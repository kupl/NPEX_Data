[{"commit": "https://github.com/apache/fineract-cn-customer/commit/48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da", "parent": "https://github.com/apache/fineract-cn-customer/commit/9f5e721b3d4f93b4ef5047395142ec1cd2cb8bdd", "message": "fixed NPE when checking four eye task", "bug_id": "fineract-cn-customer_1", "file": [{"additions": 32, "raw_url": "https://github.com/apache/fineract-cn-customer/raw/48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da/component-test/src/main/java/io/mifos/customer/TestTaskInstance.java", "blob_url": "https://github.com/apache/fineract-cn-customer/blob/48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da/component-test/src/main/java/io/mifos/customer/TestTaskInstance.java", "sha": "53a6ba6e2ac41317958c72f187841bb78766871e", "changes": 33, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/fineract-cn-customer/contents/component-test/src/main/java/io/mifos/customer/TestTaskInstance.java?ref=48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da", "patch": "@@ -120,6 +120,10 @@ public void shouldListNonMandatoryTasks() throws Exception{\n     final List<TaskDefinition> tasksForCustomer = this.customerManager.findTasksForCustomer(randomCustomer.getIdentifier(), false);\n \n     Assert.assertEquals(1, tasksForCustomer.size());\n+\n+    taskDefinition.setPredefined(false);\n+    this.customerManager.updateTask(taskDefinition.getIdentifier(), taskDefinition);\n+    this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, taskDefinition.getIdentifier());\n   }\n \n   @Test\n@@ -197,7 +201,34 @@ public void shouldUnlockCustomerMultipleTasks() throws Exception{\n     this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, customTask1.getIdentifier());\n \n     customTask2.setPredefined(false);\n-    this.customerManager.updateTask(customTask2.getIdentifier(), customTask1);\n+    this.customerManager.updateTask(customTask2.getIdentifier(), customTask2);\n     this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, customTask2.getIdentifier());\n   }\n+\n+  @Test(expected = TaskExecutionException.class)\n+  public void shouldNotProceedFourEyesWrongSigner() throws Exception {\n+    final TaskDefinition fourEyesTask = new TaskDefinition();\n+    fourEyesTask.setIdentifier(\"4-eyes-task-1\");\n+    fourEyesTask.setType(TaskDefinition.Type.FOUR_EYES.name());\n+    fourEyesTask.setName(\"Do the barrel roll\");\n+    fourEyesTask.setCommands(\n+        TaskDefinition.Command.ACTIVATE.name()\n+    );\n+    fourEyesTask.setPredefined(Boolean.TRUE);\n+    fourEyesTask.setMandatory(Boolean.TRUE);\n+\n+    this.customerManager.createTask(fourEyesTask);\n+    this.eventRecorder.wait(CustomerEventConstants.POST_TASK, fourEyesTask.getIdentifier());\n+\n+    final Customer randomCustomer = CustomerGenerator.createRandomCustomer();\n+    this.customerManager.createCustomer(randomCustomer);\n+    this.eventRecorder.wait(CustomerEventConstants.POST_CUSTOMER, randomCustomer.getIdentifier());\n+\n+    this.customerManager.taskForCustomerExecuted(randomCustomer.getIdentifier(), fourEyesTask.getIdentifier());\n+    this.eventRecorder.wait(CustomerEventConstants.PUT_CUSTOMER, randomCustomer.getIdentifier());\n+\n+    fourEyesTask.setPredefined(false);\n+    this.customerManager.updateTask(fourEyesTask.getIdentifier(), fourEyesTask);\n+    this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, fourEyesTask.getIdentifier());\n+  }\n }", "filename": "component-test/src/main/java/io/mifos/customer/TestTaskInstance.java"}, {"additions": 7, "raw_url": "https://github.com/apache/fineract-cn-customer/raw/48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da/service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java", "blob_url": "https://github.com/apache/fineract-cn-customer/blob/48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da/service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java", "sha": "d07124e59e68325767692d8c2462bda30e53f842", "changes": 13, "status": "modified", "deletions": 6, "contents_url": "https://api.github.com/repos/apache/fineract-cn-customer/contents/service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java?ref=48bfd66f9f7851aad38ac0a04bd4a73c35f6a8da", "patch": "@@ -307,10 +307,12 @@ public CustomerRestController(@Qualifier(ServiceConstants.LOGGER_NAME) final Log\n   @ResponseBody\n   ResponseEntity<Void> taskForCustomerExecuted(@PathVariable(\"identifier\") final String identifier,\n                                                @PathVariable(\"taskIdentifier\") final String taskIdentifier) {\n-    if (this.customerService.customerExists(identifier)) {\n-      if (this.taskService.taskDefinitionExists(taskIdentifier)) {\n-        final TaskDefinition taskDefinition = this.taskService.findByIdentifier(taskIdentifier).get();\n-        final Customer customer;\n+    final Optional<Customer> optionalCustomer = this.customerService.findCustomer(identifier);\n+    if (optionalCustomer.isPresent()) {\n+      final Customer customer = optionalCustomer.get();\n+      final Optional<TaskDefinition> optionalTaskDefinition = this.taskService.findByIdentifier(taskIdentifier);\n+      if (optionalTaskDefinition.isPresent()) {\n+        final TaskDefinition taskDefinition = optionalTaskDefinition.get();\n         switch (TaskDefinition.Type.valueOf(taskDefinition.getType())) {\n           case ID_CARD:\n             final List<IdentificationCard> identificationCards = this.customerService.fetchIdentificationCardsByCustomer(identifier);\n@@ -319,8 +321,7 @@ public CustomerRestController(@Qualifier(ServiceConstants.LOGGER_NAME) final Log\n             }\n             break;\n           case FOUR_EYES:\n-            customer = this.customerService.findCustomer(identifier).get();\n-            if (customer.getAssignedEmployee().equals(UserContextHolder.checkedGetUser())) {\n+            if (customer.getCreatedBy().equals(UserContextHolder.checkedGetUser())) {\n               throw ServiceException.conflict(\"Signing user must be different than creator.\");\n             }\n             break;", "filename": "service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java"}], "repo": "fineract-cn-customer"}, {"commit": "https://github.com/apache/fineract-cn-customer/commit/5184b15bf1f636fa81b643c1852e2995c33b8221", "parent": "https://github.com/apache/fineract-cn-customer/commit/9f5e721b3d4f93b4ef5047395142ec1cd2cb8bdd", "message": "Merge pull request #10 from markusgeiss/develop\n\nfixed NPE when checking four eye task", "bug_id": "fineract-cn-customer_2", "file": [{"additions": 32, "raw_url": "https://github.com/apache/fineract-cn-customer/raw/5184b15bf1f636fa81b643c1852e2995c33b8221/component-test/src/main/java/io/mifos/customer/TestTaskInstance.java", "blob_url": "https://github.com/apache/fineract-cn-customer/blob/5184b15bf1f636fa81b643c1852e2995c33b8221/component-test/src/main/java/io/mifos/customer/TestTaskInstance.java", "sha": "53a6ba6e2ac41317958c72f187841bb78766871e", "changes": 33, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/fineract-cn-customer/contents/component-test/src/main/java/io/mifos/customer/TestTaskInstance.java?ref=5184b15bf1f636fa81b643c1852e2995c33b8221", "patch": "@@ -120,6 +120,10 @@ public void shouldListNonMandatoryTasks() throws Exception{\n     final List<TaskDefinition> tasksForCustomer = this.customerManager.findTasksForCustomer(randomCustomer.getIdentifier(), false);\n \n     Assert.assertEquals(1, tasksForCustomer.size());\n+\n+    taskDefinition.setPredefined(false);\n+    this.customerManager.updateTask(taskDefinition.getIdentifier(), taskDefinition);\n+    this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, taskDefinition.getIdentifier());\n   }\n \n   @Test\n@@ -197,7 +201,34 @@ public void shouldUnlockCustomerMultipleTasks() throws Exception{\n     this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, customTask1.getIdentifier());\n \n     customTask2.setPredefined(false);\n-    this.customerManager.updateTask(customTask2.getIdentifier(), customTask1);\n+    this.customerManager.updateTask(customTask2.getIdentifier(), customTask2);\n     this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, customTask2.getIdentifier());\n   }\n+\n+  @Test(expected = TaskExecutionException.class)\n+  public void shouldNotProceedFourEyesWrongSigner() throws Exception {\n+    final TaskDefinition fourEyesTask = new TaskDefinition();\n+    fourEyesTask.setIdentifier(\"4-eyes-task-1\");\n+    fourEyesTask.setType(TaskDefinition.Type.FOUR_EYES.name());\n+    fourEyesTask.setName(\"Do the barrel roll\");\n+    fourEyesTask.setCommands(\n+        TaskDefinition.Command.ACTIVATE.name()\n+    );\n+    fourEyesTask.setPredefined(Boolean.TRUE);\n+    fourEyesTask.setMandatory(Boolean.TRUE);\n+\n+    this.customerManager.createTask(fourEyesTask);\n+    this.eventRecorder.wait(CustomerEventConstants.POST_TASK, fourEyesTask.getIdentifier());\n+\n+    final Customer randomCustomer = CustomerGenerator.createRandomCustomer();\n+    this.customerManager.createCustomer(randomCustomer);\n+    this.eventRecorder.wait(CustomerEventConstants.POST_CUSTOMER, randomCustomer.getIdentifier());\n+\n+    this.customerManager.taskForCustomerExecuted(randomCustomer.getIdentifier(), fourEyesTask.getIdentifier());\n+    this.eventRecorder.wait(CustomerEventConstants.PUT_CUSTOMER, randomCustomer.getIdentifier());\n+\n+    fourEyesTask.setPredefined(false);\n+    this.customerManager.updateTask(fourEyesTask.getIdentifier(), fourEyesTask);\n+    this.eventRecorder.wait(CustomerEventConstants.PUT_TASK, fourEyesTask.getIdentifier());\n+  }\n }", "filename": "component-test/src/main/java/io/mifos/customer/TestTaskInstance.java"}, {"additions": 7, "raw_url": "https://github.com/apache/fineract-cn-customer/raw/5184b15bf1f636fa81b643c1852e2995c33b8221/service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java", "blob_url": "https://github.com/apache/fineract-cn-customer/blob/5184b15bf1f636fa81b643c1852e2995c33b8221/service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java", "sha": "d07124e59e68325767692d8c2462bda30e53f842", "changes": 13, "status": "modified", "deletions": 6, "contents_url": "https://api.github.com/repos/apache/fineract-cn-customer/contents/service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java?ref=5184b15bf1f636fa81b643c1852e2995c33b8221", "patch": "@@ -307,10 +307,12 @@ public CustomerRestController(@Qualifier(ServiceConstants.LOGGER_NAME) final Log\n   @ResponseBody\n   ResponseEntity<Void> taskForCustomerExecuted(@PathVariable(\"identifier\") final String identifier,\n                                                @PathVariable(\"taskIdentifier\") final String taskIdentifier) {\n-    if (this.customerService.customerExists(identifier)) {\n-      if (this.taskService.taskDefinitionExists(taskIdentifier)) {\n-        final TaskDefinition taskDefinition = this.taskService.findByIdentifier(taskIdentifier).get();\n-        final Customer customer;\n+    final Optional<Customer> optionalCustomer = this.customerService.findCustomer(identifier);\n+    if (optionalCustomer.isPresent()) {\n+      final Customer customer = optionalCustomer.get();\n+      final Optional<TaskDefinition> optionalTaskDefinition = this.taskService.findByIdentifier(taskIdentifier);\n+      if (optionalTaskDefinition.isPresent()) {\n+        final TaskDefinition taskDefinition = optionalTaskDefinition.get();\n         switch (TaskDefinition.Type.valueOf(taskDefinition.getType())) {\n           case ID_CARD:\n             final List<IdentificationCard> identificationCards = this.customerService.fetchIdentificationCardsByCustomer(identifier);\n@@ -319,8 +321,7 @@ public CustomerRestController(@Qualifier(ServiceConstants.LOGGER_NAME) final Log\n             }\n             break;\n           case FOUR_EYES:\n-            customer = this.customerService.findCustomer(identifier).get();\n-            if (customer.getAssignedEmployee().equals(UserContextHolder.checkedGetUser())) {\n+            if (customer.getCreatedBy().equals(UserContextHolder.checkedGetUser())) {\n               throw ServiceException.conflict(\"Signing user must be different than creator.\");\n             }\n             break;", "filename": "service/src/main/java/io/mifos/customer/service/rest/controller/CustomerRestController.java"}], "repo": "fineract-cn-customer"}]
