[
    {
        "repo": "sling-org-apache-sling-security",
        "message": "SLING-4982 - NPE in ContentDispositionFilter\n\ngit-svn-id: https://svn.apache.org/repos/asf/sling/trunk@1700426 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/sling-org-apache-sling-security/commit/7cd29a5b33ea8f2128484b383b5c8bddd9f18ffe",
        "parent": "https://github.com/apache/sling-org-apache-sling-security/commit/1fa2f4de0a375a7d93338c7d6d640867590fefd3",
        "bug_id": "sling-org-apache-sling-security_1",
        "file": [
            {
                "sha": "34e78714367d8a611328252a24fbd875ee5b1970",
                "filename": "src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-security/blob/7cd29a5b33ea8f2128484b383b5c8bddd9f18ffe/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "raw_url": "https://github.com/apache/sling-org-apache-sling-security/raw/7cd29a5b33ea8f2128484b383b5c8bddd9f18ffe/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "status": "modified",
                "changes": 28,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-security/contents/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java?ref=7cd29a5b33ea8f2128484b383b5c8bddd9f18ffe",
                "patch": "@@ -283,19 +283,23 @@ private boolean setContentDisposition(Resource resource) {\n         \n         private boolean isJcrData(Resource resource){\n             boolean jcrData = false;\n-            if (resource!= null) {\n-                ValueMap props = resource.adaptTo(ValueMap.class);\n-                if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n-                    jcrData = true;\n-                } else {\n-                    Resource jcrContent = resource.getChild(JCR_CONTENT_LEAF);\n-                    if (jcrContent!= null) {\n-                        props = jcrContent.adaptTo(ValueMap.class);\n-                        if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n-                            jcrData = true;\n+            try {\n+                if (resource!= null) {\n+                    ValueMap props = resource.adaptTo(ValueMap.class);\n+                    if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n+                        jcrData = true;\n+                    } else {\n+                        Resource jcrContent = resource.getChild(JCR_CONTENT_LEAF);\n+                        if (jcrContent!= null) {\n+                            props = jcrContent.adaptTo(ValueMap.class);\n+                            if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n+                                jcrData = true;\n+                            }\n                         }\n-                    }\n-                }     \n+                    }     \n+                }\n+            } catch (Exception e) {\n+                logger.error(\"Exception in isJcrData\", e);\n             }\n             return jcrData;\n         }",
                "deletions": 12
            }
        ]
    },
    {
        "repo": "sling-org-apache-sling-security",
        "message": "SLING-4982 - NPE in ContentDispositionFilter\n\ngit-svn-id: https://svn.apache.org/repos/asf/sling/trunk@1700424 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/sling-org-apache-sling-security/commit/1fa2f4de0a375a7d93338c7d6d640867590fefd3",
        "parent": "https://github.com/apache/sling-org-apache-sling-security/commit/434f2a8d1e7dff11ddb7b1fa5167b2a792db7d91",
        "bug_id": "sling-org-apache-sling-security_2",
        "file": [
            {
                "sha": "96b2df0913d42087be5ca4f857e6deda3eb6fe7e",
                "filename": "src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-security/blob/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "raw_url": "https://github.com/apache/sling-org-apache-sling-security/raw/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-security/contents/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java?ref=1fa2f4de0a375a7d93338c7d6d640867590fefd3",
                "patch": "@@ -285,13 +285,13 @@ private boolean isJcrData(Resource resource){\n             boolean jcrData = false;\n             if (resource!= null) {\n                 ValueMap props = resource.adaptTo(ValueMap.class);\n-                if (props.containsKey(PROP_JCR_DATA) ) {\n+                if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n                     jcrData = true;\n                 } else {\n                     Resource jcrContent = resource.getChild(JCR_CONTENT_LEAF);\n                     if (jcrContent!= null) {\n                         props = jcrContent.adaptTo(ValueMap.class);\n-                        if (props.containsKey(PROP_JCR_DATA) ) {\n+                        if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n                             jcrData = true;\n                         }\n                     }",
                "deletions": 2
            },
            {
                "sha": "49b1ae7cc849813f4b8ce391ca589a39c2681dd5",
                "filename": "src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-security/blob/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
                "raw_url": "https://github.com/apache/sling-org-apache-sling-security/raw/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
                "status": "modified",
                "changes": 57,
                "additions": 57,
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-security/contents/src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java?ref=1fa2f4de0a375a7d93338c7d6d640867590fefd3",
                "patch": "@@ -1474,4 +1474,61 @@ public void test_isJcrData5() throws Throwable {\n         \n         Assert.assertTrue(result);\n     }\n+    \n+    @Test\n+    public void test_isJcrData6() throws Throwable {\n+        contentDispositionFilter = new ContentDispositionFilter();\n+        final SlingHttpServletRequest request = context.mock(SlingHttpServletRequest.class);\n+        final SlingHttpServletResponse response = context.mock(SlingHttpServletResponse.class);       \n+        final ContentDispositionFilter.RewriterResponse rewriterResponse = contentDispositionFilter. new RewriterResponse(request, response);\n+        \n+        \n+        final Resource resource = context.mock(Resource.class);\n+        final ValueMap properties = context.mock(ValueMap.class);\n+        \n+        context.checking(new Expectations() {\n+            {\n+                allowing(resource).adaptTo(ValueMap.class);\n+                will(returnValue(null));\n+                allowing(resource).getChild(JCR_CONTENT_LEAF);\n+                will(returnValue(null));\n+            }\n+        });     \n+        \n+        Boolean result = (Boolean) PrivateAccessor.invoke(rewriterResponse,\"isJcrData\",  new Class[]{Resource.class},new Object[]{resource});\n+        \n+        Assert.assertFalse(result);\n+    }\n+    \n+    \n+    @Test\n+    public void test_isJcrData7() throws Throwable {\n+        contentDispositionFilter = new ContentDispositionFilter();\n+        final SlingHttpServletRequest request = context.mock(SlingHttpServletRequest.class);\n+        final SlingHttpServletResponse response = context.mock(SlingHttpServletResponse.class);       \n+        final ContentDispositionFilter.RewriterResponse rewriterResponse = contentDispositionFilter. new RewriterResponse(request, response);\n+        \n+        final Resource child = context.mock(Resource.class, \"child\");\n+        final Resource resource = context.mock(Resource.class, \"resource\" );\n+        final ValueMap properties = context.mock(ValueMap.class);\n+        final ValueMap childPropoerties = context.mock(ValueMap.class, \"childPropoerties\");\n+\n+        \n+        context.checking(new Expectations() {\n+            {\n+                allowing(resource).adaptTo(ValueMap.class);\n+                will(returnValue(properties));\n+                allowing(properties).containsKey(PROP_JCR_DATA);\n+                will(returnValue(false));\n+                allowing(resource).getChild(JCR_CONTENT_LEAF);\n+                will(returnValue(child));\n+                allowing(child).adaptTo(ValueMap.class);\n+                will(returnValue(null));\n+            }\n+        });     \n+        \n+        Boolean result = (Boolean) PrivateAccessor.invoke(rewriterResponse,\"isJcrData\",  new Class[]{Resource.class},new Object[]{resource});\n+        \n+        Assert.assertFalse(result);\n+    }\n }\n\\ No newline at end of file",
                "deletions": 0
            }
        ]
    }
]