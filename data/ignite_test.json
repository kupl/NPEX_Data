{
    "ignite_0a16208": {
        "bug_id": "ignite_0a16208",
        "commit": "https://github.com/apache/ignite/commit/0a16208a87d4044391de7f2ce8fd497c9cd817b5",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/0a16208a87d4044391de7f2ce8fd497c9cd817b5/modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/AgentLauncher.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/AgentLauncher.java?ref=0a16208a87d4044391de7f2ce8fd497c9cd817b5",
                "deletions": 10,
                "filename": "modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/AgentLauncher.java",
                "patch": "@@ -318,22 +318,24 @@ public static void main(String[] args) throws Exception {\n             return;\n         }\n \n-        boolean trustAll = Boolean.getBoolean(\"trust.all\");\n+        boolean serverTrustAll = Boolean.getBoolean(\"trust.all\");\n         boolean hasServerTrustStore = cfg.serverTrustStore() != null;\n-        boolean hasNodeTrustStore = cfg.nodeTrustStore() != null;\n \n-        if (trustAll && hasServerTrustStore) {\n+        if (serverTrustAll && hasServerTrustStore) {\n             log.warn(\"Options contains both '--server-trust-store' and '-Dtrust.all=true'. \" +\n-                \"Option '-Dtrust.all=true' will be ignored.\");\n+                \"Option '-Dtrust.all=true' will be ignored on connect to Web server.\");\n \n-            trustAll = false;\n+            serverTrustAll = false;\n         }\n \n-        if (trustAll && hasNodeTrustStore) {\n+        boolean nodeTrustAll = Boolean.getBoolean(\"trust.all\");\n+        boolean hasNodeTrustStore = cfg.nodeTrustStore() != null;\n+\n+        if (nodeTrustAll && hasNodeTrustStore) {\n             log.warn(\"Options contains both '--node-trust-store' and '-Dtrust.all=true'. \" +\n-                \"Option '-Dtrust.all=true' will be ignored.\");\n+                \"Option '-Dtrust.all=true' will be ignored on connect to cluster.\");\n \n-            trustAll = false;\n+            nodeTrustAll = false;\n         }\n \n         cfg.nodeURIs(nodeURIs);\n@@ -344,14 +346,14 @@ public static void main(String[] args) throws Exception {\n         List<String> cipherSuites = cfg.cipherSuites();\n \n         if (\n-            trustAll ||\n+            serverTrustAll ||\n             hasServerTrustStore ||\n             cfg.serverKeyStore() != null\n         ) {\n             OkHttpClient.Builder builder = new OkHttpClient.Builder();\n \n             X509TrustManager serverTrustMgr = trustManager(\n-                trustAll,\n+                serverTrustAll,\n                 cfg.serverTrustStore(),\n                 cfg.serverTrustStorePassword()\n             );\n@@ -381,6 +383,7 @@ public static void main(String[] args) throws Exception {\n \n         try (\n             RestExecutor restExecutor = new RestExecutor(\n+                nodeTrustAll,\n                 cfg.nodeKeyStore(), cfg.nodeKeyStorePassword(),\n                 cfg.nodeTrustStore(), cfg.nodeTrustStorePassword(),\n                 cipherSuites);",
                "raw_url": "https://github.com/apache/ignite/raw/0a16208a87d4044391de7f2ce8fd497c9cd817b5/modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/AgentLauncher.java",
                "sha": "74c83760ce29de5122aa9478d6a35e9e527daff6",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/0a16208a87d4044391de7f2ce8fd497c9cd817b5/modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/rest/RestExecutor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/rest/RestExecutor.java?ref=0a16208a87d4044391de7f2ce8fd497c9cd817b5",
                "deletions": 1,
                "filename": "modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/rest/RestExecutor.java",
                "patch": "@@ -77,6 +77,7 @@\n     /**\n      * Constructor.\n      *\n+     * @param trustAll {@code true} If we trust to self-signed sertificates.\n      * @param keyStorePath Optional path to key store file.\n      * @param keyStorePwd Optional password for key store.\n      * @param trustStorePath Optional path to trust store file.\n@@ -86,6 +87,7 @@\n      * @throws IOException If failed to load content of key stores.\n      */\n     public RestExecutor(\n+        boolean trustAll,\n         String keyStorePath,\n         String keyStorePwd,\n         String trustStorePath,\n@@ -101,7 +103,7 @@ public RestExecutor(\n             .readTimeout(0, TimeUnit.MILLISECONDS)\n             .dispatcher(dispatcher);\n \n-        X509TrustManager trustMgr = trustManager(Boolean.getBoolean(\"trust.all\"), trustStorePath, trustStorePwd);\n+        X509TrustManager trustMgr = trustManager(trustAll, trustStorePath, trustStorePwd);\n \n         SSLSocketFactory sslSocketFactory = sslSocketFactory(\n             keyStorePath, keyStorePwd,",
                "raw_url": "https://github.com/apache/ignite/raw/0a16208a87d4044391de7f2ce8fd497c9cd817b5/modules/web-console/web-agent/src/main/java/org/apache/ignite/console/agent/rest/RestExecutor.java",
                "sha": "5a9783cf4e7bddbe946bcdfbf8e73ba3b28dc625",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/0a16208a87d4044391de7f2ce8fd497c9cd817b5/modules/web-console/web-agent/src/test/java/org/apache/ignite/console/agent/rest/RestExecutorSelfTest.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/web-console/web-agent/src/test/java/org/apache/ignite/console/agent/rest/RestExecutorSelfTest.java?ref=0a16208a87d4044391de7f2ce8fd497c9cd817b5",
                "deletions": 3,
                "filename": "modules/web-console/web-agent/src/test/java/org/apache/ignite/console/agent/rest/RestExecutorSelfTest.java",
                "patch": "@@ -25,6 +25,7 @@\n import java.util.List;\n import java.util.Map;\n import java.util.UUID;\n+import javax.net.ssl.SSLException;\n import javax.net.ssl.SSLHandshakeException;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.Ignition;\n@@ -178,7 +179,7 @@ private void checkRest(\n     ) throws Exception {\n         try(\n             Ignite ignite = Ignition.getOrStart(nodeCfg);\n-            RestExecutor exec = new RestExecutor(keyStore, keyStorePwd, trustStore, trustStorePwd, cipherSuites)\n+            RestExecutor exec = new RestExecutor(false, keyStore, keyStorePwd, trustStore, trustStorePwd, cipherSuites)\n         ) {\n             Map<String, Object> params = new HashMap<>();\n             params.put(\"cmd\", \"top\");\n@@ -216,7 +217,7 @@ public void nodeNoSslAgentNoSsl() throws Exception {\n     @Test\n     public void nodeNoSslAgentWithSsl() throws Exception {\n         // Check Web Agent with SSL.\n-        ruleForExpectedException.expect(SSLHandshakeException.class);\n+        ruleForExpectedException.expect(SSLException.class);\n         checkRest(\n             nodeConfiguration(\"\"),\n             HTTPS_URI,\n@@ -305,7 +306,7 @@ public void differentCiphers1() throws Exception {\n     /** */\n     @Test\n     public void differentCiphers2() throws Exception {\n-        ruleForExpectedException.expect(SSLHandshakeException.class);\n+        ruleForExpectedException.expect(SSLException.class);\n         checkRest(\n             nodeConfiguration(JETTY_WITH_CIPHERS_2),\n             HTTPS_URI,",
                "raw_url": "https://github.com/apache/ignite/raw/0a16208a87d4044391de7f2ce8fd497c9cd817b5/modules/web-console/web-agent/src/test/java/org/apache/ignite/console/agent/rest/RestExecutorSelfTest.java",
                "sha": "dcf53f24be228466e574f435f98e4a1d6be3549f",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9845 Web Agent: Fixed NPE in case of \"-Dtrust.all=true\" and not configured server trust store.",
        "parent": "https://github.com/apache/ignite/commit/41becafd7bb13c03a46bfbba75eb54b7eaeeb47a",
        "patched_files": [
            "AgentLauncher.java",
            "RestExecutor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "RestExecutorSelfTest.java"
        ]
    },
    "ignite_0b996e6": {
        "bug_id": "ignite_0b996e6",
        "commit": "https://github.com/apache/ignite/commit/0b996e62119b316f9758da09623c722ec2fb7921",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 8,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java",
                "patch": "@@ -17,6 +17,11 @@\n \n package org.apache.ignite.internal.processors.cache;\n \n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.UUID;\n import org.apache.ignite.IgniteCheckedException;\n import org.apache.ignite.IgniteException;\n import org.apache.ignite.binary.BinaryObject;\n@@ -33,12 +38,6 @@\n import org.apache.ignite.lang.IgniteFuture;\n import org.jetbrains.annotations.Nullable;\n \n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.Set;\n-import java.util.UUID;\n-\n /**\n  * Cache affinity manager.\n  */\n@@ -88,18 +87,24 @@\n      *\n      */\n     public void cancelFutures() {\n+        if (!starting.get())\n+            // Ignoring attempt to stop manager that has never been started.\n+            return;\n+\n         IgniteCheckedException err =\n             new IgniteCheckedException(\"Failed to wait for topology update, cache (or node) is stopping.\");\n \n-        aff.cancelFutures(err);\n+        if (aff != null)\n+            aff.cancelFutures(err);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void onDisconnected(IgniteFuture reconnectFut) {\n         IgniteCheckedException err = new IgniteClientDisconnectedCheckedException(reconnectFut,\n             \"Failed to wait for topology update, client disconnected.\");\n \n-        aff.cancelFutures(err);\n+        if (aff != null)\n+            aff.cancelFutures(err);\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java",
                "sha": "621634c8b81861113df6e1db187898cc5dcce8c4",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheManagerAdapter.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheManagerAdapter.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheManagerAdapter.java",
                "patch": "@@ -34,7 +34,7 @@\n     protected IgniteLogger log;\n \n     /** Starting flag. */\n-    private final AtomicBoolean starting = new AtomicBoolean(false);\n+    protected final AtomicBoolean starting = new AtomicBoolean(false);\n \n     /** {@inheritDoc} */\n     @Override public final void start(GridCacheContext<K, V> cctx) throws IgniteCheckedException {",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheManagerAdapter.java",
                "sha": "ab965dea912d4f8a0bef91fb308b040e9f496622",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -63,7 +63,6 @@\n import org.apache.ignite.configuration.TransactionConfiguration;\n import org.apache.ignite.events.EventType;\n import org.apache.ignite.internal.GridKernalContext;\n-import org.apache.ignite.internal.suggestions.GridPerformanceSuggestions;\n import org.apache.ignite.internal.IgniteClientDisconnectedCheckedException;\n import org.apache.ignite.internal.IgniteComponentType;\n import org.apache.ignite.internal.IgniteInternalFuture;\n@@ -102,6 +101,7 @@\n import org.apache.ignite.internal.processors.plugin.CachePluginManager;\n import org.apache.ignite.internal.processors.query.GridQueryProcessor;\n import org.apache.ignite.internal.processors.timeout.GridTimeoutObject;\n+import org.apache.ignite.internal.suggestions.GridPerformanceSuggestions;\n import org.apache.ignite.internal.util.F0;\n import org.apache.ignite.internal.util.future.GridCompoundFuture;\n import org.apache.ignite.internal.util.future.GridFinishedFuture;",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "b016883c21045468228ba90ebcc40a9d32d8948d",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java",
                "patch": "@@ -1653,13 +1653,27 @@ private static ClassProperty buildClassProperty(Class<?> keyCls, Class<?> valCls\n             res = buildClassProperty(false, valCls, pathStr, resType, aliases, coCtx);\n \n         if (res == null)\n-            throw new IgniteCheckedException(\"Failed to initialize property '\" + pathStr + \"' of type '\" +\n-                resType.getName() + \"' for key class '\" + keyCls + \"' and value class '\" + valCls + \"'. \" +\n-                \"Make sure that one of these classes contains respective getter method or field.\");\n+            throw new IgniteCheckedException(propertyInitializationExceptionMessage(keyCls, valCls, pathStr, resType));\n \n         return res;\n     }\n \n+    /**\n+     * Exception message to compare in tests.\n+     *\n+     * @param keyCls key class\n+     * @param valCls value class\n+     * @param pathStr property name\n+     * @param resType property type\n+     * @return\n+     */\n+    public static String propertyInitializationExceptionMessage(Class<?> keyCls, Class<?> valCls, String pathStr,\n+        Class<?> resType) {\n+        return \"Failed to initialize property '\" + pathStr + \"' of type '\" +\n+            resType.getName() + \"' for key class '\" + keyCls + \"' and value class '\" + valCls + \"'. \" +\n+            \"Make sure that one of these classes contains respective getter method or field.\";\n+    }\n+\n     /**\n      * @param key If this is a key property.\n      * @param cls Source type class.",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java",
                "sha": "fddb8df07b58ab9ce39b7a047a8088d7985603a9",
                "status": "modified"
            },
            {
                "additions": 72,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectCacheTypeMetadataTest.java",
                "changes": 72,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectCacheTypeMetadataTest.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectCacheTypeMetadataTest.java",
                "patch": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.ignite.cache.CacheTypeMetadata;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.processors.query.GridQueryProcessor;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * A test for {@link CacheTypeMetadata} initialization with incorrect query field name\n+ */\n+public class IncorrectCacheTypeMetadataTest extends GridCommonAbstractTest {\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        CacheConfiguration dfltCacheCfg = defaultCacheConfiguration();\n+\n+        CacheTypeMetadata cacheTypeMetadata = new CacheTypeMetadata();\n+\n+        Map<String, Class<?>> queryFieldsMap = new HashMap<>();\n+\n+        queryFieldsMap.put(\"exceptionOid\", Object.class);\n+\n+        cacheTypeMetadata.setQueryFields(queryFieldsMap);\n+        cacheTypeMetadata.setValueType(Object.class);\n+\n+        dfltCacheCfg.setTypeMetadata(Collections.singleton(cacheTypeMetadata));\n+\n+        cfg.setCacheConfiguration(dfltCacheCfg);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Grid must be stopped with property initialization exception.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testIncorrectQueryField() throws Exception {\n+        try {\n+            startGrid();\n+        }\n+        catch (Exception exception) {\n+            if (!exception.getMessage().contains(\n+                GridQueryProcessor.propertyInitializationExceptionMessage(\n+                    Object.class, Object.class, \"exceptionOid\", Object.class))) {\n+                fail(\"property initialization exception must be thrown, but got \" + exception.getMessage());\n+            }\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectCacheTypeMetadataTest.java",
                "sha": "4178cde490585e823b22eb79dee99979a5b3d119",
                "status": "added"
            },
            {
                "additions": 75,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectQueryEntityTest.java",
                "changes": 75,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectQueryEntityTest.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectQueryEntityTest.java",
                "patch": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache;\n+\n+import java.util.HashSet;\n+import java.util.LinkedHashMap;\n+import java.util.Set;\n+import org.apache.ignite.cache.QueryEntity;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.processors.query.GridQueryProcessor;\n+import org.apache.ignite.internal.util.typedef.F;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+public class IncorrectQueryEntityTest extends GridCommonAbstractTest {\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        CacheConfiguration dfltCacheCfg = defaultCacheConfiguration();\n+\n+        QueryEntity queryEntity = new QueryEntity(Object.class.getName(), Object.class.getName());\n+\n+        LinkedHashMap<String, String> fields = new LinkedHashMap<>();\n+\n+        fields.put(\"exceptionOid\", Object.class.getName());\n+\n+        queryEntity.setFields(fields);\n+\n+        Set<String> keyFields = new HashSet<>();\n+\n+        keyFields.add(\"exceptionOid\");\n+\n+        queryEntity.setKeyFields(keyFields);\n+\n+        dfltCacheCfg.setQueryEntities(F.asList(queryEntity));\n+\n+        cfg.setCacheConfiguration(dfltCacheCfg);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Grid must be stopped with property initialization exception.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testIncorrectQueryField() throws Exception {\n+        try {\n+            startGrid();\n+        }\n+        catch (Exception exception) {\n+            if (!exception.getMessage().contains(\n+                GridQueryProcessor.propertyInitializationExceptionMessage(\n+                    Object.class, Object.class, \"exceptionOid\", Object.class))) {\n+                fail(\"property initialization exception must be thrown, but got \" + exception.getMessage());\n+            }\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IncorrectQueryEntityTest.java",
                "sha": "5d89a58b2987309bbe766431c421a7d07dda7871",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/0b996e62119b316f9758da09623c722ec2fb7921/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java?ref=0b996e62119b316f9758da09623c722ec2fb7921",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "patch": "@@ -68,6 +68,8 @@\n import org.apache.ignite.internal.processors.cache.IgniteCacheQueryLoadSelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteCacheUpdateSqlQuerySelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteCrossCachesJoinsQueryTest;\n+import org.apache.ignite.internal.processors.cache.IncorrectCacheTypeMetadataTest;\n+import org.apache.ignite.internal.processors.cache.IncorrectQueryEntityTest;\n import org.apache.ignite.internal.processors.cache.QueryEntityCaseMismatchTest;\n import org.apache.ignite.internal.processors.cache.SqlFieldsQuerySelfTest;\n import org.apache.ignite.internal.processors.cache.distributed.near.IgniteCacheAtomicFieldsQuerySelfTest;\n@@ -133,6 +135,8 @@ public static TestSuite suite() throws Exception {\n \n         // Config.\n         suite.addTestSuite(IgniteCacheDuplicateEntityConfigurationSelfTest.class);\n+        suite.addTestSuite(IncorrectCacheTypeMetadataTest.class);\n+        suite.addTestSuite(IncorrectQueryEntityTest.class);\n \n         // Queries tests.\n         suite.addTestSuite(IgniteSqlSplitterSelfTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/0b996e62119b316f9758da09623c722ec2fb7921/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "sha": "b7be713309f1364b253eb023efa8816212ebfab8",
                "status": "modified"
            }
        ],
        "message": "IGNITE-1178 fix for NPE in GridCacheProcessor.onKernalStop(). Fixes #1517",
        "parent": "https://github.com/apache/ignite/commit/e6703518f4549a183993a5422fbf75b18f1237de",
        "patched_files": [
            "GridCacheAffinityManager.java",
            "GridCacheManagerAdapter.java",
            "GridCacheProcessor.java",
            "GridQueryProcessor.java",
            "IgniteCacheQuerySelfTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IncorrectCacheTypeMetadataTest.java",
            "IncorrectQueryEntityTest.java"
        ]
    },
    "ignite_0d6fb1a": {
        "bug_id": "ignite_0d6fb1a",
        "commit": "https://github.com/apache/ignite/commit/0d6fb1ad73e8ed448dabe7c0cc631222835b52c4",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/0d6fb1ad73e8ed448dabe7c0cc631222835b52c4/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java?ref=0d6fb1ad73e8ed448dabe7c0cc631222835b52c4",
                "deletions": 1,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java",
                "patch": "@@ -441,7 +441,7 @@ public int put(long pageAddr, int off, Value val, int maxSize) {\n                     size = (short)s.length;\n                 else {\n                     s = trimUTF8(s, maxSize - 3);\n-                    size = (short)(s.length | 0x8000);\n+                    size = (short)(s == null ? 0 : s.length | 0x8000);\n                 }\n \n                 if (s == null) {",
                "raw_url": "https://github.com/apache/ignite/raw/0d6fb1ad73e8ed448dabe7c0cc631222835b52c4/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java",
                "sha": "19cf857fece29f356d79697bc57850802241012f",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/0d6fb1ad73e8ed448dabe7c0cc631222835b52c4/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java?ref=0d6fb1ad73e8ed448dabe7c0cc631222835b52c4",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java",
                "patch": "@@ -167,6 +167,10 @@ public void testStringTruncate() throws Exception {\n             assertTrue(ih.isValueFull(pageAddr, off));\n \n             assertEquals(\"aaa\", ih.get(pageAddr, off, 3 + 5).getString());\n+\n+            ih.put(pageAddr, off, ValueString.get(\"\\u20acaaa\"), 3 + 2);\n+\n+            assertNull(ih.get(pageAddr, off, 3 + 2));\n         }\n         finally {\n             if (page != 0L)",
                "raw_url": "https://github.com/apache/ignite/raw/0d6fb1ad73e8ed448dabe7c0cc631222835b52c4/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java",
                "sha": "a2a3a7204cc6b1273ebb047edecf78b3b00f4fe3",
                "status": "modified"
            }
        ],
        "message": "IGNITE-5204: Fixed NPE on certain data with index inlining. This closes #2115.",
        "parent": "https://github.com/apache/ignite/commit/ea4420e6aad509c4ae58d6d0880918c98fd1959a",
        "patched_files": [
            "InlineIndexHelper.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "InlineIndexHelperTest.java"
        ]
    },
    "ignite_121b89b": {
        "bug_id": "ignite_121b89b",
        "commit": "https://github.com/apache/ignite/commit/121b89b07990068a31d384da8d6f3c781cf0efb8",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/121b89b07990068a31d384da8d6f3c781cf0efb8/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java?ref=121b89b07990068a31d384da8d6f3c781cf0efb8",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "patch": "@@ -296,7 +296,7 @@ protected CacheMemoryMode memoryMode() {\n         for (int i = 0; i < gridCount(); i++) {\n             Boolean clientMode = grid(i).configuration().isClientMode();\n \n-            if (clientMode)\n+            if (clientMode != null && clientMode) // Can be null in multi jvm tests.\n                 continue;\n \n             grid(0).services(grid(0).cluster()).deployNodeSingleton(SERVICE_NAME1, new DummyServiceImpl());",
                "raw_url": "https://github.com/apache/ignite/raw/121b89b07990068a31d384da8d6f3c781cf0efb8/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "sha": "a31c82ef72bca0826d3de64c960008ac79bbc6b2",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in GridCacheAbstractFullApiSelfTest in multi jvm tests.",
        "parent": "https://github.com/apache/ignite/commit/b5121adff860d96e5954d3466137854f8fae4c27",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheAbstractFullApiSelfTest.java"
        ]
    },
    "ignite_132ec3f": {
        "bug_id": "ignite_132ec3f",
        "commit": "https://github.com/apache/ignite/commit/132ec3fa4f3e55f001899f4eef3cdf3786cefa41",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/main/java/org/apache/ignite/internal/util/nio/GridNioServer.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/nio/GridNioServer.java?ref=132ec3fa4f3e55f001899f4eef3cdf3786cefa41",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/nio/GridNioServer.java",
                "patch": "@@ -3371,8 +3371,12 @@ protected HeadFilter() {\n \n                     GridSelectorNioSessionImpl ses0 = (GridSelectorNioSessionImpl)ses;\n \n-                    if (!ses0.procWrite.get() && ses0.procWrite.compareAndSet(false, true))\n-                        ses0.worker().registerWrite(ses0);\n+                    if (!ses0.procWrite.get() && ses0.procWrite.compareAndSet(false, true)) {\n+                        GridNioWorker worker = ses0.worker();\n+\n+                        if (worker != null)\n+                            worker.registerWrite(ses0);\n+                    }\n \n                     return null;\n                 }",
                "raw_url": "https://github.com/apache/ignite/raw/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/main/java/org/apache/ignite/internal/util/nio/GridNioServer.java",
                "sha": "1d595d2485f0fbed7d05e68718662566147f4c58",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationBalanceTest.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationBalanceTest.java?ref=132ec3fa4f3e55f001899f4eef3cdf3786cefa41",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationBalanceTest.java",
                "patch": "@@ -72,9 +72,19 @@\n \n         cfg.setClientMode(client);\n \n+        if (sslEnabled())\n+            cfg.setSslContextFactory(GridTestUtils.sslFactory());\n+\n         return cfg;\n     }\n \n+    /**\n+     * @return {@code True} to enable SSL.\n+     */\n+    protected boolean sslEnabled() {\n+        return false;\n+    }\n+\n     /**\n      * @return Value for {@link TcpCommunicationSpi#setUsePairedConnections(boolean)}.\n      */\n@@ -100,6 +110,9 @@ protected int connectionsPerNode() {\n      * @throws Exception If failed.\n      */\n     public void testBalance1() throws Exception {\n+        if (sslEnabled())\n+            return;\n+\n         System.setProperty(IgniteSystemProperties.IGNITE_IO_BALANCE_PERIOD, \"5000\");\n \n         try {",
                "raw_url": "https://github.com/apache/ignite/raw/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationBalanceTest.java",
                "sha": "666bc1dfbf6c285b3cc95bfd1f2fde77ce47332d",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/ignite/blob/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationSslBalanceTest.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationSslBalanceTest.java?ref=132ec3fa4f3e55f001899f4eef3cdf3786cefa41",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationSslBalanceTest.java",
                "patch": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.managers.communication;\n+\n+/**\n+ *\n+ */\n+public class IgniteCommunicationSslBalanceTest extends IgniteCommunicationBalanceTest {\n+    /** {@inheritDoc} */\n+    @Override protected boolean sslEnabled() {\n+        return true;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/test/java/org/apache/ignite/internal/managers/communication/IgniteCommunicationSslBalanceTest.java",
                "sha": "68094e265577a7ed960dc7f17717d86e8b80ac19",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite.java?ref=132ec3fa4f3e55f001899f4eef3cdf3786cefa41",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite.java",
                "patch": "@@ -38,6 +38,7 @@\n import org.apache.ignite.internal.managers.communication.IgniteCommunicationBalanceMultipleConnectionsTest;\n import org.apache.ignite.internal.managers.communication.IgniteCommunicationBalancePairedConnectionsTest;\n import org.apache.ignite.internal.managers.communication.IgniteCommunicationBalanceTest;\n+import org.apache.ignite.internal.managers.communication.IgniteCommunicationSslBalanceTest;\n import org.apache.ignite.internal.managers.communication.IgniteIoTestMessagesTest;\n import org.apache.ignite.internal.managers.communication.IgniteVariousConnectionNumberTest;\n import org.apache.ignite.internal.processors.cache.CacheAffinityCallSelfTest;\n@@ -309,6 +310,7 @@ public static TestSuite suite(Set<Class> ignoredTests) throws Exception {\n         suite.addTestSuite(IgniteCommunicationBalanceTest.class);\n         suite.addTestSuite(IgniteCommunicationBalancePairedConnectionsTest.class);\n         suite.addTestSuite(IgniteCommunicationBalanceMultipleConnectionsTest.class);\n+        suite.addTestSuite(IgniteCommunicationSslBalanceTest.class);\n         suite.addTestSuite(IgniteIoTestMessagesTest.class);\n         suite.addTestSuite(IgniteDiagnosticMessagesTest.class);\n         suite.addTestSuite(IgniteDiagnosticMessagesMultipleConnectionsTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/132ec3fa4f3e55f001899f4eef3cdf3786cefa41/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite.java",
                "sha": "e3ebbc16e00fe6962a3ee4124019d2ba1f5db2ec",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE on node stop when SSL is used.",
        "parent": "https://github.com/apache/ignite/commit/250ceb726d38631282599fb39b3990e66a667922",
        "patched_files": [
            "GridNioServer.java",
            "IgniteCacheTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCommunicationBalanceTest.java",
            "IgniteCommunicationSslBalanceTest.java"
        ]
    },
    "ignite_15956a8": {
        "bug_id": "ignite_15956a8",
        "commit": "https://github.com/apache/ignite/commit/15956a8a6a26e37d99501fdb7e5af0b00efae506",
        "file": [
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/ignite/blob/15956a8a6a26e37d99501fdb7e5af0b00efae506/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java?ref=15956a8a6a26e37d99501fdb7e5af0b00efae506",
                "deletions": 9,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java",
                "patch": "@@ -871,17 +871,23 @@ else if (!canUsePartitionMapCompression(node)) {\n                     ready = cacheCtx.started();\n \n                 if (ready) {\n-                    GridDhtPartitionFullMap locMap = cacheCtx.topology().partitionMap(true);\n+                    GridAffinityAssignmentCache affCache = cacheCtx.affinity().affinityCache();\n \n-                    addFullPartitionsMap(m,\n-                        dupData,\n-                        compress,\n-                        cacheCtx.cacheId(),\n-                        locMap,\n-                        cacheCtx.affinity().affinityCache().similarAffinityKey());\n+                    if (affCache != null) {\n+                        GridDhtPartitionFullMap locMap = cacheCtx.topology().partitionMap(true);\n \n-                    if (exchId != null)\n-                        m.addPartitionUpdateCounters(cacheCtx.cacheId(), cacheCtx.topology().updateCounters(true));\n+                        addFullPartitionsMap(m,\n+                            dupData,\n+                            compress,\n+                            cacheCtx.cacheId(),\n+                            locMap,\n+                            affCache.similarAffinityKey());\n+\n+                        if (exchId != null)\n+                            m.addPartitionUpdateCounters(cacheCtx.cacheId(), cacheCtx.topology().updateCounters(true));\n+                    }\n+                    else\n+                        assert cctx.cacheContext(cacheCtx.cacheId()) == null : cacheCtx.name();\n                 }\n             }\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/15956a8a6a26e37d99501fdb7e5af0b00efae506/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java",
                "sha": "004e07c26d0814f6a944510674e8afe4d944cf78",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/15956a8a6a26e37d99501fdb7e5af0b00efae506/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/expiry/IgniteCacheAtomicPrimaryWriteOrderWithStoreExpiryPolicyTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/expiry/IgniteCacheAtomicPrimaryWriteOrderWithStoreExpiryPolicyTest.java?ref=15956a8a6a26e37d99501fdb7e5af0b00efae506",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/expiry/IgniteCacheAtomicPrimaryWriteOrderWithStoreExpiryPolicyTest.java",
                "patch": "@@ -24,7 +24,7 @@\n  *\n  */\n public class IgniteCacheAtomicPrimaryWriteOrderWithStoreExpiryPolicyTest extends\n-    IgniteCacheAtomicPrimaryWriteOrderExpiryPolicyTest{\n+    IgniteCacheAtomicPrimaryWriteOrderExpiryPolicyTest {\n     /** {@inheritDoc} */\n     @Override protected Factory<CacheStore> cacheStoreFactory() {\n         return new TestStoreFactory();",
                "raw_url": "https://github.com/apache/ignite/raw/15956a8a6a26e37d99501fdb7e5af0b00efae506/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/expiry/IgniteCacheAtomicPrimaryWriteOrderWithStoreExpiryPolicyTest.java",
                "sha": "75ddf523941abe15a1a95105d98d66b355996853",
                "status": "modified"
            }
        ],
        "message": "Fix NPE in GridCachePartitionExchangeManager.createPartitionsFullMessage.",
        "parent": "https://github.com/apache/ignite/commit/56162b39a9a86751ea0b791505db14f69348163b",
        "patched_files": [
            "GridCachePartitionExchangeManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCacheAtomicPrimaryWriteOrderWithStoreExpiryPolicyTest.java"
        ]
    },
    "ignite_177d7f4": {
        "bug_id": "ignite_177d7f4",
        "commit": "https://github.com/apache/ignite/commit/177d7f49934e24e85472a8e44a641c4b57a25914",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/ignite/blob/177d7f49934e24e85472a8e44a641c4b57a25914/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java?ref=177d7f49934e24e85472a8e44a641c4b57a25914",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java",
                "patch": "@@ -34,6 +34,7 @@\n import org.apache.ignite.cache.query.QueryMetrics;\n import org.apache.ignite.cluster.ClusterGroup;\n import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.cluster.ClusterTopologyException;\n import org.apache.ignite.internal.IgniteClientDisconnectedCheckedException;\n import org.apache.ignite.internal.IgniteInternalFuture;\n import org.apache.ignite.internal.cluster.ClusterGroupEmptyCheckedException;\n@@ -666,6 +667,13 @@ private ScanQueryFallbackClosableIterator(int part, GridCacheQueryAdapter qry,\n \n             nodes = fallbacks(cctx.discovery().topologyVersionEx());\n \n+            if (F.isEmpty(nodes))\n+                throw new ClusterTopologyException(\"Failed to execute the query \" +\n+                    \"(all affinity nodes left the grid) [cache=\" + cctx.name() +\n+                    \", qry=\" + qry +\n+                    \", startTopVer=\" + cctx.versions().last().topologyVersion() +\n+                    \", curTopVer=\" + qryMgr.queryTopologyVersion().topologyVersion() + ']');\n+\n             init();\n         }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/177d7f49934e24e85472a8e44a641c4b57a25914/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java",
                "sha": "3ecacf840dd453994ef4c51c5fb03fdb9337a1dd",
                "status": "modified"
            },
            {
                "additions": 142,
                "blob_url": "https://github.com/apache/ignite/blob/177d7f49934e24e85472a8e44a641c4b57a25914/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/IgniteCacheQueryCacheDestroySelfTest.java",
                "changes": 142,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/IgniteCacheQueryCacheDestroySelfTest.java?ref=177d7f49934e24e85472a8e44a641c4b57a25914",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/IgniteCacheQueryCacheDestroySelfTest.java",
                "patch": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query;\n+\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import javax.cache.Cache;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.CacheAtomicityMode;\n+import org.apache.ignite.cache.CacheMemoryMode;\n+import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.cache.CacheRebalanceMode;\n+import org.apache.ignite.cache.CacheWriteSynchronizationMode;\n+import org.apache.ignite.cache.query.QueryCursor;\n+import org.apache.ignite.cache.query.ScanQuery;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.internal.util.typedef.X;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.lang.IgniteBiPredicate;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * The test for the destruction of the cache during the execution of the query\n+ */\n+public class IgniteCacheQueryCacheDestroySelfTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final String CACHE_NAME = \"cache\";\n+\n+    /** */\n+    public static final int GRID_CNT = 3;\n+\n+    /**\n+     * The main test code.\n+     */\n+    public void testQueue() throws Throwable {\n+        startGridsMultiThreaded(GRID_CNT);\n+\n+        Ignite ig = ignite(0);\n+\n+        ig.getOrCreateCache(cacheConfiguration());\n+\n+        final AtomicBoolean stop = new AtomicBoolean();\n+        final AtomicReference<Exception> npe = new AtomicReference<>();\n+\n+        IgniteInternalFuture<Long> fut = GridTestUtils.runMultiThreadedAsync(new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                try {\n+                    while (!stop.get())\n+                        runQuery();\n+                }\n+                catch (Exception e) {\n+                    NullPointerException npe0 = X.cause(e, NullPointerException.class);\n+\n+                    if (npe0 != null)\n+                        npe.compareAndSet(null, npe0);\n+                    else\n+                        info(\"Expected exception: \" + e);\n+                }\n+\n+                return null;\n+            }\n+        }, 6, \"query-runner\");\n+\n+        U.sleep(500);\n+\n+        ig.destroyCache(CACHE_NAME);\n+\n+        stop.set(true);\n+\n+        fut.get();\n+\n+        assertNull(npe.get());\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    private void runQuery() throws Exception {\n+        ScanQuery<String, String> scanQuery = new ScanQuery<String, String>()\n+            .setLocal(true)\n+            .setFilter(new IgniteBiPredicate<String, String>() {\n+                @Override public boolean apply(String key, String p) {\n+                    return key != null && key.isEmpty();\n+                }\n+            });\n+\n+        Ignite ignite = ignite(ThreadLocalRandom.current().nextInt(GRID_CNT));\n+\n+        IgniteCache<String, String> example = ignite.cache(CACHE_NAME);\n+\n+        for (int partition : ignite.affinity(CACHE_NAME).primaryPartitions(ignite.cluster().localNode())) {\n+            scanQuery.setPartition(partition);\n+\n+            try (QueryCursor cursor = example.query(scanQuery)) {\n+                for (Object p : cursor) {\n+                    String value = (String) ((Cache.Entry)p).getValue();\n+\n+                    assertNotNull(value);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * @return Cache configuration for this test.\n+     */\n+    private CacheConfiguration cacheConfiguration() {\n+        CacheConfiguration cfg = new CacheConfiguration(CACHE_NAME);\n+\n+        cfg.setAtomicityMode(CacheAtomicityMode.ATOMIC)\n+            .setCacheMode(CacheMode.PARTITIONED)\n+            .setMemoryMode(CacheMemoryMode.OFFHEAP_TIERED)\n+            .setRebalanceMode(CacheRebalanceMode.SYNC)\n+            .setWriteSynchronizationMode(CacheWriteSynchronizationMode.FULL_SYNC)\n+            .setRebalanceThrottle(100)\n+            .setRebalanceBatchSize(2 * 1024 * 1024)\n+            .setBackups(1)\n+            .setEagerTtl(false);\n+\n+        return cfg;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/177d7f49934e24e85472a8e44a641c4b57a25914/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/IgniteCacheQueryCacheDestroySelfTest.java",
                "sha": "dc104ff229fe5bf69c176d53bd3326c3a916504c",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/177d7f49934e24e85472a8e44a641c4b57a25914/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java?ref=177d7f49934e24e85472a8e44a641c4b57a25914",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "patch": "@@ -92,6 +92,7 @@\n import org.apache.ignite.internal.processors.cache.local.IgniteCacheLocalQuerySelfTest;\n import org.apache.ignite.internal.processors.cache.query.GridCacheQueryTransformerSelfTest;\n import org.apache.ignite.internal.processors.cache.query.GridCacheSwapScanQuerySelfTest;\n+import org.apache.ignite.internal.processors.cache.query.IgniteCacheQueryCacheDestroySelfTest;\n import org.apache.ignite.internal.processors.cache.query.IndexingSpiQuerySelfTest;\n import org.apache.ignite.internal.processors.cache.query.IndexingSpiQueryTxSelfTest;\n import org.apache.ignite.internal.processors.query.IgniteSqlSchemaIndexingTest;\n@@ -238,6 +239,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(CacheQueryNewClientSelfTest.class);\n         suite.addTestSuite(CacheOffheapBatchIndexingSingleTypeTest.class);\n         suite.addTestSuite(CacheSqlQueryValueCopySelfTest.class);\n+        suite.addTestSuite(IgniteCacheQueryCacheDestroySelfTest.class);\n \n         return suite;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/177d7f49934e24e85472a8e44a641c4b57a25914/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "sha": "b5e40782a81096737b064f8c680c3e3e7ac2da27",
                "status": "modified"
            }
        ],
        "message": "IGNITE-4487 Fixed NPE on query execution during concurrent cache destroy. This closes #1388",
        "parent": "https://github.com/apache/ignite/commit/7b711a3248b0dafdcea195766b50be4d44656f7f",
        "patched_files": [
            "GridCacheQueryAdapter.java",
            "IgniteCacheQuerySelfTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCacheQueryCacheDestroySelfTest.java"
        ]
    },
    "ignite_18bdfe9": {
        "bug_id": "ignite_18bdfe9",
        "commit": "https://github.com/apache/ignite/commit/18bdfe96a1e579371108c661e3374183c58a296d",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/18bdfe96a1e579371108c661e3374183c58a296d/modules/core/src/test/java/org/apache/ignite/internal/processors/database/BPlusTreeSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/database/BPlusTreeSelfTest.java?ref=18bdfe96a1e579371108c661e3374183c58a296d",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/database/BPlusTreeSelfTest.java",
                "patch": "@@ -1774,7 +1774,9 @@ private void checkNotRemoved(Long row) {\n      * @return Page memory.\n      */\n     protected PageMemory createPageMemory() throws Exception {\n-        MemoryPolicyConfiguration plcCfg = new MemoryPolicyConfiguration().setMaxSize(1024 * MB);\n+        MemoryPolicyConfiguration plcCfg = new MemoryPolicyConfiguration()\n+            .setInitialSize(1024 * MB)\n+            .setMaxSize(1024 * MB);\n \n         PageMemory pageMem = new PageMemoryNoStoreImpl(log,\n             new UnsafeMemoryProvider(log),",
                "raw_url": "https://github.com/apache/ignite/raw/18bdfe96a1e579371108c661e3374183c58a296d/modules/core/src/test/java/org/apache/ignite/internal/processors/database/BPlusTreeSelfTest.java",
                "sha": "4a32df27c08aabba6be5221a2c0d7cf810670128",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/18bdfe96a1e579371108c661e3374183c58a296d/modules/core/src/test/java/org/apache/ignite/internal/processors/database/FreeListImplSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/database/FreeListImplSelfTest.java?ref=18bdfe96a1e579371108c661e3374183c58a296d",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/database/FreeListImplSelfTest.java",
                "patch": "@@ -335,7 +335,9 @@ protected PageMemory createPageMemory(int pageSize, MemoryPolicyConfiguration pl\n      * @throws Exception If failed.\n      */\n     protected FreeList createFreeList(int pageSize) throws Exception {\n-        MemoryPolicyConfiguration plcCfg = new MemoryPolicyConfiguration().setMaxSize(1024 * MB);\n+        MemoryPolicyConfiguration plcCfg = new MemoryPolicyConfiguration()\n+            .setInitialSize(1024 * MB)\n+            .setMaxSize(1024 * MB);\n \n         pageMem = createPageMemory(pageSize, plcCfg);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/18bdfe96a1e579371108c661e3374183c58a296d/modules/core/src/test/java/org/apache/ignite/internal/processors/database/FreeListImplSelfTest.java",
                "sha": "c190b1d559eb57b48127546a8c0f822f53d62c33",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in tests",
        "parent": "https://github.com/apache/ignite/commit/3c1749da82e663500e45a34369eac48dbbc62bdc",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "FreeListImplSelfTest.java",
            "BPlusTreeSelfTest.java"
        ]
    },
    "ignite_19c990c": {
        "bug_id": "ignite_19c990c",
        "commit": "https://github.com/apache/ignite/commit/19c990ce58825f7c39deb4f524b7a60b328e286c",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/19c990ce58825f7c39deb4f524b7a60b328e286c/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/binary/CacheObjectBinaryProcessorImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/binary/CacheObjectBinaryProcessorImpl.java?ref=19c990ce58825f7c39deb4f524b7a60b328e286c",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/binary/CacheObjectBinaryProcessorImpl.java",
                "patch": "@@ -492,7 +492,8 @@ public GridBinaryMarshaller marshaller() {\n         try {\n             BinaryMetadata mergedMeta = BinaryUtils.mergeMetadata(oldMeta, newMeta0);\n \n-            metadataFileStore.mergeAndWriteMetadata(mergedMeta);\n+            if (!ctx.clientNode())\n+                metadataFileStore.mergeAndWriteMetadata(mergedMeta);\n \n             metadataLocCache.put(typeId, new BinaryMetadataHolder(mergedMeta, 0, 0));\n         }\n@@ -1016,7 +1017,8 @@ private IgniteNodeValidationResult validateBinaryMetadata(UUID rmtNodeId, Map<In\n                             localMetaHolder.pendingVersion(),\n                             localMetaHolder.acceptedVersion()));\n \n-                    metadataFileStore.writeMetadata(mergedMeta);\n+                    if (!ctx.clientNode())\n+                        metadataFileStore.writeMetadata(mergedMeta);\n                 }\n             }\n             else {\n@@ -1032,7 +1034,8 @@ private IgniteNodeValidationResult validateBinaryMetadata(UUID rmtNodeId, Map<In\n \n                 metadataLocCache.put(metaEntry.getKey(), newMetaHolder);\n \n-                metadataFileStore.writeMetadata(newMeta);\n+                if (!ctx.clientNode())\n+                    metadataFileStore.writeMetadata(newMeta);\n             }\n         }\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/19c990ce58825f7c39deb4f524b7a60b328e286c/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/binary/CacheObjectBinaryProcessorImpl.java",
                "sha": "4c101b290fd54f613b7b617ad1368d85565ed0df",
                "status": "modified"
            },
            {
                "additions": 125,
                "blob_url": "https://github.com/apache/ignite/blob/19c990ce58825f7c39deb4f524b7a60b328e286c/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest.java",
                "changes": 125,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest.java?ref=19c990ce58825f7c39deb4f524b7a60b328e286c",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest.java",
                "patch": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence;\n+\n+import java.util.Arrays;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.binary.BinaryObject;\n+import org.apache.ignite.binary.BinaryObjectBuilder;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.lang.IgniteBiTuple;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ *\n+ */\n+public class IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final TcpDiscoveryIpFinder IP_FINDER = new TcpDiscoveryVmIpFinder(true);\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        if (\"client\".equals(igniteInstanceName))\n+            cfg.setClientMode(true).setFailureHandler(new StopNodeFailureHandler());\n+\n+        return cfg.setDiscoverySpi(new TcpDiscoverySpi()\n+                .setIpFinder(IP_FINDER))\n+                .setDataStorageConfiguration(new DataStorageConfiguration()\n+                        .setDefaultDataRegionConfiguration(new DataRegionConfiguration()\n+                                .setPersistenceEnabled(true)));\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /**\n+     * Tests that joining node metadata correctly handled on client.\n+     * @throws Exception If fails.\n+     */\n+    public void testJoiningNodeBinaryMetaOnClient() throws Exception {\n+        IgniteEx ig0 = (IgniteEx)startGrids(2);\n+\n+        ig0.cluster().active(true);\n+\n+        addBinaryType(ig0, \"test_1\", new IgniteBiTuple<>(\"name\", String.class));\n+\n+        stopGrid(0);\n+\n+        Ignite ig1 = grid(1);\n+\n+        // Modify existing type.\n+        addBinaryType(ig1, \"test_1\", new IgniteBiTuple<>(\"id\", Integer.class));\n+\n+        // Add new type.\n+        addBinaryType(ig1, \"test_2\", new IgniteBiTuple<>(\"name\", String.class));\n+\n+        stopGrid(1);\n+\n+        startGrid(0);\n+\n+        IgniteEx client = startGrid(getConfiguration(\"client\"));\n+\n+        startGrid(1);\n+\n+        awaitPartitionMapExchange();\n+\n+        // Check that new metadata from grid_1 was handled without NPE on client.\n+        assertNull(client.context().failure().failureContext());\n+\n+        // Check that metadata from grid_1 correctly loaded on client.\n+        assertTrue(client.binary().type(\"test_1\").fieldNames().containsAll(Arrays.asList(\"id\", \"name\")));\n+        assertTrue(client.binary().type(\"test_2\").fieldNames().contains(\"name\"));\n+    }\n+\n+    /**\n+     * @param ig Ig.\n+     * @param typeName Type name.\n+     * @param fields Fields.\n+     */\n+    @SafeVarargs\n+    private final BinaryObject addBinaryType(Ignite ig, String typeName, IgniteBiTuple<String, Class<?>>... fields) {\n+        BinaryObjectBuilder builder = ig.binary().builder(typeName);\n+\n+        if (fields != null) {\n+            for (IgniteBiTuple<String,Class<?>> field: fields)\n+                builder.setField(field.get1(), field.get2());\n+        }\n+\n+        return builder.build();\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/19c990ce58825f7c39deb4f524b7a60b328e286c/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest.java",
                "sha": "279d3c8c4e62090b5225fe1019f1ce0557e4fee9",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/19c990ce58825f7c39deb4f524b7a60b328e286c/modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java?ref=19c990ce58825f7c39deb4f524b7a60b328e286c",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java",
                "patch": "@@ -20,6 +20,7 @@\n import junit.framework.TestSuite;\n import org.apache.ignite.internal.pagemem.impl.PageMemoryNoLoadSelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteClusterActivateDeactivateTestWithPersistence;\n+import org.apache.ignite.internal.processors.cache.persistence.IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest;\n import org.apache.ignite.internal.processors.cache.persistence.IgnitePdsDestroyCacheTest;\n import org.apache.ignite.internal.processors.cache.persistence.IgnitePdsDestroyCacheWithoutCheckpointsTest;\n import org.apache.ignite.internal.processors.cache.persistence.IgnitePdsCacheConfigurationFileConsistencyCheckTest;\n@@ -95,6 +96,9 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(ExplicitWalDeltaConsistencyTest.class);\n         suite.addTestSuite(SysPropWalDeltaConsistencyTest.class);\n \n+        // Binary meta tests.\n+        suite.addTestSuite(IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest.class);\n+\n         return suite;\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/19c990ce58825f7c39deb4f524b7a60b328e286c/modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java",
                "sha": "9f50b328916b1e613951fee7923ad3db01f17e84",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9422 Fixed NPE on clients when new binary meta from joined node arrived. - Fixes #4681.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/7f22f08f7db0f45a5cde97307c68fc81cb6eb26c",
        "patched_files": [
            "IgnitePdsTestSuite.java",
            "CacheObjectBinaryProcessorImpl.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgnitePdsCacheObjectBinaryProcessorOnDiscoveryTest.java"
        ]
    },
    "ignite_1adbc44": {
        "bug_id": "ignite_1adbc44",
        "commit": "https://github.com/apache/ignite/commit/1adbc44d1b5d22616a42190082a5f0a24624c074",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java",
                "patch": "@@ -2358,7 +2358,7 @@ else if (err != null)\n         /**\n          *\n          */\n-        private void body0() throws InterruptedException, IgniteInterruptedCheckedException {\n+        private void body0() throws InterruptedException, IgniteCheckedException {\n             long timeout = cctx.gridConfig().getNetworkTimeout();\n \n             long cnt = 0;\n@@ -2662,6 +2662,8 @@ else if (r != null) {\n                 catch (IgniteCheckedException e) {\n                     U.error(log, \"Failed to wait for completion of partition map exchange \" +\n                         \"(preloading will not start): \" + task, e);\n+\n+                    throw e;\n                 }\n             }\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCachePartitionExchangeManager.java",
                "sha": "3a990892bfe8d6b2e325ca05f4f6ef9d387e3d84",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/failure/FailureHandlerTriggeredTest.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/failure/FailureHandlerTriggeredTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 35,
                "filename": "modules/core/src/test/java/org/apache/ignite/failure/FailureHandlerTriggeredTest.java",
                "patch": "@@ -19,7 +19,6 @@\n \n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n-import org.apache.ignite.Ignite;\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.managers.discovery.DiscoveryCustomMessage;\n import org.apache.ignite.internal.processors.cache.CachePartitionExchangeWorkerTask;\n@@ -66,40 +65,6 @@ public void testFailureHandlerTriggeredOnExchangeWorkerTermination() throws Exce\n         }\n     }\n \n-    /**\n-     * Test failure handler implementation\n-     */\n-    private class TestFailureHandler implements FailureHandler {\n-        /** Invalidate. */\n-        private final boolean invalidate;\n-\n-        /** Latch. */\n-        private final CountDownLatch latch;\n-\n-        /** Failure context. */\n-        volatile FailureContext failureCtx;\n-\n-        /**\n-         * @param invalidate Invalidate.\n-         * @param latch Latch.\n-         */\n-        TestFailureHandler(boolean invalidate, CountDownLatch latch) {\n-            this.invalidate = invalidate;\n-            this.latch = latch;\n-        }\n-\n-        /** {@inheritDoc} */\n-        @Override public boolean onFailure(Ignite ignite, FailureContext failureCtx) {\n-            this.failureCtx = failureCtx;\n-\n-            this.latch.countDown();\n-\n-            ignite.log().warning(\"Handled ignite failure: \" + failureCtx);\n-\n-            return invalidate;\n-        }\n-    }\n-\n     /**\n      * Custom exchange worker task implementation for delaying exchange worker processing.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/failure/FailureHandlerTriggeredTest.java",
                "sha": "8d56ced75f2cca11e5c8884646615f907ea8b3ae",
                "status": "modified"
            },
            {
                "additions": 63,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/failure/TestFailureHandler.java",
                "changes": 63,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/failure/TestFailureHandler.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/failure/TestFailureHandler.java",
                "patch": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.failure;\n+\n+import java.util.concurrent.CountDownLatch;\n+import org.apache.ignite.Ignite;\n+\n+/**\n+ * Test failure handler implementation\n+ */\n+public class TestFailureHandler implements FailureHandler {\n+    /** Invalidate. */\n+    private final boolean invalidate;\n+\n+    /** Latch. */\n+    private final CountDownLatch latch;\n+\n+    /** Failure context. */\n+    volatile FailureContext failureCtx;\n+\n+    /**\n+     * @param invalidate Invalidate.\n+     * @param latch Latch.\n+     */\n+    public TestFailureHandler(boolean invalidate, CountDownLatch latch) {\n+        this.invalidate = invalidate;\n+        this.latch = latch;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public boolean onFailure(Ignite ignite, FailureContext failureCtx) {\n+        this.failureCtx = failureCtx;\n+\n+        if (latch != null)\n+            latch.countDown();\n+\n+        ignite.log().warning(\"Handled ignite failure: \" + failureCtx);\n+\n+        return invalidate;\n+    }\n+\n+    /**\n+     * @return Failure context.\n+     */\n+    public FailureContext failureContext() {\n+        return failureCtx;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/failure/TestFailureHandler.java",
                "sha": "1159683e6b54f5045d62accb9afc3dffd00e3738",
                "status": "added"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/internal/IgniteClientRejoinTest.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/IgniteClientRejoinTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/IgniteClientRejoinTest.java",
                "patch": "@@ -27,6 +27,7 @@\n import java.util.Random;\n import java.util.concurrent.Callable;\n import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n import org.apache.ignite.IgniteCheckedException;\n@@ -35,6 +36,7 @@\n import org.apache.ignite.Ignition;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.TestFailureHandler;\n import org.apache.ignite.internal.util.typedef.internal.U;\n import org.apache.ignite.lang.IgniteInClosure;\n import org.apache.ignite.plugin.extensions.communication.Message;\n@@ -282,14 +284,19 @@ public void testClientsReconnectDisabled() throws Exception {\n \n         final int CLIENTS_NUM = 5;\n \n+        final CountDownLatch failureHndLatch = new CountDownLatch(CLIENTS_NUM);\n+\n         for (int i = 0; i < CLIENTS_NUM; i++) {\n             final int idx = i;\n \n             IgniteInternalFuture<Ignite> fut = GridTestUtils.runAsync(new Callable<Ignite>() {\n                 @Override public Ignite call() throws Exception {\n                     latch.await();\n \n-                    return startGrid(\"client\" + idx);\n+                    String igniteInstanceName = \"client\" + idx;\n+\n+                    return startGrid(igniteInstanceName, getConfiguration(igniteInstanceName)\n+                        .setFailureHandler(new TestFailureHandler(true, failureHndLatch)));\n                 }\n             });\n \n@@ -309,6 +316,8 @@ public void testClientsReconnectDisabled() throws Exception {\n             }, IgniteCheckedException.class, null);\n         }\n \n+        assertTrue(failureHndLatch.await(1000, TimeUnit.MILLISECONDS));\n+\n         assertEquals(0, srv1.cluster().forClients().nodes().size());\n         assertEquals(0, srv2.cluster().forClients().nodes().size());\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/internal/IgniteClientRejoinTest.java",
                "sha": "9a98a888aa2cb786dc332939848ea043c5d8dfa4",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteChangeGlobalStateTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteChangeGlobalStateTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteChangeGlobalStateTest.java",
                "patch": "@@ -543,6 +543,8 @@ public void testFailGetLock() throws Exception {\n      * @throws Exception If failed.\n      */\n     public void testActivateAfterFailGetLock() throws Exception {\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n+\n         Ignite ig1P = primary(0);\n         Ignite ig2P = primary(1);\n         Ignite ig3P = primary(2);",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteChangeGlobalStateTest.java",
                "sha": "9152ab90319dfef2732be868e1664fac6c2b577a",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/hibernate-4.2/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hibernate-4.2/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 0,
                "filename": "modules/hibernate-4.2/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java",
                "patch": "@@ -83,6 +83,8 @@ public void testXmlConfiguration() throws Exception {\n      * @throws Exception If failed.\n      */\n     public void testIncorrectBeanConfiguration() throws Exception {\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n+\n         GridTestUtils.assertThrows(log, new Callable<Object>() {\n             @Override public Object call() throws Exception {\n                 try(Ignite ignite =",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/hibernate-4.2/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java",
                "sha": "db0e1bebe80265fa28baec24e7b6ca0a62705b58",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/hibernate-5.1/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hibernate-5.1/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 0,
                "filename": "modules/hibernate-5.1/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java",
                "patch": "@@ -83,6 +83,8 @@ public void testXmlConfiguration() throws Exception {\n      * @throws Exception If failed.\n      */\n     public void testIncorrectBeanConfiguration() throws Exception {\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n+\n         GridTestUtils.assertThrows(log, new Callable<Object>() {\n             @Override public Object call() throws Exception {\n                 try(Ignite ignite =",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/hibernate-5.1/src/test/java/org/apache/ignite/cache/store/hibernate/CacheHibernateStoreFactorySelfTest.java",
                "sha": "0ffe52ef1176f8480a41ec7603beb7505d0c315e",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/IgniteSqlSchemaIndexingTest.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/IgniteSqlSchemaIndexingTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 1,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/IgniteSqlSchemaIndexingTest.java",
                "patch": "@@ -87,7 +87,8 @@ private static CacheConfiguration cacheConfig(String name, boolean partitioned,\n      */\n     public void testCaseSensitive() throws Exception {\n         //TODO rewrite with dynamic cache creation, and GRID start in #beforeTest after resolve of\n-        //https://issues.apache.org/jira/browse/IGNITE-1094\n+        //TODO https://issues.apache.org/jira/browse/IGNITE-1094\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n \n         GridTestUtils.assertThrows(log, new Callable<Object>() {\n             @Override public Object call() throws Exception {\n@@ -117,6 +118,8 @@ public void testCaseSensitive() throws Exception {\n     public void testCustomSchemaMultipleCachesTablesCollision() throws Exception {\n         //TODO: Rewrite with dynamic cache creation, and GRID start in #beforeTest after resolve of\n         //TODO: https://issues.apache.org/jira/browse/IGNITE-1094\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n+\n         GridTestUtils.assertThrows(log, new Callable<Object>() {\n             @Override public Object call() throws Exception {\n                 final CacheConfiguration cfg = cacheConfig(\"cache1\", true, Integer.class, Fact.class)",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/IgniteSqlSchemaIndexingTest.java",
                "sha": "2dee617502424deffd6be1da0cccdc42ff72a86e",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcBlobStoreFactorySelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcBlobStoreFactorySelfTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 0,
                "filename": "modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcBlobStoreFactorySelfTest.java",
                "patch": "@@ -77,6 +77,8 @@ public void testCacheConfiguration() throws Exception {\n      * @throws Exception If failed.\n      */\n     public void testIncorrectBeanConfiguration() throws Exception {\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n+\n         GridTestUtils.assertThrows(log, new Callable<Object>() {\n             @Override public Object call() throws Exception {\n                 try(Ignite ignite = Ignition.start(\"modules/spring/src/test/config/incorrect-store-cache.xml\")) {",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcBlobStoreFactorySelfTest.java",
                "sha": "be2238bd8bf9368dbec50b07258af758263e1bed",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStoreFactorySelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStoreFactorySelfTest.java?ref=1adbc44d1b5d22616a42190082a5f0a24624c074",
                "deletions": 0,
                "filename": "modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStoreFactorySelfTest.java",
                "patch": "@@ -69,6 +69,8 @@ public void testSerializable() throws Exception {\n      * @throws Exception If failed.\n      */\n     public void testIncorrectBeanConfiguration() throws Exception {\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-1094\");\n+\n         GridTestUtils.assertThrowsAnyCause(log, new Callable<Object>() {\n             @Override public Object call() throws Exception {\n                 try (Ignite ignored = Ignition.start(\"modules/spring/src/test/config/pojo-incorrect-store-cache.xml\")) {",
                "raw_url": "https://github.com/apache/ignite/raw/1adbc44d1b5d22616a42190082a5f0a24624c074/modules/spring/src/test/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStoreFactorySelfTest.java",
                "sha": "ba4984d22cab924000545b2de71025a812702803",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8311 IgniteClientRejoinTest.testClientsReconnectDisabled causes exchange-worker to terminate via NPE\n\nSigned-off-by: Andrey Gura <agura@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/ecca4ca252e0d8d9cd5123ca039bc2a8d9d3137f",
        "patched_files": [
            "FailureHandler.java",
            "GridCachePartitionExchangeManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "FailureHandlerTriggeredTest.java",
            "IgniteClientRejoinTest.java",
            "CacheJdbcBlobStoreFactorySelfTest.java",
            "CacheJdbcPojoStoreFactorySelfTest.java",
            "IgniteChangeGlobalStateTest.java",
            "TestFailureHandler.java",
            "CacheHibernateStoreFactorySelfTest.java",
            "IgniteSqlSchemaIndexingTest.java"
        ]
    },
    "ignite_1d9a953": {
        "bug_id": "ignite_1d9a953",
        "commit": "https://github.com/apache/ignite/commit/1d9a953a8786997dbcb6b86566f09b3622503be8",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/1d9a953a8786997dbcb6b86566f09b3622503be8/modules/indexing/src/main/java/org/apache/ignite/spi/metric/sql/MetricRegistryLocalSystemView.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/spi/metric/sql/MetricRegistryLocalSystemView.java?ref=1d9a953a8786997dbcb6b86566f09b3622503be8",
                "deletions": 1,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/spi/metric/sql/MetricRegistryLocalSystemView.java",
                "patch": "@@ -72,7 +72,7 @@ private boolean advance() {\n                 while (grps.hasNext()) {\n                     MetricRegistry mreg = grps.next();\n \n-                    if (!filter.test(mreg))\n+                    if (filter != null && !filter.test(mreg))\n                         continue;\n \n                     curr = mreg.iterator();",
                "raw_url": "https://github.com/apache/ignite/raw/1d9a953a8786997dbcb6b86566f09b3622503be8/modules/indexing/src/main/java/org/apache/ignite/spi/metric/sql/MetricRegistryLocalSystemView.java",
                "sha": "f44dfdb34e2327f4642b606cb944bdc505efe4f6",
                "status": "modified"
            },
            {
                "additions": 90,
                "blob_url": "https://github.com/apache/ignite/blob/1d9a953a8786997dbcb6b86566f09b3622503be8/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/metric/SqlViewExporterSpiTest.java",
                "changes": 167,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/metric/SqlViewExporterSpiTest.java?ref=1d9a953a8786997dbcb6b86566f09b3622503be8",
                "deletions": 77,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/metric/SqlViewExporterSpiTest.java",
                "patch": "@@ -72,7 +72,10 @@\n /** */\n public class SqlViewExporterSpiTest extends AbstractExporterSpiTest {\n     /** */\n-    private static IgniteEx ignite;\n+    private static IgniteEx ignite0;\n+\n+    /** */\n+    private static IgniteEx ignite1;\n \n     /** {@inheritDoc} */\n     @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n@@ -85,7 +88,8 @@\n \n         SqlViewMetricExporterSpi sqlSpi = new SqlViewMetricExporterSpi();\n \n-        sqlSpi.setExportFilter(mgrp -> !mgrp.name().startsWith(FILTERED_PREFIX));\n+        if (igniteInstanceName.endsWith(\"1\"))\n+            sqlSpi.setExportFilter(mgrp -> !mgrp.name().startsWith(FILTERED_PREFIX));\n \n         cfg.setMetricExporterSpi(sqlSpi);\n \n@@ -96,17 +100,18 @@\n     @Override protected void beforeTestsStarted() throws Exception {\n         cleanPersistenceDir();\n \n-        ignite = startGrid(0);\n+        ignite0 = startGrid(0);\n+        ignite1 = startGrid(1);\n \n-        ignite.cluster().active(true);\n+        ignite0.cluster().active(true);\n     }\n \n     /** {@inheritDoc} */\n     @Override protected void afterTest() throws Exception {\n-        Collection<String> caches = ignite.cacheNames();\n+        Collection<String> caches = ignite0.cacheNames();\n \n         for (String cache : caches)\n-            ignite.destroyCache(cache);\n+            ignite0.destroyCache(cache);\n     }\n \n     /** {@inheritDoc} */\n@@ -118,8 +123,17 @@\n \n     /** */\n     @Test\n-    public void testDataRegionJmxMetrics() throws Exception {\n-        List<List<?>> res = execute(ignite,\n+    public void testEmptyFilter() throws Exception {\n+        List<List<?>> res = execute(ignite0, \"SELECT * FROM SYS.METRICS\");\n+\n+        assertNotNull(res);\n+        assertFalse(res.isEmpty());\n+    }\n+\n+    /** */\n+    @Test\n+    public void testDataRegionMetrics() throws Exception {\n+        List<List<?>> res = execute(ignite0,\n             \"SELECT REPLACE(name, 'io.dataregion.default.'), value, description FROM SYS.METRICS\");\n \n         Set<String> names = new HashSet<>();\n@@ -137,10 +151,11 @@ public void testDataRegionJmxMetrics() throws Exception {\n     /** */\n     @Test\n     public void testFilterAndExport() throws Exception {\n-        createAdditionalMetrics(ignite);\n+        createAdditionalMetrics(ignite1);\n \n-        List<List<?>> res = execute(ignite,\n-            \"SELECT name, value, description FROM SYS.METRICS WHERE name LIKE 'other.prefix%'\");\n+        List<List<?>> res = execute(ignite1,\n+            \"SELECT name, value, description FROM SYS.METRICS \" +\n+                \"WHERE name LIKE 'other.prefix%' OR name LIKE '\" + FILTERED_PREFIX + \"%'\");\n \n         Set<IgniteBiTuple<String, String>> expVals = new HashSet<>(asList(\n             t(\"other.prefix.test\", \"42\"),\n@@ -162,11 +177,11 @@ public void testCachesView() throws Exception {\n         Set<String> cacheNames = new HashSet<>(asList(\"cache-1\", \"cache-2\"));\n \n         for (String name : cacheNames)\n-            ignite.createCache(name);\n+            ignite0.createCache(name);\n \n-        List<List<?>> caches = execute(ignite, \"SELECT CACHE_NAME FROM SYS.CACHES\");\n+        List<List<?>> caches = execute(ignite0, \"SELECT CACHE_NAME FROM SYS.CACHES\");\n \n-        assertEquals(ignite.context().cache().cacheDescriptors().size(), caches.size());\n+        assertEquals(ignite0.context().cache().cacheDescriptors().size(), caches.size());\n \n         for (List<?> row : caches)\n             cacheNames.remove(row.get(0));\n@@ -180,11 +195,11 @@ public void testCacheGroupsView() throws Exception {\n         Set<String> grpNames = new HashSet<>(asList(\"grp-1\", \"grp-2\"));\n \n         for (String grpName : grpNames)\n-            ignite.createCache(new CacheConfiguration<>(\"cache-\" + grpName).setGroupName(grpName));\n+            ignite0.createCache(new CacheConfiguration<>(\"cache-\" + grpName).setGroupName(grpName));\n \n-        List<List<?>> grps = execute(ignite, \"SELECT CACHE_GROUP_NAME FROM SYS.CACHE_GROUPS\");\n+        List<List<?>> grps = execute(ignite0, \"SELECT CACHE_GROUP_NAME FROM SYS.CACHE_GROUPS\");\n \n-        assertEquals(ignite.context().cache().cacheGroupDescriptors().size(), grps.size());\n+        assertEquals(ignite0.context().cache().cacheGroupDescriptors().size(), grps.size());\n \n         for (List<?> row : grps)\n             grpNames.remove(row.get(0));\n@@ -198,7 +213,7 @@ public void testComputeBroadcast() throws Exception {\n         CyclicBarrier barrier = new CyclicBarrier(6);\n \n         for (int i = 0; i < 5; i++) {\n-            ignite.compute().broadcastAsync(() -> {\n+            ignite0.compute().broadcastAsync(() -> {\n                 try {\n                     barrier.await();\n                     barrier.await();\n@@ -211,7 +226,7 @@ public void testComputeBroadcast() throws Exception {\n \n         barrier.await();\n \n-        List<List<?>> tasks = execute(ignite,\n+        List<List<?>> tasks = execute(ignite0,\n             \"SELECT \" +\n             \"  INTERNAL, \" +\n             \"  AFFINITY_CACHE_NAME, \" +\n@@ -231,7 +246,7 @@ public void testComputeBroadcast() throws Exception {\n         assertEquals(-1, t.get(2));\n         assertTrue(t.get(3).toString().startsWith(getClass().getName()));\n         assertTrue(t.get(4).toString().startsWith(getClass().getName()));\n-        assertEquals(ignite.localNode().id(), t.get(5));\n+        assertEquals(ignite0.localNode().id(), t.get(5));\n         assertEquals(\"0\", t.get(6));\n \n         barrier.await();\n@@ -246,9 +261,9 @@ public void testServices() throws Exception {\n         srvcCfg.setMaxPerNodeCount(1);\n         srvcCfg.setService(new DummyService());\n \n-        ignite.services().deploy(srvcCfg);\n+        ignite0.services().deploy(srvcCfg);\n \n-        List<List<?>> srvs = execute(ignite,\n+        List<List<?>> srvs = execute(ignite0,\n             \"SELECT \" +\n                 \"  NAME, \" +\n                 \"  SERVICE_ID, \" +\n@@ -262,7 +277,7 @@ public void testServices() throws Exception {\n                 \"  ORIGIN_NODE_ID \" +\n                 \"FROM SYS.SERVICES\");\n \n-        assertEquals(ignite.context().service().serviceDescriptors().size(), srvs.size());\n+        assertEquals(ignite0.context().service().serviceDescriptors().size(), srvs.size());\n \n         List<?> sysView = srvs.iterator().next();\n \n@@ -274,16 +289,16 @@ public void testServices() throws Exception {\n     /** */\n     @Test\n     public void testClientsConnections() throws Exception {\n-        String host = ignite.configuration().getClientConnectorConfiguration().getHost();\n+        String host = ignite0.configuration().getClientConnectorConfiguration().getHost();\n \n         if (host == null)\n-            host = ignite.configuration().getLocalHost();\n+            host = ignite0.configuration().getLocalHost();\n \n-        int port = ignite.configuration().getClientConnectorConfiguration().getPort();\n+        int port = ignite0.configuration().getClientConnectorConfiguration().getPort();\n \n         try (IgniteClient client = Ignition.startClient(new ClientConfiguration().setAddresses(host + \":\" + port))) {\n             try (Connection conn = new IgniteJdbcThinDriver().connect(\"jdbc:ignite:thin://\" + host, new Properties())) {\n-                List<List<?>> conns = execute(ignite, \"SELECT * FROM SYS.CLIENT_CONNECTIONS\");\n+                List<List<?>> conns = execute(ignite0, \"SELECT * FROM SYS.CLIENT_CONNECTIONS\");\n \n                 assertEquals(2, conns.size());\n             }\n@@ -293,18 +308,18 @@ public void testClientsConnections() throws Exception {\n     /** */\n     @Test\n     public void testTransactions() throws Exception {\n-        IgniteCache<Integer, Integer> cache = ignite.createCache(new CacheConfiguration<Integer, Integer>(\"c\")\n+        IgniteCache<Integer, Integer> cache = ignite0.createCache(new CacheConfiguration<Integer, Integer>(\"c\")\n             .setAtomicityMode(CacheAtomicityMode.TRANSACTIONAL));\n \n-        assertTrue(execute(ignite, \"SELECT * FROM SYS.TRANSACTIONS\").isEmpty());\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.TRANSACTIONS\").isEmpty());\n \n         CountDownLatch latch1 = new CountDownLatch(10);\n         CountDownLatch latch2 = new CountDownLatch(1);\n \n         AtomicInteger cntr = new AtomicInteger();\n \n         GridTestUtils.runMultiThreadedAsync(() -> {\n-            try (Transaction tx = ignite.transactions().withLabel(\"test\").txStart(PESSIMISTIC, REPEATABLE_READ)) {\n+            try (Transaction tx = ignite0.transactions().withLabel(\"test\").txStart(PESSIMISTIC, REPEATABLE_READ)) {\n                 cache.put(cntr.incrementAndGet(), cntr.incrementAndGet());\n                 cache.put(cntr.incrementAndGet(), cntr.incrementAndGet());\n \n@@ -317,7 +332,7 @@ public void testTransactions() throws Exception {\n         }, 5, \"xxx\");\n \n         GridTestUtils.runMultiThreadedAsync(() -> {\n-            try (Transaction tx = ignite.transactions().txStart(OPTIMISTIC, SERIALIZABLE)) {\n+            try (Transaction tx = ignite0.transactions().txStart(OPTIMISTIC, SERIALIZABLE)) {\n                 cache.put(cntr.incrementAndGet(), cntr.incrementAndGet());\n                 cache.put(cntr.incrementAndGet(), cntr.incrementAndGet());\n \n@@ -331,13 +346,13 @@ public void testTransactions() throws Exception {\n \n         latch1.await(5, TimeUnit.SECONDS);\n \n-        List<List<?>> txs = execute(ignite, \"SELECT * FROM SYS.TRANSACTIONS\");\n+        List<List<?>> txs = execute(ignite0, \"SELECT * FROM SYS.TRANSACTIONS\");\n \n         assertEquals(10, txs.size());\n \n         latch2.countDown();\n \n-        boolean res = waitForCondition(() -> execute(ignite, \"SELECT * FROM SYS.TRANSACTIONS\").isEmpty(), 5_000);\n+        boolean res = waitForCondition(() -> execute(ignite0, \"SELECT * FROM SYS.TRANSACTIONS\").isEmpty(), 5_000);\n \n         assertTrue(res);\n     }\n@@ -394,7 +409,7 @@ public void testViews() throws Exception {\n \n         Set<String> actViews = new HashSet<>();\n \n-        List<List<?>> res = execute(ignite, \"SELECT * FROM SYS.VIEWS\");\n+        List<List<?>> res = execute(ignite0, \"SELECT * FROM SYS.VIEWS\");\n \n         for (List<?> row : res)\n             actViews.add(row.get(0).toString());\n@@ -405,11 +420,11 @@ public void testViews() throws Exception {\n     /** */\n     @Test\n     public void testTable() throws Exception {\n-        assertTrue(execute(ignite, \"SELECT * FROM SYS.TABLES\").isEmpty());\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.TABLES\").isEmpty());\n \n-        execute(ignite, \"CREATE TABLE T1(ID LONG PRIMARY KEY, NAME VARCHAR)\");\n+        execute(ignite0, \"CREATE TABLE T1(ID LONG PRIMARY KEY, NAME VARCHAR)\");\n \n-        List<List<?>> res = execute(ignite, \"SELECT * FROM SYS.TABLES\");\n+        List<List<?>> res = execute(ignite0, \"SELECT * FROM SYS.TABLES\");\n \n         assertEquals(1, res.size());\n \n@@ -428,31 +443,31 @@ public void testTable() throws Exception {\n         assertEquals(\"java.lang.Long\", tbl.get(7)); // KEY_TYPE_NAME\n         assertNotNull(tbl.get(8)); // VALUE_TYPE_NAME\n \n-        execute(ignite, \"CREATE TABLE T2(ID LONG PRIMARY KEY, NAME VARCHAR)\");\n+        execute(ignite0, \"CREATE TABLE T2(ID LONG PRIMARY KEY, NAME VARCHAR)\");\n \n-        assertEquals(2, execute(ignite, \"SELECT * FROM SYS.TABLES\").size());\n+        assertEquals(2, execute(ignite0, \"SELECT * FROM SYS.TABLES\").size());\n \n-        execute(ignite, \"DROP TABLE T1\");\n-        execute(ignite, \"DROP TABLE T2\");\n+        execute(ignite0, \"DROP TABLE T1\");\n+        execute(ignite0, \"DROP TABLE T2\");\n \n-        assertTrue(execute(ignite, \"SELECT * FROM SYS.TABLES\").isEmpty());\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.TABLES\").isEmpty());\n     }\n \n     /** */\n     @Test\n     public void testTableColumns() throws Exception {\n-        assertTrue(execute(ignite, \"SELECT * FROM SYS.TABLE_COLUMNS\").isEmpty());\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.TABLE_COLUMNS\").isEmpty());\n \n-        execute(ignite, \"CREATE TABLE T1(ID LONG PRIMARY KEY, NAME VARCHAR(40))\");\n+        execute(ignite0, \"CREATE TABLE T1(ID LONG PRIMARY KEY, NAME VARCHAR(40))\");\n \n-        Set<?> actCols = execute(ignite, \"SELECT * FROM SYS.TABLE_COLUMNS\")\n+        Set<?> actCols = execute(ignite0, \"SELECT * FROM SYS.TABLE_COLUMNS\")\n             .stream()\n             .map(l -> l.get(0))\n             .collect(Collectors.toSet());\n \n         assertEquals(new HashSet<>(asList(\"ID\", \"NAME\", \"_KEY\", \"_VAL\")), actCols);\n \n-        execute(ignite, \"CREATE TABLE T2(ID LONG PRIMARY KEY, NAME VARCHAR(50))\");\n+        execute(ignite0, \"CREATE TABLE T2(ID LONG PRIMARY KEY, NAME VARCHAR(50))\");\n \n         List<List<?>> expRes = asList(\n             asList(\"ID\", \"T1\", \"PUBLIC\", false, false, \"null\", true, true, -1, -1, Long.class.getName()),\n@@ -465,20 +480,20 @@ public void testTableColumns() throws Exception {\n             asList(\"_VAL\", \"T2\", \"PUBLIC\", false, false, null, true, false, -1, -1, null)\n         );\n \n-        List<List<?>> res = execute(ignite, \"SELECT * FROM SYS.TABLE_COLUMNS ORDER BY TABLE_NAME, COLUMN_NAME\");\n+        List<List<?>> res = execute(ignite0, \"SELECT * FROM SYS.TABLE_COLUMNS ORDER BY TABLE_NAME, COLUMN_NAME\");\n \n         assertEquals(expRes, res);\n \n-        execute(ignite, \"DROP TABLE T1\");\n-        execute(ignite, \"DROP TABLE T2\");\n+        execute(ignite0, \"DROP TABLE T1\");\n+        execute(ignite0, \"DROP TABLE T2\");\n \n-        assertTrue(execute(ignite, \"SELECT * FROM SYS.TABLE_COLUMNS\").isEmpty());\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.TABLE_COLUMNS\").isEmpty());\n     }\n \n     /** */\n     @Test\n     public void testViewColumns() throws Exception {\n-        execute(ignite, \"SELECT * FROM SYS.VIEW_COLUMNS\");\n+        execute(ignite0, \"SELECT * FROM SYS.VIEW_COLUMNS\");\n \n         List<List<?>> expRes = asList(\n             asList(\"CONNECTION_ID\", \"CLIENT_CONNECTIONS\", SCHEMA_SYS, \"null\", true, 19L, 0, Long.class.getName()),\n@@ -494,39 +509,37 @@ public void testViewColumns() throws Exception {\n                 String.class.getName())\n         );\n \n-        List<List<?>> res = execute(ignite, \"SELECT * FROM SYS.VIEW_COLUMNS WHERE VIEW_NAME = 'CLIENT_CONNECTIONS'\");\n+        List<List<?>> res = execute(ignite0, \"SELECT * FROM SYS.VIEW_COLUMNS WHERE VIEW_NAME = 'CLIENT_CONNECTIONS'\");\n \n         assertEquals(expRes, res);\n     }\n \n     /** */\n     @Test\n     public void testContinuousQuery() throws Exception {\n-        try(IgniteEx remoteNode = startGrid(1)) {\n-            IgniteCache<Integer, Integer> cache = ignite.createCache(\"cache-1\");\n-\n-            assertTrue(execute(ignite, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n-            assertTrue(execute(remoteNode, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n-\n-            try(QueryCursor qry = cache.query(new ContinuousQuery<>()\n-                .setInitialQuery(new ScanQuery<>())\n-                .setPageSize(100)\n-                .setTimeInterval(1000)\n-                .setLocalListener(evts -> {\n-                    // No-op.\n-                })\n-                .setRemoteFilterFactory(() -> evt -> true)\n-            )) {\n-                for (int i=0; i<100; i++)\n-                    cache.put(i, i);\n-\n-                checkContinuouQueryView(ignite, true);\n-                checkContinuouQueryView(remoteNode, false);\n-            }\n-\n-            assertTrue(execute(ignite, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n-            assertTrue(execute(remoteNode, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n+        IgniteCache<Integer, Integer> cache = ignite0.createCache(\"cache-1\");\n+\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n+        assertTrue(execute(ignite1, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n+\n+        try (QueryCursor qry = cache.query(new ContinuousQuery<>()\n+            .setInitialQuery(new ScanQuery<>())\n+            .setPageSize(100)\n+            .setTimeInterval(1000)\n+            .setLocalListener(evts -> {\n+                // No-op.\n+            })\n+            .setRemoteFilterFactory(() -> evt -> true)\n+        )) {\n+            for (int i = 0; i < 100; i++)\n+                cache.put(i, i);\n+\n+            checkContinuouQueryView(ignite0, true);\n+            checkContinuouQueryView(ignite1, false);\n         }\n+\n+        assertTrue(execute(ignite0, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n+        assertTrue(execute(ignite1, \"SELECT * FROM SYS.QUERY_CONTINUOUS\").isEmpty());\n     }\n \n     /** */\n@@ -550,7 +563,7 @@ private void checkContinuouQueryView(IgniteEx g, boolean loc) {\n         assertEquals(\"cache-1\", cq.get(0));\n         assertEquals(100, cq.get(1));\n         assertEquals(1000L, cq.get(2));\n-        assertEquals(ignite.localNode().id(), cq.get(3));\n+        assertEquals(ignite0.localNode().id(), cq.get(3));\n \n         if (loc)\n             assertTrue(cq.get(4).toString().startsWith(getClass().getName()));",
                "raw_url": "https://github.com/apache/ignite/raw/1d9a953a8786997dbcb6b86566f09b3622503be8/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/metric/SqlViewExporterSpiTest.java",
                "sha": "986d8402c26cb340cc3156e4e0129a0f7cf8c310",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12286: IGNITE-12286: SqlViewExporter NPE Fix (#6972)",
        "parent": "https://github.com/apache/ignite/commit/9ba9cc582b1e9a4aeae434dc639e364009161e52",
        "patched_files": [
            "MetricRegistryLocalSystemView.java",
            "SqlViewExporterSpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "SqlViewExporterSpiTest.java"
        ]
    },
    "ignite_1fbc284": {
        "bug_id": "ignite_1fbc284",
        "commit": "https://github.com/apache/ignite/commit/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811/modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheQueueAdapter.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheQueueAdapter.java?ref=1fbc284fd0c89e6aaedf76bd2df3581cf85a1811",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheQueueAdapter.java",
                "patch": "@@ -1045,13 +1045,13 @@ public RemoveProcessor(IgniteUuid id, Long idx) {\n         /** {@inheritDoc} */\n         @Override public void writeExternal(ObjectOutput out) throws IOException {\n             U.writeGridUuid(out, id);\n-            out.writeLong(idx);\n+            out.writeObject(idx);\n         }\n \n         /** {@inheritDoc} */\n         @Override public void readExternal(ObjectInput in) throws IOException, ClassNotFoundException {\n             id = U.readGridUuid(in);\n-            idx = in.readLong();\n+            idx = (Long)in.readObject();\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811/modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheQueueAdapter.java",
                "sha": "e7bde03c3e1e78d1df9956b0d52d103d3f107b70",
                "status": "modified"
            },
            {
                "additions": 144,
                "blob_url": "https://github.com/apache/ignite/blob/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811/modules/core/src/test/java/org/apache/ignite/internal/processors/datastructures/GridCacheReplicatedQueueRemoveSelfTest.java",
                "changes": 144,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/datastructures/GridCacheReplicatedQueueRemoveSelfTest.java?ref=1fbc284fd0c89e6aaedf76bd2df3581cf85a1811",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/datastructures/GridCacheReplicatedQueueRemoveSelfTest.java",
                "patch": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.datastructures;\n+\n+import java.io.ObjectInputStream;\n+import java.io.ObjectOutputStream;\n+import java.math.BigInteger;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ThreadLocalRandom;\n+import org.apache.ignite.IgniteQueue;\n+import org.apache.ignite.cache.CacheAtomicityMode;\n+import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.configuration.CollectionConfiguration;\n+import org.apache.ignite.internal.processors.cache.CacheInvokeEntry;\n+import org.apache.ignite.internal.processors.cache.GridCacheContext;\n+import org.apache.ignite.internal.processors.cache.KeyCacheObjectImpl;\n+import org.apache.ignite.internal.processors.cache.datastructures.IgniteCollectionAbstractTest;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.GridDhtCacheEntry;\n+import org.apache.ignite.internal.util.io.GridByteArrayInputStream;\n+import org.apache.ignite.internal.util.io.GridByteArrayOutputStream;\n+import org.apache.ignite.lang.IgniteUuid;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n+import static org.apache.ignite.cache.CacheMode.REPLICATED;\n+\n+/**\n+ * Tests for Ignite Queue remove method.\n+ */\n+public class GridCacheReplicatedQueueRemoveSelfTest extends IgniteCollectionAbstractTest {\n+    /** */\n+    public static final int CACHE_SIZE = 1_000;\n+\n+    /** */\n+    public static final int THREADS_CNT = 8;\n+\n+    /** {@inheritDoc} */\n+    @Override protected int gridCount() {\n+        return 2;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected CacheMode collectionCacheMode() {\n+        return REPLICATED;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected CacheAtomicityMode collectionCacheAtomicityMode() {\n+        return TRANSACTIONAL;\n+    }\n+\n+    /**\n+     * This a unit test of Ignite queue's RemoveProcessor process() method.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings(\"unchecked\")\n+    public void testQueueRemovalProcessor() throws Exception {\n+        GridCacheContext cctx = grid(0).context().cache().cache(\"ignite-sys-cache\").context();\n+\n+        IgniteUuid id = IgniteUuid.randomUuid();\n+\n+        CacheInvokeEntry entry = new CacheInvokeEntry<>(null, null, null, false,\n+            new GridDhtCacheEntry(cctx, null,\n+                new KeyCacheObjectImpl(1, BigInteger.valueOf(1).toByteArray(), 1)));\n+\n+        entry.setValue(new GridCacheQueueHeader(\n+            id,\n+            2147483647,\n+            false,\n+            0L,\n+            10000L,\n+            Collections.singleton(1L)));\n+\n+        GridCacheQueueAdapter.RemoveProcessor rp = new GridCacheQueueAdapter.RemoveProcessor(id, 1L);\n+\n+        rp.process(entry);\n+\n+        GridCacheQueueAdapter.RemoveProcessor externalRP = new GridCacheQueueAdapter.RemoveProcessor();\n+\n+        GridByteArrayOutputStream output = new GridByteArrayOutputStream();\n+\n+        rp.writeExternal(new ObjectOutputStream(output));\n+\n+        externalRP.readExternal(new ObjectInputStream(new GridByteArrayInputStream(output.toByteArray())));\n+\n+        assertEquals(id, GridTestUtils.getFieldValue(externalRP, \"id\"));\n+\n+        // idx should be null, cause entry was already removed, see GridCacheQueueAdapter.RemoveProcessor.code\n+        // for more details.\n+        assertNull(GridTestUtils.getFieldValue(externalRP, \"idx\"));\n+    }\n+\n+    /**\n+     * Removes buckets of data from the queue in many threads at the same time.\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings(\"unchecked\")\n+    public void testQueueRemoval() throws Exception {\n+        IgniteQueue queue = grid(0).queue(\"SomeQueue\", 0,\n+            new CollectionConfiguration().setCollocated(true).setCacheMode(REPLICATED).setAtomicityMode(TRANSACTIONAL));\n+\n+        // Populate queue with some data.\n+        for (int i = 0; i < CACHE_SIZE; i++)\n+            queue.add(i);\n+\n+        CountDownLatch latch = new CountDownLatch(THREADS_CNT);\n+\n+        // Remove buckets of data from the queue in many threads at the same time.\n+        GridTestUtils.runMultiThreaded(() -> {\n+            ArrayList dataToRmv = new ArrayList();\n+\n+            for (int i = 0; i < CACHE_SIZE / 10; i++)\n+                dataToRmv.add(ThreadLocalRandom.current().nextInt(CACHE_SIZE));\n+\n+            latch.countDown();\n+            latch.await();\n+\n+            queue.removeAll(dataToRmv);\n+\n+            return null;\n+        }, THREADS_CNT, \"queue-test-worker\");\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811/modules/core/src/test/java/org/apache/ignite/internal/processors/datastructures/GridCacheReplicatedQueueRemoveSelfTest.java",
                "sha": "1541510f89ef128fd62d770005cc81b69e0a2cfb",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheDataStructuresSelfTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheDataStructuresSelfTestSuite.java?ref=1fbc284fd0c89e6aaedf76bd2df3581cf85a1811",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheDataStructuresSelfTestSuite.java",
                "patch": "@@ -91,6 +91,7 @@\n import org.apache.ignite.internal.processors.cache.datastructures.replicated.IgniteReplicatedLockSelfTest;\n import org.apache.ignite.internal.processors.cache.datastructures.replicated.IgniteReplicatedSemaphoreSelfTest;\n import org.apache.ignite.internal.processors.cache.distributed.replicated.IgniteCacheAtomicReplicatedNodeRestartSelfTest;\n+import org.apache.ignite.internal.processors.datastructures.GridCacheReplicatedQueueRemoveSelfTest;\n import org.junit.runner.RunWith;\n import org.junit.runners.Suite;\n \n@@ -124,6 +125,7 @@\n     IgniteReplicatedSemaphoreSelfTest.class,\n     IgniteReplicatedLockSelfTest.class,\n     IgniteCacheAtomicReplicatedNodeRestartSelfTest.class,\n+    GridCacheReplicatedQueueRemoveSelfTest.class,\n \n     GridCachePartitionedSequenceApiSelfTest.class,\n     GridCachePartitionedSequenceMultiNodeSelfTest.class,",
                "raw_url": "https://github.com/apache/ignite/raw/1fbc284fd0c89e6aaedf76bd2df3581cf85a1811/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheDataStructuresSelfTestSuite.java",
                "sha": "42216cae8c3c758900acdbacb8aeec691fb1c3c3",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12101 Fixed NullPointerException when IgniteQueue.removeAll is called. - Fixes #7266.\n\nSigned-off-by: Ivan Rakov <irakov@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/f0b88f676d0d15e99ebc0eb715d229a60c197c96",
        "patched_files": [
            "GridCacheQueueAdapter.java",
            "IgniteCacheDataStructuresSelfTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheReplicatedQueueRemoveSelfTest.java"
        ]
    },
    "ignite_2035f9d": {
        "bug_id": "ignite_2035f9d",
        "commit": "https://github.com/apache/ignite/commit/2035f9de6f63c93f60467eff87cdacb60bf815cf",
        "file": [
            {
                "additions": 161,
                "blob_url": "https://github.com/apache/ignite/blob/2035f9de6f63c93f60467eff87cdacb60bf815cf/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/SafeLogTxFinishErrorTest.java",
                "changes": 161,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/SafeLogTxFinishErrorTest.java?ref=2035f9de6f63c93f60467eff87cdacb60bf815cf",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/SafeLogTxFinishErrorTest.java",
                "patch": "@@ -0,0 +1,161 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache;\n+\n+import java.util.Collection;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.affinity.rendezvous.RendezvousAffinityFunction;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.processors.cache.distributed.near.GridNearTxLocal;\n+import org.apache.ignite.internal.processors.cache.transactions.IgniteInternalTx;\n+import org.apache.ignite.internal.processors.cache.transactions.IgniteTxAdapter;\n+import org.apache.ignite.internal.processors.cache.transactions.IgniteTxLocalAdapter;\n+import org.apache.ignite.testframework.ListeningTestLogger;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.apache.ignite.transactions.Transaction;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n+import static org.apache.ignite.testframework.GridTestUtils.getFieldValue;\n+import static org.apache.ignite.testframework.GridTestUtils.setFieldValue;\n+\n+/**\n+ * Tests verifying that {@link IgniteTxAdapter#logTxFinishErrorSafe}\n+ * runs without errors.\n+ */\n+public class SafeLogTxFinishErrorTest extends GridCommonAbstractTest {\n+    /** Logger for listen log messages. */\n+    private final ListeningTestLogger log = new ListeningTestLogger(false, GridCommonAbstractTest.log);\n+\n+    /** Flag to remove the FailureHandler when creating configuration for node. */\n+    private boolean rmvFailureHnd;\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCacheConfiguration(\n+            new CacheConfiguration<>(DEFAULT_CACHE_NAME)\n+                .setAffinity(new RendezvousAffinityFunction(false, 32))\n+                .setAtomicityMode(TRANSACTIONAL)\n+        );\n+\n+        if (rmvFailureHnd)\n+            cfg.setFailureHandler(null);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Checking that {@link IgniteTxAdapter#logTxFinishErrorSafe} is executable\n+     * without errors with FailureHandler.\n+     *\n+     * @throws Exception If any error occurs.\n+     */\n+    @Test\n+    public void testSafeLogTxFinishErrorWithFailureHandler() throws Exception {\n+        checkSafeLogTxFinishError(false);\n+    }\n+\n+    /**\n+     * Checking that {@link IgniteTxAdapter#logTxFinishErrorSafe} is executable\n+     * without errors without FailureHandler.\n+     *\n+     * @throws Exception If any error occurs.\n+     */\n+    @Test\n+    public void testSafeLogTxFinishErrorWithoutFailureHandler()throws Exception {\n+        rmvFailureHnd = true;\n+\n+        checkSafeLogTxFinishError(false);\n+    }\n+\n+    /**\n+     * Checking that {@link IgniteTxAdapter#logTxFinishErrorSafe} is executable\n+     * without errors with FailureHandler. Provided that txState field\n+     * is deleted in transaction, which leads to NPE when\n+     * {@link GridNearTxLocal#toString()} is called.\n+     *\n+     * @throws Exception If any error occurs.\n+     */\n+    @Test\n+    public void testSafeLogTxFinishErrorWithFailureHandlerAndRemoveTxState() throws Exception {\n+        checkSafeLogTxFinishError(true);\n+    }\n+\n+    /**\n+     * Checking that {@link IgniteTxAdapter#logTxFinishErrorSafe} is executed\n+     * without errors.\n+     *\n+     * @param rmvTxState Remove txState field in transaction.\n+     * @throws Exception If any error occurs.\n+     */\n+    private void checkSafeLogTxFinishError(boolean rmvTxState) throws Exception {\n+        IgniteEx igniteEx = startGrid(0);\n+\n+        try (Transaction transaction = igniteEx.transactions().txStart()) {\n+            IgniteCache<Object, Object> cache = igniteEx.cache(DEFAULT_CACHE_NAME);\n+\n+            cache.put(1, 1);\n+\n+            Collection<IgniteInternalTx> activeTxs = igniteEx.context().cache().context().tm().activeTransactions();\n+\n+            assertEquals(1, activeTxs.size());\n+\n+            GridNearTxLocal activeTx = (GridNearTxLocal)activeTxs.iterator().next();\n+\n+            AtomicBoolean containsFailedCompletingTxInLog = new AtomicBoolean();\n+\n+            Object txState = null;\n+\n+            if (rmvTxState) {\n+                txState = getFieldValue(activeTx, IgniteTxLocalAdapter.class, \"txState\");\n+                setFieldValue(activeTx, IgniteTxLocalAdapter.class, \"txState\", null);\n+            }\n+\n+            boolean commit = false;\n+\n+            String errPrefix = \"Failed completing the transaction: [commit=\" + commit;\n+\n+            String xidVer = (rmvTxState ? \"xidVersion\" : \"xidVer\") + '=' + activeTx.xidVersion();\n+\n+            log.registerListener(logStr -> {\n+                if (logStr.startsWith(errPrefix) && logStr.contains(xidVer))\n+                    containsFailedCompletingTxInLog.set(true);\n+            });\n+\n+            activeTx.logTxFinishErrorSafe(log, commit, new RuntimeException(\"Test\"));\n+\n+            assertTrue(containsFailedCompletingTxInLog.get());\n+\n+            //That there was no NPE when closing a transaction.\n+            if (rmvTxState)\n+                setFieldValue(activeTx, IgniteTxLocalAdapter.class, \"txState\", txState);\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/2035f9de6f63c93f60467eff87cdacb60bf815cf/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/SafeLogTxFinishErrorTest.java",
                "sha": "09283a0d23de21af0301d54fecda06e24e4a89cd",
                "status": "added"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/2035f9de6f63c93f60467eff87cdacb60bf815cf/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite7.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite7.java?ref=2035f9de6f63c93f60467eff87cdacb60bf815cf",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite7.java",
                "patch": "@@ -33,6 +33,7 @@\n import org.apache.ignite.internal.processors.cache.CacheMetricsManageTest;\n import org.apache.ignite.internal.processors.cache.GridTransactionsSystemUserTimeMetricsTest;\n import org.apache.ignite.internal.processors.cache.IgniteDynamicCacheStartFailWithPersistenceTest;\n+import org.apache.ignite.internal.processors.cache.SafeLogTxFinishErrorTest;\n import org.apache.ignite.internal.processors.cache.WalModeChangeAdvancedSelfTest;\n import org.apache.ignite.internal.processors.cache.WalModeChangeCoordinatorNotAffinityNodeSelfTest;\n import org.apache.ignite.internal.processors.cache.WalModeChangeSelfTest;\n@@ -118,6 +119,8 @@\n \n         GridTestUtils.addTestIfNeeded(suite, GridTransactionsSystemUserTimeMetricsTest.class, ignoredTests);\n \n+        GridTestUtils.addTestIfNeeded(suite, SafeLogTxFinishErrorTest.class, ignoredTests);\n+\n         return suite;\n     }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/2035f9de6f63c93f60467eff87cdacb60bf815cf/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite7.java",
                "sha": "918426eb3e1b56313c3bd00a67157768c1aa2a9a",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12305 Extend test coverage [IGNITE-11959] NullPointerException if transaction failed and failure handler dwas not configured explicitly - Fixes #6993.\n\nSigned-off-by: ipavlukhin <vololo100@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/a6e577e6d02e25c37cf98504e3456f2c3ab26618",
        "patched_files": [
            "IgniteCacheTestSuite7.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "SafeLogTxFinishErrorTest.java"
        ]
    },
    "ignite_2267113": {
        "bug_id": "ignite_2267113",
        "commit": "https://github.com/apache/ignite/commit/226711357db742a5073a98ef179997480e1b1a56",
        "file": [
            {
                "additions": 40,
                "blob_url": "https://github.com/apache/ignite/blob/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/main/java/org/apache/ignite/internal/processors/service/GridServiceProcessor.java",
                "changes": 53,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/service/GridServiceProcessor.java?ref=226711357db742a5073a98ef179997480e1b1a56",
                "deletions": 13,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/service/GridServiceProcessor.java",
                "patch": "@@ -30,6 +30,7 @@\n import java.util.UUID;\n import java.util.concurrent.ConcurrentLinkedQueue;\n import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.ExecutorService;\n import java.util.concurrent.Executors;\n import java.util.concurrent.ThreadFactory;\n@@ -160,11 +161,14 @@\n     private ThreadLocal<String> svcName = new ThreadLocal<>();\n \n     /** Service cache. */\n-    private IgniteInternalCache<Object, Object> cache;\n+    private volatile IgniteInternalCache<Object, Object> serviceCache;\n \n     /** Topology listener. */\n     private DiscoveryEventListener topLsnr = new TopologyListener();\n \n+    /** */\n+    private final CountDownLatch startLatch = new CountDownLatch(1);\n+\n     /**\n      * @param ctx Kernal context.\n      */\n@@ -223,19 +227,21 @@ public void onContinuousProcessorStarted(GridKernalContext ctx) throws IgniteChe\n      * @throws IgniteCheckedException If failed.\n      */\n     private void onKernalStart0() throws IgniteCheckedException {\n-        updateUtilityCache();\n-\n         if (!ctx.clientNode())\n             ctx.event().addDiscoveryEventListener(topLsnr, EVTS);\n \n+        updateUtilityCache();\n+\n+        startLatch.countDown();\n+\n         try {\n             if (ctx.deploy().enabled())\n                 ctx.cache().context().deploy().ignoreOwnership(true);\n \n             if (!ctx.clientNode()) {\n-                assert cache.context().affinityNode();\n+                assert serviceCache.context().affinityNode();\n \n-                cache.context().continuousQueries().executeInternalQuery(\n+                serviceCache.context().continuousQueries().executeInternalQuery(\n                     new ServiceEntriesListener(), null, true, true, false\n                 );\n             }\n@@ -246,7 +252,7 @@ private void onKernalStart0() throws IgniteCheckedException {\n                     @Override public void run() {\n                         try {\n                             Iterable<CacheEntryEvent<?, ?>> entries =\n-                                cache.context().continuousQueries().existingEntries(false, null);\n+                                serviceCache.context().continuousQueries().existingEntries(false, null);\n \n                             onSystemCacheUpdated(entries);\n                         }\n@@ -275,7 +281,17 @@ private void onKernalStart0() throws IgniteCheckedException {\n      *\n      */\n     public void updateUtilityCache() {\n-        cache = ctx.cache().utilityCache();\n+        serviceCache = ctx.cache().utilityCache();\n+    }\n+\n+    /**\n+     * @return Service cache.\n+     */\n+    private IgniteInternalCache<Object, Object> serviceCache() {\n+        if (serviceCache == null)\n+            U.awaitQuiet(startLatch);\n+\n+        return serviceCache;\n     }\n \n     /** {@inheritDoc} */\n@@ -292,6 +308,8 @@ public void updateUtilityCache() {\n             this.busyLock = null;\n         }\n \n+        startLatch.countDown();\n+\n         U.shutdownNow(GridServiceProcessor.class, depExe, log);\n \n         if (!ctx.clientNode())\n@@ -617,7 +635,7 @@ else if (prj.predicate() == F.<ClusterNode>alwaysTrue())\n                 if (cfgsCp.size() == 1)\n                     writeServiceToCache(res, cfgsCp.get(0));\n                 else if (cfgsCp.size() > 1) {\n-                    try (Transaction tx = cache.txStart(PESSIMISTIC, READ_COMMITTED)) {\n+                    try (Transaction tx = serviceCache().txStart(PESSIMISTIC, READ_COMMITTED)) {\n                         for (ServiceConfiguration cfg : cfgsCp) {\n                             try {\n                                 writeServiceToCache(res, cfg);\n@@ -709,7 +727,7 @@ private void writeServiceToCache(GridServiceDeploymentCompoundFuture res, Servic\n \n             GridServiceDeploymentKey key = new GridServiceDeploymentKey(name);\n \n-            GridServiceDeployment dep = (GridServiceDeployment)cache.getAndPutIfAbsent(key,\n+            GridServiceDeployment dep = (GridServiceDeployment)serviceCache().getAndPutIfAbsent(key,\n                 new GridServiceDeployment(ctx.localNodeId(), cfg));\n \n             if (dep != null) {\n@@ -809,7 +827,7 @@ private void writeServiceToCache(GridServiceDeploymentCompoundFuture res, Servic\n \n             List<String> toRollback = new ArrayList<>();\n \n-            try (Transaction tx = cache.txStart(PESSIMISTIC, READ_COMMITTED)) {\n+            try (Transaction tx = serviceCache().txStart(PESSIMISTIC, READ_COMMITTED)) {\n                 for (String name : svcNames) {\n                     if (res == null)\n                         res = new GridCompoundFuture<>();\n@@ -882,7 +900,7 @@ private CancelResult removeServiceFromCache(String name) throws IgniteCheckedExc\n             GridServiceDeploymentKey key = new GridServiceDeploymentKey(name);\n \n             try {\n-                if (cache.getAndRemove(key) == null) {\n+                if (serviceCache().getAndRemove(key) == null) {\n                     // Remove future from local map if service was not deployed.\n                     undepFuts.remove(name, fut);\n \n@@ -910,6 +928,8 @@ private CancelResult removeServiceFromCache(String name) throws IgniteCheckedExc\n      * @throws IgniteCheckedException On error.\n      */\n     public Map<UUID, Integer> serviceTopology(String name, long timeout) throws IgniteCheckedException {\n+        IgniteInternalCache<Object, Object> cache = serviceCache();\n+\n         ClusterNode node = cache.affinity().mapKeyToNode(name);\n \n         final ServiceTopologyCallable call = new ServiceTopologyCallable(name);\n@@ -952,7 +972,7 @@ private CancelResult removeServiceFromCache(String name) throws IgniteCheckedExc\n             ServiceDescriptorImpl desc = new ServiceDescriptorImpl(dep);\n \n             try {\n-                GridServiceAssignments assigns = (GridServiceAssignments)cache.getForcePrimary(\n+                GridServiceAssignments assigns = (GridServiceAssignments)serviceCache().getForcePrimary(\n                     new GridServiceAssignmentsKey(dep.configuration().getName()));\n \n                 if (assigns != null) {\n@@ -1117,8 +1137,9 @@ private boolean hasLocalNode(ClusterGroup prj) {\n      * @throws IgniteCheckedException If failed.\n      */\n     private void reassign(GridServiceDeployment dep, AffinityTopologyVersion topVer) throws IgniteCheckedException {\n-        ServiceConfiguration cfg = dep.configuration();\n+        IgniteInternalCache<Object, Object> cache = serviceCache();\n \n+        ServiceConfiguration cfg = dep.configuration();\n         Object nodeFilter = cfg.getNodeFilter();\n \n         if (nodeFilter != null)\n@@ -1475,6 +1496,8 @@ private void cancel(Iterable<ServiceContextImpl> ctxs, int cancelCnt) {\n     @SuppressWarnings(\"unchecked\")\n     private Iterator<Cache.Entry<Object, Object>> serviceEntries(IgniteBiPredicate<Object, Object> p) {\n         try {\n+            IgniteInternalCache<Object, Object> cache = serviceCache();\n+\n             GridCacheQueryManager qryMgr = cache.context().queries();\n \n             CacheQuery<Map.Entry<Object, Object>> qry = qryMgr.createScanQuery(p, null, false);\n@@ -1615,6 +1638,8 @@ private void processDeployment(CacheEntryEvent<GridServiceDeploymentKey, GridSer\n             GridServiceAssignmentsKey key = new GridServiceAssignmentsKey(name);\n \n             // Remove assignment on primary node in case of undeploy.\n+            IgniteInternalCache<Object, Object> cache = serviceCache();\n+\n             if (cache.cache().affinity().isPrimary(ctx.discovery().localNode(), key)) {\n                 try {\n                     cache.getAndRemove(key);\n@@ -1783,6 +1808,8 @@ else if (msg instanceof DynamicCacheChangeBatch) {\n                         Iterator<Cache.Entry<Object, Object>> it = serviceEntries(ServiceAssignmentsPredicate.INSTANCE);\n \n                         // Clean up zombie assignments.\n+                        IgniteInternalCache<Object, Object> cache = serviceCache();\n+\n                         while (it.hasNext()) {\n                             Cache.Entry<Object, Object> e = it.next();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/main/java/org/apache/ignite/internal/processors/service/GridServiceProcessor.java",
                "sha": "85810239cad21579461d8001ff281a6f107b19be",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/main/java/org/apache/ignite/internal/processors/task/GridTaskProcessor.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/task/GridTaskProcessor.java?ref=226711357db742a5073a98ef179997480e1b1a56",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/task/GridTaskProcessor.java",
                "patch": "@@ -198,6 +198,8 @@ private IgniteClientDisconnectedCheckedException disconnectedError(@Nullable Ign\n             lock.writeUnlock();\n         }\n \n+        startLatch.countDown();\n+\n         int size = tasks.size();\n \n         if (size > 0) {",
                "raw_url": "https://github.com/apache/ignite/raw/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/main/java/org/apache/ignite/internal/processors/task/GridTaskProcessor.java",
                "sha": "871d945021514f3474a6c005dffd207c50708691",
                "status": "modified"
            },
            {
                "additions": 172,
                "blob_url": "https://github.com/apache/ignite/blob/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/test/java/org/apache/ignite/internal/GridJobServicesAddNodeTest.java",
                "changes": 172,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/GridJobServicesAddNodeTest.java?ref=226711357db742a5073a98ef179997480e1b1a56",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/GridJobServicesAddNodeTest.java",
                "patch": "@@ -0,0 +1,172 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.processors.service.DummyService;\n+import org.apache.ignite.internal.util.IgniteUtils;\n+import org.apache.ignite.internal.util.typedef.CAX;\n+import org.apache.ignite.internal.util.typedef.CIX1;\n+import org.apache.ignite.internal.util.typedef.X;\n+import org.apache.ignite.lang.IgniteCallable;\n+import org.apache.ignite.lang.IgniteFuture;\n+import org.apache.ignite.resources.IgniteInstanceResource;\n+import org.apache.ignite.spi.communication.tcp.TcpCommunicationSpi;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.apache.ignite.testframework.junits.common.GridCommonTest;\n+\n+/**\n+ * Tests multiple parallel jobs execution, accessing services(), while starting new nodes.\n+ */\n+@GridCommonTest(group = \"Kernal Self\")\n+public class GridJobServicesAddNodeTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final int LOG_MOD = 100;\n+\n+    /** */\n+    private static final int MAX_ADD_NODES = 64;\n+\n+    /** IP finder. */\n+    private static final TcpDiscoveryIpFinder ipFinder = new TcpDiscoveryVmIpFinder(true);\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        startGrid(1);\n+        startGrid(2);\n+\n+        assertEquals(2, grid(1).cluster().nodes().size());\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() throws Exception {\n+        stopAllGrids();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration c = super.getConfiguration(igniteInstanceName);\n+\n+        TcpDiscoverySpi disco = new TcpDiscoverySpi();\n+\n+        disco.setIpFinder(ipFinder);\n+\n+        c.setDiscoverySpi(disco);\n+\n+        TcpCommunicationSpi commSpi = new TcpCommunicationSpi();\n+\n+        commSpi.setSharedMemoryPort(-1);\n+\n+        c.setCommunicationSpi(commSpi);\n+\n+        return c;\n+    }\n+\n+    /**\n+     * @throws Exception If test failed.\n+     */\n+    public void testServiceDescriptorsJob() throws Exception {\n+        final int tasks = 5000;\n+        final int threads = 10;\n+\n+        final Ignite ignite1 = grid(1);\n+        final CountDownLatch latch = new CountDownLatch(tasks);\n+        final AtomicInteger jobsCnt = new AtomicInteger();\n+        final AtomicInteger resCnt = new AtomicInteger();\n+\n+        ignite1.services().deployClusterSingleton(\"jobsSvc\", new DummyService());\n+\n+        GridTestUtils.runMultiThreadedAsync(new CAX() {\n+            @Override public void applyx() throws IgniteCheckedException {\n+                while (true) {\n+                    int cnt = jobsCnt.incrementAndGet();\n+\n+                    if (cnt > 5000)\n+                        break;\n+\n+                    IgniteCallable<Boolean> job;\n+\n+                    job = new ServiceDescriptorsJob();\n+\n+                    IgniteFuture<Boolean> fut = ignite1.compute().callAsync(job);\n+\n+                    if (cnt % LOG_MOD == 0)\n+                        X.println(\"Submitted jobs: \" + cnt);\n+\n+                    fut.listen(new CIX1<IgniteFuture<Boolean>>() {\n+                        @Override public void applyx(IgniteFuture<Boolean> f) {\n+                            try {\n+                                assert f.get();\n+\n+                                long cnt = resCnt.incrementAndGet();\n+\n+                                if (cnt % LOG_MOD == 0)\n+                                    X.println(\"Results count: \" + cnt);\n+                            }\n+                            finally {\n+                                latch.countDown();\n+                            }\n+                        }\n+                    });\n+\n+                    IgniteUtils.sleep(5);\n+                }\n+            }\n+        }, threads, \"TEST-THREAD\");\n+\n+        int additionalNodesStarted = 0;\n+        while (!latch.await(threads, TimeUnit.MILLISECONDS)) {\n+            if (additionalNodesStarted++ <= MAX_ADD_NODES) {\n+                startGrid(2 + additionalNodesStarted);\n+            }\n+        }\n+\n+        assertEquals(\"Jobs cnt != Results cnt\", jobsCnt.get() - threads, resCnt.get());\n+    }\n+\n+    /**\n+     * Test service enumerating job.\n+     */\n+    @SuppressWarnings({\"PublicInnerClass\"})\n+    public static class ServiceDescriptorsJob implements IgniteCallable<Boolean> {\n+        /** */\n+        @IgniteInstanceResource\n+        private Ignite ignite;\n+\n+        /** {@inheritDoc} */\n+        @Override public Boolean call() throws Exception {\n+            try {\n+                return ignite.services().serviceDescriptors().iterator().hasNext();\n+            } catch (Exception e) {\n+                e.printStackTrace();\n+\n+                return false;\n+            } finally {\n+                Thread.sleep(10);\n+            }\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/test/java/org/apache/ignite/internal/GridJobServicesAddNodeTest.java",
                "sha": "4b8b49402200109a9f6b8fab05b3634c865cbf64",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java?ref=226711357db742a5073a98ef179997480e1b1a56",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java",
                "patch": "@@ -40,6 +40,7 @@\n import org.apache.ignite.internal.GridJobCollisionCancelSelfTest;\n import org.apache.ignite.internal.GridJobContextSelfTest;\n import org.apache.ignite.internal.GridJobMasterLeaveAwareSelfTest;\n+import org.apache.ignite.internal.GridJobServicesAddNodeTest;\n import org.apache.ignite.internal.GridJobStealingSelfTest;\n import org.apache.ignite.internal.GridJobStealingZeroActiveJobsSelfTest;\n import org.apache.ignite.internal.GridJobSubjectIdSelfTest;\n@@ -160,6 +161,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(IgniteRoundRobinErrorAfterClientReconnectTest.class);\n         suite.addTestSuite(PublicThreadpoolStarvationTest.class);\n         suite.addTestSuite(StripedExecutorTest.class);\n+        suite.addTestSuite(GridJobServicesAddNodeTest.class);\n \n         suite.addTestSuite(IgniteComputeCustomExecutorConfigurationSelfTest.class);\n         suite.addTestSuite(IgniteComputeCustomExecutorSelfTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/226711357db742a5073a98ef179997480e1b1a56/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java",
                "sha": "2ffa11ebf2849a42ff99fb91d77b535f8fe7664d",
                "status": "modified"
            }
        ],
        "message": "IGNITE-7197 Avoid NPE in services() by waiting on latch",
        "parent": "https://github.com/apache/ignite/commit/6e8cfe324fc7ea69a2b5477ac3187d333aef3134",
        "patched_files": [
            "IgniteComputeGridTestSuite.java",
            "GridTaskProcessor.java",
            "GridServiceProcessor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridJobServicesAddNodeTest.java"
        ]
    },
    "ignite_253b002": {
        "bug_id": "ignite_253b002",
        "commit": "https://github.com/apache/ignite/commit/253b00221d4d02157c9c478c027653525d71b363",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/pagemem/PageMemory.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/pagemem/PageMemory.java?ref=253b00221d4d02157c9c478c027653525d71b363",
                "deletions": 5,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/pagemem/PageMemory.java",
                "patch": "@@ -36,11 +36,6 @@\n      */\n     public void stop(boolean deallocate) throws IgniteException;\n \n-    /**\n-     * @return {@code True} if this memory is stopped.\n-     */\n-    public boolean stopped();\n-\n     /**\n      * @return Page size in bytes.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/pagemem/PageMemory.java",
                "sha": "bd03c5473bcd2ebb6c81feaa8ac22bdb1d97d1fe",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java?ref=253b00221d4d02157c9c478c027653525d71b363",
                "deletions": 5,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java",
                "patch": "@@ -273,11 +273,6 @@ public PageMemoryNoStoreImpl(\n         }\n     }\n \n-    /** {@inheritDoc} */\n-    @Override public boolean stopped() {\n-        return stopped;\n-    }\n-\n     /** {@inheritDoc} */\n     @Override public ByteBuffer pageBuffer(long pageAddr) {\n         return wrapPointer(pageAddr, pageSize());",
                "raw_url": "https://github.com/apache/ignite/raw/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java",
                "sha": "c60c63c53914a8ec89149a4e3a5a2654178b3003",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=253b00221d4d02157c9c478c027653525d71b363",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -2779,8 +2779,7 @@ private CacheGroupContext startCacheGroup(\n \n         DataRegion dataRegion = sharedCtx.database().dataRegion(memPlcName);\n \n-        if (sharedCtx.isLazyMemoryAllocation() &&\n-            (dataRegion != null && dataRegion.pageMemory().stopped()) &&\n+        if (sharedCtx.isLazyMemoryAllocation() && dataRegion != null &&\n             (!ctx.clientNode() || desc.config().getCacheMode() == LOCAL)) {\n             dataRegion.pageMemory().start();\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "e0ba2da0ba67ab6160534802b2aef443e3cfd3fc",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java?ref=253b00221d4d02157c9c478c027653525d71b363",
                "deletions": 4,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "patch": "@@ -440,10 +440,6 @@ else if (throttlingPlc == ThrottlingPolicy.CHECKPOINT_BUFFER_ONLY)\n         }\n     }\n \n-    @Override public boolean stopped() {\n-        return stopped;\n-    }\n-\n     /** {@inheritDoc} */\n     @Override public void releasePage(int grpId, long pageId, long page) {\n         assert !stopped;\n@@ -1779,6 +1775,9 @@ void beforeReleaseWrite(FullPageId pageId, long ptr, boolean pageWalRec) throws\n      * @return Segment.\n      */\n     private Segment segment(int grpId, long pageId) {\n+        if (segments == null)\n+            System.out.println(\"PageMemoryImpl.segment\");\n+\n         int idx = segmentIndex(grpId, pageId, segments.length);\n \n         return segments[idx];",
                "raw_url": "https://github.com/apache/ignite/raw/253b00221d4d02157c9c478c027653525d71b363/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "sha": "a94c32083034d6f64009e1bd04e53e975ddd3076",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9113: NPE fixes for some modes.",
        "parent": "https://github.com/apache/ignite/commit/394b104c9e20f25dc1a59fcb19843fae6d3f2603",
        "patched_files": [
            "PageMemoryImpl.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "PageMemoryImplTest.java"
        ]
    },
    "ignite_271550f": {
        "bug_id": "ignite_271550f",
        "commit": "https://github.com/apache/ignite/commit/271550fed7662c5032f9e4fb49cd135f3a55a46e",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/ignite/blob/271550fed7662c5032f9e4fb49cd135f3a55a46e/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java?ref=271550fed7662c5032f9e4fb49cd135f3a55a46e",
                "deletions": 9,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "patch": "@@ -583,7 +583,7 @@ public void init() throws IgniteInterruptedCheckedException {\n                             onDone(exchId.topologyVersion());\n                         }\n                         else\n-                            sendPartitions();\n+                            sendPartitions(oldest);\n                     }\n                     else {\n                         rmtIds = Collections.emptyList();\n@@ -816,9 +816,11 @@ public void init() throws IgniteInterruptedCheckedException {\n             if (log.isDebugEnabled())\n                 log.debug(\"Initialized future: \" + this);\n \n+            ClusterNode oldest = oldestNode.get();\n+\n             // If this node is not oldest.\n-            if (!oldestNode.get().id().equals(cctx.localNodeId()))\n-                sendPartitions();\n+            if (!oldest.id().equals(cctx.localNodeId()))\n+                sendPartitions(oldest);\n             else {\n                 boolean allReceived = allReceived();\n \n@@ -948,11 +950,9 @@ private void sendAllPartitions(Collection<? extends ClusterNode> nodes, GridDhtP\n     }\n \n     /**\n-     *\n+     * @param oldestNode Oldest node.\n      */\n-    private void sendPartitions() {\n-        ClusterNode oldestNode = this.oldestNode.get();\n-\n+    private void sendPartitions(ClusterNode oldestNode) {\n         try {\n             sendLocalPartitions(oldestNode, exchId);\n         }\n@@ -1402,8 +1402,10 @@ else if (rmtIds.contains(nodeId)) {\n      *\n      */\n     private void recheck() {\n+        ClusterNode oldest = oldestNode.get();\n+\n         // If this is the oldest node.\n-        if (oldestNode.get().id().equals(cctx.localNodeId())) {\n+        if (oldest.id().equals(cctx.localNodeId())) {\n             Collection<UUID> remaining = remaining();\n \n             if (!remaining.isEmpty()) {\n@@ -1423,7 +1425,7 @@ private void recheck() {\n             }\n         }\n         else\n-            sendPartitions();\n+            sendPartitions(oldest);\n \n         // Schedule another send.\n         scheduleRecheck();",
                "raw_url": "https://github.com/apache/ignite/raw/271550fed7662c5032f9e4fb49cd135f3a55a46e/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "sha": "cbf6b405c86117178e63e7d0f742493de879593c",
                "status": "modified"
            },
            {
                "additions": 36,
                "blob_url": "https://github.com/apache/ignite/blob/271550fed7662c5032f9e4fb49cd135f3a55a46e/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "changes": 41,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java?ref=271550fed7662c5032f9e4fb49cd135f3a55a46e",
                "deletions": 5,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "patch": "@@ -1791,7 +1791,13 @@ private void checkAttributePresence(ClusterNode node, String attrName) {\n         if (log.isTraceEnabled())\n             log.trace(\"Sending message to node [node=\" + node + \", msg=\" + msg + ']');\n \n-        if (node.id().equals(getLocalNode().id()))\n+        ClusterNode localNode = getLocalNode();\n+\n+        if (localNode == null)\n+            throw new IgniteSpiException(\"Local node has not been started or fully initialized \" +\n+                \"[isStopping=\" + getSpiContext().isStopping() + ']');\n+\n+        if (node.id().equals(localNode.id()))\n             notifyListener(node.id(), msg, NOOP);\n         else {\n             GridCommunicationClient client = null;\n@@ -1804,7 +1810,7 @@ private void checkAttributePresence(ClusterNode node, String attrName) {\n \n                     UUID nodeId = null;\n \n-                    if (!client.async() && !getSpiContext().localNode().version().equals(node.version()))\n+                    if (!client.async() && !localNode.version().equals(node.version()))\n                         nodeId = node.id();\n \n                     retry = client.sendMessage(nodeId, msg);\n@@ -2435,8 +2441,14 @@ else if (log.isDebugEnabled())\n                     else\n                         ch.write(ByteBuffer.wrap(U.IGNITE_HEADER));\n \n+                    ClusterNode localNode = getLocalNode();\n+\n+                    if (localNode == null)\n+                        throw new IgniteCheckedException(\"Local node has not been started or \" +\n+                            \"fully initialized [isStopping=\" + getSpiContext().isStopping() + ']');\n+\n                     if (recovery != null) {\n-                        HandshakeMessage msg = new HandshakeMessage(getLocalNode().id(),\n+                        HandshakeMessage msg = new HandshakeMessage(localNode.id(),\n                             recovery.incrementConnectCount(),\n                             recovery.receivedCount());\n \n@@ -2629,7 +2641,20 @@ private void onException(String msg, Exception e) {\n      * @return Node ID message.\n      */\n     private NodeIdMessage nodeIdMessage() {\n-        return new NodeIdMessage(getLocalNode().id());\n+        ClusterNode localNode = getLocalNode();\n+\n+        UUID id;\n+\n+        if (localNode == null) {\n+            U.warn(log, \"Local node is not started or fully initialized [isStopping=\" +\n+                    getSpiContext().isStopping() + ']');\n+\n+            id = new UUID(0, 0);\n+        }\n+        else\n+            id = localNode.id();\n+\n+        return new NodeIdMessage(id);\n     }\n \n     /** {@inheritDoc} */\n@@ -3145,7 +3170,13 @@ else if (log.isDebugEnabled())\n             }\n \n             try {\n-                UUID id = getLocalNode().id();\n+                ClusterNode localNode = getLocalNode();\n+\n+                if (localNode == null)\n+                    throw new IgniteSpiException(\"Local node has not been started or fully initialized \" +\n+                        \"[isStopping=\" + getSpiContext().isStopping() + ']');\n+\n+                UUID id = localNode.id();\n \n                 NodeIdMessage msg = new NodeIdMessage(id);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/271550fed7662c5032f9e4fb49cd135f3a55a46e/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "sha": "1c74d5959c0a196440b3bbbbdd5b46ec80ff5396",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/271550fed7662c5032f9e4fb49cd135f3a55a46e/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoveryMultiThreadedTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoveryMultiThreadedTest.java?ref=271550fed7662c5032f9e4fb49cd135f3a55a46e",
                "deletions": 5,
                "filename": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoveryMultiThreadedTest.java",
                "patch": "@@ -88,9 +88,9 @@ public TcpDiscoveryMultiThreadedTest() throws Exception {\n \n     /** {@inheritDoc} */\n     @Override protected void afterTest() throws Exception {\n-        super.afterTest();\n-\n         stopAllGrids();\n+\n+        super.afterTest();\n     }\n \n     /** {@inheritDoc} */\n@@ -102,8 +102,6 @@ public TcpDiscoveryMultiThreadedTest() throws Exception {\n      * @throws Exception If any error occurs.\n      */\n     public void testMultiThreadedClientsRestart() throws Exception {\n-        fail(\"https://issues.apache.org/jira/browse/IGNITE-1139\");\n-\n         clientFlagGlobal = false;\n \n         info(\"Test timeout: \" + (getTestTimeout() / (60 * 1000)) + \" min.\");\n@@ -126,7 +124,7 @@ public void testMultiThreadedClientsRestart() throws Exception {\n                     int idx = clientIdx.getAndIncrement();\n \n                     while (!done.get()) {\n-                        stopGrid(idx);\n+                        stopGrid(idx, true);\n                         startGrid(idx);\n                     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/271550fed7662c5032f9e4fb49cd135f3a55a46e/modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoveryMultiThreadedTest.java",
                "sha": "f7c73b647ede0d8531625a1fb893791ebd197a24",
                "status": "modified"
            }
        ],
        "message": "Squashed commit of the following:\n\ncommit ed8dac68bb008c17246ecea5169b34a55b860869\nMerge: 6f915db a127756\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 16:56:39 2015 +0300\n\n    Merge remote-tracking branch 'remotes/origin/master' into ignite-1139\n\ncommit 6f915db1890c81af035984f07a7195da9048a67f\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 09:50:53 2015 +0300\n\n    ignite-1139: uncommented tests\n\ncommit aadbdda1dab5e1c350afb0ac5e7f1182095ecd70\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 09:30:50 2015 +0300\n\n    ignite-1139: set cancel to true when stopping a client node\n\ncommit 86c6f6a8df6e828e5cc3c606c334925e948dee7a\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 09:06:49 2015 +0300\n\n    ignite-1139: temporaly disable some SPI tests\n\ncommit e6a2d88063a1c32478f3ee1dea80c2ffe2ee19af\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 08:51:51 2015 +0300\n\n    ignite-\n\ncommit f39086536e3afd031ed158e9cd2d65afb71a32bf\nMerge: 14ee9df 84f8b95\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 08:42:28 2015 +0300\n\n    Merge branch 'ignite-1139' of https://git-wip-us.apache.org/repos/asf/incubator-ignite into ignite-1139\n\ncommit 14ee9df2251716d1a3913742ce05154e2e958b56\nMerge: fd6b0e3 0341759\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Mon Jul 27 08:39:31 2015 +0300\n\n    Merge remote-tracking branch 'remotes/origin/master' into ignite-1139\n\ncommit 84f8b956e40ae88d11e0ef125442203a497b8c4b\nAuthor: dmagda <magda7817@gmail.com>\nDate:   Fri Jul 24 13:35:32 2015 +0300\n\n    ignite-1139:\n    - fixed race in GridDhtPartitionsExchangeFuture\n    - fixed NPE in TcpCommunicationSpi when this SPI was not in the fully initialized state\n\ncommit 89da409d5e6a62e744c4030475bbbfcb822a103c\nMerge: fd6b0e3 ed5d3ed\nAuthor: dmagda <magda7817@gmail.com>\nDate:   Fri Jul 24 08:55:26 2015 +0300\n\n    Merge remote-tracking branch 'remotes/origin/master' into ignite-1139\n\ncommit fd6b0e3684df97875947c7864487b658ac599fce\nAuthor: Denis Magda <dmagda@gridgain.com>\nDate:   Thu Jul 23 16:08:21 2015 +0300\n\n    ignite-1139: unmuted test",
        "parent": "https://github.com/apache/ignite/commit/abb2cef136da824c55964bb4032c47dd150242c1",
        "patched_files": [
            "TcpCommunicationSpi.java",
            "GridDhtPartitionsExchangeFuture.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TestTcpCommunicationSpi.java",
            "TcpDiscoveryMultiThreadedTest.java"
        ]
    },
    "ignite_2929ace": {
        "bug_id": "ignite_2929ace",
        "commit": "https://github.com/apache/ignite/commit/2929acef591a6309438cd46e11751bf86a11bf8b",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/2929acef591a6309438cd46e11751bf86a11bf8b/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java?ref=2929acef591a6309438cd46e11751bf86a11bf8b",
                "deletions": 0,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java",
                "patch": "@@ -383,6 +383,9 @@ private int tryCompareOptimized(long pageAddr, int off, int maxSize, Value v) {\n         if (type == Value.NULL)\n             return Integer.MIN_VALUE;\n \n+        if (v == ValueNull.INSTANCE)\n+            return fixSort(1, sortType());\n+\n         if (this.type != type)\n             throw new UnsupportedOperationException(\"Invalid fast index type: \" + type);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/2929acef591a6309438cd46e11751bf86a11bf8b/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelper.java",
                "sha": "5c42d0d3097b40669b0890f9865b931d9f5f2ba9",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/2929acef591a6309438cd46e11751bf86a11bf8b/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java?ref=2929acef591a6309438cd46e11751bf86a11bf8b",
                "deletions": 2,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java",
                "patch": "@@ -207,15 +207,15 @@ private int putAndCompare(String v1, String v2, int maxSize) throws Exception {\n             InlineIndexHelper ih = new InlineIndexHelper(Value.STRING, 1, 0,\n                 CompareMode.getInstance(null, 0));\n \n-            ih.put(pageAddr, off, ValueString.get(v1), maxSize);\n+            ih.put(pageAddr, off, v1 == null ? ValueNull.INSTANCE : ValueString.get(v1), maxSize);\n \n             Comparator<Value> comp = new Comparator<Value>() {\n                 @Override public int compare(Value o1, Value o2) {\n                     throw new AssertionError(\"Optimized algorithm should be used.\");\n                 }\n             };\n \n-            return ih.compare(pageAddr, off, maxSize,  ValueString.get(v2), comp);\n+            return ih.compare(pageAddr, off, maxSize,  v2 == null ? ValueNull.INSTANCE : ValueString.get(v2), comp);\n         }\n         finally {\n             if (page != 0L)\n@@ -378,6 +378,10 @@ public void testBytes() throws Exception {\n     /** */\n     public void testNull() throws Exception {\n         testPutGet(ValueInt.get(-1), ValueNull.INSTANCE, ValueInt.get(3));\n+        testPutGet(ValueInt.get(-1), ValueNull.INSTANCE, ValueInt.get(3));\n+\n+        int maxSize = 3 + 2; // 2 ascii chars + 3 bytes header.\n+        assertEquals(1, putAndCompare(\"aa\", null, maxSize));\n     }\n \n     /** */",
                "raw_url": "https://github.com/apache/ignite/raw/2929acef591a6309438cd46e11751bf86a11bf8b/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/database/InlineIndexHelperTest.java",
                "sha": "4a6988734093f018999f3bf1c35e01e795b025f0",
                "status": "modified"
            }
        ],
        "message": "Fixed \"IGNITE-6360: NPE occurs if object with null indexed field is added\". This closes #2739.\n\nSigned-off-by: nikolay_tikhonov <ntikhonov@gridgain.com>",
        "parent": "https://github.com/apache/ignite/commit/12cbf75bb70615cf31ac059e89dabac1dabce77e",
        "patched_files": [
            "InlineIndexHelper.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "InlineIndexHelperTest.java"
        ]
    },
    "ignite_2ad974e": {
        "bug_id": "ignite_2ad974e",
        "commit": "https://github.com/apache/ignite/commit/2ad974e6af0767f4b639564092f9ae18116616cf",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/ignite/blob/2ad974e6af0767f4b639564092f9ae18116616cf/modules/ssh/src/test/java/org/apache/ignite/internal/IgniteProjectionStartStopRestartSelfTest.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ssh/src/test/java/org/apache/ignite/internal/IgniteProjectionStartStopRestartSelfTest.java?ref=2ad974e6af0767f4b639564092f9ae18116616cf",
                "deletions": 7,
                "filename": "modules/ssh/src/test/java/org/apache/ignite/internal/IgniteProjectionStartStopRestartSelfTest.java",
                "patch": "@@ -145,15 +145,21 @@\n \n     /** {@inheritDoc} */\n     @Override protected void afterTest() throws Exception {\n-        if (!ignite.cluster().nodes().isEmpty()) {\n-            leftLatch = new CountDownLatch(ignite.cluster().nodes().size());\n+        boolean wasEmpty = true;\n \n-            ignite.cluster().stopNodes();\n+        if (ignite != null) {\n+            if (!ignite.cluster().nodes().isEmpty()) {\n+                leftLatch = new CountDownLatch(ignite.cluster().nodes().size());\n \n-            assert leftLatch.await(WAIT_TIMEOUT, MILLISECONDS);\n-        }\n+                ignite.cluster().stopNodes();\n+\n+                assert leftLatch.await(\n+                    WAIT_TIMEOUT,\n+                    MILLISECONDS);\n+            }\n \n-        boolean wasEmpty = ignite.cluster().nodes().isEmpty();\n+            wasEmpty = ignite.cluster().nodes().isEmpty();\n+        }\n \n         G.stop(true);\n \n@@ -163,7 +169,8 @@\n         joinedLatch = null;\n         leftLatch = null;\n \n-        assert wasEmpty : \"grid.isEmpty() returned false after all nodes were stopped [nodes=\" + ignite.cluster().nodes() + ']';\n+        assert wasEmpty : \"grid.isEmpty() returned false after all nodes were stopped \" +\n+            \"[nodes=\" + ignite.cluster().nodes() + ']';\n     }\n \n     /** {@inheritDoc} */",
                "raw_url": "https://github.com/apache/ignite/raw/2ad974e6af0767f4b639564092f9ae18116616cf/modules/ssh/src/test/java/org/apache/ignite/internal/IgniteProjectionStartStopRestartSelfTest.java",
                "sha": "e1750640a0237fe0f3805632bd20274d3f127aa8",
                "status": "modified"
            }
        ],
        "message": "fixed NPE",
        "parent": "https://github.com/apache/ignite/commit/77d092c75fd8de40dd6a814c3a38839b80190119",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "IgniteProjectionStartStopRestartSelfTest.java"
        ]
    },
    "ignite_2d3eac7": {
        "bug_id": "ignite_2d3eac7",
        "commit": "https://github.com/apache/ignite/commit/2d3eac747656132ff877c76e70603580f6cc2efb",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/2d3eac747656132ff877c76e70603580f6cc2efb/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java?ref=2d3eac747656132ff877c76e70603580f6cc2efb",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "patch": "@@ -313,6 +313,9 @@ public boolean isLocalClientAdded(int cacheId) {\n      * Rechecks topology.\n      */\n     private void initTopology(GridCacheContext cacheCtx) throws IgniteCheckedException {\n+        if (stopping(cacheCtx.cacheId()))\n+            return;\n+\n         if (canCalculateAffinity(cacheCtx)) {\n             if (log.isDebugEnabled())\n                 log.debug(\"Will recalculate affinity [locNodeId=\" + cctx.localNodeId() + \", exchId=\" + exchId + ']');",
                "raw_url": "https://github.com/apache/ignite/raw/2d3eac747656132ff877c76e70603580f6cc2efb/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "sha": "a28f69c481162e7ec142de43af73a93e4b57ddac",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/2d3eac747656132ff877c76e70603580f6cc2efb/modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/GridFairAffinityFunctionSelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/GridFairAffinityFunctionSelfTest.java?ref=2d3eac747656132ff877c76e70603580f6cc2efb",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/GridFairAffinityFunctionSelfTest.java",
                "patch": "@@ -254,8 +254,6 @@ private void verifyAssignment(List<List<ClusterNode>> assignment, int keyBackups\n \n         log().warning(\"max=\" + max + \", min=\" + min + \", ideal=\" + ideal + \", minDev=\" + deviation(min, ideal) + \"%, \" +\n             \"maxDev=\" + deviation(max, ideal) + \"%\");\n-\n-        assertTrue(\"max=\" + max + \", min=\" + min, max - min < (keyBackups + 1) * topSize);\n     }\n \n     private static int deviation(int val, int ideal) {",
                "raw_url": "https://github.com/apache/ignite/raw/2d3eac747656132ff877c76e70603580f6cc2efb/modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/GridFairAffinityFunctionSelfTest.java",
                "sha": "dcf45086db9a68214ff3655c9c4379f746d5ac36",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/ignite/blob/2d3eac747656132ff877c76e70603580f6cc2efb/modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/IgniteFairAffinityDynamicCacheSelfTest.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/IgniteFairAffinityDynamicCacheSelfTest.java?ref=2d3eac747656132ff877c76e70603580f6cc2efb",
                "deletions": 16,
                "filename": "modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/IgniteFairAffinityDynamicCacheSelfTest.java",
                "patch": "@@ -70,27 +70,30 @@ public IgniteFairAffinityDynamicCacheSelfTest(){\n      * @throws Exception If failed.\n      */\n     public void testStartStopCache() throws Exception {\n-        CacheConfiguration<Integer, Integer> cacheCfg = new CacheConfiguration<>();\n+        for (int k = 0; k < 10; k++) {\n+            CacheConfiguration<Integer, Integer> cacheCfg = new CacheConfiguration<>();\n \n-        cacheCfg.setCacheMode(CacheMode.PARTITIONED);\n-        cacheCfg.setAtomicityMode(CacheAtomicityMode.ATOMIC);\n-        cacheCfg.setBackups(1);\n-        cacheCfg.setName(\"test\");\n-        cacheCfg.setAffinity(new FairAffinityFunction());\n+            cacheCfg.setCacheMode(CacheMode.PARTITIONED);\n+            cacheCfg.setAtomicityMode(CacheAtomicityMode.ATOMIC);\n+            cacheCfg.setBackups(1);\n+            cacheCfg.setName(\"test\");\n+            cacheCfg.setAffinity(new FairAffinityFunction());\n \n-        final IgniteCache<Integer, Integer> cache = ignite(0).createCache(cacheCfg);\n+            final IgniteCache<Integer, Integer> cache = ignite(0).createCache(cacheCfg);\n \n-        for (int i = 0; i < 10_000; i++)\n-            cache.put(i, i);\n+            for (int i = 0; i < 10_000; i++)\n+                cache.put(i, i);\n \n-        IgniteInternalFuture<Object> destFut = GridTestUtils.runAsync(new Callable<Object>() {\n-            @Override public Object call() throws Exception {\n-                ignite(0).destroyCache(cache.getName());\n+            IgniteInternalFuture<Object> destFut = GridTestUtils.runAsync(new Callable<Object>() {\n+                @Override\n+                public Object call() throws Exception {\n+                    ignite(0).destroyCache(cache.getName());\n \n-                return null;\n-            }\n-        });\n+                    return null;\n+                }\n+            });\n \n-        destFut.get(2000L);\n+            destFut.get(2000L);\n+        }\n     }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/2d3eac747656132ff877c76e70603580f6cc2efb/modules/core/src/test/java/org/apache/ignite/cache/affinity/fair/IgniteFairAffinityDynamicCacheSelfTest.java",
                "sha": "90571a4b49953d4be6021d026e1e00f755669e5f",
                "status": "modified"
            }
        ],
        "message": "IGNITE-721 - Fixed NPE in fair affinity",
        "parent": "https://github.com/apache/ignite/commit/1757473754a94e0e3ac0fb75c9767126de278dbb",
        "patched_files": [
            "GridDhtPartitionsExchangeFuture.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridFairAffinityFunctionSelfTest.java",
            "IgniteFairAffinityDynamicCacheSelfTest.java"
        ]
    },
    "ignite_2f72788": {
        "bug_id": "ignite_2f72788",
        "commit": "https://github.com/apache/ignite/commit/2f7278869b9af0c180b19046d7385802eeffa57b",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/2f7278869b9af0c180b19046d7385802eeffa57b/modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java?ref=2f7278869b9af0c180b19046d7385802eeffa57b",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java",
                "patch": "@@ -103,7 +103,19 @@ protected GridCacheDistributionMode distributionMode() {\n \n     /** {@inheritDoc} */\n     @Override protected void afterTest() throws Exception {\n-        assertEquals(gridCount(), grid(0).nodes().size());\n+        GridTestUtils.waitForCondition(new PA() {\n+            @Override public boolean apply() {\n+                for (int i = 0; i < gridCount(); i++) {\n+                    if (grid(i).nodes().size() != gridCount())\n+                        return false;\n+                }\n+\n+                return true;\n+            }\n+        }, 3000);\n+\n+        for (int i = 0; i < gridCount(); i++)\n+            assertEquals(gridCount(), grid(i).nodes().size());\n \n         for (int i = 0; i < gridCount(); i++)\n             grid(i).cache(null).removeAll();",
                "raw_url": "https://github.com/apache/ignite/raw/2f7278869b9af0c180b19046d7385802eeffa57b/modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java",
                "sha": "91a9efdd45d39beaef7825871735911f6ddce49e",
                "status": "modified"
            }
        ],
        "message": "# GG-7944 NPE in GridCacheGateway",
        "parent": "https://github.com/apache/ignite/commit/2e90c9c764a7c82afe554a8ebc5f286ccb8f4d07",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheContinuousQueryAbstractSelfTest.java"
        ]
    },
    "ignite_3087662": {
        "bug_id": "ignite_3087662",
        "commit": "https://github.com/apache/ignite/commit/3087662e3b32b1575ac429d43dae1f7eab2dcb7f",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/3087662e3b32b1575ac429d43dae1f7eab2dcb7f/modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java?ref=3087662e3b32b1575ac429d43dae1f7eab2dcb7f",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java",
                "patch": "@@ -985,7 +985,7 @@ protected IgniteConfiguration getConfiguration(String gridName) throws Exception\n \n         cfg.setNodeId(null);\n \n-        if (gridName.matches(\".*\\\\d\")) {\n+        if (gridName != null && gridName.matches(\".*\\\\d\")) {\n             String idStr = UUID.randomUUID().toString();\n \n             char[] chars = idStr.toCharArray();",
                "raw_url": "https://github.com/apache/ignite/raw/3087662e3b32b1575ac429d43dae1f7eab2dcb7f/modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java",
                "sha": "f3a9051ce72816fa7d391ca8e3db53f4fedcf18c",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/3087662e3b32b1575ac429d43dae1f7eab2dcb7f/modules/spring/src/test/java/org/apache/ignite/internal/GridFactorySelfTest.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/spring/src/test/java/org/apache/ignite/internal/GridFactorySelfTest.java?ref=3087662e3b32b1575ac429d43dae1f7eab2dcb7f",
                "deletions": 1,
                "filename": "modules/spring/src/test/java/org/apache/ignite/internal/GridFactorySelfTest.java",
                "patch": "@@ -62,7 +62,8 @@\n     private static final AtomicInteger cnt = new AtomicInteger();\n \n     /** */\n-    private static final String CUSTOM_CFG_PATH = \"modules/core/src/test/config/factory/custom-grid-name-spring-test.xml\";\n+    private static final String CUSTOM_CFG_PATH =\n+        \"modules/core/src/test/config/factory/custom-grid-name-spring-test.xml\";\n \n     /**\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/3087662e3b32b1575ac429d43dae1f7eab2dcb7f/modules/spring/src/test/java/org/apache/ignite/internal/GridFactorySelfTest.java",
                "sha": "ecc7fb787c30e7093f6fc1848cc66f171c59ed27",
                "status": "modified"
            }
        ],
        "message": "minor, fixed NPE in test",
        "parent": "https://github.com/apache/ignite/commit/86cc1ade3bc56a8ba7ae2efcce3e1876c406ba87",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "GridFactorySelfTest.java",
            "GridAbstractTest.java"
        ]
    },
    "ignite_359777f": {
        "bug_id": "ignite_359777f",
        "commit": "https://github.com/apache/ignite/commit/359777f2355483b3d206b874117d680076a03853",
        "file": [
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneDirectory.java",
                "changes": 64,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneDirectory.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 13,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneDirectory.java",
                "patch": "@@ -21,22 +21,27 @@\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Collection;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.atomic.AtomicLong;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.internal.util.offheap.unsafe.GridUnsafeMemory;\n+import org.apache.ignite.internal.util.typedef.F;\n import org.apache.lucene.store.BaseDirectory;\n import org.apache.lucene.store.Directory;\n import org.apache.lucene.store.IOContext;\n import org.apache.lucene.store.IndexInput;\n import org.apache.lucene.store.IndexOutput;\n+import org.apache.lucene.util.Accountable;\n+import org.apache.lucene.util.Accountables;\n \n /**\n  * A memory-resident {@link Directory} implementation.\n  */\n-public class GridLuceneDirectory extends BaseDirectory {\n+public class GridLuceneDirectory extends BaseDirectory implements Accountable {\n     /** */\n     protected final Map<String, GridLuceneFile> fileMap = new ConcurrentHashMap<>();\n \n@@ -51,7 +56,7 @@\n      *\n      * @param mem Memory.\n      */\n-    public GridLuceneDirectory(GridUnsafeMemory mem) {\n+    GridLuceneDirectory(GridUnsafeMemory mem) {\n         super(new GridLuceneLockFactory());\n \n         this.mem = mem;\n@@ -64,10 +69,7 @@ public GridLuceneDirectory(GridUnsafeMemory mem) {\n         // and the code below is resilient to map changes during the array population.\n         Set<String> fileNames = fileMap.keySet();\n \n-        List<String> names = new ArrayList<>(fileNames.size());\n-\n-        for (String name : fileNames)\n-            names.add(name);\n+        List<String> names = new ArrayList<>(fileNames);\n \n         return names.toArray(new String[names.size()]);\n     }\n@@ -82,6 +84,7 @@ public GridLuceneDirectory(GridUnsafeMemory mem) {\n             throw new FileNotFoundException(source);\n \n         fileMap.put(dest, file);\n+\n         fileMap.remove(source);\n     }\n \n@@ -101,21 +104,25 @@ public GridLuceneDirectory(GridUnsafeMemory mem) {\n     @Override public void deleteFile(String name) throws IOException {\n         ensureOpen();\n \n-        doDeleteFile(name);\n+        doDeleteFile(name, false);\n     }\n \n     /**\n      * Deletes file.\n      *\n      * @param name File name.\n+     * @param onClose If on close directory;\n      * @throws IOException If failed.\n      */\n-    private void doDeleteFile(String name) throws IOException {\n+    private void doDeleteFile(String name, boolean onClose) throws IOException {\n         GridLuceneFile file = fileMap.remove(name);\n \n         if (file != null) {\n             file.delete();\n \n+            // All files should be closed when Directory is closing.\n+            assert !onClose || !file.hasRefs() : \"Possible memory leak, resource is not closed: \" + file.toString();\n+\n             sizeInBytes.addAndGet(-file.getSizeInBytes());\n         }\n         else\n@@ -128,16 +135,17 @@ private void doDeleteFile(String name) throws IOException {\n \n         GridLuceneFile file = newRAMFile();\n \n-        GridLuceneFile existing = fileMap.remove(name);\n+        // Lock for using in stream. Will be unlocked on stream closing.\n+        file.lockRef();\n+\n+        GridLuceneFile existing = fileMap.put(name, file);\n \n         if (existing != null) {\n             sizeInBytes.addAndGet(-existing.getSizeInBytes());\n \n             existing.delete();\n         }\n \n-        fileMap.put(name, file);\n-\n         return new GridLuceneOutputStream(file);\n     }\n \n@@ -165,23 +173,53 @@ protected GridLuceneFile newRAMFile() {\n         if (file == null)\n             throw new FileNotFoundException(name);\n \n+        // Lock for using in stream. Will be unlocked on stream closing.\n+        file.lockRef();\n+\n+        if (!fileMap.containsKey(name)) {\n+            // Unblock for deferred delete.\n+            file.releaseRef();\n+\n+            throw new FileNotFoundException(name);\n+        }\n+\n         return new GridLuceneInputStream(name, file);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void close() {\n         isOpen = false;\n \n+        IgniteException errs = null;\n+\n         for (String fileName : fileMap.keySet()) {\n             try {\n-                doDeleteFile(fileName);\n+                doDeleteFile(fileName, true);\n             }\n             catch (IOException e) {\n-                throw new IllegalStateException(e);\n+                if (errs == null)\n+                    errs = new IgniteException(\"Error closing index directory.\");\n+\n+                errs.addSuppressed(e);\n             }\n         }\n \n         assert fileMap.isEmpty();\n+\n+        if (errs != null && !F.isEmpty(errs.getSuppressed()))\n+            throw errs;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public long ramBytesUsed() {\n+        ensureOpen();\n+\n+        return sizeInBytes.get();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public synchronized Collection<Accountable> getChildResources() {\n+        return Accountables.namedAccountables(\"file\", new HashMap<>(fileMap));\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneDirectory.java",
                "sha": "3ac9641f762db19dff87b70c1a99422f90273ab7",
                "status": "modified"
            },
            {
                "additions": 70,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneFile.java",
                "changes": 91,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneFile.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 21,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneFile.java",
                "patch": "@@ -17,22 +17,19 @@\n \n package org.apache.ignite.internal.processors.query.h2.opt;\n \n-import java.io.Serializable;\n import java.util.Arrays;\n-import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+import org.apache.lucene.util.Accountable;\n \n import static org.apache.ignite.internal.processors.query.h2.opt.GridLuceneOutputStream.BUFFER_SIZE;\n \n /**\n  * Lucene file.\n  */\n-public class GridLuceneFile implements Serializable {\n-    /** */\n-    private static final long serialVersionUID = 0L;\n-\n-    /** */\n-    public static final AtomicInteger filesCnt = new AtomicInteger();\n-\n+public class GridLuceneFile implements Accountable {\n     /** */\n     private LongArray buffers = new LongArray();\n \n@@ -45,15 +42,19 @@\n     /** */\n     private volatile long sizeInBytes;\n \n+    /** */\n+    private final AtomicLong refCnt = new AtomicLong();\n+\n+    /** */\n+    private final AtomicBoolean deleted = new AtomicBoolean();\n+\n     /**\n      * File used as buffer, in no RAMDirectory\n      *\n      * @param dir Directory.\n      */\n     GridLuceneFile(GridLuceneDirectory dir) {\n         this.dir = dir;\n-\n-        filesCnt.incrementAndGet();\n     }\n \n     /**\n@@ -92,52 +93,90 @@ final long addBuffer() {\n         return buf;\n     }\n \n+    /**\n+     * Increment ref counter.\n+     */\n+    void lockRef() {\n+        refCnt.incrementAndGet();\n+    }\n+\n+    /**\n+     * Decrement ref counter.\n+     */\n+    void releaseRef() {\n+        refCnt.decrementAndGet();\n+\n+        deferredDelete();\n+    }\n+\n+    /**\n+     * Checks if there is file stream opened.\n+     *\n+     * @return {@code True} if file has external references.\n+     */\n+    boolean hasRefs() {\n+        long refs = refCnt.get();\n+\n+        assert refs >= 0;\n+\n+        return refs != 0;\n+    }\n+\n     /**\n      * Gets address of buffer.\n      *\n      * @param idx Index.\n      * @return Pointer.\n      */\n-    protected final synchronized long getBuffer(int idx) {\n+    final synchronized long getBuffer(int idx) {\n         return buffers.get(idx);\n     }\n \n     /**\n      * @return Number of buffers.\n      */\n-    protected final synchronized int numBuffers() {\n+    final synchronized int numBuffers() {\n         return buffers.size();\n     }\n \n     /**\n-     * Expert: allocate a new buffer.\n-     * Subclasses can allocate differently.\n+     * Expert: allocate a new buffer. Subclasses can allocate differently.\n      *\n      * @return allocated buffer.\n      */\n-    protected long newBuffer() {\n+    private long newBuffer() {\n         return dir.memory().allocate(BUFFER_SIZE);\n     }\n \n     /**\n      * Deletes file and deallocates memory..\n      */\n-    public synchronized void delete() {\n-        if (buffers == null)\n+    public void delete() {\n+        if (!deleted.compareAndSet(false, true))\n             return;\n \n+        deferredDelete();\n+    }\n+\n+    /**\n+     * Deferred delete.\n+     */\n+    synchronized void deferredDelete() {\n+        if (!deleted.get() || hasRefs())\n+            return;\n+\n+        assert refCnt.get() == 0;\n+\n         for (int i = 0; i < buffers.idx; i++)\n             dir.memory().release(buffers.arr[i], BUFFER_SIZE);\n \n         buffers = null;\n-\n-        filesCnt.decrementAndGet();\n     }\n \n     /**\n      * @return Size in bytes.\n      */\n-    public long getSizeInBytes() {\n+    long getSizeInBytes() {\n         return sizeInBytes;\n     }\n \n@@ -148,6 +187,16 @@ public GridLuceneDirectory getDirectory() {\n         return dir;\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public long ramBytesUsed() {\n+        return sizeInBytes;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public Collection<Accountable> getChildResources() {\n+        return Collections.emptyList();\n+    }\n+\n     /**\n      * Simple expandable long[] wrapper.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneFile.java",
                "sha": "d7ae132903b976618a0c47bd599bdce2e04849a9",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneIndex.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneIndex.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 1,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneIndex.java",
                "patch": "@@ -296,7 +296,8 @@ public void remove(CacheObject key) throws IgniteCheckedException {\n     /** {@inheritDoc} */\n     @Override public void close() {\n         U.closeQuiet(writer);\n-        U.closeQuiet(dir);\n+\n+        dir.close();\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneIndex.java",
                "sha": "c51eb5d37cf5428990681f1224ec60969f51ec28",
                "status": "modified"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneInputStream.java",
                "changes": 42,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneInputStream.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 10,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneInputStream.java",
                "patch": "@@ -20,14 +20,15 @@\n import java.io.EOFException;\n import java.io.IOException;\n import org.apache.ignite.internal.util.offheap.unsafe.GridUnsafeMemory;\n+import org.apache.lucene.store.AlreadyClosedException;\n import org.apache.lucene.store.IndexInput;\n \n import static org.apache.ignite.internal.processors.query.h2.opt.GridLuceneOutputStream.BUFFER_SIZE;\n \n /**\n  * A memory-resident {@link IndexInput} implementation.\n  */\n-public class GridLuceneInputStream extends IndexInput {\n+public class GridLuceneInputStream extends IndexInput implements Cloneable {\n     /** */\n     private GridLuceneFile file;\n \n@@ -52,6 +53,11 @@\n     /** */\n     private final GridUnsafeMemory mem;\n \n+    /** */\n+    private volatile boolean closed;\n+\n+    /** */\n+    private boolean isClone;\n     /**\n      * Constructor.\n      *\n@@ -91,7 +97,24 @@ public GridLuceneInputStream(String name, GridLuceneFile f, final long length) t\n \n     /** {@inheritDoc} */\n     @Override public void close() {\n-        // nothing to do here\n+        if (!isClone) {\n+            closed = true;\n+\n+            file.releaseRef();\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public IndexInput clone() {\n+        GridLuceneInputStream clone = (GridLuceneInputStream) super.clone();\n+\n+        if(closed)\n+            throw new AlreadyClosedException(toString());\n+\n+        clone.isClone = true;\n+\n+        return clone;\n+\n     }\n \n     /** {@inheritDoc} */\n@@ -222,35 +245,34 @@ void readBytes(long ptr, int len) throws IOException {\n         public SlicedInputStream(String newResourceDescription, long offset, long length) throws IOException {\n             super(newResourceDescription, GridLuceneInputStream.this.file, offset + length);\n \n+            // Avoid parent resource closing together with this.\n+            super.isClone = true;\n+\n             this.offset = offset;\n \n             seek(0L);\n         }\n \n         /** {@inheritDoc} */\n-        @Override\n-        public void seek(long pos) throws IOException {\n+        @Override public void seek(long pos) throws IOException {\n             if (pos < 0L) {\n                 throw new IllegalArgumentException(\"Seeking to negative position: \" + this);\n             }\n             super.seek(pos + offset);\n         }\n \n         /** {@inheritDoc} */\n-        @Override\n-        public long getFilePointer() {\n+        @Override public long getFilePointer() {\n             return super.getFilePointer() - offset;\n         }\n \n         /** {@inheritDoc} */\n-        @Override\n-        public long length() {\n+        @Override public long length() {\n             return super.length() - offset;\n         }\n \n         /** {@inheritDoc} */\n-        @Override\n-        public IndexInput slice(String sliceDescription, long ofs, long len) throws IOException {\n+        @Override public IndexInput slice(String sliceDescription, long ofs, long len) throws IOException {\n             return super.slice(sliceDescription, offset + ofs, len);\n         }\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneInputStream.java",
                "sha": "9b1bf0c2a90909b11c2e90778769f5de18d66987",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneOutputStream.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneOutputStream.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 1,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneOutputStream.java",
                "patch": "@@ -18,17 +18,21 @@\n package org.apache.ignite.internal.processors.query.h2.opt;\n \n import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.zip.CRC32;\n import java.util.zip.Checksum;\n import org.apache.ignite.internal.util.offheap.unsafe.GridUnsafeMemory;\n import org.apache.lucene.store.BufferedChecksum;\n import org.apache.lucene.store.DataInput;\n import org.apache.lucene.store.IndexOutput;\n+import org.apache.lucene.util.Accountable;\n+import org.apache.lucene.util.Accountables;\n \n /**\n  * A memory-resident {@link IndexOutput} implementation.\n  */\n-public class GridLuceneOutputStream extends IndexOutput {\n+public class GridLuceneOutputStream extends IndexOutput implements Accountable {\n     /** Off-heap page size. */\n     static final int BUFFER_SIZE = 32 * 1024;\n \n@@ -93,6 +97,8 @@ public void reset() {\n     /** {@inheritDoc} */\n     @Override public void close() throws IOException {\n         flush();\n+\n+        file.releaseRef();\n     }\n \n     /** {@inheritDoc} */\n@@ -201,4 +207,14 @@ private void flush() throws IOException {\n             bufPosition += toCp;\n         }\n     }\n+\n+    /** {@inheritDoc} */\n+    @Override public long ramBytesUsed() {\n+        return file.getSizeInBytes();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public Collection<Accountable> getChildResources() {\n+        return Collections.singleton(Accountables.namedAccountable(\"file\", file));\n+    }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridLuceneOutputStream.java",
                "sha": "d8f09dfd0cf0fd10d278e20e67ce6470aaf96b03",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheFullTextQueryNodeJoiningSelfTest.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheFullTextQueryNodeJoiningSelfTest.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 1,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheFullTextQueryNodeJoiningSelfTest.java",
                "patch": "@@ -42,7 +42,6 @@\n import static org.apache.ignite.cache.CacheWriteSynchronizationMode.FULL_SYNC;\n \n /**\n- * TODO https://issues.apache.org/jira/browse/IGNITE-2229\n  * Tests cache in-place modification logic with iterative value increment.\n  */\n public class IgniteCacheFullTextQueryNodeJoiningSelfTest extends GridCommonAbstractTest {\n@@ -107,6 +106,8 @@ protected CacheAtomicityMode atomicityMode() {\n      * @throws Exception If failed.\n      */\n     public void testFullTextQueryNodeJoin() throws Exception {\n+        fail(\"https://issues.apache.org/jira/browse/IGNITE-2229\");\n+\n         for (int r = 0; r < 5; r++) {\n             startGrids(GRID_CNT);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheFullTextQueryNodeJoiningSelfTest.java",
                "sha": "162b1e5bacaaaa02cb1e036edd732a025252d28e",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java?ref=359777f2355483b3d206b874117d680076a03853",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "patch": "@@ -47,6 +47,7 @@\n import org.apache.ignite.internal.processors.cache.IgniteCacheDeleteSqlQuerySelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteCacheDuplicateEntityConfigurationSelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteCacheFieldsQueryNoDataSelfTest;\n+import org.apache.ignite.internal.processors.cache.IgniteCacheFullTextQueryNodeJoiningSelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteCacheInsertSqlQuerySelfTest;\n import org.apache.ignite.internal.processors.cache.IgniteCacheJoinPartitionedAndReplicatedTest;\n import org.apache.ignite.internal.processors.cache.IgniteCacheJoinQueryWithAffinityKeyTest;\n@@ -273,6 +274,7 @@ public static TestSuite suite() throws Exception {\n \n         // Full text queries.\n         suite.addTestSuite(GridCacheFullTextQuerySelfTest.class);\n+        suite.addTestSuite(IgniteCacheFullTextQueryNodeJoiningSelfTest.class);\n \n         // Ignite cache and H2 comparison.\n         suite.addTestSuite(BaseH2CompareQueryTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/359777f2355483b3d206b874117d680076a03853/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteCacheQuerySelfTestSuite.java",
                "sha": "1ad0d4bfb8ca24cccb130153828078b03c8c37f7",
                "status": "modified"
            }
        ],
        "message": "IGNITE-4800: Lucene query may fails with NPE. This closes #2315.",
        "parent": "https://github.com/apache/ignite/commit/48c914dcc3a092655636b0df5634c6336dd58a9d",
        "patched_files": [
            "GridLuceneInputStream.java",
            "GridLuceneOutputStream.java",
            "GridLuceneFile.java",
            "GridLuceneDirectory.java",
            "GridLuceneIndex.java",
            "IgniteCacheQuerySelfTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCacheFullTextQueryNodeJoiningSelfTest.java"
        ]
    },
    "ignite_3989451": {
        "bug_id": "ignite_3989451",
        "commit": "https://github.com/apache/ignite/commit/39894517ed30646627bfaadf3fed60fb72a7057b",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/39894517ed30646627bfaadf3fed60fb72a7057b/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheAbstractJdbcStore.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheAbstractJdbcStore.java?ref=39894517ed30646627bfaadf3fed60fb72a7057b",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheAbstractJdbcStore.java",
                "patch": "@@ -462,6 +462,12 @@ protected void end(@Nullable Connection conn, @Nullable Statement st) {\n                         clo.apply(key, val);\n                     }\n                 }\n+                catch (NullPointerException e){\n+                    //todo only for investigation\n+                    System.out.println(\"Got NPE\");\n+\n+                    e.printStackTrace();\n+                }\n                 catch (SQLException e) {\n                     throw new IgniteCheckedException(\"Failed to load cache\", e);\n                 }",
                "raw_url": "https://github.com/apache/ignite/raw/39894517ed30646627bfaadf3fed60fb72a7057b/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheAbstractJdbcStore.java",
                "sha": "26b4fe8d2cb45aa61f5d397a7f5f3d45c65baa32",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/39894517ed30646627bfaadf3fed60fb72a7057b/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java?ref=39894517ed30646627bfaadf3fed60fb72a7057b",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "patch": "@@ -7586,7 +7586,12 @@ public static void join(GridWorker w) throws IgniteInterruptedCheckedException {\n             return fut.get();\n         }\n         catch (ExecutionException e) {\n-             throw new IgniteCheckedException(e.getCause());\n+            //todo only for investigation\n+            System.out.println(\"Task exception:\");\n+\n+            e.getCause().printStackTrace();\n+\n+            throw new IgniteCheckedException(e.getCause());\n         }\n         catch (InterruptedException e) {\n             Thread.currentThread().interrupt();",
                "raw_url": "https://github.com/apache/ignite/raw/39894517ed30646627bfaadf3fed60fb72a7057b/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "sha": "b70513b271f5fba5b1ca336e644a6059b0078fd4",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/39894517ed30646627bfaadf3fed60fb72a7057b/modules/core/src/test/java/org/apache/ignite/internal/processors/odbc/OdbcProcessorValidationSelfTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/odbc/OdbcProcessorValidationSelfTest.java?ref=39894517ed30646627bfaadf3fed60fb72a7057b",
                "deletions": 5,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/odbc/OdbcProcessorValidationSelfTest.java",
                "patch": "@@ -17,18 +17,17 @@\n \n package org.apache.ignite.internal.processors.odbc;\n \n+import java.util.concurrent.Callable;\n+import java.util.concurrent.atomic.AtomicInteger;\n import org.apache.ignite.IgniteException;\n-import org.apache.ignite.Ignition;\n import org.apache.ignite.configuration.IgniteConfiguration;\n import org.apache.ignite.configuration.OdbcConfiguration;\n+import org.apache.ignite.internal.binary.BinaryMarshaller;\n import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n import org.apache.ignite.testframework.GridTestUtils;\n import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n \n-import java.util.concurrent.Callable;\n-import java.util.concurrent.atomic.AtomicInteger;\n-\n /**\n  * ODBC configuration validation tests.\n  */\n@@ -155,11 +154,12 @@ public void testThreadPoolSize() throws Exception {\n      */\n     @SuppressWarnings(\"ThrowableResultOfMethodCallIgnored\")\n     private void check(OdbcConfiguration odbcCfg, boolean success) throws Exception {\n-        final IgniteConfiguration cfg = new IgniteConfiguration();\n+        final IgniteConfiguration cfg = super.getConfiguration();\n \n         cfg.setGridName(OdbcProcessorValidationSelfTest.class.getName() + \"-\" + NODE_IDX_GEN.incrementAndGet());\n         cfg.setLocalHost(\"127.0.0.1\");\n         cfg.setOdbcConfiguration(odbcCfg);\n+        cfg.setMarshaller(new BinaryMarshaller());\n \n         TcpDiscoverySpi spi = new TcpDiscoverySpi();\n         spi.setIpFinder(new TcpDiscoveryVmIpFinder(true));",
                "raw_url": "https://github.com/apache/ignite/raw/39894517ed30646627bfaadf3fed60fb72a7057b/modules/core/src/test/java/org/apache/ignite/internal/processors/odbc/OdbcProcessorValidationSelfTest.java",
                "sha": "d0cdddf6d1ae4567f172e2ce69b025b600037c1c",
                "status": "modified"
            }
        ],
        "message": "ignite-db-x  try/catch for npe, odbc refactoring",
        "parent": "https://github.com/apache/ignite/commit/425ae4c4df9d621a8b82fc9f0b8a479d597e5c0d",
        "patched_files": [
            "CacheAbstractJdbcStore.java",
            "IgniteUtils.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "OdbcProcessorValidationSelfTest.java"
        ]
    },
    "ignite_411481c": {
        "bug_id": "ignite_411481c",
        "commit": "https://github.com/apache/ignite/commit/411481c80797384b61e520a0b2bd057058701a82",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/411481c80797384b61e520a0b2bd057058701a82/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java?ref=411481c80797384b61e520a0b2bd057058701a82",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "patch": "@@ -369,7 +369,8 @@ else if (evtType != EVT_NODE_METRICS_UPDATED)\n \n                 if (type == DiscoveryCustomEvent.EVT_DISCOVERY_CUSTOM_EVT) {\n                     try {\n-                        customEvtLsnr.apply(data);\n+                        if (customEvtLsnr != null)\n+                            customEvtLsnr.apply(data);\n                     }\n                     catch (Exception e) {\n                         U.error(log, \"Failed to notify direct custom event listener: \" + data, e);",
                "raw_url": "https://github.com/apache/ignite/raw/411481c80797384b61e520a0b2bd057058701a82/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "sha": "3cd6aab4742cf74bab22a1669a49025a00f86c50",
                "status": "modified"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/ignite/blob/411481c80797384b61e520a0b2bd057058701a82/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteDynamicCacheStartSelfTest.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteDynamicCacheStartSelfTest.java?ref=411481c80797384b61e520a0b2bd057058701a82",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteDynamicCacheStartSelfTest.java",
                "patch": "@@ -62,6 +62,9 @@ public boolean apply(ClusterNode n) {\n     /** */\n     private boolean testAttribute = true;\n \n+    /** */\n+    private boolean daemon;\n+\n     /**\n      * @return Number of nodes for this test.\n      */\n@@ -88,6 +91,9 @@ protected IgniteConfiguration getConfiguration(String gridName) throws Exception\n \n         cfg.setIncludeEventTypes(EventType.EVT_CACHE_STARTED, EventType.EVT_CACHE_STOPPED, EventType.EVT_CACHE_NODES_LEFT);\n \n+        if (daemon)\n+            cfg.setDaemon(true);\n+\n         return cfg;\n     }\n \n@@ -969,4 +975,31 @@ public boolean apply(CacheEvent e) {\n                 ignite(i).events().stopLocalListen(lsnrs[i]);\n         }\n     }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testDaemonNode() throws Exception {\n+        daemon = true;\n+\n+        Ignite dNode = startGrid(nodeCount());\n+\n+        try {\n+            CacheConfiguration cfg = new CacheConfiguration(DYNAMIC_CACHE_NAME);\n+\n+            try (IgniteCache cache = ignite(0).createCache(cfg)) {\n+                for (int i = 0; i < 100; i++) {\n+                    assertFalse(ignite(0).affinity(DYNAMIC_CACHE_NAME).mapKeyToPrimaryAndBackups(i)\n+                        .contains(dNode.cluster().localNode()));\n+\n+                    cache.put(i, i);\n+                }\n+            }\n+        }\n+        finally {\n+            stopGrid(nodeCount());\n+\n+            daemon = false;\n+        }\n+    }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/411481c80797384b61e520a0b2bd057058701a82/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteDynamicCacheStartSelfTest.java",
                "sha": "e57a0a24e66460edba562b5b31e5f01f81eb3e8c",
                "status": "modified"
            }
        ],
        "message": "IGNITE-594 - Fixed NPE, added test.",
        "parent": "https://github.com/apache/ignite/commit/f9f649aae3943bb9034dcdd56c279a3317db6f6b",
        "patched_files": [
            "GridDiscoveryManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteDynamicCacheStartSelfTest.java"
        ]
    },
    "ignite_4273950": {
        "bug_id": "ignite_4273950",
        "commit": "https://github.com/apache/ignite/commit/4273950458a9bb2f83d5fc0489da49aa1fa1dfaf",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/4273950458a9bb2f83d5fc0489da49aa1fa1dfaf/modules/hadoop/src/main/java/org/apache/ignite/hadoop/util/BasicUserNameMapper.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/main/java/org/apache/ignite/hadoop/util/BasicUserNameMapper.java?ref=4273950458a9bb2f83d5fc0489da49aa1fa1dfaf",
                "deletions": 3,
                "filename": "modules/hadoop/src/main/java/org/apache/ignite/hadoop/util/BasicUserNameMapper.java",
                "patch": "@@ -41,9 +41,7 @@\n \n     /** {@inheritDoc} */\n     @Nullable @Override public String map(String name) {\n-        assert mappings != null;\n-\n-        String res = mappings.get(name);\n+        String res = mappings != null ? mappings.get(name) : null;\n \n         return res != null ? res : useDfltUsrName ? dfltUsrName : name;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/4273950458a9bb2f83d5fc0489da49aa1fa1dfaf/modules/hadoop/src/main/java/org/apache/ignite/hadoop/util/BasicUserNameMapper.java",
                "sha": "c34808ae84bc4dab96ccbdddebcca23534ce891a",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/ignite/blob/4273950458a9bb2f83d5fc0489da49aa1fa1dfaf/modules/hadoop/src/test/java/org/apache/ignite/hadoop/util/BasicUserNameMapperSelfTest.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/test/java/org/apache/ignite/hadoop/util/BasicUserNameMapperSelfTest.java?ref=4273950458a9bb2f83d5fc0489da49aa1fa1dfaf",
                "deletions": 1,
                "filename": "modules/hadoop/src/test/java/org/apache/ignite/hadoop/util/BasicUserNameMapperSelfTest.java",
                "patch": "@@ -27,14 +27,31 @@\n  * Test for basic user name mapper.\n  */\n public class BasicUserNameMapperSelfTest extends GridCommonAbstractTest {\n+    /**\n+     * Test null mappings.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testNullMappings() throws Exception {\n+        checkNullOrEmptyMappings(null);\n+    }\n+\n     /**\n      * Test empty mappings.\n      *\n      * @throws Exception If failed.\n      */\n     public void testEmptyMappings() throws Exception {\n-        Map<String, String> map = new HashMap<>();\n+        checkNullOrEmptyMappings(new HashMap<String, String>());\n+    }\n \n+    /**\n+     * Check null or empty mappings.\n+     *\n+     * @param map Mappings.\n+     * @throws Exception If failed.\n+     */\n+    private void checkNullOrEmptyMappings(@Nullable Map<String, String> map) throws Exception {\n         BasicUserNameMapper mapper = create(map, false, null);\n \n         assertNull(mapper.map(null));",
                "raw_url": "https://github.com/apache/ignite/raw/4273950458a9bb2f83d5fc0489da49aa1fa1dfaf/modules/hadoop/src/test/java/org/apache/ignite/hadoop/util/BasicUserNameMapperSelfTest.java",
                "sha": "fd8fdef0369eb9d8ff657a80af096cd34274f1ea",
                "status": "modified"
            }
        ],
        "message": "IGNITE-3274: Hadoop: Fixed NPE in BasicUserNameMapper.",
        "parent": "https://github.com/apache/ignite/commit/c300448b94ed0d3f847197d1bbe67c31165c6ae6",
        "patched_files": [
            "BasicUserNameMapper.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "BasicUserNameMapperSelfTest.java"
        ]
    },
    "ignite_447ce47": {
        "bug_id": "ignite_447ce47",
        "commit": "https://github.com/apache/ignite/commit/447ce47cc2781fc4b95172ab386e87f2c08ce040",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/ignite/blob/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/BaselineTopology.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/BaselineTopology.java?ref=447ce47cc2781fc4b95172ab386e87f2c08ce040",
                "deletions": 6,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/BaselineTopology.java",
                "patch": "@@ -298,13 +298,15 @@ public ClusterNode baselineNode(Object consId) {\n      * @return Sorted list of baseline topology nodes.\n      */\n     public List<ClusterNode> createBaselineView(\n-        List<ClusterNode> aliveNodes,\n-        @Nullable IgnitePredicate<ClusterNode> nodeFilter)\n-    {\n+        Collection<ClusterNode> aliveNodes,\n+        @Nullable IgnitePredicate<ClusterNode> nodeFilter\n+    ) {\n         List<ClusterNode> res = new ArrayList<>(nodeMap.size());\n \n+        boolean nullNodeFilter = nodeFilter == null;\n+\n         for (ClusterNode node : aliveNodes) {\n-            if (nodeMap.containsKey(node.consistentId()) && (nodeFilter == null || CU.affinityNode(node, nodeFilter)))\n+            if (nodeMap.containsKey(node.consistentId()) && (nullNodeFilter || CU.affinityNode(node, nodeFilter)))\n                 res.add(node);\n         }\n \n@@ -316,7 +318,7 @@ public ClusterNode baselineNode(Object consId) {\n         Map<Object, ClusterNode> consIdMap = new HashMap<>();\n \n         for (ClusterNode node : aliveNodes) {\n-            if (nodeMap.containsKey(node.consistentId()) && (nodeFilter == null || CU.affinityNode(node, nodeFilter)))\n+            if (nodeMap.containsKey(node.consistentId()) && (nullNodeFilter || CU.affinityNode(node, nodeFilter)))\n                 consIdMap.put(node.consistentId(), node);\n         }\n \n@@ -326,7 +328,7 @@ public ClusterNode baselineNode(Object consId) {\n             if (!consIdMap.containsKey(consId)) {\n                 DetachedClusterNode node = new DetachedClusterNode(consId, e.getValue());\n \n-                if (nodeFilter == null || CU.affinityNode(node, nodeFilter))\n+                if (nullNodeFilter || CU.affinityNode(node, nodeFilter))\n                     consIdMap.put(consId, node);\n             }\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/BaselineTopology.java",
                "sha": "5a7e66aefc7bb7e9b1f5194aa9dc929fccf13eb3",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/main/java/org/apache/ignite/internal/util/GridLongList.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/GridLongList.java?ref=447ce47cc2781fc4b95172ab386e87f2c08ce040",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/GridLongList.java",
                "patch": "@@ -42,6 +42,9 @@\n     /** */\n     private static final long serialVersionUID = 0L;\n \n+    /** Empty array. */\n+    public static final long[] EMPTY_ARRAY = new long[0];\n+\n     /** */\n     private long[] arr;\n \n@@ -390,6 +393,9 @@ public int replaceValue(int startIdx, long oldVal, long newVal) {\n      * @return Array copy.\n      */\n     public long[] array() {\n+        if (arr == null)\n+            return EMPTY_ARRAY;\n+\n         long[] res = new long[idx];\n \n         System.arraycopy(arr, 0, res, 0, idx);",
                "raw_url": "https://github.com/apache/ignite/raw/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/main/java/org/apache/ignite/internal/util/GridLongList.java",
                "sha": "8d09539590f4300b8f09b4a6fac2b2701a63ec97",
                "status": "modified"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/ignite/blob/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java",
                "changes": 53,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java?ref=447ce47cc2781fc4b95172ab386e87f2c08ce040",
                "deletions": 27,
                "filename": "modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java",
                "patch": "@@ -17,6 +17,31 @@\n \n package org.apache.ignite.testframework.junits;\n \n+import java.io.ObjectStreamException;\n+import java.io.Serializable;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.lang.reflect.Proxy;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+import javax.cache.configuration.Factory;\n+import javax.cache.configuration.FactoryBuilder;\n import junit.framework.TestCase;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n@@ -98,32 +123,6 @@\n import org.springframework.context.ApplicationContext;\n import org.springframework.context.support.FileSystemXmlApplicationContext;\n \n-import javax.cache.configuration.Factory;\n-import javax.cache.configuration.FactoryBuilder;\n-import java.io.ObjectStreamException;\n-import java.io.Serializable;\n-import java.lang.reflect.Field;\n-import java.lang.reflect.InvocationHandler;\n-import java.lang.reflect.Method;\n-import java.lang.reflect.Modifier;\n-import java.lang.reflect.Proxy;\n-import java.net.MalformedURLException;\n-import java.net.URL;\n-import java.net.URLClassLoader;\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.UUID;\n-import java.util.concurrent.Callable;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n-import java.util.concurrent.TimeoutException;\n-import java.util.concurrent.atomic.AtomicInteger;\n-import java.util.concurrent.atomic.AtomicReference;\n-\n import static org.apache.ignite.IgniteSystemProperties.IGNITE_CLIENT_CACHE_CHANGE_MESSAGE_TIMEOUT;\n import static org.apache.ignite.IgniteSystemProperties.IGNITE_DISCO_FAILED_CLIENT_RECONNECT_DELAY;\n import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n@@ -604,7 +603,7 @@ protected void afterTestsStopped() throws Exception {\n             info(\">>> Starting test class: \" + testClassDescription() + \" <<<\");\n \n             if(isSafeTopology())\n-                assert G.allGrids().isEmpty() : \"Not all Ignite instances stopped before tests execution\";\n+                assert G.allGrids().isEmpty() : \"Not all Ignite instances stopped before tests execution:\" +  G.allGrids();\n \n             if (startGrid) {\n                 IgniteConfiguration cfg = optimize(getConfiguration());",
                "raw_url": "https://github.com/apache/ignite/raw/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/test/java/org/apache/ignite/testframework/junits/GridAbstractTest.java",
                "sha": "f1d66825b715b36915865da6ba51166b0d517fc9",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/ignite/blob/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/test/java/org/apache/ignite/util/GridLongListSelfTest.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/util/GridLongListSelfTest.java?ref=447ce47cc2781fc4b95172ab386e87f2c08ce040",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/util/GridLongListSelfTest.java",
                "patch": "@@ -150,4 +150,27 @@ public void testSort() {\n         assertEquals(asList(1, 3, 4, 5, 0), list);\n         assertEquals(asList(0, 1, 3, 4, 5), list.sort());\n     }\n+\n+    /**\n+     *\n+     */\n+    public void testArray() {\n+        GridLongList list = new GridLongList();\n+\n+        long[] array = list.array();\n+\n+        assertNotNull(array);\n+\n+        assertEquals(0, array.length);\n+\n+        list.add(1L);\n+\n+        array = list.array();\n+\n+        assertNotNull(array);\n+\n+        assertEquals(1, array.length);\n+\n+        assertEquals(1L, array[0]);\n+    }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/ignite/raw/447ce47cc2781fc4b95172ab386e87f2c08ce040/modules/core/src/test/java/org/apache/ignite/util/GridLongListSelfTest.java",
                "sha": "8849a3d2727d084c47ad541856d97e3b70150059",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9796 NPE if you call array() method on empty GridLongList - Fixes #4917.\n\nSigned-off-by: Ivan Rakov <irakov@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/ccf9c1ce33b5513372beed0ee8463ed3684e35e9",
        "patched_files": [
            "GridLongList.java",
            "BaselineTopology.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridAbstractTest.java",
            "GridLongListSelfTest.java"
        ]
    },
    "ignite_4c6f4ae": {
        "bug_id": "ignite_4c6f4ae",
        "commit": "https://github.com/apache/ignite/commit/4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
        "file": [
            {
                "additions": 31,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/configuration/DataRegionConfiguration.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/configuration/DataRegionConfiguration.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/configuration/DataRegionConfiguration.java",
                "patch": "@@ -133,6 +133,14 @@\n     /** Temporary buffer size for checkpoints in bytes. */\n     private long checkpointPageBufSize;\n \n+    /**\n+     * If {@code true}, memory for {@code DataRegion} will be allocated only on the creation of the first cache\n+     * belonged to this {@code DataRegion}.\n+     *\n+     * Default is {@code true}.\n+     */\n+    private boolean lazyMemoryAllocation = true;\n+\n     /**\n      * Gets data region name.\n      *\n@@ -433,6 +441,29 @@ public DataRegionConfiguration setCheckpointPageBufferSize(long checkpointPageBu\n         return this;\n     }\n \n+    /**\n+     * @return {@code True} if memory for {@code DataRegion} will be allocated only on the creation of the first cache\n+     * belonged to this {@code DataRegion}.\n+     */\n+    public boolean isLazyMemoryAllocation() {\n+        return lazyMemoryAllocation;\n+    }\n+\n+    /**\n+     * Sets {@code lazyMemoryAllocation} flag value.\n+     *\n+     * If {@code true}, memory for {@code DataRegion} will be allocated only on the creation of the first cache\n+     * belonged to this {@code DataRegion}.\n+     *\n+     * @param lazyMemoryAllocation Flag value.\n+     * @return {@code this} for chaining.\n+     */\n+    public DataRegionConfiguration setLazyMemoryAllocation(boolean lazyMemoryAllocation) {\n+        this.lazyMemoryAllocation = lazyMemoryAllocation;\n+\n+        return this;\n+    }\n+\n     /** {@inheritDoc} */\n     @Override public String toString() {\n         return S.toString(DataRegionConfiguration.class, this);",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/configuration/DataRegionConfiguration.java",
                "sha": "85910005a37ee560d4ee17ee70f522a6691616b0",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/IgniteKernal.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/IgniteKernal.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/IgniteKernal.java",
                "patch": "@@ -2010,7 +2010,8 @@ private String dataRegionConfigurationMessage(DataRegionConfiguration regCfg) {\n         m.a(\"  ^-- \").a(regCfg.getName()).a(\" [\");\n         m.a(\"initSize=\").a(U.readableSize(regCfg.getInitialSize(), false));\n         m.a(\", maxSize=\").a(U.readableSize(regCfg.getMaxSize(), false));\n-        m.a(\", persistence=\" + regCfg.isPersistenceEnabled()).a(']');\n+        m.a(\", persistence=\" + regCfg.isPersistenceEnabled());\n+        m.a(\", lazyMemoryAllocation=\" + regCfg.isLazyMemoryAllocation()).a(']');\n \n         return m.toString();\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/IgniteKernal.java",
                "sha": "c3c725d9430ae8518d98061a0a889eb03bf5d5b5",
                "status": "modified"
            },
            {
                "additions": 53,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java",
                "changes": 96,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 43,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java",
                "patch": "@@ -140,6 +140,9 @@\n     /** Segments array. */\n     private volatile Segment[] segments;\n \n+    /** Lock for segments changes. */\n+    private Object segmentsLock = new Object();\n+\n     /** */\n     private final AtomicInteger allocatedPages = new AtomicInteger();\n \n@@ -165,9 +168,9 @@\n     private final GridCacheSharedContext<?, ?> ctx;\n \n     /**\n-     * Marker that stop was invoked and memory is not supposed for any usage.\n+     * {@code False} if memory was not started or already stopped and is not supposed for any usage.\n      */\n-    private volatile boolean stopped;\n+    private volatile boolean started;\n \n     /**\n      * @param log Logger.\n@@ -208,58 +211,65 @@ public PageMemoryNoStoreImpl(\n \n     /** {@inheritDoc} */\n     @Override public void start() throws IgniteException {\n-        stopped = false;\n+        synchronized (segmentsLock) {\n+            if (started)\n+                return;\n+\n+            started = true;\n \n-        long startSize = dataRegionCfg.getInitialSize();\n-        long maxSize = dataRegionCfg.getMaxSize();\n+            long startSize = dataRegionCfg.getInitialSize();\n+            long maxSize = dataRegionCfg.getMaxSize();\n \n-        long[] chunks = new long[SEG_CNT];\n+            long[] chunks = new long[SEG_CNT];\n \n-        chunks[0] = startSize;\n+            chunks[0] = startSize;\n \n-        long total = startSize;\n+            long total = startSize;\n \n-        long allocChunkSize = Math.max((maxSize - startSize) / (SEG_CNT - 1), 256L * 1024 * 1024);\n+            long allocChunkSize = Math.max((maxSize - startSize) / (SEG_CNT - 1), 256L * 1024 * 1024);\n \n-        int lastIdx = 0;\n+            int lastIdx = 0;\n \n-        for (int i = 1; i < SEG_CNT; i++) {\n-            long allocSize = Math.min(allocChunkSize, maxSize - total);\n+            for (int i = 1; i < SEG_CNT; i++) {\n+                long allocSize = Math.min(allocChunkSize, maxSize - total);\n \n-            if (allocSize <= 0)\n-                break;\n+                if (allocSize <= 0)\n+                    break;\n \n-            chunks[i] = allocSize;\n+                chunks[i] = allocSize;\n \n-            total += allocSize;\n+                total += allocSize;\n \n-            lastIdx = i;\n-        }\n+                lastIdx = i;\n+            }\n \n-        if (lastIdx != SEG_CNT - 1)\n-            chunks = Arrays.copyOf(chunks, lastIdx + 1);\n+            if (lastIdx != SEG_CNT - 1)\n+                chunks = Arrays.copyOf(chunks, lastIdx + 1);\n \n-        if (segments == null)\n-            directMemoryProvider.initialize(chunks);\n+            if (segments == null)\n+                directMemoryProvider.initialize(chunks);\n \n-        addSegment(null);\n+            addSegment(null);\n+        }\n     }\n \n     /** {@inheritDoc} */\n     @Override public void stop(boolean deallocate) throws IgniteException {\n-        if (log.isDebugEnabled())\n-            log.debug(\"Stopping page memory.\");\n+        synchronized (segmentsLock) {\n+            if (log.isDebugEnabled())\n+                log.debug(\"Stopping page memory.\");\n \n-        stopped = true;\n+            started = false;\n \n-        directMemoryProvider.shutdown(deallocate);\n+            directMemoryProvider.shutdown(deallocate);\n \n-        if (directMemoryProvider instanceof Closeable) {\n-            try {\n-                ((Closeable)directMemoryProvider).close();\n-            }\n-            catch (IOException e) {\n-                throw new IgniteException(e);\n+            if (directMemoryProvider instanceof Closeable) {\n+                try {\n+                    ((Closeable)directMemoryProvider).close();\n+                }\n+                catch (IOException e) {\n+                    throw new IgniteException(e);\n+                }\n             }\n         }\n     }\n@@ -271,7 +281,7 @@ public PageMemoryNoStoreImpl(\n \n     /** {@inheritDoc} */\n     @Override public long allocatePage(int grpId, int partId, byte flags) {\n-        assert !stopped;\n+        assert started;\n \n         long relPtr = borrowFreePage();\n         long absPtr = 0;\n@@ -335,7 +345,7 @@ public PageMemoryNoStoreImpl(\n \n     /** {@inheritDoc} */\n     @Override public boolean freePage(int cacheId, long pageId) {\n-        assert !stopped;\n+        assert started;\n \n         releaseFreePage(pageId);\n \n@@ -461,7 +471,7 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n \n     /** {@inheritDoc} */\n     @Override public long acquirePage(int cacheId, long pageId, IoStatisticsHolder statHolder) {\n-        assert !stopped;\n+        assert started;\n \n         int pageIdx = PageIdUtils.pageIndex(pageId);\n \n@@ -476,7 +486,7 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n \n     /** {@inheritDoc} */\n     @Override public void releasePage(int cacheId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         if (trackAcquiredPages) {\n             Segment seg = segment(PageIdUtils.pageIndex(pageId));\n@@ -487,7 +497,7 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n \n     /** {@inheritDoc} */\n     @Override public long readLock(int cacheId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         if (rwLock.readLock(page + LOCK_OFFSET, PageIdUtils.tag(pageId)))\n             return page + PAGE_OVERHEAD;\n@@ -497,7 +507,7 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n \n     /** {@inheritDoc} */\n     @Override public long readLockForce(int cacheId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         if (rwLock.readLock(page + LOCK_OFFSET, -1))\n             return page + PAGE_OVERHEAD;\n@@ -507,14 +517,14 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n \n     /** {@inheritDoc} */\n     @Override public void readUnlock(int cacheId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         rwLock.readUnlock(page + LOCK_OFFSET);\n     }\n \n     /** {@inheritDoc} */\n     @Override public long writeLock(int cacheId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         if (rwLock.writeLock(page + LOCK_OFFSET, PageIdUtils.tag(pageId)))\n             return page + PAGE_OVERHEAD;\n@@ -524,7 +534,7 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n \n     /** {@inheritDoc} */\n     @Override public long tryWriteLock(int cacheId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         if (rwLock.tryWriteLock(page + LOCK_OFFSET, PageIdUtils.tag(pageId)))\n             return page + PAGE_OVERHEAD;\n@@ -540,7 +550,7 @@ private long fromSegmentIndex(int segIdx, long pageIdx) {\n         Boolean walPlc,\n         boolean dirtyFlag\n     ) {\n-        assert !stopped;\n+        assert started;\n \n         long actualId = PageIO.getPageId(page + PAGE_OVERHEAD);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/pagemem/impl/PageMemoryNoStoreImpl.java",
                "sha": "adfbf449c64ff5a868bcdfb4b126e3f616d0a685",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -2813,6 +2813,15 @@ private CacheGroupContext startCacheGroup(\n         String memPlcName = cfg.getDataRegionName();\n \n         DataRegion dataRegion = sharedCtx.database().dataRegion(memPlcName);\n+\n+        boolean needToStart = (dataRegion != null)\n+            && (cacheType != CacheType.USER\n+                || (sharedCtx.isLazyMemoryAllocation(dataRegion)\n+                    && (!cacheObjCtx.kernalContext().clientNode() || cfg.getCacheMode() == LOCAL)));\n+\n+        if (needToStart)\n+            dataRegion.pageMemory().start();\n+\n         FreeList freeList = sharedCtx.database().freeList(memPlcName);\n         ReuseList reuseList = sharedCtx.database().reuseList(memPlcName);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "e095db4ae3577caebf145d570c2177b457440a23",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java",
                "patch": "@@ -49,6 +49,7 @@\n import org.apache.ignite.internal.processors.cache.mvcc.DeadlockDetectionManager;\n import org.apache.ignite.internal.processors.cache.mvcc.MvccCachingManager;\n import org.apache.ignite.internal.processors.cache.mvcc.MvccProcessor;\n+import org.apache.ignite.internal.processors.cache.persistence.DataRegion;\n import org.apache.ignite.internal.processors.cache.persistence.IgniteCacheDatabaseSharedManager;\n import org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteCacheSnapshotManager;\n import org.apache.ignite.internal.processors.cache.store.CacheStoreManager;\n@@ -1155,4 +1156,11 @@ public void readOnlyMode(boolean readOnlyMode) {\n     public void setTxManager(IgniteTxManager txMgr) {\n         this.txMgr = txMgr;\n     }\n+\n+    /**\n+     * @return {@code True} if lazy memory allocation enabled. {@code False} otherwise.\n+     */\n+    public boolean isLazyMemoryAllocation(@Nullable DataRegion region) {\n+        return gridConfig().isClientMode() || region == null || region.config().isLazyMemoryAllocation();\n+    }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java",
                "sha": "32a8f5b81a44f343655d4f574e5a6c9caf8eaf33",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/mvcc/MvccProcessorImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/mvcc/MvccProcessorImpl.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/mvcc/MvccProcessorImpl.java",
                "patch": "@@ -965,6 +965,8 @@ private DataRegionConfiguration createTxLogRegion(DataStorageConfiguration dscfg\n         cfg.setInitialSize(dscfg.getSystemRegionInitialSize());\n         cfg.setMaxSize(dscfg.getSystemRegionMaxSize());\n         cfg.setPersistenceEnabled(CU.isPersistenceEnabled(dscfg));\n+        cfg.setLazyMemoryAllocation(false);\n+\n         return cfg;\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/mvcc/MvccProcessorImpl.java",
                "sha": "6643b125c4ccf5ae670bb2fa96993993ef1edcd4",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "patch": "@@ -508,6 +508,7 @@ private DataRegionConfiguration createMetastoreDataRegionConfig(DataStorageConfi\n         cfg.setInitialSize(storageCfg.getSystemRegionInitialSize());\n         cfg.setMaxSize(storageCfg.getSystemRegionMaxSize());\n         cfg.setPersistenceEnabled(true);\n+        cfg.setLazyMemoryAllocation(false);\n \n         return cfg;\n     }\n@@ -2188,7 +2189,24 @@ private RestoreBinaryState performBinaryMemoryRestore(\n                     U.quietAndWarn(log, \"Ignite node stopped in the middle of checkpoint. Will restore memory state and \" +\n                         \"finish checkpoint on node start.\");\n \n-                cctx.pageStore().beginRecover();\n+            cctx.cache().cacheGroupDescriptors().forEach((grpId, desc) -> {\n+                if (!cacheGroupsPredicate.apply(grpId))\n+                    return;\n+\n+                try {\n+                    DataRegion region = cctx.database().dataRegion(desc.config().getDataRegionName());\n+\n+                    if (region == null || !cctx.isLazyMemoryAllocation(region))\n+                        return;\n+\n+                    region.pageMemory().start();\n+                }\n+                catch (IgniteCheckedException e) {\n+                    throw new IgniteException(e);\n+                }\n+            });\n+\n+            cctx.pageStore().beginRecover();\n \n                 if (!(startRec instanceof CheckpointRecord))\n                     throw new StorageException(\"Checkpoint marker doesn't point to checkpoint record \" +",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "sha": "9110c95b484923f989d371bc33094bef42f6d109",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/IgniteCacheDatabaseSharedManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/IgniteCacheDatabaseSharedManager.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/IgniteCacheDatabaseSharedManager.java",
                "patch": "@@ -276,7 +276,8 @@ public int pageSize() {\n      */\n     private void startDataRegions() {\n         for (DataRegion region : dataRegionMap.values()) {\n-            region.pageMemory().start();\n+            if (!cctx.isLazyMemoryAllocation(region))\n+                region.pageMemory().start();\n \n             region.evictionTracker().start();\n         }\n@@ -463,6 +464,7 @@ private DataRegionConfiguration createSystemDataRegion(\n         res.setInitialSize(sysCacheInitSize);\n         res.setMaxSize(sysCacheMaxSize);\n         res.setPersistenceEnabled(persistenceEnabled);\n+        res.setLazyMemoryAllocation(false);\n \n         return res;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/IgniteCacheDatabaseSharedManager.java",
                "sha": "d93c189f974518694f3c6fc3f6821637f401965f",
                "status": "modified"
            },
            {
                "additions": 112,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "changes": 185,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 73,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "patch": "@@ -238,7 +238,10 @@\n     private final DirectMemoryProvider directMemoryProvider;\n \n     /** Segments array. */\n-    private Segment[] segments;\n+    private volatile Segment[] segments;\n+\n+    /** Lock for segments changes. */\n+    private Object segmentsLock = new Object();\n \n     /** */\n     private PagePool checkpointPool;\n@@ -281,9 +284,9 @@\n     private DataRegionMetricsImpl memMetrics;\n \n     /**\n-     * Marker that stop was invoked and memory is not supposed for any usage.\n+     * {@code False} if memory was not started or already stopped and is not supposed for any usage.\n      */\n-    private volatile boolean stopped;\n+    private volatile boolean started;\n \n     /**\n      * @param directMemoryProvider Memory allocator to use.\n@@ -347,56 +350,64 @@ public PageMemoryImpl(\n \n     /** {@inheritDoc} */\n     @Override public void start() throws IgniteException {\n-        stopped = false;\n+        synchronized (segmentsLock) {\n+            if (started)\n+                return;\n \n-        directMemoryProvider.initialize(sizes);\n+            started = true;\n \n-        List<DirectMemoryRegion> regions = new ArrayList<>(sizes.length);\n+            directMemoryProvider.initialize(sizes);\n \n-        while (true) {\n-            DirectMemoryRegion reg = directMemoryProvider.nextRegion();\n+            List<DirectMemoryRegion> regions = new ArrayList<>(sizes.length);\n \n-            if (reg == null)\n-                break;\n+            while (true) {\n+                DirectMemoryRegion reg = directMemoryProvider.nextRegion();\n \n-            regions.add(reg);\n-        }\n+                if (reg == null)\n+                    break;\n \n-        int regs = regions.size();\n+                regions.add(reg);\n+            }\n \n-        segments = new Segment[regs - 1];\n+            int regs = regions.size();\n \n-        DirectMemoryRegion cpReg = regions.get(regs - 1);\n+            Segment[] segments = new Segment[regs - 1];\n \n-        checkpointPool = new PagePool(regs - 1, cpReg, cpBufPagesCntr);\n+            DirectMemoryRegion cpReg = regions.get(regs - 1);\n \n-        long checkpointBuf = cpReg.size();\n+            checkpointPool = new PagePool(regs - 1, cpReg, cpBufPagesCntr);\n \n-        long totalAllocated = 0;\n-        int pages = 0;\n-        long totalTblSize = 0;\n+            long checkpointBuf = cpReg.size();\n \n-        for (int i = 0; i < regs - 1; i++) {\n-            assert i < segments.length;\n+            long totalAllocated = 0;\n+            int pages = 0;\n+            long totalTblSize = 0;\n \n-            DirectMemoryRegion reg = regions.get(i);\n+            for (int i = 0; i < regs - 1; i++) {\n+                assert i < segments.length;\n \n-            totalAllocated += reg.size();\n+                DirectMemoryRegion reg = regions.get(i);\n \n-            segments[i] = new Segment(i, regions.get(i), checkpointPool.pages() / segments.length, throttlingPlc);\n+                totalAllocated += reg.size();\n \n-            pages += segments[i].pages();\n-            totalTblSize += segments[i].tableSize();\n-        }\n+                segments[i] = new Segment(i, regions.get(i), checkpointPool.pages() / segments.length, throttlingPlc);\n+\n+                pages += segments[i].pages();\n+                totalTblSize += segments[i].tableSize();\n+            }\n \n-        initWriteThrottle();\n+            this.segments = segments;\n \n-        if (log.isInfoEnabled())\n-            log.info(\"Started page memory [memoryAllocated=\" + U.readableSize(totalAllocated, false) +\n-                \", pages=\" + pages +\n-                \", tableSize=\" + U.readableSize(totalTblSize, false) +\n-                \", checkpointBuffer=\" + U.readableSize(checkpointBuf, false) +\n-                ']');\n+            initWriteThrottle();\n+\n+            if (log.isInfoEnabled())\n+                log.info(\"Started page memory [memoryAllocated=\" + U.readableSize(totalAllocated, false) +\n+                    \", pages=\" + pages +\n+                    \", tableSize=\" + U.readableSize(totalTblSize, false) +\n+                    \", checkpointBuffer=\" + U.readableSize(checkpointBuf, false) +\n+                    ']');\n+\n+        }\n     }\n \n     /**\n@@ -413,24 +424,29 @@ else if (throttlingPlc == ThrottlingPolicy.CHECKPOINT_BUFFER_ONLY)\n \n     /** {@inheritDoc} */\n     @Override public void stop(boolean deallocate) throws IgniteException {\n-        if (log.isDebugEnabled())\n-            log.debug(\"Stopping page memory.\");\n+        synchronized (segmentsLock) {\n+            if (!started)\n+                return;\n \n-        U.shutdownNow(getClass(), asyncRunner, log);\n+            if (log.isDebugEnabled())\n+                log.debug(\"Stopping page memory.\");\n \n-        if (segments != null) {\n-            for (Segment seg : segments)\n-                seg.close();\n-        }\n+            U.shutdownNow(getClass(), asyncRunner, log);\n \n-        stopped = true;\n+            if (segments != null) {\n+                for (Segment seg : segments)\n+                    seg.close();\n+            }\n+\n+            started = false;\n \n-        directMemoryProvider.shutdown(deallocate);\n+            directMemoryProvider.shutdown(deallocate);\n+        }\n     }\n \n     /** {@inheritDoc} */\n     @Override public void releasePage(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         Segment seg = segment(grpId, pageId);\n \n@@ -446,58 +462,58 @@ else if (throttlingPlc == ThrottlingPolicy.CHECKPOINT_BUFFER_ONLY)\n \n     /** {@inheritDoc} */\n     @Override public long readLock(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         return readLock(page, pageId, false);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void readUnlock(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         readUnlockPage(page);\n     }\n \n     /** {@inheritDoc} */\n     @Override public long writeLock(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         return writeLock(grpId, pageId, page, false);\n     }\n \n     /** {@inheritDoc} */\n     @Override public long writeLock(int grpId, long pageId, long page, boolean restore) {\n-        assert !stopped;\n+        assert started;\n \n         return writeLockPage(page, new FullPageId(pageId, grpId), !restore);\n     }\n \n     /** {@inheritDoc} */\n     @Override public long tryWriteLock(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         return tryWriteLockPage(page, new FullPageId(pageId, grpId), true);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void writeUnlock(int grpId, long pageId, long page, Boolean walPlc,\n         boolean dirtyFlag) {\n-        assert !stopped;\n+        assert started;\n \n         writeUnlock(grpId, pageId, page, walPlc, dirtyFlag, false);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void writeUnlock(int grpId, long pageId, long page, Boolean walPlc,\n         boolean dirtyFlag, boolean restore) {\n-        assert !stopped;\n+        assert started;\n \n         writeUnlockPage(page, new FullPageId(pageId, grpId), walPlc, dirtyFlag, restore);\n     }\n \n     /** {@inheritDoc} */\n     @Override public boolean isDirty(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         return isDirty(page);\n     }\n@@ -508,7 +524,7 @@ else if (throttlingPlc == ThrottlingPolicy.CHECKPOINT_BUFFER_ONLY)\n             flags == PageIdAllocator.FLAG_IDX && partId == PageIdAllocator.INDEX_PARTITION :\n             \"flags = \" + flags + \", partId = \" + partId;\n \n-        assert !stopped;\n+        assert started;\n         assert stateChecker.checkpointLockIsHeldByThread();\n \n         if (isThrottlingEnabled())\n@@ -664,14 +680,14 @@ private DataRegionConfiguration getDataRegionConfiguration() {\n \n     /** {@inheritDoc} */\n     @Override public long metaPageId(int grpId) throws IgniteCheckedException {\n-        assert !stopped;\n+        assert started;\n \n         return storeMgr.metaPageId(grpId);\n     }\n \n     /** {@inheritDoc} */\n     @Override public long partitionMetaPageId(int grpId, int partId) throws IgniteCheckedException {\n-        assert !stopped;\n+        assert started;\n \n         return PageIdUtils.pageId(partId, PageIdAllocator.FLAG_DATA, 0);\n     }\n@@ -684,15 +700,15 @@ private DataRegionConfiguration getDataRegionConfiguration() {\n     /** {@inheritDoc} */\n     @Override public long acquirePage(int grpId, long pageId,\n         IoStatisticsHolder statHolder) throws IgniteCheckedException {\n-        assert !stopped;\n+        assert started;\n \n         return acquirePage(grpId, pageId, statHolder, false);\n     }\n \n     /** {@inheritDoc} */\n     @Override public long acquirePage(int grpId, long pageId, IoStatisticsHolder statHolder,\n         boolean restore) throws IgniteCheckedException {\n-        assert !stopped;\n+        assert started;\n \n         FullPageId fullId = new FullPageId(pageId, grpId);\n \n@@ -1047,6 +1063,9 @@ private void tryToRestorePage(FullPageId fullId, ByteBuffer buf) throws IgniteCh\n      * @param dirtyRatioThreshold Throttle threshold.\n      */\n     boolean shouldThrottle(double dirtyRatioThreshold) {\n+        if (segments == null)\n+            return false;\n+\n         for (Segment segment : segments) {\n             if (segment.shouldThrottle(dirtyRatioThreshold))\n                 return true;\n@@ -1059,6 +1078,9 @@ boolean shouldThrottle(double dirtyRatioThreshold) {\n      * @return Max dirty ratio from the segments.\n      */\n     double getDirtyPagesRatio() {\n+        if (segments == null)\n+            return 0;\n+\n         double res = 0;\n \n         for (Segment segment : segments) {\n@@ -1072,6 +1094,9 @@ boolean shouldThrottle(double dirtyRatioThreshold) {\n      * @return Total pages can be placed in all segments.\n      */\n     public long totalPages() {\n+        if (segments == null)\n+            return 0;\n+\n         long res = 0;\n \n         for (Segment segment : segments) {\n@@ -1319,25 +1344,30 @@ private void copyInBuffer(long absPtr, ByteBuffer buf) {\n \n     /** {@inheritDoc} */\n     @Override public int invalidate(int grpId, int partId) {\n-        int tag = 0;\n+        synchronized (segmentsLock) {\n+            if (!started)\n+                return 0;\n \n-        for (Segment seg : segments) {\n-            seg.writeLock().lock();\n+            int tag = 0;\n \n-            try {\n-                int newTag = seg.incrementPartGeneration(grpId, partId);\n+            for (Segment seg : segments) {\n+                seg.writeLock().lock();\n \n-                if (tag == 0)\n-                    tag = newTag;\n+                try {\n+                    int newTag = seg.incrementPartGeneration(grpId, partId);\n \n-                assert tag == newTag;\n-            }\n-            finally {\n-                seg.writeLock().unlock();\n+                    if (tag == 0)\n+                        tag = newTag;\n+\n+                    assert tag == newTag;\n+                }\n+                finally {\n+                    seg.writeLock().unlock();\n+                }\n             }\n-        }\n \n-        return tag;\n+            return tag;\n+        }\n     }\n \n     /** {@inheritDoc} */\n@@ -1407,6 +1437,9 @@ private void copyInBuffer(long absPtr, ByteBuffer buf) {\n      * @return Total number of acquired pages.\n      */\n     public long acquiredPages() {\n+        if (segments == null)\n+            return 0L;\n+\n         long total = 0;\n \n         for (Segment seg : segments) {\n@@ -1438,7 +1471,7 @@ private long readLock(long absPtr, long pageId, boolean force) {\n \n     /** {@inheritDoc} */\n     @Override  public long readLock(long absPtr, long pageId, boolean force, boolean touch) {\n-        assert !stopped;\n+        assert started;\n \n         int tag = force ? -1 : PageIdUtils.tag(pageId);\n \n@@ -1457,7 +1490,7 @@ private long readLock(long absPtr, long pageId, boolean force) {\n \n     /** {@inheritDoc} */\n     @Override public long readLockForce(int grpId, long pageId, long page) {\n-        assert !stopped;\n+        assert started;\n \n         return readLock(page, pageId, true);\n     }\n@@ -1676,6 +1709,9 @@ boolean isDirty(long absPtr) {\n      * @return Number of active pages.\n      */\n     public int activePagesCount() {\n+        if (segments == null)\n+            return 0;\n+\n         int total = 0;\n \n         for (Segment seg : segments)\n@@ -1947,6 +1983,9 @@ private int pages() {\n      * @return Collection of all page IDs marked as dirty.\n      */\n     public Collection<FullPageId> dirtyPages() {\n+        if (segments == null)\n+            return Collections.EMPTY_SET;\n+\n         Collection<FullPageId> res = new HashSet<>((int)loadedPages());\n \n         for (Segment seg : segments)",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "sha": "45dfae1e1725c52abb6ac84ef5893e1ff64cb1c3",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/client/ClientConnectionContext.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/client/ClientConnectionContext.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/client/ClientConnectionContext.java",
                "patch": "@@ -44,11 +44,15 @@\n     /** Version 1.2.0. */\n     public static final ClientListenerProtocolVersion VER_1_2_0 = ClientListenerProtocolVersion.create(1, 2, 0);\n \n+    /** Version 1.3.0. */\n+    public static final ClientListenerProtocolVersion VER_1_3_0 = ClientListenerProtocolVersion.create(1, 3, 0);\n+\n     /** Version 1.2.0. */\n-    public static final ClientListenerProtocolVersion CURRENT_VER = VER_1_2_0;\n+    public static final ClientListenerProtocolVersion CURRENT_VER = VER_1_3_0;\n \n     /** Supported versions. */\n     private static final Collection<ClientListenerProtocolVersion> SUPPORTED_VERS = Arrays.asList(\n+        VER_1_3_0,\n         VER_1_2_0,\n         VER_1_1_0,\n         VER_1_0_0",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/client/ClientConnectionContext.java",
                "sha": "25f7a96cfa58bc997598c6f22e304949a43e2ec4",
                "status": "modified"
            },
            {
                "additions": 41,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformConfigurationUtils.java",
                "changes": 64,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformConfigurationUtils.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 23,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformConfigurationUtils.java",
                "patch": "@@ -110,6 +110,7 @@\n import org.apache.ignite.transactions.TransactionIsolation;\n \n import static org.apache.ignite.internal.processors.platform.client.ClientConnectionContext.VER_1_2_0;\n+import static org.apache.ignite.internal.processors.platform.client.ClientConnectionContext.VER_1_3_0;\n \n /**\n  * Configuration utils.\n@@ -815,7 +816,7 @@ public static void readIgniteConfiguration(BinaryRawReaderEx in, IgniteConfigura\n             cfg.setPersistentStoreConfiguration(readPersistentStoreConfiguration(in));\n \n         if (in.readBoolean())\n-            cfg.setDataStorageConfiguration(readDataStorageConfiguration(in));\n+            cfg.setDataStorageConfiguration(readDataStorageConfiguration(in, ver));\n \n         if (in.readBoolean())\n             cfg.setSslContextFactory(readSslContextFactory(in));\n@@ -1410,7 +1411,7 @@ else if (evtStorageSpi instanceof MemoryEventStorageSpi) {\n \n         writePersistentStoreConfiguration(w, cfg.getPersistentStoreConfiguration());\n \n-        writeDataStorageConfiguration(w, cfg.getDataStorageConfiguration());\n+        writeDataStorageConfiguration(w, cfg.getDataStorageConfiguration(), ver);\n \n         writeSslContextFactory(w, cfg.getSslContextFactory());\n \n@@ -1885,9 +1886,11 @@ private static PersistentStoreConfiguration readPersistentStoreConfiguration(Bin\n      * Reads the data storage configuration.\n      *\n      * @param in Reader.\n+     * @param ver Client version.\n      * @return Config.\n      */\n-    private static DataStorageConfiguration readDataStorageConfiguration(BinaryRawReader in) {\n+    private static DataStorageConfiguration readDataStorageConfiguration(BinaryRawReader in,\n+        ClientListenerProtocolVersion ver) {\n         DataStorageConfiguration res = new DataStorageConfiguration()\n                 .setStoragePath(in.readString())\n                 .setCheckpointFrequency(in.readLong())\n@@ -1926,13 +1929,13 @@ private static DataStorageConfiguration readDataStorageConfiguration(BinaryRawRe\n             DataRegionConfiguration[] regs = new DataRegionConfiguration[cnt];\n \n             for (int i = 0; i < cnt; i++)\n-                regs[i] = readDataRegionConfiguration(in);\n+                regs[i] = readDataRegionConfiguration(in, ver);\n \n             res.setDataRegionConfigurations(regs);\n         }\n \n         if (in.readBoolean())\n-            res.setDefaultDataRegionConfiguration(readDataRegionConfiguration(in));\n+            res.setDefaultDataRegionConfiguration(readDataRegionConfiguration(in, ver));\n \n         return res;\n     }\n@@ -2011,8 +2014,11 @@ private static void writePersistentStoreConfiguration(BinaryRawWriter w, Persist\n      * Writes the data storage configuration.\n      *\n      * @param w Writer.\n+     * @param cfg Data storage configuration.\n+     * @param ver Client version.\n      */\n-    private static void writeDataStorageConfiguration(BinaryRawWriter w, DataStorageConfiguration cfg) {\n+    private static void writeDataStorageConfiguration(BinaryRawWriter w, DataStorageConfiguration cfg,\n+        ClientListenerProtocolVersion ver) {\n         assert w != null;\n \n         if (cfg != null) {\n@@ -2057,14 +2063,14 @@ private static void writeDataStorageConfiguration(BinaryRawWriter w, DataStorage\n                 w.writeInt(cfg.getDataRegionConfigurations().length);\n \n                 for (DataRegionConfiguration d : cfg.getDataRegionConfigurations())\n-                    writeDataRegionConfiguration(w, d);\n+                    writeDataRegionConfiguration(w, d, ver);\n             }\n             else\n                 w.writeInt(0);\n \n             if (cfg.getDefaultDataRegionConfiguration() != null) {\n                 w.writeBoolean(true);\n-                writeDataRegionConfiguration(w, cfg.getDefaultDataRegionConfiguration());\n+                writeDataRegionConfiguration(w, cfg.getDefaultDataRegionConfiguration(), ver);\n             }\n             else\n                 w.writeBoolean(false);\n@@ -2077,8 +2083,10 @@ private static void writeDataStorageConfiguration(BinaryRawWriter w, DataStorage\n      * Writes the data region configuration.\n      *\n      * @param w Writer.\n+     * @param ver Client version.\n      */\n-    private static void writeDataRegionConfiguration(BinaryRawWriter w, DataRegionConfiguration cfg) {\n+    private static void writeDataRegionConfiguration(BinaryRawWriter w, DataRegionConfiguration cfg,\n+        ClientListenerProtocolVersion ver) {\n         assert w != null;\n         assert cfg != null;\n \n@@ -2094,6 +2102,9 @@ private static void writeDataRegionConfiguration(BinaryRawWriter w, DataRegionCo\n         w.writeInt(cfg.getMetricsSubIntervalCount());\n         w.writeLong(cfg.getMetricsRateTimeInterval());\n         w.writeLong(cfg.getCheckpointPageBufferSize());\n+\n+        if (ver.compareTo(VER_1_3_0) >= 0)\n+            w.writeBoolean(cfg.isLazyMemoryAllocation());\n     }\n \n     /**\n@@ -2131,23 +2142,30 @@ private static void writeSslContextFactory(BinaryRawWriter w, Factory<SSLContext\n      * Reads the data region configuration.\n      *\n      * @param r Reader.\n+     * @param ver Client version.\n      */\n-    private static DataRegionConfiguration readDataRegionConfiguration(BinaryRawReader r) {\n+    private static DataRegionConfiguration readDataRegionConfiguration(BinaryRawReader r,\n+        ClientListenerProtocolVersion ver) {\n         assert r != null;\n \n-        return new DataRegionConfiguration()\n-                .setName(r.readString())\n-                .setPersistenceEnabled(r.readBoolean())\n-                .setInitialSize(r.readLong())\n-                .setMaxSize(r.readLong())\n-                .setSwapPath(r.readString())\n-                .setPageEvictionMode(DataPageEvictionMode.fromOrdinal(r.readInt()))\n-                .setEvictionThreshold(r.readDouble())\n-                .setEmptyPagesPoolSize(r.readInt())\n-                .setMetricsEnabled(r.readBoolean())\n-                .setMetricsSubIntervalCount(r.readInt())\n-                .setMetricsRateTimeInterval(r.readLong())\n-                .setCheckpointPageBufferSize(r.readLong());\n+        DataRegionConfiguration cfg = new DataRegionConfiguration()\n+            .setName(r.readString())\n+            .setPersistenceEnabled(r.readBoolean())\n+            .setInitialSize(r.readLong())\n+            .setMaxSize(r.readLong())\n+            .setSwapPath(r.readString())\n+            .setPageEvictionMode(DataPageEvictionMode.fromOrdinal(r.readInt()))\n+            .setEvictionThreshold(r.readDouble())\n+            .setEmptyPagesPoolSize(r.readInt())\n+            .setMetricsEnabled(r.readBoolean())\n+            .setMetricsSubIntervalCount(r.readInt())\n+            .setMetricsRateTimeInterval(r.readLong())\n+            .setCheckpointPageBufferSize(r.readLong());\n+\n+        if (ver.compareTo(VER_1_3_0) >= 0)\n+            cfg.setLazyMemoryAllocation(r.readBoolean());\n+\n+        return cfg;\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformConfigurationUtils.java",
                "sha": "857c1b12c71b7aab790981deed9634e88b6fb59d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "patch": "@@ -296,7 +296,7 @@\n @SuppressWarnings({\"UnusedReturnValue\", \"RedundantStringConstructorCall\"})\n public abstract class IgniteUtils {\n     /** */\n-    private static final long GB = 1024L * 1024 * 1024;\n+    public static final long GB = 1024L * 1024 * 1024;\n \n     /** Minimum checkpointing page buffer size (may be adjusted by Ignite). */\n     public static final Long DFLT_MIN_CHECKPOINTING_PAGE_BUFFER_SIZE = GB / 4;",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "sha": "999b4409870eb65a01605fe7146bd98dc145bade",
                "status": "modified"
            },
            {
                "additions": 275,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationTest.java",
                "changes": 275,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationTest.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationTest.java",
                "patch": "@@ -0,0 +1,275 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.pagemem;\n+\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.pagemem.PageMemory;\n+import org.apache.ignite.internal.processors.cache.persistence.IgniteCacheDatabaseSharedManager;\n+import org.apache.ignite.lang.IgnitePredicate;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/** */\n+public class PageMemoryLazyAllocationTest extends GridCommonAbstractTest {\n+    /** */\n+    public static final String LAZY_REGION = \"lazyRegion\";\n+\n+    /** */\n+    public static final String EAGER_REGION = \"eagerRegion\";\n+\n+    /** */\n+    protected boolean client = false;\n+\n+    /** */\n+    protected boolean lazyAllocation = true;\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setClientMode(client);\n+\n+        cfg.setDataStorageConfiguration(new DataStorageConfiguration()\n+            .setDataRegionConfigurations(\n+                new DataRegionConfiguration()\n+                    .setName(LAZY_REGION)\n+                    .setLazyMemoryAllocation(lazyAllocation)\n+                    .setPersistenceEnabled(persistenceEnabled()),\n+                new DataRegionConfiguration()\n+                    .setName(EAGER_REGION)\n+                    .setLazyMemoryAllocation(lazyAllocation)\n+                    .setPersistenceEnabled(persistenceEnabled())));\n+\n+        CacheConfiguration<?, ?> ccfg = new CacheConfiguration<>(\"my-cache\")\n+            .setDataRegionName(EAGER_REGION);\n+\n+        cfg.setCacheConfiguration(ccfg);\n+\n+        return cfg;\n+    }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testLazyMemoryAllocationOnServer() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startSrv()[0];\n+\n+        IgniteCacheDatabaseSharedManager db = srv.context().cache().context().database();\n+\n+        checkMemoryAllocated(db.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(db.dataRegion(LAZY_REGION).pageMemory());\n+\n+        createCacheAndPut(srv);\n+\n+        checkMemoryAllocated(db.dataRegion(LAZY_REGION).pageMemory());\n+    }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testLazyMemoryAllocationOnClient() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startSrv()[0];\n+\n+        IgniteCacheDatabaseSharedManager srvDb = srv.context().cache().context().database();\n+\n+        checkMemoryAllocated(srvDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(srvDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        client = true;\n+\n+        IgniteEx clnt = startGrid(2);\n+\n+        IgniteCacheDatabaseSharedManager clntDb = clnt.context().cache().context().database();\n+\n+        checkMemoryNotAllocated(clntDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(clntDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        createCacheAndPut(clnt);\n+\n+        checkMemoryAllocated(srvDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        checkMemoryNotAllocated(clntDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(clntDb.dataRegion(LAZY_REGION).pageMemory());\n+    }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testEagerMemoryAllocationOnServer() throws Exception {\n+        lazyAllocation = false;\n+        client = false;\n+\n+        IgniteEx g = startSrv()[0];\n+\n+        IgniteCacheDatabaseSharedManager db = g.context().cache().context().database();\n+\n+        checkMemoryAllocated(db.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryAllocated(db.dataRegion(LAZY_REGION).pageMemory());\n+\n+        createCacheAndPut(g);\n+    }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testEagerMemoryAllocationOnClient() throws Exception {\n+        lazyAllocation = false;\n+        client = false;\n+\n+        IgniteEx srv = startSrv()[0];\n+\n+        IgniteCacheDatabaseSharedManager srvDb = srv.context().cache().context().database();\n+\n+        checkMemoryAllocated(srvDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryAllocated(srvDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        client = true;\n+\n+        IgniteEx clnt = startGrid(2);\n+\n+        IgniteCacheDatabaseSharedManager clntDb = clnt.context().cache().context().database();\n+\n+        checkMemoryNotAllocated(clntDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(clntDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        createCacheAndPut(clnt);\n+\n+        checkMemoryNotAllocated(clntDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(clntDb.dataRegion(LAZY_REGION).pageMemory());\n+    }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testLocalCacheOnClientNodeWithLazyAllocation() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startSrv()[0];\n+\n+        IgniteCacheDatabaseSharedManager srvDb = srv.context().cache().context().database();\n+\n+        checkMemoryAllocated(srvDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(srvDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        client = true;\n+\n+        IgniteEx clnt = startGrid(2);\n+\n+        IgniteCacheDatabaseSharedManager clntDb = clnt.context().cache().context().database();\n+\n+        checkMemoryNotAllocated(clntDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(clntDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        createCacheAndPut(clnt, CacheMode.LOCAL);\n+\n+        checkMemoryNotAllocated(clntDb.dataRegion(EAGER_REGION).pageMemory());\n+        //LOCAL Cache was created in LAZY_REGION so it has to be allocated on client node.\n+        checkMemoryAllocated(clntDb.dataRegion(LAZY_REGION).pageMemory());\n+    }\n+\n+    /** @throws Exception If failed. */\n+    @Test\n+    public void testStopNotAllocatedRegions() throws Exception {\n+        IgniteEx srv = startSrv()[0];\n+\n+        IgniteCacheDatabaseSharedManager srvDb = srv.context().cache().context().database();\n+\n+        checkMemoryAllocated(srvDb.dataRegion(EAGER_REGION).pageMemory());\n+        checkMemoryNotAllocated(srvDb.dataRegion(LAZY_REGION).pageMemory());\n+\n+        stopGrid(0);\n+    }\n+\n+    @After\n+    public void after() {\n+        stopAllGrids();\n+    }\n+\n+    @Before\n+    public void before() throws Exception {\n+        cleanPersistenceDir();\n+    }\n+\n+    /** */\n+    protected void createCacheAndPut(IgniteEx g) {\n+        createCacheAndPut(g, CacheConfiguration.DFLT_CACHE_MODE);\n+    }\n+\n+    /** */\n+    private void createCacheAndPut(IgniteEx g, CacheMode cacheMode) {\n+        createCacheAndPut(g, cacheMode, null);\n+    }\n+\n+    /** */\n+    private void createCacheAndPut(IgniteEx g, CacheMode cacheMode, IgnitePredicate<ClusterNode> fltr) {\n+        IgniteCache<Integer, String> cache =\n+            g.createCache(new CacheConfiguration<Integer, String>(\"my-cache-2\")\n+                .setCacheMode(cacheMode)\n+                .setDataRegionName(LAZY_REGION)\n+                .setNodeFilter(fltr));\n+\n+        cache.put(1, \"test\");\n+\n+        assertEquals(cache.get(1), \"test\");\n+    }\n+\n+    /** */\n+    protected void checkMemoryAllocated(PageMemory pageMem) {\n+        Object[] segments = GridTestUtils.getFieldValue(pageMem, \"segments\");\n+\n+        assertNotNull(segments);\n+        assertTrue(segments.length > 0);\n+        assertNotNull(segments[0]);\n+    }\n+\n+    /** */\n+    protected void checkMemoryNotAllocated(PageMemory pageMem) {\n+        Object[] segments = GridTestUtils.getFieldValue(pageMem, \"segments\");\n+\n+        assertNull(segments);\n+    }\n+\n+    /** */\n+    protected IgniteEx[] startSrv() throws Exception {\n+        IgniteEx srv0 = startGrid(0);\n+        IgniteEx srv1 = startGrid(1);\n+\n+        srv0.cluster().active(true);\n+\n+        awaitPartitionMapExchange();\n+\n+        return new IgniteEx[] {srv0, srv1};\n+    }\n+\n+    /** */\n+    protected boolean persistenceEnabled() {\n+        return false;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationTest.java",
                "sha": "c7478ec71bdbdbbd629262dcf25b424bf20dd38a",
                "status": "added"
            },
            {
                "additions": 159,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationWithPDSTest.java",
                "changes": 159,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationWithPDSTest.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationWithPDSTest.java",
                "patch": "@@ -0,0 +1,159 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.pagemem;\n+\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.jetbrains.annotations.NotNull;\n+import org.junit.Ignore;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.util.IgniteUtils.GB;\n+\n+/** */\n+public class PageMemoryLazyAllocationWithPDSTest extends PageMemoryLazyAllocationTest {\n+\n+    public static final long PETA_BYTE = 1024 * GB;\n+\n+    /** {@inheritDoc} */\n+    @Ignore(\"https://issues.apache.org/jira/browse/IGNITE-11677\")\n+    @Override public void testLocalCacheOnClientNodeWithLazyAllocation() throws Exception {\n+        // No-op.\n+    }\n+\n+    /** */\n+    @Test\n+    public void testNodeRestart() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startSrv()[0];\n+\n+        createCacheAndPut(srv);\n+\n+        stopAllGrids(false);\n+\n+        IgniteCache<Integer, String> cache = startSrv()[0].cache(\"my-cache-2\");\n+\n+        assertEquals(\"test\", cache.get(1));\n+    }\n+\n+    /** */\n+    @Test\n+    public void testClientNodeRestart() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startSrv()[0];\n+\n+        client = true;\n+\n+        IgniteEx clnt = startGrid(2);\n+\n+        createCacheAndPut(clnt);\n+\n+        stopAllGrids(false);\n+\n+        client = false;\n+\n+        srv = startSrv()[0];\n+\n+        client = true;\n+\n+        IgniteCache<Integer, String> cache = startGrid(2).cache(\"my-cache-2\");\n+\n+        assertEquals(\"test\", cache.get(1));\n+    }\n+\n+    /** */\n+    @Test\n+    public void testHugeNotUsedMemoryRegion() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startGrid(cfgWithHugeRegion(\"test-server\"));\n+\n+        startGrid(cfgWithHugeRegion(\"test-server-2\"));\n+\n+        srv.cluster().active(true);\n+\n+        awaitPartitionMapExchange();\n+\n+        stopAllGrids(false);\n+\n+        srv = startGrid(cfgWithHugeRegion(\"test-server\"));\n+\n+        startGrid(cfgWithHugeRegion(\"test-server-2\"));\n+\n+        srv.cluster().active(true);\n+    }\n+\n+    /** */\n+    @Test\n+    public void testCreateCacheFailsInHugeMemoryRegion() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startGrid(cfgWithHugeRegion(\"test-server\")\n+            .setFailureHandler(new StopNodeFailureHandler()));\n+\n+        srv.cluster().active(true);\n+\n+        awaitPartitionMapExchange();\n+    }\n+\n+    /** */\n+    @Test\n+    public void testCreateCacheFromClientFailsInHugeMemoryRegion() throws Exception {\n+        lazyAllocation = true;\n+        client = false;\n+\n+        IgniteEx srv = startGrid(cfgWithHugeRegion(\"test-server\")\n+            .setFailureHandler(new StopNodeFailureHandler()));\n+\n+        client = true;\n+\n+        IgniteEx clnt = startGrid(cfgWithHugeRegion(\"test-client\")\n+            .setFailureHandler(new StopNodeFailureHandler()));\n+\n+        srv.cluster().active(true);\n+\n+        awaitPartitionMapExchange();\n+    }\n+\n+    @NotNull private IgniteConfiguration cfgWithHugeRegion(String name) throws Exception {\n+        IgniteConfiguration cfg = getConfiguration(name);\n+\n+        for (DataRegionConfiguration drc : cfg.getDataStorageConfiguration().getDataRegionConfigurations()) {\n+            if (drc.getName().equals(LAZY_REGION))\n+                drc.setMaxSize(PETA_BYTE);\n+        }\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected boolean persistenceEnabled() {\n+        return true;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryLazyAllocationWithPDSTest.java",
                "sha": "c84928b60f6a35e176abdd7f3ca73a4237d90d00",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java",
                "patch": "@@ -44,6 +44,8 @@\n import org.apache.ignite.internal.processors.cache.persistence.pagemem.IndexStoragePageMemoryImplTest;\n import org.apache.ignite.internal.processors.cache.persistence.pagemem.PageMemoryImplNoLoadTest;\n import org.apache.ignite.internal.processors.cache.persistence.pagemem.PageMemoryImplTest;\n+import org.apache.ignite.internal.processors.cache.persistence.pagemem.PageMemoryLazyAllocationTest;\n+import org.apache.ignite.internal.processors.cache.persistence.pagemem.PageMemoryLazyAllocationWithPDSTest;\n import org.apache.ignite.internal.processors.cache.persistence.pagemem.PageMemoryNoStoreLeakTest;\n import org.apache.ignite.internal.processors.cache.persistence.pagemem.PagesWriteThrottleSmokeTest;\n import org.apache.ignite.internal.processors.cache.persistence.pagemem.UsedPagesMetricTest;\n@@ -88,6 +90,8 @@\n         //GridTestUtils.addTestIfNeeded(suite, PageMemoryNoLoadSelfTest.class, ignoredTests);\n         GridTestUtils.addTestIfNeeded(suite, PageMemoryImplNoLoadTest.class, ignoredTests);\n         GridTestUtils.addTestIfNeeded(suite, PageMemoryNoStoreLeakTest.class, ignoredTests);\n+        GridTestUtils.addTestIfNeeded(suite, PageMemoryLazyAllocationTest.class, ignoredTests);\n+        GridTestUtils.addTestIfNeeded(suite, PageMemoryLazyAllocationWithPDSTest.class, ignoredTests);\n         GridTestUtils.addTestIfNeeded(suite, IndexStoragePageMemoryImplTest.class, ignoredTests);\n         GridTestUtils.addTestIfNeeded(suite, PageMemoryImplTest.class, ignoredTests);\n         //GridTestUtils.addTestIfNeeded(suite, PageIdDistributionTest.class, ignoredTests);",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/core/src/test/java/org/apache/ignite/testsuites/IgnitePdsTestSuite.java",
                "sha": "e21577da56074e247fdf6fab317ed76983751c93",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataRegionConfiguration.cs",
                "changes": 30,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataRegionConfiguration.cs?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 2,
                "filename": "modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataRegionConfiguration.cs",
                "patch": "@@ -24,6 +24,7 @@ namespace Apache.Ignite.Core.Configuration\n     using Apache.Ignite.Core.Cache.Configuration;\n     using Apache.Ignite.Core.Impl;\n     using Apache.Ignite.Core.Impl.Binary;\n+    using Apache.Ignite.Core.Impl.Client;\n \n     /// <summary>\n     /// Defines custom data region configuration for Apache Ignite page memory\n@@ -74,6 +75,11 @@ public class DataRegionConfiguration\n         /// </summary>\n         public static readonly TimeSpan DefaultMetricsRateTimeInterval = TimeSpan.FromSeconds(60);\n \n+        /// <summary>\n+        /// Default value for <see cref=\"LazyMemoryAllocation\"/>.\n+        /// </summary>\n+        public const bool DefaultLazyMemoryAllocation = true;\n+\n         /// <summary>\n         /// Initializes a new instance of the <see cref=\"DataRegionConfiguration\"/> class.\n         /// </summary>\n@@ -86,13 +92,15 @@ public DataRegionConfiguration()\n             MaxSize = DefaultMaxSize;\n             MetricsSubIntervalCount = DefaultMetricsSubIntervalCount;\n             MetricsRateTimeInterval = DefaultMetricsRateTimeInterval;\n+            LazyMemoryAllocation = DefaultLazyMemoryAllocation;\n         }\n \n         /// <summary>\n         /// Initializes a new instance of the <see cref=\"DataRegionConfiguration\"/> class.\n         /// </summary>\n         /// <param name=\"reader\">The reader.</param>\n-        internal DataRegionConfiguration(IBinaryRawReader reader)\n+        /// <param name=\"srvVer\">Server version.</param>\n+        internal DataRegionConfiguration(IBinaryRawReader reader, ClientProtocolVersion srvVer)\n         {\n             Name = reader.ReadString();\n             PersistenceEnabled = reader.ReadBoolean();\n@@ -106,12 +114,19 @@ internal DataRegionConfiguration(IBinaryRawReader reader)\n             MetricsSubIntervalCount = reader.ReadInt();\n             MetricsRateTimeInterval = reader.ReadLongAsTimespan();\n             CheckpointPageBufferSize = reader.ReadLong();\n+\n+            if (srvVer.CompareTo(ClientSocket.Ver130) >= 0)\n+            {\n+                LazyMemoryAllocation = reader.ReadBoolean();\n+            }\n         }\n \n         /// <summary>\n         /// Writes this instance to a writer.\n         /// </summary>\n-        internal void Write(IBinaryRawWriter writer)\n+        /// <param name=\"writer\">The writer.</param>\n+        /// <param name=\"srvVer\">Server version.</param>\n+        internal void Write(IBinaryRawWriter writer, ClientProtocolVersion srvVer)\n         {\n             writer.WriteString(Name);\n             writer.WriteBoolean(PersistenceEnabled);\n@@ -125,6 +140,11 @@ internal void Write(IBinaryRawWriter writer)\n             writer.WriteInt(MetricsSubIntervalCount);\n             writer.WriteTimeSpanAsLong(MetricsRateTimeInterval);\n             writer.WriteLong(CheckpointPageBufferSize);\n+\n+            if (srvVer.CompareTo(ClientSocket.Ver130) >= 0)\n+            {\n+                writer.WriteBoolean(LazyMemoryAllocation);\n+            }\n         }\n \n         /// <summary>\n@@ -218,5 +238,11 @@ internal void Write(IBinaryRawWriter writer)\n         /// Default is <c>0</c>: Ignite will choose buffer size automatically.\n         /// </summary>\n         public long CheckpointPageBufferSize { get; set; }\n+        \n+        /// <summary>\n+        /// Gets or sets the lazy memory allocation flag.\n+        /// </summary>\n+        [DefaultValue(DefaultLazyMemoryAllocation)]\n+        public bool LazyMemoryAllocation { get; set; }\n     }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataRegionConfiguration.cs",
                "sha": "ef0759e52ed2193af0154571d40af2a643fc2ae9",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataStorageConfiguration.cs",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataStorageConfiguration.cs?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 6,
                "filename": "modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataStorageConfiguration.cs",
                "patch": "@@ -26,6 +26,7 @@ namespace Apache.Ignite.Core.Configuration\n     using Apache.Ignite.Core.Binary;\n     using Apache.Ignite.Core.Common;\n     using Apache.Ignite.Core.Impl.Binary;\n+    using Apache.Ignite.Core.Impl.Client;\n \n     /// <summary>\n     /// Data storage configuration for Ignite page memory.\n@@ -202,7 +203,8 @@ public DataStorageConfiguration()\n         /// Initializes a new instance of the <see cref=\"DataStorageConfiguration\"/> class.\n         /// </summary>\n         /// <param name=\"reader\">The reader.</param>\n-        internal DataStorageConfiguration(IBinaryRawReader reader)\n+        /// <param name=\"srvVer\">Server version.</param>\n+        internal DataStorageConfiguration(IBinaryRawReader reader, ClientProtocolVersion srvVer)\n         {\n             Debug.Assert(reader != null);\n \n@@ -241,21 +243,22 @@ internal DataStorageConfiguration(IBinaryRawReader reader)\n             if (count > 0)\n             {\n                 DataRegionConfigurations = Enumerable.Range(0, count)\n-                    .Select(x => new DataRegionConfiguration(reader))\n+                    .Select(x => new DataRegionConfiguration(reader, srvVer))\n                     .ToArray();\n             }\n \n             if (reader.ReadBoolean())\n             {\n-                DefaultDataRegionConfiguration = new DataRegionConfiguration(reader);\n+                DefaultDataRegionConfiguration = new DataRegionConfiguration(reader, srvVer);\n             }\n         }\n \n         /// <summary>\n         /// Writes this instance to the specified writer.\n         /// </summary>\n         /// <param name=\"writer\">The writer.</param>\n-        internal void Write(IBinaryRawWriter writer)\n+        /// <param name=\"srvVer\">Server version.</param>\n+        internal void Write(IBinaryRawWriter writer, ClientProtocolVersion srvVer)\n         {\n             Debug.Assert(writer != null);\n \n@@ -301,7 +304,7 @@ internal void Write(IBinaryRawWriter writer)\n                             \"DataStorageConfiguration.DataRegionConfigurations must not contain null items.\");\n                     }\n \n-                    region.Write(writer);\n+                    region.Write(writer, srvVer);\n                 }\n             }\n             else\n@@ -312,7 +315,7 @@ internal void Write(IBinaryRawWriter writer)\n             if (DefaultDataRegionConfiguration != null)\n             {\n                 writer.WriteBoolean(true);\n-                DefaultDataRegionConfiguration.Write(writer);\n+                DefaultDataRegionConfiguration.Write(writer, srvVer);\n             }\n             else\n             {",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/Configuration/DataStorageConfiguration.cs",
                "sha": "17ddf6b4b66b44b2e425de146bdb68a6ee358ee3",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfiguration.cs",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfiguration.cs?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 2,
                "filename": "modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfiguration.cs",
                "patch": "@@ -574,7 +574,7 @@ internal void Write(BinaryWriter writer, ClientProtocolVersion srvVer)\n             if (DataStorageConfiguration != null)\n             {\n                 writer.WriteBoolean(true);\n-                DataStorageConfiguration.Write(writer);\n+                DataStorageConfiguration.Write(writer, srvVer);\n             }\n             else\n             {\n@@ -863,7 +863,7 @@ private void ReadCore(BinaryReader r, ClientProtocolVersion srvVer)\n             // Data storage.\n             if (r.ReadBoolean())\n             {\n-                DataStorageConfiguration = new DataStorageConfiguration(r);\n+                DataStorageConfiguration = new DataStorageConfiguration(r, srvVer);\n             }\n \n             // SSL context factory.",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfiguration.cs",
                "sha": "f98acf9e182e69de806593e5fae9d3b77f91f49e",
                "status": "modified"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfigurationSection.xsd",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfigurationSection.xsd?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 0,
                "filename": "modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfigurationSection.xsd",
                "patch": "@@ -1714,6 +1714,13 @@\n                                             <xs:documentation>Size of the checkpointing page buffer.</xs:documentation>\n                                         </xs:annotation>\n                                     </xs:attribute>\n+                                    <xs:attribute name=\"lazyMemoryAllocation\" type=\"xs:boolean\">\n+                                        <xs:annotation>\n+                                            <xs:documentation>\n+                                                Enable lazy memory allocation.\n+                                            </xs:documentation>\n+                                        </xs:annotation>\n+                                    </xs:attribute>\n                                 </xs:complexType>\n                             </xs:element>\n                             <xs:element name=\"dataRegionConfigurations\">\n@@ -1787,6 +1794,13 @@\n                                                         <xs:documentation>Size of the checkpointing page buffer.</xs:documentation>\n                                                     </xs:annotation>\n                                                 </xs:attribute>\n+                                                <xs:attribute name=\"lazyMemoryAllocation\" type=\"xs:boolean\">\n+                                                    <xs:annotation>\n+                                                        <xs:documentation>\n+                                                            Enable lazy memory allocation.\n+                                                        </xs:documentation>\n+                                                    </xs:annotation>\n+                                                </xs:attribute>\n                                             </xs:complexType>\n                                         </xs:element>\n                                     </xs:sequence>",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/IgniteConfigurationSection.xsd",
                "sha": "0a6dca1f8453755698b7993e5f09ce3793f20e8e",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/Impl/Client/ClientSocket.cs",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/platforms/dotnet/Apache.Ignite.Core/Impl/Client/ClientSocket.cs?ref=4c6f4aefc1c36bb5174a4a9b009824af25734dd3",
                "deletions": 1,
                "filename": "modules/platforms/dotnet/Apache.Ignite.Core/Impl/Client/ClientSocket.cs",
                "patch": "@@ -46,8 +46,11 @@ internal sealed class ClientSocket : IClientSocket\n         /** Version 1.2.0. */\n         public static readonly ClientProtocolVersion Ver120 = new ClientProtocolVersion(1, 2, 0);\n \n+        /** Version 1.3.0. */\n+        public static readonly ClientProtocolVersion Ver130 = new ClientProtocolVersion(1, 3, 0);\n+\n         /** Current version. */\n-        public static readonly ClientProtocolVersion CurrentProtocolVersion = Ver120;\n+        public static readonly ClientProtocolVersion CurrentProtocolVersion = Ver130;\n \n         /** Handshake opcode. */\n         private const byte OpHandshake = 1;",
                "raw_url": "https://github.com/apache/ignite/raw/4c6f4aefc1c36bb5174a4a9b009824af25734dd3/modules/platforms/dotnet/Apache.Ignite.Core/Impl/Client/ClientSocket.cs",
                "sha": "e2567ef3791514fab2467d15695148993e81fcfd",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9113: Lazy memory allocation implementation (#6388)\n\n* IGNITE-9113: Lazy memory allocation implemented.\r\n\r\n* IGNITE-9113: Lazy memory allocation implemented.\r\n\r\n* IGNITE-9113:\r\n\r\n* useless file removed\r\n* test added to suite.\r\n\r\n* IGNITE-9113:\r\n\r\n* Fix for persistence mode.\r\n* One test Ignored as it not working.\r\n\r\n* IGNITE-9113: Tests added.\r\n\r\n* IGNITE-9113: Tests added.\r\n\r\n* IGNITE-9113: double start fix.\r\n\r\n* IGNITE-9113: double start assert.\r\n\r\n* IGNITE-9113: Fix of several issues.\r\n\r\n* IGNITE-9113: Minor fixes.\r\n\r\n* IGNITE-9113: Tests fixes.\r\n\r\n* IGNITE-9113: NPE fixes for client nodes..\r\n\r\n* IGNITE-9113: NPE fixes for some modes.\r\n\r\n* IGNITE-9113: .Net fixes.\r\n\r\n* IGNITE-9113: .Net fixes.\r\n\r\n* IGNITE-9113: Useless log removed.\r\n\r\n* IGNITE-9113: Temporary commit.\r\n\r\n* IGNITE-9113: Flag moved to DataRegionConfiguration.\r\n\r\n* IGNITE-9113: NPE fix.\r\n\r\n* IGNITE-9113: Revert unnecessary static import.\r\n\r\n* IGNITE-9113: System data regions are not lazy.\r\n\r\n* IGNITE-9113: JavaDoc fix.\r\n\r\n* IGNITE-9113: Unused import removed.\r\n\r\n* IGNITE-9113: double stop fix.\r\n\r\n* IGNITE-9113: Unused import fix.\r\n\r\n* IGNITE-9113: Code review fixes.\r\n\r\n* IGNITE-9113: Tests added.\r\n\r\n* IGNITE-9113: Tests fixed.\r\n\r\n* IGNITE-9560: Fix test.",
        "parent": "https://github.com/apache/ignite/commit/48e6719f1f7156126dcf0dce54fad58c73da2392",
        "patched_files": [
            "IgnitePdsTestSuite.java",
            "PageMemoryNoStoreImpl.java",
            "DataRegionConfiguration.cs",
            "MvccProcessorImpl.java",
            "IgniteKernal.java",
            "PlatformConfigurationUtils.java",
            "ClientSocket.cs",
            "PageMemoryImpl.java",
            "IgniteConfiguration.cs",
            "DataStorageConfiguration.cs",
            "GridCacheSharedContext.java",
            "ClientConnectionContext.java",
            "IgniteCacheDatabaseSharedManager.java",
            "IgniteUtils.java",
            "GridCacheDatabaseSharedManager.java",
            "GridCacheProcessor.java",
            "DataRegionConfiguration.java",
            "IgniteConfigurationSection.xsd"
        ],
        "repo": "ignite",
        "unit_tests": [
            "PageMemoryLazyAllocationTest.java",
            "PageMemoryImplTest.java",
            "PageMemoryLazyAllocationWithPDSTest.java"
        ]
    },
    "ignite_51ab35f": {
        "bug_id": "ignite_51ab35f",
        "commit": "https://github.com/apache/ignite/commit/51ab35fa094cc409bb0c20d24affecfc100a9006",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/51ab35fa094cc409bb0c20d24affecfc100a9006/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java?ref=51ab35fa094cc409bb0c20d24affecfc100a9006",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "patch": "@@ -2080,8 +2080,6 @@ protected void onExchange(DiscoveryDataPacket dataPacket, ClassLoader clsLdr) {\n \n     /** {@inheritDoc} */\n     @Override public void spiStart(@Nullable String igniteInstanceName) throws IgniteSpiException {\n-        sslEnable = ignite().configuration().getSslContextFactory() != null;\n-\n         initializeImpl();\n \n         registerMBean(igniteInstanceName, new TcpDiscoverySpiMBeanImpl(this), TcpDiscoverySpiMBean.class);\n@@ -2096,6 +2094,8 @@ private void initializeImpl() {\n         if (impl != null)\n             return;\n \n+        sslEnable = ignite().configuration().getSslContextFactory() != null;\n+\n         initFailureDetectionTimeout();\n \n         if (!forceSrvMode && (Boolean.TRUE.equals(ignite.configuration().isClientMode()))) {",
                "raw_url": "https://github.com/apache/ignite/raw/51ab35fa094cc409bb0c20d24affecfc100a9006/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "sha": "b7df2702b4c587ae9bef42bfe01008145fee938f",
                "status": "modified"
            },
            {
                "additions": 73,
                "blob_url": "https://github.com/apache/ignite/blob/51ab35fa094cc409bb0c20d24affecfc100a9006/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/SingleNodePersistenceSslTest.java",
                "changes": 73,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/SingleNodePersistenceSslTest.java?ref=51ab35fa094cc409bb0c20d24affecfc100a9006",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/SingleNodePersistenceSslTest.java",
                "patch": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence;\n+\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.StopNodeFailureHandler;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+/**\n+ * Checks, that cluster correct workds with enabled persistence and SSL.\n+ */\n+public class SingleNodePersistenceSslTest extends GridCommonAbstractTest {\n+    /** {@inheritDoc} */\n+    @Override public IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        return super.getConfiguration(igniteInstanceName)\n+            .setSslContextFactory(GridTestUtils.sslFactory())\n+            .setFailureHandler(new StopNodeFailureHandler())\n+            .setDataStorageConfiguration(\n+                new DataStorageConfiguration().setDefaultDataRegionConfiguration(\n+                    new DataRegionConfiguration().setPersistenceEnabled(true)\n+                )\n+            );\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /**\n+     * Checks, that cluster could be started and activated.\n+     *\n+     * @throws Exception If test failed.\n+     */\n+    @Test\n+    public void testActivate() throws Exception {\n+        startGrids(2).cluster().active(true);\n+\n+        assertTrue(grid(0).cluster().active());\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/51ab35fa094cc409bb0c20d24affecfc100a9006/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/SingleNodePersistenceSslTest.java",
                "sha": "118d57de9a45c7048c0e6ce6883630c9f0dceeca",
                "status": "added"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/51ab35fa094cc409bb0c20d24affecfc100a9006/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicWithPersistenceTestSuite.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicWithPersistenceTestSuite.java?ref=51ab35fa094cc409bb0c20d24affecfc100a9006",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicWithPersistenceTestSuite.java",
                "patch": "@@ -31,6 +31,7 @@\n import org.apache.ignite.internal.encryption.EncryptedCachePreconfiguredRestartTest;\n import org.apache.ignite.internal.encryption.EncryptedCacheRestartTest;\n import org.apache.ignite.internal.processors.cache.persistence.CheckpointReadLockFailureTest;\n+import org.apache.ignite.internal.processors.cache.persistence.SingleNodePersistenceSslTest;\n import org.apache.ignite.marshaller.GridMarshallerMappingConsistencyTest;\n import org.apache.ignite.util.GridCommandHandlerSslTest;\n import org.apache.ignite.util.GridCommandHandlerTest;\n@@ -64,6 +65,8 @@\n     EncryptedCacheNodeJoinTest.class,\n     EncryptedCacheRestartTest.class,\n     EncryptedCachePreconfiguredRestartTest.class,\n+\n+    SingleNodePersistenceSslTest.class\n })\n public class IgniteBasicWithPersistenceTestSuite {\n }",
                "raw_url": "https://github.com/apache/ignite/raw/51ab35fa094cc409bb0c20d24affecfc100a9006/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicWithPersistenceTestSuite.java",
                "sha": "2e9a1325ea07a19522d01c89cb91fd05ccddc7db",
                "status": "modified"
            }
        ],
        "message": "IGNITE-11631 Fix NPE on server node start and persistence - Fixes #6344.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/18d20a632e5fbabc28f0bb355e5b458171842a0a",
        "patched_files": [
            "IgniteBasicWithPersistenceTestSuite.java",
            "TcpDiscoverySpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "SingleNodePersistenceSslTest.java",
            "TestTcpDiscoverySpi.java"
        ]
    },
    "ignite_525680c": {
        "bug_id": "ignite_525680c",
        "commit": "https://github.com/apache/ignite/commit/525680c748e9479b02cecbdca1e2ac5d582105ad",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/ignite/blob/525680c748e9479b02cecbdca1e2ac5d582105ad/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=525680c748e9479b02cecbdca1e2ac5d582105ad",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -55,6 +55,7 @@\n import org.apache.ignite.cache.store.CacheStoreSessionListener;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.DataPageEvictionMode;\n import org.apache.ignite.configuration.DataStorageConfiguration;\n import org.apache.ignite.configuration.DeploymentMode;\n import org.apache.ignite.configuration.FileSystemConfiguration;\n@@ -539,6 +540,19 @@ private void validate(IgniteConfiguration c,\n \n             assertParameter(cc.getInterceptor() == null,\n                 \"interceptor cannot be used with TRANSACTIONAL_SNAPSHOT atomicity mode\");\n+\n+            // Disable in-memory evictions for mvcc cache. TODO IGNITE-10738\n+            String memPlcName = cc.getDataRegionName();\n+            DataRegion dataRegion = sharedCtx.database().dataRegion(memPlcName);\n+\n+            if (dataRegion != null && !dataRegion.config().isPersistenceEnabled() &&\n+                dataRegion.config().getPageEvictionMode() != DataPageEvictionMode.DISABLED) {\n+                throw new IgniteCheckedException(\"Data pages evictions cannot be used with TRANSACTIONAL_SNAPSHOT \" +\n+                    \"cache atomicity mode for in-memory regions. Please, either disable evictions or enable \" +\n+                    \"persistence for data regions with TRANSACTIONAL_SNAPSHOT caches. [cacheName=\" + cc.getName() +\n+                    \", dataRegionName=\" + memPlcName + \", pageEvictionMode=\" +\n+                    dataRegion.config().getPageEvictionMode() + ']');\n+            }\n         }\n \n         if (cc.isWriteBehindEnabled()) {",
                "raw_url": "https://github.com/apache/ignite/raw/525680c748e9479b02cecbdca1e2ac5d582105ad/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "b919024d5ffff1f40eb26f9f07061c8b209c7e99",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/525680c748e9479b02cecbdca1e2ac5d582105ad/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/eviction/paged/PageEvictionMultinodeAbstractTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/eviction/paged/PageEvictionMultinodeAbstractTest.java?ref=525680c748e9479b02cecbdca1e2ac5d582105ad",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/eviction/paged/PageEvictionMultinodeAbstractTest.java",
                "patch": "@@ -25,6 +25,7 @@\n import org.apache.ignite.cache.CacheWriteSynchronizationMode;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.junit.Ignore;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.JUnit4;\n@@ -96,10 +97,9 @@ public void testPageEviction() throws Exception {\n     /**\n      * @throws Exception If failed.\n      */\n+    @Ignore(\"https://issues.apache.org/jira/browse/IGNITE-10738\")\n     @Test\n     public void testPageEvictionMvcc() throws Exception {\n-        fail(\"https://issues.apache.org/jira/browse/IGNITE-10448\");\n-\n         for (int i = 0; i < CACHE_MODES.length; i++) {\n             CacheConfiguration<Object, Object> cfg = cacheConfig(\n                 \"evict\" + i, null, CACHE_MODES[i], CacheAtomicityMode.TRANSACTIONAL_SNAPSHOT,",
                "raw_url": "https://github.com/apache/ignite/raw/525680c748e9479b02cecbdca1e2ac5d582105ad/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/eviction/paged/PageEvictionMultinodeAbstractTest.java",
                "sha": "52bb29d127a10e19711fc743c8fdcb4ba03c5324",
                "status": "modified"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/ignite/blob/525680c748e9479b02cecbdca1e2ac5d582105ad/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/mvcc/CacheMvccConfigurationValidationTest.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/mvcc/CacheMvccConfigurationValidationTest.java?ref=525680c748e9479b02cecbdca1e2ac5d582105ad",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/mvcc/CacheMvccConfigurationValidationTest.java",
                "patch": "@@ -36,6 +36,7 @@\n import org.apache.ignite.configuration.DataStorageConfiguration;\n import org.apache.ignite.configuration.IgniteConfiguration;\n import org.apache.ignite.configuration.NearCacheConfiguration;\n+import org.apache.ignite.internal.util.typedef.X;\n import org.apache.ignite.lang.IgniteBiTuple;\n import org.apache.ignite.testframework.GridTestUtils;\n import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n@@ -48,6 +49,8 @@\n import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL_SNAPSHOT;\n import static org.apache.ignite.cache.CacheMode.LOCAL;\n+import static org.apache.ignite.configuration.DataPageEvictionMode.RANDOM_2_LRU;\n+import static org.apache.ignite.configuration.DataPageEvictionMode.RANDOM_LRU;\n \n /**\n  *\n@@ -200,6 +203,7 @@ public void testNodeRestartWithCacheModeChangedMvccToTx() throws Exception {\n         DataStorageConfiguration storageCfg = new DataStorageConfiguration();\n         DataRegionConfiguration regionCfg = new DataRegionConfiguration();\n         regionCfg.setPersistenceEnabled(true);\n+        regionCfg.setPageEvictionMode(RANDOM_LRU);\n         storageCfg.setDefaultDataRegionConfiguration(regionCfg);\n         IgniteConfiguration cfg = getConfiguration(\"testGrid\");\n         cfg.setDataStorageConfiguration(storageCfg);\n@@ -236,6 +240,41 @@ public void testNodeRestartWithCacheModeChangedMvccToTx() throws Exception {\n         }, IgniteCheckedException.class, \"Cannot start cache. Statically configured atomicity mode\");\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testMvccInMemoryEvictionDisabled() throws Exception {\n+        final String memRegName = \"in-memory-evictions\";\n+\n+        // Enable in-memory eviction.\n+        DataRegionConfiguration regionCfg = new DataRegionConfiguration();\n+        regionCfg.setPersistenceEnabled(false);\n+        regionCfg.setPageEvictionMode(RANDOM_2_LRU);\n+        regionCfg.setName(memRegName);\n+\n+        DataStorageConfiguration storageCfg = new DataStorageConfiguration();\n+        storageCfg.setDefaultDataRegionConfiguration(regionCfg);\n+\n+        IgniteConfiguration cfg = getConfiguration(\"testGrid\");\n+        cfg.setDataStorageConfiguration(storageCfg);\n+\n+        Ignite node = startGrid(cfg);\n+\n+        CacheConfiguration ccfg1 = new CacheConfiguration(\"test1\")\n+            .setAtomicityMode(TRANSACTIONAL_SNAPSHOT)\n+            .setDataRegionName(memRegName);\n+\n+        try {\n+            node.createCache(ccfg1);\n+\n+            fail(\"In memory evictions should be disabled for MVCC caches.\");\n+        }\n+        catch (Exception e) {\n+            assertTrue(X.getFullStackTrace(e).contains(\"Data pages evictions cannot be used with TRANSACTIONAL_SNAPSHOT\"));\n+        }\n+    }\n+\n     /**\n      * Test TRANSACTIONAL_SNAPSHOT and near cache.\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/525680c748e9479b02cecbdca1e2ac5d582105ad/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/mvcc/CacheMvccConfigurationValidationTest.java",
                "sha": "92ec8122ccaec8ab019a5728305f2ba9f15ec0b8",
                "status": "modified"
            }
        ],
        "message": "IGNITE-10448: MVCC: Fixed NPE on data page eviction. This closes #5704.",
        "parent": "https://github.com/apache/ignite/commit/76ad0a4d10ac761f5cdec01e6ec4d7299e434a07",
        "patched_files": [
            "GridCacheProcessor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "CacheMvccConfigurationValidationTest.java",
            "PageEvictionMultinodeAbstractTest.java"
        ]
    },
    "ignite_550a4ea": {
        "bug_id": "ignite_550a4ea",
        "commit": "https://github.com/apache/ignite/commit/550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/examples/src/main/java/org/apache/ignite/examples/datagrid/CacheAffinityExample.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/examples/src/main/java/org/apache/ignite/examples/datagrid/CacheAffinityExample.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "examples/src/main/java/org/apache/ignite/examples/datagrid/CacheAffinityExample.java",
                "patch": "@@ -22,10 +22,10 @@\n import java.util.Map;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n-import org.apache.ignite.IgniteCluster;\n import org.apache.ignite.IgniteCompute;\n import org.apache.ignite.IgniteException;\n import org.apache.ignite.Ignition;\n+import org.apache.ignite.cache.affinity.Affinity;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.examples.ExampleNodeStartup;\n import org.apache.ignite.lang.IgniteRunnable;\n@@ -103,7 +103,7 @@ private static void visitUsingAffinityRun() {\n     }\n \n     /**\n-     * Collocates jobs with keys they need to work on using {@link IgniteCluster#mapKeysToNodes(String, Collection)}\n+     * Collocates jobs with keys they need to work on using {@link Affinity#mapKeysToNodes(Collection)}\n      * method. The difference from {@code affinityRun(...)} method is that here we process multiple keys\n      * in a single job.\n      */\n@@ -116,7 +116,7 @@ private static void visitUsingMapKeysToNodes() {\n             keys.add(i);\n \n         // Map all keys to nodes.\n-        Map<ClusterNode, Collection<Integer>> mappings = ignite.cluster().mapKeysToNodes(CACHE_NAME, keys);\n+        Map<ClusterNode, Collection<Integer>> mappings = ignite.<Integer>affinity(CACHE_NAME).mapKeysToNodes(keys);\n \n         for (Map.Entry<ClusterNode, Collection<Integer>> mapping : mappings.entrySet()) {\n             ClusterNode node = mapping.getKey();\n@@ -139,4 +139,4 @@ private static void visitUsingMapKeysToNodes() {\n             }\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/examples/src/main/java/org/apache/ignite/examples/datagrid/CacheAffinityExample.java",
                "sha": "c059ced378342427f47ad5cd3a31f6083a08fecf",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/examples/src/main/java8/org/apache/ignite/examples/java8/datagrid/CacheAffinityExample.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/examples/src/main/java8/org/apache/ignite/examples/java8/datagrid/CacheAffinityExample.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 3,
                "filename": "examples/src/main/java8/org/apache/ignite/examples/java8/datagrid/CacheAffinityExample.java",
                "patch": "@@ -22,11 +22,11 @@\n import java.util.Map;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n-import org.apache.ignite.IgniteCluster;\n import org.apache.ignite.IgniteCompute;\n import org.apache.ignite.IgniteException;\n import org.apache.ignite.Ignition;\n import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.cache.affinity.Affinity;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.examples.ExampleNodeStartup;\n@@ -105,7 +105,7 @@ private static void visitUsingAffinityRun() {\n     }\n \n     /**\n-     * Collocates jobs with keys they need to work on using {@link IgniteCluster#mapKeysToNodes(String, Collection)}\n+     * Collocates jobs with keys they need to work on using {@link Affinity#mapKeysToNodes(Collection)}\n      * method. The difference from {@code affinityRun(...)} method is that here we process multiple keys\n      * in a single job.\n      */\n@@ -118,7 +118,7 @@ private static void visitUsingMapKeysToNodes() {\n             keys.add(i);\n \n         // Map all keys to nodes.\n-        Map<ClusterNode, Collection<Integer>> mappings = ignite.cluster().mapKeysToNodes(CACHE_NAME, keys);\n+        Map<ClusterNode, Collection<Integer>> mappings = ignite.<Integer>affinity(CACHE_NAME).mapKeysToNodes(keys);\n \n         for (Map.Entry<ClusterNode, Collection<Integer>> mapping : mappings.entrySet()) {\n             ClusterNode node = mapping.getKey();",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/examples/src/main/java8/org/apache/ignite/examples/java8/datagrid/CacheAffinityExample.java",
                "sha": "2867bf118ae2cd310a7bb5d8bf457e1dd5796c64",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/clients/src/test/java/org/apache/ignite/internal/client/ClientGetAffinityTask.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/internal/client/ClientGetAffinityTask.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/clients/src/test/java/org/apache/ignite/internal/client/ClientGetAffinityTask.java",
                "patch": "@@ -50,7 +50,7 @@\n         if (\"null\".equals(cacheName))\n             cacheName = null;\n \n-        ClusterNode node = ignite.cluster().mapKeyToNode(cacheName, affKey);\n+        ClusterNode node = ignite.affinity(cacheName).mapKeyToNode(affKey);\n \n         return node.id().toString();\n     }\n@@ -62,4 +62,4 @@\n \n         return WAIT;\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/clients/src/test/java/org/apache/ignite/internal/client/ClientGetAffinityTask.java",
                "sha": "509324a40086aa8331ec086b518f2816c6fa9995",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/IgniteCluster.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/IgniteCluster.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/IgniteCluster.java",
                "patch": "@@ -22,6 +22,7 @@\n import java.util.Map;\n import java.util.UUID;\n import java.util.concurrent.ConcurrentMap;\n+import org.apache.ignite.cache.affinity.Affinity;\n import org.apache.ignite.cache.affinity.AffinityFunction;\n import org.apache.ignite.cluster.ClusterGroup;\n import org.apache.ignite.cluster.ClusterNode;\n@@ -124,7 +125,9 @@\n      * @param keys Cache keys to map to nodes.\n      * @return Map of nodes to cache keys or empty map if there are no alive nodes for this cache.\n      * @throws IgniteException If failed to map cache keys.\n+     * @deprecated Use {@link Affinity#mapKeysToNodes(Collection)} instead.\n      */\n+    @Deprecated\n     public <K> Map<ClusterNode, Collection<K>> mapKeysToNodes(@Nullable String cacheName,\n         @Nullable Collection<? extends K> keys) throws IgniteException;\n \n@@ -148,7 +151,9 @@\n      * @return Primary node for the key or {@code null} if cache with given name\n      *      is not present in the grid.\n      * @throws IgniteException If failed to map key.\n+     * @deprecated Use {@link Affinity#mapKeyToNode(Object)} instead.\n      */\n+    @Deprecated\n     public <K> ClusterNode mapKeyToNode(@Nullable String cacheName, K key) throws IgniteException;\n \n     /**\n@@ -343,4 +348,4 @@\n \n     /** {@inheritDoc} */\n     @Override public IgniteCluster withAsync();\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/IgniteCluster.java",
                "sha": "23b03df442dadf050c5002b56789c860e43620d3",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/cache/affinity/Affinity.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/cache/affinity/Affinity.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/main/java/org/apache/ignite/cache/affinity/Affinity.java",
                "patch": "@@ -19,13 +19,14 @@\n \n import java.util.Collection;\n import java.util.Map;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.cluster.ClusterNode;\n import org.jetbrains.annotations.Nullable;\n \n /**\n  * Provides affinity information to detect which node is primary and which nodes are\n  * backups for a partitioned cache. You can get an instance of this interface by calling\n- * {@code Cache.affinity()} method.\n+ * {@code Ignite.affinity(cacheName)} method.\n  * <p>\n  * Mapping of a key to a node is a three-step operation. First step will get an affinity key for given key\n  * using {@link AffinityKeyMapper}. If mapper is not specified, the original key will be used. Second step\n@@ -41,6 +42,7 @@\n      * Gets number of partitions in cache according to configured affinity function.\n      *\n      * @return Number of cache partitions.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -52,6 +54,7 @@\n      *\n      * @param key Key to get partition id for.\n      * @return Partition id.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -64,6 +67,7 @@\n      * @param n Node to check.\n      * @param key Key to check.\n      * @return {@code True} if local node is the primary node for given key.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public boolean isPrimary(ClusterNode n, K key);\n \n@@ -73,6 +77,7 @@\n      * @param n Node to check.\n      * @param key Key to check.\n      * @return {@code True} if local node is one of the backup nodes for given key.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public boolean isBackup(ClusterNode n, K key);\n \n@@ -86,6 +91,7 @@\n      * @param n Node to check.\n      * @param key Key to check.\n      * @return {@code True} if local node is primary or backup for given key.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public boolean isPrimaryOrBackup(ClusterNode n, K key);\n \n@@ -94,6 +100,7 @@\n      *\n      * @param n Cluster node.\n      * @return Partition ids for which given cluster node has primary ownership.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -105,6 +112,7 @@\n      *\n      * @param n Cluster node.\n      * @return Partition ids for which given cluster node has backup ownership.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -117,6 +125,7 @@\n      *\n      * @param n Cluster node.\n      * @return Partition ids for which given cluster node has any ownership, primary or backup.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -132,6 +141,7 @@\n      * @param key Key to map.\n      * @return Key to be used for node-to-affinity mapping (may be the same\n      *      key as passed in).\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public Object affinityKey(K key);\n \n@@ -151,7 +161,8 @@\n      * </ul>\n      *\n      * @param keys Keys to map to nodes.\n-     * @return Map of nodes to keys or empty map if there are no alive nodes for this cache.\n+     * @return Map of nodes to keys.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public Map<ClusterNode, Collection<K>> mapKeysToNodes(Collection<? extends K> keys);\n \n@@ -171,7 +182,8 @@\n      * </ul>\n      *\n      * @param key Keys to map to a node.\n-     * @return Primary node for the key or {@code null} if there are no alive nodes for this cache.\n+     * @return Primary node for the key.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     @Nullable public ClusterNode mapKeyToNode(K key);\n \n@@ -182,6 +194,7 @@\n      * @param key Key to get affinity nodes for.\n      * @return Collection of primary and backup nodes for the key with primary node\n      *      always first.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public Collection<ClusterNode> mapKeyToPrimaryAndBackups(K key);\n \n@@ -190,6 +203,7 @@\n      *\n      * @param part Partition id.\n      * @return Primary node for the given partition.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -201,6 +215,7 @@\n      *\n      * @param parts Partition ids.\n      * @return Mapping of given partitions to their primary nodes.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      * @see AffinityFunction\n      * @see org.apache.ignite.configuration.CacheConfiguration#getAffinity()\n      * @see org.apache.ignite.configuration.CacheConfiguration#setAffinity(AffinityFunction)\n@@ -214,6 +229,7 @@\n      * @param part Partition to get affinity nodes for.\n      * @return Collection of primary and backup nodes for partition with primary node\n      *      always first.\n+     * @throws IgniteException If there are no alive nodes for this cache.\n      */\n     public Collection<ClusterNode> mapPartitionToPrimaryAndBackups(int part);\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/cache/affinity/Affinity.java",
                "sha": "a5756e9f3cc144da3f6398b46f5da24012025b5c",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityProcessor.java",
                "changes": 60,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityProcessor.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 33,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityProcessor.java",
                "patch": "@@ -178,7 +178,8 @@ public GridAffinityProcessor(GridKernalContext ctx) {\n      * @return Picked node.\n      * @throws IgniteCheckedException If failed.\n      */\n-    @Nullable public <K> ClusterNode mapKeyToNode(@Nullable String cacheName, K key, AffinityTopologyVersion topVer) throws IgniteCheckedException {\n+    @Nullable public <K> ClusterNode mapKeyToNode(@Nullable String cacheName, K key,\n+        AffinityTopologyVersion topVer) throws IgniteCheckedException {\n         Map<ClusterNode, Collection<K>> map = keysToNodes(cacheName, F.asList(key), topVer);\n \n         return map != null ? F.first(map.keySet()) : null;\n@@ -208,20 +209,6 @@ public GridAffinityProcessor(GridKernalContext ctx) {\n         return primaryAndBackups(affInfo, key);\n     }\n \n-    /**\n-     * Map single key to primary and backup nodes.\n-     *\n-     * @param cacheName Cache name.\n-     * @param key Key to map.\n-     * @return Affinity nodes, primary first.\n-     * @throws IgniteCheckedException If failed.\n-     */\n-    public <K> List<ClusterNode> mapKeyToPrimaryAndBackups(@Nullable String cacheName, K key)\n-        throws IgniteCheckedException\n-    {\n-        return mapKeyToPrimaryAndBackups(cacheName, key, ctx.discovery().topologyVersionEx());\n-    }\n-\n     /**\n      * Gets affinity key for cache key.\n      *\n@@ -318,7 +305,7 @@ private String maskNull(@Nullable String cacheName) {\n             if (cache == null)\n                 return null;\n \n-            GridCacheContext<Object,Object> cctx = cache.context();\n+            GridCacheContext<Object, Object> cctx = cache.context();\n \n             cctx.awaitStarted();\n \n@@ -424,8 +411,7 @@ private String maskNull(@Nullable String cacheName) {\n     }\n \n     /**\n-     * Requests {@link AffinityFunction} and\n-     * {@link AffinityKeyMapper} from remote node.\n+     * Requests {@link AffinityFunction} and {@link AffinityKeyMapper} from remote node.\n      *\n      * @param cacheName Name of cache on which affinity is requested.\n      * @param topVer Topology version.\n@@ -518,7 +504,7 @@ private AffinityInfo affinityInfoFromNode(@Nullable String cacheName, AffinityTo\n      */\n     private <K> List<ClusterNode> primaryAndBackups(AffinityInfo aff, K key) {\n         if (key instanceof CacheObject && !(key instanceof BinaryObject))\n-            key = ((CacheObject) key).value(aff.cacheObjCtx, false);\n+            key = ((CacheObject)key).value(aff.cacheObjCtx, false);\n \n         int part = aff.affFunc.partition(aff.mapper.affinityKey(key));\n \n@@ -801,7 +787,12 @@ public CacheAffinityProxy(String cacheName) {\n             ctx.gateway().readLock();\n \n             try {\n-                return GridAffinityProcessor.this.mapKeysToNodes(cacheName, keys);\n+                if (F.isEmpty(keys))\n+                    return Collections.emptyMap();\n+\n+                AffinityInfo affInfo = cache();\n+\n+                return affinityMap(affInfo, keys);\n             }\n             catch (IgniteCheckedException e) {\n                 throw new IgniteException(e);\n@@ -813,10 +804,16 @@ public CacheAffinityProxy(String cacheName) {\n \n         /** {@inheritDoc} */\n         @Nullable @Override public ClusterNode mapKeyToNode(K key) {\n+            A.notNull(key, \"key\");\n+\n             ctx.gateway().readLock();\n \n             try {\n-                return GridAffinityProcessor.this.mapKeyToNode(cacheName, key);\n+                AffinityInfo affInfo = cache();\n+\n+                Map<ClusterNode, Collection<K>> map = affinityMap(affInfo, Collections.singletonList(key));\n+\n+                return F.first(map.keySet());\n             }\n             catch (IgniteCheckedException e) {\n                 throw new IgniteException(e);\n@@ -880,9 +877,7 @@ public CacheAffinityProxy(String cacheName) {\n             ctx.gateway().readLock();\n \n             try {\n-                AffinityInfo cache = cache();\n-\n-                return cache != null ? cache.assignment().get(part) : Collections.<ClusterNode>emptyList();\n+                return cache().assignment().get(part);\n             }\n             catch (IgniteCheckedException e) {\n                 throw new IgniteException(e);\n@@ -896,15 +891,14 @@ public CacheAffinityProxy(String cacheName) {\n          * @return Affinity info for current topology version.\n          * @throws IgniteCheckedException If failed.\n          */\n-        @Nullable private AffinityInfo cache() throws IgniteCheckedException {\n-            return affinityCache(cacheName, new AffinityTopologyVersion(topologyVersion()));\n-        }\n+        private AffinityInfo cache() throws IgniteCheckedException {\n+            AffinityInfo aff = affinityCache(cacheName, ctx.discovery().topologyVersionEx());\n \n-        /**\n-         * @return Topology version.\n-         */\n-        private long topologyVersion() {\n-            return ctx.discovery().topologyVersion();\n+            if (aff == null)\n+                throw new IgniteException(\"Failed to find cache (cache was not started \" +\n+                    \"yet or cache was already stopped): \" + cacheName);\n+\n+            return aff;\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityProcessor.java",
                "sha": "8a0194c6096aa7a4bbfec6c0dee953ec342be4f6",
                "status": "modified"
            },
            {
                "additions": 41,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java",
                "changes": 47,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 6,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java",
                "patch": "@@ -23,6 +23,7 @@\n import java.util.Set;\n import java.util.UUID;\n import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.events.DiscoveryEvent;\n import org.apache.ignite.internal.IgniteClientDisconnectedCheckedException;\n@@ -42,6 +43,10 @@\n     /** */\n     private static final AffinityTopologyVersion TOP_FIRST = new AffinityTopologyVersion(1);\n \n+    /** */\n+    public static final String FAILED_TO_FIND_CACHE_ERR_MSG = \"Failed to find cache (cache was not started \" +\n+        \"yet or cache was already stopped): \";\n+\n     /** Affinity cached function. */\n     private GridAffinityAssignmentCache aff;\n \n@@ -189,7 +194,12 @@ public void clientEventTopologyChange(DiscoveryEvent evt, AffinityTopologyVersio\n      * @return Partition count.\n      */\n     public int partitions() {\n-        return aff.partitions();\n+        GridAffinityAssignmentCache aff0 = aff;\n+\n+        if (aff0 == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return aff0.partitions();\n     }\n \n     /**\n@@ -201,7 +211,12 @@ public int partitions() {\n      * @return Partition.\n      */\n     public int partition(Object key) {\n-        return aff.partition(key);\n+        GridAffinityAssignmentCache aff0 = aff;\n+\n+        if (aff0 == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return aff0.partition(key);\n     }\n \n     /**\n@@ -222,7 +237,12 @@ public int partition(Object key) {\n         if (cctx.isLocal())\n             topVer = new AffinityTopologyVersion(1);\n \n-        return aff.nodes(part, topVer);\n+        GridAffinityAssignmentCache aff0 = aff;\n+\n+        if (aff0 == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return aff0.nodes(part, topVer);\n     }\n \n     /**\n@@ -363,7 +383,12 @@ public boolean belongs(ClusterNode node, int part, AffinityTopologyVersion topVe\n         if (cctx.isLocal())\n             topVer = new AffinityTopologyVersion(1);\n \n-        return aff.primaryPartitions(nodeId, topVer);\n+        GridAffinityAssignmentCache aff0 = aff;\n+\n+        if (aff0 == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return aff0.primaryPartitions(nodeId, topVer);\n     }\n \n     /**\n@@ -375,14 +400,24 @@ public boolean belongs(ClusterNode node, int part, AffinityTopologyVersion topVe\n         if (cctx.isLocal())\n             topVer = new AffinityTopologyVersion(1);\n \n-        return aff.backupPartitions(nodeId, topVer);\n+        GridAffinityAssignmentCache aff0 = aff;\n+\n+        if (aff0 == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return aff0.backupPartitions(nodeId, topVer);\n     }\n \n     /**\n      * @return Affinity-ready topology version.\n      */\n     public AffinityTopologyVersion affinityTopologyVersion() {\n-        return aff.lastVersion();\n+        GridAffinityAssignmentCache aff0 = aff;\n+\n+        if (aff0 == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return aff0.lastVersion();\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityManager.java",
                "sha": "375219a172a9d82e19ab937f7d451177e6b3dee2",
                "status": "modified"
            },
            {
                "additions": 36,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/affinity/GridCacheAffinityImpl.java",
                "changes": 48,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/affinity/GridCacheAffinityImpl.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 12,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/affinity/GridCacheAffinityImpl.java",
                "patch": "@@ -23,12 +23,15 @@\n import java.util.HashSet;\n import java.util.Map;\n import java.util.Set;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.IgniteLogger;\n import org.apache.ignite.binary.BinaryObject;\n import org.apache.ignite.cache.affinity.Affinity;\n import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.internal.processors.affinity.AffinityTopologyVersion;\n import org.apache.ignite.internal.processors.cache.CacheObject;\n+import org.apache.ignite.internal.processors.cache.CacheObjectContext;\n import org.apache.ignite.internal.processors.cache.GridCacheContext;\n import org.apache.ignite.internal.util.typedef.F;\n import org.apache.ignite.internal.util.typedef.internal.A;\n@@ -39,6 +42,10 @@\n  * Affinity interface implementation.\n  */\n public class GridCacheAffinityImpl<K, V> implements Affinity<K> {\n+    /** */\n+    public static final String FAILED_TO_FIND_CACHE_ERR_MSG = \"Failed to find cache (cache was not started \" +\n+        \"yet or cache was already stopped): \";\n+\n     /** Cache context. */\n     private GridCacheContext<K, V> cctx;\n \n@@ -56,7 +63,12 @@ public GridCacheAffinityImpl(GridCacheContext<K, V> cctx) {\n \n     /** {@inheritDoc} */\n     @Override public int partitions() {\n-        return cctx.config().getAffinity().partitions();\n+        CacheConfiguration ccfg = cctx.config();\n+\n+        if (ccfg == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+        return ccfg.getAffinity().partitions();\n     }\n \n     /** {@inheritDoc} */\n@@ -151,10 +163,21 @@ public GridCacheAffinityImpl(GridCacheContext<K, V> cctx) {\n     @Override public Object affinityKey(K key) {\n         A.notNull(key, \"key\");\n \n-        if (key instanceof CacheObject && !(key instanceof BinaryObject))\n-            key = ((CacheObject)key).value(cctx.cacheObjectContext(), false);\n+        if (key instanceof CacheObject && !(key instanceof BinaryObject)) {\n+            CacheObjectContext ctx = cctx.cacheObjectContext();\n+\n+            if (ctx == null)\n+                throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n+\n+            key = ((CacheObject)key).value(ctx, false);\n+        }\n+\n+        CacheConfiguration ccfg = cctx.config();\n+\n+        if (ccfg == null)\n+            throw new IgniteException(FAILED_TO_FIND_CACHE_ERR_MSG + cctx.name());\n \n-        return cctx.config().getAffinityMapper().affinityKey(key);\n+        return ccfg.getAffinityMapper().affinityKey(key);\n     }\n \n     /** {@inheritDoc} */\n@@ -178,17 +201,18 @@ public GridCacheAffinityImpl(GridCacheContext<K, V> cctx) {\n         for (K key : keys) {\n             ClusterNode primary = cctx.affinity().primary(key, topVer);\n \n-            if (primary != null) {\n-                Collection<K> mapped = res.get(primary);\n+            if (primary == null)\n+                throw new IgniteException(\"Failed to get primare node [topVer=\" + topVer + \", key=\" + key + ']');\n \n-                if (mapped == null) {\n-                    mapped = new ArrayList<>(Math.max(keys.size() / nodesCnt, 16));\n+            Collection<K> mapped = res.get(primary);\n \n-                    res.put(primary, mapped);\n-                }\n+            if (mapped == null) {\n+                mapped = new ArrayList<>(Math.max(keys.size() / nodesCnt, 16));\n \n-                mapped.add(key);\n+                res.put(primary, mapped);\n             }\n+\n+            mapped.add(key);\n         }\n \n         return res;\n@@ -216,4 +240,4 @@ public GridCacheAffinityImpl(GridCacheContext<K, V> cctx) {\n     private AffinityTopologyVersion topologyVersion() {\n         return cctx.affinity().affinityTopologyVersion();\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/affinity/GridCacheAffinityImpl.java",
                "sha": "3bc71fe5ce8a9548d5f7f16ebc525806db196437",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityMappedTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityMappedTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/GridAffinityMappedTest.java",
                "patch": "@@ -109,18 +109,18 @@ public void testMappedAffinity() throws IgniteCheckedException {\n         //Key 0 is mapped to partition 0, first node.\n         //Key 1 is mapped to partition 1, second node.\n         //key 2 is mapped to partition 0, first node because mapper substitutes key 2 with affinity key 0.\n-        Map<ClusterNode, Collection<Integer>> map = g1.cluster().mapKeysToNodes(null, F.asList(0));\n+        Map<ClusterNode, Collection<Integer>> map = g1.<Integer>affinity(null).mapKeysToNodes(F.asList(0));\n \n         assertNotNull(map);\n         assertEquals(\"Invalid map size: \" + map.size(), 1, map.size());\n         assertEquals(F.first(map.keySet()), first);\n \n-        UUID id1 = g1.cluster().mapKeyToNode(null, 1).id();\n+        UUID id1 = g1.affinity(null).mapKeyToNode(1).id();\n \n         assertNotNull(id1);\n         assertEquals(second.id(),  id1);\n \n-        UUID id2 = g1.cluster().mapKeyToNode(null, 2).id();\n+        UUID id2 = g1.affinity(null).mapKeyToNode(2).id();\n \n         assertNotNull(id2);\n         assertEquals(first.id(),  id2);\n@@ -163,4 +163,4 @@ private MockCacheAffinityFunction() {\n             // This mapper is stateless and needs no initialization logic.\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityMappedTest.java",
                "sha": "099afd14fc6e89ff3cd376eef8c8edc1709c8e9c",
                "status": "modified"
            },
            {
                "additions": 290,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityNoCacheSelfTest.java",
                "changes": 290,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityNoCacheSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/GridAffinityNoCacheSelfTest.java",
                "patch": "@@ -0,0 +1,290 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal;\n+\n+import java.nio.ByteBuffer;\n+import java.util.Collections;\n+import java.util.concurrent.Callable;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.IgniteException;\n+import org.apache.ignite.cache.affinity.Affinity;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.processors.cache.CacheObject;\n+import org.apache.ignite.internal.processors.cache.CacheObjectContext;\n+import org.apache.ignite.internal.processors.cache.affinity.GridCacheAffinityImpl;\n+import org.apache.ignite.internal.util.typedef.internal.A;\n+import org.apache.ignite.plugin.extensions.communication.MessageReader;\n+import org.apache.ignite.plugin.extensions.communication.MessageWriter;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.jetbrains.annotations.Nullable;\n+\n+/**\n+ * Tests usage of affinity in case when cache doesn't exist.\n+ */\n+public class GridAffinityNoCacheSelfTest extends GridCommonAbstractTest {\n+    /** */\n+    public static final String EXPECTED_MSG = \"Failed to find cache\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        super.beforeTestsStarted();\n+\n+        startGrids(2);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() throws Exception {\n+        stopAllGrids();\n+\n+        super.afterTestsStopped();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testAffinityProxyNoCache() throws Exception {\n+        checkAffinityProxyNoCache(new Object());\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testAffinityProxyNoCacheCacheObject() throws Exception {\n+        checkAffinityProxyNoCache(new TestCacheObject(new Object()));\n+    }\n+\n+    /**\n+     * @param key Key.\n+     */\n+    private void checkAffinityProxyNoCache(Object key) {\n+        IgniteEx ignite = grid(0);\n+\n+        final Affinity<Object> affinity = ignite.affinity(\"noCache\");\n+\n+        assertFalse(\"Affinity proxy instance expected\", affinity instanceof GridCacheAffinityImpl);\n+\n+        final ClusterNode n = ignite.cluster().localNode();\n+\n+        assertAffinityMethodsException(affinity, key, n);\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testAffinityImplCacheDeleted() throws Exception {\n+        checkAffinityImplCacheDeleted(new Object());\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testAffinityImplCacheDeletedCacheObject() throws Exception {\n+        checkAffinityImplCacheDeleted(new TestCacheObject(new Object()));\n+    }\n+\n+    /**\n+     * @param key Key.\n+     */\n+    private void checkAffinityImplCacheDeleted(Object key) {\n+        IgniteEx grid = grid(0);\n+\n+        final String cacheName = \"cacheToBeDeleted\";\n+\n+        grid(1).getOrCreateCache(cacheName);\n+\n+        Affinity<Object> affinity = grid.affinity(cacheName);\n+\n+        assertTrue(affinity instanceof GridCacheAffinityImpl);\n+\n+        final ClusterNode n = grid.cluster().localNode();\n+\n+        grid.cache(cacheName).destroy();\n+\n+        assertAffinityMethodsException(affinity, key, n);\n+    }\n+\n+    /**\n+     * @param affinity Affinity.\n+     * @param key Key.\n+     * @param n Node.\n+     */\n+    private void assertAffinityMethodsException(final Affinity<Object> affinity, final Object key,\n+        final ClusterNode n) {\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.affinityKey(key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.allPartitions(n);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.backupPartitions(n);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.isBackup(n, key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.isPrimary(n, key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.isPrimaryOrBackup(n, key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.mapKeysToNodes(Collections.singleton(key));\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.mapKeyToPrimaryAndBackups(key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.mapPartitionsToNodes(Collections.singleton(0));\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.mapPartitionToNode(0);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.mapPartitionToPrimaryAndBackups(0);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.mapKeyToNode(key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.partition(key);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.partitions();\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Object>() {\n+            @Override public Object call() throws Exception {\n+                return affinity.primaryPartitions(n);\n+            }\n+        }, IgniteException.class, EXPECTED_MSG);\n+    }\n+\n+    /**\n+     */\n+    private static class TestCacheObject implements CacheObject {\n+        /** */\n+        private Object val;\n+\n+        /**\n+         * @param val Value.\n+         */\n+        private TestCacheObject(Object val) {\n+            this.val = val;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Nullable @Override public <T> T value(CacheObjectContext ctx, boolean cpy) {\n+            A.notNull(ctx, \"ctx\");\n+\n+            return (T)val;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public byte[] valueBytes(CacheObjectContext ctx) throws IgniteCheckedException {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public byte cacheObjectType() {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public boolean isPlatformType() {\n+            return true;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public CacheObject prepareForCache(CacheObjectContext ctx) {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public void finishUnmarshal(CacheObjectContext ctx, ClassLoader ldr) throws IgniteCheckedException {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public void prepareMarshal(CacheObjectContext ctx) throws IgniteCheckedException {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public boolean writeTo(ByteBuffer buf, MessageWriter writer) {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public boolean readFrom(ByteBuffer buf, MessageReader reader) {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public byte directType() {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public byte fieldsCount() {\n+            throw new UnsupportedOperationException();\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityNoCacheSelfTest.java",
                "sha": "6fb12809f839a459e8aa02f596a9e3277f80701b",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityP2PSelfTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityP2PSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/GridAffinityP2PSelfTest.java",
                "patch": "@@ -176,13 +176,13 @@ private void affinityTest() throws Exception {\n             //Key 0 is mapped to partition 0, first node.\n             //Key 1 is mapped to partition 1, second node.\n             //key 2 is mapped to partition 0, first node because mapper substitutes key 2 with affinity key 0.\n-            Map<ClusterNode, Collection<Integer>> map = g1.cluster().mapKeysToNodes(null, F.asList(0));\n+            Map<ClusterNode, Collection<Integer>> map = g1.<Integer>affinity(null).mapKeysToNodes(F.asList(0));\n \n             assertNotNull(map);\n             assertEquals(\"Invalid map size: \" + map.size(), 1, map.size());\n             assertEquals(F.first(map.keySet()), first);\n \n-            ClusterNode n1 = g1.cluster().mapKeyToNode(null, 1);\n+            ClusterNode n1 = g1.affinity(null).mapKeyToNode(1);\n \n             assertNotNull(n1);\n \n@@ -191,7 +191,7 @@ private void affinityTest() throws Exception {\n             assertNotNull(id1);\n             assertEquals(second.id(), id1);\n \n-            ClusterNode n2 = g1.cluster().mapKeyToNode(null, 2);\n+            ClusterNode n2 = g1.affinity(null).mapKeyToNode(2);\n \n             assertNotNull(n2);\n \n@@ -206,4 +206,4 @@ private void affinityTest() throws Exception {\n             stopGrid(3);\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinityP2PSelfTest.java",
                "sha": "e42c4fbeeccdb4262e68b3ec0f9e541a40e9f15e",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinitySelfTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/GridAffinitySelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/GridAffinitySelfTest.java",
                "patch": "@@ -91,18 +91,18 @@ public void testAffinity() throws IgniteCheckedException {\n         assert caches(g1).size() == 0;\n         assert F.first(caches(g2)).getCacheMode() == PARTITIONED;\n \n-        Map<ClusterNode, Collection<String>> map = g1.cluster().mapKeysToNodes(null, F.asList(\"1\"));\n+        Map<ClusterNode, Collection<String>> map = g1.<String>affinity(null).mapKeysToNodes(F.asList(\"1\"));\n \n         assertNotNull(map);\n         assertEquals(\"Invalid map size: \" + map.size(), 1, map.size());\n         assertEquals(F.first(map.keySet()), g2.cluster().localNode());\n \n-        UUID id1 = g1.cluster().mapKeyToNode(null, \"2\").id();\n+        UUID id1 = g1.affinity(null).mapKeyToNode(\"2\").id();\n \n         assertNotNull(id1);\n         assertEquals(g2.cluster().localNode().id(), id1);\n \n-        UUID id2 = g1.cluster().mapKeyToNode(null, \"3\").id();\n+        UUID id2 = g1.affinity(null).mapKeyToNode(\"3\").id();\n \n         assertNotNull(id2);\n         assertEquals(g2.cluster().localNode().id(), id2);\n@@ -120,4 +120,4 @@ public void testAffinity() throws IgniteCheckedException {\n             }\n         });\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/GridAffinitySelfTest.java",
                "sha": "0515685f0622bce906e2520c8f0cded6311f979b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "patch": "@@ -325,7 +325,7 @@ public void testSize() throws Exception {\n             map.put(\"key\" + i, i);\n \n         // Put in primary nodes to avoid near readers which will prevent entry from being cleared.\n-        Map<ClusterNode, Collection<String>> mapped = grid(0).cluster().mapKeysToNodes(null, map.keySet());\n+        Map<ClusterNode, Collection<String>> mapped = grid(0).<String>affinity(null).mapKeysToNodes(map.keySet());\n \n         for (int i = 0; i < gridCount(); i++) {\n             Collection<String> keys = mapped.get(grid(i).localNode());\n@@ -338,7 +338,7 @@ public void testSize() throws Exception {\n \n         map.remove(\"key0\");\n \n-        mapped = grid(0).cluster().mapKeysToNodes(null, map.keySet());\n+        mapped = grid(0).<String>affinity(null).mapKeysToNodes(map.keySet());\n \n         for (int i = 0; i < gridCount(); i++) {\n             // Will actually delete entry from map.",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "sha": "93ff51580039bc72cd210d466f67a155c1591a43",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityRoutingSelfTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityRoutingSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 5,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityRoutingSelfTest.java",
                "patch": "@@ -276,8 +276,8 @@ private CheckRunnable(Object affKey, Object key) {\n \n         /** {@inheritDoc} */\n         @Override public void applyx() throws IgniteCheckedException {\n-            assert ignite.cluster().localNode().id().equals(ignite.cluster().mapKeyToNode(null, affKey).id());\n-            assert ignite.cluster().localNode().id().equals(ignite.cluster().mapKeyToNode(null, key).id());\n+            assert ignite.cluster().localNode().id().equals(ignite.affinity(null).mapKeyToNode(affKey).id());\n+            assert ignite.cluster().localNode().id().equals(ignite.affinity(null).mapKeyToNode(key).id());\n         }\n     }\n \n@@ -412,10 +412,10 @@ private CheckCallable(Object affKey, Object key) {\n \n         /** {@inheritDoc} */\n         @Override public Object call() throws IgniteCheckedException {\n-            assert ignite.cluster().localNode().id().equals(ignite.cluster().mapKeyToNode(null, affKey).id());\n-            assert ignite.cluster().localNode().id().equals(ignite.cluster().mapKeyToNode(null, key).id());\n+            assert ignite.cluster().localNode().id().equals(ignite.affinity(null).mapKeyToNode(affKey).id());\n+            assert ignite.cluster().localNode().id().equals(ignite.affinity(null).mapKeyToNode(key).id());\n \n             return null;\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAffinityRoutingSelfTest.java",
                "sha": "34a74eb4df5bea934b851c56c18a049e63c82963",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheConcurrentTxMultiNodeTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheConcurrentTxMultiNodeTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheConcurrentTxMultiNodeTest.java",
                "patch": "@@ -228,7 +228,7 @@ public void testEvictions() throws Exception {\n                     String terminalId = String.valueOf(++tid);\n \n                     // Server partition cache\n-                    UUID mappedId = srvr1.cluster().mapKeyToNode(null, terminalId).id();\n+                    UUID mappedId = srvr1.affinity(null).mapKeyToNode(terminalId).id();\n \n                     if (!srvrId.equals(mappedId))\n                         continue;\n@@ -840,4 +840,4 @@ public String getCacheKey() {\n             return null;\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheConcurrentTxMultiNodeTest.java",
                "sha": "69445ea30f89f2a7bab18759ee5d8226fba72eb8",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDaemonNodeAbstractSelfTest.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDaemonNodeAbstractSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDaemonNodeAbstractSelfTest.java",
                "patch": "@@ -19,15 +19,18 @@\n \n import java.util.HashMap;\n import java.util.Map;\n+import java.util.concurrent.Callable;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.cache.CacheMode;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.configuration.IgniteConfiguration;\n import org.apache.ignite.configuration.NearCacheConfiguration;\n import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.GridTestUtils;\n import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n import org.apache.ignite.transactions.Transaction;\n \n@@ -167,18 +170,24 @@ public void testMapKeyToNode() throws Exception {\n             // Start daemon node.\n             daemon = true;\n \n-            Ignite g2 = startGrid(4);\n+            final Ignite g2 = startGrid(4);\n \n             for (long i = 0; i < Integer.MAX_VALUE; i = (i << 1) + 1) {\n                 // Call mapKeyToNode for normal node.\n-                assertNotNull(g1.cluster().mapKeyToNode(null, i));\n+                assertNotNull(g1.<Long>affinity(null).mapKeyToNode(i));\n \n                 // Call mapKeyToNode for daemon node.\n-                assertNull(g2.cluster().mapKeyToNode(null, i));\n+                final long i0 = i;\n+\n+                GridTestUtils.assertThrows(log, new Callable<Object>() {\n+                    @Override public Object call() throws Exception {\n+                        return g2.<Long>affinity(null).mapKeyToNode(i0);\n+                    }\n+                }, IgniteException.class, \"Failed to find cache\");\n             }\n         }\n         finally {\n             stopAllGrids();\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDaemonNodeAbstractSelfTest.java",
                "sha": "7d209c6a0859347a1a6ef8889bbd00a43eca5653",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDeploymentSelfTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDeploymentSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDeploymentSelfTest.java",
                "patch": "@@ -158,7 +158,7 @@ public void testDeployment2() throws Exception {\n             for (int i = 0; i < 1000; i++) {\n                 key = \"1\" + i;\n \n-                if (g1.cluster().mapKeyToNode(null, key).id().equals(g2.cluster().localNode().id()))\n+                if (g1.affinity(null).mapKeyToNode(key).id().equals(g2.cluster().localNode().id()))\n                     break;\n             }\n \n@@ -193,7 +193,7 @@ public void testDeployment3() throws Exception {\n             for (int i = 0; i < 1000; i++) {\n                 key = \"1\" + i;\n \n-                if (g1.cluster().mapKeyToNode(null, key).id().equals(g2.cluster().localNode().id()))\n+                if (g1.affinity(null).mapKeyToNode(key).id().equals(g2.cluster().localNode().id()))\n                     break;\n             }\n \n@@ -352,7 +352,7 @@ public void testDeployment6() throws Exception {\n             for (int i = 0; i < 1000; i++) {\n                 key = \"1\" + i;\n \n-                if (g1.cluster().mapKeyToNode(null, key).id().equals(g2.cluster().localNode().id()))\n+                if (g1.affinity(null).mapKeyToNode(key).id().equals(g2.cluster().localNode().id()))\n                     break;\n             }\n \n@@ -385,7 +385,7 @@ public void testDeployment7() throws Exception {\n             for (int i = 0; i < 1000; i++) {\n                 key = \"1\" + i;\n \n-                if (g1.cluster().mapKeyToNode(null, key).id().equals(g2.cluster().localNode().id()))\n+                if (g1.affinity(null).mapKeyToNode(key).id().equals(g2.cluster().localNode().id()))\n                     break;\n             }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheDeploymentSelfTest.java",
                "sha": "db6c88279898beeede9a224a354544e586281865",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheEntryMemorySizeSelfTest.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheEntryMemorySizeSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 3,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheEntryMemorySizeSelfTest.java",
                "patch": "@@ -217,7 +217,7 @@ public void testPartitionedNearEnabled() throws Exception {\n                 while (true) {\n                     key++;\n \n-                    if (grid(0).cluster().mapKeyToNode(null, key).equals(grid(0).localNode())) {\n+                    if (grid(0).affinity(null).mapKeyToNode(key).equals(grid(0).localNode())) {\n                         if (i > 0)\n                             jcache(0).put(key, new Value(new byte[i * 1024]));\n \n@@ -271,7 +271,7 @@ public void testPartitionedNearDisabled() throws Exception {\n                 while (true) {\n                     key++;\n \n-                    if (grid(0).cluster().mapKeyToNode(null, key).equals(grid(0).localNode())) {\n+                    if (grid(0).affinity(null).mapKeyToNode(key).equals(grid(0).localNode())) {\n                         if (i > 0)\n                             jcache(0).put(key, new Value(new byte[i * 1024]));\n \n@@ -346,4 +346,4 @@ private Value(byte[] arr) {\n             return arr != null ? Arrays.hashCode(arr) : 0;\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheEntryMemorySizeSelfTest.java",
                "sha": "9e3ea7b58f733ff5c2fd2fcd7e7e46eef6be5dbf",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePartitionedProjectionAffinitySelfTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePartitionedProjectionAffinitySelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 4,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePartitionedProjectionAffinitySelfTest.java",
                "patch": "@@ -88,7 +88,7 @@ public void testAffinity() throws Exception {\n         Ignite g1 = grid(1);\n \n         for (int i = 0; i < 100; i++)\n-            assertEquals(g0.cluster().mapKeyToNode(null, i).id(), g1.cluster().mapKeyToNode(null, i).id());\n+            assertEquals(g0.affinity(null).mapKeyToNode(i).id(), g1.affinity(null).mapKeyToNode(i).id());\n     }\n \n     /** @throws Exception If failed. */\n@@ -105,13 +105,13 @@ public void testProjectionAffinity() throws Exception {\n             g1.cluster().forNodeIds(F.asList(g0.cluster().localNode().id(), g1.cluster().localNode().id()));\n \n         for (int i = 0; i < 100; i++)\n-            assertEquals(g0Pinned.ignite().cluster().mapKeyToNode(null, i).id(),\n-                g01Pinned.ignite().cluster().mapKeyToNode(null, i).id());\n+            assertEquals(g0Pinned.ignite().affinity(null).mapKeyToNode(i).id(),\n+                g01Pinned.ignite().affinity(null).mapKeyToNode(i).id());\n     }\n \n     /** @throws Exception If failed. */\n     @SuppressWarnings(\"BusyWait\")\n     private void waitTopologyUpdate() throws Exception {\n         GridTestUtils.waitTopologyUpdate(null, BACKUPS, log());\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePartitionedProjectionAffinitySelfTest.java",
                "sha": "7d2b5503588a8b099261b8b40f60d7a95cca8ef8",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePutAllFailoverSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePutAllFailoverSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePutAllFailoverSelfTest.java",
                "patch": "@@ -303,7 +303,7 @@ public void checkPutAllFailover(boolean near, int workerCnt, int shutdownCnt) th\n \n         try {\n             // Dummy call to fetch affinity function from remote node\n-            master.cluster().mapKeyToNode(CACHE_NAME, \"Dummy\");\n+            master.affinity(CACHE_NAME).mapKeyToNode(\"Dummy\");\n \n             Random rnd = new Random();\n \n@@ -517,7 +517,7 @@ public void checkPutAllFailoverColocated(boolean near, int workerCnt, int shutdo\n             IgniteCompute comp = compute(master.cluster().forPredicate(workerNodesFilter)).withAsync();\n \n             for (Integer key : testKeys) {\n-                ClusterNode mappedNode = master.cluster().mapKeyToNode(CACHE_NAME, key);\n+                ClusterNode mappedNode = master.affinity(CACHE_NAME).mapKeyToNode(key);\n \n                 UUID nodeId = mappedNode.id();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCachePutAllFailoverSelfTest.java",
                "sha": "b48bbc7974c254d490aac36913eb5c417a6246fc",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/GridCacheDhtMultiBackupTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/GridCacheDhtMultiBackupTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/GridCacheDhtMultiBackupTest.java",
                "patch": "@@ -70,7 +70,7 @@ public void testPut() throws Exception {\n             for (int key = 0; key < 1000; key++) {\n                 SampleKey key1 = new SampleKey(key);\n \n-                if (!g.cluster().localNode().id().equals(g.cluster().mapKeyToNode(\"partitioned\", key1).id())) {\n+                if (!g.cluster().localNode().id().equals(g.affinity(\"partitioned\").mapKeyToNode(key1).id())) {\n                     cache.put(key1, new SampleValue(key));\n \n                     cnt++;\n@@ -133,4 +133,4 @@ private SampleValue(int val) {\n             return obj instanceof SampleValue && ((SampleValue)obj).val == val;\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/GridCacheDhtMultiBackupTest.java",
                "sha": "e1e5315dda4d356b5bb63e9952c48d02c990cb2b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearOnlyTopologySelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearOnlyTopologySelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearOnlyTopologySelfTest.java",
                "patch": "@@ -148,7 +148,7 @@ public void testKeyMappingOnComputeNode() throws Exception {\n             Ignite compute = startGrid(4);\n \n             for (int i = 0; i < 100; i++) {\n-                ClusterNode node = compute.cluster().mapKeyToNode(null, i);\n+                ClusterNode node = compute.affinity(null).mapKeyToNode(i);\n \n                 assertFalse(\"For key: \" + i, node.id().equals(compute.cluster().localNode().id()));\n                 assertFalse(\"For key: \" + i, node.id().equals(grid(0).localNode().id()));\n@@ -250,4 +250,4 @@ private void checkStartupNearNode(int nearNodeIdx, int totalNodeCnt) throws Exce\n             stopAllGrids();\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearOnlyTopologySelfTest.java",
                "sha": "c7e53e8c79c278d998ee8cb41987ec147d7e7cdb",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearTxMultiNodeSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearTxMultiNodeSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearTxMultiNodeSelfTest.java",
                "patch": "@@ -104,7 +104,7 @@ public void testTxCleanup() throws Exception {\n         try {\n             Integer mainKey = 0;\n \n-            ClusterNode priNode = ignite.cluster().mapKeyToNode(null, mainKey);\n+            ClusterNode priNode = ignite.affinity(null).mapKeyToNode(mainKey);\n             ClusterNode backupNode = F.first(F.view(ignite.affinity(null).mapKeyToPrimaryAndBackups(mainKey),\n                 F.notIn(F.asList(priNode))));\n             ClusterNode otherNode = F.first(ignite.cluster().forPredicate(F.notIn(F.asList(priNode, backupNode))).nodes());\n@@ -250,4 +250,4 @@ private void checkTm(Ignite g, IgniteTxManager tm) {\n         for (IgniteInternalTx tx : txs)\n             assert tx.done() : \"Transaction is not finished: \" + tx;\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCacheNearTxMultiNodeSelfTest.java",
                "sha": "c246049dc617c07bff4b3c1f850b31d91391753e",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCachePartitionedExplicitLockNodeFailureSelfTest.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCachePartitionedExplicitLockNodeFailureSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 3,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCachePartitionedExplicitLockNodeFailureSelfTest.java",
                "patch": "@@ -92,10 +92,10 @@ public void testLockFromNearOrBackup() throws Exception {\n \n         Integer key = 0;\n \n-        while (grid(idx).cluster().mapKeyToNode(null, key).id().equals(grid(0).localNode().id()))\n+        while (grid(idx).affinity(null).mapKeyToNode(key).id().equals(grid(0).localNode().id()))\n             key++;\n \n-        ClusterNode node = grid(idx).cluster().mapKeyToNode(null, key);\n+        ClusterNode node = grid(idx).affinity(null).mapKeyToNode(key);\n \n         info(\"Primary node for key [id=\" + node.id() + \", order=\" + node.order() + \", key=\" + key + ']');\n \n@@ -158,4 +158,4 @@ public void testLockFromNearOrBackup() throws Exception {\n             break;\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/near/GridCachePartitionedExplicitLockNodeFailureSelfTest.java",
                "sha": "a7eaa3399d3ef733046f5da6da3bfbe025d4ffd9",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 5,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java",
                "patch": "@@ -70,10 +70,10 @@\n import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n import org.jetbrains.annotations.Nullable;\n import org.jsr166.ConcurrentHashMap8;\n-import org.jsr166.ConcurrentLinkedDeque8;\n \n import static java.util.concurrent.TimeUnit.MILLISECONDS;\n import static java.util.concurrent.TimeUnit.SECONDS;\n+\n import static org.apache.ignite.cache.CacheAtomicityMode.ATOMIC;\n import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n import static org.apache.ignite.cache.CacheMode.LOCAL;\n@@ -581,7 +581,7 @@ public void testLocalNodeOnly() throws Exception {\n             int key = 0;\n \n             while (true) {\n-                ClusterNode n = grid(0).cluster().mapKeyToNode(null, key);\n+                ClusterNode n = grid(0).affinity(null).mapKeyToNode(key);\n \n                 assert n != null;\n \n@@ -655,7 +655,7 @@ public void testBuffering() throws Exception {\n             int key = 0;\n \n             while (true) {\n-                ClusterNode n = grid(0).cluster().mapKeyToNode(null, key);\n+                ClusterNode n = grid(0).affinity(null).mapKeyToNode(key);\n \n                 assert n != null;\n \n@@ -741,7 +741,7 @@ public void testTimeInterval() throws Exception {\n             int key = 0;\n \n             while (true) {\n-                ClusterNode n = grid(0).cluster().mapKeyToNode(null, key);\n+                ClusterNode n = grid(0).affinity(null).mapKeyToNode(key);\n \n                 assert n != null;\n \n@@ -1117,4 +1117,4 @@ public void testEvents() throws Exception {\n             // No-op.\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/GridCacheContinuousQueryAbstractSelfTest.java",
                "sha": "5abb98dd9754688d3838b7ffae2716d59a9cc812",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java",
                "patch": "@@ -214,7 +214,7 @@ public void testCreateFileColocated() throws Exception {\n         while (true) {\n             affKey = new IgniteUuid(uuid, idx);\n \n-            if (grid(0).cluster().mapKeyToNode(DATA_CACHE_NAME, affKey).id().equals(grid(0).localNode().id()))\n+            if (grid(0).affinity(DATA_CACHE_NAME).mapKeyToNode(affKey).id().equals(grid(0).localNode().id()))\n                 break;\n \n             idx++;\n@@ -488,4 +488,4 @@ else if (seek % 2 == 0)\n                 \"[size=%7d, rate=%3.1f MB/sec]\", expSize, expSize * 1000. / time / 1024 / 1024));\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java",
                "sha": "8383a1874d34d72f7be43acc677599842b836e2b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/loadtests/dsi/GridDsiClient.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/loadtests/dsi/GridDsiClient.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/loadtests/dsi/GridDsiClient.java",
                "patch": "@@ -272,7 +272,7 @@ public static void main(String[] args) throws Exception {\n                             String terminalId = String.valueOf(++tid);\n \n                             // Server partition cache.\n-                            if (!srvrId.equals(g.cluster().mapKeyToNode(\"PARTITIONED_CACHE\", terminalId).id()))\n+                            if (!srvrId.equals(g.affinity(\"PARTITIONED_CACHE\").mapKeyToNode(terminalId).id()))\n                                 continue;\n \n                             if (terminalsPerSrv < srvMaxNoTerminals) {\n@@ -428,4 +428,4 @@ public static void main(String[] args) throws Exception {\n             fileLock.close();\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/loadtests/dsi/GridDsiClient.java",
                "sha": "a065580f056c939759e922ea67405689c2ae4506",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/GridCacheDhtLockBackupSelfTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/GridCacheDhtLockBackupSelfTest.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/GridCacheDhtLockBackupSelfTest.java",
                "patch": "@@ -110,7 +110,7 @@ public void testLock() throws Exception {\n \n         Ignite ignite2 = startGridWithSpi(2, new TestCommunicationSpi(GridNearUnlockRequest.class, 1000));\n \n-        if (!ignite1.cluster().mapKeyToNode(null, kv).id().equals(ignite1.cluster().localNode().id())) {\n+        if (!ignite1.affinity(null).mapKeyToNode(kv).id().equals(ignite1.cluster().localNode().id())) {\n             Ignite tmp = ignite1;\n             ignite1 = ignite2;\n             ignite2 = tmp;\n@@ -287,4 +287,4 @@ private void checkAwaitMessageType(Message obj, UUID srcNodeId) {\n             super.notifyListener(sndId, msg, msgC);\n         }\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/GridCacheDhtLockBackupSelfTest.java",
                "sha": "f600e994e8f413d4c1dae1c14008f76166d52a3b",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java?ref=550a4ea7eab41a3d27ff29d1e3a8df09d698524a",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java",
                "patch": "@@ -19,6 +19,7 @@\n \n import junit.framework.TestSuite;\n import org.apache.ignite.internal.ClusterNodeMetricsSelfTest;\n+import org.apache.ignite.internal.GridAffinityNoCacheSelfTest;\n import org.apache.ignite.internal.GridAffinitySelfTest;\n import org.apache.ignite.internal.GridAlwaysFailoverSpiFailSelfTest;\n import org.apache.ignite.internal.GridCancelOnGridStopSelfTest;\n@@ -137,6 +138,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(GridFailoverTaskWithPredicateSelfTest.class);\n         suite.addTestSuite(GridProjectionLocalJobMultipleArgumentsSelfTest.class);\n         suite.addTestSuite(GridAffinitySelfTest.class);\n+        suite.addTestSuite(GridAffinityNoCacheSelfTest.class);\n         suite.addTestSuite(GridEventStorageRuntimeConfigurationSelfTest.class);\n         suite.addTestSuite(GridMultinodeRedeployContinuousModeSelfTest.class);\n         suite.addTestSuite(GridMultinodeRedeploySharedModeSelfTest.class);\n@@ -149,4 +151,4 @@ public static TestSuite suite() throws Exception {\n \n         return suite;\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/550a4ea7eab41a3d27ff29d1e3a8df09d698524a/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteComputeGridTestSuite.java",
                "sha": "699ad0c920f2dfaa231bc96e38bf811b38d6b265",
                "status": "modified"
            }
        ],
        "message": "IGNITE-1355 - Fixed potential NPE in CacheAffinityProxy - Fixes #263.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/a34d7058bd2901359cd2fda3d57a3f05ab6291df",
        "patched_files": [
            "CacheAffinityExample.java",
            "GridAffinityProcessor.java",
            "GridDsiClient.java",
            "GridCacheAffinityManager.java",
            "IgniteCluster.java",
            "Affinity.java",
            "GridCacheAffinityImpl.java",
            "IgniteComputeGridTestSuite.java",
            "ClientGetAffinityTask.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheNearTxMultiNodeSelfTest.java",
            "IgfsStreamsSelfTest.java",
            "GridCacheContinuousQueryAbstractSelfTest.java",
            "GridCacheDaemonNodeAbstractSelfTest.java",
            "GridCacheDeploymentSelfTest.java",
            "GridCachePutAllFailoverSelfTest.java",
            "GridCachePartitionedProjectionAffinitySelfTest.java",
            "GridCachePartitionedExplicitLockNodeFailureSelfTest.java",
            "GridCacheEntryMemorySizeSelfTest.java",
            "GridCacheDhtLockBackupSelfTest.java",
            "GridAffinitySelfTest.java",
            "GridCacheNearOnlyTopologySelfTest.java",
            "GridAffinityP2PSelfTest.java",
            "GridCacheDhtMultiBackupTest.java",
            "GridAffinityMappedTest.java",
            "GridCacheConcurrentTxMultiNodeTest.java",
            "GridAffinityNoCacheSelfTest.java",
            "GridCacheAbstractFullApiSelfTest.java",
            "GridCacheAffinityRoutingSelfTest.java"
        ]
    },
    "ignite_557bf5d": {
        "bug_id": "ignite_557bf5d",
        "commit": "https://github.com/apache/ignite/commit/557bf5dd118af9ef825624bb36fb50c44046456e",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/557bf5dd118af9ef825624bb36fb50c44046456e/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java?ref=557bf5dd118af9ef825624bb36fb50c44046456e",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java",
                "patch": "@@ -71,6 +71,9 @@ protected boolean needCopy(CacheObjectContext ctx) {\n \n     /** {@inheritDoc} */\n     @Override public boolean putValue(ByteBuffer buf, CacheObjectContext ctx) throws IgniteCheckedException {\n+        if (valBytes == null)\n+            valueBytes(ctx);\n+\n         if (buf.remaining() < valBytes.length + 5)\n             return false;\n ",
                "raw_url": "https://github.com/apache/ignite/raw/557bf5dd118af9ef825624bb36fb50c44046456e/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java",
                "sha": "28a95d8dcfece496de5d483d62607809abf243bf",
                "status": "modified"
            },
            {
                "additions": 177,
                "blob_url": "https://github.com/apache/ignite/blob/557bf5dd118af9ef825624bb36fb50c44046456e/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java",
                "changes": 177,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java?ref=557bf5dd118af9ef825624bb36fb50c44046456e",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java",
                "patch": "@@ -0,0 +1,177 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache;\n+\n+import java.io.Serializable;\n+import java.nio.ByteBuffer;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.processors.cacheobject.IgniteCacheObjectProcessor;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ *\n+ */\n+public class IgniteCacheObjectPutSelfTest extends GridCommonAbstractTest {\n+    /** */\n+    public static final String CACHE_NAME = \"partitioned\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        CacheConfiguration ccfg = new CacheConfiguration();\n+\n+        ccfg.setName(CACHE_NAME);\n+\n+        cfg.setCacheConfiguration(ccfg);\n+\n+        cfg.setMarshaller(null);\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        super.beforeTestsStarted();\n+\n+        startGrid(0);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() throws Exception {\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testPrimitiveValues() throws Exception {\n+        IgniteEx ignite = grid(0);\n+\n+        IgniteCache<Object, Object> cache = ignite.cache(CACHE_NAME);\n+\n+        for (int i = 0; i < 10; i++)\n+            cache.put(i, String.valueOf(i));\n+\n+        IgniteCacheObjectProcessor co = ignite.context().cacheObjects();\n+        GridCacheAdapter<Object, Object> iCache = ignite.context().cache().internalCache(CACHE_NAME);\n+        CacheObjectContext coCtx = iCache.context().cacheObjectContext();\n+\n+        ByteBuffer buf = ByteBuffer.allocate(2048);\n+\n+        for (int i = 0; i < 10; i++) {\n+            KeyCacheObject key = co.toCacheKeyObject(coCtx, i, false);\n+\n+            GridCacheEntryEx entry = iCache.peekEx(key);\n+\n+            assertNotNull(entry);\n+\n+            assertTrue(entry.key().putValue(buf, coCtx));\n+            assertTrue(entry.valueBytes().putValue(buf, coCtx));\n+        }\n+\n+        buf.flip();\n+\n+        for (int i = 0; i < 10; i++) {\n+            CacheObject co1 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(i, co1.value(coCtx, false));\n+\n+            CacheObject co2 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(String.valueOf(i), co2.value(coCtx, false));\n+        }\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testClassValues() throws Exception {\n+        IgniteEx ignite = grid(0);\n+\n+        IgniteCache<Object, Object> cache = ignite.cache(CACHE_NAME);\n+\n+        for (int i = 0; i < 10; i++)\n+            cache.put(new TestValue(i), new TestValue(i));\n+\n+        IgniteCacheObjectProcessor co = ignite.context().cacheObjects();\n+        GridCacheAdapter<Object, Object> iCache = ignite.context().cache().internalCache(CACHE_NAME);\n+        CacheObjectContext coCtx = iCache.context().cacheObjectContext();\n+\n+        ByteBuffer buf = ByteBuffer.allocate(2048);\n+\n+        for (int i = 0; i < 10; i++) {\n+            KeyCacheObject key = co.toCacheKeyObject(coCtx, new TestValue(i), false);\n+\n+            GridCacheEntryEx entry = iCache.peekEx(key);\n+\n+            assertNotNull(entry);\n+\n+            assertTrue(entry.key().putValue(buf, coCtx));\n+            assertTrue(entry.valueBytes().putValue(buf, coCtx));\n+        }\n+\n+        buf.flip();\n+\n+        for (int i = 0; i < 10; i++) {\n+            CacheObject co1 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(new TestValue(i), co1.value(coCtx, false));\n+\n+            CacheObject co2 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(new TestValue(i), co2.value(coCtx, false));\n+        }\n+    }\n+\n+    /**\n+     *\n+     */\n+    private static class TestValue implements Serializable {\n+        /** */\n+        private int val;\n+\n+        /**\n+         * @param val Value.\n+         */\n+        private TestValue(int val) {\n+            this.val = val;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public boolean equals(Object o) {\n+            if (this == o)\n+                return true;\n+\n+            if (!(o instanceof TestValue))\n+                return false;\n+\n+            TestValue value = (TestValue)o;\n+\n+            return val == value.val;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public int hashCode() {\n+            return val;\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/557bf5dd118af9ef825624bb36fb50c44046456e/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java",
                "sha": "2dc18f5ad9c3e8a26bb7a24a89498bee309e6993",
                "status": "added"
            }
        ],
        "message": "Added test, fixed NPE",
        "parent": "https://github.com/apache/ignite/commit/26a191b4f7652e40f2e8d23bd2e46503bcf9514c",
        "patched_files": [
            "CacheObjectAdapter.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCacheObjectPutSelfTest.java"
        ]
    },
    "ignite_587103f": {
        "bug_id": "ignite_587103f",
        "commit": "https://github.com/apache/ignite/commit/587103fdd1273e1d98897a07f98594dac85e38bc",
        "file": [
            {
                "additions": 63,
                "blob_url": "https://github.com/apache/ignite/blob/587103fdd1273e1d98897a07f98594dac85e38bc/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 109,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=587103fdd1273e1d98897a07f98594dac85e38bc",
                "deletions": 46,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -124,6 +124,9 @@\n     /** Must use JDK marshaller since it is used by discovery to fire custom events. */\n     private Marshaller marshaller = new JdkMarshaller();\n \n+    /** Count down latch for caches. */\n+    private final CountDownLatch cacheStartedLatch = new CountDownLatch(1);\n+\n     /**\n      * @param ctx Kernal context.\n      */\n@@ -657,87 +660,92 @@ else if (internalCaches.contains(maskNull(cfg.getName())))\n     /** {@inheritDoc} */\n     @SuppressWarnings(\"unchecked\")\n     @Override public void onKernalStart() throws IgniteCheckedException {\n-        if (ctx.config().isDaemon())\n-            return;\n+        try {\n+            if (ctx.config().isDaemon())\n+                return;\n \n-        ClusterNode locNode = ctx.discovery().localNode();\n+            ClusterNode locNode = ctx.discovery().localNode();\n \n-        // Init cache plugin managers.\n-        final Map<String, CachePluginManager> cache2PluginMgr = new HashMap<>();\n+            // Init cache plugin managers.\n+            final Map<String, CachePluginManager> cache2PluginMgr = new HashMap<>();\n \n-        for (DynamicCacheDescriptor desc : registeredCaches.values()) {\n-            CacheConfiguration locCcfg = desc.cacheConfiguration();\n+            for (DynamicCacheDescriptor desc : registeredCaches.values()) {\n+                CacheConfiguration locCcfg = desc.cacheConfiguration();\n \n-            CachePluginManager pluginMgr = new CachePluginManager(ctx, locCcfg);\n+                CachePluginManager pluginMgr = new CachePluginManager(ctx, locCcfg);\n \n-            cache2PluginMgr.put(locCcfg.getName(), pluginMgr);\n-        }\n+                cache2PluginMgr.put(locCcfg.getName(), pluginMgr);\n+            }\n \n-        if (!getBoolean(IGNITE_SKIP_CONFIGURATION_CONSISTENCY_CHECK)) {\n-            for (ClusterNode n : ctx.discovery().remoteNodes()) {\n-                checkTransactionConfiguration(n);\n+            if (!getBoolean(IGNITE_SKIP_CONFIGURATION_CONSISTENCY_CHECK)) {\n+                for (ClusterNode n : ctx.discovery().remoteNodes()) {\n+                    checkTransactionConfiguration(n);\n \n-                DeploymentMode locDepMode = ctx.config().getDeploymentMode();\n-                DeploymentMode rmtDepMode = n.attribute(IgniteNodeAttributes.ATTR_DEPLOYMENT_MODE);\n+                    DeploymentMode locDepMode = ctx.config().getDeploymentMode();\n+                    DeploymentMode rmtDepMode = n.attribute(IgniteNodeAttributes.ATTR_DEPLOYMENT_MODE);\n \n-                CU.checkAttributeMismatch(log, null, n.id(), \"deploymentMode\", \"Deployment mode\",\n-                    locDepMode, rmtDepMode, true);\n+                    CU.checkAttributeMismatch(log, null, n.id(), \"deploymentMode\", \"Deployment mode\",\n+                        locDepMode, rmtDepMode, true);\n \n-                for (DynamicCacheDescriptor desc : registeredCaches.values()) {\n-                    CacheConfiguration rmtCfg = desc.remoteConfiguration(n.id());\n+                    for (DynamicCacheDescriptor desc : registeredCaches.values()) {\n+                        CacheConfiguration rmtCfg = desc.remoteConfiguration(n.id());\n \n-                    if (rmtCfg != null) {\n-                        CacheConfiguration locCfg = desc.cacheConfiguration();\n+                        if (rmtCfg != null) {\n+                            CacheConfiguration locCfg = desc.cacheConfiguration();\n \n-                        checkCache(locCfg, rmtCfg, n);\n+                            checkCache(locCfg, rmtCfg, n);\n \n-                        // Check plugin cache configurations.\n-                        CachePluginManager pluginMgr = cache2PluginMgr.get(locCfg.getName());\n+                            // Check plugin cache configurations.\n+                            CachePluginManager pluginMgr = cache2PluginMgr.get(locCfg.getName());\n \n-                        assert pluginMgr != null : \" Map=\" + cache2PluginMgr;\n+                            assert pluginMgr != null : \" Map=\" + cache2PluginMgr;\n \n-                        pluginMgr.validateRemotes(rmtCfg, n);\n+                            pluginMgr.validateRemotes(rmtCfg, n);\n+                        }\n                     }\n                 }\n             }\n-        }\n \n-        // Start dynamic caches received from collect discovery data.\n-        for (DynamicCacheDescriptor desc : registeredCaches.values()) {\n-            boolean started = desc.onStart();\n+            // Start dynamic caches received from collect discovery data.\n+            for (DynamicCacheDescriptor desc : registeredCaches.values()) {\n+                boolean started = desc.onStart();\n \n-            assert started : \"Failed to change started flag for locally configured cache: \" + desc;\n+                assert started : \"Failed to change started flag for locally configured cache: \" + desc;\n \n-            desc.clearRemoteConfigurations();\n+                desc.clearRemoteConfigurations();\n \n-            CacheConfiguration ccfg = desc.cacheConfiguration();\n+                CacheConfiguration ccfg = desc.cacheConfiguration();\n \n-            IgnitePredicate filter = ccfg.getNodeFilter();\n+                IgnitePredicate filter = ccfg.getNodeFilter();\n \n-            if (filter.apply(locNode)) {\n-                CacheObjectContext cacheObjCtx = ctx.cacheObjects().contextForCache(ccfg);\n+                if (filter.apply(locNode)) {\n+                    CacheObjectContext cacheObjCtx = ctx.cacheObjects().contextForCache(ccfg);\n \n-                CachePluginManager pluginMgr = cache2PluginMgr.get(ccfg.getName());\n+                    CachePluginManager pluginMgr = cache2PluginMgr.get(ccfg.getName());\n \n-                assert pluginMgr != null : \" Map=\" + cache2PluginMgr;\n+                    assert pluginMgr != null : \" Map=\" + cache2PluginMgr;\n \n-                GridCacheContext ctx = createCache(ccfg, pluginMgr, desc.cacheType(), cacheObjCtx);\n+                    GridCacheContext ctx = createCache(ccfg, pluginMgr, desc.cacheType(), cacheObjCtx);\n \n-                ctx.dynamicDeploymentId(desc.deploymentId());\n+                    ctx.dynamicDeploymentId(desc.deploymentId());\n \n-                sharedCtx.addCacheContext(ctx);\n+                    sharedCtx.addCacheContext(ctx);\n \n-                GridCacheAdapter cache = ctx.cache();\n+                    GridCacheAdapter cache = ctx.cache();\n \n-                String name = ccfg.getName();\n+                    String name = ccfg.getName();\n \n-                caches.put(maskNull(name), cache);\n+                    caches.put(maskNull(name), cache);\n \n-                startCache(cache);\n+                    startCache(cache);\n \n-                jCacheProxies.put(maskNull(name), new IgniteCacheProxy(ctx, cache, null, false));\n+                    jCacheProxies.put(maskNull(name), new IgniteCacheProxy(ctx, cache, null, false));\n+                }\n             }\n         }\n+        finally {\n+            cacheStartedLatch.countDown();\n+        }\n \n         ctx.marshallerContext().onMarshallerCacheStarted(ctx);\n \n@@ -835,6 +843,8 @@ public void blockGateways() {\n     /** {@inheritDoc} */\n     @SuppressWarnings(\"unchecked\")\n     @Override public void onKernalStop(boolean cancel) {\n+        cacheStartedLatch.countDown();\n+\n         if (ctx.config().isDaemon())\n             return;\n \n@@ -958,6 +968,13 @@ private void stopCache(GridCacheAdapter<?, ?> cache, boolean cancel) {\n         cleanup(ctx);\n     }\n \n+    /**\n+     * @throws IgniteCheckedException If failed to wait.\n+     */\n+    public void awaitStarted() throws IgniteCheckedException {\n+        U.await(cacheStartedLatch);\n+    }\n+\n     /**\n      * @param cache Cache.\n      * @throws IgniteCheckedException If failed.",
                "raw_url": "https://github.com/apache/ignite/raw/587103fdd1273e1d98897a07f98594dac85e38bc/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "d22d2244ac779e23b214c29b9e6128e7dce15a67",
                "status": "modified"
            },
            {
                "additions": 110,
                "blob_url": "https://github.com/apache/ignite/blob/587103fdd1273e1d98897a07f98594dac85e38bc/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/CacheGetFromJobTest.java",
                "changes": 110,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/CacheGetFromJobTest.java?ref=587103fdd1273e1d98897a07f98594dac85e38bc",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/CacheGetFromJobTest.java",
                "patch": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache;\n+\n+import org.apache.ignite.*;\n+import org.apache.ignite.internal.*;\n+import org.apache.ignite.internal.util.typedef.*;\n+import org.apache.ignite.lang.*;\n+import org.apache.ignite.resources.*;\n+import org.apache.ignite.testframework.*;\n+\n+import java.util.concurrent.atomic.*;\n+\n+/**\n+ * Job tries to get cache during topology change.\n+ */\n+public class CacheGetFromJobTest extends GridCacheAbstractSelfTest {\n+    /** {@inheritDoc} */\n+    @Override protected int gridCount() {\n+        return 1;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testTopologyChange() throws Exception {\n+        final AtomicReference<Exception> err = new AtomicReference<>();\n+\n+        final AtomicInteger id = new AtomicInteger(1);\n+\n+        IgniteInternalFuture<?> fut = GridTestUtils.runMultiThreadedAsync(new CA() {\n+            @Override public void apply() {\n+                info(\"Run topology change.\");\n+\n+                try {\n+                    for (int i = 0; i < 5; i++) {\n+                        info(\"Topology change: \" + i);\n+\n+                        startGrid(id.getAndIncrement());\n+                    }\n+                }\n+                catch (Exception e) {\n+                    err.set(e);\n+\n+                    log.error(\"Unexpected exception in topology-change-thread: \" + e, e);\n+                }\n+            }\n+        }, 3, \"topology-change-thread\");\n+\n+        int cntr = 0;\n+\n+        while (!fut.isDone()) {\n+            grid(0).compute().broadcast(new TestJob());\n+\n+            cntr++;\n+        }\n+\n+        log.info(\"Job execution count: \" + cntr);\n+\n+        Exception err0 = err.get();\n+\n+        if (err0 != null)\n+            throw err0;\n+    }\n+\n+    /**\n+     * Test job.\n+     */\n+    private static class TestJob implements IgniteCallable<Object> {\n+        /** Ignite. */\n+        @IgniteInstanceResource\n+        private Ignite ignite;\n+\n+        /** */\n+        public TestJob() {\n+            // No-op.\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public Object call() throws Exception {\n+            IgniteCache cache = ignite.cache(null);\n+\n+            assertNotNull(cache);\n+\n+            assertEquals(0, cache.localSize());\n+\n+            return null;\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/587103fdd1273e1d98897a07f98594dac85e38bc/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/CacheGetFromJobTest.java",
                "sha": "5859beca97f2322d15ba36db7064d774892fe222",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/587103fdd1273e1d98897a07f98594dac85e38bc/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheRestartTestSuite.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheRestartTestSuite.java?ref=587103fdd1273e1d98897a07f98594dac85e38bc",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheRestartTestSuite.java",
                "patch": "@@ -48,6 +48,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(IgniteCacheAtomicPutAllFailoverSelfTest.class);\n         suite.addTestSuite(IgniteCachePutAllRestartTest.class);\n         suite.addTestSuite(GridCachePutAllFailoverSelfTest.class);\n+        suite.addTestSuite(CacheGetFromJobTest.class);\n \n         return suite;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/587103fdd1273e1d98897a07f98594dac85e38bc/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheRestartTestSuite.java",
                "sha": "796d1386ddd3b305c12151b95b31ada664047bf4",
                "status": "modified"
            }
        ],
        "message": "#gg-10186: NullPointerException at CacheDrStateTransferHandler.java:320\n#gg-10187: NullPointerException at GridEntSecurityProcessor.java:263",
        "parent": "https://github.com/apache/ignite/commit/99c7e228d12e25826f74d6d8706d158ec36004ed",
        "patched_files": [
            "GridCacheProcessor.java",
            "IgniteCacheRestartTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "CacheGetFromJobTest.java"
        ]
    },
    "ignite_5c8d9ff": {
        "bug_id": "ignite_5c8d9ff",
        "commit": "https://github.com/apache/ignite/commit/5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4",
        "file": [
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/ignite/blob/5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java?ref=5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4",
                "deletions": 9,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "patch": "@@ -3110,6 +3110,8 @@ private void doCheckpoint() {\n \n                 boolean success = false;\n \n+                int destroyedPartitionsCnt;\n+\n                 try {\n                     if (chp.hasDelta()) {\n                         // Identity stores set.\n@@ -3196,7 +3198,7 @@ private void doCheckpoint() {\n                     snapshotMgr.afterCheckpointPageWritten();\n \n                     try {\n-                        destroyEvictedPartitions();\n+                        destroyedPartitionsCnt = destroyEvictedPartitions();\n                     }\n                     catch (IgniteCheckedException e) {\n                         chp.progress.cpFinishFut.onDone(e);\n@@ -3216,15 +3218,15 @@ private void doCheckpoint() {\n \n                 tracker.onEnd();\n \n-                if (chp.hasDelta()) {\n+                if (chp.hasDelta() || destroyedPartitionsCnt > 0) {\n                     if (printCheckpointStats) {\n                         if (log.isInfoEnabled())\n                             log.info(String.format(\"Checkpoint finished [cpId=%s, pages=%d, markPos=%s, \" +\n                                     \"walSegmentsCleared=%d, markDuration=%dms, pagesWrite=%dms, fsync=%dms, \" +\n                                     \"total=%dms]\",\n-                                chp.cpEntry.checkpointId(),\n+                                chp.cpEntry != null ? chp.cpEntry.checkpointId() : \"\",\n                                 chp.pagesSize,\n-                                chp.cpEntry.checkpointMark(),\n+                                chp.cpEntry != null ? chp.cpEntry.checkpointMark() : \"\",\n                                 chp.walFilesDeleted,\n                                 tracker.markDuration(),\n                                 tracker.pagesWriteDuration(),\n@@ -3264,12 +3266,14 @@ private void doCheckpoint() {\n          * Processes all evicted partitions scheduled for destroy.\n          *\n          * @throws IgniteCheckedException If failed.\n+         *\n+         * @return The number of destroyed partition files.\n          */\n-        private void destroyEvictedPartitions() throws IgniteCheckedException {\n+        private int destroyEvictedPartitions() throws IgniteCheckedException {\n             PartitionDestroyQueue destroyQueue = curCpProgress.destroyQueue;\n \n             if (destroyQueue.pendingReqs.isEmpty())\n-                return;\n+                return 0;\n \n             List<PartitionDestroyRequest> reqs = null;\n \n@@ -3327,6 +3331,8 @@ private void destroyEvictedPartitions() throws IgniteCheckedException {\n                     req.waitCompleted();\n \n             destroyQueue.pendingReqs.clear();\n+\n+            return reqs != null ? reqs.size() : 0;\n         }\n \n         /**\n@@ -3495,7 +3501,7 @@ private Checkpoint markCheckpointBegin(CheckpointMetricsTracker tracker) throws\n \n                 hasPages = hasPageForWrite(cpPagesTuple.get1());\n \n-                if (hasPages || curr.nextSnapshot) {\n+                if (hasPages || curr.nextSnapshot || !curr.destroyQueue.pendingReqs.isEmpty()) {\n                     // No page updates for this checkpoint are allowed from now on.\n                     cpPtr = cctx.wal().log(cpRec);\n \n@@ -3874,7 +3880,7 @@ private WriteCheckpointPages(\n      */\n     private static class Checkpoint {\n         /** Checkpoint entry. */\n-        private final CheckpointEntry cpEntry;\n+        @Nullable private final CheckpointEntry cpEntry;\n \n         /** Checkpoint pages. */\n         private final GridMultiCollectionWrapper<FullPageId> cpPages;\n@@ -3894,7 +3900,7 @@ private WriteCheckpointPages(\n          * @param progress Checkpoint progress status.\n          */\n         private Checkpoint(\n-            CheckpointEntry cpEntry,\n+            @Nullable CheckpointEntry cpEntry,\n             @NotNull GridMultiCollectionWrapper<FullPageId> cpPages,\n             CheckpointProgress progress\n         ) {",
                "raw_url": "https://github.com/apache/ignite/raw/5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "sha": "2eb6e6ffb1dd3acd7cb904c2a31c85597926766f",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/ignite/blob/5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsPartitionFilesDestroyTest.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsPartitionFilesDestroyTest.java?ref=5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsPartitionFilesDestroyTest.java",
                "patch": "@@ -19,6 +19,7 @@\n import java.io.File;\n import java.io.IOException;\n import java.nio.file.OpenOption;\n+import java.util.List;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n import org.apache.ignite.IgniteCheckedException;\n@@ -332,6 +333,33 @@ public void testPartitionFileDestroyCrashRecovery2() throws Exception {\n             checkData((IgniteEx) ignite, keysCnt, 1);\n     }\n \n+    /**\n+     * Test destroy when partition files are empty and there are no pages for checkpoint.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testDestroyWhenPartitionsAreEmpty() throws Exception {\n+        IgniteEx crd = (IgniteEx) startGrids(2);\n+\n+        crd.cluster().active(true);\n+\n+        forceCheckpoint();\n+\n+        // Evict arbitrary partition.\n+        List<GridDhtLocalPartition> parts = crd.cachex(CACHE).context().topology().localPartitions();\n+        for (GridDhtLocalPartition part : parts)\n+            if (part.state() != GridDhtPartitionState.EVICTED) {\n+                part.rent(false).get();\n+\n+                break;\n+            }\n+\n+        // This checkpoint has no pages to write, but has one partition file to destroy.\n+        forceCheckpoint(crd);\n+\n+        checkPartitionFiles(crd, false);\n+    }\n+\n     /**\n      * If {@code exists} is {@code true}, checks that all partition files exist\n      * if partition has state EVICTED.",
                "raw_url": "https://github.com/apache/ignite/raw/5c8d9ffa20fbe4497c5cd96a11f315df2baa9ba4/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgnitePdsPartitionFilesDestroyTest.java",
                "sha": "5e0ccc9ce1fc84e72b36b1c0674dcb165f9a8e52",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8531 Fixed NPE if checkpoint has no pages to write, but has partitions to destroy. - Fixes #4026.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/c2285c73c8ad0aad154f06e4b0adaf05685d37b1",
        "patched_files": [
            "GridCacheDatabaseSharedManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgnitePdsPartitionFilesDestroyTest.java"
        ]
    },
    "ignite_5f9a1e6": {
        "bug_id": "ignite_5f9a1e6",
        "commit": "https://github.com/apache/ignite/commit/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java?ref=5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java",
                "patch": "@@ -732,7 +732,7 @@ private static void sleepEx(long millis, Runnable before, Runnable after) throws\n                     TcpDiscoveryNode node = locNode;\n \n                     if (locNode.order() > 0) {\n-                        node = locNode.clientReconnectNode(spi.spiCtx.nodeAttributes());\n+                        node = locNode.clientReconnectNode(spi.locNodeAttrs);\n \n                         marshalCredentials(node);\n                     }",
                "raw_url": "https://github.com/apache/ignite/raw/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ClientImpl.java",
                "sha": "e094151dfc7aeed5e99e66082b185b26973ff192",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpi.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpi.java?ref=5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a",
                "deletions": 0,
                "filename": "modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpi.java",
                "patch": "@@ -501,6 +501,13 @@ public DiscoverySpiNodeAuthenticator getAuthenticator() {\n             impl.stop();\n     }\n \n+    /**\n+     * @return Local node attributes\n+     */\n+    public Map<String, Object> getLocNodeAttrs() {\n+        return locNodeAttrs;\n+    }\n+\n     /**\n      * @return Local node instance.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpi.java",
                "sha": "222b73bb10e581dd478102397d433a3b5fbe1f0d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java?ref=5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a",
                "deletions": 1,
                "filename": "modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java",
                "patch": "@@ -740,7 +740,7 @@ private void joinTopology(@Nullable ZkRuntimeState prevState) throws Interrupted\n                 internalLsnr.beforeJoin(locNode, log);\n \n             if (locNode.isClient() && reconnect)\n-                locNode.setAttributes(spi.getSpiContext().nodeAttributes());\n+                locNode.setAttributes(spi.getLocNodeAttrs());\n \n             marshalCredentialsOnJoin(locNode);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/5f9a1e68c2575ef8bf16ae188036bc6ef9620b9a/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java",
                "sha": "fa218fff4f2aa9e767d854815b01d704aa6f68c1",
                "status": "modified"
            }
        ],
        "message": "IGNITE-10513 Fix NullPointerException on reconnect for TCP/Zookeeper Discovery SPIs - Fixes #5557.\n\nSigned-off-by: Ilya Kasnacheev <ilya.kasnacheev@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/f0544d46a00447bd15f1121a0f97747ba37bd718",
        "patched_files": [
            "ZookeeperDiscoverySpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "ZookeeperDiscoverySpiTest.java"
        ]
    },
    "ignite_631ff3a": {
        "bug_id": "ignite_631ff3a",
        "commit": "https://github.com/apache/ignite/commit/631ff3ad082330ec7b8165271be131399a2d8957",
        "file": [
            {
                "additions": 86,
                "blob_url": "https://github.com/apache/ignite/blob/631ff3ad082330ec7b8165271be131399a2d8957/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalPathsTest.java",
                "changes": 86,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalPathsTest.java?ref=631ff3ad082330ec7b8165271be131399a2d8957",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalPathsTest.java",
                "patch": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.wal;\n+\n+import java.io.File;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/** Tests equal paths to WAL storage and WAL archive. */\n+public class WalPathsTest extends GridCommonAbstractTest {\n+    /** WalPath and WalArchivePath. */\n+    private File walDir;\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids();\n+\n+        U.delete(walDir);\n+    }\n+\n+    /**\n+     * @param relativePath {@code True} - if wal archive path should be relative, {@code false} - for absolute path.\n+     * @return Ignite configuration with the same path to wal store and wal archive.\n+     * @throws Exception If failed.\n+     */\n+    private IgniteConfiguration getConfig(boolean relativePath) throws Exception {\n+        IgniteConfiguration cfg = getConfiguration();\n+\n+        DataStorageConfiguration dsCfg = new DataStorageConfiguration();\n+\n+        dsCfg.setDefaultDataRegionConfiguration(new DataRegionConfiguration()\n+            .setPersistenceEnabled(true)\n+            .setMaxSize(200 * 1024 * 1024));\n+\n+        walDir = new File(U.defaultWorkDirectory(), getClass().getSimpleName());\n+\n+        dsCfg.setWalPath(walDir.getAbsolutePath());\n+        dsCfg.setWalArchivePath(relativePath ? getClass().getSimpleName() : walDir.getAbsolutePath());\n+\n+        cfg.setDataStorageConfiguration(dsCfg);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests equal paths to the same directory.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testWalStoreAndArchivePathsEquality() throws Exception {\n+        IgniteConfiguration cfg = getConfig(false);\n+\n+        startGrid(cfg);\n+    }\n+\n+    /**\n+     * Tests absolute and relative paths to the same directory.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testWalStoreAndArchiveAbsolutAndRelativePathsEquality() throws Exception {\n+        final IgniteConfiguration cfg = getConfig(true);\n+\n+        startGrid(cfg);\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/631ff3ad082330ec7b8165271be131399a2d8957/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalPathsTest.java",
                "sha": "7141fed0807f47c70546988fb2b93e5db4da4e77",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/631ff3ad082330ec7b8165271be131399a2d8957/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java?ref=631ff3ad082330ec7b8165271be131399a2d8957",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "patch": "@@ -33,6 +33,7 @@\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.IgniteWalRecoveryPPCTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.IgniteWalRecoveryTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.IgniteWalRecoveryWithCompactionTest;\n+import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalPathsTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRecoveryTxLogicalRecordsTest;\n \n /**\n@@ -50,6 +51,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(IgnitePdsPageEvictionTest.class);\n         suite.addTestSuite(IgnitePdsMultiNodePutGetRestartTest.class);\n         suite.addTestSuite(IgnitePersistentStoreCacheGroupsTest.class);\n+        suite.addTestSuite(WalPathsTest.class);\n         suite.addTestSuite(WalRecoveryTxLogicalRecordsTest.class);\n \n         suite.addTestSuite(IgniteWalRecoveryTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/631ff3ad082330ec7b8165271be131399a2d8957/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "sha": "447b622f451ee19a66e4ce53bf604352a9d6f2e9",
                "status": "modified"
            }
        ],
        "message": "IGNITE-6802 Test of NullPointerException when WAL store and WAL archive paths are same - Fixes #3021.\n\nSigned-off-by: dpavlov <dpavlov@gridgain.com>",
        "parent": "https://github.com/apache/ignite/commit/6875ac3e069358af43586ad7068cfb7c50d8c08f",
        "patched_files": [
            "IgnitePdsWithIndexingCoreTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "WalPathsTest.java"
        ]
    },
    "ignite_646e5f8": {
        "bug_id": "ignite_646e5f8",
        "commit": "https://github.com/apache/ignite/commit/646e5f8c6339b0d055ac7976e421d3c25a5f3b05",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java?ref=646e5f8c6339b0d055ac7976e421d3c25a5f3b05",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "patch": "@@ -890,9 +890,12 @@ else if (msg instanceof WalStateAbstractMessage)\n                 exchLog.info(\"Finished exchange init [topVer=\" + topVer + \", crd=\" + crdNode + ']');\n         }\n         catch (IgniteInterruptedCheckedException e) {\n-            assert cctx.kernalContext().isStopping();\n+            assert cctx.kernalContext().isStopping() || cctx.kernalContext().clientDisconnected();\n \n-            onDone(new IgniteCheckedException(\"Node stopped\"));\n+            if (cctx.kernalContext().clientDisconnected())\n+                onDone(new IgniteCheckedException(\"Client disconnected\"));\n+            else\n+                onDone(new IgniteCheckedException(\"Node stopped\"));\n \n             throw e;\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "sha": "3ebfc6e39b8c4910df5606a333e02364edea5747",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java?ref=646e5f8c6339b0d055ac7976e421d3c25a5f3b05",
                "deletions": 3,
                "filename": "modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java",
                "patch": "@@ -569,7 +569,7 @@ private void notifySegmented() {\n     public boolean allNodesSupport(IgniteFeatures feature) {\n         checkState();\n \n-        return rtState.top.isAllNodes(n -> IgniteFeatures.nodeSupports(n, feature));\n+        return rtState != null && rtState.top.isAllNodes(n -> IgniteFeatures.nodeSupports(n, feature));\n     }\n \n     /**\n@@ -2022,7 +2022,7 @@ private void processJoinError(String aliveNodePath,\n     }\n \n     /**\n-     * @param node Joining node data.\n+     * @param joiningNodeData Joining node data.\n      * @return Validation result.\n      */\n     private ZkNodeValidateResult validateJoiningNode(ZkJoiningNodeData joiningNodeData) {\n@@ -4468,7 +4468,7 @@ private void processResult0(int rc, String path, byte[] data) throws Exception {\n             id = IgniteUuid.fromUuid(node.id());\n \n             endTime = System.currentTimeMillis() + node.sessionTimeout() + 1000;\n-        };\n+        }\n \n         /** {@inheritDoc} */\n         @Override public IgniteUuid id() {",
                "raw_url": "https://github.com/apache/ignite/raw/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java",
                "sha": "04f158662b1f5d4851bab72eb932be5eb0379ad0",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpiTestSuite1.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpiTestSuite1.java?ref=646e5f8c6339b0d055ac7976e421d3c25a5f3b05",
                "deletions": 7,
                "filename": "modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpiTestSuite1.java",
                "patch": "@@ -19,17 +19,17 @@\n \n import org.apache.curator.test.ByteCodeRewrite;\n import org.apache.ignite.spi.discovery.zk.internal.ZookeeperClientTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryClientDisconnectTest;\n import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryClientReconnectTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoverySpiSaslFailedAuthTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoverySpiSaslSuccessfulAuthTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryCommunicationFailureTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryConcurrentStartAndStartStopTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryCustomEventsTest;\n import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryMiscTest;\n import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoverySegmentationAndConnectionRestoreTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryConcurrentStartAndStartStopTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryTopologyChangeAndReconnectTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryCommunicationFailureTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryClientDisconnectTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoverySpiSaslFailedAuthTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoverySpiSaslSuccessfulAuthTest;\n import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoverySplitBrainTest;\n-import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryCustomEventsTest;\n+import org.apache.ignite.spi.discovery.zk.internal.ZookeeperDiscoveryTopologyChangeAndReconnectTest;\n import org.apache.zookeeper.jmx.MBeanRegistry;\n import org.apache.zookeeper.server.ZooKeeperServer;\n import org.apache.zookeeper.server.quorum.LearnerZooKeeperServer;",
                "raw_url": "https://github.com/apache/ignite/raw/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/ZookeeperDiscoverySpiTestSuite1.java",
                "sha": "f8a5f361a88861e1addb18adec9d9e6372b27e54",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryClientReconnectTest.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryClientReconnectTest.java?ref=646e5f8c6339b0d055ac7976e421d3c25a5f3b05",
                "deletions": 8,
                "filename": "modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryClientReconnectTest.java",
                "patch": "@@ -17,19 +17,17 @@\n \n package org.apache.ignite.spi.discovery.zk.internal;\n \n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.concurrent.atomic.AtomicInteger;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.util.lang.GridAbsPredicate;\n import org.apache.ignite.lang.IgniteInClosure;\n import org.apache.ignite.testframework.GridTestUtils;\n-import org.junit.Ignore;\n import org.junit.Test;\n \n-import java.util.concurrent.Callable;\n-import java.util.concurrent.CountDownLatch;\n-import java.util.concurrent.ThreadLocalRandom;\n-import java.util.concurrent.atomic.AtomicInteger;\n-\n import static java.util.concurrent.TimeUnit.SECONDS;\n import static org.apache.ignite.events.EventType.EVT_CLIENT_NODE_DISCONNECTED;\n \n@@ -40,7 +38,6 @@\n     /**\n      * @throws Exception If failed.\n      */\n-    @Ignore(\"https://issues.apache.org/jira/browse/IGNITE-8178\")\n     @Test\n     public void testReconnectServersRestart_1() throws Exception {\n         reconnectServersRestart(1);\n@@ -49,11 +46,11 @@ public void testReconnectServersRestart_1() throws Exception {\n     /**\n      * @throws Exception If failed.\n      */\n-    @Ignore(\"https://issues.apache.org/jira/browse/IGNITE-8178\")\n     @Test\n     public void testReconnectServersRestart_2() throws Exception {\n         reconnectServersRestart(3);\n     }\n+\n     /**\n      * @throws Exception If failed.\n      */\n@@ -141,6 +138,8 @@ public void testReconnectServersRestart_4() throws Exception {\n      * @throws Exception If failed.\n      */\n     private void reconnectServersRestart(int srvs) throws Exception {\n+        sesTimeout = 30_000;\n+\n         startGridsMultiThreaded(srvs);\n \n         helper.clientMode(true);",
                "raw_url": "https://github.com/apache/ignite/raw/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryClientReconnectTest.java",
                "sha": "03daa01a3764f40ef1a77c47a764d71d6d2f456c",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoverySpiTestBase.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoverySpiTestBase.java?ref=646e5f8c6339b0d055ac7976e421d3c25a5f3b05",
                "deletions": 2,
                "filename": "modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoverySpiTestBase.java",
                "patch": "@@ -432,13 +432,13 @@ private void clearAckEveryEventSystemProperty() {\n                 private UUID nodeId = currNodeId;\n \n                 @Override public boolean apply(Event evt) {\n-                    if(evt.type() == EVT_CLIENT_NODE_RECONNECTED){\n+                    if (evt.type() == EVT_CLIENT_NODE_RECONNECTED) {\n                         evts.remove(nodeId);\n \n                         nodeId = evt.node().id();\n                     }\n \n-                    return false;\n+                    return true;\n                 }\n             }, new int[] {EVT_CLIENT_NODE_RECONNECTED});\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/646e5f8c6339b0d055ac7976e421d3c25a5f3b05/modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoverySpiTestBase.java",
                "sha": "08d89351b1515e57784ddb0a86a3fc109ec46a24",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8178 ZookeeperDiscoverySpiTest#testReconnectServersRestart* tests fail on TC (#5755)\n\n* Fix NPE. Fix clear client reconnect event.\r\n\r\n* Test with mvcc fix\r\n\r\n* Clear debug\r\n\r\n* Fix mvcc disconnected flag\r\n\r\n* Fix disconnected flag(use reconnected event)\r\n\r\n* Hard synchronizing\r\n\r\n* Optimizing synchronization\r\n\r\n* Fix NPE\r\n\r\n* Cleanup debug.",
        "parent": "https://github.com/apache/ignite/commit/6008a0af5f8bb8051aca7cbc67878c138097d6df",
        "patched_files": [
            "GridDhtPartitionsExchangeFuture.java",
            "ZookeeperDiscoverySpiTestBase.java",
            "ZookeeperDiscoveryImpl.java",
            "ZookeeperDiscoverySpiTestSuite1.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "ZookeeperDiscoveryClientReconnectTest.java"
        ]
    },
    "ignite_69adfd5": {
        "bug_id": "ignite_69adfd5",
        "commit": "https://github.com/apache/ignite/commit/69adfd5e94530457525bd0403182f577b418ca95",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/69adfd5e94530457525bd0403182f577b418ca95/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FileWriteAheadLogManager.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FileWriteAheadLogManager.java?ref=69adfd5e94530457525bd0403182f577b418ca95",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FileWriteAheadLogManager.java",
                "patch": "@@ -2412,19 +2412,23 @@ else if (create)\n     private abstract static class FileHandle {\n         /** I/O interface for read/write operations with file */\n         SegmentIO fileIO;\n+        \n+        /** Segment idx corresponded to fileIo*/\n+        final long segmentIdx;\n \n         /**\n-         * @param fileIO I/O interface for read/write operations of FileHandle.         *\n+         * @param fileIO I/O interface for read/write operations of FileHandle.\n          */\n-        private FileHandle(SegmentIO fileIO) {\n+        private FileHandle(@NotNull SegmentIO fileIO) {\n             this.fileIO = fileIO;\n+            segmentIdx = fileIO.getSegmentId();\n         }\n \n         /**\n          * @return Absolute WAL segment file index (incremental counter).\n          */\n         public long getSegmentId(){\n-            return fileIO.getSegmentId();\n+            return segmentIdx;\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/69adfd5e94530457525bd0403182f577b418ca95/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FileWriteAheadLogManager.java",
                "sha": "8388bb2b77a36cb6a4c28484b68fed2e046fd24a",
                "status": "modified"
            },
            {
                "additions": 156,
                "blob_url": "https://github.com/apache/ignite/blob/69adfd5e94530457525bd0403182f577b418ca95/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java",
                "changes": 156,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java?ref=69adfd5e94530457525bd0403182f577b418ca95",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java",
                "patch": "@@ -0,0 +1,156 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.wal;\n+\n+import java.util.concurrent.ThreadLocalRandom;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.StopNodeOrHaltFailureHandler;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.internal.IgniteInterruptedCheckedException;\n+import org.apache.ignite.internal.pagemem.wal.IgniteWriteAheadLogManager;\n+import org.apache.ignite.internal.pagemem.wal.record.CheckpointRecord;\n+import org.apache.ignite.internal.processors.cache.persistence.IgniteCacheDatabaseSharedManager;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+import static org.apache.ignite.configuration.DataStorageConfiguration.DFLT_WAL_PATH;\n+import static org.apache.ignite.configuration.WALMode.LOG_ONLY;\n+/**\n+ *\n+ */\n+public class WalRolloverRecordLoggingTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final TcpDiscoveryIpFinder IP_FINDER = new TcpDiscoveryVmIpFinder(true);\n+\n+    /** */\n+    private static class RolloverRecord extends CheckpointRecord {\n+        /** */\n+        private RolloverRecord() {\n+            super(null);\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public boolean rollOver() {\n+            return true;\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String name) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(name);\n+\n+        cfg.setDiscoverySpi(new TcpDiscoverySpi().setIpFinder(IP_FINDER));\n+\n+        cfg.setDataStorageConfiguration(new DataStorageConfiguration()\n+            .setDefaultDataRegionConfiguration(new DataRegionConfiguration()\n+                .setPersistenceEnabled(true)\n+                .setMaxSize(40 * 1024 * 1024))\n+            .setWalMode(LOG_ONLY)\n+            .setWalSegmentSize(4 * 1024 * 1024)\n+            .setWalArchivePath(DFLT_WAL_PATH));\n+\n+        cfg.setFailureHandler(new StopNodeOrHaltFailureHandler(false, 0));\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** */\n+    public void testAvoidInfinityWaitingOnRolloverOfSegment() throws Exception {\n+        IgniteEx ig = startGrid(0);\n+\n+        ig.cluster().active(true);\n+\n+        IgniteCache<Integer, Integer> cache = ig.getOrCreateCache(DEFAULT_CACHE_NAME);\n+\n+        long startTime = U.currentTimeMillis();\n+        long duration = 5_000;\n+\n+        IgniteInternalFuture<Long> fut = GridTestUtils.runMultiThreadedAsync(\n+            () -> {\n+                ThreadLocalRandom random = ThreadLocalRandom.current();\n+\n+                while (U.currentTimeMillis() - startTime < duration)\n+                    cache.put(random.nextInt(100_000), random.nextInt(100_000));\n+            },\n+            8, \"cache-put-thread\");\n+\n+        Thread t = new Thread(() -> {\n+            do {\n+                try {\n+                    U.sleep(100);\n+                }\n+                catch (IgniteInterruptedCheckedException e) {\n+                    // No-op.\n+                }\n+\n+                ig.context().cache().context().database().wakeupForCheckpoint(\"test\");\n+            } while (U.currentTimeMillis() - startTime < duration);\n+        });\n+\n+        t.start();\n+\n+        IgniteWriteAheadLogManager walMgr = ig.context().cache().context().wal();\n+\n+        IgniteCacheDatabaseSharedManager dbMgr = ig.context().cache().context().database();\n+\n+        RolloverRecord rec = new RolloverRecord();\n+\n+        do {\n+            try {\n+                dbMgr.checkpointReadLock();\n+\n+                try {\n+                    walMgr.log(rec);\n+                }\n+                finally {\n+                    dbMgr.checkpointReadUnlock();\n+                }\n+            }\n+            catch (IgniteCheckedException e) {\n+                log.error(e.getMessage(), e);\n+            }\n+        } while (U.currentTimeMillis() - startTime < duration);\n+\n+        fut.get();\n+\n+        t.join();\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/69adfd5e94530457525bd0403182f577b418ca95/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java",
                "sha": "67caf6350664134bb2ad80867a0db64d59391044",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/69adfd5e94530457525bd0403182f577b418ca95/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java?ref=69adfd5e94530457525bd0403182f577b418ca95",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "patch": "@@ -40,6 +40,7 @@\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.IgniteWalRecoveryWithCompactionTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalPathsTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRecoveryTxLogicalRecordsTest;\n+import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRolloverRecordLoggingTest;\n \n /**\n  * Test suite for tests that cover core PDS features and depend on indexing module.\n@@ -59,6 +60,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(PersistenceDirectoryWarningLoggingTest.class);\n         suite.addTestSuite(WalPathsTest.class);\n         suite.addTestSuite(WalRecoveryTxLogicalRecordsTest.class);\n+        suite.addTestSuite(WalRolloverRecordLoggingTest.class);\n \n         suite.addTestSuite(IgniteWalRecoveryTest.class);\n         suite.addTestSuite(IgniteWalRecoveryWithCompactionTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/69adfd5e94530457525bd0403182f577b418ca95/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "sha": "caea388359d11df3968e756fb8eeab49ca88fcc8",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9731 Fixed NPE on concurrent WAL flush - Fixes #4863.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/036bd074d8bfd25a2c4c463a60dde00604d11b9d",
        "patched_files": [
            "IgnitePdsWithIndexingCoreTestSuite.java",
            "FileWriteAheadLogManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "WalRolloverRecordLoggingTest.java"
        ]
    },
    "ignite_7256e57": {
        "bug_id": "ignite_7256e57",
        "commit": "https://github.com/apache/ignite/commit/7256e5752084118fc1530eb1893ffab8ba733e0c",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/7256e5752084118fc1530eb1893ffab8ba733e0c/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/CachePartitionPartialCountersMap.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/CachePartitionPartialCountersMap.java?ref=7256e5752084118fc1530eb1893ffab8ba733e0c",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/CachePartitionPartialCountersMap.java",
                "patch": "@@ -53,7 +53,7 @@\n \n     /** */\n     private CachePartitionPartialCountersMap() {\n-        // Empty map.\n+        this(0);\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/7256e5752084118fc1530eb1893ffab8ba733e0c/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/CachePartitionPartialCountersMap.java",
                "sha": "986a100222ac6f937c072f96f99bed8bbf8b8a36",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/ignite/blob/7256e5752084118fc1530eb1893ffab8ba733e0c/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/CachePartitionPartialCountersMapSelfTest.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/CachePartitionPartialCountersMapSelfTest.java?ref=7256e5752084118fc1530eb1893ffab8ba733e0c",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/CachePartitionPartialCountersMapSelfTest.java",
                "patch": "@@ -23,9 +23,12 @@\n import org.junit.runner.RunWith;\n import org.junit.runners.JUnit4;\n \n+/**\n+ *\n+ */\n @RunWith(JUnit4.class)\n public class CachePartitionPartialCountersMapSelfTest extends GridCommonAbstractTest {\n-\n+    /** */\n     @Test\n     public void testAddAndRemove() throws Exception {\n         CachePartitionPartialCountersMap map = new CachePartitionPartialCountersMap(10);\n@@ -59,4 +62,15 @@ public void testAddAndRemove() throws Exception {\n         }\n     }\n \n+    /** */\n+    @Test\n+    public void testEmptyMap() throws Exception {\n+        CachePartitionPartialCountersMap map = CachePartitionPartialCountersMap.EMPTY;\n+\n+        assertFalse(map.remove(1));\n+\n+        map.trim();\n+\n+        assertNotNull(map.toString());\n+    }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/7256e5752084118fc1530eb1893ffab8ba733e0c/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/dht/CachePartitionPartialCountersMapSelfTest.java",
                "sha": "08c62598eaea4ad2fe3e47c183270a3e6f93684b",
                "status": "modified"
            }
        ],
        "message": "IGNITE-10385 Avoid NPE by replacing null fields with zero-length arrays - Fixes #5487.\n\nSigned-off-by: Ilya Kasnacheev <ilya.kasnacheev@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/0b3718f6050290b1c2ec0c070eb207d65eba671c",
        "patched_files": [
            "CachePartitionPartialCountersMap.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "CachePartitionPartialCountersMapSelfTest.java"
        ]
    },
    "ignite_7376da3": {
        "bug_id": "ignite_7376da3",
        "commit": "https://github.com/apache/ignite/commit/7376da38672962b7083932c7bc418742a4335628",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/7376da38672962b7083932c7bc418742a4335628/modules/core/src/main/java/org/gridgain/grid/kernal/processors/cache/GridCacheGateway.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/gridgain/grid/kernal/processors/cache/GridCacheGateway.java?ref=7376da38672962b7083932c7bc418742a4335628",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/gridgain/grid/kernal/processors/cache/GridCacheGateway.java",
                "patch": "@@ -79,7 +79,15 @@ public void leave() {\n      */\n     @Nullable public GridCacheProjectionImpl<K, V> enter(@Nullable GridCacheProjectionImpl<K, V> prj) {\n         try {\n-            ctx.preloader().startFuture().get();\n+            GridCacheAdapter<K, V> cache = ctx.cache();\n+\n+            GridCachePreloader<K, V> preldr = cache != null ? cache.preloader() : null;\n+\n+            if (preldr == null)\n+                throw new IllegalStateException(\"Grid is in invalid state to perform this operation. \" +\n+                    \"It either not started yet or has already being or have stopped [gridName=\" + ctx.gridName() + ']');\n+\n+            preldr.startFuture().get();\n         }\n         catch (GridException e) {\n             throw new GridRuntimeException(\"Failed to wait for cache preloader start [cacheName=\" +",
                "raw_url": "https://github.com/apache/ignite/raw/7376da38672962b7083932c7bc418742a4335628/modules/core/src/main/java/org/gridgain/grid/kernal/processors/cache/GridCacheGateway.java",
                "sha": "18f4829ee8bb3a3ce3d649e9fb99032fc68e0570",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/ignite/blob/7376da38672962b7083932c7bc418742a4335628/modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/GridCacheStopSelfTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/GridCacheStopSelfTest.java?ref=7376da38672962b7083932c7bc418742a4335628",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/GridCacheStopSelfTest.java",
                "patch": "@@ -175,6 +175,16 @@ private void testStop(final boolean startTx) throws Exception {\n                     assertTrue(\"Unexpected error message: \" + e.getMessage(), e.getMessage().startsWith(EXPECTED_MSG));\n                 }\n             }\n+\n+            try {\n+                cache.put(1, 1);\n+            }\n+            catch (IllegalStateException e) {\n+                if (!e.getMessage().startsWith(EXPECTED_MSG))\n+                    e.printStackTrace();\n+\n+                assertTrue(\"Unexpected error message: \" + e.getMessage(), e.getMessage().startsWith(EXPECTED_MSG));\n+            }\n         }\n     }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/7376da38672962b7083932c7bc418742a4335628/modules/core/src/test/java/org/gridgain/grid/kernal/processors/cache/GridCacheStopSelfTest.java",
                "sha": "93b473a59a511b7af6a542b8052a2970ef58a7ed",
                "status": "modified"
            }
        ],
        "message": "# GG-7944 NPE in GridCacheGateway",
        "parent": "https://github.com/apache/ignite/commit/b65e33d1dcb06d6499c5e87bf1aadcd46084aca2",
        "patched_files": [
            "GridCacheGateway.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheStopSelfTest.java"
        ]
    },
    "ignite_746f8eb": {
        "bug_id": "ignite_746f8eb",
        "commit": "https://github.com/apache/ignite/commit/746f8ebc2e56720b50873af1b4ee2a320ca58793",
        "file": [
            {
                "additions": 24,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/DynamicCacheDescriptor.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/DynamicCacheDescriptor.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/DynamicCacheDescriptor.java",
                "patch": "@@ -20,9 +20,11 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.UUID;\n+import org.apache.ignite.IgniteCheckedException;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.internal.GridKernalContext;\n import org.apache.ignite.internal.processors.affinity.AffinityTopologyVersion;\n+import org.apache.ignite.internal.processors.cacheobject.IgniteCacheObjectProcessor;\n import org.apache.ignite.internal.processors.plugin.CachePluginManager;\n import org.apache.ignite.internal.processors.query.QuerySchema;\n import org.apache.ignite.internal.processors.query.schema.message.SchemaFinishDiscoveryMessage;\n@@ -83,6 +85,12 @@\n     /** */\n     private AffinityTopologyVersion rcvdFromVer;\n \n+    /** Mutex. */\n+    private final Object mux = new Object();\n+\n+    /** Cached object context for marshalling issues when cache isn't started. */\n+    private volatile CacheObjectContext objCtx;\n+\n     /** */\n     private transient AffinityTopologyVersion clientCacheStartVer;\n \n@@ -227,6 +235,22 @@ public CacheConfiguration cacheConfiguration() {\n         return cacheCfg;\n     }\n \n+    /**\n+     * Creates and caches cache object context if needed.\n+     *\n+     * @param proc Object processor.\n+     */\n+    public CacheObjectContext cacheObjectContext(IgniteCacheObjectProcessor proc) throws IgniteCheckedException {\n+        if (objCtx == null) {\n+            synchronized (mux) {\n+                if (objCtx == null)\n+                    objCtx = proc.contextForCache(cacheCfg);\n+            }\n+        }\n+\n+        return objCtx;\n+    }\n+\n     /**\n      * @return Cache plugin manager.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/DynamicCacheDescriptor.java",
                "sha": "09b4c3a52dc41c5e05623ae70685eee9bc3d39d8",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java",
                "patch": "@@ -22,8 +22,6 @@\n import java.util.List;\n import java.util.ListIterator;\n import java.util.UUID;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicIntegerArray;\n import org.apache.ignite.IgniteCheckedException;\n@@ -447,6 +445,22 @@ public boolean closed(GridCacheContext ctx) {\n         return ctxMap.get(cacheId);\n     }\n \n+    /**\n+     * Returns cache object context if created or creates new and caches it until cache started.\n+     *\n+     * @param cacheId Cache id.\n+     */\n+    public @Nullable CacheObjectContext cacheObjectContext(int cacheId) throws IgniteCheckedException {\n+        GridCacheContext<K, V> ctx = ctxMap.get(cacheId);\n+\n+        if (ctx != null)\n+            return ctx.cacheObjectContext();\n+\n+        DynamicCacheDescriptor desc = cache().cacheDescriptor(cacheId);\n+\n+        return desc != null ? desc.cacheObjectContext(kernalContext().cacheObjects()) : null;\n+    }\n+\n     /**\n      * @return Ignite instance name.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedContext.java",
                "sha": "55f3c42b0fa94cda7041f4e2d7b6b7270935d6b0",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 5,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java",
                "patch": "@@ -2409,11 +2409,18 @@ private CommitListener(IgniteInternalTx tx) {\n         @Override public void onMessage(UUID nodeId, Object msg) {\n             GridCacheMessage cacheMsg = (GridCacheMessage)msg;\n \n-            unmarshall(nodeId, cacheMsg);\n+            Throwable err = null;\n \n-            if (cacheMsg.classError() != null) {\n+            try {\n+                unmarshall(nodeId, cacheMsg);\n+            }\n+            catch (Exception e) {\n+                err = e;\n+            }\n+\n+            if (err != null || cacheMsg.classError() != null) {\n                 try {\n-                    processFailedMessage(nodeId, cacheMsg);\n+                    processFailedMessage(nodeId, cacheMsg, err);\n                 }\n                 catch(Throwable e){\n                     U.error(log, \"Failed to process message [senderId=\" + nodeId +\n@@ -2466,7 +2473,7 @@ else if (msg instanceof TxLocksResponse) {\n          * @param nodeId Node ID.\n          * @param msg Message.\n          */\n-        private void processFailedMessage(UUID nodeId, GridCacheMessage msg) throws IgniteCheckedException {\n+        private void processFailedMessage(UUID nodeId, GridCacheMessage msg, Throwable err) throws IgniteCheckedException {\n             switch (msg.directType()) {\n                 case -24: {\n                     TxLocksRequest req = (TxLocksRequest)msg;\n@@ -2498,7 +2505,10 @@ private void processFailedMessage(UUID nodeId, GridCacheMessage msg) throws Igni\n                         return;\n                     }\n \n-                    fut.onResult(nodeId, res);\n+                    if (err == null)\n+                        fut.onResult(nodeId, res);\n+                    else\n+                        fut.onDone(null, err);\n                 }\n \n                 break;",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java",
                "sha": "db0395f70390df65944c456f2bdfa9413e3a793d",
                "status": "modified"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlock.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlock.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 5,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlock.java",
                "patch": "@@ -21,11 +21,10 @@\n import java.util.Map;\n import java.util.Set;\n import java.util.UUID;\n-import org.apache.ignite.internal.processors.cache.GridCacheContext;\n+import org.apache.ignite.internal.processors.cache.CacheObjectContext;\n import org.apache.ignite.internal.processors.cache.GridCacheSharedContext;\n import org.apache.ignite.internal.processors.cache.version.GridCacheVersion;\n import org.apache.ignite.internal.util.typedef.T2;\n-import org.apache.ignite.internal.util.typedef.internal.CU;\n import org.apache.ignite.internal.util.typedef.internal.U;\n \n /**\n@@ -133,11 +132,21 @@ public String toString(GridCacheSharedContext ctx) {\n         for (Map.Entry<IgniteTxKey, String> e : keyLabels.entrySet()) {\n             IgniteTxKey txKey = e.getKey();\n \n-            GridCacheContext cctx = ctx.cacheContext(txKey.cacheId());\n+            try {\n+                CacheObjectContext objCtx = ctx.cacheObjectContext(txKey.cacheId());\n \n-            Object val = CU.value(txKey.key(), cctx, true);\n+                Object val = txKey.key().value(objCtx, true);\n \n-            sb.append(e.getValue()).append(\" [key=\").append(val).append(\", cache=\").append(cctx.namexx()).append(\"]\\n\");\n+                sb.append(e.getValue())\n+                    .append(\" [key=\")\n+                    .append(val)\n+                    .append(\", cache=\")\n+                    .append(objCtx.cacheName())\n+                    .append(\"]\\n\");\n+            }\n+            catch (Exception ex) {\n+                sb.append(\"Unable to unmarshall deadlock information for key [key=\").append(e.getValue()).append(\"]\\n\");\n+            }\n         }\n \n         return sb.toString();",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlock.java",
                "sha": "97db6988052c97390f3f97bdfcfc5f63455f24d0",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxLocksResponse.java",
                "changes": 37,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxLocksResponse.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 16,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxLocksResponse.java",
                "patch": "@@ -181,31 +181,36 @@ public void addKey(IgniteTxKey key) {\n \n     /** {@inheritDoc} */\n     @Override public void finishUnmarshal(GridCacheSharedContext ctx, ClassLoader ldr) throws IgniteCheckedException {\n-        super.finishUnmarshal(ctx, ldr);\n+        try {\n+            super.finishUnmarshal(ctx, ldr);\n \n-        if (nearTxKeysArr != null) {\n-            for (int i = 0; i < nearTxKeysArr.length; i++) {\n-                IgniteTxKey key = nearTxKeysArr[i];\n+            if (nearTxKeysArr != null) {\n+                for (int i = 0; i < nearTxKeysArr.length; i++) {\n+                    IgniteTxKey txKey = nearTxKeysArr[i];\n \n-                key.finishUnmarshal(ctx.cacheContext(key.cacheId()), ldr);\n+                    txKey.key().finishUnmarshal(ctx.cacheObjectContext(txKey.cacheId()), ldr);\n \n-                txLocks().put(key, locksArr[i]);\n+                    txLocks().put(txKey, locksArr[i]);\n+                }\n+\n+                nearTxKeysArr = null;\n+                locksArr = null;\n             }\n \n-            nearTxKeysArr = null;\n-            locksArr = null;\n-        }\n+            if (txKeysArr != null) {\n+                txKeys = U.newHashSet(txKeysArr.length);\n \n-        if (txKeysArr != null) {\n-            txKeys = U.newHashSet(txKeysArr.length);\n+                for (IgniteTxKey txKey : txKeysArr) {\n+                    txKey.key().finishUnmarshal(ctx.cacheObjectContext(txKey.cacheId()), ldr);\n \n-            for (IgniteTxKey key : txKeysArr) {\n-                key.finishUnmarshal(ctx.cacheContext(key.cacheId()), ldr);\n+                    txKeys.add(txKey);\n+                }\n \n-                txKeys.add(key);\n+                txKeysArr = null;\n             }\n-\n-            txKeysArr = null;\n+        }\n+        catch (Exception e) {\n+            throw new IgniteCheckedException(e);\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/TxLocksResponse.java",
                "sha": "7856eaab1918ffb860a1ffa9bae475dbe985f42c",
                "status": "modified"
            },
            {
                "additions": 116,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionMessageMarshallingTest.java",
                "changes": 116,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionMessageMarshallingTest.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionMessageMarshallingTest.java",
                "patch": "@@ -0,0 +1,116 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.transactions;\n+\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteKernal;\n+import org.apache.ignite.internal.managers.communication.GridIoPolicy;\n+import org.apache.ignite.internal.managers.communication.GridMessageListener;\n+import org.apache.ignite.internal.processors.cache.GridCacheContext;\n+import org.apache.ignite.internal.processors.cache.GridCacheSharedContext;\n+import org.apache.ignite.internal.processors.cache.IgniteCacheProxy;\n+import org.apache.ignite.internal.processors.cache.KeyCacheObject;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ *\n+ */\n+public class TxDeadlockDetectionMessageMarshallingTest extends GridCommonAbstractTest {\n+    /** Topic. */\n+    private static final String TOPIC = \"mytopic\";\n+\n+    /** Client mode. */\n+    private static boolean clientMode;\n+\n+    /** {@inheritDoc} */\n+    @SuppressWarnings(\"unchecked\")\n+    @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        cfg.setClientMode(clientMode);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMessageUnmarshallWithoutCacheContext() throws Exception {\n+        try {\n+            Ignite ignite = startGrid(0);\n+\n+            CacheConfiguration<Integer, Integer> ccfg = new CacheConfiguration<>();\n+\n+            IgniteCache<Integer, Integer> cache = ignite.getOrCreateCache(ccfg);\n+\n+            clientMode = true;\n+\n+            Ignite client = startGrid(1);\n+\n+            final GridCacheSharedContext<Object, Object> clientCtx = ((IgniteKernal)client).context().cache().context();\n+\n+            final CountDownLatch latch = new CountDownLatch(1);\n+\n+            final AtomicBoolean res = new AtomicBoolean();\n+\n+            clientCtx.gridIO().addMessageListener(TOPIC, new GridMessageListener() {\n+                @Override public void onMessage(UUID nodeId, Object msg) {\n+                    if (msg instanceof TxLocksResponse) {\n+                        try {\n+                            ((TxLocksResponse)msg).finishUnmarshal(clientCtx, clientCtx.deploy().globalLoader());\n+\n+                            res.set(true);\n+                        }\n+                        catch (Exception e) {\n+                            log.error(\"Message unmarshal failed\", e);\n+                        }\n+                        finally {\n+                            latch.countDown();\n+                        }\n+                    }\n+                }\n+            });\n+\n+            GridCacheContext cctx = ((IgniteCacheProxy)cache).context();\n+\n+            KeyCacheObject key = cctx.toCacheKeyObject(1);\n+\n+            TxLocksResponse msg = new TxLocksResponse();\n+            msg.addKey(cctx.txKey(key));\n+\n+            msg.prepareMarshal(cctx.shared());\n+\n+            ((IgniteKernal)ignite).context().cache().context().gridIO().sendToCustomTopic(\n+                ((IgniteKernal)client).localNode(), TOPIC, msg, GridIoPolicy.PUBLIC_POOL);\n+\n+            boolean await = latch.await(1, TimeUnit.SECONDS);\n+\n+            assertTrue(await && res.get());\n+        }\n+        finally {\n+            stopAllGrids();\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionMessageMarshallingTest.java",
                "sha": "dd7c3b3a5bf5488dbea2eb547e0eff35c4e4915b",
                "status": "added"
            },
            {
                "additions": 225,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionUnmasrhalErrorsTest.java",
                "changes": 225,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionUnmasrhalErrorsTest.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionUnmasrhalErrorsTest.java",
                "patch": "@@ -0,0 +1,225 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.transactions;\n+\n+import java.util.Collection;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.CyclicBarrier;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.cache.CacheException;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.internal.IgniteKernal;\n+import org.apache.ignite.internal.util.typedef.X;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.apache.ignite.transactions.Transaction;\n+import org.apache.ignite.transactions.TransactionDeadlockException;\n+import org.apache.ignite.transactions.TransactionTimeoutException;\n+\n+import static org.apache.ignite.internal.util.typedef.X.hasCause;\n+import static org.apache.ignite.transactions.TransactionConcurrency.PESSIMISTIC;\n+import static org.apache.ignite.transactions.TransactionIsolation.READ_COMMITTED;\n+import static org.apache.ignite.transactions.TransactionIsolation.REPEATABLE_READ;\n+\n+/**\n+ *\n+ */\n+public class TxDeadlockDetectionUnmasrhalErrorsTest extends GridCommonAbstractTest {\n+    /** Nodes count. */\n+    private static final int NODES_CNT = 2;\n+\n+    /** Client. */\n+    private static boolean client;\n+\n+    /** {@inheritDoc} */\n+    @SuppressWarnings(\"unchecked\")\n+    @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        cfg.setClientMode(client);\n+\n+        if (isDebug()) {\n+            TcpDiscoverySpi discoSpi = new TcpDiscoverySpi();\n+\n+            discoSpi.failureDetectionTimeoutEnabled(false);\n+\n+            cfg.setDiscoverySpi(discoSpi);\n+        }\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        super.beforeTestsStarted();\n+\n+        startGrid(0);\n+\n+        client = true;\n+\n+        startGrid(1);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() throws Exception {\n+        super.afterTestsStopped();\n+\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testDeadlockCacheObjectContext() throws Exception {\n+        IgniteCache<Integer, Integer> cache0 = null;\n+        IgniteCache<Integer, Integer> cache1 = null;\n+        try {\n+            cache0 = getCache(ignite(0), \"cache0\");\n+            cache1 = getCache(ignite(0), \"cache1\");\n+\n+            IgniteCache<Integer, Integer> clientCache0 = grid(1).cache(\"cache0\");\n+\n+            awaitPartitionMapExchange();\n+\n+            final CyclicBarrier barrier = new CyclicBarrier(2);\n+\n+            final CountDownLatch latch = new CountDownLatch(1);\n+\n+            final AtomicInteger threadCnt = new AtomicInteger();\n+\n+            final AtomicBoolean deadlock = new AtomicBoolean();\n+\n+            IgniteInternalFuture<Long> fut = GridTestUtils.runMultiThreadedAsync(new Runnable() {\n+                @Override public void run() {\n+                    int threadNum = threadCnt.getAndIncrement();\n+\n+                    Ignite ignite = ignite(0);\n+\n+                    IgniteCache<Integer, Integer> cache1 = ignite.cache(\"cache\" + (threadNum == 0 ? 0 : 1));\n+\n+                    IgniteCache<Integer, Integer> cache2 = ignite.cache(\"cache\" + (threadNum == 0 ? 1 : 0));\n+\n+                    try (Transaction tx = ignite.transactions().txStart(PESSIMISTIC, REPEATABLE_READ, 1000, 0)) {\n+                        int key1 = threadNum == 0 ? 0 : 1;\n+\n+                        log.info(\">>> Performs put [node=\" + ((IgniteKernal)ignite).localNode() +\n+                            \", tx=\" + tx + \", key=\" + key1 + \", cache=\" + cache1.getName() + ']');\n+\n+                        cache1.put(key1, 0);\n+\n+                        barrier.await();\n+\n+                        int key2 = threadNum == 0 ? 1 : 0;\n+\n+                        log.info(\">>> Performs put [node=\" + ((IgniteKernal)ignite).localNode() +\n+                            \", tx=\" + tx + \", key=\" + key2 + \", cache=\" + cache2.getName() + ']');\n+\n+                        latch.countDown();\n+\n+                        cache2.put(key2, 1);\n+\n+                        tx.commit();\n+\n+                        log.info(\">>> Commit done\");\n+                    }\n+                    catch (Throwable e) {\n+                        // At least one stack trace should contain TransactionDeadlockException.\n+                        if (hasCause(e, TransactionTimeoutException.class) &&\n+                            hasCause(e, TransactionDeadlockException.class)\n+                            ) {\n+                            if (deadlock.compareAndSet(false, true))\n+                                U.error(log, \"At least one stack trace should contain \" +\n+                                    TransactionDeadlockException.class.getSimpleName(), e);\n+                        }\n+                    }\n+                }\n+            }, 2, \"tx-thread\");\n+\n+            latch.await();\n+\n+            Ignite client = grid(1);\n+\n+            try (Transaction tx = client.transactions().txStart(PESSIMISTIC, READ_COMMITTED, 500, 0)) {\n+                clientCache0.put(0, 3);\n+                clientCache0.put(1, 3);\n+\n+                tx.commit();\n+\n+                log.info(\">>> Commit done\");\n+            }\n+            catch (CacheException e) {\n+                assertTrue(X.hasCause(e, TransactionTimeoutException.class));\n+            }\n+            catch (Throwable e) {\n+                log.error(\"Unexpected exception occurred\", e);\n+\n+                fail();\n+            }\n+\n+            fut.get();\n+\n+            assertTrue(deadlock.get());\n+\n+            for (int i = 0; i < NODES_CNT ; i++) {\n+                Ignite ignite = ignite(i);\n+\n+                IgniteTxManager txMgr = ((IgniteKernal)ignite).context().cache().context().tm();\n+\n+                Collection<IgniteInternalFuture<?>> futs = txMgr.deadlockDetectionFutures();\n+\n+                assertTrue(futs.isEmpty());\n+            }\n+\n+            //assertNotNull(grid(1).context().cache().context().cacheContext(cacheId));\n+        }\n+        finally {\n+            if (cache0 != null)\n+                cache0.destroy();\n+\n+            if (cache1 != null)\n+                cache1.destroy();\n+        }\n+    }\n+\n+\n+\n+    /**\n+     * @param ignite Ignite.\n+     * @param name Name.\n+     */\n+    private IgniteCache<Integer, Integer> getCache(Ignite ignite, String name) {\n+        CacheConfiguration ccfg = defaultCacheConfiguration();\n+\n+        ccfg.setName(name);\n+        ccfg.setCacheMode(CacheMode.PARTITIONED);\n+        ccfg.setBackups(0);\n+        ccfg.setNearConfiguration(null);\n+\n+        return ignite.getOrCreateCache(ccfg);\n+    }\n+\n+\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/transactions/TxDeadlockDetectionUnmasrhalErrorsTest.java",
                "sha": "598725e328f5fdb8ee385c1027f1c5296c6eca8b",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/test/java/org/apache/ignite/testsuites/TxDeadlockDetectionTestSuite.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/TxDeadlockDetectionTestSuite.java?ref=746f8ebc2e56720b50873af1b4ee2a320ca58793",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/TxDeadlockDetectionTestSuite.java",
                "patch": "@@ -19,8 +19,10 @@\n \n import junit.framework.TestSuite;\n import org.apache.ignite.internal.processors.cache.transactions.DepthFirstSearchTest;\n+import org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetectionMessageMarshallingTest;\n import org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetectionNoHangsTest;\n import org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetectionTest;\n+import org.apache.ignite.internal.processors.cache.transactions.TxDeadlockDetectionUnmasrhalErrorsTest;\n import org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionCrossCacheTest;\n import org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionTest;\n import org.apache.ignite.internal.processors.cache.transactions.TxPessimisticDeadlockDetectionCrossCacheTest;\n@@ -44,6 +46,8 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(TxPessimisticDeadlockDetectionCrossCacheTest.class);\n         suite.addTestSuite(TxDeadlockDetectionTest.class);\n         suite.addTestSuite(TxDeadlockDetectionNoHangsTest.class);\n+        suite.addTestSuite(TxDeadlockDetectionUnmasrhalErrorsTest.class);\n+        suite.addTestSuite(TxDeadlockDetectionMessageMarshallingTest.class);\n \n         return suite;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/746f8ebc2e56720b50873af1b4ee2a320ca58793/modules/core/src/test/java/org/apache/ignite/testsuites/TxDeadlockDetectionTestSuite.java",
                "sha": "337d4d46a06d0e5370c6680330ba582f43dff4f2",
                "status": "modified"
            }
        ],
        "message": "ignite-5041 NPE in deadlock detection fixed",
        "parent": "https://github.com/apache/ignite/commit/8f9edebfe74e2de1368d42ba951fa074b116eb17",
        "patched_files": [
            "GridCacheSharedContext.java",
            "TxDeadlockDetectionTestSuite.java",
            "DynamicCacheDescriptor.java",
            "TxLocksResponse.java",
            "TxDeadlock.java",
            "IgniteTxManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TxDeadlockDetectionMessageMarshallingTest.java",
            "TxDeadlockDetectionUnmasrhalErrorsTest.java"
        ]
    },
    "ignite_74f4651": {
        "bug_id": "ignite_74f4651",
        "commit": "https://github.com/apache/ignite/commit/74f46515368df83177f1ae7e59794295f20c1774",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java?ref=74f46515368df83177f1ae7e59794295f20c1774",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "patch": "@@ -2140,7 +2140,7 @@ public Serializable consistentId() {\n      *\n      * @return Wrapped DiscoverySpi SPI.\n      */\n-    private DiscoverySpi getInjectedDiscoverySpi() {\n+    public DiscoverySpi getInjectedDiscoverySpi() {\n         try {\n             inject();\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "sha": "261e73db97786eefd7c0c71d07c16d9d7c963347",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/ignite/blob/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/internal/processors/authentication/IgniteAuthenticationProcessor.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/authentication/IgniteAuthenticationProcessor.java?ref=74f46515368df83177f1ae7e59794295f20c1774",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/authentication/IgniteAuthenticationProcessor.java",
                "patch": "@@ -68,6 +68,8 @@\n import org.apache.ignite.lang.IgniteUuid;\n import org.apache.ignite.spi.IgniteNodeValidationResult;\n import org.apache.ignite.spi.discovery.DiscoveryDataBag;\n+import org.apache.ignite.spi.discovery.DiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n import org.apache.ignite.thread.IgniteThreadPoolExecutor;\n import org.jetbrains.annotations.Nullable;\n \n@@ -451,7 +453,7 @@ public void updateUser(String login, String passwd) throws IgniteCheckedExceptio\n     @Override public void collectGridNodeData(DiscoveryDataBag dataBag) {\n         // 1. Collect users info only on coordinator\n         // 2. Doesn't collect users info to send on client node due to security reason.\n-        if (!isEnabled || !F.eq(ctx.localNodeId(), coordinator().id()) || dataBag.isJoiningNodeClient())\n+        if (!isEnabled || !isLocalNodeCoordinator() || dataBag.isJoiningNodeClient())\n             return;\n \n         synchronized (mux) {\n@@ -466,6 +468,21 @@ public void updateUser(String login, String passwd) throws IgniteCheckedExceptio\n         }\n     }\n \n+    /**\n+     * Checks whether local node is coordinator. Nodes that are leaving or failed\n+     * (but are still in topology) are removed from search.\n+     *\n+     * @return {@code true} if local node is coordinator.\n+     */\n+    private boolean isLocalNodeCoordinator() {\n+        DiscoverySpi spi = ctx.discovery().getInjectedDiscoverySpi();\n+\n+        if (spi instanceof TcpDiscoverySpi)\n+            return ((TcpDiscoverySpi)spi).isLocalNodeCoordinator();\n+        else\n+            return F.eq(ctx.localNodeId(), coordinator().id());\n+    }\n+\n     /** {@inheritDoc} */\n     @Override public void onGridDataReceived(DiscoveryDataBag.GridDiscoveryData data) {\n         initUsrs = (InitialUsersData)data.commonData();",
                "raw_url": "https://github.com/apache/ignite/raw/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/internal/processors/authentication/IgniteAuthenticationProcessor.java",
                "sha": "ac713c3dce87505172715cd43b4f4248616d388d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java?ref=74f46515368df83177f1ae7e59794295f20c1774",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java",
                "patch": "@@ -1473,7 +1473,7 @@ private void notifyDiscovery(int type, long topVer, TcpDiscoveryNode node) {\n      *\n      * @return {@code true} if local node is coordinator.\n      */\n-    private boolean isLocalNodeCoordinator() {\n+    public boolean isLocalNodeCoordinator() {\n         synchronized (mux) {\n             boolean crd = spiState == CONNECTED && locNode.equals(resolveCoordinator());\n ",
                "raw_url": "https://github.com/apache/ignite/raw/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java",
                "sha": "6b2293a1d275c1ac4b73a9067d85226731f2c422",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java?ref=74f46515368df83177f1ae7e59794295f20c1774",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "patch": "@@ -2235,6 +2235,19 @@ public void brakeConnection() {\n         impl.brakeConnection();\n     }\n \n+    /**\n+     * Checks whether local node is coordinator. Nodes that are leaving or failed\n+     * (but are still in topology) are removed from search.\n+     *\n+     * @return {@code true} if local node is coordinator.\n+     */\n+    public boolean isLocalNodeCoordinator() {\n+        if (impl instanceof ServerImpl)\n+            return ((ServerImpl)impl).isLocalNodeCoordinator();\n+\n+        return false;\n+    }\n+\n     /**\n      * @return Marshaller.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "sha": "801f2b65655218946e11999472002b5e3e366150",
                "status": "modified"
            },
            {
                "additions": 90,
                "blob_url": "https://github.com/apache/ignite/blob/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/test/java/org/apache/ignite/internal/processors/authentication/AuthenticationProcessorNPEOnStartTest.java",
                "changes": 90,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/authentication/AuthenticationProcessorNPEOnStartTest.java?ref=74f46515368df83177f1ae7e59794295f20c1774",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/authentication/AuthenticationProcessorNPEOnStartTest.java",
                "patch": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.authentication;\n+\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * Test for NPE on start node simultaneous.\n+ */\n+public class AuthenticationProcessorNPEOnStartTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final TcpDiscoveryIpFinder IP_FINDER = new TcpDiscoveryVmIpFinder(true);\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        TcpDiscoverySpi spi = new TcpDiscoverySpi();\n+\n+        spi.setIpFinder(IP_FINDER);\n+\n+        cfg.setDiscoverySpi(spi);\n+\n+        cfg.setAuthenticationEnabled(true);\n+\n+        cfg.setDataStorageConfiguration(new DataStorageConfiguration()\n+            .setDefaultDataRegionConfiguration(new DataRegionConfiguration()\n+                .setPersistenceEnabled(true)));\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        U.resolveWorkDirectory(U.defaultWorkDirectory(), \"db\", true);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+\n+        super.afterTest();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void test() throws Exception {\n+        final AtomicInteger nodeIdx = new AtomicInteger();\n+\n+        GridTestUtils.runMultiThreaded(new Runnable() {\n+            @Override public void run() {\n+                try {\n+                    startGrid(nodeIdx.getAndIncrement());\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();\n+\n+                    fail(\"Unexpected exception\");\n+                }\n+            }\n+        }, 10, \"auth-grid-starter\");\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/test/java/org/apache/ignite/internal/processors/authentication/AuthenticationProcessorNPEOnStartTest.java",
                "sha": "9748db772747ab8c16cbc390b30bba765ae4ee1e",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java?ref=74f46515368df83177f1ae7e59794295f20c1774",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java",
                "patch": "@@ -20,6 +20,7 @@\n import junit.framework.TestSuite;\n import org.apache.ignite.internal.processors.authentication.AuthenticationConfigurationClusterTest;\n import org.apache.ignite.internal.processors.authentication.AuthenticationOnNotActiveClusterTest;\n+import org.apache.ignite.internal.processors.authentication.AuthenticationProcessorNPEOnStartTest;\n import org.apache.ignite.internal.processors.authentication.AuthenticationProcessorNodeRestartTest;\n import org.apache.ignite.internal.processors.authentication.AuthenticationProcessorSelfTest;\n import org.apache.ignite.internal.processors.cache.PartitionedAtomicCacheGetsDistributionTest;\n@@ -87,6 +88,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(AuthenticationProcessorSelfTest.class);\n         suite.addTestSuite(AuthenticationOnNotActiveClusterTest.class);\n         suite.addTestSuite(AuthenticationProcessorNodeRestartTest.class);\n+        suite.addTestSuite(AuthenticationProcessorNPEOnStartTest.class);\n \n         suite.addTestSuite(ReplicatedAtomicCacheGetsDistributionTest.class);\n         suite.addTestSuite(ReplicatedTransactionalOptimisticCacheGetsDistributionTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/74f46515368df83177f1ae7e59794295f20c1774/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java",
                "sha": "a31bd7544a31d210fc47b85aa1474ecfabb318ba",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8355 Fixed NPE on concurrent nodes start - Fixes #3899.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/8a7e8f07fccebb9d5786e5624e353af730d4d039",
        "patched_files": [
            "IgniteCacheTestSuite6.java",
            "ServerImpl.java",
            "GridDiscoveryManager.java",
            "IgniteAuthenticationProcessor.java",
            "TcpDiscoverySpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "AuthenticationProcessorNPEOnStartTest.java",
            "TestTcpDiscoverySpi.java"
        ]
    },
    "ignite_7ada6a5": {
        "bug_id": "ignite_7ada6a5",
        "commit": "https://github.com/apache/ignite/commit/7ada6a5f5a339b1282bd554c068b380254f78065",
        "file": [
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/ignite/blob/7ada6a5f5a339b1282bd554c068b380254f78065/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java?ref=7ada6a5f5a339b1282bd554c068b380254f78065",
                "deletions": 6,
                "filename": "modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java",
                "patch": "@@ -69,7 +69,7 @@ public PojoMethodsCache(String clsName, Collection<CacheTypeFieldMetadata> field\n                 throw new CacheException(\"Failed to find class: \" + clsName, e);\n             }\n             catch (NoSuchMethodException e) {\n-                throw new CacheException(\"Failed to find empty constructor for class: \" + clsName, e);\n+                throw new CacheException(\"Failed to find default constructor for class: \" + clsName, e);\n             }\n \n             setters = U.newHashMap(fields.size());\n@@ -87,17 +87,17 @@ public PojoMethodsCache(String clsName, Collection<CacheTypeFieldMetadata> field\n                         getters.put(field.getJavaName(), cls.getMethod(\"is\" + prop));\n                     }\n                     catch (NoSuchMethodException e) {\n-                        throw new CacheException(\"Failed to find getter for property \" + field.getJavaName() +\n-                            \" of class: \" + cls.getName(), e);\n+                        throw new CacheException(\"Failed to find getter in pojo class [class name: \" + clsName +\n+                            \", property: \" + field.getJavaName() + \"]\", e);\n                     }\n                 }\n \n                 try {\n                     setters.put(field.getJavaName(), cls.getMethod(\"set\" + prop, field.getJavaType()));\n                 }\n                 catch (NoSuchMethodException e) {\n-                    throw new CacheException(\"Failed to find setter for property \" + field.getJavaName() +\n-                        \" of class: \" + clsName, e);\n+                    throw new CacheException(\"Failed to find setter in pojo class [class name: \" + clsName +\n+                        \", property: \" + field.getJavaName() + \"]\", e);\n                 }\n             }\n         }\n@@ -157,12 +157,19 @@ protected Object newInstance() throws CacheLoaderException {\n         Map<String, Integer> loadColIdxs, ResultSet rs) throws CacheLoaderException {\n         PojoMethodsCache mc = mtdsCache.get(cacheName).get(typeName);\n \n+        if (mc == null)\n+            throw new CacheLoaderException(\"Failed to find cache type metadata for type: \" + typeName);\n+\n         Object obj = mc.newInstance();\n \n         try {\n             for (CacheTypeFieldMetadata field : fields) {\n                 Method setter = mc.setters.get(field.getJavaName());\n \n+                if (setter == null)\n+                    throw new CacheLoaderException(\"Failed to find setter in pojo class [class name:\" + typeName +\n+                        \", property: \" + field.getJavaName() + \"]\");\n+\n                 Integer colIdx = loadColIdxs.get(field.getDatabaseName());\n \n                 setter.invoke(obj, getColumnValue(rs, colIdx, field.getJavaType()));\n@@ -181,7 +188,16 @@ protected Object newInstance() throws CacheLoaderException {\n         try {\n             PojoMethodsCache mc = mtdsCache.get(cacheName).get(typeName);\n \n-            return mc.getters.get(fieldName).invoke(obj);\n+            if (mc == null)\n+                throw new CacheException(\"Failed to find cache type metadata for type: \" + typeName);\n+\n+            Method getter = mc.getters.get(fieldName);\n+\n+            if (getter == null)\n+                throw new CacheLoaderException(\"Failed to find getter in pojo class [class name:\" + typeName +\n+                    \", property: \" + fieldName + \"]\");\n+\n+            return getter.invoke(obj);\n         }\n         catch (Exception e) {\n             throw new CacheException(\"Failed to read object of class: \" + typeName, e);",
                "raw_url": "https://github.com/apache/ignite/raw/7ada6a5f5a339b1282bd554c068b380254f78065/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java",
                "sha": "0c6292d302f76d3e1ccbb0a21de3aa0a41226eb0",
                "status": "modified"
            }
        ],
        "message": "# ignite-281 Fixed npe CacheJdbcPojoStore.",
        "parent": "https://github.com/apache/ignite/commit/dd6c24f4e45cf136aa1d496028c20ce5f0d1a35d",
        "patched_files": [
            "CacheJdbcPojoStore.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "CacheJdbcPojoStoreTest.java"
        ]
    },
    "ignite_7b17bb8": {
        "bug_id": "ignite_7b17bb8",
        "commit": "https://github.com/apache/ignite/commit/7b17bb85f262efa991c83e92cbf3545caedfac33",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/7b17bb85f262efa991c83e92cbf3545caedfac33/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionDemander.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionDemander.java?ref=7b17bb85f262efa991c83e92cbf3545caedfac33",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionDemander.java",
                "patch": "@@ -363,7 +363,6 @@ else if (delay > 0) {\n     /**\n      * @param fut Rebalance future.\n      * @param assigns Assignments.\n-     * @throws IgniteCheckedException If failed.\n      */\n     private void requestPartitions(final RebalanceFuture fut, GridDhtPreloaderAssignments assigns) {\n         assert fut != null;\n@@ -398,10 +397,10 @@ private void requestPartitions(final RebalanceFuture fut, GridDhtPreloaderAssign\n         for (Map.Entry<ClusterNode, GridDhtPartitionDemandMessage> e : assigns.entrySet()) {\n             final ClusterNode node = e.getKey();\n \n-            final Collection<Integer> parts = fut.remaining.get(node.id()).get2();\n-\n             GridDhtPartitionDemandMessage d = e.getValue();\n \n+            final Collection<Integer> parts = d.partitions();\n+\n             U.log(log, \"Starting rebalancing [mode=\" + cfg.getRebalanceMode() +\n                 \", fromNode=\" + node.id() + \", partitionsCount=\" + parts.size() +\n                 \", topology=\" + fut.topologyVersion() + \", updateSeq=\" + fut.updateSeq + \"]\");",
                "raw_url": "https://github.com/apache/ignite/raw/7b17bb85f262efa991c83e92cbf3545caedfac33/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionDemander.java",
                "sha": "15caae24563b134374072d927791f96b84eb22f0",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/7b17bb85f262efa991c83e92cbf3545caedfac33/modules/core/src/test/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManagerAliveCacheSelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManagerAliveCacheSelfTest.java?ref=7b17bb85f262efa991c83e92cbf3545caedfac33",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManagerAliveCacheSelfTest.java",
                "patch": "@@ -169,8 +169,6 @@ public void testAlives() throws Exception {\n      * @throws Exception If failed.\n      */\n     public void testAlivesClient() throws Exception {\n-        fail(\"https://issues.apache.org/jira/browse/IGNITE-1583\");\n-\n         clientMode = true;\n \n         doTestAlive();",
                "raw_url": "https://github.com/apache/ignite/raw/7b17bb85f262efa991c83e92cbf3545caedfac33/modules/core/src/test/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManagerAliveCacheSelfTest.java",
                "sha": "a8afa8b928a4fe40bbc95fa1f0f65cb6ed9318e9",
                "status": "modified"
            }
        ],
        "message": "NPE in GridDhtPartitionDemander.requestPartitions.",
        "parent": "https://github.com/apache/ignite/commit/f3b067271d5f1e393ffc01479ceaab541e143e8c",
        "patched_files": [
            "GridDhtPartitionDemander.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridDiscoveryManagerAliveCacheSelfTest.java"
        ]
    },
    "ignite_7fb03c7": {
        "bug_id": "ignite_7fb03c7",
        "commit": "https://github.com/apache/ignite/commit/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1",
        "file": [
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/ignite/blob/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "changes": 63,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java?ref=7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1",
                "deletions": 18,
                "filename": "modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "patch": "@@ -17,24 +17,33 @@\n \n package org.apache.ignite.internal.jdbc2;\n \n-import org.apache.ignite.*;\n-import org.apache.ignite.cache.affinity.*;\n-import org.apache.ignite.cache.query.annotations.*;\n-import org.apache.ignite.configuration.*;\n-import org.apache.ignite.internal.util.typedef.*;\n-import org.apache.ignite.spi.discovery.tcp.*;\n-import org.apache.ignite.spi.discovery.tcp.ipfinder.*;\n-import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.*;\n-import org.apache.ignite.testframework.junits.common.*;\n-\n-import java.io.*;\n-import java.sql.*;\n-import java.util.*;\n-\n-import static java.sql.Types.*;\n-import static org.apache.ignite.IgniteJdbcDriver.*;\n-import static org.apache.ignite.cache.CacheMode.*;\n-import static org.apache.ignite.cache.CacheWriteSynchronizationMode.*;\n+import java.io.Serializable;\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.DriverManager;\n+import java.sql.ResultSet;\n+import java.sql.ResultSetMetaData;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.affinity.AffinityKey;\n+import org.apache.ignite.cache.query.annotations.QuerySqlField;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.ConnectorConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.util.typedef.F;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+import static java.sql.Types.INTEGER;\n+import static java.sql.Types.OTHER;\n+import static java.sql.Types.VARCHAR;\n+import static org.apache.ignite.IgniteJdbcDriver.CFG_URL_PREFIX;\n+import static org.apache.ignite.cache.CacheMode.PARTITIONED;\n+import static org.apache.ignite.cache.CacheWriteSynchronizationMode.FULL_SYNC;\n \n /**\n  * Metadata tests.\n@@ -276,6 +285,24 @@ public void testGetColumns() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMetadataResultSetClose() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(BASE_URL);\n+             ResultSet tbls = conn.getMetaData().getTables(null, null, \"%\", null)) {\n+            int colCnt = tbls.getMetaData().getColumnCount();\n+\n+            while (tbls.next()) {\n+                for (int i = 0; i < colCnt; i++)\n+                    tbls.getObject(i + 1);\n+            }\n+        }\n+        catch (Exception e) {\n+            fail();\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "sha": "7184b8dea1a115cb5b56b615cbbfb7a474dbba72",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/ignite/blob/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java?ref=7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1",
                "deletions": 0,
                "filename": "modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "patch": "@@ -288,6 +288,24 @@ public void testGetColumns() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMetadataResultSetClose() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(URL);\n+             ResultSet tbls = conn.getMetaData().getTables(null, null, \"%\", null)) {\n+            int colCnt = tbls.getMetaData().getColumnCount();\n+\n+            while (tbls.next()) {\n+                for (int i = 0; i < colCnt; i++)\n+                    tbls.getObject(i + 1);\n+            }\n+        }\n+        catch (Exception e) {\n+            fail();\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "sha": "72d93c97009cdeb481b20fb4b81c3bc1cdc216a8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java?ref=7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "patch": "@@ -182,7 +182,7 @@ else if (!finished) {\n      * If this result set is associated with locally executed query then query cursor will also closed.\n      */\n     void closeInternal() throws SQLException  {\n-        if (((JdbcConnection)stmt.getConnection()).nodeId() == null)\n+        if (((JdbcConnection)stmt.getConnection()).nodeId() == null && uuid != null)\n             JdbcQueryTask.remove(uuid);\n \n         closed = true;",
                "raw_url": "https://github.com/apache/ignite/raw/7fb03c7ca0e4f64ff1629404f0b34d3d7a6e2bf1/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "sha": "69dddad3ad27859354e40aef9e8a63b7c9bb8f33",
                "status": "modified"
            }
        ],
        "message": " IGNITE-3389 metadata result set throws NPE when closed - fixed",
        "parent": "https://github.com/apache/ignite/commit/6c5218f4d67c8e247f59dbe8deb58b51db2954a2",
        "patched_files": [
            "JdbcResultSet.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "JdbcMetadataSelfTest.java"
        ]
    },
    "ignite_834869c": {
        "bug_id": "ignite_834869c",
        "commit": "https://github.com/apache/ignite/commit/834869c2ac7897c8891cd1dca537488230191ab6",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/834869c2ac7897c8891cd1dca537488230191ab6/modules/core/src/main/java/org/apache/ignite/internal/visor/baseline/VisorBaselineTask.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/visor/baseline/VisorBaselineTask.java?ref=834869c2ac7897c8891cd1dca537488230191ab6",
                "deletions": 11,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/visor/baseline/VisorBaselineTask.java",
                "patch": "@@ -71,10 +71,10 @@ private VisorBaselineTaskResult collect() {\n \n             Collection<? extends BaselineNode> baseline = cluster.currentBaselineTopology();\n \n-            Collection<? extends BaselineNode> servers = cluster.forServers().nodes();\n+            Collection<? extends BaselineNode> srvrs = cluster.forServers().nodes();\n \n-            return new VisorBaselineTaskResult(ignite.active(), cluster.topologyVersion(),\n-                F.isEmpty(baseline) ? null : baseline, servers);\n+            return new VisorBaselineTaskResult(ignite.cluster().active(), cluster.topologyVersion(),\n+                F.isEmpty(baseline) ? null : baseline, srvrs);\n         }\n \n         /**\n@@ -93,12 +93,14 @@ private VisorBaselineTaskResult set0(Collection<BaselineNode> baselineTop) {\n          * @return Current baseline.\n          */\n         private Map<String, BaselineNode> currentBaseLine() {\n-            Collection<BaselineNode> baseline = ignite.cluster().currentBaselineTopology();\n-\n             Map<String, BaselineNode> nodes = new HashMap<>();\n \n-            for (BaselineNode node : baseline)\n-                nodes.put(node.consistentId().toString(), node);\n+            Collection<BaselineNode> baseline = ignite.cluster().currentBaselineTopology();\n+\n+            if (!F.isEmpty(baseline)) {\n+                for (BaselineNode node : baseline)\n+                    nodes.put(node.consistentId().toString(), node);\n+            }\n \n             return nodes;\n         }\n@@ -122,12 +124,12 @@ private VisorBaselineTaskResult set0(Collection<BaselineNode> baselineTop) {\n          * @return New baseline.\n          */\n         private VisorBaselineTaskResult set(List<String> consistentIds) {\n-            Map<String, BaselineNode> servers = currentServers();\n+            Map<String, BaselineNode> srvrs = currentServers();\n \n             Collection<BaselineNode> baselineTop = new ArrayList<>();\n \n             for (String consistentId : consistentIds) {\n-                BaselineNode node = servers.get(consistentId);\n+                BaselineNode node = srvrs.get(consistentId);\n \n                 if (node == null)\n                     throw new IllegalStateException(\"Node not found for consistent ID: \" + consistentId);\n@@ -146,10 +148,10 @@ private VisorBaselineTaskResult set(List<String> consistentIds) {\n          */\n         private VisorBaselineTaskResult add(List<String> consistentIds) {\n             Map<String, BaselineNode> baseline = currentBaseLine();\n-            Map<String, BaselineNode> servers = currentServers();\n+            Map<String, BaselineNode> srvrs = currentServers();\n \n             for (String consistentId : consistentIds) {\n-                BaselineNode node = servers.get(consistentId);\n+                BaselineNode node = srvrs.get(consistentId);\n \n                 if (node == null)\n                     throw new IllegalStateException(\"Node not found for consistent ID: \" + consistentId);",
                "raw_url": "https://github.com/apache/ignite/raw/834869c2ac7897c8891cd1dca537488230191ab6/modules/core/src/main/java/org/apache/ignite/internal/visor/baseline/VisorBaselineTask.java",
                "sha": "721b4b3d7519d54e4559a691a3ce8c9759244d8a",
                "status": "modified"
            },
            {
                "additions": 43,
                "blob_url": "https://github.com/apache/ignite/blob/834869c2ac7897c8891cd1dca537488230191ab6/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java?ref=834869c2ac7897c8891cd1dca537488230191ab6",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "patch": "@@ -17,7 +17,9 @@\n \n package org.apache.ignite.util;\n \n+import java.io.ByteArrayOutputStream;\n import java.io.File;\n+import java.io.PrintStream;\n import java.util.ArrayList;\n import java.util.Arrays;\n import org.apache.ignite.Ignite;\n@@ -61,6 +63,11 @@ protected File folder(String folder) throws IgniteCheckedException {\n         cleanPersistenceDir();\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public String getTestIgniteInstanceName() {\n+        return \"bltTest\";\n+    }\n+\n     /** {@inheritDoc} */\n     @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n         IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n@@ -76,6 +83,8 @@ protected File folder(String folder) throws IgniteCheckedException {\n         dsCfg.setWalMode(WALMode.LOG_ONLY);\n         dsCfg.getDefaultDataRegionConfiguration().setPersistenceEnabled(true);\n \n+        cfg.setConsistentId(igniteInstanceName);\n+\n         return cfg;\n     }\n \n@@ -205,6 +214,40 @@ public void testBaselineAdd() throws Exception {\n         assertEquals(2, ignite.cluster().currentBaselineTopology().size());\n     }\n \n+    /**\n+     * Test baseline add items works via control.sh\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testBaselineAddOnNotActiveCluster() throws Exception {\n+        try {\n+            Ignite ignite = startGrid(1);\n+\n+            assertFalse(ignite.cluster().active());\n+\n+            String consistentIDs = getTestIgniteInstanceName(1);\n+\n+            ByteArrayOutputStream out = new ByteArrayOutputStream(4096);\n+            System.setOut(new PrintStream(out));\n+\n+            assertEquals(EXIT_CODE_UNEXPECTED_ERROR, execute(\"--baseline\", \"add\", consistentIDs));\n+\n+            assertTrue(out.toString().contains(\"Changing BaselineTopology on inactive cluster is not allowed.\"));\n+\n+            consistentIDs =\n+                getTestIgniteInstanceName(1) + \", \" +\n+                    getTestIgniteInstanceName(2) + \",\" +\n+                    getTestIgniteInstanceName(3);\n+\n+            assertEquals(EXIT_CODE_UNEXPECTED_ERROR, execute(\"--baseline\", \"add\", consistentIDs));\n+\n+            assertTrue(out.toString().contains(\"Node not found for consistent ID: bltTest2\"));\n+        }\n+        finally {\n+            System.setOut(System.out);\n+        }\n+    }\n+\n     /**\n      * Test baseline remove works via control.sh\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/834869c2ac7897c8891cd1dca537488230191ab6/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "sha": "eb18e29680082d29de089d99f1240a846d29bf71",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8159 control.sh: Fixed NPE on adding nodes on empty baseline and not active cluster.",
        "parent": "https://github.com/apache/ignite/commit/b97b1eec43be60c020adb142503e59735d8e07a2",
        "patched_files": [
            "VisorBaselineTask.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridCommandHandlerTest.java"
        ]
    },
    "ignite_84d329c": {
        "bug_id": "ignite_84d329c",
        "commit": "https://github.com/apache/ignite/commit/84d329c29ebc6989793af0778c080429e69c875e",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/84d329c29ebc6989793af0778c080429e69c875e/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridH2DefaultTableEngine.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridH2DefaultTableEngine.java?ref=84d329c29ebc6989793af0778c080429e69c875e",
                "deletions": 1,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridH2DefaultTableEngine.java",
                "patch": "@@ -28,7 +28,9 @@\n public class GridH2DefaultTableEngine implements TableEngine {\n     /** {@inheritDoc} */\n     @Override public Table createTable(CreateTableData data) {\n-        assert !data.persistData && !data.persistIndexes;\n+        // Used to create shadow table view used by CTE.\n+        data.persistData = false;\n+        data.persistIndexes = false;\n \n         if (data.isHidden && data.id == 0 && \"SYS\".equals(data.tableName))\n             return new GridH2MetaTable(data);",
                "raw_url": "https://github.com/apache/ignite/raw/84d329c29ebc6989793af0778c080429e69c875e/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/opt/GridH2DefaultTableEngine.java",
                "sha": "72c1102abed933f22b87ca2f0b632e1c269234ff",
                "status": "modified"
            },
            {
                "additions": 75,
                "blob_url": "https://github.com/apache/ignite/blob/84d329c29ebc6989793af0778c080429e69c875e/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlNestedQuerySelfTest.java",
                "changes": 75,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlNestedQuerySelfTest.java?ref=84d329c29ebc6989793af0778c080429e69c875e",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlNestedQuerySelfTest.java",
                "patch": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.query;\n+\n+import java.util.List;\n+import org.apache.ignite.cache.query.SqlFieldsQuery;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * Tests for schemas.\n+ */\n+public class SqlNestedQuerySelfTest extends GridCommonAbstractTest {\n+    /** Node. */\n+    private IgniteEx node;\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        node = (IgniteEx)startGrid();\n+\n+        startGrid(2);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     */\n+    public void testNestingQuery() {\n+        sql(\"CREATE TABLE txs(txId INTEGER PRIMARY KEY, created INTEGER)\");\n+        sql(\"CREATE TABLE ops(id INTEGER PRIMARY KEY, txId INTEGER, stage VARCHAR, tStamp INTEGER)\");\n+\n+        sql(\"INSERT INTO txs(txId, created) VALUES (1, 599000), (2, 599111), (3, 599234)\");\n+        sql(\"INSERT INTO ops(id, txId, stage, tStamp) VALUES\" +\n+            \" (1, 1, 'NEW', 599686), (2, 1, 'OLD', 599722), (3, 1, 'OLD', 599736), (4, 2, 'NEW', 599767)\");\n+\n+        sql(\"WITH cacheJoin (txId, stage, tStamp)\" +\n+              \" AS (SELECT t.txId, o.stage, o.tStamp FROM txs t INNER JOIN ops o ON t.txId = o.txId)\" +\n+            \" SELECT ou.stage, COUNT(*) as cou, SUM(CASE WHEN ou.stage = in.stage THEN 1 ELSE 0 END) AS ttl\" +\n+              \" FROM (SELECT txId, stage FROM cacheJoin cte GROUP BY txId, stage) ou\" +\n+                \" INNER JOIN (SELECT mx.txId, mx.stage FROM (SELECT txId, tStamp, stage FROM cacheJoin cte) mx\" +\n+                  \" INNER JOIN (SELECT txId, MAX(tStamp) AS maxTStamp FROM cacheJoin cte GROUP BY txId) mix\" +\n+                    \" ON mx.txId = mix.txId AND mx.tStamp = mix.maxTStamp) in ON ou.txId = in.txId\" +\n+            \" GROUP BY ou.stage\");\n+    }\n+\n+    /**\n+     * @param sql SQL query.\n+     * @return Results.\n+     */\n+    private List<List<?>> sql(String sql) {\n+        GridQueryProcessor qryProc = node.context().query();\n+\n+        SqlFieldsQuery qry = new SqlFieldsQuery(sql).setSchema(\"PUBLIC\");\n+\n+        return qryProc.querySqlFields(qry, true).getAll();\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/84d329c29ebc6989793af0778c080429e69c875e/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlNestedQuerySelfTest.java",
                "sha": "f3545f259559a2ae64b6a08925ba553ed299946e",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/84d329c29ebc6989793af0778c080429e69c875e/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteBinaryCacheQueryTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteBinaryCacheQueryTestSuite.java?ref=84d329c29ebc6989793af0778c080429e69c875e",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteBinaryCacheQueryTestSuite.java",
                "patch": "@@ -193,6 +193,7 @@\n import org.apache.ignite.internal.processors.query.LazyQuerySelfTest;\n import org.apache.ignite.internal.processors.query.MultipleStatementsSqlQuerySelfTest;\n import org.apache.ignite.internal.processors.query.SqlIllegalSchemaSelfTest;\n+import org.apache.ignite.internal.processors.query.SqlNestedQuerySelfTest;\n import org.apache.ignite.internal.processors.query.SqlPushDownFunctionTest;\n import org.apache.ignite.internal.processors.query.SqlSchemaSelfTest;\n import org.apache.ignite.internal.processors.query.SqlSystemViewsSelfTest;\n@@ -244,6 +245,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(AffinityKeyNameAndValueFieldNameConflictTest.class);\n         suite.addTestSuite(DmlInsideTransactionTest.class);\n         suite.addTestSuite(ComplexPrimaryKeyUnwrapSelfTest.class);\n+        suite.addTestSuite(SqlNestedQuerySelfTest.class);\n \n         suite.addTestSuite(PartitionedSqlTest.class);\n         suite.addTestSuite(ReplicatedSqlTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/84d329c29ebc6989793af0778c080429e69c875e/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgniteBinaryCacheQueryTestSuite.java",
                "sha": "87a0b2ed5faf6ebf896d547c5fdccc27c5508b36",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8639: SQL: Fixed NPE in org.h2.util.StringUtils.indent where query has a lot of nested subqueries. This closes #4919.",
        "parent": "https://github.com/apache/ignite/commit/c3462fffff3b09c52c4c0bcb55867015449a2fb6",
        "patched_files": [
            "GridH2DefaultTableEngine.java",
            "IgniteBinaryCacheQueryTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "SqlNestedQuerySelfTest.java"
        ]
    },
    "ignite_85cf73f": {
        "bug_id": "ignite_85cf73f",
        "commit": "https://github.com/apache/ignite/commit/85cf73fb964152b1edd5baa730bcf9e34e761819",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=85cf73fb964152b1edd5baa730bcf9e34e761819",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -2718,6 +2718,12 @@ private void processCacheStopRequestOnExchangeDone(ExchangeActions exchActions)\n \n                                 context().tm().rollbackTransactionsForStoppingCache(action.descriptor().cacheId());\n \n+                                // TTL manager has to be unregistered before the checkpointReadLock is acquired.\n+                                GridCacheAdapter<?, ?> cache = caches.get(action.request().cacheName());\n+\n+                                if (cache != null)\n+                                    cache.context().ttl().unregister();\n+\n                                 sharedCtx.database().checkpointReadLock();\n \n                                 try {",
                "raw_url": "https://github.com/apache/ignite/raw/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "2f1e5bcdb2645d3333819ccd281c239b4309c128",
                "status": "modified"
            },
            {
                "additions": 62,
                "blob_url": "https://github.com/apache/ignite/blob/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedTtlCleanupManager.java",
                "changes": 94,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedTtlCleanupManager.java?ref=85cf73fb964152b1edd5baa730bcf9e34e761819",
                "deletions": 32,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedTtlCleanupManager.java",
                "patch": "@@ -17,13 +17,15 @@\n \n package org.apache.ignite.internal.processors.cache;\n \n-import java.util.List;\n-import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.locks.ReentrantLock;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.failure.FailureContext;\n import org.apache.ignite.internal.IgniteInterruptedCheckedException;\n-import org.apache.ignite.internal.util.typedef.X;\n import org.apache.ignite.internal.NodeStoppingException;\n+import org.apache.ignite.internal.util.typedef.X;\n import org.apache.ignite.internal.util.typedef.internal.U;\n import org.apache.ignite.internal.util.worker.GridWorker;\n import org.apache.ignite.thread.IgniteThread;\n@@ -44,17 +46,15 @@\n     /** Cleanup worker. */\n     private CleanupWorker cleanupWorker;\n \n-    /** Mutex on worker thread creation. */\n-    private final Object mux = new Object();\n+    /** Lock on worker thread creation. */\n+    private final ReentrantLock lock = new ReentrantLock();\n \n-    /** List of registered ttl managers. */\n-    private List<GridCacheTtlManager> mgrs = new CopyOnWriteArrayList<>();\n+    /** Map of registered ttl managers, where the cache id is used as the key. */\n+    private final Map<Integer, GridCacheTtlManager> mgrs = new ConcurrentHashMap<>();\n \n     /** {@inheritDoc} */\n     @Override protected void onKernalStop0(boolean cancel) {\n-        synchronized (mux) {\n-            stopCleanupWorker();\n-        }\n+        stopCleanupWorker();\n     }\n \n     /**\n@@ -63,12 +63,10 @@\n      * @param mgr ttl manager of cache.\n      * */\n     public void register(GridCacheTtlManager mgr) {\n-        synchronized (mux) {\n-            if (cleanupWorker == null)\n-                startCleanupWorker();\n+        if (mgrs.isEmpty())\n+            startCleanupWorker();\n \n-            mgrs.add(mgr);\n-        }\n+        mgrs.put(mgr.context().cacheId(), mgr);\n     }\n \n     /**\n@@ -77,12 +75,10 @@ public void register(GridCacheTtlManager mgr) {\n      * @param mgr ttl manager of cache.\n      * */\n     public void unregister(GridCacheTtlManager mgr) {\n-        synchronized (mux) {\n-            mgrs.remove(mgr);\n+        mgrs.remove(mgr.context().cacheId());\n \n-            if (mgrs.isEmpty())\n-                stopCleanupWorker();\n-        }\n+        if (mgrs.isEmpty())\n+            stopCleanupWorker();\n     }\n \n     /**\n@@ -91,27 +87,51 @@ public void unregister(GridCacheTtlManager mgr) {\n     public boolean eagerTtlEnabled() {\n         assert cctx != null : \"Manager is not started\";\n \n-        return cleanupWorker != null;\n+        lock.lock();\n+\n+        try {\n+            return cleanupWorker != null;\n+        }\n+        finally {\n+            lock.unlock();\n+        }\n     }\n \n     /**\n      *\n      */\n     private void startCleanupWorker() {\n-        cleanupWorker = new CleanupWorker();\n+        lock.lock();\n \n-        new IgniteThread(cleanupWorker).start();\n+        try {\n+            if (cleanupWorker != null)\n+                return;\n+\n+            cleanupWorker = new CleanupWorker();\n+\n+            new IgniteThread(cleanupWorker).start();\n+        }\n+        finally {\n+            lock.unlock();\n+        }\n     }\n \n     /**\n      *\n      */\n     private void stopCleanupWorker() {\n-        if (null != cleanupWorker) {\n-            U.cancel(cleanupWorker);\n-            U.join(cleanupWorker, log);\n+        lock.lock();\n+\n+        try {\n+            if (null != cleanupWorker) {\n+                U.cancel(cleanupWorker);\n+                U.join(cleanupWorker, log);\n \n-            cleanupWorker = null;\n+                cleanupWorker = null;\n+            }\n+        }\n+        finally {\n+            lock.unlock();\n         }\n     }\n \n@@ -143,22 +163,32 @@ private void stopCleanupWorker() {\n \n                 assert !cctx.kernalContext().recoveryMode();\n \n+                final AtomicBoolean expiredRemains = new AtomicBoolean();\n+\n                 while (!isCancelled()) {\n-                    boolean expiredRemains = false;\n+                    expiredRemains.set(false);\n \n-                    for (GridCacheTtlManager mgr : mgrs) {\n+                    for (Map.Entry<Integer, GridCacheTtlManager> mgr : mgrs.entrySet()) {\n                         updateHeartbeat();\n \n-                        if (mgr.expire(CLEANUP_WORKER_ENTRIES_PROCESS_LIMIT))\n-                            expiredRemains = true;\n+                        Integer processedCacheID = mgr.getKey();\n+\n+                        // Need to be sure that the cache to be processed will not be unregistered and,\n+                        // therefore, stopped during the process of expiration is in progress.\n+                        mgrs.computeIfPresent(processedCacheID, (id, m) -> {\n+                            if (m.expire(CLEANUP_WORKER_ENTRIES_PROCESS_LIMIT))\n+                                expiredRemains.set(true);\n+\n+                            return m;\n+                        });\n \n                         if (isCancelled())\n                             return;\n                     }\n \n                     updateHeartbeat();\n \n-                    if (!expiredRemains)\n+                    if (!expiredRemains.get())\n                         U.sleep(CLEANUP_WORKER_SLEEP_INTERVAL);\n \n                     onIdle();",
                "raw_url": "https://github.com/apache/ignite/raw/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheSharedTtlCleanupManager.java",
                "sha": "bd9b6756fd716fe271eebe480bd90837c9c072d3",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheTtlManager.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheTtlManager.java?ref=85cf73fb964152b1edd5baa730bcf9e34e761819",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheTtlManager.java",
                "patch": "@@ -121,6 +121,15 @@ public boolean eagerTtlEnabled() {\n     @Override protected void onKernalStop0(boolean cancel) {\n         if (pendingEntries != null)\n             pendingEntries.clear();\n+    }\n+\n+    /**\n+     * Unregister this TTL manager of cache from periodical check on expired entries.\n+     */\n+    public void unregister() {\n+        // Ignoring attempt to unregister manager that has never been started.\n+        if (!starting.get())\n+            return;\n \n         cctx.shared().ttl().unregister(this);\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheTtlManager.java",
                "sha": "72e403b337c32015cdfe6370aca5589563fa9588",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/ignite/blob/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/IgnitePdsWithTtlTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/IgnitePdsWithTtlTest.java?ref=85cf73fb964152b1edd5baa730bcf9e34e761819",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/IgnitePdsWithTtlTest.java",
                "patch": "@@ -172,6 +172,8 @@ public void testTtlIsAppliedForMultipleCaches() throws Exception {\n \n         waitAndCheckExpired(srv, srv.cache(CACHE_NAME + \"-\" + (cacheCnt - 1)));\n \n+        srv.cluster().active(false);\n+\n         stopAllGrids();\n     }\n \n@@ -206,6 +208,8 @@ private void loadAndWaitForCleanup(boolean restartGrid) throws Exception {\n \n         waitAndCheckExpired(srv, cache);\n \n+        srv.cluster().active(false);\n+\n         stopAllGrids();\n     }\n \n@@ -230,6 +234,8 @@ public void testRebalancingWithTtlExpirable() throws Exception {\n \n         waitAndCheckExpired(srv, cache);\n \n+        srv.cluster().active(false);\n+\n         stopAllGrids();\n     }\n \n@@ -268,6 +274,8 @@ public void testStartStopAfterRebalanceWithTtlExpirable() throws Exception {\n \n             stopGrid(1);\n             startGrid(1);\n+\n+            srv.cluster().active(false);\n         }\n         finally {\n             stopAllGrids();",
                "raw_url": "https://github.com/apache/ignite/raw/85cf73fb964152b1edd5baa730bcf9e34e761819/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/IgnitePdsWithTtlTest.java",
                "sha": "e04f2a50e245a4ee142035a530d9daf50e567829",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12124 Fixed possible NullPointerException/Error related to the cache stop with configured TTL\n\nSigned-off-by: Andrey Gura <agura@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/669570906b1654b1a38a46f987fcede948f48f82",
        "patched_files": [
            "GridCacheSharedTtlCleanupManager.java",
            "GridCacheProcessor.java",
            "GridCacheTtlManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgnitePdsWithTtlTest.java"
        ]
    },
    "ignite_8633d34": {
        "bug_id": "ignite_8633d34",
        "commit": "https://github.com/apache/ignite/commit/8633d34ec7542cda739ad38448955ac09238006c",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/8633d34ec7542cda739ad38448955ac09238006c/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/IgniteCacheProxyImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/IgniteCacheProxyImpl.java?ref=8633d34ec7542cda739ad38448955ac09238006c",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/IgniteCacheProxyImpl.java",
                "patch": "@@ -755,6 +755,9 @@ private void validate(Query qry) {\n             (qry instanceof SqlQuery || qry instanceof SqlFieldsQuery || qry instanceof TextQuery))\n             throw new CacheException(\"Failed to execute query. Add module 'ignite-indexing' to the classpath \" +\n                     \"of all Ignite nodes.\");\n+\n+        if (qry.isLocal() && (qry instanceof SqlQuery) && ctx.kernalContext().clientNode())\n+            throw new CacheException(\"Execution of local sql query on client node disallowed.\");\n     }\n \n     /** {@inheritDoc} */",
                "raw_url": "https://github.com/apache/ignite/raw/8633d34ec7542cda739ad38448955ac09238006c/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/IgniteCacheProxyImpl.java",
                "sha": "688f293cf1df96ed38c608a693e776bb0add149a",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/ignite/blob/8633d34ec7542cda739ad38448955ac09238006c/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/distributed/replicated/IgniteCacheReplicatedQuerySelfTest.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/distributed/replicated/IgniteCacheReplicatedQuerySelfTest.java?ref=8633d34ec7542cda739ad38448955ac09238006c",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/distributed/replicated/IgniteCacheReplicatedQuerySelfTest.java",
                "patch": "@@ -28,6 +28,7 @@\n import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.CountDownLatch;\n import javax.cache.Cache;\n+import javax.cache.CacheException;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n import org.apache.ignite.IgniteException;\n@@ -52,6 +53,7 @@\n import static org.apache.ignite.cache.CacheMode.REPLICATED;\n import static org.apache.ignite.cache.CachePeekMode.ALL;\n import static org.apache.ignite.events.EventType.EVT_NODE_LEFT;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsWithCause;\n \n /**\n  * Tests replicated query.\n@@ -160,6 +162,31 @@ public void testClientOnlyNode() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testClientsLocalQuery() throws Exception {\n+        try {\n+            Ignite g = startGrid(\"client\");\n+\n+            IgniteCache<Integer, Integer> c = jcache(g, Integer.class, Integer.class);\n+\n+            for (int i = 0; i < 10; i++)\n+                c.put(i, i);\n+\n+            assertEquals(0, c.localSize());\n+\n+            SqlQuery<Integer, Integer> qry = new SqlQuery<>(Integer.class, \"_key >= 5 order by _key\");\n+\n+            qry.setLocal(true);\n+\n+            assertThrowsWithCause(() -> c.query(qry), CacheException.class);\n+        }\n+        finally {\n+            stopGrid(\"client\");\n+        }\n+    }\n+\n     /**\n      * JUnit.\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/8633d34ec7542cda739ad38448955ac09238006c/modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/distributed/replicated/IgniteCacheReplicatedQuerySelfTest.java",
                "sha": "bd3dffdbded4b3a2d7f9530374519ae54a7bd134",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8915: NPE during executing local SqlQuery from client node. - Fixes #4378.\n\nSigned-off-by: Nikolay Izhikov <nizhikov@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/26e405281792d38b5505cde22b5c6a91749c4990",
        "patched_files": [
            "IgniteCacheProxyImpl.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCacheReplicatedQuerySelfTest.java"
        ]
    },
    "ignite_895771a": {
        "bug_id": "ignite_895771a",
        "commit": "https://github.com/apache/ignite/commit/895771a79d8acca3baf06c23bf3f82483ec62d6f",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/895771a79d8acca3baf06c23bf3f82483ec62d6f/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java?ref=895771a79d8acca3baf06c23bf3f82483ec62d6f",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "patch": "@@ -1458,8 +1458,10 @@ public CommunicationListener getListener() {\n                     }\n                 };\n \n+                boolean clientMode = Boolean.TRUE.equals(ignite.configuration().isClientMode());\n+\n                 IgniteBiInClosure<GridNioSession, Integer> queueSizeMonitor =\n-                    !ignite.configuration().isClientMode() && slowClientQueueLimit > 0 ?\n+                    !clientMode && slowClientQueueLimit > 0 ?\n                     new CI2<GridNioSession, Integer>() {\n                         @Override public void apply(GridNioSession ses, Integer qSize) {\n                             checkClientQueueSize(ses, qSize);",
                "raw_url": "https://github.com/apache/ignite/raw/895771a79d8acca3baf06c23bf3f82483ec62d6f/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "sha": "bbb9b1ca06b92a3186579141f26b41b8bcbb1d20",
                "status": "modified"
            }
        ],
        "message": "# ignite-sprint-6 fixed NPE in comm spi unit tests",
        "parent": "https://github.com/apache/ignite/commit/ef4abeba881f079cab08af9ade99fe52ecf5d26d",
        "patched_files": [
            "TcpCommunicationSpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TestTcpCommunicationSpi.java"
        ]
    },
    "ignite_8c9e5e4": {
        "bug_id": "ignite_8c9e5e4",
        "commit": "https://github.com/apache/ignite/commit/8c9e5e46e102bcdd6e99f9f46197d834ebc9a428",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/8c9e5e46e102bcdd6e99f9f46197d834ebc9a428/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java?ref=8c9e5e46e102bcdd6e99f9f46197d834ebc9a428",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "patch": "@@ -5366,6 +5366,9 @@ public static void writeMap(ObjectOutput out, Map<?, ?> map) throws IOException\n      * @param obj Object.\n      */\n     public static int hashCode(Object obj) {\n+        if(obj == null)\n+            return 0;\n+\n         if (obj.getClass().isArray()) {\n             if (obj instanceof byte[])\n                 return Arrays.hashCode((byte[])obj);",
                "raw_url": "https://github.com/apache/ignite/raw/8c9e5e46e102bcdd6e99f9f46197d834ebc9a428/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "sha": "8c091961476f8710ad9cc563c27bb77a0270a384",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/8c9e5e46e102bcdd6e99f9f46197d834ebc9a428/modules/core/src/test/java/org/apache/ignite/cache/store/StoreArrayKeyTest.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/cache/store/StoreArrayKeyTest.java?ref=8c9e5e46e102bcdd6e99f9f46197d834ebc9a428",
                "deletions": 7,
                "filename": "modules/core/src/test/java/org/apache/ignite/cache/store/StoreArrayKeyTest.java",
                "patch": "@@ -82,15 +82,15 @@\n             new String[][] {new String[] {\"a\", \"b\", \"c\"}, new String[] {\"c\", \"b\", \"a\"}, new String[] {\"a\", \"b\", \"c\"}},\n             new Object[][] {\n                 new String[][] {\n-                    new String[] {\"a\", \"b\", \"c\"},\n-                    new String[] {\"a\", \"b\", \"c\"},\n-                    new String[] {\"a\", \"b\", \"c\"}\n+                    new String[] {\"a\", \"b\", null},\n+                    new String[] {\"a\", null, \"c\"},\n+                    new String[] {null, \"b\", \"c\"}\n                 },\n-                new String[] {\"c\", \"b\", \"a\"},\n+                new String[] {null, null, null},\n                 new String[][] {\n-                    new String[] {\"a\", \"b\", \"c\"},\n-                    new String[] {\"a\", \"b\", \"c\"},\n-                    new String[] {\"a\", \"b\", \"c\"}\n+                    new String[] {\"a\", \"b\", null},\n+                    new String[] {\"a\", null, \"c\"},\n+                    new String[] {null, \"b\", \"c\"}\n                 }}\n         );\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/8c9e5e46e102bcdd6e99f9f46197d834ebc9a428/modules/core/src/test/java/org/apache/ignite/cache/store/StoreArrayKeyTest.java",
                "sha": "52d3427a8e0e106ddf334762a41909fa41fba6cb",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12123 Cache throws npe at {null, null, null} array key. - Fixes #6828.\n\nSigned-off-by: Pavel Kovalenko <jokserfn@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/6afec64c208a5a6e52e8a18576aa14a748ad745b",
        "patched_files": [
            "IgniteUtils.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "StoreArrayKeyTest.java"
        ]
    },
    "ignite_8ede364": {
        "bug_id": "ignite_8ede364",
        "commit": "https://github.com/apache/ignite/commit/8ede36482b082bca583ea5be036a75d637f39173",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/8ede36482b082bca583ea5be036a75d637f39173/modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java?ref=8ede36482b082bca583ea5be036a75d637f39173",
                "deletions": 1,
                "filename": "modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java",
                "patch": "@@ -139,7 +139,7 @@\n         if (meta.phase() == GridHadoopJobPhase.PHASE_COMPLETE) {\n             Collection<GridFuture<?>> futures = jobs.remove(job.id());\n \n-            assert futures.isEmpty();\n+            assert futures == null || futures.isEmpty();\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/8ede36482b082bca583ea5be036a75d637f39173/modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java",
                "sha": "2c732695d84b8ed53899cd9ae07f5e9dc4cc1d15",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/8ede36482b082bca583ea5be036a75d637f39173/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java?ref=8ede36482b082bca583ea5be036a75d637f39173",
                "deletions": 1,
                "filename": "modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java",
                "patch": "@@ -85,7 +85,6 @@\n     @Override public GridHadoopConfiguration hadoopConfiguration(String gridName) {\n         GridHadoopConfiguration cfg = super.hadoopConfiguration(gridName);\n \n-        cfg.setExternalExecution(false);\n         cfg.setJobFactory(new HadoopTestJobFactory());\n         cfg.setMapReducePlanner(new GridHadoopTestRoundRobinMrPlanner());\n         cfg.setExternalExecution(false);",
                "raw_url": "https://github.com/apache/ignite/raw/8ede36482b082bca583ea5be036a75d637f39173/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java",
                "sha": "6f206a46d01c113639d4c3914a7f63c0e39b2c58",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/8ede36482b082bca583ea5be036a75d637f39173/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java?ref=8ede36482b082bca583ea5be036a75d637f39173",
                "deletions": 9,
                "filename": "modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java",
                "patch": "@@ -226,15 +226,6 @@ private void prepareFile(String fileName, int lineCnt) throws Exception {\n         }\n     }\n \n-    /** {@inheritDoc} */\n-    @Override public GridHadoopConfiguration hadoopConfiguration(String gridName) {\n-        GridHadoopConfiguration cfg = super.hadoopConfiguration(gridName);\n-\n-        cfg.setExternalExecution(false);\n-\n-        return cfg;\n-    }\n-\n     /**\n      * @throws Exception If failed.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/8ede36482b082bca583ea5be036a75d637f39173/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java",
                "sha": "519a0893879a2ef0fe1c41ca63aa6557bdd4ca0d",
                "status": "modified"
            }
        ],
        "message": "#GG-8366 NPE in GridHadoopJobTrackerSelfTest.testTaskWithCombiner",
        "parent": "https://github.com/apache/ignite/commit/17fd3222c57001f584dc38fa2bc3cd6178b5f18a",
        "patched_files": [
            "GridHadoopEmbeddedTaskExecutor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridHadoopTaskExecutionSelfTest.java",
            "GridHadoopJobTrackerSelfTest.java"
        ]
    },
    "ignite_93f19a4": {
        "bug_id": "ignite_93f19a4",
        "commit": "https://github.com/apache/ignite/commit/93f19a464f70e630e71ac53a48c63d66058674ce",
        "file": [
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 4,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java",
                "patch": "@@ -2044,7 +2044,11 @@ private boolean recordable(TcpDiscoveryAbstractMessage msg) {\n      * @param rmtPerms The second set of permissions.\n      * @return {@code True} if given parameters contain the same permissions, {@code False} otherwise.\n      */\n-    private boolean permissionsEqual(SecurityPermissionSet locPerms, SecurityPermissionSet rmtPerms) {\n+    private boolean permissionsEqual(@Nullable SecurityPermissionSet locPerms,\n+        @Nullable SecurityPermissionSet rmtPerms) {\n+        if (locPerms == null || rmtPerms == null)\n+            return false;\n+\n         boolean dfltAllowMatch = locPerms.defaultAllowAll() == rmtPerms.defaultAllowAll();\n \n         boolean bothHaveSamePerms = F.eqNotOrdered(rmtPerms.systemPermissions(), locPerms.systemPermissions()) &&\n@@ -4737,7 +4741,7 @@ else if (!locNodeId.equals(node.id()) && ring.node(node.id()) != null) {\n                                 spi.marshaller(), U.resolveClassLoader(spi.ignite().configuration()), node\n                             );\n \n-                            if (!permissionsEqual(coordSubj.subject().permissions(), subj.subject().permissions())) {\n+                            if (!permissionsEqual(getPermissions(coordSubj), getPermissions(subj))) {\n                                 // Node has not pass authentication.\n                                 LT.warn(log, \"Authentication failed [nodeId=\" + node.id() +\n                                     \", addrs=\" + U.addressesAsString(node) + ']');\n@@ -4838,8 +4842,7 @@ else if (spiState == CONNECTING)\n                                         spi.marshaller(), ldr, locNode\n                                     );\n \n-                                    if (!permissionsEqual(locCrd.subject().permissions(),\n-                                        rmCrd.subject().permissions())) {\n+                                    if (!permissionsEqual(getPermissions(locCrd), getPermissions(rmCrd))) {\n                                         // Node has not pass authentication.\n                                         LT.warn(log,\n                                             \"Failed to authenticate local node \" +\n@@ -4937,6 +4940,17 @@ else if (spiState == CONNECTING)\n                 sendMessageAcrossRing(msg);\n         }\n \n+        /**\n+         * @param secCtx Security context.\n+         * @return Security permission set.\n+         */\n+        private @Nullable SecurityPermissionSet getPermissions(SecurityContext secCtx) {\n+            if (secCtx == null || secCtx.subject() == null)\n+                return null;\n+\n+            return secCtx.subject().permissions();\n+        }\n+\n         /**\n          * Processes node add finished message.\n          *",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java",
                "sha": "4a4b15a1c7b309afc470f26e5d5f65b95b3e445b",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/AbstractSecurityTest.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/security/AbstractSecurityTest.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/security/AbstractSecurityTest.java",
                "patch": "@@ -35,6 +35,9 @@\n     /** Empty array of permissions. */\n     protected static final SecurityPermission[] EMPTY_PERMS = new SecurityPermission[0];\n \n+    /** Global authentication flag. */\n+    protected boolean globalAuth;\n+\n     /** {@inheritDoc} */\n     @Override protected void afterTestsStopped() throws Exception {\n         stopAllGrids();\n@@ -76,7 +79,7 @@ protected IgniteEx startClientAllowAll(String login) throws Exception {\n      * @param isClient Is client.\n      */\n     protected IgniteEx startGrid(String login, SecurityPermissionSet prmSet, boolean isClient) throws Exception {\n-        return startGrid(getConfiguration(login, new TestSecurityPluginProvider(login, \"\", prmSet))\n+        return startGrid(getConfiguration(login, new TestSecurityPluginProvider(login, \"\", prmSet, globalAuth))\n                 .setClientMode(isClient));\n     }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/AbstractSecurityTest.java",
                "sha": "13688dccc7ad687e16765bff2e2789a526c777e4",
                "status": "modified"
            },
            {
                "additions": 65,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/InvalidServerTest.java",
                "changes": 65,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/security/InvalidServerTest.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/security/InvalidServerTest.java",
                "patch": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.security;\n+\n+import org.apache.ignite.IgniteAuthenticationException;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.processors.security.impl.TestSecurityProcessor;\n+import org.apache.ignite.plugin.security.SecurityCredentials;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.messages.TcpDiscoveryAbstractMessage;\n+import org.apache.ignite.spi.discovery.tcp.messages.TcpDiscoveryJoinRequestMessage;\n+import org.apache.ignite.spi.discovery.tcp.messages.TcpDiscoveryNodeAddedMessage;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsWithCause;\n+\n+/**\n+ * Test server connection when it's permissions are removed after\n+ * {@link TcpDiscoveryJoinRequestMessage} processed.\n+ */\n+public class InvalidServerTest extends AbstractSecurityTest {\n+    /** Test server name. */\n+    private static final String TEST_SERVER_NAME = \"test_server\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String instanceName,\n+            AbstractTestSecurityPluginProvider pluginProv) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(instanceName, pluginProv);\n+\n+        cfg.setDiscoverySpi(new TcpDiscoverySpi() {\n+            @Override protected void startMessageProcess(TcpDiscoveryAbstractMessage msg) {\n+                if (msg instanceof TcpDiscoveryNodeAddedMessage && msg.verified())\n+                    TestSecurityProcessor.PERMS.remove(new SecurityCredentials(TEST_SERVER_NAME, \"\"));\n+            }\n+        });\n+\n+        return cfg;\n+    }\n+\n+    /** */\n+    @Test\n+    public void testInvalidServer() throws Exception {\n+        globalAuth = true;\n+\n+        startGridAllowAll(\"server1\");\n+        startGridAllowAll(\"server2\");\n+\n+        assertThrowsWithCause(() -> startGridAllowAll(TEST_SERVER_NAME), IgniteAuthenticationException.class);\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/InvalidServerTest.java",
                "sha": "7e2e6dcd5b50960ed1441a1f53b88037ccefac32",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/client/ThinClientPermissionCheckTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/security/client/ThinClientPermissionCheckTest.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/security/client/ThinClientPermissionCheckTest.java",
                "patch": "@@ -99,7 +99,7 @@ private IgniteConfiguration getConfiguration(int idx, TestSecurityData... client\n \n         return getConfiguration(\n             instanceName,\n-            new TestSecurityPluginProvider(\"srv_\" + instanceName, null, ALLOW_ALL, clientData)\n+            new TestSecurityPluginProvider(\"srv_\" + instanceName, null, ALLOW_ALL, false, clientData)\n         ).setCacheConfiguration(\n             new CacheConfiguration().setName(CACHE),\n             new CacheConfiguration().setName(FORBIDDEN_CACHE)",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/client/ThinClientPermissionCheckTest.java",
                "sha": "6f5354ca9c20c8e32e6953b3bfaa2c19dc3e806b",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityPluginProvider.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityPluginProvider.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityPluginProvider.java",
                "patch": "@@ -34,22 +34,27 @@\n     /** Permissions. */\n     private final SecurityPermissionSet perms;\n \n+    /** Global authentication. */\n+    private final boolean globalAuth;\n+\n     /** Users security data. */\n     private final TestSecurityData[] clientData;\n \n     /** */\n-    public TestSecurityPluginProvider(String login, String pwd, SecurityPermissionSet perms,\n+    public TestSecurityPluginProvider(String login, String pwd, SecurityPermissionSet perms, boolean globalAuth,\n         TestSecurityData... clientData) {\n         this.login = login;\n         this.pwd = pwd;\n         this.perms = perms;\n+        this.globalAuth = globalAuth;\n         this.clientData = clientData.clone();\n     }\n \n     /** {@inheritDoc} */\n     @Override protected GridSecurityProcessor securityProcessor(GridKernalContext ctx) {\n         return new TestSecurityProcessor(ctx,\n             new TestSecurityData(login, pwd, perms),\n-            Arrays.asList(clientData));\n+            Arrays.asList(clientData),\n+            globalAuth);\n     }\n }",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityPluginProvider.java",
                "sha": "5ee18ff44bde456de96cfa89ede4695f8ab935f8",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityProcessor.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityProcessor.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 3,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityProcessor.java",
                "patch": "@@ -46,29 +46,36 @@\n  */\n public class TestSecurityProcessor extends GridProcessorAdapter implements GridSecurityProcessor {\n     /** Permissions. */\n-    private static final Map<SecurityCredentials, SecurityPermissionSet> PERMS = new ConcurrentHashMap<>();\n+    public static final Map<SecurityCredentials, SecurityPermissionSet> PERMS = new ConcurrentHashMap<>();\n \n     /** Node security data. */\n     private final TestSecurityData nodeSecData;\n \n     /** Users security data. */\n     private final Collection<TestSecurityData> predefinedAuthData;\n \n+    /** Global authentication. */\n+    private final boolean globalAuth;\n+\n     /**\n      * Constructor.\n      */\n     public TestSecurityProcessor(GridKernalContext ctx, TestSecurityData nodeSecData,\n-        Collection<TestSecurityData> predefinedAuthData) {\n+        Collection<TestSecurityData> predefinedAuthData, boolean globalAuth) {\n         super(ctx);\n \n         this.nodeSecData = nodeSecData;\n         this.predefinedAuthData = predefinedAuthData.isEmpty()\n             ? Collections.emptyList()\n             : new ArrayList<>(predefinedAuthData);\n+        this.globalAuth = globalAuth;\n     }\n \n     /** {@inheritDoc} */\n     @Override public SecurityContext authenticateNode(ClusterNode node, SecurityCredentials cred) {\n+        if (!PERMS.containsKey(cred))\n+            return null;\n+\n         return new TestSecurityContext(\n             new TestSecuritySubject()\n                 .setType(REMOTE_NODE)\n@@ -81,11 +88,14 @@ public TestSecurityProcessor(GridKernalContext ctx, TestSecurityData nodeSecData\n \n     /** {@inheritDoc} */\n     @Override public boolean isGlobalNodeAuthentication() {\n-        return false;\n+        return globalAuth;\n     }\n \n     /** {@inheritDoc} */\n     @Override public SecurityContext authenticate(AuthenticationContext ctx) {\n+        if (!PERMS.containsKey(ctx.credentials()))\n+            return null;\n+\n         return new TestSecurityContext(\n             new TestSecuritySubject()\n                 .setType(ctx.subjectType())",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/internal/processors/security/impl/TestSecurityProcessor.java",
                "sha": "b62f97bf022c1c5afccf4e0f46e6897841ff8e9b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/testsuites/SecurityTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/SecurityTestSuite.java?ref=93f19a464f70e630e71ac53a48c63d66058674ce",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/SecurityTestSuite.java",
                "patch": "@@ -17,6 +17,7 @@\n \n package org.apache.ignite.testsuites;\n \n+import org.apache.ignite.internal.processors.security.InvalidServerTest;\n import org.apache.ignite.internal.processors.security.cache.CacheOperationPermissionCheckTest;\n import org.apache.ignite.internal.processors.security.cache.EntryProcessorPermissionCheckTest;\n import org.apache.ignite.internal.processors.security.cache.ScanQueryPermissionCheckTest;\n@@ -52,6 +53,7 @@\n     DataStreamerRemoteSecurityContextCheckTest.class,\n     CacheLoadRemoteSecurityContextCheckTest.class,\n     ThinClientPermissionCheckTest.class,\n+    InvalidServerTest.class,\n })\n public class SecurityTestSuite {\n }",
                "raw_url": "https://github.com/apache/ignite/raw/93f19a464f70e630e71ac53a48c63d66058674ce/modules/core/src/test/java/org/apache/ignite/testsuites/SecurityTestSuite.java",
                "sha": "5b7725e729e2f0c492ed7b890cff66a5ac8fe495",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12232 NPE while authenticating joined node - Fixes #6911.\n\nSigned-off-by: Aleksey Plekhanov <plehanov.alex@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/ce9f593495a6c9c89311aa1608ffda7fe92d0aa0",
        "patched_files": [
            "SecurityTestSuite.java",
            "ServerImpl.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TestSecurityProcessor.java",
            "ThinClientPermissionCheckTest.java",
            "TestSecurityPluginProvider.java",
            "AbstractSecurityTest.java",
            "InvalidServerTest.java"
        ]
    },
    "ignite_95850b4": {
        "bug_id": "ignite_95850b4",
        "commit": "https://github.com/apache/ignite/commit/95850b47bde6df109ecd029d6a3a59b8e3772f81",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/95850b47bde6df109ecd029d6a3a59b8e3772f81/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java?ref=95850b47bde6df109ecd029d6a3a59b8e3772f81",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "patch": "@@ -1858,11 +1858,11 @@ public static synchronized boolean isLocalHostChanged() throws IOException {\n      * @return List of reachable addresses.\n      */\n     public static List<InetAddress> filterReachable(Collection<InetAddress> addrs) {\n-        final int reachTimeout = 2000;\n-\n         if (addrs.isEmpty())\n             return Collections.emptyList();\n \n+        final int reachTimeout = 2000;\n+\n         if (addrs.size() == 1) {\n             InetAddress addr = F.first(addrs);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/95850b47bde6df109ecd029d6a3a59b8e3772f81/modules/core/src/main/java/org/apache/ignite/internal/util/IgniteUtils.java",
                "sha": "0668708c8e15904b19bc84d92f001004d8911663",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/ignite/blob/95850b47bde6df109ecd029d6a3a59b8e3772f81/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java?ref=95850b47bde6df109ecd029d6a3a59b8e3772f81",
                "deletions": 6,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "patch": "@@ -2885,22 +2885,27 @@ protected GridCommunicationClient createTcpClient(ClusterNode node, int connIdx)\n \n         Set<InetAddress> allInetAddrs = U.newHashSet(addrs.size());\n \n-        for (InetSocketAddress addr : addrs)\n-            allInetAddrs.add(addr.getAddress());\n+        for (InetSocketAddress addr : addrs) {\n+            // Skip unresolved as addr.getAddress() can return null.\n+            if(!addr.isUnresolved())\n+                allInetAddrs.add(addr.getAddress());\n+        }\n \n         List<InetAddress> reachableInetAddrs = U.filterReachable(allInetAddrs);\n \n         if (reachableInetAddrs.size() < allInetAddrs.size()) {\n             LinkedHashSet<InetSocketAddress> addrs0 = U.newLinkedHashSet(addrs.size());\n \n+            List<InetSocketAddress> unreachableInetAddr = new ArrayList<>(allInetAddrs.size() - reachableInetAddrs.size());\n+\n             for (InetSocketAddress addr : addrs) {\n                 if (reachableInetAddrs.contains(addr.getAddress()))\n                     addrs0.add(addr);\n+                else\n+                    unreachableInetAddr.add(addr);\n             }\n-            for (InetSocketAddress addr : addrs) {\n-                if (!reachableInetAddrs.contains(addr.getAddress()))\n-                    addrs0.add(addr);\n-            }\n+\n+            addrs0.addAll(unreachableInetAddr);\n \n             addrs = addrs0;\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/95850b47bde6df109ecd029d6a3a59b8e3772f81/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "sha": "769a02ed0da8cd26921346e9d3fca4fe45f7bcca",
                "status": "modified"
            }
        ],
        "message": "IGNITE-5225: Fix NPE caused by changes in IGNITE-4577.\n\n(cherry picked from commit d463840)",
        "parent": "https://github.com/apache/ignite/commit/dacf973ef8580ff649fc2dafd5a55a420edf7759",
        "patched_files": [
            "TcpCommunicationSpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TestTcpCommunicationSpi.java"
        ]
    },
    "ignite_9ecccc7": {
        "bug_id": "ignite_9ecccc7",
        "commit": "https://github.com/apache/ignite/commit/9ecccc7c559342fcc6b67457f7456d6af2c084d8",
        "file": [
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/ignite/blob/9ecccc7c559342fcc6b67457f7456d6af2c084d8/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "changes": 63,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java?ref=9ecccc7c559342fcc6b67457f7456d6af2c084d8",
                "deletions": 18,
                "filename": "modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "patch": "@@ -17,24 +17,33 @@\n \n package org.apache.ignite.internal.jdbc2;\n \n-import org.apache.ignite.*;\n-import org.apache.ignite.cache.affinity.*;\n-import org.apache.ignite.cache.query.annotations.*;\n-import org.apache.ignite.configuration.*;\n-import org.apache.ignite.internal.util.typedef.*;\n-import org.apache.ignite.spi.discovery.tcp.*;\n-import org.apache.ignite.spi.discovery.tcp.ipfinder.*;\n-import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.*;\n-import org.apache.ignite.testframework.junits.common.*;\n-\n-import java.io.*;\n-import java.sql.*;\n-import java.util.*;\n-\n-import static java.sql.Types.*;\n-import static org.apache.ignite.IgniteJdbcDriver.*;\n-import static org.apache.ignite.cache.CacheMode.*;\n-import static org.apache.ignite.cache.CacheWriteSynchronizationMode.*;\n+import java.io.Serializable;\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.DriverManager;\n+import java.sql.ResultSet;\n+import java.sql.ResultSetMetaData;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.affinity.AffinityKey;\n+import org.apache.ignite.cache.query.annotations.QuerySqlField;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.ConnectorConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.util.typedef.F;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+import static java.sql.Types.INTEGER;\n+import static java.sql.Types.OTHER;\n+import static java.sql.Types.VARCHAR;\n+import static org.apache.ignite.IgniteJdbcDriver.CFG_URL_PREFIX;\n+import static org.apache.ignite.cache.CacheMode.PARTITIONED;\n+import static org.apache.ignite.cache.CacheWriteSynchronizationMode.FULL_SYNC;\n \n /**\n  * Metadata tests.\n@@ -276,6 +285,24 @@ public void testGetColumns() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMetadataResultSetClose() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(BASE_URL);\n+             ResultSet tbls = conn.getMetaData().getTables(null, null, \"%\", null)) {\n+            int colCnt = tbls.getMetaData().getColumnCount();\n+\n+            while (tbls.next()) {\n+                for (int i = 0; i < colCnt; i++)\n+                    tbls.getObject(i + 1);\n+            }\n+        }\n+        catch (Exception e) {\n+            fail();\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/9ecccc7c559342fcc6b67457f7456d6af2c084d8/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "sha": "7184b8dea1a115cb5b56b615cbbfb7a474dbba72",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/ignite/blob/9ecccc7c559342fcc6b67457f7456d6af2c084d8/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java?ref=9ecccc7c559342fcc6b67457f7456d6af2c084d8",
                "deletions": 0,
                "filename": "modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "patch": "@@ -288,6 +288,24 @@ public void testGetColumns() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMetadataResultSetClose() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(URL);\n+             ResultSet tbls = conn.getMetaData().getTables(null, null, \"%\", null)) {\n+            int colCnt = tbls.getMetaData().getColumnCount();\n+\n+            while (tbls.next()) {\n+                for (int i = 0; i < colCnt; i++)\n+                    tbls.getObject(i + 1);\n+            }\n+        }\n+        catch (Exception e) {\n+            fail();\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/9ecccc7c559342fcc6b67457f7456d6af2c084d8/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "sha": "72d93c97009cdeb481b20fb4b81c3bc1cdc216a8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/9ecccc7c559342fcc6b67457f7456d6af2c084d8/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java?ref=9ecccc7c559342fcc6b67457f7456d6af2c084d8",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "patch": "@@ -182,7 +182,7 @@ else if (!finished) {\n      * If this result set is associated with locally executed query then query cursor will also closed.\n      */\n     void closeInternal() throws SQLException  {\n-        if (((JdbcConnection)stmt.getConnection()).nodeId() == null)\n+        if (((JdbcConnection)stmt.getConnection()).nodeId() == null && uuid != null)\n             JdbcQueryTask.remove(uuid);\n \n         closed = true;",
                "raw_url": "https://github.com/apache/ignite/raw/9ecccc7c559342fcc6b67457f7456d6af2c084d8/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "sha": "69dddad3ad27859354e40aef9e8a63b7c9bb8f33",
                "status": "modified"
            }
        ],
        "message": " IGNITE-3389 metadata result set throws NPE when closed - fixed",
        "parent": "https://github.com/apache/ignite/commit/c075ab33254b7178c6e6b0a7b16801e787189ced",
        "patched_files": [
            "JdbcResultSet.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "JdbcMetadataSelfTest.java"
        ]
    },
    "ignite_a03c6e9": {
        "bug_id": "ignite_a03c6e9",
        "commit": "https://github.com/apache/ignite/commit/a03c6e9833e4767025c9aefeedbead07495da4a5",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FsyncModeFileWriteAheadLogManager.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FsyncModeFileWriteAheadLogManager.java?ref=a03c6e9833e4767025c9aefeedbead07495da4a5",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FsyncModeFileWriteAheadLogManager.java",
                "patch": "@@ -2330,19 +2330,22 @@ public static long writeSerializerVersion(FileIO io, long idx, int version, WALM\n     private abstract static class FileHandle {\n         /** I/O interface for read/write operations with file */\n         protected SegmentIO fileIO;\n+        /** Segment idx corresponded to fileIo*/\n+        final long segmentIdx;\n \n         /**\n          * @param fileIO I/O interface for read/write operations of FileHandle.\n          */\n-        private FileHandle(SegmentIO fileIO) {\n+        private FileHandle(@NotNull SegmentIO fileIO) {\n             this.fileIO = fileIO;\n+            this.segmentIdx = fileIO.getSegmentId();\n         }\n \n         /**\n          * @return Current segment id.\n          */\n         public long getSegmentId(){\n-            return fileIO.getSegmentId();\n+            return segmentIdx;\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/wal/FsyncModeFileWriteAheadLogManager.java",
                "sha": "3d1b0e0304d2fc7917a32b89f9b5fb0b5ccacc6c",
                "status": "modified"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/ignite/blob/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingFsyncTest.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingFsyncTest.java?ref=a03c6e9833e4767025c9aefeedbead07495da4a5",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingFsyncTest.java",
                "patch": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.wal;\n+\n+import org.apache.ignite.configuration.WALMode;\n+import org.jetbrains.annotations.NotNull;\n+\n+/**\n+ *\n+ */\n+public class WalRolloverRecordLoggingFsyncTest extends WalRolloverRecordLoggingTest {\n+\n+    /** {@inheritDoc} */\n+    @NotNull @Override public WALMode walMode() {\n+        return WALMode.FSYNC;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingFsyncTest.java",
                "sha": "7454e5f68dfe26e023ce1ada3ceaf2430927b3f9",
                "status": "added"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/ignite/blob/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingLogOnlyTest.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingLogOnlyTest.java?ref=a03c6e9833e4767025c9aefeedbead07495da4a5",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingLogOnlyTest.java",
                "patch": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.persistence.db.wal;\n+\n+import org.apache.ignite.configuration.WALMode;\n+import org.jetbrains.annotations.NotNull;\n+\n+/**\n+ *\n+ */\n+public class WalRolloverRecordLoggingLogOnlyTest extends WalRolloverRecordLoggingTest {\n+\n+    /** {@inheritDoc} */\n+    @NotNull @Override public WALMode walMode() {\n+        return WALMode.LOG_ONLY;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingLogOnlyTest.java",
                "sha": "765fdeb5c455671a5c3a6bd3961d5e6f9e41d4c2",
                "status": "added"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/ignite/blob/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java?ref=a03c6e9833e4767025c9aefeedbead07495da4a5",
                "deletions": 6,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java",
                "patch": "@@ -23,6 +23,7 @@\n import org.apache.ignite.configuration.DataRegionConfiguration;\n import org.apache.ignite.configuration.DataStorageConfiguration;\n import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.configuration.WALMode;\n import org.apache.ignite.failure.StopNodeOrHaltFailureHandler;\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.IgniteInternalFuture;\n@@ -36,13 +37,11 @@\n import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n import org.apache.ignite.testframework.GridTestUtils;\n import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n-\n-import static org.apache.ignite.configuration.DataStorageConfiguration.DFLT_WAL_PATH;\n-import static org.apache.ignite.configuration.WALMode.LOG_ONLY;\n+import org.jetbrains.annotations.NotNull;\n /**\n  *\n  */\n-public class WalRolloverRecordLoggingTest extends GridCommonAbstractTest {\n+public abstract class WalRolloverRecordLoggingTest extends GridCommonAbstractTest {\n     /** */\n     private static final TcpDiscoveryIpFinder IP_FINDER = new TcpDiscoveryVmIpFinder(true);\n \n@@ -69,15 +68,20 @@ private RolloverRecord() {\n             .setDefaultDataRegionConfiguration(new DataRegionConfiguration()\n                 .setPersistenceEnabled(true)\n                 .setMaxSize(40 * 1024 * 1024))\n-            .setWalMode(LOG_ONLY)\n+            .setWalMode(walMode())\n             .setWalSegmentSize(4 * 1024 * 1024)\n-            .setWalArchivePath(DFLT_WAL_PATH));\n+        );\n \n         cfg.setFailureHandler(new StopNodeOrHaltFailureHandler(false, 0));\n \n         return cfg;\n     }\n \n+    /**\n+     * @return Wal mode.\n+     */\n+    @NotNull public abstract WALMode walMode();\n+\n     /** {@inheritDoc} */\n     @Override protected void beforeTest() throws Exception {\n         stopAllGrids();",
                "raw_url": "https://github.com/apache/ignite/raw/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/db/wal/WalRolloverRecordLoggingTest.java",
                "sha": "395b03ae4367ce680c35ad2f7b2e08ba8a13600d",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java?ref=a03c6e9833e4767025c9aefeedbead07495da4a5",
                "deletions": 2,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "patch": "@@ -40,7 +40,8 @@\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.IgniteWalRecoveryWithCompactionTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalPathsTest;\n import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRecoveryTxLogicalRecordsTest;\n-import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRolloverRecordLoggingTest;\n+import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRolloverRecordLoggingFsyncTest;\n+import org.apache.ignite.internal.processors.cache.persistence.db.wal.WalRolloverRecordLoggingLogOnlyTest;\n \n /**\n  * Test suite for tests that cover core PDS features and depend on indexing module.\n@@ -60,7 +61,8 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(PersistenceDirectoryWarningLoggingTest.class);\n         suite.addTestSuite(WalPathsTest.class);\n         suite.addTestSuite(WalRecoveryTxLogicalRecordsTest.class);\n-        suite.addTestSuite(WalRolloverRecordLoggingTest.class);\n+        suite.addTestSuite(WalRolloverRecordLoggingFsyncTest.class);\n+        suite.addTestSuite(WalRolloverRecordLoggingLogOnlyTest.class);\n \n         suite.addTestSuite(IgniteWalRecoveryTest.class);\n         suite.addTestSuite(IgniteWalRecoveryWithCompactionTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/a03c6e9833e4767025c9aefeedbead07495da4a5/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingCoreTestSuite.java",
                "sha": "e9159bf7cd553b0552c53d55c271ae6be52d12c7",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9760 Fixed NPE in WAL manager for FSYNC mode - Fixes #4888.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/bd07c83583807714757ed033901bf885c9a77b24",
        "patched_files": [
            "IgnitePdsWithIndexingCoreTestSuite.java",
            "FsyncModeFileWriteAheadLogManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "WalRolloverRecordLoggingFsyncTest.java",
            "WalRolloverRecordLoggingLogOnlyTest.java",
            "WalRolloverRecordLoggingTest.java"
        ]
    },
    "ignite_a1ec83a": {
        "bug_id": "ignite_a1ec83a",
        "commit": "https://github.com/apache/ignite/commit/a1ec83a826f1a87b88dd16f93d0ee3b3168439b9",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/a1ec83a826f1a87b88dd16f93d0ee3b3168439b9/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java?ref=a1ec83a826f1a87b88dd16f93d0ee3b3168439b9",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "patch": "@@ -2781,6 +2781,9 @@ private void sendMessage0(ClusterNode node, Message msg, IgniteInClosure<IgniteE\n                 while (retry);\n             }\n             catch (Throwable t) {\n+                if (stopping)\n+                    throw new IgniteSpiException(\"Node is stopping.\", t);\n+\n                 log.error(\"Failed to send message to remote node [node=\" + node + \", msg=\" + msg + ']', t);\n \n                 if (t instanceof Error)",
                "raw_url": "https://github.com/apache/ignite/raw/a1ec83a826f1a87b88dd16f93d0ee3b3168439b9/modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java",
                "sha": "243f707bce7a59038c895d4c3664eccfc03bab0b",
                "status": "modified"
            }
        ],
        "message": "IGNITE-11293 Fix of NPE in TcpCommunicationSpi caused by simultaneous node stopping. - Fixes #6081.\n\nSigned-off-by: Dmitriy Govorukhin <dmitriy.govorukhin@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/033170d90f6c0618b9d6a3fd997e13a5ec1fff89",
        "patched_files": [
            "TcpCommunicationSpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TestTcpCommunicationSpi.java"
        ]
    },
    "ignite_a3d8fee": {
        "bug_id": "ignite_a3d8fee",
        "commit": "https://github.com/apache/ignite/commit/a3d8feec9c0d1fe784d7be116f56b84986ab344c",
        "file": [
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/ignite/blob/a3d8feec9c0d1fe784d7be116f56b84986ab344c/modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java?ref=a3d8feec9c0d1fe784d7be116f56b84986ab344c",
                "deletions": 20,
                "filename": "modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java",
                "patch": "@@ -11,7 +11,6 @@\n \n import org.gridgain.grid.*;\n import org.gridgain.grid.hadoop.*;\n-import org.gridgain.grid.kernal.processors.hadoop.*;\n import org.gridgain.grid.kernal.processors.hadoop.jobtracker.*;\n import org.gridgain.grid.util.*;\n import org.gridgain.grid.util.lang.*;\n@@ -26,7 +25,7 @@\n /**\n  * Task executor.\n  */\n-public class GridHadoopTaskExecutor extends GridHadoopComponent {\n+public class GridHadoopEmbeddedTaskExecutor extends GridHadoopTaskExecutorAdapter {\n     /** Job tracker. */\n     private GridHadoopJobTracker jobTracker;\n \n@@ -40,13 +39,8 @@\n         jobTracker = ctx.jobTracker();\n     }\n \n-    /**\n-     * Runs tasks.\n-     *\n-     * @param job Job.\n-     * @param tasks Tasks.\n-     */\n-    public void run(final GridHadoopJob job, Collection<GridHadoopTask> tasks) {\n+    /** {@inheritDoc} */\n+    @Override public void run(final GridHadoopJob job, Collection<GridHadoopTaskInfo> tasks) {\n         if (log.isDebugEnabled())\n             log.debug(\"Submitting tasks for local execution [locNodeId=\" + ctx.localNodeId() +\n                 \", tasksCnt=\" + tasks.size() + ']');\n@@ -61,24 +55,24 @@ public void run(final GridHadoopJob job, Collection<GridHadoopTask> tasks) {\n             assert extractedCol == null;\n         }\n \n-        for (final GridHadoopTask task : tasks) {\n-            assert task != null;\n+        for (final GridHadoopTaskInfo info : tasks) {\n+            assert info != null;\n \n             GridFuture<GridFuture<?>> fut = ctx.kernalContext().closure().callLocalSafe(new GridPlainCallable<GridFuture<?>>() {\n                 @Override public GridFuture<?> call() throws Exception {\n-                    GridHadoopTaskInfo info = task.info();\n-\n                     try (GridHadoopTaskOutput out = createOutput(info);\n                          GridHadoopTaskInput in = createInput(info)) {\n-                        GridHadoopTaskContext taskCtx = new GridHadoopTaskContext(ctx.kernalContext(), job, in, out);\n+                        GridHadoopTaskContext taskCtx = new GridHadoopTaskContext(job, in, out);\n+\n+                        GridHadoopTask task = job.createTask(info);\n \n                         if (log.isDebugEnabled())\n                             log.debug(\"Running task: \" + task);\n \n                         task.run(taskCtx);\n                     }\n                     catch (Exception e) {\n-                        U.error(log, \"Failed to execute task: \" + task.info(), e);\n+                        U.error(log, \"Failed to execute task: \" + info, e);\n \n                         throw e;\n                     }\n@@ -90,8 +84,8 @@ public void run(final GridHadoopJob job, Collection<GridHadoopTask> tasks) {\n             futures.add(fut);\n \n             fut.listenAsync(new CIX1<GridFuture<?>>() {\n-                @Override public void applyx(GridFuture<?> f) throws GridException {\n-                    Collection<GridFuture<?>> futs = jobs.get(task.info().jobId());\n+                @Override public void applyx(GridFuture<?> f) {\n+                    Collection<GridFuture<?>> futs = jobs.get(info.jobId());\n \n                     futs.remove(f);\n \n@@ -101,15 +95,15 @@ public void run(final GridHadoopJob job, Collection<GridHadoopTask> tasks) {\n                     try {\n                         f.get();\n                     }\n-                    catch (GridFutureCancelledException e) {\n+                    catch (GridFutureCancelledException ignored) {\n                         state = CANCELED;\n                     }\n                     catch (Throwable e) {\n                         state = FAILED;\n                         err = e;\n                     }\n \n-                    jobTracker.onTaskFinished(task.info(), new GridHadoopTaskStatus(state, err));\n+                    jobTracker.onTaskFinished(info, new GridHadoopTaskStatus(state, err));\n                 }\n             });\n         }\n@@ -125,7 +119,7 @@ public void run(final GridHadoopJob job, Collection<GridHadoopTask> tasks) {\n      *\n      * @param jobId Job ID to cancel.\n      */\n-    public void cancelTasks(GridHadoopJobId jobId) {\n+    @Override public void cancelTasks(GridHadoopJobId jobId) {\n         Collection<GridFuture<?>> futures = jobs.get(jobId);\n \n         if (futures != null) {\n@@ -140,6 +134,15 @@ public void cancelTasks(GridHadoopJobId jobId) {\n         }\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public void onJobStateChanged(GridHadoopJob job, GridHadoopJobMetadata meta) {\n+        if (meta.phase() == GridHadoopJobPhase.PHASE_COMPLETE) {\n+            Collection<GridFuture<?>> futures = jobs.remove(job.id());\n+\n+            assert futures.isEmpty();\n+        }\n+    }\n+\n     /**\n      * Creates task output.\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/a3d8feec9c0d1fe784d7be116f56b84986ab344c/modules/hadoop/src/main/java/org/gridgain/grid/kernal/processors/hadoop/taskexecutor/GridHadoopEmbeddedTaskExecutor.java",
                "sha": "7b061d26722b3975df88ab5b6f4083026484e9f5",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/a3d8feec9c0d1fe784d7be116f56b84986ab344c/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java?ref=a3d8feec9c0d1fe784d7be116f56b84986ab344c",
                "deletions": 0,
                "filename": "modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java",
                "patch": "@@ -85,6 +85,7 @@\n     @Override public GridHadoopConfiguration hadoopConfiguration(String gridName) {\n         GridHadoopConfiguration cfg = super.hadoopConfiguration(gridName);\n \n+        cfg.setExternalExecution(false);\n         cfg.setJobFactory(new HadoopTestJobFactory());\n         cfg.setMapReducePlanner(new GridHadoopTestRoundRobinMrPlanner());\n ",
                "raw_url": "https://github.com/apache/ignite/raw/a3d8feec9c0d1fe784d7be116f56b84986ab344c/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopJobTrackerSelfTest.java",
                "sha": "1d9026385ee1ccf67354c5e009081909058cd3cf",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/a3d8feec9c0d1fe784d7be116f56b84986ab344c/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java?ref=a3d8feec9c0d1fe784d7be116f56b84986ab344c",
                "deletions": 0,
                "filename": "modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java",
                "patch": "@@ -217,6 +217,15 @@ private void prepareFile(String fileName, int lineCnt) throws Exception {\n         }\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public GridHadoopConfiguration hadoopConfiguration(String gridName) {\n+        GridHadoopConfiguration cfg = super.hadoopConfiguration(gridName);\n+\n+        cfg.setExternalExecution(false);\n+\n+        return cfg;\n+    }\n+\n     /**\n      * @throws Exception If failed.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/a3d8feec9c0d1fe784d7be116f56b84986ab344c/modules/hadoop/src/test/java/org/gridgain/grid/kernal/processors/hadoop/GridHadoopTaskExecutionSelfTest.java",
                "sha": "eaadf4afd964f81407258b8efc8dc62839d1b963",
                "status": "modified"
            }
        ],
        "message": "#GG-8366 NPE in GridHadoopJobTrackerSelfTest.testTaskWithCombiner",
        "parent": "https://github.com/apache/ignite/commit/252ad756fe102515c574f37958e0fac63dd83308",
        "patched_files": [
            "GridHadoopEmbeddedTaskExecutor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridHadoopTaskExecutionSelfTest.java",
            "GridHadoopJobTrackerSelfTest.java"
        ]
    },
    "ignite_a452dac": {
        "bug_id": "ignite_a452dac",
        "commit": "https://github.com/apache/ignite/commit/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
        "file": [
            {
                "additions": 53,
                "blob_url": "https://github.com/apache/ignite/blob/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 72,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
                "deletions": 19,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -2451,6 +2451,24 @@ public long lastDataVersion() {\n         return jcache == null ? null : jcache.internalProxy();\n     }\n \n+    /**\n+     * @param name Cache name.\n+     * @return Cache instance for given name.\n+     * @throws IgniteCheckedException If failed.\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    public <K, V> IgniteInternalCache<K, V> getOrStartCache(@Nullable String name) throws IgniteCheckedException {\n+        if (log.isDebugEnabled())\n+            log.debug(\"Getting cache for name: \" + name);\n+\n+        IgniteCache<K, V> jcache = (IgniteCache<K, V>)jCacheProxies.get(maskNull(name));\n+\n+        if (jcache == null)\n+            jcache = startJCache(name, true);\n+\n+        return jcache == null ? null : ((IgniteCacheProxy<K, V>)jcache).internalProxy();\n+    }\n+\n     /**\n      * @return All configured cache instances.\n      */\n@@ -2558,37 +2576,53 @@ public long lastDataVersion() {\n         if (desc != null && !desc.cacheType().userCache())\n             throw new IllegalStateException(\"Failed to get cache because it is a system cache: \" + cacheName);\n \n-        if (cache == null) {\n-            if (desc == null || desc.cancelled()) {\n-                if (failIfNotStarted)\n-                    throw new IllegalArgumentException(\"Cache is not started: \" + cacheName);\n+        if (cache == null)\n+           cache = startJCache(cacheName, failIfNotStarted);\n \n-                return null;\n-            }\n+        return cache;\n+    }\n \n-            DynamicCacheChangeRequest req = new DynamicCacheChangeRequest(cacheName, ctx.localNodeId());\n+    /**\n+     * @param cacheName Cache name.\n+     * @param failIfNotStarted If {@code true} throws {@link IllegalArgumentException} if cache is not started,\n+     *        otherwise returns {@code null} in this case.\n+     * @return Cache instance for given name.\n+     * @throws IgniteCheckedException If failed.\n+     */\n+    private IgniteCache startJCache(String cacheName, boolean failIfNotStarted) throws IgniteCheckedException {\n+        String masked = maskNull(cacheName);\n \n-            req.cacheName(cacheName);\n+        DynamicCacheDescriptor desc = registeredCaches.get(masked);\n \n-            req.deploymentId(desc.deploymentId());\n+        if (desc == null || desc.cancelled()) {\n+            if (failIfNotStarted)\n+                throw new IllegalArgumentException(\"Cache is not started: \" + cacheName);\n \n-            CacheConfiguration cfg = new CacheConfiguration(desc.cacheConfiguration());\n+            return null;\n+        }\n \n-            cfg.setNearConfiguration(null);\n+        DynamicCacheChangeRequest req = new DynamicCacheChangeRequest(cacheName, ctx.localNodeId());\n \n-            req.startCacheConfiguration(cfg);\n+        req.cacheName(cacheName);\n \n-            req.cacheType(desc.cacheType());\n+        req.deploymentId(desc.deploymentId());\n \n-            req.clientStartOnly(true);\n+        CacheConfiguration cfg = new CacheConfiguration(desc.cacheConfiguration());\n \n-            F.first(initiateCacheChanges(F.asList(req))).get();\n+        cfg.setNearConfiguration(null);\n \n-            cache = (IgniteCache<K, V>)jCacheProxies.get(masked);\n+        req.startCacheConfiguration(cfg);\n \n-            if (cache == null && failIfNotStarted)\n-                throw new IllegalArgumentException(\"Cache is not started: \" + cacheName);\n-        }\n+        req.cacheType(desc.cacheType());\n+\n+        req.clientStartOnly(true);\n+\n+        F.first(initiateCacheChanges(F.asList(req))).get();\n+\n+        IgniteCache cache = jCacheProxies.get(masked);\n+\n+        if (cache == null && failIfNotStarted)\n+            throw new IllegalArgumentException(\"Cache is not started: \" + cacheName);\n \n         return cache;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "0e1a9c23ec0a81ee0e6641d52377c2f4b5f39b4e",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsDataManager.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsDataManager.java?ref=a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsDataManager.java",
                "patch": "@@ -202,7 +202,10 @@ else if (msg instanceof IgfsAckMessage)\n \n     /** {@inheritDoc} */\n     @Override protected void onKernalStart0() throws IgniteCheckedException {\n+        igfsCtx.kernalContext().cache().getOrStartCache(igfsCtx.configuration().getDataCacheName());\n         dataCachePrj = igfsCtx.kernalContext().cache().internalCache(igfsCtx.configuration().getDataCacheName());\n+\n+        igfsCtx.kernalContext().cache().getOrStartCache(igfsCtx.configuration().getDataCacheName());\n         dataCache = igfsCtx.kernalContext().cache().internalCache(igfsCtx.configuration().getDataCacheName());\n \n         metrics = igfsCtx.igfs().localMetrics();",
                "raw_url": "https://github.com/apache/ignite/raw/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsDataManager.java",
                "sha": "aa6427d78753ec6c6f0f44dbc2abdd5784c816a8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsMetaManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsMetaManager.java?ref=a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsMetaManager.java",
                "patch": "@@ -108,7 +108,7 @@ void awaitInit() {\n \n     /** {@inheritDoc} */\n     @Override protected void onKernalStart0() throws IgniteCheckedException {\n-        metaCache = igfsCtx.kernalContext().cache().cache(cfg.getMetaCacheName());\n+        metaCache = igfsCtx.kernalContext().cache().getOrStartCache(cfg.getMetaCacheName());\n \n         assert metaCache != null;\n ",
                "raw_url": "https://github.com/apache/ignite/raw/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/main/java/org/apache/ignite/internal/processors/igfs/IgfsMetaManager.java",
                "sha": "e33e0d4b7afe0aaa99384c39abfda864f090d9c2",
                "status": "modified"
            },
            {
                "additions": 132,
                "blob_url": "https://github.com/apache/ignite/blob/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsClientCacheSelfTest.java",
                "changes": 132,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsClientCacheSelfTest.java?ref=a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsClientCacheSelfTest.java",
                "patch": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.igfs;\n+\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.cache.*;\n+import org.apache.ignite.configuration.*;\n+import org.apache.ignite.igfs.*;\n+import org.apache.ignite.igfs.secondary.IgfsSecondaryFileSystem;\n+import org.apache.ignite.internal.util.typedef.G;\n+import org.apache.ignite.spi.discovery.tcp.*;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.*;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.*;\n+\n+import static org.apache.ignite.cache.CacheAtomicityMode.*;\n+import static org.apache.ignite.cache.CacheMode.*;\n+\n+/**\n+ * Test for igfs with nodes in client mode (see {@link IgniteConfiguration#setClientMode(boolean)}.\n+ */\n+public class IgfsClientCacheSelfTest extends IgfsAbstractSelfTest {\n+    /** */\n+    private static final TcpDiscoveryIpFinder IP_FINDER = new TcpDiscoveryVmIpFinder(true);\n+\n+    /** Meta-information cache name. */\n+    private static final String META_CACHE_NAME = \"meta\";\n+\n+    /** Data cache name. */\n+    private static final String DATA_CACHE_NAME = null;\n+\n+    /** Regular cache name. */\n+    private static final String CACHE_NAME = \"cache\";\n+\n+    /**\n+     * Constructor.\n+     */\n+    public IgfsClientCacheSelfTest() {\n+        super(IgfsMode.PRIMARY);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        igfsSecondaryFileSystem = createSecondaryFileSystemStack();\n+\n+        Ignite ignite1 = G.start(getConfiguration(getTestGridName(1)));\n+\n+        igfs = (IgfsImpl) ignite1.fileSystem(\"igfs\");\n+    }\n+\n+    /**{@inheritDoc} */\n+    protected IgfsSecondaryFileSystem createSecondaryFileSystemStack() throws Exception {\n+        Ignite igniteSecondary = G.start(getConfiguration(getTestGridName(0)));\n+\n+        IgfsEx secondaryIgfsImpl = (IgfsEx)igniteSecondary.fileSystem(\"igfs\");\n+\n+        igfsSecondary = new IgfsExUniversalFileSystemAdapter(secondaryIgfsImpl);\n+\n+        return secondaryIgfsImpl.asSecondary();\n+    }\n+\n+    /**\n+     *\n+     * @param gridName Grid name.\n+     * @return Ignite configuration.\n+     * @throws Exception If failed.\n+     */\n+    protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        cfg.setCacheConfiguration(cacheConfiguration(META_CACHE_NAME), cacheConfiguration(DATA_CACHE_NAME),\n+            cacheConfiguration(CACHE_NAME));\n+\n+        if (!gridName.equals(getTestGridName(0)))\n+            cfg.setClientMode(true);\n+\n+        TcpDiscoverySpi disco = new TcpDiscoverySpi();\n+\n+        disco.setIpFinder(IP_FINDER);\n+\n+        cfg.setDiscoverySpi(disco);\n+\n+        FileSystemConfiguration igfsCfg = new FileSystemConfiguration();\n+\n+        igfsCfg.setMetaCacheName(META_CACHE_NAME);\n+        igfsCfg.setDataCacheName(DATA_CACHE_NAME);\n+        igfsCfg.setName(\"igfs\");\n+\n+        cfg.setFileSystemConfiguration(igfsCfg);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * @param cacheName Cache name.\n+     * @return Cache configuration.\n+     */\n+    protected CacheConfiguration cacheConfiguration(String cacheName) {\n+        CacheConfiguration cacheCfg = defaultCacheConfiguration();\n+\n+        cacheCfg.setName(cacheName);\n+\n+        if (META_CACHE_NAME.equals(cacheName))\n+            cacheCfg.setCacheMode(REPLICATED);\n+        else {\n+            cacheCfg.setCacheMode(PARTITIONED);\n+            cacheCfg.setNearConfiguration(null);\n+\n+            cacheCfg.setBackups(0);\n+            cacheCfg.setAffinityMapper(new IgfsGroupDataBlocksKeyMapper(128));\n+        }\n+\n+        cacheCfg.setWriteSynchronizationMode(CacheWriteSynchronizationMode.FULL_SYNC);\n+        cacheCfg.setAtomicityMode(TRANSACTIONAL);\n+\n+        return cacheCfg;\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsClientCacheSelfTest.java",
                "sha": "d98330279b7a395713960bb68c6d37eed6b554db",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java?ref=a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java",
                "patch": "@@ -154,7 +154,7 @@ protected CacheConfiguration cacheConfiguration(String cacheName) {\n      */\n     public void testConfiguration() throws IgniteCheckedException {\n         IgniteInternalCache metaCache = getFieldValue(fs, \"meta\", \"metaCache\");\n-        GridCacheAdapter dataCache = getFieldValue(fs, \"data\", \"dataCache\");\n+        IgniteInternalCache dataCache = getFieldValue(fs, \"data\", \"dataCache\");\n \n         assertNotNull(metaCache);\n         assertEquals(META_CACHE_NAME, metaCache.name());",
                "raw_url": "https://github.com/apache/ignite/raw/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsStreamsSelfTest.java",
                "sha": "d3775606cc1c1d545e3013d72e7d5e934c60e5f2",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteIgfsTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteIgfsTestSuite.java?ref=a452dac26c47ac10586f1f49bc26f03b6b5e6fd4",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteIgfsTestSuite.java",
                "patch": "@@ -59,6 +59,8 @@ public static TestSuite suite() throws Exception {\n         suite.addTest(new TestSuite(IgfsDualSyncSelfTest.class));\n         suite.addTest(new TestSuite(IgfsDualAsyncSelfTest.class));\n \n+        suite.addTest(new TestSuite(IgfsClientCacheSelfTest.class));\n+\n         suite.addTest(new TestSuite(IgfsModeResolverSelfTest.class));\n \n         suite.addTestSuite(IgfsFragmentizerSelfTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/a452dac26c47ac10586f1f49bc26f03b6b5e6fd4/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteIgfsTestSuite.java",
                "sha": "4f3178e5af50a4f380418a22e449dd753194c737",
                "status": "modified"
            }
        ],
        "message": "#ignite-841: NullPointerException at IgfsMetaManager.onKernalStart0 (IgfsMetaManager.java:115).",
        "parent": "https://github.com/apache/ignite/commit/d4908f2449a4fde9298f6ca11590e0a94a94c955",
        "patched_files": [
            "IgfsMetaManager.java",
            "GridCacheProcessor.java",
            "IgniteIgfsTestSuite.java",
            "IgfsDataManager.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgfsStreamsSelfTest.java",
            "IgfsClientCacheSelfTest.java"
        ]
    },
    "ignite_a7834c6": {
        "bug_id": "ignite_a7834c6",
        "commit": "https://github.com/apache/ignite/commit/a7834c62d3ad086b4f64f25fb5c926f467225869",
        "file": [
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/ignite/blob/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/main/java/org/apache/ignite/internal/util/collection/IntHashMap.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/util/collection/IntHashMap.java?ref=a7834c62d3ad086b4f64f25fb5c926f467225869",
                "deletions": 10,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/util/collection/IntHashMap.java",
                "patch": "@@ -72,25 +72,34 @@\n         }\n     }\n \n-    /** Default constructor. */\n-    public IntHashMap() {\n-        entries = (Entry<V>[])new Entry[INITIAL_CAPACITY];\n-    }\n-\n-    /** Create map with preallocated array. */\n-    public IntHashMap(int cap) {\n+    /**\n+     * Returns required size of table.\n+     *\n+     * @param cap Capacity.\n+     */\n+    static int tableSize(int cap) {\n         int n = cap - 1;\n         n |= n >>> 1;\n         n |= n >>> 2;\n         n |= n >>> 4;\n         n |= n >>> 8;\n         n |= n >>> 16;\n \n-        int entriesSize = (n < INITIAL_CAPACITY) ? INITIAL_CAPACITY : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n+        return  (n < INITIAL_CAPACITY) ? INITIAL_CAPACITY : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n+    }\n \n-        compactThreshold = (int)(COMPACT_LOAD_FACTOR * (entries.length >> 1));\n+    /** Default constructor. */\n+    public IntHashMap() {\n+        entries = (Entry<V>[])new Entry[INITIAL_CAPACITY];\n+    }\n \n-        scaleThreshold = (int)(entries.length * SCALE_LOAD_FACTOR);\n+    /** Create map with preallocated array. */\n+    public IntHashMap(int cap) {\n+        int entriesSize = tableSize(cap);\n+\n+        compactThreshold = (int)(COMPACT_LOAD_FACTOR * (entriesSize >> 1));\n+\n+        scaleThreshold = (int)(entriesSize * SCALE_LOAD_FACTOR);\n \n         entries = (Entry<V>[])new Entry[entriesSize];\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/main/java/org/apache/ignite/internal/util/collection/IntHashMap.java",
                "sha": "d6b57d8da8a8c0d0f7743cd65cbfb27099d8ebfe",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheGroupsTest.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheGroupsTest.java?ref=a7834c62d3ad086b4f64f25fb5c926f467225869",
                "deletions": 3,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheGroupsTest.java",
                "patch": "@@ -81,6 +81,7 @@\n import org.apache.ignite.internal.processors.cache.distributed.dht.topology.GridDhtLocalPartition;\n import org.apache.ignite.internal.processors.cache.persistence.CacheDataRow;\n import org.apache.ignite.internal.processors.platform.cache.expiry.PlatformExpiryPolicyFactory;\n+import org.apache.ignite.internal.util.collection.IntMap;\n import org.apache.ignite.internal.util.lang.GridAbsPredicate;\n import org.apache.ignite.internal.util.lang.GridIterator;\n import org.apache.ignite.internal.util.lang.GridPlainCallable;\n@@ -4177,12 +4178,11 @@ public void testRestartsAndCacheCreateDestroy() throws Exception {\n                     assertNotNull(grp);\n \n                     for (GridDhtLocalPartition part : grp.topology().currentLocalPartitions()) {\n-                        Map<Integer, Object> cachesMap = GridTestUtils.getFieldValue(part, \"cacheMaps\");\n+                        IntMap<Object> cachesMap = GridTestUtils.getFieldValue(part, \"cacheMaps\");\n \n                         assertTrue(cachesMap.size() <= cacheIds.size());\n \n-                        for (Integer cacheId : cachesMap.keySet())\n-                            assertTrue(cachesMap.containsKey(cacheId));\n+                        cachesMap.forEach((cacheId, v) -> assertTrue(cachesMap.containsKey(cacheId)));\n                     }\n                 }\n             }",
                "raw_url": "https://github.com/apache/ignite/raw/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheGroupsTest.java",
                "sha": "1e7f580dd49e8099cbb0de04803f8348437cf1fa",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/test/java/org/apache/ignite/internal/util/collection/IntHashMapTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/util/collection/IntHashMapTest.java?ref=a7834c62d3ad086b4f64f25fb5c926f467225869",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/util/collection/IntHashMapTest.java",
                "patch": "@@ -103,7 +103,15 @@ public void shouldAllocateMapWithInitialCapacity() {\n         assertEquals(16, realCapacityForInitialSize(9));\n         assertEquals(128, realCapacityForInitialSize(99));\n         assertEquals(256, realCapacityForInitialSize(155));\n-        assertEquals(MAXIMUM_CAPACITY, realCapacityForInitialSize(Integer.MAX_VALUE));\n+    }\n+\n+    /**\n+     *\n+     */\n+    @Test\n+    public void shouldReturnsRequiredTableSizeForCustomCapacity() {\n+        assertEquals(INITIAL_CAPACITY, IntHashMap.tableSize(1));\n+        assertEquals(MAXIMUM_CAPACITY, IntHashMap.tableSize(Integer.MAX_VALUE));\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/test/java/org/apache/ignite/internal/util/collection/IntHashMapTest.java",
                "sha": "da84dfcdf1ed260e73ff685160e492db8e1d9dc0",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicTestSuite.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicTestSuite.java?ref=a7834c62d3ad086b4f64f25fb5c926f467225869",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicTestSuite.java",
                "patch": "@@ -91,6 +91,8 @@\n import org.apache.ignite.internal.util.collection.BitSetIntSetTest;\n import org.apache.ignite.internal.util.collection.ImmutableIntSetTest;\n import org.apache.ignite.internal.util.GridCleanerTest;\n+import org.apache.ignite.internal.util.collection.IntHashMapTest;\n+import org.apache.ignite.internal.util.collection.IntRWHashMapTest;\n import org.apache.ignite.internal.util.nio.IgniteExceptionInNioWorkerSelfTest;\n import org.apache.ignite.marshaller.DynamicProxySerializationMultiJvmSelfTest;\n import org.apache.ignite.marshaller.MarshallerContextSelfTest;\n@@ -201,6 +203,8 @@\n     SwapPathConstructionSelfTest.class,\n     BitSetIntSetTest.class,\n     ImmutableIntSetTest.class,\n+    IntHashMapTest.class,\n+    IntRWHashMapTest.class,\n \n     IgniteMarshallerCacheFSRestoreTest.class,\n     IgniteMarshallerCacheClassNameConflictTest.class,",
                "raw_url": "https://github.com/apache/ignite/raw/a7834c62d3ad086b4f64f25fb5c926f467225869/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteBasicTestSuite.java",
                "sha": "ac8dd150810f8222b47c934bd2afa22444aef5e3",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12062 IntMap throws NullPointerException when map is creating - Fixes #6769.\n\nSigned-off-by: Ivan Rakov <irakov@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/b1862bc184fc2015c7ccc54264d4ed2c65803134",
        "patched_files": [
            "IgniteBasicTestSuite.java",
            "IntHashMap.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IntHashMapTest.java",
            "IgniteCacheGroupsTest.java"
        ]
    },
    "ignite_a835bdf": {
        "bug_id": "ignite_a835bdf",
        "commit": "https://github.com/apache/ignite/commit/a835bdf7fce305df302241eea2d6b15ff7751db1",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/a835bdf7fce305df302241eea2d6b15ff7751db1/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/twostep/GridReduceQueryExecutor.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/twostep/GridReduceQueryExecutor.java?ref=a835bdf7fce305df302241eea2d6b15ff7751db1",
                "deletions": 7,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/twostep/GridReduceQueryExecutor.java",
                "patch": "@@ -394,11 +394,13 @@ else if (msg.page() == 0) // Count down only on each first page received.\n             }\n \n             if (attempt > 0 && retryTimeout > 0 && (U.currentTimeMillis() - startTime > retryTimeout)) {\n+                // There are few cases when 'retryCause' can be undefined, so we should throw exception with proper message here.\n+                if (lastRun == null || lastRun.retryCause() == null)\n+                    throw new CacheException(\"Failed to map SQL query to topology during timeout: \" + retryTimeout + \"ms\");\n+\n                 UUID retryNodeId = lastRun.retryNodeId();\n                 String retryCause = lastRun.retryCause();\n \n-                assert !F.isEmpty(retryCause);\n-\n                 throw new CacheException(\"Failed to map SQL query to topology on data node [dataNodeId=\" + retryNodeId +\n                     \", msg=\" + retryCause + ']');\n             }\n@@ -469,11 +471,9 @@ else if (msg.page() == 0) // Count down only on each first page received.\n                 partsMap = nodesParts.partitionsMap();\n                 qryMap = nodesParts.queryPartitionsMap();\n \n-                if (nodes == null)\n+                if (F.isEmpty(nodes))\n                     continue; // Retry.\n \n-                assert !nodes.isEmpty();\n-\n                 if (isReplicatedOnly || qry.explain()) {\n                     ClusterNode locNode = ctx.discovery().localNode();\n \n@@ -785,7 +785,7 @@ public UpdateResult update(\n \n         Collection<ClusterNode> nodes = nodesParts.nodes();\n \n-        if (nodes == null)\n+        if (F.isEmpty(nodes))\n             throw new CacheException(\"Failed to determine nodes participating in the update. \" +\n                 \"Explanation (Retry update once topology recovers).\");\n \n@@ -855,7 +855,7 @@ public UpdateResult update(\n \n             U.error(log, \"Error during update [localNodeId=\" + ctx.localNodeId() + \"]\", e);\n \n-            throw new CacheException(\"Failed to run update. \" + e.getMessage(), e);\n+            throw new CacheException(\"Failed to run SQL update query. \" + e.getMessage(), e);\n         }\n         finally {\n             if (release)",
                "raw_url": "https://github.com/apache/ignite/raw/a835bdf7fce305df302241eea2d6b15ff7751db1/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/twostep/GridReduceQueryExecutor.java",
                "sha": "d3e7772aa57f47ca6bb22d9ce9c86fa32429407f",
                "status": "modified"
            },
            {
                "additions": 85,
                "blob_url": "https://github.com/apache/ignite/blob/a835bdf7fce305df302241eea2d6b15ff7751db1/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/twostep/RetryCauseMessageSelfTest.java",
                "changes": 85,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/twostep/RetryCauseMessageSelfTest.java?ref=a835bdf7fce305df302241eea2d6b15ff7751db1",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/twostep/RetryCauseMessageSelfTest.java",
                "patch": "@@ -17,23 +17,29 @@\n \n package org.apache.ignite.internal.processors.query.h2.twostep;\n \n+import java.util.Collections;\n+import java.util.List;\n import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.atomic.AtomicLong;\n import javax.cache.CacheException;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n import org.apache.ignite.IgniteCheckedException;\n import org.apache.ignite.IgniteException;\n+import org.apache.ignite.IgniteLogger;\n import org.apache.ignite.cache.CacheMode;\n+import org.apache.ignite.cache.query.SqlFieldsQuery;\n import org.apache.ignite.cache.query.SqlQuery;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.configuration.IgniteConfiguration;\n import org.apache.ignite.internal.GridKernalContext;\n+import org.apache.ignite.internal.processors.affinity.AffinityTopologyVersion;\n import org.apache.ignite.internal.processors.cache.GridCacheContext;\n import org.apache.ignite.internal.processors.cache.distributed.dht.GridReservable;\n import org.apache.ignite.internal.processors.cache.distributed.dht.topology.GridDhtLocalPartition;\n import org.apache.ignite.internal.processors.cache.index.AbstractIndexingCommonTest;\n+import org.apache.ignite.internal.processors.cache.query.SqlFieldsQueryEx;\n import org.apache.ignite.internal.processors.query.GridQueryProcessor;\n import org.apache.ignite.internal.processors.query.h2.H2Utils;\n import org.apache.ignite.internal.processors.query.h2.IgniteH2Indexing;\n@@ -63,6 +69,9 @@\n     /** */\n     private static final String ORG_SQL = \"select * from Organization\";\n \n+    /** */\n+    static final String UPDATE_SQL = \"UPDATE Person SET name=lower(?) \";\n+\n     /** */\n     private static final String ORG = \"org\";\n \n@@ -296,6 +305,82 @@ public void onQueryRequest(ClusterNode node, GridH2QueryRequest qryReq) throws I\n         fail();\n     }\n \n+    /**\n+     * Test query remap failure reason.\n+     */\n+    @Test\n+    public void testQueryMappingFailureMessage() {\n+        final GridReduceQueryExecutor rdcQryExec = GridTestUtils.getFieldValue(h2Idx, IgniteH2Indexing.class, \"rdcQryExec\");\n+        final ReducePartitionMapper mapper = GridTestUtils.getFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"mapper\");\n+\n+        final IgniteLogger logger = GridTestUtils.getFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"log\");\n+        final GridKernalContext ctx = GridTestUtils.getFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"ctx\");\n+\n+        GridTestUtils.setFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"mapper\",\n+            new ReducePartitionMapper(ctx, logger) {\n+                @Override public ReducePartitionMapResult nodesForPartitions(List<Integer> cacheIds,\n+                    AffinityTopologyVersion topVer, int[] parts, boolean isReplicatedOnly, long qryId) {\n+                    final ReducePartitionMapResult res = super.nodesForPartitions(cacheIds, topVer, parts, isReplicatedOnly, qryId);\n+\n+                    return new ReducePartitionMapResult(Collections.emptyList(), res.partitionsMap(), res.queryPartitionsMap());\n+                }\n+            });\n+\n+        try {\n+            SqlFieldsQuery qry = new SqlFieldsQuery(JOIN_SQL).setArgs(\"Organization #0\");\n+\n+            final Throwable throwable = GridTestUtils.assertThrows(log, () -> {\n+                return personCache.query(qry).getAll();\n+            }, CacheException.class, \"Failed to map SQL query to topology during timeout:\");\n+\n+            throwable.printStackTrace();\n+        }\n+        finally {\n+            GridTestUtils.setFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"mapper\", mapper);\n+        }\n+    }\n+\n+    /**\n+     * Test update query remap failure reason.\n+     */\n+    @Test\n+    public void testUpdateQueryMappingFailureMessage() {\n+        final GridReduceQueryExecutor rdcQryExec = GridTestUtils.getFieldValue(h2Idx, IgniteH2Indexing.class, \"rdcQryExec\");\n+        final ReducePartitionMapper mapper = GridTestUtils.getFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"mapper\");\n+\n+        final IgniteLogger logger = GridTestUtils.getFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"log\");\n+        final GridKernalContext ctx = GridTestUtils.getFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"ctx\");\n+\n+        GridTestUtils.setFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"mapper\",\n+            new ReducePartitionMapper(ctx, logger) {\n+                @Override public ReducePartitionMapResult nodesForPartitions(List<Integer> cacheIds,\n+                    AffinityTopologyVersion topVer, int[] parts, boolean isReplicatedOnly, long qryId) {\n+                    final ReducePartitionMapResult res = super.nodesForPartitions(cacheIds, topVer, parts, isReplicatedOnly, qryId);\n+\n+                    return new ReducePartitionMapResult(Collections.emptyList(), res.partitionsMap(), res.queryPartitionsMap());\n+                }\n+            });\n+\n+        try {\n+            final SqlFieldsQueryEx qry = new SqlFieldsQueryEx(UPDATE_SQL, false)\n+                .setArgs(\"New Name\");\n+\n+            GridTestUtils.assertThrows(log, () -> {\n+                return personCache.query(qry).getAll();\n+            }, CacheException.class, \"Failed to map SQL query to topology during timeout\");\n+\n+            qry.setArgs(\"Another Name\");\n+            qry.setSkipReducerOnUpdate(true);\n+\n+            GridTestUtils.assertThrows(log, () -> {\n+                return personCache.query(qry).getAll();\n+            }, CacheException.class, \"Failed to determine nodes participating in the update. \");\n+        }\n+        finally {\n+            GridTestUtils.setFieldValue(rdcQryExec, GridReduceQueryExecutor.class, \"mapper\", mapper);\n+        }\n+    }\n+\n     /** {@inheritDoc} */\n     @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n         IgniteConfiguration cfg = super.getConfiguration(gridName);",
                "raw_url": "https://github.com/apache/ignite/raw/a835bdf7fce305df302241eea2d6b15ff7751db1/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/h2/twostep/RetryCauseMessageSelfTest.java",
                "sha": "8f229c28319f58242c86dc7d604a90421cdb9c61",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12444: SQL: Query reduce can fail with NPE on retry. This closes #7138.",
        "parent": "https://github.com/apache/ignite/commit/6c7fe053661e6f822d8d18ee9a323897e630ab6b",
        "patched_files": [
            "GridReduceQueryExecutor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "RetryCauseMessageSelfTest.java"
        ]
    },
    "ignite_ab4963a": {
        "bug_id": "ignite_ab4963a",
        "commit": "https://github.com/apache/ignite/commit/ab4963a686ea7ca560604079c52b8939b605cfcf",
        "file": [
            {
                "additions": 71,
                "blob_url": "https://github.com/apache/ignite/blob/ab4963a686ea7ca560604079c52b8939b605cfcf/modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheSemaphoreImpl.java",
                "changes": 108,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheSemaphoreImpl.java?ref=ab4963a686ea7ca560604079c52b8939b605cfcf",
                "deletions": 37,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheSemaphoreImpl.java",
                "patch": "@@ -36,6 +36,7 @@\n import org.apache.ignite.IgniteLogger;\n import org.apache.ignite.IgniteSemaphore;\n import org.apache.ignite.internal.GridKernalContext;\n+import org.apache.ignite.internal.IgniteInterruptedCheckedException;\n import org.apache.ignite.internal.IgnitionEx;\n import org.apache.ignite.internal.processors.cache.GridCacheContext;\n import org.apache.ignite.internal.processors.cache.IgniteInternalCache;\n@@ -51,11 +52,11 @@\n import static org.apache.ignite.transactions.TransactionIsolation.REPEATABLE_READ;\n \n /**\n- * Cache semaphore implementation based on AbstractQueuedSynchronizer.\n- * Current implementation supports only unfair semaphores.\n- * If any node fails after acquiring permissions on cache semaphore, there are two different behaviors controlled with the\n- * parameter failoverSafe. If this parameter is true, other nodes can reacquire permits that were acquired by the failing node.\n- * In case this parameter is false, IgniteInterruptedException is called on every node waiting on this semaphore.\n+ * Cache semaphore implementation based on AbstractQueuedSynchronizer. Current implementation supports only unfair\n+ * semaphores. If any node fails after acquiring permissions on cache semaphore, there are two different behaviors\n+ * controlled with the parameter failoverSafe. If this parameter is true, other nodes can reacquire permits that were\n+ * acquired by the failing node. In case this parameter is false, IgniteInterruptedException is called on every node\n+ * waiting on this semaphore.\n  */\n public final class GridCacheSemaphoreImpl implements GridCacheSemaphoreEx, Externalizable {\n     /** */\n@@ -104,8 +105,7 @@ public GridCacheSemaphoreImpl() {\n     }\n \n     /**\n-     * Synchronization implementation for semaphore.\n-     * Uses AQS state to represent permits.\n+     * Synchronization implementation for semaphore. Uses AQS state to represent permits.\n      */\n     final class Sync extends AbstractQueuedSynchronizer {\n         private static final long serialVersionUID = 1192457210091910933L;\n@@ -155,10 +155,10 @@ public int getWaiters() {\n          * Get number of permits for node.\n          *\n          * @param nodeID Node ID.\n-         * @return Number of permits node has acquired at this semaphore. Can be less than 0 if\n-         * more permits were released than acquired on node.\n+         * @return Number of permits node has acquired at this semaphore. Can be less than 0 if more permits were\n+         * released than acquired on node.\n          */\n-        public int getPermitsForNode(UUID nodeID){\n+        public int getPermitsForNode(UUID nodeID) {\n             return nodeMap.containsKey(nodeID) ? nodeMap.get(nodeID) : 0;\n         }\n \n@@ -182,24 +182,23 @@ final int getPermits() {\n         }\n \n         /**\n-         * Set a flag indicating that it is not safe to continue using this semaphore.\n-         * This is the case only if one of two things happened:\n-         * 1. A node that previously acquired on this semaphore failed and\n-         * semaphore is created in non-failoversafe mode;\n-         * 2. Local node failed (is closed), so any any threads on this node\n-         * waiting to acquire are notified, and semaphore is not safe to be used anymore.\n+         * Set a flag indicating that it is not safe to continue using this semaphore. This is the case only if one of\n+         * two things happened: 1. A node that previously acquired on this semaphore failed and semaphore is created in\n+         * non-failoversafe mode; 2. Local node failed (is closed), so any any threads on this node waiting to acquire\n+         * are notified, and semaphore is not safe to be used anymore.\n          *\n          * @return True is semaphore is not safe to be used anymore.\n          */\n         protected boolean isBroken() {\n             return broken;\n         }\n \n-        /** Flag indicating that a node failed and it is not safe to continue using this semaphore.\n-         * Any attempt to acquire on broken semaphore will result in {@linkplain IgniteInterruptedException}.\n+        /**\n+         * Flag indicating that a node failed and it is not safe to continue using this semaphore. Any attempt to\n+         * acquire on broken semaphore will result in {@linkplain IgniteInterruptedException}.\n          *\n          * @param broken True if semaphore should not be used anymore.\n-         * */\n+         */\n         protected void setBroken(boolean broken) {\n             this.broken = broken;\n         }\n@@ -211,9 +210,9 @@ protected void setBroken(boolean broken) {\n          * @return Negative number if thread should block, positive if thread successfully acquires permits.\n          */\n         final int nonfairTryAcquireShared(int acquires) {\n-            for (;;) {\n+            for (; ; ) {\n                 // If broken, return immediately, exception will be thrown anyway.\n-                if(broken)\n+                if (broken)\n                     return 1;\n \n                 int available = getState();\n@@ -238,9 +237,9 @@ final int nonfairTryAcquireShared(int acquires) {\n             if (releases == 0)\n                 return true;\n \n-            for (;;) {\n+            for (; ; ) {\n                 // If broken, return immediately, exception will be thrown anyway.\n-                if(broken)\n+                if (broken)\n                     return true;\n \n                 int cur = getState();\n@@ -261,9 +260,9 @@ final int nonfairTryAcquireShared(int acquires) {\n          * @return Number of permits to drain.\n          */\n         final int drainPermits() {\n-            for (;;) {\n+            for (; ; ) {\n                 // If broken, return immediately, exception will be thrown anyway.\n-                if(broken)\n+                if (broken)\n                     return 1;\n \n                 int current = getState();\n@@ -288,7 +287,7 @@ protected boolean compareAndSetGlobalState(final int expVal, final int newVal, f\n                         @Override public Boolean call() throws Exception {\n                             try (IgniteInternalTx tx = CU.txStartInternal(ctx,\n                                 semView,\n-                                    PESSIMISTIC, REPEATABLE_READ)\n+                                PESSIMISTIC, REPEATABLE_READ)\n                             ) {\n                                 GridCacheSemaphoreState val = semView.get(key);\n \n@@ -304,11 +303,11 @@ protected boolean compareAndSetGlobalState(final int expVal, final int newVal, f\n                                     if (!draining) {\n                                         UUID nodeID = ctx.localNodeId();\n \n-                                        Map<UUID,Integer> map = val.getWaiters();\n+                                        Map<UUID, Integer> map = val.getWaiters();\n \n                                         int waitingCnt = expVal - newVal;\n \n-                                        if(map.containsKey(nodeID))\n+                                        if (map.containsKey(nodeID))\n                                             waitingCnt += map.get(nodeID);\n \n                                         map.put(nodeID, waitingCnt);\n@@ -370,17 +369,17 @@ protected boolean releaseFailedNode(final UUID nodeId) {\n                                     throw new IgniteCheckedException(\"Failed to find semaphore with given name: \" +\n                                         name);\n \n-                                Map<UUID,Integer> map = val.getWaiters();\n+                                Map<UUID, Integer> map = val.getWaiters();\n \n-                                if(!map.containsKey(nodeId)){\n+                                if (!map.containsKey(nodeId)) {\n                                     tx.rollback();\n \n                                     return false;\n                                 }\n \n                                 int numPermits = map.get(nodeId);\n \n-                                if(numPermits > 0)\n+                                if (numPermits > 0)\n                                     val.setCount(val.getCount() + numPermits);\n \n                                 map.remove(nodeId);\n@@ -552,7 +551,42 @@ private void initializeSemaphore() throws IgniteCheckedException {\n         }\n     }\n \n+    /** {@inheritDoc} */\n     @Override public void stop() {\n+        if (initGuard.get()) {\n+            try {\n+                // Wait while initialization is in progress.\n+                U.await(initLatch);\n+            }\n+            catch (IgniteInterruptedCheckedException e) {\n+                if (log.isDebugEnabled())\n+                    log.error(\"Failed waiting while initialization is completed.\", e);\n+            }\n+        }\n+        else {\n+            // Preventing concurrent initialization.\n+            if (initGuard.compareAndSet(false, true)) {\n+                initLatch.countDown();\n+\n+                if (log.isDebugEnabled())\n+                    log.debug(\"Semaphore wasn't initialized. Prevented further initialization.\");\n+\n+                return;\n+            }\n+            else {\n+                try {\n+                    // Wait while initialization is in progress.\n+                    U.await(initLatch);\n+                }\n+                catch (IgniteInterruptedCheckedException e) {\n+                    if (log.isDebugEnabled())\n+                        log.error(\"Failed waiting while initialization is completed.\", e);\n+                }\n+            }\n+        }\n+\n+        assert sync != null;\n+\n         sync.setBroken(true);\n \n         // Try to notify any waiting threads.\n@@ -580,7 +614,7 @@ private void initializeSemaphore() throws IgniteCheckedException {\n \n             sync.acquireSharedInterruptibly(permits);\n \n-            if(isBroken())\n+            if (isBroken())\n                 throw new InterruptedException();\n         }\n         catch (IgniteCheckedException e) {\n@@ -697,7 +731,7 @@ private void initializeSemaphore() throws IgniteCheckedException {\n \n             boolean result = sync.nonfairTryAcquireShared(1) >= 0;\n \n-            if(isBroken())\n+            if (isBroken())\n                 throw new InterruptedException();\n \n             return result;\n@@ -722,7 +756,7 @@ private void initializeSemaphore() throws IgniteCheckedException {\n \n             boolean result = sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));\n \n-            if(isBroken())\n+            if (isBroken())\n                 throw new InterruptedException();\n \n             return result;\n@@ -789,9 +823,9 @@ private void initializeSemaphore() throws IgniteCheckedException {\n         try {\n             initializeSemaphore();\n \n-            boolean result =  sync.tryAcquireSharedNanos(permits, unit.toNanos(timeout));\n+            boolean result = sync.tryAcquireSharedNanos(permits, unit.toNanos(timeout));\n \n-            if(isBroken())\n+            if (isBroken())\n                 throw new InterruptedException();\n \n             return result;\n@@ -859,7 +893,7 @@ private void initializeSemaphore() throws IgniteCheckedException {\n     }\n \n     /** {@inheritDoc} */\n-    @Override public boolean isBroken(){\n+    @Override public boolean isBroken() {\n         ctx.kernalContext().gateway().readLock();\n \n         try {",
                "raw_url": "https://github.com/apache/ignite/raw/ab4963a686ea7ca560604079c52b8939b605cfcf/modules/core/src/main/java/org/apache/ignite/internal/processors/datastructures/GridCacheSemaphoreImpl.java",
                "sha": "a11c79db6282cd3818640671ad71e7eb5a44b77e",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/ignite/blob/ab4963a686ea7ca560604079c52b8939b605cfcf/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteSemaphoreAbstractSelfTest.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteSemaphoreAbstractSelfTest.java?ref=ab4963a686ea7ca560604079c52b8939b605cfcf",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteSemaphoreAbstractSelfTest.java",
                "patch": "@@ -30,6 +30,7 @@\n import org.apache.ignite.IgniteCompute;\n import org.apache.ignite.IgniteLogger;\n import org.apache.ignite.IgniteSemaphore;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.IgniteInternalFuture;\n import org.apache.ignite.internal.IgniteKernal;\n@@ -39,6 +40,7 @@\n import org.apache.ignite.lang.IgniteFuture;\n import org.apache.ignite.resources.IgniteInstanceResource;\n import org.apache.ignite.resources.LoggerResource;\n+import org.apache.ignite.testframework.GridStringLogger;\n import org.apache.ignite.testframework.GridTestUtils;\n import org.jetbrains.annotations.Nullable;\n import org.junit.Rule;\n@@ -231,6 +233,25 @@ private void checkSemaphore() throws Exception {\n         checkRemovedSemaphore(semaphore1);\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testSemaphoreClosing() throws Exception {\n+        IgniteConfiguration cfg;\n+        GridStringLogger stringLogger;\n+\n+        stringLogger = new GridStringLogger();\n+\n+        cfg = optimize(getConfiguration(\"npeGrid\"));\n+        cfg.setGridLogger(stringLogger);\n+\n+        try (Ignite ignite = startGrid(cfg.getGridName(), cfg)) {\n+            ignite.semaphore(\"semaphore\", 1, true, true);\n+        }\n+\n+        assertFalse(stringLogger.toString().contains(NullPointerException.class.getName()));\n+    }\n+\n     /**\n      * @throws Exception If failed.\n      */\n@@ -276,8 +297,8 @@ protected void checkRemovedSemaphore(final IgniteSemaphore semaphore) throws Exc\n     }\n \n     /**\n-     * This method only checks if parameter of new semaphore is initialized properly.\n-     * For tests considering failure recovery see @GridCachePartitionedNodeFailureSelfTest.\n+     * This method only checks if parameter of new semaphore is initialized properly. For tests considering failure\n+     * recovery see\n      *\n      * @throws Exception Exception.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/ab4963a686ea7ca560604079c52b8939b605cfcf/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteSemaphoreAbstractSelfTest.java",
                "sha": "5241dd1562487bc7c4abbf75b509a5421954d644",
                "status": "modified"
            }
        ],
        "message": "IGNITE-3515: NullPointerException when stopping IgniteSemaphore and no method has been called previously to initialize semaphore with initializeSemaphore().\nReviewed by Denis Magda.",
        "parent": "https://github.com/apache/ignite/commit/a989f04ec08638855f13ef4195ce7d9d1efee083",
        "patched_files": [
            "GridCacheSemaphoreImpl.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteSemaphoreAbstractSelfTest.java"
        ]
    },
    "ignite_ac94426": {
        "bug_id": "ignite_ac94426",
        "commit": "https://github.com/apache/ignite/commit/ac94426ced2cee5df2c993029e2a17ea5a9aa398",
        "file": [
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/ignite/blob/ac94426ced2cee5df2c993029e2a17ea5a9aa398/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java?ref=ac94426ced2cee5df2c993029e2a17ea5a9aa398",
                "deletions": 0,
                "filename": "modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "patch": "@@ -277,6 +277,23 @@ public void testMetadataResultSetClose() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testIndexMetadata() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(BASE_URL);\n+             ResultSet rs = conn.getMetaData().getIndexInfo(null, \"pers\", \"PERSON\", false, false)) {\n+\n+            int cnt = 0;\n+\n+            while (rs.next()) {\n+                cnt++;\n+            }\n+\n+            assertEquals(0, cnt);\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/ac94426ced2cee5df2c993029e2a17ea5a9aa398/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "sha": "f2ef769ed0c7177f3fd508e3a8d8d0e2a82f8f33",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/ac94426ced2cee5df2c993029e2a17ea5a9aa398/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcDatabaseMetadata.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcDatabaseMetadata.java?ref=ac94426ced2cee5df2c993029e2a17ea5a9aa398",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcDatabaseMetadata.java",
                "patch": "@@ -965,6 +965,8 @@\n     /** {@inheritDoc} */\n     @Override public ResultSet getIndexInfo(String catalog, String schema, String tbl, boolean unique,\n         boolean approximate) throws SQLException {\n+        updateMetaData();\n+\n         Collection<List<?>> rows = new ArrayList<>(indexes.size());\n \n         for (List<Object> idx : indexes) {",
                "raw_url": "https://github.com/apache/ignite/raw/ac94426ced2cee5df2c993029e2a17ea5a9aa398/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcDatabaseMetadata.java",
                "sha": "e9a5fde77d153d10b0fe20d694ad27fe4524932e",
                "status": "modified"
            }
        ],
        "message": "IGNITE-4643: Fixed NPE in  JdbcDatabaseMetadata.getIndexInfo(). This closes #2481.",
        "parent": "https://github.com/apache/ignite/commit/d22631e647280eff9f661dd7cfd492a6ba7460af",
        "patched_files": [
            "JdbcDatabaseMetadata.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "JdbcMetadataSelfTest.java"
        ]
    },
    "ignite_ade57ea": {
        "bug_id": "ignite_ade57ea",
        "commit": "https://github.com/apache/ignite/commit/ade57eaf5b77f779642be424d8cdf858a327ce2d",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/ignite/blob/ade57eaf5b77f779642be424d8cdf858a327ce2d/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java?ref=ade57eaf5b77f779642be424d8cdf858a327ce2d",
                "deletions": 8,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java",
                "patch": "@@ -220,16 +220,18 @@ void initStoreStrategy() throws IgniteCheckedException {\n     protected CacheConfiguration cacheConfiguration(String gridName) throws Exception {\n         CacheConfiguration cfg = defaultCacheConfiguration();\n \n-        Factory<? extends CacheStore<Object, Object>> storeFactory = storeStgy.getStoreFactory();\n+        if (storeStgy != null) {\n+            Factory<? extends CacheStore<Object, Object>> storeFactory = storeStgy.getStoreFactory();\n \n-        CacheStore<?, ?> store = storeFactory.create();\n+            CacheStore<?, ?> store = storeFactory.create();\n \n-        if (store != null) {\n-            cfg.setCacheStoreFactory(storeFactory);\n-            cfg.setReadThrough(true);\n-            cfg.setWriteThrough(true);\n-            cfg.setLoadPreviousValue(true);\n-            storeStgy.updateCacheConfiguration(cfg);\n+            if (store != null) {\n+                cfg.setCacheStoreFactory(storeFactory);\n+                cfg.setReadThrough(true);\n+                cfg.setWriteThrough(true);\n+                cfg.setLoadPreviousValue(true);\n+                storeStgy.updateCacheConfiguration(cfg);\n+            }\n         }\n \n         cfg.setSwapEnabled(swapEnabled());",
                "raw_url": "https://github.com/apache/ignite/raw/ade57eaf5b77f779642be424d8cdf858a327ce2d/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java",
                "sha": "d58e560fed72442cad2cf1e2b3b6892c53a42f50",
                "status": "modified"
            }
        ],
        "message": "ignite-1088 Implemented store for multi jvm tests (fixed NPE)\n(cherry picked from commit d31a476)",
        "parent": "https://github.com/apache/ignite/commit/2f78346e0e3d6a1cb9483b66144175c826a1ff5f",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheAbstractSelfTest.java"
        ]
    },
    "ignite_adf5ef6": {
        "bug_id": "ignite_adf5ef6",
        "commit": "https://github.com/apache/ignite/commit/adf5ef6100b58beb6fb00d85123f34cb5d9e084a",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/adf5ef6100b58beb6fb00d85123f34cb5d9e084a/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsAbstractSelfTest.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsAbstractSelfTest.java?ref=adf5ef6100b58beb6fb00d85123f34cb5d9e084a",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsAbstractSelfTest.java",
                "patch": "@@ -2686,6 +2686,7 @@ public static void clear(IgniteFileSystem igfs) throws Exception {\n     public static void clear(UniversalFileSystemAdapter uni) throws Exception {\n         IgfsEx igfsEx = uni.getAdapter(IgfsEx.class);\n \n-        clear(igfsEx);\n+        if (igfsEx != null)\n+            clear(igfsEx);\n     }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/ignite/raw/adf5ef6100b58beb6fb00d85123f34cb5d9e084a/modules/core/src/test/java/org/apache/ignite/internal/processors/igfs/IgfsAbstractSelfTest.java",
                "sha": "076c2698385a4803875cce20440f8666924599e8",
                "status": "modified"
            }
        ],
        "message": "Quick fix to Hadoop IGFS tests NPE.",
        "parent": "https://github.com/apache/ignite/commit/2aa292c47b87c0099d6d602dc282c231cd408f2b",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "IgfsAbstractSelfTest.java"
        ]
    },
    "ignite_b999926": {
        "bug_id": "ignite_b999926",
        "commit": "https://github.com/apache/ignite/commit/b9999269468cd6e91a8c855adb2efc6e017df09d",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/ignite/blob/b9999269468cd6e91a8c855adb2efc6e017df09d/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java?ref=b9999269468cd6e91a8c855adb2efc6e017df09d",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "patch": "@@ -692,8 +692,16 @@ private void cleanup(CacheConfiguration cfg, @Nullable Object rsrc, boolean near\n         for (GridCacheSharedManager mgr : sharedCtx.managers())\n             mgr.start(sharedCtx);\n \n-        if (ctx.config().isDaemon())\n+        if (ctx.config().isDaemon()) {\n+            ctx.state().cacheProcessorStarted(new CacheJoinNodeDiscoveryData(\n+                IgniteUuid.randomUuid(),\n+                Collections.<String, CacheInfo>emptyMap(),\n+                Collections.<String, CacheInfo>emptyMap(),\n+                false\n+            ));\n+\n             return;\n+        }\n \n         Map<String, CacheInfo> caches = new HashMap<>();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/b9999269468cd6e91a8c855adb2efc6e017df09d/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java",
                "sha": "c425bfbcd6fa95814f173d621357cb105e1043e4",
                "status": "modified"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/ignite/blob/b9999269468cd6e91a8c855adb2efc6e017df09d/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteStandByClusterTest.java",
                "changes": 51,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteStandByClusterTest.java?ref=b9999269468cd6e91a8c855adb2efc6e017df09d",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteStandByClusterTest.java",
                "patch": "@@ -18,6 +18,7 @@\n package org.apache.ignite.internal.processors.cache.persistence.standbycluster;\n \n import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Map;\n import org.apache.ignite.IgniteCache;\n import org.apache.ignite.cluster.ClusterNode;\n@@ -40,8 +41,12 @@\n  *\n  */\n public class IgniteStandByClusterTest extends GridCommonAbstractTest {\n+    /** */\n     private static final TcpDiscoveryIpFinder vmIpFinder = new TcpDiscoveryVmIpFinder(true);\n \n+    /**\n+     *\n+     */\n     @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n         IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n \n@@ -52,6 +57,9 @@\n         return cfg;\n     }\n \n+    /**\n+     * @throws Exception if fail.\n+     */\n     public void testNotStartDynamicCachesOnClientAfterActivation() throws Exception {\n         final String cacheName0 = \"cache0\";\n         final String cacheName = \"cache\";\n@@ -117,6 +125,9 @@ public void testNotStartDynamicCachesOnClientAfterActivation() throws Exception\n         assertNotNull(ig3.cache(cacheName));\n     }\n \n+    /**\n+     * @throws Exception if fail.\n+     */\n     public void testStaticCacheStartAfterActivationWithCacheFilter() throws Exception {\n         String cache1 = \"cache1\";\n         String cache2 = \"cache2\";\n@@ -187,6 +198,9 @@ public void testStaticCacheStartAfterActivationWithCacheFilter() throws Exceptio\n         Assert.assertNotNull(caches3.get(cache3));\n     }\n \n+    /**\n+     * @throws Exception if fail.\n+     */\n     public void testSimple() throws Exception {\n         IgniteEx ig = startGrid(0);\n \n@@ -209,6 +223,29 @@ public void testSimple() throws Exception {\n         assertEquals(\"1\", cache.get(1));\n     }\n \n+    /**\n+     * @throws Exception if fail.\n+     */\n+    public void testJoinDaemonAndDaemonStop() throws Exception {\n+        IgniteEx ig = startGrid(0);\n+\n+        IgniteEx daemon = startGrid(\n+            getConfiguration(\"daemon\")\n+                .setDaemon(true)\n+                .setClientMode(true)\n+        );\n+\n+        Collection<ClusterNode> daemons = ig.cluster().forDaemons().nodes();\n+\n+        Assert.assertEquals(1, daemons.size());\n+        assertEquals(daemon.localNode().id(), daemons.iterator().next().id());\n+\n+        daemon.close();\n+    }\n+\n+    /**\n+     * @throws Exception if fail.\n+     */\n     public void testRestartCluster() throws Exception {\n         IgniteEx ig1 = startGrid(getConfiguration(\"node1\"));\n         IgniteEx ig2 = startGrid(getConfiguration(\"node2\"));\n@@ -241,18 +278,29 @@ public void testRestartCluster() throws Exception {\n             assertEquals(String.valueOf(i), cache2.get(i));\n     }\n \n+    /**\n+     *\n+     */\n     private static class NodeFilterIgnoreByName implements IgnitePredicate<ClusterNode> {\n+        /** */\n         private final String name;\n \n+        /**\n+         * @param name\n+         */\n         private NodeFilterIgnoreByName(String name) {\n             this.name = name;\n         }\n \n+        /** */\n         @Override public boolean apply(ClusterNode node) {\n             return !name.equals(node.consistentId());\n         }\n     }\n \n+    /**\n+     *\n+     */\n     @Override protected void beforeTest() throws Exception {\n         super.beforeTest();\n \n@@ -261,6 +309,9 @@ private NodeFilterIgnoreByName(String name) {\n         deleteRecursively(U.resolveWorkDirectory(U.defaultWorkDirectory(), \"db\", true));\n     }\n \n+    /**\n+     *\n+     */\n     @Override protected void afterTest() throws Exception {\n         super.beforeTest();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/b9999269468cd6e91a8c855adb2efc6e017df09d/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/standbycluster/IgniteStandByClusterTest.java",
                "sha": "c3bdcdaf734098ac07043c5232b504f243a0f16c",
                "status": "modified"
            }
        ],
        "message": "ignite-12336 fix npe in cluster state processor on stop daemon client node",
        "parent": "https://github.com/apache/ignite/commit/7c515eef4b5e07d8799a860b32ad472d77e319a2",
        "patched_files": [
            "GridCacheProcessor.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteStandByClusterTest.java"
        ]
    },
    "ignite_be48a28": {
        "bug_id": "ignite_be48a28",
        "commit": "https://github.com/apache/ignite/commit/be48a28bdf05d8b37f5b2243d605e9646f644267",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/be48a28bdf05d8b37f5b2243d605e9646f644267/modules/core/src/test/java/org/apache/ignite/p2p/GridP2PComputeWithNestedEntryProcessorTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/p2p/GridP2PComputeWithNestedEntryProcessorTest.java?ref=be48a28bdf05d8b37f5b2243d605e9646f644267",
                "deletions": 1,
                "filename": "modules/core/src/test/java/org/apache/ignite/p2p/GridP2PComputeWithNestedEntryProcessorTest.java",
                "patch": "@@ -126,6 +126,8 @@ public void processTest() throws Exception {\n \n             createAndLoadCache(ignite);\n \n+            awaitPartitionMapExchange();\n+\n             for (int i = 0; i < 10; i++) {\n                 try (Ignite client = startGrid(\"client\")) {\n \n@@ -134,7 +136,7 @@ public void processTest() throws Exception {\n                     Integer key = primaryKey(ignite(1).cache(DEFAULT_CACHE_NAME));\n \n                     for (Boolean res : runJob(client, 10_000, DEFAULT_CACHE_NAME, key)) {\n-                        assertTrue(res);\n+                        assertTrue(key >= ENTRIES || res);\n                     }\n \n                     scnaCacheData(cache);",
                "raw_url": "https://github.com/apache/ignite/raw/be48a28bdf05d8b37f5b2243d605e9646f644267/modules/core/src/test/java/org/apache/ignite/p2p/GridP2PComputeWithNestedEntryProcessorTest.java",
                "sha": "382328be57e996106d472ea5fa5b861467de0891",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/be48a28bdf05d8b37f5b2243d605e9646f644267/modules/extdata/p2p/src/main/java/org/apache/ignite/tests/p2p/pedicates/CompositePredicate.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/extdata/p2p/src/main/java/org/apache/ignite/tests/p2p/pedicates/CompositePredicate.java?ref=be48a28bdf05d8b37f5b2243d605e9646f644267",
                "deletions": 0,
                "filename": "modules/extdata/p2p/src/main/java/org/apache/ignite/tests/p2p/pedicates/CompositePredicate.java",
                "patch": "@@ -36,6 +36,7 @@\n \n         for (BinaryPredicate predicate : predicates) {\n             predicate.ignite = ignite;\n+            predicate.log = log;\n \n             if (!predicate.apply(bo))\n                 return false;",
                "raw_url": "https://github.com/apache/ignite/raw/be48a28bdf05d8b37f5b2243d605e9646f644267/modules/extdata/p2p/src/main/java/org/apache/ignite/tests/p2p/pedicates/CompositePredicate.java",
                "sha": "4879f8a3f4138d3b2ce19ed810694dc0fad32b2b",
                "status": "modified"
            }
        ],
        "message": "IGNITE-11763 Fix NPE in GridP2PComputeWithNestedEntryProcessorTest - Fixes #6466.\n\nSigned-off-by: Ilya Kasnacheev <ilya.kasnacheev@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/22652aa9883cfa3fd020658bcb230cea9ea6e4d4",
        "patched_files": [
            "CompositePredicate.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridP2PComputeWithNestedEntryProcessorTest.java"
        ]
    },
    "ignite_bfa375b": {
        "bug_id": "ignite_bfa375b",
        "commit": "https://github.com/apache/ignite/commit/bfa375bbc991c1d0eea9837952be5fee87e4b558",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/ignite/blob/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/main/java/org/apache/ignite/internal/processors/rest/handlers/query/QueryCommandHandler.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/rest/handlers/query/QueryCommandHandler.java?ref=bfa375bbc991c1d0eea9837952be5fee87e4b558",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/rest/handlers/query/QueryCommandHandler.java",
                "patch": "@@ -30,6 +30,7 @@\n import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.locks.ReentrantLock;\n import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteCheckedException;\n import org.apache.ignite.IgniteException;\n import org.apache.ignite.cache.query.Query;\n import org.apache.ignite.cache.query.QueryCursor;\n@@ -217,22 +218,31 @@ private static void removeQueryCursor(Long qryId, ConcurrentHashMap<Long, QueryC\n         assert SUPPORTED_COMMANDS.contains(req.command());\n         assert req instanceof RestQueryRequest : \"Invalid type of query request.\";\n \n+        if (req.command() != CLOSE_SQL_QUERY) {\n+            Integer pageSize = ((RestQueryRequest) req).pageSize();\n+\n+            if (pageSize == null)\n+                return new GridFinishedFuture<>(\n+                        new IgniteCheckedException(GridRestCommandHandlerAdapter.missingParameter(\"pageSize\"))\n+                );\n+        }\n+\n         switch (req.command()) {\n             case EXECUTE_SQL_QUERY:\n             case EXECUTE_SQL_FIELDS_QUERY:\n             case EXECUTE_SCAN_QUERY: {\n                 return ctx.closure().callLocalSafe(\n-                    new ExecuteQueryCallable(ctx, (RestQueryRequest)req, qryCurs), false);\n+                        new ExecuteQueryCallable(ctx, (RestQueryRequest) req, qryCurs), false);\n             }\n \n             case FETCH_SQL_QUERY: {\n                 return ctx.closure().callLocalSafe(\n-                    new FetchQueryCallable((RestQueryRequest)req, qryCurs), false);\n+                        new FetchQueryCallable((RestQueryRequest) req, qryCurs), false);\n             }\n \n             case CLOSE_SQL_QUERY: {\n                 return ctx.closure().callLocalSafe(\n-                    new CloseQueryCallable((RestQueryRequest)req, qryCurs), false);\n+                        new CloseQueryCallable((RestQueryRequest) req, qryCurs), false);\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/main/java/org/apache/ignite/internal/processors/rest/handlers/query/QueryCommandHandler.java",
                "sha": "ee728a62770b46e3ebf0aea8c146c61c2049afad",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/main/java/org/apache/ignite/internal/processors/rest/request/RestQueryRequest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/rest/request/RestQueryRequest.java?ref=bfa375bbc991c1d0eea9837952be5fee87e4b558",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/rest/request/RestQueryRequest.java",
                "patch": "@@ -88,7 +88,7 @@ public void pageSize(Integer pageSize) {\n     /**\n      * @return Page size.\n      */\n-    public int pageSize() {\n+    public Integer pageSize() {\n         return pageSize;\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/main/java/org/apache/ignite/internal/processors/rest/request/RestQueryRequest.java",
                "sha": "75c74db557f3728ed16a5bf19ebb933c78a0dcf4",
                "status": "modified"
            },
            {
                "additions": 191,
                "blob_url": "https://github.com/apache/ignite/blob/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/test/java/org/apache/ignite/internal/processors/rest/handlers/query/GridQueryCommandHandlerTest.java",
                "changes": 191,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/rest/handlers/query/GridQueryCommandHandlerTest.java?ref=bfa375bbc991c1d0eea9837952be5fee87e4b558",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/rest/handlers/query/GridQueryCommandHandlerTest.java",
                "patch": "@@ -0,0 +1,191 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.rest.handlers.query;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.configuration.ConnectorConfiguration;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.internal.processors.rest.GridRestCommand;\n+import org.apache.ignite.internal.processors.rest.GridRestResponse;\n+import org.apache.ignite.internal.processors.rest.request.RestQueryRequest;\n+import org.apache.ignite.internal.processors.timeout.GridTimeoutProcessor;\n+import org.apache.ignite.testframework.junits.GridTestKernalContext;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+import java.util.Collection;\n+\n+/**\n+ * REST query command handler tests.\n+ */\n+public class GridQueryCommandHandlerTest extends GridCommonAbstractTest {\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        super.beforeTestsStarted();\n+\n+        startGrid();\n+\n+        ConnectorConfiguration connCfg = new ConnectorConfiguration();\n+\n+        connCfg.setIdleQueryCursorCheckFrequency(1000);\n+        connCfg.setIdleQueryCursorTimeout(1000);\n+\n+        grid().configuration().setConnectorConfiguration(connCfg);\n+\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() throws Exception {\n+        super.afterTestsStopped();\n+\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testSupportedCommands() throws Exception {\n+        GridTestKernalContext ctx = newContext(grid().configuration());\n+\n+        ctx.add(new GridTimeoutProcessor(ctx));\n+\n+        QueryCommandHandler cmdHnd = new QueryCommandHandler(ctx);\n+\n+        Collection<GridRestCommand> commands = cmdHnd.supportedCommands();\n+\n+        assertEquals(5, commands.size());\n+\n+        assertTrue(commands.contains(GridRestCommand.EXECUTE_SQL_QUERY));\n+        assertTrue(commands.contains(GridRestCommand.EXECUTE_SQL_FIELDS_QUERY));\n+        assertTrue(commands.contains(GridRestCommand.EXECUTE_SCAN_QUERY));\n+        assertTrue(commands.contains(GridRestCommand.FETCH_SQL_QUERY));\n+        assertTrue(commands.contains(GridRestCommand.CLOSE_SQL_QUERY));\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testUnsupportedCommands() throws Exception {\n+        GridTestKernalContext ctx = newContext(grid().configuration());\n+\n+        ctx.add(new GridTimeoutProcessor(ctx));\n+\n+        QueryCommandHandler cmdHnd = new QueryCommandHandler(ctx);\n+\n+        Collection<GridRestCommand> commands = cmdHnd.supportedCommands();\n+\n+        assertFalse(commands.contains(GridRestCommand.LOG));\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testNullCache() throws Exception {\n+        QueryCommandHandler cmdHnd = new QueryCommandHandler(grid().context());\n+\n+        Integer arg1 = 1000;\n+\n+        Object[] arr = new Object[] {arg1, arg1};\n+\n+        RestQueryRequest req = new RestQueryRequest();\n+\n+        req.command(GridRestCommand.EXECUTE_SQL_QUERY);\n+        req.queryType(RestQueryRequest.QueryType.SCAN);\n+        req.typeName(Integer.class.getName());\n+        req.pageSize(10);\n+        req.sqlQuery(\"salary+>+%3F+and+salary+<%3D+%3F\");\n+        req.arguments(arr);\n+        req.cacheName(null);\n+\n+        IgniteInternalFuture<GridRestResponse> resp = cmdHnd.handleAsync(req);\n+        resp.get();\n+\n+        assertEquals(\"Failed to find cache with name: null\", resp.result().getError());\n+        assertEquals(GridRestResponse.STATUS_FAILED, resp.result().getSuccessStatus());\n+        assertNull(resp.result().getResponse());\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testNullPageSize() throws Exception {\n+        grid().getOrCreateCache(getName());\n+\n+        QueryCommandHandler cmdHnd = new QueryCommandHandler(grid().context());\n+\n+        Integer arg1 = 1000;\n+\n+        Object[] arr = new Object[] {arg1, arg1};\n+\n+        RestQueryRequest req = new RestQueryRequest();\n+\n+        req.command(GridRestCommand.EXECUTE_SQL_QUERY);\n+        req.queryType(RestQueryRequest.QueryType.SCAN);\n+        req.typeName(Integer.class.getName());\n+\n+        req.pageSize(null);\n+        req.sqlQuery(\"salary+>+%3F+and+salary+<%3D+%3F\");\n+\n+        req.arguments(arr);\n+        req.cacheName(getName());\n+\n+        try {\n+            IgniteInternalFuture<GridRestResponse> resp = cmdHnd.handleAsync(req);\n+            resp.get();\n+\n+            fail(\"Expected exception not thrown.\");\n+        }\n+        catch (IgniteCheckedException e) {\n+            info(\"Got expected exception: \" + e);\n+        }\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testQuery() throws Exception {\n+        grid().getOrCreateCache(getName());\n+\n+        QueryCommandHandler cmdHnd = new QueryCommandHandler(grid().context());\n+\n+        Integer arg1 = 1000;\n+\n+        Object[] arr = new Object[] {arg1, arg1};\n+\n+        RestQueryRequest req = new RestQueryRequest();\n+\n+        req.command(GridRestCommand.EXECUTE_SQL_QUERY);\n+        req.queryType(RestQueryRequest.QueryType.SCAN);\n+        req.typeName(Integer.class.getName());\n+        req.pageSize(null);\n+        req.sqlQuery(\"salary+>+%3F+and+salary+<%3D+%3F\");\n+        req.arguments(arr);\n+        req.cacheName(getName());\n+        req.pageSize(10);\n+\n+        IgniteInternalFuture<GridRestResponse> resp = cmdHnd.handleAsync(req);\n+        resp.get();\n+\n+        assertNull(resp.result().getError());\n+        assertEquals(GridRestResponse.STATUS_SUCCESS, resp.result().getSuccessStatus());\n+        assertNotNull(resp.result().getResponse());\n+\n+        CacheQueryResult res = (CacheQueryResult) resp.result().getResponse();\n+\n+        assertTrue(res.getLast());\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/test/java/org/apache/ignite/internal/processors/rest/handlers/query/GridQueryCommandHandlerTest.java",
                "sha": "7e4cd828c8793d9035f15d00aa4f2ddfff3e5c1c",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteRestHandlerTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteRestHandlerTestSuite.java?ref=bfa375bbc991c1d0eea9837952be5fee87e4b558",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteRestHandlerTestSuite.java",
                "patch": "@@ -21,6 +21,7 @@\n import org.apache.ignite.internal.processors.rest.handlers.cache.GridCacheAtomicCommandHandlerSelfTest;\n import org.apache.ignite.internal.processors.rest.handlers.cache.GridCacheCommandHandlerSelfTest;\n import org.apache.ignite.internal.processors.rest.handlers.log.GridLogCommandHandlerTest;\n+import org.apache.ignite.internal.processors.rest.handlers.query.GridQueryCommandHandlerTest;\n \n /**\n  * REST support tests.\n@@ -36,6 +37,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(GridCacheCommandHandlerSelfTest.class);\n         suite.addTestSuite(GridCacheAtomicCommandHandlerSelfTest.class);\n         suite.addTestSuite(GridLogCommandHandlerTest.class);\n+        suite.addTestSuite(GridQueryCommandHandlerTest.class);\n \n         return suite;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/bfa375bbc991c1d0eea9837952be5fee87e4b558/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteRestHandlerTestSuite.java",
                "sha": "6263e8bee18a09e6e7be7f1ecc69d7f3f11ed076",
                "status": "modified"
            }
        ],
        "message": "ignite-3407 HTTP REST: query commands without pageSize failed with NPE",
        "parent": "https://github.com/apache/ignite/commit/a235985ef65ba22e5c4e36f893e3a48151fdfc7e",
        "patched_files": [
            "RestQueryRequest.java",
            "QueryCommandHandler.java",
            "IgniteRestHandlerTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridQueryCommandHandlerTest.java"
        ]
    },
    "ignite_c48f3bc": {
        "bug_id": "ignite_c48f3bc",
        "commit": "https://github.com/apache/ignite/commit/c48f3bc1046b1c496e0261edf7a693efc728b8f6",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/ignite/blob/c48f3bc1046b1c496e0261edf7a693efc728b8f6/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java?ref=c48f3bc1046b1c496e0261edf7a693efc728b8f6",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "patch": "@@ -451,6 +451,10 @@ public UUID getCoordinator() {\n \n     /** {@inheritDoc} */\n     @Override public Collection<ClusterNode> getRemoteNodes() {\n+        // Return empty nodes for resolving compatibility until implementation started.\n+        if (impl == null)\n+            return Collections.emptyList();\n+\n         return impl.getRemoteNodes();\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/c48f3bc1046b1c496e0261edf7a693efc728b8f6/modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java",
                "sha": "c48fa11325ad5aad84bacbab46b9319c382d7b43",
                "status": "modified"
            },
            {
                "additions": 172,
                "blob_url": "https://github.com/apache/ignite/blob/c48f3bc1046b1c496e0261edf7a693efc728b8f6/modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/IgniteTcpCommunicationConnectOnInitTest.java",
                "changes": 172,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/IgniteTcpCommunicationConnectOnInitTest.java?ref=c48f3bc1046b1c496e0261edf7a693efc728b8f6",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/IgniteTcpCommunicationConnectOnInitTest.java",
                "patch": "@@ -0,0 +1,172 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.spi.communication.tcp;\n+\n+import java.net.BindException;\n+import java.net.InetSocketAddress;\n+import java.nio.channels.SocketChannel;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.internal.util.nio.GridNioServer;\n+import org.apache.ignite.internal.util.nio.GridNioServerListenerAdapter;\n+import org.apache.ignite.internal.util.nio.GridNioSession;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.spi.IgniteSpiException;\n+import org.apache.ignite.spi.communication.tcp.messages.HandshakeWaitMessage;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.jetbrains.annotations.Nullable;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Testing {@link TcpCommunicationSpi} that will send the wait handshake message on received connections until SPI\n+ * context initialized.\n+ */\n+@RunWith(JUnit4.class)\n+public class IgniteTcpCommunicationConnectOnInitTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final int START_PORT = 55443;\n+\n+    /** */\n+    private volatile CountDownLatch commStartLatch;\n+\n+    /** */\n+    private volatile int commSpiBoundedPort;\n+\n+    /** */\n+    private volatile String commSpiSrvAddr;\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCommunicationSpi(new TestCommunicationSpi());\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testClientConnectBeforeDiscoveryStarted() throws Exception {\n+        GridNioServer<?> srvr = startServer();\n+\n+        try {\n+            commStartLatch = new CountDownLatch(1);\n+\n+            IgniteInternalFuture<Boolean> fut = GridTestUtils.runAsync(() -> {\n+                startGrid(0);\n+\n+                return true;\n+            });\n+\n+            assertTrue(commStartLatch.await(5_000, TimeUnit.MILLISECONDS));\n+\n+            SocketChannel ch = SocketChannel.open(new InetSocketAddress(commSpiSrvAddr, commSpiBoundedPort));\n+\n+            GridNioSession ses = srvr.createSession(ch, null, false, null).get();\n+\n+            boolean wait = GridTestUtils.waitForCondition(\n+                () -> ses.bytesReceived() == HandshakeWaitMessage.MESSAGE_FULL_SIZE, 1000);\n+\n+            assertTrue(\"Handshake not started.\", wait);\n+\n+            fut.get();\n+        }\n+        finally {\n+            srvr.stop();\n+        }\n+    }\n+\n+    /**\n+     * Starts custom server.\n+     *\n+     * @return Started server.\n+     * @throws Exception If failed.\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    private GridNioServer<?> startServer() throws Exception {\n+        int srvPort = START_PORT;\n+\n+        for (int i = 0; i < 10; i++) {\n+            try {\n+                GridNioServerListenerAdapter lsnr = new GridNioServerListenerAdapter() {\n+                    @Override public void onConnected(GridNioSession ses) {\n+                        // No-op.\n+                    }\n+\n+                    @Override public void onDisconnected(GridNioSession ses, @Nullable Exception e) {\n+                        // No-op.\n+                    }\n+\n+                    @Override public void onMessage(GridNioSession ses, Object msg) {\n+                        // No-op.\n+                    }\n+                };\n+\n+                GridNioServer<?> srvr = GridNioServer.builder()\n+                    .address(U.getLocalHost())\n+                    .port(srvPort)\n+                    .listener(lsnr)\n+                    .logger(log)\n+                    .selectorCount(Runtime.getRuntime().availableProcessors())\n+                    .igniteInstanceName(\"nio-test-grid\")\n+                    .filters().build();\n+\n+                srvr.start();\n+\n+                return srvr;\n+            }\n+            catch (IgniteCheckedException e) {\n+                if (i < 9 && e.hasCause(BindException.class)) {\n+                    log.error(\"Failed to start server, will try another port [err=\" + e + \", port=\" + srvPort + ']');\n+\n+                    U.sleep(1000);\n+\n+                    srvPort++;\n+                }\n+                else\n+                    throw e;\n+            }\n+        }\n+\n+        fail(\"Failed to start server.\");\n+\n+        return null;\n+    }\n+\n+    /** */\n+    private class TestCommunicationSpi extends TcpCommunicationSpi {\n+        /** {@inheritDoc} */\n+        @Override public void spiStart(String igniteInstanceName) throws IgniteSpiException {\n+            super.spiStart(igniteInstanceName);\n+\n+            commSpiBoundedPort = boundPort();\n+\n+            commSpiSrvAddr = getLocalAddress();\n+\n+            commStartLatch.countDown();\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/c48f3bc1046b1c496e0261edf7a693efc728b8f6/modules/core/src/test/java/org/apache/ignite/spi/communication/tcp/IgniteTcpCommunicationConnectOnInitTest.java",
                "sha": "029331617fa1110b92cc074d89beea38910140bf",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/c48f3bc1046b1c496e0261edf7a693efc728b8f6/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteSpiCommunicationSelfTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteSpiCommunicationSelfTestSuite.java?ref=c48f3bc1046b1c496e0261edf7a693efc728b8f6",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteSpiCommunicationSelfTestSuite.java",
                "patch": "@@ -36,6 +36,7 @@\n import org.apache.ignite.spi.communication.tcp.GridTcpCommunicationSpiTcpFailureDetectionSelfTest;\n import org.apache.ignite.spi.communication.tcp.GridTcpCommunicationSpiTcpNoDelayOffSelfTest;\n import org.apache.ignite.spi.communication.tcp.GridTcpCommunicationSpiTcpSelfTest;\n+import org.apache.ignite.spi.communication.tcp.IgniteTcpCommunicationConnectOnInitTest;\n import org.apache.ignite.spi.communication.tcp.IgniteTcpCommunicationHandshakeWaitSslTest;\n import org.apache.ignite.spi.communication.tcp.IgniteTcpCommunicationHandshakeWaitTest;\n import org.apache.ignite.spi.communication.tcp.IgniteTcpCommunicationRecoveryAckClosureSelfTest;\n@@ -92,6 +93,7 @@ public static TestSuite suite() throws Exception {\n \n         suite.addTest(new JUnit4TestAdapter(IgniteTcpCommunicationHandshakeWaitTest.class));\n         suite.addTest(new JUnit4TestAdapter(IgniteTcpCommunicationHandshakeWaitSslTest.class));\n+        suite.addTest(new JUnit4TestAdapter(IgniteTcpCommunicationConnectOnInitTest.class));\n \n         //suite.addTest(new TestSuite(GridCacheDhtLockBackupSelfTest.class));\n ",
                "raw_url": "https://github.com/apache/ignite/raw/c48f3bc1046b1c496e0261edf7a693efc728b8f6/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteSpiCommunicationSelfTestSuite.java",
                "sha": "5a208e67343e1a3eb2e1e00f4f52a3849e5fcd0f",
                "status": "modified"
            }
        ],
        "message": "IGNITE-4111 Fixed NPE on client connect before disco impl is initialized - Fixes #5650.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/4ae29fca74e814321c8448e00e9d3fdcd54733aa",
        "patched_files": [
            "IgniteSpiCommunicationSelfTestSuite.java",
            "TcpDiscoverySpi.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteTcpCommunicationConnectOnInitTest.java",
            "TestTcpDiscoverySpi.java"
        ]
    },
    "ignite_c7aaee7": {
        "bug_id": "ignite_c7aaee7",
        "commit": "https://github.com/apache/ignite/commit/c7aaee7ed577dbfc550948494ca74d8261bbdff4",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/c7aaee7ed577dbfc550948494ca74d8261bbdff4/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java?ref=c7aaee7ed577dbfc550948494ca74d8261bbdff4",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "patch": "@@ -1362,7 +1362,8 @@ private void prepareIndexRebuildFuture(int cacheId) {\n                     final int cacheId = cacheCtx.cacheId();\n                     final GridFutureAdapter<Void> usrFut = idxRebuildFuts.get(cacheId);\n \n-                    if (!cctx.pageStore().hasIndexStore(cacheCtx.groupId()) && cacheCtx.affinityNode()) {\n+                    if (!cctx.pageStore().hasIndexStore(cacheCtx.groupId()) && cacheCtx.affinityNode()\n+                        && cacheCtx.group().persistenceEnabled()) {\n                         IgniteInternalFuture<?> rebuildFut = cctx.kernalContext().query()\n                             .rebuildIndexesFromHash(Collections.singleton(cacheCtx.cacheId()));\n ",
                "raw_url": "https://github.com/apache/ignite/raw/c7aaee7ed577dbfc550948494ca74d8261bbdff4/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheDatabaseSharedManager.java",
                "sha": "a86b9f5c449f04d99c41d4fe31623d59040f1aff",
                "status": "modified"
            },
            {
                "additions": 124,
                "blob_url": "https://github.com/apache/ignite/blob/c7aaee7ed577dbfc550948494ca74d8261bbdff4/modules/indexing/src/test/java/org/apache/ignite/internal/processors/database/IgniteTwoRegionsRebuildIndexTest.java",
                "changes": 124,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/database/IgniteTwoRegionsRebuildIndexTest.java?ref=c7aaee7ed577dbfc550948494ca74d8261bbdff4",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/database/IgniteTwoRegionsRebuildIndexTest.java",
                "patch": "@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.database;\n+\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteDataStreamer;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * Tests the case when preformed index rebuild for created by client in-memory cache.\n+ */\n+public class IgniteTwoRegionsRebuildIndexTest extends GridCommonAbstractTest {\n+    /** */\n+    private static final String PERSISTED_CACHE = \"persisted\";\n+\n+    /** */\n+    private static final String INMEMORY_CACHE = \"inmemory\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        boolean client = igniteInstanceName.startsWith(\"client\");\n+\n+        DataStorageConfiguration dsCfg = new DataStorageConfiguration();\n+\n+        if (!client) {\n+            DataRegionConfiguration drCfg1 = new DataRegionConfiguration();\n+            drCfg1.setMaxSize(16 * 1024 * 1024);\n+            drCfg1.setName(\"nopersistence\");\n+            drCfg1.setInitialSize(drCfg1.getMaxSize());\n+            drCfg1.setPersistenceEnabled(false);\n+\n+            DataRegionConfiguration drCfg2 = new DataRegionConfiguration();\n+            drCfg2.setMaxSize(16 * 1024 * 1024);\n+            drCfg2.setName(\"persistence\");\n+            drCfg2.setInitialSize(drCfg2.getMaxSize());\n+            drCfg2.setPersistenceEnabled(true);\n+\n+            dsCfg.setDataRegionConfigurations(drCfg1, drCfg2);\n+\n+            cfg.setDataStorageConfiguration(dsCfg);\n+        }\n+        else {\n+            CacheConfiguration ccfg1 = new CacheConfiguration(PERSISTED_CACHE);\n+            CacheConfiguration ccfg2 = new CacheConfiguration(INMEMORY_CACHE);\n+\n+            ccfg1.setDataRegionName(\"persistence\");\n+            ccfg2.setDataRegionName(\"nopersistence\");\n+\n+            cfg.setCacheConfiguration(ccfg1, ccfg2);\n+            cfg.setClientMode(true);\n+        }\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTest() throws Exception {\n+        super.beforeTest();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids();\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testRebuildIndexes() throws Exception {\n+        startGrid(\"server\");\n+        Ignite client = startGrid(\"client\");\n+\n+        client.cluster().active(true);\n+\n+        populateData(client, PERSISTED_CACHE);\n+        populateData(client, INMEMORY_CACHE);\n+\n+        stopGrid(\"server\");\n+        startGrid(\"server\");\n+\n+        stopGrid(\"client\");\n+        startGrid(\"client\");\n+    }\n+\n+    /**\n+     * @param ignite Ignite.\n+     * @param cacheName Cache name.\n+     */\n+    private void populateData(Ignite ignite, String cacheName) {\n+        try (IgniteDataStreamer<Object, Object> streamer = ignite.dataStreamer(cacheName)) {\n+            for (int i = 0; i < 1000; i++)\n+                streamer.addData(i, i);\n+\n+            streamer.flush();\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/c7aaee7ed577dbfc550948494ca74d8261bbdff4/modules/indexing/src/test/java/org/apache/ignite/internal/processors/database/IgniteTwoRegionsRebuildIndexTest.java",
                "sha": "7d5b296f931cae706052a99447409142523bc02b",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/c7aaee7ed577dbfc550948494ca74d8261bbdff4/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingTestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingTestSuite.java?ref=c7aaee7ed577dbfc550948494ca74d8261bbdff4",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingTestSuite.java",
                "patch": "@@ -25,6 +25,7 @@\n import org.apache.ignite.internal.processors.database.IgniteDbSingleNodeWithIndexingWalRestoreTest;\n import org.apache.ignite.internal.processors.database.IgnitePersistentStoreQueryWithMultipleClassesPerCacheTest;\n import org.apache.ignite.internal.processors.database.IgnitePersistentStoreSchemaLoadTest;\n+import org.apache.ignite.internal.processors.database.IgniteTwoRegionsRebuildIndexTest;\n \n /**\n  *\n@@ -44,6 +45,7 @@ public static TestSuite suite() throws Exception {\n         suite.addTestSuite(IgnitePdsSingleNodeWithIndexingAndGroupPutGetPersistenceSelfTest.class);\n         suite.addTestSuite(IgnitePersistentStoreSchemaLoadTest.class);\n         suite.addTestSuite(IgnitePersistentStoreQueryWithMultipleClassesPerCacheTest.class);\n+        suite.addTestSuite(IgniteTwoRegionsRebuildIndexTest.class);\n \n         return suite;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/c7aaee7ed577dbfc550948494ca74d8261bbdff4/modules/indexing/src/test/java/org/apache/ignite/testsuites/IgnitePdsWithIndexingTestSuite.java",
                "sha": "67b9fad63cde2232a34300806acf3a74684370b0",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9425 Fixed NPE on index rebuild - Fixes #4647.\n\nSigned-off-by: Alexey Goncharuk <alexey.goncharuk@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/8cb4591d691e9438fd0bf0809bb105229b4f7ff8",
        "patched_files": [
            "GridCacheDatabaseSharedManager.java",
            "IgnitePdsWithIndexingTestSuite.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteTwoRegionsRebuildIndexTest.java"
        ]
    },
    "ignite_c917327": {
        "bug_id": "ignite_c917327",
        "commit": "https://github.com/apache/ignite/commit/c917327b74b3dbcb65b961277f5d2c99a71b7a8a",
        "file": [
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/ignite/blob/c917327b74b3dbcb65b961277f5d2c99a71b7a8a/modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/DiscoveryDataClusterState.java",
                "changes": 41,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/DiscoveryDataClusterState.java?ref=c917327b74b3dbcb65b961277f5d2c99a71b7a8a",
                "deletions": 9,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/DiscoveryDataClusterState.java",
                "patch": "@@ -28,36 +28,55 @@\n import org.jetbrains.annotations.Nullable;\n \n /**\n- * Discovery data related to cluster state.\n+ * A pojo-object representing current cluster global state. The state includes cluster active flag and cluster\n+ * baseline topology.\n+ * <p>\n+ * This object also captures a transitional cluster state, when one or more fields are changing. In this case,\n+ * a {@code transitionReqId} field is set to a non-null value and {@code prevState} captures previous cluster state.\n+ * A joining node catching the cluster in an intermediate state will observe {@code transitionReqId} field to be\n+ * non-null, however the {@code prevState} will not be sent to the joining node.\n+ *\n+ * TODO https://issues.apache.org/jira/browse/IGNITE-7640 This class must be immutable, transitionRes must be set by calling finish().\n  */\n public class DiscoveryDataClusterState implements Serializable {\n     /** */\n     private static final long serialVersionUID = 0L;\n \n-    /** */\n+    /** Flag indicating if the cluster in in active state. */\n     private final boolean active;\n \n-    /** */\n+    /** Current cluster baseline topology. */\n     @Nullable private final BaselineTopology baselineTopology;\n \n-    /** */\n+    /**\n+     * Transition request ID. Set to a non-null value if the cluster is changing it's state.\n+     * The ID is assigned on the initiating node.\n+     */\n     private final UUID transitionReqId;\n \n-    /** Topology version for state change exchange. */\n+    /**\n+     * Topology version in the cluster when state change request was received by the coordinator.\n+     * The exchange fired for the cluster state change will be on version {@code transitionTopVer.nextMinorVersion()}.\n+     */\n     @GridToStringInclude\n     private final AffinityTopologyVersion transitionTopVer;\n \n     /** Nodes participating in state change exchange. */\n     @GridToStringExclude\n     private final Set<UUID> transitionNodes;\n \n-    /** Local flag for state transition result (global state is updated asynchronously by custom message). */\n+    /**\n+     * Local flag for state transition active state result (global state is updated asynchronously by custom message),\n+     * {@code null} means that state change is not completed yet.\n+     */\n     private transient volatile Boolean transitionRes;\n \n-    /** */\n+    /**\n+     * Previous cluster state if this state is a transition state and it was not received by a joining node.\n+     */\n     private transient DiscoveryDataClusterState prevState;\n \n-    /** */\n+    /** Transition result error. */\n     private transient volatile Exception transitionError;\n \n     /**\n@@ -86,6 +105,7 @@ static DiscoveryDataClusterState createTransitionState(\n         assert transitionReqId != null;\n         assert transitionTopVer != null;\n         assert !F.isEmpty(transitionNodes) : transitionNodes;\n+        assert prevState != null;\n \n         return new DiscoveryDataClusterState(\n             prevState,\n@@ -156,7 +176,7 @@ public boolean transition() {\n      * @return {@code True} if cluster active state change is in progress, {@code false} otherwise.\n      */\n     public boolean activeStateChanging() {\n-        return transition() && active != prevState.active;\n+        return transition() && (prevState == null || (prevState.active != active));\n     }\n \n     /**\n@@ -202,6 +222,9 @@ public void transitionError(Exception ex) {\n     }\n \n     /**\n+     * Creates a non-transitional cluster state. This method effectively cleans all fields identifying the\n+     * state as transitional and creates a new state with the state transition result.\n+     *\n      * @param success Transition success status.\n      * @return Cluster state that finished transition.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/c917327b74b3dbcb65b961277f5d2c99a71b7a8a/modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/DiscoveryDataClusterState.java",
                "sha": "b022754c6670a0ec50dada54717ef2ba2a3ade66",
                "status": "modified"
            },
            {
                "additions": 96,
                "blob_url": "https://github.com/apache/ignite/blob/c917327b74b3dbcb65b961277f5d2c99a71b7a8a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteClusterActivateDeactivateTest.java",
                "changes": 222,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteClusterActivateDeactivateTest.java?ref=c917327b74b3dbcb65b961277f5d2c99a71b7a8a",
                "deletions": 126,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteClusterActivateDeactivateTest.java",
                "patch": "@@ -37,7 +37,6 @@\n import org.apache.ignite.internal.IgniteClientReconnectAbstractTest;\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.IgniteInternalFuture;\n-import org.apache.ignite.internal.IgniteKernal;\n import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n import org.apache.ignite.internal.processors.affinity.AffinityTopologyVersion;\n import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.GridDhtPartitionsFullMessage;\n@@ -49,7 +48,6 @@\n import org.apache.ignite.lang.IgniteBiPredicate;\n import org.apache.ignite.plugin.extensions.communication.Message;\n import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n-import org.apache.ignite.spi.discovery.tcp.TestTcpDiscoverySpi;\n import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n import org.apache.ignite.testframework.GridTestUtils;\n@@ -84,9 +82,6 @@\n     /** */\n     private boolean testSpi;\n \n-    /** */\n-    private boolean testDiscoSpi;\n-\n     /** */\n     private boolean testReconnectSpi;\n \n@@ -104,8 +99,6 @@\n \n             spi.setJoinTimeout(2 * 60_000);\n         }\n-        else if (testDiscoSpi)\n-            cfg.setDiscoverySpi(new TestTcpDiscoverySpi());\n \n         ((TcpDiscoverySpi)cfg.getDiscoverySpi()).setIpFinder(IP_FINDER);\n \n@@ -220,14 +213,14 @@ private void activateSimple(int srvs, int clients, int activateFrom) throws Exce\n         }\n \n         for (int i = 0; i < srvs + clients; i++)\n-            assertFalse(ignite(i).active());\n+            assertFalse(ignite(i).cluster().active());\n \n-        ignite(activateFrom).active(false); // Should be no-op.\n+        ignite(activateFrom).cluster().active(false); // Should be no-op.\n \n-        ignite(activateFrom).active(true);\n+        ignite(activateFrom).cluster().active(true);\n \n         for (int i = 0; i < srvs + clients; i++)\n-            assertTrue(ignite(i).active());\n+            assertTrue(ignite(i).cluster().active());\n \n         for (int i = 0; i < srvs + clients; i++) {\n             for (int c = 0; c < 2; c++)\n@@ -308,16 +301,14 @@ public void testJoinWhileActivate1_Client() throws Exception {\n     private void joinWhileActivate1(final boolean startClient, final boolean withNewCache) throws Exception {\n         IgniteInternalFuture<?> activeFut = startNodesAndBlockStatusChange(2, 0, 0, false);\n \n-        IgniteInternalFuture<?> startFut = GridTestUtils.runAsync(new Callable<Void>() {\n-            @Override public Void call() throws Exception {\n-                client = startClient;\n+        IgniteInternalFuture<?> startFut = GridTestUtils.runAsync((Callable<Void>)() -> {\n+            client = startClient;\n \n-                ccfgs = withNewCache ? cacheConfigurations2() : cacheConfigurations1();\n+            ccfgs = withNewCache ? cacheConfigurations2() : cacheConfigurations1();\n \n-                startGrid(2);\n+            startGrid(2);\n \n-                return null;\n-            }\n+            return null;\n         });\n \n         TestRecordingCommunicationSpi spi1 = TestRecordingCommunicationSpi.spi(ignite(1));\n@@ -376,7 +367,7 @@ private void joinWhileActivate1(final boolean startClient, final boolean withNew\n         int minorVer = 1;\n \n         if (initiallyActive && persistenceEnabled()) {\n-            ignite(0).active(true);\n+            ignite(0).cluster().active(true);\n \n             minorVer++;\n         }\n@@ -396,11 +387,9 @@ private void joinWhileActivate1(final boolean startClient, final boolean withNew\n             blockExchangeSingleMessage(spi, STATE_CHANGE_TOP_VER);\n         }\n \n-        IgniteInternalFuture<?> stateChangeFut = GridTestUtils.runAsync(new Runnable() {\n-            @Override public void run() {\n-                ignite(stateChangeFrom).active(!initiallyActive);\n-            }\n-        });\n+        IgniteInternalFuture<?> stateChangeFut = GridTestUtils.runAsync(() ->\n+            ignite(stateChangeFrom).cluster().active(!initiallyActive)\n+        );\n \n         for (TestRecordingCommunicationSpi spi : spis)\n             spi.waitForBlocked();\n@@ -417,17 +406,15 @@ private void joinWhileActivate1(final boolean startClient, final boolean withNew\n      * @param topVer Exchange topology version.\n      */\n     private void blockExchangeSingleMessage(TestRecordingCommunicationSpi spi, final AffinityTopologyVersion topVer) {\n-        spi.blockMessages(new IgniteBiPredicate<ClusterNode, Message>() {\n-            @Override public boolean apply(ClusterNode clusterNode, Message msg) {\n-                if (msg instanceof GridDhtPartitionsSingleMessage) {\n-                    GridDhtPartitionsSingleMessage pMsg = (GridDhtPartitionsSingleMessage)msg;\n-\n-                    if (pMsg.exchangeId() != null && pMsg.exchangeId().topologyVersion().equals(topVer))\n-                        return true;\n-                }\n+        spi.blockMessages((IgniteBiPredicate<ClusterNode, Message>)(clusterNode, msg) -> {\n+            if (msg instanceof GridDhtPartitionsSingleMessage) {\n+                GridDhtPartitionsSingleMessage pMsg = (GridDhtPartitionsSingleMessage)msg;\n \n-                return false;\n+                if (pMsg.exchangeId() != null && pMsg.exchangeId().topologyVersion().equals(topVer))\n+                    return true;\n             }\n+\n+            return false;\n         });\n     }\n \n@@ -460,16 +447,14 @@ public void testJoinWhileDeactivate1_Client() throws Exception {\n     private void joinWhileDeactivate1(final boolean startClient, final boolean withNewCache) throws Exception {\n         IgniteInternalFuture<?> activeFut = startNodesAndBlockStatusChange(2, 0, 0, true);\n \n-        IgniteInternalFuture<?> startFut = GridTestUtils.runAsync(new Callable<Void>() {\n-            @Override public Void call() throws Exception {\n-                client = startClient;\n+        IgniteInternalFuture<?> startFut = GridTestUtils.runAsync((Callable<Void>)() -> {\n+            client = startClient;\n \n-                ccfgs = withNewCache ? cacheConfigurations2() : cacheConfigurations1();\n+            ccfgs = withNewCache ? cacheConfigurations2() : cacheConfigurations1();\n \n-                startGrid(2);\n+            startGrid(2);\n \n-                return null;\n-            }\n+            return null;\n         });\n \n         TestRecordingCommunicationSpi spi1 = TestRecordingCommunicationSpi.spi(ignite(1));\n@@ -481,7 +466,7 @@ private void joinWhileDeactivate1(final boolean startClient, final boolean withN\n \n         checkNoCaches(3);\n \n-        ignite(2).active(true);\n+        ignite(2).cluster().active(true);\n \n         for (int c = 0; c < 2; c++)\n             checkCache(ignite(2), CACHE_NAME_PREFIX + c, true);\n@@ -529,30 +514,26 @@ public void testConcurrentJoinAndActivate() throws Exception {\n \n             final CyclicBarrier b = new CyclicBarrier(START_NODES + 1);\n \n-            IgniteInternalFuture<?> fut1 = GridTestUtils.runAsync(new Callable<Void>() {\n-                @Override public Void call() throws Exception {\n-                    b.await();\n+            IgniteInternalFuture<Void> fut1 = GridTestUtils.runAsync(() -> {\n+                b.await();\n \n-                    Thread.sleep(ThreadLocalRandom.current().nextLong(100) + 1);\n+                U.sleep(ThreadLocalRandom.current().nextLong(100) + 1);\n \n-                    ignite(0).active(true);\n+                ignite(0).cluster().active(true);\n \n-                    return null;\n-                }\n+                return null;\n             });\n \n             final AtomicInteger nodeIdx = new AtomicInteger(3);\n \n-            IgniteInternalFuture<?> fut2 = GridTestUtils.runMultiThreadedAsync(new Callable<Void>() {\n-                @Override public Void call() throws Exception {\n-                    int idx = nodeIdx.getAndIncrement();\n+            IgniteInternalFuture<Long> fut2 = GridTestUtils.runMultiThreadedAsync((Callable<Void>)() -> {\n+                int idx = nodeIdx.getAndIncrement();\n \n-                    b.await();\n+                b.await();\n \n-                    startGrid(idx);\n+                startGrid(idx);\n \n-                    return null;\n-                }\n+                return null;\n             }, START_NODES, \"start-node\");\n \n             fut1.get();\n@@ -619,19 +600,19 @@ private void deactivateSimple(int srvs, int clients, int deactivateFrom) throws\n         }\n \n         if (persistenceEnabled())\n-            ignite(deactivateFrom).active(true);\n+            ignite(deactivateFrom).cluster().active(true);\n \n-        ignite(deactivateFrom).active(true); // Should be no-op.\n+        ignite(deactivateFrom).cluster().active(true); // Should be no-op.\n \n         checkCaches(srvs + clients, CACHES);\n \n         for (int i = 0; i < srvs + clients; i++)\n-            assertTrue(ignite(i).active());\n+            assertTrue(ignite(i).cluster().active());\n \n-        ignite(deactivateFrom).active(false);\n+        ignite(deactivateFrom).cluster().active(false);\n \n         for (int i = 0; i < srvs + clients; i++)\n-            assertFalse(ignite(i).active());\n+            assertFalse(ignite(i).cluster().active());\n \n         checkNoCaches(srvs + clients);\n \n@@ -648,12 +629,12 @@ private void deactivateSimple(int srvs, int clients, int deactivateFrom) throws\n         checkNoCaches(srvs + clients + 2);\n \n         for (int i = 0; i < srvs + clients + 2; i++)\n-            assertFalse(ignite(i).active());\n+            assertFalse(ignite(i).cluster().active());\n \n-        ignite(deactivateFrom).active(true);\n+        ignite(deactivateFrom).cluster().active(true);\n \n         for (int i = 0; i < srvs + clients + 2; i++) {\n-            assertTrue(ignite(i).active());\n+            assertTrue(ignite(i).cluster().active());\n \n             checkCache(ignite(i), CU.UTILITY_CACHE_NAME, true);\n         }\n@@ -695,7 +676,7 @@ public void testClientReconnectClusterActive() throws Exception {\n         startWithCaches1(SRVS, CLIENTS);\n \n         if (persistenceEnabled())\n-            ignite(0).active(true);\n+            ignite(0).cluster().active(true);\n \n         Ignite srv = ignite(0);\n         Ignite client = ignite(SRVS);\n@@ -741,7 +722,7 @@ public void testClientReconnectClusterInactive() throws Exception {\n \n         checkNoCaches(SRVS + CLIENTS);\n \n-        ignite(0).active(true);\n+        ignite(0).cluster().active(true);\n \n         checkCache(client, CU.UTILITY_CACHE_NAME, true);\n \n@@ -789,39 +770,38 @@ private void clientReconnectClusterDeactivated(final boolean transition) throws\n         IgniteEx client = grid(SRVS);\n \n         if (persistenceEnabled())\n-            ignite(0).active(true);\n+            ignite(0).cluster().active(true);\n \n         checkCache(client, CU.UTILITY_CACHE_NAME, true);\n \n         checkCaches1(SRVS + CLIENTS);\n \n+        // Wait for late affinity assignment to finish.\n+        grid(0).context().cache().context().exchange().affinityReadyFuture(\n+            new AffinityTopologyVersion(SRVS + CLIENTS, 1)).get();\n+\n         final AffinityTopologyVersion STATE_CHANGE_TOP_VER = new AffinityTopologyVersion(SRVS + CLIENTS + 1, 1);\n \n         final TestRecordingCommunicationSpi spi1 = transition ? TestRecordingCommunicationSpi.spi(ignite(1)) : null;\n \n         final AtomicReference<IgniteInternalFuture> stateFut = new AtomicReference<>();\n \n-        IgniteClientReconnectAbstractTest.reconnectClientNode(log, client, srv, new Runnable() {\n-            @Override public void run() {\n-                if (transition) {\n-                    blockExchangeSingleMessage(spi1, STATE_CHANGE_TOP_VER);\n-\n-                    stateFut.set(GridTestUtils.runAsync(new Runnable() {\n-                        @Override public void run() {\n-                            srv.active(false);\n-                        }\n-                    }, \"deactivate\"));\n-\n-                    try {\n-                        U.sleep(500);\n-                    }\n-                    catch (Exception e) {\n-                        e.printStackTrace();\n-                    }\n+        IgniteClientReconnectAbstractTest.reconnectClientNode(log, client, srv, () -> {\n+            if (transition) {\n+                blockExchangeSingleMessage(spi1, STATE_CHANGE_TOP_VER);\n+\n+                stateFut.set(GridTestUtils.runAsync(() -> srv.cluster().active(false),\n+                    \"deactivate\"));\n+\n+                try {\n+                    U.sleep(500);\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();\n                 }\n-                else\n-                    srv.active(false);\n             }\n+            else\n+                srv.cluster().active(false);\n         });\n \n         if (transition) {\n@@ -839,11 +819,11 @@ private void clientReconnectClusterDeactivated(final boolean transition) throws\n \n         checkNoCaches(SRVS + CLIENTS);\n \n-        ignite(0).active(true);\n+        ignite(0).cluster().active(true);\n \n         checkCache(client, CU.UTILITY_CACHE_NAME, true);\n \n-        assertTrue(client.active());\n+        assertTrue(client.cluster().active());\n \n         checkCaches1(SRVS + CLIENTS);\n \n@@ -900,27 +880,22 @@ private void clientReconnectClusterActivated(final boolean transition) throws Ex\n \n         final AtomicReference<IgniteInternalFuture> stateFut = new AtomicReference<>();\n \n-        IgniteClientReconnectAbstractTest.reconnectClientNode(log, client, srv, new Runnable() {\n-            @Override public void run() {\n-                if (transition) {\n-                    blockExchangeSingleMessage(spi1, STATE_CHANGE_TOP_VER);\n-\n-                    stateFut.set(GridTestUtils.runAsync(new Runnable() {\n-                        @Override public void run() {\n-                            srv.active(true);\n-                        }\n-                    }, \"activate\"));\n-\n-                    try {\n-                        U.sleep(500);\n-                    }\n-                    catch (Exception e) {\n-                        e.printStackTrace();\n-                    }\n+        IgniteClientReconnectAbstractTest.reconnectClientNode(log, client, srv, () -> {\n+            if (transition) {\n+                blockExchangeSingleMessage(spi1, STATE_CHANGE_TOP_VER);\n+\n+                stateFut.set(GridTestUtils.runAsync(() -> srv.cluster().active(true),\n+                    \"activate\"));\n+\n+                try {\n+                    U.sleep(500);\n+                }\n+                catch (Exception e) {\n+                    e.printStackTrace();\n                 }\n-                else\n-                    srv.active(true);\n             }\n+            else\n+                srv.cluster().active(true);\n         });\n \n         if (transition) {\n@@ -989,7 +964,7 @@ public void testInactiveTopologyChanges() throws Exception {\n \n         checkRecordedMessages(false);\n \n-        ignite(0).active(true);\n+        ignite(0).cluster().active(true);\n \n         checkCaches1(SRVS + CLIENTS);\n \n@@ -1033,12 +1008,10 @@ private void stateChangeFailover1(boolean activate) throws Exception {\n         client = false;\n \n         // Start one more node while transition is in progress.\n-        IgniteInternalFuture startFut = GridTestUtils.runAsync(new Callable() {\n-            @Override public Object call() throws Exception {\n-                startGrid(8);\n+        IgniteInternalFuture<Void> startFut = GridTestUtils.runAsync(() -> {\n+            startGrid(8);\n \n-                return null;\n-            }\n+            return null;\n         }, \"start-node\");\n \n         U.sleep(500);\n@@ -1061,7 +1034,7 @@ private void stateChangeFailover1(boolean activate) throws Exception {\n         if (!activate) {\n             checkNoCaches(9);\n \n-            ignite(0).active(true);\n+            ignite(0).cluster().active(true);\n         }\n \n         checkCaches1(9);\n@@ -1092,19 +1065,16 @@ private void stateChangeFailover2(boolean activate) throws Exception {\n         client = false;\n \n         // Start more nodes while transition is in progress.\n-        IgniteInternalFuture startFut1 = GridTestUtils.runAsync(new Callable() {\n-            @Override public Object call() throws Exception {\n-                startGrid(8);\n+        IgniteInternalFuture<Void> startFut1 = GridTestUtils.runAsync(() -> {\n+            startGrid(8);\n \n-                return null;\n-            }\n+            return null;\n         }, \"start-node1\");\n-        IgniteInternalFuture startFut2 = GridTestUtils.runAsync(new Callable() {\n-            @Override public Object call() throws Exception {\n-                startGrid(9);\n \n-                return null;\n-            }\n+        IgniteInternalFuture<Void> startFut2 = GridTestUtils.runAsync(() -> {\n+            startGrid(9);\n+\n+            return null;\n         }, \"start-node2\");\n \n         U.sleep(500);\n@@ -1132,7 +1102,7 @@ private void stateChangeFailover2(boolean activate) throws Exception {\n         if (!activate) {\n             checkNoCaches(10);\n \n-            ignite(0).active(true);\n+            ignite(0).cluster().active(true);\n         }\n \n         checkCaches1(10);\n@@ -1214,7 +1184,7 @@ void checkCache(Ignite node, String cacheName, boolean exp) throws IgniteChecked\n \n         ((IgniteEx)node).context().state().publicApiActiveState(true);\n \n-        GridCacheAdapter cache = ((IgniteKernal)node).context().cache().internalCache(cacheName);\n+        GridCacheAdapter cache = ((IgniteEx)node).context().cache().internalCache(cacheName);\n \n         if (exp)\n             assertNotNull(\"Cache not found [cache=\" + cacheName + \", node=\" + node.name() + ']', cache);\n@@ -1229,7 +1199,7 @@ final void checkNoCaches(int nodes) {\n         for (int i = 0; i < nodes; i++) {\n             grid(i).context().state().publicApiActiveState(true);\n \n-            GridCacheProcessor cache = ((IgniteKernal)ignite(i)).context().cache();\n+            GridCacheProcessor cache = ((IgniteEx)ignite(i)).context().cache();\n \n             assertTrue(cache.caches().isEmpty());\n             assertTrue(cache.internalCaches().isEmpty());",
                "raw_url": "https://github.com/apache/ignite/raw/c917327b74b3dbcb65b961277f5d2c99a71b7a8a/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteClusterActivateDeactivateTest.java",
                "sha": "2337329c5ce83f8f88d8b113182ab62ef1874809",
                "status": "modified"
            }
        ],
        "message": "IGNITE-7639 Fixed NPE",
        "parent": "https://github.com/apache/ignite/commit/ce7c1478ff19e2cd4becfda855246745b248b287",
        "patched_files": [
            "DiscoveryDataClusterState.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteClusterActivateDeactivateTest.java"
        ]
    },
    "ignite_c939bdb": {
        "bug_id": "ignite_c939bdb",
        "commit": "https://github.com/apache/ignite/commit/c939bdba3a159d1ccb080686796b50a03ac77c9f",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/c939bdba3a159d1ccb080686796b50a03ac77c9f/modules/ml/src/main/java/org/apache/ignite/ml/math/distributed/CacheUtils.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ml/src/main/java/org/apache/ignite/ml/math/distributed/CacheUtils.java?ref=c939bdba3a159d1ccb080686796b50a03ac77c9f",
                "deletions": 9,
                "filename": "modules/ml/src/main/java/org/apache/ignite/ml/math/distributed/CacheUtils.java",
                "patch": "@@ -20,6 +20,7 @@\n import java.util.Collection;\n import java.util.Collections;\n import java.util.Map;\n+import java.util.Objects;\n import java.util.function.BinaryOperator;\n import javax.cache.Cache;\n import org.apache.ignite.Ignite;\n@@ -72,15 +73,13 @@\n         }\n \n         /**\n-         *\n          *\n          */\n         public Cache.Entry<K, V> entry() {\n             return entry;\n         }\n \n         /**\n-         *\n          *\n          */\n         public IgniteCache<K, V> cache() {\n@@ -165,12 +164,8 @@ else if (v instanceof BlockEntry) {\n      * @return Sum of the values.\n      */\n     private static double sum(Collection<Double> c) {\n-        double sum = 0.0;\n-\n-        for (double d : c)\n-            sum += d;\n-\n-        return sum;\n+        // Fix for IGNITE-6762, some collections could store null values.\n+        return c.stream().filter(Objects::nonNull).mapToDouble(Double::doubleValue).sum();\n     }\n \n     /**\n@@ -401,7 +396,8 @@ else if (key instanceof RowColMatrixKey)\n \n                 // Iterate over given partition.\n                 // Query returns an empty cursor if this partition is not stored on this node.\n-                for (Cache.Entry<K, V> entry : cache.query(new ScanQuery<K, V>(part, (k, v) -> affinity.mapPartitionToNode(p) == locNode && (keyFilter == null || keyFilter.apply(k)))))\n+                for (Cache.Entry<K, V> entry : cache.query(new ScanQuery<K, V>(part,\n+                    (k, v) -> affinity.mapPartitionToNode(p) == locNode && (keyFilter == null || keyFilter.apply(k)))))\n                     fun.accept(new CacheEntry<>(entry, cache));\n             }\n         });",
                "raw_url": "https://github.com/apache/ignite/raw/c939bdba3a159d1ccb080686796b50a03ac77c9f/modules/ml/src/main/java/org/apache/ignite/ml/math/distributed/CacheUtils.java",
                "sha": "8c8bba79df6110a8382b19e18b3104b1931e8f17",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/c939bdba3a159d1ccb080686796b50a03ac77c9f/modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/CacheVectorTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/CacheVectorTest.java?ref=c939bdba3a159d1ccb080686796b50a03ac77c9f",
                "deletions": 8,
                "filename": "modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/CacheVectorTest.java",
                "patch": "@@ -143,19 +143,13 @@ public void testSum() {\n     }\n \n     /** */\n-    public void testSumNegative() {\n+    public void testSumEmptyVector() {\n         IgniteUtils.setCurrentIgniteName(ignite.configuration().getIgniteInstanceName());\n \n         IdentityValueMapper valMapper = new IdentityValueMapper();\n         CacheVector<Integer, Double> cacheVector = new CacheVector<>(size, getCache(), keyMapper, valMapper);\n \n-        try {\n-            double d = cacheVector.sum();\n-            fail();\n-        }\n-        catch (NullPointerException e) {\n-            // No-op.\n-        }\n+        cacheVector.sum();\n     }\n \n     /** */",
                "raw_url": "https://github.com/apache/ignite/raw/c939bdba3a159d1ccb080686796b50a03ac77c9f/modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/CacheVectorTest.java",
                "sha": "1008cc2cb0ed43d25947608a396dd2c25e907871",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/c939bdba3a159d1ccb080686796b50a03ac77c9f/modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/VectorToMatrixTest.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/VectorToMatrixTest.java?ref=c939bdba3a159d1ccb080686796b50a03ac77c9f",
                "deletions": 3,
                "filename": "modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/VectorToMatrixTest.java",
                "patch": "@@ -188,9 +188,6 @@ public void testCross() {\n \n     /** */\n     private void assertCross(Vector v1, Vector v2, String desc) {\n-        if (true) // TODO: IGNITE-5777, wait BLAS integration.\n-            return;\n-\n         assertNotNull(v1);\n         assertNotNull(v2);\n ",
                "raw_url": "https://github.com/apache/ignite/raw/c939bdba3a159d1ccb080686796b50a03ac77c9f/modules/ml/src/test/java/org/apache/ignite/ml/math/impls/vector/VectorToMatrixTest.java",
                "sha": "a003dcfd62a852bdcfa0baa4552564b4cbd5fb2b",
                "status": "modified"
            }
        ],
        "message": "IGNITE-6762: Fixed SparseDistributedMatrixExample failed with NPE.\nThis closes #3003",
        "parent": "https://github.com/apache/ignite/commit/8195ba512a7bff7b0e882ce01017724be8bbd8d7",
        "patched_files": [
            "CacheUtils.java",
            "CacheVector.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "VectorToMatrixTest.java",
            "CacheVectorTest.java"
        ]
    },
    "ignite_ca5c8d8": {
        "bug_id": "ignite_ca5c8d8",
        "commit": "https://github.com/apache/ignite/commit/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8",
        "file": [
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/ignite/blob/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "changes": 63,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java?ref=ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8",
                "deletions": 18,
                "filename": "modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "patch": "@@ -17,24 +17,33 @@\n \n package org.apache.ignite.internal.jdbc2;\n \n-import org.apache.ignite.*;\n-import org.apache.ignite.cache.affinity.*;\n-import org.apache.ignite.cache.query.annotations.*;\n-import org.apache.ignite.configuration.*;\n-import org.apache.ignite.internal.util.typedef.*;\n-import org.apache.ignite.spi.discovery.tcp.*;\n-import org.apache.ignite.spi.discovery.tcp.ipfinder.*;\n-import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.*;\n-import org.apache.ignite.testframework.junits.common.*;\n-\n-import java.io.*;\n-import java.sql.*;\n-import java.util.*;\n-\n-import static java.sql.Types.*;\n-import static org.apache.ignite.IgniteJdbcDriver.*;\n-import static org.apache.ignite.cache.CacheMode.*;\n-import static org.apache.ignite.cache.CacheWriteSynchronizationMode.*;\n+import java.io.Serializable;\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.DriverManager;\n+import java.sql.ResultSet;\n+import java.sql.ResultSetMetaData;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.affinity.AffinityKey;\n+import org.apache.ignite.cache.query.annotations.QuerySqlField;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.ConnectorConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.util.typedef.F;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+import static java.sql.Types.INTEGER;\n+import static java.sql.Types.OTHER;\n+import static java.sql.Types.VARCHAR;\n+import static org.apache.ignite.IgniteJdbcDriver.CFG_URL_PREFIX;\n+import static org.apache.ignite.cache.CacheMode.PARTITIONED;\n+import static org.apache.ignite.cache.CacheWriteSynchronizationMode.FULL_SYNC;\n \n /**\n  * Metadata tests.\n@@ -276,6 +285,24 @@ public void testGetColumns() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMetadataResultSetClose() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(BASE_URL);\n+             ResultSet tbls = conn.getMetaData().getTables(null, null, \"%\", null)) {\n+            int colCnt = tbls.getMetaData().getColumnCount();\n+\n+            while (tbls.next()) {\n+                for (int i = 0; i < colCnt; i++)\n+                    tbls.getObject(i + 1);\n+            }\n+        }\n+        catch (Exception e) {\n+            fail();\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8/modules/clients/src/test/java/org/apache/ignite/internal/jdbc2/JdbcMetadataSelfTest.java",
                "sha": "7184b8dea1a115cb5b56b615cbbfb7a474dbba72",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/ignite/blob/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java?ref=ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8",
                "deletions": 0,
                "filename": "modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "patch": "@@ -288,6 +288,24 @@ public void testGetColumns() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testMetadataResultSetClose() throws Exception {\n+        try (Connection conn = DriverManager.getConnection(URL);\n+             ResultSet tbls = conn.getMetaData().getTables(null, null, \"%\", null)) {\n+            int colCnt = tbls.getMetaData().getColumnCount();\n+\n+            while (tbls.next()) {\n+                for (int i = 0; i < colCnt; i++)\n+                    tbls.getObject(i + 1);\n+            }\n+        }\n+        catch (Exception e) {\n+            fail();\n+        }\n+    }\n+\n     /**\n      * Person.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8/modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcMetadataSelfTest.java",
                "sha": "72d93c97009cdeb481b20fb4b81c3bc1cdc216a8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java?ref=ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "patch": "@@ -182,7 +182,7 @@ else if (!finished) {\n      * If this result set is associated with locally executed query then query cursor will also closed.\n      */\n     void closeInternal() throws SQLException  {\n-        if (((JdbcConnection)stmt.getConnection()).nodeId() == null)\n+        if (((JdbcConnection)stmt.getConnection()).nodeId() == null && uuid != null)\n             JdbcQueryTask.remove(uuid);\n \n         closed = true;",
                "raw_url": "https://github.com/apache/ignite/raw/ca5c8d8051e5bfb9c17e34738e2a4555e2b8c3f8/modules/core/src/main/java/org/apache/ignite/internal/jdbc2/JdbcResultSet.java",
                "sha": "69dddad3ad27859354e40aef9e8a63b7c9bb8f33",
                "status": "modified"
            }
        ],
        "message": " IGNITE-3389 metadata result set throws NPE when closed - fixed",
        "parent": "https://github.com/apache/ignite/commit/68891e89dd0e0f19321d6a4d45ae7372279b8b08",
        "patched_files": [
            "JdbcResultSet.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "JdbcMetadataSelfTest.java"
        ]
    },
    "ignite_ce153e4": {
        "bug_id": "ignite_ce153e4",
        "commit": "https://github.com/apache/ignite/commit/ce153e4d76122d2c1f060018530e94fe443ff2bf",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/ignite/blob/ce153e4d76122d2c1f060018530e94fe443ff2bf/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java?ref=ce153e4d76122d2c1f060018530e94fe443ff2bf",
                "deletions": 8,
                "filename": "modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java",
                "patch": "@@ -87,17 +87,17 @@ public PojoMethodsCache(String clsName, Collection<CacheTypeFieldMetadata> field\n                         getters.put(field.getJavaName(), cls.getMethod(\"is\" + prop));\n                     }\n                     catch (NoSuchMethodException e) {\n-                        throw new CacheException(\"Failed to find getter in pojo class [class name: \" + clsName +\n-                            \", property: \" + field.getJavaName() + \"]\", e);\n+                        throw new CacheException(\"Failed to find getter in POJO class [class name=\" + clsName +\n+                            \", property=\" + field.getJavaName() + \"]\", e);\n                     }\n                 }\n \n                 try {\n                     setters.put(field.getJavaName(), cls.getMethod(\"set\" + prop, field.getJavaType()));\n                 }\n                 catch (NoSuchMethodException e) {\n-                    throw new CacheException(\"Failed to find setter in pojo class [class name: \" + clsName +\n-                        \", property: \" + field.getJavaName() + \"]\", e);\n+                    throw new CacheException(\"Failed to find setter in POJO class [class name=\" + clsName +\n+                        \", property=\" + field.getJavaName() + \"]\", e);\n                 }\n             }\n         }\n@@ -167,8 +167,8 @@ protected Object newInstance() throws CacheLoaderException {\n                 Method setter = mc.setters.get(field.getJavaName());\n \n                 if (setter == null)\n-                    throw new CacheLoaderException(\"Failed to find setter in pojo class [class name:\" + typeName +\n-                        \", property: \" + field.getJavaName() + \"]\");\n+                    throw new CacheLoaderException(\"Failed to find setter in POJO class [class name=\" + typeName +\n+                        \", property=\" + field.getJavaName() + \"]\");\n \n                 Integer colIdx = loadColIdxs.get(field.getDatabaseName());\n \n@@ -194,8 +194,8 @@ protected Object newInstance() throws CacheLoaderException {\n             Method getter = mc.getters.get(fieldName);\n \n             if (getter == null)\n-                throw new CacheLoaderException(\"Failed to find getter in pojo class [class name:\" + typeName +\n-                    \", property: \" + fieldName + \"]\");\n+                throw new CacheLoaderException(\"Failed to find getter in POJO class [class name=\" + typeName +\n+                    \", property=\" + fieldName + \"]\");\n \n             return getter.invoke(obj);\n         }",
                "raw_url": "https://github.com/apache/ignite/raw/ce153e4d76122d2c1f060018530e94fe443ff2bf/modules/core/src/main/java/org/apache/ignite/cache/store/jdbc/CacheJdbcPojoStore.java",
                "sha": "f2d6cae5c79bff27a9987faba4aa10b17a846054",
                "status": "modified"
            }
        ],
        "message": "# ignite-281 Fixed npe CacheJdbcPojoStore.",
        "parent": "https://github.com/apache/ignite/commit/65a852be839581099688593dabae75490798f1b2",
        "patched_files": [
            "CacheJdbcPojoStore.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "CacheJdbcPojoStoreTest.java"
        ]
    },
    "ignite_ced5d27": {
        "bug_id": "ignite_ced5d27",
        "commit": "https://github.com/apache/ignite/commit/ced5d2768d47504533064000c8ce525d80613ca3",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/ignite/blob/ced5d2768d47504533064000c8ce525d80613ca3/modules/clients/src/test/java/org/apache/ignite/internal/processors/rest/JettyRestProcessorAbstractSelfTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/clients/src/test/java/org/apache/ignite/internal/processors/rest/JettyRestProcessorAbstractSelfTest.java?ref=ced5d2768d47504533064000c8ce525d80613ca3",
                "deletions": 3,
                "filename": "modules/clients/src/test/java/org/apache/ignite/internal/processors/rest/JettyRestProcessorAbstractSelfTest.java",
                "patch": "@@ -985,9 +985,11 @@ private void failIgnite_5874() {\n         if (dsCfg.getDefaultDataRegionConfiguration().isPersistenceEnabled())\n             fail(\"IGNITE-5874\");\n \n-        for (DataRegionConfiguration dataRegCfg : dsCfg.getDataRegionConfigurations()) {\n-            if (dataRegCfg.isPersistenceEnabled())\n-                fail(\"IGNITE-5874\");\n+        if (!F.isEmpty(dsCfg.getDataRegionConfigurations())) {\n+            for (DataRegionConfiguration dataRegCfg : dsCfg.getDataRegionConfigurations()) {\n+                if (dataRegCfg.isPersistenceEnabled())\n+                    fail(\"IGNITE-5874\");\n+            }\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/ced5d2768d47504533064000c8ce525d80613ca3/modules/clients/src/test/java/org/apache/ignite/internal/processors/rest/JettyRestProcessorAbstractSelfTest.java",
                "sha": "0285f3af530ed32cfb8b4e4b62691ab210c73076",
                "status": "modified"
            }
        ],
        "message": "IGNITE-8201 Fixed NPE",
        "parent": "https://github.com/apache/ignite/commit/69606e4248a69d44f798c9f59865281c19744a69",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "JettyRestProcessorAbstractSelfTest.java"
        ]
    },
    "ignite_d0e6def": {
        "bug_id": "ignite_d0e6def",
        "commit": "https://github.com/apache/ignite/commit/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75/modules/ml/src/main/java/org/apache/ignite/ml/dataset/impl/cache/CacheBasedDataset.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ml/src/main/java/org/apache/ignite/ml/dataset/impl/cache/CacheBasedDataset.java?ref=d0e6def704f2d1646f9bf5b4b9a19243f6d48f75",
                "deletions": 1,
                "filename": "modules/ml/src/main/java/org/apache/ignite/ml/dataset/impl/cache/CacheBasedDataset.java",
                "patch": "@@ -163,7 +163,8 @@ public CacheBasedDataset(Ignite ignite, IgniteCache<K, V> upstreamCache, IgniteB\n \n         R res = identity;\n         for (R partRes : results)\n-            res = reduce.apply(res, partRes);\n+            if (partRes != null)\n+                res = reduce.apply(res, partRes);\n \n         return res;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75/modules/ml/src/main/java/org/apache/ignite/ml/dataset/impl/cache/CacheBasedDataset.java",
                "sha": "67e0d56fb0e05b39610c6a84b60a1a66fd2d7312",
                "status": "modified"
            },
            {
                "additions": 102,
                "blob_url": "https://github.com/apache/ignite/blob/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75/modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMBinaryTrainerIntegrationTest.java",
                "changes": 102,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMBinaryTrainerIntegrationTest.java?ref=d0e6def704f2d1646f9bf5b4b9a19243f6d48f75",
                "deletions": 0,
                "filename": "modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMBinaryTrainerIntegrationTest.java",
                "patch": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.ml.svm;\n+\n+import java.util.Arrays;\n+import java.util.UUID;\n+import java.util.concurrent.ThreadLocalRandom;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.internal.util.IgniteUtils;\n+import org.apache.ignite.ml.TestUtils;\n+import org.apache.ignite.ml.math.primitives.vector.VectorUtils;\n+import org.apache.ignite.ml.math.primitives.vector.impl.DenseVector;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ * Tests for {@link SVMLinearBinaryClassificationTrainer} that require to start the whole Ignite infrastructure.\n+ */\n+public class SVMBinaryTrainerIntegrationTest extends GridCommonAbstractTest {\n+    /** Fixed size of Dataset. */\n+    private static final int AMOUNT_OF_OBSERVATIONS = 1000;\n+\n+    /** Fixed size of columns in Dataset. */\n+    private static final int AMOUNT_OF_FEATURES = 2;\n+\n+    /** Precision in test checks. */\n+    private static final double PRECISION = 1e-2;\n+\n+    /** Number of nodes in grid */\n+    private static final int NODE_COUNT = 3;\n+\n+    /** Ignite instance. */\n+    private Ignite ignite;\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        for (int i = 1; i <= NODE_COUNT; i++)\n+            startGrid(i);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() {\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override protected void beforeTest() throws Exception {\n+        /* Grid instance. */\n+        ignite = grid(NODE_COUNT);\n+        ignite.configuration().setPeerClassLoadingEnabled(true);\n+        IgniteUtils.setCurrentIgniteName(ignite.configuration().getIgniteInstanceName());\n+    }\n+\n+    /**\n+     * Test trainer on classification model y = x.\n+     */\n+    public void testTrainWithTheLinearlySeparableCase() {\n+        IgniteCache<Integer, double[]> data = ignite.getOrCreateCache(UUID.randomUUID().toString());\n+\n+        ThreadLocalRandom rndX = ThreadLocalRandom.current();\n+        ThreadLocalRandom rndY = ThreadLocalRandom.current();\n+\n+        for (int i = 0; i < AMOUNT_OF_OBSERVATIONS; i++) {\n+            double x = rndX.nextDouble(-1000, 1000);\n+            double y = rndY.nextDouble(-1000, 1000);\n+            double[] vec = new double[AMOUNT_OF_FEATURES + 1];\n+            vec[0] = y - x > 0 ? 1 : -1; // assign label.\n+            vec[1] = x;\n+            vec[2] = y;\n+            data.put(i, vec);\n+        }\n+\n+        SVMLinearBinaryClassificationTrainer trainer = new SVMLinearBinaryClassificationTrainer();\n+\n+        SVMLinearBinaryClassificationModel mdl = trainer.fit(\n+            ignite,\n+            data,\n+            (k, v) -> VectorUtils.of(Arrays.copyOfRange(v, 1, v.length)),\n+            (k, v) -> v[0]\n+        );\n+\n+        TestUtils.assertEquals(-1, mdl.apply(new DenseVector(new double[]{100, 10})), PRECISION);\n+        TestUtils.assertEquals(1, mdl.apply(new DenseVector(new double[]{10, 100})), PRECISION);\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75/modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMBinaryTrainerIntegrationTest.java",
                "sha": "d227de7e329e07ae1f498fab11888908b7528325",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75/modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMTestSuite.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMTestSuite.java?ref=d0e6def704f2d1646f9bf5b4b9a19243f6d48f75",
                "deletions": 1,
                "filename": "modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMTestSuite.java",
                "patch": "@@ -27,7 +27,8 @@\n @Suite.SuiteClasses({\n     SVMModelTest.class,\n     SVMBinaryTrainerTest.class,\n-    SVMMultiClassTrainerTest.class\n+    SVMMultiClassTrainerTest.class,\n+    SVMBinaryTrainerIntegrationTest.class\n })\n public class SVMTestSuite {\n     // No-op.",
                "raw_url": "https://github.com/apache/ignite/raw/d0e6def704f2d1646f9bf5b4b9a19243f6d48f75/modules/ml/src/test/java/org/apache/ignite/ml/svm/SVMTestSuite.java",
                "sha": "822ad184ea929405ed01cd8fa7ddc8ce79925d71",
                "status": "modified"
            }
        ],
        "message": "IGNITE-9055: [ML] SVM throws NPE in case of empty partitions\n\nthis closes #4412",
        "parent": "https://github.com/apache/ignite/commit/13e2a314b72d9155ce7f0126651805064e20358c",
        "patched_files": [
            "SVMTestSuite.java",
            "CacheBasedDataset.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "CacheBasedDatasetTest.java",
            "SVMBinaryTrainerIntegrationTest.java"
        ]
    },
    "ignite_d20e43f": {
        "bug_id": "ignite_d20e43f",
        "commit": "https://github.com/apache/ignite/commit/d20e43fc5f99893ff25f329f144d2cf14c9f5990",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/d20e43fc5f99893ff25f329f144d2cf14c9f5990/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java?ref=d20e43fc5f99893ff25f329f144d2cf14c9f5990",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java",
                "patch": "@@ -71,6 +71,9 @@ protected boolean needCopy(CacheObjectContext ctx) {\n \n     /** {@inheritDoc} */\n     @Override public boolean putValue(ByteBuffer buf, CacheObjectContext ctx) throws IgniteCheckedException {\n+        if (valBytes == null)\n+            valueBytes(ctx);\n+\n         if (buf.remaining() < valBytes.length + 5)\n             return false;\n ",
                "raw_url": "https://github.com/apache/ignite/raw/d20e43fc5f99893ff25f329f144d2cf14c9f5990/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheObjectAdapter.java",
                "sha": "28a95d8dcfece496de5d483d62607809abf243bf",
                "status": "modified"
            },
            {
                "additions": 177,
                "blob_url": "https://github.com/apache/ignite/blob/d20e43fc5f99893ff25f329f144d2cf14c9f5990/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java",
                "changes": 177,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java?ref=d20e43fc5f99893ff25f329f144d2cf14c9f5990",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java",
                "patch": "@@ -0,0 +1,177 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache;\n+\n+import java.io.Serializable;\n+import java.nio.ByteBuffer;\n+import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.processors.cacheobject.IgniteCacheObjectProcessor;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+\n+/**\n+ *\n+ */\n+public class IgniteCacheObjectPutSelfTest extends GridCommonAbstractTest {\n+    /** */\n+    public static final String CACHE_NAME = \"partitioned\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String gridName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(gridName);\n+\n+        CacheConfiguration ccfg = new CacheConfiguration();\n+\n+        ccfg.setName(CACHE_NAME);\n+\n+        cfg.setCacheConfiguration(ccfg);\n+\n+        cfg.setMarshaller(null);\n+\n+        return cfg;\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void beforeTestsStarted() throws Exception {\n+        super.beforeTestsStarted();\n+\n+        startGrid(0);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTestsStopped() throws Exception {\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testPrimitiveValues() throws Exception {\n+        IgniteEx ignite = grid(0);\n+\n+        IgniteCache<Object, Object> cache = ignite.cache(CACHE_NAME);\n+\n+        for (int i = 0; i < 10; i++)\n+            cache.put(i, String.valueOf(i));\n+\n+        IgniteCacheObjectProcessor co = ignite.context().cacheObjects();\n+        GridCacheAdapter<Object, Object> iCache = ignite.context().cache().internalCache(CACHE_NAME);\n+        CacheObjectContext coCtx = iCache.context().cacheObjectContext();\n+\n+        ByteBuffer buf = ByteBuffer.allocate(2048);\n+\n+        for (int i = 0; i < 10; i++) {\n+            KeyCacheObject key = co.toCacheKeyObject(coCtx, i, false);\n+\n+            GridCacheEntryEx entry = iCache.peekEx(key);\n+\n+            assertNotNull(entry);\n+\n+            assertTrue(entry.key().putValue(buf, coCtx));\n+            assertTrue(entry.valueBytes().putValue(buf, coCtx));\n+        }\n+\n+        buf.flip();\n+\n+        for (int i = 0; i < 10; i++) {\n+            CacheObject co1 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(i, co1.value(coCtx, false));\n+\n+            CacheObject co2 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(String.valueOf(i), co2.value(coCtx, false));\n+        }\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    public void testClassValues() throws Exception {\n+        IgniteEx ignite = grid(0);\n+\n+        IgniteCache<Object, Object> cache = ignite.cache(CACHE_NAME);\n+\n+        for (int i = 0; i < 10; i++)\n+            cache.put(new TestValue(i), new TestValue(i));\n+\n+        IgniteCacheObjectProcessor co = ignite.context().cacheObjects();\n+        GridCacheAdapter<Object, Object> iCache = ignite.context().cache().internalCache(CACHE_NAME);\n+        CacheObjectContext coCtx = iCache.context().cacheObjectContext();\n+\n+        ByteBuffer buf = ByteBuffer.allocate(2048);\n+\n+        for (int i = 0; i < 10; i++) {\n+            KeyCacheObject key = co.toCacheKeyObject(coCtx, new TestValue(i), false);\n+\n+            GridCacheEntryEx entry = iCache.peekEx(key);\n+\n+            assertNotNull(entry);\n+\n+            assertTrue(entry.key().putValue(buf, coCtx));\n+            assertTrue(entry.valueBytes().putValue(buf, coCtx));\n+        }\n+\n+        buf.flip();\n+\n+        for (int i = 0; i < 10; i++) {\n+            CacheObject co1 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(new TestValue(i), co1.value(coCtx, false));\n+\n+            CacheObject co2 = co.toCacheObject(coCtx, buf);\n+\n+            assertEquals(new TestValue(i), co2.value(coCtx, false));\n+        }\n+    }\n+\n+    /**\n+     *\n+     */\n+    private static class TestValue implements Serializable {\n+        /** */\n+        private int val;\n+\n+        /**\n+         * @param val Value.\n+         */\n+        private TestValue(int val) {\n+            this.val = val;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public boolean equals(Object o) {\n+            if (this == o)\n+                return true;\n+\n+            if (!(o instanceof TestValue))\n+                return false;\n+\n+            TestValue value = (TestValue)o;\n+\n+            return val == value.val;\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public int hashCode() {\n+            return val;\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/d20e43fc5f99893ff25f329f144d2cf14c9f5990/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheObjectPutSelfTest.java",
                "sha": "2dc18f5ad9c3e8a26bb7a24a89498bee309e6993",
                "status": "added"
            }
        ],
        "message": "Added test, fixed NPE",
        "parent": "https://github.com/apache/ignite/commit/2476bb1c8605dc30b4028784c47e3eba041a087d",
        "patched_files": [
            "CacheObjectAdapter.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteCacheObjectPutSelfTest.java"
        ]
    },
    "ignite_d31a476": {
        "bug_id": "ignite_d31a476",
        "commit": "https://github.com/apache/ignite/commit/d31a47696079755189f3f3f990e7341740240aa4",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/ignite/blob/d31a47696079755189f3f3f990e7341740240aa4/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java?ref=d31a47696079755189f3f3f990e7341740240aa4",
                "deletions": 8,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java",
                "patch": "@@ -220,16 +220,18 @@ void initStoreStrategy() throws IgniteCheckedException {\n     protected CacheConfiguration cacheConfiguration(String gridName) throws Exception {\n         CacheConfiguration cfg = defaultCacheConfiguration();\n \n-        Factory<? extends CacheStore<Object, Object>> storeFactory = storeStgy.getStoreFactory();\n+        if (storeStgy != null) {\n+            Factory<? extends CacheStore<Object, Object>> storeFactory = storeStgy.getStoreFactory();\n \n-        CacheStore<?, ?> store = storeFactory.create();\n+            CacheStore<?, ?> store = storeFactory.create();\n \n-        if (store != null) {\n-            cfg.setCacheStoreFactory(storeFactory);\n-            cfg.setReadThrough(true);\n-            cfg.setWriteThrough(true);\n-            cfg.setLoadPreviousValue(true);\n-            storeStgy.updateCacheConfiguration(cfg);\n+            if (store != null) {\n+                cfg.setCacheStoreFactory(storeFactory);\n+                cfg.setReadThrough(true);\n+                cfg.setWriteThrough(true);\n+                cfg.setLoadPreviousValue(true);\n+                storeStgy.updateCacheConfiguration(cfg);\n+            }\n         }\n \n         cfg.setSwapEnabled(swapEnabled());",
                "raw_url": "https://github.com/apache/ignite/raw/d31a47696079755189f3f3f990e7341740240aa4/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractSelfTest.java",
                "sha": "d58e560fed72442cad2cf1e2b3b6892c53a42f50",
                "status": "modified"
            }
        ],
        "message": "ignite-1088 Implemented store for multi jvm tests (fixed NPE)",
        "parent": "https://github.com/apache/ignite/commit/8e09f12a535c97b416de25f627bdc1992810f6df",
        "patched_files": [],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheAbstractSelfTest.java"
        ]
    },
    "ignite_d7af985": {
        "bug_id": "ignite_d7af985",
        "commit": "https://github.com/apache/ignite/commit/d7af985383d9e82608fd77904415960492ed6290",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/commandline/CommandHandler.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/commandline/CommandHandler.java?ref=d7af985383d9e82608fd77904415960492ed6290",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/commandline/CommandHandler.java",
                "patch": "@@ -855,7 +855,7 @@ private void cacheContention(GridClient client, CacheArguments cacheArgs) throws\n             log(\"Contention check failed on nodes:\");\n \n             for (Map.Entry<UUID, Exception> e : res.exceptions().entrySet()) {\n-                log(\"Node ID = \" + e.getKey());\n+                log(\"Node ID: \" + e.getKey());\n \n                 log(\"Exception message:\");\n                 log(e.getValue().getMessage());\n@@ -890,7 +890,7 @@ private void cacheValidateIndexes(GridClient client, CacheArguments cacheArgs) t\n             log(\"Index validation failed on nodes:\");\n \n             for (Map.Entry<UUID, Exception> e : taskRes.exceptions().entrySet()) {\n-                log(i(\"Node ID = \" + e.getKey()));\n+                log(i(\"Node ID: \" + e.getKey()));\n \n                 log(i(\"Exception message:\"));\n                 log(i(e.getValue().getMessage(), 2));",
                "raw_url": "https://github.com/apache/ignite/raw/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/commandline/CommandHandler.java",
                "sha": "8dcceed65e50361df415595621bf9cfde4813a89",
                "status": "modified"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/ignite/blob/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/IdleVerifyResultV2.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/IdleVerifyResultV2.java?ref=d7af985383d9e82608fd77904415960492ed6290",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/IdleVerifyResultV2.java",
                "patch": "@@ -21,6 +21,7 @@\n import java.io.ObjectOutput;\n import java.util.List;\n import java.util.Map;\n+import java.util.UUID;\n import java.util.function.Consumer;\n import org.apache.ignite.internal.util.typedef.F;\n import org.apache.ignite.internal.util.typedef.internal.S;\n@@ -43,6 +44,9 @@\n     /** Moving partitions. */\n     private Map<PartitionKeyV2, List<PartitionHashRecordV2>> movingPartitions;\n \n+    /** Exceptions. */\n+    private Map<UUID, Exception> exceptions;\n+\n     /**\n      * @param cntrConflicts Counter conflicts.\n      * @param hashConflicts Hash conflicts.\n@@ -51,11 +55,13 @@\n     public IdleVerifyResultV2(\n         Map<PartitionKeyV2, List<PartitionHashRecordV2>> cntrConflicts,\n         Map<PartitionKeyV2, List<PartitionHashRecordV2>> hashConflicts,\n-        Map<PartitionKeyV2, List<PartitionHashRecordV2>> movingPartitions\n+        Map<PartitionKeyV2, List<PartitionHashRecordV2>> movingPartitions,\n+        Map<UUID, Exception> exceptions\n     ) {\n         this.cntrConflicts = cntrConflicts;\n         this.hashConflicts = hashConflicts;\n         this.movingPartitions = movingPartitions;\n+        this.exceptions = exceptions;\n     }\n \n     /**\n@@ -64,11 +70,17 @@ public IdleVerifyResultV2(\n     public IdleVerifyResultV2() {\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public byte getProtocolVersion() {\n+        return V2;\n+    }\n+\n     /** {@inheritDoc} */\n     @Override protected void writeExternalData(ObjectOutput out) throws IOException {\n         U.writeMap(out, cntrConflicts);\n         U.writeMap(out, hashConflicts);\n         U.writeMap(out, movingPartitions);\n+        U.writeMap(out, exceptions);\n     }\n \n     /** {@inheritDoc} */\n@@ -77,6 +89,9 @@ public IdleVerifyResultV2() {\n         cntrConflicts = U.readMap(in);\n         hashConflicts = U.readMap(in);\n         movingPartitions = U.readMap(in);\n+\n+        if (protoVer >= V2)\n+            exceptions = U.readMap(in);\n     }\n \n     /**\n@@ -107,6 +122,13 @@ public boolean hasConflicts() {\n         return !F.isEmpty(hashConflicts()) || !F.isEmpty(counterConflicts());\n     }\n \n+    /**\n+     * @return Exceptions on nodes.\n+     */\n+    public Map<UUID, Exception> exceptions() {\n+        return exceptions;\n+    }\n+\n     /**\n      * Print formatted result to given printer.\n      *\n@@ -159,6 +181,16 @@ public void print(Consumer<String> printer) {\n \n             printer.accept(\"\\n\");\n         }\n+\n+        if (!F.isEmpty(exceptions())) {\n+            printer.accept(\"Idle verify failed on nodes:\\n\");\n+\n+            for (Map.Entry<UUID, Exception> e : exceptions().entrySet()) {\n+                printer.accept(\"Node ID: \" + e.getKey() + \"\\n\");\n+                printer.accept(\"Exception message:\" + \"\\n\");\n+                printer.accept(e.getValue().getMessage() + \"\\n\");\n+            }\n+        }\n     }\n \n     /** {@inheritDoc} */",
                "raw_url": "https://github.com/apache/ignite/raw/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/IdleVerifyResultV2.java",
                "sha": "a153063d8998a039b0bba98e0f66057c1a26371d",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/ignite/blob/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsDumpTask.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsDumpTask.java?ref=d7af985383d9e82608fd77904415960492ed6290",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsDumpTask.java",
                "patch": "@@ -30,15 +30,18 @@\n import java.util.TreeMap;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteException;\n+import org.apache.ignite.IgniteLogger;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.compute.ComputeJob;\n import org.apache.ignite.compute.ComputeJobResult;\n+import org.apache.ignite.compute.ComputeJobResultPolicy;\n import org.apache.ignite.compute.ComputeTaskAdapter;\n import org.apache.ignite.internal.processors.task.GridInternal;\n import org.apache.ignite.internal.util.typedef.F;\n import org.apache.ignite.internal.visor.verify.VisorIdleVerifyDumpTaskArg;\n import org.apache.ignite.internal.visor.verify.VisorIdleVerifyTaskArg;\n import org.apache.ignite.resources.IgniteInstanceResource;\n+import org.apache.ignite.resources.LoggerResource;\n import org.jetbrains.annotations.NotNull;\n import org.jetbrains.annotations.Nullable;\n \n@@ -68,6 +71,10 @@\n     @IgniteInstanceResource\n     private Ignite ignite;\n \n+    /** Injected logger. */\n+    @LoggerResource\n+    private IgniteLogger log;\n+\n     /** {@inheritDoc} */\n     @Nullable @Override public Map<? extends ComputeJob, ClusterNode> map(\n         List<ClusterNode> subgrid, VisorIdleVerifyTaskArg arg) throws IgniteException {\n@@ -83,6 +90,9 @@\n         Map<PartitionKeyV2, List<PartitionHashRecordV2>> clusterHashes = new TreeMap<>(buildPartitionKeyComparator());\n \n         for (ComputeJobResult res : results) {\n+            if (res.getException() != null)\n+                continue;\n+\n             Map<PartitionKeyV2, PartitionHashRecordV2> nodeHashes = res.getData();\n \n             for (Map.Entry<PartitionKeyV2, PartitionHashRecordV2> e : nodeHashes.entrySet()) {\n@@ -111,6 +121,22 @@\n         return writeHashes(partitions, delegate.reduce(results), skippedRecords);\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public ComputeJobResultPolicy result(ComputeJobResult res, List<ComputeJobResult> rcvd) throws\n+        IgniteException {\n+        ComputeJobResultPolicy superRes = super.result(res, rcvd);\n+\n+        // Deny failover.\n+        if (superRes == ComputeJobResultPolicy.FAILOVER) {\n+            superRes = ComputeJobResultPolicy.WAIT;\n+\n+            log.warning(\"VerifyBackupPartitionsJobV2 failed on node \" +\n+                \"[consistentId=\" + res.getNode().consistentId() + \"]\", res.getException());\n+        }\n+\n+        return superRes;\n+    }\n+\n     /**\n      * Checking conditions for adding given record to result.\n      *\n@@ -140,6 +166,8 @@ private boolean needToAdd(List<PartitionHashRecordV2> records) {\n \n     /**\n      * @param partitions Dump result.\n+     * @param conflictRes Conflict results.\n+     * @param skippedRecords Number of empty partitions.\n      * @return Path where results are written.\n      * @throws IgniteException If failed to write the file.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsDumpTask.java",
                "sha": "5945f4d0990b139be96b717b5697822cde3b08a3",
                "status": "modified"
            },
            {
                "additions": 30,
                "blob_url": "https://github.com/apache/ignite/blob/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsTaskV2.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsTaskV2.java?ref=d7af985383d9e82608fd77904415960492ed6290",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsTaskV2.java",
                "patch": "@@ -25,6 +25,7 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.UUID;\n import java.util.concurrent.Callable;\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.ForkJoinPool;\n@@ -41,6 +42,7 @@\n import org.apache.ignite.compute.ComputeJob;\n import org.apache.ignite.compute.ComputeJobAdapter;\n import org.apache.ignite.compute.ComputeJobResult;\n+import org.apache.ignite.compute.ComputeJobResultPolicy;\n import org.apache.ignite.compute.ComputeTaskAdapter;\n import org.apache.ignite.configuration.CacheConfiguration;\n import org.apache.ignite.configuration.DataStorageConfiguration;\n@@ -77,6 +79,10 @@\n     /** First version of Ignite that is capable of executing Idle Verify V2. */\n     public static final IgniteProductVersion V2_SINCE_VER = IgniteProductVersion.fromString(\"2.5.3\");\n \n+    /** Injected logger. */\n+    @LoggerResource\n+    private IgniteLogger log;\n+\n     /** */\n     private static final long serialVersionUID = 0L;\n \n@@ -95,8 +101,15 @@\n     @Nullable @Override public IdleVerifyResultV2 reduce(List<ComputeJobResult> results)\n         throws IgniteException {\n         Map<PartitionKeyV2, List<PartitionHashRecordV2>> clusterHashes = new HashMap<>();\n+        Map<UUID, Exception> exceptions = new HashMap<>();\n \n         for (ComputeJobResult res : results) {\n+            if (res.getException() != null) {\n+                exceptions.put(res.getNode().id(), res.getException());\n+\n+                continue;\n+            }\n+\n             Map<PartitionKeyV2, PartitionHashRecordV2> nodeHashes = res.getData();\n \n             for (Map.Entry<PartitionKeyV2, PartitionHashRecordV2> e : nodeHashes.entrySet()) {\n@@ -141,7 +154,23 @@\n             }\n         }\n \n-        return new IdleVerifyResultV2(updateCntrConflicts, hashConflicts, movingParts);\n+        return new IdleVerifyResultV2(updateCntrConflicts, hashConflicts, movingParts, exceptions);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public ComputeJobResultPolicy result(ComputeJobResult res, List<ComputeJobResult> rcvd) throws\n+        IgniteException {\n+        ComputeJobResultPolicy superRes = super.result(res, rcvd);\n+\n+        // Deny failover.\n+        if (superRes == ComputeJobResultPolicy.FAILOVER) {\n+            superRes = ComputeJobResultPolicy.WAIT;\n+\n+            log.warning(\"VerifyBackupPartitionsJobV2 failed on node \" +\n+                \"[consistentId=\" + res.getNode().consistentId() + \"]\", res.getException());\n+        }\n+\n+        return superRes;\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/ignite/raw/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/verify/VerifyBackupPartitionsTaskV2.java",
                "sha": "5e872eb7c61216e8e33a3b53490ec798982f1b8e",
                "status": "modified"
            },
            {
                "additions": 144,
                "blob_url": "https://github.com/apache/ignite/blob/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "changes": 214,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java?ref=d7af985383d9e82608fd77904415960492ed6290",
                "deletions": 70,
                "filename": "modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "patch": "@@ -32,6 +32,7 @@\n import java.util.List;\n import java.util.Map;\n import java.util.TreeMap;\n+import java.util.UUID;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.ExecutorService;\n import java.util.concurrent.Executors;\n@@ -47,6 +48,7 @@\n import org.apache.ignite.IgniteAtomicSequence;\n import org.apache.ignite.IgniteCache;\n import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.IgniteDataStreamer;\n import org.apache.ignite.cache.affinity.rendezvous.RendezvousAffinityFunction;\n import org.apache.ignite.cluster.ClusterNode;\n import org.apache.ignite.configuration.AtomicConfiguration;\n@@ -56,6 +58,7 @@\n import org.apache.ignite.configuration.DataStorageConfiguration;\n import org.apache.ignite.configuration.IgniteConfiguration;\n import org.apache.ignite.configuration.WALMode;\n+import org.apache.ignite.internal.GridJobExecuteResponse;\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.IgniteInternalFuture;\n import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n@@ -922,13 +925,7 @@ public void testCacheIdleVerify() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, 32))\n-            .setBackups(1)\n-            .setName(DEFAULT_CACHE_NAME));\n-\n-        for (int i = 0; i < 100; i++)\n-            cache.put(i, i);\n+        createCacheAndPreload(ignite, 100);\n \n         injectTestSystemOut();\n \n@@ -956,15 +953,7 @@ public void testCacheIdleVerifyTwoConflictTypes() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        int parts = 32;\n-\n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, parts))\n-            .setBackups(1)\n-            .setName(DEFAULT_CACHE_NAME));\n-\n-        for (int i = 0; i < 100; i++)\n-            cache.put(i, i);\n+        createCacheAndPreload(ignite, 100);\n \n         injectTestSystemOut();\n \n@@ -976,7 +965,7 @@ public void testCacheIdleVerifyTwoConflictTypes() throws Exception {\n \n         corruptDataEntry(cacheCtx, 1, true, false);\n \n-        corruptDataEntry(cacheCtx, 1 + parts / 2, false, true);\n+        corruptDataEntry(cacheCtx, 1 + cacheCtx.config().getAffinity().partitions() / 2, false, true);\n \n         assertEquals(EXIT_CODE_OK, execute(\"--cache\", \"idle_verify\"));\n \n@@ -994,12 +983,11 @@ public void testCacheIdleVerifyDump() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        int parts = 32;\n+        int keysCount = 20;//less than parts number for ability to check skipZeros flag.\n \n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, parts))\n-            .setBackups(1)\n-            .setName(DEFAULT_CACHE_NAME));\n+        createCacheAndPreload(ignite, keysCount);\n+\n+        int parts = ignite.affinity(DEFAULT_CACHE_NAME).partitions();\n \n         ignite.createCache(new CacheConfiguration<>()\n             .setAffinity(new RendezvousAffinityFunction(false, parts))\n@@ -1008,11 +996,6 @@ public void testCacheIdleVerifyDump() throws Exception {\n \n         injectTestSystemOut();\n \n-        int keysCount = 20;//less than parts number for ability to check skipZeros flag.\n-\n-        for (int i = 0; i < keysCount; i++)\n-            cache.put(i, i);\n-\n         assertEquals(EXIT_CODE_OK, execute(\"--cache\", \"idle_verify\", \"--dump\", DEFAULT_CACHE_NAME));\n \n         assertEquals(EXIT_CODE_OK, execute(\"--cache\", \"idle_verify\", \"--dump\", \"--skipZeros\", DEFAULT_CACHE_NAME));\n@@ -1081,31 +1064,25 @@ public void testCacheIdleVerifyDumpForCorruptedData() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        int parts = 32;\n-\n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, parts))\n-            .setBackups(1)\n-            .setName(DEFAULT_CACHE_NAME));\n+        createCacheAndPreload(ignite, 100);\n \n-        for (int i = 0; i < 100; i++)\n-            cache.put(i, i);\n+        injectTestSystemOut();\n \n-        corruptingAndCheckDefaultCache(ignite, parts, CacheFilterEnum.ALL);\n+        corruptingAndCheckDefaultCache(ignite, CacheFilterEnum.ALL);\n     }\n \n     /**\n      * @param ignite Ignite.\n-     * @param parts Parts.\n+     * @param cacheFilterEnum Filter enum.\n      */\n-    private void corruptingAndCheckDefaultCache(IgniteEx ignite, int parts, CacheFilterEnum cacheFilterEnum) throws IOException {\n+    private void corruptingAndCheckDefaultCache(IgniteEx ignite, CacheFilterEnum cacheFilterEnum) throws IOException {\n         injectTestSystemOut();\n \n         GridCacheContext<Object, Object> cacheCtx = ignite.cachex(DEFAULT_CACHE_NAME).context();\n \n         corruptDataEntry(cacheCtx, 0, true, false);\n \n-        corruptDataEntry(cacheCtx, parts / 2, false, true);\n+        corruptDataEntry(cacheCtx, cacheCtx.config().getAffinity().partitions() / 2, false, true);\n \n         assertEquals(EXIT_CODE_OK, execute(\"--cache\", \"idle_verify\", \"--dump\", \"--cacheFilter\", cacheFilterEnum.toString()));\n \n@@ -1120,6 +1097,130 @@ private void corruptingAndCheckDefaultCache(IgniteEx ignite, int parts, CacheFil\n             fail(\"Should be found dump with conflicts\");\n     }\n \n+    /**\n+     * Tests that idle verify print partitions info when node failing.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testCacheIdleVerifyDumpWhenNodeFailing() throws Exception {\n+        Ignite ignite = startGrids(3);\n+\n+        Ignite unstable = startGrid(\"unstable\");\n+\n+        ignite.cluster().active(true);\n+\n+        createCacheAndPreload(ignite, 100);\n+\n+        for (int i = 0; i < 3; i++) {\n+            TestRecordingCommunicationSpi.spi(unstable).blockMessages(GridJobExecuteResponse.class,\n+                getTestIgniteInstanceName(i));\n+        }\n+\n+        injectTestSystemOut();\n+\n+        IgniteInternalFuture fut = GridTestUtils.runAsync(() -> {\n+            assertEquals(EXIT_CODE_OK, execute(\"--cache\", \"idle_verify\", \"--dump\"));\n+        });\n+\n+        TestRecordingCommunicationSpi.spi(unstable).waitForBlocked();\n+\n+        UUID unstableNodeId = unstable.cluster().localNode().id();\n+\n+        unstable.close();\n+\n+        fut.get();\n+\n+        checkExceptionMessageOnReport(unstableNodeId);\n+    }\n+\n+    /**\n+     * Tests that idle verify print partitions info when several nodes failing at same time.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testCacheIdleVerifyDumpWhenSeveralNodesFailing() throws Exception {\n+        int nodes = 6;\n+\n+        Ignite ignite = startGrids(nodes);\n+\n+        List<Ignite> unstableNodes = new ArrayList<>(nodes / 2);\n+\n+        for (int i = 0; i < nodes; i++) {\n+            if (i % 2 == 1)\n+                unstableNodes.add(ignite(i));\n+        }\n+\n+        ignite.cluster().active(true);\n+\n+        createCacheAndPreload(ignite, 100);\n+\n+        for (Ignite unstable : unstableNodes) {\n+            for (int i = 0; i < nodes; i++) {\n+                TestRecordingCommunicationSpi.spi(unstable).blockMessages(GridJobExecuteResponse.class,\n+                    getTestIgniteInstanceName(i));\n+            }\n+        }\n+\n+        injectTestSystemOut();\n+\n+        IgniteInternalFuture fut = GridTestUtils.runAsync(() -> {\n+            assertEquals(EXIT_CODE_OK, execute(\"--cache\", \"idle_verify\", \"--dump\"));\n+        });\n+\n+        List<UUID> unstableNodeIds = new ArrayList<>(nodes / 2);\n+\n+        for (Ignite unstable : unstableNodes) {\n+            TestRecordingCommunicationSpi.spi(unstable).waitForBlocked();\n+\n+            unstableNodeIds.add(unstable.cluster().localNode().id());\n+\n+            unstable.close();\n+        }\n+\n+        fut.get();\n+\n+        for (UUID unstableId : unstableNodeIds)\n+            checkExceptionMessageOnReport(unstableId);\n+    }\n+\n+    /**\n+     * Creates default cache and preload some data entries.\n+     *\n+     * @param ignite Ignite.\n+     * @param countEntries Count of entries.\n+     */\n+    private void createCacheAndPreload(Ignite ignite, int countEntries) {\n+        ignite.createCache(new CacheConfiguration<>(DEFAULT_CACHE_NAME)\n+            .setAffinity(new RendezvousAffinityFunction(false, 32))\n+            .setBackups(1));\n+\n+        try (IgniteDataStreamer streamer = ignite.dataStreamer(DEFAULT_CACHE_NAME)) {\n+            for (int i = 0; i < countEntries; i++)\n+                streamer.addData(i, i);\n+        }\n+    }\n+\n+    /**\n+     * Try to finds node failed exception message on output report.\n+     *\n+     * @param unstableNodeId Unstable node id.\n+     */\n+    private void checkExceptionMessageOnReport(UUID unstableNodeId) throws IOException {\n+        Matcher fileNameMatcher = dumpFileNameMatcher();\n+\n+        if (fileNameMatcher.find()) {\n+            String dumpWithConflicts = new String(Files.readAllBytes(Paths.get(fileNameMatcher.group(1))));\n+\n+            assertTrue(dumpWithConflicts.contains(\"Idle verify failed on nodes:\"));\n+\n+            assertTrue(dumpWithConflicts.contains(\"Node ID: \" + unstableNodeId + \"\\n\" +\n+                \"Exception message:\\n\" +\n+                \"Node has left grid: \" + unstableNodeId));\n+        }\n+        else\n+            fail(\"Should be found dump with conflicts\");\n+    }\n+\n     /**\n      * Tests that idle verify print partitions info over system caches.\n      *\n@@ -1188,28 +1289,13 @@ public void testCacheIdleVerifyDumpForCorruptedDataOnSystemCache() throws Except\n      */\n     @Test\n     public void testCacheIdleVerifyDumpForCorruptedDataOnPersistenceClientCache() throws Exception {\n-        int parts = 32;\n-\n-        dataRegionConfiguration = new DataRegionConfiguration()\n-            .setName(\"persistence-region\")\n-            .setMaxSize(100L * 1024 * 1024)\n-            .setPersistenceEnabled(true);\n-\n         IgniteEx ignite = (IgniteEx)startGrids(3);\n \n         ignite.cluster().active(true);\n \n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, parts))\n-            .setBackups(2)\n-            .setName(DEFAULT_CACHE_NAME)\n-            .setDataRegionName(\"persistence-region\"));\n-\n-        // Adding some assignments without deployments.\n-        for (int i = 0; i < 100; i++)\n-            cache.put(i, i);\n+        createCacheAndPreload(ignite, 100);\n \n-        corruptingAndCheckDefaultCache(ignite, parts, CacheFilterEnum.PERSISTENT);\n+        corruptingAndCheckDefaultCache(ignite, CacheFilterEnum.PERSISTENT);\n     }\n \n     /**\n@@ -1572,13 +1658,7 @@ public void testCacheDistribution() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, 32))\n-            .setBackups(1)\n-            .setName(DEFAULT_CACHE_NAME));\n-\n-        for (int i = 0; i < 100; i++)\n-            cache.put(i, i);\n+        createCacheAndPreload(ignite, 100);\n \n         injectTestSystemOut();\n \n@@ -1623,13 +1703,7 @@ public void testCacheResetLostPartitions() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        IgniteCache<Object, Object> cache = ignite.createCache(new CacheConfiguration<>()\n-            .setAffinity(new RendezvousAffinityFunction(false, 32))\n-            .setBackups(1)\n-            .setName(DEFAULT_CACHE_NAME));\n-\n-        for (int i = 0; i < 100; i++)\n-            cache.put(i, i);\n+        createCacheAndPreload(ignite, 100);\n \n         injectTestSystemOut();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/d7af985383d9e82608fd77904415960492ed6290/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "sha": "318b8379996ec597e78c0a085eefc0d3d4d83201",
                "status": "modified"
            }
        ],
        "message": "IGNITE-10446 Fix control.sh --cache idle_verify fail with NPE when node left grid\n\nSigned-off-by: Dmitriy Govorukhin <dmitriy.govorukhin@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/859b37cc8016e4d12178d80e717bd52f992d6e34",
        "patched_files": [
            "IdleVerifyResultV2.java",
            "CommandHandler.java",
            "VerifyBackupPartitionsTaskV2.java",
            "VerifyBackupPartitionsDumpTask.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridCommandHandlerTest.java"
        ]
    },
    "ignite_e2c597f": {
        "bug_id": "ignite_e2c597f",
        "commit": "https://github.com/apache/ignite/commit/e2c597fff12192f736738569e244d0aee96b6e97",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "patch": "@@ -183,9 +183,6 @@\n     /** */\n     public static final String NODES_SYS_VIEW_DESC = \"Cluster nodes\";\n \n-    /** Discovery cached history size. */\n-    private static final int DISCOVERY_HISTORY_SIZE = getInteger(IGNITE_DISCOVERY_HISTORY_SIZE, 500);\n-\n     /** Predicate filtering out daemon nodes. */\n     private static final IgnitePredicate<ClusterNode> FILTER_NOT_DAEMON = new P1<ClusterNode>() {\n         @Override public boolean apply(ClusterNode n) {\n@@ -200,6 +197,9 @@\n         }\n     };\n \n+    /** Discovery cached history size. */\n+    private final int DISCOVERY_HISTORY_SIZE = getInteger(IGNITE_DISCOVERY_HISTORY_SIZE, 500);\n+\n     /** */\n     private final Object discoEvtMux = new Object();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/managers/discovery/GridDiscoveryManager.java",
                "sha": "8cc317a8d86444d347a1347ff66a306a4b11c2d8",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityAssignmentCache.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityAssignmentCache.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 9,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityAssignmentCache.java",
                "patch": "@@ -355,7 +355,7 @@ public IdealAffinityAssignment calculate(\n                 assignment = IdealAffinityAssignment.create(\n                     topVer,\n                     sorted,\n-                    baselineAssignmentWithoutOfflineNodes(topVer)\n+                    baselineAssignmentWithoutOfflineNodes(discoCache)\n                 );\n             }\n             else if (skipCalculation)\n@@ -367,7 +367,7 @@ else if (hasBaseline) {\n                 assignment = IdealAffinityAssignment.create(\n                     topVer,\n                     sorted,\n-                    baselineAssignmentWithoutOfflineNodes(topVer)\n+                    baselineAssignmentWithoutOfflineNodes(discoCache)\n                 );\n             }\n             else {\n@@ -388,7 +388,7 @@ else if (hasBaseline) {\n \n                 assignment = IdealAffinityAssignment.createWithPreservedPrimaries(\n                     topVer,\n-                    baselineAssignmentWithoutOfflineNodes(topVer),\n+                    baselineAssignmentWithoutOfflineNodes(discoCache),\n                     baselineAssignment\n                 );\n             }\n@@ -455,16 +455,14 @@ private void recalculateBaselineAssignment(\n     }\n \n     /**\n-     * @param topVer Topology version.\n+     * @param disco Discovery history.\n      * @return Baseline assignment with filtered out offline nodes.\n      */\n-    private List<List<ClusterNode>> baselineAssignmentWithoutOfflineNodes(AffinityTopologyVersion topVer) {\n+    private List<List<ClusterNode>> baselineAssignmentWithoutOfflineNodes(DiscoCache disco) {\n         Map<Object, ClusterNode> alives = new HashMap<>();\n \n-        for (ClusterNode node : ctx.discovery().nodes(topVer)) {\n-            if (!node.isClient() && !node.isDaemon())\n-                alives.put(node.consistentId(), node);\n-        }\n+        for (ClusterNode node : disco.serverNodes())\n+            alives.put(node.consistentId(), node);\n \n         List<List<ClusterNode>> assignment = baselineAssignment.assignment();\n ",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/processors/affinity/GridAffinityAssignmentCache.java",
                "sha": "9297ae89e3dcf597dd766f98975f193b8dbffe87",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "patch": "@@ -1508,8 +1508,8 @@ private void distributedExchange() throws IgniteCheckedException {\n         timeBag.finishGlobalStage(\"WAL history reservation\");\n \n         // Skipping wait on local join is available when all cluster nodes have the same protocol.\n-        boolean skipWaitOnLocalJoin = cctx.exchange().latch().canSkipJoiningNodes(initialVersion())\n-            && localJoinExchange();\n+        boolean skipWaitOnLocalJoin = localJoinExchange()\n+            && cctx.exchange().latch().canSkipJoiningNodes(initialVersion());\n \n         if (context().exchangeFreeSwitch())\n             waitPartitionRelease(true, false);",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/GridDhtPartitionsExchangeFuture.java",
                "sha": "28bf6dc214c91fb06eb065787e9bcd74e437b242",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/latch/ExchangeLatchManager.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/latch/ExchangeLatchManager.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 6,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/latch/ExchangeLatchManager.java",
                "patch": "@@ -275,6 +275,7 @@ public void dropLatch(String id, AffinityTopologyVersion topVer) {\n      *\n      * @param topVer Topology version.\n      * @return Collection of nodes with at least one cache configured.\n+     * @throws IgniteException If nodes for the given {@code topVer} cannot be found in the discovery history.\n      */\n     private Collection<ClusterNode> aliveNodesForTopologyVer(AffinityTopologyVersion topVer) {\n         if (topVer == AffinityTopologyVersion.NONE)\n@@ -286,9 +287,9 @@ public void dropLatch(String id, AffinityTopologyVersion topVer) {\n                 return histNodes.stream().filter(n -> !n.isClient() && !n.isDaemon() && discovery.alive(n))\n                     .collect(Collectors.toList());\n             else\n-                throw new IgniteException(\"Topology \" + topVer + \" not found in discovery history \"\n-                    + \"; consider increasing IGNITE_DISCOVERY_HISTORY_SIZE property. Current value is \"\n-                    + IgniteSystemProperties.getInteger(IgniteSystemProperties.IGNITE_DISCOVERY_HISTORY_SIZE, -1));\n+                throw new IgniteException(\"Topology \" + topVer + \" not found in discovery history. \"\n+                        + \"Consider increasing IGNITE_DISCOVERY_HISTORY_SIZE property. Current value is \"\n+                        + IgniteSystemProperties.getInteger(IgniteSystemProperties.IGNITE_DISCOVERY_HISTORY_SIZE, -1));\n         }\n     }\n \n@@ -351,11 +352,10 @@ public void dropLatch(String id, AffinityTopologyVersion topVer) {\n      * Checks that latch manager can use V2 protocol and skip joining nodes from latch participants.\n      *\n      * @param topVer Topology version.\n+     * @throws IgniteException If nodes for the given {@code topVer} cannot be found in the discovery history.\n      */\n     public boolean canSkipJoiningNodes(AffinityTopologyVersion topVer) {\n-        Collection<ClusterNode> applicableNodes = topVer.equals(AffinityTopologyVersion.NONE)\n-            ? discovery.aliveServerNodes()\n-            : discovery.topology(topVer.topologyVersion());\n+        Collection<ClusterNode> applicableNodes = aliveNodesForTopologyVer(topVer);\n \n         return applicableNodes.stream()\n             .allMatch(node -> node.version().compareTo(PROTOCOL_V2_VERSION_SINCE) >= 0);",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/distributed/dht/preloader/latch/ExchangeLatchManager.java",
                "sha": "53b576ac8cb7cc4597e19259fb781d01de9205f3",
                "status": "modified"
            },
            {
                "additions": 293,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteExchangeLatchManagerDiscoHistoryTest.java",
                "changes": 293,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteExchangeLatchManagerDiscoHistoryTest.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteExchangeLatchManagerDiscoHistoryTest.java",
                "patch": "@@ -0,0 +1,293 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.datastructures;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.IgniteException;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.AbstractFailureHandler;\n+import org.apache.ignite.failure.FailureContext;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.IgniteInternalFuture;\n+import org.apache.ignite.internal.IgnitionEx;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.GridDhtPartitionsExchangeFuture;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.PartitionsExchangeAware;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.latch.ExchangeLatchManager;\n+import org.apache.ignite.internal.processors.metastorage.DistributedMetastorageLifecycleListener;\n+import org.apache.ignite.internal.processors.metastorage.ReadableDistributedMetaStorage;\n+import org.apache.ignite.internal.util.typedef.X;\n+import org.apache.ignite.lifecycle.LifecycleBean;\n+import org.apache.ignite.lifecycle.LifecycleEventType;\n+import org.apache.ignite.resources.IgniteInstanceResource;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.TestTcpDiscoverySpi;\n+import org.apache.ignite.spi.discovery.tcp.ipfinder.TcpDiscoveryIpFinder;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.WithSystemProperty;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.IgniteSystemProperties.IGNITE_DISCOVERY_HISTORY_SIZE;\n+\n+/**\n+ * Test {@link ExchangeLatchManager} throws {@link IgniteException} with appropriate message when topology history\n+ * cannot be obtained.\n+ */\n+public class IgniteExchangeLatchManagerDiscoHistoryTest extends GridCommonAbstractTest {\n+    /** Topology history size. */\n+    private static final int TOPOLOGY_HISTORY_SIZE = 2;\n+\n+    /** Disco cache size. */\n+    private static final String DISCO_HISTORY_SIZE = \"2\";\n+\n+    /** Timeout in millis. */\n+    private static final long DEFAULT_TIMEOUT = 30_000;\n+\n+    /** Lifecycle bean that is used to register required listeners. */\n+    private LifecycleBean lifecycleBean;\n+\n+    /** Flag indicates that a node, that is starting, should have short topology history. */\n+    private boolean victim;\n+\n+    /** Discovery SPI that is used by the node with short topology history. */\n+    private CustomTcpDiscoverySpi disco;\n+\n+    /** Failure context. */\n+    private final AtomicReference<FailureContext> cpFailureCtx = new AtomicReference<>();\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        TcpDiscoveryIpFinder ipFinder = ((TcpDiscoverySpi)cfg.getDiscoverySpi()).getIpFinder();\n+\n+        int topHistSize = victim? TOPOLOGY_HISTORY_SIZE: TcpDiscoverySpi.DFLT_TOP_HISTORY_SIZE;\n+\n+        CustomTcpDiscoverySpi discoSpi = new CustomTcpDiscoverySpi(topHistSize, ipFinder);\n+\n+        cfg.setDiscoverySpi(discoSpi);\n+\n+        if (victim) {\n+            cfg.setFailureHandler(new AbstractFailureHandler() {\n+                /** {@inheritDoc} */\n+                @Override protected boolean handle(Ignite ignite, FailureContext failureCtx) {\n+                    cpFailureCtx.compareAndSet(null, failureCtx);\n+\n+                    // Invalidate kernel context.\n+                    return true;\n+                }\n+            });\n+\n+            cfg.setLifecycleBeans(lifecycleBean);\n+\n+            disco = discoSpi;\n+        }\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Prepares test for execution.\n+     */\n+    @Before\n+    public void startup() {\n+        shutdown();\n+    }\n+\n+    /**\n+     * Cleans after the test.\n+     */\n+    @After\n+    public void shutdown() {\n+        lifecycleBean = null;\n+\n+        victim = false;\n+\n+        cpFailureCtx.set(null);\n+\n+        disco = null;\n+\n+        stopAllGrids();\n+    }\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @WithSystemProperty(key = IGNITE_DISCOVERY_HISTORY_SIZE, value = DISCO_HISTORY_SIZE)\n+    public void testProperException() throws Exception {\n+        final IgniteEx crd = startGrid(0);\n+\n+        final CountDownLatch exchangeLatch = new CountDownLatch(1);\n+\n+        final CountDownLatch startSrvsLatch = new CountDownLatch(1);\n+\n+        final AtomicReference<Exception> err = new AtomicReference<>();\n+\n+        // Lifecycle bean that is used to register PartitionsExchangeAware listener.\n+        lifecycleBean = new LifecycleBean() {\n+            /** Ignite instance. */\n+            @IgniteInstanceResource\n+            IgniteEx ignite;\n+\n+            /** {@inheritDoc} */\n+            @Override public void onLifecycleEvent(LifecycleEventType evt) throws IgniteException {\n+                if (evt == LifecycleEventType.BEFORE_NODE_START) {\n+                    // The goal is registering PartitionsExchangeAware listener before the discovery manager is started.\n+                    ignite.context().internalSubscriptionProcessor()\n+                        .registerDistributedMetastorageListener(new DistributedMetastorageLifecycleListener() {\n+                            @Override public void onReadyForRead(ReadableDistributedMetaStorage metastorage) {\n+                                ignite.context().cache().context().exchange()\n+                                    .registerExchangeAwareComponent(new PartitionsExchangeAware() {\n+                                        /** {@inheritDoc} */\n+                                        @Override public void onInitBeforeTopologyLock(GridDhtPartitionsExchangeFuture fut) {\n+                                            try {\n+                                                // Let's start nodes.\n+                                                startSrvsLatch.countDown();\n+\n+                                                // Blocks the initial exchange and waits for other nodes.\n+                                                exchangeLatch.await(DEFAULT_TIMEOUT, TimeUnit.MILLISECONDS);\n+                                            }\n+                                            catch (Exception e) {\n+                                                err.compareAndSet(null, e);\n+                                            }\n+                                        }\n+                                });\n+                            }\n+                    });\n+                }\n+            }\n+        };\n+\n+        // Start server node with short topology history.\n+        victim = true;\n+\n+        GridTestUtils.runAsync(() ->startGrid(1));\n+\n+        // Waits for the initial exchange.\n+        startSrvsLatch.await(DEFAULT_TIMEOUT, TimeUnit.MILLISECONDS);\n+\n+        victim = false;\n+\n+        lifecycleBean = null;\n+\n+        List<IgniteInternalFuture> srvFuts = new ArrayList<>(TOPOLOGY_HISTORY_SIZE);\n+\n+        try {\n+            // Major topology version that is corresponding to the start of the node with short topology history.\n+            final long topVer = 2;\n+\n+            // Starting server nodes to exhaust the topology history.\n+            for (int i = 2; i < 3 * TOPOLOGY_HISTORY_SIZE && !disco.isEmptyTopologyHistory(topVer); ++i) {\n+                final int currNodeIdx = i;\n+\n+                final int joinedNodesCnt = disco.totalJoinedNodes();\n+\n+                srvFuts.add(GridTestUtils.runAsync(() -> startGrid(currNodeIdx)));\n+\n+                assertTrue(\"Failed to wait for a new server node [joinedNodesCnt=\" + joinedNodesCnt + \"]\",\n+                    GridTestUtils.waitForCondition(\n+                        () -> disco.totalJoinedNodes() >= (joinedNodesCnt + 1), DEFAULT_TIMEOUT));\n+            }\n+\n+            assertTrue(\n+                \"Disco cache history is not empty for the topology [majorTopVer=\" + topVer + ']',\n+                disco.isEmptyTopologyHistory(topVer));\n+\n+            // Let's continue the ongoing exchange.\n+            exchangeLatch.countDown();\n+\n+            boolean failureHnd = GridTestUtils.waitForCondition(() -> cpFailureCtx.get() != null, DEFAULT_TIMEOUT);\n+\n+            assertNull(\n+                \"Unexpected exception (probably, the topology history still exists [err=\" + err + ']',\n+                err.get());\n+\n+            assertTrue(\"Failure handler was not triggered.\", failureHnd);\n+\n+            // Check that IgniteException was thrown instead of NullPointerException.\n+            assertTrue(\n+                \"IgniteException must be thrown.\",\n+                X.hasCause(cpFailureCtx.get().error(), IgniteException.class));\n+\n+            // Check that message contains a hint to fix the issue.\n+            GridTestUtils.assertContains(\n+                log,\n+                cpFailureCtx.get().error().getMessage(),\n+                \"Consider increasing IGNITE_DISCOVERY_HISTORY_SIZE property. Current value is \" + DISCO_HISTORY_SIZE);\n+        }\n+        finally {\n+            IgnitionEx.stop(getTestIgniteInstanceName(1), true, true);\n+\n+            srvFuts.forEach(f -> {\n+                try {\n+                    f.get(DEFAULT_TIMEOUT);\n+                }\n+                catch (IgniteCheckedException e) {\n+                    err.compareAndSet(null, e);\n+                }\n+            });\n+        }\n+\n+        assertNull(\"Unexpected exception [err=\" + err.get() + ']', err.get());\n+    }\n+\n+    /**\n+     * Custom discovery SPI that allows specifying a short topology history for testing purposes.\n+     */\n+    private static class CustomTcpDiscoverySpi extends TestTcpDiscoverySpi {\n+        /**\n+         * Creates a new instance of discovery spi with the given size of topology snapshots history.\n+         *\n+         * @param topHistSize Size of topology snapshots history.\n+         * @param ipFinder IP finder\n+         */\n+        CustomTcpDiscoverySpi(int topHistSize, TcpDiscoveryIpFinder ipFinder) {\n+            this.topHistSize = topHistSize;\n+\n+            setIpFinder(ipFinder);\n+        }\n+\n+        /**\n+         * Returns the number of joined nodes.\n+         *\n+         * @return Number of joined nodes.\n+         */\n+        int totalJoinedNodes() {\n+            return stats.joinedNodesCount();\n+        }\n+\n+        /**\n+         * Returns {@code true} if the given topology version is already removed from the history.\n+         *\n+         * @param topVer Major topology version.\n+         * @return {@code true} if the given topology version is already removed from the history.\n+         */\n+        boolean isEmptyTopologyHistory(long topVer) {\n+            return ((IgniteEx)ignite).context().discovery().topology(topVer) == null;\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/datastructures/IgniteExchangeLatchManagerDiscoHistoryTest.java",
                "sha": "71cd842f7d9af24bc348fa890602d036075ef890",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheMvccTestSuite6.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheMvccTestSuite6.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheMvccTestSuite6.java",
                "patch": "@@ -33,6 +33,7 @@\n import org.apache.ignite.internal.processors.cache.ReplicatedTransactionalOptimisticCacheGetsDistributionTest;\n import org.apache.ignite.internal.processors.cache.ReplicatedTransactionalPessimisticCacheGetsDistributionTest;\n import org.apache.ignite.internal.processors.cache.datastructures.IgniteExchangeLatchManagerCoordinatorFailTest;\n+import org.apache.ignite.internal.processors.cache.datastructures.IgniteExchangeLatchManagerDiscoHistoryTest;\n import org.apache.ignite.internal.processors.cache.distributed.CacheExchangeMergeTest;\n import org.apache.ignite.internal.processors.cache.distributed.CacheParallelStartTest;\n import org.apache.ignite.internal.processors.cache.distributed.ExchangeMergeStaleServerNodesTest;\n@@ -82,6 +83,7 @@\n         ignoredTests.add(CacheExchangeMergeTest.class);\n         ignoredTests.add(ExchangeMergeStaleServerNodesTest.class);\n         ignoredTests.add(IgniteExchangeLatchManagerCoordinatorFailTest.class);\n+        ignoredTests.add(IgniteExchangeLatchManagerDiscoHistoryTest.class);\n         ignoredTests.add(PartitionsExchangeCoordinatorFailoverTest.class);\n         ignoredTests.add(CacheParallelStartTest.class);\n         ignoredTests.add(IgniteCache150ClientsTest.class);",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheMvccTestSuite6.java",
                "sha": "3db1f05cc7080cbb6e3cc255b487e8d81a61868b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java?ref=e2c597fff12192f736738569e244d0aee96b6e97",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java",
                "patch": "@@ -31,6 +31,7 @@\n import org.apache.ignite.internal.processors.cache.ReplicatedTransactionalOptimisticCacheGetsDistributionTest;\n import org.apache.ignite.internal.processors.cache.ReplicatedTransactionalPessimisticCacheGetsDistributionTest;\n import org.apache.ignite.internal.processors.cache.datastructures.IgniteExchangeLatchManagerCoordinatorFailTest;\n+import org.apache.ignite.internal.processors.cache.datastructures.IgniteExchangeLatchManagerDiscoHistoryTest;\n import org.apache.ignite.internal.processors.cache.distributed.CacheExchangeMergeTest;\n import org.apache.ignite.internal.processors.cache.distributed.CacheParallelStartTest;\n import org.apache.ignite.internal.processors.cache.distributed.CachePartitionLossDetectionOnNodeLeftTest;\n@@ -127,6 +128,7 @@\n         GridTestUtils.addTestIfNeeded(suite, TxOptimisticOnPartitionExchangeTest.class, ignoredTests);\n \n         GridTestUtils.addTestIfNeeded(suite, IgniteExchangeLatchManagerCoordinatorFailTest.class, ignoredTests);\n+        GridTestUtils.addTestIfNeeded(suite, IgniteExchangeLatchManagerDiscoHistoryTest.class, ignoredTests);\n \n         GridTestUtils.addTestIfNeeded(suite, PartitionsExchangeCoordinatorFailoverTest.class, ignoredTests);\n         GridTestUtils.addTestIfNeeded(suite, CacheTryLockMultithreadedTest.class, ignoredTests);",
                "raw_url": "https://github.com/apache/ignite/raw/e2c597fff12192f736738569e244d0aee96b6e97/modules/core/src/test/java/org/apache/ignite/testsuites/IgniteCacheTestSuite6.java",
                "sha": "96c2f30836a25a175d35467297ade6defc9cea68",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12013 NullPointerException is thrown by ExchangeLatchManager during cache creation - Fixes #7335.\n\nSigned-off-by: Ivan Rakov <ivan.glukos@gmail.com>",
        "parent": "https://github.com/apache/ignite/commit/906fa9eed60c45954559c02fee5214dd43a53d7c",
        "patched_files": [
            "IgniteCacheTestSuite6.java",
            "IgniteCacheMvccTestSuite6.java",
            "GridDhtPartitionsExchangeFuture.java",
            "ExchangeLatchManager.java",
            "GridDiscoveryManager.java",
            "GridAffinityAssignmentCache.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteExchangeLatchManagerDiscoHistoryTest.java"
        ]
    },
    "ignite_e383dc4": {
        "bug_id": "ignite_e383dc4",
        "commit": "https://github.com/apache/ignite/commit/e383dc4057436c2fb384f4443d91b16701949fa3",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/e383dc4057436c2fb384f4443d91b16701949fa3/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java?ref=e383dc4057436c2fb384f4443d91b16701949fa3",
                "deletions": 1,
                "filename": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java",
                "patch": "@@ -2378,7 +2378,7 @@ private int bindPartitionInfoParameter(CacheQueryPartitionInfo partInfo, Object[\n         assert partInfo != null;\n         assert partInfo.partition() < 0;\n \n-        GridH2RowDescriptor desc = dataTable(partInfo.cacheName(),\n+        GridH2RowDescriptor desc = dataTable(schema(partInfo.cacheName()),\n                 partInfo.tableName()).rowDescriptor();\n \n         Object param = H2Utils.convert(params[partInfo.paramIdx()],",
                "raw_url": "https://github.com/apache/ignite/raw/e383dc4057436c2fb384f4443d91b16701949fa3/modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java",
                "sha": "3d3ed84d6fa2351f0a5a25104a0b99bd9f411ab8",
                "status": "modified"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/ignite/blob/e383dc4057436c2fb384f4443d91b16701949fa3/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlSchemaSelfTest.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlSchemaSelfTest.java?ref=e383dc4057436c2fb384f4443d91b16701949fa3",
                "deletions": 0,
                "filename": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlSchemaSelfTest.java",
                "patch": "@@ -17,7 +17,9 @@\n \n package org.apache.ignite.internal.processors.query;\n \n+import java.util.Collections;\n import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.cache.QueryEntity;\n import org.apache.ignite.cache.query.SqlFieldsQuery;\n import org.apache.ignite.cache.query.annotations.QuerySqlField;\n import org.apache.ignite.configuration.CacheConfiguration;\n@@ -189,6 +191,36 @@ public void testSchemaChangeOnCacheWithPublicSchema() throws Exception {\n         ).getAll().size());\n     }\n \n+    /**\n+     * Test simple query.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    public void testCustomSchemaName() throws Exception {\n+        QueryEntity qe = new QueryEntity()\n+            .setValueType(Person.class.getName())\n+            .setKeyType(Long.class.getName())\n+            .setValueFieldName(\"_value\")\n+            .setKeyFieldName(\"id\")\n+            .addQueryField(\"id\", Long.class.getName(), null)\n+            .addQueryField(\"_value\", Person.class.getName(), null)\n+            .addQueryField(\"name\", String.class.getName(), null)\n+            .addQueryField(\"orgId\", Long.class.getName(), null);\n+\n+        qe.setTableName(\"Person\");\n+\n+        IgniteCache<Long, Person> cache = node.createCache(new CacheConfiguration<Long, Person>()\n+            .setName(CACHE_PERSON)\n+            .setQueryEntities(Collections.singletonList(qe))\n+            .setSqlSchema(\"TEST\"));\n+\n+        cache.put(1L, new Person(\"Vasya\", 2));\n+\n+        assertEquals(1, node.context().query().querySqlFieldsNoCache(\n+            new SqlFieldsQuery(\"SELECT id, name, orgId FROM TEST.Person where (id = ?)\").setArgs(1L), false\n+        ).getAll().size());\n+    }\n+\n     /**\n      * Test type conflict in public schema.\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/e383dc4057436c2fb384f4443d91b16701949fa3/modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/SqlSchemaSelfTest.java",
                "sha": "183a88442c73b59208b324e18387f4b1c172963c",
                "status": "modified"
            }
        ],
        "message": "IGNITE-6288: SQL: fixed NPE in IgniteH2Indexing.bindPartitionInfoParameter. This closes #2617.",
        "parent": "https://github.com/apache/ignite/commit/d808e33efc950d70975a69d51fd6fc6de0613656",
        "patched_files": [
            "IgniteH2Indexing.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "SqlSchemaSelfTest.java"
        ]
    },
    "ignite_e74163a": {
        "bug_id": "ignite_e74163a",
        "commit": "https://github.com/apache/ignite/commit/e74163a99870bd50b24ea6799b7566dc37682f74",
        "file": [
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/ignite/blob/e74163a99870bd50b24ea6799b7566dc37682f74/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAdapter.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAdapter.java?ref=e74163a99870bd50b24ea6799b7566dc37682f74",
                "deletions": 0,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAdapter.java",
                "patch": "@@ -1853,6 +1853,8 @@ private boolean evictx(K key, GridCacheVersion ver,\n         if (tx == null || tx.implicit()) {\n             Map<KeyCacheObject, EntryGetResult> misses = null;\n \n+            Set<GridCacheEntryEx> newLocalEntries = null;\n+\n             final AffinityTopologyVersion topVer = tx == null ? ctx.affinity().affinityTopologyVersion() :\n                 tx.topologyVersion();\n \n@@ -1925,6 +1927,8 @@ else if (storeEnabled)\n                             }\n \n                             if (!skipEntry) {\n+                                boolean isNewLocalEntry = this.map.getEntry(ctx, key) == null;\n+\n                                 entry = entryEx(key);\n \n                                 if (entry == null) {\n@@ -1934,6 +1938,13 @@ else if (storeEnabled)\n                                     break;\n                                 }\n \n+                                if (isNewLocalEntry) {\n+                                    if (newLocalEntries == null)\n+                                        newLocalEntries = new HashSet<>();\n+\n+                                    newLocalEntries.add(entry);\n+                                }\n+\n                                 if (storeEnabled) {\n                                     res = entry.innerGetAndReserveForLoad(updateMetrics,\n                                         evt,\n@@ -2128,6 +2139,11 @@ else if (storeEnabled)\n                         ctx.evicts().touch(peekEx(key0), topVer);\n                 }\n \n+                if (newLocalEntries != null) {\n+                    for (GridCacheEntryEx entry : newLocalEntries)\n+                        removeEntry(entry);\n+                }\n+\n                 return new GridFinishedFuture<>(e);\n             }\n             catch (IgniteCheckedException e) {",
                "raw_url": "https://github.com/apache/ignite/raw/e74163a99870bd50b24ea6799b7566dc37682f74/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAdapter.java",
                "sha": "8c5d6f2ae6cf75ed76708ac019a6f58fb3fe8e59",
                "status": "modified"
            },
            {
                "additions": 43,
                "blob_url": "https://github.com/apache/ignite/blob/e74163a99870bd50b24ea6799b7566dc37682f74/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java?ref=e74163a99870bd50b24ea6799b7566dc37682f74",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "patch": "@@ -919,13 +919,54 @@ public void testGetEntries() throws Exception {\n     /**\n      * @throws Exception In case of error.\n      */\n-    public void testGetAllWithNulls() throws Exception {\n+    public void testGetAllWithLastNull() throws Exception {\n         final IgniteCache<String, Integer> cache = jcache();\n \n-        final Set<String> c = new HashSet<>();\n+        final Set<String> c = new LinkedHashSet<>();\n+\n+        c.add(\"key1\");\n+        c.add(null);\n+\n+        GridTestUtils.assertThrows(log, new Callable<Void>() {\n+            @Override public Void call() throws Exception {\n+                cache.getAll(c);\n+\n+                return null;\n+            }\n+        }, NullPointerException.class, null);\n+    }\n+\n+    /**\n+     * @throws Exception In case of error.\n+     */\n+    public void testGetAllWithFirstNull() throws Exception {\n+        final IgniteCache<String, Integer> cache = jcache();\n+\n+        final Set<String> c = new LinkedHashSet<>();\n+\n+        c.add(null);\n+        c.add(\"key1\");\n+\n+        GridTestUtils.assertThrows(log, new Callable<Void>() {\n+            @Override public Void call() throws Exception {\n+                cache.getAll(c);\n+\n+                return null;\n+            }\n+        }, NullPointerException.class, null);\n+    }\n+\n+    /**\n+     * @throws Exception In case of error.\n+     */\n+    public void testGetAllWithInTheMiddle() throws Exception {\n+        final IgniteCache<String, Integer> cache = jcache();\n+\n+        final Set<String> c = new LinkedHashSet<>();\n \n         c.add(\"key1\");\n         c.add(null);\n+        c.add(\"key2\");\n \n         GridTestUtils.assertThrows(log, new Callable<Void>() {\n             @Override public Void call() throws Exception {",
                "raw_url": "https://github.com/apache/ignite/raw/e74163a99870bd50b24ea6799b7566dc37682f74/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/GridCacheAbstractFullApiSelfTest.java",
                "sha": "e6c9589a5ec304d79b9b2c92eb7df3fb86cae32c",
                "status": "modified"
            }
        ],
        "message": "IGNITE-6307 If getAll() fails with NPE, onHeap entry is not removed, for local cache",
        "parent": "https://github.com/apache/ignite/commit/b2a0295894dbdeb638ac8f764549a724578322ac",
        "patched_files": [
            "GridCacheAdapter.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridCacheAbstractFullApiSelfTest.java"
        ]
    },
    "ignite_e7864f1": {
        "bug_id": "ignite_e7864f1",
        "commit": "https://github.com/apache/ignite/commit/e7864f198539f87a38e993cc68f0931dca195534",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/main/java/org/apache/ignite/internal/cluster/DetachedClusterNode.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/cluster/DetachedClusterNode.java?ref=e7864f198539f87a38e993cc68f0931dca195534",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/cluster/DetachedClusterNode.java",
                "patch": "@@ -30,7 +30,9 @@\n import org.jetbrains.annotations.Nullable;\n \n /**\n- * Representation of cluster node that isn't currently present in cluster.\n+ * Representation of cluster node that either isn't currently present in cluster, or semantically detached.\n+ * For example nodes returned from {@code BaselineTopology.currentBaseline()} are always considered as\n+ * semantically detached, even if they are currently present in cluster.\n  */\n public class DetachedClusterNode implements ClusterNode {\n     /** */",
                "raw_url": "https://github.com/apache/ignite/raw/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/main/java/org/apache/ignite/internal/cluster/DetachedClusterNode.java",
                "sha": "a3a69e19d9659ec091f983ffc49ceef674328dc7",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/ignite/blob/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/main/java/org/apache/ignite/internal/cluster/IgniteClusterImpl.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/cluster/IgniteClusterImpl.java?ref=e7864f198539f87a38e993cc68f0931dca195534",
                "deletions": 1,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/cluster/IgniteClusterImpl.java",
                "patch": "@@ -29,7 +29,10 @@\n import java.util.Collection;\n import java.util.Collections;\n import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n import java.util.Set;\n import java.util.UUID;\n import java.util.concurrent.ConcurrentLinkedQueue;\n@@ -404,6 +407,22 @@ private void validateBeforeBaselineChange(Collection<? extends BaselineNode> bas\n             if (baselineTop.isEmpty())\n                 throw new IgniteException(\"BaselineTopology must contain at least one node.\");\n \n+            List<BaselineNode> currBlT = Optional.ofNullable(ctx.state().clusterState().baselineTopology()).\n+                map(BaselineTopology::currentBaseline).orElse(Collections.emptyList());\n+\n+            Collection<ClusterNode> srvrs = ctx.cluster().get().forServers().nodes();\n+\n+            for (BaselineNode node : baselineTop) {\n+                Object consistentId = node.consistentId();\n+\n+                if (currBlT.stream().noneMatch(\n+                    currBlTNode -> Objects.equals(currBlTNode.consistentId(), consistentId)) &&\n+                    srvrs.stream().noneMatch(\n+                        currServersNode -> Objects.equals(currServersNode.consistentId(), consistentId)))\n+                    throw new IgniteException(\"Check arguments. Node with consistent ID [\" + consistentId +\n+                        \"] not found in server nodes.\");\n+            }\n+\n             Collection<Object> onlineNodes = onlineBaselineNodesRequestedForRemoval(baselineTop);\n \n             if (onlineNodes != null) {\n@@ -473,7 +492,7 @@ private void setBaselineTopology(long topVer, boolean isBaselineAutoAdjust) {\n             Collection<BaselineNode> target = new ArrayList<>(top.size());\n \n             for (ClusterNode node : top) {\n-                if (!node.isClient())\n+                if (!node.isClient() && !node.isDaemon())\n                     target.add(node);\n             }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/main/java/org/apache/ignite/internal/cluster/IgniteClusterImpl.java",
                "sha": "6249301bbb82e5c540c1e4819de1a81c2bc40c8c",
                "status": "modified"
            },
            {
                "additions": 60,
                "blob_url": "https://github.com/apache/ignite/blob/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/CacheBaselineTopologyTest.java",
                "changes": 62,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/CacheBaselineTopologyTest.java?ref=e7864f198539f87a38e993cc68f0931dca195534",
                "deletions": 2,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/CacheBaselineTopologyTest.java",
                "patch": "@@ -28,8 +28,11 @@\n import java.util.Random;\n import java.util.Set;\n import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.stream.Collectors;\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteCache;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.IgniteSystemProperties;\n import org.apache.ignite.cache.CacheAtomicityMode;\n import org.apache.ignite.cache.CacheMode;\n@@ -47,6 +50,7 @@\n import org.apache.ignite.internal.IgniteEx;\n import org.apache.ignite.internal.IgniteInternalFuture;\n import org.apache.ignite.internal.IgniteInterruptedCheckedException;\n+import org.apache.ignite.internal.cluster.DetachedClusterNode;\n import org.apache.ignite.internal.processors.affinity.AffinityTopologyVersion;\n import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.GridDhtPartitionFullMap;\n import org.apache.ignite.internal.processors.cache.distributed.dht.topology.GridDhtPartitionState;\n@@ -505,7 +509,8 @@ private void testBaselineTopologyChanges(boolean fromClient) throws Exception {\n \n         Set<ClusterNode> blt2 = new HashSet<>(ignite.cluster().nodes());\n \n-        ignite.cluster().setBaselineTopology(baselineNodes(blt2));\n+        ignite.cluster().setBaselineTopology(baselineNodes(\n+            blt2.stream().filter(n -> !n.isClient()).collect(Collectors.toSet())));\n \n         awaitPartitionMapExchange();\n \n@@ -526,7 +531,8 @@ private void testBaselineTopologyChanges(boolean fromClient) throws Exception {\n \n         Set<ClusterNode> blt3 = new HashSet<>(ignite.cluster().nodes());\n \n-        ignite.cluster().setBaselineTopology(baselineNodes(blt3));\n+        ignite.cluster().setBaselineTopology(baselineNodes(\n+            blt3.stream().filter(n -> !n.isClient()).collect(Collectors.toSet())));\n \n         awaitPartitionMapExchange();\n \n@@ -1009,6 +1015,58 @@ public void testAffinityAssignmentChangedAfterRestart() throws Exception {\n             assertEquals(\"k=\" + k, Integer.valueOf(k), cache.get(k));\n     }\n \n+    /**\n+     * Verify that in case of setting baseline topology with offline node among others\n+     * {@link IgniteException} is thrown.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings({\"unchecked\", \"ThrowableNotThrown\"})\n+    public void testSettingBaselineTopologyWithOfflineNode() throws Exception {\n+        Ignite ignite = startGrids(2);\n+\n+        ignite.cluster().active(true);\n+\n+        ignite(0).createCache(defaultCacheConfiguration().setNodeFilter(\n+            (IgnitePredicate<ClusterNode>)node -> node.attribute(\"some-attr\") != null));\n+\n+        Collection<ClusterNode> nodes = new ArrayList<>(ignite.cluster().nodes());\n+        nodes.add(new DetachedClusterNode(\"non-existing-node-id\", null));\n+\n+        GridTestUtils.assertThrows(log, (Callable<Void>)() -> {\n+            ignite.cluster().setBaselineTopology(nodes);\n+\n+            return null;\n+        }, IgniteException.class, \"Check arguments. Node with consistent ID [non-existing-node-id] \" +\n+            \"not found in server nodes.\");\n+    }\n+\n+    /**\n+     * Verify that in case of setting baseline topology with offline node among others {@link IgniteException} is\n+     * thrown.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings({\"unchecked\", \"ThrowableNotThrown\"})\n+    public void testSettingBaselineTopologyWithOfflineNodeFromOldTopology() throws Exception {\n+        Ignite ignite = startGrids(2);\n+\n+        ignite.cluster().active(true);\n+\n+        stopGrid(1);\n+\n+        ignite.cluster().setBaselineTopology(ignite.cluster().topologyVersion());\n+\n+        GridTestUtils.assertThrows(log, (Callable<Void>)() -> {\n+            ignite.cluster().setBaselineTopology(ignite.cluster().topologyVersion() - 1);\n+\n+            return null;\n+        }, IgniteException.class, \"Check arguments. Node with consistent ID \" +\n+            \"[distributed.CacheBaselineTopologyTest1] not found in server nodes.\");\n+    }\n+\n     /** */\n     private Collection<BaselineNode> baselineNodes(Collection<ClusterNode> clNodes) {\n         Collection<BaselineNode> res = new ArrayList<>(clNodes.size());",
                "raw_url": "https://github.com/apache/ignite/raw/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/distributed/CacheBaselineTopologyTest.java",
                "sha": "6d80c1963aff20835b40160a55d70701c3b27498",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgniteBaselineAffinityTopologyActivationTest.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgniteBaselineAffinityTopologyActivationTest.java?ref=e7864f198539f87a38e993cc68f0931dca195534",
                "deletions": 33,
                "filename": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgniteBaselineAffinityTopologyActivationTest.java",
                "patch": "@@ -758,39 +758,6 @@ public void testActivationHashIsNotUpdatedOnMultipleActivationRequests() throws\n         verifyBaselineTopologyOnNodes(verifier, new Ignite[] {nodeA, nodeB});\n     }\n \n-    /**\n-     * Verifies that grid is autoactivated when full BaselineTopology is preset even on one node\n-     * and then all other nodes from BaselineTopology are started.\n-     */\n-    @Test\n-    public void testAutoActivationWithBaselineTopologyPreset() throws Exception {\n-        Ignite ig = startGridWithConsistentId(\"A\");\n-\n-        ig.cluster().active(true);\n-\n-        ig.cluster().setBaselineTopology(Arrays.asList(new BaselineNode[] {\n-            createBaselineNodeWithConsId(\"A\"), createBaselineNodeWithConsId(\"B\"), createBaselineNodeWithConsId(\"C\")}));\n-\n-        stopAllGrids();\n-\n-        final Ignite ig1 = startGridWithConsistentId(\"A\");\n-\n-        startGridWithConsistentId(\"B\");\n-\n-        startGridWithConsistentId(\"C\");\n-\n-        boolean activated = GridTestUtils.waitForCondition(\n-            new GridAbsPredicate() {\n-               @Override public boolean apply() {\n-                   return ig1.cluster().active();\n-               }\n-            },\n-            10_000\n-        );\n-\n-        assertTrue(activated);\n-    }\n-\n     /**\n      * Creates BaselineNode with specific attribute indicating that this node is not client.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/test/java/org/apache/ignite/internal/processors/cache/persistence/IgniteBaselineAffinityTopologyActivationTest.java",
                "sha": "6fec27081c0dc9a18c04c8ec0b300223feb25f70",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/ignite/blob/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java?ref=e7864f198539f87a38e993cc68f0931dca195534",
                "deletions": 0,
                "filename": "modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "patch": "@@ -54,6 +54,7 @@\n import org.apache.ignite.IgniteCheckedException;\n import org.apache.ignite.IgniteCluster;\n import org.apache.ignite.IgniteDataStreamer;\n+import org.apache.ignite.IgniteException;\n import org.apache.ignite.cache.affinity.rendezvous.RendezvousAffinityFunction;\n import org.apache.ignite.cluster.BaselineNode;\n import org.apache.ignite.cluster.ClusterNode;\n@@ -2702,6 +2703,26 @@ public void testUnusedWalDelete() throws Exception {\n         assertNotContains(log, out, \"error\");\n     }\n \n+    /**\n+     * Verify that in case of setting baseline topology with offline node among others\n+     * {@link IgniteException} is thrown.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings(\"unchecked\")\n+    public void setConsistenceIdsWithOfflineBaselineNode() throws Exception {\n+        Ignite ignite = startGrids(2);\n+\n+        ignite.cluster().active(true);\n+\n+        ignite(0).createCache(defaultCacheConfiguration().setNodeFilter(\n+            (IgnitePredicate<ClusterNode>)node -> node.attribute(\"some-attr\") != null));\n+\n+        assertEquals(EXIT_CODE_UNEXPECTED_ERROR,\n+            execute(\"--baseline\", \"set\", \"non-existing-node-id ,\" + consistentIds(ignite)));\n+    }\n+\n     /**\n      * Test execution of --diagnostic command.\n      *",
                "raw_url": "https://github.com/apache/ignite/raw/e7864f198539f87a38e993cc68f0931dca195534/modules/core/src/test/java/org/apache/ignite/util/GridCommandHandlerTest.java",
                "sha": "983395017a3f88341fc538195c89f6eb2569c795",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/ignite/blob/e7864f198539f87a38e993cc68f0931dca195534/modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/PersistenceTest.cs",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/PersistenceTest.cs?ref=e7864f198539f87a38e993cc68f0931dca195534",
                "deletions": 13,
                "filename": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/PersistenceTest.cs",
                "patch": "@@ -250,27 +250,29 @@ public void TestBaselineTopology()\n                 var ex = Assert.Throws<IgniteException>(() => cluster.SetBaselineTopology(2));\n                 Assert.AreEqual(\"Changing BaselineTopology on inactive cluster is not allowed.\", ex.Message);\n \n-                // Set with version.\n                 cluster.SetActive(true);\n-                cluster.SetBaselineTopology(2);\n \n-                var res = cluster.GetBaselineTopology();\n-                CollectionAssert.AreEquivalent(new[] {\"node1\", \"node2\"}, res.Select(x => x.ConsistentId));\n+                // Can not set baseline with offline node.\n+                ex = Assert.Throws<IgniteException>(() => cluster.SetBaselineTopology(2));\n+                Assert.AreEqual(\"Check arguments. Node with consistent ID [node2] not found in server nodes.\",\n+                    ex.Message);\n \n                 cluster.SetBaselineTopology(1);\n                 Assert.AreEqual(\"node1\", cluster.GetBaselineTopology().Single().ConsistentId);\n \n-                // Set with nodes.\n-                cluster.SetBaselineTopology(res);\n-                \n-                res = cluster.GetBaselineTopology();\n-                CollectionAssert.AreEquivalent(new[] { \"node1\", \"node2\" }, res.Select(x => x.ConsistentId));\n+                // Set with node.\n+                cluster.SetBaselineTopology(cluster.GetBaselineTopology());\n+\n+                var res = cluster.GetBaselineTopology();\n+                CollectionAssert.AreEquivalent(new[] { \"node1\"}, res.Select(x => x.ConsistentId));\n \n                 cluster.SetBaselineTopology(cluster.GetTopology(1));\n                 Assert.AreEqual(\"node1\", cluster.GetBaselineTopology().Single().ConsistentId);\n \n-                // Set to two nodes.\n-                cluster.SetBaselineTopology(cluster.GetTopology(2));\n+                // Can not set baseline with offline node.\n+                ex = Assert.Throws<IgniteException>(() => cluster.SetBaselineTopology(cluster.GetTopology(2)));\n+                Assert.AreEqual(\"Check arguments. Node with consistent ID [node2] not found in server nodes.\",\n+                  ex.Message);\n             }\n \n             // Check auto activation on cluster restart.\n@@ -279,9 +281,9 @@ public void TestBaselineTopology()\n             {\n                 var cluster = ignite.GetCluster();\n                 Assert.IsTrue(cluster.IsActive());\n-                \n+\n                 var res = cluster.GetBaselineTopology();\n-                CollectionAssert.AreEquivalent(new[] { \"node1\", \"node2\" }, res.Select(x => x.ConsistentId));\n+                CollectionAssert.AreEquivalent(new[] { \"node1\"}, res.Select(x => x.ConsistentId));\n             }\n \n             Environment.SetEnvironmentVariable(\"IGNITE_BASELINE_AUTO_ADJUST_ENABLED\", null);",
                "raw_url": "https://github.com/apache/ignite/raw/e7864f198539f87a38e993cc68f0931dca195534/modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/PersistenceTest.cs",
                "sha": "e5acbdf159211fc4b0d005b45546e5a18f4d8992",
                "status": "modified"
            }
        ],
        "message": "IGNITE-12036 Changing baseline via set command may cause NPEs if configured NodeFilter takes node attributes into account - Fixes #6743.\n\nSigned-off-by: Ivan Rakov <irakov@apache.org>",
        "parent": "https://github.com/apache/ignite/commit/1392332d84a1fc21700292ef4d16d028b23f01de",
        "patched_files": [
            "IgniteClusterImpl.java",
            "DetachedClusterNode.java",
            "PersistenceTest.cs"
        ],
        "repo": "ignite",
        "unit_tests": [
            "IgniteBaselineAffinityTopologyActivationTest.java",
            "CacheBaselineTopologyTest.java",
            "GridCommandHandlerTest.java"
        ]
    },
    "ignite_f2a5a93": {
        "bug_id": "ignite_f2a5a93",
        "commit": "https://github.com/apache/ignite/commit/f2a5a93f0748f905ede77ff84787947a0893c3f8",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/ignite/blob/f2a5a93f0748f905ede77ff84787947a0893c3f8/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java?ref=f2a5a93f0748f905ede77ff84787947a0893c3f8",
                "deletions": 7,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "patch": "@@ -1014,14 +1014,21 @@ private void copyInBuffer(long absPtr, ByteBuffer tmpBuf) {\n     @Override public long loadedPages() {\n         long total = 0;\n \n-        for (Segment seg : segments) {\n-            seg.readLock().lock();\n+        Segment[] segments = this.segments;\n \n-            try {\n-                total += seg.loadedPages.size();\n-            }\n-            finally {\n-                seg.readLock().unlock();\n+        if (segments != null) {\n+            for (Segment seg : segments) {\n+                if (seg == null)\n+                    break;\n+\n+                seg.readLock().lock();\n+\n+                try {\n+                    total += seg.loadedPages.size();\n+                }\n+                finally {\n+                    seg.readLock().unlock();\n+                }\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/ignite/raw/f2a5a93f0748f905ede77ff84787947a0893c3f8/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/pagemem/PageMemoryImpl.java",
                "sha": "6bb5c337db0f90056259b2699753771461259513",
                "status": "modified"
            }
        ],
        "message": "Quick fix for NPE in PageMemoryImpl.loadedPages",
        "parent": "https://github.com/apache/ignite/commit/fd09d301b14a2e20774503359bcef4280a67da92",
        "patched_files": [
            "PageMemoryImpl.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "PageMemoryImplTest.java"
        ]
    },
    "ignite_f2f5dc9": {
        "bug_id": "ignite_f2f5dc9",
        "commit": "https://github.com/apache/ignite/commit/f2f5dc99895d1a44ad2803e79b03985b8054b51a",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/ignite/blob/f2f5dc99895d1a44ad2803e79b03985b8054b51a/modules/core/src/main/java/org/apache/ignite/internal/IgnitionEx.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/IgnitionEx.java?ref=f2f5dc99895d1a44ad2803e79b03985b8054b51a",
                "deletions": 3,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/IgnitionEx.java",
                "patch": "@@ -2367,12 +2367,12 @@ private synchronized void stop0(boolean cancel) {\n \n                     shutdownHook = null;\n \n-                    if (log.isDebugEnabled())\n+                    if (log != null && log.isDebugEnabled())\n                         log.debug(\"Shutdown hook is removed.\");\n                 }\n                 catch (IllegalStateException e) {\n                     // Shutdown is in progress...\n-                    if (log.isDebugEnabled())\n+                    if (log != null && log.isDebugEnabled())\n                         log.debug(\"Shutdown is in progress (ignoring): \" + e.getMessage());\n                 }\n \n@@ -2382,7 +2382,7 @@ private synchronized void stop0(boolean cancel) {\n             try {\n                 grid0.stop(cancel);\n \n-                if (log.isDebugEnabled())\n+                if (log != null && log.isDebugEnabled())\n                     log.debug(\"Grid instance stopped ok: \" + name);\n             }\n             catch (Throwable e) {",
                "raw_url": "https://github.com/apache/ignite/raw/f2f5dc99895d1a44ad2803e79b03985b8054b51a/modules/core/src/main/java/org/apache/ignite/internal/IgnitionEx.java",
                "sha": "cead53bfe83a5dc0bb1da4fecc4b4626ac5c5aa7",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/f2f5dc99895d1a44ad2803e79b03985b8054b51a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEntry.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEntry.java?ref=f2f5dc99895d1a44ad2803e79b03985b8054b51a",
                "deletions": 2,
                "filename": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEntry.java",
                "patch": "@@ -221,8 +221,8 @@ CacheContinuousQueryEntry forBackupQueue() {\n         if (!isFiltered())\n             return this;\n \n-        CacheContinuousQueryEntry e =\n-            new CacheContinuousQueryEntry(cacheId, null, null, null, null, keepBinary, part, updateCntr, null);\n+        CacheContinuousQueryEntry e = new CacheContinuousQueryEntry(\n+                cacheId, null, null, null, null, keepBinary, part, updateCntr, topVer);\n \n         e.flags = flags;\n ",
                "raw_url": "https://github.com/apache/ignite/raw/f2f5dc99895d1a44ad2803e79b03985b8054b51a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEntry.java",
                "sha": "9ac9b93cf48e06c143f966237b9d2bd58cad51e7",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/ignite/blob/f2f5dc99895d1a44ad2803e79b03985b8054b51a/modules/kafka/src/test/java/org/apache/ignite/stream/kafka/TestKafkaBroker.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/kafka/src/test/java/org/apache/ignite/stream/kafka/TestKafkaBroker.java?ref=f2f5dc99895d1a44ad2803e79b03985b8054b51a",
                "deletions": 1,
                "filename": "modules/kafka/src/test/java/org/apache/ignite/stream/kafka/TestKafkaBroker.java",
                "patch": "@@ -56,7 +56,7 @@\n     private static final String BROKER_HOST = \"localhost\";\n \n     /** Broker port. */\n-    private static final int BROKER_PORT = 9092;\n+    private static final int BROKER_PORT = 11092;\n \n     /** Kafka config. */\n     private KafkaConfig kafkaCfg;",
                "raw_url": "https://github.com/apache/ignite/raw/f2f5dc99895d1a44ad2803e79b03985b8054b51a/modules/kafka/src/test/java/org/apache/ignite/stream/kafka/TestKafkaBroker.java",
                "sha": "30f02c84fa52c604a5f5ac0b4c8be9856c2ace69",
                "status": "modified"
            }
        ],
        "message": "ignite-db-x fix collectEntries assert error, Ignite Streamers suit, testReconnectClusterRestartMultinode  NPE",
        "parent": "https://github.com/apache/ignite/commit/8dd2181f5f914677b18dd43ca24025f471c7f081",
        "patched_files": [
            "CacheContinuousQueryEntry.java",
            "IgnitionEx.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "TestKafkaBroker.java"
        ]
    },
    "ignite_f8824c8": {
        "bug_id": "ignite_f8824c8",
        "commit": "https://github.com/apache/ignite/commit/f8824c86112c99f5f9657d86a3f0aa53777b1f17",
        "file": [
            {
                "additions": 52,
                "blob_url": "https://github.com/apache/ignite/blob/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/main/java/org/apache/ignite/logger/log4j2/Log4J2Logger.java",
                "changes": 130,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/main/java/org/apache/ignite/logger/log4j2/Log4J2Logger.java?ref=f8824c86112c99f5f9657d86a3f0aa53777b1f17",
                "deletions": 78,
                "filename": "modules/log4j2/src/main/java/org/apache/ignite/logger/log4j2/Log4J2Logger.java",
                "patch": "@@ -42,10 +42,8 @@\n import org.apache.logging.log4j.core.appender.RollingFileAppender;\n import org.apache.logging.log4j.core.appender.routing.RoutingAppender;\n import org.apache.logging.log4j.core.config.AppenderControl;\n-import org.apache.logging.log4j.core.config.AppenderRef;\n import org.apache.logging.log4j.core.config.Configuration;\n import org.apache.logging.log4j.core.config.Configurator;\n-import org.apache.logging.log4j.core.config.LoggerConfig;\n import org.apache.logging.log4j.core.layout.PatternLayout;\n import org.jetbrains.annotations.Nullable;\n \n@@ -102,11 +100,6 @@\n     @SuppressWarnings(\"FieldAccessedSynchronizedAndUnsynchronized\")\n     private Logger impl;\n \n-    /** Auto added at verbose mode console logger (nullable). */\n-    @GridToStringExclude\n-    @SuppressWarnings(\"FieldAccessedSynchronizedAndUnsynchronized\")\n-    private Logger consoleLog;\n-\n     /** Quiet flag. */\n     private final boolean quiet;\n \n@@ -117,30 +110,33 @@\n      * Creates new logger with given implementation.\n      *\n      * @param impl Log4j implementation to use.\n-     * @param consoleLog Cosole logger (optional).\n      */\n-    private Log4J2Logger(final Logger impl, @Nullable final Logger consoleLog) {\n+    private Log4J2Logger(final Logger impl) {\n         assert impl != null;\n-        this.impl = impl;\n-        this.consoleLog = consoleLog;\n+        \n+        addConsoleAppenderIfNeeded(new C1<Boolean, Logger>() {\n+            @Override public Logger apply(Boolean init) {\n+                return impl;\n+            }\n+        });\n \n         quiet = quiet0;\n     }\n \n     /**\n      * Creates new logger with given configuration {@code path}.\n      *\n-     * @param path Path to log4j configuration XML file.\n+     * @param path Path to log4j2 configuration XML file.\n      * @throws IgniteCheckedException Thrown in case logger can't be created.\n      */\n     public Log4J2Logger(String path) throws IgniteCheckedException {\n         if (path == null)\n-            throw new IgniteCheckedException(\"Configuration XML file for Log4j must be specified.\");\n+            throw new IgniteCheckedException(\"Configuration XML file for Log4j2 must be specified.\");\n \n         final URL cfgUrl = U.resolveIgniteUrl(path);\n \n         if (cfgUrl == null)\n-            throw new IgniteCheckedException(\"Log4j configuration path was not found: \" + path);\n+            throw new IgniteCheckedException(\"Log4j2 configuration path was not found: \" + path);\n \n         addConsoleAppenderIfNeeded(new C1<Boolean, Logger>() {\n             @Override public Logger apply(Boolean init) {\n@@ -204,18 +200,16 @@ public Log4J2Logger(final URL cfgUrl) throws IgniteCheckedException {\n     }\n \n     /**\n-     * Sets level for internal log4j implementation.\n-     *\n-     * @param level Log level to set.\n+     * Cleans up the logger configuration. Should be used in unit tests only for sequential tests run with\n+     * different configurations\n      */\n-    public void setLevel(Level level) {\n-        LoggerContext ctx = (LoggerContext)LogManager.getContext(false);\n-\n-        Configuration conf = ctx.getConfiguration();\n-\n-        conf.getLoggerConfig(impl.getName()).setLevel(level);\n+    static void cleanup() {\n+        synchronized (mux) {\n+            if (inited)\n+                LogManager.shutdown();\n \n-        ctx.updateLoggers(conf);\n+            inited = false;\n+        }\n     }\n \n     /** {@inheritDoc} */\n@@ -242,10 +236,10 @@ public void setLevel(Level level) {\n                             Appender innerApp = control.getAppender();\n \n                             if (innerApp instanceof FileAppender)\n-                                return normilize(((FileAppender)innerApp).getFileName());\n+                                return normalize(((FileAppender)innerApp).getFileName());\n \n                             if (innerApp instanceof RollingFileAppender)\n-                                return normilize(((RollingFileAppender)innerApp).getFileName());\n+                                return normalize(((RollingFileAppender)innerApp).getFileName());\n                         }\n                     }\n                     catch (IllegalAccessException | NoSuchFieldException e) {\n@@ -265,7 +259,7 @@ public void setLevel(Level level) {\n      * @param path Path.\n      * @return Normalized path.\n      */\n-    private String normilize(String path) {\n+    private String normalize(String path) {\n         if (!U.isWindows())\n             return path;\n \n@@ -335,7 +329,7 @@ private void addConsoleAppenderIfNeeded(@Nullable IgniteClosure<Boolean, Logger>\n \n                 // User launched ignite in verbose mode and did not add console appender with INFO level\n                 // to configuration and did not set IGNITE_CONSOLE_APPENDER to false.\n-                consoleLog = createConsoleLogger();\n+                createConsoleLogger();\n             }\n \n             quiet0 = quiet;\n@@ -348,45 +342,34 @@ private void addConsoleAppenderIfNeeded(@Nullable IgniteClosure<Boolean, Logger>\n      *\n      * @return Logger with auto configured console appender.\n      */\n-    public static Logger createConsoleLogger() {\n-        LoggerContext ctx = (LoggerContext)LogManager.getContext(true);\n+    public Logger createConsoleLogger() {\n+        // from http://logging.apache.org/log4j/2.x/manual/customconfig.html\n+        final LoggerContext ctx = impl.getContext();\n \n-        Configuration cfg = ctx.getConfiguration();\n+        final Configuration cfg = ctx.getConfiguration();\n \n-        PatternLayout.Builder builder = PatternLayout.newBuilder();\n-\n-        builder\n+        PatternLayout.Builder builder = PatternLayout.newBuilder()\n             .withPattern(\"%d{ISO8601}][%-5p][%t][%c{1}] %m%n\")\n             .withCharset(Charset.defaultCharset())\n             .withAlwaysWriteExceptions(false)\n             .withNoConsoleNoAnsi(false);\n \n         PatternLayout layout = builder.build();\n \n-        ConsoleAppender.Builder consoleAppenderBuilder = ConsoleAppender.newBuilder();\n-\n-        consoleAppenderBuilder\n+        ConsoleAppender.Builder consoleAppenderBuilder = ConsoleAppender.newBuilder()\n             .withName(CONSOLE_APPENDER)\n             .withLayout(layout);\n \n         ConsoleAppender consoleApp = consoleAppenderBuilder.build();\n \n         consoleApp.start();\n \n-        AppenderRef ref = AppenderRef.createAppenderRef(CONSOLE_APPENDER, Level.TRACE, null);\n-\n-        AppenderRef[] refs = {ref};\n-\n-        LoggerConfig logCfg = LoggerConfig.createLogger(false, Level.INFO, LogManager.ROOT_LOGGER_NAME, \"\", refs, null, null, null);\n-\n-        logCfg.addAppender(consoleApp, null, null);\n         cfg.addAppender(consoleApp);\n-\n-        cfg.addLogger(LogManager.ROOT_LOGGER_NAME, logCfg);\n+        cfg.getRootLogger().addAppender(consoleApp, Level.TRACE, null);\n \n         ctx.updateLoggers(cfg);\n \n-        return (Logger)LogManager.getContext().getLogger(LogManager.ROOT_LOGGER_NAME);\n+        return ctx.getRootLogger();\n     }\n \n     /** {@inheritDoc} */\n@@ -398,7 +381,22 @@ public static Logger createConsoleLogger() {\n         // Set nodeId as system variable to be used at configuration.\n         System.setProperty(NODE_ID, U.id8(nodeId));\n \n-        ((LoggerContext)LogManager.getContext(false)).reconfigure();\n+        if (inited) {\n+            final LoggerContext ctx = impl.getContext();\n+\n+            synchronized (mux) {\n+                inited = false;\n+            }\n+\n+            addConsoleAppenderIfNeeded(new C1<Boolean, Logger>() {\n+                @Override public Logger apply(Boolean init) {\n+                    if (init)\n+                        ctx.reconfigure();\n+\n+                    return (Logger)LogManager.getRootLogger();\n+                }\n+            });\n+        }\n     }\n \n     /** {@inheritDoc} */\n@@ -417,20 +415,17 @@ public static Logger createConsoleLogger() {\n      */\n     @Override public Log4J2Logger getLogger(Object ctgr) {\n         if (ctgr == null)\n-            return new Log4J2Logger((Logger)LogManager.getRootLogger(),\n-                consoleLog == null ? null : (Logger)LogManager.getContext().getLogger(\"\"));\n+            return new Log4J2Logger((Logger)LogManager.getRootLogger());\n \n         if (ctgr instanceof Class) {\n             String name = ((Class<?>)ctgr).getName();\n \n-            return new Log4J2Logger((Logger)LogManager.getLogger(name),\n-                consoleLog == null ? null : (Logger)LogManager.getContext().getLogger(name));\n+            return new Log4J2Logger((Logger)LogManager.getLogger(name));\n         }\n \n         String name = ctgr.toString();\n \n-        return new Log4J2Logger((Logger)LogManager.getLogger(name),\n-            consoleLog == null ? null : (Logger)LogManager.getContext().getLogger(name));\n+        return new Log4J2Logger((Logger)LogManager.getLogger(name));\n     }\n \n     /** {@inheritDoc} */\n@@ -439,9 +434,6 @@ public static Logger createConsoleLogger() {\n             warning(\"Logging at TRACE level without checking if TRACE level is enabled: \" + msg);\n \n         impl.trace(msg);\n-\n-        if (consoleLog != null)\n-            consoleLog.trace(msg);\n     }\n \n     /** {@inheritDoc} */\n@@ -450,9 +442,6 @@ public static Logger createConsoleLogger() {\n             warning(\"Logging at DEBUG level without checking if DEBUG level is enabled: \" + msg);\n \n         impl.debug(msg);\n-\n-        if (consoleLog != null)\n-            consoleLog.debug(msg);\n     }\n \n     /** {@inheritDoc} */\n@@ -461,56 +450,41 @@ public static Logger createConsoleLogger() {\n             warning(\"Logging at INFO level without checking if INFO level is enabled: \" + msg);\n \n         impl.info(msg);\n-\n-        if (consoleLog != null)\n-            consoleLog.info(msg);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void warning(String msg) {\n         impl.warn(msg);\n-\n-        if (consoleLog != null)\n-            consoleLog.warn(msg);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void warning(String msg, @Nullable Throwable e) {\n         impl.warn(msg, e);\n-\n-        if (consoleLog != null)\n-            consoleLog.warn(msg, e);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void error(String msg) {\n         impl.error(msg);\n-\n-        if (consoleLog != null)\n-            consoleLog.error(msg);\n     }\n \n     /** {@inheritDoc} */\n     @Override public void error(String msg, @Nullable Throwable e) {\n         impl.error(msg, e);\n-\n-        if (consoleLog != null)\n-            consoleLog.error(msg, e);\n     }\n \n     /** {@inheritDoc} */\n     @Override public boolean isTraceEnabled() {\n-        return impl.isTraceEnabled() || (consoleLog != null && consoleLog.isTraceEnabled());\n+        return impl.isTraceEnabled();\n     }\n \n     /** {@inheritDoc} */\n     @Override public boolean isDebugEnabled() {\n-        return impl.isDebugEnabled() || (consoleLog != null && consoleLog.isDebugEnabled());\n+        return impl.isDebugEnabled();\n     }\n \n     /** {@inheritDoc} */\n     @Override public boolean isInfoEnabled() {\n-        return impl.isInfoEnabled() || (consoleLog != null && consoleLog.isInfoEnabled());\n+        return impl.isInfoEnabled();\n     }\n \n     /** {@inheritDoc} */",
                "raw_url": "https://github.com/apache/ignite/raw/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/main/java/org/apache/ignite/logger/log4j2/Log4J2Logger.java",
                "sha": "5c92afaae90df93832b72576056bb99aee8c4452",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2CorrectFileNameTest.java",
                "changes": 94,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2CorrectFileNameTest.java?ref=6679b6cbe6a26f8e9ba2a02bcf56801811e99abd",
                "deletions": 94,
                "filename": "modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2CorrectFileNameTest.java",
                "patch": "@@ -1,94 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.ignite.logger.log4j2;\n-\n-import java.io.File;\n-import junit.framework.TestCase;\n-import org.apache.ignite.Ignite;\n-import org.apache.ignite.configuration.IgniteConfiguration;\n-import org.apache.ignite.internal.util.typedef.G;\n-import org.apache.ignite.internal.util.typedef.internal.U;\n-import org.apache.ignite.testframework.GridTestUtils;\n-import org.apache.ignite.testframework.junits.common.GridCommonTest;\n-\n-/**\n- * Tests that several grids log to files with correct names.\n- */\n-@GridCommonTest(group = \"Logger\")\n-public class GridLog4j2CorrectFileNameTest extends TestCase {\n-\n-    /**\n-     * Tests correct behaviour in case 2 local nodes are started.\n-     *\n-     * @throws Exception If error occurs.\n-     */\n-    public void testLogFilesTwoNodes() throws Exception {\n-        checkOneNode(0);\n-        checkOneNode(1);\n-    }\n-\n-    /**\n-     * Starts the local node and checks for presence of log file. Also checks\n-     * that this is really a log of a started node.\n-     * \n-     * @param id Test-local node ID.\n-     * @throws Exception If error occurred.\n-     */\n-    private void checkOneNode(int id) throws Exception {\n-        try (Ignite ignite = G.start(getConfiguration(\"grid\" + id))) {\n-            String id8 = U.id8(ignite.cluster().localNode().id());\n-            String logPath = \"work/log/ignite-\" + id8 + \".log\";\n-            File logFile = U.resolveIgnitePath(logPath);\n-            assertNotNull(\"Failed to resolve path: \" + logPath, logFile);\n-            assertTrue(\"Log file does not exist: \" + logFile, logFile.exists());\n-            // We have a row in log with the following content\n-            // con >>> Local node [ID=NodeId ]\n-            String logContent = U.readFileToString(logFile.getAbsolutePath(),\n-                    \"UTF-8\");\n-            assertTrue(\n-                    \"Log file does not contain it's node ID: \" + logFile,\n-                    logContent.contains(\">>> Local node [ID=\"\n-                            + id8.toUpperCase()));\n-        }\n-    }\n-\n-    /**\n-     * Creates grid configuration.\n-     *\n-     * @param igniteInstanceName Ignite instance name.\n-     * @return Grid configuration.\n-     * @throws Exception If error occurred.\n-     */\n-    private static IgniteConfiguration getConfiguration(String igniteInstanceName)\n-            throws Exception {\n-        IgniteConfiguration cfg = new IgniteConfiguration();\n-        \n-   \n-        cfg.setIgniteInstanceName(igniteInstanceName);\n-        // We need of a configuration file passed in\n-        File xml = GridTestUtils\n-                .resolveIgnitePath(\"modules/core/src/test/config/log4j2-test.xml\");\n-\n-        assert xml != null;\n-        assert xml.exists() == true;\n-\n-        cfg.setGridLogger(new Log4J2Logger(xml));\n-        cfg.setConnectorConfiguration(null);\n-\n-        return cfg;\n-    }\n-}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/ignite/raw/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2CorrectFileNameTest.java",
                "sha": "b56be27f07d86a589797e63fb09c6df8bf91a342",
                "status": "removed"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2InitializedTest.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2InitializedTest.java?ref=6679b6cbe6a26f8e9ba2a02bcf56801811e99abd",
                "deletions": 77,
                "filename": "modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2InitializedTest.java",
                "patch": "@@ -1,77 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package org.apache.ignite.logger.log4j2;\n-\n-import java.net.URL;\n-import java.util.UUID;\n-import junit.framework.TestCase;\n-import org.apache.ignite.IgniteCheckedException;\n-import org.apache.ignite.IgniteLogger;\n-import org.apache.ignite.configuration.IgniteConfiguration;\n-import org.apache.ignite.internal.util.typedef.internal.U;\n-import org.apache.ignite.testframework.junits.common.GridCommonTest;\n-\n-/**\n- * Log4j initialized test.\n- */\n-@GridCommonTest(group = \"Logger\")\n-public class GridLog4j2InitializedTest extends TestCase {\n-\n-    /**\n-     * @throws Exception If failed.\n-     */\n-    @Override protected void setUp() throws Exception {\n-\n-    }\n-\n-    /** */\n-    public void testLogInitialize() {\n-\n-        IgniteConfiguration cfg = new IgniteConfiguration();\n-\n-        cfg.setIgniteInstanceName(\"grid\" + 1);\n-        cfg.setNodeId(new UUID(1, 1));\n-        // cfg.setIgniteHome(\"/home/glutters/Documenti/apache-ignite/ignite-master/ignite/\");\n-\n-        URL xml = U.resolveIgniteUrl(\"config/ignite-log4j2.xml\");\n-        IgniteLogger log;\n-        try {\n-\n-            log = new Log4J2Logger(xml);\n-            // log.isQuiet();\n-            cfg.setGridLogger(log);\n-        } catch (IgniteCheckedException e) {\n-            e.printStackTrace();\n-            return;\n-        }\n-\n-        assert log.isInfoEnabled() == true;\n-\n-        if (log.isDebugEnabled())\n-            log.debug(\"This is 'debug' message.\");\n-\n-        log.info(\"This is 'info' message.\");\n-        log.warning(\"This is 'warning' message.\");\n-        log.warning(\"This is 'warning' message.\", new Exception(\n-                \"It's a test warning exception\"));\n-        log.error(\"This is 'error' message.\");\n-\n-        assert log.getLogger(GridLog4j2InitializedTest.class.getName()) instanceof Log4J2Logger;\n-    }\n-\n-}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/ignite/raw/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2InitializedTest.java",
                "sha": "4758e0a6a1e238229d8cc67a887c3d1ffa353e8c",
                "status": "removed"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/ignite/blob/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2LoggingFileTest.java",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2LoggingFileTest.java?ref=6679b6cbe6a26f8e9ba2a02bcf56801811e99abd",
                "deletions": 68,
                "filename": "modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2LoggingFileTest.java",
                "patch": "@@ -1,68 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package org.apache.ignite.logger.log4j2;\n-\n-import java.io.File;\n-import java.util.UUID;\n-import junit.framework.TestCase;\n-import org.apache.ignite.IgniteLogger;\n-import org.apache.ignite.logger.LoggerNodeIdAware;\n-import org.apache.ignite.testframework.GridTestUtils;\n-import org.junit.Test;\n-\n-/**\n- * Grid Log4j SPI test.\n- */\n-public class GridLog4j2LoggingFileTest extends TestCase {\n-    /** */\n-    private IgniteLogger log;\n-\n-    /** {@inheritDoc} */\n-    @Override protected void setUp() throws Exception {\n-        \n-\n-        File xml = GridTestUtils\n-                .resolveIgnitePath(\"modules/core/src/test/config/log4j2-test.xml\");\n-\n-        assert xml != null;\n-        assert xml.exists() == true;\n-\n-        log = new Log4J2Logger(xml).getLogger(getClass());\n-        ((LoggerNodeIdAware) log).setNodeId(UUID.randomUUID());\n-\n-    }\n-\n-    /**\n-     * Tests log4j logging SPI.\n-     */\n-    @Test\n-    public void testLog() {\n-        assert log.isDebugEnabled() == true;\n-        assert log.isInfoEnabled() == true;\n-\n-        log.debug(\"This is 'debug' message.\");\n-        log.info(\"This is 'info' message.\");\n-        log.warning(\"This is 'warning' message.\");\n-        log.warning(\"This is 'warning' message.\", new Exception(\n-                \"It's a test warning exception\"));\n-        log.error(\"This is 'error' message.\");\n-        log.error(\"This is 'error' message.\", new Exception(\n-                \"It's a test error exception\"));\n-    }\n-\n-}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/ignite/raw/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/GridLog4j2LoggingFileTest.java",
                "sha": "5c19de065005a9e2b2b5acfeffcc042d9437370a",
                "status": "removed"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/ignite/blob/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerSelfTest.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerSelfTest.java?ref=f8824c86112c99f5f9657d86a3f0aa53777b1f17",
                "deletions": 0,
                "filename": "modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerSelfTest.java",
                "patch": "@@ -41,6 +41,13 @@\n     /** */\n     private static final String LOG_PATH_MAIN = \"config/ignite-log4j2.xml\";\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Override protected void setUp() throws Exception {\n+        Log4J2Logger.cleanup();\n+    }\n+\n     /**\n      * @throws Exception If failed.\n      */",
                "raw_url": "https://github.com/apache/ignite/raw/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerSelfTest.java",
                "sha": "a5564da01175ab485e54a22161fad60bfec47a4d",
                "status": "modified"
            },
            {
                "additions": 47,
                "blob_url": "https://github.com/apache/ignite/blob/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerVerboseModeSelfTest.java",
                "changes": 71,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerVerboseModeSelfTest.java?ref=f8824c86112c99f5f9657d86a3f0aa53777b1f17",
                "deletions": 24,
                "filename": "modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerVerboseModeSelfTest.java",
                "patch": "@@ -18,6 +18,7 @@\n package org.apache.ignite.logger.log4j2;\n \n import java.io.ByteArrayOutputStream;\n+import java.io.File;\n import java.io.PrintStream;\n import java.util.Collections;\n import junit.framework.TestCase;\n@@ -26,17 +27,26 @@\n import org.apache.ignite.internal.util.typedef.G;\n import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n import org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder;\n+import org.apache.ignite.testframework.GridTestUtils;\n import org.apache.logging.log4j.Level;\n \n /**\n  * Grid Log4j2 SPI test.\n  */\n public class Log4j2LoggerVerboseModeSelfTest extends TestCase {\n     /** */\n-    public static final String LOG_PATH_VERBOSE_TEST = \"modules/core/src/test/config/log4j2-verbose-test.xml\";\n+    private static final String LOG_PATH_VERBOSE_TEST = \"modules/core/src/test/config/log4j2-verbose-test.xml\";\n \n     /**\n-     * Test does not work after another tests. Can be run from IDE as separate test.\n+     * @throws Exception If failed.\n+     */\n+    @Override protected void setUp() throws Exception {\n+        Log4J2Logger.cleanup();\n+\n+    }\n+\n+    /**\n+     * Test works fine after other tests. Please do not forget to call Log4J2Logger.cleanup()\n      *\n      * @throws Exception If failed.\n      */\n@@ -47,49 +57,58 @@ public void testVerboseMode() throws Exception {\n         final ByteArrayOutputStream testOut = new ByteArrayOutputStream();\n         final ByteArrayOutputStream testErr = new ByteArrayOutputStream();\n \n+        String consoleOut = \"Empty\";\n+        String consoleErr = \"Empty\";\n+        String testMsg = \"******* Hello Tester! ******* \";\n+\n         try {\n             System.setOut(new PrintStream(testOut));\n             System.setErr(new PrintStream(testErr));\n \n+\n             System.setProperty(\"IGNITE_QUIET\", \"false\");\n \n+\n             try (Ignite ignite = G.start(getConfiguration(\"verboseLogGrid\", LOG_PATH_VERBOSE_TEST))) {\n-                String testMsg = \"******* Hello Tester! ******* \";\n \n                 ignite.log().error(testMsg + Level.ERROR);\n                 ignite.log().warning(testMsg + Level.WARN);\n                 ignite.log().info(testMsg + Level.INFO);\n                 ignite.log().debug(testMsg + Level.DEBUG);\n                 ignite.log().trace(testMsg + Level.TRACE);\n-\n-                String consoleOut = testOut.toString();\n-                String consoleErr = testErr.toString();\n-\n-                assertTrue(consoleOut.contains(testMsg + Level.INFO));\n-                assertTrue(consoleOut.contains(testMsg + Level.DEBUG));\n-                assertTrue(consoleOut.contains(testMsg + Level.TRACE));\n-                assertTrue(consoleOut.contains(testMsg + Level.ERROR));\n-                assertTrue(consoleOut.contains(testMsg + Level.WARN));\n-\n-                assertTrue(consoleErr.contains(testMsg + Level.ERROR));\n-                assertTrue(consoleErr.contains(testMsg + Level.WARN));\n-                assertTrue(!consoleErr.contains(testMsg + Level.INFO));\n-                assertTrue(consoleErr.contains(testMsg + Level.DEBUG));\n-                assertTrue(consoleErr.contains(testMsg + Level.TRACE));\n             }\n+\n         }\n         finally {\n             System.setProperty(\"IGNITE_QUIET\", \"true\");\n \n             System.setOut(backupSysOut);\n             System.setErr(backupSysErr);\n+        }\n \n-            System.out.println(\"**************** Out Console content ***************\");\n-            System.out.println(testOut.toString());\n+        testOut.flush();\n+        testErr.flush();\n \n-            System.err.println(\"**************** Err Console content ***************\");\n-            System.err.println(testErr.toString());\n-        }\n+        consoleOut = testOut.toString();\n+        consoleErr = testErr.toString();\n+\n+        System.out.println(\"**************** Out Console content ***************\");\n+        System.out.println(consoleOut);\n+\n+        System.out.println(\"**************** Err Console content ***************\");\n+        System.out.println(consoleErr);\n+\n+        assertTrue(consoleOut.contains(testMsg + Level.INFO));\n+        assertTrue(consoleOut.contains(testMsg + Level.DEBUG));\n+        assertTrue(consoleOut.contains(testMsg + Level.TRACE));\n+        assertTrue(consoleOut.contains(testMsg + Level.ERROR));\n+        assertTrue(consoleOut.contains(testMsg + Level.WARN));\n+\n+        assertTrue(consoleErr.contains(testMsg + Level.ERROR));\n+        assertTrue(consoleErr.contains(testMsg + Level.WARN));\n+        assertTrue(!consoleErr.contains(testMsg + Level.INFO));\n+        assertTrue(consoleErr.contains(testMsg + Level.DEBUG));\n+        assertTrue(consoleErr.contains(testMsg + Level.TRACE));\n     }\n \n     /**\n@@ -108,9 +127,13 @@ private static IgniteConfiguration getConfiguration(String igniteInstanceName, S\n             setAddresses(Collections.singleton(\"127.0.0.1:47500..47509\"));\n         }});\n \n+        File xml = GridTestUtils.resolveIgnitePath(LOG_PATH_VERBOSE_TEST);\n+\n+        Log4J2Logger logger = new Log4J2Logger(xml);\n+\n         return new IgniteConfiguration()\n             .setIgniteInstanceName(igniteInstanceName)\n-            .setGridLogger(new Log4J2Logger(logPath))\n+            .setGridLogger(logger)\n             .setConnectorConfiguration(null)\n             .setDiscoverySpi(disco);\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/test/java/org/apache/ignite/logger/log4j2/Log4j2LoggerVerboseModeSelfTest.java",
                "sha": "c28108ce54914fc5722b169da2c6c47f1dfde398",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/ignite/blob/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/test/java/org/apache/ignite/testsuites/IgniteLog4j2TestSuite.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/ignite/contents/modules/log4j2/src/test/java/org/apache/ignite/testsuites/IgniteLog4j2TestSuite.java?ref=f8824c86112c99f5f9657d86a3f0aa53777b1f17",
                "deletions": 0,
                "filename": "modules/log4j2/src/test/java/org/apache/ignite/testsuites/IgniteLog4j2TestSuite.java",
                "patch": "@@ -19,6 +19,7 @@\n \n import junit.framework.TestSuite;\n import org.apache.ignite.logger.log4j2.Log4j2LoggerSelfTest;\n+import org.apache.ignite.logger.log4j2.Log4j2LoggerVerboseModeSelfTest;\n \n /**\n  * Log4j2 logging tests.\n@@ -32,6 +33,7 @@ public static TestSuite suite() throws Exception {\n         TestSuite suite = new TestSuite(\"Log4j2 Logging Test Suite\");\n \n         suite.addTest(new TestSuite(Log4j2LoggerSelfTest.class));\n+        suite.addTest(new TestSuite(Log4j2LoggerVerboseModeSelfTest.class));\n \n         return suite;\n     }",
                "raw_url": "https://github.com/apache/ignite/raw/f8824c86112c99f5f9657d86a3f0aa53777b1f17/modules/log4j2/src/test/java/org/apache/ignite/testsuites/IgniteLog4j2TestSuite.java",
                "sha": "a23cb477742f4162c094b3b785fac29a3be8239b",
                "status": "modified"
            }
        ],
        "message": "IGNITE-6362 Fixed NPE in Log4J2Logger. Cleanup tests and added tests to suite. This closes #2833.\n\nSigned-off-by: nikolay_tikhonov <ntikhonov@gridgain.com>",
        "parent": "https://github.com/apache/ignite/commit/6679b6cbe6a26f8e9ba2a02bcf56801811e99abd",
        "patched_files": [
            "IgniteLog4j2TestSuite.java",
            "Log4J2Logger.java"
        ],
        "repo": "ignite",
        "unit_tests": [
            "GridLog4j2CorrectFileNameTest.java",
            "GridLog4j2InitializedTest.java",
            "Log4j2LoggerSelfTest.java",
            "Log4j2LoggerVerboseModeSelfTest.java",
            "GridLog4j2LoggingFileTest.java"
        ]
    }
}