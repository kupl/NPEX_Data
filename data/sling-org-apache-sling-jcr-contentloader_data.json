[
    {
        "repo": "sling-org-apache-sling-jcr-contentloader",
        "message": "SLING-1325 : Bundle deploy fails utterly if any XML files contains an element named \"type\" - throw exception now instead of an NPE.\n\ngit-svn-id: https://svn.apache.org/repos/asf/sling/trunk@903115 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/commit/d3d01bd47d5acf3a2219509359506964dc72e956",
        "parent": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/commit/c99132897c63799973c0d09164f2117814324c71",
        "bug_id": "sling-org-apache-sling-jcr-contentloader_1",
        "file": [
            {
                "sha": "8cd74e111513c3984968bbf04cf5d4693949fd8a",
                "filename": "src/main/java/org/apache/sling/jcr/contentloader/internal/readers/XmlReader.java",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/blob/d3d01bd47d5acf3a2219509359506964dc72e956/src/main/java/org/apache/sling/jcr/contentloader/internal/readers/XmlReader.java",
                "raw_url": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/raw/d3d01bd47d5acf3a2219509359506964dc72e956/src/main/java/org/apache/sling/jcr/contentloader/internal/readers/XmlReader.java",
                "status": "modified",
                "changes": 32,
                "additions": 22,
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-jcr-contentloader/contents/src/main/java/org/apache/sling/jcr/contentloader/internal/readers/XmlReader.java?ref=d3d01bd47d5acf3a2219509359506964dc72e956",
                "patch": "@@ -156,10 +156,10 @@ public ContentReader getReader() throws IOException {\n \n \n     /**\n-     * @see org.apache.sling.jcr.contentloader.internal.ContentReader#parse(java.net.URL, org.apache.sling.jcr.contentloader.internal.ContentCreator)\n+     * @see org.apache.sling.jcr.contentloader.internal.ContentReader#parse(URL, org.apache.sling.jcr.contentloader.internal.ContentCreator)\n      */\n-    public synchronized void parse(java.net.URL url, ContentCreator creator)\n-            throws IOException, RepositoryException {\n+    public synchronized void parse(final URL url, final ContentCreator creator)\n+    throws IOException, RepositoryException {\n         BufferedInputStream bufferedInput = null;\n         try {\n             // We need to buffer input, so that we can reset the stream if we encounter an XSL stylesheet reference\n@@ -172,8 +172,11 @@ public synchronized void parse(java.net.URL url, ContentCreator creator)\n         }\n     }\n \n-    private void parseInternal(InputStream bufferedInput, ContentCreator creator, java.net.URL xmlLocation) throws XmlPullParserException, IOException, RepositoryException {\n-        final StringBuffer contentBuffer = new StringBuffer();\n+    private void parseInternal(final InputStream bufferedInput,\n+                               final ContentCreator creator,\n+                               final URL xmlLocation)\n+    throws XmlPullParserException, IOException, RepositoryException {\n+        final StringBuilder contentBuffer = new StringBuilder();\n         // Mark the beginning of the stream. We assume that if there's an XSL processing instruction,\n         // it will occur in the first gulp - which makes sense, as processing instructions must be\n         // specified before the root elemeent of an XML file.\n@@ -223,7 +226,7 @@ private void parseInternal(InputStream bufferedInput, ContentCreator creator, ja\n                 } else if (ELEM_FILE_NAME.equals(currentElement) && ELEM_FILE_NAMESPACE.equals(this.xmlParser.getNamespace())) {\n                     int attributeCount = this.xmlParser.getAttributeCount();\n                     if (attributeCount < 2 || attributeCount > 3) {\n-                        throw new IOException(\"File element must have these attributes: url, mimeType and lastModified\");\n+                        throw new IOException(\"File element must have these attributes: url, mimeType and lastModified: \" + xmlLocation);\n                     }\n                     try {\n                         AttributeMap attributes = AttributeMap.getInstance();\n@@ -232,7 +235,7 @@ private void parseInternal(InputStream bufferedInput, ContentCreator creator, ja\n                         FileDescription.SHARED.setValues(attributes);\n                         attributes.clear();\n                     } catch (ParseException e) {\n-                        IOException ioe = new IOException(\"Error parsing file description\");\n+                        IOException ioe = new IOException(\"Error parsing file description: \" + xmlLocation);\n                         ioe.initCause(e);\n                         throw ioe;\n                     }\n@@ -257,12 +260,21 @@ private void parseInternal(InputStream bufferedInput, ContentCreator creator, ja\n                     }\n \n                 } else if (ELEM_VALUE.equals(qName)) {\n+                    if ( currentProperty == null ) {\n+                        throw new IOException(\"XML file does not seem to contain valid content xml. Unexpected \" + ELEM_VALUE + \" element in : \" + xmlLocation);\n+                    }\n                     currentProperty.addValue(content);\n \n                 } else if (ELEM_VALUES.equals(qName)) {\n+                    if ( currentProperty == null ) {\n+                        throw new IOException(\"XML file does not seem to contain valid content xml. Unexpected \" + ELEM_VALUE + \" element in : \" + xmlLocation);\n+                    }\n                     currentProperty.isMultiValue = true;\n \n                 } else if (ELEM_TYPE.equals(qName)) {\n+                    if ( currentProperty == null ) {\n+                        throw new IOException(\"XML file does not seem to contain valid content xml. Unexpected \" + ELEM_VALUE + \" element in : \" + xmlLocation);\n+                    }\n                     currentProperty.type = content;\n \n                 } else if (ELEM_NODE.equals(qName)) {\n@@ -271,13 +283,13 @@ private void parseInternal(InputStream bufferedInput, ContentCreator creator, ja\n \n                 } else if (ELEM_PRIMARY_NODE_TYPE.equals(qName)) {\n                     if ( currentNode == null ) {\n-                        throw new IOException(\"Element is not allowed at this location: \" + qName);\n+                        throw new IOException(\"Element is not allowed at this location: \" + qName + \" in \" + xmlLocation);\n                     }\n                     currentNode.primaryNodeType = content;\n \n                 } else if (ELEM_MIXIN_NODE_TYPE.equals(qName)) {\n                     if ( currentNode == null ) {\n-                        throw new IOException(\"Element is not allowed at this location: \" + qName);\n+                        throw new IOException(\"Element is not allowed at this location: \" + qName + \" in \" + xmlLocation);\n                     }\n                     currentNode.addMixinType(content);\n                 }\n@@ -321,7 +333,7 @@ public XslTransformerStream(InputStream inputXml, String xslHref, URL xmlLocatio\n          * @throws IOException\n          */\n         public void startTransform() throws IOException {\n-            final URL xslResource = new java.net.URL(xmlLocation, this.xslHref);\n+            final URL xslResource = new URL(xmlLocation, this.xslHref);\n \n /*\n             if (xslResource == null) {",
                "deletions": 10
            }
        ]
    },
    {
        "repo": "sling-org-apache-sling-jcr-contentloader",
        "message": "SLING-1251 Applied Patch from Ray Davis (Thanks) fixes acl policies after JR16 upgrade, and fixes a potential NPE.\n\ngit-svn-id: https://svn.apache.org/repos/asf/sling/trunk@897054 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/commit/c99132897c63799973c0d09164f2117814324c71",
        "parent": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/commit/e7d0f660b67b3ab342e6fddb8a89ff519669a1e9",
        "bug_id": "sling-org-apache-sling-jcr-contentloader_2",
        "file": [
            {
                "sha": "2cf70aa852885759894dca5d47dc16db2126b1b4",
                "filename": "src/main/java/org/apache/sling/jcr/contentloader/internal/DefaultContentCreator.java",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/blob/c99132897c63799973c0d09164f2117814324c71/src/main/java/org/apache/sling/jcr/contentloader/internal/DefaultContentCreator.java",
                "raw_url": "https://github.com/apache/sling-org-apache-sling-jcr-contentloader/raw/c99132897c63799973c0d09164f2117814324c71/src/main/java/org/apache/sling/jcr/contentloader/internal/DefaultContentCreator.java",
                "status": "modified",
                "changes": 53,
                "additions": 32,
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-jcr-contentloader/contents/src/main/java/org/apache/sling/jcr/contentloader/internal/DefaultContentCreator.java?ref=c99132897c63799973c0d09164f2117814324c71",
                "patch": "@@ -813,16 +813,24 @@ public void createAce(String principalId,\n \n \t\tAccessControlManager accessControlManager = AccessControlUtil.getAccessControlManager(session);\n \t\tAccessControlList updatedAcl = null;\n-\t\tAccessControlPolicyIterator applicablePolicies = accessControlManager.getApplicablePolicies(resourcePath);\n-\t\twhile (applicablePolicies.hasNext()) {\n-\t\t\tAccessControlPolicy policy = applicablePolicies.nextAccessControlPolicy();\n-\t\t\tif (policy instanceof AccessControlList) {\n-\t\t\t\tupdatedAcl = (AccessControlList)policy;\n-\t\t\t\tbreak;\n-\t\t\t}\n+\t\tAccessControlPolicy[] policies = accessControlManager.getPolicies(resourcePath);\n+\t\tfor (AccessControlPolicy policy : policies) {\n+\t\t  if (policy instanceof AccessControlList) {\n+\t\t    updatedAcl = (AccessControlList)policy;\n+\t\t    break;\n+\t\t  }\n+\t\t}\n+\t\tif (updatedAcl == null) {\n+\t\t  AccessControlPolicyIterator applicablePolicies = accessControlManager.getApplicablePolicies(resourcePath);\n+\t\t  while (applicablePolicies.hasNext()) {\n+\t\t    AccessControlPolicy policy = applicablePolicies.nextAccessControlPolicy();\n+\t\t    if (policy instanceof AccessControlList) {\n+\t\t      updatedAcl = (AccessControlList)policy;\n+\t\t    }\n+\t\t  }\n \t\t}\n \t\tif (updatedAcl == null) {\n-\t\t\tthrow new RepositoryException(\"Unable to find an access conrol policy to update.\");\n+\t\t\tthrow new RepositoryException(\"Unable to find or create an access control policy to update for \" + resourcePath);\n \t\t}\n \n \t\tSet<String> postedPrivilegeNames = new HashSet<String>();\n@@ -869,12 +877,14 @@ public void createAce(String principalId,\n \n \t\t//add a fresh ACE with the granted privileges\n \t\tList<Privilege> grantedPrivilegeList = new ArrayList<Privilege>();\n-\t\tfor (String name : grantedPrivilegeNames) {\n-\t\t\tif (name.length() == 0) {\n-\t\t\t\tcontinue; //empty, skip it.\n-\t\t\t}\n-\t\t\tPrivilege privilege = accessControlManager.privilegeFromName(name);\n-\t\t\tgrantedPrivilegeList.add(privilege);\n+\t\tif (grantedPrivilegeNames != null) {\n+\t\t  for (String name : grantedPrivilegeNames) {\n+\t\t\t  if (name.length() == 0) {\n+\t\t\t\t  continue; //empty, skip it.\n+\t\t\t  }\n+\t\t\t  Privilege privilege = accessControlManager.privilegeFromName(name);\n+\t\t\t  grantedPrivilegeList.add(privilege);\n+\t    }\n \t\t}\n \t\t//add the privileges that should be preserved\n \t\tgrantedPrivilegeList.addAll(preserveGrantedPrivileges);\n@@ -888,13 +898,14 @@ public void createAce(String principalId,\n \t\tif (!authorizable.isGroup()) {\n \t\t\t//add a fresh ACE with the denied privileges\n \t\t\tList<Privilege> deniedPrivilegeList = new ArrayList<Privilege>();\n-\t\t\tfor (String name : deniedPrivilegeNames) {\n-\t\t\t\tif (name.length() == 0) {\n-\t\t\t\t\tcontinue; //empty, skip it.\n-\t\t\t\t}\n-\t\t\t\tPrivilege privilege = accessControlManager.privilegeFromName(name);\n-\t\t\t\tdeniedPrivilegeList.add(privilege);\n-\n+\t\t\tif (deniedPrivilegeNames != null) {\n+\t\t\t  for (String name : deniedPrivilegeNames) {\n+\t\t\t\t  if (name.length() == 0) {\n+\t\t\t\t\t  continue; //empty, skip it.\n+\t\t\t\t  }\n+\t\t\t\t  Privilege privilege = accessControlManager.privilegeFromName(name);\n+\t\t\t\t  deniedPrivilegeList.add(privilege);\n+\t\t\t  }\n \t\t\t}\n \t\t\t//add the privileges that should be preserved\n \t\t\tdeniedPrivilegeList.addAll(preserveDeniedPrivileges);",
                "deletions": 21
            }
        ]
    }
]