[{"commit": "https://github.com/apache/jackrabbit/commit/442f485bfd1553bc4ceac49f38f3ae85e518f3f3", "parent": "https://github.com/apache/jackrabbit/commit/5514bec790dbc45ad6f05c859afb6442b052a976", "message": "JCR-4483: jcr2spi: potential NPE in ImportHandler.endDocument\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1867130 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_1", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/442f485bfd1553bc4ceac49f38f3ae85e518f3f3/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/ImportHandler.java", "blob_url": "https://github.com/apache/jackrabbit/blob/442f485bfd1553bc4ceac49f38f3ae85e518f3f3/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/ImportHandler.java", "sha": "6f50df85847a650dda35054fe2106a271101a68b", "changes": 4, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/ImportHandler.java?ref=442f485bfd1553bc4ceac49f38f3ae85e518f3f3", "patch": "@@ -162,7 +162,9 @@ public void startDocument() throws SAXException {\n     @Override\n     public void endDocument() throws SAXException {\n         // delegate to target handler\n-        targetHandler.endDocument();\n+        if (targetHandler != null) {\n+            targetHandler.endDocument();\n+        }\n         // cleanup\n         nsContext.reset();\n     }", "filename": "jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/ImportHandler.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f", "parent": "https://github.com/apache/jackrabbit/commit/4e6739f9fc0759ab7ef1cc7a988e604f755c1d28", "message": "JCR-4324: NPE on Version.getLinearPredecessor() implementation\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1834424 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_2", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java", "sha": "2070a6a74c67be28b81376210c11c4a9f1dc8c12", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java?ref=f95af78c5a567f14c3acfea0c6b7710ce0e25d9f", "patch": "@@ -127,7 +127,7 @@ public Version getLinearSuccessor() throws RepositoryException {\n      */\n     public javax.jcr.version.Version getLinearPredecessor() throws RepositoryException {\n         InternalVersion pred = getInternalVersion().getLinearPredecessor();\n-        return (Version) sessionContext.getSessionImpl().getNodeById(pred.getId());\n+        return pred == null ? null : (Version) sessionContext.getSessionImpl().getNodeById(pred.getId());\n     }\n \n     /**", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java"}, {"additions": 10, "raw_url": "https://github.com/apache/jackrabbit/raw/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java", "sha": "00ab2a5575240cd5228cc3720ebced5ba274569d", "changes": 17, "status": "modified", "deletions": 7, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java?ref=f95af78c5a567f14c3acfea0c6b7710ce0e25d9f", "patch": "@@ -41,31 +41,34 @@ public void testGetPredecessors() throws RepositoryException {\n \n         assertTrue(\"Version should have at minimum one predecessor version.\", version.getPredecessors().length > 0);\n     }\n-    \n+\n     /**\n-     * Checks ontaining the linear predecessor.\n+     * Checks obtaining the linear predecessor.\n      * @since JCR 2.0\n      */\n     public void testGetLinearPredecessorSuccessor() throws RepositoryException {\n \n         String path = versionableNode.getPath();\n-        \n+\n         VersionManager vm = versionableNode.getSession().getWorkspace().getVersionManager();\n-        \n+\n         // get the previous version\n         Version pred = vm.getBaseVersion(path);\n \n+        // shouldn't have a predecessor\n+        assertNull(pred.getLinearPredecessor());\n+\n         // shouldn't have a successor yet\n         assertNull(pred.getLinearSuccessor());\n-        \n+\n         // check root version\n         Version root = vm.getVersionHistory(path).getRootVersion();\n         assertNull(root.getLinearSuccessor());\n-        \n+\n         // create a new version\n         vm.checkout(path);\n         Version version = vm.checkin(path);\n-        \n+\n         // refresh the predecessor\n         pred = (Version)versionableNode.getSession().getNode(pred.getPath());\n ", "filename": "jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/dcbf17fe78596f45f50f82f124816766b4ace0c9", "parent": "https://github.com/apache/jackrabbit/commit/3d1c8a6a0611c069839e76cdfc9a63d4d385aaff", "message": "JCR-4135: guard against NPEs\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1793639 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_3", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/dcbf17fe78596f45f50f82f124816766b4ace0c9/jackrabbit-data/src/main/java/org/apache/jackrabbit/core/data/FSBackend.java", "blob_url": "https://github.com/apache/jackrabbit/blob/dcbf17fe78596f45f50f82f124816766b4ace0c9/jackrabbit-data/src/main/java/org/apache/jackrabbit/core/data/FSBackend.java", "sha": "1437178d556a957c67e19804f92820df2d89b074", "changes": 4, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-data/src/main/java/org/apache/jackrabbit/core/data/FSBackend.java?ref=dcbf17fe78596f45f50f82f124816766b4ace0c9", "patch": "@@ -269,7 +269,9 @@ public void run() {\n                 }\n             });\n         } catch (Exception e) {\n-            callback.onAbort(new AsyncTouchResult(identifier));\n+            if (callback != null) {\n+                callback.onAbort(new AsyncTouchResult(identifier));\n+            }\n             throw new DataStoreException(\"Cannot touch the record \"\n                 + identifier.toString(), e);\n         }", "filename": "jackrabbit-data/src/main/java/org/apache/jackrabbit/core/data/FSBackend.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/c9924979046924c428950f35dc9395ce800ecaca", "parent": "https://github.com/apache/jackrabbit/commit/5a37e856830401142808a541ef52cd911e2327d1", "message": "JCR-4102: jcr2dav: change polling thread sometimes dies with NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1779460 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_4", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/c9924979046924c428950f35dc9395ce800ecaca/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2dav/URIResolverImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/c9924979046924c428950f35dc9395ce800ecaca/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2dav/URIResolverImpl.java", "sha": "aae0154958b4b06eb901f490aa88440b60af0fd3", "changes": 6, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2dav/URIResolverImpl.java?ref=c9924979046924c428950f35dc9395ce800ecaca", "patch": "@@ -333,14 +333,14 @@ public NodeId getNodeId(String uri, SessionInfo sessionInfo) throws RepositoryEx\n     public NodeId getNodeIdAfterEvent(String uri, SessionInfo sessionInfo, boolean nodeIsGone) throws RepositoryException {\n         return getNodeId(uri, sessionInfo, nodeIsGone);\n     }\n-    \n+\n     /**\n      * @inheritDoc\n      */\n     public PropertyId getPropertyId(String uri, SessionInfo sessionInfo) throws RepositoryException {\n         IdURICache cache = getCache(sessionInfo.getWorkspaceName());\n-        if (cache.containsUri(uri)) {\n-            ItemId id = cache.getItemId(uri);\n+        ItemId id = cache.getItemId(uri);\n+        if (id != null) {\n             if (!id.denotesNode()) {\n                 return (PropertyId) id;\n             }", "filename": "jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2dav/URIResolverImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/524deb74243abba98b246845296ee422baf4c556", "parent": "https://github.com/apache/jackrabbit/commit/97bb7f89fc3d1487dc2155f44a2c2d9db7c74169", "message": "JCR-2655: initVersions crashes with NPE\n\nSkip missing successors to avoid the NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1000912 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_5", "file": [{"additions": 2, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java", "sha": "a612163bb2da395dbf05a11fd20e9470fc2e575a", "changes": 3, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -21,6 +21,7 @@\n import javax.jcr.version.Version;\n \n import java.util.Calendar;\n+import java.util.List;\n \n /**\n  * This interface defines the internal version.\n@@ -63,7 +64,7 @@\n      * @see javax.jcr.version.Version#getSuccessors()\n      * @return the successors as internal versions\n      */\n-    InternalVersion[] getSuccessors();\n+    List<InternalVersion> getSuccessors();\n \n     /**\n      * Equivalent to {@link Version#getLinearSuccessor()}.", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java"}, {"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java", "sha": "9929305c5226f744bb109a677579e0c1cdab183a", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -162,7 +162,7 @@ private synchronized void init() throws RepositoryException {\n         }\n \n         // fix legacy\n-        if (rootVersion.getSuccessors().length == 0) {\n+        if (rootVersion.getSuccessors().isEmpty()) {\n             for (Name versionName : nameCache.keySet()) {\n                 InternalVersionImpl v = createVersionInstance(versionName);\n                 v.legacyResolveSuccessors();", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java"}, {"additions": 26, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java", "sha": "85309383189b4b9f6afd4d4bfe9cf0b8a293011d", "changes": 37, "status": "modified", "deletions": 11, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -22,11 +22,14 @@\n import org.apache.jackrabbit.core.id.NodeId;\n import org.apache.jackrabbit.spi.Name;\n import org.apache.jackrabbit.spi.commons.name.NameConstants;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import javax.jcr.PropertyType;\n import javax.jcr.RepositoryException;\n import java.util.Arrays;\n import java.util.Calendar;\n+import java.util.Collections;\n import java.util.HashSet;\n import java.util.List;\n import java.util.ArrayList;\n@@ -37,6 +40,10 @@\n class InternalVersionImpl extends InternalVersionItemImpl\n         implements InternalVersion {\n \n+    /** Logger instance */\n+    private static final Logger log =\n+        LoggerFactory.getLogger(InternalVersionImpl.class);\n+\n     /**\n      * the date when this version was created\n      */\n@@ -138,18 +145,27 @@ public Calendar getCreated() {\n     /**\n      * {@inheritDoc}\n      */\n-    public InternalVersion[] getSuccessors() {\n+    public List<InternalVersion> getSuccessors() {\n         ReadLock lock = vMgr.acquireReadLock();\n         try {\n-            InternalValue[] values = node.getPropertyValues(NameConstants.JCR_SUCCESSORS);\n+            InternalValue[] values =\n+                node.getPropertyValues(NameConstants.JCR_SUCCESSORS);\n             if (values != null) {\n-                InternalVersion[] versions = new InternalVersion[values.length];\n-                for (int i = 0; i < values.length; i++) {\n-                    versions[i] = versionHistory.getVersion(values[i].getNodeId());\n+                List<InternalVersion> versions =\n+                    new ArrayList<InternalVersion>(values.length);\n+                for (InternalValue value : values) {\n+                    InternalVersion version =\n+                        versionHistory.getVersion(value.getNodeId());\n+                    if (version != null) {\n+                        versions.add(version);\n+                    } else {\n+                        // Can happen with a corrupted repository (JCR-2655)\n+                        log.warn(\"Missing successor {}\", value.getNodeId());\n+                    }\n                 }\n                 return versions;\n             } else {\n-                return new InternalVersion[0];\n+                return Collections.emptyList();\n             }\n         } finally {\n             lock.release();\n@@ -275,8 +291,7 @@ private void storeXCessors(List<InternalVersion> cessors, Name propname, boolean\n      */\n     void internalDetach() throws RepositoryException {\n         // detach this from all successors\n-        InternalVersion[] succ = getSuccessors();\n-        for (InternalVersion aSucc : succ) {\n+        for (InternalVersion aSucc :  getSuccessors()) {\n             ((InternalVersionImpl) aSucc).internalDetachPredecessor(this, true);\n         }\n \n@@ -312,7 +327,7 @@ void internalAttach() throws RepositoryException {\n      */\n     private void internalAddSuccessor(InternalVersionImpl succ, boolean store)\n             throws RepositoryException {\n-        List<InternalVersion> l = new ArrayList<InternalVersion>(Arrays.asList(getSuccessors()));\n+        List<InternalVersion> l = new ArrayList<InternalVersion>(getSuccessors());\n         if (!l.contains(succ)) {\n             l.add(succ);\n             storeXCessors(l, NameConstants.JCR_SUCCESSORS, store);\n@@ -353,11 +368,11 @@ private void internalDetachPredecessor(InternalVersionImpl v, boolean store)\n     private void internalDetachSuccessor(InternalVersionImpl v, boolean store)\n             throws RepositoryException {\n         // remove 'v' from successors list\n-        List<InternalVersion> l = new ArrayList<InternalVersion>(Arrays.asList(getSuccessors()));\n+        List<InternalVersion> l = new ArrayList<InternalVersion>(getSuccessors());\n         l.remove(v);\n \n         // attach V's successors\n-        l.addAll(Arrays.asList(v.getSuccessors()));\n+        l.addAll(v.getSuccessors());\n         storeXCessors(l, NameConstants.JCR_SUCCESSORS, store);\n     }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java"}, {"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "sha": "0c12cb5eb2734f04f9d550c8bd9a8daa814a0949", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -664,7 +664,7 @@ protected String calculateCheckinVersionName(InternalVersionHistoryImpl history,\n             return newVersionName;\n         } else {\n             // best is root version\n-            return String.valueOf(best.getSuccessors().length + 1) + \".0\";\n+            return String.valueOf(best.getSuccessors().size() + 1) + \".0\";\n         }\n     }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java"}, {"additions": 2, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java", "sha": "819b40e2020ae624e26be9e0ee89c08df3f53808", "changes": 6, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -512,12 +512,10 @@ protected void internalRemoveVersion(InternalVersionHistoryImpl history, Name na\n             xaItems.put(history.getId(), history);\n             // also put 'successor' and 'predecessor' version items to xaItem sets\n             InternalVersion v = history.getVersion(name);\n-            InternalVersion[] vs = v.getSuccessors();\n-            for (InternalVersion v1 : vs) {\n+            for (InternalVersion v1 : v.getSuccessors()) {\n                 xaItems.put(v1.getId(), v1);\n             }\n-            vs = v.getPredecessors();\n-            for (InternalVersion v1 : vs) {\n+            for (InternalVersion v1 : v.getPredecessors()) {\n                 xaItems.put(v1.getId(), v1);\n             }\n         }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java"}, {"additions": 6, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java", "sha": "42df5e3c39cd592e2374d105b0563af4af11956a", "changes": 10, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -34,6 +34,7 @@\n import javax.jcr.Node;\n import javax.jcr.nodetype.ConstraintViolationException;\n import java.util.Calendar;\n+import java.util.List;\n \n /**\n  * Base implementation of the {@link javax.jcr.version.Version} interface.\n@@ -84,10 +85,11 @@ public Calendar getCreated() throws RepositoryException {\n      */\n     public javax.jcr.version.Version[] getSuccessors() throws RepositoryException {\n         // need to wrap it around proper node\n-        InternalVersion[] suc = getInternalVersion().getSuccessors();\n-        Version[] ret = new Version[suc.length];\n-        for (int i = 0; i < suc.length; i++) {\n-            ret[i] = (Version) sessionContext.getSessionImpl().getNodeById(suc[i].getId());\n+        List<InternalVersion> suc = getInternalVersion().getSuccessors();\n+        Version[] ret = new Version[suc.size()];\n+        for (int i = 0; i < ret.length; i++) {\n+            ret[i] = (Version) sessionContext.getSessionImpl().getNodeById(\n+                    suc.get(i).getId());\n         }\n         return ret;\n     }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java"}, {"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java", "sha": "99a485c51cfe190acda1ff4037c050be18e10034", "changes": 4, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -26,7 +26,6 @@\n import java.util.ConcurrentModificationException;\n import java.util.LinkedList;\n import java.util.NoSuchElementException;\n-import java.util.Arrays;\n \n /**\n  * This Class implements a VersionIterator that iterates over a version\n@@ -170,8 +169,7 @@ private synchronized void collectAllVersions(InternalVersion root) {\n             NodeId id = currentVersion.getId();\n             if (!versions.contains(id)) {\n                 versions.add(id);\n-                InternalVersion[] successors = currentVersion.getSuccessors();\n-                workQueue.addAll(Arrays.asList(successors));\n+                workQueue.addAll(currentVersion.getSuccessors());\n             }\n         }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java"}, {"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java", "sha": "72a76bae530495bdcebb85bd89cf18e86bb893da", "changes": 7, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -19,6 +19,7 @@\n import java.util.ArrayList;\n import java.util.HashSet;\n import java.util.LinkedList;\n+import java.util.List;\n import java.util.Set;\n \n import javax.jcr.ItemExistsException;\n@@ -577,14 +578,14 @@ protected void internalRestoreFrozen(NodeStateEx state,\n                     if (v == null) {\n                         // if version selector was unable to select version,\n                         // choose the initial one\n-                        InternalVersion[] vs = vh.getRootVersion().getSuccessors();\n-                        if (vs.length == 0) {\n+                        List<InternalVersion> vs = vh.getRootVersion().getSuccessors();\n+                        if (vs.isEmpty()) {\n                             String msg = \"Unable to select appropariate version for \"\n                                     + child.getName() + \" using \" + vsel;\n                             log.error(msg);\n                             throw new VersionException(msg);\n                         }\n-                        v = vs[0];\n+                        v = vs.get(0);\n                     }\n                     InternalFrozenNode f = v.getFrozenNode();\n                     restoredChild = state.addNode(fh.getName(), f.getFrozenPrimaryType(), f.getFrozenId());", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java"}, {"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java", "sha": "c14f66bb6211a4ff7430a807018dbe1a311fd01b", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java?ref=524deb74243abba98b246845296ee422baf4c556", "patch": "@@ -16,7 +16,9 @@\n  */\n package org.apache.jackrabbit.core.version;\n \n+import java.util.Arrays;\n import java.util.Calendar;\n+import java.util.List;\n \n import junit.framework.TestCase;\n \n@@ -37,8 +39,8 @@ public DummyInternalVersion(InternalVersion[] successors, NodeId id) {\n             this.id = id;\n         }\n \n-        public InternalVersion[] getSuccessors() {\n-            return successors;\n+        public List<InternalVersion> getSuccessors() {\n+            return Arrays.asList(successors);\n         }\n \n         public NodeId getId() {", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/887b297f0c021dadc4107fa6248292aa76d4682a", "parent": "https://github.com/apache/jackrabbit/commit/7d181b124200f4db5de61e8d5124d8738c43ae29", "message": "JCR-2433: NPE when copying nodes with Workspace.copy()\n\nWork around the potential NPE by rearranging the name equality test\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@927393 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_6", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/887b297f0c021dadc4107fa6248292aa76d4682a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java", "blob_url": "https://github.com/apache/jackrabbit/blob/887b297f0c021dadc4107fa6248292aa76d4682a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java", "sha": "db5eb6055e29bb746dc9e78271aa46b2a029b7d5", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java?ref=887b297f0c021dadc4107fa6248292aa76d4682a", "patch": "@@ -1775,7 +1775,7 @@ private NodeState copyNodeState(NodeState srcState,\n                 QPropertyDefinition def = ent.getApplicablePropertyDef(\n                         srcChildState.getName(), srcChildState.getType(),\n                         srcChildState.isMultiValued());\n-                if (def.getDeclaringNodeType().equals(NameConstants.MIX_LOCKABLE)) {\n+                if (NameConstants.MIX_LOCKABLE.equals(def.getDeclaringNodeType())) {\n                     // skip properties defined by mix:lockable\n                     continue;\n                 }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/bf46c1b721699a2469da215b26fcd27ea6c20640", "parent": "https://github.com/apache/jackrabbit/commit/98dc67b8c6348ac2e12c9de516d04dd0ee164e3f", "message": "guard against NPEs\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1566430 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_7", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/bf46c1b721699a2469da215b26fcd27ea6c20640/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/join/QueryEngine.java", "blob_url": "https://github.com/apache/jackrabbit/blob/bf46c1b721699a2469da215b26fcd27ea6c20640/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/join/QueryEngine.java", "sha": "11716774086ec47d97fb40777144f54119b0f853", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/join/QueryEngine.java?ref=bf46c1b721699a2469da215b26fcd27ea6c20640", "patch": "@@ -246,7 +246,7 @@ protected QueryResult execute(JoinMerger merger,\n                 merger.getRightSelectors());\n \n         if (leftRows == null || leftRows.isEmpty()) {\n-            return merger.merge(new RowIteratorAdapter(leftRows),\n+            return merger.merge(new RowIteratorAdapter((leftRows == null) ? Collections.emptySet() : leftRows),\n                     new RowIteratorAdapter(new TreeSet<Row>()), null, rightCo);\n         }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/join/QueryEngine.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/d246283cb60de501463aab99e3038a6d966ad6ba", "parent": "https://github.com/apache/jackrabbit/commit/b896752f76c9b06276b54b86c0426adf215f9b4d", "message": "guard against npes\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1177524 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_8", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/d246283cb60de501463aab99e3038a6d966ad6ba/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/DefaultHighlighter.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d246283cb60de501463aab99e3038a6d966ad6ba/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/DefaultHighlighter.java", "sha": "6628880145c08a5d496b2722aba23ac1ac8b022e", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/DefaultHighlighter.java?ref=d246283cb60de501463aab99e3038a6d966ad6ba", "patch": "@@ -152,8 +152,11 @@ protected String doHighlight(TermPositionVector tvec,\n         Iterator<Term[]> it = queryTerms.iterator();\n         while (it.hasNext()) {\n             Term[] qt = it.next();\n+            if (qt == null) {\n+                continue;\n+            }\n             final int qtLen = qt.length;\n-            if (qt == null || qtLen == 0) {\n+            if (qtLen == 0) {\n                 continue;\n             }\n             String[] qtText = new String[qtLen];", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/DefaultHighlighter.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/1dbf453b95de047ca9d8fcd8c187f9e65b5382c0", "parent": "https://github.com/apache/jackrabbit/commit/518afbd2e4573a4110bcb1d2819005bdd0ec8788", "message": "- fixing npe\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@158601 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_9", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/1dbf453b95de047ca9d8fcd8c187f9e65b5382c0/src/java/org/apache/jackrabbit/core/virtual/AbstractVISProvider.java", "blob_url": "https://github.com/apache/jackrabbit/blob/1dbf453b95de047ca9d8fcd8c187f9e65b5382c0/src/java/org/apache/jackrabbit/core/virtual/AbstractVISProvider.java", "sha": "06f48c73adfba505c9c243d34f4c8d593f082883", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/virtual/AbstractVISProvider.java?ref=1dbf453b95de047ca9d8fcd8c187f9e65b5382c0", "patch": "@@ -284,8 +284,10 @@ protected NodeTypeRegistry getNodeTypeRegistry() {\n      * @param state\n      */\n     protected NodeState cache(NodeState state) {\n-        nodes.put(state.getId(), state);\n-        log.debug(\"item added to cache. size=\" + nodes.size());\n+        if (state != null) {\n+            nodes.put(state.getId(), state);\n+            log.debug(\"item added to cache. size=\" + nodes.size());\n+        }\n         return state;\n     }\n ", "filename": "src/java/org/apache/jackrabbit/core/virtual/AbstractVISProvider.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/97288e64c29599e07e537f5a2c17ce0ccadc46e7", "parent": "https://github.com/apache/jackrabbit/commit/7b909badc488aaf11f98253b382b9a7176fec076", "message": "JCR-2380: NPE in ObservationManagerImpl.getRegisteredEventListeners() during shutdown after broken startup\n- explicitly throwing NPE earlier in constructor as it is done for other parameters as well\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@831934 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_10", "file": [{"additions": 6, "raw_url": "https://github.com/apache/jackrabbit/raw/97288e64c29599e07e537f5a2c17ce0ccadc46e7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/ObservationManagerImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/97288e64c29599e07e537f5a2c17ce0ccadc46e7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/ObservationManagerImpl.java", "sha": "285854025295ed76ef7c50f588a5a2dcc668176f", "changes": 9, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/ObservationManagerImpl.java?ref=97288e64c29599e07e537f5a2c17ce0ccadc46e7", "patch": "@@ -87,19 +87,22 @@\n      *                belongs to.\n      * @param itemMgr {@link org.apache.jackrabbit.core.ItemManager} of the passed\n      *                <code>Session</code>.\n-     * @throws NullPointerException if <code>session</code> or <code>itemMgr</code>\n-     *                              is <code>null</code>.\n+     * @throws NullPointerException if <code>dispatcher</code>, <code>session</code>\n+     *                              or <code>itemMgr</code> is <code>null</code>.\n      */\n     public ObservationManagerImpl(\n             ObservationDispatcher dispatcher, SessionImpl session,\n             ItemManager itemMgr, ClusterNode clusterNode) {\n+        if (dispatcher == null) {\n+            throw new NullPointerException(\"dispatcher\");\n+        }\n         if (session == null) {\n             throw new NullPointerException(\"session\");\n         }\n         if (itemMgr == null) {\n             throw new NullPointerException(\"itemMgr\");\n         }\n-\n+        \n         this.dispatcher = dispatcher;\n         this.session = session;\n         this.itemMgr = itemMgr;", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/ObservationManagerImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/d82b62405dc1db67b53d6e86d2d73e3353675b63", "parent": "https://github.com/apache/jackrabbit/commit/054c5906503c0a0893ce2f70ae80185045a51ef1", "message": "JCR-3806: TestLocalCache fails occasionally with NPE\n\nIgnore tests for now\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1619422 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_11", "file": [{"additions": 12, "raw_url": "https://github.com/apache/jackrabbit/raw/d82b62405dc1db67b53d6e86d2d73e3353675b63/jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d82b62405dc1db67b53d6e86d2d73e3353675b63/jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java", "sha": "705cc9fbe45d25dc1fefb45303c1499ee44db43d", "changes": 12, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java?ref=d82b62405dc1db67b53d6e86d2d73e3353675b63", "patch": "@@ -76,6 +76,10 @@ protected void tearDown() throws IOException {\n      * Test to validate store retrieve in cache.\n      */\n     public void testStoreRetrieve() {\n+        // FIXME: JCR-3806\n+        if (true) {\n+            return;\n+        }\n         try {\n             AsyncUploadCache pendingFiles = new AsyncUploadCache();\n             pendingFiles.init(TARGET_DIR, CACHE_DIR, 100);\n@@ -116,6 +120,10 @@ public void testStoreRetrieve() {\n      * cachePurgeTrigFactor * size.\n      */\n     public void testAutoPurge() {\n+        // FIXME: JCR-3806\n+        if (true) {\n+            return;\n+        }\n         try {\n             AsyncUploadCache pendingFiles = new AsyncUploadCache();\n             pendingFiles.init(TARGET_DIR, CACHE_DIR, 100);\n@@ -179,6 +187,10 @@ public void testAutoPurge() {\n      * cachePurgeTrigFactor * size.\n      */\n     public void testAutoPurgeWithPendingUpload() {\n+        // FIXME: JCR-3806\n+        if (true) {\n+            return;\n+        }\n         try {\n             AsyncUploadCache pendingFiles = new AsyncUploadCache();\n             pendingFiles.init(TARGET_DIR, CACHE_DIR, 100);", "filename": "jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/7280250cac441584c513a16937724b2adbbbfd87", "parent": "https://github.com/apache/jackrabbit/commit/3d86c4ec5bb5a274ffc24362d28f0bcb23adacc9", "message": "fix NPE on error path when user is null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1577995 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_12", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/7280250cac441584c513a16937724b2adbbbfd87/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7280250cac441584c513a16937724b2adbbbfd87/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java", "sha": "50666a2c1043303017427b5a102a819f9ef0cfe9", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java?ref=7280250cac441584c513a16937724b2adbbbfd87", "patch": "@@ -328,7 +328,7 @@ private NodeImpl getTokenParent(User user) throws RepositoryException {\n                     }\n                 }\n             } else {\n-                log.debug(\"Cannot create login token: No corresponding node for User {}.\", user.getID());\n+                log.debug(\"Cannot create login token: No user specified. (null)\");\n             }\n         } catch (RepositoryException e) {\n             // conflict while creating token store for this user -> refresh and", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/356a1d9b15953683610094f24cc9a28c65bcc350", "parent": "https://github.com/apache/jackrabbit/commit/3630007caed2ddcf14ded37669014341cf3c28a2", "message": "JCR-3486 guard against npe due to transient root being null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1421853 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_13", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/356a1d9b15953683610094f24cc9a28c65bcc350/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/session/SessionSaveOperation.java", "blob_url": "https://github.com/apache/jackrabbit/blob/356a1d9b15953683610094f24cc9a28c65bcc350/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/session/SessionSaveOperation.java", "sha": "c7ebf1e24ca061c86731dea53b38f5df998d2106", "changes": 4, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/session/SessionSaveOperation.java?ref=356a1d9b15953683610094f24cc9a28c65bcc350", "patch": "@@ -61,7 +61,9 @@ public Object perform(SessionContext context) throws RepositoryException {\n                 LOG.debug(\"Saving changes under \" + path);\n             }\n         }\n-        context.getItemManager().getItem(id).save();\n+        if (id != null) {\n+            context.getItemManager().getItem(id).save();\n+        }\n         return this;\n     }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/session/SessionSaveOperation.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/aaff1bf7b7b1d255eaf220555721c9f963add87a", "parent": "https://github.com/apache/jackrabbit/commit/cffe8f75524b1da26efc44e8779ce1971176cab3", "message": "JCR-3466: NPE in SingletonTokenStream\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1414629 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_14", "file": [{"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/aaff1bf7b7b1d255eaf220555721c9f963add87a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/AbstractIndex.java", "blob_url": "https://github.com/apache/jackrabbit/blob/aaff1bf7b7b1d255eaf220555721c9f963add87a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/AbstractIndex.java", "sha": "e3c12f74f50abedbd522ff477bc9bbe40d3ec0f1", "changes": 15, "status": "modified", "deletions": 7, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/AbstractIndex.java?ref=aaff1bf7b7b1d255eaf220555721c9f963add87a", "patch": "@@ -207,14 +207,15 @@ public void run() {\n             });\n         }\n \n-        try {\n-            latch.await();\n-        } catch (InterruptedException e) {\n-            throw new IOExceptionWithCause(\n-                    \"Wait for background indexing tasks was interrupted\", e);\n-        } finally {\n-            invalidateSharedReader();\n+        for (;;) {\n+            try {\n+                latch.await();\n+                break;\n+            } catch (InterruptedException e) {\n+                // retry\n+            }\n         }\n+        invalidateSharedReader();\n \n         if (!exceptions.isEmpty()) {\n             throw new IOExceptionWithCause(", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/AbstractIndex.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/a9501efa46f9833e96e1c7cb0f83f467649ac4b7", "parent": "https://github.com/apache/jackrabbit/commit/e60384f3420a4edecdd76472664527ccd61d07c2", "message": "JCR-3337 Negated descendant node query with no results throws NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1357591 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_15", "file": [{"additions": 6, "raw_url": "https://github.com/apache/jackrabbit/raw/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java", "sha": "c91fd3a651af7e09c517ed12595d3f89bea978cd", "changes": 14, "status": "modified", "deletions": 8, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java?ref=a9501efa46f9833e96e1c7cb0f83f467649ac4b7", "patch": "@@ -139,6 +139,12 @@ public void normalize(float norm) {\n         public Scorer scorer(IndexReader reader, boolean scoreDocsInOrder,\n                 boolean topScorer) throws IOException {\n             contextScorer = context.weight(searcher).scorer(reader, scoreDocsInOrder, topScorer);\n+            if (contextScorer == null) {\n+                // context query does not match any node\n+                // the inverse is to match all nodes\n+                return new MatchAllDocsQuery().createWeight(searcher).scorer(\n+                        reader, scoreDocsInOrder, topScorer);\n+            }\n             return new NotQueryScorer(reader);\n         }\n \n@@ -185,10 +191,6 @@ public int nextDoc() throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n-            if (contextScorer == null) {\n-                docNo = NO_MORE_DOCS;\n-                return docNo;\n-            }\n \n             if (docNo == -1) {\n                 // get first doc of context scorer\n@@ -229,10 +231,6 @@ public int advance(int target) throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n-            if (contextScorer == null) {\n-                docNo = NO_MORE_DOCS;\n-                return docNo;\n-            }\n \n             // optimize in the case of an advance to finish.\n             // see https://issues.apache.org/jira/browse/JCR-3091", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java"}, {"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java", "sha": "4ab3af55e4cbf43c063468a521bfd863adbb096b", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java?ref=a9501efa46f9833e96e1c7cb0f83f467649ac4b7", "patch": "@@ -253,6 +253,6 @@ public void testNotIsDescendantNodeQuery() throws Exception {\n                 + testRootNode.getPath()\n                 + \"') and not isdescendantnode(a,'\"\n                 + foo.getPath() + \"')\";\n-        executeSQL2Query(sql, new Node[] {});\n+        executeSQL2Query(sql, new Node[] {foo});\n     }\n }", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/936453a1287000626f6074db6ad0537ece561d9c", "parent": "https://github.com/apache/jackrabbit/commit/ac674fe9a3f293f97ecc194a5ec280b389290382", "message": "JCR-3337 Negated descendant node query with no results throws NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1352053 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_16", "file": [{"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java", "blob_url": "https://github.com/apache/jackrabbit/blob/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java", "sha": "610c3b9494b14cbf68b467e862eb03476255db49", "changes": 8, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java?ref=936453a1287000626f6074db6ad0537ece561d9c", "patch": "@@ -185,6 +185,10 @@ public int nextDoc() throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n+            if (contextScorer == null) {\n+                docNo = NO_MORE_DOCS;\n+                return docNo;\n+            }\n \n             if (docNo == -1) {\n                 // get first doc of context scorer\n@@ -225,6 +229,10 @@ public int advance(int target) throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n+            if (contextScorer == null) {\n+                docNo = NO_MORE_DOCS;\n+                return docNo;\n+            }\n \n             // optimize in the case of an advance to finish.\n             // see https://issues.apache.org/jira/browse/JCR-3091", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java"}, {"additions": 12, "raw_url": "https://github.com/apache/jackrabbit/raw/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java", "sha": "31b1d560beaca24b8a6249255f91ceada7a33726", "changes": 12, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java?ref=936453a1287000626f6074db6ad0537ece561d9c", "patch": "@@ -243,4 +243,16 @@ public void testSimpleQuery() throws Exception {\n         executeSQLQuery(sql, new Node[] {foo});\n     }\n \n+    /**\n+     * JCR-3337\n+     */\n+    public void testNotIsDescendantNodeQuery() throws Exception {\n+        Node foo = testRootNode.addNode(\"foo\");\n+        testRootNode.getSession().save();\n+        String sql = \"SELECT a.* FROM [nt:base] as a WHERE isdescendantnode(a,'\"\n+                + testRootNode.getPath()\n+                + \"') and not isdescendantnode(a,'\"\n+                + foo.getPath() + \"')\";\n+        executeSQL2Query(sql, new Node[] {});\n+    }\n }", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/369b3d6496d02e44c770d355fd20e7ca7f718db8", "parent": "https://github.com/apache/jackrabbit/commit/4e02044524a2dfc9f5502bd29663b37adfc061ff", "message": "JCR-3189 JCARepositoryManager.createNonTransientRepository throws NPE with no JCAManagedConnectionFactory.CONFIGFILE_KEY\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1232831 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_17", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/369b3d6496d02e44c770d355fd20e7ca7f718db8/jackrabbit-jca/src/main/java/org/apache/jackrabbit/jca/JCARepositoryManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/369b3d6496d02e44c770d355fd20e7ca7f718db8/jackrabbit-jca/src/main/java/org/apache/jackrabbit/jca/JCARepositoryManager.java", "sha": "efaaf8ffe58c26f21299d193cd016bed32f097ff", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jca/src/main/java/org/apache/jackrabbit/jca/JCARepositoryManager.java?ref=369b3d6496d02e44c770d355fd20e7ca7f718db8", "patch": "@@ -24,6 +24,7 @@\n import org.apache.jackrabbit.core.RepositoryImpl;\n import org.apache.jackrabbit.core.config.RepositoryConfig;\n \n+import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n import java.util.HashMap;\n@@ -115,8 +116,10 @@ private Repository createNonTransientRepository(\n                     }\n                 }\n             }            \t\n-        } else {\n+        } else if (configFile != null) {\n             config = RepositoryConfig.create(configFile, homeDir);\n+        } else {\n+            config = RepositoryConfig.create(new File(homeDir));\n         }\n         return RepositoryImpl.create(config);\n \t}", "filename": "jackrabbit-jca/src/main/java/org/apache/jackrabbit/jca/JCARepositoryManager.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/df3bb8b94b3b34b0cd21d1c4873cb326226c8918", "parent": "https://github.com/apache/jackrabbit/commit/9ccd17ce5df1888a815ca03f22aad6d2a82c3aa7", "message": "JCR-3163 NPE in RepositoryServiceImpl.getPropertyInfo()\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1209033 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_18", "file": [{"additions": 12, "raw_url": "https://github.com/apache/jackrabbit/raw/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java", "sha": "af0e96341d1fb009dee8b82b250a28e406e355b5", "changes": 12, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java?ref=df3bb8b94b3b34b0cd21d1c4873cb326226c8918", "patch": "@@ -271,4 +271,16 @@ public void testGetPropertyOfRemovedAncestor() throws RepositoryException {\n             rw.logout();\n         }\n     }\n+\n+    public void testGetDeepEmptyStringProperty() throws RepositoryException, NotExecutableException {\n+        Node n = testRootNode.getNode(nodeName1);\n+        Node n2 = n.addNode(nodeName2);\n+        Node n3 = n2.addNode(nodeName3);\n+        Node n4 = n3.addNode(nodeName4);\n+        Property emptyProp = n4.setProperty(propertyName1, \"\");\n+        testRootNode.save();\n+\n+        Property p = readOnly.getProperty(emptyProp.getPath());\n+        assertEquals(\"\", p.getString());\n+    }\n }", "filename": "jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java"}, {"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java", "sha": "762dfa0dd4b5e0c2445423e2d3ac43040d08a4cd", "changes": 5, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java?ref=df3bb8b94b3b34b0cd21d1c4873cb326226c8918", "patch": "@@ -413,9 +413,10 @@ public PropertyInfo getPropertyInfo(SessionInfo sessionInfo, PropertyId property\n                     QValue qValue = getQValueFactory(sessionInfo).create(length, uri, QValueFactoryImpl.NO_INDEX) ;\n                     return new PropertyInfoImpl(propertyId, p, propertyType, qValue);\n                 }\n-            } else if (props.contains(JCR_GET_STRING) && props.get(JCR_GET_STRING).getValue() != null) {\n+            } else if (props.contains(JCR_GET_STRING)) {\n                 // single valued non-binary property\n-                String str = props.get(JCR_GET_STRING).getValue().toString();\n+                Object v = props.get(JCR_GET_STRING).getValue();\n+                String str = (v == null) ? \"\" : v.toString();\n                 QValue qValue = ValueFormat.getQValue(str, propertyType, getNamePathResolver(sessionInfo), getQValueFactory(sessionInfo));\n                 return new PropertyInfoImpl(propertyId, p, propertyType, qValue);\n             } else {", "filename": "jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/ef3bfe520b24fd3ddaad11252cdf1807666e8113", "parent": "https://github.com/apache/jackrabbit/commit/03c23d0b5233e2c0bf2bf86c5c8035724f54cc8c", "message": "JCR-3163 NPE in RepositoryServiceImpl.getPropertyInfo()\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1208818 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_19", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/ef3bfe520b24fd3ddaad11252cdf1807666e8113/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/ef3bfe520b24fd3ddaad11252cdf1807666e8113/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java", "sha": "4406b5b454eef647b43ac23981018a9f7c01e568", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java?ref=ef3bfe520b24fd3ddaad11252cdf1807666e8113", "patch": "@@ -413,7 +413,7 @@ public PropertyInfo getPropertyInfo(SessionInfo sessionInfo, PropertyId property\n                     QValue qValue = getQValueFactory(sessionInfo).create(length, uri, QValueFactoryImpl.NO_INDEX) ;\n                     return new PropertyInfoImpl(propertyId, p, propertyType, qValue);\n                 }\n-            } else if (props.contains(JCR_GET_STRING)) {\n+            } else if (props.contains(JCR_GET_STRING) && props.get(JCR_GET_STRING).getValue() != null) {\n                 // single valued non-binary property\n                 String str = props.get(JCR_GET_STRING).getValue().toString();\n                 QValue qValue = ValueFormat.getQValue(str, propertyType, getNamePathResolver(sessionInfo), getQValueFactory(sessionInfo));", "filename": "jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/aef547f481e6250a9d1ff73b9c567b3403f8e62f", "parent": "https://github.com/apache/jackrabbit/commit/ae8de242047148e14dafce3205f256b4b1f80dcf", "message": "guard against npe on exceptional path\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1200742 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_20", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/aef547f481e6250a9d1ff73b9c567b3403f8e62f/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/CachingIndexReader.java", "blob_url": "https://github.com/apache/jackrabbit/blob/aef547f481e6250a9d1ff73b9c567b3403f8e62f/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/CachingIndexReader.java", "sha": "8c0d7756b52a244009c25cca540f7b380f8aacdc", "changes": 4, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/CachingIndexReader.java?ref=aef547f481e6250a9d1ff73b9c567b3403f8e62f", "patch": "@@ -629,7 +629,9 @@ public void saveCacheToFile() throws IOException {\n                         \"Error saving \" + FILE_CACHE_NAME_ARRAY + \": \"\n                                 + e.getMessage(), e);\n             } finally {\n-                io.close();\n+                if (io != null) {\n+                    io.close();\n+                }\n             }\n         }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/CachingIndexReader.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/3117b716d6ec29073f570938ce30e963dc7aa004", "parent": "https://github.com/apache/jackrabbit/commit/4d9b9b9774c4f6b46fe89fbd27e155dd09557dd9", "message": "JCR-3105 - fix potential NPE on concurrent versioning operations\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1181712 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_21", "file": [{"additions": 5, "raw_url": "https://github.com/apache/jackrabbit/raw/3117b716d6ec29073f570938ce30e963dc7aa004/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "blob_url": "https://github.com/apache/jackrabbit/blob/3117b716d6ec29073f570938ce30e963dc7aa004/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "sha": "ad2349b1f66590fbd93e54d5361b2b4ba007d472", "changes": 9, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java?ref=3117b716d6ec29073f570938ce30e963dc7aa004", "patch": "@@ -546,12 +546,13 @@ protected static NodeStateEx getParentNode(NodeStateEx parent, String uuid, Name\n         NodeStateEx n = parent;\n         for (int i = 0; i < 3; i++) {\n             Name name = getName(uuid.substring(i * 2, i * 2 + 2));\n-            if (n.hasNode(name)) {\n-                n = n.getNode(name, 1);\n+            NodeStateEx childn = n.getNode(name, 1);\n+            if (childn != null) {\n+                n = childn;\n             } else if (interNT != null) {\n-                n.addNode(name, interNT, null, false);\n+                childn = n.addNode(name, interNT, null, false);\n                 n.store();\n-                n = n.getNode(name, 1);\n+                n = childn;\n             } else {\n                 return null;\n             }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/6f67f6fb6520fd7c9e65bdffa0c52e42ee7d96d2", "parent": "https://github.com/apache/jackrabbit/commit/d0f888a068a29c17d8751250b2c867b2deaf206c", "message": "JCR-3049: NPE in ConsolidatingChangeLog for id base NodeId\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1161059 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_22", "file": [{"additions": 11, "raw_url": "https://github.com/apache/jackrabbit/raw/6f67f6fb6520fd7c9e65bdffa0c52e42ee7d96d2/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "blob_url": "https://github.com/apache/jackrabbit/blob/6f67f6fb6520fd7c9e65bdffa0c52e42ee7d96d2/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "sha": "cf8d1ef2eacced5ff03c6f4ee8f0eded440a1397", "changes": 14, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java?ref=6f67f6fb6520fd7c9e65bdffa0c52e42ee7d96d2", "patch": "@@ -54,13 +54,14 @@ public ConsolidatingChangeLog() {\n      * child.\n      * @param parentId  node id of the parent\n      * @param name  name of the child\n-     * @return  the path of the item <code>name</code>\n+     * @return  the path of the item <code>name</code> or <code>null</code> if <code>parentId</code>'s\n+     * path is not absolute\n      * @throws RepositoryException\n      */\n     protected static Path getPath(NodeId parentId, Name name) throws RepositoryException {\n         Path parent = parentId.getPath();\n         if (!parent.isAbsolute()) {\n-            throw new IllegalArgumentException(\"Path not absolute: \" + parent);\n+            return null;\n         }\n \n         return PATH_FACTORY.create(parent, name, true);\n@@ -69,7 +70,8 @@ protected static Path getPath(NodeId parentId, Name name) throws RepositoryExcep\n     /**\n      * Determine the {@link Path} from an {@link ItemId}.\n      * @param itemId\n-     * @return  path of the item <code>itemId</code>\n+     * @return  path of the item <code>itemId</code> or <code>null</code> if <code>itemId</code>'s\n+     * path is not absolute\n      */\n     protected static Path getPath(ItemId itemId) {\n         Path path = itemId.getPath();\n@@ -366,6 +368,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                 if (other instanceof Remove) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(parentId, propertyName);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((Remove) other).itemId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     if (thisPath.equals(otherPath)) {\n                         return CANCEL_BOTH;\n                     }\n@@ -377,6 +382,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                     SetValue setValue = (SetValue) other;\n                     Path thisPath = ConsolidatingChangeLog.getPath(parentId, propertyName);\n                     Path otherPath = ConsolidatingChangeLog.getPath(setValue.propertyId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     if (thisPath.equals(otherPath)) {\n                         if (!isMultivalued && setValue.values[0] == null) {\n                             return CANCEL_BOTH;", "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/fd9513124a25480a186596086abea91f58074c5e", "parent": "https://github.com/apache/jackrabbit/commit/9f4400916cc6aa93888d24e5ff5503742c2eeee1", "message": "JCR-3055 NPE in event polling thread\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1158330 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_23", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/fd9513124a25480a186596086abea91f58074c5e/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/fd9513124a25480a186596086abea91f58074c5e/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java", "sha": "cf885f6090b404ec91226b1fd8eef8fc66a20766", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java?ref=fd9513124a25480a186596086abea91f58074c5e", "patch": "@@ -901,7 +901,7 @@ public void refresh(Event childEvent) {\n         ItemId eventId = childEvent.getItemId();\n         Path eventPath = childEvent.getPath();\n         Name eventName = eventPath.getName();\n-        HierarchyEntry child = lookupEntry(eventId, eventPath);\n+        HierarchyEntry child = eventId == null ? null : lookupEntry(eventId, eventPath);\n \n         switch (childEvent.getType()) {\n             case Event.NODE_ADDED:", "filename": "jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/c6d2e5124ac85811629739db1974fcb8cfc14183", "parent": "https://github.com/apache/jackrabbit/commit/dd303b3f668ddd3e1f4b7f657f578e34abd61118", "message": "JCR-3049: NPE in ConsolidatingChangeLog for id base NodeId\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1157042 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_24", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/c6d2e5124ac85811629739db1974fcb8cfc14183/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "blob_url": "https://github.com/apache/jackrabbit/blob/c6d2e5124ac85811629739db1974fcb8cfc14183/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "sha": "b6093584703d59543a4063d51c30d0afc564e6e0", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java?ref=c6d2e5124ac85811629739db1974fcb8cfc14183", "patch": "@@ -74,7 +74,7 @@ protected static Path getPath(NodeId parentId, Name name) throws RepositoryExcep\n     protected static Path getPath(ItemId itemId) {\n         Path path = itemId.getPath();\n         if (path != null && !path.isAbsolute()) {\n-            throw new IllegalArgumentException(\"Path not absoulte: \" + path);\n+            return null;\n         }\n         return path;\n     }", "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/dd303b3f668ddd3e1f4b7f657f578e34abd61118", "parent": "https://github.com/apache/jackrabbit/commit/8c65b9c138496c5883519d283811881db747f86e", "message": "JCR-3049: NPE in ConsolidatingChangeLog for id base NodeId\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1157025 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_25", "file": [{"additions": 34, "raw_url": "https://github.com/apache/jackrabbit/raw/dd303b3f668ddd3e1f4b7f657f578e34abd61118/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "blob_url": "https://github.com/apache/jackrabbit/blob/dd303b3f668ddd3e1f4b7f657f578e34abd61118/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "sha": "364514338ef375136cf2eb671d0b9f8f7da1fe14", "changes": 36, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java?ref=dd303b3f668ddd3e1f4b7f657f578e34abd61118", "patch": "@@ -73,7 +73,7 @@ protected static Path getPath(NodeId parentId, Name name) throws RepositoryExcep\n      */\n     protected static Path getPath(ItemId itemId) {\n         Path path = itemId.getPath();\n-        if (!path.isAbsolute()) {\n+        if (path != null && !path.isAbsolute()) {\n             throw new IllegalArgumentException(\"Path not absoulte: \" + path);\n         }\n         return path;\n@@ -298,6 +298,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                 if (other instanceof Remove) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(parentId, nodeName);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((Remove) other).itemId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     if (thisPath.equals(otherPath)) {\n                         return CANCEL_BOTH;\n                     }\n@@ -509,13 +512,19 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                 if (other instanceof Remove) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(srcNodeId);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((Remove) other).itemId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     return thisPath.isDescendantOf(otherPath) || thisPath.equals(otherPath)\n                         ? CANCEL_THIS\n                         : CANCEL_NONE;\n                 }\n                 if (other instanceof ReorderNodes) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(parentId);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((ReorderNodes) other).parentId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     return thisPath.equals(otherPath) && !hasSNS(srcNodeId) && !hasSNS(beforeNodeId)\n                         ? CANCEL_THIS\n                         : CANCEL_NONE;\n@@ -524,7 +533,12 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n             }\n \n             private boolean hasSNS(NodeId nodeId) {\n-                return nodeId != null && ConsolidatingChangeLog.getPath(nodeId).getIndex() > 1;\n+                if (nodeId != null) {\n+                    Path path = ConsolidatingChangeLog.getPath(nodeId);\n+                    return path != null && path.getIndex() > 1;\n+                }\n+\n+                return false;\n             }\n         }\n \n@@ -569,6 +583,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                 if (other instanceof Remove) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(nodeId);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((Remove) other).itemId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     return thisPath.isDescendantOf(otherPath) || thisPath.equals(otherPath)\n                         ? CANCEL_THIS\n                         : CANCEL_NONE;\n@@ -578,6 +595,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                     if (mixinNodeTypeNames.length == setMixin.mixinNodeTypeNames.length) {\n                         Path thisPath = ConsolidatingChangeLog.getPath(nodeId);\n                         Path otherPath = ConsolidatingChangeLog.getPath(setMixin.nodeId);\n+                        if (thisPath == null || otherPath == null) {\n+                            return CANCEL_NONE;\n+                        }\n                         if (thisPath.equals(otherPath)) {\n                             for (int k = 0; k < mixinNodeTypeNames.length; k++) {\n                                 if (!mixinNodeTypeNames[k].equals(setMixin.mixinNodeTypeNames[k])) {\n@@ -632,6 +652,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                 if (other instanceof Remove) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(nodeId);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((Remove) other).itemId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     return thisPath.isDescendantOf(otherPath) || thisPath.equals(otherPath)\n                         ? CANCEL_THIS\n                         : CANCEL_NONE;\n@@ -641,6 +664,9 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                     if (primaryTypeName.equals(setPrimaryType.primaryTypeName)) {\n                         Path thisPath = ConsolidatingChangeLog.getPath(nodeId);\n                         Path otherPath = ConsolidatingChangeLog.getPath(setPrimaryType.nodeId);\n+                        if (thisPath == null || otherPath == null) {\n+                            return CANCEL_NONE;\n+                        }\n                         if (thisPath.equals(otherPath)) {\n                             return CANCEL_THIS;\n                         }\n@@ -693,13 +719,19 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n                 if (other instanceof Remove) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(propertyId);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((Remove) other).itemId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     return thisPath.isDescendantOf(otherPath) || thisPath.equals(otherPath)\n                         ? CANCEL_THIS\n                         : CANCEL_NONE;\n                 }\n                 if (other instanceof SetValue) {\n                     Path thisPath = ConsolidatingChangeLog.getPath(propertyId);\n                     Path otherPath = ConsolidatingChangeLog.getPath(((SetValue) other).propertyId);\n+                    if (thisPath == null || otherPath == null) {\n+                        return CANCEL_NONE;\n+                    }\n                     if (thisPath.equals(otherPath)) {\n                         return CANCEL_THIS;\n                     }", "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/dc18482310b2023b7cec952a65080369889ef6bf", "parent": "https://github.com/apache/jackrabbit/commit/accf70f056f47f577928a6c21d60f886bb96e549", "message": "JCR-3025: NPE in ConsolidatingChangeLog\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1148442 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_26", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/dc18482310b2023b7cec952a65080369889ef6bf/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "blob_url": "https://github.com/apache/jackrabbit/blob/dc18482310b2023b7cec952a65080369889ef6bf/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java", "sha": "0c87f38f02a62c31f8bb1858416b5ca78fd7fdb1", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java?ref=dc18482310b2023b7cec952a65080369889ef6bf", "patch": "@@ -524,7 +524,7 @@ public int cancel(CancelableOperation other) throws RepositoryException {\n             }\n \n             private boolean hasSNS(NodeId nodeId) {\n-                return ConsolidatingChangeLog.getPath(nodeId).getIndex() > 1;\n+                return nodeId != null && ConsolidatingChangeLog.getPath(nodeId).getIndex() > 1;\n             }\n         }\n ", "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/batch/ConsolidatingChangeLog.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/df0962e7e7ad68f89f52ad59cbb3ecb4aabc194d", "parent": "https://github.com/apache/jackrabbit/commit/5d73d05bb45bfe574035fc3440d1c0b5095cc0e1", "message": "JCR-2967: SessionItemStateManager.getIdOfRootTransientNodeState() may cause NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1101046 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_27", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/df0962e7e7ad68f89f52ad59cbb3ecb4aabc194d/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/df0962e7e7ad68f89f52ad59cbb3ecb4aabc194d/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "sha": "635b975458cb98c5b7325009e4c31c7a80189005", "changes": 7, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java?ref=df0962e7e7ad68f89f52ad59cbb3ecb4aabc194d", "patch": "@@ -462,15 +462,16 @@ public NodeId getIdOfRootTransientNodeState() throws RepositoryException {\n \n         // the nearest common ancestor of all transient states\n         // must be either\n-        // a) a node state with STATUS_EXISTING_MODIFIED, or\n-        // b) the parent node of a property state with STATUS_EXISTING_MODIFIED\n+        // a) a node state with STATUS_EXISTING_MODIFIED or STATUS_STALE_DESTROYED, or\n+        // b) the parent node of a property state with STATUS_EXISTING_MODIFIED or STATUS_STALE_DESTROYED\n \n         // collect all candidates based on above criteria\n         Collection<NodeId> candidateIds = new LinkedList<NodeId>();\n         try {\n             HierarchyManager hierMgr = getHierarchyMgr();\n             for (ItemState state : transientStore.values()) {\n-                if (state.getStatus() == ItemState.STATUS_EXISTING_MODIFIED) {\n+                if (state.getStatus() == ItemState.STATUS_EXISTING_MODIFIED\n+                        || state.getStatus() == ItemState.STATUS_STALE_DESTROYED) {\n                     NodeId nodeId;\n                     if (state.isNode()) {\n                         nodeId = (NodeId) state.getId();", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/6f86c84fc59da1cb9c54ff659a6bbbfc25c64498", "parent": "https://github.com/apache/jackrabbit/commit/828e730f556c83e9dbc46384383d6f3081b316f1", "message": "JCR-2655: initVersions crashes with NPE\n\nMake an unmodified variable final.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1032621 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_28", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/6f86c84fc59da1cb9c54ff659a6bbbfc25c64498/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/6f86c84fc59da1cb9c54ff659a6bbbfc25c64498/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java", "sha": "7d2df985c5d0f05dfb89633dfc04a0125fc91b2f", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java?ref=6f86c84fc59da1cb9c54ff659a6bbbfc25c64498", "patch": "@@ -43,7 +43,7 @@\n     /**\n      * the id's of the versions to return\n      */\n-    private LinkedList<NodeId> versions = new LinkedList<NodeId>();\n+    private final LinkedList<NodeId> versions = new LinkedList<NodeId>();\n \n     /**\n      * the current position", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/37f41a7715e128cf78a599199b7768311e8be1f9", "parent": "https://github.com/apache/jackrabbit/commit/aa2c73ce74f4fe786874e8c420f19b12e61fb112", "message": "JCR-2484: NPE if RepositoryService#getItemInfos throws ItemNotFoundException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@905997 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_29", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/37f41a7715e128cf78a599199b7768311e8be1f9/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyEntryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/37f41a7715e128cf78a599199b7768311e8be1f9/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyEntryImpl.java", "sha": "58a52888601ca84a2d274086b3754bab5a14a6bf", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyEntryImpl.java?ref=37f41a7715e128cf78a599199b7768311e8be1f9", "patch": "@@ -416,7 +416,7 @@ void internalRemove(boolean staleParent) {\n             }\n         } else {\n             // unresolved\n-            if (!staleParent) {\n+            if (!staleParent && parent != null) {\n                 parent.internalRemoveChildEntry(this);\n             }\n         }", "filename": "jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyEntryImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/a5c7496fde2a57bd754c962dc9d0b6c6802a839b", "parent": "https://github.com/apache/jackrabbit/commit/7199f14a20aefa3c42c7c51bfc081cde9abe7bcf", "message": "JCR-1592: removeActivity failed with NPE when no current activity set\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@791452 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_30", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/a5c7496fde2a57bd754c962dc9d0b6c6802a839b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/JcrVersionManagerImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a5c7496fde2a57bd754c962dc9d0b6c6802a839b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/JcrVersionManagerImpl.java", "sha": "7343469355702a7249d6106a226e7931766c4e62", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/JcrVersionManagerImpl.java?ref=a5c7496fde2a57bd754c962dc9d0b6c6802a839b", "patch": "@@ -251,7 +251,7 @@ public void removeActivity(Node node) throws RepositoryException {\n         }\n         NodeId actId = actNode.getNodeId();\n         session.getVersionManager().removeActivity(session, actId);\n-        if (currentActivity.equals(actId)) {\n+        if (actId.equals(currentActivity)) {\n             currentActivity = null;\n         }\n     }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/JcrVersionManagerImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/a4991790f9ab4135c1780a7ed73ada43528e5a7e", "parent": "https://github.com/apache/jackrabbit/commit/89fe1177eb816933d20cb0a0426e276691e0522e", "message": "JCR-1646: NPE in OpenOfficeTextExtractor\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@666098 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_31", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/a4991790f9ab4135c1780a7ed73ada43528e5a7e/jackrabbit-text-extractors/src/main/java/org/apache/jackrabbit/extractor/OpenOfficeTextExtractor.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a4991790f9ab4135c1780a7ed73ada43528e5a7e/jackrabbit-text-extractors/src/main/java/org/apache/jackrabbit/extractor/OpenOfficeTextExtractor.java", "sha": "252306b383c192e1e881217a6541f116458823b9", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-text-extractors/src/main/java/org/apache/jackrabbit/extractor/OpenOfficeTextExtractor.java?ref=a4991790f9ab4135c1780a7ed73ada43528e5a7e", "patch": "@@ -75,7 +75,7 @@ public Reader extractText(InputStream stream,\n \n             ZipInputStream zis = new ZipInputStream(stream);\n             ZipEntry ze = zis.getNextEntry();\n-            while (!ze.getName().equals(\"content.xml\")) {\n+            while (ze != null && !ze.getName().equals(\"content.xml\")) {\n                 ze = zis.getNextEntry();\n             }\n ", "filename": "jackrabbit-text-extractors/src/main/java/org/apache/jackrabbit/extractor/OpenOfficeTextExtractor.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/087af73b40d3592418832f190a140b2541701189", "parent": "https://github.com/apache/jackrabbit/commit/e806b85d5ec84adadefe03bb3cd033566ff1a010", "message": "JCR-1131: JCR2SPI NodeEntryImpl throws NPE during reorderNodes\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@576296 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_32", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/087af73b40d3592418832f190a140b2541701189/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/087af73b40d3592418832f190a140b2541701189/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java", "sha": "e1dc7dd40c8f06ebe075d89976cbaaa8af9727b0", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java?ref=087af73b40d3592418832f190a140b2541701189", "patch": "@@ -1351,7 +1351,10 @@ private void revertTransientChanges() throws RepositoryException {\n      */\n     private void completeTransientChanges() {\n         // old parent can forget this one\n-        revertInfo.oldParent.childNodeAttic.remove(this);\n+        // root entry does not have oldParent\n+        if (revertInfo.oldParent != null) {\n+            revertInfo.oldParent.childNodeAttic.remove(this);\n+        }\n         revertInfo.dispose();\n         revertInfo = null;\n     }", "filename": "contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/NodeEntryImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b", "parent": "https://github.com/apache/jackrabbit/commit/c0bca944465ca480ffd9d5f7112a6aa8f2093cb7", "message": "JCR-931: cluster synchronization NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@540492 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_33", "file": [{"additions": 6, "raw_url": "https://github.com/apache/jackrabbit/raw/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java", "sha": "cb8bb08f50679e2e330f352d09213e763b5b0985", "changes": 6, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java?ref=a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b", "patch": "@@ -164,6 +164,12 @@ protected Document createDoc() throws RepositoryException {\n                 doc.add(new Field(FieldNames.PARENT, node.getParentId().toString(), Field.Store.YES, Field.Index.UN_TOKENIZED, Field.TermVector.NO));\n                 NodeState parent = (NodeState) stateProvider.getItemState(node.getParentId());\n                 NodeState.ChildNodeEntry child = parent.getChildNodeEntry(node.getNodeId());\n+                if (child == null) {\n+                    // this can only happen when jackrabbit\n+                    // is running in a cluster.\n+                    throw new RepositoryException(\"Missing child node entry \" +\n+                            \"for node with id: \" + node.getNodeId());\n+                }\n                 String name = NameFormat.format(child.getName(), mappings);\n                 doc.add(new Field(FieldNames.LABEL, name, Field.Store.NO, Field.Index.UN_TOKENIZED, Field.TermVector.NO));\n             }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java"}, {"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java", "sha": "af975ed5c9ad7e04a74563266cc45897a2fea944", "changes": 6, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java?ref=a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b", "patch": "@@ -422,11 +422,11 @@ public Object next() {\n                 Document doc = null;\n                 try {\n                     doc = createDocument(state, getNamespaceMappings());\n+                    retrieveAggregateRoot(state, aggregateRoots);\n                 } catch (RepositoryException e) {\n-                    log.error(\"Exception while creating document for node: \"\n+                    log.warn(\"Exception while creating document for node: \"\n                             + state.getNodeId() + \": \" + e.toString());\n                 }\n-                retrieveAggregateRoot(state, aggregateRoots);\n                 return doc;\n             }\n         });\n@@ -451,7 +451,7 @@ public Object next() {\n                     try {\n                         return createDocument(state, getNamespaceMappings());\n                     } catch (RepositoryException e) {\n-                        log.error(\"Exception while creating document for node: \"\n+                        log.warn(\"Exception while creating document for node: \"\n                                 + state.getNodeId() + \": \" + e.toString());\n                     }\n                     return null;", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/53b661237c6cd1ce2f1b50792375f0f6852faeaf", "parent": "https://github.com/apache/jackrabbit/commit/4bea7293726749d8f89ae4fe80d98d9e369bb2dd", "message": "JCR-648: fixed potential cause of NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@480877 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_34", "file": [{"additions": 2, "raw_url": "https://github.com/apache/jackrabbit/raw/53b661237c6cd1ce2f1b50792375f0f6852faeaf/jackrabbit/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/53b661237c6cd1ce2f1b50792375f0f6852faeaf/jackrabbit/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "sha": "dcbdbf436aed021761153883559d22cf237b18be", "changes": 5, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java?ref=53b661237c6cd1ce2f1b50792375f0f6852faeaf", "patch": "@@ -90,16 +90,15 @@\n     public SessionItemStateManager(NodeId rootNodeId,\n                                    LocalItemStateManager stateMgr,\n                                    NamespaceResolver nsResolver) {\n+        transientStore = new ItemStateMap();\n+        atticStore = new ItemStateMap();\n \n         this.stateMgr = stateMgr;\n         stateMgr.addListener(this);\n \n         // create hierarchy manager that uses both transient and persistent state\n         hierMgr = new CachingHierarchyManager(rootNodeId, this, nsResolver);\n         addListener(hierMgr);\n-\n-        transientStore = new ItemStateMap();\n-        atticStore = new ItemStateMap();\n     }\n \n     /**", "filename": "jackrabbit/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/b25503c7e069a88cd8ffa0499538e44b41f95783", "parent": "https://github.com/apache/jackrabbit/commit/e2272fe4ed0172d584f1094083f2aaa94d889468", "message": "JCR-541: NPE in PredefinedNodeTypeTest.getPropertyDefSpec\n- PropertyDefinition.getValueConstratins() may return null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@430715 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_35", "file": [{"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java", "sha": "2c00e83fba7dfd1de460d0bb52de84a1b2aa30f1", "changes": 9, "status": "modified", "deletions": 9, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -364,15 +364,6 @@ private static String getPropertyDefSpec(PropertyDefinition property)\n         }\n         String type = PropertyType.nameFromValue(property.getRequiredType());\n         writer.println(\"  RequiredType \" + type.toUpperCase());\n-        writer.print(\"  ValueConstraints [\");\n-        String[] constraints = property.getValueConstraints();\n-        for (int i = 0; i < constraints.length; i++) {\n-            if (i > 0) {\n-                writer.print(',');\n-            }\n-            writer.print(constraints[i]);\n-        }\n-        writer.println(\"]\");\n         Value[] values = property.getDefaultValues();\n         if (values != null && values.length > 0) {\n             writer.print(\"  DefaultValues [\");", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt", "sha": "f0e0b774c6be5d5e0d617378e773cf729aefd7ad", "changes": 2, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:lockIsDeep\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:lockOwner\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt", "sha": "634c9854a4c5a3dd39839b67408eae7e146d58e0", "changes": 1, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:uuid\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt", "sha": "8aff88e48089378642017d566ed8dc223e37ef85", "changes": 5, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:baseVersion\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:isCheckedOut\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues [true]\n   AutoCreated true\n   Mandatory true\n@@ -31,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mergeFailed\n   RequiredType REFERENCE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -41,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:predecessors\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -51,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:versionHistory\n   RequiredType REFERENCE\n-  ValueConstraints [nt:versionHistory]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt", "sha": "24eec467ce63b220c6959ed0465ccec3d97d5fd3", "changes": 2, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:mixinTypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:primaryType\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt", "sha": "1a5954e38d534d1e9f8d045755890f8a534cae07", "changes": 8, "status": "modified", "deletions": 8, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:autoCreated\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:defaultPrimaryType\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -31,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mandatory\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -41,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:name\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -51,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:onParentVersion\n   RequiredType STRING\n-  ValueConstraints [COPY,VERSION,INITIALIZE,COMPUTE,IGNORE,ABORT]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -61,7 +56,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:protected\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -71,7 +65,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:requiredPrimaryTypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues [nt:base]\n   AutoCreated false\n   Mandatory true\n@@ -81,7 +74,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:sameNameSiblings\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt", "sha": "76ff255f5bc5b616512d7945bde192402a0b9fd5", "changes": 5, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -21,7 +21,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:frozenMixinTypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -31,7 +30,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:frozenPrimaryType\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true\n@@ -41,7 +39,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:frozenUuid\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true\n@@ -51,7 +48,6 @@ PropertyDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -61,7 +57,6 @@ PropertyDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt", "sha": "70819a663ebfda918b87cb7729a1fd325dfbb6c2", "changes": 1, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:created\n   RequiredType DATE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt", "sha": "372dae8004cc99851486db6586ef83c6f73d43ea", "changes": 1, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:content\n   RequiredType REFERENCE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt", "sha": "f9302563dbdcb22b76f552e0e756713bd504eb67", "changes": 5, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -29,7 +29,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:hasOrderableChildNodes\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -39,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:isMixin\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -49,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:nodeTypeName\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -59,7 +56,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:primaryItemName\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -69,7 +65,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:supertypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt", "sha": "96300ed1606c4b167338277e253de6186c98b13e", "changes": 9, "status": "modified", "deletions": 9, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:autoCreated\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:defaultValues\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -31,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mandatory\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -41,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:multiple\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -51,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:name\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -61,7 +56,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:onParentVersion\n   RequiredType STRING\n-  ValueConstraints [COPY,VERSION,INITIALIZE,COMPUTE,IGNORE,ABORT]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -71,7 +65,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:protected\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -81,7 +74,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:requiredType\n   RequiredType STRING\n-  ValueConstraints [STRING,BINARY,LONG,DOUBLE,BOOLEAN,DATE,NAME,PATH,REFERENCE,UNDEFINED]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -91,7 +83,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:valueConstraints\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt", "sha": "b4dba314ab058ddc60bc22fcdb12f45ea5824ae9", "changes": 2, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:language\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:statement\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt", "sha": "0ac93bf4f0450b9d06127e7fc61bf5b6eb9dd516", "changes": 4, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -12,7 +12,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:data\n   RequiredType BINARY\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -22,7 +21,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:encoding\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -32,7 +30,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:lastModified\n   RequiredType DATE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -42,7 +39,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mimeType\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt", "sha": "20030495c86e4bea63bd7daf5811d41c2734eb96", "changes": 2, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -20,7 +20,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -30,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt", "sha": "cac88227083978d22fce4951964ef9a1134688c0", "changes": 3, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -21,7 +21,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:created\n   RequiredType DATE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true\n@@ -31,7 +30,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:predecessors\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -41,7 +39,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:successors\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt", "sha": "cad4c8f779c529cf5576a8972f2c239479083e22", "changes": 1, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -39,7 +39,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:versionableUuid\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt", "sha": "71054269ddc32930ca6b1e752dc0248551c9a11d", "changes": 1, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name \"*\"\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory false", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt", "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt", "sha": "8b101a09fdc648a2e2b7c2af5a5dc1c4f478864d", "changes": 1, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783", "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:childVersionHistory\n   RequiredType REFERENCE\n-  ValueConstraints [nt:versionHistory]\n   DefaultValues null\n   AutoCreated true\n   Mandatory true", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/a0b46378111db40c38862ae45eea1e5387b91fbd", "parent": "https://github.com/apache/jackrabbit/commit/0ce449c65fc93dd402fd1d88ba3baa8e89be69df", "message": "adding simple protection of eventual NPE. need to investigate further.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@405567 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_36", "file": [{"additions": 6, "raw_url": "https://github.com/apache/jackrabbit/raw/a0b46378111db40c38862ae45eea1e5387b91fbd/jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a0b46378111db40c38862ae45eea1e5387b91fbd/jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java", "sha": "b09ccddc9eed9e6ffa507674aff034661defd861", "changes": 8, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java?ref=a0b46378111db40c38862ae45eea1e5387b91fbd", "patch": "@@ -152,8 +152,12 @@ private void init() throws RepositoryException {\n                     QName name = pState.getName();\n                     UUID ref = (UUID) pState.getValues()[0].internalValue();\n                     InternalVersionImpl v = (InternalVersionImpl) getVersion(new NodeId(ref));\n-                    labelCache.put(name, v);\n-                    v.internalAddLabel(name);\n+                    if (v != null) {\n+                        labelCache.put(name, v);\n+                        v.internalAddLabel(name);\n+                    } else {\n+                        log.warn(\"Error while resolving label reference. Version missing: \" + ref);\n+                    }\n                 }\n             }\n         } catch (ItemStateException e) {", "filename": "jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/13bccb105c764cd3aa61d34649a3b9efa4b482cd", "parent": "https://github.com/apache/jackrabbit/commit/562b9c34963b405abfc2cbb1d1a618caddd07f6b", "message": "JCR-382: Setting WebDAV property without value causes NPE in DAVResourceImpl\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@390356 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_37", "file": [{"additions": 7, "raw_url": "https://github.com/apache/jackrabbit/raw/13bccb105c764cd3aa61d34649a3b9efa4b482cd/jcr-server/server/src/java/org/apache/jackrabbit/webdav/simple/DavResourceImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/13bccb105c764cd3aa61d34649a3b9efa4b482cd/jcr-server/server/src/java/org/apache/jackrabbit/webdav/simple/DavResourceImpl.java", "sha": "d45faca152fb7da8e32881afa4c8e15dbbe84106", "changes": 11, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jcr-server/server/src/java/org/apache/jackrabbit/webdav/simple/DavResourceImpl.java?ref=13bccb105c764cd3aa61d34649a3b9efa4b482cd", "patch": "@@ -929,10 +929,13 @@ private String getJcrName(DavPropertyName propName) throws RepositoryException {\n      * @throws RepositoryException\n      */\n     private void setJcrProperty(DavProperty property) throws RepositoryException {\n-        // retrieve value\n-        String value = property.getValue().toString();\n-        // set value; since multivalued-properties are not listed in the set\n-        // of available properties, this extra validation-check is omitted.\n+        // Retrieve the property value. Note, that a 'null' value is replaced\n+        // by empty string, since setting a jcr property value to 'null'\n+        // would be equivalent to its removal.\n+        String value = \"\";\n+        if (property.getValue() != null) {\n+            value = property.getValue().toString();\n+        }\n         node.setProperty(getJcrName(property.getName()), value);\n     }\n ", "filename": "jcr-server/server/src/java/org/apache/jackrabbit/webdav/simple/DavResourceImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/260862ca17080f2d5f6eb924f54b2a4b93c49638", "parent": "https://github.com/apache/jackrabbit/commit/93ff88412eca3b31693cbaa37acdb7d1b093e237", "message": "- fixing eventual NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@378253 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_38", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/260862ca17080f2d5f6eb924f54b2a4b93c49638/jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/260862ca17080f2d5f6eb924f54b2a4b93c49638/jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java", "sha": "26f6d11222ac503bae732514d8c536408db92e54", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java?ref=260862ca17080f2d5f6eb924f54b2a4b93c49638", "patch": "@@ -1508,7 +1508,7 @@ public synchronized NodeImpl addNode(QName nodeName, QName nodeTypeName,\n         if (nodeTypeName != null) {\n             nt = session.getNodeTypeManager().getNodeType(nodeTypeName);\n         }\n-        return internalAddChildNode(nodeName, nt, new NodeId(uuid));\n+        return internalAddChildNode(nodeName, nt, uuid == null ? null : new NodeId(uuid));\n     }\n \n     /**", "filename": "jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/b6f107161b15c4cf1674f76df98421152551c88a", "parent": "https://github.com/apache/jackrabbit/commit/7f1fde4d31a586d681f568453384c6a1fd95b400", "message": "- adding better handling for unexpected NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@190367 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_39", "file": [{"additions": 2, "raw_url": "https://github.com/apache/jackrabbit/raw/b6f107161b15c4cf1674f76df98421152551c88a/src/java/org/apache/jackrabbit/core/observation/EventStateCollection.java", "blob_url": "https://github.com/apache/jackrabbit/blob/b6f107161b15c4cf1674f76df98421152551c88a/src/java/org/apache/jackrabbit/core/observation/EventStateCollection.java", "sha": "69813c16e2b6d022047f29e83ecef0b7fac70f3b", "changes": 3, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/observation/EventStateCollection.java?ref=b6f107161b15c4cf1674f76df98421152551c88a", "patch": "@@ -378,7 +378,8 @@ private NodeTypeImpl getNodeType(NodeState node, SessionImpl session)\n             throws ItemStateException {\n         try {\n             return session.getNodeTypeManager().getNodeType(node.getNodeTypeName());\n-        } catch (NoSuchNodeTypeException e) {\n+        } catch (Exception e) {\n+            // also catch eventual runtime exceptions here\n             // should never happen actually\n             String msg = \"Item \" + node.getId() + \" has unknown node type: \" + node.getNodeTypeName();\n             log.error(msg);", "filename": "src/java/org/apache/jackrabbit/core/observation/EventStateCollection.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/6251ae013f83502b63a5ca7b88e50af8104c4a79", "parent": "https://github.com/apache/jackrabbit/commit/105b3b1d3496786cd85305e462d208edf66d1ca9", "message": "calling Node.getName() on disposed instance could throw NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@160858 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_40", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/6251ae013f83502b63a5ca7b88e50af8104c4a79/src/java/org/apache/jackrabbit/core/NodeImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/6251ae013f83502b63a5ca7b88e50af8104c4a79/src/java/org/apache/jackrabbit/core/NodeImpl.java", "sha": "5f4fb7aa9d03f5bb38a208be0b6a554849c8a1e3", "changes": 4, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/NodeImpl.java?ref=6251ae013f83502b63a5ca7b88e50af8104c4a79", "patch": "@@ -1617,12 +1617,14 @@ public boolean isNode() {\n      * {@inheritDoc}\n      */\n     public String getName() throws RepositoryException {\n+        // check state of this instance\n+        sanityCheck();\n+\n         if (state.getParentUUID() == null) {\n             // this is the root node\n             return \"\";\n         }\n \n-        //QName name = getPrimaryPath().getNameElement().getName();\n         QName name = session.getHierarchyManager().getName(id);\n         try {\n             return name.toJCRName(session.getNamespaceResolver());", "filename": "src/java/org/apache/jackrabbit/core/NodeImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/755261b37d3b958fd21af44435beea0f0e5f574c", "parent": "https://github.com/apache/jackrabbit/commit/0c4f85792cdbac9648fd6fc18d544cdcf8ef5c31", "message": "- fixing NPE in export of custom nodetypes\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@157729 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_41", "file": [{"additions": 6, "raw_url": "https://github.com/apache/jackrabbit/raw/755261b37d3b958fd21af44435beea0f0e5f574c/src/java/org/apache/jackrabbit/core/nodetype/xml/NodeTypeFormat.java", "blob_url": "https://github.com/apache/jackrabbit/blob/755261b37d3b958fd21af44435beea0f0e5f574c/src/java/org/apache/jackrabbit/core/nodetype/xml/NodeTypeFormat.java", "sha": "dfa45d2f8dc340e6b2955598302ef8e03b96a12b", "changes": 8, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/nodetype/xml/NodeTypeFormat.java?ref=755261b37d3b958fd21af44435beea0f0e5f574c", "patch": "@@ -243,8 +243,12 @@ private void readPrimaryItemName() throws InvalidNodeTypeDefException {\n      * Writes the primary item name of the node type definition.\n      */\n     private void writePrimaryItemName() {\n-        String value = toJCRName(def.getPrimaryItemName());\n-        setAttribute(PRIMARYITEMNAME_ATTRIBUTE, value);\n+        QName name = def.getPrimaryItemName();\n+        if (name == null) {\n+            setAttribute(PRIMARYITEMNAME_ATTRIBUTE, \"\");\n+        } else {\n+            setAttribute(PRIMARYITEMNAME_ATTRIBUTE, toJCRName(name));\n+        }\n     }\n \n     /**", "filename": "src/java/org/apache/jackrabbit/core/nodetype/xml/NodeTypeFormat.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/19cff315b9ba0d01002dceb39f74c8c3c09805a0", "parent": "https://github.com/apache/jackrabbit/commit/6ffd5f53a780cb6414bd48a28f2956f0198fcce5", "message": "fixed NPE that occured occasionally on repository instantiation \n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@125055 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_42", "file": [{"additions": 7, "raw_url": "https://github.com/apache/jackrabbit/raw/19cff315b9ba0d01002dceb39f74c8c3c09805a0/src/java/org/apache/jackrabbit/core/RepositoryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/19cff315b9ba0d01002dceb39f74c8c3c09805a0/src/java/org/apache/jackrabbit/core/RepositoryImpl.java", "sha": "f62e22602a3c31a992707c993b613c9b99d03c53", "changes": 13, "status": "modified", "deletions": 6, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/RepositoryImpl.java?ref=19cff315b9ba0d01002dceb39f74c8c3c09805a0", "patch": "@@ -125,6 +125,7 @@\n      */\n     private RepositoryImpl(RepositoryConfig repConfig) throws RepositoryException {\n         this.repConfig = repConfig;\n+\n         // setup file systems\n         repStore = repConfig.getFileSystem();\n         String fsRootPath = \"/meta\";\n@@ -240,6 +241,12 @@ private RepositoryImpl(RepositoryConfig repConfig) throws RepositoryException {\n             throw new RepositoryException(msg, fse);\n         }\n \n+        // load repository properties\n+        repProps = new Properties();\n+        loadRepProps();\n+        nodesCount = Long.parseLong(repProps.getProperty(STATS_NODE_COUNT_PROPERTY, \"0\"));\n+        propsCount = Long.parseLong(repProps.getProperty(STATS_PROP_COUNT_PROPERTY, \"0\"));\n+\n         // setup internal transaction manager\n         // @todo rewrite to use file system abstraction (FileSystem interface)\n         try {\n@@ -276,12 +283,6 @@ private RepositoryImpl(RepositoryConfig repConfig) throws RepositoryException {\n         pvMgr = new NativePVM(verSession);\n         vMgr = new VersionManagerImpl(pvMgr);\n \n-        // load repository properties\n-        repProps = new Properties();\n-        loadRepProps();\n-        nodesCount = Long.parseLong(repProps.getProperty(STATS_NODE_COUNT_PROPERTY, \"0\"));\n-        propsCount = Long.parseLong(repProps.getProperty(STATS_PROP_COUNT_PROPERTY, \"0\"));\n-\n         // finally register shutdown hook\n         Runtime.getRuntime().addShutdownHook(new Thread() {\n             public void run() {", "filename": "src/java/org/apache/jackrabbit/core/RepositoryImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/b6c2fa59db67bdb2a7acfa6e0ec7a41cb122e052", "parent": "https://github.com/apache/jackrabbit/commit/6e3483e1528c3df829a81cff7a9ada31554f39fb", "message": "JCR-3798 prevent NPE when encountering inconsistent hierarchy during building of path\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1613048 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_43", "file": [{"additions": 5, "raw_url": "https://github.com/apache/jackrabbit/raw/b6c2fa59db67bdb2a7acfa6e0ec7a41cb122e052/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/ConsistencyCheck.java", "blob_url": "https://github.com/apache/jackrabbit/blob/b6c2fa59db67bdb2a7acfa6e0ec7a41cb122e052/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/ConsistencyCheck.java", "sha": "8192984366c7464955a1201e03d2461700608676", "changes": 5, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/ConsistencyCheck.java?ref=b6c2fa59db67bdb2a7acfa6e0ec7a41cb122e052", "patch": "@@ -477,6 +477,11 @@ private String getPath(NodeState node) {\n                 NodeId parentId = node.getParentId();\n                 NodeState parent = (NodeState) stateMgr.getItemState(parentId);\n                 ChildNodeEntry entry = parent.getChildNodeEntry(node.getNodeId());\n+                if (entry == null) {\n+                    log.warn(\"Failed to build path: abandoned child {} of node {}. \" +\n+                            \"Please run a repository consistency check\", node.getNodeId(), parentId);\n+                    return uuid;\n+                }\n                 elements.add(entry);\n                 node = parent;\n             }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/ConsistencyCheck.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/d64e3367c4bbb01e893b172bd735c1459d4c5f08", "parent": "https://github.com/apache/jackrabbit/commit/e134f4233aba42748cd6b35f56eadcf9cc6c4eb5", "message": "JCR-3702 : NPE if user w/o read permission on admin user node removes any node\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1546953 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_44", "file": [{"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java", "sha": "ff32888e91aa4922f35fc8c25a07d453b1a1d4ef", "changes": 5, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08", "patch": "@@ -43,7 +43,6 @@\n import org.apache.jackrabbit.core.retention.RetentionRegistry;\n import org.apache.jackrabbit.core.security.AccessManager;\n import org.apache.jackrabbit.core.security.authorization.Permission;\n-import org.apache.jackrabbit.core.security.user.UserManagerImpl;\n import org.apache.jackrabbit.core.session.SessionContext;\n import org.apache.jackrabbit.core.state.ChildNodeEntry;\n import org.apache.jackrabbit.core.state.ItemState;\n@@ -934,10 +933,6 @@ public void checkRemoveNode(NodeState targetState, NodeId parentId,\n                 throw new RepositoryException(\"Unable to perform removal. Node is affected by a retention.\");\n             }\n         }\n-\n-        if (UserManagerImpl.includesAdmin(context.getSessionImpl().getItemManager().getNode(targetPath))) {\n-            throw new RepositoryException(\"Attempt to remove/move the admin user.\");\n-        }\n     }\n \n     /**", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java", "sha": "eb08c56812c9680ae9aab060fcb9095297c3797f", "changes": 5, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08", "patch": "@@ -33,7 +33,6 @@\n import org.apache.jackrabbit.core.nodetype.NodeTypeConflictException;\n import org.apache.jackrabbit.core.nodetype.NodeTypeRegistry;\n import org.apache.jackrabbit.core.security.authorization.Permission;\n-import org.apache.jackrabbit.core.security.user.UserManagerImpl;\n import org.apache.jackrabbit.core.session.SessionContext;\n import org.apache.jackrabbit.core.session.SessionOperation;\n import org.apache.jackrabbit.core.state.NodeState;\n@@ -303,10 +302,6 @@ private void checkCondition(ItemImpl item, int options, int permissions, boolean\n                 throw new RepositoryException(\"Unable to perform operation. Node is affected by a retention.\");\n             }\n         }\n-\n-        if (isRemoval && item.isNode() && UserManagerImpl.includesAdmin((NodeImpl) item)) {\n-            throw new RepositoryException(\"Attempt to remove/move the admin user.\");\n-        }\n     }\n \n     public synchronized boolean canModify(", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java", "sha": "dcdc91d5b9d1142c657dfa463d9e6355a472312d", "changes": 15, "status": "modified", "deletions": 15, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08", "patch": "@@ -16,7 +16,6 @@\n  */\n package org.apache.jackrabbit.core.security.user;\n \n-import org.apache.jackrabbit.api.JackrabbitRepository;\n import org.apache.jackrabbit.api.security.principal.ItemBasedPrincipal;\n import org.apache.jackrabbit.api.security.user.Authorizable;\n import org.apache.jackrabbit.api.security.user.AuthorizableExistsException;\n@@ -1154,20 +1153,6 @@ public void loggedOut(SessionImpl session) {\n         }\n     }\n \n-    //--------------------------------------------------------------------------\n-    public static boolean includesAdmin(NodeImpl node) throws RepositoryException {\n-        SessionImpl s = (SessionImpl) node.getSession();\n-        if (s.getRepository().getDescriptorValue(JackrabbitRepository.OPTION_USER_MANAGEMENT_SUPPORTED).getBoolean()) {\n-            UserManager uMgr = s.getUserManager();\n-            if (uMgr instanceof UserManagerImpl) {\n-                UserManagerImpl uMgrImpl = (UserManagerImpl) uMgr;\n-                AuthorizableImpl admin = (AuthorizableImpl) uMgrImpl.getAuthorizable(uMgrImpl.adminId);\n-                return Text.isDescendantOrEqual(node.getPath(), admin.getNode().getPath());\n-            }\n-        }\n-        return false;\n-    }\n-\n     //------------------------------------------------------< inner classes >---\n     /**\n      * Inner class", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java"}, {"additions": 149, "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java", "sha": "b26ac51731a8c899504728007d49b76051e5ec0f", "changes": 213, "status": "modified", "deletions": 64, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08", "patch": "@@ -16,13 +16,20 @@\n  */\n package org.apache.jackrabbit.core.security.user;\n \n+import java.util.Properties;\n+import javax.jcr.Node;\n import javax.jcr.RepositoryException;\n import javax.jcr.Session;\n \n import org.apache.jackrabbit.api.security.user.AbstractUserTest;\n import org.apache.jackrabbit.api.security.user.Authorizable;\n+import org.apache.jackrabbit.api.security.user.User;\n+import org.apache.jackrabbit.api.security.user.UserManager;\n import org.apache.jackrabbit.core.NodeImpl;\n+import org.apache.jackrabbit.core.SessionImpl;\n+import org.apache.jackrabbit.core.id.NodeId;\n import org.apache.jackrabbit.core.security.principal.AdminPrincipal;\n+import org.apache.jackrabbit.spi.commons.conversion.NameResolver;\n import org.apache.jackrabbit.test.NotExecutableException;\n \n /**\n@@ -65,119 +72,197 @@ public void testRemoveSelf() throws RepositoryException, NotExecutableException\n         }\n     }\n \n+    /**\n+     * Test if the administrator is recreated upon login if the corresponding\n+     * node gets removed.\n+     *\n+     * @throws RepositoryException\n+     * @throws NotExecutableException\n+     */\n     public void testRemoveAdminNode() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n-        Session s = null;\n+        // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        // after removing the node the admin user doesn't exist any more\n+        assertNull(userMgr.getAuthorizable(adminId));\n+\n+        // login must succeed as system user mgr recreates the admin user\n+        Session s2 = getHelper().getSuperuserSession();\n         try {\n-            NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n-            s = adminNode.getSession();\n-            adminNode.remove();\n-            // use session obtained from the node as usermgr may point to a dedicated\n-            // system workspace different from the superusers workspace.\n-            s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            assertNotNull(getUserManager(s2).getAuthorizable(adminId));\n         } finally {\n-            if (s != null) {\n-                s.refresh(false);\n-            }\n+            s2.logout();\n         }\n     }\n \n-    public void testSessionRemoveItem()  throws RepositoryException, NotExecutableException {\n+    /**\n+     * Test for collisions that would prevent from recreate the admin user.\n+     * - an intermediate rep:AuthorizableFolder node with the same name\n+     */\n+    public void testAdminNodeCollidingWithAuthorizableFolder() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n-        Session s = null;\n+        // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+        String adminPath = adminNode.getPath();\n+        String adminNodeName = adminNode.getName();\n+        Node parentNode = adminNode.getParent();\n+\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        Session s2 = null;\n+        String collidingPath = null;\n         try {\n-            NodeImpl parent = (NodeImpl) ((AuthorizableImpl) admin).getNode().getParent();\n-            s = parent.getSession();\n-            s.removeItem(parent.getPath());\n+            // now create a colliding node:\n+            Node n = parentNode.addNode(adminNodeName, \"rep:AuthorizableFolder\");\n+            collidingPath = n.getPath();\n             s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n+\n+            // force recreation of admin user.\n+            s2 = getHelper().getSuperuserSession();\n+\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            assertEquals(adminNodeName, ((AuthorizableImpl) admin).getNode().getName());\n+            assertFalse(adminPath.equals(((AuthorizableImpl) admin).getNode().getPath()));\n+\n         } finally {\n-            if (s != null) {\n-                s.refresh(false);\n+            if (s2 != null) {\n+                s2.logout();\n+            }\n+            // remove the extra folder and the admin user (created underneath) again.\n+            if (collidingPath != null) {\n+                s.getNode(collidingPath).remove();\n+                s.save();\n             }\n         }\n     }\n \n-    public void testSessionMoveAdminNode()  throws RepositoryException, NotExecutableException {\n+    /**\n+     * Test for collisions that would prevent from recreate the admin user.\n+     * - a colliding node somewhere else with the same jcr:uuid.\n+     *\n+     * Test if creation of the administrator user forces the removal of some\n+     * other node in the repository that by change happens to have the same\n+     * jcr:uuid and thus inhibits the creation of the admininstrator user.\n+     */\n+    public void testAdminNodeCollidingWithRandomNode() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n-        Session s = null;\n+        // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+        NodeId nid = adminNode.getNodeId();\n+\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        Session s2 = null;\n+        String collidingPath = null;\n         try {\n-            NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n-            s = adminNode.getSession();\n-            s.move(adminNode.getPath(), \"/somewhereelse\");\n-            // use session obtained from the node as usermgr may point to a dedicated\n-            // system workspace different from the superusers workspace.\n+            // create a colliding node outside of the user tree\n+            NameResolver nr = (SessionImpl) s;\n+            // NOTE: testRootNode will not be present if users are stored in a distinct wsp.\n+            //       therefore use root node as start...\n+            NodeImpl tr = (NodeImpl) s.getRootNode();\n+            Node n = tr.addNode(nr.getQName(\"tmpNode\"), nr.getQName(testNodeType), nid);\n+            collidingPath = n.getPath();\n             s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n-        }  finally {\n-            if (s != null) {\n-                s.refresh(false);\n-            }\n-        }\n-    }\n \n-    public void testSessionMoveParentNode()  throws RepositoryException, NotExecutableException {\n-        Authorizable admin = userMgr.getAuthorizable(adminId);\n+            // force recreation of admin user.\n+            s2 = getHelper().getSuperuserSession();\n \n-        if (admin == null || !(admin instanceof AuthorizableImpl)) {\n-            throw new NotExecutableException();\n-        }\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            // the colliding node must have been removed.\n+            assertFalse(s2.nodeExists(collidingPath));\n \n-        Session s = null;\n-        try {\n-            NodeImpl parent = (NodeImpl) ((AuthorizableImpl) admin).getNode().getParent();\n-            s = parent.getSession();\n-            s.move(parent.getPath(), \"/somewhereelse\");\n-            // use session obtained from the node as usermgr may point to a dedicated\n-            // system workspace different from the superusers workspace.\n-            s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n         } finally {\n-            if (s != null) {\n-                s.refresh(false);\n+            if (s2 != null) {\n+                s2.logout();\n+            }\n+            if (collidingPath != null && s.nodeExists(collidingPath)) {\n+                s.getNode(collidingPath).remove();\n+                s.save();\n             }\n         }\n     }\n \n-    public void testWorkspaceMoveAdminNode()  throws RepositoryException, NotExecutableException {\n+    /**\n+     * Reconfiguration of the user-root-path will result in node collision\n+     * upon initialization of the built-in repository users. Test if the\n+     * UserManagerImpl in this case removes the colliding admin-user node.\n+     */\n+    public void testChangeUserRootPath() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n         // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        Session s2 = null;\n+        String collidingPath = null;\n         try {\n-            NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n-            Session s = adminNode.getSession();\n-            s.getWorkspace().move(adminNode.getPath(), \"/somewhereelse\");\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n+            // create a colliding user node outside of the user tree\n+            Properties props = new Properties();\n+            props.setProperty(\"usersPath\", \"/testPath\");\n+            UserManager um = new UserManagerImpl((SessionImpl) s, adminId, props);\n+            User collidingUser = um.createUser(adminId, adminId);\n+            collidingPath = ((AuthorizableImpl) collidingUser).getNode().getPath();\n+            s.save();\n+\n+            // force recreation of admin user.\n+            s2 = getHelper().getSuperuserSession();\n+\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            // the colliding node must have been removed.\n+            assertFalse(s2.nodeExists(collidingPath));\n+\n+        } finally {\n+            if (s2 != null) {\n+                s2.logout();\n+            }\n+            if (collidingPath != null && s.nodeExists(collidingPath)) {\n+                s.getNode(collidingPath).remove();\n+                s.save();\n+            }\n         }\n     }\n }", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/7d653b12127c3da2f5c1804551bd76c6797fd21d", "parent": "https://github.com/apache/jackrabbit/commit/c403b6eca2b7722a9dc8db2fb237e2fb050f79ac", "message": "JCR-3435: Fix NPE for xpath query with child axis and star name\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1393342 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_45", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java", "sha": "d345adcaaaeb7c9dde3ff7b12e145c4c540a5b98", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d", "patch": "@@ -348,7 +348,7 @@ public Object visit(RelationQueryNode node, Object data) throws RepositoryExcept\n             PathQueryNode relPath = node.getRelativePath();\n             if (relPath == null) {\n                 propPath.append(\".\");\n-            } else if (relPath.getNumOperands() > 0 && relPath.getPathSteps()[0].getNameTest().equals(XPathQueryBuilder.FN_POSITION_FULL)) {\n+            } else if (relPath.getNumOperands() > 0 && XPathQueryBuilder.FN_POSITION_FULL.equals(relPath.getPathSteps()[0].getNameTest())) {\n                 propPath.append(resolver.getJCRName(XPathQueryBuilder.FN_POSITION_FULL));\n             } else {\n                 LocationStepQueryNode[] steps = relPath.getPathSteps();", "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java"}, {"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java", "sha": "2fa556437e041137d664dcbd958f04983d390450", "changes": 11, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d", "patch": "@@ -425,8 +425,13 @@ public Object visit(SimpleNode node, Object data) {\n                         }\n                         PathQueryNode relPath = tmp.getRelativePath();\n                         LocationStepQueryNode[] steps = relPath.getPathSteps();\n-                        \n-                        tmpRelPath.addLast(steps[steps.length-1].getNameTest());\n+\n+                        Name nameTest = steps[steps.length-1].getNameTest();\n+                        if (nameTest==null) {\n+                        \t// see LocationStepQueryNode javadoc on when getNameTest()==null: when it was a star (asterisk)\n+                        \tnameTest = RelationQueryNode.STAR_NAME_TEST;\n+                        }\n+\t\t\t\t\t\ttmpRelPath.addLast(nameTest);\n                     }\n                 }\n                 break;\n@@ -956,7 +961,7 @@ private QueryNode createFunction(SimpleNode node, QueryNode queryNode) {\n                     }\n                     if (queryNode.getType() == QueryNode.TYPE_PATH) {\n                         PathQueryNode pathNode = (PathQueryNode) queryNode;\n-                        \n+\n                         pathNode.addPathStep(createDerefQueryNode(node, descendant, pathNode));\n                     } else if (queryNode.getType() == QueryNode.TYPE_RELATION) {\n                         RelationQueryNode relNode = (RelationQueryNode) queryNode;", "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java"}, {"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java", "sha": "a07e8e255ab27c025c1e011d651663d55d8ab3a1", "changes": 8, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d", "patch": "@@ -67,6 +67,14 @@ public void testStarNameTest() throws Exception {\n         checkStatement(\"//element(*, foo)[foo/*/@bar = 'bla']\");\n     }\n \n+    public void testStarNameAtBeginningOfPredicate() throws Exception {\n+        checkStatement(\"//element(*, foo)[*/*/@bar = 'bla']\");\n+    }\n+\n+    public void testChildStarName() throws Exception {\n+        checkStatement(\"//programs//*[*/@sunday]\");\n+    }\n+\n     public void testRepSimilar() throws Exception {\n         checkStatement(\"//element(*, foo)[rep:similar(foo, '/some/path')]\");\n     }", "filename": "jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/deff7702b5448de854ed27b64f485d53b13e887c", "parent": "https://github.com/apache/jackrabbit/commit/e71c0544e5a2945a29215736735897ab697dcaaa", "message": "JCR-3393: InternalVersionManagerBase.calculateCheckinVersionName may fail with NPE on broken versioning persistence\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1362924 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_46", "file": [{"additions": 19, "raw_url": "https://github.com/apache/jackrabbit/raw/deff7702b5448de854ed27b64f485d53b13e887c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "blob_url": "https://github.com/apache/jackrabbit/blob/deff7702b5448de854ed27b64f485d53b13e887c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "sha": "f86a9a112da719136f97a2f3c61c7e05733294cf", "changes": 19, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java?ref=deff7702b5448de854ed27b64f485d53b13e887c", "patch": "@@ -699,6 +699,13 @@ protected InternalVersion internalCheckin(\n     protected String calculateCheckinVersionName(InternalVersionHistoryImpl history,\n                                                  NodeStateEx node, boolean simple)\n             throws RepositoryException {\n+\n+        if (history == null) {\n+            String message = \"Node \" + node.getNodeId() + \" has no version history\";\n+            log.error(message);\n+            throw new VersionException(message);\n+        }\n+\n         InternalVersion best = null;\n         if (simple) {\n             // 1. in simple versioning just take the 'head' version\n@@ -721,12 +728,24 @@ protected String calculateCheckinVersionName(InternalVersionHistoryImpl history,\n \n             for (InternalValue value: values) {\n                 InternalVersion pred = history.getVersion(value.getNodeId());\n+                if (pred == null) {\n+                    String message = \"Could not instantiate InternalVersion for nodeId \" + value.getNodeId() + \" (VHR + \" + history.getId() + \", node \" + node.getNodeId() + \")\";\n+                    log.error(message);\n+                    throw new VersionException(message);\n+                }\n                 if (best == null\n                         || pred.getName().getLocalName().length() < best.getName().getLocalName().length()) {\n                     best = pred;\n                 }\n             }\n         }\n+\n+        if (best == null) {\n+            String message = \"Could not find 'best' predecessor node for \" + node.getNodeId();\n+            log.error(message);\n+            throw new VersionException(message);\n+        }\n+\n         // 2. generate version name (assume no namespaces in version names)\n         String versionName = best.getName().getLocalName();\n         int pos = versionName.lastIndexOf('.');", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/16255dbad5a6b592dc0d348ac4514a07f16786b9", "parent": "https://github.com/apache/jackrabbit/commit/5336f6a70a38ba924875a5af216e3c050875c9e3", "message": "JCR-3343 ClusterNode's updateCommited method throws NPE - patch contributed by Mete Atamel\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1350542 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_47", "file": [{"additions": 2, "raw_url": "https://github.com/apache/jackrabbit/raw/16255dbad5a6b592dc0d348ac4514a07f16786b9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterNode.java", "blob_url": "https://github.com/apache/jackrabbit/blob/16255dbad5a6b592dc0d348ac4514a07f16786b9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterNode.java", "sha": "688d2324c22a7634cdc065204b0555f2cd37f71b", "changes": 3, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterNode.java?ref=16255dbad5a6b592dc0d348ac4514a07f16786b9", "patch": "@@ -683,7 +683,8 @@ public void updateCommitted(Update update, String path) {\n \n                 log.debug(\"Stored record '{}' to Journal ({})\", recordRevision, journalUpdateSize);\n \n-                long updateSize = (Long)update.getAttribute(ATTRIBUTE_UPDATE_SIZE);\n+                Object updateSizeValue = update.getAttribute(ATTRIBUTE_UPDATE_SIZE);\n+                long updateSize = updateSizeValue != null? (Long)updateSizeValue : 0;\n                 updateCount.compareAndSet(Integer.MAX_VALUE, 0);\n \n                 auditLogger.info(\"[{}] {} {} ({})\", new Object[]{updateCount.incrementAndGet(), ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterNode.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/b56e112b239165ae3daa649994213e07ddb28cc2", "parent": "https://github.com/apache/jackrabbit/commit/d83d11ac68b413db7ce3f97ff166399f35d26b57", "message": "JCR-3210 NPE in spi2dav when server does not send all headers\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1232100 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_48", "file": [{"additions": 5, "raw_url": "https://github.com/apache/jackrabbit/raw/b56e112b239165ae3daa649994213e07ddb28cc2/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/ValueLoader.java", "blob_url": "https://github.com/apache/jackrabbit/blob/b56e112b239165ae3daa649994213e07ddb28cc2/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/ValueLoader.java", "sha": "07aec167b4db6cf6540803c837b4cbefa58cc1af", "changes": 6, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/ValueLoader.java?ref=b56e112b239165ae3daa649994213e07ddb28cc2", "patch": "@@ -16,6 +16,7 @@\n  */\n package org.apache.jackrabbit.spi2davex;\n \n+import org.apache.commons.httpclient.Header;\n import org.apache.commons.httpclient.HttpClient;\n import org.apache.commons.httpclient.methods.GetMethod;\n import org.apache.commons.httpclient.methods.HeadMethod;\n@@ -74,7 +75,10 @@ void loadBinary(String uri, int index, Target target) throws RepositoryException\n             if (statusCode == DavServletResponse.SC_OK) {\n                 Map<String, String> headers = new HashMap<String, String>();\n                 for (String name : headerNames) {\n-                    headers.put(name, method.getResponseHeader(name).getValue());\n+                    Header hdr = method.getResponseHeader(name);\n+                    if (hdr != null) {\n+                        headers.put(name, hdr.getValue());\n+                    }\n                 }\n                 return headers;\n             } else {", "filename": "jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/ValueLoader.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/3f55d09a77b3e332efcc1507dbc319d4712c7fdb", "parent": "https://github.com/apache/jackrabbit/commit/4fa3d5f41bd428876ad4fe5a44d340c94973b942", "message": "JCR-3131: NPE in ItemManager when calling Session.save() with nothing to save\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1196062 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_49", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java", "sha": "c689c25b9bd0acc3d52c4dbe8f2ee8ef52bd378c", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java?ref=3f55d09a77b3e332efcc1507dbc319d4712c7fdb", "patch": "@@ -806,7 +806,10 @@ public boolean itemExists(String absPath) throws RepositoryException {\n      * {@inheritDoc}\n      */\n     public void save() throws RepositoryException {\n-        perform(new SessionSaveOperation());\n+        // JCR-3131: no need to perform save op when there's nothing to save...\n+        if (context.getItemStateManager().hasAnyTransientItemStates()) {\n+            perform(new SessionSaveOperation());\n+        }\n     }\n \n     /**", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java"}, {"additions": 26, "raw_url": "https://github.com/apache/jackrabbit/raw/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java", "sha": "a6ae45e73c94a63b47777b987a5c8da7d1cfa0fb", "changes": 26, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java?ref=3f55d09a77b3e332efcc1507dbc319d4712c7fdb", "patch": "@@ -504,4 +504,30 @@ public void testRemoveNodeWithInvisibleNonRemovableChild() throws Exception {\n             // success\n         }\n     }\n+    \n+    // https://issues.apache.org/jira/browse/JCR-3131\n+    public void testEmptySaveNoRootAccess() throws RepositoryException, NotExecutableException {\n+\n+        Session s = getTestSession();\n+        s.save();\n+\n+        Privilege[] read = privilegesFromName(Privilege.JCR_READ);\n+\n+        try {\n+            JackrabbitAccessControlList tmpl = getPolicy(acMgr, \"/\", testUser.getPrincipal());\n+            tmpl.addEntry(testUser.getPrincipal(), read, false, getRestrictions(superuser, path));\n+            acMgr.setPolicy(tmpl.getPath(), tmpl);\n+            superuser.save();\n+\n+            // empty save operation\n+            s.save();\n+        }\n+        finally {\n+            // undo revocation of read privilege\n+            JackrabbitAccessControlList tmpl = getPolicy(acMgr, \"/\", testUser.getPrincipal());\n+            tmpl.addEntry(testUser.getPrincipal(), read, true, getRestrictions(superuser, path));\n+            acMgr.setPolicy(tmpl.getPath(), tmpl);\n+            superuser.save();\n+        }\n+    }\n }\n\\ No newline at end of file", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/8574ab4ad17ac03976059c96168778aad607525b", "parent": "https://github.com/apache/jackrabbit/commit/77146bf98c5b26bf28c95b8b21a32eff4aaf3b68", "message": "JCR-3085: better diagnostics when version storage is broken (produce a RepositoryException instead of a NPE, including the nodeId)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1177249 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_50", "file": [{"additions": 7, "raw_url": "https://github.com/apache/jackrabbit/raw/8574ab4ad17ac03976059c96168778aad607525b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "blob_url": "https://github.com/apache/jackrabbit/blob/8574ab4ad17ac03976059c96168778aad607525b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java", "sha": "daa1bed34e3e4aa32f641bf55ecd8f3e6ca21275", "changes": 7, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java?ref=8574ab4ad17ac03976059c96168778aad607525b", "patch": "@@ -681,6 +681,13 @@ protected String calculateCheckinVersionName(InternalVersionHistoryImpl history,\n         } else {\n             // 1. search a predecessor, suitable for generating the new name\n             InternalValue[] values = node.getPropertyValues(NameConstants.JCR_PREDECESSORS);\n+\n+            if (values == null) {\n+                String message = \"Mandatory jcr:predecessors property missing on node \" + node.getNodeId();\n+                log.error(message);\n+                throw new VersionException(message);\n+            }\n+\n             for (InternalValue value: values) {\n                 InternalVersion pred = history.getVersion(value.getNodeId());\n                 if (best == null", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/7dba0a3c623be7a63d4dba6c138985a617c5b0f0", "parent": "https://github.com/apache/jackrabbit/commit/40b90eedff58a58c93427e25507bdc008c85c915", "message": "JCR-3063: NullPointerException in ItemManager\n\nAdd a few extra checks against NPEs and CMEs\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1176515 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_51", "file": [{"additions": 12, "raw_url": "https://github.com/apache/jackrabbit/raw/7dba0a3c623be7a63d4dba6c138985a617c5b0f0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemSaveOperation.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7dba0a3c623be7a63d4dba6c138985a617c5b0f0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemSaveOperation.java", "sha": "49a17551ad994170abf62f071dd49b7cb9e3fc52", "changes": 15, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemSaveOperation.java?ref=7dba0a3c623be7a63d4dba6c138985a617c5b0f0", "patch": "@@ -490,9 +490,18 @@ private void validateTransientItems(\n                  * its primary type has changed, check its node type against the\n                  * required node type in its definition\n                  */\n-                if (nodeState.getStatus() == ItemState.STATUS_NEW\n-                        || !nodeState.getNodeTypeName().equals(\n-                            ((NodeState) nodeState.getOverlayedState()).getNodeTypeName())) {\n+                boolean primaryTypeChanged =\n+                        nodeState.getStatus() == ItemState.STATUS_NEW;\n+                if (!primaryTypeChanged) {\n+                    NodeState overlaid =\n+                            (NodeState) nodeState.getOverlayedState();\n+                    if (overlaid != null) {\n+                        Name newName = nodeState.getNodeTypeName();\n+                        Name oldName = overlaid.getNodeTypeName();\n+                        primaryTypeChanged = !newName.equals(oldName);\n+                    }\n+                }\n+                if (primaryTypeChanged) {\n                     for (NodeType ntReq : nodeDef.getRequiredPrimaryTypes()) {\n                         Name ntName = ((NodeTypeImpl) ntReq).getQName();\n                         if (!(pnt.getQName().equals(ntName)", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemSaveOperation.java"}, {"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/7dba0a3c623be7a63d4dba6c138985a617c5b0f0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7dba0a3c623be7a63d4dba6c138985a617c5b0f0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "sha": "9ff82d7485d2725cb56ea3d7c6beceb6468539b8", "changes": 5, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java?ref=7dba0a3c623be7a63d4dba6c138985a617c5b0f0", "patch": "@@ -470,7 +470,9 @@ public NodeId getIdOfRootTransientNodeState() throws RepositoryException {\n         Collection<NodeId> candidateIds = new LinkedList<NodeId>();\n         try {\n             HierarchyManager hierMgr = getHierarchyMgr();\n-            for (ItemState state : transientStore.values()) {\n+            ItemState[] states =\n+                    transientStore.values().toArray(new ItemState[0]);\n+            for (ItemState state : states) {\n                 if (state.getStatus() == ItemState.STATUS_EXISTING_MODIFIED\n                         || state.getStatus() == ItemState.STATUS_STALE_DESTROYED) {\n                     NodeId nodeId;\n@@ -567,7 +569,6 @@ public boolean isItemStateInAttic(ItemId id) {\n      */\n     public NodeState createTransientNodeState(NodeId id, Name nodeTypeName, NodeId parentId, int initialStatus)\n             throws ItemStateException {\n-\n         // check map; synchronized to ensure an entry is not created twice.\n         synchronized (transientStore) {\n             if (transientStore.containsKey(id)) {", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/500c1ec6a054276151cf63520d9f919d6176ad8c", "parent": "https://github.com/apache/jackrabbit/commit/8c4d3df8d2346ad2b8912779c7351be431cf2ee2", "message": "JCR-2981 - Bundle of events may be dropped due to NPE (applying patch provided by timothee maret)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1136360 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_52", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/500c1ec6a054276151cf63520d9f919d6176ad8c/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyManagerImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/500c1ec6a054276151cf63520d9f919d6176ad8c/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyManagerImpl.java", "sha": "10ced1c3d04e26bfe038f899a4689998431f5aa4", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyManagerImpl.java?ref=500c1ec6a054276151cf63520d9f919d6176ad8c", "patch": "@@ -89,7 +89,7 @@ public HierarchyEntry lookup(ItemId workspaceItemId) {\n             if (path == null) {\n                 return nEntry;\n             } else {\n-                return nEntry.lookupDeepEntry(path);\n+                return nEntry != null ? nEntry.lookupDeepEntry(path) : null;\n             }\n         }\n     }", "filename": "jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/hierarchy/HierarchyManagerImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/0e650aa902229e39b003c722f5674d4c6a89d8d0", "parent": "https://github.com/apache/jackrabbit/commit/44a1d182d1be2dbdd1f6920ed1676dba0327a71c", "message": "JCR-2699: Improve read/write concurrency\n\nRevert revision 1003542 until I have time to solve the NPE issue.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1003773 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_53", "file": [{"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java", "blob_url": "https://github.com/apache/jackrabbit/blob/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java", "sha": "a02fe447f705cecbb7ecbb6e382df0a433894a46", "changes": 282, "status": "removed", "deletions": 282, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java?ref=44a1d182d1be2dbdd1f6920ed1676dba0327a71c", "patch": "@@ -1,282 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.core.cache;\n-\n-import java.util.concurrent.ConcurrentHashMap;\n-\n-import org.apache.commons.collections.map.LinkedMap;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-/**\n- * An <code>ItemStateCache</code> implementation that internally uses a\n- * {@link LinkedMap} to maintain a cache of <code>ItemState</code> objects. The\n- * cache uses a rough estimate of the memory consumption of the cached item\n- * states for calculating the maximum number of entries. The oldest entries\n- * are flushed once the cache size has exceeded a certain limit.\n- * <p/>\n- * TODO rename class to something more appropriate, e.g. FIFOItemSateCache since\n- * it doesn't use a LRU eviction policy anymore.\n- */\n-public class LRUCache<Key, Value> implements Cache {\n-\n-    /** Logger instance */\n-    private static Logger log = LoggerFactory.getLogger(LRUCache.class);\n-\n-    /**\n-     * Map of cache entries.\n-     */\n-    private final ConcurrentHashMap<Key, Entry<Key, Value>> entries =\n-        new ConcurrentHashMap<Key, Entry<Key, Value>>();\n-\n-    /**\n-     * Most recently used entry, or <code>null</code> if the cache is empty.\n-     */\n-    private Entry<Key, Value> first = null;\n-\n-    /**\n-     * Least recently used entry, or <code>null</code> if the cache is empty.\n-     */\n-    private Entry<Key, Value> last = null;\n-\n-    /**\n-     * Current size of the cache; sum of the sizes of all the cached entries.\n-     */\n-    private long currentSize = 0;\n-\n-    /**\n-     * Maximum size of the cache\n-     */\n-    private long maximumSize;\n-\n-    /**\n-     * Cache access listener\n-     */\n-    private CacheAccessListener listener = null;\n-\n-    /**\n-     * Access count used to fire {@link CacheAccessListener#cacheAccessed()}\n-     * calls once every {@link CacheAccessListener#ACCESS_INTERVAL} hits.\n-     */\n-    private int accessCount;\n-\n-    /**\n-     * Constructs a new, empty <code>ItemStateCache</code> with the specified\n-     * maximum memory.\n-     *\n-     * @param maximumSize maximum size of the cache\n-     */\n-    public LRUCache(long maximumSize) {\n-        this.maximumSize = maximumSize;\n-    }\n-\n-    public boolean containsKey(Key key) {\n-        return entries.containsKey(key);\n-    }\n-\n-    public Value get(Key key) {\n-        Entry<Key, Value> entry = entries.get(key);\n-        if (entry != null) {\n-            boolean notifyAccessListener;\n-            synchronized (this) {\n-                // Check if we should notify the access listener\n-                notifyAccessListener =\n-                    (++accessCount % CacheAccessListener.ACCESS_INTERVAL) == 0;\n-\n-                // Move this entry to the beginning of the LRU linked list\n-                if (entry.prev != null) {\n-                    entry.prev.next = entry.next;\n-                    if (entry.next != null) {\n-                        entry.next.prev = entry.prev;\n-                    } else if (entry.prev != null) {\n-                        last = entry.prev;\n-                        entry.prev = null;\n-                    }\n-                    first.prev = entry;\n-                    entry.next = first;\n-                    first = entry;\n-                }\n-            }\n-\n-            // Notify the access listener outside the synchronized block\n-            if (notifyAccessListener && listener != null) {\n-                listener.cacheAccessed();\n-            }\n-\n-            return entry.value;\n-        } else {\n-            return null;\n-        }\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    public synchronized Value[] values() {\n-        Object[] values = new Object[entries.size()];\n-        Entry<Key, Value> entry = first;\n-        for (int i = 0; i < values.length && entry != null; i++) {\n-            values[i] = entry.value;\n-            entry = entry.next;\n-        }\n-        return (Value[]) values;\n-    }\n-\n-    public synchronized void put(Key key, Value value, long size) {\n-        Entry<Key, Value> entry = new Entry<Key, Value>(key, value, size);\n-        if (first != null) {\n-            first.prev = entry;\n-        }\n-        entry.next = first;\n-        first = entry;\n-        if (last == null) {\n-            last = entry;\n-        }\n-\n-        currentSize += size;\n-\n-        Entry<Key, Value> previous = entries.put(key, entry);\n-        if (previous != null) {\n-            log.warn(\"Overwriting cached entry {}\", key);\n-            currentSize -= previous.size;\n-        }\n-\n-        shrinkIfNeeded();\n-    }\n-\n-    public synchronized Value remove(Key key) {\n-        Entry<Key, Value> entry = entries.remove(key);\n-        if (entry != null) {\n-            if (entry.prev != null) {\n-                entry.prev.next = entry.next;\n-            } else {\n-                first = entry.next;\n-            }\n-            if (entry.next != null) {\n-                entry.next.prev = entry.prev;\n-            } else {\n-                last = entry.prev;\n-            }\n-\n-            currentSize -= entry.size;\n-\n-            return entry.value;\n-        } else {\n-            return null;\n-        }\n-    }\n-\n-    public synchronized void clear() {\n-        entries.clear();\n-        first = null;\n-        last = null;\n-        currentSize = 0;\n-    }\n-\n-    public boolean isEmpty() {\n-        return entries.isEmpty();\n-    }\n-\n-    public synchronized long getAccessCount() {\n-        return accessCount;\n-    }\n-\n-    public synchronized void resetAccessCount() {\n-        accessCount = 0;\n-    }\n-\n-    public synchronized long getMemoryUsed() {\n-        return currentSize;\n-    }\n-\n-    public synchronized long getMaxMemorySize() {\n-        return maximumSize;\n-    }\n-\n-    public synchronized void setMaxMemorySize(long size) {\n-        this.maximumSize = size;\n-        shrinkIfNeeded();\n-    }\n-\n-    private void shrinkIfNeeded() {\n-        while (currentSize > maximumSize && last != null) {\n-            entries.remove(last.key);\n-            currentSize -= last.size;\n-            if (last.prev != null) {\n-                last.prev.next = null;\n-                last = last.prev;\n-            } else {\n-                first = null;\n-                last = null;\n-            }\n-        }\n-    }\n-\n-    /**\n-     * Set the cache access listener. Only one listener per cache is supported.\n-     *\n-     * @param listener the new listener\n-     */\n-    public synchronized void setAccessListener(CacheAccessListener listener) {\n-        this.listener = listener;\n-    }\n-\n-    /**\n-     * {@inheritDoc}\n-     */\n-    public synchronized void dispose() {\n-        if (listener != null) {\n-            listener.disposeCache(this);\n-        }\n-    }\n-\n-    public String toString() {\n-        StringBuilder builder = new StringBuilder();\n-        builder.append(\"{ \");\n-        Entry<Key, Value> entry = first;\n-        while (entry != null) {\n-            builder.append(entry.key);\n-            builder.append(\" => \");\n-            builder.append(entry.value);\n-            builder.append(\" \");\n-        }\n-        builder.append(\"}\");\n-        return builder.toString();\n-    }\n-\n-    /**\n-     * Internal cache entry.\n-     */\n-    private static class Entry<Key, Value> {\n-\n-        final Key key;\n-\n-        final Value value;\n-\n-        final long size;\n-\n-        Entry<Key, Value> prev = null;\n-\n-        Entry<Key, Value> next = null;\n-\n-        public Entry(Key key, Value value, long size) {\n-            this.key = key;\n-            this.value = value;\n-            this.size = size;\n-        }\n-\n-    }\n-\n-}", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java"}, {"additions": 7, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java", "sha": "48ca35c3c84107e95dd25b1da8b552a3560b1d33", "changes": 15, "status": "modified", "deletions": 8, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -18,7 +18,6 @@\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.apache.jackrabbit.core.cache.LRUCache;\n import org.apache.jackrabbit.core.fs.FileSystemResource;\n import org.apache.jackrabbit.core.fs.FileSystem;\n import org.apache.jackrabbit.core.state.ItemState;\n@@ -38,6 +37,7 @@\n import org.apache.jackrabbit.core.persistence.PersistenceManager;\n import org.apache.jackrabbit.core.util.StringIndex;\n import org.apache.jackrabbit.core.persistence.util.BLOBStore;\n+import org.apache.jackrabbit.core.persistence.util.BundleCache;\n import org.apache.jackrabbit.core.persistence.util.FileBasedIndex;\n import org.apache.jackrabbit.core.persistence.util.LRUNodeIdCache;\n import org.apache.jackrabbit.core.persistence.util.NodePropBundle;\n@@ -68,7 +68,7 @@\n  * included in the bundle but generated when required.\n  * <p/>\n  * In order to increase performance, there are 2 caches maintained. One is the\n- * bundle cache that caches already loaded bundles. The other is the\n+ * {@link BundleCache} that caches already loaded bundles. The other is the\n  * {@link LRUNodeIdCache} that caches non-existent bundles. This is useful\n  * because a lot of {@link #exists(NodeId)} calls are issued that would result\n  * in a useless SQL execution if the desired bundle does not exist.\n@@ -103,7 +103,7 @@\n     private StringIndex nameIndex;\n \n     /** the cache of loaded bundles */\n-    private LRUCache<NodeId, NodePropBundle> bundles;\n+    private BundleCache bundles;\n \n     /** the cache of non-existent bundles */\n     private LRUNodeIdCache missing;\n@@ -387,7 +387,7 @@ protected abstract void store(NodeReferences refs)\n     public void init(PMContext context) throws Exception {\n         this.context = context;\n         // init bundle cache\n-        bundles = new LRUCache<NodeId, NodePropBundle>(bundleCacheSize);\n+        bundles = new BundleCache(bundleCacheSize);\n         missing = new LRUNodeIdCache();\n     }\n     \n@@ -656,7 +656,7 @@ private NodePropBundle getBundle(NodeId id) throws ItemStateException {\n                 bundle = loadBundle(id);\n                 if (bundle != null) {\n                     bundle.markOld();\n-                    bundles.put(id, bundle, bundle.getSize());\n+                    bundles.put(bundle);\n                 } else {\n                     missing.put(id);\n                 }\n@@ -692,9 +692,8 @@ private void putBundle(NodePropBundle bundle) throws ItemStateException {\n         missing.remove(bundle.getId());\n         // only put to cache if already exists. this is to ensure proper overwrite\n         // and not creating big contention during bulk loads\n-        if (bundles.containsKey(bundle.getId())) {\n-            bundles.remove(bundle.getId());\n-            bundles.put(bundle.getId(), bundle, bundle.getSize());\n+        if (bundles.contains(bundle.getId())) {\n+            bundles.put(bundle);\n         }\n     }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java"}, {"additions": 7, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java", "sha": "8c224f4ff47cb4bad10797ee08da42956c75b273", "changes": 15, "status": "modified", "deletions": 8, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -24,7 +24,6 @@\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.apache.jackrabbit.core.cache.LRUCache;\n import org.apache.jackrabbit.core.fs.FileSystemResource;\n import org.apache.jackrabbit.core.fs.FileSystem;\n import org.apache.jackrabbit.core.id.ItemId;\n@@ -35,6 +34,7 @@\n import org.apache.jackrabbit.core.persistence.PMContext;\n import org.apache.jackrabbit.core.persistence.PersistenceManager;\n import org.apache.jackrabbit.core.persistence.util.BLOBStore;\n+import org.apache.jackrabbit.core.persistence.util.BundleCache;\n import org.apache.jackrabbit.core.persistence.util.FileBasedIndex;\n import org.apache.jackrabbit.core.persistence.util.LRUNodeIdCache;\n import org.apache.jackrabbit.core.persistence.util.NodePropBundle;\n@@ -68,7 +68,7 @@\n  * included in the bundle but generated when required.\n  * <p/>\n  * In order to increase performance, there are 2 caches maintained. One is the\n- * bundle cache that caches already loaded bundles. The other is the\n+ * {@link BundleCache} that caches already loaded bundles. The other is the\n  * {@link LRUNodeIdCache} that caches non-existent bundles. This is useful\n  * because a lot of {@link #exists(NodeId)} calls are issued that would result\n  * in a useless SQL execution if the desired bundle does not exist.\n@@ -103,7 +103,7 @@\n     private StringIndex nameIndex;\n \n     /** the cache of loaded bundles */\n-    private LRUCache<NodeId, NodePropBundle> bundles;\n+    private BundleCache bundles;\n \n     /** the cache of non-existent bundles */\n     private LRUNodeIdCache missing;\n@@ -387,7 +387,7 @@ protected abstract void store(NodeReferences refs)\n     public void init(PMContext context) throws Exception {\n         this.context = context;\n         // init bundle cache\n-        bundles = new LRUCache<NodeId, NodePropBundle>(bundleCacheSize);\n+        bundles = new BundleCache(bundleCacheSize);\n         missing = new LRUNodeIdCache();\n     }\n \n@@ -654,7 +654,7 @@ private NodePropBundle getBundle(NodeId id) throws ItemStateException {\n                 bundle = loadBundle(id);\n                 if (bundle != null) {\n                     bundle.markOld();\n-                    bundles.put(id, bundle, bundle.getSize());\n+                    bundles.put(bundle);\n                 } else {\n                     missing.put(id);\n                 }\n@@ -690,9 +690,8 @@ private void putBundle(NodePropBundle bundle) throws ItemStateException {\n         missing.remove(bundle.getId());\n         // only put to cache if already exists. this is to ensure proper overwrite\n         // and not creating big contention during bulk loads\n-        if (bundles.containsKey(bundle.getId())) {\n-            bundles.remove(bundle.getId());\n-            bundles.put(bundle.getId(), bundle, bundle.getSize());\n+        if (bundles.contains(bundle.getId())) {\n+            bundles.put(bundle);\n         }\n     }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java"}, {"additions": 196, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java", "sha": "eef26ab885356573c608013cd928954773738f24", "changes": 196, "status": "added", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.persistence.util;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.jackrabbit.core.id.NodeId;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.Logger;\n+\n+/**\n+ * This Class implements a simple cache for nodeprop bundles\n+ */\n+public class BundleCache {\n+\n+    /**\n+     * the default logger\n+     */\n+    private static Logger log = LoggerFactory.getLogger(BundleCache.class);\n+\n+    /**\n+     * the current memory usage of this cache\n+     */\n+    private long curSize;\n+\n+    /**\n+     * the maximum chache size\n+     */\n+    private long maxSize;\n+\n+    /**\n+     * the number of cache hits\n+     */\n+    private long hits;\n+\n+    /**\n+     * the number of cache misses\n+     */\n+    private long misses;\n+\n+    /**\n+     * a map of the cache entries\n+     */\n+    private final LinkedHashMap<NodeId, NodePropBundle> bundles;\n+\n+    /**\n+     * Creates a new BundleCache\n+     *\n+     * @param maxSize the maximum size of this cache in bytes.\n+     */\n+    @SuppressWarnings(\"serial\")\n+    public BundleCache(long maxSize) {\n+        this.maxSize = maxSize;\n+        this.bundles = new LinkedHashMap<NodeId, NodePropBundle>(\n+                (int) maxSize / 1024, 0.75f, true /* access-ordered */) {\n+            @Override\n+            protected boolean removeEldestEntry(\n+                    Map.Entry<NodeId, NodePropBundle> e) {\n+                long maxSize = BundleCache.this.maxSize;\n+                if (curSize <= maxSize) {\n+                    return false;\n+                } else if (curSize - e.getValue().getSize() <= maxSize) {\n+                    curSize -= e.getValue().getSize();\n+                    return true;\n+                } else {\n+                    shrink();\n+                    return false;\n+                }\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Returns the maximum cache size in bytes.\n+     *\n+     * @return the maximum cache size in bytes.\n+     */\n+    public long getMaxSize() {\n+        return maxSize;\n+    }\n+\n+    /**\n+     * Sets the maximum cache size in bytes.\n+     *\n+     * @param maxSize the maximum cache size in bytes.\n+     */\n+    public void setMaxSize(long maxSize) {\n+        this.maxSize = maxSize;\n+\n+        if (curSize > maxSize) {\n+            shrink();\n+        }\n+    }\n+\n+    private void shrink() {\n+        List<NodePropBundle> list =\n+            new ArrayList<NodePropBundle>(bundles.values());\n+        for (int i = list.size() - 1; curSize > maxSize && i >= 0; i--) {\n+            NodePropBundle bundle = list.get(i);\n+            curSize -= bundle.getSize();\n+            bundles.remove(bundle.getId());\n+        }\n+    }\n+\n+    /**\n+     * Returns the bundle with the given <code>id</code> or <code>null</code>\n+     * if the bundle is not cached.\n+     *\n+     * @param id the id of the bundle\n+     * @return the cached bundle or <code>null</code>\n+     */\n+    public synchronized NodePropBundle get(NodeId id) {\n+        NodePropBundle bundle = bundles.get(id);\n+        if (bundle != null) {\n+            hits++;\n+        } else {\n+            misses++;\n+        }\n+        if (log.isInfoEnabled() && (hits + misses) % 10000 == 0) {\n+            long c = curSize / 1024;\n+            long m = maxSize / 1024;\n+            long a = bundles.size() > 0 ? curSize / bundles.size() : 0;\n+            log.info(\"num=\" + bundles.size() + \" mem=\" + c + \"k max=\" + m + \"k avg=\" + a\n+                    + \" hits=\" + hits + \" miss=\" + misses);\n+        }\n+        return bundle;\n+    }\n+\n+    /**\n+     * Puts a bundle to the cache.\n+     *\n+     * @param bundle the bunlde to put to the cache\n+     */\n+    public synchronized void put(NodePropBundle bundle) {\n+        NodePropBundle previous = bundles.get(bundle.getId());\n+        if (previous != null) {\n+            curSize -= previous.getSize();\n+        }\n+        bundles.put(bundle.getId(), bundle);\n+        curSize += bundle.getSize();\n+    }\n+\n+    /**\n+     * Checks if the bundle with the given id is cached.\n+     *\n+     * @param id the id of the bundle\n+     * @return <code>true</code> if the bundle is cached;\n+     *         <code>false</code> otherwise.\n+     */\n+    public synchronized boolean contains(NodeId id) {\n+        return bundles.containsKey(id);\n+    }\n+\n+    /**\n+     * Removes a bundle from this cache.\n+     *\n+     * @param id the id of the bunlde to remove.\n+     * @return the previously cached bunlde or <code>null</code> of the bundle\n+     *         was not cached.\n+     */\n+    public synchronized NodePropBundle remove(NodeId id) {\n+        NodePropBundle bundle = bundles.remove(id);\n+        if (bundle != null) {\n+            curSize -= bundle.getSize();\n+        }\n+        return bundle;\n+    }\n+\n+    /**\n+     * Clears this cache and removes all bundles.\n+     */\n+    public synchronized void clear() {\n+        bundles.clear();\n+        curSize = 0;\n+        hits = 0;\n+        misses = 0;\n+    }\n+\n+}", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java"}, {"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java", "sha": "6e2ad3f993d6131b4ad55931f638272071661e1c", "changes": 8, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -82,6 +82,14 @@\n      */\n     boolean isEmpty();\n \n+    /**\n+     * Informs the cache that the item was modified and the cache might need to\n+     * recalculate the items caching weight.\n+     *\n+     * @param id the id of the item that was modified.\n+     */\n+    void update(ItemId id);\n+\n     /**\n      * Informs the cache that it is no longer in use.\n      */", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java"}, {"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java", "sha": "f7e23f70701618e016af839d928f0f60ba88187e", "changes": 8, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -159,6 +159,14 @@ public synchronized void evictAll() {\n         refs.clear();\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    public synchronized void update(ItemId id) {\n+        // delegate\n+        cache.update(id);\n+    }\n+\n     /**\n      * {@inheritDoc}\n      */", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java"}, {"additions": 217, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java", "sha": "5fdccd585b0a8bae95dc29782678b7ca5acb576c", "changes": 241, "status": "modified", "deletions": 24, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -16,9 +16,14 @@\n  */\n package org.apache.jackrabbit.core.state;\n \n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n import org.apache.commons.collections.map.LinkedMap;\n-import org.apache.jackrabbit.core.cache.CacheManager;\n-import org.apache.jackrabbit.core.cache.LRUCache;\n+import org.apache.jackrabbit.core.cache.Cache;\n+import org.apache.jackrabbit.core.cache.CacheAccessListener;\n import org.apache.jackrabbit.core.id.ItemId;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -33,87 +38,275 @@\n  * TODO rename class to something more appropriate, e.g. FIFOItemSateCache since\n  * it doesn't use a LRU eviction policy anymore.\n  */\n-public class MLRUItemStateCache implements ItemStateCache {\n-\n+public class MLRUItemStateCache implements ItemStateCache, Cache {\n     /** Logger instance */\n     private static Logger log = LoggerFactory.getLogger(MLRUItemStateCache.class);\n \n     /** default maximum memory to use */\n     public static final int DEFAULT_MAX_MEM = 4 * 1024 * 1024;\n \n+    /** the amount of memory the entries use */\n+    private volatile long totalMem;\n+\n+    /** the maximum of memory the cache may use */\n+    private volatile long maxMem;\n+\n     /** the number of writes */\n-    private volatile long numWrites = 0;\n+    private volatile long numWrites;\n+\n+    /** the access count */\n+    private volatile long accessCount;\n \n-    private final LRUCache<ItemId, ItemState> cache =\n-        new LRUCache<ItemId, ItemState>(DEFAULT_MAX_MEM);\n+    /** the cache access listeners */\n+    private CacheAccessListener accessListener;\n \n-    public MLRUItemStateCache(CacheManager cacheMgr) {\n-        cacheMgr.add(cache);\n-        cache.setAccessListener(cacheMgr);\n+    /**\n+     * A cache for <code>ItemState</code> instances\n+     */\n+    private final Map<ItemId, Entry> cache;\n+\n+    /**\n+     * Constructs a new, empty <code>ItemStateCache</code> with a maximum amount\n+     * of memory of {@link #DEFAULT_MAX_MEM}.\n+     */\n+    public MLRUItemStateCache() {\n+        this(DEFAULT_MAX_MEM);\n     }\n \n-    //-------------------------------------------------------< ItemStateCache >\n+    /**\n+     * Constructs a new, empty <code>ItemStateCache</code> with the specified\n+     * maximum memory.\n+     *\n+     * @param maxMem the maximum amount of memory this cache may use.\n+     */\n+    @SuppressWarnings(\"serial\")\n+    private MLRUItemStateCache(int maxMem) {\n+        this.maxMem = maxMem;\n+        this.cache = new LinkedHashMap<ItemId, MLRUItemStateCache.Entry>(\n+                maxMem / 1024, 0.75f, true /* access-ordered */) {\n+            @Override\n+            protected boolean removeEldestEntry(Map.Entry<ItemId, Entry> e) {\n+                long maxMem = MLRUItemStateCache.this.maxMem;\n+                if (totalMem <= maxMem) {\n+                    return false;\n+                } else if (totalMem - e.getValue().size <= maxMem) {\n+                    totalMem -= e.getValue().size;\n+                    return true;\n+                } else {\n+                    shrink();\n+                    return false;\n+                }\n+            }\n+        };\n+    }\n \n+    //-------------------------------------------------------< ItemStateCache >\n     /**\n      * {@inheritDoc}\n      */\n     public boolean isCached(ItemId id) {\n-        return cache.containsKey(id);\n+        synchronized (cache) {\n+            return cache.containsKey(id);\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public ItemState retrieve(ItemId id) {\n-        return cache.get(id);\n+        touch();\n+        synchronized (cache) {\n+            Entry entry = cache.get(id);\n+            if (entry != null) {\n+                return entry.state;\n+            } else {\n+                return null;\n+            }\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public ItemState[] retrieveAll() {\n-        return cache.values();\n+        synchronized (cache) {\n+            ItemState[] states = new ItemState[cache.size()];\n+            int i = 0;\n+            for (Entry entry : cache.values()) {\n+                states[i++] = entry.state;\n+            }\n+            return states;\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n-    public synchronized void cache(ItemState state) {\n-        cache.put(state.getId(), state, state.calculateMemoryFootprint());\n+    public void update(ItemId id) {\n+        touch();\n+        synchronized (cache) {\n+            Entry entry = cache.get(id);\n+            if (entry != null) {\n+                totalMem -= entry.size;\n+                entry.recalc();\n+                totalMem += entry.size;\n+            }\n+        }\n+    }\n \n-        if (numWrites++ % 10000 == 0 && log.isDebugEnabled()) {\n-            log.debug(\"Item state cache size: {}% of {} bytes\",\n-                    cache.getMemoryUsed() * 100 / cache.getMaxMemorySize(),\n-                    cache.getMaxMemorySize());\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void cache(ItemState state) {\n+        touch();\n+        synchronized (cache) {\n+            ItemId id = state.getId();\n+            if (cache.containsKey(id)) {\n+                log.warn(\"overwriting cached entry \" + id);\n+                evict(id);\n+            }\n+            Entry entry = new Entry(state);\n+            totalMem += entry.size;\n+            cache.put(id, entry);\n+            if (numWrites++ % 10000 == 0 && log.isDebugEnabled()) {\n+                log.debug(this + \" size=\" + cache.size() + \", \" + totalMem + \"/\" + maxMem);\n+            }\n         }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public void evict(ItemId id) {\n-        cache.remove(id);\n+        touch();\n+        synchronized (cache) {\n+            Entry entry = cache.remove(id);\n+            if (entry != null) {\n+                totalMem -= entry.size;\n+            }\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public void evictAll() {\n-        cache.clear();\n+        synchronized (cache) {\n+            cache.clear();\n+            totalMem = 0;\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public boolean isEmpty() {\n-        return cache.isEmpty();\n+        synchronized (cache) {\n+            return cache.isEmpty();\n+        }\n+    }\n+\n+    private void touch() {\n+        accessCount++;\n+        if ((accessCount % CacheAccessListener.ACCESS_INTERVAL) == 0) {\n+            if (accessListener != null) {\n+                accessListener.cacheAccessed();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public long getAccessCount() {\n+        return accessCount;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public long getMaxMemorySize() {\n+        return maxMem;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public long getMemoryUsed() {\n+        return totalMem;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void resetAccessCount() {\n+        synchronized (cache) {\n+            accessCount = 0;\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void setMaxMemorySize(long size) {\n+        synchronized (cache) {\n+            this.maxMem = size;\n+\n+            // remove items, if too many\n+            if (totalMem > maxMem) {\n+                shrink();\n+            }\n+        }\n+    }\n+\n+    private void shrink() {\n+        List<Map.Entry<ItemId, Entry>> list =\n+            new ArrayList<Map.Entry<ItemId, Entry>>(cache.entrySet());\n+        for (int i = list.size() - 1; totalMem > maxMem && i >= 0; i--) {\n+            Map.Entry<ItemId, Entry> last = list.get(i);\n+            totalMem -= last.getValue().size;\n+            cache.remove(last.getKey());\n+        }\n+    }\n+\n+    /**\n+     * Set the cache access listener. Only one listener per cache is supported.\n+     *\n+     * @param listener the new listener\n+     */\n+    public void setAccessListener(CacheAccessListener listener) {\n+        this.accessListener = listener;\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public void dispose() {\n-        cache.dispose();\n+        synchronized (cache) {\n+            if (accessListener != null) {\n+                accessListener.disposeCache(this);\n+            }\n+        }\n+    }\n+\n+\n+    /**\n+     * Internal cache entry.\n+     */\n+    private static class Entry {\n+\n+        private final ItemState state;\n+\n+        private long size;\n+\n+        public Entry(ItemState state) {\n+            this.state = state;\n+            this.size = 64 + state.calculateMemoryFootprint();\n+        }\n+\n+        public void recalc() {\n+            size = 64 + state.calculateMemoryFootprint();\n+        }\n     }\n \n }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java"}, {"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java", "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java", "sha": "c9a843c4ecdc6b02ecf7e1d64cc114109233598f", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0", "patch": "@@ -41,7 +41,10 @@ public ManagedMLRUItemStateCacheFactory(CacheManager cacheMgr) {\n      * Create a new cache instance and link it to the cache manager.\n      */\n     public ItemStateCache newItemStateCache() {\n-        return new MLRUItemStateCache(cacheMgr);\n+        MLRUItemStateCache cache = new MLRUItemStateCache();\n+        cacheMgr.add(cache);\n+        cache.setAccessListener(cacheMgr);\n+        return cache;\n     }\n \n }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java", "sha": "180cb9fdd5b22d100390b666e9b77b86f54fa89d", "changes": 76, "status": "removed", "deletions": 76, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java?ref=44a1d182d1be2dbdd1f6920ed1676dba0327a71c", "patch": "@@ -1,76 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.core.cache;\n-\n-import junit.framework.TestCase;\n-\n-/**\n- * Test cases for the {@link LRUCache} class.\n- */\n-public class LRUCacheTest extends TestCase {\n-\n-    public void testLRUCache() {\n-        LRUCache<String, String> cache = new LRUCache<String, String>(3);\n-\n-        cache.put(\"foo\", \"1\", 1);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertEquals(1, cache.getMemoryUsed());\n-\n-        cache.put(\"bar\", \"12\", 2);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-\n-        cache.put(\"baz\", \"123\", 3);\n-        assertFalse(cache.containsKey(\"foo\"));\n-        assertFalse(cache.containsKey(\"bar\"));\n-        assertTrue(cache.containsKey(\"baz\"));\n-        assertEquals(\"123\", cache.get(\"baz\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-\n-        cache.put(\"foo\", \"1\", 1);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertFalse(cache.containsKey(\"bar\"));\n-        assertFalse(cache.containsKey(\"baz\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertEquals(1, cache.getMemoryUsed());\n-\n-        cache.put(\"bar\", \"12\", 2);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-\n-        cache.remove(\"foo\");\n-        assertFalse(cache.containsKey(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(2, cache.getMemoryUsed());\n-\n-        cache.put(\"foo\", \"1\", 1);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-    }\n-\n-}", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java", "blob_url": "https://github.com/apache/jackrabbit/blob/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java", "sha": "f4126ea88b635834181498950d1ad297890534c2", "changes": 33, "status": "removed", "deletions": 33, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java?ref=44a1d182d1be2dbdd1f6920ed1676dba0327a71c", "patch": "@@ -1,33 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.core.cache;\n-\n-import junit.framework.TestCase;\n-import junit.framework.Test;\n-import junit.framework.TestSuite;\n-\n-public class TestAll extends TestCase {\n-\n-    public static Test suite() {\n-        TestSuite suite = new TestSuite();\n-\n-        suite.addTestSuite(LRUCacheTest.class);\n-\n-        return suite;\n-    }\n-\n-}", "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/62f9c0bba50be5258d294c74a55b880282670b6a", "parent": "https://github.com/apache/jackrabbit/commit/dcfe2b71ed33d8d2147b0a83eac9ec36ead85b2e", "message": "JCR-2561 SQL2 query - supplying column selector fails with NPE on getColumnName()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@921890 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_54", "file": [{"additions": 232, "raw_url": "https://github.com/apache/jackrabbit/raw/62f9c0bba50be5258d294c74a55b880282670b6a/jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/commons/query/sql2/QOMFormatter.java", "blob_url": "https://github.com/apache/jackrabbit/blob/62f9c0bba50be5258d294c74a55b880282670b6a/jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/commons/query/sql2/QOMFormatter.java", "sha": "544e83c1e54e4ae080d006fad1f2703403d665d8", "changes": 494, "status": "modified", "deletions": 262, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/commons/query/sql2/QOMFormatter.java?ref=62f9c0bba50be5258d294c74a55b880282670b6a", "patch": "@@ -110,466 +110,435 @@ private QOMFormatter(QueryObjectModel qom) {\n      *\n      * @param qom the query object model to translate.\n      * @return the JCR_SQL2 statement.\n-     * @throws RepositoryException if an error occurs while formatting the qom. \n+     * @throws RepositoryException if an error occurs while formatting the qom.\n      */\n     public static String format(QueryObjectModel qom)\n             throws RepositoryException {\n         return new QOMFormatter(qom).format();\n     }\n \n     private String format() throws RepositoryException {\n-        sb.append(\"SELECT\");\n-        ws();\n-        format(qom.getColumns());\n-        ws();\n-        sb.append(\"FROM\");\n-        ws();\n-        format(qom.getSource());\n+        append(\"SELECT \");\n+        append(qom.getColumns());\n+        append(\" FROM \");\n+        append(qom.getSource());\n         Constraint c = qom.getConstraint();\n         if (c != null) {\n-            ws();\n-            sb.append(\"WHERE\");\n-            ws();\n-            format(c);\n+            append(\" WHERE \");\n+            append(c);\n         }\n         Ordering[] orderings = qom.getOrderings();\n         if (orderings.length > 0) {\n-            ws();\n-            sb.append(\"ORDER BY\");\n-            ws();\n-            format(orderings);\n+            append(\" ORDER BY \");\n+            append(orderings);\n         }\n         return sb.toString();\n     }\n \n-    private void format(Ordering[] orderings) {\n+    private void append(Ordering[] orderings) {\n         String comma = \"\";\n         for (Ordering ordering : orderings) {\n-            sb.append(comma);\n+            append(comma);\n             comma = \", \";\n-            format(ordering.getOperand());\n+            append(ordering.getOperand());\n             if (JCR_ORDER_DESCENDING.equals(ordering.getOrder())) {\n-                ws();\n-                sb.append(\"DESC\");\n+                append(\" DESC\");\n             }\n         }\n     }\n \n-    private void format(Constraint c)\n+    private void append(Constraint c)\n             throws RepositoryException {\n         if (c instanceof And) {\n-            format((And) c);\n+            append((And) c);\n         } else if (c instanceof ChildNode) {\n-            format((ChildNode) c);\n+            append((ChildNode) c);\n         } else if (c instanceof Comparison) {\n-            format((Comparison) c);\n+            append((Comparison) c);\n         } else if (c instanceof DescendantNode) {\n-            format((DescendantNode) c);\n+            append((DescendantNode) c);\n         } else if (c instanceof FullTextSearch) {\n-            format((FullTextSearch) c);\n+            append((FullTextSearch) c);\n         } else if (c instanceof Not) {\n-            format((Not) c);\n+            append((Not) c);\n         } else if (c instanceof Or) {\n-            format((Or) c);\n+            append((Or) c);\n         } else if (c instanceof PropertyExistence) {\n-            format((PropertyExistence) c);\n+            append((PropertyExistence) c);\n         } else {\n-            format((SameNode) c);\n+            append((SameNode) c);\n         }\n     }\n \n-    private void format(And constraint)\n+    private void append(And constraint)\n             throws RepositoryException {\n         String and = \"\";\n         for (Constraint c : Arrays.asList(\n                 constraint.getConstraint1(),\n                 constraint.getConstraint2())) {\n-            sb.append(and);\n+            append(and);\n             and = \" AND \";\n             boolean paren = c instanceof Or;\n             if (paren) {\n-                sb.append(\"(\");\n+                append(\"(\");\n             }\n-            format(c);\n+            append(c);\n             if (paren) {\n-                sb.append(\")\");\n+                append(\")\");\n             }\n         }\n     }\n \n-    private void format(ChildNode constraint) {\n-        sb.append(\"ISCHILDNODE(\");\n-        formatName(constraint.getSelectorName());\n-        sb.append(\",\");\n-        ws();\n-        formatPath(constraint.getParentPath());\n-        sb.append(\")\");\n+    private void append(ChildNode constraint) {\n+        append(\"ISCHILDNODE(\");\n+        appendName(constraint.getSelectorName());\n+        append(\", \");\n+        appendPath(constraint.getParentPath());\n+        append(\")\");\n     }\n \n-    private void format(Comparison constraint)\n+    private void append(Comparison constraint)\n             throws RepositoryException {\n-        format(constraint.getOperand1());\n-        ws();\n-        formatOperator(constraint.getOperator());\n-        ws();\n-        format(constraint.getOperand2());\n+        append(constraint.getOperand1());\n+        append(\" \");\n+        appendOperator(constraint.getOperator());\n+        append(\" \");\n+        append(constraint.getOperand2());\n     }\n \n-    private void format(StaticOperand operand)\n+    private void append(StaticOperand operand)\n             throws RepositoryException {\n         if (operand instanceof BindVariableValue) {\n-            format((BindVariableValue) operand);\n+            append((BindVariableValue) operand);\n         } else {\n-            format((Literal) operand);\n+            append((Literal) operand);\n         }\n     }\n \n-    private void format(BindVariableValue value) {\n-        sb.append(\"$\");\n-        sb.append(value.getBindVariableName());\n+    private void append(BindVariableValue value) {\n+        append(\"$\");\n+        append(value.getBindVariableName());\n     }\n \n-    private void format(Literal value)\n+    private void append(Literal value)\n             throws RepositoryException {\n         Value v = value.getLiteralValue();\n         switch (v.getType()) {\n             case PropertyType.BINARY:\n-                formatCastLiteral(v.getString(), \"BINARY\");\n+                appendCastLiteral(v.getString(), \"BINARY\");\n                 break;\n             case PropertyType.BOOLEAN:\n-                sb.append(v.getString());\n+                append(v.getString());\n                 break;\n             case PropertyType.DATE:\n-                formatCastLiteral(v.getString(), \"DATE\");\n+                appendCastLiteral(v.getString(), \"DATE\");\n                 break;\n             case PropertyType.DECIMAL:\n-                sb.append(v.getString());\n+                append(v.getString());\n                 break;\n             case PropertyType.DOUBLE:\n-                sb.append(v.getString());\n+                append(v.getString());\n                 break;\n             case PropertyType.LONG:\n-                sb.append(v.getString());\n+                append(v.getString());\n                 break;\n             case PropertyType.NAME:\n-                formatCastLiteral(v.getString(), \"NAME\");\n+                appendCastLiteral(v.getString(), \"NAME\");\n                 break;\n             case PropertyType.PATH:\n-                formatCastLiteral(v.getString(), \"PATH\");\n+                appendCastLiteral(v.getString(), \"PATH\");\n                 break;\n             case PropertyType.REFERENCE:\n-                formatCastLiteral(v.getString(), \"REFERENCE\");\n+                appendCastLiteral(v.getString(), \"REFERENCE\");\n                 break;\n             case PropertyType.STRING:\n-                formatStringLiteral(v.getString());\n+                appendStringLiteral(v.getString());\n                 break;\n             case PropertyType.URI:\n-                formatCastLiteral(v.getString(), \"URI\");\n+                appendCastLiteral(v.getString(), \"URI\");\n                 break;\n             case PropertyType.WEAKREFERENCE:\n-                formatCastLiteral(v.getString(), \"WEAKREFERENCE\");\n+                appendCastLiteral(v.getString(), \"WEAKREFERENCE\");\n                 break;\n         }\n     }\n \n-    private void formatCastLiteral(String value, String propertyType) {\n-        sb.append(\"CAST(\");\n-        formatStringLiteral(value);\n-        ws();\n-        sb.append(\"AS\");\n-        ws();\n-        sb.append(propertyType);\n-        sb.append(\")\");\n+    private void appendCastLiteral(String value, String propertyType) {\n+        append(\"CAST(\");\n+        appendStringLiteral(value);\n+        append(\" AS \");\n+        append(propertyType);\n+        append(\")\");\n     }\n \n-    private void formatStringLiteral(String value) {\n-        sb.append(\"'\");\n-        sb.append(value.replaceAll(\"'\", \"''\"));\n-        sb.append(\"'\");\n+    private void appendStringLiteral(String value) {\n+        append(\"'\");\n+        append(value.replaceAll(\"'\", \"''\"));\n+        append(\"'\");\n     }\n \n-    private void formatOperator(String operator) {\n+    private void appendOperator(String operator) {\n         if (JCR_OPERATOR_EQUAL_TO.equals(operator)) {\n-            sb.append(\"=\");\n+            append(\"=\");\n         } else if (JCR_OPERATOR_GREATER_THAN.equals(operator)) {\n-            sb.append(\">\");\n+            append(\">\");\n         } else if (JCR_OPERATOR_GREATER_THAN_OR_EQUAL_TO.equals(operator)) {\n-            sb.append(\">=\");\n+            append(\">=\");\n         } else if (JCR_OPERATOR_LESS_THAN.equals(operator)) {\n-            sb.append(\"<\");\n+            append(\"<\");\n         } else if (JCR_OPERATOR_LESS_THAN_OR_EQUAL_TO.equals(operator)) {\n-            sb.append(\"<=\");\n+            append(\"<=\");\n         } else if (JCR_OPERATOR_LIKE.equals(operator)) {\n-            sb.append(\"LIKE\");\n+            append(\"LIKE\");\n         } else {\n-            sb.append(\"<>\");\n+            append(\"<>\");\n         }\n     }\n \n-    private void format(DynamicOperand operand) {\n+    private void append(DynamicOperand operand) {\n         if (operand instanceof FullTextSearchScore) {\n-            format((FullTextSearchScore) operand);\n+            append((FullTextSearchScore) operand);\n         } else if (operand instanceof Length) {\n-            format((Length) operand);\n+            append((Length) operand);\n         } else if (operand instanceof LowerCase) {\n-            format((LowerCase) operand);\n+            append((LowerCase) operand);\n         } else if (operand instanceof NodeLocalName) {\n-            format((NodeLocalName) operand);\n+            append((NodeLocalName) operand);\n         } else if (operand instanceof NodeName) {\n-            format((NodeName) operand);\n+            append((NodeName) operand);\n         } else if (operand instanceof PropertyValue) {\n-            format((PropertyValue) operand);\n+            append((PropertyValue) operand);\n         } else {\n-            format((UpperCase) operand);\n+            append((UpperCase) operand);\n         }\n     }\n \n-    private void format(FullTextSearchScore operand) {\n-        sb.append(\"SCORE(\");\n-        formatName(operand.getSelectorName());\n-        sb.append(\")\");\n+    private void append(FullTextSearchScore operand) {\n+        append(\"SCORE(\");\n+        appendName(operand.getSelectorName());\n+        append(\")\");\n     }\n \n-    private void format(Length operand) {\n-        sb.append(\"LENGTH(\");\n-        format(operand.getPropertyValue());\n-        sb.append(\")\");\n+    private void append(Length operand) {\n+        append(\"LENGTH(\");\n+        append(operand.getPropertyValue());\n+        append(\")\");\n     }\n \n-    private void format(LowerCase operand) {\n-        sb.append(\"LOWER(\");\n-        format(operand.getOperand());\n-        sb.append(\")\");\n+    private void append(LowerCase operand) {\n+        append(\"LOWER(\");\n+        append(operand.getOperand());\n+        append(\")\");\n     }\n \n-    private void format(NodeLocalName operand) {\n-        sb.append(\"LOCALNAME(\");\n-        formatName(operand.getSelectorName());\n-        sb.append(\")\");\n+    private void append(NodeLocalName operand) {\n+        append(\"LOCALNAME(\");\n+        appendName(operand.getSelectorName());\n+        append(\")\");\n     }\n \n-    private void format(NodeName operand) {\n-        sb.append(\"NAME(\");\n-        formatName(operand.getSelectorName());\n-        sb.append(\")\");\n+    private void append(NodeName operand) {\n+        append(\"NAME(\");\n+        appendName(operand.getSelectorName());\n+        append(\")\");\n     }\n \n-    private void format(PropertyValue operand) {\n-        formatName(operand.getSelectorName());\n-        sb.append(\".\");\n-        formatName(operand.getPropertyName());\n+    private void append(PropertyValue operand) {\n+        appendName(operand.getSelectorName());\n+        append(\".\");\n+        appendName(operand.getPropertyName());\n     }\n \n-    private void format(UpperCase operand) {\n-        sb.append(\"UPPER(\");\n-        format(operand.getOperand());\n-        sb.append(\")\");\n+    private void append(UpperCase operand) {\n+        append(\"UPPER(\");\n+        append(operand.getOperand());\n+        append(\")\");\n     }\n \n-    private void format(DescendantNode constraint) {\n-        sb.append(\"ISDESCENDANTNODE(\");\n-        formatName(constraint.getSelectorName());\n-        sb.append(\",\");\n-        ws();\n-        formatPath(constraint.getAncestorPath());\n-        sb.append(\")\");\n+    private void append(DescendantNode constraint) {\n+        append(\"ISDESCENDANTNODE(\");\n+        appendName(constraint.getSelectorName());\n+        append(\", \");\n+        appendPath(constraint.getAncestorPath());\n+        append(\")\");\n     }\n \n-    private void format(FullTextSearch constraint)\n-            throws RepositoryException {\n-        sb.append(\"CONTAINS(\");\n-        formatName(constraint.getSelectorName());\n-        sb.append(\".\");\n+    private void append(FullTextSearch constraint) throws RepositoryException {\n+        append(\"CONTAINS(\");\n+        appendName(constraint.getSelectorName());\n+        append(\".\");\n         String propName = constraint.getPropertyName();\n         if (propName == null) {\n-            sb.append(\"*\");\n+            append(\"*\");\n         } else {\n-            formatName(propName);\n+            appendName(propName);\n         }\n-        sb.append(\",\");\n-        ws();\n-        format(constraint.getFullTextSearchExpression());\n-        sb.append(\")\");\n+        append(\", \");\n+        append(constraint.getFullTextSearchExpression());\n+        append(\")\");\n     }\n \n-    private void format(Not constraint)\n-            throws RepositoryException {\n-        sb.append(\"NOT\");\n-        ws();\n+    private void append(Not constraint) throws RepositoryException {\n+        append(\"NOT \");\n         Constraint c = constraint.getConstraint();\n         boolean paren = c instanceof And || c instanceof Or;\n         if (paren) {\n-            sb.append(\"(\");\n+            append(\"(\");\n         }\n-        format(c);\n+        append(c);\n         if (paren) {\n-            sb.append(\")\");\n+            append(\")\");\n         }\n     }\n \n-    private void format(Or constraint)\n-            throws RepositoryException {\n-        format(constraint.getConstraint1());\n-        ws();\n-        sb.append(\"OR\");\n-        ws();\n-        format(constraint.getConstraint2());\n+    private void append(Or constraint) throws RepositoryException {\n+        append(constraint.getConstraint1());\n+        append(\" OR \");\n+        append(constraint.getConstraint2());\n     }\n \n-    private void format(PropertyExistence constraint) {\n-        formatName(constraint.getSelectorName());\n-        sb.append(\".\");\n-        formatName(constraint.getPropertyName());\n-        ws();\n-        sb.append(\"IS NOT NULL\");\n+    private void append(PropertyExistence constraint) {\n+        appendName(constraint.getSelectorName());\n+        append(\".\");\n+        appendName(constraint.getPropertyName());\n+        append(\" IS NOT NULL\");\n     }\n \n-    private void format(SameNode constraint) {\n-        sb.append(\"ISSAMENODE(\");\n-        formatName(constraint.getSelectorName());\n-        sb.append(\",\");\n-        ws();\n-        formatPath(constraint.getPath());\n-        sb.append(\")\");\n+    private void append(SameNode constraint) {\n+        append(\"ISSAMENODE(\");\n+        appendName(constraint.getSelectorName());\n+        append(\", \");\n+        appendPath(constraint.getPath());\n+        append(\")\");\n     }\n \n-    private void format(Column[] columns) {\n+    private void append(Column[] columns) {\n         if (columns.length == 0) {\n-            sb.append(\"*\");\n+            append(\"*\");\n         } else {\n             String comma = \"\";\n             for (Column c : columns) {\n-                sb.append(comma);\n+                append(comma);\n                 comma = \", \";\n-                formatName(c.getSelectorName());\n-                sb.append(\".\");\n+                appendName(c.getSelectorName());\n+                append(\".\");\n                 String propName = c.getPropertyName();\n                 if (propName != null) {\n-                    formatName(propName);\n-                    ws();\n-                    sb.append(\"AS\");\n-                    ws();\n-                    formatName(c.getColumnName());\n+                    appendName(propName);\n+                    if (c.getColumnName() != null) {\n+                        append(\" AS \");\n+                        appendName(c.getColumnName());\n+                    }\n                 } else {\n-                    sb.append(\"*\");\n+                    append(\"*\");\n                 }\n             }\n         }\n     }\n \n-    private void format(Source source) {\n+    private void append(Source source) {\n         if (source instanceof Join) {\n-            format((Join) source);\n+            append((Join) source);\n         } else {\n-            format((Selector) source);\n+            append((Selector) source);\n         }\n     }\n \n-    private void format(Join join) {\n-        format(join.getLeft());\n-        ws();\n-        formatJoinType(join.getJoinType());\n-        ws();\n-        sb.append(\"JOIN\");\n-        ws();\n-        format(join.getRight());\n-        ws();\n-        sb.append(\"ON\");\n-        ws();\n-        format(join.getJoinCondition());\n+    private void append(Join join) {\n+        append(join.getLeft());\n+        append(\" \");\n+        appendJoinType(join.getJoinType());\n+        append(\" JOIN \");\n+        append(join.getRight());\n+        append(\" ON \");\n+        append(join.getJoinCondition());\n     }\n \n-    private void format(JoinCondition joinCondition) {\n+    private void append(JoinCondition joinCondition) {\n         if (joinCondition instanceof EquiJoinCondition) {\n-            format((EquiJoinCondition) joinCondition);\n+            append((EquiJoinCondition) joinCondition);\n         } else if (joinCondition instanceof ChildNodeJoinCondition) {\n-            format((ChildNodeJoinCondition) joinCondition);\n+            append((ChildNodeJoinCondition) joinCondition);\n         } else if (joinCondition instanceof DescendantNodeJoinCondition) {\n-            format((DescendantNodeJoinCondition) joinCondition);\n+            append((DescendantNodeJoinCondition) joinCondition);\n         } else {\n-            format((SameNodeJoinCondition) joinCondition);\n+            append((SameNodeJoinCondition) joinCondition);\n         }\n     }\n \n-    private void format(EquiJoinCondition condition) {\n-        formatName(condition.getSelector1Name());\n-        sb.append(\".\");\n-        formatName(condition.getProperty1Name());\n-        ws();\n-        sb.append(\"=\");\n-        ws();\n-        formatName(condition.getSelector2Name());\n-        sb.append(\".\");\n-        formatName(condition.getProperty2Name());\n-    }\n-\n-    private void format(ChildNodeJoinCondition condition) {\n-        sb.append(\"ISCHILDNODE(\");\n-        formatName(condition.getChildSelectorName());\n-        sb.append(\",\");\n-        ws();\n-        formatName(condition.getParentSelectorName());\n-        sb.append(\")\");\n-    }\n-\n-    private void format(DescendantNodeJoinCondition condition) {\n-        sb.append(\"ISDESCENDANTNODE(\");\n-        formatName(condition.getDescendantSelectorName());\n-        sb.append(\",\");\n-        ws();\n-        formatName(condition.getAncestorSelectorName());\n-        sb.append(\")\");\n-    }\n-\n-    private void format(SameNodeJoinCondition condition) {\n-        sb.append(\"ISSAMENODE(\");\n-        formatName(condition.getSelector1Name());\n-        sb.append(\",\");\n-        ws();\n-        formatName(condition.getSelector2Name());\n+    private void append(EquiJoinCondition condition) {\n+        appendName(condition.getSelector1Name());\n+        append(\".\");\n+        appendName(condition.getProperty1Name());\n+        append(\" = \");\n+        appendName(condition.getSelector2Name());\n+        append(\".\");\n+        appendName(condition.getProperty2Name());\n+    }\n+\n+    private void append(ChildNodeJoinCondition condition) {\n+        append(\"ISCHILDNODE(\");\n+        appendName(condition.getChildSelectorName());\n+        append(\", \");\n+        appendName(condition.getParentSelectorName());\n+        append(\")\");\n+    }\n+\n+    private void append(DescendantNodeJoinCondition condition) {\n+        append(\"ISDESCENDANTNODE(\");\n+        appendName(condition.getDescendantSelectorName());\n+        append(\", \");\n+        appendName(condition.getAncestorSelectorName());\n+        append(\")\");\n+    }\n+\n+    private void append(SameNodeJoinCondition condition) {\n+        append(\"ISSAMENODE(\");\n+        appendName(condition.getSelector1Name());\n+        append(\", \");\n+        appendName(condition.getSelector2Name());\n         if (condition.getSelector2Path() != null) {\n-            sb.append(\",\");\n-            ws();\n-            formatPath(condition.getSelector2Path());\n+            append(\", \");\n+            appendPath(condition.getSelector2Path());\n         }\n-        sb.append(\")\");\n+        append(\")\");\n     }\n \n-    private void formatPath(String path) {\n+    private void appendPath(String path) {\n         if (isSimpleName(path)) {\n-            sb.append(path);\n+            append(path);\n         } else {\n-            sb.append(\"[\");\n-            sb.append(path);\n-            sb.append(\"]\");\n+            append(\"[\");\n+            append(path);\n+            append(\"]\");\n         }\n     }\n \n-    private void formatJoinType(String joinType) {\n+    private void appendJoinType(String joinType) {\n         if (joinType.equals(JCR_JOIN_TYPE_INNER)) {\n-            sb.append(\"INNER\");\n+            append(\"INNER\");\n         } else if (joinType.equals(JCR_JOIN_TYPE_LEFT_OUTER)) {\n-            sb.append(\"LEFT OUTER\");\n+            append(\"LEFT OUTER\");\n         } else {\n-            sb.append(\"RIGHT OUTER\");\n+            append(\"RIGHT OUTER\");\n         }\n     }\n \n-    private void format(Selector selector) {\n-        formatName(selector.getNodeTypeName());\n-        ws();\n-        sb.append(\"AS\");\n-        ws();\n-        formatName(selector.getSelectorName());\n+    private void append(Selector selector) {\n+        appendName(selector.getNodeTypeName());\n+        if (!selector.getSelectorName().equals(selector.getNodeTypeName())) {\n+            append(\" AS \");\n+            appendName(selector.getSelectorName());\n+        }\n     }\n \n-    private void formatName(String name) {\n+    private void appendName(String name) {\n         if (isSimpleName(name)) {\n-            sb.append(name);\n+            append(name);\n         } else {\n-            sb.append(\"[\");\n-            sb.append(name);\n-            sb.append(\"]\");\n+            append(\"[\");\n+            append(name);\n+            append(\"]\");\n         }\n     }\n \n@@ -589,7 +558,8 @@ private static boolean isSimpleName(String name) {\n         return true;\n     }\n \n-    private void ws() {\n-        sb.append(\" \");\n+    private void append(String s) {\n+        sb.append(s);\n     }\n+\n }", "filename": "jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/commons/query/sql2/QOMFormatter.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/afe7024fdd2f04bc4c93d8b983544acb9bc4f688", "parent": "https://github.com/apache/jackrabbit/commit/0dafce4b147a5f1514752f66acc0a51d5cc3306f", "message": "JCR-2534: jcr-server: NPE in SearchResourceImpl if PathValue path is null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@918600 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_55", "file": [{"additions": 3, "raw_url": "https://github.com/apache/jackrabbit/raw/afe7024fdd2f04bc4c93d8b983544acb9bc4f688/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/search/SearchResourceImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/afe7024fdd2f04bc4c93d8b983544acb9bc4f688/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/search/SearchResourceImpl.java", "sha": "eaa904a32278cf0e13e181aaee0b22b4aa78c69a", "changes": 9, "status": "modified", "deletions": 6, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/search/SearchResourceImpl.java?ref=afe7024fdd2f04bc4c93d8b983544acb9bc4f688", "patch": "@@ -365,21 +365,18 @@ public Value getValue(Row row) throws RepositoryException {\n             } else {\n                 path = row.getPath();\n             }\n-            return vf.createValue(path, PropertyType.PATH);\n+            return (path == null) ? null : vf.createValue(path, PropertyType.PATH);\n         }\n     }\n \n     private static void collectSelectorNames(Query query,\n                                              QueryResult result,\n-                                             List<String> sn) {\n+                                             List<String> sn) throws RepositoryException {\n         if (query instanceof QueryObjectModel) {\n             QueryObjectModel qom = (QueryObjectModel) query;\n             collectSelectorNames(qom.getSource(), sn);\n         } else {\n-            // TODO\n-            // sn.addAll(Arrays.asList(qResult.getSelectorNames()));\n-            // TODO: remove once getSelectorNames() is available\n-            sn.add(null); // default selector\n+            sn.addAll(Arrays.asList(result.getSelectorNames()));\n         }\n     }\n ", "filename": "jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/search/SearchResourceImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/4e995165fa53f690061186acca45a8558f834df5", "parent": "https://github.com/apache/jackrabbit/commit/153c8f238512c92152a6020e900fa0b3a2adb6dc", "message": "JCR-2058: fix get getLinearSuccessor(), which was failing with NPE on the base version\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@772285 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_56", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/4e995165fa53f690061186acca45a8558f834df5/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/4e995165fa53f690061186acca45a8558f834df5/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java", "sha": "34db510591d990aae3ac7f1c7347b863bbb3c8ab", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java?ref=4e995165fa53f690061186acca45a8558f834df5", "patch": "@@ -113,7 +113,7 @@ public Version getLinearSuccessor() throws RepositoryException {\n         InternalVersion base = ((VersionImpl) vn.getBaseVersion()).getInternalVersion();\n \n         InternalVersion suc = getInternalVersion().getLinearSuccessor(base);\n-        return (Version) session.getNodeById(suc.getId());\n+        return suc == null ? null : (Version) session.getNodeById(suc.getId());\n     }\n \n     /**", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/ac1354cd57d9aa8492555381a7c30715132909e6", "parent": "https://github.com/apache/jackrabbit/commit/cb0c0b1fe5e1137726ff14f5dbdc14bdae97dd63", "message": "JCR-2032 : BasicCredentialsProviderTest throws NPE if defaultAuthHeader init param misses the password\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@755512 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_57", "file": [{"additions": 2, "raw_url": "https://github.com/apache/jackrabbit/raw/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java", "blob_url": "https://github.com/apache/jackrabbit/blob/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java", "sha": "e80e812694e6022c0f44113f15327545a0e830bd", "changes": 4, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java?ref=ac1354cd57d9aa8492555381a7c30715132909e6", "patch": "@@ -94,8 +94,8 @@ public Credentials getCredentials(HttpServletRequest request)\n                     return null;\n                 } else {\n                     int pos = defaultHeaderValue.indexOf(':');\n-                    if (pos<0) {\n-                        return new SimpleCredentials(defaultHeaderValue, null);\n+                    if (pos < 0) {\n+                        return new SimpleCredentials(defaultHeaderValue, new char[0]);\n                     } else {\n                         return new SimpleCredentials(\n                                 defaultHeaderValue.substring(0, pos),", "filename": "jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java"}, {"additions": 287, "raw_url": "https://github.com/apache/jackrabbit/raw/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java", "sha": "f9b703db6b7f9b649b50f60a818112f72c983410", "changes": 287, "status": "added", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java?ref=ac1354cd57d9aa8492555381a7c30715132909e6", "patch": "@@ -0,0 +1,287 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.server;\n+\n+import junit.framework.TestCase;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpSession;\n+import javax.servlet.ServletInputStream;\n+import javax.servlet.RequestDispatcher;\n+import javax.servlet.ServletException;\n+import javax.jcr.LoginException;\n+import javax.jcr.Credentials;\n+import javax.jcr.SimpleCredentials;\n+import java.util.Enumeration;\n+import java.util.Map;\n+import java.util.Locale;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.security.Principal;\n+import java.io.UnsupportedEncodingException;\n+import java.io.IOException;\n+import java.io.BufferedReader;\n+\n+/**\n+ * <code>BasicCredentialsProviderTest</code>...\n+ */\n+public class BasicCredentialsProviderTest extends TestCase {\n+\n+    public void testMissingDefaultHeader() throws ServletException {\n+        CredentialsProvider cb = new BasicCredentialsProvider(null);\n+        try {\n+            Credentials creds = cb.getCredentials(new RequestImpl(null));\n+            fail(\"LoginException expected\");\n+        } catch (LoginException e) {\n+            // ok\n+        }\n+    }\n+\n+    public void testDefaultPassword() throws ServletException, LoginException {\n+        Map m = new HashMap();\n+        m.put(\"userId\", new char[0]);\n+        m.put(\"userId:\", new char[0]);\n+        m.put(\"userId:pw\", \"pw\".toCharArray());\n+\n+        for (Iterator it = m.keySet().iterator(); it.hasNext();) {\n+            String defaultHeaderValue = it.next().toString();\n+            char[] pw = (char[]) m.get(defaultHeaderValue);\n+\n+            CredentialsProvider cb = new BasicCredentialsProvider(defaultHeaderValue);\n+            Credentials creds = cb.getCredentials(new RequestImpl(null));\n+\n+            assertNotNull(creds);\n+            assertTrue(creds instanceof SimpleCredentials);\n+            assertEquals(\"userId\",((SimpleCredentials) creds).getUserID());\n+            if (pw.length == 0) {\n+                assertEquals(0, ((SimpleCredentials) creds).getPassword().length);\n+            } else {\n+                assertEquals(new String(pw), new String(((SimpleCredentials) creds).getPassword()));\n+            }\n+        }\n+    }\n+\n+\n+\n+\n+    private class RequestImpl implements HttpServletRequest {\n+\n+        private final String authHeader;\n+\n+        private RequestImpl(String authHeader) {\n+            this.authHeader = authHeader;\n+        }\n+\n+        public String getAuthType() {\n+            return null;\n+        }\n+\n+        public Cookie[] getCookies() {\n+            return new Cookie[0];\n+        }\n+\n+        public long getDateHeader(String name) {\n+            return 0;\n+        }\n+\n+        public String getHeader(String name) {\n+            return authHeader;\n+        }\n+\n+        public Enumeration getHeaders(String name) {\n+            return null;\n+        }\n+\n+        public Enumeration getHeaderNames() {\n+            return null;\n+        }\n+\n+        public int getIntHeader(String name) {\n+            return 0;\n+        }\n+\n+        public String getMethod() {\n+            return null;\n+        }\n+\n+        public String getPathInfo() {\n+            return null;\n+        }\n+\n+        public String getPathTranslated() {\n+            return null;\n+        }\n+\n+        public String getContextPath() {\n+            return null;\n+        }\n+\n+        public String getQueryString() {\n+            return null;\n+        }\n+\n+        public String getRemoteUser() {\n+            return null;\n+        }\n+\n+        public boolean isUserInRole(String role) {\n+            return false;\n+        }\n+\n+        public Principal getUserPrincipal() {\n+            return null;\n+        }\n+\n+        public String getRequestedSessionId() {\n+            return null;\n+        }\n+\n+        public String getRequestURI() {\n+            return null;\n+        }\n+\n+        public StringBuffer getRequestURL() {\n+            return null;\n+        }\n+\n+        public String getServletPath() {\n+            return null;\n+        }\n+\n+        public HttpSession getSession(boolean create) {\n+            return null;\n+        }\n+\n+        public HttpSession getSession() {\n+            return null;\n+        }\n+\n+        public boolean isRequestedSessionIdValid() {\n+            return false;\n+        }\n+\n+        public boolean isRequestedSessionIdFromCookie() {\n+            return false;\n+        }\n+\n+        public boolean isRequestedSessionIdFromURL() {\n+            return false;\n+        }\n+\n+        public boolean isRequestedSessionIdFromUrl() {\n+            return false;\n+        }\n+\n+        public Object getAttribute(String name) {\n+            return null;\n+        }\n+\n+        public Enumeration getAttributeNames() {\n+            return null;\n+        }\n+\n+        public String getCharacterEncoding() {\n+            return null;\n+        }\n+\n+        public void setCharacterEncoding(String s) throws UnsupportedEncodingException {\n+        }\n+\n+        public int getContentLength() {\n+            return 0;\n+        }\n+\n+        public String getContentType() {\n+            return null;\n+        }\n+\n+        public ServletInputStream getInputStream() throws IOException {\n+            return null;\n+        }\n+\n+        public String getParameter(String name) {\n+            return null;\n+        }\n+\n+        public Enumeration getParameterNames() {\n+            return null;\n+        }\n+\n+        public String[] getParameterValues(String name) {\n+            return new String[0];\n+        }\n+\n+        public Map getParameterMap() {\n+            return null;\n+        }\n+\n+        public String getProtocol() {\n+            return null;\n+        }\n+\n+        public String getScheme() {\n+            return null;\n+        }\n+\n+        public String getServerName() {\n+            return null;\n+        }\n+\n+        public int getServerPort() {\n+            return 0;\n+        }\n+\n+        public BufferedReader getReader() throws IOException {\n+            return null;\n+        }\n+\n+        public String getRemoteAddr() {\n+            return null;\n+        }\n+\n+        public String getRemoteHost() {\n+            return null;\n+        }\n+\n+        public void setAttribute(String name, Object o) {\n+        }\n+\n+        public void removeAttribute(String name) {\n+        }\n+\n+        public Locale getLocale() {\n+            return null;\n+        }\n+\n+        public Enumeration getLocales() {\n+            return null;\n+        }\n+\n+        public boolean isSecure() {\n+            return false;\n+        }\n+\n+        public RequestDispatcher getRequestDispatcher(String path) {\n+            return null;\n+        }\n+\n+        public String getRealPath(String path) {\n+            return null;\n+        }\n+    }\n+}\n\\ No newline at end of file", "filename": "jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java"}, {"additions": 39, "raw_url": "https://github.com/apache/jackrabbit/raw/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java", "blob_url": "https://github.com/apache/jackrabbit/blob/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java", "sha": "26efafb9d1b19aea6a1aa373f31f3d660ada6091", "changes": 39, "status": "added", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java?ref=ac1354cd57d9aa8492555381a7c30715132909e6", "patch": "@@ -0,0 +1,39 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.server;\n+\n+import junit.framework.Test;\n+import junit.framework.TestCase;\n+import junit.framework.TestSuite;\n+\n+/**\n+ * Test suite that includes all testcases for package org.apache.jackrabbit.server.\n+ */\n+public class TestAll extends TestCase {\n+\n+    /**\n+     * Returns a <code>Test</code> suite that executes all tests inside this\n+     * package.\n+     */\n+    public static Test suite() {\n+        TestSuite suite = new TestSuite(\"org.apache.jackrabbit.server tests\");\n+\n+        suite.addTestSuite(BasicCredentialsProviderTest.class);\n+\n+        return suite;\n+    }\n+}", "filename": "jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/75e67c5a35528f59729af55345b8428e7999951a", "parent": "https://github.com/apache/jackrabbit/commit/b88ddc6c2057a1b66c56304b78d487c999cd7767", "message": "JCR-1857: NPE with SessionImporter#checkIncludesMixReferenceable if NodeInfo doesn't contain mixin names\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@714034 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_58", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java", "blob_url": "https://github.com/apache/jackrabbit/blob/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java", "sha": "c8a2d55c61e2d061670dfa6a2dc93bd5b0f14a7e", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java?ref=75e67c5a35528f59729af55345b8428e7999951a", "patch": "@@ -634,7 +634,10 @@ private QValue buildQValue(TextValue tv, int targetType, NamePathResolver resolv\n     private void checkIncludesMixReferenceable(Importer.NodeInfo nodeInfo) throws RepositoryException {\n         List l = new ArrayList();\n         l.add(nodeInfo.getNodeTypeName());\n-        l.addAll(Arrays.asList(nodeInfo.getMixinNames()));\n+        Name[] mixinNames = nodeInfo.getMixinNames();\n+        if (mixinNames != null && mixinNames.length > 0) {\n+            l.addAll(Arrays.asList(nodeInfo.getMixinNames()));\n+        }\n         if (l.contains(NameConstants.MIX_REFERENCEABLE)) {\n             // shortcut\n             return;", "filename": "jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java"}, {"additions": 79, "raw_url": "https://github.com/apache/jackrabbit/raw/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java", "sha": "a8bb3430b7a8dfbf8b4b5055bbd56558a2b0f98b", "changes": 86, "status": "modified", "deletions": 7, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java?ref=75e67c5a35528f59729af55345b8428e7999951a", "patch": "@@ -16,21 +16,26 @@\n  */\n package org.apache.jackrabbit.jcr2spi.xml;\n \n-import org.apache.jackrabbit.test.AbstractJCRTest;\n-import org.apache.jackrabbit.spi.Name;\n import org.apache.jackrabbit.JcrConstants;\n+import org.apache.jackrabbit.spi.Name;\n+import org.apache.jackrabbit.test.AbstractJCRTest;\n+import org.apache.jackrabbit.uuid.UUID;\n import org.xml.sax.ContentHandler;\n import org.xml.sax.SAXException;\n import org.xml.sax.helpers.AttributesImpl;\n \n-import javax.jcr.RepositoryException;\n import javax.jcr.ImportUUIDBehavior;\n-import javax.jcr.PropertyType;\n-import javax.jcr.Session;\n import javax.jcr.Item;\n import javax.jcr.Property;\n-import java.util.List;\n+import javax.jcr.PropertyType;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Session;\n+import javax.jcr.nodetype.ConstraintViolationException;\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n import java.util.Arrays;\n+import java.util.List;\n \n /**\n  * <code>SessionImportTest</code>...\n@@ -108,6 +113,73 @@ public void testImportNameValueWithUnregisteredNamespace() throws RepositoryExce\n         superuser.save();\n     }\n \n+    /**\n+     * Test case for issue <a href=\"https://issues.apache.org/jira/browse/JCR-1857\">JCR-1857</href>\n+     *\n+     * @throws IOException\n+     * @throws RepositoryException\n+     */\n+    public void testEmptyMixins() throws IOException, RepositoryException {\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\" +\n+                \"<sv:node xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\"\\n\" +\n+                \"         xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\"\\n\" +\n+                \"         xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\"\\n\" +\n+                \"         xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\"\\n\" +\n+                \"         sv:name=\\\"testnode1\\\">\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\">\\n\" +\n+                \"        <sv:value>nt:unstructured</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:title\\\" sv:type=\\\"String\\\">\\n\" +\n+                \"        <sv:value>Test Node</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:uuid\\\" sv:type=\\\"String\\\">\\n\" +\n+                \"        <sv:value>1234</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"</sv:node>\";\n+\n+        InputStream in = new ByteArrayInputStream(xml.getBytes());\n+        try {\n+            superuser.importXML(testRootNode.getPath(), in, ImportUUIDBehavior.IMPORT_UUID_COLLISION_THROW);\n+            fail(\"jcr:uuid cannot be created if mix:referenceable is not part of the effective nodetype.\");\n+        } catch (ConstraintViolationException e) {\n+            // ok.\n+        }\n+    }\n+\n+    /**\n+     * Test case for issue <a href=\"https://issues.apache.org/jira/browse/JCR-1857\">JCR-1857</href>\n+     *\n+     * @throws IOException\n+     * @throws RepositoryException\n+     */\n+    public void testEmptyMixins2() throws IOException, RepositoryException {\n+        /*\n+        JSR 170: nt:resource includes mix:referenceable\n+        TODO: tests needs to be adjusted for JSR 283 (-> define test-property)\n+        */\n+        String referenceableNt = \"nt:resource\";\n+        /*\n+        TODO: retrieve valid jcr:uuid value from test-properties.\n+        */\n+        String uuid = UUID.randomUUID().toString();\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\" +\n+                \"<sv:node xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\"\\n\" +\n+                \"         xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\"\\n\" +\n+                \"         xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\"\\n\" +\n+                \"         xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\"\\n\" +\n+                \"         sv:name=\\\"testnode1\\\">\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\">\\n\" +\n+                \"        <sv:value>\" + referenceableNt + \"</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:uuid\\\" sv:type=\\\"String\\\">\\n\" +\n+                \"        <sv:value>\" + uuid + \"</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"</sv:node>\";\n+\n+        InputStream in = new ByteArrayInputStream(xml.getBytes());\n+        superuser.importXML(testRootNode.getPath(), in, ImportUUIDBehavior.IMPORT_UUID_COLLISION_THROW);\n+    }\n+\n     private static String getUnknownURI(Session session, String uriHint) throws RepositoryException {\n         String uri = uriHint;\n         int index = 0;\n@@ -122,7 +194,7 @@ private static String getUnknownURI(Session session, String uriHint) throws Repo\n     /**\n      * Returns a prefix that is unique among the already registered prefixes.\n      *\n-     * @param uriHint namespace uri that serves as hint for the prefix generation\n+     * @param session\n      * @return a unique prefix\n      */\n     public static String getUniquePrefix(Session session) throws RepositoryException {", "filename": "jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df", "parent": "https://github.com/apache/jackrabbit/commit/bc05cc9a6912c94e7af980f3f2aac451446ec9f4", "message": "JCR-1782: fix potential NPE in parsing Destination header, add RFC 4918 compliant parsing, add test cases\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@701129 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_59", "file": [{"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java", "sha": "2c336754166be31b819b043f07d6d1a2d7f8fa86", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df", "patch": "@@ -60,7 +60,7 @@\n      * @return locator of the resource specified with the Destination header.\n      * @see DavConstants#HEADER_DESTINATION\n      */\n-    public DavResourceLocator getDestinationLocator();\n+    public DavResourceLocator getDestinationLocator() throws DavException;\n \n     /**\n      * Returns true if the {@link DavConstants#HEADER_OVERWRITE Overwrite header}", "filename": "jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java"}, {"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java", "sha": "334d76b27b33b48c5cb5c97f70109d14e23c8cc1", "changes": 28, "status": "modified", "deletions": 24, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df", "patch": "@@ -163,32 +163,12 @@ public DavResourceLocator getRequestLocator() {\n      * resource.\n      *\n      * @return path of the destination resource.\n+     * @throws DavException \n      * @see #HEADER_DESTINATION\n      * @see DavServletRequest#getDestinationLocator\n      */\n-    public DavResourceLocator getDestinationLocator() {\n-        String destination = httpRequest.getHeader(HEADER_DESTINATION);\n-        if (destination != null) {\n-            try {\n-                URI uri = new URI(destination);\n-                if (uri.getAuthority().equals(httpRequest.getHeader(\"Host\"))) {\n-                    destination = uri.getRawPath();\n-                }\n-            } catch (URISyntaxException e) {\n-                log.debug(\"Destination is path is not a valid URI (\" + e.getMessage() + \".\");\n-                int pos = destination.lastIndexOf(\":\");\n-                if (pos > 0) {\n-                    destination = destination.substring(destination.indexOf(\"/\", pos));\n-                    log.debug(\"Tried to retrieve resource destination path from invalid URI: \" + destination);\n-                }\n-            }\n-            // cut off the context path\n-            String contextPath = httpRequest.getContextPath();\n-            if (destination.startsWith(contextPath)) {\n-                destination = destination.substring(contextPath.length());\n-            }\n-        }\n-        return factory.createResourceLocator(hrefPrefix, destination);\n+    public DavResourceLocator getDestinationLocator() throws DavException {\n+        return getHrefLocator(httpRequest.getHeader(HEADER_DESTINATION));\n     }\n \n     /**\n@@ -201,7 +181,7 @@ public DavResourceLocator getHrefLocator(String href) throws DavException {\n         String ref = href;\n         if (ref != null) {\n             //href should be a Simple-ref production as defined in RFC4918, so it is either an absolute URI\n-            //or an absoltute path\n+            //or an absolute path\n             try {\n                 URI uri = new URI(ref);\n                 String auth = uri.getAuthority();", "filename": "jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java"}, {"additions": 117, "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java", "sha": "409367508cbeb9eed1dace5107dc5591a1260f9b", "changes": 117, "status": "added", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df", "patch": "@@ -0,0 +1,117 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\r\n+ * contributor license agreements.  See the NOTICE file distributed with\r\n+ * this work for additional information regarding copyright ownership.\r\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\r\n+ * (the \"License\"); you may not use this file except in compliance with\r\n+ * the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *      http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+package org.apache.jackrabbit.webdav.server;\r\n+\r\n+import java.io.IOException;\r\n+import java.net.URI;\r\n+import java.net.URISyntaxException;\r\n+\r\n+import junit.framework.TestCase;\r\n+\r\n+import org.apache.commons.httpclient.HttpClient;\r\n+import org.apache.commons.httpclient.HttpException;\r\n+import org.apache.commons.httpclient.UsernamePasswordCredentials;\r\n+import org.apache.commons.httpclient.auth.AuthScope;\r\n+import org.apache.commons.httpclient.methods.HeadMethod;\r\n+import org.apache.commons.httpclient.methods.PutMethod;\r\n+import org.apache.jackrabbit.webdav.DavException;\r\n+import org.apache.jackrabbit.webdav.client.methods.DeleteMethod;\r\n+import org.apache.jackrabbit.webdav.client.methods.MoveMethod;\r\n+\r\n+/**\r\n+ * Test cases for WebDAV BIND functionality (see <a href=\"http://greenbytes.de/tech/webdav/draft-ietf-webdav-bind-20.html\">draft-ietf-webdav-bind-20</a>\r\n+ * <p>\r\n+ * Required system properties:\r\n+ * <ul>\r\n+ *   <li>webdav.test.url</li>\r\n+ *   <li>webdav.test.username</li>\r\n+ *   <li>webdav.test.password</li>\r\n+ * </ul>\r\n+ */\r\n+\r\n+public class RFC4918DestinationHeaderTest extends TestCase {\r\n+\r\n+    private String root;\r\n+    private URI uri;\r\n+    private String username, password;\r\n+    private HttpClient client;\r\n+    \r\n+    protected void setUp() throws Exception {\r\n+        this.uri = URI.create(System.getProperty(\"webdav.test.url\"));\r\n+        this.root = this.uri.toASCIIString();\r\n+        if (!this.root.endsWith(\"/\")) {\r\n+            this.root += \"/\";\r\n+        }\r\n+        this.username = System.getProperty((\"webdav.test.username\"), \"\");\r\n+        this.password = System.getProperty((\"webdav.test.password\"), \"\");\r\n+        this.client = new HttpClient();\r\n+        this.client.getState().setCredentials(\r\n+                new AuthScope(this.uri.getHost(), this.uri.getPort()),\r\n+                new UsernamePasswordCredentials(this.username, this.password));\r\n+        super.setUp();\r\n+    }\r\n+\r\n+    protected void tearDown() throws Exception {\r\n+        super.tearDown();\r\n+    }\r\n+    \r\n+    public void testMove() throws HttpException, IOException, DavException, URISyntaxException {\r\n+\r\n+        String testuri = this.root + \"movetest\";\r\n+        String destinationuri = testuri + \"2\";\r\n+        String destinationpath = new URI(destinationuri).getRawPath();\r\n+        // make sure the scheme is removed\r\n+        assertTrue(destinationpath.indexOf(\":\") < 0);\r\n+        \r\n+        int status;\r\n+        try {\r\n+            PutMethod put = new PutMethod(testuri);\r\n+            status = this.client.executeMethod(put);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 201 || status == 204);\r\n+\r\n+            // try to move outside the servlet's name space\r\n+            MoveMethod move = new MoveMethod(testuri, \"/foobar\", true);\r\n+            status = this.client.executeMethod(move);\r\n+            assertTrue(\"status: \" + status, status == 403);\r\n+\r\n+            // try a relative path\r\n+            move = new MoveMethod(testuri, \"foobar\", true);\r\n+            status = this.client.executeMethod(move);\r\n+            assertTrue(\"status: \" + status, status == 400);\r\n+\r\n+            move = new MoveMethod(testuri, destinationpath, true);\r\n+            status = this.client.executeMethod(move);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 201 || status == 204);\r\n+            \r\n+            HeadMethod head = new HeadMethod(destinationuri);\r\n+            status = this.client.executeMethod(head);\r\n+            assertTrue(\"status: \" + status, status == 200);\r\n+\r\n+            head = new HeadMethod(testuri);\r\n+            status = this.client.executeMethod(head);\r\n+            assertTrue(\"status: \" + status, status == 404);\r\n+\r\n+        } finally {\r\n+            DeleteMethod delete = new DeleteMethod(testuri);\r\n+            status = this.client.executeMethod(delete);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 204 || status == 404);\r\n+            delete = new DeleteMethod(destinationuri);\r\n+            status = this.client.executeMethod(delete);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 204 || status == 404);\r\n+        }\r\n+    }\r\n+}\r", "filename": "jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java"}, {"additions": 33, "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java", "sha": "0e3bc4cadb38c0770ac0eb53bef06a3483f40576", "changes": 33, "status": "added", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df", "patch": "@@ -0,0 +1,33 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\r\n+ * contributor license agreements.  See the NOTICE file distributed with\r\n+ * this work for additional information regarding copyright ownership.\r\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\r\n+ * (the \"License\"); you may not use this file except in compliance with\r\n+ * the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *      http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+package org.apache.jackrabbit.webdav.server;\r\n+\r\n+import junit.framework.Test;\r\n+import junit.framework.TestCase;\r\n+import junit.framework.TestSuite;\r\n+\r\n+public class WebdavServerTests extends TestCase {\r\n+\r\n+    public static Test suite() {\r\n+        TestSuite suite = new TestSuite(\"WebDAV Server Tests\");\r\n+\r\n+        suite.addTestSuite(BindTest.class);\r\n+        suite.addTestSuite(RFC4918DestinationHeaderTest.class);\r\n+\r\n+        return suite;\r\n+    }\r\n+}\n\\ No newline at end of file", "filename": "jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/3f9e79cdc3cf8683a12779a003d235f1f4ee8a21", "parent": "https://github.com/apache/jackrabbit/commit/7219f128aeb146f9e6cd6779dfd3b28bc3ffa328", "message": "JCR-1454 Prevent NPE on enumerating event listeners if none have been registered yet\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@633796 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_60", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/3f9e79cdc3cf8683a12779a003d235f1f4ee8a21/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/client/ClientObservationManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/3f9e79cdc3cf8683a12779a003d235f1f4ee8a21/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/client/ClientObservationManager.java", "sha": "7222c4342f9e7d8a2db1a7ec8cd7413c3a26fd9b", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/client/ClientObservationManager.java?ref=3f9e79cdc3cf8683a12779a003d235f1f4ee8a21", "patch": "@@ -100,7 +100,10 @@ public void removeEventListener(EventListener listener)\n \n     /** {@inheritDoc} */\n     public EventListenerIterator getRegisteredEventListeners() {\n-        return new ArrayEventListenerIterator(poller.getListeners());\n+        EventListener[] listeners = (poller != null)\n+                ? poller.getListeners()\n+                : new EventListener[0];\n+        return new ArrayEventListenerIterator(listeners);\n     }\n \n     //---------- internal ------------------------------------------------------", "filename": "jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/client/ClientObservationManager.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/f64c5543baead3bad17977b6ef29e4f5bf2c955c", "parent": "https://github.com/apache/jackrabbit/commit/7a058b665b0568b0f903cfeaac47024b3f967a68", "message": "#0000 - avoid NPE upon Restore.persisted in case of a \n        Workspace.restore.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@508431 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_61", "file": [{"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/f64c5543baead3bad17977b6ef29e4f5bf2c955c/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java", "blob_url": "https://github.com/apache/jackrabbit/blob/f64c5543baead3bad17977b6ef29e4f5bf2c955c/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java", "sha": "5e2c62d02d9cc7be0e52a6c0e6045885f94bbbc9", "changes": 13, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java?ref=f64c5543baead3bad17977b6ef29e4f5bf2c955c", "patch": "@@ -68,16 +68,19 @@ public void accept(OperationVisitor visitor) throws PathNotFoundException, ItemE\n      */\n     public void persisted(CacheBehaviour cacheBehaviour) {\n         if (cacheBehaviour == CacheBehaviour.INVALIDATE) {\n+            NodeEntry entry;\n             if (nodeState == null || removeExisting) {\n                 // invalidate the complete tree\n-                NodeEntry root = nodeState.getNodeEntry();\n-                while (root.getParent() != null) {\n-                    root = root.getParent();\n+                // -> start searching root-entry from any version-entry or\n+                //    from the given nodestate\n+                entry = (nodeState == null) ? versionStates[0].getNodeEntry() : nodeState.getNodeEntry();\n+                while (entry.getParent() != null) {\n+                    entry = entry.getParent();\n                 }\n-                root.invalidate(true);\n             } else {\n-                nodeState.getHierarchyEntry().invalidate(true);\n+                entry = nodeState.getNodeEntry();\n             }\n+            entry.invalidate(true);\n         }\n     }\n     //----------------------------------------< Access Operation Parameters >---", "filename": "contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/7ad35718087e1d235f06a6d36a8870517dac6b9a", "parent": "https://github.com/apache/jackrabbit/commit/5bb3f49b42789fd9d5ddcf849f162a8f007bc9ce", "message": "JCR-583: TCK: NodeReadMethodsTest.testGetName fails with NPE if 'testroot' has no child node\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@480975 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_62", "file": [{"additions": 5, "raw_url": "https://github.com/apache/jackrabbit/raw/7ad35718087e1d235f06a6d36a8870517dac6b9a/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/7ad35718087e1d235f06a6d36a8870517dac6b9a/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java", "sha": "e8e15352921671cc43569fa4988d7fdac8d1b3fe", "changes": 10, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java?ref=7ad35718087e1d235f06a6d36a8870517dac6b9a", "patch": "@@ -112,10 +112,10 @@ public void testGetPath()\n     /**\n      * Tests if getName() returns same as last name returned by getPath()\n      */\n-    public void testGetName() throws RepositoryException {\n-        assertEquals(\"getName() of root must be an empty string\",\n-                \"\",\n-                session.getRootNode().getName());\n+    public void testGetName() throws RepositoryException, NotExecutableException {\n+        if (childNode == null) {\n+            throw new NotExecutableException(\"Workspace does not have sufficient content to run this test.\");\n+        }\n \n         // build name from path\n         String path = childNode.getPath();\n@@ -1017,4 +1017,4 @@ private Node locateNodeWithSameNameSiblings(Node node)\n         }\n         return null;\n     }\n-}\n\\ No newline at end of file\n+}", "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/ca0e663482e98fb755f9c2b55d19070cefd94246", "parent": "https://github.com/apache/jackrabbit/commit/fa5dcb3bc3e23246d45d99a59cb83fa14f15e95c", "message": "JCR-346: Jcr-Server: ItemDefinitionImpl.toXml throws NPE for the root\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@385459 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_63", "file": [{"additions": 5, "raw_url": "https://github.com/apache/jackrabbit/raw/ca0e663482e98fb755f9c2b55d19070cefd94246/jcr-server/server/src/java/org/apache/jackrabbit/webdav/jcr/nodetype/ItemDefinitionImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/ca0e663482e98fb755f9c2b55d19070cefd94246/jcr-server/server/src/java/org/apache/jackrabbit/webdav/jcr/nodetype/ItemDefinitionImpl.java", "sha": "29e7a6562ddbe41ac582d49e621f1e442bd1f7f0", "changes": 7, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jcr-server/server/src/java/org/apache/jackrabbit/webdav/jcr/nodetype/ItemDefinitionImpl.java?ref=ca0e663482e98fb755f9c2b55d19070cefd94246", "patch": "@@ -101,8 +101,11 @@ public boolean isProtected() {\n      * @param document\n      */\n     public Element toXml(Document document) {\n-\tElement elem = document.createElement(getElementName());\n-        elem.setAttribute(DECLARINGNODETYPE_ATTRIBUTE, getDeclaringNodeType().getName());\n+        Element elem = document.createElement(getElementName());\n+        NodeType dnt = getDeclaringNodeType();\n+        if (dnt != null) {\n+            elem.setAttribute(DECLARINGNODETYPE_ATTRIBUTE, dnt.getName());\n+        }\n         elem.setAttribute(NAME_ATTRIBUTE, getName());\n         elem.setAttribute(AUTOCREATED_ATTRIBUTE, Boolean.toString(isAutoCreated()));\n         elem.setAttribute(MANDATORY_ATTRIBUTE, Boolean.toString(isMandatory()));", "filename": "jcr-server/server/src/java/org/apache/jackrabbit/webdav/jcr/nodetype/ItemDefinitionImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/f8957a704cd301c5707292108df2b1920568efde", "parent": "https://github.com/apache/jackrabbit/commit/0647faf8d8dc2d52ba182c5436575337f8c28eb8", "message": "Fixed NPE in WorkspaceConfig.init() when SearchConfig is not available. (JCR-71)\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@157916 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_64", "file": [{"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/f8957a704cd301c5707292108df2b1920568efde/src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java", "blob_url": "https://github.com/apache/jackrabbit/blob/f8957a704cd301c5707292108df2b1920568efde/src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java", "sha": "e216a1d1fd2143f72a65810ea80f09961a116cbb", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java?ref=f8957a704cd301c5707292108df2b1920568efde", "patch": "@@ -50,7 +50,7 @@\n     private PersistenceManagerConfig pmc;\n \n     /**\n-     * Workspace search index configuration.\n+     * Workspace search index configuration. Can be <code>null</code>.\n      */\n     private SearchConfig sc;\n \n@@ -79,7 +79,9 @@\n      */\n     public void init() throws ConfigurationException {\n         fsc.init();\n-        sc.init();\n+        if (sc != null) {\n+            sc.init();\n+        }\n     }\n \n     /**", "filename": "src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15", "parent": "https://github.com/apache/jackrabbit/commit/e3651d9a88b13b48cfb84f5830d985d3cac4dae0", "message": "JCR-3265 guard against possible npe's due to double checking: if the bundle is no longer there we don't need to continue to check it\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1350207 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_65", "file": [{"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java", "sha": "2afaffbb56e62ab5c3829df006b941569b903330", "changes": 8, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java?ref=a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15", "patch": "@@ -309,6 +309,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                             log.error(message);\n                             missingChildren.add(entry);\n                         }\n+                    } else {\n+                        return;\n                     }\n                 } else {\n                     NodeId cp = childBundle.getParentId();\n@@ -333,6 +335,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                                     log.error(message);\n                                 }\n                             }\n+                        } else {\n+                            return;\n                         }\n                     }\n                 }\n@@ -376,6 +380,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                                 modifications.add(bundle);\n                             }\n                         }\n+                    } else {\n+                        return;\n                     }\n                 } else {\n                     boolean found = false;\n@@ -410,6 +416,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                                         + \"'\");\n                                 modifications.add(parentBundle);\n                             }\n+                        } else {\n+                            return;\n                         }\n                     }\n ", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/40b90eedff58a58c93427e25507bdc008c85c915", "parent": "https://github.com/apache/jackrabbit/commit/54e23acfe15eb2c9604b31b06010fd0a189825c2", "message": "JCR-3063: NullPointerException in ItemManager\n\nRestore the JCR-2171 fix to avoid deadlocks.\n\nIntroduce extra synchronization and checks to prevent\nthe CMEs and replace the NPEs with InvalidItemStateExceptions.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1176465 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_66", "file": [{"additions": 13, "raw_url": "https://github.com/apache/jackrabbit/raw/40b90eedff58a58c93427e25507bdc008c85c915/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/40b90eedff58a58c93427e25507bdc008c85c915/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemManager.java", "sha": "03055f8af8eaa7a788ac3e27526315a306b8358f", "changes": 14, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemManager.java?ref=40b90eedff58a58c93427e25507bdc008c85c915", "patch": "@@ -159,7 +159,13 @@ NodeDefinitionImpl getDefinition(NodeState state)\n         if (parentId == null) {\n             // removed state has parentId set to null\n             // get from overlayed state\n-            parentId = state.getOverlayedState().getParentId();\n+            ItemState overlaid = state.getOverlayedState();\n+            if (overlaid != null) {\n+                parentId = overlaid.getParentId();\n+            } else {\n+                throw new InvalidItemStateException(\n+                        \"Could not find parent of node \" + state.getNodeId());\n+            }\n         }\n         NodeState parentState = null;\n         try {\n@@ -197,6 +203,12 @@ NodeDefinitionImpl getDefinition(NodeState state)\n \n         // get child node entry\n         ChildNodeEntry cne = parentState.getChildNodeEntry(state.getNodeId());\n+        if (cne == null) {\n+            throw new InvalidItemStateException(\n+                    \"Could not find child \" + state.getNodeId()\n+                    + \" of node \" + parentState.getNodeId());\n+        }\n+\n         NodeTypeRegistry ntReg = sessionContext.getNodeTypeRegistry();\n         try {\n             EffectiveNodeType ent = ntReg.getEffectiveNodeType(", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemManager.java"}, {"additions": 8, "raw_url": "https://github.com/apache/jackrabbit/raw/40b90eedff58a58c93427e25507bdc008c85c915/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/40b90eedff58a58c93427e25507bdc008c85c915/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java", "sha": "ffbad9decd9dbc0bc31d91e611dd1e06dadbab06", "changes": 15, "status": "modified", "deletions": 7, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java?ref=40b90eedff58a58c93427e25507bdc008c85c915", "patch": "@@ -65,13 +65,13 @@\n      * map of those states that have been removed transiently\n      */\n     private final Map<ItemId, ItemState> atticStore =\n-        new HashMap<ItemId, ItemState>();\n+            Collections.synchronizedMap(new HashMap<ItemId, ItemState>());\n \n     /**\n      * map of new or modified transient states\n      */\n     private final Map<ItemId, ItemState> transientStore =\n-        new HashMap<ItemId, ItemState>();\n+            Collections.synchronizedMap(new HashMap<ItemId, ItemState>());\n \n     /**\n      * ItemStateManager view of the states in the attic; lazily instantiated\n@@ -415,7 +415,8 @@ public boolean hasAnyTransientItemStates() {\n             // Group the descendants by reverse relative depth\n             SortedMap<Integer, Collection<ItemState>> statesByReverseDepth =\n                 new TreeMap<Integer, Collection<ItemState>>();\n-            for (ItemState state : store.values()) {\n+            ItemState[] states = store.values().toArray(new ItemState[0]);\n+            for (ItemState state : states) {\n                 // determine relative depth: > 0 means it's a descendant\n                 int depth = hierarchyManager.getShareRelativeDepth(\n                         (NodeId) id, state.getId());\n@@ -732,11 +733,12 @@ public void disposeTransientItemStateInAttic(ItemState state) {\n     public void disposeAllTransientItemStates() {\n         // dispose item states in transient map & attic\n         // (use temp collection to avoid ConcurrentModificationException)\n-        Collection<ItemState> tmp = new ArrayList<ItemState>(transientStore.values());\n+        ItemState[] tmp;\n+        tmp = transientStore.values().toArray(new ItemState[0]);\n         for (ItemState state : tmp) {\n             disposeTransientItemState(state);\n         }\n-        tmp = new ArrayList<ItemState>(atticStore.values());\n+        tmp = atticStore.values().toArray(new ItemState[0]);\n         for (ItemState state : tmp) {\n             disposeTransientItemStateInAttic(state);\n         }\n@@ -841,9 +843,8 @@ public void stateDestroyed(ItemState destroyed) {\n                 visibleState = transientState;\n             } else {\n                 // check attic\n-                transientState = atticStore.get(destroyed.getId());\n+                transientState = atticStore.remove(destroyed.getId());\n                 if (transientState != null) {\n-                    atticStore.remove(destroyed.getId());\n                     transientState.onDisposed();\n                 }\n             }", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SessionItemStateManager.java"}, {"additions": 4, "raw_url": "https://github.com/apache/jackrabbit/raw/40b90eedff58a58c93427e25507bdc008c85c915/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java", "blob_url": "https://github.com/apache/jackrabbit/blob/40b90eedff58a58c93427e25507bdc008c85c915/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java", "sha": "58f12b45791eb88269bbe88d8d64528abf5a9cd0", "changes": 7, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java?ref=40b90eedff58a58c93427e25507bdc008c85c915", "patch": "@@ -771,13 +771,14 @@ public void end() throws ItemStateException {\n \n             ISMLocking.ReadLock readLock = null;\n             try {\n-                // Let the shared item listeners know about the change\n-                shared.persisted();\n-\n                 // downgrade to read lock\n                 readLock = writeLock.downgrade();\n                 writeLock = null;\n \n+                // Let the shared item listeners know about the change\n+                // JCR-2171: This must happen after downgrading the lock!\n+                shared.persisted();\n+\n                 /* notify virtual providers about node references */\n                 for (int i = 0; i < virtualNodeReferences.length; i++) {\n                     ChangeLog virtualRefs = virtualNodeReferences[i];", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/85a4a70e209e493b64bdd2e78401974098196816", "parent": "https://github.com/apache/jackrabbit/commit/95f1c16c4bc864777702e1bcd86eb22883117bca", "message": "JCR-1440: NPE Thrown when two Cluster Nodes are hitting the same underlying database\n\nAutomatically update internal version history caches when receiving updates from other cluster nodes.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@919461 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_67", "file": [{"additions": 10, "raw_url": "https://github.com/apache/jackrabbit/raw/85a4a70e209e493b64bdd2e78401974098196816/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/85a4a70e209e493b64bdd2e78401974098196816/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerImpl.java", "sha": "152f67d3b9d2c5c0a2b941a4b5c0cb211967be2b", "changes": 10, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerImpl.java?ref=85a4a70e209e493b64bdd2e78401974098196816", "patch": "@@ -16,6 +16,7 @@\n  */\n package org.apache.jackrabbit.core.version;\n \n+import java.util.ArrayList;\n import java.util.Calendar;\n import java.util.Collection;\n import java.util.List;\n@@ -692,6 +693,15 @@ public void externalUpdate(ChangeLog changes, List<EventState> events,\n         esc.setUserData(userData);\n \n         sharedStateMgr.externalUpdate(changes, esc);\n+\n+        Collection<InternalVersionItem> items =\n+            new ArrayList<InternalVersionItem>();\n+        for (Map.Entry<ItemId, InternalVersionItem> entry : versionItems.entrySet()) {\n+            if (changes.has(entry.getKey())) {\n+                items.add(entry.getValue());\n+            }\n+        }\n+        itemsUpdated(items);\n     }\n \n     //--------------------------------------------------------< inner classes >", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerImpl.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/2c14f02f8911056a27b8d0505d261c78d57482e0", "parent": "https://github.com/apache/jackrabbit/commit/2fb09c86c8620740e187d385b984a2b3ca5ea77a", "message": "JCR-2298: NPE in EventStateCollection\n\nLog an error and skip the REMOVE event when the old parent of a moved node is no longer available. This is not ideal, but definitely better than the current behaviour of throwing a NullPointerException.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@890401 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_68", "file": [{"additions": 21, "raw_url": "https://github.com/apache/jackrabbit/raw/2c14f02f8911056a27b8d0505d261c78d57482e0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/EventStateCollection.java", "blob_url": "https://github.com/apache/jackrabbit/blob/2c14f02f8911056a27b8d0505d261c78d57482e0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/EventStateCollection.java", "sha": "bb69561325cdb9f1970bd11fa7db285fbf3964a5", "changes": 32, "status": "modified", "deletions": 11, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/EventStateCollection.java?ref=2c14f02f8911056a27b8d0505d261c78d57482e0", "patch": "@@ -193,6 +193,7 @@ public void createEventStates(NodeId rootNodeId, ChangeLog changes, ItemStateMan\n                     NodeId newParentId = n.getParentId();\n                     if (newParentId != null && !oldParentId.equals(newParentId) &&\n                             !n.isShareable()) {\n+                        Path oldPath = getZombiePath(n.getNodeId(), hmgr);\n \n                         // node moved\n                         // generate node removed & node added event\n@@ -204,20 +205,29 @@ public void createEventStates(NodeId rootNodeId, ChangeLog changes, ItemStateMan\n                             // shared item state manager\n                             oldParent = (NodeState) stateMgr.getItemState(oldParentId);\n                         }\n-\n-                        NodeTypeImpl oldParentNodeType = getNodeType(oldParent, session);\n-                        Set<Name> mixins = oldParent.getMixinTypeNames();\n-                        Path newPath = getPath(n.getNodeId(), hmgr);\n-                        Path oldPath = getZombiePath(n.getNodeId(), hmgr);\n-                        events.add(EventState.childNodeRemoved(oldParentId,\n-                                getParent(oldPath), n.getNodeId(),\n-                                oldPath.getNameElement(),\n-                                oldParentNodeType.getQName(),\n-                                mixins, session));\n+                        if (oldParent != null) {\n+                            NodeTypeImpl oldParentNodeType = getNodeType(oldParent, session);\n+                            events.add(EventState.childNodeRemoved(oldParentId,\n+                                    getParent(oldPath), n.getNodeId(),\n+                                    oldPath.getNameElement(),\n+                                    oldParentNodeType.getQName(),\n+                                    oldParent.getMixinTypeNames(), session));\n+                        } else {\n+                            // JCR-2298: In some cases the old parent node\n+                            // state is no longer available anywhere. Log an\n+                            // error since in this case we can't generate the\n+                            // correct REMOVE event.\n+                            log.error(\n+                                    \"The old parent (node id \" + oldParentId\n+                                    + \") of a moved node (old path \"\n+                                    + oldPath + \") is no longer available.\"\n+                                    + \" No REMOVE event generated!\");\n+                        }\n \n                         NodeState newParent = (NodeState) changes.get(newParentId);\n                         NodeTypeImpl newParentNodeType = getNodeType(newParent, session);\n-                        mixins = newParent.getMixinTypeNames();\n+                        Set<Name> mixins = newParent.getMixinTypeNames();\n+                        Path newPath = getPath(n.getNodeId(), hmgr);\n                         events.add(EventState.childNodeAdded(newParentId,\n                                 getParent(newPath), n.getNodeId(),\n                                 newPath.getNameElement(),", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/observation/EventStateCollection.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/d5341dad66e0f20e9ddee078b9585bc1aa157a7c", "parent": "https://github.com/apache/jackrabbit/commit/b161b6b322dd41c7694236e381dda35ef1234937", "message": "JCR-2223 MSSqlFileSystem - JNDI & several configuration issues\n\nApplied patch:\n* Use null values for user and password such that JNDI configuration does not require a username/password in the repository descriptor.\n* Set tableSpace default to the empty string to prevent NPE.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@800715 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_69", "file": [{"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/d5341dad66e0f20e9ddee078b9585bc1aa157a7c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/DB2FileSystem.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d5341dad66e0f20e9ddee078b9585bc1aa157a7c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/DB2FileSystem.java", "sha": "5b0742356da3ee30d81b919be0effd1ed15fc42f", "changes": 4, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/DB2FileSystem.java?ref=d5341dad66e0f20e9ddee078b9585bc1aa157a7c", "patch": "@@ -52,10 +52,6 @@ public DB2FileSystem() {\n         // preset some attributes to reasonable defaults\n         schema = \"db2\";\n         driver = \"com.ibm.db2.jcc.DB2Driver\";\n-        schemaObjectPrefix = \"\";\n-        user = \"\";\n-        password = \"\";\n-        initialized = false;\n     }\n \n     //-----------------------------------------< DatabaseFileSystem overrides >", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/DB2FileSystem.java"}, {"additions": 1, "raw_url": "https://github.com/apache/jackrabbit/raw/d5341dad66e0f20e9ddee078b9585bc1aa157a7c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/MSSqlFileSystem.java", "blob_url": "https://github.com/apache/jackrabbit/blob/d5341dad66e0f20e9ddee078b9585bc1aa157a7c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/MSSqlFileSystem.java", "sha": "e6a79a395e6f47435a8601272592869536ab88da", "changes": 7, "status": "modified", "deletions": 6, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/MSSqlFileSystem.java?ref=d5341dad66e0f20e9ddee078b9585bc1aa157a7c", "patch": "@@ -55,7 +55,7 @@\n     public static final String TABLE_SPACE_VARIABLE = \"${tableSpace}\";\n \n     /** the MS SQL table space to use */\n-    protected String tableSpace;\n+    protected String tableSpace = \"\";\n \n     /**\n      * Returns the configured MS SQL table space.\n@@ -84,11 +84,6 @@ public MSSqlFileSystem() {\n         // preset some attributes to reasonable defaults\n         schema = \"mssql\";\n         driver = \"com.microsoft.sqlserver.jdbc.SQLServerDriver\";\n-        schemaObjectPrefix = \"\";\n-        user = \"\";\n-        password = \"\";\n-        tableSpace = null;\n-        initialized = false;\n     }\n \n    protected String createSchemaSql(String sql) {", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/fs/db/MSSqlFileSystem.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/5234d5accc5cf52e594682593d40168afaa1aaee", "parent": "https://github.com/apache/jackrabbit/commit/a5e73c05166943ad412973bbd1c4fae9f073ea98", "message": "JCR-1343: Replace use of Xerces by JAXP to implement SAX DocumentHandler\r\n    - Improved test case, previous one was throwing an NPE\r\n      because of the null attributes argument to startElement()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@615950 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_70", "file": [{"additions": 11, "raw_url": "https://github.com/apache/jackrabbit/raw/5234d5accc5cf52e594682593d40168afaa1aaee/jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java", "blob_url": "https://github.com/apache/jackrabbit/blob/5234d5accc5cf52e594682593d40168afaa1aaee/jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java", "sha": "f74e41ad51f293ae109710cb7c36a8dd6c269eec", "changes": 22, "status": "modified", "deletions": 11, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java?ref=5234d5accc5cf52e594682593d40168afaa1aaee", "patch": "@@ -18,32 +18,32 @@\n  */\n package org.apache.jackrabbit.rmi.xml;\n \n-import java.io.UnsupportedEncodingException;\n-\n import javax.jcr.RepositoryException;\n \n import junit.framework.TestCase;\n \n import org.apache.jackrabbit.rmi.xml.ImportContentHandler;\n-import org.xml.sax.SAXException;\n+import org.xml.sax.helpers.AttributesImpl;\n \n public class ImportContentHandlerTest extends TestCase {\n \n-    public void testImportContentHandler() throws RepositoryException, SAXException {\n+    public void testImportContentHandler() throws Exception {\n         // fail test if handler cannot be set up\n         DummyImportContentHandler ch = new DummyImportContentHandler();\n \n         // these may throw SAXException\n         ch.startDocument();\n-        ch.startElement(null, \"sample\", \"sample\", null);\n-        ch.endElement(null, \"sample\", \"sample\");\n+        ch.startPrefixMapping(\"foo\", \"http://example.com/ns/foo\");\n+        ch.startElement(\n+                \"http://example.com/ns/foo\", \"sample\", \"foo:sample\",\n+                new AttributesImpl());\n+        ch.endElement(\"http://example.com/ns/foo\", \"sample\", \"foo:sample\");\n+        ch.endPrefixMapping(\"foo\");\n         ch.endDocument();\n \n-        byte[] xml = ch.getXML();\n-        assertNotNull(\"Serialized XML is null\", xml);\n-        assertTrue(\"Serialized XML is empty\", xml.length > 0);\n-\n-        // for the moment we don't actually care for the concrete contents\n+        String xml = new String(ch.getXML(), \"UTF-8\");\n+        assertTrue(xml.contains(\n+                \"<foo:sample xmlns:foo=\\\"http://example.com/ns/foo\\\"/>\"));\n     }\n \n     private static class DummyImportContentHandler extends ImportContentHandler {", "filename": "jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/236ea1d08f890522facdad2e293ee453ead5d103", "parent": "https://github.com/apache/jackrabbit/commit/e29fe370a450ff6e2332a25f8d8c5680eb6f1a99", "message": "JCR-781: Reverted revision 526707 as I'm not confident enough that the default behaviour avoids NPEs in all environments. Let's try an alternative solution...\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@529906 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_71", "file": [{"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/236ea1d08f890522facdad2e293ee453ead5d103/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/RemoteAdapterFactory.java", "blob_url": "https://github.com/apache/jackrabbit/blob/236ea1d08f890522facdad2e293ee453ead5d103/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/RemoteAdapterFactory.java", "sha": "6e4a0a5572639ad76e3445b73ddae3b9c299da93", "changes": 24, "status": "modified", "deletions": 24, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/RemoteAdapterFactory.java?ref=236ea1d08f890522facdad2e293ee453ead5d103", "patch": "@@ -90,30 +90,6 @@\n  */\n public interface RemoteAdapterFactory {\n \n-    /**\n-     * Returns the RMI port to use.\n-     *\n-     * @return RMI port number\n-     * @since 1.3\n-     */\n-    int getPort();\n-\n-    /**\n-     * Returns the RMI client socket factory to use.\n-     *\n-     * @return RMI client socket factory\n-     * @since 1.3\n-     */\n-    RMIClientSocketFactory getClientSocketFactory(); \n-\n-    /**\n-     * Returns the RMI server socket factory to use.\n-     *\n-     * @return RMI server socket factory\n-     * @since 1.3\n-     */\n-    RMIServerSocketFactory getServerSocketFactory();\n-\n     /**\n      * Returns a remote adapter for the given local repository.\n      *", "filename": "jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/RemoteAdapterFactory.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/236ea1d08f890522facdad2e293ee453ead5d103/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerAdapterFactory.java", "blob_url": "https://github.com/apache/jackrabbit/blob/236ea1d08f890522facdad2e293ee453ead5d103/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerAdapterFactory.java", "sha": "8f56b970ba4e4c90c2e866f2fb1e8189c3726fbb", "changes": 68, "status": "modified", "deletions": 68, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerAdapterFactory.java?ref=236ea1d08f890522facdad2e293ee453ead5d103", "patch": "@@ -103,12 +103,6 @@\n     /** The buffer size of iterators created by this factory. */\n     private int bufferSize = DEFAULT_BUFFER_SIZE;\n \n-    private int port = 0;\n-\n-    private RMIClientSocketFactory clientSocketFactory = null;\n-\n-    private RMIServerSocketFactory serverSocketFactory = null;\n-\n     /**\n      * Returns the iterator buffer size.\n      *\n@@ -127,68 +121,6 @@ public void setBufferSize(int bufferSize) {\n         this.bufferSize = bufferSize;\n     }\n \n-    /**\n-     * Returns the RMI port to use.\n-     *\n-     * @return RMI port number\n-     * @since 1.3\n-     */\n-    public int getPort() {\n-        return port;\n-    }\n-\n-    /**\n-     * Sets the RMI port to use.\n-     *\n-     * @param port RMI port number\n-     * @since 1.3\n-     */\n-    public void setPort(int port) {\n-        this.port = port;\n-    }\n-\n-    /**\n-     * Returns the RMI client socket factory to use.\n-     *\n-     * @return RMI client socket factory\n-     * @since 1.3\n-     */\n-    public RMIClientSocketFactory getClientSocketFactory() {\n-        return clientSocketFactory;\n-    }\n-\n-    /**\n-     * Sets the RMI client socket factory to use.\n-     *\n-     * @param factory RMI client socket factory,\n-     *                or <code>null</code> to use the default\n-     * @since 1.3\n-     */\n-    public void setClientSocketFactory(RMIClientSocketFactory factory) {\n-        clientSocketFactory = factory;\n-    }\n-\n-    /**\n-     * Returns the RMI server socket factory to use.\n-     *\n-     * @return RMI server socket factory\n-     * @since 1.3\n-     */\n-    public RMIServerSocketFactory getServerSocketFactory() {\n-        return serverSocketFactory;\n-    }\n-\n-    /**\n-     * Sets the RMI server socket factory to use.\n-     *\n-     * @param factory RMI server socket factory,\n-     *                or <code>null</code> to use the default\n-     * @since 1.3\n-     */\n-    public void setServerSocketFactory(RMIServerSocketFactory factory) {\n-        serverSocketFactory = factory;\n-    }\n-\n     /**\n      * Creates a {@link ServerRepository ServerRepository} instance.\n      * {@inheritDoc}", "filename": "jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerAdapterFactory.java"}, {"additions": 0, "raw_url": "https://github.com/apache/jackrabbit/raw/236ea1d08f890522facdad2e293ee453ead5d103/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerObject.java", "blob_url": "https://github.com/apache/jackrabbit/blob/236ea1d08f890522facdad2e293ee453ead5d103/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerObject.java", "sha": "2ca9eab7030902a8b96f8a6fa9b476061bc4a5a0", "changes": 3, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerObject.java?ref=236ea1d08f890522facdad2e293ee453ead5d103", "patch": "@@ -68,9 +68,6 @@\n      */\n     protected ServerObject(RemoteAdapterFactory factory)\n             throws RemoteException {\n-        super(factory.getPort(),\n-                factory.getClientSocketFactory(),\n-                factory.getServerSocketFactory());\n         this.factory = factory;\n     }\n ", "filename": "jackrabbit-jcr-rmi/src/main/java/org/apache/jackrabbit/rmi/server/ServerObject.java"}], "repo": "jackrabbit"}, {"commit": "https://github.com/apache/jackrabbit/commit/9b9beb7f3a6970f234a637d127f820055b828053", "parent": "https://github.com/apache/jackrabbit/commit/c41e81997a91f21839c63ba4a8faf8d068054dfb", "message": "JCR-1440: NPE Thrown when two Cluster Nodes are hitting the same underlying database\n\nPatch by Ryan Brush\n\nThis needs more work (the solution reminds me of the double checked-locking antipattern), but at least it solves the most pressing issue and does not seem to cause any notable risk to other use cases.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@911856 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "jackrabbit_72", "file": [{"additions": 26, "raw_url": "https://github.com/apache/jackrabbit/raw/9b9beb7f3a6970f234a637d127f820055b828053/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java", "blob_url": "https://github.com/apache/jackrabbit/blob/9b9beb7f3a6970f234a637d127f820055b828053/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java", "sha": "3e9f5a266cbd589af12e30ff3054a1403752a13d", "changes": 26, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java?ref=9b9beb7f3a6970f234a637d127f820055b828053", "patch": "@@ -290,6 +290,32 @@ public boolean hasVersion(Name versionName) {\n      * {@inheritDoc}\n      */\n     public InternalVersion getVersion(NodeId id) {\n+        InternalVersion v = getCachedVersion(id);\n+\n+        // If the version was not found, our cache may not have been\n+        // synchronized with updates from another cluster node.  Reload the history\n+        // to be sure we have the latest updates and try again.\n+        if (v == null) {\n+            try {\n+                reload();\n+            } catch (RepositoryException e) {\n+\n+                // We should add the checked exception to this method definition\n+                // so we don't need to wrap it.\n+                // Avoiding it for now to limit impact of this fix.\n+                throw new RuntimeException(e);\n+            }\n+            v = getCachedVersion(id);\n+        }\n+\n+        return v;\n+    }\n+\n+    /**\n+     * Returns the version from cache, or <code>null</code> if it is not\n+     * present.\n+     */\n+    private InternalVersion getCachedVersion(NodeId id) {\n         InternalVersion v = versionCache.get(id);\n         if (v == null) {\n             for (Name versionName : nameCache.keySet()) {", "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java"}], "repo": "jackrabbit"}]
