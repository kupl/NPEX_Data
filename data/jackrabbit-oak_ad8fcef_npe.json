[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
        "bug_id": "jackrabbit-oak_ad8fcef",
        "message": "OAK-2256: MemoryNodeBuilder NPE on base() following root refresh\nAvoid concurrent access to NodeBuilder.base()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1637413 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/5d0ad3c91e7f2440e8eddf3edbd74604822dc47b",
        "patched_files": [
            "FilterBuilder.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 3,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java?ref=ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java",
                "deletions": 1,
                "sha": "a440f662f8d5a0f39d8ab611df9136e326b5eb5f",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java",
                "patch": "@@ -40,6 +40,7 @@\n import com.google.common.base.Predicate;\n import com.google.common.collect.ImmutableList;\n import org.apache.jackrabbit.oak.api.PropertyState;\n+import org.apache.jackrabbit.oak.core.ImmutableRoot;\n import org.apache.jackrabbit.oak.plugins.nodetype.TypePredicate;\n import org.apache.jackrabbit.oak.plugins.observation.filter.UniversalFilter.Selector;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n@@ -427,7 +428,8 @@ public ACCondition(PermissionProviderFactory permissionProviderFactory) {\n \n         @Override\n         public EventFilter createFilter(NodeState before, NodeState after) {\n-            return new ACFilter(before, after, permissionProviderFactory.create());\n+            return new ACFilter(before, after,\n+                    permissionProviderFactory.create(new ImmutableRoot(after)));\n         }\n     }\n ",
                "changes": 4
            },
            {
                "status": "modified",
                "additions": 2,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java?ref=ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java",
                "deletions": 1,
                "sha": "90fff96afeea2c96e0ea6b94b8e7235f85fb8279",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java",
                "patch": "@@ -21,6 +21,7 @@\n \n import javax.annotation.Nonnull;\n \n+import org.apache.jackrabbit.oak.api.Root;\n import org.apache.jackrabbit.oak.spi.security.authorization.permission.PermissionProvider;\n \n /**\n@@ -33,5 +34,5 @@\n      * @return\n      */\n     @Nonnull\n-    PermissionProvider create();\n+    PermissionProvider create(Root root);\n }",
                "changes": 3
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java?ref=ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java",
                "deletions": 8,
                "sha": "edcd4921c4d398b14aa957eb89aa8ceca5734624",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java",
                "patch": "@@ -50,7 +50,6 @@\n import org.apache.jackrabbit.oak.api.Root;\n import org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate;\n import org.apache.jackrabbit.oak.jcr.session.SessionContext;\n-import org.apache.jackrabbit.oak.jcr.session.operation.SessionOperation;\n import org.apache.jackrabbit.oak.namepath.NamePathMapper;\n import org.apache.jackrabbit.oak.plugins.nodetype.ReadOnlyNodeTypeManager;\n import org.apache.jackrabbit.oak.plugins.observation.CommitRateLimiter;\n@@ -119,13 +118,7 @@ public ObservationManagerImpl(\n             Set<Principal> principals = sessionDelegate.getAuthInfo().getPrincipals();\n             @Nonnull\n             @Override\n-            public PermissionProvider create() {\n-                Root root = sessionDelegate.safePerform(new SessionOperation<Root>(\"refresh-root\") {\n-                    @Override\n-                    public Root perform() {\n-                        return sessionDelegate.getRoot();\n-                    }\n-                });\n+            public PermissionProvider create(Root root) {\n                 return authorizationConfig.getPermissionProvider(root,\n                         sessionDelegate.getWorkspaceName(), principals);\n             }",
                "changes": 9
            }
        ],
        "unit_tests": [
            "FilterBuilderTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilderTest.java",
        "buggy_files": [
            "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java"
        ],
        "fixed": true
    }
]