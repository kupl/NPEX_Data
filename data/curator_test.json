{
    "curator_3ee1fdb": {
        "bug_id": "curator_3ee1fdb",
        "commit": "https://github.com/apache/curator/commit/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFailedDeleteManager.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFailedDeleteManager.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 4,
                "filename": "curator-framework/src/test/java/org/apache/curator/framework/imps/TestFailedDeleteManager.java",
                "patch": "@@ -77,7 +77,7 @@ else if ( newState == ConnectionState.RECONNECTED )\n                 client.delete().guaranteed().forPath(\"/test-me\");\n                 Assert.fail();\n             }\n-            catch ( KeeperException.ConnectionLossException e )\n+            catch ( KeeperException.ConnectionLossException | KeeperException.SessionExpiredException e )\n             {\n                 // expected\n             }\n@@ -203,7 +203,7 @@ else if ( newState == ConnectionState.RECONNECTED )\n                 namespaceClient.delete().guaranteed().forPath(\"/test-me\");\n                 Assert.fail();\n             }\n-            catch ( KeeperException.ConnectionLossException e )\n+            catch ( KeeperException.ConnectionLossException | KeeperException.SessionExpiredException e )\n             {\n                 // expected\n             }\n@@ -245,7 +245,7 @@ public void     testBasic() throws Exception\n                 client.delete().forPath(PATH);\n                 Assert.fail();\n             }\n-            catch ( KeeperException.ConnectionLossException e )\n+            catch ( KeeperException.ConnectionLossException | KeeperException.SessionExpiredException e )\n             {\n                 // expected\n             }\n@@ -259,7 +259,7 @@ public void     testBasic() throws Exception\n                 client.delete().guaranteed().forPath(PATH);\n                 Assert.fail();\n             }\n-            catch ( KeeperException.ConnectionLossException e )\n+            catch ( KeeperException.ConnectionLossException | KeeperException.SessionExpiredException e )\n             {\n                 // expected\n             }",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFailedDeleteManager.java",
                "sha": "50692d2f79e1656808894ba52053916a8e7f9240",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFramework.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFramework.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 1,
                "filename": "curator-framework/src/test/java/org/apache/curator/framework/imps/TestFramework.java",
                "patch": "@@ -261,7 +261,7 @@ public void process(WatchedEvent event)\n             client.getChildren().usingWatcher(watcher).forPath(\"/base\");\n             client.create().forPath(\"/base/child\");\n \n-            String path = queue.take();\n+            String path = new Timing().takeFromQueue(queue);\n             Assert.assertEquals(path, \"/base\");\n         }\n         finally",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFramework.java",
                "sha": "5d0c5ed8f2c5ae496a9ee58166c91139a1004f9a",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFrameworkEdges.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFrameworkEdges.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 8,
                "filename": "curator-framework/src/test/java/org/apache/curator/framework/imps/TestFrameworkEdges.java",
                "patch": "@@ -185,10 +185,8 @@ public void processResult(CuratorFramework client, CuratorEvent event) throws Ex\n             }\n             firstCreateBuilder.withMode(mode).inBackground(callback).forPath(TEST_PATH);\n \n-            String name1 = paths.poll(timing.forWaiting().milliseconds(), TimeUnit.MILLISECONDS);\n-            String path1 = paths.poll(timing.forWaiting().milliseconds(), TimeUnit.MILLISECONDS);\n-            Assert.assertNotNull(name1);\n-            Assert.assertNotNull(path1);\n+            String name1 = timing.takeFromQueue(paths);\n+            String path1 = timing.takeFromQueue(paths);\n \n             client.close();\n \n@@ -206,10 +204,8 @@ public void processResult(CuratorFramework client, CuratorEvent event) throws Ex\n             createBuilder.debugForceFindProtectedNode = true;\n             createBuilder.withMode(mode).inBackground(callback).forPath(TEST_PATH);\n \n-            String name2 = paths.poll(timing.forWaiting().milliseconds(), TimeUnit.MILLISECONDS);\n-            String path2 = paths.poll(timing.forWaiting().milliseconds(), TimeUnit.MILLISECONDS);\n-            Assert.assertNotNull(name2);\n-            Assert.assertNotNull(path2);\n+            String name2 = timing.takeFromQueue(paths);\n+            String path2 = timing.takeFromQueue(paths);\n \n             Assert.assertEquals(ZKPaths.getPathAndNode(name1).getPath(), ZKPaths.getPathAndNode(TEST_PATH).getPath());\n             Assert.assertEquals(ZKPaths.getPathAndNode(name2).getPath(), ZKPaths.getPathAndNode(TEST_PATH).getPath());",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestFrameworkEdges.java",
                "sha": "887f236cee32cbbbac90c20148fb892060a7077a",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestNamespaceFacade.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/test/java/org/apache/curator/framework/imps/TestNamespaceFacade.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 3,
                "filename": "curator-framework/src/test/java/org/apache/curator/framework/imps/TestNamespaceFacade.java",
                "patch": "@@ -40,7 +40,7 @@ public void     testInvalid() throws Exception\n     {\n         try\n         {\n-            CuratorFrameworkFactory.builder().namespace(\"/snafu\").retryPolicy(new RetryOneTime(1)).connectString(\"\").build();\n+            CuratorFrameworkFactory.builder().namespace(\"/snafu\").retryPolicy(new RetryOneTime(1)).connectString(\"foo\").build();\n             Assert.fail();\n         }\n         catch ( IllegalArgumentException e )\n@@ -53,7 +53,7 @@ public void     testInvalid() throws Exception\n     public void     testGetNamespace() throws Exception\n     {\n         CuratorFramework    client = CuratorFrameworkFactory.newClient(server.getConnectString(), new RetryOneTime(1));\n-        CuratorFramework    client2 = CuratorFrameworkFactory.builder().namespace(\"snafu\").retryPolicy(new RetryOneTime(1)).connectString(\"\").build();\n+        CuratorFramework    client2 = CuratorFrameworkFactory.builder().namespace(\"snafu\").retryPolicy(new RetryOneTime(1)).connectString(\"foo\").build();\n         try\n         {\n             client.start();\n@@ -232,7 +232,7 @@ public void testACL() throws Exception\n \n     @Test\n     public void testUnfixForEmptyNamespace() {\n-        CuratorFramework client = CuratorFrameworkFactory.builder().namespace(\"\").retryPolicy(new RetryOneTime(1)).connectString(\"\").build();\n+        CuratorFramework client = CuratorFrameworkFactory.builder().namespace(\"\").retryPolicy(new RetryOneTime(1)).connectString(\"foo\").build();\n         CuratorFrameworkImpl clientImpl = (CuratorFrameworkImpl) client;\n \n         Assert.assertEquals(clientImpl.unfixForNamespace(\"/foo/bar\"), \"/foo/bar\");",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestNamespaceFacade.java",
                "sha": "9c1c99b7c4850ccc541fc7098c87d3b565efb0d2",
                "status": "modified"
            },
            {
                "additions": 50,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestReconfiguration.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/test/java/org/apache/curator/framework/imps/TestReconfiguration.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 24,
                "filename": "curator-framework/src/test/java/org/apache/curator/framework/imps/TestReconfiguration.java",
                "patch": "@@ -37,6 +37,7 @@\n import org.apache.zookeeper.Watcher;\n import org.apache.zookeeper.data.Stat;\n import org.apache.zookeeper.server.quorum.QuorumPeer;\n+import org.apache.zookeeper.server.quorum.QuorumPeerConfig;\n import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;\n import org.apache.zookeeper.server.quorum.flexible.QuorumVerifier;\n import org.testng.Assert;\n@@ -61,12 +62,18 @@\n     private TestingCluster cluster;\n     private EnsembleProvider ensembleProvider;\n \n+    private static final String superUserPasswordDigest = \"curator-test:zghsj3JfJqK7DbWf0RQ1BgbJH9w=\";  // ran from DigestAuthenticationProvider.generateDigest(superUserPassword);\n+    private static final String superUserPassword = \"curator-test\";\n+\n     @BeforeMethod\n     @Override\n     public void setup() throws Exception\n     {\n         super.setup();\n \n+        QuorumPeerConfig.setReconfigEnabled(true);\n+        System.setProperty(\"zookeeper.DigestAuthenticationProvider.superDigest\", superUserPasswordDigest);\n+\n         CloseableUtils.closeQuietly(server);\n         server = null;\n         cluster = new TestingCluster(3);\n@@ -79,6 +86,7 @@ public void teardown() throws Exception\n     {\n         CloseableUtils.closeQuietly(cluster);\n         ensembleProvider = null;\n+        System.clearProperty(\"zookeeper.DigestAuthenticationProvider.superDigest\");\n \n         super.teardown();\n     }\n@@ -278,44 +286,61 @@ public void testAddAndRemove() throws Exception\n         }\n     }\n \n-    @Test\n+    @Test(enabled = false)  // it's what this test is inteded to do and it keeps failing - disable for now\n     public void testNewMembers() throws Exception\n     {\n         cluster.close();\n-        cluster = new TestingCluster(5);\n-        List<TestingZooKeeperServer> servers = cluster.getServers();\n-        List<InstanceSpec> smallCluster = Lists.newArrayList();\n-        for ( int i = 0; i < 3; ++i )   // only start 3 of the 5\n-        {\n-            TestingZooKeeperServer server = servers.get(i);\n-            server.start();\n-            smallCluster.add(server.getInstanceSpec());\n-        }\n+        cluster = null;\n \n-        try ( CuratorFramework client = newClient())\n+        TestingCluster smallCluster = null;\n+        TestingCluster localCluster = new TestingCluster(5);\n+        try\n         {\n-            client.start();\n+            List<TestingZooKeeperServer> servers = localCluster.getServers();\n+            List<InstanceSpec> smallClusterInstances = Lists.newArrayList();\n+            for ( int i = 0; i < 3; ++i )   // only start 3 of the 5\n+            {\n+                TestingZooKeeperServer server = servers.get(i);\n+                server.start();\n+                smallClusterInstances.add(server.getInstanceSpec());\n+            }\n \n-            QuorumVerifier oldConfig = toQuorumVerifier(client.getConfig().forEnsemble());\n-            Assert.assertEquals(oldConfig.getAllMembers().size(), 5);\n-            assertConfig(oldConfig, cluster.getInstances());\n+            smallCluster = new TestingCluster(smallClusterInstances);\n+            try ( CuratorFramework client = newClient(smallCluster.getConnectString()))\n+            {\n+                client.start();\n \n-            CountDownLatch latch = setChangeWaiter(client);\n+                QuorumVerifier oldConfig = toQuorumVerifier(client.getConfig().forEnsemble());\n+                Assert.assertEquals(oldConfig.getAllMembers().size(), 5);\n+                assertConfig(oldConfig, localCluster.getInstances());\n+\n+                CountDownLatch latch = setChangeWaiter(client);\n \n-            client.reconfig().withNewMembers(toReconfigSpec(smallCluster)).forEnsemble();\n+                client.reconfig().withNewMembers(toReconfigSpec(smallClusterInstances)).forEnsemble();\n \n-            Assert.assertTrue(timing.awaitLatch(latch));\n-            byte[] newConfigData = client.getConfig().forEnsemble();\n-            QuorumVerifier newConfig = toQuorumVerifier(newConfigData);\n-            Assert.assertEquals(newConfig.getAllMembers().size(), 3);\n-            assertConfig(newConfig, smallCluster);\n-            Assert.assertEquals(EnsembleTracker.configToConnectionString(newConfig), ensembleProvider.getConnectionString());\n+                Assert.assertTrue(timing.awaitLatch(latch));\n+                byte[] newConfigData = client.getConfig().forEnsemble();\n+                QuorumVerifier newConfig = toQuorumVerifier(newConfigData);\n+                Assert.assertEquals(newConfig.getAllMembers().size(), 3);\n+                assertConfig(newConfig, smallClusterInstances);\n+                Assert.assertEquals(EnsembleTracker.configToConnectionString(newConfig), ensembleProvider.getConnectionString());\n+            }\n+        }\n+        finally\n+        {\n+            CloseableUtils.closeQuietly(smallCluster);\n+            CloseableUtils.closeQuietly(localCluster);\n         }\n     }\n \n     private CuratorFramework newClient()\n     {\n-        final AtomicReference<String> connectString = new AtomicReference<>(cluster.getConnectString());\n+        return newClient(cluster.getConnectString());\n+    }\n+\n+    private CuratorFramework newClient(String connectionString)\n+    {\n+        final AtomicReference<String> connectString = new AtomicReference<>(connectionString);\n         ensembleProvider = new EnsembleProvider()\n         {\n             @Override\n@@ -350,6 +375,7 @@ public void setConnectionString(String connectionString)\n             .ensembleProvider(ensembleProvider)\n             .sessionTimeoutMs(timing.session())\n             .connectionTimeoutMs(timing.connection())\n+            .authorization(\"digest\", superUserPassword.getBytes())\n             .retryPolicy(new ExponentialBackoffRetry(timing.forSleepingABit().milliseconds(), 3))\n             .build();\n     }",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-framework/src/test/java/org/apache/curator/framework/imps/TestReconfiguration.java",
                "sha": "abe6cc1f3de41cf676d178adcf42c00649af61fc",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestEventOrdering.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestEventOrdering.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 1,
                "filename": "curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestEventOrdering.java",
                "patch": "@@ -143,7 +143,7 @@ public Void call() throws Exception\n             int eventSuggestedQty = 0;\n             while ( events.size() > 0 )\n             {\n-                Event event = events.take();\n+                Event event = timing.takeFromQueue(events);\n                 localEvents.add(event);\n                 eventSuggestedQty += (event.eventType == EventType.ADDED) ? 1 : -1;\n             }",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestEventOrdering.java",
                "sha": "7b3a07e1177ecf804f1cee88d71da5220b3576d4",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestPathChildrenCacheInCluster.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestPathChildrenCacheInCluster.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 2,
                "filename": "curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestPathChildrenCacheInCluster.java",
                "patch": "@@ -19,6 +19,7 @@\n package org.apache.curator.framework.recipes.cache;\n \n import com.google.common.collect.Queues;\n+import org.apache.curator.test.BaseClassForTests;\n import org.apache.curator.utils.CloseableUtils;\n import org.apache.curator.framework.CuratorFramework;\n import org.apache.curator.framework.CuratorFrameworkFactory;\n@@ -33,9 +34,9 @@\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicReference;\n \n-public class TestPathChildrenCacheInCluster\n+public class TestPathChildrenCacheInCluster extends BaseClassForTests\n {\n-    @Test\n+    @Test(enabled = false)  // this test is very flakey - it needs to be re-written at some point\n     public void testMissedDelete() throws Exception\n     {\n         Timing timing = new Timing();",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/cache/TestPathChildrenCacheInCluster.java",
                "sha": "cd87125c4cb49fc66737cda12d13deb16f9ef57d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/leader/TestLeaderSelector.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-recipes/src/test/java/org/apache/curator/framework/recipes/leader/TestLeaderSelector.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 1,
                "filename": "curator-recipes/src/test/java/org/apache/curator/framework/recipes/leader/TestLeaderSelector.java",
                "patch": "@@ -193,7 +193,7 @@ public void stateChanged(CuratorFramework client, ConnectionState newState)\n             selector = new LeaderSelector(client, \"/leader\", listener);\n             selector.start();\n \n-            Thread leaderThread = queue.take();\n+            Thread leaderThread = timing.takeFromQueue(queue);\n             server.stop();\n             leaderThread.interrupt();\n             server.restart();",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/leader/TestLeaderSelector.java",
                "sha": "60619d05b8ff95a4020f3f5652aacec8040f98d4",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/locks/TestInterProcessSemaphoreCluster.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-recipes/src/test/java/org/apache/curator/framework/recipes/locks/TestInterProcessSemaphoreCluster.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 1,
                "filename": "curator-recipes/src/test/java/org/apache/curator/framework/recipes/locks/TestInterProcessSemaphoreCluster.java",
                "patch": "@@ -26,6 +26,7 @@\n import org.apache.curator.framework.state.ConnectionState;\n import org.apache.curator.framework.state.ConnectionStateListener;\n import org.apache.curator.retry.ExponentialBackoffRetry;\n+import org.apache.curator.test.BaseClassForTests;\n import org.apache.curator.test.InstanceSpec;\n import org.apache.curator.test.TestingCluster;\n import org.apache.curator.test.Timing;\n@@ -45,7 +46,7 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicReference;\n \n-public class TestInterProcessSemaphoreCluster\n+public class TestInterProcessSemaphoreCluster extends BaseClassForTests\n {\n     @Test\n     public void     testKilledServerWithEnsembleProvider() throws Exception",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-recipes/src/test/java/org/apache/curator/framework/recipes/locks/TestInterProcessSemaphoreCluster.java",
                "sha": "ed56f15badf235d43bb0a5cc573478919cd0459e",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/DirectoryUtils.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-test/src/main/java/org/apache/curator/test/DirectoryUtils.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 2,
                "filename": "curator-test/src/main/java/org/apache/curator/test/DirectoryUtils.java",
                "patch": "@@ -19,20 +19,25 @@\n package org.apache.curator.test;\n \n import com.google.common.base.Preconditions;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import java.io.File;\n import java.io.IOException;\n \n // copied from Google Guava as these methods are now deprecated\n // NOTE: removed the line of code documented: Symbolic links will have different canonical and absolute paths\n+// Update May 28, 2017 - change exception into logs\n public class DirectoryUtils\n {\n+    private static final Logger log = LoggerFactory.getLogger(DirectoryUtils.class);\n+\n     public static void deleteRecursively(File file) throws IOException\n     {\n         if (file.isDirectory()) {\n             deleteDirectoryContents(file);\n         }\n         if (!file.delete()) {\n-            throw new IOException(\"Failed to delete \" + file);\n+            log.error(\"Failed to delete \" + file);\n         }\n     }\n \n@@ -42,7 +47,8 @@ public static void deleteDirectoryContents(File directory)\n             \"Not a directory: %s\", directory);\n         File[] files = directory.listFiles();\n         if (files == null) {\n-            throw new IOException(\"Error listing files for \" + directory);\n+            log.warn(\"directory.listFiles() returned null for: \" + directory);\n+            return;\n         }\n         for (File file : files) {\n             deleteRecursively(file);",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/DirectoryUtils.java",
                "sha": "134aa5fb1e89bb281ab9b82ebafce5dcee7bcd06",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/TestingQuorumPeerMain.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-test/src/main/java/org/apache/curator/test/TestingQuorumPeerMain.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 9,
                "filename": "curator-test/src/main/java/org/apache/curator/test/TestingQuorumPeerMain.java",
                "patch": "@@ -27,6 +27,8 @@\n \n class TestingQuorumPeerMain extends QuorumPeerMain implements ZooKeeperMainFace\n {\n+    private volatile boolean isClosed = false;\n+\n     @Override\n     public void kill()\n     {\n@@ -60,16 +62,10 @@ public QuorumPeer getTestingQuorumPeer()\n     @Override\n     public void close() throws IOException\n     {\n-        if ( quorumPeer != null )\n+        if ( (quorumPeer != null) && !isClosed )\n         {\n-            try\n-            {\n-                quorumPeer.shutdown();\n-            }\n-            finally\n-            {\n-                quorumPeer = null;\n-            }\n+            isClosed = true;\n+            quorumPeer.shutdown();\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/TestingQuorumPeerMain.java",
                "sha": "3b3ab26ad3251154c12f24314e48cbd94db6edb1",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperMain.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperMain.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 0,
                "filename": "curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperMain.java",
                "patch": "@@ -272,6 +272,13 @@ public RequestProcessor getFirstProcessor()\n             return firstProcessor;\n         }\n \n+        @Override\n+        protected void setState(State state)\n+        {\n+            this.state = state;\n+            // avoid ZKShutdownHandler is not registered message\n+        }\n+\n         protected void registerJMX()\n         {\n             // NOP",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperMain.java",
                "sha": "841df775316562c9241c004a11c87e6220409029",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperServer.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperServer.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 1,
                "filename": "curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperServer.java",
                "patch": "@@ -21,7 +21,6 @@\n \n import org.apache.zookeeper.server.quorum.QuorumPeer;\n import org.apache.zookeeper.server.quorum.QuorumPeerConfig;\n-import org.apache.zookeeper.server.quorum.QuorumPeerMain;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import java.io.Closeable;\n@@ -53,6 +52,8 @@ public TestingZooKeeperServer(QuorumConfigBuilder configBuilder)\n \n     public TestingZooKeeperServer(QuorumConfigBuilder configBuilder, int thisInstanceIndex)\n     {\n+        System.setProperty(\"zookeeper.jmx.log4j.disable\", \"true\");  // disable JMX logging\n+\n         this.configBuilder = configBuilder;\n         this.thisInstanceIndex = thisInstanceIndex;\n         main = isCluster() ? new TestingQuorumPeerMain() : new TestingZooKeeperMain();",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperServer.java",
                "sha": "58cf8d4e2090731e69941aac42e137032b1aa128",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/curator/blob/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/Timing.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-test/src/main/java/org/apache/curator/test/Timing.java?ref=3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94",
                "deletions": 0,
                "filename": "curator-test/src/main/java/org/apache/curator/test/Timing.java",
                "patch": "@@ -19,9 +19,11 @@\n \n package org.apache.curator.test;\n \n+import java.util.concurrent.BlockingQueue;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.Semaphore;\n import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n \n /**\n  * Utility to get various testing times\n@@ -127,6 +129,32 @@ public boolean awaitLatch(CountDownLatch latch)\n         return false;\n     }\n \n+    /**\n+     * Try to take an item from the given queue\n+     *\n+     * @param queue queue\n+     * @return item\n+     * @throws Exception interrupted or timed out\n+     */\n+    public <T> T takeFromQueue(BlockingQueue<T> queue) throws Exception\n+    {\n+        Timing m = forWaiting();\n+        try\n+        {\n+            T value = queue.poll(m.value, m.unit);\n+            if ( value == null )\n+            {\n+                throw new TimeoutException(\"Timed out trying to take from queue\");\n+            }\n+            return value;\n+        }\n+        catch ( InterruptedException e )\n+        {\n+            Thread.currentThread().interrupt();\n+            throw e;\n+        }\n+    }\n+\n     /**\n      * Wait on the given semaphore\n      *",
                "raw_url": "https://github.com/apache/curator/raw/3ee1fdb809996a3bd07809fdbac6c66b3dc9fd94/curator-test/src/main/java/org/apache/curator/test/Timing.java",
                "sha": "242aa50175ead2824557fc1dc3f5c6a0f4b2d65b",
                "status": "modified"
            }
        ],
        "message": "Closes #221\n\nSquashed commit of the following:\n\ncommit 82712183bb06534f470055624913682bc71fe3b2\nMerge: e31b0736 df2e447b\nAuthor: randgalt <randgalt@apache.org>\nDate:   Tue May 30 06:45:15 2017 -0500\n\n    Merge branch 'master' into CURATOR-411\n\ncommit e31b0736d9356de390798a59c2c41aa1e2e8bd56\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 29 14:03:41 2017 -0500\n\n    disable testNewMembers until it's better understood\n\ncommit d4f15297d3594b80b94cf686210999f9c141d5b4\nAuthor: randgalt <randgalt@apache.org>\nDate:   Sun May 28 09:10:38 2017 -0500\n\n    In testNewMembers the smallCluster wasn't getting closed at the end of the test.\n\ncommit 9403703ad94d6d2e54d4cf393a24affab130f2d1\nAuthor: randgalt <randgalt@apache.org>\nDate:   Sun May 28 09:10:16 2017 -0500\n\n    changed exceptions to logging. This is test code\n\ncommit a0ab8772ca89a07dcc298705c06d18c73d218242\nAuthor: randgalt <randgalt@apache.org>\nDate:   Thu May 11 10:23:34 2017 +0200\n\n    Allow KeeperException.SessionExpiredException on all the tests\n\ncommit 5e97d0f3c53a403b898381e0a90cc0d0b8375c3f\nAuthor: randgalt <randgalt@apache.org>\nDate:   Thu May 11 00:39:40 2017 +0200\n\n    In testNewMembers, make sure client connects to one of the nodes in the small cluster to avoid connection loss exceptions\n\ncommit 96cecb2bbeec6e2deeac2e74188f83d2d0744b65\nAuthor: randgalt <randgalt@apache.org>\nDate:   Wed May 10 13:38:32 2017 +0200\n\n    KeeperException.SessionExpiredException is also valid for testWithNamespaceAndLostSessionAlt\n\ncommit 51eaa426e681c6521b0e313d822d524a9d4efbe1\nAuthor: randgalt <randgalt@apache.org>\nDate:   Wed May 10 13:33:05 2017 +0200\n\n    Only change from 5 to 4 to avoid flaky test\n\ncommit fb972db618eec11d350fc490010b014b8e3523fc\nAuthor: randgalt <randgalt@apache.org>\nDate:   Wed May 10 13:32:52 2017 +0200\n\n    don't clear quorumPeer as it might cause an NPE\n\ncommit 88d56219e3be026e453a5ef254bee3771d5b018b\nAuthor: randgalt <randgalt@apache.org>\nDate:   Tue May 9 12:40:50 2017 +0200\n\n    disable testMissedDelete() for now\n\ncommit 27ddd8c90042ca7abc667edb63504d081a1ca1b4\nAuthor: randgalt <randgalt@apache.org>\nDate:   Tue May 9 10:50:35 2017 +0200\n\n    overload setState() to avoid bogus log message\n\ncommit 70588f92e3dc7162f1e0df12ad0c09c92ab86b32\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 8 23:51:25 2017 +0200\n\n    extend BaseClassForTests so that retries occur\n\ncommit 4813b7924ecb6f0a2c4836e3e167e220a35f5314\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 8 23:29:49 2017 +0200\n\n    Turn off JMX logging\n\ncommit 3fa5143d6692bb18dba0d21a28328de032482d6f\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 8 19:43:16 2017 +0200\n\n    connection string cannot be empty\n\ncommit 0d1aa7ed1f3fef2b9cdb1e3a7f15d6e6ae85dac0\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 8 19:37:06 2017 +0200\n\n    Have to call setReconfigEnabled(true) and set the super-user Auth to get reconfig to work\n\ncommit 5407746c37c6ee08bbefe6632e25f5790226180c\nMerge: 872bfb02 32a7755b\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 8 06:15:40 2017 +0200\n\n    Merge branch 'master' into CURATOR-411\n\ncommit 872bfb0285dc4807d873b9ee2707b0f6044747f6\nAuthor: randgalt <randgalt@apache.org>\nDate:   Mon May 8 06:01:45 2017 +0200\n\n    Added a method to Timing to take from a queue with timeouts and applied it to tests that needed it",
        "parent": "https://github.com/apache/curator/commit/df2e447ba717c4fca3824806e6ba9f3499f514e1",
        "patched_files": [
            "NamespaceFacade.java",
            "FailedDeleteManager.java",
            "Timing.java",
            "DirectoryUtils.java",
            "LeaderSelector.java"
        ],
        "repo": "curator",
        "unit_tests": [
            "TestFramework.java",
            "TestingZooKeeperServer.java",
            "TestFrameworkEdges.java",
            "TestInterProcessSemaphoreCluster.java",
            "TestFailedDeleteManager.java",
            "TestingQuorumPeerMain.java",
            "TestLeaderSelector.java",
            "TestPathChildrenCacheInCluster.java",
            "TestEventOrdering.java",
            "TestNamespaceFacade.java",
            "TestReconfiguration.java",
            "TestingZooKeeperMain.java"
        ]
    },
    "curator_5febd7a": {
        "bug_id": "curator_5febd7a",
        "commit": "https://github.com/apache/curator/commit/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/curator/blob/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d/CHANGES.txt",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/CHANGES.txt?ref=5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -13,6 +13,9 @@ most of the calls async which will help concurrency and performance.\n * Issue 217: DistributedAtomicLong (et al) should use ensurePath internally to be consistent with\n other recipes.\n \n+* Issue 221: client.getACL().forPath(\"/\") throws a NullPointerException, because the Zookeeper\n+API expects a Stat, but GetACLBuilderImpl initializes responseStat to null.\n+\n 1.2.5 - November 27, 2012\n =========================\n * Depend on ZooKeeper 3.4.5",
                "raw_url": "https://github.com/apache/curator/raw/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d/CHANGES.txt",
                "sha": "a1151d2b49c77db2447dc1fc3678ad49a4faaaee",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/curator/blob/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d/curator-framework/src/main/java/com/netflix/curator/framework/imps/GetACLBuilderImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/main/java/com/netflix/curator/framework/imps/GetACLBuilderImpl.java?ref=5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d",
                "deletions": 1,
                "filename": "curator-framework/src/main/java/com/netflix/curator/framework/imps/GetACLBuilderImpl.java",
                "patch": "@@ -41,7 +41,7 @@\n     {\n         this.client = client;\n         backgrounding = new Backgrounding();\n-        responseStat = null;\n+        responseStat = new Stat();\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/curator/raw/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d/curator-framework/src/main/java/com/netflix/curator/framework/imps/GetACLBuilderImpl.java",
                "sha": "22d2cfe9fd4aeeeb50b385dd768155dd1c69db5c",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/curator/blob/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d/curator-framework/src/test/java/com/netflix/curator/framework/imps/TestFrameworkEdges.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-framework/src/test/java/com/netflix/curator/framework/imps/TestFrameworkEdges.java?ref=5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d",
                "deletions": 0,
                "filename": "curator-framework/src/test/java/com/netflix/curator/framework/imps/TestFrameworkEdges.java",
                "patch": "@@ -49,6 +49,29 @@\n \n public class TestFrameworkEdges extends BaseClassForTests\n {\n+    @Test\n+    public void     testGetAclNoStat() throws Exception\n+    {\n+\n+        CuratorFramework                client = CuratorFrameworkFactory.newClient(server.getConnectString(), new RetryOneTime(1));\n+        client.start();\n+        try\n+        {\n+            try\n+            {\n+                client.getACL().forPath(\"/\");\n+            }\n+            catch ( NullPointerException e )\n+            {\n+                Assert.fail();\n+            }\n+        }\n+        finally\n+        {\n+            client.close();\n+        }\n+    }\n+\n     @Test\n     public void     testMissedResponseOnBackgroundESCreate() throws Exception\n     {",
                "raw_url": "https://github.com/apache/curator/raw/5febd7a7a5f9e61cf0527666907f7d1f6d27fc0d/curator-framework/src/test/java/com/netflix/curator/framework/imps/TestFrameworkEdges.java",
                "sha": "5115d58f6690d6b476106f5744605150653a48d1",
                "status": "modified"
            }
        ],
        "message": "Issue 221: client.getACL().forPath(\"/\") throws a NullPointerException, because the Zookeeper\nAPI expects a Stat, but GetACLBuilderImpl initializes responseStat to null.",
        "parent": "https://github.com/apache/curator/commit/bb586801e9b6061aade0dd98764c4c0dfec235ac",
        "patched_files": [
            "GetACLBuilderImpl.java",
            "CHANGES.txt"
        ],
        "repo": "curator",
        "unit_tests": [
            "TestFrameworkEdges.java"
        ]
    },
    "curator_cc30b67": {
        "bug_id": "curator_cc30b67",
        "commit": "https://github.com/apache/curator/commit/cc30b67c8dbe24babd31ed654e9536fe776b8a18",
        "file": [
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/curator/blob/cc30b67c8dbe24babd31ed654e9536fe776b8a18/curator-x-discovery/src/main/java/org/apache/curator/x/discovery/details/ServiceCacheImpl.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-x-discovery/src/main/java/org/apache/curator/x/discovery/details/ServiceCacheImpl.java?ref=cc30b67c8dbe24babd31ed654e9536fe776b8a18",
                "deletions": 1,
                "filename": "curator-x-discovery/src/main/java/org/apache/curator/x/discovery/details/ServiceCacheImpl.java",
                "patch": "@@ -18,6 +18,7 @@\n  */\n package org.apache.curator.x.discovery.details;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Function;\n import com.google.common.base.Preconditions;\n import com.google.common.collect.Lists;\n@@ -36,6 +37,7 @@\n import java.io.IOException;\n import java.util.List;\n import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.Executor;\n import java.util.concurrent.Executors;\n import java.util.concurrent.ThreadFactory;\n@@ -85,15 +87,33 @@ private static CloseableExecutorService convertThreadFactory(ThreadFactory threa\n         return Lists.newArrayList(instances.values());\n     }\n \n+    @VisibleForTesting\n+    volatile CountDownLatch debugStartLatch = null;\n+    volatile CountDownLatch debugStartWaitLatch = null;\n+\n     @Override\n     public void start() throws Exception\n     {\n         Preconditions.checkState(state.compareAndSet(State.LATENT, State.STARTED), \"Cannot be started more than once\");\n \n         cache.start(true);\n+        if ( debugStartLatch != null )\n+        {\n+            debugStartLatch.countDown();\n+            debugStartLatch = null;\n+        }\n+        if ( debugStartWaitLatch != null )\n+        {\n+            debugStartWaitLatch.await();\n+            debugStartWaitLatch = null;\n+        }\n+\n         for ( ChildData childData : cache.getCurrentData() )\n         {\n-            addInstance(childData, true);\n+            if ( childData.getData() != null )  // else already processed by the cache listener\n+            {\n+                addInstance(childData, true);\n+            }\n         }\n         discovery.cacheOpened(this);\n     }",
                "raw_url": "https://github.com/apache/curator/raw/cc30b67c8dbe24babd31ed654e9536fe776b8a18/curator-x-discovery/src/main/java/org/apache/curator/x/discovery/details/ServiceCacheImpl.java",
                "sha": "d1a31ad1cc5fafd7e87e8238c5de189e067345cb",
                "status": "modified"
            },
            {
                "additions": 110,
                "blob_url": "https://github.com/apache/curator/blob/cc30b67c8dbe24babd31ed654e9536fe776b8a18/curator-x-discovery/src/test/java/org/apache/curator/x/discovery/details/TestServiceCacheRace.java",
                "changes": 110,
                "contents_url": "https://api.github.com/repos/apache/curator/contents/curator-x-discovery/src/test/java/org/apache/curator/x/discovery/details/TestServiceCacheRace.java?ref=cc30b67c8dbe24babd31ed654e9536fe776b8a18",
                "deletions": 0,
                "filename": "curator-x-discovery/src/test/java/org/apache/curator/x/discovery/details/TestServiceCacheRace.java",
                "patch": "@@ -0,0 +1,110 @@\n+package org.apache.curator.x.discovery.details;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.framework.state.ConnectionState;\n+import org.apache.curator.retry.RetryOneTime;\n+import org.apache.curator.test.BaseClassForTests;\n+import org.apache.curator.test.Timing;\n+import org.apache.curator.utils.CloseableExecutorService;\n+import org.apache.curator.utils.CloseableUtils;\n+import org.apache.curator.x.discovery.ServiceCache;\n+import org.apache.curator.x.discovery.ServiceDiscovery;\n+import org.apache.curator.x.discovery.ServiceDiscoveryBuilder;\n+import org.apache.curator.x.discovery.ServiceInstance;\n+import org.slf4j.LoggerFactory;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+import java.io.Closeable;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.Executors;\n+\n+public class TestServiceCacheRace extends BaseClassForTests\n+{\n+    private final Timing timing = new Timing();\n+\n+    // validates CURATOR-452 which exposed a race in ServiceCacheImpl's start() method caused by an optimization whereby it clears the dataBytes of its internal PathChildrenCache\n+    @Test\n+    public void testRaceOnInitialLoad() throws Exception\n+    {\n+        List<Closeable> closeables = Lists.newArrayList();\n+        try\n+        {\n+            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new RetryOneTime(1));\n+            closeables.add(client);\n+            client.start();\n+\n+            ServiceDiscovery<String> discovery = ServiceDiscoveryBuilder.builder(String.class).basePath(\"/discovery\").client(client).build();\n+            closeables.add(discovery);\n+            discovery.start();\n+\n+            CountDownLatch cacheStartLatch = new CountDownLatch(1);\n+            CountDownLatch cacheWaitLatch = new CountDownLatch(1);\n+            final ServiceCache<String> cache = discovery.serviceCacheBuilder().name(\"test\").build();\n+            closeables.add(cache);\n+            ((ServiceCacheImpl)cache).debugStartLatch = cacheStartLatch;    // causes ServiceCacheImpl.start to notify just after starting its internal PathChildrenCache\n+            ((ServiceCacheImpl)cache).debugStartWaitLatch = cacheWaitLatch; // causes ServiceCacheImpl.start to wait before iterating over its internal PathChildrenCache\n+\n+            ServiceInstance<String> instance1 = ServiceInstance.<String>builder().payload(\"test\").name(\"test\").port(10064).build();\n+            discovery.registerService(instance1);\n+\n+            CloseableExecutorService closeableExecutorService = new CloseableExecutorService(Executors.newSingleThreadExecutor());\n+            closeables.add(closeableExecutorService);\n+            final CountDownLatch startCompletedLatch = new CountDownLatch(1);\n+            Runnable proc = new Runnable()\n+            {\n+                @Override\n+                public void run()\n+                {\n+                    try\n+                    {\n+                        cache.start();\n+                        startCompletedLatch.countDown();\n+                    }\n+                    catch ( Exception e )\n+                    {\n+                        LoggerFactory.getLogger(getClass()).error(\"Start failed\", e);\n+                        throw new RuntimeException(e);\n+                    }\n+                }\n+            };\n+            closeableExecutorService.submit(proc);\n+            Assert.assertTrue(timing.awaitLatch(cacheStartLatch));  // wait until ServiceCacheImpl's internal PathChildrenCache is started and primed\n+\n+            final CountDownLatch cacheChangedLatch = new CountDownLatch(1);\n+            ServiceCacheListener listener = new ServiceCacheListener()\n+            {\n+                @Override\n+                public void cacheChanged()\n+                {\n+                    cacheChangedLatch.countDown();\n+                }\n+\n+                @Override\n+                public void stateChanged(CuratorFramework client, ConnectionState newState)\n+                {\n+                    // NOP\n+                }\n+            };\n+            cache.addListener(listener);\n+            ServiceInstance<String> instance2 = ServiceInstance.<String>builder().payload(\"test\").name(\"test\").port(10065).build();\n+            discovery.registerService(instance2);   // cause ServiceCacheImpl's internal PathChildrenCache listener to get called which will clear the dataBytes\n+            Assert.assertTrue(timing.awaitLatch(cacheChangedLatch));\n+\n+            cacheWaitLatch.countDown();\n+\n+            Assert.assertTrue(timing.awaitLatch(startCompletedLatch));\n+        }\n+        finally\n+        {\n+            Collections.reverse(closeables);\n+            for ( Closeable c : closeables )\n+            {\n+                CloseableUtils.closeQuietly(c);\n+            }\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/curator/raw/cc30b67c8dbe24babd31ed654e9536fe776b8a18/curator-x-discovery/src/test/java/org/apache/curator/x/discovery/details/TestServiceCacheRace.java",
                "sha": "08a2a8e839807e4b0621d57b570beda5737e4a5d",
                "status": "added"
            }
        ],
        "message": "Fix for CURATOR-452\n\nrace in ServiceCacheImpl's start() method caused by an optimization whereby it clears the dataBytes of its internal PathChildrenCache - was causing an intermittent NPE",
        "parent": "https://github.com/apache/curator/commit/a1f620efe00916db168c7405a46b32dfe89a9965",
        "patched_files": [
            "ServiceCacheImpl.java"
        ],
        "repo": "curator",
        "unit_tests": [
            "TestServiceCacheRace.java"
        ]
    }
}