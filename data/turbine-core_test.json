{
    "turbine-core_1b8d16f": {
        "repo": "turbine-core",
        "message": "Fix NPE in LogoutAction: draw user from session instead of RunData. Add test.\n\ngit-svn-id: https://svn.apache.org/repos/asf/turbine/core/trunk@1754670 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/turbine-core/commit/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87",
        "parent": "https://github.com/apache/turbine-core/commit/153cece7e73ea683bfa35062c83f4f0c9c3775da",
        "bug_id": "turbine-core_1b8d16f",
        "file": [
            {
                "sha": "91d86b6dec2c2cd428fa8093cb60f69720e07703",
                "filename": "src/changes/changes.xml",
                "blob_url": "https://github.com/apache/turbine-core/blob/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87/src/changes/changes.xml",
                "raw_url": "https://github.com/apache/turbine-core/raw/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87/src/changes/changes.xml",
                "status": "modified",
                "changes": 3,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/turbine-core/contents/src/changes/changes.xml?ref=1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87",
                "patch": "@@ -25,6 +25,9 @@\n \n   <body>\n     <release version=\"4.0\" date=\"in Subversion\">\n+      <action type=\"fix\" dev=\"tv\">\n+        Fix NPE in LogoutAction: draw user from session instead of RunData. Add test.\n+      </action>\n       <action type=\"update\" dev=\"tv\">\n         Update BrowserDetector to support contemporary browsers.\n       </action>",
                "deletions": 0
            },
            {
                "sha": "d564cc43a5b312dd5bf05858378ce6f565ca5d96",
                "filename": "src/java/org/apache/turbine/modules/actions/LogoutUser.java",
                "blob_url": "https://github.com/apache/turbine-core/blob/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87/src/java/org/apache/turbine/modules/actions/LogoutUser.java",
                "raw_url": "https://github.com/apache/turbine-core/raw/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87/src/java/org/apache/turbine/modules/actions/LogoutUser.java",
                "status": "modified",
                "changes": 6,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/turbine-core/contents/src/java/org/apache/turbine/modules/actions/LogoutUser.java?ref=1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87",
                "patch": "@@ -63,7 +63,7 @@\n      * If this action name is the value of action.logout then we are\n      * being run before the session validator, so we don't need to\n      * set the screen (we assume that the session validator will handle\n-     * that). This is basically still here simply to preserve old behaviour\n+     * that). This is basically still here simply to preserve old behavior\n      * - it is recommended that action.logout is set to \"LogoutUser\" and\n      * that the session validator does handle setting the screen/template\n      * for a logged out (read not-logged-in) user.\n@@ -77,7 +77,9 @@ public void doPerform(PipelineData pipelineData)\n             throws FulcrumSecurityException\n     {\n         RunData data = getRunData(pipelineData);\n-        User user = data.getUser();\n+\n+        // Session validator did not run, so RunData is not populated\n+        User user = data.getUserFromSession();\n \n         if (!security.isAnonymousUser(user))\n         {",
                "deletions": 2
            },
            {
                "sha": "9606f79d81247b647b7096405157ce483c00dc97",
                "filename": "src/test/org/apache/turbine/pipeline/DefaultLoginValveTest.java",
                "blob_url": "https://github.com/apache/turbine-core/blob/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87/src/test/org/apache/turbine/pipeline/DefaultLoginValveTest.java",
                "raw_url": "https://github.com/apache/turbine-core/raw/1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87/src/test/org/apache/turbine/pipeline/DefaultLoginValveTest.java",
                "status": "modified",
                "changes": 43,
                "additions": 37,
                "contents_url": "https://api.github.com/repos/apache/turbine-core/contents/src/test/org/apache/turbine/pipeline/DefaultLoginValveTest.java?ref=1b8d16fbbf5b32c8c5773fd29b2f8b3c31ebad87",
                "patch": "@@ -22,6 +22,7 @@\n \n \n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertTrue;\n \n@@ -61,6 +62,7 @@\n     private EnhancedMockHttpServletRequest request = null;\n     private EnhancedMockHttpSession session = null;\n     private HttpServletResponse response = null;\n+    private SecurityService securityService = null;\n \n \n     @BeforeClass\n@@ -89,22 +91,25 @@ public void setUpBefore() throws Exception {\n         session = new EnhancedMockHttpSession();\n         response = new MockHttpServletResponse();\n \n-        session.setupGetAttribute(User.SESSION_KEY, null);\n-\n         request.setSession(session);\n \n         // User must exist\n-        SecurityService securityService = (SecurityService)TurbineServices.getInstance().getService(SecurityService.SERVICE_NAME);\n-        User user = securityService.getUserInstance();\n-        user.setName(\"username\");\n-        securityService.addUser(user, \"password\");\n+        securityService = (SecurityService)TurbineServices.getInstance().getService(SecurityService.SERVICE_NAME);\n+        if (!securityService.accountExists(\"username\"))\n+        {\n+            User user = securityService.getUserInstance();\n+            user.setName(\"username\");\n+            securityService.addUser(user, \"password\");\n+        }\n     }\n \n     /**\n      * Tests the Valve.\n      */\n     @Test public void testDefaults() throws Exception\n     {\n+        session.setupGetAttribute(User.SESSION_KEY, null);\n+\n         Vector<String> v = new Vector<String>();\n         v.add(LoginUser.CGI_USERNAME);\n         v.add(LoginUser.CGI_PASSWORD);\n@@ -130,6 +135,32 @@ public void setUpBefore() throws Exception {\n         assertTrue(user.hasLoggedIn());\n     }\n \n+    /**\n+     * Tests the LogoutAction.\n+     */\n+    @Test public void testLogout() throws Exception\n+    {\n+        User user = securityService.getUser(\"username\");\n+        user.setHasLoggedIn(Boolean.TRUE);\n+        session.setupGetAttribute(User.SESSION_KEY, user);\n+\n+        RunData runData = getRunData(request,response,config);\n+        runData.setAction(TurbineConstants.ACTION_LOGOUT_DEFAULT);\n+\n+        Pipeline pipeline = new TurbinePipeline();\n+        PipelineData pipelineData = runData;\n+\n+        DefaultLoginValve valve = new DefaultLoginValve();\n+        pipeline.addValve(valve);\n+        pipeline.initialize();\n+\n+        pipeline.invoke(pipelineData);\n+        user = runData.getUser();\n+        assertNotNull(user);\n+        assertTrue(securityService.isAnonymousUser(user));\n+        assertFalse(user.hasLoggedIn());\n+    }\n+\n     @AfterClass\n     public static void destroy() {\n         tc.dispose();",
                "deletions": 6
            }
        ],
        "patched_files": [
            "LogoutUser.java",
            "DefaultLoginValve.java"
        ],
        "unit_tests": [
            "DefaultLoginValveTest.java"
        ]
    }
}