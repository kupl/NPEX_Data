[
    {
        "repo": "hive",
        "commit": "https://github.com/apache/hive/commit/89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f",
        "bug_id": "hive_89c275e",
        "message": "HIVE-22393: HiveStreamingConnection: Exception in beginTransaction causes AbstractRecordWriter to throw NPE, covering up real exception (Matt Burgess via L\u00e1szl\u00f3 Bodor)\n\nSigned-off-by: Laszlo Bodor <bodorlaszlo0202@gmail.com>",
        "parent": "https://github.com/apache/hive/commit/22f5ab51660aa660fdae58bb56a8c5cc44b60630",
        "patched_files": [
            "AbstractRecordWriter.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 7,
                "raw_url": "https://github.com/apache/hive/raw/89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f/streaming/src/java/org/apache/hive/streaming/AbstractRecordWriter.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/streaming/src/java/org/apache/hive/streaming/AbstractRecordWriter.java?ref=89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f",
                "filename": "streaming/src/java/org/apache/hive/streaming/AbstractRecordWriter.java",
                "deletions": 3,
                "sha": "fc9a2dd5342aa615059db7882d56c962aa6a22c5",
                "blob_url": "https://github.com/apache/hive/blob/89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f/streaming/src/java/org/apache/hive/streaming/AbstractRecordWriter.java",
                "patch": "@@ -366,7 +366,9 @@ public void flush() throws StreamingIOFailure {\n \n   @Override\n   public void close() throws StreamingIOFailure {\n-    heapMemoryMonitor.close();\n+    if(heapMemoryMonitor != null) {\n+      heapMemoryMonitor.close();\n+    }\n     boolean haveError = false;\n     String partition = null;\n     if (LOG.isDebugEnabled()) {\n@@ -395,7 +397,9 @@ public void close() throws StreamingIOFailure {\n       logStats(\"Stats after close:\");\n     }\n     try {\n-      this.fs.close();\n+      if(this.fs != null) {\n+        this.fs.close();\n+      }\n     } catch (IOException e) {\n       throw new StreamingIOFailure(\"Error while closing FileSystem\", e);\n     }\n@@ -630,7 +634,7 @@ protected void logStats(final String prefix) {\n       .filter(Objects::nonNull)\n       .mapToLong(RecordUpdater::getBufferedRowCount)\n       .sum();\n-    MemoryUsage memoryUsage = heapMemoryMonitor.getTenuredGenMemoryUsage();\n+    MemoryUsage memoryUsage = heapMemoryMonitor == null ? null : heapMemoryMonitor.getTenuredGenMemoryUsage();\n     String oldGenUsage = \"NA\";\n     if (memoryUsage != null) {\n       oldGenUsage = \"used/max => \" + LlapUtil.humanReadableByteCount(memoryUsage.getUsed()) + \"/\" +",
                "changes": 10
            },
            {
                "status": "modified",
                "additions": 21,
                "raw_url": "https://github.com/apache/hive/raw/89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f/streaming/src/test/org/apache/hive/streaming/TestStreaming.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/streaming/src/test/org/apache/hive/streaming/TestStreaming.java?ref=89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f",
                "filename": "streaming/src/test/org/apache/hive/streaming/TestStreaming.java",
                "deletions": 0,
                "sha": "35a220facd7d2d8f0a24a2cddfaf47ca47c60c5f",
                "blob_url": "https://github.com/apache/hive/blob/89c275e21395b28e4ed3a3dd317f67e3cd4bcc4f/streaming/src/test/org/apache/hive/streaming/TestStreaming.java",
                "patch": "@@ -1819,6 +1819,27 @@ public void testTransactionBatchAbort() throws Exception {\n \n   }\n \n+  @Test(expected = ClassCastException.class)\n+  public void testFileSystemError() throws Exception {\n+    // Bad file system object, ClassCastException should occur during record writer init\n+    conf.set(\"fs.raw.impl\", Object.class.getName());\n+\n+    StrictDelimitedInputWriter writer = StrictDelimitedInputWriter.newBuilder()\n+            .withFieldDelimiter(',')\n+            .build();\n+\n+    HiveStreamingConnection connection = HiveStreamingConnection.newBuilder()\n+            .withDatabase(dbName)\n+            .withTable(tblName)\n+            .withStaticPartitionValues(partitionVals)\n+            .withAgentInfo(\"UT_\" + Thread.currentThread().getName())\n+            .withRecordWriter(writer)\n+            .withHiveConf(conf)\n+            .connect();\n+\n+    connection.beginTransaction();\n+  }\n+\n \n   @Test\n   public void testTransactionBatchAbortAndCommit() throws Exception {",
                "changes": 21
            }
        ],
        "unit_tests": [
            "TestStreaming.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "streaming/src/test/org/apache/hive/streaming/TestStreaming.java",
        "buggy_files": [
            "streaming/src/java/org/apache/hive/streaming/AbstractRecordWriter.java",
            "hcatalog/streaming/src/java/org/apache/hive/hcatalog/streaming/AbstractRecordWriter.java"
        ],
        "fixed": true
    }
]