[
    {
        "repo": "maven-common-artifact-filters",
        "commit": "https://github.com/apache/maven-common-artifact-filters/commit/5a2c263a455c80e18ce41d602672c43b1ff8c33b",
        "bug_id": "maven-common-artifact-filters_5a2c263",
        "message": "[MSHARED-74] Fix NPE for Artifact.getId() when artifact uses a version range instead of a single version...this is triggered when an artifact is excluded from the ScopeArtifactFilter.include() method.\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/maven/shared/trunk@697220 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/maven-common-artifact-filters/commit/f031b4326707f56e1317caeb69d0e429ad88800a",
        "patched_files": [
            "ScopeArtifactFilter.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 13,
                "raw_url": "https://github.com/apache/maven-common-artifact-filters/raw/5a2c263a455c80e18ce41d602672c43b1ff8c33b/src/main/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilter.java",
                "contents_url": "https://api.github.com/repos/apache/maven-common-artifact-filters/contents/src/main/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilter.java?ref=5a2c263a455c80e18ce41d602672c43b1ff8c33b",
                "filename": "src/main/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilter.java",
                "deletions": 1,
                "sha": "b2d281d5d590202aef018f602f28e484736a170d",
                "blob_url": "https://github.com/apache/maven-common-artifact-filters/blob/5a2c263a455c80e18ce41d602672c43b1ff8c33b/src/main/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilter.java",
                "patch": "@@ -139,7 +139,19 @@ else if ( Artifact.SCOPE_SYSTEM.equals( artifact.getScope() ) )\n \n         if ( !result )\n         {\n-            filteredArtifactIds.add( artifact.getId() );\n+            // We have to be very careful with artifacts that have ranges, \n+            // because artifact.getId() will throw a NPE if a range is specified.\n+            String id;\n+            if ( artifact.getVersionRange() != null )\n+            {\n+                id = artifact.getDependencyConflictId() + \":\" + artifact.getVersionRange();\n+            }\n+            else\n+            {\n+                id = artifact.getId();\n+            }\n+            \n+            filteredArtifactIds.add( id );\n         }\n \n         return result;",
                "changes": 14
            },
            {
                "status": "modified",
                "additions": 21,
                "raw_url": "https://github.com/apache/maven-common-artifact-filters/raw/5a2c263a455c80e18ce41d602672c43b1ff8c33b/src/test/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilterTest.java",
                "contents_url": "https://api.github.com/repos/apache/maven-common-artifact-filters/contents/src/test/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilterTest.java?ref=5a2c263a455c80e18ce41d602672c43b1ff8c33b",
                "filename": "src/test/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilterTest.java",
                "deletions": 18,
                "sha": "13b6c75764414c1bcf16c73572d3895d9395b236",
                "blob_url": "https://github.com/apache/maven-common-artifact-filters/blob/5a2c263a455c80e18ce41d602672c43b1ff8c33b/src/test/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilterTest.java",
                "patch": "@@ -18,16 +18,29 @@\n  */\n package org.apache.maven.shared.artifact.filter;\n \n-import junit.framework.TestCase;\n-\n import org.apache.maven.artifact.Artifact;\n+import org.apache.maven.artifact.factory.ArtifactFactory;\n import org.apache.maven.artifact.resolver.filter.ArtifactFilter;\n+import org.apache.maven.artifact.versioning.VersionRange;\n import org.apache.maven.shared.tools.easymock.MockManager;\n+import org.codehaus.plexus.PlexusTestCase;\n import org.easymock.MockControl;\n \n public class ScopeArtifactFilterTest\n-    extends TestCase\n+    extends PlexusTestCase\n {\n+    \n+    public void testExcludedArtifactWithRangeShouldNotCauseNPE()\n+        throws Exception\n+    {\n+        ArtifactFactory factory = (ArtifactFactory) lookup( ArtifactFactory.ROLE );\n+        \n+        Artifact excluded = factory.createDependencyArtifact( \"group\", \"artifact\", VersionRange.createFromVersionSpec( \"[1.2.3]\" ), \"jar\", null, Artifact.SCOPE_PROVIDED );\n+        \n+        ArtifactFilter filter = new ScopeArtifactFilter( Artifact.SCOPE_RUNTIME );\n+        \n+        assertFalse( filter.include( excluded ) );\n+    }\n \n     private MockManager mockManager = new MockManager();\n \n@@ -148,31 +161,21 @@ private void verifyExcluded( String filterScope, String artifactScope )\n \n         MockControl control;\n \n-        private final String scope;\n-\n         ArtifactMockAndControl( String scope )\n         {\n-            this.scope = scope;\n-\n             control = MockControl.createControl( Artifact.class );\n             mockManager.add( control );\n \n             artifact = (Artifact) control.getMock();\n \n-            enableGetScope();\n-            enableGetId();\n-        }\n-\n-        void enableGetScope()\n-        {\n             artifact.getScope();\n-            control.setReturnValue( scope, MockControl.ONE_OR_MORE );\n-        }\n-\n-        void enableGetId()\n-        {\n+            control.setReturnValue( scope, MockControl.ZERO_OR_MORE );\n+            \n             artifact.getId();\n             control.setReturnValue( \"group:artifact:type:version\", MockControl.ZERO_OR_MORE );\n+            \n+            artifact.getVersionRange();\n+            control.setReturnValue( null, MockControl.ZERO_OR_MORE );\n         }\n     }\n ",
                "changes": 39
            }
        ],
        "unit_tests": [
            "ScopeArtifactFilterTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "src/test/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilterTest.java",
        "buggy_files": [
            "src/main/java/org/apache/maven/shared/artifact/filter/ScopeArtifactFilter.java"
        ],
        "fixed": true
    }
]