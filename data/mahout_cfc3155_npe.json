[
    {
        "repo": "mahout",
        "commit": "https://github.com/apache/mahout/commit/cfc31552094358301ab5d31d932620d599d29723",
        "bug_id": "mahout_cfc3155",
        "message": "MAHOUT-1232: VectorHelper.topEntries() throws a NPE when number of NonZero elements in vector < maxEntries\n\ngit-svn-id: https://svn.apache.org/repos/asf/mahout/trunk@1487279 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/mahout/commit/754fd18bd52d198518ce0ac3882581427593ece1",
        "patched_files": [
            "CHANGELOG",
            "VectorDumper.java",
            "VectorHelper.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 2,
                "raw_url": "https://github.com/apache/mahout/raw/cfc31552094358301ab5d31d932620d599d29723/CHANGELOG",
                "contents_url": "https://api.github.com/repos/apache/mahout/contents/CHANGELOG?ref=cfc31552094358301ab5d31d932620d599d29723",
                "filename": "CHANGELOG",
                "deletions": 0,
                "sha": "13c952e9d03f3cb79e55f0f162867c9004804b6f",
                "blob_url": "https://github.com/apache/mahout/blob/cfc31552094358301ab5d31d932620d599d29723/CHANGELOG",
                "patch": "@@ -2,6 +2,8 @@ Mahout Change Log\n \n Release 0.8 - unreleased\n \n+  MAHOUT-1232: VectorHelper.topEntries() throws a NPE when number of NonZero elements in vector < maxEntries (smarthi)\n+\n   MAHOUT-1229: Conf directory content from Mahout distribution archives cannot be unpacked (Stevo Slavic via smarthi)\n   \n   MAHOUT-1213: SSVD job doesn't clean it's temp dir, and fails when seeing it again (smarthi)",
                "changes": 2
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/mahout/raw/cfc31552094358301ab5d31d932620d599d29723/integration/src/main/java/org/apache/mahout/utils/vectors/VectorDumper.java",
                "contents_url": "https://api.github.com/repos/apache/mahout/contents/integration/src/main/java/org/apache/mahout/utils/vectors/VectorDumper.java?ref=cfc31552094358301ab5d31d932620d599d29723",
                "filename": "integration/src/main/java/org/apache/mahout/utils/vectors/VectorDumper.java",
                "deletions": 1,
                "sha": "a7736bbcd9313450ff3de3bf19b4933e7b8ccb13",
                "blob_url": "https://github.com/apache/mahout/blob/cfc31552094358301ab5d31d932620d599d29723/integration/src/main/java/org/apache/mahout/utils/vectors/VectorDumper.java",
                "patch": "@@ -251,7 +251,7 @@ public int run(String[] args) throws Exception {\n       writer.flush();\n     } finally {\n       if (shouldClose) {\n-        Closeables.closeQuietly(writer);\n+        Closeables.close(writer, true);\n       }\n     }\n ",
                "changes": 2
            },
            {
                "status": "modified",
                "additions": 7,
                "raw_url": "https://github.com/apache/mahout/raw/cfc31552094358301ab5d31d932620d599d29723/integration/src/main/java/org/apache/mahout/utils/vectors/VectorHelper.java",
                "contents_url": "https://api.github.com/repos/apache/mahout/contents/integration/src/main/java/org/apache/mahout/utils/vectors/VectorHelper.java?ref=cfc31552094358301ab5d31d932620d599d29723",
                "filename": "integration/src/main/java/org/apache/mahout/utils/vectors/VectorHelper.java",
                "deletions": 0,
                "sha": "26946dc8695aeb3b0f9242bf6cb7c6a6e181d014",
                "blob_url": "https://github.com/apache/mahout/blob/cfc31552094358301ab5d31d932620d599d29723/integration/src/main/java/org/apache/mahout/utils/vectors/VectorHelper.java",
                "patch": "@@ -19,6 +19,7 @@\n \n import com.google.common.base.Function;\n import com.google.common.collect.Collections2;\n+import com.google.common.collect.Iterables;\n import com.google.common.collect.Lists;\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.fs.Path;\n@@ -79,6 +80,12 @@ public static String buildJson(Iterable<Pair<String, Double>> iterable, StringBu\n   }\n \n   public static List<Pair<Integer, Double>> topEntries(Vector vector, int maxEntries) {\n+    // Get the size of nonZero elements in the input vector\n+    int sizeOfNonZeroElementsInVector = Iterables.size(vector.nonZeroes());\n+    // If the sizeOfNonZeroElementsInVector < maxEntries then set maxEntries to sizeOfNonZeroElementsInVector\n+    // else the call to queue.pop() returns a Pair(null, null) and the subsequent\n+    // call to pair.getFirst() throws a NullPointerException\n+    maxEntries = (sizeOfNonZeroElementsInVector < maxEntries) ? sizeOfNonZeroElementsInVector : maxEntries;\n     PriorityQueue<Pair<Integer, Double>> queue = new TDoublePQ<Integer>(-1, maxEntries);\n     for (Element e : vector.nonZeroes()) {\n       queue.insertWithOverflow(Pair.of(e.index(), e.get()));",
                "changes": 7
            },
            {
                "status": "modified",
                "additions": 19,
                "raw_url": "https://github.com/apache/mahout/raw/cfc31552094358301ab5d31d932620d599d29723/integration/src/test/java/org/apache/mahout/utils/vectors/VectorHelperTest.java",
                "contents_url": "https://api.github.com/repos/apache/mahout/contents/integration/src/test/java/org/apache/mahout/utils/vectors/VectorHelperTest.java?ref=cfc31552094358301ab5d31d932620d599d29723",
                "filename": "integration/src/test/java/org/apache/mahout/utils/vectors/VectorHelperTest.java",
                "deletions": 0,
                "sha": "b193bda01639662798978a8d25cdcfe23dda8858",
                "blob_url": "https://github.com/apache/mahout/blob/cfc31552094358301ab5d31d932620d599d29723/integration/src/test/java/org/apache/mahout/utils/vectors/VectorHelperTest.java",
                "patch": "@@ -17,6 +17,7 @@\n \n package org.apache.mahout.utils.vectors;\n \n+import com.google.common.collect.Iterables;\n import org.apache.mahout.math.SequentialAccessSparseVector;\n import org.apache.mahout.math.Vector;\n import org.apache.mahout.utils.MahoutTestCase;\n@@ -51,4 +52,22 @@ public void testJsonFormatting() throws Exception {\n         VectorHelper.vectorToJson(v, dictionary, 2, false));\n   }\n \n+  @Test\n+  public void testTopEntries() throws Exception {\n+    Vector v = new SequentialAccessSparseVector(10);\n+    v.set(2, 3.1);\n+    v.set(4, 1.0);\n+    v.set(6, 8.1);\n+    v.set(7, -100);\n+    v.set(9, 12.2);\n+    v.set(1, 0.0);\n+    v.set(3, 0.0);\n+    v.set(8, 2.7);\n+    assertEquals(6, VectorHelper.topEntries(v, 6).size());\n+    // when sizeOfNonZeroElementsInVector < maxEntries\n+    assertTrue(VectorHelper.topEntries(v, 9).size() < 9);\n+    // when sizeOfNonZeroElementsInVector > maxEntries\n+    assertTrue(VectorHelper.topEntries(v, 5).size() < Iterables.size(v.nonZeroes()));\n+  }\n+\n }",
                "changes": 19
            }
        ],
        "unit_tests": [
            "VectorHelperTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "integration/src/test/java/org/apache/mahout/utils/vectors/VectorHelperTest.java",
        "buggy_files": [
            "CHANGELOG",
            "integration/src/main/java/org/apache/mahout/utils/vectors/VectorDumper.java",
            "integration/src/main/java/org/apache/mahout/utils/vectors/VectorHelper.java"
        ],
        "fixed": true
    }
]