{
    "incubator-ratis_008c009": {
        "bug_id": "incubator-ratis_008c009",
        "commit": "https://github.com/apache/incubator-ratis/commit/008c0093fed0cfd7e53b7d455621e1ec794d6f38",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/008c0093fed0cfd7e53b7d455621e1ec794d6f38/ratis-server/src/main/java/org/apache/ratis/server/raftlog/segmented/SegmentedRaftLog.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/raftlog/segmented/SegmentedRaftLog.java?ref=008c0093fed0cfd7e53b7d455621e1ec794d6f38",
                "deletions": 2,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/raftlog/segmented/SegmentedRaftLog.java",
                "patch": "@@ -178,8 +178,8 @@ private void loadLogSegments(long lastIndexInSnapshot,\n   @Override\n   public LogEntryProto get(long index) throws RaftLogIOException {\n     checkLogState();\n-    LogSegment segment;\n-    LogRecordWithEntry recordAndEntry;\n+    final LogSegment segment;\n+    final LogRecordWithEntry recordAndEntry;\n     try (AutoCloseableLock readLock = readLock()) {\n       segment = cache.getSegment(index);\n       if (segment == null) {\n@@ -203,6 +203,9 @@ public LogEntryProto get(long index) throws RaftLogIOException {\n   @Override\n   public EntryWithData getEntryWithData(long index) throws RaftLogIOException {\n     final LogEntryProto entry = get(index);\n+    if (entry == null) {\n+      throw new RaftLogIOException(\"Log entry not found: index = \" + index);\n+    }\n     if (!ServerProtoUtils.shouldReadStateMachineData(entry)) {\n       return new EntryWithData(entry, null);\n     }",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/008c0093fed0cfd7e53b7d455621e1ec794d6f38/ratis-server/src/main/java/org/apache/ratis/server/raftlog/segmented/SegmentedRaftLog.java",
                "sha": "1586ecb79ed219959d9a87f1cb38d8a793676103",
                "status": "modified"
            }
        ],
        "message": "RATIS-577. NPE in LogAppender while creating a new request.",
        "parent": "https://github.com/apache/incubator-ratis/commit/300d9c53c4b77e16ddd5d68dcf6c792d52a94a02",
        "repo": "incubator-ratis",
        "unit_tests": [
            "TestSegmentedRaftLog.java"
        ]
    },
    "incubator-ratis_bbfb875": {
        "bug_id": "incubator-ratis_bbfb875",
        "commit": "https://github.com/apache/incubator-ratis/commit/bbfb8754d136a5404e8c2a813a7468d94165d80c",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java?ref=bbfb8754d136a5404e8c2a813a7468d94165d80c",
                "deletions": 1,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java",
                "patch": "@@ -170,7 +170,7 @@ private void askForVotes() throws InterruptedException, IOException {\n           case DISCOVERED_A_NEW_TERM:\n             final long term = r.term > server.getState().getCurrentTerm() ?\n                 r.term : server.getState().getCurrentTerm();\n-            server.changeToFollower(term, true);\n+            server.changeToFollowerAndPersistMetadata(term);\n             return;\n           case TIMEOUT:\n             // should start another election",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java",
                "sha": "d62b1a7b28609f407884d4f89276527c697ea7a3",
                "status": "modified"
            },
            {
                "additions": 106,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderState.java",
                "changes": 173,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderState.java?ref=bbfb8754d136a5404e8c2a813a7468d94165d80c",
                "deletions": 67,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderState.java",
                "patch": "@@ -40,8 +40,6 @@\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import static org.apache.ratis.server.impl.LeaderState.StateUpdateEventType.*;\n-\n /**\n  * States for leader only. It contains three different types of processors:\n  * 1. RPC senders: each thread is appending log to a follower\n@@ -54,21 +52,76 @@\n   private static final Logger LOG = RaftServerImpl.LOG;\n   public static final String APPEND_PLACEHOLDER = LeaderState.class.getSimpleName() + \".placeholder\";\n \n-  enum StateUpdateEventType {\n-    STEPDOWN, UPDATECOMMIT, STAGINGPROGRESS\n-  }\n-\n-  enum BootStrapProgress {\n+  private enum BootStrapProgress {\n     NOPROGRESS, PROGRESSING, CAUGHTUP\n   }\n \n   static class StateUpdateEvent {\n-    final StateUpdateEventType type;\n+    private enum Type {\n+      STEP_DOWN, UPDATE_COMMIT, CHECK_STAGING\n+    }\n+\n+    final Type type;\n     final long newTerm;\n+    final Runnable handler;\n \n-    StateUpdateEvent(StateUpdateEventType type, long newTerm) {\n+    StateUpdateEvent(Type type, long newTerm, Runnable handler) {\n       this.type = type;\n       this.newTerm = newTerm;\n+      this.handler = handler;\n+    }\n+\n+    void execute() {\n+      handler.run();\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+      if (obj == this) {\n+        return true;\n+      } else if (!(obj instanceof StateUpdateEvent)) {\n+        return false;\n+      }\n+      final StateUpdateEvent that = (StateUpdateEvent)obj;\n+      return this.type == that.type && this.newTerm == that.newTerm;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return type + (newTerm >= 0? \":\" + newTerm: \"\");\n+    }\n+  }\n+\n+  private class EventQueue {\n+    private final BlockingQueue<StateUpdateEvent> queue = new ArrayBlockingQueue<>(4096);\n+\n+    void submit(StateUpdateEvent event) {\n+      try {\n+        queue.put(event);\n+      } catch (InterruptedException e) {\n+        LOG.info(\"{}: Interrupted when submitting {} \", server.getId(), event);\n+      }\n+    }\n+\n+    StateUpdateEvent poll() {\n+      final StateUpdateEvent e;\n+      try {\n+        e = queue.poll(server.getMaxTimeoutMs(), TimeUnit.MILLISECONDS);\n+      } catch(InterruptedException ie) {\n+        String s = server.getId() + \": \" + getClass().getSimpleName() + \" thread is interrupted\";\n+        if (!running) {\n+          LOG.info(s + \" gracefully\");\n+          return null;\n+        } else {\n+          throw new IllegalStateException(s + \" UNEXPECTEDLY\", ie);\n+        }\n+      }\n+\n+      if (e != null) {\n+        // remove duplicated events from the head.\n+        for(; e.equals(queue.peek()); queue.poll());\n+      }\n+      return e;\n     }\n   }\n \n@@ -101,10 +154,10 @@ boolean removeAll(Collection<LogAppender> c) {\n     }\n   }\n \n-  static final StateUpdateEvent UPDATE_COMMIT_EVENT =\n-      new StateUpdateEvent(StateUpdateEventType.UPDATECOMMIT, -1);\n-  static final StateUpdateEvent STAGING_PROGRESS_EVENT =\n-      new StateUpdateEvent(StateUpdateEventType.STAGINGPROGRESS, -1);\n+  private final StateUpdateEvent UPDATE_COMMIT_EVENT =\n+      new StateUpdateEvent(StateUpdateEvent.Type.UPDATE_COMMIT, -1, this::updateCommit);\n+  private final StateUpdateEvent CHECK_STAGING_EVENT =\n+      new StateUpdateEvent(StateUpdateEvent.Type.CHECK_STAGING, -1, this::checkStaging);\n \n   private final RaftServerImpl server;\n   private final RaftLog raftLog;\n@@ -117,7 +170,7 @@ boolean removeAll(Collection<LogAppender> c) {\n    * The list is protected by the RaftServer's lock.\n    */\n   private final SenderList senders;\n-  private final BlockingQueue<StateUpdateEvent> eventQ;\n+  private final EventQueue eventQueue = new EventQueue();\n   private final EventProcessor processor;\n   private final PendingRequests pendingRequests;\n   private volatile boolean running = true;\n@@ -135,7 +188,6 @@ boolean removeAll(Collection<LogAppender> c) {\n     final ServerState state = server.getState();\n     this.raftLog = state.getLog();\n     this.currentTerm = state.getCurrentTerm();\n-    eventQ = new ArrayBlockingQueue<>(4096);\n     processor = new EventProcessor();\n     pendingRequests = new PendingRequests(server);\n \n@@ -192,10 +244,6 @@ boolean inStagingState() {\n     return stagingState != null;\n   }\n \n-  ConfigurationStagingState getStagingState() {\n-    return stagingState;\n-  }\n-\n   long getCurrentTerm() {\n     return currentTerm;\n   }\n@@ -299,11 +347,25 @@ private void updateSenders(RaftConfiguration conf) {\n     stopAndRemoveSenders(s -> !conf.containsInConf(s.getFollower().getPeer().getId()));\n   }\n \n-  void submitUpdateStateEvent(StateUpdateEvent event) {\n+  void submitStepDownEvent() {\n+    submitStepDownEvent(getCurrentTerm());\n+  }\n+\n+  void submitStepDownEvent(long term) {\n+    eventQueue.submit(new StateUpdateEvent(StateUpdateEvent.Type.STEP_DOWN, term, () -> stepDown(term)));\n+  }\n+\n+  private void stepDown(long term) {\n     try {\n-      eventQ.put(event);\n-    } catch (InterruptedException e) {\n-      LOG.info(\"Interrupted when adding event {} into the queue\", event);\n+      server.changeToFollowerAndPersistMetadata(term);\n+    } catch(IOException e) {\n+      final String s = server.getId() + \": Failed to persist metadata for term \" + term;\n+      LOG.warn(s, e);\n+      // the failure should happen while changing the state to follower\n+      // thus the in-memory state should have been updated\n+      if (running) {\n+        throw new IllegalStateException(s + \" and running == true\", e);\n+      }\n     }\n   }\n \n@@ -331,50 +393,20 @@ public void run() {\n       prepare();\n \n       while (running) {\n-        try {\n-          StateUpdateEvent event = eventQ.poll(server.getMaxTimeoutMs(),\n-              TimeUnit.MILLISECONDS);\n-          synchronized (server) {\n-            if (running) {\n-              handleEvent(event);\n+        final StateUpdateEvent event = eventQueue.poll();\n+        synchronized(server) {\n+          if (running) {\n+            if (event != null) {\n+              event.execute();\n+            } else if (inStagingState()) {\n+              checkStaging();\n             }\n           }\n-          // the updated configuration does not need to be sync'ed here\n-        } catch (InterruptedException e) {\n-          final String s = server.getId() + \" \" + getClass().getSimpleName()\n-              + \" thread is interrupted \";\n-          if (!running) {\n-            LOG.info(s + \" gracefully; server=\" + server);\n-          } else {\n-            LOG.warn(s + \" UNEXPECTEDLY; server=\" + server, e);\n-            throw new RuntimeException(e);\n-          }\n-        } catch (IOException e) {\n-          LOG.warn(\"Failed to persist new votedFor/term.\", e);\n-          // the failure should happen while changing the state to follower\n-          // thus the in-memory state should have been updated\n-          Preconditions.assertTrue(!running);\n         }\n       }\n     }\n   }\n \n-  private void handleEvent(StateUpdateEvent e) throws IOException {\n-    if (e == null) {\n-      if (inStagingState()) {\n-        checkNewPeers();\n-      }\n-    } else {\n-      if (e.type == STEPDOWN) {\n-        server.changeToFollower(e.newTerm, true);\n-      } else if (e.type == UPDATECOMMIT) {\n-        updateLastCommitted();\n-      } else if (e.type == STAGINGPROGRESS) {\n-        checkNewPeers();\n-      }\n-    }\n-  }\n-\n   /**\n    * So far we use a simple implementation for catchup checking:\n    * 1. If the latest rpc time of the remote peer is before 3 * max_timeout,\n@@ -410,11 +442,14 @@ private BootStrapProgress checkProgress(FollowerInfo follower,\n         .collect(Collectors.toCollection(ArrayList::new));\n   }\n \n-  private void checkNewPeers() {\n+  void submitCheckStagingEvent() {\n+    eventQueue.submit(CHECK_STAGING_EVENT);\n+  }\n+\n+  private void checkStaging() {\n     if (!inStagingState()) {\n-      // it is possible that the bootstrapping is done and we still have\n-      // remaining STAGINGPROGRESS event to handle.\n-      updateLastCommitted();\n+      // it is possible that the bootstrapping is done. Then, fallback to UPDATE_COMMIT\n+      UPDATE_COMMIT_EVENT.execute();\n     } else {\n       final long committedIndex = server.getState().getLog()\n           .getLastCommittedIndex();\n@@ -431,10 +466,14 @@ private void checkNewPeers() {\n   }\n \n   boolean isBootStrappingPeer(RaftPeerId peerId) {\n-    return inStagingState() && getStagingState().contains(peerId);\n+    return Optional.ofNullable(stagingState).map(s -> s.contains(peerId)).orElse(false);\n+  }\n+\n+  void submitUpdateCommitEvent() {\n+    eventQueue.submit(UPDATE_COMMIT_EVENT);\n   }\n \n-  private void updateLastCommitted() {\n+  private void updateCommit() {\n     final RaftPeerId selfId = server.getId();\n     final RaftConfiguration conf = server.getRaftConf();\n \n@@ -575,7 +614,7 @@ static long getMajority(long[] indices) {\n   /** @return true if the request is replied; otherwise, the reply is delayed, return false. */\n   boolean replyPendingRequest(long logIndex, RaftClientReply reply, RetryCache.CacheEntry cacheEntry) {\n     if (!pendingRequests.replyPendingRequest(logIndex, reply, cacheEntry)) {\n-      submitUpdateStateEvent(UPDATE_COMMIT_EVENT);\n+      submitUpdateCommitEvent();\n       return false;\n     }\n     return true;",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderState.java",
                "sha": "b4b613e745c5a43e6e35fac6669be4d484e3719f",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/LogAppender.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/impl/LogAppender.java?ref=bbfb8754d136a5404e8c2a813a7468d94165d80c",
                "deletions": 9,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/impl/LogAppender.java",
                "patch": "@@ -20,7 +20,6 @@\n import org.apache.ratis.conf.RaftProperties;\n import org.apache.ratis.protocol.RaftPeerId;\n import org.apache.ratis.server.RaftServerConfigKeys;\n-import org.apache.ratis.server.impl.LeaderState.StateUpdateEventType;\n import org.apache.ratis.server.protocol.TermIndex;\n import org.apache.ratis.server.storage.RaftLog.EntryWithData;\n import org.apache.ratis.server.storage.FileInfo;\n@@ -45,7 +44,6 @@\n import static org.apache.ratis.util.LifeCycle.State.CLOSED;\n import static org.apache.ratis.util.LifeCycle.State.CLOSING;\n import static org.apache.ratis.util.LifeCycle.State.EXCEPTION;\n-import static org.apache.ratis.util.LifeCycle.State.NEW;\n import static org.apache.ratis.util.LifeCycle.State.RUNNING;\n import static org.apache.ratis.util.LifeCycle.State.STARTING;\n \n@@ -491,10 +489,11 @@ private void handleException(Exception e) {\n   }\n \n   protected void submitEventOnSuccessAppend() {\n-    LeaderState.StateUpdateEvent e = follower.isAttendingVote() ?\n-        LeaderState.UPDATE_COMMIT_EVENT :\n-        LeaderState.STAGING_PROGRESS_EVENT;\n-    leaderState.submitUpdateStateEvent(e);\n+    if (follower.isAttendingVote()) {\n+      leaderState.submitUpdateCommitEvent();\n+    } else {\n+      leaderState.submitCheckStagingEvent();\n+    }\n   }\n \n   protected void checkSlowness() {\n@@ -531,9 +530,7 @@ protected void checkResponseTerm(long responseTerm) {\n     synchronized (server) {\n       if (isAppenderRunning() && follower.isAttendingVote()\n           && responseTerm > leaderState.getCurrentTerm()) {\n-        leaderState.submitUpdateStateEvent(\n-            new LeaderState.StateUpdateEvent(StateUpdateEventType.STEPDOWN,\n-                responseTerm));\n+        leaderState.submitStepDownEvent(responseTerm);\n       }\n     }\n   }",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/LogAppender.java",
                "sha": "3c9b2d4dbf61476ac48abb3282027af6952f3f9c",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java?ref=bbfb8754d136a5404e8c2a813a7468d94165d80c",
                "deletions": 16,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java",
                "patch": "@@ -295,13 +295,10 @@ public boolean isLeader() {\n   /**\n    * Change the server state to Follower if necessary\n    * @param newTerm The new term.\n-   * @param sync We will call {@link ServerState#persistMetadata()} if this is\n-   *             set to true and term/votedFor get updated.\n    * @return if the term/votedFor should be updated to the new term\n    * @throws IOException if term/votedFor persistence failed.\n    */\n-  synchronized boolean changeToFollower(long newTerm, boolean sync)\n-      throws IOException {\n+  private synchronized boolean changeToFollower(long newTerm) {\n     final RaftPeerRole old = role.getCurrentRole();\n     final boolean metadataUpdated = state.updateCurrentTerm(newTerm);\n \n@@ -314,11 +311,13 @@ synchronized boolean changeToFollower(long newTerm, boolean sync)\n       }\n       startHeartbeatMonitor();\n     }\n+    return metadataUpdated;\n+  }\n \n-    if (metadataUpdated && sync) {\n+  synchronized void changeToFollowerAndPersistMetadata(long newTerm) throws IOException {\n+    if (changeToFollower(newTerm)) {\n       state.persistMetadata();\n     }\n-    return metadataUpdated;\n   }\n \n   private synchronized void shutdownLeaderState(boolean allowNull) {\n@@ -546,9 +545,7 @@ void assertGroup(Object requestorId, RaftGroupId requestorGroupId) throws GroupM\n         cacheEntry.failWithReply(exceptionReply);\n         // leader will step down here\n         if (isLeader() && leaderState != null) {\n-          leaderState.submitUpdateStateEvent(new LeaderState.StateUpdateEvent(\n-              LeaderState.StateUpdateEventType.STEPDOWN,\n-              leaderState.getCurrentTerm()));\n+          leaderState.submitStepDownEvent();\n         }\n         return CompletableFuture.completedFuture(exceptionReply);\n       }\n@@ -777,7 +774,7 @@ private RequestVoteReplyProto requestVote(\n             getId(), role, candidateId, candidateTerm, state.getLeaderId(), state.getCurrentTerm(),\n             isFollower()? heartbeatMonitor.getLastRpcTime().elapsedTimeMs() + \"ms\": null);\n       } else if (state.recognizeCandidate(candidateId, candidateTerm)) {\n-        boolean termUpdated = changeToFollower(candidateTerm, false);\n+        final boolean termUpdated = changeToFollower(candidateTerm);\n         // see Section 5.4.1 Election restriction\n         if (state.isLogUpToDate(candidateLastEntry)) {\n           heartbeatMonitor.updateLastRpcTime(false);\n@@ -910,7 +907,7 @@ static void logAppendEntries(boolean isHeartbeat, Supplier<String> message) {\n         }\n         return CompletableFuture.completedFuture(reply);\n       }\n-      changeToFollower(leaderTerm, true);\n+      changeToFollowerAndPersistMetadata(leaderTerm);\n       state.setLeader(leaderId, \"appendEntries\");\n \n       if (!initializing && lifeCycle.compareAndTransition(STARTING, RUNNING)) {\n@@ -1010,7 +1007,7 @@ public InstallSnapshotReplyProto installSnapshot(\n             \" Reply: {}\", getId(), reply);\n         return reply;\n       }\n-      changeToFollower(leaderTerm, true);\n+      changeToFollowerAndPersistMetadata(leaderTerm);\n       state.setLeader(leaderId, \"installSnapshot\");\n \n       if (lifeCycle.getCurrentState() == RUNNING) {\n@@ -1062,10 +1059,8 @@ synchronized RequestVoteRequestProto createRequestVoteRequest(\n         groupId, term, lastEntry);\n   }\n \n-  public synchronized void submitLocalSyncEvent() {\n-    if (isLeader() && leaderState != null) {\n-      leaderState.submitUpdateStateEvent(LeaderState.UPDATE_COMMIT_EVENT);\n-    }\n+  public void submitUpdateCommitEvent() {\n+    Optional.ofNullable(leaderState).ifPresent(LeaderState::submitUpdateCommitEvent);\n   }\n \n   /**",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java",
                "sha": "d4b32a10362f407c1aa97ef7234b46a9ffb6a4b5",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/storage/RaftLogWorker.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/storage/RaftLogWorker.java?ref=bbfb8754d136a5404e8c2a813a7468d94165d80c",
                "deletions": 12,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/storage/RaftLogWorker.java",
                "patch": "@@ -61,7 +61,7 @@\n \n   private final RaftStorage storage;\n   private volatile LogOutputStream out;\n-  private final RaftServerImpl raftServer;\n+  private final Runnable submitUpdateCommitEvent;\n   private final StateMachine stateMachine;\n   private final Supplier<Timer> logFlushTimer;\n \n@@ -86,7 +86,7 @@\n     this.name = selfId + \"-\" + getClass().getSimpleName();\n     LOG.info(\"new {} for {}\", name, storage);\n \n-    this.raftServer = raftServer;\n+    this.submitUpdateCommitEvent = raftServer != null? raftServer::submitUpdateCommitEvent: () -> {};\n     this.stateMachine = raftServer != null? raftServer.getStateMachine(): null;\n \n     this.storage = storage;\n@@ -100,11 +100,8 @@\n     this.workerThread = new Thread(this, name);\n \n     // Server Id can be null in unit tests\n-    Supplier<String> serverId = () -> raftServer == null || raftServer.getId() == null\n-        ? \"null\" : raftServer.getId().toString();\n     this.logFlushTimer = JavaUtils.memoize(() -> RatisMetricsRegistry.getRegistry()\n-        .timer(MetricRegistry.name(RaftLogWorker.class, serverId.get(),\n-            \"flush-time\")));\n+        .timer(MetricRegistry.name(RaftLogWorker.class, selfId.toString(), \"flush-time\")));\n   }\n \n   void start(long latestIndex, File openSegmentFile) throws IOException {\n@@ -243,9 +240,7 @@ private void flushWrites() throws IOException {\n   private void updateFlushedIndex() {\n     flushedIndex = lastWrittenIndex;\n     pendingFlushNum = 0;\n-    if (raftServer != null) {\n-      raftServer.submitLocalSyncEvent();\n-    }\n+    submitUpdateCommitEvent.run();\n   }\n \n   /**\n@@ -288,9 +283,8 @@ Task truncate(TruncationSegments ts) {\n           // this.entry != entry iff the entry has state machine data\n           this.stateMachineFuture = stateMachine.writeStateMachineData(entry);\n         } catch (Throwable e) {\n-          LOG.error(\"{}: writeStateMachineData failed for index:{} proto:{}\",\n-              raftServer.getId() ,entry.getIndex(),\n-              ServerProtoUtils.toString(entry), e.getMessage());\n+          LOG.error(name + \": writeStateMachineData failed for index \" + entry.getIndex()\n+              + \", entry=\" + ServerProtoUtils.toLogEntryString(entry), e);\n           throw e;\n         }\n       }",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/storage/RaftLogWorker.java",
                "sha": "715370b554b114af25aded930b7629f0a6dc8352",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/incubator-ratis/blob/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/storage/SegmentedRaftLog.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-ratis/contents/ratis-server/src/main/java/org/apache/ratis/server/storage/SegmentedRaftLog.java?ref=bbfb8754d136a5404e8c2a813a7468d94165d80c",
                "deletions": 2,
                "filename": "ratis-server/src/main/java/org/apache/ratis/server/storage/SegmentedRaftLog.java",
                "patch": "@@ -105,8 +105,7 @@ public String toString() {\n   private final long segmentMaxSize;\n \n   public SegmentedRaftLog(RaftPeerId selfId, RaftServerImpl server,\n-      RaftStorage storage, long lastIndexInSnapshot, RaftProperties properties)\n-      throws IOException {\n+      RaftStorage storage, long lastIndexInSnapshot, RaftProperties properties) {\n     super(selfId, RaftServerConfigKeys.Log.Appender.bufferCapacity(properties)\n         .getSizeInt());\n     this.server = server;",
                "raw_url": "https://github.com/apache/incubator-ratis/raw/bbfb8754d136a5404e8c2a813a7468d94165d80c/ratis-server/src/main/java/org/apache/ratis/server/storage/SegmentedRaftLog.java",
                "sha": "862e21f87f20ee9db3ed1709651be62ec170486b",
                "status": "modified"
            }
        ],
        "message": "RATIS-336. LeaderState.isBootStrappingPeer may have NPE.",
        "parent": "https://github.com/apache/incubator-ratis/commit/f6814c6b46a54a787983a4245121ee35a9cad0b8",
        "repo": "incubator-ratis",
        "unit_tests": [
            "TestSegmentedRaftLog.java"
        ]
    }
}