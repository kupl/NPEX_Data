{
    "cloudstack_0040c4a": {
        "bug_id": "cloudstack_0040c4a",
        "commit": "https://github.com/apache/cloudstack/commit/0040c4adef4f7b92aa63737a8f2c5405a07fabda",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/0040c4adef4f7b92aa63737a8f2c5405a07fabda/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java?ref=0040c4adef4f7b92aa63737a8f2c5405a07fabda",
                "deletions": 1,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "patch": "@@ -335,7 +335,11 @@ public String getPath() {\n             return this.volumeVO.getPath();\n         } else {\n             DataObjectInStore objInStore = this.objectInStoreMgr.findObject(this, dataStore);\n-            return objInStore.getInstallPath();\n+            if (objInStore != null) {\n+                return objInStore.getInstallPath();\n+            } else {\n+                return null;\n+            }\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/0040c4adef4f7b92aa63737a8f2c5405a07fabda/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "sha": "f5a1276cf2d4e36f605ce8c4aa3670b5267c6a2c",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4363: fix possible NPE, if copy volume failed.",
        "parent": "https://github.com/apache/cloudstack/commit/1c96898ae1314521d32a557ec39bd745f0f4a709",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeObjectTest.java"
        ]
    },
    "cloudstack_0059dd0": {
        "bug_id": "cloudstack_0059dd0",
        "commit": "https://github.com/apache/cloudstack/commit/0059dd0e5742235448b1551e5c047daa485778d1",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/0059dd0e5742235448b1551e5c047daa485778d1/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=0059dd0e5742235448b1551e5c047daa485778d1",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1534,7 +1534,7 @@ protected Command compareState(long hostId, VMInstanceVO vm, final AgentVmInfo i\n         }\n         \n         if(trackExternalChange) {\n-        \tif(hostId != vm.getHostId()) {\n+        \tif(vm.getHostId() == null || hostId != vm.getHostId()) {\n         \t\ttry {\n         \t\t\tstateTransitTo(vm, VirtualMachine.Event.AgentReportMigrated, hostId);\n         \t\t} catch (NoTransitionException e) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/0059dd0e5742235448b1551e5c047daa485778d1/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "ed01e94d0a5be3aa0fbc178cda319c7c0ea0c7f7",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/0059dd0e5742235448b1551e5c047daa485778d1/setup/db/db/schema-225to226.sql",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-225to226.sql?ref=0059dd0e5742235448b1551e5c047daa485778d1",
                "deletions": 0,
                "filename": "setup/db/db/schema-225to226.sql",
                "patch": "@@ -9,5 +9,27 @@ ALTER TABLE `cloud`.`network_offerings` ADD COLUMN `unique_name` varchar(64) NOT\n UPDATE `cloud`.`network_offerings` SET unique_name=name;\n ALTER TABLE `cloud`.`network_offerings` MODIFY `unique_name` varchar(64) NOT NULL UNIQUE COMMENT 'unique name of the network offering';\n \n+DROP TABLE IF EXISTS `cloud`.`certificate`;\n+CREATE TABLE IF NOT EXISTS `cloud`.`keystore` (\n+  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\n+  `name` varchar(64) NOT NULL COMMENT 'unique name for the certifiation',\n+  `certificate` text NOT NULL COMMENT 'the actual certificate being stored in the db',\n+  `key` text NOT NULL COMMENT 'private key associated wih the certificate',\n+  `domain_suffix` varchar(256) NOT NULL COMMENT 'DNS domain suffix associated with the certificate',\n+  PRIMARY KEY (`id`),\n+  UNIQUE(name)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n \n+CREATE TABLE IF NOT EXISTS `cloud`.`cmd_exec_log` (\n+  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\n+  `host_id` bigint unsigned NOT NULL COMMENT 'host id of the system VM agent that command is sent to',\n+  `instance_id` bigint unsigned NOT NULL COMMENT 'instance id of the system VM that command is executed on',\n+  `command_name` varchar(255) NOT NULL COMMENT 'command name',\n+  `weight` integer NOT NULL DEFAULT 1 COMMENT 'command weight in consideration of the load factor added to host that is executing the command',\n+  `created` datetime NOT NULL COMMENT 'date created',\n+  PRIMARY KEY (`id`),\n+  INDEX `i_cmd_exec_log__host_id`(`host_id`),\n+  INDEX `i_cmd_exec_log__instance_id`(`instance_id`),\n+  CONSTRAINT `fk_cmd_exec_log_ref__inst_id` FOREIGN KEY (`instance_id`) REFERENCES `vm_instance`(`id`) ON DELETE CASCADE\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/0059dd0e5742235448b1551e5c047daa485778d1/setup/db/db/schema-225to226.sql",
                "sha": "eb39f0c91a9c888f5f6227536bdb76be66bb40bb",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/0059dd0e5742235448b1551e5c047daa485778d1/setup/db/db/schema-227to228.sql",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-227to228.sql?ref=0059dd0e5742235448b1551e5c047daa485778d1",
                "deletions": 3,
                "filename": "setup/db/db/schema-227to228.sql",
                "patch": "@@ -11,7 +11,7 @@ ALTER TABLE `cloud`.`service_offering` ADD COLUMN `vm_type` varchar(32) COMMENT\n ALTER TABLE `cloud`.`storage_pool` MODIFY `host_address` varchar(255) NOT NULL;\r\n \r\n DROP TABLE IF EXISTS `cloud`.`certificate`;\r\n-CREATE TABLE `cloud`.`keystore` (\r\n+CREATE TABLE IF NOT EXISTS `cloud`.`keystore` (\r\n   `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\r\n   `name` varchar(64) NOT NULL COMMENT 'unique name for the certifiation',\r\n   `certificate` text NOT NULL COMMENT 'the actual certificate being stored in the db',\r\n@@ -21,7 +21,7 @@ CREATE TABLE `cloud`.`keystore` (\n   UNIQUE(name)\r\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\r\n \r\n-CREATE TABLE `cloud`.`cmd_exec_log` (\r\n+CREATE TABLE IF NOT EXISTS `cloud`.`cmd_exec_log` (\r\n   `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\r\n   `host_id` bigint unsigned NOT NULL COMMENT 'host id of the system VM agent that command is sent to',\r\n   `instance_id` bigint unsigned NOT NULL COMMENT 'instance id of the system VM that command is executed on',\r\n@@ -34,7 +34,7 @@ CREATE TABLE `cloud`.`cmd_exec_log` (\n   CONSTRAINT `fk_cmd_exec_log_ref__inst_id` FOREIGN KEY (`instance_id`) REFERENCES `vm_instance`(`id`) ON DELETE CASCADE\r\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\r\n \r\n-CREATE TABLE `cloud`.`network_tags` (\r\n+CREATE TABLE IF NOT EXISTS `cloud`.`network_tags` (\r\n   `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\r\n   `network_id` bigint unsigned NOT NULL COMMENT 'id of the network',\r\n   `tag` varchar(255) NOT NULL COMMENT 'tag',\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/0059dd0e5742235448b1551e5c047daa485778d1/setup/db/db/schema-227to228.sql",
                "sha": "b9f74dc72c86092b746695a132e6da571786d623",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/0059dd0e5742235448b1551e5c047daa485778d1/utils/src/com/cloud/utils/StringUtils.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/StringUtils.java?ref=0059dd0e5742235448b1551e5c047daa485778d1",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/StringUtils.java",
                "patch": "@@ -119,4 +119,16 @@ public static String unicodeEscape(String s) {\n     \t}\n     \treturn sb.toString();\n     }\n+    \n+    public static String getMaskedPasswordForDisplay(String password) {\n+    \tif(password == null || password.isEmpty())\n+    \t\treturn \"*\";\n+    \t\n+    \tStringBuffer sb = new StringBuffer();\n+    \tsb.append(password.charAt(0));\n+    \tfor(int i = 1; i < password.length(); i++)\n+    \t\tsb.append(\"*\");\n+    \t\n+    \treturn sb.toString();\n+    }\n }\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/0059dd0e5742235448b1551e5c047daa485778d1/utils/src/com/cloud/utils/StringUtils.java",
                "sha": "f4226efe33385d9a70cd3e0abe184a2a810f0e59",
                "status": "modified"
            }
        ],
        "message": "bug 10480, 10494: NPE fix in VirtualMachineManagerImpl, move keystore upgrade sql to upgrade225to226.sql",
        "parent": "https://github.com/apache/cloudstack/commit/80028345813200ef1aa039838b63549dcbf5f9dd",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java",
            "StringUtilsTest.java"
        ]
    },
    "cloudstack_04a8682": {
        "bug_id": "cloudstack_04a8682",
        "commit": "https://github.com/apache/cloudstack/commit/04a868231311477dde8e60d4f87a0360ef681dd1",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/04a868231311477dde8e60d4f87a0360ef681dd1/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=04a868231311477dde8e60d4f87a0360ef681dd1",
                "deletions": 3,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1254,11 +1254,10 @@ private Date massageDate(Date date, int hourOfDay, int minute, int second) {\n             // Get all the pools available. Only shared pools are considered because only a volume on a shared pools\n             // can be live migrated while the virtual machine stays on the same host.\n             List<StoragePoolVO> storagePools = null;\n-\n             if (srcVolumePool.getClusterId() == null) {\n                 storagePools = _poolDao.findZoneWideStoragePoolsByTags(volume.getDataCenterId(), null);\n             } else {\n-                storagePools = _poolDao.findPoolsByTags(volume.getDataCenterId(), volume.getPodId(), srcVolumePool.getClusterId(), null);\n+                storagePools = _poolDao.findPoolsByTags(volume.getDataCenterId(), srcVolumePool.getPodId(), srcVolumePool.getClusterId(), null);\n             }\n \n             storagePools.remove(srcVolumePool);\n@@ -1274,7 +1273,7 @@ private Date massageDate(Date date, int hourOfDay, int minute, int second) {\n             avoid.addPool(srcVolumePool.getId());\n \n             // Volume stays in the same cluster after migration.\n-            DataCenterDeployment plan = new DataCenterDeployment(volume.getDataCenterId(), volume.getPodId(),\n+            DataCenterDeployment plan = new DataCenterDeployment(volume.getDataCenterId(), srcVolumePool.getPodId(),\n                     srcVolumePool.getClusterId(), null, null, null);\n             VirtualMachineProfile<VMInstanceVO> profile = new VirtualMachineProfileImpl<VMInstanceVO>(vm);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/04a868231311477dde8e60d4f87a0360ef681dd1/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "29272dd33c9be5b032f5a91bcf54f6977327a159",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3545: NPE in listStoragePoolsForMigration api. The volume table no longer holds\nthe pod id, the column is null now. Made a change to get the pod id from the storage pool\non which the volume resides.",
        "parent": "https://github.com/apache/cloudstack/commit/a67cce3d26c5d6e6de0f8c58f2772ff93b666404",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_0833cf1": {
        "bug_id": "cloudstack_0833cf1",
        "commit": "https://github.com/apache/cloudstack/commit/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/plugins/network-elements/juniper-contrail/src/test/java/org/apache/cloudstack/network/contrail/management/MockAccountManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/juniper-contrail/src/test/java/org/apache/cloudstack/network/contrail/management/MockAccountManager.java?ref=0833cf1dd74b03fd2aa805588f05bf555e1ceaf0",
                "deletions": 1,
                "filename": "plugins/network-elements/juniper-contrail/src/test/java/org/apache/cloudstack/network/contrail/management/MockAccountManager.java",
                "patch": "@@ -316,7 +316,7 @@ public boolean moveUser(MoveUserCmd moveUserCmd) {\n     }\n \n     @Override\n-    public boolean moveUser(long id, Long domainId, long accountId) {\n+    public boolean moveUser(long id, Long domainId, Account account) {\n         return false;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/plugins/network-elements/juniper-contrail/src/test/java/org/apache/cloudstack/network/contrail/management/MockAccountManager.java",
                "sha": "f07a74352315401de1086785152be4cf61888514",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/plugins/user-authenticators/ldap/src/main/java/org/apache/cloudstack/ldap/LdapAuthenticator.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/user-authenticators/ldap/src/main/java/org/apache/cloudstack/ldap/LdapAuthenticator.java?ref=0833cf1dd74b03fd2aa805588f05bf555e1ceaf0",
                "deletions": 1,
                "filename": "plugins/user-authenticators/ldap/src/main/java/org/apache/cloudstack/ldap/LdapAuthenticator.java",
                "patch": "@@ -35,6 +35,7 @@\n import com.cloud.user.dao.UserAccountDao;\n import com.cloud.utils.Pair;\n import com.cloud.utils.component.AdapterBase;\n+import com.cloud.utils.exception.CloudRuntimeException;\n \n public class LdapAuthenticator extends AdapterBase implements UserAuthenticator {\n     private static final Logger s_logger = Logger.getLogger(LdapAuthenticator.class.getName());\n@@ -135,7 +136,11 @@ public LdapAuthenticator(final LdapManager ldapManager, final UserAccountDao use\n                 } else {\n                     // not a new user, check if mapped group has changed\n                     if(userAccount.getAccountId() != mapping.getAccountId()) {\n-                        _accountManager.moveUser(userAccount.getId(),userAccount.getDomainId(),mapping.getAccountId());\n+                        final Account mappedAccount = _accountManager.getAccount(mapping.getAccountId());\n+                        if (mappedAccount == null || mappedAccount.getRemoved() != null) {\n+                            throw new CloudRuntimeException(\"Mapped account for users does not exist. Please contact your administrator.\");\n+                        }\n+                        _accountManager.moveUser(userAccount.getId(), userAccount.getDomainId(), mappedAccount);\n                     }\n                     // else { the user hasn't changed in ldap, the ldap group stayed the same, hurray, pass, fun thou self a lot of fun }\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/plugins/user-authenticators/ldap/src/main/java/org/apache/cloudstack/ldap/LdapAuthenticator.java",
                "sha": "2d8fe530d9de7db4587e98479cb76a27b7af03e3",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/server/src/main/java/com/cloud/user/AccountManager.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/user/AccountManager.java?ref=0833cf1dd74b03fd2aa805588f05bf555e1ceaf0",
                "deletions": 4,
                "filename": "server/src/main/java/com/cloud/user/AccountManager.java",
                "patch": "@@ -180,11 +180,12 @@ void buildACLViewSearchCriteria(SearchCriteria<? extends ControlledViewEntity> s\n \n     List<String> listAclGroupsByAccount(Long accountId);\n \n-    public static final String MESSAGE_ADD_ACCOUNT_EVENT = \"Message.AddAccount.Event\";\n+    String MESSAGE_ADD_ACCOUNT_EVENT = \"Message.AddAccount.Event\";\n \n-    public static final String MESSAGE_REMOVE_ACCOUNT_EVENT = \"Message.RemoveAccount.Event\";\n-    public static final ConfigKey<Boolean> UseSecretKeyInResponse = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"use.secret.key.in.response\", \"false\",\n+    String MESSAGE_REMOVE_ACCOUNT_EVENT = \"Message.RemoveAccount.Event\";\n+\n+    ConfigKey<Boolean> UseSecretKeyInResponse = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"use.secret.key.in.response\", \"false\",\n             \"This parameter allows the users to enable or disable of showing secret key as a part of response for various APIs. By default it is set to false.\", true);\n \n-    boolean moveUser(long id, Long domainId, long accountId);\n+    boolean moveUser(long id, Long domainId, Account newAccount);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/server/src/main/java/com/cloud/user/AccountManager.java",
                "sha": "57012e13334c02931821f0e7ca0e2aa4549d9310",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/server/src/main/java/com/cloud/user/AccountManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/user/AccountManagerImpl.java?ref=0833cf1dd74b03fd2aa805588f05bf555e1ceaf0",
                "deletions": 3,
                "filename": "server/src/main/java/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -1817,13 +1817,12 @@ public boolean moveUser(MoveUserCmd cmd) {\n     }\n \n     @Override\n-    public boolean moveUser(long id, Long domainId, long accountId) {\n+    public boolean moveUser(long id, Long domainId, Account newAccount) {\n         UserVO user = getValidUserVO(id);\n         Account oldAccount = _accountDao.findById(user.getAccountId());\n         checkAccountAndAccess(user, oldAccount);\n-        Account newAccount = _accountDao.findById(accountId);\n         checkIfNotMovingAcrossDomains(domainId, newAccount);\n-        return moveUser(user, accountId);\n+        return moveUser(user, newAccount.getId());\n     }\n \n     private boolean moveUser(UserVO user, long newAccountId) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/server/src/main/java/com/cloud/user/AccountManagerImpl.java",
                "sha": "b71d548c4d5ca7231d8dbb39d72562e92cb0dd2b",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/server/src/test/java/com/cloud/user/MockAccountManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/test/java/com/cloud/user/MockAccountManagerImpl.java?ref=0833cf1dd74b03fd2aa805588f05bf555e1ceaf0",
                "deletions": 1,
                "filename": "server/src/test/java/com/cloud/user/MockAccountManagerImpl.java",
                "patch": "@@ -129,7 +129,7 @@ public boolean moveUser(MoveUserCmd moveUserCmd) {\n     }\n \n     @Override\n-    public boolean moveUser(long id, Long domainId, long accountId) {\n+    public boolean moveUser(long id, Long domainId, Account account) {\n         return false;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/0833cf1dd74b03fd2aa805588f05bf555e1ceaf0/server/src/test/java/com/cloud/user/MockAccountManagerImpl.java",
                "sha": "9fece09f35771d8271fbfd1f52b1ac4c56d7f42e",
                "status": "modified"
            }
        ],
        "message": "server: fix potential NPE while ldap authentication (#3418)\n\nThis fixes a potential NPE when a mapped account is not found and\r\nmoving of user to the mapped account is performed. This will now\r\nthrow a more information exception than NPE.\r\n\r\nFixes #2853\r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/f653e6149c53c9316bcccaf23f407c1be19eecb3",
        "repo": "cloudstack",
        "unit_tests": [
            "LdapAuthenticatorTest.java",
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_0d27ac2": {
        "bug_id": "cloudstack_0d27ac2",
        "commit": "https://github.com/apache/cloudstack/commit/0d27ac2e31e0f34601256f5e157adbd078332ff0",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d27ac2e31e0f34601256f5e157adbd078332ff0/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=0d27ac2e31e0f34601256f5e157adbd078332ff0",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1984,7 +1984,7 @@ public Long getPodIdForVlan(long vlanDbId) {\n         }\n \n         HypervisorType hypervisorType = HypervisorType.getType(cmd.getHypervisor());\n-        return listTemplates(cmd.getId(), cmd.getTemplateName(), cmd.getKeyword(), templateFilter, false, null, accountId, cmd.getPageSizeVal().intValue(), cmd.getStartIndex(), cmd.getZoneId(), hypervisorType);\n+        return listTemplates(cmd.getId(), cmd.getTemplateName(), cmd.getKeyword(), templateFilter, false, null, accountId, (cmd.getPageSizeVal() != null) ? cmd.getPageSizeVal().intValue() : null, cmd.getStartIndex(), cmd.getZoneId(), hypervisorType);\n     }\n \n     private List<VMTemplateVO> listTemplates(Long templateId, String name, String keyword, TemplateFilter templateFilter, boolean isIso, Boolean bootable, Long accountId, Integer pageSize, Long startIndex, Long zoneId, HypervisorType hyperType) throws InvalidParameterValueException {",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d27ac2e31e0f34601256f5e157adbd078332ff0/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "c60340eef75bf6b7a147266db91000aa1562f96e",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/jsp/snapshot.jsp",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/jsp/snapshot.jsp?ref=0d27ac2e31e0f34601256f5e157adbd078332ff0",
                "deletions": 0,
                "filename": "ui/jsp/snapshot.jsp",
                "patch": "@@ -144,6 +144,12 @@\n </div>\n <!-- Add Volume Dialog from Snapshot (end) -->\n \n+<!-- snapshot confirmation dialog (begin) -->\n+<div id=\"dialog_confirmation_delete_snapshot\" title=\"Confirmation\" style=\"display:none\">\n+    <p>Please confirm you want to delete the snapshot.</p>   \n+</div>\n+<!-- snapshot confirmation dialog (end) -->\n+\n <!-- Create template from snapshot (begin) -->\n <div id=\"dialog_create_template_from_snapshot\" title=\"Create Template from Snapshot\" style=\"display:none\">\t\n \t<div class=\"dialog_formcontent\">",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/jsp/snapshot.jsp",
                "sha": "30a31e76d7752787df6773634b418a5a4f08c7d6",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/jsp/volume.jsp",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/jsp/volume.jsp?ref=0d27ac2e31e0f34601256f5e157adbd078332ff0",
                "deletions": 0,
                "filename": "ui/jsp/volume.jsp",
                "patch": "@@ -242,6 +242,12 @@\n </div>\n <!-- Create Snapshot Dialog (end) -->\n \n+<!-- snapshot confirmation dialog (begin) -->\n+<div id=\"dialog_confirmation_delete_snapshot\" title=\"Confirmation\" style=\"display:none\">\n+    <p>Please confirm you want to delete the snapshot.</p>   \n+</div>\n+<!-- snapshot confirmation dialog (end) -->\n+\n <!-- Recurring Snapshots Dialog (begin) -->\n <div id=\"dialog_recurring_snapshot\" title=\"Recurring Snapshot\" style=\"display:none;\">\n     <div class=\"dialog_snapshotcontainer\">",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/jsp/volume.jsp",
                "sha": "d7f8278b7362ff896553c1df05eb6d08e4efdfa2",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/scripts/cloud.core.snapshot.js",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/cloud.core.snapshot.js?ref=0d27ac2e31e0f34601256f5e157adbd078332ff0",
                "deletions": 2,
                "filename": "ui/scripts/cloud.core.snapshot.js",
                "patch": "@@ -19,7 +19,8 @@\n function afterLoadSnapshotJSP() {\n     //initialize dialog\r\n     initDialog(\"dialog_add_volume_from_snapshot\");       \r\n-    initDialog(\"dialog_create_template_from_snapshot\", 400);    \n+    initDialog(\"dialog_create_template_from_snapshot\", 400);  \n+\tinitDialog(\"dialog_confirmation_delete_snapshot\");\t\n     \n     //populate dropdown\n     $.ajax({\r\n@@ -123,7 +124,8 @@ var snapshotActionMap = {\n     \"Delete Snapshot\": {              \n         api: \"deleteSnapshot\",     \n         isAsyncJob: true,\n-        asyncJobResponse: \"deletesnapshotresponse\",        \n+        asyncJobResponse: \"deletesnapshotresponse\",    \n+\t\tdialogBeforeActionFn : doSnapshotDelete,\n         inProcessText: \"Deleting snapshot....\",\n         afterActionSeccessFn: function(json, $midmenuItem1, id){            \n             $midmenuItem1.remove();\n@@ -140,6 +142,22 @@ var snapshotActionMap = {\n         afterActionSeccessFn: function(json, $midmenuItem1, id){}\n     }\n }   \n+\n+function doSnapshotDelete($actionLink, $thisTab, $midmenuItem1) {\n+\t$(\"#dialog_confirmation_delete_snapshot\")\t\n+    .dialog('option', 'buttons', { \t\t\t\t\t\t\n+\t    \"Confirm\": function() { \n+\t\t    $(this).dialog(\"close\"); \t\n+\t\t\tvar id = $thisTab.data(\"jsonObj\").id;\n+\t\t\tvar apiCommand = \"command=deleteSnapshot&id=\"+id;                      \n+            doActionToTab(id, $actionLink, apiCommand, $midmenuItem1, $thisTab); \n+\t    }, \n+\t    \"Cancel\": function() { \n+\t\t    $(this).dialog(\"close\"); \n+\t\t\t\n+\t    } \n+    }).dialog(\"open\");\n+}\n \r\n function doCreateVolumeFromSnapshotInSnapshotPage($actionLink, $detailsTab, $midmenuItem1){ \r\n     var jsonObj = $detailsTab.data(\"jsonObj\");\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/scripts/cloud.core.snapshot.js",
                "sha": "7a963b8fa1136340c73f407784a30fa1a0ac1c40",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/scripts/cloud.core.volume.js",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/cloud.core.volume.js?ref=0d27ac2e31e0f34601256f5e157adbd078332ff0",
                "deletions": 3,
                "filename": "ui/scripts/cloud.core.volume.js",
                "patch": "@@ -23,7 +23,8 @@ function afterLoadVolumeJSP() {\n     initDialog(\"dialog_add_volume\");\t\r\n     initDialog(\"dialog_attach_volume\");\t\r\n     initDialog(\"dialog_add_volume_from_snapshot\");\t\n-    initDialog(\"dialog_create_template_from_snapshot\", 400);    \r\n+    initDialog(\"dialog_create_template_from_snapshot\", 400);    \n+\tinitDialog(\"dialog_confirmation_delete_snapshot\");\r\n \t        \r\n     $.ajax({\r\n         data: createURL(\"command=listOsTypes\"),\r\n@@ -888,7 +889,8 @@ var volumeSnapshotActionMap = {\n     \"Delete Snapshot\": {              \n         api: \"deleteSnapshot\",     \n         isAsyncJob: true,\n-        asyncJobResponse: \"deletesnapshotresponse\",        \n+        asyncJobResponse: \"deletesnapshotresponse\",\n+\t\tdialogBeforeActionFn : doSnapshotDelete,\n         inProcessText: \"Deleting snapshot....\",\n         afterActionSeccessFn: function(json, id, $subgridItem) {                 \n             $subgridItem.slideUp(\"slow\", function() {\n@@ -904,7 +906,23 @@ var volumeSnapshotActionMap = {\n         inProcessText: \"Creating Template....\",\n         afterActionSeccessFn: function(json, id, $subgridItem) {}            \n     }\n-}  \r\n+}  \n+\n+function doSnapshotDelete($actionLink, $subgridItem) {\n+\t$(\"#dialog_confirmation_delete_snapshot\")\t\n+    .dialog('option', 'buttons', { \t\t\t\t\t\t\n+\t    \"Confirm\": function() { \n+\t\t    $(this).dialog(\"close\"); \t\n+\t\t\tvar id = $subgridItem.data(\"jsonObj\").id;\n+\t\t\tvar apiCommand = \"command=deleteSnapshot&id=\"+id;                      \n+            doActionToSubgridItem(id, $actionLink, apiCommand, $subgridItem); \n+\t    }, \n+\t    \"Cancel\": function() { \n+\t\t    $(this).dialog(\"close\"); \n+\t\t\t\n+\t    } \n+    }).dialog(\"open\");\n+}\r\n                                               \r\n function doCreateVolumeFromSnapshotInVolumePage($actionLink, $subgridItem) { \r\n     var jsonObj = $subgridItem.data(\"jsonObj\");\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d27ac2e31e0f34601256f5e157adbd078332ff0/ui/scripts/cloud.core.volume.js",
                "sha": "eda95a42c55f333984a383bbee56613a2f15e526",
                "status": "modified"
            }
        ],
        "message": "bug 5920: added confirmation dialog before allowing user to delete snapshots\n\n- Fixed a NPE when listing templates.",
        "parent": "https://github.com/apache/cloudstack/commit/76bc3e21e62931c3c81d70e81abb9ae21dfada05",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_0d580cc": {
        "bug_id": "cloudstack_0d580cc",
        "commit": "https://github.com/apache/cloudstack/commit/0d580ccb26e55f0d17e04a98f470116bef6073b2",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d580ccb26e55f0d17e04a98f470116bef6073b2/engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java?ref=0d580ccb26e55f0d17e04a98f470116bef6073b2",
                "deletions": 2,
                "filename": "engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java",
                "patch": "@@ -463,15 +463,19 @@ protected Void createTemplateCallback(AsyncCallbackDispatcher<TemplateServiceImp\n         if (callbackResult.isFailed()) {\n             template.processEvent(ObjectInDataStoreStateMachine.Event.OperationFailed);\n             result.setResult(callbackResult.getResult());\n-            parentCallback.complete(result);\n+            if ( parentCallback != null ){\n+                parentCallback.complete(result);\n+            }\n             return null;\n         }\n \n         try {\n             template.processEvent(ObjectInDataStoreStateMachine.Event.OperationSuccessed);\n         } catch (Exception e) {\n             result.setResult(e.toString());\n-            parentCallback.complete(result);\n+            if ( parentCallback != null ){\n+                parentCallback.complete(result);\n+            }\n             return null;\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d580ccb26e55f0d17e04a98f470116bef6073b2/engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java",
                "sha": "bf8155bec4c324a35ed330c6b3969120fe88c460",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d580ccb26e55f0d17e04a98f470116bef6073b2/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=0d580ccb26e55f0d17e04a98f470116bef6073b2",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -736,7 +736,7 @@ public DataStore createLocalStorage(Host host, StoragePoolInfo pInfo) throws Con\n                         DataStoreRole.Primary);\n             }\n \n-            HostScope scope = new HostScope(host.getId(), pool.getDataCenterId());\n+            HostScope scope = new HostScope(host.getId(), host.getDataCenterId());\n             lifeCycle.attachHost(store, scope, pInfo);\n         } catch (Exception e) {\n             s_logger.warn(\"Unable to setup the local storage pool for \" + host, e);",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d580ccb26e55f0d17e04a98f470116bef6073b2/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "f03e9f99e04c6012d3a38bd7124c8b17652f1556",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d580ccb26e55f0d17e04a98f470116bef6073b2/tools/devcloud/devcloud_s3.cfg",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/devcloud/devcloud_s3.cfg?ref=0d580ccb26e55f0d17e04a98f470116bef6073b2",
                "deletions": 1,
                "filename": "tools/devcloud/devcloud_s3.cfg",
                "patch": "@@ -106,7 +106,7 @@\n             ],\n             \"cacheStorages\": [\n                 {\n-                    \"url\": \"nfs://192.168.56.10/opt/storage/cache\",\n+                    \"url\": \"nfs://192.168.56.10/opt/storage/secondary\",\n                     \"providerName\": \"NFS\",\n                     \"details\": [\n                     ]",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d580ccb26e55f0d17e04a98f470116bef6073b2/tools/devcloud/devcloud_s3.cfg",
                "sha": "18efec35d37517ea23980c58f8a7f5019f3f9e10",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/0d580ccb26e55f0d17e04a98f470116bef6073b2/tools/marvin/marvin/deployDataCenter.py",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/marvin/marvin/deployDataCenter.py?ref=0d580ccb26e55f0d17e04a98f470116bef6073b2",
                "deletions": 3,
                "filename": "tools/marvin/marvin/deployDataCenter.py",
                "patch": "@@ -138,10 +138,28 @@ def createSecondaryStorages(self, secondaryStorages, zoneId):\n         if secondaryStorages is None:\n             return\n         for secondary in secondaryStorages:\n-            secondarycmd = addSecondaryStorage.addSecondaryStorageCmd()\n+            secondarycmd = addImageStore.addImageStoreCmd()\n             secondarycmd.url = secondary.url\n-            secondarycmd.zoneid = zoneId\n-            self.apiClient.addSecondaryStorage(secondarycmd)\n+            secondarycmd.provider = secondary.providerName\n+            secondarycmd.details = []\n+            for item in secondary.details:\n+                secondarycmd.details.append(item.__dict__)\n+            if secondarycmd.provider == \"NFS\":\n+                secondarycmd.zoneid = zoneId\n+            self.apiClient.addImageStore(secondarycmd)\n+\n+    def createCacheStorages(self, cacheStorages, zoneId):\n+        if cacheStorages is None:\n+            return\n+        for cache in cacheStorages:\n+            cachecmd = createCacheStore.createCacheStoreCmd()\n+            cachecmd.url = cache.url\n+            cachecmd.provider = cache.providerName\n+            cachecmd.zoneid = zoneId\n+            cachecmd.details = []\n+            for item in cache.details:\n+                cachecmd.details.append(item.__dict__)\n+            self.apiClient.createCacheStore(cachecmd)\n \n     def createnetworks(self, networks, zoneId):\n         if networks is None:\n@@ -328,6 +346,7 @@ def createZones(self, zones):\n                                         zoneId)\n \n             self.createSecondaryStorages(zone.secondaryStorages, zoneId)\n+            self.createCacheStorages(zone.cacheStorages, zoneId)            \n             \n             enabled = getattr(zone, 'enabled', 'True')\n             if enabled == 'True' or enabled is None:",
                "raw_url": "https://github.com/apache/cloudstack/raw/0d580ccb26e55f0d17e04a98f470116bef6073b2/tools/marvin/marvin/deployDataCenter.py",
                "sha": "dd6db051e8d28661f939f1bb0fdabcaada4b5547",
                "status": "modified"
            }
        ],
        "message": "Fix NPE in adding host and also put back lost change in deployDataCenter\ndue to rebase with master.",
        "parent": "https://github.com/apache/cloudstack/commit/1bd216fc488521834c12e366ddf4b7f48287ea42",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_11d0336": {
        "bug_id": "cloudstack_11d0336",
        "commit": "https://github.com/apache/cloudstack/commit/11d0336803048b156731da15239147e7f6b4d03a",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/core/src/com/cloud/agent/api/storage/AbstractDownloadCommand.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/agent/api/storage/AbstractDownloadCommand.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 9,
                "filename": "core/src/com/cloud/agent/api/storage/AbstractDownloadCommand.java",
                "patch": "@@ -31,8 +31,8 @@\n     protected AbstractDownloadCommand() {\n     }\n \n-    protected AbstractDownloadCommand(String name, String url, ImageFormat format, Long accountId) {\n-        assert (url != null);\n+    protected AbstractDownloadCommand(final String name, String url, final ImageFormat format, final Long accountId) {\n+        assert url != null;\n         url = url.replace('\\\\', '/');\n \n         this.url = url;\n@@ -41,14 +41,14 @@ protected AbstractDownloadCommand(String name, String url, ImageFormat format, L\n         this.name = name;\n     }\n \n-    protected AbstractDownloadCommand(AbstractDownloadCommand that) {\n+    protected AbstractDownloadCommand(final AbstractDownloadCommand that) {\n         super(that);\n-        assert (that.url != null);\n+        assert that.url != null;\n \n-        this.url = that.url.replace('\\\\', '/');\n-        this.format = that.format;\n-        this.accountId = that.accountId;\n-        this.name = that.name;\n+        url = that.url.replace('\\\\', '/');\n+        format = that.format;\n+        accountId = that.accountId;\n+        name = that.name;\n     }\n \n     public String getUrl() {\n@@ -73,7 +73,7 @@ public boolean executeInSequence() {\n     }\n \n     public void setUrl(String url) {\n-        assert (url != null);\n+        assert url != null;\n         url = url.replace('\\\\', '/');\n         this.url = url;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/core/src/com/cloud/agent/api/storage/AbstractDownloadCommand.java",
                "sha": "0670eefd9449ae3e9e4a3c0627c5fad87c253253",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/core/src/com/cloud/agent/api/storage/PrimaryStorageDownloadCommand.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/agent/api/storage/PrimaryStorageDownloadCommand.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 17,
                "filename": "core/src/com/cloud/agent/api/storage/PrimaryStorageDownloadCommand.java",
                "patch": "@@ -37,22 +37,13 @@\n     String primaryStorageUrl;\n \n     protected PrimaryStorageDownloadCommand() {\n-\n-    }\n-\n-    public PrimaryStorageDownloadCommand(String url, StoragePool pool, int wait) {\n-        super(null, url, null, null);\n-        this.poolId = pool.getId();\n-        this.poolUuid = pool.getUuid();\n-        this.primaryPool = new StorageFilerTO(pool);\n-        setWait(wait);\n     }\n \n-    public PrimaryStorageDownloadCommand(String name, String url, ImageFormat format, long accountId, StoragePool pool, int wait) {\n+    public PrimaryStorageDownloadCommand(final String name, final String url, final ImageFormat format, final long accountId, final StoragePool pool, final int wait) {\n         super(name, url, format, accountId);\n-        this.poolId = pool.getId();\n-        this.poolUuid = pool.getUuid();\n-        this.primaryPool = new StorageFilerTO(pool);\n+        poolId = pool.getId();\n+        poolUuid = pool.getUuid();\n+        primaryPool = new StorageFilerTO(pool);\n         setWait(wait);\n     }\n \n@@ -68,23 +59,23 @@ public StorageFilerTO getPool() {\n         return primaryPool;\n     }\n \n-    public void setLocalPath(String path) {\n-        this.localPath = path;\n+    public void setLocalPath(final String path) {\n+        localPath = path;\n     }\n \n     public String getLocalPath() {\n         return localPath;\n     }\n \n-    public void setSecondaryStorageUrl(String url) {\n+    public void setSecondaryStorageUrl(final String url) {\n         secondaryStorageUrl = url;\n     }\n \n     public String getSecondaryStorageUrl() {\n         return secondaryStorageUrl;\n     }\n \n-    public void setPrimaryStorageUrl(String url) {\n+    public void setPrimaryStorageUrl(final String url) {\n         primaryStorageUrl = url;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/core/src/com/cloud/agent/api/storage/PrimaryStorageDownloadCommand.java",
                "sha": "ce8ed217a562e3f1a4d4e722c42c0720cdc186b9",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 10,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "patch": "@@ -441,12 +441,6 @@ public Answer executeRequest(final Command cmd) {\n \n         if (cmd instanceof NetworkElementCommand) {\n             return _vrResource.executeRequest((NetworkElementCommand)cmd);\n-        } else if (clazz == AttachVolumeCommand.class) {\n-            return execute((AttachVolumeCommand)cmd);\n-        } else if (clazz == AttachIsoCommand.class) {\n-            return execute((AttachIsoCommand) cmd);\n-        } else if (clazz == UpgradeSnapshotCommand.class) {\n-            return execute((UpgradeSnapshotCommand)cmd);\n         } else if (clazz == GetStorageStatsCommand.class) {\n             return execute((GetStorageStatsCommand)cmd);\n         } else if (clazz == PrimaryStorageDownloadCommand.class) {\n@@ -2751,7 +2745,7 @@ void destroyVDIbyNameLabel(final Connection conn, final String nameLabel) {\n         }\n     }\n \n-    String copy_vhd_from_secondarystorage(final Connection conn, final String mountpoint, final String sruuid, final int wait) {\n+    public String copyVhdFromSecondaryStorage(final Connection conn, final String mountpoint, final String sruuid, final int wait) {\n         final String nameLabel = \"cloud-\" + UUID.randomUUID().toString();\n         final String results =\n                 callHostPluginAsync(conn, \"vmopspremium\", \"copy_vhd_from_secondarystorage\", wait, \"mountpoint\", mountpoint, \"sruuid\", sruuid, \"namelabel\", nameLabel);\n@@ -2794,7 +2788,7 @@ public PrimaryStorageDownloadAnswer execute(final PrimaryStorageDownloadCommand\n             }\n             final String pUuid = poolsr.getUuid(conn);\n             final boolean isISCSI = IsISCSI(poolsr.getType(conn));\n-            final String uuid = copy_vhd_from_secondarystorage(conn, tmplpath, pUuid, wait);\n+            final String uuid = copyVhdFromSecondaryStorage(conn, tmplpath, pUuid, wait);\n             final VDI tmpl = getVDIbyUuid(conn, uuid);\n             final VDI snapshotvdi = tmpl.snapshot(conn, new HashMap<String, String>());\n             final String snapshotUuid = snapshotvdi.getUuid(conn);\n@@ -6589,7 +6583,7 @@ protected Answer execute(final AttachIsoCommand cmd) {\n         }\n     }\n \n-    boolean IsISCSI(final String type) {\n+    public boolean IsISCSI(final String type) {\n         return SRType.LVMOHBA.equals(type) || SRType.LVMOISCSI.equals(type) || SRType.LVM.equals(type);\n     }\n \n@@ -6838,7 +6832,7 @@ protected boolean postCreatePrivateTemplate(final Connection conn, final String\n         return success;\n     }\n \n-    protected String getVhdParent(final Connection conn, final String primaryStorageSRUuid, final String snapshotUuid, final Boolean isISCSI) {\n+    public String getVhdParent(final Connection conn, final String primaryStorageSRUuid, final String snapshotUuid, final Boolean isISCSI) {\n         final String parentUuid =\n                 callHostPlugin(conn, \"vmopsSnapshot\", \"getVhdParent\", \"primaryStorageSRUuid\", primaryStorageSRUuid, \"snapshotUuid\", snapshotUuid, \"isISCSI\",\n                         isISCSI.toString());",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "sha": "c412b546efb04e5f8f1b8674f77a34763ea32b61",
                "status": "modified"
            },
            {
                "additions": 69,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixGetStorageStatsCommandWrapper.java",
                "changes": 69,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixGetStorageStatsCommandWrapper.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 0,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixGetStorageStatsCommandWrapper.java",
                "patch": "@@ -0,0 +1,69 @@\n+//\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+//\n+\n+package com.cloud.hypervisor.xenserver.resource.wrapper;\n+\n+import java.util.Set;\n+\n+import org.apache.log4j.Logger;\n+import org.apache.xmlrpc.XmlRpcException;\n+\n+import com.cloud.agent.api.Answer;\n+import com.cloud.agent.api.GetStorageStatsAnswer;\n+import com.cloud.agent.api.GetStorageStatsCommand;\n+import com.cloud.hypervisor.xenserver.resource.CitrixResourceBase;\n+import com.cloud.resource.CommandWrapper;\n+import com.xensource.xenapi.Connection;\n+import com.xensource.xenapi.SR;\n+import com.xensource.xenapi.Types.XenAPIException;\n+\n+public final class CitrixGetStorageStatsCommandWrapper extends CommandWrapper<GetStorageStatsCommand, Answer, CitrixResourceBase> {\n+\n+    private static final Logger s_logger = Logger.getLogger(CitrixGetStorageStatsCommandWrapper.class);\n+\n+    @Override\n+    public Answer execute(final GetStorageStatsCommand command, final CitrixResourceBase citrixResourceBase) {\n+        final Connection conn = citrixResourceBase.getConnection();\n+        try {\n+            final Set<SR> srs = SR.getByNameLabel(conn, command.getStorageId());\n+            if (srs.size() != 1) {\n+                final String msg = \"There are \" + srs.size() + \" storageid: \" + command.getStorageId();\n+                s_logger.warn(msg);\n+                return new GetStorageStatsAnswer(command, msg);\n+            }\n+            final SR sr = srs.iterator().next();\n+            sr.scan(conn);\n+            final long capacity = sr.getPhysicalSize(conn);\n+            final long used = sr.getPhysicalUtilisation(conn);\n+            return new GetStorageStatsAnswer(command, capacity, used);\n+        } catch (final XenAPIException e) {\n+            final String msg = \"GetStorageStats Exception:\" + e.toString() + \"host:\" + citrixResourceBase.getHost().getUuid() + \"storageid: \" + command.getStorageId();\n+            s_logger.warn(msg);\n+            return new GetStorageStatsAnswer(command, msg);\n+        } catch (final XmlRpcException e) {\n+            final String msg = \"GetStorageStats Exception:\" + e.getMessage() + \"host:\" + citrixResourceBase.getHost().getUuid() + \"storageid: \" + command.getStorageId();\n+            s_logger.warn(msg);\n+            return new GetStorageStatsAnswer(command, msg);\n+        }  catch (final Exception e) {\n+            final String msg = \"GetStorageStats Exception:\" + e.getMessage() + \"host:\" + citrixResourceBase.getHost().getUuid() + \"storageid: \" + command.getStorageId();\n+            s_logger.warn(msg);\n+            return new GetStorageStatsAnswer(command, msg);\n+        }\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixGetStorageStatsCommandWrapper.java",
                "sha": "e0001ccd9feba987a93101e7ce7ec984ca6e0070",
                "status": "added"
            },
            {
                "additions": 83,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixPrimaryStorageDownloadCommandWrapper.java",
                "changes": 83,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixPrimaryStorageDownloadCommandWrapper.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 0,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixPrimaryStorageDownloadCommandWrapper.java",
                "patch": "@@ -0,0 +1,83 @@\n+//\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+//\n+\n+package com.cloud.hypervisor.xenserver.resource.wrapper;\n+\n+import java.net.URI;\n+import java.util.HashMap;\n+import java.util.Set;\n+\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.agent.api.Answer;\n+import com.cloud.agent.api.storage.PrimaryStorageDownloadAnswer;\n+import com.cloud.agent.api.storage.PrimaryStorageDownloadCommand;\n+import com.cloud.hypervisor.xenserver.resource.CitrixResourceBase;\n+import com.cloud.resource.CommandWrapper;\n+import com.xensource.xenapi.Connection;\n+import com.xensource.xenapi.SR;\n+import com.xensource.xenapi.VDI;\n+\n+public final class CitrixPrimaryStorageDownloadCommandWrapper extends CommandWrapper<PrimaryStorageDownloadCommand, Answer, CitrixResourceBase> {\n+\n+    private static final Logger s_logger = Logger.getLogger(CitrixPrimaryStorageDownloadCommandWrapper.class);\n+\n+    @Override\n+    public Answer execute(final PrimaryStorageDownloadCommand command, final CitrixResourceBase citrixResourceBase) {\n+        final String tmplturl = command.getUrl();\n+        final String poolName = command.getPoolUuid();\n+        final int wait = command.getWait();\n+        try {\n+            final URI uri = new URI(tmplturl);\n+            final String tmplpath = uri.getHost() + \":\" + uri.getPath();\n+            final Connection conn = citrixResourceBase.getConnection();\n+            SR poolsr = null;\n+            final Set<SR> srs = SR.getByNameLabel(conn, poolName);\n+            if (srs.size() != 1) {\n+                final String msg = \"There are \" + srs.size() + \" SRs with same name: \" + poolName;\n+                s_logger.warn(msg);\n+                return new PrimaryStorageDownloadAnswer(msg);\n+            } else {\n+                poolsr = srs.iterator().next();\n+            }\n+            final String pUuid = poolsr.getUuid(conn);\n+            final boolean isISCSI = citrixResourceBase.IsISCSI(poolsr.getType(conn));\n+            final String uuid = citrixResourceBase.copyVhdFromSecondaryStorage(conn, tmplpath, pUuid, wait);\n+            final VDI tmpl = citrixResourceBase.getVDIbyUuid(conn, uuid);\n+            final VDI snapshotvdi = tmpl.snapshot(conn, new HashMap<String, String>());\n+            final String snapshotUuid = snapshotvdi.getUuid(conn);\n+            snapshotvdi.setNameLabel(conn, \"Template \" + command.getName());\n+            final String parentuuid = citrixResourceBase.getVhdParent(conn, pUuid, snapshotUuid, isISCSI);\n+            final VDI parent = citrixResourceBase.getVDIbyUuid(conn, parentuuid);\n+            final Long phySize = parent.getPhysicalUtilisation(conn);\n+            tmpl.destroy(conn);\n+            poolsr.scan(conn);\n+            try {\n+                Thread.sleep(5000);\n+            } catch (final Exception e) {\n+            }\n+            return new PrimaryStorageDownloadAnswer(snapshotvdi.getUuid(conn), phySize);\n+        } catch (final Exception e) {\n+            final String msg = \"Catch Exception \" + e.getClass().getName() + \" on host:\" + citrixResourceBase.getHost().getUuid() + \" for template: \" + tmplturl + \" due to \"\n+                    + e.toString();\n+            s_logger.warn(msg, e);\n+            return new PrimaryStorageDownloadAnswer(msg);\n+        }\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixPrimaryStorageDownloadCommandWrapper.java",
                "sha": "270520777d4a3ef6a85ba0aaec7b52befd491a5b",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapper.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapper.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 0,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapper.java",
                "patch": "@@ -30,6 +30,7 @@\n import com.cloud.agent.api.CreateStoragePoolCommand;\n import com.cloud.agent.api.DeleteStoragePoolCommand;\n import com.cloud.agent.api.GetHostStatsCommand;\n+import com.cloud.agent.api.GetStorageStatsCommand;\n import com.cloud.agent.api.GetVmDiskStatsCommand;\n import com.cloud.agent.api.GetVmStatsCommand;\n import com.cloud.agent.api.MigrateCommand;\n@@ -44,6 +45,7 @@\n import com.cloud.agent.api.proxy.WatchConsoleProxyLoadCommand;\n import com.cloud.agent.api.storage.CreateCommand;\n import com.cloud.agent.api.storage.DestroyCommand;\n+import com.cloud.agent.api.storage.PrimaryStorageDownloadCommand;\n import com.cloud.agent.api.storage.ResizeVolumeCommand;\n import com.cloud.resource.CommandWrapper;\n import com.cloud.resource.RequestWrapper;\n@@ -89,6 +91,8 @@ private void init() {\n         map.put(AttachVolumeCommand.class, new CitrixAttachVolumeCommandWrapper());\n         map.put(AttachIsoCommand.class, new CitrixAttachIsoCommandWrapper());\n         map.put(UpgradeSnapshotCommand.class, new CitrixUpgradeSnapshotCommandWrapper());\n+        map.put(GetStorageStatsCommand.class, new CitrixGetStorageStatsCommandWrapper());\n+        map.put(PrimaryStorageDownloadCommand.class, new CitrixPrimaryStorageDownloadCommandWrapper());\n     }\n \n     public static CitrixRequestWrapper getInstance() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapper.java",
                "sha": "c31c340c6081a85c884c9486cddf7897fee95dce",
                "status": "modified"
            },
            {
                "additions": 40,
                "blob_url": "https://github.com/apache/cloudstack/blob/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/test/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapperTest.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/test/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapperTest.java?ref=11d0336803048b156731da15239147e7f6b4d03a",
                "deletions": 0,
                "filename": "plugins/hypervisors/xenserver/test/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapperTest.java",
                "patch": "@@ -25,6 +25,7 @@\n import com.cloud.agent.api.CreateStoragePoolCommand;\n import com.cloud.agent.api.DeleteStoragePoolCommand;\n import com.cloud.agent.api.GetHostStatsCommand;\n+import com.cloud.agent.api.GetStorageStatsCommand;\n import com.cloud.agent.api.GetVmDiskStatsCommand;\n import com.cloud.agent.api.GetVmStatsCommand;\n import com.cloud.agent.api.MigrateCommand;\n@@ -41,11 +42,14 @@\n import com.cloud.agent.api.storage.CreateAnswer;\n import com.cloud.agent.api.storage.CreateCommand;\n import com.cloud.agent.api.storage.DestroyCommand;\n+import com.cloud.agent.api.storage.PrimaryStorageDownloadCommand;\n import com.cloud.agent.api.storage.ResizeVolumeCommand;\n+import com.cloud.agent.api.to.DataStoreTO;\n import com.cloud.agent.api.to.StorageFilerTO;\n import com.cloud.agent.api.to.VirtualMachineTO;\n import com.cloud.hypervisor.xenserver.resource.CitrixResourceBase;\n import com.cloud.hypervisor.xenserver.resource.XsHost;\n+import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.storage.Storage.StoragePoolType;\n import com.cloud.storage.VMTemplateStorageResourceAssoc;\n import com.cloud.vm.DiskProfile;\n@@ -400,6 +404,42 @@ public void testUpgradeSnapshotCommandNo21() {\n \n         assertTrue(answer.getResult());\n     }\n+\n+    @Test\n+    public void testGetStorageStatsCommand() {\n+        final XsHost xsHost = Mockito.mock(XsHost.class);\n+        final DataStoreTO store = Mockito.mock(DataStoreTO.class);\n+\n+        final GetStorageStatsCommand storageStatsCommand = new GetStorageStatsCommand(store);\n+\n+        final CitrixRequestWrapper wrapper = CitrixRequestWrapper.getInstance();\n+        assertNotNull(wrapper);\n+\n+        when(citrixResourceBase.getHost()).thenReturn(xsHost);\n+\n+        final Answer answer = wrapper.execute(storageStatsCommand, citrixResourceBase);\n+        verify(citrixResourceBase, times(1)).getConnection();\n+\n+        assertFalse(answer.getResult());\n+    }\n+\n+    @Test\n+    public void testPrimaryStorageDownloadCommand() {\n+        final XsHost xsHost = Mockito.mock(XsHost.class);\n+        final StoragePoolVO poolVO = Mockito.mock(StoragePoolVO.class);\n+\n+        final PrimaryStorageDownloadCommand storageDownloadCommand = new PrimaryStorageDownloadCommand(\"Test\", \"http://127.0.0.1\", ImageFormat.VHD, 1l, poolVO, 200);\n+\n+        final CitrixRequestWrapper wrapper = CitrixRequestWrapper.getInstance();\n+        assertNotNull(wrapper);\n+\n+        when(citrixResourceBase.getHost()).thenReturn(xsHost);\n+\n+        final Answer answer = wrapper.execute(storageDownloadCommand, citrixResourceBase);\n+        verify(citrixResourceBase, times(1)).getConnection();\n+\n+        assertFalse(answer.getResult());\n+    }\n }\n \n class NotAValidCommand extends Command {",
                "raw_url": "https://github.com/apache/cloudstack/raw/11d0336803048b156731da15239147e7f6b4d03a/plugins/hypervisors/xenserver/test/com/cloud/hypervisor/xenserver/resource/wrapper/CitrixRequestWrapperTest.java",
                "sha": "187384271f5c2af477839457440ee43046aad67b",
                "status": "modified"
            }
        ],
        "message": "Refactoring GetStorageStatsCommand and PrimaryStorageDownloadCommand to cope with the new design\nFix the NPE in the constructor that was never used\n  - Basic tests added for all changes",
        "parent": "https://github.com/apache/cloudstack/commit/ea374b6a2ffba8c5ea2222cf1cffce10dbbdff92",
        "repo": "cloudstack",
        "unit_tests": [
            "CitrixResourceBaseTest.java",
            "CitrixRequestWrapperTest.java"
        ]
    },
    "cloudstack_12adbff": {
        "bug_id": "cloudstack_12adbff",
        "commit": "https://github.com/apache/cloudstack/commit/12adbffbea77b6a21aa8350d0b0effd1c7fb9702",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/12adbffbea77b6a21aa8350d0b0effd1c7fb9702/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=12adbffbea77b6a21aa8350d0b0effd1c7fb9702",
                "deletions": 4,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -750,11 +750,14 @@ protected boolean cleanupAccount(AccountVO account, long callerUserId, Account c\n \n             // release account specific acquired portable IP's. Since all the portable IP's must have been already\n             // disassociated with VPC/guest network (due to deletion), so just mark portable IP as free.\n-            List<? extends IpAddress> portableIpsToRelease = _ipAddressDao.listByAccount(accountId);\n-            for (IpAddress ip : portableIpsToRelease) {\n-                s_logger.debug(\"Releasing portable ip \" + ip + \" as a part of account id=\" + accountId + \" cleanup\");\n-                _ipAddrMgr.releasePortableIpAddress(ip.getId());\n+            List<? extends IpAddress> ipsToRelease = _ipAddressDao.listByAccount(accountId);\n+            for (IpAddress ip : ipsToRelease) {\n+                if (ip.isPortable()) {\n+                    s_logger.debug(\"Releasing portable ip \" + ip + \" as a part of account id=\" + accountId + \" cleanup\");\n+                    _ipAddrMgr.releasePortableIpAddress(ip.getId());\n+                }\n             }\n+\n             // release dedication if any\n             List<DedicatedResourceVO> dedicatedResources = _dedicatedDao.listByAccountId(accountId);\n             if (dedicatedResources != null && !dedicatedResources.isEmpty()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/12adbffbea77b6a21aa8350d0b0effd1c7fb9702/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "20a6242cfd64f405e39741d6d240779dc5c51b94",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-5517: NPE observed during \"release portable IPs\" as part of\naccount cleanup\n\nensure proper portable ip address are released  as part of account\ncleanup",
        "parent": "https://github.com/apache/cloudstack/commit/c6c299523151345bbc3c97614c8ac995676e229b",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_14abe4c": {
        "bug_id": "cloudstack_14abe4c",
        "commit": "https://github.com/apache/cloudstack/commit/14abe4cb2dbdc9293926ec706b01ab068d03c34d",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/14abe4cb2dbdc9293926ec706b01ab068d03c34d/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java?ref=14abe4cb2dbdc9293926ec706b01ab068d03c34d",
                "deletions": 1,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "patch": "@@ -2679,7 +2679,8 @@ protected StartAnswer execute(StartCommand cmd) {\n                 ManagedObjectReference environmentBrowser =\n                         context.getVimClient().getMoRefProp(computeMor, \"environmentBrowser\");\n                 HostCapability hostCapability = context.getService().queryTargetCapabilities(environmentBrowser, hostMor);\n-                if (hostCapability.isNestedHVSupported()) {\n+                Boolean nestedHvSupported = hostCapability.isNestedHVSupported();\n+                if (nestedHvSupported != null && nestedHvSupported.booleanValue()) {\n                     s_logger.debug(\"Hypervisor supports nested virtualization, enabling for VM \" + vmSpec.getName());\n                     vmConfigSpec.setNestedHVEnabled(true);\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/14abe4cb2dbdc9293926ec706b01ab068d03c34d/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "sha": "c61e171f7cad80c5ae923eb68996e97fad903902",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4155 [VMWARE] Failed to deploy VM with NPE when vmware.nested.virtualization is enabled to true\n\nSigned-off-by: Sateesh Chodapuneedi <sateesh@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/59f944d7c33d75561f0ac6a53255bfa0497c925a",
        "repo": "cloudstack",
        "unit_tests": [
            "VmwareResourceTest.java"
        ]
    },
    "cloudstack_15b11a3": {
        "bug_id": "cloudstack_15b11a3",
        "commit": "https://github.com/apache/cloudstack/commit/15b11a3b27800afcb598f8e97416f0d826cac491",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -4776,8 +4776,8 @@ protected VirtualMachine retrieve() {\n         final VMInstanceVO vm = _entityMgr.findById(VMInstanceVO.class, work.getVmId());\n         if (vm == null) {\n             s_logger.info(\"Unable to find vm \" + work.getVmId());\n+            throw new CloudRuntimeException(\"Unable to find VM id=\" + work.getVmId());\n         }\n-        assert vm != null;\n \n         orchestrateStop(vm.getUuid(), work.isCleanup());\n         return new Pair<JobInfo.Status, String>(JobInfo.Status.SUCCEEDED, null);",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "8413ce9f6e9eb5c4d4cdda5c26d2a7ddd682c1fe",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/python/lib/cloudutils/utilities.py",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/python/lib/cloudutils/utilities.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 2,
                "filename": "python/lib/cloudutils/utilities.py",
                "patch": "@@ -216,8 +216,8 @@ def isKVMEnabled(self):\n class serviceOpsRedhat7(serviceOps):\n     def isServiceRunning(self, servicename):\n         try:\n-            o = bash(\"systemctl status \" + servicename)\n-            if \"running\" in o.getStdout() or \"start\" in o.getStdout() or \"Running\" in o.getStdout():\n+            o = bash(\"systemctl is-active \" + servicename)\n+            if \"inactive\" not in o.getStdout():\n                 return True\n             else:\n                 return False",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/python/lib/cloudutils/utilities.py",
                "sha": "b9d47630cc60cbabe11d09337508ac1a7a46b810",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/server/src/com/cloud/server/StatsCollector.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 2,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -64,6 +64,7 @@\n import com.cloud.cluster.dao.ManagementServerHostDao;\n import com.cloud.dc.Vlan.VlanType;\n import com.cloud.dc.VlanVO;\n+import com.cloud.dc.dao.ClusterDao;\n import com.cloud.dc.dao.VlanDao;\n import com.cloud.exception.StorageUnavailableException;\n import com.cloud.gpu.dao.HostGpuGroupsDao;\n@@ -92,18 +93,20 @@\n import com.cloud.network.as.dao.AutoScaleVmProfileDao;\n import com.cloud.network.as.dao.ConditionDao;\n import com.cloud.network.as.dao.CounterDao;\n+import com.cloud.org.Cluster;\n import com.cloud.resource.ResourceManager;\n import com.cloud.resource.ResourceState;\n import com.cloud.service.ServiceOfferingVO;\n import com.cloud.service.dao.ServiceOfferingDao;\n import com.cloud.storage.ImageStoreDetailsUtil;\n+import com.cloud.storage.ScopeType;\n+import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.storage.StorageManager;\n import com.cloud.storage.StorageStats;\n import com.cloud.storage.VolumeStats;\n import com.cloud.storage.VolumeVO;\n import com.cloud.storage.dao.VolumeDao;\n import com.cloud.user.UserStatisticsVO;\n-import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.user.VmDiskStatisticsVO;\n import com.cloud.user.dao.UserStatisticsDao;\n import com.cloud.user.dao.VmDiskStatisticsDao;\n@@ -173,6 +176,8 @@ public String toString() {\n     @Inject\n     private HostDao _hostDao;\n     @Inject\n+    private ClusterDao _clusterDao;\n+    @Inject\n     private UserVmDao _userVmDao;\n     @Inject\n     private VolumeDao _volsDao;\n@@ -916,7 +921,18 @@ else if (volume.getFormat() == ImageFormat.OVA){\n                         }\n                     }\n                     try {\n-                        HashMap<String, VolumeStatsEntry> volumeStatsByUuid = _userVmMgr.getVolumeStatistics(pool.getClusterId(), pool.getUuid(), pool.getPoolType(), volumeLocators, StatsTimeout.value());\n+                        Map<String, VolumeStatsEntry> volumeStatsByUuid;\n+                        if (pool.getScope() == ScopeType.ZONE) {\n+                            volumeStatsByUuid = new HashMap<>();\n+                            for (final Cluster cluster: _clusterDao.listByZoneId(pool.getDataCenterId())) {\n+                                final Map<String, VolumeStatsEntry> volumeStatsForCluster = _userVmMgr.getVolumeStatistics(cluster.getId(), pool.getUuid(), pool.getPoolType(), volumeLocators, StatsTimeout.value());\n+                                if (volumeStatsForCluster != null) {\n+                                    volumeStatsByUuid.putAll(volumeStatsForCluster);\n+                                }\n+                            }\n+                        } else {\n+                            volumeStatsByUuid = _userVmMgr.getVolumeStatistics(pool.getClusterId(), pool.getUuid(), pool.getPoolType(), volumeLocators, StatsTimeout.value());\n+                        }\n                         if (volumeStatsByUuid != null){\n                             for (final Map.Entry<String, VolumeStatsEntry> entry : volumeStatsByUuid.entrySet()) {\n                                 if (entry == null || entry.getKey() == null || entry.getValue() == null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/server/src/com/cloud/server/StatsCollector.java",
                "sha": "b66fa5f0600d44ba128cbe26b9ad5b3116bbd51e",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/agent/conf/log4j-cloud.xml",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/agent/conf/log4j-cloud.xml?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 6,
                "filename": "systemvm/agent/conf/log4j-cloud.xml",
                "patch": "@@ -24,7 +24,7 @@ under the License.\n    <!-- Preserve messages in a local file -->\n    <!-- ================================= -->\n \n-   <appender name=\"FILE1\" class=\"org.apache.log4j.RollingFileAppender\">\n+   <appender name=\"cloudLog\" class=\"org.apache.log4j.RollingFileAppender\">\n       <param name=\"File\" value=\"/var/log/cloud.log\"/>\n       <param name=\"MaxFileSize\" value=\"10000KB\"/>\n       <param name=\"MaxBackupIndex\" value=\"4\"/>\n@@ -34,7 +34,7 @@ under the License.\n      </layout>\n     </appender>\n \n-    <appender name=\"FILE2\" class=\"org.apache.log4j.RollingFileAppender\">\n+    <appender name=\"cloudOut\" class=\"org.apache.log4j.RollingFileAppender\">\n        <param name=\"File\" value=\"/var/log/cloud/cloud.out\"/>\n        <param name=\"Append\" value=\"true\"/>\n        <param name=\"MaxFileSize\" value=\"10000KB\"/>\n@@ -45,7 +45,7 @@ under the License.\n     </layout>\n     </appender>\n \n-     <appender name=\"FILE3\" class=\"org.apache.log4j.rolling.RollingFileAppender\">\n+     <appender name=\"cloudSystemvmLog\" class=\"org.apache.log4j.rolling.RollingFileAppender\">\n        <param name=\"File\" value=\"/usr/local/cloud/systemvm/cloud.log\"/>\n        <param name=\"Append\" value=\"true\"/>\n        <param name=\"MaxFileSize\" value=\"10000KB\"/>\n@@ -123,9 +123,9 @@ under the License.\n    <root>\n       <level value=\"INFO\"/>\n       <appender-ref ref=\"CONSOLE\"/>\n-      <appender-ref ref=\"FILE1\"/>\n-      <appender-ref ref=\"FILE2\"/>\n-      <appender-ref ref=\"FILE3\"/>\n+      <appender-ref ref=\"cloudLog\"/>\n+      <appender-ref ref=\"cloudOut\"/>\n+      <appender-ref ref=\"cloudSystemvmLog\"/>\n    </root>\n \n </log4j:configuration>",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/agent/conf/log4j-cloud.xml",
                "sha": "338fae234f67e731a8c504c31e1a9dca6af9058b",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/ce3303212b5f9639ee91db52972fc9fd4b9a3c68/systemvm/debian/etc/issue",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/etc/issue?ref=ce3303212b5f9639ee91db52972fc9fd4b9a3c68",
                "deletions": 3,
                "filename": "systemvm/debian/etc/issue",
                "patch": "@@ -1,3 +0,0 @@\n-   __?.o/  Apache CloudStack SystemVM\n-  (  )#    https://cloudstack.apache.org\n- (___(_)   \\s \\r \\n \\l",
                "raw_url": "https://github.com/apache/cloudstack/raw/ce3303212b5f9639ee91db52972fc9fd4b9a3c68/systemvm/debian/etc/issue",
                "sha": "fdef90e7c8a8d7ebe4aa895dec3a6707fdb27da7",
                "status": "removed"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/ce3303212b5f9639ee91db52972fc9fd4b9a3c68/systemvm/debian/etc/rc.local",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/etc/rc.local?ref=ce3303212b5f9639ee91db52972fc9fd4b9a3c68",
                "deletions": 19,
                "filename": "systemvm/debian/etc/rc.local",
                "patch": "@@ -1,19 +0,0 @@\n-#!/bin/bash\n-# Licensed to the Apache Software Foundation (ASF) under one\n-# or more contributor license agreements.  See the NOTICE file\n-# distributed with this work for additional information\n-# regarding copyright ownership.  The ASF licenses this file\n-# to you under the Apache License, Version 2.0 (the\n-# \"License\"); you may not use this file except in compliance\n-# with the License.  You may obtain a copy of the License at\n-#\n-#   http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing,\n-# software distributed under the License is distributed on an\n-# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n-# KIND, either express or implied.  See the License for the\n-# specific language governing permissions and limitations\n-# under the License.\n-\n-",
                "raw_url": "https://github.com/apache/cloudstack/raw/ce3303212b5f9639ee91db52972fc9fd4b9a3c68/systemvm/debian/etc/rc.local",
                "sha": "e419de0939cc317995b4cedec3d8d82f1c645e73",
                "status": "removed"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/cs/CsDhcp.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/cs/CsDhcp.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 1,
                "filename": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py",
                "patch": "@@ -80,7 +80,7 @@ def configure_server(self):\n             # DNS search order\n             if gn.get_dns() and device:\n                 sline = \"dhcp-option=tag:interface-%s-%s,6\" % (device, idx)\n-                dns_list = [x for x in gn.get_dns() if x is not None]\n+                dns_list = [x for x in gn.get_dns() if not (not x)]\n                 line = \"dhcp-option=tag:interface-%s-%s,6,%s\" % (device, idx, ','.join(dns_list))\n                 self.conf.search(sline, line)\n             # Gateway",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/cs/CsDhcp.py",
                "sha": "bcdba51e6c8939d9795a5b6f36c96afa0b454057",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/setup/common.sh",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/setup/common.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 4,
                "filename": "systemvm/debian/opt/cloud/bin/setup/common.sh",
                "patch": "@@ -331,14 +331,14 @@ setup_common() {\n     ip route add default via $GW dev $gwdev\n   fi\n \n-  # a hacking way to activate vSwitch under VMware\n-  ping -n -c 3 $GW &\n+  # Workaround to activate vSwitch under VMware\n+  timeout 3 ping -n -c 3 $GW || true\n   if [ -n \"$MGMTNET\"  -a -n \"$LOCAL_GW\" ]\n   then\n-      ping -n -c 3 $LOCAL_GW &\n+      timeout 3 ping -n -c 3 $LOCAL_GW || true\n       #This code is added to address ARP issue by pinging MGMT_GW\n       MGMT_GW=$(echo $MGMTNET | awk -F \".\" '{print $1\".\"$2\".\"$3\".1\"}')\n-      ping -n -c 3 $MGMT_GW &\n+      timeout 3 ping -n -c 3 $MGMT_GW || true\n   fi\n \n   if [ \"$HYPERVISOR\" == \"vmware\" ]; then",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/setup/common.sh",
                "sha": "0622e2e1aa83f1bccc928ff3ead7066856abcdce",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/setup/router.sh",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/setup/router.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 4,
                "filename": "systemvm/debian/opt/cloud/bin/setup/router.sh",
                "patch": "@@ -59,10 +59,8 @@ setup_router() {\n \n     if [ \"$oldmd5\" != \"$newmd5\" ]\n     then\n-      log_it \"udev NIC assignment requires reboot to take effect\"\n-      sync\n-      sleep 2\n-      reboot\n+      log_it \"Reloading udev for new udev NIC assignment\"\n+      udevadm control --reload-rules && udevadm trigger\n     fi\n   fi\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/setup/router.sh",
                "sha": "f41e57e6375073edbf64d17280d5b21b48c79d53",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/setup/vpcrouter.sh",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/setup/vpcrouter.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 5,
                "filename": "systemvm/debian/opt/cloud/bin/setup/vpcrouter.sh",
                "patch": "@@ -65,11 +65,8 @@ EOF\n      if [ \"$HYPERVISOR\" == \"vmware\" ] || [ \"$HYPERVISOR\" == \"hyperv\" ];\n      then\n          ip route add $MGMTNET via $LOCAL_GW dev eth0\n-\n-          # a hacking way to activate vSwitch under VMware\n-         ping -n -c 3 $LOCAL_GW &\n-         sleep 3\n-         pkill ping\n+         # workaround to activate vSwitch under VMware\n+         timeout 3 ping -n -c 3 $LOCAL_GW || true\n      fi\n   fi\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/setup/vpcrouter.sh",
                "sha": "220a2ea8747a3d809a9d8a36d2ce7e48d4a6ef21",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/update_config.py",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/update_config.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "systemvm/debian/opt/cloud/bin/update_config.py",
                "patch": "@@ -112,6 +112,12 @@ def is_guestnet_configured(guestnet_dict, keys):\n \n     return exists\n \n+# If the command line json file is unprocessed process it\n+# This is important or, the control interfaces will get deleted!\n+if jsonFilename != \"cmd_line.json\" and os.path.isfile(jsonPath % \"cmd_line.json\"):\n+    qf = QueueFile()\n+    qf.setFile(\"cmd_line.json\")\n+    qf.load(None)\n \n if not (os.path.isfile(jsonConfigFile) and os.access(jsonConfigFile, os.R_OK)):\n     print \"[ERROR] update_config.py :: Unable to read and access %s to process it\" % jsonConfigFile",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/bin/update_config.py",
                "sha": "c22aea03b4f51bd198613d25d907648384af6801",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/templates/keepalived.conf.templ",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/templates/keepalived.conf.templ?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 1,
                "filename": "systemvm/debian/opt/cloud/templates/keepalived.conf.templ",
                "patch": "@@ -25,7 +25,7 @@ vrrp_script heartbeat {\n }\n \n vrrp_instance inside_network {\n-    state EQUAL\n+    state BACKUP\n     interface eth2\n     virtual_router_id 51\n     nopreempt",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/systemvm/debian/opt/cloud/templates/keepalived.conf.templ",
                "sha": "0a537776623846c5d651370f45e992cff122845f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_deploy_virtio_scsi_vm.py",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_deploy_virtio_scsi_vm.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 1,
                "filename": "test/integration/smoke/test_deploy_virtio_scsi_vm.py",
                "patch": "@@ -219,7 +219,8 @@ def verifyVirshState(self, diskcount):\n                                      \"controller index\")\n                 elif child.tag.lower() == \"driver\":\n                     discard = child.get(\"discard\")\n-                    self.assertEqual(discard, \"unmap\", \"discard settings not unmap\")\n+                    if discard: # may not be defined by older qemu/libvirt\n+                        self.assertEqual(discard, \"unmap\", \"discard settings not unmap\")\n \n     def verifyGuestState(self, diskcount):\n         ssh = self.virtual_machine.get_ssh_client(reconnect=True)",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_deploy_virtio_scsi_vm.py",
                "sha": "260e299d4f990c211c86d120c59e288e5847de2c",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_deploy_vm_root_resize.py",
                "changes": 56,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_deploy_vm_root_resize.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 34,
                "filename": "test/integration/smoke/test_deploy_vm_root_resize.py",
                "patch": "@@ -53,8 +53,8 @@ def setUpClass(cls):\n         cls.services = cls.testClient.getParsedTestDataConfig()\n         cls.services[\"mode\"] = cls.zone.networktype\n         cls._cleanup = []\n+        cls.storageID = None\n         cls.updateclone = False\n-        cls.restartreq = False\n         cls.defaultdiskcontroller = \"ide\"\n         cls.template = get_template(cls.api_client, cls.zone.id)\n         if cls.template == FAILED:\n@@ -70,7 +70,8 @@ def setUpClass(cls):\n         list_pool_resp = list_storage_pools(cls.api_client,\n                                             account=cls.account.name,\n                                             domainid=cls.domain.id)\n-        #Identify the storage pool type  and set vmware fullclone to\n+\n+        # Identify the storage pool type  and set vmware fullclone to\n         # true if storage is VMFS\n         if cls.hypervisor == 'vmware':\n              # please make sure url of templateregister dictionary in\n@@ -89,26 +90,13 @@ def setUpClass(cls):\n                                               value=\"scsi\")\n \n                         cls.updateclone = True\n-                        cls.restartreq = True\n-\n-             list_config_fullclone_global_response = list_configurations(\n-                        cls.api_client\n-                        , name=\n-                        \"vmware.create.full.clone\")\n-             if list_config_fullclone_global_response[0].value==\"false\":\n-                        Configurations.update(cls.api_client,\n-                                              \"vmware.create.full.clone\",\n-                                              value=\"true\")\n-\n-                        cls.updateclone = True\n-                        cls.restartreq = True\n \n              for strpool in list_pool_resp:\n                 if strpool.type.lower() == \"vmfs\" or strpool.type.lower()== \"networkfilesystem\":\n                     list_config_storage_response = list_configurations(\n-                        cls.api_client\n-                        , name=\n-                        \"vmware.create.full.clone\",storageid=strpool.id)\n+                        cls.api_client, name=\"vmware.create.full.clone\",\n+                        storageid=strpool.id)\n+\n                     res = validateList(list_config_storage_response)\n                     if res[2]== INVALID_INPUT:\n                         raise Exception(\"Failed to  list configurations \")\n@@ -123,12 +111,16 @@ def setUpClass(cls):\n                                            tags=\"scsi\")\n                         cls.storageID = strpool.id\n                         break\n-             if cls.restartreq:\n-                cls.restartServer()\n \n-                #Giving 30 seconds to management to warm-up,\n-                #Experienced failures when trying to deploy a VM exactly when management came up\n-                time.sleep(30)\n+             list_config_fullclone_global_response = list_configurations(\n+                        cls.api_client, name=\"vmware.create.full.clone\")\n+\n+             if list_config_fullclone_global_response[0].value==\"false\":\n+                        Configurations.update(cls.api_client,\n+                                              \"vmware.create.full.clone\",\n+                                              value=\"true\")\n+                        cls.updateclone = True\n+\n \n         #create a service offering\n         cls.service_offering = ServiceOffering.create(\n@@ -147,21 +139,17 @@ def tearDownClass(cls):\n \n             if cls.updateclone:\n                 Configurations.update(cls.api_client,\n-                                      \"vmware.create.full.clone\",\n-                                      value=\"false\",storageid=cls.storageID)\n+                                              \"vmware.root.disk.controller\",\n+                                              value=cls.defaultdiskcontroller)\n                 Configurations.update(cls.api_client,\n                                               \"vmware.create.full.clone\",\n                                               value=\"false\")\n                 Configurations.update(cls.api_client,\n-                                              \"vmware.root.disk.controller\",\n-                                              value=cls.defaultdiskcontroller)\n-                StoragePool.update(cls.api_client, id=cls.storageID,\n-                                   tags=\"\")\n-                cls.restartServer()\n-\n-                #Giving 30 seconds to management to warm-up,\n-                #Experienced failures when trying to deploy a VM exactly when management came up\n-                time.sleep(30)\n+                                      \"vmware.create.full.clone\",\n+                                      value=\"false\", storageid=cls.storageID)\n+                if cls.storageID:\n+                    StoragePool.update(cls.api_client, id=cls.storageID,\n+                                    tags=\"\")\n \n             cleanup_resources(cls.api_client, cls._cleanup)\n         except Exception as e:",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_deploy_vm_root_resize.py",
                "sha": "e23bbcec6d2c0f29b0442998301c35b264aea656",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_iso.py",
                "changes": 0,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_iso.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "test/integration/smoke/test_iso.py",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_iso.py",
                "sha": null,
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_list_ids_parameter.py",
                "changes": 0,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_list_ids_parameter.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "test/integration/smoke/test_list_ids_parameter.py",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_list_ids_parameter.py",
                "sha": null,
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_nested_virtualization.py",
                "changes": 0,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_nested_virtualization.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "test/integration/smoke/test_nested_virtualization.py",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_nested_virtualization.py",
                "sha": null,
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_ssvm.py",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_ssvm.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 2,
                "filename": "test/integration/smoke/test_ssvm.py",
                "patch": "@@ -73,7 +73,7 @@ def checkRunningAgent():\n                 return list_host_response[0].state == 'Up', None\n             return False, None\n \n-        res, _ = wait_until(3, self.services[\"sleep\"], checkRunningAgent)\n+        res, _ = wait_until(3, 300, checkRunningAgent)\n         if not res:\n             raise Exception(\"Failed to wait for SSVM agent to be Up\")\n \n@@ -99,7 +99,7 @@ def checkRunningState():\n                 return ssvm_response.state == 'Running', ssvm_response\n             return False, None\n \n-        res, ssvm_response = wait_until(3, self.services[\"sleep\"], checkRunningState)\n+        res, ssvm_response = wait_until(3, 300, checkRunningState)\n         if not res:\n             self.fail(\"Failed to reach systemvm state to Running\")\n         return ssvm_response",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_ssvm.py",
                "sha": "f20003bf23aa7ea8df6629d078d755dc16409810",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_vm_life_cycle.py",
                "changes": 0,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_vm_life_cycle.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "test/integration/smoke/test_vm_life_cycle.py",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_vm_life_cycle.py",
                "sha": null,
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_volumes.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_volumes.py?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "test/integration/smoke/test_volumes.py",
                "patch": "@@ -246,6 +246,8 @@ def test_01_create_volume(self):\n                 ret = checkVolumeSize(ssh_handle=ssh,volume_name=volume_name,size_to_verify=vol_sz)\n             elif list_volume_response[0].hypervisor.lower() == \"hyperv\":\n                 ret = checkVolumeSize(ssh_handle=ssh,volume_name=\"/dev/sdb\",size_to_verify=vol_sz)\n+            elif list_volume_response[0].hypervisor.lower() == \"vmware\":\n+                ret = checkVolumeSize(ssh_handle=ssh,volume_name=\"/dev/sda\",size_to_verify=vol_sz)\n             else:\n                 ret = checkVolumeSize(ssh_handle=ssh,volume_name=\"/dev/sdb\",size_to_verify=vol_sz)\n             self.debug(\" Volume Size Expected %s  Actual :%s\" %(vol_sz,ret[1]))",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/test/integration/smoke/test_volumes.py",
                "sha": "431dfa9b79744d8bf4f4ea748e32a73554d7fb01",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/configure_acpid.sh",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/appliance/definitions/systemvmtemplate/configure_acpid.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 10,
                "filename": "tools/appliance/definitions/systemvmtemplate/configure_acpid.sh",
                "patch": "@@ -20,18 +20,11 @@ set -e\n set -x\n \n function configure_acpid() {\n-  grep /usr/local/sbin/power.sh /etc/acpi/events/power && return\n-\n   mkdir -p /etc/acpi/events\n-  cat >> /etc/acpi/events/power << EOF\n-event=button/power.*\n-action=/usr/local/sbin/power.sh \"%e\"\n-EOF\n-  cat >> /usr/local/sbin/power.sh << EOF\n-#!/bin/bash\n-/sbin/poweroff\n+  cat > /etc/acpi/events/powerbtn <<EOF\n+event=button[ /]power\n+action=/sbin/poweroff\n EOF\n-  chmod a+x /usr/local/sbin/power.sh\n }\n \n return 2>/dev/null || configure_acpid",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/configure_acpid.sh",
                "sha": "6e27eee765754e56c4b3fef09b1143d0f1cb31ab",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/configure_grub.sh",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/appliance/definitions/systemvmtemplate/configure_grub.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 2,
                "filename": "tools/appliance/definitions/systemvmtemplate/configure_grub.sh",
                "patch": "@@ -20,14 +20,14 @@ set -e\n set -x\n \n function configure_grub() {\n-  cat <<EOF > /etc/default/grub\n+  cat > /etc/default/grub <<EOF\n # If you change this file, run 'update-grub' afterwards to update\n # /boot/grub/grub.cfg.\n \n GRUB_DEFAULT=0\n GRUB_TIMEOUT=0\n GRUB_DISTRIBUTOR=Debian\n-GRUB_CMDLINE_LINUX_DEFAULT=\"\"\n+GRUB_CMDLINE_LINUX_DEFAULT=\"loglevel=4\"\n GRUB_CMDLINE_LINUX=\"console=tty0 console=ttyS0,115200n8 console=hvc0 earlyprintk=xen net.ifnames=0 biosdevname=0 debian-installer=en_US nomodeset\"\n GRUB_CMDLINE_XEN=\"com1=115200 console=com1\"\n GRUB_TERMINAL=\"console serial\"",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/configure_grub.sh",
                "sha": "53ffb2dc306b8497b743adb9b547395f9a1f6733",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/configure_systemvm_services.sh",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/appliance/definitions/systemvmtemplate/configure_systemvm_services.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 0,
                "filename": "tools/appliance/definitions/systemvmtemplate/configure_systemvm_services.sh",
                "patch": "@@ -52,6 +52,15 @@ function do_signature() {\n   echo \"Cloudstack Release $CLOUDSTACK_RELEASE $(date)\" > /etc/cloudstack-release\n }\n \n+function configure_issue() {\n+  cat > /etc/issue <<EOF\n+   __?.o/  Apache CloudStack SystemVM $CLOUDSTACK_RELEASE\n+  (  )#    https://cloudstack.apache.org\n+ (___(_)   Debian GNU/Linux 9 \\n \\l\n+\n+EOF\n+}\n+\n function configure_strongswan() {\n   # change the charon stroke timeout from 3 minutes to 30 seconds\n   sed -i \"s/# timeout = 0/timeout = 30000/\" /etc/strongswan.d/charon/stroke.conf\n@@ -92,6 +101,7 @@ function configure_services() {\n \n   configure_apache2\n   configure_strongswan\n+  configure_issue\n }\n \n return 2>/dev/null || configure_services",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/configure_systemvm_services.sh",
                "sha": "6e2e3059a534b62e490b9ab0d8af737c2a4d02f8",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/install_systemvm_packages.sh",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/appliance/definitions/systemvmtemplate/install_systemvm_packages.sh?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 2,
                "filename": "tools/appliance/definitions/systemvmtemplate/install_systemvm_packages.sh",
                "patch": "@@ -53,10 +53,10 @@ function install_packages() {\n   fi\n \n   ${apt_get} install grub-legacy \\\n-    rsyslog logrotate cron net-tools ifupdown tmux vim netbase iptables \\\n+    rsyslog logrotate cron net-tools ifupdown tmux vim htop netbase iptables \\\n     openssh-server e2fsprogs tcpdump socat wget \\\n     python bzip2 sed gawk diffutils grep gzip less tar telnet ftp rsync traceroute psmisc lsof procps \\\n-    inetutils-ping iputils-arping httping  curl \\\n+    inetutils-ping iputils-arping httping curl \\\n     dnsutils zip unzip ethtool uuid file iproute acpid sudo \\\n     sysstat python-netaddr \\\n     apache2 ssl-cert \\",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/install_systemvm_packages.sh",
                "sha": "30ad66dd4efbf5e68311b30026e43628d0435ea8",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/preseed.cfg",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/appliance/definitions/systemvmtemplate/preseed.cfg?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 3,
                "filename": "tools/appliance/definitions/systemvmtemplate/preseed.cfg",
                "patch": "@@ -57,13 +57,13 @@ d-i partman-auto/method string regular\n d-i partman-auto/choose_recipe select atomic\n d-i partman-auto/expert_recipe string                         \\\n       boot-root ::                                            \\\n-              100 50 200 ext2                                 \\\n+              50 50 100 ext2                                  \\\n                       $primary{ } $bootable{ }                \\\n                       method{ format } format{ }              \\\n                       use_filesystem{ } filesystem{ ext2 }    \\\n                       mountpoint{ /boot }                     \\\n               .                                               \\\n-              1450 40 1600 ext4                               \\\n+              1300 40 1600 ext4                               \\\n                       method{ format } format{ }              \\\n                       use_filesystem{ } filesystem{ ext4 }    \\\n                       mountpoint{ / }                         \\\n@@ -78,7 +78,7 @@ d-i partman-auto/expert_recipe string                         \\\n                       use_filesystem{ } filesystem{ ext4 }    \\\n                       mountpoint{ /tmp }                      \\\n               .                                               \\\n-              100 100 1024 linux-swap                         \\\n+              256 100 1024 linux-swap                         \\\n                       method{ swap } format{ }                \\\n               .\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/tools/appliance/definitions/systemvmtemplate/preseed.cfg",
                "sha": "0f6c265f19ccf265d30c64390d3e9f4764ce55d5",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/15b11a3b27800afcb598f8e97416f0d826cac491/ui/scripts/network.js",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/network.js?ref=15b11a3b27800afcb598f8e97416f0d826cac491",
                "deletions": 1,
                "filename": "ui/scripts/network.js",
                "patch": "@@ -844,7 +844,7 @@\n                                 'Released': 'off',\n                                 'Destroy': 'off',\n                                 'Shutdown': 'off',\n-                                'Setup': 'warning',\n+                                'Setup': 'on',\n                                 'Implemented': 'on'\n                             }\n                         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/15b11a3b27800afcb598f8e97416f0d826cac491/ui/scripts/network.js",
                "sha": "7dd459dc91585cb85e9bea8fe624e98789ccc244",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-10013: Fix VMware related issues and fix misc tests\n\nThis fixes test failures around VMware with the new systemvmtemplate.\nIn addition:\n\n- Does not skip rVR related test cases for VMware\n- Removes rc.local\n- Processes unprocessed cmd_line.json\n- Fixed NPEs around VMware tests/code\n- On VMware, use udevadm to reconfigure nic/mac address than rebooting\n- Fix proper acpi shutdown script for faster systemvm shutdowns\n- Give at least 256MB of swap for VRs to avoid OOM on VMware\n- Fixes smoke tests for environment related failures\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/ce3303212b5f9639ee91db52972fc9fd4b9a3c68",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java",
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_15c93ba": {
        "bug_id": "cloudstack_15c93ba",
        "commit": "https://github.com/apache/cloudstack/commit/15c93ba9b77b15a268dfe618277a21331edfe0d0",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/15c93ba9b77b15a268dfe618277a21331edfe0d0/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=15c93ba9b77b15a268dfe618277a21331edfe0d0",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1237,7 +1237,7 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n \n         //Check if its a scale \"up\"\n         ServiceOffering newServiceOffering = _configMgr.getServiceOffering(newServiceOfferingId);\n-        ServiceOffering currentServiceOffering = _configMgr.getServiceOffering(vmInstance.getServiceOfferingId());\n+        ServiceOffering currentServiceOffering = _offeringDao.findByIdIncludingRemoved(vmInstance.getServiceOfferingId());\n         int newCpu = newServiceOffering.getCpu();\n         int newMemory = newServiceOffering.getRamSize();\n         int newSpeed = newServiceOffering.getSpeed();",
                "raw_url": "https://github.com/apache/cloudstack/raw/15c93ba9b77b15a268dfe618277a21331edfe0d0/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "b710c085ca37108472980a1b95a14a333333991f",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/15c93ba9b77b15a268dfe618277a21331edfe0d0/server/test/com/cloud/vm/UserVmManagerTest.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vm/UserVmManagerTest.java?ref=15c93ba9b77b15a268dfe618277a21331edfe0d0",
                "deletions": 1,
                "filename": "server/test/com/cloud/vm/UserVmManagerTest.java",
                "patch": "@@ -35,6 +35,7 @@\n import java.util.List;\n import java.util.UUID;\n \n+import com.cloud.service.dao.ServiceOfferingDao;\n import org.junit.Before;\n import org.junit.Test;\n import org.mockito.Mock;\n@@ -107,6 +108,7 @@\n     @Mock VolumeVO _volumeMock;\n     @Mock List<VolumeVO> _rootVols;\n     @Mock Account _accountMock2;\n+    @Mock ServiceOfferingDao _offeringDao;\n     @Before\n     public void setup(){\n         MockitoAnnotations.initMocks(this);\n@@ -122,6 +124,7 @@ public void setup(){\n         _userVmMgr._userDao = _userDao;\n         _userVmMgr._accountMgr = _accountMgr;\n         _userVmMgr._configMgr = _configMgr;\n+        _userVmMgr._offeringDao= _offeringDao;\n         _userVmMgr._capacityMgr = _capacityMgr;\n         _userVmMgr._scaleRetry = 2;\n \n@@ -356,7 +359,7 @@ public void testScaleVMF2()  throws Exception {\n         ServiceOffering so2 =  getSvcoffering(256);\n \n         when(_configMgr.getServiceOffering(anyLong())).thenReturn(so1);\n-        when(_configMgr.getServiceOffering(1L)).thenReturn(so1);\n+        when(_offeringDao.findByIdIncludingRemoved(anyLong())).thenReturn((ServiceOfferingVO) so1);\n \n         Account account = new AccountVO(\"testaccount\", 1L, \"networkdomain\", (short)0, UUID.randomUUID().toString());\n         UserVO user = new UserVO(1, \"testuser\", \"password\", \"firstname\", \"lastName\", \"email\", \"timezone\", UUID.randomUUID().toString());",
                "raw_url": "https://github.com/apache/cloudstack/raw/15c93ba9b77b15a268dfe618277a21331edfe0d0/server/test/com/cloud/vm/UserVmManagerTest.java",
                "sha": "e74188f25a38da94190360be32e527f3a949184e",
                "status": "modified"
            }
        ],
        "message": "=CLOUDSTACK-4068 scaling up user vm and system vm is failing with NPE if current service offering is deleted\nNitin Mehta <nitin.mehta@citrix.com>",
        "parent": "https://github.com/apache/cloudstack/commit/3f79a6730f8245229185710c0926d16a52bfa285",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_16de4a7": {
        "bug_id": "cloudstack_16de4a7",
        "commit": "https://github.com/apache/cloudstack/commit/16de4a71761efe69053fefb6f77f16ddfff63c0f",
        "file": [
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/16de4a71761efe69053fefb6f77f16ddfff63c0f/utils/src/com/cloud/utils/net/NetUtils.java",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/net/NetUtils.java?ref=16de4a71761efe69053fefb6f77f16ddfff63c0f",
                "deletions": 23,
                "filename": "utils/src/com/cloud/utils/net/NetUtils.java",
                "patch": "@@ -19,16 +19,6 @@\n \n package com.cloud.utils.net;\n \n-import com.cloud.utils.IteratorUtil;\n-import com.cloud.utils.Pair;\n-import com.cloud.utils.script.Script;\n-import com.googlecode.ipv6.IPv6Address;\n-import com.googlecode.ipv6.IPv6AddressRange;\n-import com.googlecode.ipv6.IPv6Network;\n-import org.apache.commons.lang.SystemUtils;\n-import org.apache.commons.net.util.SubnetUtils;\n-import org.apache.log4j.Logger;\n-\n import java.io.BufferedReader;\n import java.io.IOException;\n import java.io.InputStreamReader;\n@@ -51,6 +41,18 @@\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n+import org.apache.commons.lang.SystemUtils;\n+import org.apache.commons.net.util.SubnetUtils;\n+import org.apache.log4j.Logger;\n+\n+import com.googlecode.ipv6.IPv6Address;\n+import com.googlecode.ipv6.IPv6AddressRange;\n+import com.googlecode.ipv6.IPv6Network;\n+\n+import com.cloud.utils.IteratorUtil;\n+import com.cloud.utils.Pair;\n+import com.cloud.utils.script.Script;\n+\n public class NetUtils {\n     protected final static Logger s_logger = Logger.getLogger(NetUtils.class);\n     public final static String HTTP_PORT = \"80\";\n@@ -321,6 +323,8 @@ public static String getMacAddress(InetAddress address) {\n             }\n         } catch (SocketException e) {\n             s_logger.error(\"SocketException when trying to retrieve MAC address\", e);\n+        } finally {\n+            formatter.close();\n         }\n         return sb.toString();\n     }\n@@ -456,6 +460,7 @@ public static String byte2Mac(byte[] m) {\n         StringBuilder result = new StringBuilder(17);\n         Formatter formatter = new Formatter(result);\n         formatter.format(\"%02x:%02x:%02x:%02x:%02x:%02x\", m[0], m[1], m[2], m[3], m[4], m[5]);\n+        formatter.close();\n         return result.toString();\n     }\n \n@@ -464,7 +469,7 @@ public static String long2Mac(long macAddress) {\n         Formatter formatter = new Formatter(result);\n         formatter.format(\"%02x:%02x:%02x:%02x:%02x:%02x\", (macAddress >> 40) & 0xff, (macAddress >> 32) & 0xff, (macAddress >> 24) & 0xff, (macAddress >> 16) & 0xff,\n                 (macAddress >> 8) & 0xff, (macAddress & 0xff));\n-\n+        formatter.close();\n         return result.toString();\n     }\n \n@@ -1307,20 +1312,14 @@ public static BigInteger countIp6InRange(String ip6Range) {\n         if (ips.length > 1) {\n             endIp = ips[1];\n         }\n-        IPv6Address start, end;\n         try {\n-            start = IPv6Address.fromString(startIp);\n-            end = IPv6Address.fromString(endIp);\n-        } catch (IllegalArgumentException ex) {\n-            return null;\n-        }\n-        BigInteger startInt = convertIPv6AddressToBigInteger(start);\n-        BigInteger endInt = convertIPv6AddressToBigInteger(end);\n-        if (endInt != null) {\n-            if (startInt == null || startInt.compareTo(endInt) > 0) {\n-                return null;\n+            BigInteger startInt = convertIPv6AddressToBigInteger(IPv6Address.fromString(startIp));\n+            BigInteger endInt = convertIPv6AddressToBigInteger(IPv6Address.fromString(endIp));\n+            if (endInt != null && startInt != null && startInt.compareTo(endInt) <= 0) {\n+                return endInt.subtract(startInt).add(BigInteger.ONE);\n             }\n-            return endInt.subtract(startInt).add(BigInteger.ONE);\n+        } catch (IllegalArgumentException ex) {\n+            s_logger.error(\"Failed to convert a string to an IPv6 address\", ex);\n         }\n         return null;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/16de4a71761efe69053fefb6f77f16ddfff63c0f/utils/src/com/cloud/utils/net/NetUtils.java",
                "sha": "3ce369784525e393d9b3915c18e9d9efd8b4c053",
                "status": "modified"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/16de4a71761efe69053fefb6f77f16ddfff63c0f/utils/test/com/cloud/utils/net/NetUtilsTest.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/test/com/cloud/utils/net/NetUtilsTest.java?ref=16de4a71761efe69053fefb6f77f16ddfff63c0f",
                "deletions": 10,
                "filename": "utils/test/com/cloud/utils/net/NetUtilsTest.java",
                "patch": "@@ -19,14 +19,6 @@\n \n package com.cloud.utils.net;\n \n-import com.googlecode.ipv6.IPv6Address;\n-import org.apache.log4j.Logger;\n-import org.junit.Test;\n-\n-import java.math.BigInteger;\n-import java.util.SortedSet;\n-import java.util.TreeSet;\n-\n import static org.hamcrest.Matchers.anyOf;\n import static org.hamcrest.Matchers.contains;\n import static org.hamcrest.Matchers.equalTo;\n@@ -39,6 +31,15 @@\n import static org.junit.Assert.assertThat;\n import static org.junit.Assert.assertTrue;\n \n+import java.math.BigInteger;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+\n+import org.apache.log4j.Logger;\n+import org.junit.Test;\n+\n+import com.googlecode.ipv6.IPv6Address;\n+\n public class NetUtilsTest {\n \n     private static final Logger s_logger = Logger.getLogger(NetUtilsTest.class);\n@@ -138,8 +139,22 @@ public void testGetIp6FromRange() {\n \n     @Test\n     public void testCountIp6InRange() {\n-        assertEquals(NetUtils.countIp6InRange(\"1234:5678::1-1234:5678::2\"), new BigInteger(\"2\"));\n-        assertEquals(NetUtils.countIp6InRange(\"1234:5678::2-1234:5678::0\"), null);\n+        assertEquals(new BigInteger(\"2\"), NetUtils.countIp6InRange(\"1234:5678::1-1234:5678::2\"));\n+    }\n+\n+    @Test\n+    public void testCountIp6InRangeWithInvalidRange() {\n+        assertEquals(null, NetUtils.countIp6InRange(\"1234:5678::2-1234:5678::0\"));\n+    }\n+\n+    @Test\n+    public void testCountIp6InRangeWithNullStart() {\n+        assertEquals(null, NetUtils.countIp6InRange(\"-1234:5678::0\"));\n+    }\n+\n+    @Test\n+    public void testCountIp6InRangeWithNoEnd() {\n+        assertEquals(new BigInteger(\"1\"), NetUtils.countIp6InRange(\"1234:5678::2\"));\n     }\n \n     @Test",
                "raw_url": "https://github.com/apache/cloudstack/raw/16de4a71761efe69053fefb6f77f16ddfff63c0f/utils/test/com/cloud/utils/net/NetUtilsTest.java",
                "sha": "e48faa1842aabb707e2f6a3c3dbd520be77dd32b",
                "status": "modified"
            }
        ],
        "message": "Fix for potential NPE",
        "parent": "https://github.com/apache/cloudstack/commit/638da54fcee53cea305c0e730fef28c914298731",
        "repo": "cloudstack",
        "unit_tests": [
            "NetUtilsTest.java"
        ]
    },
    "cloudstack_1741fdf": {
        "bug_id": "cloudstack_1741fdf",
        "commit": "https://github.com/apache/cloudstack/commit/1741fdfb12fd37ce73708b4d563ac22217098c03",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/1741fdfb12fd37ce73708b4d563ac22217098c03/utils/src/com/cloud/utils/UriUtils.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/UriUtils.java?ref=1741fdfb12fd37ce73708b4d563ac22217098c03",
                "deletions": 5,
                "filename": "utils/src/com/cloud/utils/UriUtils.java",
                "patch": "@@ -108,17 +108,22 @@ public static Long getRemoteSize(String url) {\n         HttpsURLConnection httpsConn = null;\n         try {\n             URI uri = new URI(url);\n-            if(uri.getScheme().equalsIgnoreCase(\"http\")) {\n+            if (uri.getScheme().equalsIgnoreCase(\"http\")) {\n                 httpConn = (HttpURLConnection) uri.toURL().openConnection();\n                 if (httpConn != null) {\n-                    remoteSize = Long.parseLong(httpConn.getHeaderField(\"content-length\"));\n+                    String contentLength = httpConn.getHeaderField(\"content-length\");\n+                    if (contentLength != null) {\n+                        remoteSize = Long.parseLong(contentLength);\n+                    }\n                     httpConn.disconnect();\n                 }\n-            }\n-            else if(uri.getScheme().equalsIgnoreCase(\"https\")) {\n+            } else if (uri.getScheme().equalsIgnoreCase(\"https\")) {\n                 httpsConn = (HttpsURLConnection) uri.toURL().openConnection();\n                 if (httpsConn != null) {\n-                    remoteSize = Long.parseLong(httpsConn.getHeaderField(\"content-length\"));\n+                    String contentLength = httpsConn.getHeaderField(\"content-length\");\n+                    if (contentLength != null) {\n+                        remoteSize = Long.parseLong(contentLength);\n+                    }\n                     httpsConn.disconnect();\n                 }\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/1741fdfb12fd37ce73708b4d563ac22217098c03/utils/src/com/cloud/utils/UriUtils.java",
                "sha": "1ff4d729cbf50154688bcea79bb8f48d1a972674",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3774: NPE while creating template from snapshot on a upgraded setup.\nAfter upgrade the SSVM was staying in connecting/alert state. This was because\nwhile handling the processConnect command for ssvm the management server was\ntrying to template sync. For resource limit calculation it was trying to get the\nremote size of the template. If the template was no longer available a number\nformat exception was thrown. The process connect wasn't getting completed and\nthe ssvm used to stay in connecting/alert state. While creating template from\nsnapshot cloudstack looks for up and enabled ssvms and because there wasn't\nany available (as the ssvm was in coonecting/alert state) it used to pick the\nwrong resource (LocalNfs*Resource) instead of the NfsSecondaryStorageResource.\n\nFixed the issue by making sure number format exceptions are avoided so that\nSSVM moves to the right state.",
        "parent": "https://github.com/apache/cloudstack/commit/6164077ee88786bc80b895f889b45c17fdf7ae2e",
        "repo": "cloudstack",
        "unit_tests": [
            "UriUtilsTest.java"
        ]
    },
    "cloudstack_17e4e70": {
        "bug_id": "cloudstack_17e4e70",
        "commit": "https://github.com/apache/cloudstack/commit/17e4e7014fed8bd010c7858e5bd086c4f479ba1f",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/17e4e7014fed8bd010c7858e5bd086c4f479ba1f/server/src/com/cloud/server/StatsCollector.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=17e4e7014fed8bd010c7858e5bd086c4f479ba1f",
                "deletions": 7,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -259,21 +259,26 @@ public VmStats getVmStats(long id) {\n \t\t@Override\n         public void run() {\r\n \t\t\ttry {\n-\t\t\t\ts_logger.debug(\"StorageCollector is running...\");\n+\t            if (s_logger.isDebugEnabled()) {\n+\t            \ts_logger.debug(\"StorageCollector is running...\");\n+\t            }\n \t\t\t\t\r\n                 List<HostVO> hosts = _hostDao.listSecondaryStorageHosts();\n-                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\r\n+                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\n+                \r\n                 for (HostVO host : hosts) {\r\n                     GetStorageStatsCommand command = new GetStorageStatsCommand(host.getStorageUrl());\n-                    HostVO ssAhost = _agentMgr.getSSAgent(host);\n-                    if (ssAhost == null) {\n-                        return;\n-                    }\n+        \t\t\tHostVO ssAhost = _agentMgr.getSSAgent(host);\n+        \t\t\tif( ssAhost == null ) {\n+        \t\t\t\ts_logger.warn(\"There is no secondary storage VM for secondary storage host \" + host.getName());\n+        \t\t\t\tcontinue;\n+        \t\t\t}\n+        \t\t\t\n                     long hostId = host.getId();\r\n                     Answer answer = _agentMgr.easySend(ssAhost.getId(), command);\r\n                     if (answer != null && answer.getResult()) {\r\n                         storageStats.put(hostId, (StorageStats)answer);\n-                        s_logger.debug(\"HostId: \"+hostId+ \" Used: \" + ((StorageStats)answer).getByteUsed() + \" Total Available: \" + ((StorageStats)answer).getCapacityBytes());\n+                        s_logger.trace(\"HostId: \"+hostId+ \" Used: \" + ((StorageStats)answer).getByteUsed() + \" Total Available: \" + ((StorageStats)answer).getCapacityBytes());\n                         //Seems like we have dynamically updated the sec. storage as prev. size and the current do not match\n                         if (_storageStats.get(hostId)!=null &&\n                         \t\t_storageStats.get(hostId).getCapacityBytes() != ((StorageStats)answer).getCapacityBytes()){",
                "raw_url": "https://github.com/apache/cloudstack/raw/17e4e7014fed8bd010c7858e5bd086c4f479ba1f/server/src/com/cloud/server/StatsCollector.java",
                "sha": "6561567da8315aa88fdc5ed2f0ebc609b4a7c686",
                "status": "modified"
            }
        ],
        "message": "bug 10602: Fix NPE in StatsCollector - ssvm might not be up so check for that.\nstatus 10602: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/73b79deb9943820f968adc513d4187caf4aa3ab6",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_1889247": {
        "bug_id": "cloudstack_1889247",
        "commit": "https://github.com/apache/cloudstack/commit/188924751ed87a01541a094e03e958cd8d01653b",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/188924751ed87a01541a094e03e958cd8d01653b/developer/developer-prefill.sql",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/developer/developer-prefill.sql?ref=188924751ed87a01541a094e03e958cd8d01653b",
                "deletions": 16,
                "filename": "developer/developer-prefill.sql",
                "patch": "@@ -62,22 +62,6 @@ INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n             VALUES ('Advanced', 'DEFAULT', 'management-server',\n             'expunge.interval', '60');\n \n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'cluster.cpu.allocated.capacity.disablethreshold', '0.95');\n-\n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'cluster.memory.allocated.capacity.disablethreshold ', '0.95');\n-\n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'pool.storage.allocated.capacity.disablethreshold ', '0.95');\n-\n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'pool.storage.capacity.disablethreshold ', '0.95');\n-\n -- Add developer configuration entry; allows management server to be run as a user other than \"cloud\"\n INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n             VALUES ('Advanced', 'DEFAULT', 'management-server',",
                "raw_url": "https://github.com/apache/cloudstack/raw/188924751ed87a01541a094e03e958cd8d01653b/developer/developer-prefill.sql",
                "sha": "89d9c7ebe28402f53b3dd5f10d852107ae6711af",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/188924751ed87a01541a094e03e958cd8d01653b/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=188924751ed87a01541a094e03e958cd8d01653b",
                "deletions": 3,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1709,9 +1709,18 @@ private boolean hasSuitablePoolsForVolume(VolumeVO volume, Host host, VirtualMac\n             List<ConfigurationVO> configVOList = new ArrayList<ConfigurationVO>();\n             for (ConfigurationVO param : result.first()) {\n                 ConfigurationVO configVo = _configDao.findByName(param.getName());\n-                configVo.setValue(_configDepot.get(param.getName()).valueIn(id).toString());\n-                configVOList.add(configVo);\n-    }\n+                if (configVo != null) {\n+                    ConfigKey<?> key = _configDepot.get(param.getName());\n+                    if (key != null) {\n+                        configVo.setValue(key.valueIn(id).toString());\n+                        configVOList.add(configVo);\n+                    } else {\n+                        s_logger.warn(\"ConfigDepot could not find parameter \" + param.getName() + \" for scope \" + scope);\n+                    }\n+                } else {\n+                    s_logger.warn(\"Configuration item  \" + param.getName() + \" not found in \" + scope);\n+                }\n+            }\n \n             return new Pair<List<? extends Configuration>, Integer>(configVOList, configVOList.size());\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/188924751ed87a01541a094e03e958cd8d01653b/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "85ce413d96a8cf857a2e369f370b7ac337cd9e61",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7219: Fix NPE, log warning when config item is missing from scope\n\n- Cherry picked from Daan's fix 63fbd16dd11388bd93cdbec4ea7fe6de37aa7fc5\n- Added another check if configDepot returned null\n- Removed developer prefill values\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/b99d950dd31420ffb06d6c910a075ec691ae2e67",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_1a03097": {
        "bug_id": "cloudstack_1a03097",
        "commit": "https://github.com/apache/cloudstack/commit/1a03097d1b6eda3d3705b800e23077f2e10a732b",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/1a03097d1b6eda3d3705b800e23077f2e10a732b/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=1a03097d1b6eda3d3705b800e23077f2e10a732b",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1020,8 +1020,13 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<DomainRou\n         }\n         _routerDao.update(router.getId(), router);\n        \n+        //restart network if restartNetwork = false is not specified in profile parameters\n+        boolean restartNetwork = true;\n+        if (profile.getParameter(Param.RestartNetwork) != null && (Boolean)profile.getParameter(Param.RestartNetwork) == false) {\n+            restartNetwork = false;\n+        }\n         //The commands should be sent for domR only, skip for DHCP\n-        if (router.getRole() == VirtualRouter.Role.DHCP_FIREWALL_LB_PASSWD_USERDATA && ((Boolean)profile.getParameter(Param.RestartNetwork))== true) {\n+        if (router.getRole() == VirtualRouter.Role.DHCP_FIREWALL_LB_PASSWD_USERDATA && restartNetwork) {\n             s_logger.debug(\"Resending ipAssoc, port forwarding, load balancing rules as a part of Virtual router start\");\n             long networkId = router.getNetworkId();\n             long ownerId = router.getAccountId();",
                "raw_url": "https://github.com/apache/cloudstack/raw/1a03097d1b6eda3d3705b800e23077f2e10a732b/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "0411c98a8b951ad057769b1c41b0467335068baa",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in VirtualNetworkApplianceManager - happened when stopped domR start was initiated by user vm start",
        "parent": "https://github.com/apache/cloudstack/commit/a8ce46b57aac08b89e3d874d9ef1d9460dede27c",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_1a0ec2a": {
        "bug_id": "cloudstack_1a0ec2a",
        "commit": "https://github.com/apache/cloudstack/commit/1a0ec2a00f8cd2a1961d4a5dad793e3565a57640",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/1a0ec2a00f8cd2a1961d4a5dad793e3565a57640/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=1a0ec2a00f8cd2a1961d4a5dad793e3565a57640",
                "deletions": 3,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1094,9 +1094,11 @@ public IpForwardingRuleResponse createIpForwardingRuleResponse(FirewallRule fwRu\n         response.setPublicIpAddress(fwRule.getPublicIpAddress());\n         if (fwRule.getPublicIpAddress() != null && fwRule.getPrivateIpAddress() != null) {\n             UserVm vm = ApiDBUtils.findUserVmByPublicIpAndGuestIp(fwRule.getPublicIpAddress(), fwRule.getPrivateIpAddress());\n-            response.setVirtualMachineId(vm.getId());\n-            response.setVirtualMachineName(vm.getHostName());\n-            response.setVirtualMachineDisplayName(vm.getDisplayName());\n+            if(vm != null){//vm might be destroyed\n+            \tresponse.setVirtualMachineId(vm.getId());\n+            \tresponse.setVirtualMachineName(vm.getHostName());\n+            \tresponse.setVirtualMachineDisplayName(vm.getDisplayName());\n+            }\n         }\n         response.setObjectName(\"ipforwardingrule\");\n         return response;",
                "raw_url": "https://github.com/apache/cloudstack/raw/1a0ec2a00f8cd2a1961d4a5dad793e3565a57640/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "aa8ab7512f9dffb5aa1eb895e1ecfa6851f093d1",
                "status": "modified"
            }
        ],
        "message": "bug 7346: fixing the corner case where list ip forwarding rules is called for a rule, which is yet to be expunged, but the vm is destroyed. if you call list here, an npe results\nstatus 7346: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/ed9207014265095a6cf69297bb025238a4495d78",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_1cf165f": {
        "bug_id": "cloudstack_1cf165f",
        "commit": "https://github.com/apache/cloudstack/commit/1cf165f86df718bdbd1db1f094a341c8abaca42e",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/1cf165f86df718bdbd1db1f094a341c8abaca42e/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=1cf165f86df718bdbd1db1f094a341c8abaca42e",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -500,7 +500,10 @@ public VMSnapshotResponse createVMSnapshotResponse(VMSnapshot vmSnapshot) {\n             vmSnapshotResponse.setVirtualMachineid(vm.getUuid());\n         }\n         if (vmSnapshot.getParent() != null) {\n-            vmSnapshotResponse.setParentName(ApiDBUtils.getVMSnapshotById(vmSnapshot.getParent()).getDisplayName());\n+            VMSnapshot vmSnapshotParent = ApiDBUtils.getVMSnapshotById(vmSnapshot.getParent());\n+            if (vmSnapshotParent != null) {\n+                vmSnapshotResponse.setParentName(vmSnapshotParent.getDisplayName());\n+            }\n         }\n         vmSnapshotResponse.setCurrent(vmSnapshot.getCurrent());\n         vmSnapshotResponse.setType(vmSnapshot.getType().toString());",
                "raw_url": "https://github.com/apache/cloudstack/raw/1cf165f86df718bdbd1db1f094a341c8abaca42e/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "a13e99694238a140833c30693ebfc5501d42457b",
                "status": "modified"
            }
        ],
        "message": "ApiResponseHelper: fix NPE when parent of snapshot is null",
        "parent": "https://github.com/apache/cloudstack/commit/ca0a77088c773516d07c24df8613ac9ff334a441",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_1d4a59c": {
        "bug_id": "cloudstack_1d4a59c",
        "commit": "https://github.com/apache/cloudstack/commit/1d4a59ce73d9715675f1539ef4a2d5156c82771c",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/1d4a59ce73d9715675f1539ef4a2d5156c82771c/server/src/com/cloud/agent/manager/AgentManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/agent/manager/AgentManagerImpl.java?ref=1d4a59ce73d9715675f1539ef4a2d5156c82771c",
                "deletions": 8,
                "filename": "server/src/com/cloud/agent/manager/AgentManagerImpl.java",
                "patch": "@@ -74,7 +74,6 @@\n import com.cloud.agent.transport.Request;\n import com.cloud.agent.transport.Response;\n import com.cloud.alert.AlertManager;\n-import com.cloud.api.ApiConstants;\n import com.cloud.api.commands.AddClusterCmd;\n import com.cloud.api.commands.AddHostCmd;\n import com.cloud.api.commands.AddSecondaryStorageCmd;\n@@ -541,7 +540,7 @@ public Host findHost(final Host.Type type, final DataCenterVO dc, final HostPodV\n     }\n \n     protected AgentAttache handleDirectConnect(ServerResource resource, StartupCommand[] startup, Map<String, String> details, boolean old, List<String> hostTags, String allocationState)\n-            throws ConnectionException {\n+    throws ConnectionException {\n         if (startup == null) {\n             return null;\n         }\n@@ -567,7 +566,7 @@ protected AgentAttache handleDirectConnect(ServerResource resource, StartupComma\n         String url = cmd.getUrl();\n         String username = cmd.getUsername();\n         String password = cmd.getPassword();\n-        \n+\n         url = URLDecoder.decode(url);\n \n         URI uri = null;\n@@ -807,7 +806,7 @@ private Discoverer getMatchingDiscover(Hypervisor.HypervisorType hypervisorType)\n \n     @Override\n     public List<HostVO> discoverHosts(Long dcId, Long podId, Long clusterId, String clusterName, String url, String username, String password, String hypervisorType, List<String> hostTags)\n-            throws IllegalArgumentException, DiscoveryException, InvalidParameterValueException {\n+    throws IllegalArgumentException, DiscoveryException, InvalidParameterValueException {\n         return discoverHostsFull(dcId, podId, clusterId, clusterName, url, username, password, hypervisorType, hostTags, null, null);\n     }\n \n@@ -1162,7 +1161,7 @@ public boolean deleteHost(long hostId, boolean isForced, User caller) {\n                         }\n                         if (!success) {\n                             String msg = \"Unable to eject host \" + host.getGuid() + \" due to there is no host up in this cluster, please execute xe pool-eject host-uuid=\" + host.getGuid()\n-                                    + \"in this host \" + host.getPrivateIpAddress();\n+                            + \"in this host \" + host.getPrivateIpAddress();\n                             s_logger.warn(msg);\n                             _alertMgr.sendAlert(AlertManager.ALERT_TYPE_HOST, host.getDataCenterId(), host.getPodId(), \"Unable to eject host \" + host.getGuid(), msg);\n                         }\n@@ -2271,7 +2270,7 @@ public Host addHost(long zoneId, ServerResource resource, Type hostType, Map<Str\n     }\n \n     public HostVO createHost(final StartupCommand startup, ServerResource resource, Map<String, String> details, boolean directFirst, List<String> hostTags, String allocationState)\n-            throws IllegalArgumentException {\n+    throws IllegalArgumentException {\n         Host.Type type = null;\n \n         if (startup instanceof StartupStorageCommand) {\n@@ -2394,7 +2393,7 @@ public HostVO createHost(final StartupCommand startup, ServerResource resource,\n     }\n \n     public HostVO createHost(final StartupCommand[] startup, ServerResource resource, Map<String, String> details, boolean directFirst, List<String> hostTags, String allocationState)\n-            throws IllegalArgumentException {\n+    throws IllegalArgumentException {\n         StartupCommand firstCmd = startup[0];\n         HostVO result = createHost(firstCmd, resource, details, directFirst, hostTags, allocationState);\n         if (result == null) {\n@@ -2735,7 +2734,7 @@ private void createCapacityEntry(final StartupCommand startup, HostVO server) {\n             capacityCPU.addAnd(\"dataCenterId\", SearchCriteria.Op.EQ, server.getDataCenterId());\n             capacityCPU.addAnd(\"podId\", SearchCriteria.Op.EQ, server.getPodId());\n             capacityCPU.addAnd(\"capacityType\", SearchCriteria.Op.EQ, CapacityVO.CAPACITY_TYPE_CPU);\n-            List<CapacityVO> capacityVOCpus = _capacityDao.search(capacitySC, null);\n+            List<CapacityVO> capacityVOCpus = _capacityDao.search(capacityCPU, null);\n \n             if (capacityVOCpus != null && !capacityVOCpus.isEmpty()) {\n                 CapacityVO CapacityVOCpu = capacityVOCpus.get(0);",
                "raw_url": "https://github.com/apache/cloudstack/raw/1d4a59ce73d9715675f1539ef4a2d5156c82771c/server/src/com/cloud/agent/manager/AgentManagerImpl.java",
                "sha": "63c51cdc8a001cd627a64d421a331182347804ee",
                "status": "modified"
            },
            {
                "additions": 148,
                "blob_url": "https://github.com/apache/cloudstack/blob/1d4a59ce73d9715675f1539ef4a2d5156c82771c/server/src/com/cloud/capacity/CapacityManagerImpl.java",
                "changes": 283,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/capacity/CapacityManagerImpl.java?ref=1d4a59ce73d9715675f1539ef4a2d5156c82771c",
                "deletions": 135,
                "filename": "server/src/com/cloud/capacity/CapacityManagerImpl.java",
                "patch": "@@ -34,7 +34,6 @@\n import com.cloud.configuration.dao.ConfigurationDao;\n import com.cloud.host.Host;\n import com.cloud.host.HostVO;\n-import com.cloud.host.Status;\n import com.cloud.host.dao.HostDao;\n import com.cloud.offering.ServiceOffering;\n import com.cloud.service.ServiceOfferingVO;\n@@ -44,7 +43,6 @@\n import com.cloud.utils.component.Inject;\n import com.cloud.utils.concurrency.NamedThreadFactory;\n import com.cloud.utils.db.DB;\n-import com.cloud.utils.db.SearchCriteria;\n import com.cloud.utils.db.Transaction;\n import com.cloud.utils.fsm.StateListener;\n import com.cloud.vm.VMInstanceVO;\n@@ -68,7 +66,7 @@\n     private int _vmCapacityReleaseInterval;\n     private ScheduledExecutorService _executor;\n     private boolean _stopped;\n-    \n+\n \n     @Override\n     public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n@@ -109,7 +107,7 @@ public boolean releaseVmCapacity(VirtualMachine vm, boolean moveFromReserved, bo\n         if (capacityCpu == null || capacityMemory == null || svo == null) {\n             return false;\n         }\n-        \n+\n         Transaction txn = Transaction.currentTxn();\n         try {\n             txn.start();\n@@ -127,7 +125,7 @@ public boolean releaseVmCapacity(VirtualMachine vm, boolean moveFromReserved, bo\n             long actualTotalCpu = capacityCpu.getTotalCapacity();\n             String opFactor = _configDao.getValue(Config.CPUOverprovisioningFactor.key());\n             float cpuOverprovisioningFactor = NumbersUtil.parseFloat(opFactor, 1);\n-    \t\tlong totalCpu = (long)(actualTotalCpu * cpuOverprovisioningFactor);\n+            long totalCpu = (long)(actualTotalCpu * cpuOverprovisioningFactor);\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Hosts's actual total CPU: \" + actualTotalCpu + \" and CPU after applying overprovisioning: \" + totalCpu);\n             }\n@@ -177,15 +175,15 @@ public boolean releaseVmCapacity(VirtualMachine vm, boolean moveFromReserved, bo\n             return false;\n         }\n     }\n-        \n+\n     @DB\n     @Override\n     public void allocateVmCapacity(VirtualMachine vm, boolean fromLastHost) {\n \n-    \tlong hostId = vm.getHostId();\n-    \t\n-    \tServiceOfferingVO svo = _offeringsDao.findById(vm.getServiceOfferingId());\n-    \t\n+        long hostId = vm.getHostId();\n+\n+        ServiceOfferingVO svo = _offeringsDao.findById(vm.getServiceOfferingId());\n+\n         CapacityVO capacityCpu = _capacityDao.findByHostIdType(hostId, CapacityVO.CAPACITY_TYPE_CPU);\n         CapacityVO capacityMem = _capacityDao.findByHostIdType(hostId, CapacityVO.CAPACITY_TYPE_MEMORY);\n \n@@ -195,10 +193,10 @@ public void allocateVmCapacity(VirtualMachine vm, boolean fromLastHost) {\n \n         int cpu = svo.getCpu() * svo.getSpeed();\n         long ram = svo.getRamSize() * 1024L * 1024L;\n-        \n+\n         String opFactor = _configDao.getValue(Config.CPUOverprovisioningFactor.key());\n         float cpuOverprovisioningFactor = NumbersUtil.parseFloat(opFactor, 1);\n-    \t\n+\n         Transaction txn = Transaction.currentTxn();\n \n         try {\n@@ -211,40 +209,40 @@ public void allocateVmCapacity(VirtualMachine vm, boolean fromLastHost) {\n             long reservedCpu = capacityCpu.getReservedCapacity();\n             long reservedMem = capacityMem.getReservedCapacity();\n             long actualTotalCpu = capacityCpu.getTotalCapacity();\n-    \t\tlong totalCpu = (long)(actualTotalCpu * cpuOverprovisioningFactor);\n+            long totalCpu = (long)(actualTotalCpu * cpuOverprovisioningFactor);\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Hosts's actual total CPU: \" + actualTotalCpu + \" and CPU after applying overprovisioning: \" + totalCpu);\n             }\n             long totalMem = capacityMem.getTotalCapacity();\n-            \n-\t\t\tlong freeCpu = totalCpu - (reservedCpu + usedCpu);\n-\t\t\tlong freeMem = totalMem - (reservedMem + usedMem);\n-\n-\t        if (s_logger.isDebugEnabled()) {\n-\t        \ts_logger.debug(\"We are allocating VM, increasing the used capacity of this host:\"+ hostId);\n-\t            s_logger.debug(\"Current Used CPU: \"+usedCpu + \" , Free CPU:\"+freeCpu+\" ,Requested CPU: \"+cpu);\n-\t            s_logger.debug(\"Current Used RAM: \"+usedMem + \" , Free RAM:\"+freeMem+\" ,Requested RAM: \"+ram);\n-\t        } \n+\n+            long freeCpu = totalCpu - (reservedCpu + usedCpu);\n+            long freeMem = totalMem - (reservedMem + usedMem);\n+\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"We are allocating VM, increasing the used capacity of this host:\"+ hostId);\n+                s_logger.debug(\"Current Used CPU: \"+usedCpu + \" , Free CPU:\"+freeCpu+\" ,Requested CPU: \"+cpu);\n+                s_logger.debug(\"Current Used RAM: \"+usedMem + \" , Free RAM:\"+freeMem+\" ,Requested RAM: \"+ram);\n+            } \n             capacityCpu.setUsedCapacity(usedCpu + cpu);\n             capacityMem.setUsedCapacity(usedMem + ram);\n-            \n+\n             if (fromLastHost) {\n-            \t/*alloc from reserved*/\n-    \t        if (s_logger.isDebugEnabled()) {\n-    \t        \ts_logger.debug(\"We are allocating VM to the last host again, so adjusting the reserved capacity if it is not less than required\");\n-    \t            s_logger.debug(\"Reserved CPU: \"+reservedCpu + \" , Requested CPU: \"+cpu);\n-    \t            s_logger.debug(\"Reserved RAM: \"+reservedMem + \" , Requested RAM: \"+ram);\n-    \t        }                \n+                /*alloc from reserved*/\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"We are allocating VM to the last host again, so adjusting the reserved capacity if it is not less than required\");\n+                    s_logger.debug(\"Reserved CPU: \"+reservedCpu + \" , Requested CPU: \"+cpu);\n+                    s_logger.debug(\"Reserved RAM: \"+reservedMem + \" , Requested RAM: \"+ram);\n+                }                \n                 if (reservedCpu >= cpu && reservedMem >= ram) {\n                     capacityCpu.setReservedCapacity(reservedCpu - cpu);\n                     capacityMem.setReservedCapacity(reservedMem - ram);        \n                 }\n             } else {\n                 /*alloc from free resource*/\n                 if (!((reservedCpu + usedCpu + cpu <= totalCpu) && (reservedMem + usedMem + ram <= totalMem))) {\n-                \tif (s_logger.isDebugEnabled()) {\n-        \t            s_logger.debug(\"Host doesnt seem to have enough free capacity, but increasing the used capacity anyways, since the VM is already starting on this host \");\n-        \t        }\n+                    if (s_logger.isDebugEnabled()) {\n+                        s_logger.debug(\"Host doesnt seem to have enough free capacity, but increasing the used capacity anyways, since the VM is already starting on this host \");\n+                    }\n                 }\n             }\n \n@@ -265,101 +263,116 @@ public void allocateVmCapacity(VirtualMachine vm, boolean fromLastHost) {\n             return;\n         }               \n     }\n-    \n+\n     @Override\n     public boolean checkIfHostHasCapacity(long hostId, Integer cpu, long ram, boolean checkFromReservedCapacity, float cpuOverprovisioningFactor){\n-       \tboolean hasCapacity = false;\n-       \t\n+        boolean hasCapacity = false;\n+\n         if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Checking if host: \" + hostId + \" has enough capacity for requested CPU: \"+ cpu + \" and requested RAM: \"+ ram + \" , cpuOverprovisioningFactor: \"+cpuOverprovisioningFactor);\n         }\n-       \t\n-       \tCapacityVO capacityCpu = _capacityDao.findByHostIdType(hostId, CapacityVO.CAPACITY_TYPE_CPU);\n-       \tCapacityVO capacityMem = _capacityDao.findByHostIdType(hostId, CapacityVO.CAPACITY_TYPE_MEMORY);\n-\n-\t\tlong usedCpu = capacityCpu.getUsedCapacity();\n-\t\tlong usedMem = capacityMem.getUsedCapacity();\n-\t\tlong reservedCpu = capacityCpu.getReservedCapacity();\n-\t\tlong reservedMem = capacityMem.getReservedCapacity();\n+\n+        CapacityVO capacityCpu = _capacityDao.findByHostIdType(hostId, CapacityVO.CAPACITY_TYPE_CPU);\n+        CapacityVO capacityMem = _capacityDao.findByHostIdType(hostId, CapacityVO.CAPACITY_TYPE_MEMORY);\n+\n+        if (capacityCpu == null || capacityMem == null) {\n+            if(capacityCpu == null){\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Cannot checkIfHostHasCapacity, Capacity entry for CPU not found in Db, for hostId: \"+ hostId);\n+                }\n+            }\n+            if(capacityMem == null){\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Cannot checkIfHostHasCapacity, Capacity entry for RAM not found in Db, for hostId: \"+ hostId);\n+                }\n+            }\n+\n+            return false;\n+        }       \t\n+\n+        long usedCpu = capacityCpu.getUsedCapacity();\n+        long usedMem = capacityMem.getUsedCapacity();\n+        long reservedCpu = capacityCpu.getReservedCapacity();\n+        long reservedMem = capacityMem.getReservedCapacity();\n         long actualTotalCpu = capacityCpu.getTotalCapacity();\n-\t\tlong totalCpu = (long)(actualTotalCpu * cpuOverprovisioningFactor);\n+        long totalCpu = (long)(actualTotalCpu * cpuOverprovisioningFactor);\n         if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Hosts's actual total CPU: \" + actualTotalCpu + \" and CPU after applying overprovisioning: \" + totalCpu);\n         }\n \n-\t\tlong totalMem = capacityMem.getTotalCapacity();\n-\t\t\n-\t\t\n-\t\tString failureReason = \"\";\n-\t\tif (checkFromReservedCapacity) {\n-\t\t\tlong freeCpu = reservedCpu;\n-\t\t\tlong freeMem = reservedMem;\n-\t\t\t\n-\t        if (s_logger.isDebugEnabled()) {\n-\t        \ts_logger.debug(\"We need to allocate to the last host again, so checking if there is enough reserved capacity\");\n-\t            s_logger.debug(\"Reserved CPU: \"+freeCpu + \" , Requested CPU: \"+cpu);\n-\t            s_logger.debug(\"Reserved RAM: \"+freeMem + \" , Requested RAM: \"+ram);\n-\t        }\t\n-\t\t\t/*alloc from reserved*/\n-\t\t\tif (reservedCpu >= cpu){ \n-\t\t\t\tif(reservedMem >= ram) {\n-\t\t\t\t\thasCapacity = true;\n-\t\t\t\t}else{\n-\t\t\t\t\tfailureReason = \"Host does not have enough reserved RAM available\";\n-\t\t\t\t}\n-\t\t\t}else{\n-\t\t\t\tfailureReason = \"Host does not have enough reserved CPU available\";\n-\t\t\t}\t\t\n-\t\t} else {\n-\t\t\tlong freeCpu = totalCpu - (reservedCpu + usedCpu);\n-\t\t\tlong freeMem = totalMem - (reservedMem + usedMem);\n-\t\t\t\n-\t        if (s_logger.isDebugEnabled()) {\n-\t            s_logger.debug(\"Free CPU: \"+freeCpu + \" , Requested CPU: \"+cpu);\n-\t            s_logger.debug(\"Free RAM: \"+freeMem + \" , Requested RAM: \"+ram);\n-\t        }\t\t\t\n-\t\t\t/*alloc from free resource*/\n-\t\t\tif ((reservedCpu + usedCpu + cpu <= totalCpu)) {\n-\t\t\t\tif((reservedMem + usedMem + ram <= totalMem)){\n-\t\t\t\t\thasCapacity = true;\n-\t\t\t\t}else{\n-\t\t\t\t\tfailureReason = \"Host does not have enough RAM available\";\n-\t\t\t\t}\n-\t\t\t}else{\n-\t\t\t\tfailureReason = \"Host does not have enough CPU available\";\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (hasCapacity) {\n-\t        if (s_logger.isDebugEnabled()) {\n-\t            s_logger.debug(\"Host has enough CPU and RAM available\");\n-\t        }\n-\t        \n-\t\t\ts_logger.debug(\"STATS: Can alloc CPU from host: \" + hostId + \", used: \" + usedCpu + \", reserved: \" +\n-\t\t\t\t\treservedCpu + \", actual total: \"+actualTotalCpu + \", total with overprovisioning: \" + totalCpu +\n-\t\t\t\t\t\"; requested cpu:\" + cpu + \",alloc_from_last_host?:\" + checkFromReservedCapacity);\n-   \t\t\n-\t\t\ts_logger.debug(\"STATS: Can alloc MEM from host: \" + hostId + \", used: \" + usedMem + \", reserved: \" +\n-   \t\t\t\treservedMem + \", total: \" + totalMem + \"; requested mem: \" + ram + \",alloc_from_last_host?:\" + checkFromReservedCapacity);\n-       \t} else {\n-       \t\t\n-       \t\tif (checkFromReservedCapacity) {\n-       \t\t\ts_logger.debug(\"STATS: Failed to alloc resource from host: \" + hostId + \" reservedCpu: \" + reservedCpu + \", requested cpu: \" + cpu +\n-       \t\t\t\t\t\", reservedMem: \" + reservedMem + \", requested mem: \" + ram); \n-       \t\t} else {\n-       \t\t\ts_logger.debug(\"STATS: Failed to alloc resource from host: \" + hostId + \" reservedCpu: \" + reservedCpu + \", used cpu: \" + usedCpu + \", requested cpu: \" + cpu +\n-       \t\t\t\t\t\", actual total cpu: \"+actualTotalCpu + \", total cpu with overprovisioning: \" + totalCpu + \n-       \t\t\t\t\t\", reservedMem: \" + reservedMem + \", used Mem: \" + usedMem + \", requested mem: \" + ram + \", total Mem:\" + totalMem); \n-       \t\t}\n-       \t\t\n-\t        if (s_logger.isDebugEnabled()) {\n-\t            s_logger.debug(failureReason + \", cannot allocate to this host.\");\n-\t        }\n+        long totalMem = capacityMem.getTotalCapacity();\n+\n+\n+        String failureReason = \"\";\n+        if (checkFromReservedCapacity) {\n+            long freeCpu = reservedCpu;\n+            long freeMem = reservedMem;\n+\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"We need to allocate to the last host again, so checking if there is enough reserved capacity\");\n+                s_logger.debug(\"Reserved CPU: \"+freeCpu + \" , Requested CPU: \"+cpu);\n+                s_logger.debug(\"Reserved RAM: \"+freeMem + \" , Requested RAM: \"+ram);\n+            }\t\n+            /*alloc from reserved*/\n+            if (reservedCpu >= cpu){ \n+                if(reservedMem >= ram) {\n+                    hasCapacity = true;\n+                }else{\n+                    failureReason = \"Host does not have enough reserved RAM available\";\n+                }\n+            }else{\n+                failureReason = \"Host does not have enough reserved CPU available\";\n+            }\t\t\n+        } else {\n+            long freeCpu = totalCpu - (reservedCpu + usedCpu);\n+            long freeMem = totalMem - (reservedMem + usedMem);\n+\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Free CPU: \"+freeCpu + \" , Requested CPU: \"+cpu);\n+                s_logger.debug(\"Free RAM: \"+freeMem + \" , Requested RAM: \"+ram);\n+            }\t\t\t\n+            /*alloc from free resource*/\n+            if ((reservedCpu + usedCpu + cpu <= totalCpu)) {\n+                if((reservedMem + usedMem + ram <= totalMem)){\n+                    hasCapacity = true;\n+                }else{\n+                    failureReason = \"Host does not have enough RAM available\";\n+                }\n+            }else{\n+                failureReason = \"Host does not have enough CPU available\";\n+            }\n+        }\n+\n+        if (hasCapacity) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Host has enough CPU and RAM available\");\n+            }\n+\n+            s_logger.debug(\"STATS: Can alloc CPU from host: \" + hostId + \", used: \" + usedCpu + \", reserved: \" +\n+                    reservedCpu + \", actual total: \"+actualTotalCpu + \", total with overprovisioning: \" + totalCpu +\n+                    \"; requested cpu:\" + cpu + \",alloc_from_last_host?:\" + checkFromReservedCapacity);\n+\n+            s_logger.debug(\"STATS: Can alloc MEM from host: \" + hostId + \", used: \" + usedMem + \", reserved: \" +\n+                    reservedMem + \", total: \" + totalMem + \"; requested mem: \" + ram + \",alloc_from_last_host?:\" + checkFromReservedCapacity);\n+        } else {\n+\n+            if (checkFromReservedCapacity) {\n+                s_logger.debug(\"STATS: Failed to alloc resource from host: \" + hostId + \" reservedCpu: \" + reservedCpu + \", requested cpu: \" + cpu +\n+                        \", reservedMem: \" + reservedMem + \", requested mem: \" + ram); \n+            } else {\n+                s_logger.debug(\"STATS: Failed to alloc resource from host: \" + hostId + \" reservedCpu: \" + reservedCpu + \", used cpu: \" + usedCpu + \", requested cpu: \" + cpu +\n+                        \", actual total cpu: \"+actualTotalCpu + \", total cpu with overprovisioning: \" + totalCpu + \n+                        \", reservedMem: \" + reservedMem + \", used Mem: \" + usedMem + \", requested mem: \" + ram + \", total Mem:\" + totalMem); \n+            }\n+\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(failureReason + \", cannot allocate to this host.\");\n+            }\n         }\n-       \t\n-    \treturn hasCapacity;\n-     \n-       }\n+\n+        return hasCapacity;\n+\n+    }\n \n     public class HostCapacityCollector implements Runnable {\n \n@@ -453,16 +466,16 @@ public boolean preStateTransitionEvent(State oldState,\n             Event event, State newState, VirtualMachine vm, boolean transitionStatus, Long id) {\n         return true;\n     }\n-    \n+\n     @Override\n     public boolean postStateTransitionEvent(State oldState, Event event, State newState, VirtualMachine vm, boolean status, Long oldHostId) {\n         if (!status) {\n             return false;\n         }\n-        \n+\n         s_logger.debug(\"VM state transitted from :\" + oldState + \" to \" + newState + \" with event: \" + event +\n                 \"vm's original host id: \" + vm.getLastHostId() + \" new host id: \" + vm.getHostId() + \" host id before state transition: \" + oldHostId);\n-      \n+\n \n         if (oldState == State.Starting) {\n             if (event == Event.OperationFailed) {\n@@ -474,18 +487,18 @@ public boolean postStateTransitionEvent(State oldState, Event event, State newSt\n             }\n         } else if (oldState == State.Running) {\n             if (event == Event.AgentReportStopped) {\n-               releaseVmCapacity(vm, false, true, oldHostId);\n+                releaseVmCapacity(vm, false, true, oldHostId);\n             }\n         } else if (oldState == State.Migrating) {\n             if (event == Event.AgentReportStopped) {\n                 /*Release capacity from original host*/\n-               releaseVmCapacity(vm, false, false, vm.getLastHostId());\n-               releaseVmCapacity(vm, false, true, oldHostId);\n+                releaseVmCapacity(vm, false, false, vm.getLastHostId());\n+                releaseVmCapacity(vm, false, true, oldHostId);\n             } else if (event == Event.OperationFailed) {\n-               /*Release from dest host*/\n+                /*Release from dest host*/\n                 releaseVmCapacity(vm, false, false, oldHostId);\n             } else if (event == Event.OperationSucceeded) {\n-               releaseVmCapacity(vm, false, false, vm.getLastHostId());\n+                releaseVmCapacity(vm, false, false, vm.getLastHostId());\n             }\n         } else if (oldState == State.Stopping) {\n             if (event == Event.AgentReportStopped || event == Event.OperationSucceeded) {\n@@ -496,18 +509,18 @@ public boolean postStateTransitionEvent(State oldState, Event event, State newSt\n                 releaseVmCapacity(vm, true, false, vm.getLastHostId());\n             }\n         }\n-        \n-\n-    \tif((newState == State.Starting || newState == State.Migrating) && vm.getHostId() != null){\n-    \t\tboolean fromLastHost = false;\n-    \t\tif(vm.getLastHostId() == vm.getHostId()){\n-    \t\t\ts_logger.debug(\"VM starting again on the last host it was stopped on\");\n-    \t\t\tfromLastHost = true;\n-    \t\t}\n-    \t\tallocateVmCapacity(vm,fromLastHost);\n+\n+\n+        if((newState == State.Starting || newState == State.Migrating) && vm.getHostId() != null){\n+            boolean fromLastHost = false;\n+            if(vm.getLastHostId() == vm.getHostId()){\n+                s_logger.debug(\"VM starting again on the last host it was stopped on\");\n+                fromLastHost = true;\n+            }\n+            allocateVmCapacity(vm,fromLastHost);\n         }\n-        \n+\n         return true;\n     }\n-    \n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/1d4a59ce73d9715675f1539ef4a2d5156c82771c/server/src/com/cloud/capacity/CapacityManagerImpl.java",
                "sha": "6eb9c077928e3916e332d20bfaeefdf6346deefd",
                "status": "modified"
            }
        ],
        "message": "Bug 9666 - hostId and spoolId overlap in op_host_capacity table\n\nChanges:\n- When a host connects, we check if it has a CPU and RAM entry in capacity table. If the entry is found, the values are updated if possible. If the entry is not found a new one is inserted.\n- The searchCriteria used to check if CPU entry is present was wrong. We were passing in a criteria which did not specify capacityType. So for hostId >= 200, the serach would return capacity entries of storage pools also since poolIDs start from 200 onwards.\n- Since an entry was found (although the wrong one), we tried to update it. But update does not happen since the capacity ranges dont match.\nAnd a new insert for CPU also does not happen since an entry is found.\n- So as a result CPU entries are never inserted in the table for hostIds >=200\n\n- As a fix, corrected the search criteria.\n- During VM deployment, when the entry is not found, we get a NPE. Added a null check to avoid that.",
        "parent": "https://github.com/apache/cloudstack/commit/c6965f06ccd75dd24fd8885818fb07407baebc44",
        "repo": "cloudstack",
        "unit_tests": [
            "AgentManagerImplTest.java"
        ]
    },
    "cloudstack_1e8126a": {
        "bug_id": "cloudstack_1e8126a",
        "commit": "https://github.com/apache/cloudstack/commit/1e8126afbf8c4473a4fb0f3bf6dc5c9df6823e9f",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/1e8126afbf8c4473a4fb0f3bf6dc5c9df6823e9f/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java?ref=1e8126afbf8c4473a4fb0f3bf6dc5c9df6823e9f",
                "deletions": 0,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "patch": "@@ -1523,6 +1523,8 @@ public NicProfile prepareNic(final VirtualMachineProfile vmProfile, final Deploy\n             nic.setIPv4Address(profile.getIPv4Address());\n             nic.setAddressFormat(profile.getFormat());\n             nic.setIPv6Address(profile.getIPv6Address());\n+            nic.setIPv6Cidr(profile.getIPv6Cidr());\n+            nic.setIPv6Gateway(profile.getIPv6Gateway());\n             nic.setMacAddress(profile.getMacAddress());\n             nic.setIsolationUri(profile.getIsolationUri());\n             nic.setBroadcastUri(profile.getBroadCastUri());",
                "raw_url": "https://github.com/apache/cloudstack/raw/1e8126afbf8c4473a4fb0f3bf6dc5c9df6823e9f/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "sha": "a2505fbe638e95ca16fabbeb1e09488b9514b973",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1927 from wido/ipv6-ssvm-fix\n\nipv6: Set IPv6 CIDR and Gateway in 'nic' profileWithout this information a NPE might be triggered when starting a VR, SSVM or CP\nas this information is read from the 'nics' table and causes a NPE.\n\nDuring deployment we should set the IPv6 Gateway and CIDR for the NIC object so that\nit is persisted to the database.\n\nSigned-off-by: Wido den Hollander <wido@widodh.nl>\n\n* pr/1927:\n  ipv6: Set IPv6 CIDR and Gateway in 'nic' profile\n\nSigned-off-by: Rajani Karuturi <rajani.karuturi@accelerite.com>",
        "parent": "https://github.com/apache/cloudstack/commit/cd68e99148ac9ed96a8d1906b206cb5c5bcee11b",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkOrchestratorTest.java"
        ]
    },
    "cloudstack_1edf772": {
        "bug_id": "cloudstack_1edf772",
        "commit": "https://github.com/apache/cloudstack/commit/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=1edf772f92dd645d3e00dfe373ddb8a5ac4b864b",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1525,7 +1525,7 @@ protected Command compareState(long hostId, VMInstanceVO vm, final AgentVmInfo i\n         }\n         \n         if(trackExternalChange) {\n-        \tif(hostId != vm.getHostId()) {\n+        \tif(vm.getHostId() == null || hostId != vm.getHostId()) {\n         \t\ttry {\n         \t\t\tstateTransitTo(vm, VirtualMachine.Event.AgentReportMigrated, hostId);\n         \t\t} catch (NoTransitionException e) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "798f8f5b3dd10ea061b4a0f00effaf78d6a73d00",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/setup/db/db/schema-225to226.sql",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-225to226.sql?ref=1edf772f92dd645d3e00dfe373ddb8a5ac4b864b",
                "deletions": 0,
                "filename": "setup/db/db/schema-225to226.sql",
                "patch": "@@ -9,5 +9,27 @@ ALTER TABLE `cloud`.`network_offerings` ADD COLUMN `unique_name` varchar(64) NOT\n UPDATE `cloud`.`network_offerings` SET unique_name=name;\n ALTER TABLE `cloud`.`network_offerings` MODIFY `unique_name` varchar(64) NOT NULL UNIQUE COMMENT 'unique name of the network offering';\n \n+DROP TABLE IF EXISTS `cloud`.`certificate`;\n+CREATE TABLE IF NOT EXISTS `cloud`.`keystore` (\n+  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\n+  `name` varchar(64) NOT NULL COMMENT 'unique name for the certifiation',\n+  `certificate` text NOT NULL COMMENT 'the actual certificate being stored in the db',\n+  `key` text NOT NULL COMMENT 'private key associated wih the certificate',\n+  `domain_suffix` varchar(256) NOT NULL COMMENT 'DNS domain suffix associated with the certificate',\n+  PRIMARY KEY (`id`),\n+  UNIQUE(name)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n \n+CREATE TABLE IF NOT EXISTS `cloud`.`cmd_exec_log` (\n+  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\n+  `host_id` bigint unsigned NOT NULL COMMENT 'host id of the system VM agent that command is sent to',\n+  `instance_id` bigint unsigned NOT NULL COMMENT 'instance id of the system VM that command is executed on',\n+  `command_name` varchar(255) NOT NULL COMMENT 'command name',\n+  `weight` integer NOT NULL DEFAULT 1 COMMENT 'command weight in consideration of the load factor added to host that is executing the command',\n+  `created` datetime NOT NULL COMMENT 'date created',\n+  PRIMARY KEY (`id`),\n+  INDEX `i_cmd_exec_log__host_id`(`host_id`),\n+  INDEX `i_cmd_exec_log__instance_id`(`instance_id`),\n+  CONSTRAINT `fk_cmd_exec_log_ref__inst_id` FOREIGN KEY (`instance_id`) REFERENCES `vm_instance`(`id`) ON DELETE CASCADE\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/setup/db/db/schema-225to226.sql",
                "sha": "eb39f0c91a9c888f5f6227536bdb76be66bb40bb",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/setup/db/db/schema-227to228.sql",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-227to228.sql?ref=1edf772f92dd645d3e00dfe373ddb8a5ac4b864b",
                "deletions": 3,
                "filename": "setup/db/db/schema-227to228.sql",
                "patch": "@@ -11,7 +11,7 @@ ALTER TABLE `cloud`.`service_offering` ADD COLUMN `vm_type` varchar(32) COMMENT\n ALTER TABLE `cloud`.`storage_pool` MODIFY `host_address` varchar(255) NOT NULL;\r\n \r\n DROP TABLE IF EXISTS `cloud`.`certificate`;\r\n-CREATE TABLE `cloud`.`keystore` (\r\n+CREATE TABLE IF NOT EXISTS `cloud`.`keystore` (\r\n   `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\r\n   `name` varchar(64) NOT NULL COMMENT 'unique name for the certifiation',\r\n   `certificate` text NOT NULL COMMENT 'the actual certificate being stored in the db',\r\n@@ -21,7 +21,7 @@ CREATE TABLE `cloud`.`keystore` (\n   UNIQUE(name)\r\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\r\n \r\n-CREATE TABLE `cloud`.`cmd_exec_log` (\r\n+CREATE TABLE IF NOT EXISTS `cloud`.`cmd_exec_log` (\r\n   `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\r\n   `host_id` bigint unsigned NOT NULL COMMENT 'host id of the system VM agent that command is sent to',\r\n   `instance_id` bigint unsigned NOT NULL COMMENT 'instance id of the system VM that command is executed on',\r\n@@ -34,7 +34,7 @@ CREATE TABLE `cloud`.`cmd_exec_log` (\n   CONSTRAINT `fk_cmd_exec_log_ref__inst_id` FOREIGN KEY (`instance_id`) REFERENCES `vm_instance`(`id`) ON DELETE CASCADE\r\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\r\n \r\n-CREATE TABLE `cloud`.`network_tags` (\r\n+CREATE TABLE IF NOT EXISTS `cloud`.`network_tags` (\r\n   `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\r\n   `network_id` bigint unsigned NOT NULL COMMENT 'id of the network',\r\n   `tag` varchar(255) NOT NULL COMMENT 'tag',\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/setup/db/db/schema-227to228.sql",
                "sha": "3ce53a22e0fc93dfbd3ce8bdda0be640db4de841",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/utils/src/com/cloud/utils/StringUtils.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/StringUtils.java?ref=1edf772f92dd645d3e00dfe373ddb8a5ac4b864b",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/StringUtils.java",
                "patch": "@@ -119,4 +119,16 @@ public static String unicodeEscape(String s) {\n     \t}\n     \treturn sb.toString();\n     }\n+    \n+    public static String getMaskedPasswordForDisplay(String password) {\n+    \tif(password == null || password.isEmpty())\n+    \t\treturn \"*\";\n+    \t\n+    \tStringBuffer sb = new StringBuffer();\n+    \tsb.append(password.charAt(0));\n+    \tfor(int i = 1; i < password.length(); i++)\n+    \t\tsb.append(\"*\");\n+    \t\n+    \treturn sb.toString();\n+    }\n }\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/1edf772f92dd645d3e00dfe373ddb8a5ac4b864b/utils/src/com/cloud/utils/StringUtils.java",
                "sha": "f4226efe33385d9a70cd3e0abe184a2a810f0e59",
                "status": "modified"
            }
        ],
        "message": "bug 10480, 10494: NPE fix in VirtualMachineManagerImpl, move keystore upgrade sql to upgrade225to226.sql",
        "parent": "https://github.com/apache/cloudstack/commit/33624efd2f688818d15a9b88b6184ea56db583dc",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java",
            "StringUtilsTest.java"
        ]
    },
    "cloudstack_1ee9afd": {
        "bug_id": "cloudstack_1ee9afd",
        "commit": "https://github.com/apache/cloudstack/commit/1ee9afd8df9828f100946e83c31f98eb87de32fc",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/1ee9afd8df9828f100946e83c31f98eb87de32fc/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=1ee9afd8df9828f100946e83c31f98eb87de32fc",
                "deletions": 6,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -822,12 +822,14 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            volResponse.setVirtualMachineId(vm.getId());\n-            volResponse.setVirtualMachineName(vm.getHostName());\n-            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-            if (userVm != null) {\n-                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                volResponse.setVirtualMachineState(vm.getState().toString());\n+            if (vm != null) {\n+                volResponse.setVirtualMachineId(vm.getId());\n+                volResponse.setVirtualMachineName(vm.getHostName());\n+                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+                if (userVm != null) {\n+                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                    volResponse.setVirtualMachineState(vm.getState().toString());\n+                }\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/1ee9afd8df9828f100946e83c31f98eb87de32fc/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "f0b232b3d88c90013dece8a1de8729684fd91219",
                "status": "modified"
            }
        ],
        "message": "fix NPE when listvolume if vm got destroyed",
        "parent": "https://github.com/apache/cloudstack/commit/671b360df7175c007a221172ec75836b6855bc03",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_1efcc19": {
        "bug_id": "cloudstack_1efcc19",
        "commit": "https://github.com/apache/cloudstack/commit/1efcc19dbd0e609733f93089ce5cb2a5be84209b",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/1efcc19dbd0e609733f93089ce5cb2a5be84209b/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=1efcc19dbd0e609733f93089ce5cb2a5be84209b",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1748,6 +1748,10 @@ private void orchestrateStorageMigration(final String vmUuid, final StoragePool\n         final HostVO srcHost = _hostDao.findById(srchostId);\n         final Long srcClusterId = srcHost.getClusterId();\n \n+        if (destPool == null) {\n+            throw new CloudRuntimeException(\"Unable to migrate vm: missing destination storage pool\");\n+        }\n+\n         try {\n             stateTransitTo(vm, VirtualMachine.Event.StorageMigrationRequested, null);\n         } catch (final NoTransitionException e) {\n@@ -1763,7 +1767,7 @@ private void orchestrateStorageMigration(final String vmUuid, final StoragePool\n             if (migrationResult) {\n                 //if the vm is migrated to different pod in basic mode, need to reallocate ip\n \n-                if (!vm.getPodIdToDeployIn().equals(destPool.getPodId())) {\n+                if (destPool.getPodId() != null && !destPool.getPodId().equals(vm.getPodIdToDeployIn())) {\n                     final DataCenterDeployment plan = new DataCenterDeployment(vm.getDataCenterId(), destPool.getPodId(), null, null, null, null);\n                     final VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vm, null, null, null, null);\n                     _networkMgr.reallocate(vmProfile, plan);",
                "raw_url": "https://github.com/apache/cloudstack/raw/1efcc19dbd0e609733f93089ce5cb2a5be84209b/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "f972539fc7dd430bfd448200a5daac51f4a393dc",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8941: fix NPE when migrate vm to other zone-wide pools the second time",
        "parent": "https://github.com/apache/cloudstack/commit/f241455a632345540ccc727513e75473bba4418a",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_1f387b2": {
        "bug_id": "cloudstack_1f387b2",
        "commit": "https://github.com/apache/cloudstack/commit/1f387b298d577d39268be1e27c622ae0a5240492",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/1f387b298d577d39268be1e27c622ae0a5240492/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=1f387b298d577d39268be1e27c622ae0a5240492",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1162,7 +1162,13 @@ protected int getUpdatedPriority(Network guestNetwork, List<DomainRouterVO> rout\n                     physicalNetworkId = _networkMgr.findPhysicalNetworkId(network.getDataCenterId(), null);\n                 }\n                 PhysicalNetworkServiceProvider provider = _physicalProviderDao.findByServiceProvider(physicalNetworkId, typeString);\n+                if (provider == null) {\n+                    throw new CloudRuntimeException(\"Cannot find service provider \" + typeString + \" in physical network \" + physicalNetworkId);\n+                }\n                 VirtualRouterProvider vrProvider = _vrProviderDao.findByNspIdAndType(provider.getId(), type);\n+                if (vrProvider == null) {\n+                    throw new CloudRuntimeException(\"Cannot find virtual router provider \" + typeString + \" as service provider \" + provider.getId());\n+                }\n                 ServiceOfferingVO routerOffering = _serviceOfferingDao.findById(offering_id);\n                 int retry = 0;\n                 for (HypervisorType hType : supportedHypervisors) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/1f387b298d577d39268be1e27c622ae0a5240492/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "6363a47961863a67ae32318222430038fa7e075a",
                "status": "modified"
            }
        ],
        "message": "NaaS: Fix NPEs",
        "parent": "https://github.com/apache/cloudstack/commit/3051dc2621df0fc531899ef4b707bf72494b3810",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_1fa00d1": {
        "bug_id": "cloudstack_1fa00d1",
        "commit": "https://github.com/apache/cloudstack/commit/1fa00d14b11ff1e09c45cef53cddabca03604319",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/1fa00d14b11ff1e09c45cef53cddabca03604319/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java?ref=1fa00d14b11ff1e09c45cef53cddabca03604319",
                "deletions": 6,
                "filename": "agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "patch": "@@ -1988,12 +1988,6 @@ protected Answer execute(StopCommand cmd) {\n         try {\n         \tConnect conn = LibvirtConnection.getConnection();\n         \t\n-        \tString macAddress = null;\n-        \tif (vmName.startsWith(\"i-\")) {\n-        \t    List<InterfaceDef> nics = getInterfaces(conn, vmName);\n-        \t    macAddress = nics.get(0).getMacAddress();\n-        \t}\n-        \t\n         \tdestroy_network_rules_for_vm(conn, vmName);\n             String result = stopVM(conn, vmName, defineOps.UNDEFINE_VM);\n             ",
                "raw_url": "https://github.com/apache/cloudstack/raw/1fa00d14b11ff1e09c45cef53cddabca03604319/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "sha": "195754bd536efc791675ef36dca525e48285c1cd",
                "status": "modified"
            }
        ],
        "message": "fix NPE when stopvm",
        "parent": "https://github.com/apache/cloudstack/commit/cab765f85e976100b8a5b9477166ee70dfccfab1",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_21b1c94": {
        "bug_id": "cloudstack_21b1c94",
        "commit": "https://github.com/apache/cloudstack/commit/21b1c9449a1289db9fa92c2ec76a936006100ab3",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/21b1c9449a1289db9fa92c2ec76a936006100ab3/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=21b1c9449a1289db9fa92c2ec76a936006100ab3",
                "deletions": 10,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -734,16 +734,6 @@ protected boolean cleanupAccount(AccountVO account, long callerUserId, Account c\n             int vlansReleased = _accountGuestVlanMapDao.removeByAccountId(accountId);\n             s_logger.info(\"deleteAccount: Released \" + vlansReleased + \" dedicated guest vlan ranges from account \" + accountId);\n \n-            // Update resource count for this account and for parent domains.\n-            List<ResourceCountVO> resourceCounts = _resourceCountDao.listByOwnerId(accountId, ResourceOwnerType.Account);\n-            for (ResourceCountVO resourceCount : resourceCounts) {\n-                _resourceLimitMgr.decrementResourceCount(accountId, resourceCount.getType(), resourceCount.getCount());\n-            }\n-\n-            // Delete resource count and resource limits entries set for this account (if there are any).\n-            _resourceCountDao.removeEntriesByOwner(accountId, ResourceOwnerType.Account);\n-            _resourceLimitDao.removeEntriesByOwner(accountId, ResourceOwnerType.Account);\n-\n             // release account specific acquired portable IP's. Since all the portable IP's must have been already\n             // disassociated with VPC/guest network (due to deletion), so just mark portable IP as free.\n             List<? extends IpAddress> portableIpsToRelease = _ipAddressDao.listByAccount(accountId);\n@@ -761,6 +751,17 @@ protected boolean cleanupAccount(AccountVO account, long callerUserId, Account c\n                     }\n                 }\n             }\n+\n+            // Updating and deleting the resourceLimit and resourceCount should be the last step in cleanupAccount process.\n+            // Update resource count for this account and for parent domains.\n+            List<ResourceCountVO> resourceCounts = _resourceCountDao.listByOwnerId(accountId, ResourceOwnerType.Account);\n+            for (ResourceCountVO resourceCount : resourceCounts) {\n+                _resourceLimitMgr.decrementResourceCount(accountId, resourceCount.getType(), resourceCount.getCount());\n+            }\n+\n+            // Delete resource count and resource limits entries set for this account (if there are any).\n+            _resourceCountDao.removeEntriesByOwner(accountId, ResourceOwnerType.Account);\n+            _resourceLimitDao.removeEntriesByOwner(accountId, ResourceOwnerType.Account);\n             return true;\n         } catch (Exception ex) {\n             s_logger.warn(\"Failed to cleanup account \" + account + \" due to \", ex);",
                "raw_url": "https://github.com/apache/cloudstack/raw/21b1c9449a1289db9fa92c2ec76a936006100ab3/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "512f9130a06ed72857d394db3a897e0abfecb605",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3376: NPE: resource count calculation from the account manager on account cleanup\n\nThis issue is happing because of the steps the code follow to cleanup the account.\nThe cleanupAccount was deleting the entries from the resource_limit and\nresource_count table and performing further cleaning afterwards. Ideally, deletion\nof entries from resourceLimit and resourceCount should be the last step in\ncleanupAccount process.\n\nSigned-off-by: Prasanna Santhanam <tsp@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/5fbec76c8a7a57c01d456ab0af23dcb44e29ca14",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_22c6b47": {
        "bug_id": "cloudstack_22c6b47",
        "commit": "https://github.com/apache/cloudstack/commit/22c6b474732e643feb9411c0ca9e33109777e895",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 2,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -847,7 +847,7 @@ protected boolean doDeleteHost(final long hostId, final boolean isForced, final\n             return true;\n         }\n \n-        long clusterId = host.getClusterId();\n+        Long clusterId = host.getClusterId();\n \n         _agentMgr.notifyMonitorsOfHostAboutToBeRemoved(host.getId());\n \n@@ -927,7 +927,9 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n             }\n         });\n \n-        _agentMgr.notifyMonitorsOfRemovedHost(host.getId(), clusterId);\n+        if (clusterId != null) {\n+            _agentMgr.notifyMonitorsOfRemovedHost(host.getId(), clusterId);\n+        }\n \n         return true;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "2bb1596ed1c7eb5b15e90ae37b7b1012f5ba8b5c",
                "status": "modified"
            },
            {
                "additions": 305,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/nuageTestCase.py",
                "changes": 530,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/plugins/nuagevsp/nuageTestCase.py?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 225,
                "filename": "test/integration/plugins/nuagevsp/nuageTestCase.py",
                "patch": "@@ -21,6 +21,7 @@\n from marvin.cloudstackTestCase import cloudstackTestCase, unittest\n from marvin.lib.base import (EgressFireWallRule,\n                              FireWallRule,\n+                             Host,\n                              Hypervisor,\n                              Network,\n                              NetworkACL,\n@@ -45,6 +46,8 @@\n import importlib\n import logging\n import socket\n+import sys\n+import time\n \n \n class nuageTestCase(cloudstackTestCase):\n@@ -60,6 +63,7 @@ def setUpClass(cls, zone=None):\n         cls.api_client = test_client.getApiClient()\n         cls.db_client = test_client.getDbConnection()\n         cls.test_data = test_client.getParsedTestDataConfig()\n+\n         # Get Zone, Domain and templates\n         cls.zone = get_zone(cls.api_client,\n                             zone_name=zone.name if zone else None,\n@@ -79,6 +83,9 @@ def setUpClass(cls, zone=None):\n                                                       )\n         cls._cleanup = [cls.service_offering]\n \n+        # Check if the host hypervisor type is simulator\n+        cls.isSimulator = Hypervisor.list(cls.api_client, zoneid=cls.zone.id)[0].name == \"Simulator\"\n+\n         # Get configured Nuage VSP device details\n         try:\n             physical_networks = PhysicalNetwork.list(cls.api_client, zoneid=cls.zone.id)\n@@ -97,42 +104,44 @@ def setUpClass(cls, zone=None):\n             cls.cms_id = cls.nuage_vsp_device.cmsid\n         except Exception as e:\n             cls.tearDownClass()\n-            raise unittest.SkipTest(\"Warning: Couldn't get configured Nuage VSP device details: %s\" % e)\n-\n-        # Check if the host hypervisor type is simulator\n-        cls.isSimulator = Hypervisor.list(cls.api_client, zoneid=cls.zone.id)[0].name == \"Simulator\"\n+            raise unittest.SkipTest(\"Warning: Could not get configured Nuage VSP device details - %s\" % e)\n \n         # VSD is a programmable policy and analytics engine of Nuage VSP SDN platform\n         # vspk is a Python SDK for Nuage VSP's VSD\n-        # cms_vspk_wrapper is a library that wraps vspk package\n+        # libVSD is a library that wraps vspk package\n         try:\n             vspk_module = \"vspk.\" + cls.nuage_vsp_device.apiversion if int(cls.nuage_vsp_device.apiversion[1]) >= 4 \\\n                 else \"vspk.vsdk.\" + cls.nuage_vsp_device.apiversion\n             cls.vsdk = importlib.import_module(vspk_module)\n-            vspk_utils_module = \"vspk.utils\" if int(cls.nuage_vsp_device.apiversion[1]) >= 4 \\\n-                else \"vspk.vsdk.\" + cls.nuage_vsp_device.apiversion + \".utils\"\n-            vsdk_utils = importlib.import_module(vspk_utils_module)\n-            set_log_level = getattr(vsdk_utils, \"set_log_level\")\n-            from cms_vspk_wrapper.cms_vspk_wrapper import Cms_vspk_wrapper\n-        except:\n-            raise unittest.SkipTest(\"vspk (and/or) cms_vspk_wrapper import failure\")\n+            from libVSD import ApiClient, VSDHelpers\n+        except Exception as e:\n+            cls.tearDownClass()\n+            raise unittest.SkipTest(\"Warning: vspk (and/or) libVSD package import failure - %s\" % e)\n \n         # Configure VSD session\n         cls._session = cls.vsdk.NUVSDSession(username=cls.nuage_vsp_device.username,\n                                              password=cls.nuage_vsp_device.password,\n-                                             enterprise=\"csp\", api_url=\"https://%s:%d\" %\n-                                                                       (cls.nuage_vsp_device.hostname,\n+                                             enterprise=\"csp\",\n+                                             api_url=\"https://%s:%d\" % (cls.nuage_vsp_device.hostname,\n                                                                         cls.nuage_vsp_device.port)\n                                              )\n         cls._session.start()\n \n-        # Configure cms_vspk_wrapper session\n-        cls.log_handler = logging.getLogger(\"CSLog\").handlers[0]\n+        # Configure libVSD session\n+        root = logging.getLogger()\n+        log_handler = logging.StreamHandler(sys.stdout)\n+        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')\n+        log_handler.setFormatter(formatter)\n+        root.addHandler(log_handler)\n         vsd_info = cls.nuage_vsp_device.__dict__\n-        vsd_info[\"port\"] = str(vsd_info[\"port\"])\n-        cls.vsd = Cms_vspk_wrapper(vsd_info, cls.log_handler)\n-\n-        set_log_level(logging.INFO)\n+        cls.debug(\"Nuage VSP device (VSD) details - %s\" % vsd_info)\n+        vsd_api_client = ApiClient(address=vsd_info[\"hostname\"],\n+                                   user=vsd_info[\"username\"],\n+                                   password=vsd_info[\"password\"],\n+                                   version=vsd_info[\"apiversion\"][1] + \".\" + vsd_info[\"apiversion\"][3]\n+                                   )\n+        vsd_api_client.new_session()\n+        cls.vsd = VSDHelpers(vsd_api_client)\n \n         cls.debug(\"setUpClass nuageTestCase [DONE]\")\n \n@@ -180,17 +189,23 @@ def create_VpcOffering(self, vpc_offering, suffix=None):\n         return vpc_off\n \n     # create_Vpc - Creates VPC with the given VPC offering\n-    def create_Vpc(self, vpc_offering, cidr=\"10.1.1.1/16\", cleanup=True):\n-        self.debug(\"Creating a VPC in the account - %s\" % self.account.name)\n-        self.test_data[\"vpc\"][\"name\"] = \"TestVPC\"\n-        self.test_data[\"vpc\"][\"displaytext\"] = \"TestVPC\"\n-        self.test_data[\"vpc\"][\"cidr\"] = cidr\n+    def create_Vpc(self, vpc_offering, cidr='10.1.0.0/16', testdata=None, account=None, networkDomain=None,\n+                   cleanup=True):\n+        if not account:\n+            account = self.account\n+        self.debug(\"Creating a VPC in the account - %s\" % account.name)\n+        if not testdata:\n+            testdata = self.test_data[\"vpc\"]\n+            testdata[\"name\"] = \"TestVPC-\" + cidr + \"-\" + str(vpc_offering.name)\n+            testdata[\"displaytext\"] = \"Test VPC\"\n+            testdata[\"cidr\"] = cidr\n         vpc = VPC.create(self.api_client,\n-                         self.test_data[\"vpc\"],\n+                         testdata,\n                          vpcofferingid=vpc_offering.id,\n                          zoneid=self.zone.id,\n-                         account=self.account.name,\n-                         domainid=self.account.domainid\n+                         account=account.name,\n+                         domainid=account.domainid,\n+                         networkDomain=networkDomain\n                          )\n         self.debug(\"Created VPC with ID - %s\" % vpc.id)\n         if cleanup:\n@@ -223,21 +238,29 @@ def create_NetworkOffering(self, net_offering, suffix=None, conserve_mode=False)\n         return nw_off\n \n     # create_Network - Creates network with the given Network offering\n-    def create_Network(self, nw_off, gateway=\"10.1.1.1\", netmask=\"255.255.255.0\", vpc=None, acl_list=None):\n-        self.debug(\"Creating a network in the account - %s\" % self.account.name)\n-        self.test_data[\"network\"][\"netmask\"] = netmask\n+    def create_Network(self, nw_off, gateway=\"10.1.1.1\", netmask=\"255.255.255.0\", vpc=None, acl_list=None,\n+                       testdata=None, account=None, cleanup=True):\n+        if not account:\n+            account = self.account\n+        self.debug(\"Creating a network in the account - %s\" % account.name)\n+        if not testdata:\n+            testdata = self.test_data[\"network\"]\n+            testdata[\"name\"] = \"TestNetwork-\" + gateway + \"-\" + str(nw_off.name)\n+            testdata[\"displaytext\"] = \"Test Network\"\n+            testdata[\"netmask\"] = netmask\n         network = Network.create(self.api_client,\n-                                 self.test_data[\"network\"],\n-                                 accountid=self.account.name,\n-                                 domainid=self.account.domainid,\n+                                 testdata,\n+                                 accountid=account.name,\n+                                 domainid=account.domainid,\n                                  networkofferingid=nw_off.id,\n                                  zoneid=self.zone.id,\n                                  gateway=gateway,\n                                  vpcid=vpc.id if vpc else self.vpc.id if hasattr(self, \"vpc\") else None,\n                                  aclid=acl_list.id if acl_list else None\n                                  )\n         self.debug(\"Created network with ID - %s\" % network.id)\n-        self.cleanup.append(network)\n+        if cleanup:\n+            self.cleanup.append(network)\n         return network\n \n     # upgrade_Network - Upgrades the given network\n@@ -259,25 +282,74 @@ def delete_Network(self, network):\n             self.cleanup.remove(network)\n         self.debug(\"Deleted Network with ID - %s\" % network.id)\n \n-    # create_VM - Creates VM in the given network, vm_key - Key for the services on the VM\n-    def create_VM(self, network, vm_key=\"virtual_machine\", host_id=None, start_vm=True):\n-        self.debug(\"Creating VM in network with ID - %s\" % network.id)\n-        self.debug(\"Passed vm_key - %s\" % vm_key)\n-        self.test_data[vm_key][\"zoneid\"] = self.zone.id\n-        self.test_data[vm_key][\"template\"] = self.template.id\n+    # create_VM - Creates VM in the given network(s)\n+    def create_VM(self, network_list, host_id=None, start_vm=True, testdata=None, account=None, cleanup=True):\n+        network_ids = []\n+        if isinstance(network_list, list):\n+            for network in network_list:\n+                network_ids.append(str(network.id))\n+        else:\n+            network_ids.append(str(network_list.id))\n+        if not account:\n+            account = self.account\n+        self.debug(\"Creating VM in network(s) with ID(s) - %s in the account - %s\" % (network_ids, account.name))\n+        if not testdata:\n+            testdata = self.test_data[\"virtual_machine\"]\n         vm = VirtualMachine.create(self.api_client,\n-                                   self.test_data[vm_key],\n-                                   accountid=self.account.name,\n-                                   domainid=self.account.domainid,\n+                                   testdata,\n+                                   accountid=account.name,\n+                                   domainid=account.domainid,\n                                    serviceofferingid=self.service_offering.id,\n-                                   networkids=[str(network.id)],\n+                                   templateid=self.template.id,\n+                                   zoneid=self.zone.id,\n+                                   networkids=network_ids,\n                                    startvm=start_vm,\n                                    hostid=host_id\n                                    )\n-        self.debug(\"Created VM with ID - %s in network with ID - %s\" % (vm.id, network.id))\n-        self.cleanup.append(vm)\n+        self.debug(\"Created VM with ID - %s in network(s) with ID(s) - %s\" % (vm.id, network_ids))\n+        if cleanup:\n+            self.cleanup.append(vm)\n         return vm\n \n+    # nic_operation_VM - Performs NIC operations such as add, remove, and update default NIC in the given VM and network\n+    def nic_operation_VM(self, vm, network, operation=\"update\"):\n+        self.debug(\"Performing %s NIC operation in VM with ID - %s and network with ID - %s\" %\n+                   (operation, vm.id, network.id))\n+        for nic in vm.nic:\n+            if nic.networkid == network.id:\n+                nic_id = nic.id\n+        if operation is \"update\":\n+            vm.update_default_nic(self.api_client, nic_id)\n+            self.debug(\"Updated default NIC to NIC with ID - %s in VM with ID - %s and network with ID - %s\" %\n+                       (nic_id, vm.id, network.id))\n+        if operation is \"remove\":\n+            vm.remove_nic(self.api_client, nic_id)\n+            self.debug(\"Removed NIC with ID - %s in VM with ID - %s and network with ID - %s\" %\n+                       (nic_id, vm.id, network.id))\n+        if operation is \"add\":\n+            vm.add_nic(self.api_client, network.id)\n+            self.debug(\"Added NIC with ID - %s in VM with ID - %s and network with ID - %s\" %\n+                       (nic_id, vm.id, network.id))\n+\n+    # migrate_VM - Migrates VM to another host, if available\n+    def migrate_VM(self, vm):\n+        self.debug(\"Checking if a host is available for migration...\")\n+        hosts = Host.listForMigration(self.api_client, virtualmachineid=vm.id)\n+        self.assertEqual(isinstance(hosts, list), True,\n+                         \"List hosts should return a valid list\"\n+                         )\n+        # Remove the host of current VM from the hosts list\n+        hosts[:] = [host for host in hosts if host.id != vm.hostid]\n+        if len(hosts) <= 0:\n+            self.skipTest(\"No host available for migration. Test requires at-least 2 hosts\")\n+        host = hosts[0]\n+        self.debug(\"Migrating VM with ID: %s to Host: %s\" % (vm.id, host.id))\n+        try:\n+            vm.migrate(self.api_client, hostid=host.id)\n+        except Exception as e:\n+            self.fail(\"Failed to migrate instance, %s\" % e)\n+        self.debug(\"Migrated VM with ID: %s to Host: %s\" % (vm.id, host.id))\n+\n     # delete_VM - Deletes the given VM\n     def delete_VM(self, vm, expunge=True):\n         self.debug(\"Deleting VM with ID - %s\" % vm.id)\n@@ -299,44 +371,49 @@ def get_Router(self, network):\n         return routers[0]\n \n     # acquire_PublicIPAddress - Acquires public IP address for the given network/VPC\n-    def acquire_PublicIPAddress(self, network, vpc=None):\n-        self.debug(\"Associating public IP for network with ID - %s\" % network.id)\n+    def acquire_PublicIPAddress(self, network, vpc=None, account=None):\n+        if not account:\n+            account = self.account\n+        self.debug(\"Associating public IP for network with ID - %s in the account - %s\" % (network.id, account.name))\n         public_ip = PublicIPAddress.create(self.api_client,\n-                                           accountid=self.account.name,\n+                                           accountid=account.name,\n+                                           domainid=account.domainid,\n                                            zoneid=self.zone.id,\n-                                           domainid=self.account.domainid,\n                                            networkid=network.id if vpc is None else None,\n                                            vpcid=vpc.id if vpc else self.vpc.id if hasattr(self, \"vpc\") else None\n                                            )\n         self.debug(\"Associated public IP address - %s with network with ID - %s\" %\n                    (public_ip.ipaddress.ipaddress, network.id))\n         return public_ip\n \n-    # create_StaticNatRule_For_VM - Creates static NAT rule on the given public IP for the given network and VM\n+    # create_StaticNatRule_For_VM - Creates Static NAT rule on the given public IP for the given VM in the given network\n     def create_StaticNatRule_For_VM(self, vm, public_ip, network, vmguestip=None):\n-        self.debug(\"Enabling static NAT for public IP - %s\" % public_ip.ipaddress.ipaddress)\n-        StaticNATRule.enable(self.api_client,\n-                             ipaddressid=public_ip.ipaddress.id,\n-                             virtualmachineid=vm.id,\n-                             networkid=network.id,\n-                             vmguestip=vmguestip\n-                             )\n-        self.debug(\"Static NAT enabled for public IP - %s\" % public_ip.ipaddress.ipaddress)\n+        self.debug(\"Enabling Static NAT rule on public IP - %s for VM with ID - %s in network with ID - %s\" %\n+                   (public_ip.ipaddress.ipaddress, vm.id, network.id))\n+        static_nat_rule = StaticNATRule.enable(self.api_client,\n+                                               ipaddressid=public_ip.ipaddress.id,\n+                                               virtualmachineid=vm.id,\n+                                               networkid=network.id,\n+                                               vmguestip=vmguestip\n+                                               )\n+        self.debug(\"Static NAT rule enabled on public IP - %s for VM with ID - %s in network with ID - %s\" %\n+                   (public_ip.ipaddress.ipaddress, vm.id, network.id))\n+        return static_nat_rule\n \n-    # delete_StaticNatRule_For_VM - Deletes static NAT rule on the given public IP for the given VM\n-    def delete_StaticNatRule_For_VM(self, vm, public_ip):\n-        self.debug(\"Disabling static NAT for public IP - %s\" % public_ip.ipaddress.ipaddress)\n+    # delete_StaticNatRule_For_VM - Deletes Static NAT rule on the given public IP\n+    def delete_StaticNatRule_For_VM(self, public_ip):\n+        self.debug(\"Disabling Static NAT rule on public IP - %s\" % public_ip.ipaddress.ipaddress)\n         StaticNATRule.disable(self.api_client,\n-                              ipaddressid=public_ip.ipaddress.id,\n-                              virtualmachineid=vm.id\n+                              ipaddressid=public_ip.ipaddress.id\n                               )\n-        self.debug(\"Static NAT disabled for public IP - %s\" % public_ip.ipaddress.ipaddress)\n+        self.debug(\"Static NAT rule disabled on public IP - %s\" % public_ip.ipaddress.ipaddress)\n \n-    # create_FirewallRule - Creates Ingress firewall rule on the given public IP\n+    # create_FirewallRule - Creates (Ingress) Firewall rule on the given Static NAT rule enabled public IP for Isolated\n+    # networks\n     def create_FirewallRule(self, public_ip, rule=None):\n         if not rule:\n             rule = self.test_data[\"ingress_rule\"]\n-        self.debug(\"Adding an Ingress Firewall rule to make Guest VMs accessible through Static NAT - %s\" % rule)\n+        self.debug(\"Adding an (Ingress) Firewall rule to make Guest VMs accessible through Static NAT rule - %s\" % rule)\n         return FireWallRule.create(self.api_client,\n                                    ipaddressid=public_ip.ipaddress.id,\n                                    protocol=rule[\"protocol\"],\n@@ -345,7 +422,7 @@ def create_FirewallRule(self, public_ip, rule=None):\n                                    endport=rule[\"endport\"]\n                                    )\n \n-    # create_EgressFirewallRule - Creates Egress firewall rule on the given public IP\n+    # create_EgressFirewallRule - Creates Egress Firewall rule in the given Isolated network\n     def create_EgressFirewallRule(self, network, rule):\n         self.debug(\"Adding an Egress Firewall rule to allow/deny outgoing traffic from Guest VMs - %s\" % rule)\n         return EgressFireWallRule.create(self.api_client,\n@@ -366,7 +443,7 @@ def create_NetworkAclList(self, name, description, vpc):\n                                      vpcid=vpc.id\n                                      )\n \n-    # create_NetworkAclRule - Creates Ingress/Egress network ACL rule in the given network/acl list\n+    # create_NetworkAclRule - Creates Ingress/Egress Network ACL rule in the given VPC network/acl list\n     def create_NetworkAclRule(self, rule, traffic_type=\"Ingress\", network=None, acl_list=None):\n         self.debug(\"Adding NetworkACL rule - %s\" % rule)\n         if acl_list:\n@@ -383,11 +460,23 @@ def create_NetworkAclRule(self, rule, traffic_type=\"Ingress\", network=None, acl_\n                                      traffictype=traffic_type\n                                      )\n \n-    # ssh_into_VM - Gets into the shell of the given VM\n-    def ssh_into_VM(self, vm, public_ip):\n+    # ssh_into_VM - Gets into the shell of the given VM using its public IP\n+    def ssh_into_VM(self, vm, public_ip, reconnect=True):\n         self.debug(\"SSH into VM with ID - %s on public IP address - %s\" % (vm.id, public_ip.ipaddress.ipaddress))\n-        ssh_client = vm.get_ssh_client(ipaddress=public_ip.ipaddress.ipaddress)\n-        return ssh_client\n+        tries = 0\n+        while tries < 3:\n+            try:\n+                ssh_client = vm.get_ssh_client(ipaddress=public_ip.ipaddress.ipaddress, reconnect=reconnect)\n+            except Exception as e:\n+                self.debug(\"Failed to SSH into VM: %s\" % e)\n+                self.debug(\"Waiting for the VM to be fully resolved for SSH connection...\")\n+                time.sleep(120)\n+                self.debug(\"Retrying SSH into VM...\")\n+                tries += 1\n+                continue\n+            self.debug(\"Successful to SSH into VM with ID - %s on public IP address - %s\" %\n+                       (vm.id, public_ip.ipaddress.ipaddress))\n+            return ssh_client\n \n     # execute_cmd - Executes the given command on the given ssh client\n     def execute_cmd(self, ssh_client, cmd):\n@@ -401,11 +490,12 @@ def execute_cmd(self, ssh_client, cmd):\n             self.debug(\"SSH client executed command result is None\")\n         return ret_data\n \n-    # wget_from_server - Fetches index.html file of web server running with the given public IP\n-    def wget_from_server(self, public_ip):\n+    # wget_from_server - Fetches index.html file from a web server listening on the given public IP address and port\n+    def wget_from_server(self, public_ip, port):\n         import urllib\n-        self.debug(\"wget from a http server on public IP address - %s\" % public_ip.ipaddress.ipaddress)\n-        filename, headers = urllib.urlretrieve(\"http://%s/index.html\" % public_ip.ipaddress.ipaddress,\n+        self.debug(\"wget index.html file from a http web server listening on public IP address - %s and port - %s\" %\n+                   (public_ip.ipaddress.ipaddress, port))\n+        filename, headers = urllib.urlretrieve(\"http://%s:%s/index.html\" % (public_ip.ipaddress.ipaddress, port),\n                                                filename=\"index.html\"\n                                                )\n         return filename, headers\n@@ -414,7 +504,7 @@ def wget_from_server(self, public_ip):\n     # matches the given provider name and state against the list of providers fetched\n     def validate_NetworkServiceProvider(self, provider_name, state=None):\n         \"\"\"Validates the Network Service Provider in the Nuage VSP Physical Network\"\"\"\n-        self.debug(\"Check if the Network Service Provider is created successfully ?\")\n+        self.debug(\"Validating the creation and state of Network Service Provider - %s\" % provider_name)\n         providers = NetworkServiceProvider.list(self.api_client,\n                                                 name=provider_name,\n                                                 physicalnetworkid=self.vsp_physical_network.id)\n@@ -426,15 +516,15 @@ def validate_NetworkServiceProvider(self, provider_name, state=None):\n                          )\n         if state:\n             self.assertEqual(providers[0].state, state,\n-                             \"Network Service Provider state should be in state - %s\" % state\n+                             \"Network Service Provider state should be '%s'\" % state\n                              )\n-        self.debug(\"Network Service Provider creation successfully validated for %s\" % provider_name)\n+        self.debug(\"Successfully validated the creation and state of Network Service Provider - %s\" % provider_name)\n \n-    # validate_VpcOffering - Validates the given VPC offering,\n-    # matches the given VPC offering name and state against the list of VPC offerings fetched\n+    # validate_VpcOffering - Validates the given VPC offering, matches the given VPC offering name and state against the\n+    # list of VPC offerings fetched\n     def validate_VpcOffering(self, vpc_offering, state=None):\n         \"\"\"Validates the VPC offering\"\"\"\n-        self.debug(\"Check if the VPC offering is created successfully ?\")\n+        self.debug(\"Validating the creation and state of VPC offering - %s\" % vpc_offering.name)\n         vpc_offs = VpcOffering.list(self.api_client,\n                                     id=vpc_offering.id\n                                     )\n@@ -446,15 +536,14 @@ def validate_VpcOffering(self, vpc_offering, state=None):\n                          )\n         if state:\n             self.assertEqual(vpc_offs[0].state, state,\n-                             \"VPC offering state should be in state - %s\" % state\n+                             \"VPC offering state should be '%s'\" % state\n                              )\n-        self.debug(\"VPC offering creation successfully validated for %s\" % vpc_offering.name)\n+        self.debug(\"Successfully validated the creation and state of VPC offering - %s\" % vpc_offering.name)\n \n-    # validate_Vpc - Validates the given VPC,\n-    # matches the given VPC name and state against the list of VPCs fetched\n+    # validate_Vpc - Validates the given VPC, matches the given VPC name and state against the list of VPCs fetched\n     def validate_Vpc(self, vpc, state=None):\n         \"\"\"Validates the VPC\"\"\"\n-        self.debug(\"Check if the VPC is created successfully ?\")\n+        self.debug(\"Validating the creation and state of VPC - %s\" % vpc.name)\n         vpcs = VPC.list(self.api_client,\n                         id=vpc.id\n                         )\n@@ -466,15 +555,15 @@ def validate_Vpc(self, vpc, state=None):\n                          )\n         if state:\n             self.assertEqual(vpcs[0].state, state,\n-                             \"VPC state should be in state - %s\" % state\n+                             \"VPC state should be '%s'\" % state\n                              )\n-        self.debug(\"VPC creation successfully validated for %s\" % vpc.name)\n+        self.debug(\"Successfully validated the creation and state of VPC - %s\" % vpc.name)\n \n-    # validate_NetworkOffering - Validates the given Network offering,\n-    # matches the given network offering name and state against the list of network offerings fetched\n+    # validate_NetworkOffering - Validates the given Network offering, matches the given network offering name and state\n+    # against the list of network offerings fetched\n     def validate_NetworkOffering(self, net_offering, state=None):\n         \"\"\"Validates the Network offering\"\"\"\n-        self.debug(\"Check if the Network offering is created successfully ?\")\n+        self.debug(\"Validating the creation and state of Network offering - %s\" % net_offering.name)\n         net_offs = NetworkOffering.list(self.api_client,\n                                         id=net_offering.id\n                                         )\n@@ -486,15 +575,15 @@ def validate_NetworkOffering(self, net_offering, state=None):\n                          )\n         if state:\n             self.assertEqual(net_offs[0].state, state,\n-                             \"Network offering state should be in state - %s\" % state\n+                             \"Network offering state should be '%s'\" % state\n                              )\n-        self.debug(\"Network offering creation successfully validated for %s\" % net_offering.name)\n+        self.debug(\"Successfully validated the creation and state of Network offering - %s\" % net_offering.name)\n \n-    # validate_Network - Validates the given network,\n-    # matches the given network name and state against the list of networks fetched\n+    # validate_Network - Validates the given network, matches the given network name and state against the list of\n+    # networks fetched\n     def validate_Network(self, network, state=None):\n-        \"\"\"Validates the Network\"\"\"\n-        self.debug(\"Check if the network is created successfully ?\")\n+        \"\"\"Validates the network\"\"\"\n+        self.debug(\"Validating the creation and state of Network - %s\" % network.name)\n         networks = Network.list(self.api_client,\n                                 id=network.id\n                                 )\n@@ -506,14 +595,14 @@ def validate_Network(self, network, state=None):\n                          )\n         if state:\n             self.assertEqual(networks[0].state, state,\n-                             \"Network state should be in state - %s\" % state\n+                             \"Network state should be '%s'\" % state\n                              )\n-        self.debug(\"Network creation successfully validated for %s\" % network.name)\n+        self.debug(\"Successfully validated the creation and state of Network - %s\" % network.name)\n \n     # check_VM_state - Checks if the given VM is in the expected state form the list of fetched VMs\n     def check_VM_state(self, vm, state=None):\n         \"\"\"Validates the VM state\"\"\"\n-        self.debug(\"Check if the VM instance is in state - %s\" % state)\n+        self.debug(\"Validating the deployment and state of VM - %s\" % vm.name)\n         vms = VirtualMachine.list(self.api_client,\n                                   id=vm.id,\n                                   listall=True\n@@ -525,12 +614,12 @@ def check_VM_state(self, vm, state=None):\n             self.assertEqual(vms[0].state, state,\n                              \"Virtual machine is not in the expected state\"\n                              )\n-        self.debug(\"Virtual machine instance - %s is in the expected state - %s\" % (vm.name, state))\n+        self.debug(\"Successfully validated the deployment and state of VM - %s\" % vm.name)\n \n     # check_Router_state - Checks if the given router is in the expected state form the list of fetched routers\n     def check_Router_state(self, router, state=None):\n         \"\"\"Validates the Router state\"\"\"\n-        self.debug(\"Check if the virtual router instance is in state - %s\" % state)\n+        self.debug(\"Validating the deployment and state of Router - %s\" % router.name)\n         routers = Router.list(self.api_client,\n                               id=router.id,\n                               listall=True\n@@ -542,13 +631,13 @@ def check_Router_state(self, router, state=None):\n             self.assertEqual(routers[0].state, state,\n                              \"Virtual router is not in the expected state\"\n                              )\n-        self.debug(\"Virtual router instance - %s is in the expected state - %s\" % (router.name, state))\n+        self.debug(\"Successfully validated the deployment and state of Router - %s\" % router.name)\n \n     # validate_PublicIPAddress - Validates if the given public IP address is in the expected state form the list of\n     # fetched public IP addresses\n     def validate_PublicIPAddress(self, public_ip, network, static_nat=False, vm=None):\n         \"\"\"Validates the Public IP Address\"\"\"\n-        self.debug(\"Check if the public IP is successfully assigned to the network ?\")\n+        self.debug(\"Validating the assignment and state of public IP address - %s\" % public_ip.ipaddress.ipaddress)\n         public_ips = PublicIPAddress.list(self.api_client,\n                                           id=public_ip.ipaddress.id,\n                                           networkid=network.id,\n@@ -566,20 +655,22 @@ def validate_PublicIPAddress(self, public_ip, network, static_nat=False, vm=None\n                          )\n         if static_nat and vm:\n             self.assertEqual(public_ips[0].virtualmachineid, vm.id,\n-                             \"Static NAT Rule not enabled for the VM using the assigned public IP\"\n+                             \"Static NAT rule is not enabled for the VM on the assigned public IP\"\n                              )\n-        self.debug(\"Assigned Public IP address - %s is successfully validated\" % public_ip.ipaddress.ipaddress)\n+        self.debug(\"Successfully validated the assignment and state of public IP address - %s\" %\n+                   public_ip.ipaddress.ipaddress)\n \n     # VSD verifications\n     # VSD is a programmable policy and analytics engine of Nuage VSP SDN platform\n \n-    # get_externalID - Returns corresponding external ID of the given object in VSD\n-    def get_externalID(self, object_id):\n-        return object_id + \"@\" + self.cms_id\n+    # get_externalID_filter - Returns corresponding external ID filter of the given object in VSD\n+    def get_externalID_filter(self, object_id):\n+        ext_id = object_id + \"@\" + self.cms_id\n+        return self.vsd.set_externalID_filter(ext_id)\n \n     # fetch_by_externalID - Returns VSD object with the given external ID\n     def fetch_by_externalID(self, fetcher, *cs_objects):\n-        \"\"\" Fetches a child object by external ID using the given fetcher, and uuids of the given cloudstack objects.\n+        \"\"\" Fetches a child object by external id using the given fetcher, and uuids of the given cloudstack objects.\n         E.G.\n           - fetch_by_external_id(vsdk.NUSubnet(id=\"954de425-b860-410b-be09-c560e7dbb474\").vms, cs_vm)\n           - fetch_by_external_id(session.user.floating_ips, cs_network, cs_public_ip)\n@@ -589,162 +680,148 @@ def fetch_by_externalID(self, fetcher, *cs_objects):\n         \"\"\"\n         return fetcher.get_first(filter=\"externalID BEGINSWITH '%s'\" % \":\".join([o.id for o in cs_objects]))\n \n-    # verify_vsp_network - Verifies the given domain and network/VPC\n-    # against the corresponding installed enterprise, domain, zone, and subnet in VSD\n-    def verify_vsp_network(self, domain_id, network, vpc=None):\n-        vsd_enterprise = self.vsd.get_enterprise(name=domain_id)\n-        if vpc:\n-            ext_network_id = self.get_externalID(vpc.id)\n-        else:\n-            ext_network_id = self.get_externalID(network.id)\n-        ext_subnet_id = self.get_externalID(network.id)\n-        vsd_domain = self.vsd.get_domain(externalID=ext_network_id)\n-        vsd_zone = self.vsd.get_zone(externalID=ext_network_id)\n-        vsd_subnet = self.vsd.get_subnet(externalID=ext_subnet_id)\n-        self.debug(\"SHOW ENTERPRISE DATA FORMAT IN VSD\")\n-        self.debug(vsd_enterprise)\n-        self.assertNotEqual(vsd_enterprise, None,\n-                            \"VSD Enterprise data format should not be a None type\"\n-                            )\n-        self.debug(\"SHOW NETWORK DATA FORMAT IN VSD\")\n-        self.debug(vsd_domain)\n-        self.debug(vsd_zone)\n-        self.debug(vsd_subnet)\n+    # verify_vsd_network - Verifies the given domain and network/VPC against the corresponding installed enterprise,\n+    # domain, zone, and subnet in VSD\n+    def verify_vsd_network(self, domain_id, network, vpc=None):\n+        self.debug(\"Verifying the creation and state of Network - %s in VSD\" % network.name)\n+        vsd_enterprise = self.vsd.get_enterprise(filter=self.get_externalID_filter(domain_id))\n+        ext_network_filter = self.get_externalID_filter(vpc.id) if vpc else self.get_externalID_filter(network.id)\n+        vsd_domain = self.vsd.get_domain(filter=ext_network_filter)\n+        vsd_zone = self.vsd.get_zone(filter=ext_network_filter)\n+        vsd_subnet = self.vsd.get_subnet(filter=self.get_externalID_filter(network.id))\n+        self.assertEqual(vsd_enterprise.name, domain_id,\n+                         \"VSD enterprise name should match CloudStack domain uuid\"\n+                         )\n         if vpc:\n-            self.assertEqual(vsd_domain[\"description\"], \"VPC_\" + vpc.name,\n+            self.assertEqual(vsd_domain.description, \"VPC_\" + vpc.name,\n                              \"VSD domain description should match VPC name in CloudStack\"\n                              )\n-            self.assertEqual(vsd_zone[\"description\"], \"VPC_\" + vpc.name,\n+            self.assertEqual(vsd_zone.description, \"VPC_\" + vpc.name,\n                              \"VSD zone description should match VPC name in CloudStack\"\n                              )\n         else:\n-            self.assertEqual(vsd_domain[\"description\"], network.name,\n+            self.assertEqual(vsd_domain.description, network.name,\n                              \"VSD domain description should match network name in CloudStack\"\n                              )\n-            self.assertEqual(vsd_zone[\"description\"], network.name,\n+            self.assertEqual(vsd_zone.description, network.name,\n                              \"VSD zone description should match network name in CloudStack\"\n                              )\n-        self.assertEqual(vsd_subnet[\"description\"], network.name,\n+        self.assertEqual(vsd_subnet.description, network.name,\n                          \"VSD subnet description should match network name in CloudStack\"\n                          )\n-\n-    # verify_vsp_vm - Verifies the given VM deployment and state in VSD\n-    def verify_vsp_vm(self, vm, stopped=None):\n-        ext_vm_id = self.get_externalID(vm.id)\n+        self.debug(\"Successfully verified the creation and state of Network - %s in VSD\" % network.name)\n+\n+    # verify_vsd_vm - Verifies the given VM deployment and state in VSD\n+    def verify_vsd_vm(self, vm, stopped=None):\n+        self.debug(\"Verifying the deployment and state of VM - %s in VSD\" % vm.name)\n+        vsd_vm = self.vsd.get_vm(filter=self.get_externalID_filter(vm.id))\n+        self.assertNotEqual(vsd_vm, None,\n+                            \"VM data format in VSD should not be of type None\"\n+                            )\n         for nic in vm.nic:\n-            ext_network_id = self.get_externalID(nic.networkid)\n-            ext_nic_id = self.get_externalID(nic.id)\n-            vsd_vport = self.vsd.get_vport(subnet_externalID=ext_network_id, vport_externalID=ext_nic_id)\n-            vsd_vm_interface = self.vsd.get_vm_interface(externalID=ext_nic_id)\n-            self.debug(\"SHOW VPORT and VM INTERFACE DATA FORMAT IN VSD\")\n-            self.debug(vsd_vport)\n-            self.debug(vsd_vm_interface)\n-            self.assertEqual(vsd_vport[\"active\"], True,\n+            vsd_subnet = self.vsd.get_subnet(filter=self.get_externalID_filter(nic.networkid))\n+            vsd_vport = self.vsd.get_vport(subnet=vsd_subnet, filter=self.get_externalID_filter(nic.id))\n+            vsd_vm_interface = self.vsd.get_vm_interface(filter=self.get_externalID_filter(nic.id))\n+            self.assertEqual(vsd_vport.active, True,\n                              \"VSD VM vport should be active\"\n                              )\n-            self.assertEqual(vsd_vm_interface[\"IPAddress\"], nic.ipaddress,\n+            self.assertEqual(vsd_vm_interface.ip_address, nic.ipaddress,\n                              \"VSD VM interface IP address should match VM's NIC IP address in CloudStack\"\n                              )\n-        vsd_vm = self.vsd.get_vm(externalID=ext_vm_id)\n-        self.debug(\"SHOW VM DATA FORMAT IN VSD\")\n-        self.debug(vsd_vm)\n         if not self.isSimulator:\n             if stopped:\n-                self.assertEqual(vsd_vm[\"status\"], \"DELETE_PENDING\",\n+                self.assertEqual(vsd_vm.status, \"DELETE_PENDING\",\n                                  \"VM state in VSD should be DELETE_PENDING\"\n                                  )\n             else:\n-                self.assertEqual(vsd_vm[\"status\"], vm.state.upper(),\n+                self.assertEqual(vsd_vm.status, vm.state.upper(),\n                                  \"VM state in VSD should match its state in CloudStack\"\n                                  )\n-\n-    # verify_vsp_router - Verifies the given network router deployment and state in VSD\n-    def verify_vsp_router(self, router, stopped=None):\n-        ext_router_id = self.get_externalID(router.id)\n-        vsd_router = self.vsd.get_vm(externalID=ext_router_id)\n-        self.debug(\"SHOW VIRTUAL ROUTER DATA FORMAT IN VSD\")\n-        self.debug(vsd_router)\n+        self.debug(\"Successfully verified the deployment and state of VM - %s in VSD\" % vm.name)\n+\n+    # verify_vsd_router - Verifies the given network router deployment and state in VSD\n+    def verify_vsd_router(self, router, stopped=None):\n+        self.debug(\"Verifying the deployment and state of Router - %s in VSD\" % router.name)\n+        vsd_router = self.vsd.get_vm(filter=self.get_externalID_filter(router.id))\n+        self.assertNotEqual(vsd_router, None,\n+                            \"Router data format in VSD should not be of type None\"\n+                            )\n         if not self.isSimulator:\n             if stopped:\n-                self.assertEqual(vsd_router[\"status\"], \"DELETE_PENDING\",\n+                self.assertEqual(vsd_router.status, \"DELETE_PENDING\",\n                                  \"Router state in VSD should be DELETE_PENDING\"\n                                  )\n             else:\n-                self.assertEqual(vsd_router[\"status\"], router.state.upper(),\n+                self.assertEqual(vsd_router.status, router.state.upper(),\n                                  \"Router state in VSD should match its state in CloudStack\"\n                                  )\n-\n-    # verify_vsp_LB_device - Verifies the given LB device deployment and state in VSD\n-    def verify_vsp_LB_device(self, lb_device, stopped=None):\n-        ext_lb_device_id = self.get_externalID(lb_device.id)\n-        vsd_lb_device = self.vsd.get_vm(externalID=ext_lb_device_id)\n-        self.debug(\"SHOW LB Device DATA FORMAT IN VSD\")\n-        self.debug(vsd_lb_device)\n+        self.debug(\"Successfully verified the deployment and state of Router - %s in VSD\" % router.name)\n+\n+    # verify_vsd_lb_device - Verifies the given LB device deployment and state in VSD\n+    def verify_vsd_lb_device(self, lb_device, stopped=None):\n+        self.debug(\"Verifying the deployment and state of LB device - %s in VSD\" % lb_device.name)\n+        vsd_lb_device = self.vsd.get_vm(filter=self.get_externalID_filter(lb_device.id))\n+        self.assertNotEqual(vsd_lb_device, None,\n+                            \"LB device data format in VSD should not be of type None\"\n+                            )\n         if not self.isSimulator:\n             if stopped:\n-                self.assertEqual(vsd_lb_device['status'], \"DELETE_PENDING\",\n+                self.assertEqual(vsd_lb_device.status, \"DELETE_PENDING\",\n                                  \"LB device state in VSD should be DELETE_PENDING\"\n                                  )\n             else:\n-                self.assertEqual(vsd_lb_device['status'], lb_device.state.upper(),\n+                self.assertEqual(vsd_lb_device.status, lb_device.state.upper(),\n                                  \"LB device state in VSD should match its state in CloudStack\"\n                                  )\n-\n-    # verify_vsp_floating_ip -  Verifies the static nat rule on the given public IP of the given network and VM\n-    # against the corresponding installed FIP in VSD\n-    def verify_vsp_floating_ip(self, network, vm, public_ipaddress, vpc=None):\n-        if vpc:\n-            ext_fip_id = self.get_externalID(vpc.id + \":\" + public_ipaddress.id)\n-        else:\n-            ext_fip_id = self.get_externalID(network.id + \":\" + public_ipaddress.id)\n-        vsd_fip = self.vsd.get_floating_ip(externalID=ext_fip_id)\n-        self.debug(\"SHOW FLOATING IP DATA FORMAT IN VSD\")\n-        self.debug(vsd_fip)\n-        self.assertEqual(vsd_fip[\"address\"], public_ipaddress.ipaddress,\n+        self.debug(\"Successfully verified the deployment and state of LB device - %s in VSD\" % lb_device.name)\n+\n+    # verify_vsd_floating_ip -  Verifies the Static NAT rule on the given public IP of the given VM in the given network\n+    # against the corresponding installed Floating IP in VSD\n+    def verify_vsd_floating_ip(self, network, vm, public_ipaddress, vpc=None):\n+        self.debug(\"Verifying the assignment and state of public IP address - %s in VSD\" % public_ipaddress.ipaddress)\n+        ext_fip_filter = self.get_externalID_filter(vpc.id + \":\" + public_ipaddress.id) if vpc else \\\n+            self.get_externalID_filter(network.id + \":\" + public_ipaddress.id)\n+        vsd_fip = self.vsd.get_floating_ip(filter=ext_fip_filter)\n+        self.assertEqual(vsd_fip.address, public_ipaddress.ipaddress,\n                          \"Floating IP address in VSD should match acquired public IP address in CloudStack\"\n                          )\n-        if vpc:\n-            ext_network_id = self.get_externalID(vpc.id)\n-        else:\n-            ext_network_id = self.get_externalID(network.id)\n-        vsd_domain = self.vsd.get_domain(externalID=ext_network_id)\n-        self.debug(\"SHOW NETWORK DATA FORMAT IN VSD\")\n-        self.debug(vsd_domain)\n-        self.assertEqual(vsd_domain[\"ID\"], vsd_fip[\"parentID\"],\n-                         \"Floating IP in VSD should be associated with the correct VSD domain, \"\n-                         \"which in turn should correspond to the correct VPC (or) network in CloudStack\"\n+        self.assertEqual(vsd_fip.assigned, True,\n+                         \"Floating IP in VSD should be assigned\"\n+                         )\n+        ext_network_filter = self.get_externalID_filter(vpc.id) if vpc else self.get_externalID_filter(network.id)\n+        vsd_domain = self.vsd.get_domain(filter=ext_network_filter)\n+        self.assertEqual(vsd_domain.id, vsd_fip.parent_id,\n+                         \"Floating IP in VSD should be associated with the correct VSD domain, which in turn should \"\n+                         \"correspond to the correct VPC (or) network in CloudStack\"\n                          )\n-        ext_subnet_id = self.get_externalID(network.id)\n-        vsd_subnet = self.vsd.get_subnet(externalID=ext_subnet_id)\n+        vsd_subnet = self.vsd.get_subnet(filter=self.get_externalID_filter(network.id))\n         for nic in vm.nic:\n-            if nic.networkname == vsd_subnet[\"description\"]:\n-                ext_network_id = self.get_externalID(nic.networkid)\n-                ext_nic_id = self.get_externalID(nic.id)\n-                vsd_vport = self.vsd.get_vport(subnet_externalID=ext_network_id, vport_externalID=ext_nic_id)\n-                self.debug(\"SHOW VM VPORT DATA FORMAT IN VSD\")\n-                self.debug(vsd_vport)\n-        self.assertEqual(vsd_vport[\"associatedFloatingIPID\"], vsd_fip[\"ID\"],\n-                         \"Floating IP in VSD should be associated to the correct VSD vport, \"\n-                         \"which in turn should correspond to the correct Static NAT enabled VM \"\n-                         \"and network in CloudStack\"\n+            if nic.networkid == network.id:\n+                vsd_vport = self.vsd.get_vport(subnet=vsd_subnet, filter=self.get_externalID_filter(nic.id))\n+        self.assertEqual(vsd_vport.associated_floating_ip_id, vsd_fip.id,\n+                         \"Floating IP in VSD should be associated to the correct VSD vport, which in turn should \"\n+                         \"correspond to the correct Static NAT rule enabled VM and network in CloudStack\"\n+                         )\n+        self.debug(\"Successfully verified the assignment and state of public IP address - %s in VSD\" %\n+                   public_ipaddress.ipaddress)\n+\n+    # verify_vsd_firewall_rule - Verifies the given Network Firewall (Ingress/Egress ACL) rule against the corresponding\n+    # installed firewall rule in VSD\n+    def verify_vsd_firewall_rule(self, firewall_rule, traffic_type=\"Ingress\"):\n+        self.debug(\"Verifying the creation and state of Network Firewall (Ingress/Egress ACL) rule with ID - %s in VSD\"\n+                   % firewall_rule.id)\n+        ext_fw_rule_filter = self.get_externalID_filter(firewall_rule.id)\n+        vsd_fw_rule = self.vsd.get_egress_acl_entry(filter=ext_fw_rule_filter) if traffic_type is \"Ingress\" else \\\n+            self.vsd.get_ingress_acl_entry(filter=ext_fw_rule_filter)\n+        self.assertEqual(vsd_fw_rule.policy_state, \"LIVE\",\n+                         \"Ingress/Egress ACL rule's policy state in VSD should be LIVE\"\n                          )\n-\n-    # verify_vsp_firewall_rule - Verifies the given Ingress/Egress firewall rule\n-    # against the corresponding installed firewall rule in VSD\n-    def verify_vsp_firewall_rule(self, firewall_rule, traffic_type=\"Ingress\"):\n-        ext_fw_id = self.get_externalID(firewall_rule.id)\n-        if traffic_type is \"Ingress\":\n-            vsd_fw_rule = self.vsd.get_egress_acl_entry(externalID=ext_fw_id)\n-        else:\n-            vsd_fw_rule = self.vsd.get_ingress_acl_entry(externalID=ext_fw_id)\n-        self.debug(\"SHOW ACL ENTRY IN VSD\")\n-        self.debug(vsd_fw_rule)\n         dest_port = str(firewall_rule.startport) + \"-\" + str(firewall_rule.endport)\n-        self.assertEqual(vsd_fw_rule[\"destinationPort\"], dest_port,\n-                         \"Destination port in VSD should match destination port in CloudStack\"\n+        self.assertEqual(vsd_fw_rule.destination_port, dest_port,\n+                         \"Ingress/Egress ACL rule's destination port in VSD should match corresponding rule's \"\n+                         \"destination port in CloudStack\"\n                          )\n-        vsd_protocol = str(vsd_fw_rule[\"protocol\"])\n-        self.debug(\"vsd protocol - %s\" % vsd_protocol)\n+        vsd_protocol = int(vsd_fw_rule.protocol)\n         protocol = \"tcp\"\n         if vsd_protocol == 6:\n             protocol = \"tcp\"\n@@ -753,5 +830,8 @@ def verify_vsp_firewall_rule(self, firewall_rule, traffic_type=\"Ingress\"):\n         elif vsd_protocol == 17:\n             protocol = \"udp\"\n         self.assertEqual(protocol, firewall_rule.protocol.lower(),\n-                         \"Protocol in VSD should match protocol in CloudStack\"\n+                         \"Ingress/Egress ACL rule's protocol in VSD should match corresponding rule's protocol in \"\n+                         \"CloudStack\"\n                          )\n+        self.debug(\"Successfully verified the creation and state of Network Firewall (Ingress/Egress ACL) rule with ID \"\n+                   \"- %s in VSD\" % firewall_rule.id)",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/nuageTestCase.py",
                "sha": "a71945c472f480e0c27f90ee5f3562bca6723a48",
                "status": "modified"
            },
            {
                "additions": 156,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_password_reset.py",
                "changes": 321,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/plugins/nuagevsp/test_nuage_password_reset.py?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 165,
                "filename": "test/integration/plugins/nuagevsp/test_nuage_password_reset.py",
                "patch": "@@ -24,7 +24,6 @@\n                              VirtualMachine,\n                              Volume)\n from marvin.lib.common import list_templates\n-from marvin.lib.utils import cleanup_resources\n from marvin.cloudstackAPI import updateTemplate\n # Import System Modules\n from nose.plugins.attrib import attr\n@@ -41,254 +40,246 @@ def setUpClass(cls):\n         return\n \n     def setUp(self):\n-        self.cleanup = []\n-        self.apiclient = self.testClient.getApiClient()\n-\n-        self.account = Account.create(\n-            self.apiclient,\n-            self.test_data[\"account\"],\n-            admin=True,\n-            domainid=self.domain.id\n-        )\n-\n-        self.cleanup.append(self.account)\n-        self.remove_vm2 = False\n+        # Create an account\n+        self.account = Account.create(self.api_client,\n+                                      self.test_data[\"account\"],\n+                                      admin=True,\n+                                      domainid=self.domain.id\n+                                      )\n+        self.cleanup = [self.account]\n         return\n \n-    # tearDown() - Cleans up the setup, removes the VMs\n-    def tearDown(self):\n-        self.debug(\"CLEANUP: TEARDOWN\")\n-        self.apiclient = self.testClient.getApiClient()\n-        self.updateTemplate(self.defaultTemplateVal)\n-        self.vm_1.delete(self.apiclient, expunge=True)\n-        if self.remove_vm2:\n-            self.vm_2.delete(self.apiclient, expunge=True)\n-        try:\n-            cleanup_resources(self.apiclient, self.cleanup)\n-        except Exception as e:\n-            self.debug(\"Warning: Exception during cleanup: %s\" % e)\n-        return\n-\n-    # create_template - Creates template with the given VM object\n+    # create_template - Creates guest VM template with the given VM object\n     def create_template(self, vm):\n-        self.debug(\"Creating template\")\n-        list_volume = Volume.list(self.apiclient,\n+        self.debug(\"Creating guest VM template\")\n+        list_volume = Volume.list(self.api_client,\n                                   virtualmachineid=vm.id,\n                                   type='ROOT',\n-                                  listall=True)\n+                                  listall=True\n+                                  )\n         if isinstance(list_volume, list):\n             self.volume = list_volume[0]\n         else:\n             raise Exception(\"Exception: Unable to find root volume for VM with ID - %s\" % vm.id)\n-        self.pw_enabled_template = Template.create(\n-            self.apiclient,\n-            self.test_data[\"template\"],\n-            self.volume.id,\n-            account=self.account.name,\n-            domainid=self.account.domainid\n-        )\n-        self.assertEqual(self.pw_enabled_template.passwordenabled, True, \"template is not passwordenabled\")\n+        self.pw_enabled_template = Template.create(self.api_client,\n+                                                   self.test_data[\"template\"],\n+                                                   self.volume.id,\n+                                                   account=self.account.name,\n+                                                   domainid=self.account.domainid\n+                                                   )\n+        self.assertEqual(self.pw_enabled_template.passwordenabled, True,\n+                         \"template is not passwordenabled\"\n+                         )\n         self.cleanup.append(self.pw_enabled_template)\n-        self.debug(\"Created template\")\n+        self.debug(\"Created guest VM template\")\n \n-    # updateTemplate - Updates value of template's password enabled setting\n+    # updateTemplate - Updates value of the guest VM template's password enabled setting\n     def updateTemplate(self, value):\n-        self.debug(\"Updating value of template's password enabled setting\")\n+        self.debug(\"Updating value of guest VM template's password enabled setting\")\n         cmd = updateTemplate.updateTemplateCmd()\n         cmd.id = self.template.id\n         cmd.passwordenabled = value\n-        self.apiclient.updateTemplate(cmd)\n-        list_template_response = list_templates(self.apiclient,\n+        self.api_client.updateTemplate(cmd)\n+        list_template_response = list_templates(self.api_client,\n                                                 templatefilter=\"all\",\n                                                 id=self.template.id\n                                                 )\n         self.template = list_template_response[0]\n-        self.debug(\"Updated template\")\n-\n-    # VM object is passed as an argument and its interface id is returned\n-    def get_vm_interface_id(self, vm):\n-        self.debug(\"GET VM INTERFACE ID\")\n-        nic_ext_id = self.get_externalID(vm.nic[0].id)\n-        vm_interface = self.vsd.get_vm_interface(externalID=nic_ext_id)\n-        vm_interface_id = vm_interface[\"ID\"]\n-        return vm_interface_id\n+        self.debug(\"Updated guest VM template\")\n \n-    # VM object is passed as an argument and its userdata URL is returned\n+    # get_userdata_url - Returns user data URL for the given VM object\n     def get_userdata_url(self, vm):\n-        self.debug(\"GET USER DATA URL\")\n+        self.debug(\"Getting user data url\")\n         nic = vm.nic[0]\n         gateway = str(nic.gateway)\n-        self.debug(\"GATEWAY: \" + gateway)\n+        self.debug(\"Gateway: \" + gateway)\n         user_data_url = 'curl \"http://' + gateway + ':80/latest/user-data\"'\n         return user_data_url\n \n-    # Creates and verifies the firewall rule\n+    # create_and_verify_fw - Creates and verifies (Ingress) firewall rule with a Static NAT rule enabled public IP\n     def create_and_verify_fw(self, vm, public_ip, network):\n-        self.debug(\"Create and verify firewall rule\")\n+        self.debug(\"Creating and verifying firewall rule\")\n         self.create_StaticNatRule_For_VM(vm, public_ip, network)\n \n         # VSD verification\n-        self.verify_vsp_floating_ip(network, vm, public_ip.ipaddress)\n+        self.verify_vsd_floating_ip(network, vm, public_ip.ipaddress)\n \n         fw_rule = self.create_FirewallRule(public_ip, self.test_data[\"ingress_rule\"])\n-        self.verify_vsp_firewall_rule(fw_rule)\n-        vm_interface_id = self.get_vm_interface_id(vm)\n-        pd = self.vsd.get_vm_interface_policydecisions(id=vm_interface_id)\n-        self.debug(pd)\n-        egressAcls = pd['egressACLs'][0]['entries']\n-        gotFirewallPolicy = False\n-        for acl in egressAcls:\n-            if acl['destinationPort'] == \"22-22\":\n-                gotFirewallPolicy = True\n-                break\n-        if not gotFirewallPolicy:\n-            raise ValueError('No firewall policy decision in vm interface')\n \n+        # VSD verification\n+        self.verify_vsd_firewall_rule(fw_rule)\n+        self.debug(\"Successfully created and verified firewall rule\")\n+\n+    # stop_vm - Stops the given VM, and verifies its state\n     def stop_vm(self, vm):\n         self.debug(\"Stoping VM\")\n-        vm.stop(self.apiclient)\n-        list_vm_response = VirtualMachine.list(self.apiclient,\n-                                               id=vm.id)\n+        vm.stop(self.api_client)\n+        list_vm_response = VirtualMachine.list(self.api_client,\n+                                               id=vm.id\n+                                               )\n         if isinstance(list_vm_response, list):\n             vm = list_vm_response[0]\n             if vm.state != 'Stopped':\n-                raise Exception(\"Failed to stop VM (ID: %s) \" %\n-                                self.vm.id)\n+                raise Exception(\"Failed to stop VM (ID: %s) \" % self.vm.id)\n         else:\n-            raise Exception(\"Invalid response from list_virtual_machines VM (ID: %s) \" %\n-                            self.vm.id)\n+            raise Exception(\"Invalid response from list_virtual_machines VM (ID: %s) \" % self.vm.id)\n+        self.debug(\"Stopped VM\")\n \n+    # install_cloud_set_guest_password_script - Installs the cloud-set-guest-password script from people.apache.org in\n+    # the given VM (SSH client)\n     def install_cloud_set_guest_password_script(self, ssh_client):\n-        self.debug(\"GET CLOUD-SET-GUEST-PASSWORD\")\n+        self.debug(\"Installing cloud-set-guest-password script\")\n         cmd = \"cd /etc/init.d;wget http://people.apache.org/~tsp/cloud-set-guest-password\"\n         result = self.execute_cmd(ssh_client, cmd)\n-        self.debug(\"WGET CLOUD-SET-GUEST-PASSWORD: \" + result)\n+        self.debug(\"wget file cloud-set-guest-password: \" + result)\n         if \"200 OK\" not in result:\n-            self.fail(\"failed to get file cloud-set-guest-password\")\n+            self.fail(\"failed to wget file cloud-set-guest-password\")\n         cmds = [\"chmod +x /etc/init.d/cloud-set-guest-password\",\n                 \"chkconfig --add cloud-set-guest-password\"\n                 ]\n         for c in cmds:\n             result = self.execute_cmd(ssh_client, c)\n             self.debug(\"get_set_password_file cmd \" + c)\n             self.debug(\"get_set_password_file result \" + result)\n+        self.debug(\"Installed cloud-set-guest-password script\")\n \n     @attr(tags=[\"advanced\", \"nuagevsp\"], required_hardware=\"true\")\n     def test_nuage_UserDataPasswordReset(self):\n         \"\"\"Test user data and password reset functionality with Nuage VSP SDN plugin\n         \"\"\"\n \n-        \"\"\"\n-         Validate the following:\n-         1) user data\n-         2) reset vm password.\n-\n-         Steps:\n-         1.  Set password enabled to false in the template.\n-         2.  Create an Isolated network - Test Network (10.1.1.1/24).\n-         3.  Deploy VM1 in Test Network\n-         4.  Verify domain,zone subnet, vm.\n-         5.  create public IP, Create Static Nat rule firewall rule and verify\n-         6.  SSH to VM should be successful\n-         7.  verify userdata\n-         8.  check cloud-set-guest-password exist.\n-         9.  if cloud-set-guest-password exist.\n-          9.1   change template password enabled to true\n-          9.2   verify that template is password enbalded\n-          9.3   SSH with new password should be successful\n-         10. else cloud-set-guest-password does not exist.\n-          10.1  get the cloud-set-guest-password file\n-          10.2  stop vm\n-          10.3  create a new template with password enabled. Verify that template is password enabled.\n-          10.4  create vm 2 with new template in Test Network\n-          10.5  Verify vm.\n-          10.6  create public IP, Create Static Nat rule firewall rule and verify\n-          10.7  SSH to VM 2 should be successful\n-         11. Reset VM password (VM_1 if guest password file exist.  else it is VM2)\n-         12  Starting VM and SSH to VM to verify new password\n-        \"\"\"\n-\n-        self.debug(\"TEST USER DATA & PASSWORD RESET ON VM\")\n+        # 1. Create an Isolated Network with Nuage VSP Isolated Network offering, check if it is successfully created\n+        #    and is in the \"Allocated\" state.\n+        # 2. Set password enabled to false in the guest VM template.\n+        # 3. Deploy a VM in the created Isolated network with user data, check if the Isolated network state is changed\n+        #    to \"Implemented\", and both the VM & VR are successfully deployed and are in the \"Running\" state.\n+        # 4. Verify that the guest VM template is not password enabled by checking the deployed VM's password\n+        #    (password == \"password\").\n+        # 5. SSH into the deployed VM and verify its user data (expected user data == actual user data).\n+        # 6. Check for cloud-set-guest-password script in the deployed VM for testing password reset functionality.\n+        # 7. if cloud-set-guest-password script does not exist in the deployed VM:\n+        #       7.1  Install the cloud-set-guest-password script from people.apache.org in the deployed VM.\n+        #       7.2  Stop the deployed VM, and create a new password enabled guest VM template with it.\n+        #       7.3  Deploy a new VM in the created Isolated network with the newly created guest VM template,\n+        #            check if the VM is successfully deployed and is in the \"Running\" state.\n+        #       7.4  Verify that the new guest VM template is password enabled by checking the newly deployed VM's\n+        #            password (password != \"password\").\n+        #       7.5  SSH into the newly deployed VM for verifying its password.\n+        # 8. else cloud-set-guest-password script exists in the deployed VM:\n+        #       8.1  Change password enabled to true in the guest VM template.\n+        #       8.2  Verify that the guest VM template is password enabled.\n+        # 9. Reset VM password, and start the VM.\n+        # 10. Verify that the new guest VM template is password enabled by checking the VM's password\n+        #     (password != \"password\").\n+        # 11. SSH into the VM for verifying its new password after its password reset.\n+        # 12. Set password enabled to the default value in the guest VM template.\n+        # 13. Delete all the created objects (cleanup).\n+\n+        self.debug(\"Testing user data & password reset functionality in an Isolated network...\")\n+\n+        self.debug(\"Creating an Isolated network...\")\n+        net_off = self.create_NetworkOffering(self.test_data[\"nuagevsp\"][\"isolated_network_offering\"])\n+        self.network = self.create_Network(net_off)\n+        self.validate_Network(self.network, state=\"Allocated\")\n \n+        self.debug(\"Setting password enabled to false in the guest VM template...\")\n         self.defaultTemplateVal = self.template.passwordenabled\n         if self.template.passwordenabled:\n             self.updateTemplate(False)\n \n-        self.debug(\"CREATE AN ISOLATED NETWORK\")\n-        net_off = self.create_NetworkOffering(self.test_data[\"nuagevsp\"][\"isolated_network_offering\"])\n-        self.network_1 = self.create_Network(net_off)\n-        self.cleanup.append(self.network_1)\n-        expUserData = \"hello world vm1\"\n-        userdata = base64.b64encode(expUserData)\n-        self.test_data[\"virtual_machine_userdata\"][\"userdata\"] = userdata\n-        self.debug(\"DEPLOY VM 1 IN TEST NETWORK\")\n-        # Pass the network and name of the vm type from the testdata with the configuration for the vm\n-        self.vm_1 = self.create_VM(self.network_1, vm_key=\"virtual_machine_userdata\")\n-\n-        self.vm_1.password = self.test_data[\"virtual_machine_userdata\"][\"password\"]\n-        user_data_cmd = self.get_userdata_url(self.vm_1)\n+        self.debug(\"Deploying a VM in the created Isolated network with user data...\")\n+        expected_user_data = \"hello world vm1\"\n+        user_data = base64.b64encode(expected_user_data)\n+        self.test_data[\"virtual_machine_userdata\"][\"userdata\"] = user_data\n+        self.vm_1 = self.create_VM(self.network, testdata=self.test_data[\"virtual_machine_userdata\"])\n+        self.validate_Network(self.network, state=\"Implemented\")\n+        vr = self.get_Router(self.network)\n+        self.check_Router_state(vr, state=\"Running\")\n+        self.check_VM_state(self.vm_1, state=\"Running\")\n \n         # VSD verification\n-        self.debug(\"VERIFY DOMAIN, ZONE, NETWORK , and VM 1\")\n-        self.verify_vsp_network(self.domain.id, self.network_1)\n-        self.verify_vsp_vm(self.vm_1)\n-\n-        self.debug(\"CREATE PUBLIC IP, STATIC NAT RULE, FLOATING IP, FIREWALL AND VERIFY\")\n-        public_ip_1 = self.acquire_PublicIPAddress(self.network_1)\n-        self.create_and_verify_fw(self.vm_1, public_ip_1, self.network_1)\n-\n-        self.debug(\"SSH TO VM\")\n+        self.verify_vsd_network(self.domain.id, self.network)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(self.vm_1)\n+\n+        self.debug(\"verifying that the guest VM template is not password enabled...\")\n+        self.debug(\"VM - %s password - %s !\" % (self.vm_1.name, self.vm_1.password))\n+        self.assertEqual(self.vm_1.password, self.test_data[\"virtual_machine_userdata\"][\"password\"],\n+                         \"Password is enabled for the VM (vm_1)\"\n+                         )\n+\n+        self.debug(\"SSHing into the VM for verifying its user data...\")\n+        public_ip_1 = self.acquire_PublicIPAddress(self.network)\n+        self.create_and_verify_fw(self.vm_1, public_ip_1, self.network)\n         ssh = self.ssh_into_VM(self.vm_1, public_ip_1)\n-\n-        self.debug(\"VERIFY USER DATA\")\n-        self.debug(\"Get User Data with command: \" + user_data_cmd)\n-        adata = self.execute_cmd(ssh, user_data_cmd)\n-        actUserData = base64.b64decode(adata)\n-        self.debug(\"Response User Data=\" + actUserData + \", Expected=\" + expUserData)\n-        self.assertEqual(actUserData, expUserData, \"User Data Did Not Match \")\n-\n-        # check /etc/init.d/cloud-set-quest-password\n+        user_data_cmd = self.get_userdata_url(self.vm_1)\n+        self.debug(\"Getting user data with command: \" + user_data_cmd)\n+        actual_user_data = base64.b64decode(self.execute_cmd(ssh, user_data_cmd))\n+        self.debug(\"Actual user data - \" + actual_user_data + \", Expected user data - \" + expected_user_data)\n+        self.assertEqual(actual_user_data, expected_user_data,\n+                         \"Un-expected VM (VM_1) user data\"\n+                         )\n+\n+        self.debug(\"Checking for cloud-set-guest-password script in the VM for testing password reset functionality...\")\n         ls_cmd = \"ls /etc/init.d/cloud-set-guest-password\"\n         ls_result = self.execute_cmd(ssh, ls_cmd)\n         ls_result = ls_result.lower()\n-        self.debug(\"reponse from ls_cmd: \" + ls_result)\n+        self.debug(\"Response from ls_cmd: \" + ls_result)\n         if \"no such file\" in ls_result:\n-            self.debug(\"NO CLOUD-SET_GUEST_PASSWORD FILE.  NEED TO GET ONE\")\n+            self.debug(\"No cloud-set-guest-password script in the VM\")\n+            self.debug(\"Installing the cloud-set-guest-password script from people.apache.org in the VM...\")\n             self.install_cloud_set_guest_password_script(ssh)\n+            self.debug(\"Stopping the VM, and creating a new password enabled guest VM template with it...\")\n             self.stop_vm(self.vm_1)\n             self.create_template(self.vm_1)\n-            self.debug(\"DEPLOY VM 2 IN TEST NETWORK WITH NEW TEMPLATE\")\n-            self.vm_2 = self.create_VM(self.network_1, vm_key=\"virtual_machine_userdata\")\n-            self.remove_vm2 = True\n-            self.debug(\"STARTING VM_2 \")\n-            vm_2a = self.vm_2.start(self.apiclient)\n+\n+            self.debug(\"Deploying a new VM in the created Isolated network with the newly created guest VM template...\")\n+            self.vm_2 = self.create_VM(self.network, testdata=self.test_data[\"virtual_machine_userdata\"])\n+            self.debug(\"Starting the VM...\")\n+            vm_2a = self.vm_2.start(self.api_client)\n             self.vm_2.password = vm_2a.password.strip()\n             self.vm_2.nic = vm_2a.nic\n+\n+            # VSD verification\n+            self.verify_vsd_vm(self.vm_2)\n+\n+            self.debug(\"verifying that the guest VM template is password enabled...\")\n             self.debug(\"VM - %s password - %s !\" % (self.vm_2.name, self.vm_2.password))\n-            self.assertNotEqual(self.vm_2.password,\n-                                self.test_data[\"virtual_machine_userdata\"][\"password\"],\n-                                \"Password enabled not working. Password same as virtual_machine password \"\n+            self.assertNotEqual(self.vm_2.password, self.test_data[\"virtual_machine_userdata\"][\"password\"],\n+                                \"Password is not enabled for the VM\"\n                                 )\n-            self.verify_vsp_vm(vm_2a)\n-            self.debug(\"GET PUBLIC IP.  CREATE AND VERIFIED FIREWALL RULES\")\n-            public_ip_2 = self.acquire_PublicIPAddress(self.network_1)\n-            self.create_and_verify_fw(self.vm_2, public_ip_2, self.network_1)\n \n+            self.debug(\"SSHing into the VM for verifying its password...\")\n+            public_ip_2 = self.acquire_PublicIPAddress(self.network)\n+            self.create_and_verify_fw(self.vm_2, public_ip_2, self.network)\n             self.ssh_into_VM(self.vm_2, public_ip_2)\n+\n             vm_test = self.vm_2\n             vm_test_public_ip = public_ip_2\n-\n         else:\n-            self.debug(\"UPDATE TEMPLATE TO PASSWORD ENABLED\")\n+            self.debug(\"Updating the guest VM template to password enabled\")\n             self.updateTemplate(True)\n-            self.assertEqual(self.template.passwordenabled, True, \"Template is not password enabled\")\n+            self.assertEqual(self.template.passwordenabled, True,\n+                             \"Guest VM template is not password enabled\"\n+                             )\n             vm_test = self.vm_1\n             vm_test_public_ip = public_ip_1\n \n-        self.debug(\"RESETTING VM PASSWORD for VM - %s\" % vm_test.name)\n-        vm_test.password = vm_test.resetPassword(self.apiclient)\n+        self.debug(\"Resetting password for VM - %s\" % vm_test.name)\n+        vm_test.password = vm_test.resetPassword(self.api_client)\n         self.debug(\"Password reset to - %s\" % vm_test.password)\n-        self.debug(\"STARTING VM AND SSH TO VM TO VERIFY NEW PASSWORD\")\n-        vm_test.start(self.apiclient)\n-        self.debug(\"VM - %s started!\" % vm_test.name)\n+\n+        self.debug(\"Starting the VM\")\n+        vm_test.start(self.api_client)\n+\n+        self.debug(\"verifying that the guest VM template is password enabled...\")\n+        self.debug(\"VM - %s password - %s !\" % (vm_test.name, vm_test.password))\n+        self.assertNotEqual(vm_test.password, self.test_data[\"virtual_machine_userdata\"][\"password\"],\n+                            \"Password is not enabled for the VM\"\n+                            )\n+\n+        self.debug(\"SSHing into the VM for verifying its new password after its password reset...\")\n         self.ssh_into_VM(vm_test, vm_test_public_ip)\n+\n+        self.debug(\"Setting password enabled to the default value in the guest VM template...\")\n+        self.updateTemplate(self.defaultTemplateVal)",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_password_reset.py",
                "sha": "bd8bba6ac782ad18b6f2cc75e33a5cf2a1669b15",
                "status": "modified"
            },
            {
                "additions": 233,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_vpc_internal_lb.py",
                "changes": 471,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/plugins/nuagevsp/test_nuage_vpc_internal_lb.py?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 238,
                "filename": "test/integration/plugins/nuagevsp/test_nuage_vpc_internal_lb.py",
                "patch": "@@ -136,7 +136,7 @@ def start_InternalLbVm(self, int_lb_vm):\n         cmd.id = int_lb_vm.id\n         self.api_client.startInternalLoadBalancerVM(cmd)\n \n-    # check_InternalLbVm_state - Checks if the Internal LB VM instance of the given VPC network and source ip is in the\n+    # check_InternalLbVm_state - Checks if the Internal LB VM instance of the given VPC network and source IP is in the\n     # expected state form the list of fetched Internal LB VM instances\n     def check_InternalLbVm_state(self, network, source_ip, state=None):\n         self.debug(\"Check if the InternalLbVm is in state - %s\" % state)\n@@ -220,7 +220,7 @@ def test_01_nuage_internallb_vpc_Offering(self):\n         # 4. Create Nuage VSP VPC offering with LB service provider as \"Netscaler\", check if it is successfully\n         #    created and enabled. Verify that the VPC creation fails with this VPC offering as Nuage VSP does not\n         #    support provider \"Netscaler\" for service LB.\n-        # 5. Delete the created VPC offerings (cleanup).\n+        # 5. Delete all the created objects (cleanup).\n \n         self.debug(\"Validating network service providers supported by Nuage VSP for VPC Internal LB functionality\")\n         providers = [\"NuageVsp\", \"VpcVirtualRouter\", \"InternalLbVm\"]\n@@ -271,25 +271,25 @@ def test_02_nuage_internallb_vpc_network_offering(self):\n         \"\"\"Test Nuage VSP VPC Network Offering with and without Internal LB service\n         \"\"\"\n \n-        # 1. Create Nuage Vsp VPC Network offering with LB Service Provider as \"InternalLbVm\" and LB Service Capability\n+        # 1. Create Nuage VSP VPC Network offering with LB Service Provider as \"InternalLbVm\" and LB Service Capability\n         #    \"lbSchemes\" as \"internal\", check if it is successfully created and enabled. Verify that the VPC network\n         #    creation succeeds with this Network offering.\n         # 2. Recreate above Network offering with ispersistent False, check if it is successfully created and enabled.\n         #    Verify that the VPC network creation fails with this Network offering as Nuage VSP does not support non\n         #    persistent VPC networks.\n         # 3. Recreate above Network offering with conserve mode On, check if the network offering creation failed\n         #    as only networks with conserve mode Off can belong to VPC.\n-        # 4. Create Nuage Vsp VPC Network offering with LB Service Provider as \"InternalLbVm\" and LB Service Capability\n+        # 4. Create Nuage VSP VPC Network offering with LB Service Provider as \"InternalLbVm\" and LB Service Capability\n         #    \"lbSchemes\" as \"public\", check if the network offering creation failed as \"public\" lbScheme is not\n         #    supported for LB Service Provider \"InternalLbVm\".\n-        # 5. Create Nuage Vsp VPC Network offering without Internal LB Service, check if it is successfully created and\n+        # 5. Create Nuage VSP VPC Network offering without Internal LB Service, check if it is successfully created and\n         #    enabled. Verify that the VPC network creation succeeds with this Network offering.\n         # 6. Recreate above Network offering with ispersistent False, check if it is successfully created and enabled.\n         #    Verify that the VPC network creation fails with this Network offering as Nuage VSP does not support non\n         #    persistent VPC networks.\n         # 7. Recreate the above Network offering with conserve mode On, check if the network offering creation failed\n         #    as only networks with conserve mode Off can belong to VPC.\n-        # 8. Delete the created Network offerings (cleanup).\n+        # 8. Delete all the created objects (cleanup).\n \n         # Creating VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering with Internal LB service...\")\n@@ -328,7 +328,7 @@ def test_02_nuage_internallb_vpc_network_offering(self):\n         self.debug(\"Network offering creation failed as public lbScheme is not supported for LB Service Provider \"\n                    \"InternalLbVm\")\n \n-        self.debug(\"Creating Nuage Vsp VPC Network offering without Internal LB service...\")\n+        self.debug(\"Creating Nuage VSP VPC Network offering without Internal LB service...\")\n         net_off_3 = self.create_NetworkOffering(self.test_data[\"nuagevsp\"][\"vpc_network_offering\"])\n         self.validate_NetworkOffering(net_off_3, state=\"Enabled\")\n \n@@ -351,8 +351,8 @@ def test_02_nuage_internallb_vpc_network_offering(self):\n         self.check_Router_state(vr, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n \n         self.debug(\"Creating a non persistent VPC network with Internal LB service...\")\n         with self.assertRaises(Exception):\n@@ -366,8 +366,8 @@ def test_02_nuage_internallb_vpc_network_offering(self):\n         self.check_Router_state(vr, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n \n         self.debug(\"Creating a non persistent VPC network without Internal LB service...\")\n         with self.assertRaises(Exception):\n@@ -437,29 +437,29 @@ def test_03_nuage_internallb_vpc_networks(self):\n         vr_1 = self.get_Router(internal_tier_1)\n         self.check_Router_state(vr_1, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier_1.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm_1 = self.create_VM(internal_tier_1)\n         self.check_VM_state(internal_vm_1, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_1, vpc_1)\n-        self.verify_vsp_router(vr_1)\n-        self.verify_vsp_vm(internal_vm_1)\n+        self.verify_vsd_network(self.domain.id, internal_tier_1, vpc_1)\n+        self.verify_vsd_router(vr_1)\n+        self.verify_vsd_vm(internal_vm_1)\n \n         self.debug(\"Creating one more VPC network in vpc_1 with Internal LB service...\")\n         internal_tier_2 = self.create_Network(net_off_1, gateway='10.1.2.1', vpc=vpc_1)\n         self.validate_Network(internal_tier_2, state=\"Implemented\")\n         vr_1 = self.get_Router(internal_tier_2)\n         self.check_Router_state(vr_1, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier_2.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm_2 = self.create_VM(internal_tier_2)\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_2, vpc_1)\n-        self.verify_vsp_router(vr_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_network(self.domain.id, internal_tier_2, vpc_1)\n+        self.verify_vsd_router(vr_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         self.debug(\"Creating a VPC network in vpc_2 with Internal LB service...\")\n         with self.assertRaises(Exception):\n@@ -472,29 +472,29 @@ def test_03_nuage_internallb_vpc_networks(self):\n         vr_1 = self.get_Router(public_tier_1)\n         self.check_Router_state(vr_1, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier_1.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm_1 = self.create_VM(public_tier_1)\n         self.check_VM_state(public_vm_1, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier_1, vpc_1)\n-        self.verify_vsp_router(vr_1)\n-        self.verify_vsp_vm(public_vm_1)\n+        self.verify_vsd_network(self.domain.id, public_tier_1, vpc_1)\n+        self.verify_vsd_router(vr_1)\n+        self.verify_vsd_vm(public_vm_1)\n \n         self.debug(\"Creating a VPC network in vpc_2 without Internal LB service...\")\n         public_tier_2 = self.create_Network(net_off_2, gateway='10.1.1.1', vpc=vpc_2)\n         self.validate_Network(public_tier_2, state=\"Implemented\")\n         vr_2 = self.get_Router(public_tier_2)\n         self.check_Router_state(vr_2, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier_2.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm_2 = self.create_VM(public_tier_2)\n         self.check_VM_state(public_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier_2, vpc_2)\n-        self.verify_vsp_router(vr_2)\n-        self.verify_vsp_vm(public_vm_2)\n+        self.verify_vsd_network(self.domain.id, public_tier_2, vpc_2)\n+        self.verify_vsd_router(vr_2)\n+        self.verify_vsd_vm(public_vm_2)\n \n         # Upgrading a VPC network\n         self.debug(\"Upgrading a VPC network with Internal LB Service to one without Internal LB Service...\")\n@@ -505,9 +505,9 @@ def test_03_nuage_internallb_vpc_networks(self):\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_2, vpc_1)\n-        self.verify_vsp_router(vr_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_network(self.domain.id, internal_tier_2, vpc_1)\n+        self.verify_vsd_router(vr_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         self.debug(\"Upgrading a VPC network without Internal LB Service to one with Internal LB Service...\")\n         self.upgrade_Network(net_off_1, internal_tier_2)\n@@ -517,9 +517,9 @@ def test_03_nuage_internallb_vpc_networks(self):\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_2, vpc_1)\n-        self.verify_vsp_router(vr_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_network(self.domain.id, internal_tier_2, vpc_1)\n+        self.verify_vsd_router(vr_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         # Deleting and re-creating a VPC network\n         self.debug(\"Deleting a VPC network with Internal LB Service...\")\n@@ -531,7 +531,7 @@ def test_03_nuage_internallb_vpc_networks(self):\n \n         # VSD verification\n         with self.assertRaises(Exception):\n-            self.verify_vsp_network(self.domain.id, internal_tier_2, vpc_1)\n+            self.verify_vsd_network(self.domain.id, internal_tier_2, vpc_1)\n         self.debug(\"VPC network successfully deleted in VSD\")\n \n         self.debug(\"Recreating a VPC network with Internal LB Service...\")\n@@ -543,9 +543,9 @@ def test_03_nuage_internallb_vpc_networks(self):\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_2, vpc_1)\n-        self.verify_vsp_router(vr_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_network(self.domain.id, internal_tier_2, vpc_1)\n+        self.verify_vsd_router(vr_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n     @attr(tags=[\"advanced\", \"nuagevsp\"], required_hardware=\"false\")\n     def test_04_nuage_internallb_rules(self):\n@@ -576,6 +576,7 @@ def test_04_nuage_internallb_rules(self):\n         #     VM to it.\n         # 11. Verify the failure of attaching a VM from a different tier to an Internal LB Rule created on a tier.\n         # 12. Delete the above created Internal LB Rules, check if the Internal LB Rules are successfully deleted.\n+        # 13. Delete all the created objects (cleanup).\n \n         # Creating a VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering with Internal LB service...\")\n@@ -604,29 +605,29 @@ def test_04_nuage_internallb_rules(self):\n         vr = self.get_Router(internal_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm = self.create_VM(internal_tier)\n         self.check_VM_state(internal_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n \n         self.debug(\"Creating a VPC network without Internal LB service...\")\n         public_tier = self.create_Network(net_off_2, gateway='10.1.2.1', vpc=vpc)\n         self.validate_Network(public_tier, state=\"Implemented\")\n         vr = self.get_Router(public_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm = self.create_VM(public_tier)\n         self.check_VM_state(public_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n \n         # Creating Internal LB Rules\n         self.debug(\"Creating an Internal LB Rule without source IP Address specified...\")\n@@ -691,8 +692,8 @@ def test_04_nuage_internallb_rules(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_2.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_1)\n-        self.verify_vsp_LB_device(int_lb_vm_2)\n+        self.verify_vsd_lb_device(int_lb_vm_1)\n+        self.verify_vsd_lb_device(int_lb_vm_2)\n \n         self.debug('Removing VMs from the Internal LB Rules - %s, %s' % (int_lb_rule_1.name, int_lb_rule_2.name))\n         int_lb_rule_1.remove(self.api_client, vms=[internal_vm])\n@@ -709,8 +710,8 @@ def test_04_nuage_internallb_rules(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_2.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_1)\n-        self.verify_vsp_LB_device(int_lb_vm_2)\n+        self.verify_vsd_lb_device(int_lb_vm_1)\n+        self.verify_vsd_lb_device(int_lb_vm_2)\n \n         self.debug('Deleting the Internal LB Rules - %s, %s' % (int_lb_rule_1.name, int_lb_rule_2.name))\n         int_lb_rule_1.delete(self.api_client)\n@@ -732,10 +733,10 @@ def test_04_nuage_internallb_rules(self):\n \n         # VSD Verification\n         with self.assertRaises(Exception):\n-            self.verify_vsp_LB_device(int_lb_vm_1)\n+            self.verify_vsd_lb_device(int_lb_vm_1)\n         self.debug(\"InternalLbVm successfully destroyed in VSD\")\n         with self.assertRaises(Exception):\n-            self.verify_vsp_LB_device(int_lb_vm_2)\n+            self.verify_vsd_lb_device(int_lb_vm_2)\n         self.debug(\"InternalLbVm successfully destroyed in VSD\")\n \n         self.debug(\"Creating multiple Internal LB Rules with different ports but using the same Load Balancing source \"\n@@ -754,7 +755,7 @@ def test_04_nuage_internallb_rules(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         self.debug('Removing VMs from the Internal LB Rules - %s, %s' % (int_lb_rule_1.name, int_lb_rule_2.name))\n         int_lb_rule_1.remove(self.api_client, vms=[internal_vm])\n@@ -770,7 +771,7 @@ def test_04_nuage_internallb_rules(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         self.debug('Deleting the Internal LB Rules - %s, %s' % (int_lb_rule_1.name, int_lb_rule_2.name))\n         int_lb_rule_1.delete(self.api_client)\n@@ -789,10 +790,10 @@ def test_04_nuage_internallb_rules(self):\n \n         # VSD Verification\n         with self.assertRaises(Exception):\n-            self.verify_vsp_LB_device(int_lb_vm)\n+            self.verify_vsd_lb_device(int_lb_vm)\n         self.debug(\"InternalLbVm successfully destroyed in VSD\")\n \n-        self.debug(\"Creating multiple Internal LB Rules with same ports and using the same Load Balacing source IP \"\n+        self.debug(\"Creating multiple Internal LB Rules with same ports and using the same Load Balancing source IP \"\n                    \"Address...\")\n         int_lb_rule = self.create_Internal_LB_Rule(internal_tier, vm_array=[internal_vm])\n         self.validate_Internal_LB_Rule(int_lb_rule, state=\"Active\", vm_array=[internal_vm])\n@@ -805,7 +806,7 @@ def test_04_nuage_internallb_rules(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         self.debug('Removing VMs from the Internal LB Rule - %s' % int_lb_rule.name)\n         int_lb_rule.remove(self.api_client, vms=[internal_vm])\n@@ -817,7 +818,7 @@ def test_04_nuage_internallb_rules(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         self.debug('Deleting the Internal LB Rule - %s' % int_lb_rule.name)\n         int_lb_rule.delete(self.api_client)\n@@ -832,7 +833,7 @@ def test_04_nuage_internallb_rules(self):\n \n         # VSD Verification\n         with self.assertRaises(Exception):\n-            self.verify_vsp_LB_device(int_lb_vm)\n+            self.verify_vsd_lb_device(int_lb_vm)\n         self.debug(\"InternalLbVm successfully destroyed in VSD\")\n \n         self.debug(\"Attaching a VM from a different tier to an Internal LB Rule created on a tier...\")\n@@ -862,6 +863,7 @@ def test_05_nuage_internallb_traffic(self):\n         # 8. Verify that the InternalLbVm gets destroyed when the last Internal LB rule is removed from the Internal\n         #    tier.\n         # 9. Repeat the above steps for one more Internal tier as well, validate the Internal LB functionality.\n+        # 10. Delete all the created objects (cleanup).\n \n         # Creating a VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering with Internal LB service...\")\n@@ -890,44 +892,44 @@ def test_05_nuage_internallb_traffic(self):\n         vr = self.get_Router(internal_tier_1)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier_1.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm_1 = self.create_VM(internal_tier_1)\n         self.check_VM_state(internal_vm_1, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_1, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm_1)\n+        self.verify_vsd_network(self.domain.id, internal_tier_1, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm_1)\n \n         self.debug(\"Creating one more VPC network with Internal LB service...\")\n         internal_tier_2 = self.create_Network(net_off_1, gateway='10.1.2.1', vpc=vpc)\n         self.validate_Network(internal_tier_2, state=\"Implemented\")\n         vr = self.get_Router(internal_tier_2)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier_2.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm_2 = self.create_VM(internal_tier_2)\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier_2, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_network(self.domain.id, internal_tier_2, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         self.debug(\"Creating a VPC network without Internal LB service...\")\n         public_tier = self.create_Network(net_off_2, gateway='10.1.3.1', vpc=vpc)\n         self.validate_Network(public_tier, state=\"Implemented\")\n         vr = self.get_Router(public_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm = self.create_VM(public_tier)\n         self.check_VM_state(public_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n \n         # Creating Internal LB Rules in the Internal tiers\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) using the same Load Balancing source IP Address...\")\n@@ -945,16 +947,16 @@ def test_05_nuage_internallb_traffic(self):\n         self.check_InternalLbVm_state(internal_tier_1, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_1)\n+        self.verify_vsd_lb_device(int_lb_vm_1)\n \n         # Deploying more VMs in the Internal tier\n         self.debug(\"Deploying two more VMs in network - %s\" % internal_tier_1.name)\n         internal_vm_1_1 = self.create_VM(internal_tier_1)\n         internal_vm_1_2 = self.create_VM(internal_tier_1)\n \n         # VSD verification\n-        self.verify_vsp_vm(internal_vm_1_1)\n-        self.verify_vsp_vm(internal_vm_1_2)\n+        self.verify_vsd_vm(internal_vm_1_1)\n+        self.verify_vsd_vm(internal_vm_1_2)\n \n         # Adding newly deployed VMs to the created Internal LB rules\n         self.debug(\"Adding two more virtual machines to the created Internal LB rules...\")\n@@ -969,16 +971,16 @@ def test_05_nuage_internallb_traffic(self):\n         self.check_InternalLbVm_state(internal_tier_1, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_1)\n+        self.verify_vsd_lb_device(int_lb_vm_1)\n \n         # Adding Network ACL rules in the Internal tier\n         self.debug(\"Adding Network ACL rules to make the created Internal LB rules (SSH & HTTP) accessible...\")\n         ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=internal_tier_1)\n         http_rule = self.create_NetworkAclRule(self.test_data[\"http_rule\"], network=internal_tier_1)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Creating Internal LB Rules in the Internal tier\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) using the same Load Balancing source IP Address...\")\n@@ -996,16 +998,16 @@ def test_05_nuage_internallb_traffic(self):\n         self.check_InternalLbVm_state(internal_tier_2, int_lb_rule_3.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_2)\n+        self.verify_vsd_lb_device(int_lb_vm_2)\n \n         # Deploying more VMs in the Internal tier\n         self.debug(\"Deploying two more VMs in network - %s\" % internal_tier_2.name)\n         internal_vm_2_1 = self.create_VM(internal_tier_2)\n         internal_vm_2_2 = self.create_VM(internal_tier_2)\n \n         # VSD verification\n-        self.verify_vsp_vm(internal_vm_2_1)\n-        self.verify_vsp_vm(internal_vm_2_2)\n+        self.verify_vsd_vm(internal_vm_2_1)\n+        self.verify_vsd_vm(internal_vm_2_2)\n \n         # Adding newly deployed VMs to the created Internal LB rules\n         self.debug(\"Adding two more virtual machines to the created Internal LB rules...\")\n@@ -1020,32 +1022,32 @@ def test_05_nuage_internallb_traffic(self):\n         self.check_InternalLbVm_state(internal_tier_2, int_lb_rule_3.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_2)\n+        self.verify_vsd_lb_device(int_lb_vm_2)\n \n         # Adding Network ACL rules in the Internal tier\n         self.debug(\"Adding Network ACL rules to make the created Internal LB rules (SSH & HTTP) accessible...\")\n         ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=internal_tier_2)\n         http_rule = self.create_NetworkAclRule(self.test_data[\"http_rule\"], network=internal_tier_2)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n-        # Creating Static NAT Rule for the VM in the Public tier\n+        # Creating Static NAT rule for the VM in the Public tier\n         public_ip = self.acquire_PublicIPAddress(public_tier, vpc)\n         self.validate_PublicIPAddress(public_ip, public_tier)\n         self.create_StaticNatRule_For_VM(public_vm, public_ip, public_tier)\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n \n         # Adding Network ACL rule in the Public tier\n         self.debug(\"Adding Network ACL rule to make the created NAT rule (SSH) accessible...\")\n         public_ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=public_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n \n         # Internal LB (wget) traffic tests\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1074,6 +1076,7 @@ def test_06_nuage_internallb_algorithms_traffic(self):\n         # 2. Least connections\n         # 3. Source\n         # Verify the above Internal LB algorithms by performing multiple (wget) traffic tests within a VPC.\n+        # Delete all the created objects (cleanup).\n \n         # Creating a VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering with Internal LB service...\")\n@@ -1102,29 +1105,29 @@ def test_06_nuage_internallb_algorithms_traffic(self):\n         vr = self.get_Router(internal_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm = self.create_VM(internal_tier)\n         self.check_VM_state(internal_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n \n         self.debug(\"Creating a VPC network without Internal LB service...\")\n         public_tier = self.create_Network(net_off_2, gateway='10.1.2.1', vpc=vpc)\n         self.validate_Network(public_tier, state=\"Implemented\")\n         vr = self.get_Router(public_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm = self.create_VM(public_tier)\n         self.check_VM_state(public_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n \n         # Creating Internal LB Rules in the Internal tier with Round Robin Algorithm\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) with Round Robin Algorithm...\")\n@@ -1142,16 +1145,16 @@ def test_06_nuage_internallb_algorithms_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_1)\n+        self.verify_vsd_lb_device(int_lb_vm_1)\n \n         # Deploying more VMs in the Internal tier\n         self.debug(\"Deploying two more VMs in network - %s\" % internal_tier.name)\n         internal_vm_1 = self.create_VM(internal_tier)\n         internal_vm_2 = self.create_VM(internal_tier)\n \n         # VSD verification\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         # Adding newly deployed VMs to the created Internal LB rules\n         self.debug(\"Adding two more virtual machines to the created Internal LB rules...\")\n@@ -1166,7 +1169,7 @@ def test_06_nuage_internallb_algorithms_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_1)\n+        self.verify_vsd_lb_device(int_lb_vm_1)\n \n         # Creating Internal LB Rules in the Internal tier with Least connections Algorithm\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) with Least connections Algorithm...\")\n@@ -1191,7 +1194,7 @@ def test_06_nuage_internallb_algorithms_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_3.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_2)\n+        self.verify_vsd_lb_device(int_lb_vm_2)\n \n         # Creating Internal LB Rules in the Internal tier with Source Algorithm\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) with Source Algorithm...\")\n@@ -1216,32 +1219,32 @@ def test_06_nuage_internallb_algorithms_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_5.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm_3)\n+        self.verify_vsd_lb_device(int_lb_vm_3)\n \n         # Adding Network ACL rules in the Internal tier\n         self.debug(\"Adding Network ACL rules to make the created Internal LB rules (SSH & HTTP) accessible...\")\n         ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=internal_tier)\n         http_rule = self.create_NetworkAclRule(self.test_data[\"http_rule\"], network=internal_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n-        # Creating Static NAT Rule for the VM in the Public tier\n+        # Creating Static NAT rule for the VM in the Public tier\n         public_ip = self.acquire_PublicIPAddress(public_tier, vpc)\n         self.validate_PublicIPAddress(public_ip, public_tier)\n         self.create_StaticNatRule_For_VM(public_vm, public_ip, public_tier)\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n \n         # Adding Network ACL rule in the Public tier\n         self.debug(\"Adding Network ACL rule to make the created NAT rule (SSH) accessible...\")\n         public_ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=public_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n \n         # Internal LB (wget) traffic tests with Round Robin Algorithm\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1289,9 +1292,12 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         #    tier.\n         # 6. Start all the VMs configured with InternalLbVm, verify that the InternalLbVm gets deployed again in the\n         #    Internal tier.\n-        # 7. Restart VPC, verify that the VPC VR gets rebooted and this restart has no effect on the InternalLbVm\n-        #    functionality.\n+        # 7. Restart VPC (cleanup = false), verify that the VPC VR gets rebooted and this restart has no effect on the\n+        #    InternalLbVm functionality.\n+        # 7. Restart VPC (cleanup = true), verify that the VPC VR gets rebooted and this restart has no effect on the\n+        #    InternalLbVm functionality.\n         # Verify the above restarts of VPC networks (tiers) by performing (wget) traffic tests within a VPC.\n+        # Delete all the created objects (cleanup).\n \n         # Creating a VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering with Internal LB service...\")\n@@ -1320,29 +1326,29 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         vr = self.get_Router(internal_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm = self.create_VM(internal_tier)\n         self.check_VM_state(internal_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n \n         self.debug(\"Creating a VPC network without Internal LB service...\")\n         public_tier = self.create_Network(net_off_2, gateway='10.1.2.1', vpc=vpc)\n         self.validate_Network(public_tier, state=\"Implemented\")\n         vr = self.get_Router(public_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm = self.create_VM(public_tier)\n         self.check_VM_state(public_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n \n         # Creating Internal LB Rules in the Internal tier\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) using the same Load Balancing source IP Address...\")\n@@ -1360,16 +1366,16 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Deploying more VMs in the Internal tier\n         self.debug(\"Deploying two more VMs in network - %s\" % internal_tier.name)\n         internal_vm_1 = self.create_VM(internal_tier)\n         internal_vm_2 = self.create_VM(internal_tier)\n \n         # VSD verification\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         # Adding newly deployed VMs to the created Internal LB rules\n         self.debug(\"Adding two more virtual machines to the created Internal LB rules...\")\n@@ -1384,32 +1390,32 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Adding Network ACL rules in the Internal tier\n         self.debug(\"Adding Network ACL rules to make the created Internal LB rules (SSH & HTTP) accessible...\")\n         ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=internal_tier)\n         http_rule = self.create_NetworkAclRule(self.test_data[\"http_rule\"], network=internal_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n-        # Creating Static NAT Rule for the VM in the Public tier\n+        # Creating Static NAT rule for the VM in the Public tier\n         public_ip = self.acquire_PublicIPAddress(public_tier, vpc)\n         self.validate_PublicIPAddress(public_ip, public_tier)\n         self.create_StaticNatRule_For_VM(public_vm, public_ip, public_tier)\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n \n         # Adding Network ACL rule in the Public tier\n         self.debug(\"Adding Network ACL rule to make the created NAT rule (SSH) accessible...\")\n         public_ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=public_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1432,35 +1438,33 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Validating InternalLbVm state\n         # InternalLbVm gets destroyed and deployed again in the Internal tier\n         int_lb_vm = self.get_InternalLbVm(internal_tier, int_lb_rule_1.sourceipaddress)\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n         tries = 0\n-        while True:\n+        while tries < 10:\n             try:\n                 wget_file = self.wget_from_vm_cmd(ssh_client,\n                                                   int_lb_rule_1.sourceipaddress,\n                                                   self.test_data[\"http_rule\"][\"publicport\"]\n                                                   )\n             except Exception as e:\n                 self.debug(\"Failed to wget file via the InternalLbVm after re-starting the Internal tier: %s\" % e)\n-                if tries == 10:\n-                    break\n                 self.debug(\"Waiting for the InternalLbVm in the Internal tier to be fully resolved for (wget) traffic \"\n                            \"test...\")\n                 time.sleep(30)\n@@ -1483,26 +1487,26 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Validating InternalLbVm state\n         # InternalLbVm gets destroyed and deployed again in the Internal tier\n         int_lb_vm = self.get_InternalLbVm(internal_tier, int_lb_rule_1.sourceipaddress)\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n         tries = 0\n-        while True:\n+        while tries < 10:\n             try:\n                 wget_file = self.wget_from_vm_cmd(ssh_client,\n                                                   int_lb_rule_1.sourceipaddress,\n@@ -1511,8 +1515,6 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n             except Exception as e:\n                 self.debug(\"Failed to wget file via the InternalLbVm after re-starting the Internal tier with cleanup: \"\n                            \"%s\" % e)\n-                if tries == 10:\n-                    break\n                 self.debug(\"Waiting for the InternalLbVm in the Internal tier to be fully resolved for (wget) traffic \"\n                            \"test...\")\n                 time.sleep(30)\n@@ -1534,17 +1536,17 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n \n         # Validating InternalLbVm state\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1566,17 +1568,17 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n \n         # Validating InternalLbVm state\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1601,19 +1603,19 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.check_VM_state(internal_vm_2, state=\"Stopped\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm, stopped=True)\n-        self.verify_vsp_vm(internal_vm_1, stopped=True)\n-        self.verify_vsp_vm(internal_vm_2, stopped=True)\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm, stopped=True)\n+        self.verify_vsd_vm(internal_vm_1, stopped=True)\n+        self.verify_vsd_vm(internal_vm_2, stopped=True)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Validating InternalLbVm state\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1637,24 +1639,24 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.check_VM_state(internal_vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Validating InternalLbVm state\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n         tries = 0\n-        while True:\n+        while tries < 10:\n             try:\n                 wget_file = self.wget_from_vm_cmd(ssh_client,\n                                                   int_lb_rule_1.sourceipaddress,\n@@ -1663,8 +1665,6 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n             except Exception as e:\n                 self.debug(\"Failed to wget file via the InternalLbVm after re-starting all the VMs in the Internal tier\"\n                            \": %s\" % e)\n-                if tries == 10:\n-                    break\n                 self.debug(\"Waiting for the InternalLbVm and all the VMs in the Internal tier to be fully resolved for \"\n                            \"(wget) traffic test...\")\n                 time.sleep(30)\n@@ -1693,23 +1693,23 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n-        self.verify_vsp_vm(internal_vm)\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n+        self.verify_vsd_vm(internal_vm)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Validating InternalLbVm state\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1737,23 +1737,23 @@ def test_07_nuage_internallb_vpc_network_restarts_traffic(self):\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n-        self.verify_vsp_vm(internal_vm)\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n+        self.verify_vsd_vm(internal_vm)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n         # Validating InternalLbVm state\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1781,6 +1781,7 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         # 6. Force stop the InternalLbVm when the VPC VR is in Running State\n         # 7. Start the InternalLbVm when the VPC VR is in Running state\n         # Verify the above restarts of VPC networks by performing (wget) traffic tests within a VPC.\n+        # Delete all the created objects (cleanup).\n \n         # Creating a VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering with Internal LB service...\")\n@@ -1809,29 +1810,29 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         vr = self.get_Router(internal_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % internal_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         internal_vm = self.create_VM(internal_tier)\n         self.check_VM_state(internal_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(internal_vm)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(internal_vm)\n \n         self.debug(\"Creating a VPC network without Internal LB service...\")\n         public_tier = self.create_Network(net_off_2, gateway='10.1.2.1', vpc=vpc)\n         self.validate_Network(public_tier, state=\"Implemented\")\n         vr = self.get_Router(public_tier)\n         self.check_Router_state(vr, state=\"Running\")\n \n-        self.debug(\"Deploying a VM in network - %s\" % public_tier.name)\n+        self.debug(\"Deploying a VM in the created VPC network...\")\n         public_vm = self.create_VM(public_tier)\n         self.check_VM_state(public_vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(public_vm)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(public_vm)\n \n         # Stopping the VPC VR\n         # VPC VR has no effect on the InternalLbVm functionality\n@@ -1841,9 +1842,9 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.validate_Network(internal_tier, state=\"Implemented\")\n \n         # VSD verification\n-        self.verify_vsp_router(vr, stopped=True)\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr, stopped=True)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n \n         # Creating Internal LB Rules in the Internal tier\n         self.debug(\"Creating two Internal LB Rules (SSH & HTTP) using the same Load Balancing source IP Address...\")\n@@ -1861,16 +1862,16 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Deploying more VMs in the Internal tier\n         self.debug(\"Deploying two more VMs in network - %s\" % internal_tier.name)\n         internal_vm_1 = self.create_VM(internal_tier)\n         internal_vm_2 = self.create_VM(internal_tier)\n \n         # VSD verification\n-        self.verify_vsp_vm(internal_vm_1)\n-        self.verify_vsp_vm(internal_vm_2)\n+        self.verify_vsd_vm(internal_vm_1)\n+        self.verify_vsd_vm(internal_vm_2)\n \n         # Adding newly deployed VMs to the created Internal LB rules\n         self.debug(\"Adding two more virtual machines to the created Internal LB rules...\")\n@@ -1885,32 +1886,32 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Adding Network ACL rules in the Internal tier\n         self.debug(\"Adding Network ACL rules to make the created Internal LB rules (SSH & HTTP) accessible...\")\n         ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=internal_tier)\n         http_rule = self.create_NetworkAclRule(self.test_data[\"http_rule\"], network=internal_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(ssh_rule)\n-        self.verify_vsp_firewall_rule(http_rule)\n+        self.verify_vsd_firewall_rule(ssh_rule)\n+        self.verify_vsd_firewall_rule(http_rule)\n \n-        # Creating Static NAT Rule for the VM in the Public tier\n+        # Creating Static NAT rule for the VM in the Public tier\n         public_ip = self.acquire_PublicIPAddress(public_tier, vpc)\n         self.validate_PublicIPAddress(public_ip, public_tier)\n         self.create_StaticNatRule_For_VM(public_vm, public_ip, public_tier)\n         self.validate_PublicIPAddress(public_ip, public_tier, static_nat=True, vm=public_vm)\n \n         # VSD verification\n-        self.verify_vsp_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n+        self.verify_vsd_floating_ip(public_tier, public_vm, public_ip.ipaddress, vpc)\n \n         # Adding Network ACL rule in the Public tier\n         self.debug(\"Adding Network ACL rule to make the created NAT rule (SSH) accessible...\")\n         public_ssh_rule = self.create_NetworkAclRule(self.test_data[\"ingress_rule\"], network=public_tier)\n \n         # VSD verification\n-        self.verify_vsp_firewall_rule(public_ssh_rule)\n+        self.verify_vsd_firewall_rule(public_ssh_rule)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1927,7 +1928,7 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Stopped\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm, stopped=True)\n+        self.verify_vsd_lb_device(int_lb_vm, stopped=True)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -1943,12 +1944,12 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n         tries = 0\n-        while True:\n+        while tries < 10:\n             try:\n                 wget_file = self.wget_from_vm_cmd(ssh_client,\n                                                   int_lb_rule_1.sourceipaddress,\n@@ -1957,8 +1958,6 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n             except Exception as e:\n                 self.debug(\"Failed to wget file via the InternalLbVm after re-starting the InternalLbVm appliance: %s\"\n                            % e)\n-                if tries == 10:\n-                    break\n                 self.debug(\"Waiting for the InternalLbVm to be fully resolved for (wget) traffic test...\")\n                 time.sleep(30)\n                 tries += 1\n@@ -1977,16 +1976,16 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.validate_Network(internal_tier, state=\"Implemented\")\n \n         # VSD verification\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_network(self.domain.id, public_tier, vpc)\n-        self.verify_vsp_network(self.domain.id, internal_tier, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_network(self.domain.id, public_tier, vpc)\n+        self.verify_vsd_network(self.domain.id, internal_tier, vpc)\n \n         # # Stopping the InternalLbVm when the VPC VR is in Running state\n         self.stop_InternalLbVm(int_lb_vm)\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Stopped\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm, stopped=True)\n+        self.verify_vsd_lb_device(int_lb_vm, stopped=True)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -2002,12 +2001,12 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n         tries = 0\n-        while True:\n+        while tries < 10:\n             try:\n                 wget_file = self.wget_from_vm_cmd(ssh_client,\n                                                   int_lb_rule_1.sourceipaddress,\n@@ -2016,8 +2015,6 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n             except Exception as e:\n                 self.debug(\"Failed to wget file via the InternalLbVm after re-starting the InternalLbVm appliance: %s\"\n                            % e)\n-                if tries == 10:\n-                    break\n                 self.debug(\"Waiting for the InternalLbVm to be fully resolved for (wget) traffic test...\")\n                 time.sleep(30)\n                 tries += 1\n@@ -2033,7 +2030,7 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Stopped\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm, stopped=True)\n+        self.verify_vsd_lb_device(int_lb_vm, stopped=True)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n@@ -2049,12 +2046,12 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n         self.check_InternalLbVm_state(internal_tier, int_lb_rule_1.sourceipaddress, state=\"Running\")\n \n         # VSD Verification\n-        self.verify_vsp_LB_device(int_lb_vm)\n+        self.verify_vsd_lb_device(int_lb_vm)\n \n         # Internal LB (wget) traffic test\n         ssh_client = self.ssh_into_VM(public_vm, public_ip)\n         tries = 0\n-        while True:\n+        while tries < 10:\n             try:\n                 wget_file = self.wget_from_vm_cmd(ssh_client,\n                                                   int_lb_rule_1.sourceipaddress,\n@@ -2063,8 +2060,6 @@ def test_08_nuage_internallb_appliance_operations_traffic(self):\n             except Exception as e:\n                 self.debug(\"Failed to wget file via the InternalLbVm after re-starting the InternalLbVm appliance: %s\"\n                            % e)\n-                if tries == 10:\n-                    break\n                 self.debug(\"Waiting for the InternalLbVm to be fully resolved for (wget) traffic test...\")\n                 time.sleep(30)\n                 tries += 1",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_vpc_internal_lb.py",
                "sha": "081468975923b5f53698780383ee67b75cf384b3",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_vpc_network.py",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/plugins/nuagevsp/test_nuage_vpc_network.py?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 4,
                "filename": "test/integration/plugins/nuagevsp/test_nuage_vpc_network.py",
                "patch": "@@ -57,6 +57,7 @@ def test_nuage_vpc_network(self):\n         # 6. Deploy a VM in the created VPC network, check if the VM is successfully deployed and is in the \"Running\"\n         #    state.\n         # 7. Verify that the created ACL item is successfully implemented in Nuage VSP.\n+        # 8. Delete all the created objects (cleanup).\n \n         # Creating a VPC offering\n         self.debug(\"Creating Nuage VSP VPC offering...\")\n@@ -91,12 +92,12 @@ def test_nuage_vpc_network(self):\n         self.check_VM_state(vm, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, vpc_network, vpc)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(vm)\n+        self.verify_vsd_network(self.domain.id, vpc_network, vpc)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(vm)\n \n         # VSD verification for ACL item\n-        self.verify_vsp_firewall_rule(acl_item)\n+        self.verify_vsd_firewall_rule(acl_item)\n \n     @attr(tags=[\"advanced\", \"nuagevsp\", \"multizone\"], required_hardware=\"false\")\n     def test_nuage_vpc_network_multizone(self):",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_vpc_network.py",
                "sha": "7dec5a6a1992be216b4834a2d385558828ecdc13",
                "status": "modified"
            },
            {
                "additions": 94,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_vsp.py",
                "changes": 103,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/plugins/nuagevsp/test_nuage_vsp.py?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 9,
                "filename": "test/integration/plugins/nuagevsp/test_nuage_vsp.py",
                "patch": "@@ -19,9 +19,11 @@\n \"\"\"\n # Import Local Modules\n from nuageTestCase import nuageTestCase\n-from marvin.lib.base import Account\n+from marvin.lib.base import Account, Nuage\n+from marvin.cloudstackAPI import deleteNuageVspDevice\n # Import System Modules\n from nose.plugins.attrib import attr\n+import copy\n \n \n class TestNuageVsp(nuageTestCase):\n@@ -43,6 +45,91 @@ def setUp(self):\n         self.cleanup = [self.account]\n         return\n \n+    # validate_NuageVspDevice - Validates the addition of Nuage VSP device in the Nuage VSP Physical Network\n+    def validate_NuageVspDevice(self):\n+        \"\"\"Validates the addition of Nuage VSP device in the Nuage VSP Physical Network\"\"\"\n+        self.debug(\"Validating the addition of Nuage VSP device in the Nuage VSP Physical Network - %s\" %\n+                   self.vsp_physical_network.id)\n+        nuage_vsp_device = Nuage.list(self.api_client,\n+                                      physicalnetworkid=self.vsp_physical_network.id\n+                                      )\n+        self.assertEqual(isinstance(nuage_vsp_device, list), True,\n+                         \"List Nuage VSP device should return a valid list\"\n+                         )\n+        self.debug(\"Successfully validated the addition of Nuage VSP device in the Nuage VSP Physical Network - %s\" %\n+                   self.vsp_physical_network.id)\n+\n+    # delete_NuageVspDevice - Deletes the Nuage VSP device in the Nuage VSP Physical Network\n+    def delete_NuageVspDevice(self):\n+        \"\"\"Deletes the Nuage VSP device in the Nuage VSP Physical Network\"\"\"\n+        self.debug(\"Deleting the Nuage VSP device in the Nuage VSP Physical Network - %s\" %\n+                   self.vsp_physical_network.id)\n+        nuage_vsp_device = Nuage.list(self.api_client,\n+                                      physicalnetworkid=self.vsp_physical_network.id\n+                                      )[0]\n+        cmd = deleteNuageVspDevice.deleteNuageVspDeviceCmd()\n+        cmd.vspdeviceid = nuage_vsp_device.vspdeviceid\n+        self.api_client.deleteNuageVspDevice(cmd)\n+        self.debug(\"Successfully deleted the Nuage VSP device in the Nuage VSP Physical Network - %s\" %\n+                   self.vsp_physical_network.id)\n+\n+    @attr(tags=[\"advanced\", \"nuagevsp\"], required_hardware=\"false\")\n+    def test_nuage_vsp_device(self):\n+        \"\"\" Test Nuage VSP device in the Nuage VSP Physical Network\n+        \"\"\"\n+\n+        # 1. Verify that the Nuage VSP network service provider is successfully created and enabled in the Nuage VSP\n+        #    Physical Network.\n+        # 2. Verify that the Nuage VSP device is successfully created in the Nuage VSP Physical Network.\n+        # 3. Delete the Nuage VSP device in the Nuage VSP Physical Network, verify that the Nuage VSP device is\n+        #    successfully deleted in the Nuage VSP Physical Network.\n+        # 4. Add the Nuage VSP device in the Nuage VSP Physical Network with invalid VSD credentials, verify that the\n+        #    Nuage VSP device failed to add in the Nuage VSP Physical Network.\n+        # 5. Add the Nuage VSP device in the Nuage VSP Physical Network with valid VSD credentials, verify that the\n+        #    Nuage VSP device is successfully added in the Nuage VSP Physical Network.\n+\n+        # Nuage VSP network service provider validation\n+        self.debug(\"Validating the Nuage VSP network service provider in the Nuage VSP Physical Network...\")\n+        self.validate_NetworkServiceProvider(\"NuageVsp\", state=\"Enabled\")\n+\n+        # Nuage VSP device validation\n+        self.debug(\"Validating the Nuage VSP device in the Nuage VSP Physical Network...\")\n+        self.validate_NuageVspDevice()\n+\n+        # Nuage VSP device deletion\n+        self.debug(\"Deleting the Nuage VSP device in the Nuage VSP Physical Network...\")\n+        self.delete_NuageVspDevice()\n+\n+        # Nuage VSP device validation\n+        self.debug(\"Validating the Nuage VSP device in the Nuage VSP Physical Network...\")\n+        with self.assertRaises(Exception):\n+            self.validate_NuageVspDevice()\n+        self.debug(\"Successfully deleted the Nuage VSP device in the Nuage VSP Physical Network\")\n+\n+        # Adding the Nuage VSP device with invalid VSD credentials\n+        self.debug(\"Adding the Nuage VSP device in the Nuage VSP Physical Network with invalid VSD credentials...\")\n+        vsd_info = self.nuage_vsp_device.__dict__\n+        invalid_vsd_info = copy.deepcopy(vsd_info)\n+        invalid_vsd_info[\"password\"] = \"\"\n+        with self.assertRaises(Exception):\n+            Nuage.add(self.api_client, invalid_vsd_info, self.vsp_physical_network.id)\n+        self.debug(\"Failed to add the Nuage VSP device in the Nuage VSP Physical Network due to invalid VSD \"\n+                   \"credentials\")\n+\n+        # Nuage VSP device validation\n+        self.debug(\"Validating the Nuage VSP device in the Nuage VSP Physical Network...\")\n+        with self.assertRaises(Exception):\n+            self.validate_NuageVspDevice()\n+        self.debug(\"The Nuage VSP device is not added in the Nuage VSP Physical Network\")\n+\n+        # Adding the Nuage VSP device with valid VSD credentials\n+        self.debug(\"Adding the Nuage VSP device in the Nuage VSP Physical Network with valid VSD credentials...\")\n+        Nuage.add(self.api_client, vsd_info, self.vsp_physical_network.id)\n+\n+        # Nuage VSP device validation\n+        self.debug(\"Validating the Nuage VSP device in the Nuage VSP Physical Network...\")\n+        self.validate_NuageVspDevice()\n+\n     @attr(tags=[\"advanced\", \"nuagevsp\"], required_hardware=\"false\")\n     def test_nuage_vsp(self):\n         \"\"\" Test Nuage VSP SDN plugin with basic Isolated Network functionality\n@@ -58,9 +145,7 @@ def test_nuage_vsp(self):\n         #    \"Running\" state.\n         # 6. Delete the created Isolated Network after destroying its VMs, check if the Isolated network is successfully\n         #    deleted.\n-\n-        self.debug(\"Validating the Nuage VSP network service provider...\")\n-        self.validate_NetworkServiceProvider(\"NuageVsp\", state=\"Enabled\")\n+        # 7. Delete all the created objects (cleanup).\n \n         # Creating a network offering\n         self.debug(\"Creating and enabling Nuage VSP Isolated Network offering...\")\n@@ -81,16 +166,16 @@ def test_nuage_vsp(self):\n         self.check_VM_state(vm_1, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_network(self.domain.id, network)\n-        self.verify_vsp_router(vr)\n-        self.verify_vsp_vm(vm_1)\n+        self.verify_vsd_network(self.domain.id, network)\n+        self.verify_vsd_router(vr)\n+        self.verify_vsd_vm(vm_1)\n \n         # Deploying one more VM in the network\n         vm_2 = self.create_VM(network)\n         self.check_VM_state(vm_2, state=\"Running\")\n \n         # VSD verification\n-        self.verify_vsp_vm(vm_2)\n+        self.verify_vsd_vm(vm_2)\n \n         # Deleting the network\n         self.debug(\"Deleting the Isolated Network with Nuage VSP Isolated Network offering...\")\n@@ -103,5 +188,5 @@ def test_nuage_vsp(self):\n \n         # VSD verification\n         with self.assertRaises(Exception):\n-            self.verify_vsp_network(self.domain.id, network)\n+            self.verify_vsd_network(self.domain.id, network)\n         self.debug(\"Isolated Network successfully deleted in VSD\")",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/test/integration/plugins/nuagevsp/test_nuage_vsp.py",
                "sha": "d71d0c1b4abbf214658b650a5ea0ef011f55a1f4",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/22c6b474732e643feb9411c0ca9e33109777e895/ui/scripts/system.js",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/system.js?ref=22c6b474732e643feb9411c0ca9e33109777e895",
                "deletions": 2,
                "filename": "ui/scripts/system.js",
                "patch": "@@ -13256,7 +13256,7 @@\n                             dataType: \"json\",\n                             async: false,\n                             success: function(json) {\n-                                var items = json.listnuagevspdeviceresponse.nuagevspdevice;\n+                                var items = json.listnuagevspdevicesresponse.nuagevspdevice;\n                                 args.response.success({\n                                     data: items\n                                 });\n@@ -13325,7 +13325,7 @@\n                                         dataType: \"json\",\n                                         async: true,\n                                         success: function(json) {\n-                                            var item = json.listnuagevspdeviceresponse.nuagevspdevice[0];\n+                                            var item = json.listnuagevspdevicesresponse.nuagevspdevice[0];\n                                             args.response.success({\n                                                 data: item\n                                             });",
                "raw_url": "https://github.com/apache/cloudstack/raw/22c6b474732e643feb9411c0ca9e33109777e895/ui/scripts/system.js",
                "sha": "2eef6b1908daa5f63d1e653ab06ce7d352809084",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1585 from nlivens/CLOUDSTACK-9399\n\nCLOUDSTACK-9399 : NPE during deletion of host when clusterId is nullIn most network plugins, there's a Resource class which will handle the communication with the actual device / underlaying client / ... They're configured as a host, so ACS is able to send commands towards it.\n\nWhen they're configured as a host, the clusterId is not filled in since it's not relevant. Hence, the NPE while deleting this host because of ```long clusterId = host.getClusterId();```\n\n* pr/1585:\n  Nuage VSP : Enhancing Marvin test coverage\n  CLOUDSTACK-9399 : Marvin test coverage for Nuage VSP device CRUD operations\n  CLOUDSTACK-9399 : NPE during deletion of host when clusterId is null\n\nSigned-off-by: Will Stevens <williamstevens@gmail.com>",
        "parent": "https://github.com/apache/cloudstack/commit/76d5350f71ddbb588ead27f5eda576c9a68a9648",
        "repo": "cloudstack",
        "unit_tests": [
            "ResourceManagerImplTest.java"
        ]
    },
    "cloudstack_22ee711": {
        "bug_id": "cloudstack_22ee711",
        "commit": "https://github.com/apache/cloudstack/commit/22ee7117f52ef639009711ce015ac7c5a64b8751",
        "file": [
            {
                "additions": 323,
                "blob_url": "https://github.com/apache/cloudstack/blob/22ee7117f52ef639009711ce015ac7c5a64b8751/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "changes": 636,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java?ref=22ee7117f52ef639009711ce015ac7c5a64b8751",
                "deletions": 313,
                "filename": "server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "patch": "@@ -146,11 +146,11 @@\n public class ConsoleProxyManagerImpl implements ConsoleProxyManager, ConsoleProxyService, Manager, AgentHook, VirtualMachineGuru<ConsoleProxyVO>, SystemVmLoadScanHandler<Long> {\n     private static final Logger s_logger = Logger.getLogger(ConsoleProxyManagerImpl.class);\n \n-    private static final int DEFAULT_CAPACITY_SCAN_INTERVAL = 30000;    \t\t// 30 seconds\n-    private static final int ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC = 180;        // 3 minutes\n+    private static final int DEFAULT_CAPACITY_SCAN_INTERVAL = 30000; // 30 seconds\n+    private static final int ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC = 180; // 3 minutes\n \n-    private static final int API_WAIT_TIMEOUT = 5000;   // 5 seconds (in milliseconds)\n-    private static final int STARTUP_DELAY = 60000;     // 60 seconds\n+    private static final int API_WAIT_TIMEOUT = 5000; // 5 seconds (in milliseconds)\n+    private static final int STARTUP_DELAY = 60000; // 60 seconds\n \n     private int _consoleProxyPort = ConsoleProxyManager.DEFAULT_PROXY_VNC_PORT;\n \n@@ -160,32 +160,48 @@\n     private String _name;\n     private Adapters<ConsoleProxyAllocator> _consoleProxyAllocators;\n \n-    @Inject private ConsoleProxyDao _consoleProxyDao;\n-    @Inject private DataCenterDao _dcDao;\n-    @Inject private VMTemplateDao _templateDao;\n-    @Inject private HostPodDao _podDao;\n-    @Inject private HostDao _hostDao;\n-    @Inject private ConfigurationDao _configDao;\n-    @Inject private CertificateDao _certDao;\n-    @Inject private VMInstanceDao _instanceDao;\n-    @Inject private VMTemplateHostDao _vmTemplateHostDao;\n-    @Inject private AgentManager _agentMgr;\n-    @Inject private StorageManager _storageMgr;\n-    @Inject NetworkManager _networkMgr;\n-    @Inject AccountManager _accountMgr;\n-    @Inject ServiceOfferingDao _offeringDao;\n-    @Inject NetworkOfferingDao _networkOfferingDao;\n-    \n+    @Inject\n+    private ConsoleProxyDao _consoleProxyDao;\n+    @Inject\n+    private DataCenterDao _dcDao;\n+    @Inject\n+    private VMTemplateDao _templateDao;\n+    @Inject\n+    private HostPodDao _podDao;\n+    @Inject\n+    private HostDao _hostDao;\n+    @Inject\n+    private ConfigurationDao _configDao;\n+    @Inject\n+    private CertificateDao _certDao;\n+    @Inject\n+    private VMInstanceDao _instanceDao;\n+    @Inject\n+    private VMTemplateHostDao _vmTemplateHostDao;\n+    @Inject\n+    private AgentManager _agentMgr;\n+    @Inject\n+    private StorageManager _storageMgr;\n+    @Inject\n+    NetworkManager _networkMgr;\n+    @Inject\n+    AccountManager _accountMgr;\n+    @Inject\n+    ServiceOfferingDao _offeringDao;\n+    @Inject\n+    NetworkOfferingDao _networkOfferingDao;\n+\n     private ConsoleProxyListener _listener;\n \n     private ServiceOfferingVO _serviceOffering;\n-    \n+\n     NetworkOfferingVO _publicNetworkOffering;\n     NetworkOfferingVO _managementNetworkOffering;\n     NetworkOfferingVO _linkLocalNetworkOffering;\n \n-    @Inject private VirtualMachineManager _itMgr;\n-    \n+    @Inject\n+    private VirtualMachineManager _itMgr;\n+\n     private final ExecutorService _requestHandlerScheduler = Executors.newCachedThreadPool(new NamedThreadFactory(\"Request-handler\"));\n \n     private long _capacityScanInterval = DEFAULT_CAPACITY_SCAN_INTERVAL;\n@@ -198,16 +214,16 @@\n     private boolean _use_storage_vm;\n     private boolean _disable_rp_filter = false;\n     private String _instance;\n-    \n+\n     private int _proxySessionTimeoutValue = DEFAULT_PROXY_SESSION_TIMEOUT;\n     private boolean _sslEnabled = false;\n \n     // global load picture at zone basis\n     private SystemVmLoadScanner<Long> _loadScanner;\n-    private Map<Long, ZoneHostInfo> _zoneHostInfoMap;\t\t\t\t\t// map <zone id, info about running host in zone>\n-    private Map<Long, ConsoleProxyLoadInfo> _zoneProxyCountMap; \t\t// map <zone id, info about proxy VMs count in zone> \n-    private Map<Long, ConsoleProxyLoadInfo> _zoneVmCountMap; \t\t\t// map <zone id, info about running VMs count in zone>\n-    \n+    private Map<Long, ZoneHostInfo> _zoneHostInfoMap; // map <zone id, info about running host in zone>\n+    private Map<Long, ConsoleProxyLoadInfo> _zoneProxyCountMap; // map <zone id, info about proxy VMs count in zone>\n+    private Map<Long, ConsoleProxyLoadInfo> _zoneVmCountMap; // map <zone id, info about running VMs count in zone>\n+\n     private final GlobalLock _allocProxyLock = GlobalLock.getInternLock(getAllocProxyLockName());\n \n     @Override\n@@ -241,17 +257,17 @@ public void run() {\n                 s_logger.info(\"Waiting for console proxy assignment is interrupted\");\n             }\n         }\n-        \n+\n         ConsoleProxyVO proxy = result.second();\n         if (proxy == null) {\n             return null;\n         }\n-        \n-        if(proxy.getPublicIpAddress() == null) {\n-        \ts_logger.warn(\"Assigned console proxy does not have a valid public IP address\");\n-        \treturn null;\n+\n+        if (proxy.getPublicIpAddress() == null) {\n+            s_logger.warn(\"Assigned console proxy does not have a valid public IP address\");\n+            return null;\n         }\n-        \n+\n         return new ConsoleProxyInfo(proxy.isSslEnabled(), proxy.getPublicIpAddress(), _consoleProxyPort, proxy.getPort(), _configDao.getValue(\"consoleproxy.url.domain\"));\n     }\n \n@@ -271,8 +287,7 @@ public ConsoleProxyVO doAssignProxy(long dataCenterId, long vmId) {\n                 _allocProxyLock.unlock();\n             }\n         } else {\n-            s_logger.error(\"Unable to acquire synchronization lock to get/allocate proxy resource for vm :\" + vmId\n-                    + \". Previous console proxy allocation is taking too long\");\n+            s_logger.error(\"Unable to acquire synchronization lock to get/allocate proxy resource for vm :\" + vmId + \". Previous console proxy allocation is taking too long\");\n         }\n \n         if (proxy == null) {\n@@ -302,7 +317,7 @@ public ConsoleProxyVO doAssignProxy(long dataCenterId, long vmId) {\n             } else {\n                 proxy.setPort(80);\n             }\n-            \n+\n             return proxy;\n         }\n     }\n@@ -431,7 +446,7 @@ private boolean hasPreviousSession(ConsoleProxyVO proxy, VMInstanceVO vm) {\n             return false;\n         }\n     }\n-    \n+\n     @Override\n     public ConsoleProxyVO startProxy(long proxyVmId) {\n         try {\n@@ -441,18 +456,19 @@ public ConsoleProxyVO startProxy(long proxyVmId) {\n             if (proxy.getState() == VirtualMachine.State.Running) {\n                 return proxy;\n             }\n-            \n+\n             String restart = _configDao.getValue(Config.ConsoleProxyRestart.key());\n-            if(restart != null && restart.equalsIgnoreCase(\"false\")) {\n+            if (restart != null && restart.equalsIgnoreCase(\"false\")) {\n                 return null;\n             }\n-            \n-            if(proxy.getState() == VirtualMachine.State.Stopped) {\n+\n+            if (proxy.getState() == VirtualMachine.State.Stopped) {\n                 return _itMgr.start(proxy, null, systemUser, systemAcct);\n             }\n-        \n+\n             // For VMs that are in Stopping, Starting, Migrating state, let client to wait by returning null\n-            // as sooner or later, Starting/Migrating state will be transited to Running and Stopping will be transited to Stopped to allow\n+            // as sooner or later, Starting/Migrating state will be transited to Running and Stopping will be transited to\n+            // Stopped to allow\n             // Starting of it\n             return null;\n         } catch (StorageUnavailableException e) {\n@@ -464,7 +480,7 @@ public ConsoleProxyVO startProxy(long proxyVmId) {\n         } catch (ResourceUnavailableException e) {\n             s_logger.warn(\"Exception while trying to start console proxy\", e);\n             return null;\n-        } catch(CloudRuntimeException e) {\n+        } catch (CloudRuntimeException e) {\n             s_logger.warn(\"Runtime Exception while trying to start console proxy\", e);\n             return null;\n         }\n@@ -508,8 +524,9 @@ public ConsoleProxyVO assignProxyFromRunningPool(long dataCenterId) {\n     }\n \n     public ConsoleProxyVO assignProxyFromStoppedPool(long dataCenterId) {\n-        \n-        // practically treat all console proxy VM that is not in Running state but can be entering into Running state as candidates\n+\n+        // practically treat all console proxy VM that is not in Running state but can be entering into Running state as\n+        // candidates\n         // this is to prevent launching unneccessary console proxy VMs because of temporarily unavailable state\n         List<ConsoleProxyVO> l = _consoleProxyDao.getProxyListInStates(dataCenterId, State.Starting, State.Stopped, State.Migrating, State.Stopping);\n         if (l != null && l.size() > 0) {\n@@ -524,13 +541,13 @@ public ConsoleProxyVO startNew(long dataCenterId) throws ConcurrentOperationExce\n         if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Assign console proxy from a newly started instance for request from data center : \" + dataCenterId);\n         }\n-        \n-        if(!allowToLaunchNew(dataCenterId)) {\n+\n+        if (!allowToLaunchNew(dataCenterId)) {\n             s_logger.warn(\"The number of launched console proxy on zone \" + dataCenterId + \" has reached to limit\");\n             return null;\n         }\n         HypervisorType currentHyp = currentHypervisorType(dataCenterId);\n-        \n+\n         Map<String, Object> context = createProxyInstance(dataCenterId, currentHyp);\n \n         long proxyVmId = (Long) context.get(\"proxyVmId\");\n@@ -541,7 +558,7 @@ public ConsoleProxyVO startNew(long dataCenterId) throws ConcurrentOperationExce\n             return null;\n         }\n \n-        ConsoleProxyVO proxy = _consoleProxyDao.findById(proxyVmId); \n+        ConsoleProxyVO proxy = _consoleProxyDao.findById(proxyVmId);\n         if (proxy != null) {\n             SubscriptionMgr.getInstance().notifySubscribers(ConsoleProxyManager.ALERT_SUBJECT, this,\n                     new ConsoleProxyAlertEventArgs(ConsoleProxyAlertEventArgs.PROXY_CREATED, dataCenterId, proxy.getId(), proxy, null));\n@@ -551,11 +568,8 @@ public ConsoleProxyVO startNew(long dataCenterId) throws ConcurrentOperationExce\n                 s_logger.debug(\"Unable to allocate console proxy storage, remove the console proxy record from DB, proxy id: \" + proxyVmId);\n             }\n \n-            SubscriptionMgr.getInstance().notifySubscribers(\n-                    ConsoleProxyManager.ALERT_SUBJECT,\n-                    this,\n-                    new ConsoleProxyAlertEventArgs(ConsoleProxyAlertEventArgs.PROXY_CREATE_FAILURE, dataCenterId, proxyVmId, null,\n-                            \"Unable to allocate storage\"));\n+            SubscriptionMgr.getInstance().notifySubscribers(ConsoleProxyManager.ALERT_SUBJECT, this,\n+                    new ConsoleProxyAlertEventArgs(ConsoleProxyAlertEventArgs.PROXY_CREATE_FAILURE, dataCenterId, proxyVmId, null, \"Unable to allocate storage\"));\n         }\n         return null;\n     }\n@@ -566,14 +580,14 @@ public ConsoleProxyVO startNew(long dataCenterId) throws ConcurrentOperationExce\n         String name = VirtualMachineName.getConsoleProxyName(id, _instance);\n         DataCenterVO dc = _dcDao.findById(dataCenterId);\n         Account systemAcct = _accountMgr.getSystemAccount();\n-        \n+\n         DataCenterDeployment plan = new DataCenterDeployment(dataCenterId);\n         List<NetworkOfferingVO> defaultOffering = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemPublicNetwork);\n \n         if (dc.getNetworkType() == NetworkType.Basic || dc.isSecurityGroupEnabled()) {\n             defaultOffering = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemGuestNetwork);\n         }\n-        \n+\n         List<NetworkOfferingVO> offerings = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemControlNetwork, NetworkOfferingVO.SystemManagementNetwork);\n         List<Pair<NetworkVO, NicProfile>> networks = new ArrayList<Pair<NetworkVO, NicProfile>>(offerings.size() + 1);\n         NicProfile defaultNic = new NicProfile();\n@@ -583,21 +597,22 @@ public ConsoleProxyVO startNew(long dataCenterId) throws ConcurrentOperationExce\n         for (NetworkOfferingVO offering : offerings) {\n             networks.add(new Pair<NetworkVO, NicProfile>(_networkMgr.setupNetwork(systemAcct, offering, plan, null, null, false, false).get(0), null));\n         }\n-        \n+\n         VMTemplateVO template = _templateDao.findSystemVMTemplate(dataCenterId, desiredHyp);\n         if (template == null) {\n             s_logger.debug(\"Can't find a template to start\");\n             throw new CloudRuntimeException(\"Insufficient capacity exception\");\n         }\n-        \n-        ConsoleProxyVO proxy = new ConsoleProxyVO(id, _serviceOffering.getId(), name, template.getId(), template.getHypervisorType(), template.getGuestOSId(), dataCenterId, systemAcct.getDomainId(), systemAcct.getId(), 0);\n+\n+        ConsoleProxyVO proxy = new ConsoleProxyVO(id, _serviceOffering.getId(), name, template.getId(), template.getHypervisorType(), template.getGuestOSId(), dataCenterId, systemAcct.getDomainId(),\n+                systemAcct.getId(), 0);\n         try {\n             proxy = _itMgr.allocate(proxy, template, _serviceOffering, networks, plan, null, systemAcct);\n         } catch (InsufficientCapacityException e) {\n             s_logger.warn(\"InsufficientCapacity\", e);\n             throw new CloudRuntimeException(\"Insufficient capacity exception\", e);\n         }\n-        \n+\n         Map<String, Object> context = new HashMap<String, Object>();\n         context.put(\"dc\", dc);\n         HostPodVO pod = _podDao.findById(proxy.getPodId());\n@@ -606,7 +621,7 @@ public ConsoleProxyVO startNew(long dataCenterId) throws ConcurrentOperationExce\n \n         return context;\n     }\n-    \n+\n     private ConsoleProxyAllocator getCurrentAllocator() {\n         // for now, only one adapter is supported\n         Enumeration<ConsoleProxyAllocator> it = _consoleProxyAllocators.enumeration();\n@@ -692,37 +707,37 @@ public void onLoadReport(ConsoleProxyLoadReportCommand cmd) {\n     @Override\n     public AgentControlAnswer onConsoleAccessAuthentication(ConsoleAccessAuthenticationCommand cmd) {\n         long vmId = 0;\n-        \n-\t\tString ticketInUrl = cmd.getTicket();\n-\t\tif(ticketInUrl == null) {\n-\t\t\ts_logger.error(\"Access ticket could not be found, you could be running an old version of console proxy. vmId: \" + cmd.getVmId());\n-\t\t\treturn new ConsoleAccessAuthenticationAnswer(cmd, false);\n-\t\t}\n-\t\t\n-\t\tif(s_logger.isDebugEnabled()) {\n+\n+        String ticketInUrl = cmd.getTicket();\n+        if (ticketInUrl == null) {\n+            s_logger.error(\"Access ticket could not be found, you could be running an old version of console proxy. vmId: \" + cmd.getVmId());\n+            return new ConsoleAccessAuthenticationAnswer(cmd, false);\n+        }\n+\n+        if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Console authentication. Ticket in url for \" + cmd.getHost() + \":\" + cmd.getPort() + \"-\" + cmd.getVmId() + \" is \" + ticketInUrl);\n         }\n \n         String ticket = ConsoleProxyServlet.genAccessTicket(cmd.getHost(), cmd.getPort(), cmd.getSid(), cmd.getVmId());\n-        if(s_logger.isDebugEnabled()) {\n+        if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Console authentication. Ticket in 1 minute boundary for \" + cmd.getHost() + \":\" + cmd.getPort() + \"-\" + cmd.getVmId() + \" is \" + ticket);\n         }\n-        \n-\t\tif(!ticket.equals(ticketInUrl)) {\n-\t\t\tDate now = new Date();\n-\t\t\t// considering of minute round-up\n-\t\t\tString minuteEarlyTicket = ConsoleProxyServlet.genAccessTicket(cmd.getHost(), cmd.getPort(), cmd.getSid(), cmd.getVmId(), \n-\t\t\t\tnew Date(now.getTime() - 60*1000));\n \n-\t\t\tif(s_logger.isDebugEnabled()) {\n+        if (!ticket.equals(ticketInUrl)) {\n+            Date now = new Date();\n+            // considering of minute round-up\n+            String minuteEarlyTicket = ConsoleProxyServlet.genAccessTicket(cmd.getHost(), cmd.getPort(), cmd.getSid(), cmd.getVmId(), new Date(now.getTime() - 60 * 1000));\n+\n+            if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Console authentication. Ticket in 2-minute boundary for \" + cmd.getHost() + \":\" + cmd.getPort() + \"-\" + cmd.getVmId() + \" is \" + minuteEarlyTicket);\n             }\n-\t\t\t\n-\t\t\tif(!minuteEarlyTicket.equals(ticketInUrl)) {\n-\t\t\t\ts_logger.error(\"Access ticket expired or has been modified. vmId: \" + cmd.getVmId() + \"ticket in URL: \" + ticketInUrl + \", tickets to check against: \" + ticket + \",\" + minuteEarlyTicket);\n-\t\t\t\treturn new ConsoleAccessAuthenticationAnswer(cmd, false);\n-\t\t\t}\n-\t\t}\n+\n+            if (!minuteEarlyTicket.equals(ticketInUrl)) {\n+                s_logger.error(\"Access ticket expired or has been modified. vmId: \" + cmd.getVmId() + \"ticket in URL: \" + ticketInUrl + \", tickets to check against: \" + ticket + \",\"\n+                        + minuteEarlyTicket);\n+                return new ConsoleAccessAuthenticationAnswer(cmd, false);\n+            }\n+        }\n \n         if (cmd.getVmId() != null && cmd.getVmId().isEmpty()) {\n             if (s_logger.isDebugEnabled()) {\n@@ -769,32 +784,32 @@ public AgentControlAnswer onConsoleAccessAuthentication(ConsoleAccessAuthenticat\n \n     @Override\n     public void onAgentConnect(HostVO host, StartupCommand cmd) {\n-//        if (host.getType() == Type.ConsoleProxy) {\n-//            // TODO we can use this event to mark the proxy is up and\n-//            // functioning instead of\n-//            // pinging the console proxy VM command port\n-//            //\n-//            // for now, just log a message\n-//            if (s_logger.isInfoEnabled()) {\n-//                s_logger.info(\"Console proxy agent is connected. proxy: \" + host.getName());\n-//            }\n-//\n-//            /* update public/private ip address */\n-//            if (_IpAllocator != null && _IpAllocator.exteralIpAddressAllocatorEnabled()) {\n-//                try {\n-//                    ConsoleProxyVO console = findConsoleProxyByHost(host);\n-//                    if (console == null) {\n-//                        s_logger.debug(\"Can't find console proxy \");\n-//                        return;\n-//                    }\n-//                    console.setPrivateIpAddress(cmd.getPrivateIpAddress());\n-//                    console.setPublicIpAddress(cmd.getPublicIpAddress());\n-//                    console.setPublicNetmask(cmd.getPublicNetmask());\n-//                    _consoleProxyDao.persist(console);\n-//                } catch (NumberFormatException e) {\n-//                }\n-//            }\n-//        }\n+        // if (host.getType() == Type.ConsoleProxy) {\n+        // // TODO we can use this event to mark the proxy is up and\n+        // // functioning instead of\n+        // // pinging the console proxy VM command port\n+        // //\n+        // // for now, just log a message\n+        // if (s_logger.isInfoEnabled()) {\n+        // s_logger.info(\"Console proxy agent is connected. proxy: \" + host.getName());\n+        // }\n+        //\n+        // /* update public/private ip address */\n+        // if (_IpAllocator != null && _IpAllocator.exteralIpAddressAllocatorEnabled()) {\n+        // try {\n+        // ConsoleProxyVO console = findConsoleProxyByHost(host);\n+        // if (console == null) {\n+        // s_logger.debug(\"Can't find console proxy \");\n+        // return;\n+        // }\n+        // console.setPrivateIpAddress(cmd.getPrivateIpAddress());\n+        // console.setPublicIpAddress(cmd.getPublicIpAddress());\n+        // console.setPublicNetmask(cmd.getPublicNetmask());\n+        // _consoleProxyDao.persist(console);\n+        // } catch (NumberFormatException e) {\n+        // }\n+        // }\n+        // }\n     }\n \n     @Override\n@@ -832,17 +847,13 @@ public void onAgentDisconnect(long agentId, com.cloud.host.Status state) {\n                         // continue on forever\n \n                         /*\n-                         * _capacityScanScheduler.execute(new Runnable() {\n-                         * public void run() { if(s_logger.isInfoEnabled())\n-                         * s_logger.info(\"Stop console proxy \" + proxy.getName()\n-                         * +\n-                         * \" VM because of that the agent running inside it has disconnected\"\n-                         * ); stopProxy(proxy.getId()); } });\n+                         * _capacityScanScheduler.execute(new Runnable() { public void run() { if(s_logger.isInfoEnabled())\n+                         * s_logger.info(\"Stop console proxy \" + proxy.getName() +\n+                         * \" VM because of that the agent running inside it has disconnected\" ); stopProxy(proxy.getId()); } });\n                          */\n                     } else {\n                         if (s_logger.isInfoEnabled()) {\n-                            s_logger.info(\"Console proxy agent disconnected but corresponding console proxy VM no longer exists in DB, proxy: \"\n-                                    + name);\n+                            s_logger.info(\"Console proxy agent disconnected but corresponding console proxy VM no longer exists in DB, proxy: \" + name);\n                         }\n                     }\n                 } else {\n@@ -851,32 +862,30 @@ public void onAgentDisconnect(long agentId, com.cloud.host.Status state) {\n             }\n         }\n     }\n-    \n+\n     private boolean reserveStandbyCapacity() {\n         String value = _configDao.getValue(Config.SystemVMAutoReserveCapacity.key());\n-        if(value != null && value.equalsIgnoreCase(\"true\")) {\n+        if (value != null && value.equalsIgnoreCase(\"true\")) {\n             return true;\n         }\n-        \n+\n         return false;\n     }\n-    \n+\n     private boolean allowToLaunchNew(long dcId) {\n-        List<ConsoleProxyVO> l = _consoleProxyDao.getProxyListInStates(dcId, VirtualMachine.State.Starting, \n-          VirtualMachine.State.Running, VirtualMachine.State.Stopping, VirtualMachine.State.Stopped,\n-          VirtualMachine.State.Migrating, VirtualMachine.State.Shutdowned, VirtualMachine.State.Unknown);\n-        \n+        List<ConsoleProxyVO> l = _consoleProxyDao.getProxyListInStates(dcId, VirtualMachine.State.Starting, VirtualMachine.State.Running, VirtualMachine.State.Stopping, VirtualMachine.State.Stopped,\n+                VirtualMachine.State.Migrating, VirtualMachine.State.Shutdowned, VirtualMachine.State.Unknown);\n+\n         String value = _configDao.getValue(Config.ConsoleProxyLaunchMax.key());\n         int launchLimit = NumbersUtil.parseInt(value, 10);\n         return l.size() < launchLimit;\n     }\n-    \n+\n     private HypervisorType currentHypervisorType(long dcId) {\n-        List<ConsoleProxyVO> l = _consoleProxyDao.getProxyListInStates(dcId, VirtualMachine.State.Starting, \n-          VirtualMachine.State.Running, VirtualMachine.State.Stopping, VirtualMachine.State.Stopped,\n-          VirtualMachine.State.Migrating, VirtualMachine.State.Shutdowned, VirtualMachine.State.Unknown);\n-        \n-        return l.size() > 0? l.get(0).getHypervisorType():HypervisorType.Any;\n+        List<ConsoleProxyVO> l = _consoleProxyDao.getProxyListInStates(dcId, VirtualMachine.State.Starting, VirtualMachine.State.Running, VirtualMachine.State.Stopping, VirtualMachine.State.Stopped,\n+                VirtualMachine.State.Migrating, VirtualMachine.State.Shutdowned, VirtualMachine.State.Unknown);\n+\n+        return l.size() > 0 ? l.get(0).getHypervisorType() : HypervisorType.Any;\n     }\n \n     private boolean checkCapacity(ConsoleProxyLoadInfo proxyCountInfo, ConsoleProxyLoadInfo vmCountInfo) {\n@@ -901,10 +910,10 @@ private void allocCapacity(long dataCenterId) {\n                     if (s_logger.isInfoEnabled()) {\n                         s_logger.info(\"No stopped console proxy is available, need to allocate a new console proxy\");\n                     }\n-        \n+\n                     try {\n                         proxy = startNew(dataCenterId);\n-                    }  catch (ConcurrentOperationException e) {\n+                    } catch (ConcurrentOperationException e) {\n                         s_logger.info(\"Concurrent Operation caught \" + e);\n                     }\n                 } else {\n@@ -916,7 +925,7 @@ private void allocCapacity(long dataCenterId) {\n                 _allocProxyLock.unlock();\n             }\n         } else {\n-            if(s_logger.isInfoEnabled()) {\n+            if (s_logger.isInfoEnabled()) {\n                 s_logger.info(\"Unable to acquire proxy allocation lock, skip for next time\");\n             }\n         }\n@@ -1007,7 +1016,7 @@ public boolean stop() {\n         if (s_logger.isInfoEnabled()) {\n             s_logger.info(\"Stop console proxy manager\");\n         }\n-        \n+\n         this._loadScanner.stop();\n         _allocProxyLock.releaseRef();\n         return true;\n@@ -1030,7 +1039,7 @@ public boolean stopProxy(long proxyVmId) {\n             }\n             return false;\n         }\n-        \n+\n         try {\n             return _itMgr.stop(proxy, _accountMgr.getSystemUser(), _accountMgr.getSystemAccount());\n         } catch (ResourceUnavailableException e) {\n@@ -1056,11 +1065,8 @@ public boolean rebootProxy(long proxyVmId) {\n                     s_logger.debug(\"Successfully reboot console proxy \" + proxy.getName());\n                 }\n \n-                SubscriptionMgr.getInstance().notifySubscribers(\n-                    ConsoleProxyManager.ALERT_SUBJECT,\n-                    this,\n-                    new ConsoleProxyAlertEventArgs(ConsoleProxyAlertEventArgs.PROXY_REBOOTED, proxy.getDataCenterId(), proxy.getId(),\n-                    proxy, null));\n+                SubscriptionMgr.getInstance().notifySubscribers(ConsoleProxyManager.ALERT_SUBJECT, this,\n+                        new ConsoleProxyAlertEventArgs(ConsoleProxyAlertEventArgs.PROXY_REBOOTED, proxy.getDataCenterId(), proxy.getId(), proxy, null));\n \n                 return true;\n             } else {\n@@ -1089,7 +1095,7 @@ public boolean destroyProxy(long vmId) {\n     private String getAllocProxyLockName() {\n         return \"consoleproxy.alloc\";\n     }\n-    \n+\n     @Override\n     public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n         if (s_logger.isInfoEnabled()) {\n@@ -1108,7 +1114,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n \n         _proxyRamSize = NumbersUtil.parseInt(configs.get(Config.ConsoleProxyRamSize.key()), DEFAULT_PROXY_VM_RAMSIZE);\n         _proxyCpuMHz = NumbersUtil.parseInt(configs.get(Config.ConsoleProxyCpuMHz.key()), DEFAULT_PROXY_VM_CPUMHZ);\n-        \n+\n         String value = configs.get(Config.ConsoleProxyCmdPort.key());\n         value = configs.get(\"consoleproxy.sslEnabled\");\n         if (value != null && value.equalsIgnoreCase(\"true\")) {\n@@ -1126,9 +1132,9 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         if (value != null) {\n             _consoleProxyPort = NumbersUtil.parseInt(value, ConsoleProxyManager.DEFAULT_PROXY_VNC_PORT);\n         }\n-        \n+\n         value = configs.get(Config.ConsoleProxyDisableRpFilter.key());\n-        if(value != null && value.equalsIgnoreCase(\"true\")) {\n+        if (value != null && value.equalsIgnoreCase(\"true\")) {\n             _disable_rp_filter = true;\n         }\n \n@@ -1141,7 +1147,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         if (value != null && value.equalsIgnoreCase(\"true\")) {\n             _use_storage_vm = true;\n         }\n-        \n+\n         if (s_logger.isInfoEnabled()) {\n             s_logger.info(\"Console proxy max session soft limit : \" + _capacityPerProxy);\n             s_logger.info(\"Console proxy standby capacity : \" + _standbyCapacity);\n@@ -1178,23 +1184,23 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n \n         _loadScanner = new SystemVmLoadScanner<Long>(this);\n         _loadScanner.initScan(STARTUP_DELAY, _capacityScanInterval);\n-        \n+\n         if (s_logger.isInfoEnabled()) {\n             s_logger.info(\"Console Proxy Manager is configured.\");\n         }\n         return true;\n     }\n \n     @Override\n-    public boolean destroyConsoleProxy(DestroyConsoleProxyCmd cmd) throws ServerApiException{\n+    public boolean destroyConsoleProxy(DestroyConsoleProxyCmd cmd) throws ServerApiException {\n         Long proxyId = cmd.getId();\n-        \n+\n         // verify parameters\n         ConsoleProxyVO proxy = _consoleProxyDao.findById(proxyId);\n         if (proxy == null) {\n             throw new InvalidParameterValueException(\"unable to find a console proxy with id \" + proxyId);\n         }\n-        \n+\n         return destroyProxy(proxyId);\n     }\n \n@@ -1203,7 +1209,7 @@ protected ConsoleProxyManagerImpl() {\n \n     @Override\n     public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<ConsoleProxyVO> profile, DeployDestination dest, ReservationContext context) {\n-    \tStringBuilder buf = profile.getBootArgsBuilder();\n+        StringBuilder buf = profile.getBootArgsBuilder();\n         buf.append(\" template=domP type=consoleproxy\");\n         buf.append(\" host=\").append(_mgmt_host);\n         buf.append(\" port=\").append(_mgmt_port);\n@@ -1215,118 +1221,122 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<ConsoleProxyV\n         buf.append(\" pod=\").append(dest.getPod().getId());\n         buf.append(\" guid=Proxy.\").append(profile.getId());\n         buf.append(\" proxy_vm=\").append(profile.getId());\n-        if(_disable_rp_filter) {\n+        if (_disable_rp_filter) {\n             buf.append(\" disable_rp_filter=true\");\n         }\n \n         boolean externalDhcp = false;\n         String externalDhcpStr = _configDao.getValue(\"direct.attach.network.externalIpAllocator.enabled\");\n-        if(externalDhcpStr != null && externalDhcpStr.equalsIgnoreCase(\"true\")) {\n+        if (externalDhcpStr != null && externalDhcpStr.equalsIgnoreCase(\"true\")) {\n             externalDhcp = true;\n         }\n-        \n+\n         for (NicProfile nic : profile.getNics()) {\n             int deviceId = nic.getDeviceId();\n-            if(nic.getIp4Address() == null) {\n-\t            buf.append(\" eth\").append(deviceId).append(\"ip=\").append(\"0.0.0.0\");\n-\t            buf.append(\" eth\").append(deviceId).append(\"mask=\").append(\"0.0.0.0\");\n+            if (nic.getIp4Address() == null) {\n+                buf.append(\" eth\").append(deviceId).append(\"ip=\").append(\"0.0.0.0\");\n+                buf.append(\" eth\").append(deviceId).append(\"mask=\").append(\"0.0.0.0\");\n             } else {\n-\t            buf.append(\" eth\").append(deviceId).append(\"ip=\").append(nic.getIp4Address());\n-\t            buf.append(\" eth\").append(deviceId).append(\"mask=\").append(nic.getNetmask());\n+                buf.append(\" eth\").append(deviceId).append(\"ip=\").append(nic.getIp4Address());\n+                buf.append(\" eth\").append(deviceId).append(\"mask=\").append(nic.getNetmask());\n             }\n-            \n+\n             if (nic.isDefaultNic()) {\n                 buf.append(\" gateway=\").append(nic.getGateway());\n                 buf.append(\" dns1=\").append(nic.getDns1());\n                 if (nic.getDns2() != null) {\n                     buf.append(\" dns2=\").append(nic.getDns2());\n                 }\n             }\n-            \n+\n             if (nic.getTrafficType() == TrafficType.Management) {\n-            \tString mgmt_cidr = _configDao.getValue(Config.ManagementNetwork.key());\n-            \tif (NetUtils.isValidCIDR(mgmt_cidr)) {\n-            \t    buf.append(\" mgmtcidr=\").append(mgmt_cidr);\n-            \t}\n+                String mgmt_cidr = _configDao.getValue(Config.ManagementNetwork.key());\n+                if (NetUtils.isValidCIDR(mgmt_cidr)) {\n+                    buf.append(\" mgmtcidr=\").append(mgmt_cidr);\n+                }\n                 buf.append(\" localgw=\").append(dest.getPod().getGateway());\n-            } \n+            }\n         }\n \n-\t\t/*External DHCP mode*/\n-\t\tif(externalDhcp) {\n+        /* External DHCP mode */\n+        if (externalDhcp) {\n             buf.append(\" bootproto=dhcp\");\n         }\n-        \n+\n         String bootArgs = buf.toString();\n         if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Boot Args for \" + profile + \": \" + bootArgs);\n         }\n-        \n+\n         return true;\n     }\n \n     @Override\n     public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<ConsoleProxyVO> profile, DeployDestination dest, ReservationContext context) {\n-    \t\n+\n         finalizeCommandsOnStart(cmds, profile);\n-        \n+\n         ConsoleProxyVO proxy = profile.getVirtualMachine();\n         DataCenter dc = dest.getDataCenter();\n         List<NicProfile> nics = profile.getNics();\n         for (NicProfile nic : nics) {\n-        \tif ((nic.getTrafficType() == TrafficType.Public && dc.getNetworkType() == NetworkType.Advanced) || (nic.getTrafficType() == TrafficType.Guest && (dc.getNetworkType() == NetworkType.Basic || dc.isSecurityGroupEnabled()))) {\n-        \t\tproxy.setPublicIpAddress(nic.getIp4Address());\n-        \t\tproxy.setPublicNetmask(nic.getNetmask());\n-        \t\tproxy.setPublicMacAddress(nic.getMacAddress());\n-        \t} else if (nic.getTrafficType() == TrafficType.Management) {\n-        \t\tproxy.setPrivateIpAddress(nic.getIp4Address());\n-        \t\tproxy.setPrivateMacAddress(nic.getMacAddress());\n-        \t}\n+            if ((nic.getTrafficType() == TrafficType.Public && dc.getNetworkType() == NetworkType.Advanced)\n+                    || (nic.getTrafficType() == TrafficType.Guest && (dc.getNetworkType() == NetworkType.Basic || dc.isSecurityGroupEnabled()))) {\n+                proxy.setPublicIpAddress(nic.getIp4Address());\n+                proxy.setPublicNetmask(nic.getNetmask());\n+                proxy.setPublicMacAddress(nic.getMacAddress());\n+            } else if (nic.getTrafficType() == TrafficType.Management) {\n+                proxy.setPrivateIpAddress(nic.getIp4Address());\n+                proxy.setPrivateMacAddress(nic.getMacAddress());\n+            }\n         }\n         _consoleProxyDao.update(proxy.getId(), proxy);\n         return true;\n     }\n-    \n+\n     @Override\n     public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<ConsoleProxyVO> profile) {\n-        \n+\n         NicProfile managementNic = null;\n         NicProfile controlNic = null;\n         for (NicProfile nic : profile.getNics()) {\n-           if (nic.getTrafficType() == TrafficType.Management) {\n-               managementNic = nic;\n-           } else if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n-               controlNic = nic;\n-           }\n+            if (nic.getTrafficType() == TrafficType.Management) {\n+                managementNic = nic;\n+            } else if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n+                controlNic = nic;\n+            }\n         }\n \n         if (controlNic == null) {\n-          assert (managementNic != null);\n-          controlNic = managementNic;\n+            if (managementNic == null) {\n+                s_logger.error(\"Management network doesn't exist for the console proxy vm \" + profile.getVirtualMachine());\n+                return false;\n+            }\n+            controlNic = managementNic;\n         }\n \n         CheckSshCommand check = new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20);\n         cmds.addCommand(\"checkSsh\", check);\n-        \n+\n         return true;\n     }\n-    \n+\n     @Override\n     public boolean finalizeStart(VirtualMachineProfile<ConsoleProxyVO> profile, long hostId, Commands cmds, ReservationContext context) {\n-        CheckSshAnswer answer = (CheckSshAnswer)cmds.getAnswer(\"checkSsh\");\n+        CheckSshAnswer answer = (CheckSshAnswer) cmds.getAnswer(\"checkSsh\");\n         if (answer == null || !answer.getResult()) {\n-            if(answer != null) {\n+            if (answer != null) {\n                 s_logger.warn(\"Unable to ssh to the VM: \" + answer.getDetails());\n             } else {\n                 s_logger.warn(\"Unable to ssh to the VM: null answer\");\n             }\n             return false;\n         }\n-        \n+\n         return true;\n     }\n-    \n-    @Override \n+\n+    @Override\n     public void finalizeExpunge(ConsoleProxyVO proxy) {\n         proxy.setPublicIpAddress(null);\n         proxy.setPublicMacAddress(null);\n@@ -1335,95 +1345,94 @@ public void finalizeExpunge(ConsoleProxyVO proxy) {\n         proxy.setPrivateIpAddress(null);\n         _consoleProxyDao.update(proxy.getId(), proxy);\n     }\n-    \n+\n     @Override\n-    public boolean applyCustomCertToNewProxy(StartupProxyCommand cmd){\n-        //this is the case for updating cust cert on each new starting proxy, if such cert exists\n-\t\t//get cert from db\n-\t\tCertificateVO cert = _certDao.listAll().get(0);\n-\t\t\n-\t\tif(cert.getUpdated().equalsIgnoreCase(\"Y\")){\n-\t\t\tString certStr = cert.getCertificate(); \n-\t\t\tlong proxyVmId = (cmd).getProxyVmId();\n-\t\t\tConsoleProxyVO consoleProxy = _consoleProxyDao.findById(proxyVmId);\n-\t\t\t//find corresponding host\n-\t\t\tif(consoleProxy!=null){\n-\t\t\t\tHostVO consoleProxyHost = _hostDao.findConsoleProxyHost(consoleProxy.getName(), Type.ConsoleProxy);\n-\t\t\t\t//now send a command to console proxy host\n-\t    \t\tUpdateCertificateCommand certCmd = new UpdateCertificateCommand(certStr, true);\n-\t    \t\ttry {\n-\t\t\t\t\t\tAnswer updateCertAns = _agentMgr.send(consoleProxyHost.getId(), certCmd);\n-\t\t\t\t\t\tif(updateCertAns.getResult() == true)\n-\t\t\t\t\t\t{\n-\t\t\t\t\t\t\t//we have the cert copied over on cpvm\n-\t\t\t\t\t\t\trebootProxy(consoleProxy.getId());\n-\t\t\t\t\t\t\t//when cp reboots, the context will be reinit with the new cert \n-\t\t\t\t\t\t\ts_logger.info(\"Successfully rebooted console proxy resource after custom certificate application for proxy:\"+cmd.getProxyVmId());\n-\t\t\t\t\t\t\treturn true;\n-\t\t\t\t\t\t}\n-\t\t\t\t} catch (AgentUnavailableException e) {\n-\t\t\t\t\ts_logger.warn(\"Unable to send update certificate command to the console proxy resource for proxy:\"+cmd.getProxyVmId(), e);\n-\t\t\t\t\treturn false;\n-\t\t\t\t} catch (OperationTimedoutException e) {\n-\t\t\t\t\ts_logger.warn(\"Unable to send update certificate command to the console proxy resource for proxy:\"+cmd.getProxyVmId(), e);\n-\t\t\t\t\treturn false;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t} else {\n-\t\t\treturn false;//no cert entry in the db record\n-\t\t}\n-\t\treturn false;//cert already applied in previous cycles\n+    public boolean applyCustomCertToNewProxy(StartupProxyCommand cmd) {\n+        // this is the case for updating cust cert on each new starting proxy, if such cert exists\n+        // get cert from db\n+        CertificateVO cert = _certDao.listAll().get(0);\n+\n+        if (cert.getUpdated().equalsIgnoreCase(\"Y\")) {\n+            String certStr = cert.getCertificate();\n+            long proxyVmId = (cmd).getProxyVmId();\n+            ConsoleProxyVO consoleProxy = _consoleProxyDao.findById(proxyVmId);\n+            // find corresponding host\n+            if (consoleProxy != null) {\n+                HostVO consoleProxyHost = _hostDao.findConsoleProxyHost(consoleProxy.getName(), Type.ConsoleProxy);\n+                // now send a command to console proxy host\n+                UpdateCertificateCommand certCmd = new UpdateCertificateCommand(certStr, true);\n+                try {\n+                    Answer updateCertAns = _agentMgr.send(consoleProxyHost.getId(), certCmd);\n+                    if (updateCertAns.getResult() == true) {\n+                        // we have the cert copied over on cpvm\n+                        rebootProxy(consoleProxy.getId());\n+                        // when cp reboots, the context will be reinit with the new cert\n+                        s_logger.info(\"Successfully rebooted console proxy resource after custom certificate application for proxy:\" + cmd.getProxyVmId());\n+                        return true;\n+                    }\n+                } catch (AgentUnavailableException e) {\n+                    s_logger.warn(\"Unable to send update certificate command to the console proxy resource for proxy:\" + cmd.getProxyVmId(), e);\n+                    return false;\n+                } catch (OperationTimedoutException e) {\n+                    s_logger.warn(\"Unable to send update certificate command to the console proxy resource for proxy:\" + cmd.getProxyVmId(), e);\n+                    return false;\n+                }\n+            }\n+        } else {\n+            return false;// no cert entry in the db record\n+        }\n+        return false;// cert already applied in previous cycles\n     }\n-    \n+\n     @Override\n     public ConsoleProxyVO persist(ConsoleProxyVO proxy) {\n         return _consoleProxyDao.persist(proxy);\n     }\n-    \n+\n     @Override\n     public ConsoleProxyVO findById(long id) {\n         return _consoleProxyDao.findById(id);\n     }\n-    \n+\n     @Override\n     public ConsoleProxyVO findByName(String name) {\n         if (!VirtualMachineName.isValidConsoleProxyName(name)) {\n             return null;\n         }\n         return findById(VirtualMachineName.getConsoleProxyId(name));\n     }\n-    \n+\n     @Override\n     public void finalizeStop(VirtualMachineProfile<ConsoleProxyVO> profile, StopAnswer answer) {\n     }\n \n     @Override\n-\tpublic String getScanHandlerName() {\n-\t\treturn \"consoleproxy\";\n-\t}\n-    \n+    public String getScanHandlerName() {\n+        return \"consoleproxy\";\n+    }\n+\n     @Override\n-\tpublic void onScanStart() {\n+    public void onScanStart() {\n         // to reduce possible number of DB queries for capacity scan, we run following aggregated queries in preparation stage\n         _zoneHostInfoMap = getZoneHostInfo();\n-        \n+\n         _zoneProxyCountMap = new HashMap<Long, ConsoleProxyLoadInfo>();\n         List<ConsoleProxyLoadInfo> listProxyCounts = _consoleProxyDao.getDatacenterProxyLoadMatrix();\n         for (ConsoleProxyLoadInfo info : listProxyCounts) {\n-        \t_zoneProxyCountMap.put(info.getId(), info);\n+            _zoneProxyCountMap.put(info.getId(), info);\n         }\n \n         _zoneVmCountMap = new HashMap<Long, ConsoleProxyLoadInfo>();\n         List<ConsoleProxyLoadInfo> listVmCounts = _consoleProxyDao.getDatacenterSessionLoadMatrix();\n         for (ConsoleProxyLoadInfo info : listVmCounts) {\n-        \t_zoneVmCountMap.put(info.getId(), info);\n+            _zoneVmCountMap.put(info.getId(), info);\n         }\n     }\n-    \n+\n     @Override\n-\tpublic boolean canScan() {\n-        if(!reserveStandbyCapacity()) {\n-            if(s_logger.isDebugEnabled()) {\n+    public boolean canScan() {\n+        if (!reserveStandbyCapacity()) {\n+            if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Reserving standby capacity is disable, skip capacity scan\");\n             }\n             return false;\n@@ -1435,71 +1444,72 @@ public boolean canScan() {\n             s_logger.debug(\"Capacity scan disabled purposefully, consoleproxy.restart = false. This happens when the primarystorage is in maintenance mode\");\n             return false;\n         }\n-        \n+\n+        return true;\n+    }\n+\n+    @Override\n+    public Long[] getScannablePools() {\n+        List<DataCenterVO> zones = _dcDao.listEnabledZones();\n+\n+        Long[] dcIdList = new Long[zones.size()];\n+        int i = 0;\n+        for (DataCenterVO dc : zones) {\n+            dcIdList[i++] = dc.getId();\n+        }\n+\n+        return dcIdList;\n+    }\n+\n+    @Override\n+    public boolean isPoolReadyForScan(Long pool) {\n+        // pool is at zone basis\n+        long dataCenterId = pool.longValue();\n+\n+        if (!isZoneReady(_zoneHostInfoMap, dataCenterId)) {\n+            if (s_logger.isDebugEnabled())\n+                s_logger.debug(\"Zone \" + dataCenterId + \" is not ready to launch console proxy yet\");\n+            return false;\n+        }\n+\n+        if (s_logger.isDebugEnabled())\n+            s_logger.debug(\"Zone \" + dataCenterId + \" is ready to launch console proxy\");\n         return true;\n-\t}\n+    }\n \n     @Override\n-\tpublic Long[] getScannablePools() {\n-\t\tList<DataCenterVO> zones = _dcDao.listEnabledZones();\n-\n-\t\tLong[] dcIdList = new Long[zones.size()];\n-\t\tint i = 0;\n-\t\tfor(DataCenterVO dc : zones) {\n-\t\t\tdcIdList[i++] = dc.getId();\n-\t\t}\n-\t\t\n-\t\treturn dcIdList;\n-\t}\n-\t\n-\tpublic boolean isPoolReadyForScan(Long pool) {\n-\t\t// pool is at zone basis\n-\t\tlong dataCenterId = pool.longValue();\n-\t\t\n-\t\tif(!isZoneReady(_zoneHostInfoMap, dataCenterId)) {\n-\t\t\tif(s_logger.isDebugEnabled())\n-\t\t\t\ts_logger.debug(\"Zone \" + dataCenterId + \" is not ready to launch console proxy yet\");\n-\t\t\treturn false;\n-\t\t}\n-\n-\t\tif(s_logger.isDebugEnabled())\n-\t\t\ts_logger.debug(\"Zone \" + dataCenterId + \" is ready to launch console proxy\");\n-\t\treturn true;\n-\t}\n-\t\n-\t@Override\n-\tpublic Pair<AfterScanAction, Object> scanPool(Long pool) {\n-\t\tlong dataCenterId = pool.longValue();\n-\t\t\n-\t\tConsoleProxyLoadInfo proxyInfo = this._zoneProxyCountMap.get(dataCenterId);\n-\t\tif(proxyInfo == null)\n-\t\t\treturn new Pair<AfterScanAction, Object>(AfterScanAction.nop, null);\n-\t\t\t\n+    public Pair<AfterScanAction, Object> scanPool(Long pool) {\n+        long dataCenterId = pool.longValue();\n+\n+        ConsoleProxyLoadInfo proxyInfo = this._zoneProxyCountMap.get(dataCenterId);\n+        if (proxyInfo == null)\n+            return new Pair<AfterScanAction, Object>(AfterScanAction.nop, null);\n+\n         ConsoleProxyLoadInfo vmInfo = this._zoneVmCountMap.get(dataCenterId);\n-        if(vmInfo == null)\n-        \tvmInfo = new ConsoleProxyLoadInfo();\n-        \n+        if (vmInfo == null)\n+            vmInfo = new ConsoleProxyLoadInfo();\n+\n         if (!checkCapacity(proxyInfo, vmInfo)) {\n-        \tif(s_logger.isDebugEnabled())\n-        \t\ts_logger.debug(\"Expand console proxy standby capacity for zone \" + proxyInfo.getName());\n-        \t\n-        \treturn new Pair<AfterScanAction, Object>(AfterScanAction.expand, null);\n-        }\n-        \n-\t\treturn new Pair<AfterScanAction, Object>(AfterScanAction.nop, null);\n-\t}\n-\t\n-\t@Override\n-\tpublic void expandPool(Long pool, Object actionArgs) {\n-\t\tlong dataCenterId = pool.longValue();\n-\t\tallocCapacity(dataCenterId);\n-\t}\n-\t\n-\t@Override\n-\tpublic void shrinkPool(Long pool, Object actionArgs) {\n-\t}\n-\n-\t@Override\n-\tpublic void onScanEnd() {\n-\t}\n+            if (s_logger.isDebugEnabled())\n+                s_logger.debug(\"Expand console proxy standby capacity for zone \" + proxyInfo.getName());\n+\n+            return new Pair<AfterScanAction, Object>(AfterScanAction.expand, null);\n+        }\n+\n+        return new Pair<AfterScanAction, Object>(AfterScanAction.nop, null);\n+    }\n+\n+    @Override\n+    public void expandPool(Long pool, Object actionArgs) {\n+        long dataCenterId = pool.longValue();\n+        allocCapacity(dataCenterId);\n+    }\n+\n+    @Override\n+    public void shrinkPool(Long pool, Object actionArgs) {\n+    }\n+\n+    @Override\n+    public void onScanEnd() {\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/22ee7117f52ef639009711ce015ac7c5a64b8751/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "sha": "5acf93097a1037f38b6d76d8b36d025aa24d300c",
                "status": "modified"
            },
            {
                "additions": 115,
                "blob_url": "https://github.com/apache/cloudstack/blob/22ee7117f52ef639009711ce015ac7c5a64b8751/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "changes": 244,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java?ref=22ee7117f52ef639009711ce015ac7c5a64b8751",
                "deletions": 129,
                "filename": "server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "patch": "@@ -185,8 +185,8 @@\n     private String _allowedInternalSites;\n \n     private SystemVmLoadScanner<Long> _loadScanner;\n-    private Map<Long, ZoneHostInfo> _zoneHostInfoMap;\t\t\t\t\t// map <zone id, info about running host in zone>\n-    \n+    private Map<Long, ZoneHostInfo> _zoneHostInfoMap; // map <zone id, info about running host in zone>\n+\n     private final GlobalLock _allocLock = GlobalLock.getInternLock(getAllocLockName());\n \n     @Override\n@@ -255,7 +255,7 @@ public boolean generateSetupCommand(Long zoneId) {\n             String privateCidr = NetUtils.ipAndNetMaskToCidr(privateNic.getIp4Address(), privateNic.getNetmask());\n             String publicCidr = NetUtils.ipAndNetMaskToCidr(secStorageVm.getPublicIpAddress(), secStorageVm.getPublicNetmask());\n             if (NetUtils.isNetworkAWithinNetworkB(privateCidr, publicCidr) || NetUtils.isNetworkAWithinNetworkB(publicCidr, privateCidr)) {\n-            \ts_logger.info(\"private and public interface overlaps, add a default route through private interface. privateCidr: \" + privateCidr + \", publicCidr: \" + publicCidr);\n+                s_logger.info(\"private and public interface overlaps, add a default route through private interface. privateCidr: \" + privateCidr + \", publicCidr: \" + publicCidr);\n                 allowedCidrs.add(\"0.0.0.0/0\");\n             }\n             setupCmd.setAllowedInternalSites(allowedCidrs.toArray(new String[allowedCidrs.size()]));\n@@ -278,9 +278,9 @@ public boolean generateSetupCommand(Long zoneId) {\n     }\n \n     @Override\n-\tpublic Pair<HostVO, SecondaryStorageVmVO> assignSecStorageVm(long zoneId, Command cmd) {\n-\t\treturn null;\n-\t}\n+    public Pair<HostVO, SecondaryStorageVmVO> assignSecStorageVm(long zoneId, Command cmd) {\n+        return null;\n+    }\n \n     private boolean generateFirewallConfigurationForZone(Long zoneId) {\n         List<SecondaryStorageVmVO> zoneSsvms = _secStorageVmDao.listByZoneId(SecondaryStorageVm.Role.templateProcessor, zoneId);\n@@ -354,15 +354,11 @@ public SecondaryStorageVmVO startNew(long dataCenterId, SecondaryStorageVm.Role\n             return secStorageVm;\n         } else {\n             if (s_logger.isDebugEnabled()) {\n-                s_logger.debug(\"Unable to allocate secondary storage vm storage, remove the secondary storage vm record from DB, secondary storage vm id: \"\n-                        + secStorageVmId);\n+                s_logger.debug(\"Unable to allocate secondary storage vm storage, remove the secondary storage vm record from DB, secondary storage vm id: \" + secStorageVmId);\n             }\n \n-            SubscriptionMgr.getInstance().notifySubscribers(\n-                    ALERT_SUBJECT,\n-                    this,\n-                    new SecStorageVmAlertEventArgs(SecStorageVmAlertEventArgs.SSVM_CREATE_FAILURE, dataCenterId, secStorageVmId, null,\n-                            \"Unable to allocate storage\"));\n+            SubscriptionMgr.getInstance().notifySubscribers(ALERT_SUBJECT, this,\n+                    new SecStorageVmAlertEventArgs(SecStorageVmAlertEventArgs.SSVM_CREATE_FAILURE, dataCenterId, secStorageVmId, null, \"Unable to allocate storage\"));\n         }\n         return null;\n     }\n@@ -383,37 +379,34 @@ public SecondaryStorageVmVO startNew(long dataCenterId, SecondaryStorageVm.Role\n         DataCenter dc = _dcDao.findById(plan.getDataCenterId());\n \n         List<NetworkOfferingVO> defaultOffering = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemPublicNetwork);\n-        \n+\n         if (dc.getNetworkType() == NetworkType.Basic || dc.isSecurityGroupEnabled()) {\n             defaultOffering = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemGuestNetwork);\n         }\n \n-        List<NetworkOfferingVO> offerings = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemControlNetwork,\n-                NetworkOfferingVO.SystemManagementNetwork);\n+        List<NetworkOfferingVO> offerings = _networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemControlNetwork, NetworkOfferingVO.SystemManagementNetwork);\n         List<Pair<NetworkVO, NicProfile>> networks = new ArrayList<Pair<NetworkVO, NicProfile>>(offerings.size() + 1);\n         NicProfile defaultNic = new NicProfile();\n         defaultNic.setDefaultNic(true);\n         defaultNic.setDeviceId(2);\n         try {\n-            networks.add(new Pair<NetworkVO, NicProfile>(_networkMgr.setupNetwork(systemAcct, defaultOffering.get(0), plan, null, null, false, false)\n-                    .get(0), defaultNic));\n+            networks.add(new Pair<NetworkVO, NicProfile>(_networkMgr.setupNetwork(systemAcct, defaultOffering.get(0), plan, null, null, false, false).get(0), defaultNic));\n             for (NetworkOfferingVO offering : offerings) {\n-                networks.add(new Pair<NetworkVO, NicProfile>(_networkMgr.setupNetwork(systemAcct, offering, plan, null, null, false, false).get(0),\n-                        null));\n+                networks.add(new Pair<NetworkVO, NicProfile>(_networkMgr.setupNetwork(systemAcct, offering, plan, null, null, false, false).get(0), null));\n             }\n         } catch (ConcurrentOperationException e) {\n             s_logger.info(\"Unable to setup due to concurrent operation. \" + e);\n             return new HashMap<String, Object>();\n         }\n-        \n+\n         VMTemplateVO template = _templateDao.findSystemVMTemplate(dataCenterId);\n         if (template == null) {\n             s_logger.debug(\"Can't find a template to start\");\n             throw new CloudRuntimeException(\"Insufficient capacity exception\");\n         }\n-        \n-        SecondaryStorageVmVO secStorageVm = new SecondaryStorageVmVO(id, _serviceOffering.getId(), name, template.getId(),\n-                template.getHypervisorType(), template.getGuestOSId(), dataCenterId, systemAcct.getDomainId(), systemAcct.getId(), role);\n+\n+        SecondaryStorageVmVO secStorageVm = new SecondaryStorageVmVO(id, _serviceOffering.getId(), name, template.getId(), template.getHypervisorType(), template.getGuestOSId(), dataCenterId,\n+                systemAcct.getDomainId(), systemAcct.getId(), role);\n         try {\n             secStorageVm = _itMgr.allocate(secStorageVm, template, _serviceOffering, networks, plan, null, systemAcct);\n         } catch (InsufficientCapacityException e) {\n@@ -521,8 +514,7 @@ private void allocCapacity(long dataCenterId, SecondaryStorageVm.Role role) {\n                     }\n                 } else {\n                     if (s_logger.isInfoEnabled()) {\n-                        s_logger.info(\"Unable to acquire synchronization lock to start secStorageVm for standby capacity, secStorageVm vm id : \"\n-                                + secStorageVm.getId());\n+                        s_logger.info(\"Unable to acquire synchronization lock to start secStorageVm for standby capacity, secStorageVm vm id : \" + secStorageVm.getId());\n                     }\n                     return;\n                 }\n@@ -532,8 +524,7 @@ private void allocCapacity(long dataCenterId, SecondaryStorageVm.Role role) {\n \n             if (secStorageVm == null) {\n                 if (s_logger.isInfoEnabled()) {\n-                    s_logger.info(\"Unable to start secondary storage vm for standby capacity, secStorageVm vm Id : \" + secStorageVmId\n-                            + \", will recycle it and start a new one\");\n+                    s_logger.info(\"Unable to start secondary storage vm for standby capacity, secStorageVm vm Id : \" + secStorageVmId + \", will recycle it and start a new one\");\n                 }\n \n                 if (secStorageVmFromStoppedPool) {\n@@ -554,8 +545,7 @@ public boolean isZoneReady(Map<Long, ZoneHostInfo> zoneHostInfoMap, long dataCen\n             HostVO secHost = _hostDao.findSecondaryStorageHost(dataCenterId);\n             if (secHost == null) {\n                 if (s_logger.isDebugEnabled()) {\n-                    s_logger.debug(\"No secondary storage available in zone \" + dataCenterId\n-                            + \", wait until it is ready to launch secondary storage vm\");\n+                    s_logger.debug(\"No secondary storage available in zone \" + dataCenterId + \", wait until it is ready to launch secondary storage vm\");\n                 }\n                 return false;\n             }\n@@ -616,7 +606,7 @@ public boolean start() {\n \n     @Override\n     public boolean stop() {\n-    \t_loadScanner.stop();\n+        _loadScanner.stop();\n         _allocLock.releaseRef();\n         return true;\n     }\n@@ -761,11 +751,8 @@ public boolean rebootSecStorageVm(long secStorageVmId) {\n                     s_logger.debug(\"Successfully reboot secondary storage vm \" + secStorageVm.getName());\n                 }\n \n-                SubscriptionMgr.getInstance().notifySubscribers(\n-                        ALERT_SUBJECT,\n-                        this,\n-                        new SecStorageVmAlertEventArgs(SecStorageVmAlertEventArgs.SSVM_REBOOTED, secStorageVm.getDataCenterId(),\n-                                secStorageVm.getId(), secStorageVm, null));\n+                SubscriptionMgr.getInstance().notifySubscribers(ALERT_SUBJECT, this,\n+                        new SecStorageVmAlertEventArgs(SecStorageVmAlertEventArgs.SSVM_REBOOTED, secStorageVm.getDataCenterId(), secStorageVm.getId(), secStorageVm, null));\n \n                 return true;\n             } else {\n@@ -825,8 +812,7 @@ public SecondaryStorageVmVO persist(SecondaryStorageVmVO vm) {\n     }\n \n     @Override\n-    public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStorageVmVO> profile, DeployDestination dest,\n-            ReservationContext context) {\n+    public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStorageVmVO> profile, DeployDestination dest, ReservationContext context) {\n \n         HostVO secHost = _hostDao.findSecondaryStorageHost(dest.getDataCenter().getId());\n         assert (secHost != null);\n@@ -840,25 +826,25 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n         buf.append(\" zone=\").append(dest.getDataCenter().getId());\n         buf.append(\" pod=\").append(dest.getPod().getId());\n \n-        if(profile.getVirtualMachine().getRole() == SecondaryStorageVm.Role.templateProcessor)\n-        \tbuf.append(\" guid=\").append(secHost.getGuid());\n+        if (profile.getVirtualMachine().getRole() == SecondaryStorageVm.Role.templateProcessor)\n+            buf.append(\" guid=\").append(secHost.getGuid());\n         else\n-        \tbuf.append(\" guid=\").append(profile.getVirtualMachine().getName());\n-        \n+            buf.append(\" guid=\").append(profile.getVirtualMachine().getName());\n+\n         String nfsMountPoint = null;\n         try {\n             nfsMountPoint = NfsUtils.url2Mount(secHost.getStorageUrl());\n         } catch (Exception e) {\n         }\n \n         buf.append(\" mount.path=\").append(nfsMountPoint);\n-        if(_configDao.isPremium()) {\n+        if (_configDao.isPremium()) {\n             if (profile.getHypervisorType() == HypervisorType.Hyperv) {\n-            \tbuf.append(\" resource=com.cloud.storage.resource.CifsSecondaryStorageResource\");\n+                buf.append(\" resource=com.cloud.storage.resource.CifsSecondaryStorageResource\");\n             } else\n-            \tbuf.append(\" resource=com.cloud.storage.resource.PremiumSecondaryStorageResource\");\n-        } else\t\n-        \tbuf.append(\" resource=com.cloud.storage.resource.NfsSecondaryStorageResource\");\n+                buf.append(\" resource=com.cloud.storage.resource.PremiumSecondaryStorageResource\");\n+        } else\n+            buf.append(\" resource=com.cloud.storage.resource.NfsSecondaryStorageResource\");\n         buf.append(\" instance=SecStorage\");\n         buf.append(\" sslcopy=\").append(Boolean.toString(_useSSlCopy));\n         buf.append(\" role=\").append(profile.getVirtualMachine().getRole().toString());\n@@ -884,11 +870,11 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n                 buf.append(\" gateway=\").append(nic.getGateway());\n             }\n             if (nic.getTrafficType() == TrafficType.Management) {\n-            \tString mgmt_cidr = _configDao.getValue(Config.ManagementNetwork.key());\n-            \tif (NetUtils.isValidCIDR(mgmt_cidr)) {\n-            \t    buf.append(\" mgmtcidr=\").append(mgmt_cidr);\n-            \t}\n-            \t\n+                String mgmt_cidr = _configDao.getValue(Config.ManagementNetwork.key());\n+                if (NetUtils.isValidCIDR(mgmt_cidr)) {\n+                    buf.append(\" mgmtcidr=\").append(mgmt_cidr);\n+                }\n+\n                 buf.append(\" localgw=\").append(dest.getPod().getGateway());\n                 buf.append(\" private.network.device=\").append(\"eth\").append(deviceId);\n             } else if (nic.getTrafficType() == TrafficType.Public) {\n@@ -916,17 +902,16 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n     }\n \n     @Override\n-    public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<SecondaryStorageVmVO> profile, DeployDestination dest,\n-            ReservationContext context) {\n-        \n+    public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<SecondaryStorageVmVO> profile, DeployDestination dest, ReservationContext context) {\n+\n         finalizeCommandsOnStart(cmds, profile);\n \n         SecondaryStorageVmVO secVm = profile.getVirtualMachine();\n         DataCenter dc = dest.getDataCenter();\n         List<NicProfile> nics = profile.getNics();\n         for (NicProfile nic : nics) {\n             if ((nic.getTrafficType() == TrafficType.Public && dc.getNetworkType() == NetworkType.Advanced)\n-                || (nic.getTrafficType() == TrafficType.Guest && (dc.getNetworkType() == NetworkType.Basic || dc.isSecurityGroupEnabled()))) {\n+                    || (nic.getTrafficType() == TrafficType.Guest && (dc.getNetworkType() == NetworkType.Basic || dc.isSecurityGroupEnabled()))) {\n                 secVm.setPublicIpAddress(nic.getIp4Address());\n                 secVm.setPublicNetmask(nic.getNetmask());\n                 secVm.setPublicMacAddress(nic.getMacAddress());\n@@ -938,28 +923,31 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<Secondary\n         _secStorageVmDao.update(secVm.getId(), secVm);\n         return true;\n     }\n-    \n+\n     @Override\n     public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<SecondaryStorageVmVO> profile) {\n-        \n+\n         NicProfile managementNic = null;\n         NicProfile controlNic = null;\n         for (NicProfile nic : profile.getNics()) {\n-           if (nic.getTrafficType() == TrafficType.Management) {\n-               managementNic = nic;\n-           } else if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n-               controlNic = nic;\n-           }\n+            if (nic.getTrafficType() == TrafficType.Management) {\n+                managementNic = nic;\n+            } else if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n+                controlNic = nic;\n+            }\n         }\n \n         if (controlNic == null) {\n-          assert (managementNic != null);\n-          controlNic = managementNic;\n+            if (managementNic == null) {\n+                s_logger.error(\"Management network doesn't exist for the secondaryStorageVm \" + profile.getVirtualMachine());\n+                return false;\n+            }\n+            controlNic = managementNic;\n         }\n \n         CheckSshCommand check = new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20);\n         cmds.addCommand(\"checkSsh\", check);\n-        \n+\n         return true;\n     }\n \n@@ -977,88 +965,86 @@ public boolean finalizeStart(VirtualMachineProfile<SecondaryStorageVmVO> profile\n     @Override\n     public void finalizeStop(VirtualMachineProfile<SecondaryStorageVmVO> profile, StopAnswer answer) {\n     }\n-    \n+\n     @Override\n     public void finalizeExpunge(SecondaryStorageVmVO vm) {\n     }\n-    \n+\n     @Override\n-\tpublic String getScanHandlerName() {\n-\t\treturn \"secstorage\";\n-\t}\n-    \n+    public String getScanHandlerName() {\n+        return \"secstorage\";\n+    }\n+\n     @Override\n-\tpublic boolean canScan() {\n-\t\treturn true;\n-\t}\n+    public boolean canScan() {\n+        return true;\n+    }\n \n     @Override\n-\tpublic void onScanStart() {\n+    public void onScanStart() {\n         _zoneHostInfoMap = getZoneHostInfo();\n-\t}\n-\t\n+    }\n+\n     @Override\n-\tpublic Long[] getScannablePools() {\n-\t\tList<DataCenterVO> zones = _dcDao.listEnabledZones();\n-\n-\t\tLong[] dcIdList = new Long[zones.size()];\n-\t\tint i = 0;\n-\t\tfor(DataCenterVO dc : zones) {\n-\t\t\tdcIdList[i++] = dc.getId();\n-\t\t}\n-\t\t\n-\t\treturn dcIdList;\n-\t}\n-\t\n+    public Long[] getScannablePools() {\n+        List<DataCenterVO> zones = _dcDao.listEnabledZones();\n+\n+        Long[] dcIdList = new Long[zones.size()];\n+        int i = 0;\n+        for (DataCenterVO dc : zones) {\n+            dcIdList[i++] = dc.getId();\n+        }\n+\n+        return dcIdList;\n+    }\n+\n     @Override\n-\tpublic boolean isPoolReadyForScan(Long pool) {\n-\t\t// pool is at zone basis\n-\t\tlong dataCenterId = pool.longValue();\n-\t\t\n-\t\tif(!isZoneReady(_zoneHostInfoMap, dataCenterId)) {\n-\t\t\tif(s_logger.isDebugEnabled())\n-\t\t\t\ts_logger.debug(\"Zone \" + dataCenterId + \" is not ready to launch secondary storage VM yet\");\n-\t\t\treturn false;\n-\t\t}\n-\n-\t\tif(s_logger.isDebugEnabled())\n-\t\t\ts_logger.debug(\"Zone \" + dataCenterId + \" is ready to launch secondary storage VM\");\n-\t\treturn true;\n-\t}\n-\t\n+    public boolean isPoolReadyForScan(Long pool) {\n+        // pool is at zone basis\n+        long dataCenterId = pool.longValue();\n+\n+        if (!isZoneReady(_zoneHostInfoMap, dataCenterId)) {\n+            if (s_logger.isDebugEnabled())\n+                s_logger.debug(\"Zone \" + dataCenterId + \" is not ready to launch secondary storage VM yet\");\n+            return false;\n+        }\n+\n+        if (s_logger.isDebugEnabled())\n+            s_logger.debug(\"Zone \" + dataCenterId + \" is ready to launch secondary storage VM\");\n+        return true;\n+    }\n+\n     @Override\n-\tpublic Pair<AfterScanAction, Object> scanPool(Long pool) {\n-\t\tlong dataCenterId = pool.longValue();\n-    \t\n-        List<SecondaryStorageVmVO> alreadyRunning = _secStorageVmDao.getSecStorageVmListInStates(SecondaryStorageVm.Role.templateProcessor, dataCenterId, State.Running,\n-                State.Migrating, State.Starting);\n-        List<SecondaryStorageVmVO> stopped = _secStorageVmDao.getSecStorageVmListInStates(SecondaryStorageVm.Role.templateProcessor, dataCenterId, State.Stopped,\n-                State.Stopping);\n+    public Pair<AfterScanAction, Object> scanPool(Long pool) {\n+        long dataCenterId = pool.longValue();\n+\n+        List<SecondaryStorageVmVO> alreadyRunning = _secStorageVmDao.getSecStorageVmListInStates(SecondaryStorageVm.Role.templateProcessor, dataCenterId, State.Running, State.Migrating,\n+                State.Starting);\n+        List<SecondaryStorageVmVO> stopped = _secStorageVmDao.getSecStorageVmListInStates(SecondaryStorageVm.Role.templateProcessor, dataCenterId, State.Stopped, State.Stopping);\n         if (alreadyRunning.size() == 0) {\n             if (stopped.size() == 0) {\n                 s_logger.info(\"No secondary storage vms found in datacenter id=\" + dataCenterId + \", starting a new one\");\n-            \treturn new Pair<AfterScanAction, Object>(AfterScanAction.expand, SecondaryStorageVm.Role.templateProcessor);\n+                return new Pair<AfterScanAction, Object>(AfterScanAction.expand, SecondaryStorageVm.Role.templateProcessor);\n             } else {\n-                s_logger.warn(\"Stopped secondary storage vms found in datacenter id=\" + dataCenterId\n-                        + \", not restarting them automatically\");\n+                s_logger.warn(\"Stopped secondary storage vms found in datacenter id=\" + dataCenterId + \", not restarting them automatically\");\n             }\n         }\n-        \n+\n         return new Pair<AfterScanAction, Object>(AfterScanAction.nop, SecondaryStorageVm.Role.templateProcessor);\n-\t}\n-\t\n+    }\n+\n     @Override\n-\tpublic void expandPool(Long pool, Object actionArgs) {\n-\t\tlong dataCenterId = pool.longValue();\n-        allocCapacity(dataCenterId, (SecondaryStorageVm.Role)actionArgs);\n-\t}\n-\t\n+    public void expandPool(Long pool, Object actionArgs) {\n+        long dataCenterId = pool.longValue();\n+        allocCapacity(dataCenterId, (SecondaryStorageVm.Role) actionArgs);\n+    }\n+\n     @Override\n-\tpublic void shrinkPool(Long pool, Object actionArgs) {\n-\t}\n-\t\n+    public void shrinkPool(Long pool, Object actionArgs) {\n+    }\n+\n     @Override\n-\tpublic void onScanEnd() {\n-\t}\n-    \n+    public void onScanEnd() {\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/22ee7117f52ef639009711ce015ac7c5a64b8751/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "sha": "ed73a2db36806bc78b2360b1801a4d133681ab31",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/22ee7117f52ef639009711ce015ac7c5a64b8751/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=22ee7117f52ef639009711ce015ac7c5a64b8751",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -96,6 +96,7 @@\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n import com.cloud.hypervisor.HypervisorGuru;\n import com.cloud.hypervisor.HypervisorGuruManager;\n+import com.cloud.network.Network;\n import com.cloud.network.NetworkManager;\n import com.cloud.network.NetworkVO;\n import com.cloud.org.Cluster;\n@@ -1480,6 +1481,12 @@ protected Command compareState(VMInstanceVO vm, final AgentVmInfo info, final bo\n                     vm = vmGuru.findById(vm.getId());\n \n                     VirtualMachineProfile<VMInstanceVO> profile = new VirtualMachineProfileImpl<VMInstanceVO>(vm);\n+                    List<NicVO> nics = _nicsDao.listByVmId(profile.getId());\n+                    for (NicVO nic : nics) {\n+                        Network network = _networkMgr.getNetwork(nic.getNetworkId());\n+                        NicProfile nicProfile = new NicProfile(nic, network, nic.getBroadcastUri(), nic.getIsolationUri(), null);\n+                        profile.addNic(nicProfile);\n+                    }\n \n                     Commands cmds = new Commands(OnError.Revert);\n                     s_logger.debug(\"Finalizing commands that need to be send to complete Start process for the vm \" + vm);",
                "raw_url": "https://github.com/apache/cloudstack/raw/22ee7117f52ef639009711ce015ac7c5a64b8751/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "d120d87555d970cc7ed8d44b140cf5ac7ce69faf",
                "status": "modified"
            }
        ],
        "message": "bug 9521: fixed NPE in finalizeCommandsOnStart() method by adding vm's nic to vm profile during the vm to vmProfile conversion.\nstatus 9521: resolved fixed\nConflicts:\n\n\tserver/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java\n\tserver/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java\n\tserver/src/com/cloud/vm/VirtualMachineManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/f881d394e252a2bf68570b3c80ea2a9f1c19a5e4",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_238c483": {
        "bug_id": "cloudstack_238c483",
        "commit": "https://github.com/apache/cloudstack/commit/238c483a7ca744191972e3bb3404a1a506dcb2e1",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/238c483a7ca744191972e3bb3404a1a506dcb2e1/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=238c483a7ca744191972e3bb3404a1a506dcb2e1",
                "deletions": 4,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1013,10 +1013,12 @@ protected void updateRoutersRedundantState(final List<DomainRouterVO> routers) {\n                         s_logger.warn(\"Unable to update router \" + router.getHostName() + \"'s status\");\n                     }\n                     RedundantState state = RedundantState.UNKNOWN;\n-                    if (answer != null && answer.getResult()) {\n-                        state = answer.getState();\n-                    } else {\n-                        s_logger.info(\"Agent response doesn't seem to be correct ==> \" + answer.getResult());\n+                    if (answer != null) {\n+                        if (answer.getResult()) {\n+                            state = answer.getState();\n+                        } else {\n+                            s_logger.info(\"Agent response doesn't seem to be correct ==> \" + answer.getResult());\n+                        }\n                     }\n                     router.setRedundantState(state);\n                     updated = true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/238c483a7ca744191972e3bb3404a1a506dcb2e1/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "ca1f67dbb69b7b98ae38a851e54398cd05075875",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1073 from ustcweizhou/CLOUDSTACK-9055\n\nCLOUDSTACK-9055: fix NPE in updating Redundant State of VPC networksThis issue happened when the KVM nodes is down.It might also happen when the cloudstack-agent is killed unexpectedly.\n\n* pr/1073:\n  CLOUDSTACK-9055: fix NPE in updating Redundant State of VPC networks\n\nSigned-off-by: Remi Bergsma <github@remi.nl>",
        "parent": "https://github.com/apache/cloudstack/commit/401693eafbe940c8fc349eec950779cf3e3f2717",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_24435dd": {
        "bug_id": "cloudstack_24435dd",
        "commit": "https://github.com/apache/cloudstack/commit/24435dd6bc2424da18277ca00229d1d3bb0ec284",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/24435dd6bc2424da18277ca00229d1d3bb0ec284/server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java?ref=24435dd6bc2424da18277ca00229d1d3bb0ec284",
                "deletions": 1,
                "filename": "server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "patch": "@@ -1208,7 +1208,7 @@ protected boolean hostCanAccessSPool(Host host, StoragePool pool) {\n             // volume is ready and the pool should be reused.\n             // In this case, also check if rest of the volumes are ready and can\n             // be reused.\n-            if (plan.getPoolId() != null) {\n+            if (plan.getPoolId() != null || (toBeCreated.getVolumeType() == Volume.Type.DATADISK && toBeCreated.getPoolId() != null && toBeCreated.getState() == Volume.State.Ready)) {\n                 s_logger.debug(\"Volume has pool already allocated, checking if pool can be reused, poolId: \" + toBeCreated.getPoolId());\n                 List<StoragePool> suitablePools = new ArrayList<StoragePool>();\n                 StoragePool pool = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/24435dd6bc2424da18277ca00229d1d3bb0ec284/server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "sha": "7986b3a2decad2c43cb6adac066120c9ab3e78db",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/24435dd6bc2424da18277ca00229d1d3bb0ec284/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java?ref=24435dd6bc2424da18277ca00229d1d3bb0ec284",
                "deletions": 1,
                "filename": "server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -634,6 +634,9 @@ public Long migrate(final HaWorkVO work) {\n             _haDao.update(work.getId(), work);\n \n             VMInstanceVO vm = _instanceDao.findById(vmId);\n+            if (vm == null) {\n+                return null;\n+            }\n             // First try starting the vm with its original planner, if it doesn't succeed send HAPlanner as its an emergency.\n             _itMgr.migrateAway(vm.getUuid(), srcHostId);\n             return null;\n@@ -753,7 +756,10 @@ public void cancelScheduledMigrations(final HostVO host) {\n         List<HaWorkVO> works = _haDao.findTakenWorkItems(WorkType.Migration);\n         List<VMInstanceVO> vms = new ArrayList<VMInstanceVO>(works.size());\n         for (HaWorkVO work : works) {\n-            vms.add(_instanceDao.findById(work.getInstanceId()));\n+            VMInstanceVO vm = _instanceDao.findById(work.getInstanceId());\n+            if (vm != null) {\n+                vms.add(vm);\n+            }\n         }\n         return vms;\n     }\n@@ -913,6 +919,7 @@ private void runWithContext() {\n                     } else {\n                         s_logger.info(\"Rescheduling \" + work + \" to try again at \" + new Date(nextTime << 10));\n                         work.setTimeToTry(nextTime);\n+                        work.setTimesTried(work.getTimesTried() + 1);\n                         work.setServerId(null);\n                         work.setDateTaken(null);\n                     }\n@@ -923,6 +930,7 @@ private void runWithContext() {\n \n                     s_logger.info(\"Rescheduling \" + work + \" to try again at \" + new Date(nextTime << 10));\n                     work.setTimeToTry(nextTime);\n+                    work.setTimesTried(work.getTimesTried() + 1);\n                     work.setServerId(null);\n                     work.setDateTaken(null);\n \n@@ -931,6 +939,10 @@ private void runWithContext() {\n                     VMInstanceVO vm = _instanceDao.findById(work.getInstanceId());\n                     work.setUpdateTime(vm.getUpdated());\n                     work.setPreviousState(vm.getState());\n+                    if (!Step.Done.equals(work.getStep()) && work.getTimesTried() >= _maxRetries) {\n+                        s_logger.warn(\"Giving up, retries max times for work: \" + work);\n+                        work.setStep(Step.Done);\n+                    }\n                 }\n                 _haDao.update(work.getId(), work);\n             } catch (final Throwable th) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/24435dd6bc2424da18277ca00229d1d3bb0ec284/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "sha": "ce6239ae83f61461784a3b71dd1aaa0e031fb327",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/24435dd6bc2424da18277ca00229d1d3bb0ec284/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=24435dd6bc2424da18277ca00229d1d3bb0ec284",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1010,6 +1010,9 @@ public UserVm addNicToVirtualMachine(AddNicToVMCmd cmd) throws InvalidParameterV\n \n         NicProfile profile = new NicProfile(null, null);\n         if (ipAddress != null) {\n+            if (!(NetUtils.isValidIp(ipAddress) || NetUtils.isValidIpv6(ipAddress))) {\n+                throw new InvalidParameterValueException(\"Invalid format for IP address parameter: \" + ipAddress);\n+            }\n             profile = new NicProfile(ipAddress, null);\n         }\n \n@@ -2874,6 +2877,19 @@ protected UserVm createVirtualMachine(DataCenter zone, ServiceOffering serviceOf\n                 }\n \n                 profile.setDefaultNic(true);\n+                if (!_networkModel.areServicesSupportedInNetwork(network.getId(), new Service[]{Service.UserData})) {\n+                    if ((userData != null) && (!userData.isEmpty())) {\n+                        throw new InvalidParameterValueException(\"Unable to deploy VM as UserData is provided while deploying the VM, but there is no support for \" + Network.Service.UserData.getName() + \" service in the default network \" + network.getId());\n+                    }\n+\n+                    if ((sshPublicKey != null) && (!sshPublicKey.isEmpty())) {\n+                        throw new InvalidParameterValueException(\"Unable to deploy VM as SSH keypair is provided while deploying the VM, but there is no support for \" + Network.Service.UserData.getName() + \" service in the default network \" + network.getId());\n+                    }\n+\n+                    if (template.getEnablePassword()) {\n+                        throw new InvalidParameterValueException(\"Unable to deploy VM as template \" + template.getId() + \" is password enabled, but there is no support for \" + Network.Service.UserData.getName() + \" service in the default network \" + network.getId());\n+                    }\n+                }\n             }\n \n             networks.add(new Pair<NetworkVO, NicProfile>(network, profile));",
                "raw_url": "https://github.com/apache/cloudstack/raw/24435dd6bc2424da18277ca00229d1d3bb0ec284/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "13ed97ecbca14944328a55612193f436e00e5cfc",
                "status": "modified"
            }
        ],
        "message": "server: NPE checks and improved case checking\n\n- pool allocation checks for both root and data disks\n- NPE checks to not add null object in collection or try to migrate null VM\n- HA work tries need to increment and be given up when max retries are crossed\n- VM creation should check IP address format for IPv4 and IPv6\n- If userdata is not supported by a network, then fail early if userdata, ssh key,\n  or password enabled template is passed/used\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/752d784d92b4ce461ec6a19a6b54220bb967d4d0",
        "repo": "cloudstack",
        "unit_tests": [
            "DeploymentPlanningManagerImplTest.java",
            "HighAvailabilityManagerImplTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_2548269": {
        "bug_id": "cloudstack_2548269",
        "commit": "https://github.com/apache/cloudstack/commit/2548269238a5de897e1f1a52a5dba4f473b7ed92",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/2548269238a5de897e1f1a52a5dba4f473b7ed92/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=2548269238a5de897e1f1a52a5dba4f473b7ed92",
                "deletions": 6,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -822,12 +822,14 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            volResponse.setVirtualMachineId(vm.getId());\n-            volResponse.setVirtualMachineName(vm.getHostName());\n-            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-            if (userVm != null) {\n-                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                volResponse.setVirtualMachineState(vm.getState().toString());\n+            if (vm != null) {\n+                volResponse.setVirtualMachineId(vm.getId());\n+                volResponse.setVirtualMachineName(vm.getHostName());\n+                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+                if (userVm != null) {\n+                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                    volResponse.setVirtualMachineState(vm.getState().toString());\n+                }\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2548269238a5de897e1f1a52a5dba4f473b7ed92/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "f0b232b3d88c90013dece8a1de8729684fd91219",
                "status": "modified"
            }
        ],
        "message": "fix NPE when listvolume if vm got destroyed",
        "parent": "https://github.com/apache/cloudstack/commit/7ac3c818a97a7b8404ca85ae63bfa07352abf91e",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_25ddb22": {
        "bug_id": "cloudstack_25ddb22",
        "commit": "https://github.com/apache/cloudstack/commit/25ddb22724114c79a9ad5de78a30e098070c7513",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/25ddb22724114c79a9ad5de78a30e098070c7513/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=25ddb22724114c79a9ad5de78a30e098070c7513",
                "deletions": 8,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -822,14 +822,12 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            if (vm != null) {\n-                volResponse.setVirtualMachineId(vm.getId());\n-                volResponse.setVirtualMachineName(vm.getHostName());\n-                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-                if (userVm != null) {\n-                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                    volResponse.setVirtualMachineState(vm.getState().toString());\n-                }\n+            volResponse.setVirtualMachineId(vm.getId());\n+            volResponse.setVirtualMachineName(vm.getHostName());\n+            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+            if (userVm != null) {\n+                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                volResponse.setVirtualMachineState(vm.getState().toString());\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/25ddb22724114c79a9ad5de78a30e098070c7513/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "37e794ddcd55402292b23a9d97bceae283ea8b89",
                "status": "modified"
            }
        ],
        "message": "Revert \"fix NPE when listvolume if vm got destroyed\"\n\nThis reverts commit b6518399987a17c791f22b991dcea36d57866269.",
        "parent": "https://github.com/apache/cloudstack/commit/a8424da076a149a53301aaa0bc86ad8c8b0345ca",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_2660a6b": {
        "bug_id": "cloudstack_2660a6b",
        "commit": "https://github.com/apache/cloudstack/commit/2660a6b7a7f226ab757d2175222db62571813120",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/async/AsyncJob.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/async/AsyncJob.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/async/AsyncJob.java",
                "patch": "@@ -50,7 +50,9 @@\n         AutoScaleVmProfile,\n         AutoScaleVmGroup,\n         GlobalLoadBalancerRule,\n+        LoadBalancerRule,\n         AffinityGroup,\n+        InternalLbVm,\n         DedicatedGuestVlanRange\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/async/AsyncJob.java",
                "sha": "ccdc40620b796d68ce2cda4afa7dfbe7404541e1",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/event/EventTypes.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/event/EventTypes.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 5,
                "filename": "api/src/com/cloud/event/EventTypes.java",
                "patch": "@@ -16,15 +16,28 @@\n // under the License.\n package com.cloud.event;\n \n+import java.util.HashMap;\n+import java.util.Map;\n+\n import com.cloud.configuration.Configuration;\n import com.cloud.dc.DataCenter;\n import com.cloud.dc.Pod;\n import com.cloud.dc.StorageNetworkIpRange;\n import com.cloud.dc.Vlan;\n import com.cloud.domain.Domain;\n import com.cloud.host.Host;\n-import com.cloud.network.*;\n-import com.cloud.network.as.*;\n+import com.cloud.network.GuestVlan;\n+import com.cloud.network.Network;\n+import com.cloud.network.PhysicalNetwork;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.PhysicalNetworkTrafficType;\n+import com.cloud.network.PublicIpAddress;\n+import com.cloud.network.RemoteAccessVpn;\n+import com.cloud.network.as.AutoScaleCounter;\n+import com.cloud.network.as.AutoScalePolicy;\n+import com.cloud.network.as.AutoScaleVmGroup;\n+import com.cloud.network.as.AutoScaleVmProfile;\n+import com.cloud.network.as.Condition;\n import com.cloud.network.router.VirtualRouter;\n import com.cloud.network.rules.LoadBalancer;\n import com.cloud.network.rules.StaticNat;\n@@ -43,9 +56,6 @@\n import com.cloud.user.User;\n import com.cloud.vm.VirtualMachine;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-\n public class EventTypes {\n \n     //map of Event and corresponding entity for which Event is applicable\n@@ -389,11 +399,15 @@\n     public static final String EVENT_AFFINITY_GROUP_ASSIGN = \"AG.ASSIGN\";\n     public static final String EVENT_AFFINITY_GROUP_REMOVE = \"AG.REMOVE\";\n     public static final String EVENT_VM_AFFINITY_GROUP_UPDATE = \"VM.AG.UPDATE\";\n+    \n+    public static final String EVENT_INTERNAL_LB_VM_START = \"INTERNALLBVM.START\";\n+    public static final String EVENT_INTERNAL_LB_VM_STOP = \"INTERNALLBVM.STOP\";\n \n     // Dedicated guest vlan range\n     public static final String EVENT_GUEST_VLAN_RANGE_DEDICATE  = \"GUESTVLANRANGE.DEDICATE\";\n     public static final String EVENT_DEDICATED_GUEST_VLAN_RANGE_RELEASE  = \"GUESTVLANRANGE.RELEASE\";\n \n+\n     static {\n \n         // TODO: need a way to force author adding event types to declare the entity details as well, with out braking",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/event/EventTypes.java",
                "sha": "45a904e426cb42c81ce7e72eb0e42f146aece0fe",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/IpAddress.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/IpAddress.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/network/IpAddress.java",
                "patch": "@@ -81,4 +81,7 @@\n     Long getVpcId();\n \n     String getVmIp();\n+    \n+    Long getNetworkId();\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/IpAddress.java",
                "sha": "c48e8b97ca8da2c3e4cc4ce726e3acc2b4a7844f",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/Network.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/Network.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 8,
                "filename": "api/src/com/cloud/network/Network.java",
                "patch": "@@ -16,18 +16,19 @@\n // under the License.\n package com.cloud.network;\n \n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.cloudstack.acl.ControlledEntity;\n+import org.apache.cloudstack.api.Identity;\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n import com.cloud.network.Networks.BroadcastDomainType;\n import com.cloud.network.Networks.Mode;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.utils.fsm.StateMachine2;\n import com.cloud.utils.fsm.StateObject;\n-import org.apache.cloudstack.acl.ControlledEntity;\n-import org.apache.cloudstack.api.Identity;\n-import org.apache.cloudstack.api.InternalIdentity;\n-\n-import java.net.URI;\n-import java.util.ArrayList;\n-import java.util.List;\n \n /**\n  * owned by an account.\n@@ -50,7 +51,7 @@\n                 Capability.MultipleIps, Capability.TrafficStatistics, Capability.SupportedTrafficDirection, Capability.SupportedEgressProtocols);\n         public static final Service Lb = new Service(\"Lb\", Capability.SupportedLBAlgorithms, Capability.SupportedLBIsolation,\n                 Capability.SupportedProtocols, Capability.TrafficStatistics, Capability.LoadBalancingSupportedIps,\n-                Capability.SupportedStickinessMethods, Capability.ElasticLb);\n+                Capability.SupportedStickinessMethods, Capability.ElasticLb, Capability.LbSchemes);\n         public static final Service UserData = new Service(\"UserData\");\n         public static final Service SourceNat = new Service(\"SourceNat\", Capability.SupportedSourceNatTypes, Capability.RedundantRouter);\n         public static final Service StaticNat = new Service(\"StaticNat\", Capability.ElasticIp);\n@@ -124,6 +125,7 @@ public static Service getService(String serviceName) {\n         public static final Provider None = new Provider(\"None\", false);\n         // NiciraNvp is not an \"External\" provider, otherwise we get in trouble with NetworkServiceImpl.providersConfiguredForExternalNetworking \n         public static final Provider NiciraNvp = new Provider(\"NiciraNvp\", false);\n+        public static final Provider InternalLbVm = new Provider(\"InternalLbVm\", false);\n         public static final Provider CiscoVnmc = new Provider(\"CiscoVnmc\", true);\n \n         private String name;\n@@ -177,6 +179,7 @@ public static Provider getProvider(String providerName) {\n         public static final Capability SupportedTrafficDirection = new Capability(\"SupportedTrafficDirection\");\n         public static final Capability SupportedEgressProtocols = new Capability(\"SupportedEgressProtocols\");\n         public static final Capability HealthCheckPolicy = new Capability(\"HealthCheckPolicy\");\n+        public static final Capability LbSchemes = new Capability(\"LbSchemes\");\n \n         private String name;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/Network.java",
                "sha": "fa062c6a694dcba181c2b20cd2a738ec41352838",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/NetworkModel.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/NetworkModel.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/network/NetworkModel.java",
                "patch": "@@ -33,6 +33,7 @@\n import com.cloud.network.element.NetworkElement;\n import com.cloud.network.element.UserDataServiceProvider;\n import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.user.Account;\n import com.cloud.vm.Nic;\n import com.cloud.vm.NicProfile;\n@@ -264,5 +265,11 @@\n \n     Nic getPlaceholderNicForRouter(Network network, Long podId);\n     \n+    IpAddress getPublicIpAddress(String ipAddress, long zoneId);\n+\n+    List<String> getUsedIpsInNetwork(Network network);\n+\n+    Map<Detail, String> getNtwkOffDetails(long offId);\n+\n     Networks.IsolationType[] listNetworkIsolationMethods();\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/NetworkModel.java",
                "sha": "f84a8b0c76a1aa7827f817495b75ba1a54eac9b0",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/VirtualNetworkApplianceService.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/VirtualNetworkApplianceService.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/network/VirtualNetworkApplianceService.java",
                "patch": "@@ -63,5 +63,7 @@ VirtualRouter rebootRouter(long routerId, boolean reprogramNetwork) throws Concu\n     VirtualRouter startRouter(long id) throws ResourceUnavailableException, InsufficientCapacityException, ConcurrentOperationException;\n \n     VirtualRouter destroyRouter(long routerId, Account caller, Long callerUserId) throws ResourceUnavailableException, ConcurrentOperationException;\n+    \n+    VirtualRouter findRouter(long routerId);\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/VirtualNetworkApplianceService.java",
                "sha": "58eead2af0755dbcd567fda6e8e6389e2ff73c0f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/VirtualRouterProvider.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/VirtualRouterProvider.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/com/cloud/network/VirtualRouterProvider.java",
                "patch": "@@ -23,7 +23,8 @@\n     public enum VirtualRouterProviderType {\n         VirtualRouter,\n         ElasticLoadBalancerVm,\n-        VPCVirtualRouter\n+        VPCVirtualRouter,\n+        InternalLbVm\n     }\n \n     public VirtualRouterProviderType getType();",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/VirtualRouterProvider.java",
                "sha": "f67686e6b082878af7c1fe0106040f49997bed6d",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/lb/LoadBalancingRule.java",
                "changes": 83,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/lb/LoadBalancingRule.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 67,
                "filename": "api/src/com/cloud/network/lb/LoadBalancingRule.java",
                "patch": "@@ -25,111 +25,83 @@\n import com.cloud.network.as.Counter;\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.LoadBalancer;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.utils.Pair;\n+import com.cloud.utils.net.Ip;\n \n-public class LoadBalancingRule implements FirewallRule, LoadBalancer {\n+public class LoadBalancingRule {\n     private LoadBalancer lb;\n+    private Ip sourceIp;\n     private List<LbDestination> destinations;\n     private List<LbStickinessPolicy> stickinessPolicies;\n     private LbAutoScaleVmGroup autoScaleVmGroup;\n     private List<LbHealthCheckPolicy> healthCheckPolicies;\n \n     public LoadBalancingRule(LoadBalancer lb, List<LbDestination> destinations,\n-            List<LbStickinessPolicy> stickinessPolicies, List<LbHealthCheckPolicy> healthCheckPolicies) {\n+            List<LbStickinessPolicy> stickinessPolicies, List<LbHealthCheckPolicy> healthCheckPolicies, Ip sourceIp) {\n         this.lb = lb;\n         this.destinations = destinations;\n         this.stickinessPolicies = stickinessPolicies;\n         this.healthCheckPolicies = healthCheckPolicies;\n+        this.sourceIp = sourceIp;\n     }\n \n-    @Override\n     public long getId() {\n         return lb.getId();\n     }\n \n-    @Override\n-    public long getAccountId() {\n-        return lb.getAccountId();\n-    }\n-\n-    @Override\n-    public long getDomainId() {\n-        return lb.getDomainId();\n-    }\n-\n-    @Override\n     public String getName() {\n         return lb.getName();\n     }\n \n-    @Override\n     public String getDescription() {\n         return lb.getDescription();\n     }\n \n-    @Override\n     public int getDefaultPortStart() {\n         return lb.getDefaultPortStart();\n     }\n \n-    @Override\n     public int getDefaultPortEnd() {\n         return lb.getDefaultPortEnd();\n     }\n \n-    @Override\n     public String getAlgorithm() {\n         return lb.getAlgorithm();\n     }\n \n-    @Override\n     public String getUuid() {\n         return lb.getUuid();\n     }\n \n-    @Override\n     public String getXid() {\n         return lb.getXid();\n     }\n \n-    @Override\n-    public Long getSourceIpAddressId() {\n-        return lb.getSourceIpAddressId();\n-    }\n-\n-    @Override\n     public Integer getSourcePortStart() {\n         return lb.getSourcePortStart();\n     }\n \n-    @Override\n     public Integer getSourcePortEnd() {\n         return lb.getSourcePortEnd();\n     }\n \n-    @Override\n     public String getProtocol() {\n         return lb.getProtocol();\n     }\n \n-    @Override\n-    public Purpose getPurpose() {\n-        return Purpose.LoadBalancing;\n+    public FirewallRule.Purpose getPurpose() {\n+        return FirewallRule.Purpose.LoadBalancing;\n     }\n \n-    @Override\n-    public State getState() {\n+    public FirewallRule.State getState() {\n         return lb.getState();\n     }\n \n-    @Override\n     public long getNetworkId() {\n         return lb.getNetworkId();\n     }\n \n-    public LoadBalancer getLb() {\n-        return lb;\n-    }\n \n     public void setDestinations(List<LbDestination> destinations) {\n         this.destinations = destinations;\n@@ -287,36 +259,6 @@ public void setRevoked(boolean revoked) {\n         }\n     }\n \n-    @Override\n-    public Integer getIcmpCode() {\n-        return null;\n-    }\n-\n-    @Override\n-    public Integer getIcmpType() {\n-        return null;\n-    }\n-\n-    @Override\n-    public List<String> getSourceCidrList() {\n-        return null;\n-    }\n-\n-    @Override\n-    public Long getRelated() {\n-        return null;\n-    }\n-\n-    @Override\n-    public TrafficType getTrafficType() {\n-        return null;\n-    }\n-\n-    @Override\n-    public FirewallRuleType getType() {\n-        return FirewallRuleType.User;\n-    }\n-\n     public LbAutoScaleVmGroup getAutoScaleVmGroup() {\n         return autoScaleVmGroup;\n     }\n@@ -473,4 +415,11 @@ public String getCurrentState() {\n         }\n     }\n \n+    public Ip getSourceIp() {\n+        return sourceIp;\n+    }\n+\n+    public Scheme getScheme() {\n+        return lb.getScheme();\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/lb/LoadBalancingRule.java",
                "sha": "4b37782a8c73b420f25a3ab507e9f15277bd2810",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/lb/LoadBalancingRulesService.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/lb/LoadBalancingRulesService.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 6,
                "filename": "api/src/com/cloud/network/lb/LoadBalancingRulesService.java",
                "patch": "@@ -17,10 +17,10 @@\n package com.cloud.network.lb;\n \n import java.util.List;\n+import java.util.Map;\n \n import org.apache.cloudstack.api.command.user.loadbalancer.CreateLBHealthCheckPolicyCmd;\n import org.apache.cloudstack.api.command.user.loadbalancer.CreateLBStickinessPolicyCmd;\n-import org.apache.cloudstack.api.command.user.loadbalancer.CreateLoadBalancerRuleCmd;\n import org.apache.cloudstack.api.command.user.loadbalancer.ListLBHealthCheckPoliciesCmd;\n import org.apache.cloudstack.api.command.user.loadbalancer.ListLBStickinessPoliciesCmd;\n import org.apache.cloudstack.api.command.user.loadbalancer.ListLoadBalancerRuleInstancesCmd;\n@@ -30,12 +30,13 @@\n import com.cloud.exception.InsufficientAddressCapacityException;\n import com.cloud.exception.NetworkRuleConflictException;\n import com.cloud.exception.ResourceUnavailableException;\n-import com.cloud.network.lb.LoadBalancingRule.LbStickinessPolicy;\n import com.cloud.network.rules.HealthCheckPolicy;\n import com.cloud.network.rules.LoadBalancer;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.StickinessPolicy;\n import com.cloud.uservm.UserVm;\n import com.cloud.utils.Pair;\n+import com.cloud.utils.net.Ip;\n \n \n public interface LoadBalancingRulesService {\n@@ -49,7 +50,9 @@\n      * @return the newly created LoadBalancerVO if successful, null otherwise\n      * @throws InsufficientAddressCapacityException\n      */\n-    LoadBalancer createLoadBalancerRule(CreateLoadBalancerRuleCmd lb, boolean openFirewall) throws NetworkRuleConflictException, InsufficientAddressCapacityException;\n+    LoadBalancer createPublicLoadBalancerRule(String xId, String name, String description, \n+            int srcPortStart, int srcPortEnd, int defPortStart, int defPortEnd, Long ipAddrId, String protocol, String algorithm,\n+            long networkId, long lbOwnerId, boolean openFirewall) throws NetworkRuleConflictException, InsufficientAddressCapacityException;\n \n     LoadBalancer updateLoadBalancerRule(UpdateLoadBalancerRuleCmd cmd);\n \n@@ -134,8 +137,9 @@\n \n     List<? extends HealthCheckPolicy> searchForLBHealthCheckPolicies(ListLBHealthCheckPoliciesCmd cmd);\n \n-    List<LoadBalancingRule> listByNetworkId(long networkId);\n-\n     LoadBalancer findById(long LoadBalancer);\n-   public void updateLBHealthChecks() throws ResourceUnavailableException;\n+    \n+    public void updateLBHealthChecks(Scheme scheme) throws ResourceUnavailableException;\n+\n+    Map<Ip, UserVm> getLbInstances(long lbId);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/lb/LoadBalancingRulesService.java",
                "sha": "5fc41e34c349935562eca66cbca5b4a5a11e97cd",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/router/VirtualRouter.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/router/VirtualRouter.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/com/cloud/network/router/VirtualRouter.java",
                "patch": "@@ -23,7 +23,7 @@\n  */\n public interface VirtualRouter extends VirtualMachine {\n \tpublic enum Role {\n-\t\tVIRTUAL_ROUTER, LB\n+\t\tVIRTUAL_ROUTER, LB, INTERNAL_LB_VM\n \t}\n     Role getRole();\n     boolean getIsRedundantRouter();",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/router/VirtualRouter.java",
                "sha": "2311f4899189e89e490d159a351ac6dfbe1c50ca",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/rules/LoadBalancer.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/rules/LoadBalancer.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 8,
                "filename": "api/src/com/cloud/network/rules/LoadBalancer.java",
                "patch": "@@ -19,16 +19,10 @@\n /**\n  * Definition for a LoadBalancer\n  */\n-public interface LoadBalancer extends FirewallRule {\n-\n-    String getName();\n-\n-    String getDescription();\n-\n+public interface LoadBalancer extends FirewallRule, LoadBalancerContainer {\n+    \n     int getDefaultPortStart();\n \n     int getDefaultPortEnd();\n \n-    String getAlgorithm();\n-\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/rules/LoadBalancer.java",
                "sha": "e6dadcaee9713646f7dd608fe0c92965ae92a8b5",
                "status": "modified"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/rules/LoadBalancerContainer.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/rules/LoadBalancerContainer.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/network/rules/LoadBalancerContainer.java",
                "patch": "@@ -0,0 +1,33 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.network.rules;\n+\n+public interface LoadBalancerContainer {\n+    \n+    public enum Scheme {\n+        Public, Internal;\n+    }\n+\n+    String getName();\n+\n+    String getDescription();\n+    \n+    String getAlgorithm();\n+    \n+    Scheme getScheme();\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/network/rules/LoadBalancerContainer.java",
                "sha": "9d5ea595c9daf66244f0b08e032666f800d540bf",
                "status": "added"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/offering/NetworkOffering.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/offering/NetworkOffering.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/offering/NetworkOffering.java",
                "patch": "@@ -16,6 +16,8 @@\n // under the License.\n package com.cloud.offering;\n \n+import java.util.Map;\n+\n import org.apache.cloudstack.acl.InfrastructureEntity;\n import org.apache.cloudstack.api.Identity;\n import org.apache.cloudstack.api.InternalIdentity;\n@@ -38,6 +40,11 @@\n         Disabled,\n         Enabled\n     }\n+    \n+    public enum Detail {\n+        InternalLbProvider,\n+        PublicLbProvider\n+    }\n \n     public final static String SystemPublicNetwork = \"System-Public-Network\";\n     public final static String SystemControlNetwork = \"System-Control-Network\";\n@@ -116,5 +123,9 @@\n     boolean isInline();\n \n     boolean getIsPersistent();\n+    \n+    boolean getInternalLb();\n+\n+    boolean getPublicLb();\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/offering/NetworkOffering.java",
                "sha": "72e2a2bbbabd914facb621e2ca4d00796af506fc",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/offering/ServiceOffering.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/offering/ServiceOffering.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/com/cloud/offering/ServiceOffering.java",
                "patch": "@@ -30,6 +30,7 @@\n     public static final String ssvmDefaultOffUniqueName = \"Cloud.com-SecondaryStorage\";\n     public static final String routerDefaultOffUniqueName = \"Cloud.Com-SoftwareRouter\";\n     public static final String elbVmDefaultOffUniqueName = \"Cloud.Com-ElasticLBVm\";\n+    public static final String internalLbVmDefaultOffUniqueName = \"Cloud.Com-InternalLBVm\";\n \n     public enum StorageType {\n         local,",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/offering/ServiceOffering.java",
                "sha": "165369c5e9b2af18397377c67d06dd637eb4dcf9",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/vm/VirtualMachine.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/vm/VirtualMachine.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/com/cloud/vm/VirtualMachine.java",
                "patch": "@@ -186,6 +186,7 @@ public static boolean isVmDestroyed(State oldState, Event e, State newState) {\n         SecondaryStorageVm,\n         ElasticIpVm,\n         ElasticLoadBalancerVm,\n+        InternalLoadBalancerVm,\n \n         /*\n          * UserBareMetal is only used for selecting VirtualMachineGuru, there is no\n@@ -196,7 +197,7 @@ public static boolean isVmDestroyed(State oldState, Event e, State newState) {\n         public static boolean isSystemVM(VirtualMachine.Type vmtype) {\n             if (DomainRouter.equals(vmtype)\n                     || ConsoleProxy.equals(vmtype)\n-                    || SecondaryStorageVm.equals(vmtype)) {\n+                    || SecondaryStorageVm.equals(vmtype) || InternalLoadBalancerVm.equals(vmtype)) {\n                 return true;\n             }\n             return false;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/com/cloud/vm/VirtualMachine.java",
                "sha": "ce9add62469ee05c8d9cb5409deb111bbd5a40ec",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/ApiConstants.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/ApiConstants.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/ApiConstants.java",
                "patch": "@@ -480,6 +480,12 @@\n     public static final String HEALTHCHECK_HEALTHY_THRESHOLD = \"healthythreshold\";\n     public static final String HEALTHCHECK_UNHEALTHY_THRESHOLD = \"unhealthythreshold\";\n     public static final String HEALTHCHECK_PINGPATH = \"pingpath\";\n+    public static final String SOURCE_PORT = \"sourceport\";\n+    public static final String INSTANCE_PORT = \"instanceport\";\n+    public static final String SOURCE_IP = \"sourceipaddress\";\n+    public static final String SOURCE_IP_NETWORK_ID = \"sourceipaddressnetworkid\";\n+    public static final String SCHEME = \"scheme\";\n+    public static final String PROVIDER_TYPE = \"providertype\";\n     public static final String AFFINITY_GROUP_IDS = \"affinitygroupids\";\n     public static final String AFFINITY_GROUP_NAMES = \"affinitygroupnames\";\n     public static final String ASA_INSIDE_PORT_PROFILE = \"insideportprofile\";",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/ApiConstants.java",
                "sha": "c76506afc10d960873fc0328e06ad78a1e2d5fff",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/BaseCmd.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/BaseCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/BaseCmd.java",
                "patch": "@@ -28,6 +28,9 @@\n import javax.inject.Inject;\n \n import org.apache.cloudstack.affinity.AffinityGroupService;\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElementService;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerService;\n+import org.apache.cloudstack.network.lb.InternalLoadBalancerVMService;\n import org.apache.cloudstack.query.QueryService;\n import org.apache.cloudstack.usage.UsageService;\n import org.apache.log4j.Logger;\n@@ -139,7 +142,11 @@\n     @Inject public VMSnapshotService _vmSnapshotService;\n     @Inject public DataStoreProviderApiService dataStoreProviderApiService;\n     @Inject public VpcProvisioningService _vpcProvSvc;\n+    @Inject public ApplicationLoadBalancerService _newLbSvc;\n+    @Inject public ApplicationLoadBalancerService _appLbService;\n     @Inject public AffinityGroupService _affinityGroupService;\n+    @Inject public InternalLoadBalancerElementService _internalLbElementSvc;\n+    @Inject public InternalLoadBalancerVMService _internalLbSvc;\n     @Inject public NetworkModel _ntwkModel;\n \n     public abstract void execute() throws ResourceUnavailableException, InsufficientCapacityException, ServerApiException, ConcurrentOperationException, ResourceAllocationException, NetworkRuleConflictException;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/BaseCmd.java",
                "sha": "8d66a8327f0323af8e4a212051d60d9228793fa9",
                "status": "modified"
            },
            {
                "additions": 38,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/ResponseGenerator.java",
                "changes": 44,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/ResponseGenerator.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 6,
                "filename": "api/src/org/apache/cloudstack/api/ResponseGenerator.java",
                "patch": "@@ -19,14 +19,15 @@\n import java.text.DecimalFormat;\n import java.util.EnumSet;\n import java.util.List;\n+import java.util.Map;\n \n-import com.cloud.vm.NicSecondaryIp;\n import org.apache.cloudstack.affinity.AffinityGroup;\n import org.apache.cloudstack.affinity.AffinityGroupResponse;\n import org.apache.cloudstack.api.ApiConstants.HostDetails;\n import org.apache.cloudstack.api.ApiConstants.VMDetails;\n import org.apache.cloudstack.api.command.user.job.QueryAsyncJobResultCmd;\n import org.apache.cloudstack.api.response.AccountResponse;\n+import org.apache.cloudstack.api.response.ApplicationLoadBalancerResponse;\n import org.apache.cloudstack.api.response.AsyncJobResponse;\n import org.apache.cloudstack.api.response.AutoScalePolicyResponse;\n import org.apache.cloudstack.api.response.AutoScaleVmGroupResponse;\n@@ -44,11 +45,15 @@\n import org.apache.cloudstack.api.response.ExtractResponse;\n import org.apache.cloudstack.api.response.FirewallResponse;\n import org.apache.cloudstack.api.response.FirewallRuleResponse;\n+import org.apache.cloudstack.api.response.GlobalLoadBalancerResponse;\n import org.apache.cloudstack.api.response.GuestOSResponse;\n+import org.apache.cloudstack.api.response.GuestVlanRangeResponse;\n+import org.apache.cloudstack.api.response.HostForMigrationResponse;\n import org.apache.cloudstack.api.response.HostResponse;\n import org.apache.cloudstack.api.response.HypervisorCapabilitiesResponse;\n import org.apache.cloudstack.api.response.IPAddressResponse;\n import org.apache.cloudstack.api.response.InstanceGroupResponse;\n+import org.apache.cloudstack.api.response.InternalLoadBalancerElementResponse;\n import org.apache.cloudstack.api.response.IpForwardingRuleResponse;\n import org.apache.cloudstack.api.response.IsolationMethodResponse;\n import org.apache.cloudstack.api.response.LBHealthCheckResponse;\n@@ -84,6 +89,7 @@\n import org.apache.cloudstack.api.response.SnapshotScheduleResponse;\n import org.apache.cloudstack.api.response.StaticRouteResponse;\n import org.apache.cloudstack.api.response.StorageNetworkIpRangeResponse;\n+import org.apache.cloudstack.api.response.StoragePoolForMigrationResponse;\n import org.apache.cloudstack.api.response.StoragePoolResponse;\n import org.apache.cloudstack.api.response.SwiftResponse;\n import org.apache.cloudstack.api.response.SystemVmInstanceResponse;\n@@ -103,6 +109,7 @@\n import org.apache.cloudstack.api.response.VpcResponse;\n import org.apache.cloudstack.api.response.VpnUsersResponse;\n import org.apache.cloudstack.api.response.ZoneResponse;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n import org.apache.cloudstack.region.Region;\n import org.apache.cloudstack.usage.Usage;\n \n@@ -119,10 +126,25 @@\n import com.cloud.event.Event;\n import com.cloud.host.Host;\n import com.cloud.hypervisor.HypervisorCapabilities;\n-import com.cloud.network.*;\n+import com.cloud.network.GuestVlan;\n+import com.cloud.network.IpAddress;\n+import com.cloud.network.Network;\n import com.cloud.network.Network.Service;\n import com.cloud.network.Networks.IsolationType;\n-import com.cloud.network.as.*;\n+import com.cloud.network.PhysicalNetwork;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.PhysicalNetworkTrafficType;\n+import com.cloud.network.RemoteAccessVpn;\n+import com.cloud.network.Site2SiteCustomerGateway;\n+import com.cloud.network.Site2SiteVpnConnection;\n+import com.cloud.network.Site2SiteVpnGateway;\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.network.VpnUser;\n+import com.cloud.network.as.AutoScalePolicy;\n+import com.cloud.network.as.AutoScaleVmGroup;\n+import com.cloud.network.as.AutoScaleVmProfile;\n+import com.cloud.network.as.Condition;\n+import com.cloud.network.as.Counter;\n import com.cloud.network.router.VirtualRouter;\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.HealthCheckPolicy;\n@@ -145,19 +167,25 @@\n import com.cloud.projects.ProjectInvitation;\n import com.cloud.region.ha.GlobalLoadBalancerRule;\n import com.cloud.server.ResourceTag;\n-import com.cloud.storage.*;\n+import com.cloud.storage.GuestOS;\n+import com.cloud.storage.S3;\n+import com.cloud.storage.Snapshot;\n+import com.cloud.storage.StoragePool;\n+import com.cloud.storage.Swift;\n+import com.cloud.storage.Volume;\n import com.cloud.storage.snapshot.SnapshotPolicy;\n import com.cloud.storage.snapshot.SnapshotSchedule;\n import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.user.Account;\n import com.cloud.user.User;\n import com.cloud.user.UserAccount;\n import com.cloud.uservm.UserVm;\n+import com.cloud.utils.net.Ip;\n import com.cloud.vm.InstanceGroup;\n import com.cloud.vm.Nic;\n-import com.cloud.vm.snapshot.VMSnapshot;\n+import com.cloud.vm.NicSecondaryIp;\n import com.cloud.vm.VirtualMachine;\n-import org.apache.cloudstack.api.response.*;\n+import com.cloud.vm.snapshot.VMSnapshot;\n \n public interface ResponseGenerator {\n     UserResponse createUserResponse(UserAccount user);\n@@ -397,9 +425,13 @@ LBHealthCheckResponse createLBHealthCheckPolicyResponse(List<? extends HealthChe\n     NicSecondaryIpResponse createSecondaryIPToNicResponse(NicSecondaryIp result);\n     public NicResponse createNicResponse(Nic result);\n \n+    ApplicationLoadBalancerResponse createLoadBalancerContainerReponse(ApplicationLoadBalancerRule lb, Map<Ip, UserVm> lbInstances);\n+    \n     AffinityGroupResponse createAffinityGroupResponse(AffinityGroup group);\n \n     Long getAffinityGroupId(String name, long entityOwnerId);\n \n+    InternalLoadBalancerElementResponse createInternalLbElementResponse(VirtualRouterProvider result);\n+    \n     IsolationMethodResponse createIsolationMethodResponse(IsolationType method);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/ResponseGenerator.java",
                "sha": "ab8f99583a81a51f9c0030220d3e88aabe979189",
                "status": "modified"
            },
            {
                "additions": 114,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/ConfigureInternalLoadBalancerElementCmd.java",
                "changes": 114,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/internallb/ConfigureInternalLoadBalancerElementCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/internallb/ConfigureInternalLoadBalancerElementCmd.java",
                "patch": "@@ -0,0 +1,114 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the \n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.command.admin.internallb;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.InternalLoadBalancerElementResponse;\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElementService;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.user.Account;\n+import com.cloud.user.UserContext;\n+\n+@APICommand(name = \"configureInternalLoadBalancerElement\", responseObject=InternalLoadBalancerElementResponse.class,\n+            description=\"Configures an Internal Load Balancer element.\", since=\"4.2.0\")\n+public class ConfigureInternalLoadBalancerElementCmd extends BaseAsyncCmd {\n+    public static final Logger s_logger = Logger.getLogger(ConfigureInternalLoadBalancerElementCmd.class.getName());\n+    private static final String s_name = \"configureinternalloadbalancerelementresponse\";\n+\n+    @Inject\n+    private List<InternalLoadBalancerElementService> _service;\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name=ApiConstants.ID, type=CommandType.UUID, entityType = InternalLoadBalancerElementResponse.class,\n+            required=true, description=\"the ID of the internal lb provider\")\n+    private Long id;\n+\n+    @Parameter(name=ApiConstants.ENABLED, type=CommandType.BOOLEAN, required=true, description=\"Enables/Disables the Internal Load Balancer element\")\n+    private Boolean enabled;\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    public Boolean getEnabled() {\n+        return enabled;\n+    }\n+\n+    /////////////////////////////////////////////////////\n+    /////////////// API Implementation///////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+    @Override\n+    public String getEventType() {\n+        return EventTypes.EVENT_NETWORK_ELEMENT_CONFIGURE;\n+    }\n+\n+    @Override\n+    public String getEventDescription() {\n+        return  \"configuring internal load balancer element: \" + id;\n+    }\n+\n+    @Override\n+    public void execute() throws ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException{\n+        s_logger.debug(\"hello alena\");\n+        UserContext.current().setEventDetails(\"Internal load balancer element: \" + id);\n+        s_logger.debug(\"hello alena\");\n+        VirtualRouterProvider result = _service.get(0).configureInternalLoadBalancerElement(getId(), getEnabled());\n+        s_logger.debug(\"hello alena\");\n+        if (result != null){\n+            InternalLoadBalancerElementResponse routerResponse = _responseGenerator.createInternalLbElementResponse(result);\n+            routerResponse.setResponseName(getCommandName());\n+            this.setResponseObject(routerResponse);\n+        } else {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to configure the internal load balancer element\");\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/ConfigureInternalLoadBalancerElementCmd.java",
                "sha": "7c3d1e95e571db14c8d0f894e5c90dc9240a25f7",
                "status": "added"
            },
            {
                "additions": 116,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/CreateInternalLoadBalancerElementCmd.java",
                "changes": 116,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/internallb/CreateInternalLoadBalancerElementCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/internallb/CreateInternalLoadBalancerElementCmd.java",
                "patch": "@@ -0,0 +1,116 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.internallb;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCreateCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.InternalLoadBalancerElementResponse;\n+import org.apache.cloudstack.api.response.ProviderResponse;\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElementService;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.ResourceAllocationException;\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.user.Account;\n+import com.cloud.user.UserContext;\n+\n+@APICommand(name = \"createInternalLoadBalancerElement\", responseObject=InternalLoadBalancerElementResponse.class, description=\"Create an Internal Load Balancer element.\",since=\"4.2.0\")\n+public class CreateInternalLoadBalancerElementCmd extends BaseAsyncCreateCmd {\n+    public static final Logger s_logger = Logger.getLogger(CreateInternalLoadBalancerElementCmd.class.getName());\n+    private static final String s_name = \"createinternalloadbalancerelementresponse\";\n+\n+    @Inject\n+    private List<InternalLoadBalancerElementService> _service;\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name=ApiConstants.NETWORK_SERVICE_PROVIDER_ID, type=CommandType.UUID, entityType = ProviderResponse.class, required=true, description=\"the network service provider ID of the internal load balancer element\")\n+    private Long nspId;\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public void setNspId(Long nspId) {\n+        this.nspId = nspId;\n+    }\n+\n+    public Long getNspId() {\n+        return nspId;\n+    }\n+\n+    /////////////////////////////////////////////////////\n+    /////////////// API Implementation///////////////////\n+    /////////////////////////////////////////////////////\n+\n+\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+    @Override\n+    public void execute(){\n+        UserContext.current().setEventDetails(\"Virtual router element Id: \"+getEntityId());\n+        VirtualRouterProvider result = _service.get(0).getInternalLoadBalancerElement(getEntityId());\n+        if (result != null) {\n+            InternalLoadBalancerElementResponse response = _responseGenerator.createInternalLbElementResponse(result);\n+            response.setResponseName(getCommandName());\n+            this.setResponseObject(response);\n+        }else {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to add Virtual Router entity to physical network\");\n+        }\n+    }\n+\n+    @Override\n+    public void create() throws ResourceAllocationException {\n+        VirtualRouterProvider result = _service.get(0).addInternalLoadBalancerElement(getNspId());\n+        if (result != null) {\n+            setEntityId(result.getId());\n+            setEntityUuid(result.getUuid());\n+        } else {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to add Internal Load Balancer entity to physical network\");\n+        }\n+    }\n+\n+    @Override\n+    public String getEventType() {\n+        return EventTypes.EVENT_SERVICE_PROVIDER_CREATE;\n+    }\n+\n+    @Override\n+    public String getEventDescription() {\n+        return  \"Adding physical network element Internal Load Balancer: \" + getEntityId();\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/CreateInternalLoadBalancerElementCmd.java",
                "sha": "2902f7ae18a331c180e8706edb807b11732a085a",
                "status": "added"
            },
            {
                "additions": 151,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLBVMsCmd.java",
                "changes": 151,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLBVMsCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLBVMsCmd.java",
                "patch": "@@ -0,0 +1,151 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.internallb;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseListProjectAndAccountResourcesCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.response.DomainRouterResponse;\n+import org.apache.cloudstack.api.response.HostResponse;\n+import org.apache.cloudstack.api.response.ListResponse;\n+import org.apache.cloudstack.api.response.NetworkResponse;\n+import org.apache.cloudstack.api.response.PodResponse;\n+import org.apache.cloudstack.api.response.UserVmResponse;\n+import org.apache.cloudstack.api.response.VpcResponse;\n+import org.apache.cloudstack.api.response.ZoneResponse;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.async.AsyncJob;\n+import com.cloud.network.router.VirtualRouter.Role;\n+\n+@APICommand(name = \"listInternalLoadBalancerVMs\", description=\"List internal LB VMs.\", responseObject=DomainRouterResponse.class)\n+public class ListInternalLBVMsCmd extends BaseListProjectAndAccountResourcesCmd {\n+    public static final Logger s_logger = Logger.getLogger(ListInternalLBVMsCmd.class.getName());\n+\n+    private static final String s_name = \"listinternallbvmssresponse\";\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name=ApiConstants.HOST_ID, type=CommandType.UUID, entityType=HostResponse.class,\n+            description=\"the host ID of the Internal LB VM\")\n+    private Long hostId;\n+\n+    @Parameter(name=ApiConstants.ID, type=CommandType.UUID, entityType=UserVmResponse.class,\n+            description=\"the ID of the Internal LB VM\")\n+    private Long id;\n+\n+    @Parameter(name=ApiConstants.NAME, type=CommandType.STRING, description=\"the name of the Internal LB VM\")\n+    private String routerName;\n+\n+    @Parameter(name=ApiConstants.POD_ID, type=CommandType.UUID, entityType=PodResponse.class,\n+            description=\"the Pod ID of the Internal LB VM\")\n+    private Long podId;\n+\n+    @Parameter(name=ApiConstants.STATE, type=CommandType.STRING, description=\"the state of the Internal LB VM\")\n+    private String state;\n+\n+    @Parameter(name=ApiConstants.ZONE_ID, type=CommandType.UUID, entityType=ZoneResponse.class,\n+            description=\"the Zone ID of the Internal LB VM\")\n+    private Long zoneId;\n+\n+    @Parameter(name=ApiConstants.NETWORK_ID, type=CommandType.UUID, entityType=NetworkResponse.class,\n+            description=\"list by network id\")\n+    private Long networkId;\n+\n+    @Parameter(name=ApiConstants.VPC_ID, type=CommandType.UUID, entityType=VpcResponse.class,\n+            description=\"List Internal LB VMs by VPC\")\n+    private Long vpcId;\n+\n+    @Parameter(name=ApiConstants.FOR_VPC, type=CommandType.BOOLEAN, description=\"if true is passed for this parameter, list only VPC Internal LB VMs\")\n+    private Boolean forVpc;\n+    \n+    @Parameter(name=ApiConstants.ZONE_TYPE, type=CommandType.STRING, description=\"the network type of the zone that the virtual machine belongs to\")\n+    private String zoneType;\n+    \n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public Long getHostId() {\n+        return hostId;\n+    }\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    public String getRouterName() {\n+        return routerName;\n+    }\n+\n+    public Long getPodId() {\n+        return podId;\n+    }\n+\n+    public String getState() {\n+        return state;\n+    }\n+\n+    public Long getZoneId() {\n+        return zoneId;\n+    }\n+\n+    public Long getNetworkId() {\n+        return networkId;\n+    }\n+\n+    public Long getVpcId() {\n+        return vpcId;\n+    }\n+\n+    public Boolean getForVpc() {\n+        return forVpc;\n+    }\n+    \n+    public String getRole() {\n+        return Role.INTERNAL_LB_VM.toString();\n+    }\n+    \n+    public String getZoneType() {\n+        return zoneType;\n+    }\n+\n+    /////////////////////////////////////////////////////\n+    /////////////// API Implementation///////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public AsyncJob.Type getInstanceType() {\n+        return AsyncJob.Type.DomainRouter;\n+    }\n+\n+    @Override\n+    public void execute(){\n+        ListResponse<DomainRouterResponse> response = _queryService.searchForInternalLbVms(this);\n+        response.setResponseName(getCommandName());\n+        this.setResponseObject(response);\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLBVMsCmd.java",
                "sha": "e314b3245c75bb233ef97882da2993cc6e45ae99",
                "status": "added"
            },
            {
                "additions": 99,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLoadBalancerElementsCmd.java",
                "changes": 99,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLoadBalancerElementsCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLoadBalancerElementsCmd.java",
                "patch": "@@ -0,0 +1,99 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.internallb;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseListCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.InternalLoadBalancerElementResponse;\n+import org.apache.cloudstack.api.response.ListResponse;\n+import org.apache.cloudstack.api.response.ProviderResponse;\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElementService;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.ResourceAllocationException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.VirtualRouterProvider;\n+\n+@APICommand(name = \"listInternalLoadBalancerElements\", description=\"Lists all available Internal Load Balancer elements.\",\n+            responseObject=InternalLoadBalancerElementResponse.class, since=\"4.2.0\")\n+public class ListInternalLoadBalancerElementsCmd extends BaseListCmd {\n+    public static final Logger s_logger = Logger.getLogger(ListInternalLoadBalancerElementsCmd.class.getName());\n+    private static final String _name = \"listinternalloadbalancerelementsresponse\";\n+\n+    @Inject\n+    private InternalLoadBalancerElementService _service;\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+    @Parameter(name=ApiConstants.ID, type=CommandType.UUID, entityType = InternalLoadBalancerElementResponse.class,\n+            description=\"list internal load balancer elements by id\")\n+    private Long id;\n+\n+    @Parameter(name=ApiConstants.NSP_ID, type=CommandType.UUID, entityType = ProviderResponse.class,\n+            description=\"list internal load balancer elements by network service provider id\")\n+    private Long nspId;\n+\n+    @Parameter(name=ApiConstants.ENABLED, type=CommandType.BOOLEAN, description=\"list internal load balancer elements by enabled state\")\n+    private Boolean enabled;\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    public Long getNspId() {\n+        return nspId;\n+    }\n+\n+    public Boolean getEnabled() {\n+        return enabled;\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return _name;\n+    }\n+\n+    @Override\n+    public void execute() throws ResourceUnavailableException, InsufficientCapacityException, ServerApiException, ConcurrentOperationException, ResourceAllocationException {\n+        List<? extends VirtualRouterProvider> providers = _service.searchForInternalLoadBalancerElements(getId(), getNspId(), getEnabled());\n+        ListResponse<InternalLoadBalancerElementResponse> response = new ListResponse<InternalLoadBalancerElementResponse>();\n+        List<InternalLoadBalancerElementResponse> providerResponses = new ArrayList<InternalLoadBalancerElementResponse>();\n+        for (VirtualRouterProvider provider : providers) {\n+            InternalLoadBalancerElementResponse providerResponse = _responseGenerator.createInternalLbElementResponse(provider);\n+            providerResponses.add(providerResponse);\n+        }\n+        response.setResponses(providerResponses);\n+        response.setResponseName(getCommandName());\n+        this.setResponseObject(response);\n+\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/ListInternalLoadBalancerElementsCmd.java",
                "sha": "1853619199555ebb64f7631024a43b5eb9e7fde8",
                "status": "added"
            },
            {
                "additions": 120,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/StartInternalLBVMCmd.java",
                "changes": 120,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/internallb/StartInternalLBVMCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/internallb/StartInternalLBVMCmd.java",
                "patch": "@@ -0,0 +1,120 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.internallb;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.DomainRouterResponse;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.async.AsyncJob;\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n+import com.cloud.user.UserContext;\n+\n+@APICommand(name = \"startInternalLoadBalancerVM\", responseObject=DomainRouterResponse.class, description=\"Starts an existing internal lb vm.\")\n+public class StartInternalLBVMCmd extends BaseAsyncCmd {\n+    public static final Logger s_logger = Logger.getLogger(StartInternalLBVMCmd.class.getName());\n+    private static final String s_name = \"startinternallbvmresponse\";\n+\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name=ApiConstants.ID, type=CommandType.UUID, entityType=DomainRouterResponse.class,\n+            required=true, description=\"the ID of the internal lb vm\")\n+    private Long id;\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    /////////////////////////////////////////////////////\n+    /////////////// API Implementation///////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    public static String getResultObjectName() {\n+        return \"router\";\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        VirtualRouter router = _entityMgr.findById(VirtualRouter.class, getId());\n+        if (router != null && router.getRole() == Role.INTERNAL_LB_VM) {\n+            return router.getAccountId();\n+        } else {\n+            throw new InvalidParameterValueException(\"Unable to find internal lb vm by id\");\n+        } \n+    }\n+\n+    @Override\n+    public String getEventType() {\n+        return EventTypes.EVENT_INTERNAL_LB_VM_START;\n+    }\n+\n+    @Override\n+    public String getEventDescription() {\n+        return  \"starting internal lb vm: \" + getId();\n+    }\n+\n+    public AsyncJob.Type getInstanceType() {\n+        return AsyncJob.Type.InternalLbVm;\n+    }\n+\n+    public Long getInstanceId() {\n+        return getId();\n+    }\n+\n+    @Override\n+    public void execute() throws ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException{\n+        UserContext.current().setEventDetails(\"Internal Lb Vm Id: \"+getId());\n+        VirtualRouter result = null;\n+        VirtualRouter router = _routerService.findRouter(getId());\n+        if (router == null || router.getRole() != Role.INTERNAL_LB_VM) {\n+            throw new InvalidParameterValueException(\"Can't find internal lb vm by id\");\n+        } else {\n+            result = _internalLbSvc.startInternalLbVm(getId(), UserContext.current().getCaller(), UserContext.current().getCallerUserId());\n+        }\n+        \n+        if (result != null){\n+            DomainRouterResponse routerResponse = _responseGenerator.createDomainRouterResponse(result);\n+            routerResponse.setResponseName(getCommandName());\n+            this.setResponseObject(routerResponse);\n+        } else {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to start internal lb vm\");\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/StartInternalLBVMCmd.java",
                "sha": "31d132b5c9c69dfb733e039306afc84f9ec6dd41",
                "status": "added"
            },
            {
                "additions": 123,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/StopInternalLBVMCmd.java",
                "changes": 123,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/internallb/StopInternalLBVMCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/internallb/StopInternalLBVMCmd.java",
                "patch": "@@ -0,0 +1,123 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.internallb;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.DomainRouterResponse;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.async.AsyncJob;\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n+import com.cloud.user.UserContext;\n+\n+@APICommand(name = \"stopInternalLoadBalancerVM\", description = \"Stops an Internal LB vm.\", responseObject = DomainRouterResponse.class)\n+public class StopInternalLBVMCmd extends BaseAsyncCmd {\n+    public static final Logger s_logger = Logger.getLogger(StopInternalLBVMCmd.class.getName());\n+    private static final String s_name = \"stopinternallbvmresponse\";\n+\n+    // ///////////////////////////////////////////////////\n+    // ////////////// API parameters /////////////////////\n+    // ///////////////////////////////////////////////////\n+\n+    @Parameter(name = ApiConstants.ID, type = CommandType.UUID, entityType = DomainRouterResponse.class,\n+            required = true, description = \"the ID of the internal lb vm\")\n+    private Long id;\n+\n+    @Parameter(name = ApiConstants.FORCED, type = CommandType.BOOLEAN, required = false, description = \"Force stop the VM. The caller knows the VM is stopped.\")\n+    private Boolean forced;\n+\n+    // ///////////////////////////////////////////////////\n+    // ///////////////// Accessors ///////////////////////\n+    // ///////////////////////////////////////////////////\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    // ///////////////////////////////////////////////////\n+    // ///////////// API Implementation///////////////////\n+    // ///////////////////////////////////////////////////\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        VirtualRouter vm = _entityMgr.findById(VirtualRouter.class, getId());\n+        if (vm != null && vm.getRole() == Role.INTERNAL_LB_VM) {\n+            return vm.getAccountId();\n+        } else {\n+            throw new InvalidParameterValueException(\"Unable to find internal lb vm by id\");\n+        }\n+    }\n+\n+    @Override\n+    public String getEventType() {\n+        return EventTypes.EVENT_INTERNAL_LB_VM_STOP;\n+    }\n+\n+    @Override\n+    public String getEventDescription() {\n+        return \"stopping internal lb vm: \" + getId();\n+    }\n+\n+    @Override\n+    public AsyncJob.Type getInstanceType() {\n+        return AsyncJob.Type.InternalLbVm;\n+    }\n+\n+    @Override\n+    public Long getInstanceId() {\n+        return getId();\n+    }\n+\n+    public boolean isForced() {\n+        return (forced != null) ? forced : false;\n+    }\n+\n+    @Override\n+    public void execute() throws ConcurrentOperationException, ResourceUnavailableException {\n+        UserContext.current().setEventDetails(\"Internal lb vm Id: \"+getId());\n+        VirtualRouter result = null;\n+        VirtualRouter vm = _routerService.findRouter(getId());\n+        if (vm == null || vm.getRole() != Role.INTERNAL_LB_VM) {\n+            throw new InvalidParameterValueException(\"Can't find internal lb vm by id\");\n+        } else {\n+            result = _internalLbSvc.stopInternalLbVm(getId(), isForced(), UserContext.current().getCaller(), UserContext.current().getCallerUserId());\n+        } \n+        \n+        if (result != null) {\n+            DomainRouterResponse response = _responseGenerator.createDomainRouterResponse(result);\n+            response.setResponseName(getCommandName());\n+            this.setResponseObject(response);\n+        } else {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to stop internal lb vm\");\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/internallb/StopInternalLBVMCmd.java",
                "sha": "f40db49b41794674addadab60fb3ade2096755f6",
                "status": "added"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/network/CreateNetworkOfferingCmd.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/network/CreateNetworkOfferingCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/network/CreateNetworkOfferingCmd.java",
                "patch": "@@ -31,7 +31,6 @@\n import org.apache.cloudstack.api.ServerApiException;\n import org.apache.cloudstack.api.response.NetworkOfferingResponse;\n import org.apache.cloudstack.api.response.ServiceOfferingResponse;\n-\n import org.apache.log4j.Logger;\n \n import com.cloud.exception.InvalidParameterValueException;\n@@ -95,6 +94,10 @@\n \n     @Parameter(name=ApiConstants.IS_PERSISTENT, type=CommandType.BOOLEAN, description=\"true if network offering supports persistent networks; defaulted to false if not specified\")\n     private Boolean isPersistent;\n+    \n+    @Parameter(name=ApiConstants.DETAILS, type=CommandType.MAP, since=\"4.2.0\", description=\"Template details in key/value pairs.\" +\n+    \t\t\" Supported keys are internallbprovider/publiclbprovider with service provider as a value\")\n+    protected Map details;\n \n     /////////////////////////////////////////////////////\n     /////////////////// Accessors ///////////////////////\n@@ -215,6 +218,16 @@ public Boolean getIsPersistent() {\n \n         return capabilityMap;\n     }\n+    \n+    public Map<String, String> getDetails() {\n+        if (details == null || details.isEmpty()) {\n+            return null;\n+        }\n+\n+        Collection paramsCollection = details.values();\n+        Map<String, String> params = (Map<String, String>) (paramsCollection.toArray())[0];\n+        return params;\n+    }\n \n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/network/CreateNetworkOfferingCmd.java",
                "sha": "6410715727cbf2206a8daab70fceb6c97155e23f",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/CreateVirtualRouterElementCmd.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/router/CreateVirtualRouterElementCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 3,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/router/CreateVirtualRouterElementCmd.java",
                "patch": "@@ -31,6 +31,7 @@\n import org.apache.log4j.Logger;\n \n import com.cloud.event.EventTypes;\n+import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.exception.ResourceAllocationException;\n import com.cloud.network.VirtualRouterProvider;\n import com.cloud.network.VirtualRouterProvider.VirtualRouterProviderType;\n@@ -52,6 +53,9 @@\n \n     @Parameter(name=ApiConstants.NETWORK_SERVICE_PROVIDER_ID, type=CommandType.UUID, entityType = ProviderResponse.class, required=true, description=\"the network service provider ID of the virtual router element\")\n     private Long nspId;\n+    \n+    @Parameter(name=ApiConstants.PROVIDER_TYPE, type=CommandType.UUID, entityType = ProviderResponse.class, description=\"The provider type. Supported types are VirtualRouter (default) and VPCVirtualRouter\")\n+    private String providerType;\n \n     /////////////////////////////////////////////////////\n     /////////////////// Accessors ///////////////////////\n@@ -61,16 +65,27 @@ public void setNspId(Long nspId) {\n         this.nspId = nspId;\n     }\n \n-\n-\n     public Long getNspId() {\n         return nspId;\n     }\n+    \n+    public VirtualRouterProviderType getProviderType() {\n+        if (providerType != null) {\n+            if (providerType.equalsIgnoreCase(VirtualRouterProviderType.VirtualRouter.toString())) {\n+                return VirtualRouterProviderType.VirtualRouter;\n+            } else if (providerType.equalsIgnoreCase(VirtualRouterProviderType.VPCVirtualRouter.toString())) {\n+                return VirtualRouterProviderType.VPCVirtualRouter;\n+            } else throw new InvalidParameterValueException(\"Invalid providerType specified\");\n+        } \n+        return VirtualRouterProviderType.VirtualRouter;\n+    }\n \n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////\n     /////////////////////////////////////////////////////\n \n+\n+\n     @Override\n     public String getCommandName() {\n         return s_name;\n@@ -96,7 +111,7 @@ public void execute(){\n \n     @Override\n     public void create() throws ResourceAllocationException {\n-        VirtualRouterProvider result = _service.get(0).addElement(getNspId(), VirtualRouterProviderType.VirtualRouter);\n+        VirtualRouterProvider result = _service.get(0).addElement(getNspId(), getProviderType());\n         if (result != null) {\n             setEntityId(result.getId());\n             setEntityUuid(result.getUuid());",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/CreateVirtualRouterElementCmd.java",
                "sha": "b3fca5addf1a4c54f2104620f09bf119f4387213",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/ListRoutersCmd.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/router/ListRoutersCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/router/ListRoutersCmd.java",
                "patch": "@@ -31,6 +31,7 @@\n import org.apache.log4j.Logger;\n \n import com.cloud.async.AsyncJob;\n+import com.cloud.network.router.VirtualRouter.Role;\n \n @APICommand(name = \"listRouters\", description=\"List routers.\", responseObject=DomainRouterResponse.class)\n public class ListRoutersCmd extends BaseListProjectAndAccountResourcesCmd {\n@@ -77,7 +78,7 @@\n \n     @Parameter(name=ApiConstants.FOR_VPC, type=CommandType.BOOLEAN, description=\"if true is passed for this parameter, list only VPC routers\")\n     private Boolean forVpc;\n-\n+    \n     /////////////////////////////////////////////////////\n     /////////////////// Accessors ///////////////////////\n     /////////////////////////////////////////////////////\n@@ -121,6 +122,10 @@ public Long getVpcId() {\n     public Boolean getForVpc() {\n         return forVpc;\n     }\n+    \n+    public String getRole() {\n+        return Role.VIRTUAL_ROUTER.toString();\n+    }\n \n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/ListRoutersCmd.java",
                "sha": "78c3554ae730cb6ec54826636bc77702d737dc09",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/StartRouterCmd.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/router/StartRouterCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/router/StartRouterCmd.java",
                "patch": "@@ -29,8 +29,10 @@\n import com.cloud.event.EventTypes;\n import com.cloud.exception.ConcurrentOperationException;\n import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n import com.cloud.user.Account;\n import com.cloud.user.UserContext;\n \n@@ -100,7 +102,13 @@ public Long getInstanceId() {\n     @Override\n     public void execute() throws ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException{\n         UserContext.current().setEventDetails(\"Router Id: \"+getId());\n-        VirtualRouter result = _routerService.startRouter(id);\n+        VirtualRouter result = null;\n+        VirtualRouter router = _routerService.findRouter(getId());\n+        if (router == null || router.getRole() != Role.VIRTUAL_ROUTER) {\n+            throw new InvalidParameterValueException(\"Can't find router by id\");\n+        } else {\n+            result = _routerService.startRouter(getId());\n+        }\n         if (result != null){\n             DomainRouterResponse routerResponse = _responseGenerator.createDomainRouterResponse(result);\n             routerResponse.setResponseName(getCommandName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/StartRouterCmd.java",
                "sha": "ad0461e0eb70c6ceae46d74b8a988ff83a3d4a35",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/StopRouterCmd.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/router/StopRouterCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/router/StopRouterCmd.java",
                "patch": "@@ -28,8 +28,10 @@\n import com.cloud.async.AsyncJob;\n import com.cloud.event.EventTypes;\n import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n import com.cloud.user.Account;\n import com.cloud.user.UserContext;\n \n@@ -103,7 +105,14 @@ public boolean isForced() {\n     @Override\n     public void execute() throws ConcurrentOperationException, ResourceUnavailableException {\n         UserContext.current().setEventDetails(\"Router Id: \"+getId());\n-        VirtualRouter result = _routerService.stopRouter(getId(), isForced());\n+        VirtualRouter result = null;\n+        VirtualRouter router = _routerService.findRouter(getId());\n+        if (router == null || router.getRole() != Role.VIRTUAL_ROUTER) {\n+            throw new InvalidParameterValueException(\"Can't find router by id\");\n+        } else {\n+            result = _routerService.stopRouter(getId(), isForced());\n+        }\n+        \n         if (result != null) {\n             DomainRouterResponse response = _responseGenerator.createDomainRouterResponse(result);\n             response.setResponseName(getCommandName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/admin/router/StopRouterCmd.java",
                "sha": "94473cf9ffcc26eb25c6356ec2667cfd8a2c9275",
                "status": "modified"
            },
            {
                "additions": 218,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateApplicationLoadBalancerCmd.java",
                "changes": 218,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateApplicationLoadBalancerCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateApplicationLoadBalancerCmd.java",
                "patch": "@@ -0,0 +1,218 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.user.loadbalancer;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCreateCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.ApplicationLoadBalancerResponse;\n+import org.apache.cloudstack.api.response.NetworkResponse;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.async.AsyncJob;\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientVirtualNetworkCapcityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.NetworkRuleConflictException;\n+import com.cloud.exception.ResourceAllocationException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.Network;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.user.UserContext;\n+import com.cloud.utils.net.NetUtils;\n+\n+@APICommand(name = \"createLoadBalancer\", description=\"Creates a Load Balancer\", responseObject=ApplicationLoadBalancerResponse.class, since=\"4.2.0\")\n+public class CreateApplicationLoadBalancerCmd extends BaseAsyncCreateCmd {\n+    public static final Logger s_logger = Logger.getLogger(CreateApplicationLoadBalancerCmd.class.getName());\n+\n+    private static final String s_name = \"createloadbalancerresponse\";\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+    @Parameter(name=ApiConstants.NAME, type=CommandType.STRING, required=true, description=\"name of the Load Balancer\")\n+    private String loadBalancerName;\n+    \n+    @Parameter(name=ApiConstants.DESCRIPTION, type=CommandType.STRING, description=\"the description of the Load Balancer\", length=4096)\n+    private String description;\n+    \n+    @Parameter(name=ApiConstants.NETWORK_ID, type=CommandType.UUID, required=true, entityType = NetworkResponse.class,\n+            description=\"The guest network the Load Balancer will be created for\")\n+    private Long networkId;\n+    \n+    @Parameter(name=ApiConstants.SOURCE_PORT, type=CommandType.INTEGER, required=true, description=\"the source port the network traffic will be load balanced from\")\n+    private Integer sourcePort;\n+\n+    @Parameter(name=ApiConstants.ALGORITHM, type=CommandType.STRING, required=true, description=\"load balancer algorithm (source, roundrobin, leastconn)\")\n+    private String algorithm;\n+\n+    @Parameter(name=ApiConstants.INSTANCE_PORT, type=CommandType.INTEGER, required=true, description=\"the TCP port of the virtual machine where the network traffic will be load balanced to\")\n+    private Integer instancePort;\n+\n+    @Parameter(name=ApiConstants.SOURCE_IP, type=CommandType.STRING, description=\"the source ip address the network traffic will be load balanced from\")\n+    private String sourceIp;\n+    \n+    @Parameter(name=ApiConstants.SOURCE_IP_NETWORK_ID, type=CommandType.UUID, entityType = NetworkResponse.class, required=true,\n+            description=\"the network id of the source ip address\")\n+    private Long sourceIpNetworkId;\n+    \n+    @Parameter(name=ApiConstants.SCHEME, type=CommandType.STRING, required=true, description=\"the load balancer scheme. Supported value in this release is Internal\")\n+    private String scheme;\n+\n+\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public String getAlgorithm() {\n+        return algorithm;\n+    }\n+\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    public String getLoadBalancerName() {\n+        return loadBalancerName;\n+    }\n+\n+    public Integer getPrivatePort() {\n+        return instancePort;\n+    }\n+\n+    public long getNetworkId() {\n+        return networkId;\n+    }\n+\n+    public String getName() {\n+        return loadBalancerName;\n+    }\n+    \n+    public Integer getSourcePort() {\n+        return sourcePort.intValue();\n+    }\n+\n+    public String getProtocol() {\n+        return NetUtils.TCP_PROTO;\n+    }\n+\n+    public long getAccountId() {\n+        //get account info from the network object\n+        Network ntwk = _networkService.getNetwork(networkId);\n+        if (ntwk == null) {\n+            throw new InvalidParameterValueException(\"Invalid network id specified\");\n+        }\n+       \n+        return ntwk.getAccountId();\n+        \n+    }\n+\n+    public int getInstancePort() {\n+        return instancePort.intValue();\n+    }\n+\n+    @Override\n+    public String getEventType() {\n+        return EventTypes.EVENT_LOAD_BALANCER_CREATE;\n+    }\n+\n+    @Override\n+    public String getEventDescription() {\n+        return \"creating load balancer: \" + getName() + \" account: \" + getAccountId();\n+\n+    }\n+\n+    @Override\n+    public AsyncJob.Type getInstanceType() {\n+        return AsyncJob.Type.LoadBalancerRule;\n+    }\n+    \n+    public String getSourceIp() {\n+        return sourceIp;\n+    }\n+\n+    public long getSourceIpNetworkId() {\n+        return sourceIpNetworkId;\n+    }\n+\n+    public Scheme getScheme() {\n+        if (scheme.equalsIgnoreCase(Scheme.Internal.toString())) {\n+            return Scheme.Internal;\n+        } else {\n+            throw new InvalidParameterValueException(\"Invalid value for scheme. Supported value is Internal\");\n+        }\n+    }\n+    \n+    @Override\n+    public long getEntityOwnerId() {\n+       return getAccountId();\n+    }\n+\n+    /////////////////////////////////////////////////////\n+    /////////////// API Implementation///////////////////\n+    /////////////////////////////////////////////////////\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public void execute() throws ResourceAllocationException, ResourceUnavailableException {\n+        ApplicationLoadBalancerRule rule = null;\n+        try {\n+            UserContext.current().setEventDetails(\"Load Balancer Id: \" + getEntityId());\n+            // State might be different after the rule is applied, so get new object here\n+            rule = _entityMgr.findById(ApplicationLoadBalancerRule.class, getEntityId());\n+            ApplicationLoadBalancerResponse lbResponse = _responseGenerator.createLoadBalancerContainerReponse(rule, _lbService.getLbInstances(getEntityId()));\n+            setResponseObject(lbResponse);\n+            lbResponse.setResponseName(getCommandName());\n+        } catch (Exception ex) {\n+            s_logger.warn(\"Failed to create Load Balancer due to exception \", ex);\n+        } finally {\n+            if (rule == null) {\n+                throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to create Load Balancer\");\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void create() {\n+        try {\n+            \n+            ApplicationLoadBalancerRule result = _appLbService.createApplicationLoadBalancer(getName(), getDescription(), getScheme(),\n+                    getSourceIpNetworkId(), getSourceIp(), getSourcePort(), getInstancePort(), getAlgorithm(), getNetworkId(), getEntityOwnerId());\n+            this.setEntityId(result.getId());\n+            this.setEntityUuid(result.getUuid());\n+        }catch (NetworkRuleConflictException e) {\n+            s_logger.warn(\"Exception: \", e);\n+            throw new ServerApiException(ApiErrorCode.NETWORK_RULE_CONFLICT_ERROR, e.getMessage());\n+        } catch (InsufficientAddressCapacityException e) {\n+            s_logger.warn(\"Exception: \", e);\n+            throw new ServerApiException(ApiErrorCode.INSUFFICIENT_CAPACITY_ERROR, e.getMessage());\n+        } catch (InsufficientVirtualNetworkCapcityException e) {\n+            s_logger.warn(\"Exception: \", e);\n+            throw new ServerApiException(ApiErrorCode.INSUFFICIENT_CAPACITY_ERROR, e.getMessage());\n+        }\n+    }\n+}\n+",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateApplicationLoadBalancerCmd.java",
                "sha": "17ae959aa6e900efead376d2acda774f62226afb",
                "status": "added"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateLoadBalancerRuleCmd.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateLoadBalancerRuleCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 2,
                "filename": "api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateLoadBalancerRuleCmd.java",
                "patch": "@@ -148,7 +148,7 @@ private Long getVpcId() {\n     }\n \n \n-    public Long getNetworkId() {\n+    public long getNetworkId() {\n         if (networkId != null) {\n             return networkId;\n         }\n@@ -278,7 +278,9 @@ public void create() {\n             throw new InvalidParameterValueException(\"Parameter cidrList is deprecated; if you need to open firewall rule for the specific cidr, please refer to createFirewallRule command\");\n         }\n         try {\n-            LoadBalancer result = _lbService.createLoadBalancerRule(this, getOpenFirewall());\n+            LoadBalancer result = _lbService.createPublicLoadBalancerRule(getXid(), getName(), getDescription(), \n+                    getSourcePortStart(), getSourcePortEnd(), getDefaultPortStart(), getDefaultPortEnd(), getSourceIpAddressId(), getProtocol(), getAlgorithm(),\n+                    getNetworkId(), getEntityOwnerId(), getOpenFirewall());\n             this.setEntityId(result.getId());\n             this.setEntityUuid(result.getUuid());\n         } catch (NetworkRuleConflictException e) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/CreateLoadBalancerRuleCmd.java",
                "sha": "f6cc1f130bd3029b03f981571f7452550ddfebc9",
                "status": "modified"
            },
            {
                "additions": 116,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/DeleteApplicationLoadBalancerCmd.java",
                "changes": 116,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/loadbalancer/DeleteApplicationLoadBalancerCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/user/loadbalancer/DeleteApplicationLoadBalancerCmd.java",
                "patch": "@@ -0,0 +1,116 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.user.loadbalancer;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.FirewallRuleResponse;\n+import org.apache.cloudstack.api.response.SuccessResponse;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.async.AsyncJob;\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.user.UserContext;\n+\n+@APICommand(name = \"deleteLoadBalancer\", description=\"Deletes a load balancer\", responseObject=SuccessResponse.class, since=\"4.2.0\")\n+public class DeleteApplicationLoadBalancerCmd extends BaseAsyncCmd {\n+    public static final Logger s_logger = Logger.getLogger(DeleteApplicationLoadBalancerCmd.class.getName());\n+    private static final String s_name = \"deleteloadbalancerresponse\";\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name=ApiConstants.ID, type=CommandType.UUID, entityType = FirewallRuleResponse.class,\n+            required=true, description=\"the ID of the Load Balancer\")\n+    private Long id;\n+\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    /////////////////////////////////////////////////////\n+    /////////////// API Implementation///////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        ApplicationLoadBalancerRule lb = _entityMgr.findById(ApplicationLoadBalancerRule.class, getId());\n+        if (lb != null) {\n+            return lb.getAccountId();\n+        } else {\n+            throw new InvalidParameterValueException(\"Can't find load balancer by id specified\");\n+        }\n+    }\n+\n+    @Override\n+    public String getEventType() {\n+        return EventTypes.EVENT_LOAD_BALANCER_DELETE;\n+    }\n+\n+    @Override\n+    public String getEventDescription() {\n+        return  \"deleting load balancer: \" + getId();\n+    }\n+\n+    @Override\n+    public void execute(){\n+        UserContext.current().setEventDetails(\"Load balancer Id: \" + getId());\n+        boolean result = _appLbService.deleteApplicationLoadBalancer(getId());\n+\n+        if (result) {\n+            SuccessResponse response = new SuccessResponse(getCommandName());\n+            this.setResponseObject(response);\n+        } else {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to delete load balancer\");\n+        }\n+    }\n+\n+    @Override\n+    public String getSyncObjType() {\n+        return BaseAsyncCmd.networkSyncObject;\n+    }\n+\n+    @Override\n+    public Long getSyncObjId() {\n+        ApplicationLoadBalancerRule lb = _appLbService.getApplicationLoadBalancer(id);\n+        if(lb == null){\n+            throw new InvalidParameterValueException(\"Unable to find load balancer by id \");\n+        }\n+        return lb.getNetworkId();\n+    }\n+\n+    @Override\n+    public AsyncJob.Type getInstanceType() {\n+        return AsyncJob.Type.FirewallRule;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/DeleteApplicationLoadBalancerCmd.java",
                "sha": "bc6cd09526cdc7b63858035a6e79f53a87cb295a",
                "status": "added"
            },
            {
                "additions": 131,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/ListApplicationLoadBalancersCmd.java",
                "changes": 131,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/loadbalancer/ListApplicationLoadBalancersCmd.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/user/loadbalancer/ListApplicationLoadBalancersCmd.java",
                "patch": "@@ -0,0 +1,131 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.user.loadbalancer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseListTaggedResourcesCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.response.ApplicationLoadBalancerResponse;\n+import org.apache.cloudstack.api.response.FirewallRuleResponse;\n+import org.apache.cloudstack.api.response.ListResponse;\n+import org.apache.cloudstack.api.response.NetworkResponse;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.utils.Pair;\n+\n+@APICommand(name = \"listLoadBalancers\", description = \"Lists Load Balancers\", responseObject = ApplicationLoadBalancerResponse.class, since=\"4.2.0\")\n+public class ListApplicationLoadBalancersCmd extends BaseListTaggedResourcesCmd {\n+    public static final Logger s_logger = Logger.getLogger(ListApplicationLoadBalancersCmd.class.getName());\n+\n+    private static final String s_name = \"listloadbalancerssresponse\";\n+\n+    // ///////////////////////////////////////////////////\n+    // ////////////// API parameters /////////////////////\n+    // ///////////////////////////////////////////////////\n+\n+    @Parameter(name = ApiConstants.ID, type = CommandType.UUID, entityType = FirewallRuleResponse.class,\n+            description = \"the ID of the Load Balancer\")\n+    private Long id;\n+\n+    @Parameter(name = ApiConstants.NAME, type = CommandType.STRING, description = \"the name of the Load Balancer\")\n+    private String loadBalancerName;\n+    \n+    @Parameter(name = ApiConstants.SOURCE_IP, type = CommandType.STRING, description = \"the source ip address of the Load Balancer\")\n+    private String sourceIp;\n+\n+    @Parameter(name=ApiConstants.SOURCE_IP_NETWORK_ID, type=CommandType.UUID, entityType = NetworkResponse.class, \n+            description=\"the network id of the source ip address\")\n+    private Long sourceIpNetworkId;\n+    \n+    @Parameter(name = ApiConstants.SCHEME, type = CommandType.STRING, description = \"the scheme of the Load Balancer. Supported value is Internal in the current release\")\n+    private String scheme;\n+    \n+    @Parameter(name=ApiConstants.NETWORK_ID, type=CommandType.UUID, entityType = NetworkResponse.class, \n+            description=\"the network id of the Load Balancer\")\n+    private Long networkId;\n+\n+\n+    // ///////////////////////////////////////////////////\n+    // ///////////////// Accessors ///////////////////////\n+    // ///////////////////////////////////////////////////\n+\n+    public Long getId() {\n+        return id;\n+    }\n+\n+    public String getLoadBalancerRuleName() {\n+        return loadBalancerName;\n+    }\n+\n+    public String getLoadBalancerName() {\n+        return loadBalancerName;\n+    }\n+\n+    public String getSourceIp() {\n+        return sourceIp;\n+    }\n+\n+    public Long getSourceIpNetworkId() {\n+        return sourceIpNetworkId;\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+    \n+    public Scheme getScheme() {\n+        if (scheme != null) {\n+            if (scheme.equalsIgnoreCase(Scheme.Internal.toString())) {\n+                return Scheme.Internal;\n+            } else {\n+                throw new InvalidParameterValueException(\"Invalid value for scheme. Supported value is Internal\");\n+            }\n+        }\n+        return null;\n+    }\n+    \n+    public Long getNetworkId() {\n+        return networkId;\n+    }\n+    // ///////////////////////////////////////////////////\n+    // ///////////// API Implementation///////////////////\n+    // ///////////////////////////////////////////////////\n+\n+    @Override\n+    public void execute() {\n+        Pair<List<? extends ApplicationLoadBalancerRule>, Integer> loadBalancers = _appLbService.listApplicationLoadBalancers(this);\n+        ListResponse<ApplicationLoadBalancerResponse> response = new ListResponse<ApplicationLoadBalancerResponse>();\n+        List<ApplicationLoadBalancerResponse> lbResponses = new ArrayList<ApplicationLoadBalancerResponse>();\n+        for (ApplicationLoadBalancerRule loadBalancer : loadBalancers.first()) {\n+            ApplicationLoadBalancerResponse lbResponse = _responseGenerator.createLoadBalancerContainerReponse(loadBalancer, _lbService.getLbInstances(loadBalancer.getId()));\n+            lbResponse.setObjectName(\"loadbalancer\");\n+            lbResponses.add(lbResponse);\n+        }\n+        response.setResponses(lbResponses, loadBalancers.second());\n+        response.setResponseName(getCommandName());\n+        this.setResponseObject(response);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/command/user/loadbalancer/ListApplicationLoadBalancersCmd.java",
                "sha": "8e5df31ed29cba27d79f164a73008faefc6ab5a4",
                "status": "added"
            },
            {
                "additions": 63,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerInstanceResponse.java",
                "changes": 63,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerInstanceResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerInstanceResponse.java",
                "patch": "@@ -0,0 +1,63 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+/**\n+ * \n+ * Load Balancer instance is the User Vm instance participating in the Load Balancer\n+ *\n+ */\n+\n+@SuppressWarnings(\"unused\")\n+public class ApplicationLoadBalancerInstanceResponse extends BaseResponse{\n+    \n+    @SerializedName(ApiConstants.ID) @Param(description = \"the instance ID\")\n+    private String id;\n+    \n+    @SerializedName(ApiConstants.NAME) @Param(description = \"the name of the instance\")\n+    private String name;\n+    \n+    @SerializedName(ApiConstants.STATE) @Param(description=\"the state of the instance\")\n+    private String state;\n+    \n+    @SerializedName(ApiConstants.IP_ADDRESS)\n+    @Param(description=\"the ip address of the instance\")\n+    private String ipAddress;\n+    \n+\n+    public void setId(String id) {\n+        this.id = id;\n+    }\n+\n+    public void setName(String name) {\n+        this.name = name;\n+    }\n+\n+    public void setState(String state) {\n+        this.state = state;\n+    }\n+\n+    public void setIpAddress(String ipAddress) {\n+        this.ipAddress = ipAddress;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerInstanceResponse.java",
                "sha": "2d6614d217b05ad36848e749fdd61812987e626a",
                "status": "added"
            },
            {
                "additions": 142,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerResponse.java",
                "changes": 142,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerResponse.java",
                "patch": "@@ -0,0 +1,142 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.response;\n+\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+@SuppressWarnings(\"unused\")\n+public class ApplicationLoadBalancerResponse extends BaseResponse implements ControlledEntityResponse{\n+    @SerializedName(ApiConstants.ID) @Param(description = \"the Load Balancer ID\")\n+    private String id;\n+\n+    @SerializedName(ApiConstants.NAME) @Param(description = \"the name of the Load Balancer\")\n+    private String name;\n+\n+    @SerializedName(ApiConstants.DESCRIPTION) @Param(description = \"the description of the Load Balancer\")\n+    private String description;\n+    \n+    @SerializedName(ApiConstants.ALGORITHM) @Param(description = \"the load balancer algorithm (source, roundrobin, leastconn)\")\n+    private String algorithm;\n+    \n+    @SerializedName(ApiConstants.NETWORK_ID) @Param(description=\"Load Balancer network id\")\n+    private String networkId;\n+    \n+    @SerializedName(ApiConstants.SOURCE_IP) @Param(description=\"Load Balancer source ip\")\n+    private String sourceIp;\n+    \n+    @SerializedName(ApiConstants.SOURCE_IP_NETWORK_ID) @Param(description=\"Load Balancer source ip network id\")\n+    private String sourceIpNetworkId;\n+    \n+    @SerializedName(ApiConstants.ACCOUNT)\n+    @Param(description = \"the account of the Load Balancer\")\n+    private String accountName;\n+\n+    @SerializedName(ApiConstants.PROJECT_ID) @Param(description=\"the project id of the Load Balancer\")\n+    private String projectId;\n+\n+    @SerializedName(ApiConstants.PROJECT) @Param(description=\"the project name of the Load Balancer\")\n+    private String projectName;\n+\n+    @SerializedName(ApiConstants.DOMAIN_ID)\n+    @Param(description = \"the domain ID of the Load Balancer\")\n+    private String domainId;\n+    \n+    @SerializedName(ApiConstants.DOMAIN)\n+    @Param(description = \"the domain of the Load Balancer\")\n+    private String domainName;\n+    \n+    @SerializedName(\"loadbalancerrule\")  @Param(description=\"the list of rules associated with the Load Balancer\", responseObject = ApplicationLoadBalancerRuleResponse.class)\n+    private List<ApplicationLoadBalancerRuleResponse> lbRules;\n+    \n+    @SerializedName(\"loadbalancerinstance\")  @Param(description=\"the list of instances associated with the Load Balancer\", responseObject = ApplicationLoadBalancerInstanceResponse.class)\n+    private List<ApplicationLoadBalancerInstanceResponse> lbInstances;\n+    \n+    @SerializedName(ApiConstants.TAGS)  @Param(description=\"the list of resource tags associated with the Load Balancer\", responseObject = ResourceTagResponse.class)\n+    private List<ResourceTagResponse> tags;\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    @Override\n+    public void setDomainId(String domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public void setDomainName(String domainName) {\n+        this.domainName = domainName;\n+    }\n+    \n+    @Override\n+    public void setProjectId(String projectId) {\n+        this.projectId = projectId;\n+    }\n+\n+    @Override\n+    public void setProjectName(String projectName) {\n+        this.projectName = projectName;\n+    }\n+\n+    public void setTags(List<ResourceTagResponse> tags) {\n+        this.tags = tags;\n+    }\n+\n+    public void setId(String id) {\n+        this.id = id;\n+    }\n+\n+    public void setName(String name) {\n+        this.name = name;\n+    }\n+\n+    public void setDescription(String description) {\n+        this.description = description;\n+    }\n+\n+    public void setAlgorithm(String algorithm) {\n+        this.algorithm = algorithm;\n+    }\n+\n+    public void setNetworkId(String networkId) {\n+        this.networkId = networkId;\n+    }\n+\n+    public void setSourceIp(String sourceIp) {\n+        this.sourceIp = sourceIp;\n+    }\n+\n+    public void setSourceIpNetworkId(String sourceIpNetworkId) {\n+        this.sourceIpNetworkId = sourceIpNetworkId;\n+    }\n+\n+    public void setLbRules(List<ApplicationLoadBalancerRuleResponse> lbRules) {\n+        this.lbRules = lbRules;\n+    }\n+\n+    public void setLbInstances(List<ApplicationLoadBalancerInstanceResponse> lbInstances) {\n+        this.lbInstances = lbInstances;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerResponse.java",
                "sha": "de9bce6c6580e9ec203b0df1bfd4ff9247d3f9ff",
                "status": "added"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerRuleResponse.java",
                "changes": 51,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerRuleResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerRuleResponse.java",
                "patch": "@@ -0,0 +1,51 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.response;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+/**\n+ * Subobject of the load balancer container response\n+ */\n+@SuppressWarnings(\"unused\")\n+public class ApplicationLoadBalancerRuleResponse extends BaseResponse{\n+    @SerializedName(ApiConstants.SOURCE_PORT) @Param(description = \"source port of the load balancer rule\")\n+    private Integer sourcePort;\n+    \n+    @SerializedName(ApiConstants.INSTANCE_PORT) @Param(description = \"instance port of the load balancer rule\")\n+    private Integer instancePort;\n+    \n+    @SerializedName(ApiConstants.STATE) @Param(description = \"the state of the load balancer rule\")\n+    private String state;\n+\n+    public void setSourcePort(Integer sourcePort) {\n+        this.sourcePort = sourcePort;\n+    }\n+\n+    public void setInstancePort(Integer instancePort) {\n+        this.instancePort = instancePort;\n+    }\n+\n+    public void setState(String state) {\n+        this.state = state;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/ApplicationLoadBalancerRuleResponse.java",
                "sha": "ffc64d5ca462d03d6ce113e732bfb79830c49282",
                "status": "added"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/DomainRouterResponse.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/DomainRouterResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 5,
                "filename": "api/src/org/apache/cloudstack/api/response/DomainRouterResponse.java",
                "patch": "@@ -153,8 +153,11 @@\n     @SerializedName(\"scriptsversion\") @Param(description=\"the version of scripts\")\n     private String scriptsVersion;\n \n-    @SerializedName(ApiConstants.VPC_ID) @Param(description=\"VPC the network belongs to\")\n+    @SerializedName(ApiConstants.VPC_ID) @Param(description=\"VPC the router belongs to\")\n     private String vpcId;\n+    \n+    @SerializedName(ApiConstants.ROLE) @Param(description=\"role of the domain router\")\n+    private String role;\n \n     @SerializedName(\"nic\")  @Param(description=\"the list of nics associated with the router\",\n             responseObject = NicResponse.class, since=\"4.0\")\n@@ -164,15 +167,11 @@ public DomainRouterResponse(){\n         nics = new LinkedHashSet<NicResponse>();\n     }\n \n-\n-\n     @Override\n     public String getObjectId() {\n         return this.getId();\n     }\n \n-\n-\n     public String getId() {\n         return id;\n     }\n@@ -372,4 +371,8 @@ public String getIp6Dns2() {\n \tpublic void setIp6Dns2(String ip6Dns2) {\n \t\tthis.ip6Dns2 = ip6Dns2;\n \t}\n+\t\n+\tpublic void setRole(String role) {\n+        this.role = role;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/DomainRouterResponse.java",
                "sha": "852d98815a3aa8331306fa23243c36a90bebf133",
                "status": "modified"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/InternalLoadBalancerElementResponse.java",
                "changes": 51,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/InternalLoadBalancerElementResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/InternalLoadBalancerElementResponse.java",
                "patch": "@@ -0,0 +1,51 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseResponse;\n+import org.apache.cloudstack.api.EntityReference;\n+\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+@EntityReference(value=VirtualRouterProvider.class)\n+@SuppressWarnings(\"unused\")\n+public class InternalLoadBalancerElementResponse extends BaseResponse {\n+    @SerializedName(ApiConstants.ID) @Param(description=\"the id of the internal load balancer element\")\n+    private String id;\n+\n+    @SerializedName(ApiConstants.NSP_ID) @Param(description=\"the physical network service provider id of the element\")\n+    private String nspId;\n+\n+    @SerializedName(ApiConstants.ENABLED) @Param(description=\"Enabled/Disabled the element\")\n+    private Boolean enabled;\n+\n+\n+    public void setId(String id) {\n+        this.id = id;\n+    }\n+\n+    public void setNspId(String nspId) {\n+        this.nspId = nspId;\n+    }\n+\n+    public void setEnabled(Boolean enabled) {\n+        this.enabled = enabled;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/InternalLoadBalancerElementResponse.java",
                "sha": "b7e8634ee8fdd1c2410ff806cb9c7e7b72b6da33",
                "status": "added"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/NetworkOfferingResponse.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/NetworkOfferingResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/NetworkOfferingResponse.java",
                "patch": "@@ -18,6 +18,7 @@\n \n import java.util.Date;\n import java.util.List;\n+import java.util.Map;\n \n import org.apache.cloudstack.api.ApiConstants;\n import org.apache.cloudstack.api.BaseResponse;\n@@ -83,6 +84,10 @@\n \n     @SerializedName(ApiConstants.IS_PERSISTENT) @Param(description=\"true if network offering supports persistent networks, false otherwise\")\n     private Boolean isPersistent;\n+    \n+    @SerializedName(ApiConstants.DETAILS) @Param(description=\"additional key/value details tied with network offering\", since=\"4.2.0\")\n+    private Map details;\n+\n \n     public void setId(String id) {\n         this.id = id;\n@@ -156,5 +161,9 @@ public void setForVpc(Boolean forVpc) {\n     public void setIsPersistent(Boolean isPersistent) {\n         this.isPersistent = isPersistent;\n     }\n+    \n+    public void setDetails(Map details) {\n+        this.details = details;\n+    }\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/NetworkOfferingResponse.java",
                "sha": "7a7e371e180070fa3ae74cf9915addf08905b892",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/VirtualRouterProviderResponse.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/VirtualRouterProviderResponse.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/VirtualRouterProviderResponse.java",
                "patch": "@@ -25,6 +25,7 @@\n import com.google.gson.annotations.SerializedName;\n \n @EntityReference(value=VirtualRouterProvider.class)\n+@SuppressWarnings(\"unused\")\n public class VirtualRouterProviderResponse extends BaseResponse implements ControlledEntityResponse {\n     @SerializedName(ApiConstants.ID) @Param(description=\"the id of the router\")\n     private String id;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/api/response/VirtualRouterProviderResponse.java",
                "sha": "de355bd0c25e0e63fb2969de87ae8094384f7298",
                "status": "modified"
            },
            {
                "additions": 56,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/element/InternalLoadBalancerElementService.java",
                "changes": 56,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/network/element/InternalLoadBalancerElementService.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/network/element/InternalLoadBalancerElementService.java",
                "patch": "@@ -0,0 +1,56 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.network.element;\n+\n+import java.util.List;\n+\n+\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.utils.component.PluggableService;\n+\n+public interface InternalLoadBalancerElementService extends PluggableService{\n+    /**\n+     * Configures existing Internal Load Balancer Element (enables or disables it)\n+     * @param id\n+     * @param enable\n+     * @return\n+     */\n+    VirtualRouterProvider configureInternalLoadBalancerElement(long id, boolean enable);\n+    \n+    /**\n+     * Adds Internal Load Balancer element to the Network Service Provider\n+     * @param ntwkSvcProviderId\n+     * @return\n+     */\n+    VirtualRouterProvider addInternalLoadBalancerElement(long ntwkSvcProviderId);\n+    \n+    /**\n+     * Retrieves existing Internal Load Balancer element\n+     * @param id\n+     * @return\n+     */\n+    VirtualRouterProvider getInternalLoadBalancerElement(long id);\n+    \n+    /**\n+     * Searches for existing Internal Load Balancer elements based on parameters passed to the call\n+     * @param id\n+     * @param ntwkSvsProviderId\n+     * @param enabled\n+     * @return\n+     */\n+    List<? extends VirtualRouterProvider> searchForInternalLoadBalancerElements(Long id, Long ntwkSvsProviderId, Boolean enabled);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/element/InternalLoadBalancerElementService.java",
                "sha": "33a0c64058ee4ec408e38324808ecfeeb4ac7882",
                "status": "added"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerContainer.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerContainer.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerContainer.java",
                "patch": "@@ -0,0 +1,28 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.network.lb;\n+\n+import com.cloud.network.rules.LoadBalancerContainer;\n+import com.cloud.utils.net.Ip;\n+\n+public interface ApplicationLoadBalancerContainer extends LoadBalancerContainer{\n+    \n+    public Long getSourceIpNetworkId();\n+    \n+    public Ip getSourceIp();\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerContainer.java",
                "sha": "df94d3d43382ef13cc508fb3f3f80ed14e4b3891",
                "status": "added"
            },
            {
                "additions": 24,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerRule.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerRule.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerRule.java",
                "patch": "@@ -0,0 +1,24 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.network.lb;\n+\n+import com.cloud.network.rules.LoadBalancer;\n+\n+public interface ApplicationLoadBalancerRule extends ApplicationLoadBalancerContainer, LoadBalancer{\n+    int getInstancePort();\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerRule.java",
                "sha": "f4acb734c8b556ecc94953f3f74f90de7521099f",
                "status": "added"
            },
            {
                "additions": 42,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerService.java",
                "changes": 42,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerService.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerService.java",
                "patch": "@@ -0,0 +1,42 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.network.lb;\n+\n+import java.util.List;\n+\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListApplicationLoadBalancersCmd;\n+\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientVirtualNetworkCapcityException;\n+import com.cloud.exception.NetworkRuleConflictException;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.utils.Pair;\n+\n+public interface ApplicationLoadBalancerService {\n+    \n+    ApplicationLoadBalancerRule createApplicationLoadBalancer(String name, String description, Scheme scheme, long sourceIpNetworkId, String sourceIp,\n+            int sourcePort, int instancePort, String algorithm, long networkId, long lbOwnerId) throws InsufficientAddressCapacityException,\n+            NetworkRuleConflictException, InsufficientVirtualNetworkCapcityException;\n+    \n+    boolean deleteApplicationLoadBalancer(long id);\n+    \n+    Pair<List<? extends ApplicationLoadBalancerRule>, Integer> listApplicationLoadBalancers(ListApplicationLoadBalancersCmd cmd);\n+    \n+    ApplicationLoadBalancerRule getApplicationLoadBalancer(long ruleId);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerService.java",
                "sha": "b2ac358555b42c1811dfe15d99cf3bfce2c3a952",
                "status": "added"
            },
            {
                "additions": 34,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMService.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMService.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMService.java",
                "patch": "@@ -0,0 +1,34 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.network.lb;\n+\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.exception.StorageUnavailableException;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.user.Account;\n+\n+public interface InternalLoadBalancerVMService {\n+\n+    VirtualRouter startInternalLbVm(long internalLbVmId, Account caller, long callerUserId) \n+            throws StorageUnavailableException, InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException;\n+\n+    VirtualRouter stopInternalLbVm(long vmId, boolean forced, Account caller, long callerUserId)\n+            throws ConcurrentOperationException, ResourceUnavailableException;\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMService.java",
                "sha": "91cd88d91c18541fd5faeb7e8afd25bb5a4d1db8",
                "status": "added"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/query/QueryService.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/query/QueryService.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/query/QueryService.java",
                "patch": "@@ -18,6 +18,7 @@\n \n import org.apache.cloudstack.affinity.AffinityGroupResponse;\n import org.apache.cloudstack.api.command.admin.host.ListHostsCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.ListInternalLBVMsCmd;\n import org.apache.cloudstack.api.command.admin.router.ListRoutersCmd;\n import org.apache.cloudstack.api.command.admin.storage.ListStoragePoolsCmd;\n import org.apache.cloudstack.api.command.admin.user.ListUsersCmd;\n@@ -101,4 +102,6 @@\n \n     public ListResponse<AffinityGroupResponse> listAffinityGroups(Long affinityGroupId, String affinityGroupName,\n             String affinityGroupType, Long vmId, Long startIndex, Long pageSize);\n+\n+    ListResponse<DomainRouterResponse> searchForInternalLbVms(ListInternalLBVMsCmd cmd);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/api/src/org/apache/cloudstack/query/QueryService.java",
                "sha": "2f50d63828c5c967c0f03d42cccb0bdfc1802b27",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/client/pom.xml",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/pom.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "client/pom.xml",
                "patch": "@@ -85,6 +85,11 @@\n       <artifactId>cloud-plugin-network-midonet</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n+  <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-plugin-network-internallb</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n     <dependency>\n       <groupId>org.apache.cloudstack</groupId>\n       <artifactId>cloud-plugin-hypervisor-xen</artifactId>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/client/pom.xml",
                "sha": "197ba27975c17cb8cfc5488b427d324625b38bc9",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/applicationContext.xml.in",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/applicationContext.xml.in?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "client/tomcatconf/applicationContext.xml.in",
                "patch": "@@ -363,6 +363,9 @@\n   <bean id=\"vpcOfferingServiceMapDaoImpl\" class=\"com.cloud.network.vpc.dao.VpcOfferingServiceMapDaoImpl\" />\n   <bean id=\"vpcServiceMapDaoImpl\" class=\"com.cloud.network.vpc.dao.VpcServiceMapDaoImpl\" />\n   <bean id=\"vpnUserDaoImpl\" class=\"com.cloud.network.dao.VpnUserDaoImpl\" />\n+  <bean id=\"applicationLbRuleDaoImpl\" class=\"org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDaoImpl\" />\n+  <bean id=\"networkOfferingDetailsDaoImpl\" class=\"com.cloud.offerings.dao.NetworkOfferingDetailsDaoImpl\" />\n+\n \n   <!--\n     Checkers\n@@ -406,10 +409,12 @@\n   <bean id=\"VpcVirtualRouter\" class=\"com.cloud.network.element.VpcVirtualRouterElement\">\n     <property name=\"name\" value=\"VpcVirtualRouter\"/>\n   </bean>\n-\n   <bean id=\"elasticLoadBalancerElement\" class=\"com.cloud.network.element.ElasticLoadBalancerElement\">\n     <property name=\"name\" value=\"ElasticLoadBalancerElement\"/>\n   </bean>\n+  <bean id=\"InternalLbVm\" class=\"org.apache.cloudstack.network.element.InternalLoadBalancerElement\">\n+    <property name=\"name\" value=\"InternalLbVm\"/>\n+  </bean>\n \n   <!-- \n     General allocators\n@@ -789,6 +794,8 @@\n   <bean id=\"vMSnapshotManagerImpl\" class=\"com.cloud.vm.snapshot.VMSnapshotManagerImpl\" />\n   <bean id=\"volumeManagerImpl\" class=\"com.cloud.storage.VolumeManagerImpl\" />\n   <bean id=\"ClassicalPrimaryDataStoreProvider\" class=\"org.apache.cloudstack.storage.datastore.provider.CloudStackPrimaryDataStoreProviderImpl\" />\n+  <bean id=\"ApplicationLoadBalancerService\" class=\"org.apache.cloudstack.network.lb.ApplicationLoadBalancerManagerImpl\" />\n+  <bean id=\"InternalLoadBalancerVMManager\" class=\"org.apache.cloudstack.network.lb.InternalLoadBalancerVMManagerImpl\" />\n \n \n <!--=======================================================================================================-->",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/applicationContext.xml.in",
                "sha": "67c8ccf9355067e5f2b5f229a08777c3b5c5b40c",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/commands.properties.in",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/commands.properties.in?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "client/tomcatconf/commands.properties.in",
                "patch": "@@ -577,6 +577,17 @@ revertToVMSnapshot=15\n #### Baremetal commands\n addBaremetalHost=1\n \n+#### New Load Balancer commands\n+createLoadBalancer=15\n+listLoadBalancers=15\n+deleteLoadBalancer=15\n+\n+#Internal Load Balancer Element commands\n+configureInternalLoadBalancerElement=1\n+createInternalLoadBalancerElement=1\n+listInternalLoadBalancerElements=1\n+\n+\n #### Affinity group commands\n createAffinityGroup=15\n deleteAffinityGroup=15\n@@ -594,5 +605,10 @@ addCiscoAsa1000vResource=1\n deleteCiscoAsa1000vResource=1\n listCiscoAsa1000vResources=1\n \n+#### Internal LB VM commands\n+stopInternalLoadBalancerVM=1\n+startInternalLoadBalancerVM=1\n+listInternalLoadBalancerVMs=1\n+\n ### Network Isolation methods listing\n listNetworkIsolationMethods=1",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/commands.properties.in",
                "sha": "cdc19929c19f93f8e29a029a314a20084d8f48ec",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/componentContext.xml.in",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/componentContext.xml.in?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "client/tomcatconf/componentContext.xml.in",
                "patch": "@@ -198,6 +198,7 @@\n           <ref bean=\"VirtualRouter\"/>\n           <ref bean=\"VpcVirtualRouter\"/>\n           <ref bean=\"NiciraNvp\"/>\n+          <ref bean=\"InternalLbVm\"/>\n       </list>\n     </property>\n   </bean>\n@@ -241,6 +242,7 @@\n           <ref bean=\"VpcVirtualRouter\"/>\n           <ref bean=\"NiciraNvp\" />\n           <ref bean=\"MidoNetElement\"/>\n+          <ref bean=\"InternalLbVm\"/>\n <!--\n           <ref bean=\"BareMetalDhcp\"/>\n           <ref bean=\"BareMetalPxe\"/>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/componentContext.xml.in",
                "sha": "8a45e5fea857251fba18a17ec30d81eae94819df",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/nonossComponentContext.xml.in",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/nonossComponentContext.xml.in?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "client/tomcatconf/nonossComponentContext.xml.in",
                "patch": "@@ -294,6 +294,7 @@\n           <ref bean=\"VirtualRouter\"/>\n           <ref bean=\"VpcVirtualRouter\"/>\n           <ref bean=\"NiciraNvp\"/>\n+          <ref bean=\"InternalLbVm\"/>\n       </list>\n     </property>\n   </bean>\n@@ -343,6 +344,7 @@\n           <ref bean=\"Ovs\"/>\n           <ref bean=\"SecurityGroupProvider\"/>\n           <ref bean=\"VpcVirtualRouter\"/>\n+          <ref bean=\"InternalLbVm\"/>\n <!--\n           <ref bean=\"BareMetalDhcp\"/>\n           <ref bean=\"BareMetalPxe\"/>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/nonossComponentContext.xml.in",
                "sha": "1b6ee6eb089af31b425b46e71bafeaee9e676ebb",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/simulatorComponentContext.xml.in",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/simulatorComponentContext.xml.in?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "client/tomcatconf/simulatorComponentContext.xml.in",
                "patch": "@@ -205,6 +205,7 @@\n         <ref bean=\"Ovs\"/>\n         <ref bean=\"SecurityGroupProvider\"/>\n         <ref bean=\"VpcVirtualRouter\"/>\n+        <ref bean=\"InternalLbVm\"/>\n         <!--\n                   <ref bean=\"BareMetalDhcp\"/>\n                   <ref bean=\"BareMetalPxe\"/>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/client/tomcatconf/simulatorComponentContext.xml.in",
                "sha": "652c4c824ffd0a9450a9d3f4969b845e3cb25632",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/FirewallRulesDao.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/FirewallRulesDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/network/dao/FirewallRulesDao.java",
                "patch": "@@ -18,7 +18,6 @@\n \n import java.util.List;\n \n-import com.cloud.host.HostVO;\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRuleVO;\n import com.cloud.utils.db.GenericDao;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/FirewallRulesDao.java",
                "sha": "6b9b3bb83e5b6a61500670929df725acca629621",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/IPAddressVO.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/IPAddressVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 4,
                "filename": "engine/schema/src/com/cloud/network/dao/IPAddressVO.java",
                "patch": "@@ -31,12 +31,8 @@\n import javax.persistence.TemporalType;\n import javax.persistence.Transient;\n \n-import org.apache.cloudstack.api.Identity;\n-\n import com.cloud.network.IpAddress;\n-import com.cloud.network.IpAddress.State;\n import com.cloud.utils.net.Ip;\n-import org.apache.cloudstack.api.InternalIdentity;\n \n /**\n  * A bean representing a public IP Address\n@@ -304,4 +300,9 @@ public String getVmIp() {\n     public void setVmIp(String vmIp) {\n         this.vmIp = vmIp;\n     }\n+\n+    @Override\n+    public Long getNetworkId() {\n+        return sourceNetworkId;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/IPAddressVO.java",
                "sha": "ae27e95ce4bbd8537b18d38f4583c24fd5271f32",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/LoadBalancerDao.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/LoadBalancerDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 7,
                "filename": "engine/schema/src/com/cloud/network/dao/LoadBalancerDao.java",
                "patch": "@@ -18,19 +18,15 @@\n \n import java.util.List;\n \n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.utils.db.GenericDao;\n \n public interface LoadBalancerDao extends GenericDao<LoadBalancerVO, Long> {\n-    List<Long> listInstancesByLoadBalancer(long loadBalancerId);\n \n     List<LoadBalancerVO> listByIpAddress(long ipAddressId);\n \n-    LoadBalancerVO findByIpAddressAndPublicPort(long ipAddressId, String publicPort);\n+    List<LoadBalancerVO> listByNetworkIdAndScheme(long networkId, Scheme scheme);\n \n-    LoadBalancerVO findByAccountAndName(Long accountId, String name);\n-\n-    List<LoadBalancerVO> listByNetworkId(long networkId);\n-\n-    List<LoadBalancerVO> listInTransitionStateByNetworkId(long networkId);\n+    List<LoadBalancerVO> listInTransitionStateByNetworkIdAndScheme(long networkId, Scheme scheme);\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/LoadBalancerDao.java",
                "sha": "331f7555d81b2cd53127909d8a3ecf89257adbbc",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/LoadBalancerDaoImpl.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/LoadBalancerDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 66,
                "filename": "engine/schema/src/com/cloud/network/dao/LoadBalancerDaoImpl.java",
                "patch": "@@ -16,39 +16,24 @@\n // under the License.\n package com.cloud.network.dao;\n \n-import java.sql.PreparedStatement;\n-import java.sql.ResultSet;\n-import java.util.ArrayList;\n import java.util.List;\n \n import javax.ejb.Local;\n import javax.inject.Inject;\n \n-import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n import com.cloud.network.rules.FirewallRule.State;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.utils.db.GenericDaoBase;\n import com.cloud.utils.db.SearchBuilder;\n import com.cloud.utils.db.SearchCriteria;\n import com.cloud.utils.db.SearchCriteria.Op;\n-import com.cloud.utils.db.Transaction;\n \n @Component\n @Local(value = { LoadBalancerDao.class })\n public class LoadBalancerDaoImpl extends GenericDaoBase<LoadBalancerVO, Long> implements LoadBalancerDao {\n-    private static final Logger s_logger = Logger.getLogger(LoadBalancerDaoImpl.class);\n-    private static final String LIST_INSTANCES_BY_LOAD_BALANCER = \"SELECT vm.id \" +\n-            \"    FROM vm_instance vm, load_balancer lb, ip_forwarding fwd, user_ip_address ip \" +\n-            \"    WHERE lb.id = ? AND \" +\n-            \"          fwd.group_id = lb.id AND \" +\n-            \"          fwd.forwarding = 0 AND \" +\n-            \"          fwd.private_ip_address = vm.private_ip_address AND \" +\n-            \"          lb.ip_address = ip.public_ip_address AND \" +\n-            \"          ip.data_center_id = vm.data_center_id \";\n     private final SearchBuilder<LoadBalancerVO> ListByIp;\n-    private final SearchBuilder<LoadBalancerVO> IpAndPublicPortSearch;\n-    private final SearchBuilder<LoadBalancerVO> AccountAndNameSearch;\n     protected final SearchBuilder<LoadBalancerVO> TransitionStateSearch;\n \n     @Inject protected FirewallRulesCidrsDao _portForwardingRulesCidrsDao;\n@@ -57,45 +42,16 @@ protected LoadBalancerDaoImpl() {\n         ListByIp = createSearchBuilder();\n         ListByIp.and(\"ipAddressId\", ListByIp.entity().getSourceIpAddressId(), SearchCriteria.Op.EQ);\n         ListByIp.and(\"networkId\", ListByIp.entity().getNetworkId(), SearchCriteria.Op.EQ);\n+        ListByIp.and(\"scheme\", ListByIp.entity().getScheme(), SearchCriteria.Op.EQ);\n         ListByIp.done();\n \n-        IpAndPublicPortSearch = createSearchBuilder();\n-        IpAndPublicPortSearch.and(\"ipAddressId\", IpAndPublicPortSearch.entity().getSourceIpAddressId(), SearchCriteria.Op.EQ);\n-        IpAndPublicPortSearch.and(\"publicPort\", IpAndPublicPortSearch.entity().getSourcePortStart(), SearchCriteria.Op.EQ);\n-        IpAndPublicPortSearch.done();\n-\n-        AccountAndNameSearch = createSearchBuilder();\n-        AccountAndNameSearch.and(\"accountId\", AccountAndNameSearch.entity().getAccountId(), SearchCriteria.Op.EQ);\n-        AccountAndNameSearch.and(\"name\", AccountAndNameSearch.entity().getName(), SearchCriteria.Op.EQ);\n-        AccountAndNameSearch.done();\n-\n         TransitionStateSearch = createSearchBuilder();\n         TransitionStateSearch.and(\"networkId\", TransitionStateSearch.entity().getNetworkId(), Op.EQ);\n         TransitionStateSearch.and(\"state\", TransitionStateSearch.entity().getState(), Op.IN);\n+        TransitionStateSearch.and(\"scheme\", TransitionStateSearch.entity().getScheme(), Op.EQ);\n         TransitionStateSearch.done();\n     }\n-\n-    @Override\n-    public List<Long> listInstancesByLoadBalancer(long loadBalancerId) {\n-        Transaction txn = Transaction.currentTxn();\n-        String sql = LIST_INSTANCES_BY_LOAD_BALANCER;\n-        PreparedStatement pstmt = null;\n-        List<Long> instanceList = new ArrayList<Long>();\n-        try {\n-            pstmt = txn.prepareAutoCloseStatement(sql);\n-            pstmt.setLong(1, loadBalancerId);\n-\n-            ResultSet rs = pstmt.executeQuery();\n-            while (rs.next()) {\n-                Long vmId = rs.getLong(1);\n-                instanceList.add(vmId);\n-            }\n-        } catch (Exception ex) {\n-            s_logger.error(\"error getting recent usage network stats\", ex);\n-        }\n-        return instanceList;\n-    }\n-\n+    \n     @Override\n     public List<LoadBalancerVO> listByIpAddress(long ipAddressId) {\n         SearchCriteria<LoadBalancerVO> sc = ListByIp.create();\n@@ -104,33 +60,19 @@ protected LoadBalancerDaoImpl() {\n     }\n \n     @Override\n-    public List<LoadBalancerVO> listByNetworkId(long networkId) {\n+    public List<LoadBalancerVO> listByNetworkIdAndScheme(long networkId, Scheme scheme) {\n         SearchCriteria<LoadBalancerVO> sc = ListByIp.create();\n         sc.setParameters(\"networkId\", networkId);\n+        sc.setParameters(\"scheme\", scheme);\n         return listBy(sc);\n     }\n \n     @Override\n-    public LoadBalancerVO findByIpAddressAndPublicPort(long ipAddressId, String publicPort) {\n-        SearchCriteria<LoadBalancerVO> sc = IpAndPublicPortSearch.create();\n-        sc.setParameters(\"ipAddressId\", ipAddressId);\n-        sc.setParameters(\"publicPort\", publicPort);\n-        return findOneBy(sc);\n-    }\n-\n-    @Override\n-    public LoadBalancerVO findByAccountAndName(Long accountId, String name) {\n-        SearchCriteria<LoadBalancerVO> sc = AccountAndNameSearch.create();\n-        sc.setParameters(\"accountId\", accountId);\n-        sc.setParameters(\"name\", name);\n-        return findOneBy(sc);\n-    }\n-\n-    @Override\n-    public List<LoadBalancerVO> listInTransitionStateByNetworkId(long networkId) {\n+    public List<LoadBalancerVO> listInTransitionStateByNetworkIdAndScheme(long networkId, Scheme scheme) {\n         SearchCriteria<LoadBalancerVO> sc = TransitionStateSearch.create();\n         sc.setParameters(\"networkId\", networkId);\n         sc.setParameters(\"state\", State.Add.toString(), State.Revoke.toString());\n+        sc.setParameters(\"scheme\", scheme);\n         return listBy(sc);\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/LoadBalancerDaoImpl.java",
                "sha": "c20d8b23d6adb8f3b136b43c62d40a2be02637b7",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/LoadBalancerVO.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/LoadBalancerVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/network/dao/LoadBalancerVO.java",
                "patch": "@@ -19,13 +19,21 @@\n import javax.persistence.Column;\n import javax.persistence.DiscriminatorValue;\n import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n import javax.persistence.PrimaryKeyJoinColumn;\n import javax.persistence.Table;\n \n import com.cloud.network.rules.FirewallRuleVO;\n import com.cloud.network.rules.LoadBalancer;\n import com.cloud.utils.net.NetUtils;\n \n+/**\n+ * This VO represent Public Load Balancer\n+ * It references source ip address by its Id. \n+ * To get the VO for Internal Load Balancer rule, please refer to LoadBalancerRuleVO\n+ *\n+ */\n @Entity\n @Table(name=(\"load_balancing_rules\"))\n @DiscriminatorValue(value=\"LoadBalancing\")\n@@ -46,6 +54,10 @@\n     \n     @Column(name=\"default_port_end\")\n     private int defaultPortEnd;\n+    \n+    @Enumerated(value=EnumType.STRING)\n+    @Column(name=\"scheme\")\n+    Scheme scheme = Scheme.Public;\n \n     public LoadBalancerVO() { \n     }\n@@ -57,6 +69,7 @@ public LoadBalancerVO(String xId, String name, String description, long srcIpId,\n         this.algorithm = algorithm;\n         this.defaultPortStart = dstPort;\n         this.defaultPortEnd = dstPort;\n+        this.scheme = Scheme.Public;\n     }\n     \n     @Override\n@@ -94,5 +107,10 @@ public void setAlgorithm(String algorithm) {\n \n     public void setDescription(String description) {\n         this.description = description;\n+    }\n+\n+    @Override\n+    public Scheme getScheme() {\n+        return scheme;\n     }  \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/LoadBalancerVO.java",
                "sha": "fee88cf7b0ac03144a4aad05fba8459b6564ed55",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/NetworkServiceMapDao.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/NetworkServiceMapDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/network/dao/NetworkServiceMapDao.java",
                "patch": "@@ -35,4 +35,5 @@\n \tvoid deleteByNetworkId(long networkId);\n \tList<String> getDistinctProviders(long networkId);\n \tString isProviderForNetwork(long networkId, Provider provider);\n+\tList<String> getProvidersForServiceInNetwork(long networkId, Service service);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/NetworkServiceMapDao.java",
                "sha": "6d401c40d8b517e4fb885b0c1b571158bd3f17ec",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/NetworkServiceMapDaoImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/NetworkServiceMapDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/network/dao/NetworkServiceMapDaoImpl.java",
                "patch": "@@ -56,6 +56,7 @@ protected NetworkServiceMapDaoImpl() {\n         DistinctProvidersSearch = createSearchBuilder(String.class);\n         DistinctProvidersSearch.and(\"networkId\", DistinctProvidersSearch.entity().getNetworkId(), SearchCriteria.Op.EQ);\n         DistinctProvidersSearch.and(\"provider\", DistinctProvidersSearch.entity().getProvider(), SearchCriteria.Op.EQ);\n+        DistinctProvidersSearch.and(\"service\", DistinctProvidersSearch.entity().getService(), SearchCriteria.Op.EQ);\n         DistinctProvidersSearch.selectField(DistinctProvidersSearch.entity().getProvider());\n         DistinctProvidersSearch.done();\n     }\n@@ -163,5 +164,13 @@ public String isProviderForNetwork(long networkId, Provider provider) {\n         \treturn results.get(0);\n         }\n     }\n+\n+    @Override\n+    public List<String> getProvidersForServiceInNetwork(long networkId, Service service) {\n+        SearchCriteria<String> sc = DistinctProvidersSearch.create();\n+        sc.setParameters(\"networkId\", networkId);\n+        sc.setParameters(\"service\", service.getName());\n+        return customSearch(sc, null);\n+    }\n     \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/NetworkServiceMapDaoImpl.java",
                "sha": "3cdd73885c83f5000ce506ec26a5f9a5e9821beb",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/NetworkVO.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/dao/NetworkVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 3,
                "filename": "engine/schema/src/com/cloud/network/dao/NetworkVO.java",
                "patch": "@@ -32,9 +32,6 @@\n import org.apache.cloudstack.acl.ControlledEntity;\n \n import com.cloud.network.Network;\n-import com.cloud.network.Networks;\n-import com.cloud.network.Network.GuestType;\n-import com.cloud.network.Network.State;\n import com.cloud.network.Networks.BroadcastDomainType;\n import com.cloud.network.Networks.Mode;\n import com.cloud.network.Networks.TrafficType;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/dao/NetworkVO.java",
                "sha": "8e728abd98484172fc78fadb64dda558a21e7bcc",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/rules/FirewallRuleVO.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/network/rules/FirewallRuleVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 2,
                "filename": "engine/schema/src/com/cloud/network/rules/FirewallRuleVO.java",
                "patch": "@@ -20,7 +20,6 @@\n import java.util.List;\n import java.util.UUID;\n \n-import javax.inject.Inject;\n import javax.persistence.Column;\n import javax.persistence.DiscriminatorColumn;\n import javax.persistence.DiscriminatorType;\n@@ -35,7 +34,6 @@\n import javax.persistence.Table;\n import javax.persistence.Transient;\n \n-import com.cloud.network.dao.FirewallRulesCidrsDao;\n import com.cloud.utils.db.GenericDao;\n import com.cloud.utils.net.NetUtils;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/network/rules/FirewallRuleVO.java",
                "sha": "9f73029349f95499f57a82351cc1b88503e65bf4",
                "status": "modified"
            },
            {
                "additions": 90,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/NetworkOfferingDetailsVO.java",
                "changes": 90,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/offerings/NetworkOfferingDetailsVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/offerings/NetworkOfferingDetailsVO.java",
                "patch": "@@ -0,0 +1,90 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.offerings;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n+import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n+\n+@Entity\n+@Table(name=\"network_offering_details\")\n+public class NetworkOfferingDetailsVO implements InternalIdentity {\n+    @Id\n+    @GeneratedValue(strategy=GenerationType.IDENTITY)\n+    @Column(name=\"id\")\n+    private long id;\n+    \n+    @Column(name=\"network_offering_id\")\n+    private long offeringId;\n+    \n+    @Enumerated(value=EnumType.STRING)\n+    @Column(name=\"name\")\n+    private NetworkOffering.Detail name;\n+    \n+    @Column(name=\"value\", length=1024)\n+    private String value;\n+    \n+    public NetworkOfferingDetailsVO() {}\n+    \n+    public NetworkOfferingDetailsVO(long offeringId, Detail detailName, String value) {\n+        this.offeringId = offeringId;\n+        this.name = detailName;\n+        this.value = value;\n+    }\n+\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public long getOfferingId() {\n+        return offeringId;\n+    }\n+\n+    public NetworkOffering.Detail getName() {\n+        return name;\n+    }\n+\n+    public String getValue() {\n+        return value;\n+    }\n+\n+    public void setId(long id) {\n+        this.id = id;\n+    }\n+\n+    public void setOfferingId(long offeringId) {\n+        this.offeringId = offeringId;\n+    }\n+\n+    public void setName(NetworkOffering.Detail name) {\n+        this.name = name;\n+    }\n+\n+    public void setValue(String value) {\n+        this.value = value;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/NetworkOfferingDetailsVO.java",
                "sha": "6cd5abc4223495c65f9169f11b3a7c49bb3b9097",
                "status": "added"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/NetworkOfferingVO.java",
                "changes": 44,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/offerings/NetworkOfferingVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 9,
                "filename": "engine/schema/src/com/cloud/offerings/NetworkOfferingVO.java",
                "patch": "@@ -16,15 +16,23 @@\n // under the License.\n package com.cloud.offerings;\n \n+import java.util.Date;\n+import java.util.UUID;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+\n import com.cloud.network.Network;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.utils.db.GenericDao;\n \n-import javax.persistence.*;\n-import java.util.Date;\n-import java.util.UUID;\n-\n @Entity\n @Table(name = \"network_offerings\")\n public class NetworkOfferingVO implements NetworkOffering {\n@@ -126,6 +134,12 @@\n     public String getDisplayText() {\n         return displayText;\n     }\n+    \n+    @Column(name = \"internal_lb\")\n+    boolean internalLb;\n+    \n+    @Column(name = \"public_lb\")\n+    boolean publicLb;\n \n     @Override\n     public long getId() {\n@@ -262,7 +276,7 @@ public void setRedundantRouter(boolean redundantRouter) {\n     }\n \n     public NetworkOfferingVO(String name, String displayText, TrafficType trafficType, boolean systemOnly, boolean specifyVlan, Integer rateMbps, Integer multicastRateMbps, boolean isDefault,\n-            Availability availability, String tags, Network.GuestType guestType, boolean conserveMode, boolean specifyIpRanges, boolean isPersistent) {\n+            Availability availability, String tags, Network.GuestType guestType, boolean conserveMode, boolean specifyIpRanges, boolean isPersistent, boolean internalLb, boolean publicLb) {\n         this.name = name;\n         this.displayText = displayText;\n         this.rateMbps = rateMbps;\n@@ -286,12 +300,14 @@ public NetworkOfferingVO(String name, String displayText, TrafficType trafficTyp\n         this.inline = false;\n         this.specifyIpRanges = specifyIpRanges;\n         this.isPersistent=isPersistent;\n+        this.publicLb = publicLb;\n+        this.internalLb = internalLb;\n     }\n \n     public NetworkOfferingVO(String name, String displayText, TrafficType trafficType, boolean systemOnly, boolean specifyVlan, Integer rateMbps, Integer multicastRateMbps, boolean isDefault,\n             Availability availability, String tags, Network.GuestType guestType, boolean conserveMode, boolean dedicatedLb, boolean sharedSourceNat, boolean redundantRouter, boolean elasticIp, boolean elasticLb,\n-            boolean specifyIpRanges, boolean inline, boolean isPersistent, boolean associatePublicIP) {\n-        this(name, displayText, trafficType, systemOnly, specifyVlan, rateMbps, multicastRateMbps, isDefault, availability, tags, guestType, conserveMode, specifyIpRanges, isPersistent);\n+            boolean specifyIpRanges, boolean inline, boolean isPersistent, boolean associatePublicIP, boolean publicLb, boolean internalLb) {\n+        this(name, displayText, trafficType, systemOnly, specifyVlan, rateMbps, multicastRateMbps, isDefault, availability, tags, guestType, conserveMode, specifyIpRanges, isPersistent, internalLb, publicLb);\n         this.dedicatedLB = dedicatedLb;\n         this.sharedSourceNat = sharedSourceNat;\n         this.redundantRouter = redundantRouter;\n@@ -313,13 +329,13 @@ public NetworkOfferingVO() {\n      *            TODO\n      */\n     public NetworkOfferingVO(String name, TrafficType trafficType, boolean specifyIpRanges) {\n-        this(name, \"System Offering for \" + name, trafficType, true, false, 0, 0, true, Availability.Required, null, null, true, specifyIpRanges, false);\n+        this(name, \"System Offering for \" + name, trafficType, true, false, 0, 0, true, Availability.Required, null, null, true, specifyIpRanges, false, false, false);\n         this.state = State.Enabled;\n     }\n \n     public NetworkOfferingVO(String name, Network.GuestType guestType) {\n         this(name, \"System Offering for \" + name, TrafficType.Guest, true, true, 0, 0, true, Availability.Optional,\n-                null, Network.GuestType.Isolated, true, false, false);\n+                null, Network.GuestType.Isolated, true, false, false, false, false);\n         this.state = State.Enabled;\n     }\n \n@@ -388,4 +404,14 @@ public boolean getIsPersistent() {\n         return isPersistent;\n     }\n \n+    @Override\n+    public boolean getInternalLb() {\n+        return internalLb;\n+    }\n+\n+    @Override\n+    public boolean getPublicLb() {\n+        return publicLb;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/NetworkOfferingVO.java",
                "sha": "3ae0bf38b0b495fc2e5fdc1dfd78cd13caaed203",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDao.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDao.java",
                "patch": "@@ -17,11 +17,13 @@\n package com.cloud.offerings.dao;\n \n import java.util.List;\n+import java.util.Map;\n \n import com.cloud.network.Network;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offering.NetworkOffering.Availability;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.utils.db.GenericDao;\n \n@@ -57,4 +59,6 @@\n \n     List<NetworkOfferingVO> listByTrafficTypeGuestTypeAndState(NetworkOffering.State state, TrafficType trafficType, Network.GuestType type);\n \n+    NetworkOfferingVO persist(NetworkOfferingVO off, Map<Detail, String> details);\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDao.java",
                "sha": "5bb79ced69f8742d3100df009e13137d3685f14c",
                "status": "modified"
            },
            {
                "additions": 24,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDaoImpl.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDaoImpl.java",
                "patch": "@@ -17,8 +17,10 @@\n package com.cloud.offerings.dao;\n \n import java.util.List;\n+import java.util.Map;\n \n import javax.ejb.Local;\n+import javax.inject.Inject;\n import javax.persistence.EntityExistsException;\n \n import org.springframework.stereotype.Component;\n@@ -27,6 +29,8 @@\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offering.NetworkOffering.Availability;\n+import com.cloud.offering.NetworkOffering.Detail;\n+import com.cloud.offerings.NetworkOfferingDetailsVO;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.utils.db.DB;\n import com.cloud.utils.db.GenericDaoBase;\n@@ -45,6 +49,7 @@\n     final SearchBuilder<NetworkOfferingVO> AvailabilitySearch;\n     final SearchBuilder<NetworkOfferingVO> AllFieldsSearch;\n     private final GenericSearchBuilder<NetworkOfferingVO, Long> UpgradeSearch;\n+    @Inject NetworkOfferingDetailsDao _detailsDao;\n \n     protected NetworkOfferingDaoImpl() {\n         super();\n@@ -165,5 +170,24 @@ public boolean remove(Long networkOfferingId) {\n         sc.setParameters(\"state\", state);\n         return listBy(sc, null);\n     }\n+    \n+    @Override\n+    @DB\n+    public NetworkOfferingVO persist(NetworkOfferingVO off, Map<Detail, String> details) {\n+        Transaction txn = Transaction.currentTxn();\n+        txn.start();\n+        //1) persist the offering\n+        NetworkOfferingVO vo = super.persist(off);\n+        \n+        //2) persist the details\n+        if (details != null && !details.isEmpty()) {\n+            for (NetworkOffering.Detail detail : details.keySet()) {\n+                _detailsDao.persist(new NetworkOfferingDetailsVO(off.getId(), detail, details.get(detail)));\n+            }\n+        }\n+       \n+        txn.commit();\n+        return vo;\n+    }\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDaoImpl.java",
                "sha": "ef8237a48f578ba1b75e1cc17297f59d58e72e29",
                "status": "modified"
            },
            {
                "additions": 31,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDao.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDao.java",
                "patch": "@@ -0,0 +1,31 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.offerings.dao;\n+\n+\n+import java.util.Map;\n+\n+import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n+import com.cloud.offerings.NetworkOfferingDetailsVO;\n+import com.cloud.utils.db.GenericDao;\n+\n+public interface NetworkOfferingDetailsDao extends GenericDao<NetworkOfferingDetailsVO, Long>{\n+\n+    Map<NetworkOffering.Detail,String> getNtwkOffDetails(long offeringId);\n+    String getDetail(long offeringId, Detail detailName);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDao.java",
                "sha": "ce209e04694578ffc734a862cdb0a544e30ea278",
                "status": "added"
            },
            {
                "additions": 79,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDaoImpl.java",
                "changes": 79,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDaoImpl.java",
                "patch": "@@ -0,0 +1,79 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.offerings.dao;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n+import com.cloud.offerings.NetworkOfferingDetailsVO;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.GenericSearchBuilder;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.SearchCriteria.Func;\n+import com.cloud.utils.db.SearchCriteria.Op;\n+\n+public class NetworkOfferingDetailsDaoImpl extends GenericDaoBase<NetworkOfferingDetailsVO, Long> implements NetworkOfferingDetailsDao{\n+    protected final SearchBuilder<NetworkOfferingDetailsVO> DetailSearch;\n+    private final GenericSearchBuilder<NetworkOfferingDetailsVO, String> ValueSearch;\n+\n+    \n+    public NetworkOfferingDetailsDaoImpl() {\n+        \n+        DetailSearch = createSearchBuilder();\n+        DetailSearch.and(\"offeringId\", DetailSearch.entity().getOfferingId(), SearchCriteria.Op.EQ);\n+        DetailSearch.and(\"name\", DetailSearch.entity().getName(), SearchCriteria.Op.EQ);\n+        DetailSearch.done();\n+        \n+        ValueSearch = createSearchBuilder(String.class);\n+        ValueSearch.select(null, Func.DISTINCT, ValueSearch.entity().getValue());\n+        ValueSearch.and(\"offeringId\", ValueSearch.entity().getOfferingId(), SearchCriteria.Op.EQ);\n+        ValueSearch.and(\"name\", ValueSearch.entity().getName(), Op.EQ);\n+        ValueSearch.done();\n+    }\n+    \n+    @Override\n+    public Map<NetworkOffering.Detail,String> getNtwkOffDetails(long offeringId) {\n+        SearchCriteria<NetworkOfferingDetailsVO> sc = DetailSearch.create();\n+        sc.setParameters(\"offeringId\", offeringId);\n+        \n+        List<NetworkOfferingDetailsVO> results = search(sc, null);\n+        Map<NetworkOffering.Detail, String> details = new HashMap<NetworkOffering.Detail, String>(results.size());\n+        for (NetworkOfferingDetailsVO result : results) {\n+            details.put(result.getName(), result.getValue());\n+        }\n+        \n+        return details;\n+    }\n+\n+    @Override\n+    public String getDetail(long offeringId, Detail detailName) {\n+        SearchCriteria<String> sc = ValueSearch.create();\n+        sc.setParameters(\"name\", detailName);\n+        sc.setParameters(\"offeringId\", offeringId);\n+        List<String> results = customSearch(sc, null);\n+        if (results.isEmpty()) {\n+            return null;\n+        } else {\n+            return results.get(0);\n+        }\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/offerings/dao/NetworkOfferingDetailsDaoImpl.java",
                "sha": "068f3908b8d28e2913e4636303a11a9847de9c62",
                "status": "added"
            },
            {
                "additions": 91,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/upgrade/dao/Upgrade410to420.java",
                "changes": 95,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/upgrade/dao/Upgrade410to420.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 4,
                "filename": "engine/schema/src/com/cloud/upgrade/dao/Upgrade410to420.java",
                "patch": "@@ -17,17 +17,18 @@\n \n package com.cloud.upgrade.dao;\n \n-import com.cloud.utils.exception.CloudRuntimeException;\n-import com.cloud.utils.script.Script;\n-import org.apache.log4j.Logger;\n-\n import java.io.File;\n import java.sql.Connection;\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.UUID;\n \n+import org.apache.log4j.Logger;\n+\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.script.Script;\n+\n public class Upgrade410to420 implements DbUpgrade {\n \tfinal static Logger s_logger = Logger.getLogger(Upgrade410to420.class);\n \n@@ -66,6 +67,8 @@ public void performDataMigration(Connection conn) {\n         updatePrimaryStore(conn);\n         addEgressFwRulesForSRXGuestNw(conn);\n         upgradeEIPNetworkOfferings(conn);\n+        upgradeDefaultVpcOffering(conn);\n+        upgradePhysicalNtwksWithInternalLbProvider(conn);\n     }\n \t\n \tprivate void updateSystemVmTemplates(Connection conn) {\n@@ -399,4 +402,88 @@ private void upgradeEIPNetworkOfferings(Connection conn) {\n             }\n         }\n     }\n+    \n+    \n+    private void upgradeDefaultVpcOffering(Connection conn) {\n+\n+        PreparedStatement pstmt = null;\n+        ResultSet rs = null;\n+\n+        try {\n+            pstmt = conn.prepareStatement(\"select distinct map.vpc_offering_id from `cloud`.`vpc_offering_service_map` map, `cloud`.`vpc_offerings` off where off.id=map.vpc_offering_id AND service='Lb'\");\n+            rs = pstmt.executeQuery();\n+            while (rs.next()) {\n+                long id = rs.getLong(1);\n+                //Add internal LB vm as a supported provider for the load balancer service\n+                pstmt = conn.prepareStatement(\"INSERT INTO `cloud`.`vpc_offering_service_map` (vpc_offering_id, service, provider) VALUES (?,?,?)\");\n+                pstmt.setLong(1, id);\n+                pstmt.setString(2, \"Lb\");\n+                pstmt.setString(3, \"InternalLbVm\");\n+                pstmt.executeUpdate();\n+            }\n+            \n+        } catch (SQLException e) {\n+            throw new CloudRuntimeException(\"Unable update the default VPC offering with the internal lb service\", e);\n+        } finally {\n+            try {\n+                if (rs != null) {\n+                    rs.close();\n+                }\n+                if (pstmt != null) {\n+                    pstmt.close();\n+                }\n+            } catch (SQLException e) {\n+            }\n+        }\n+    }\n+    \n+    \n+    private void upgradePhysicalNtwksWithInternalLbProvider(Connection conn) {\n+\n+        PreparedStatement pstmt = null;\n+        ResultSet rs = null;\n+\n+        try {\n+            pstmt = conn.prepareStatement(\"SELECT id FROM `cloud`.`physical_network` where removed is null\");\n+            rs = pstmt.executeQuery();\n+            while (rs.next()) {\n+                long pNtwkId = rs.getLong(1);\n+                String uuid = UUID.randomUUID().toString();\n+                //Add internal LB VM to the list of physical network service providers\n+                pstmt = conn.prepareStatement(\"INSERT INTO `cloud`.`physical_network_service_providers` \" +\n+                \t\t\"(uuid, physical_network_id, provider_name, state, load_balance_service_provided, destination_physical_network_id)\" +\n+                \t\t\" VALUES (?, ?, 'InternalLbVm', 'Enabled', 1, 0)\");\n+                pstmt.setString(1, uuid);\n+                pstmt.setLong(2, pNtwkId);\n+                pstmt.executeUpdate();\n+                \n+                //Add internal lb vm to the list of physical network elements\n+                PreparedStatement pstmt1 = conn.prepareStatement(\"SELECT id FROM `cloud`.`physical_network_service_providers`\" +\n+                \t\t\" WHERE physical_network_id=? AND provider_name='InternalLbVm'\");\n+                ResultSet rs1 = pstmt1.executeQuery();\n+                while (rs1.next()) {\n+                    long providerId = rs1.getLong(1);\n+                    uuid = UUID.randomUUID().toString();\n+                    pstmt1 = conn.prepareStatement(\"INSERT INTO `cloud`.`virtual_router_providers` (nsp_id, uuid, type, enabled) VALUES (?, ?, 'InternalLbVm', 1)\");\n+                    pstmt1.setLong(1, providerId);\n+                    pstmt1.setString(2, uuid);\n+                    pstmt1.executeUpdate();\n+                }\n+            }\n+            \n+        } catch (SQLException e) {\n+            throw new CloudRuntimeException(\"Unable existing physical networks with internal lb provider\", e);\n+        } finally {\n+            try {\n+                if (rs != null) {\n+                    rs.close();\n+                }\n+                if (pstmt != null) {\n+                    pstmt.close();\n+                }\n+            } catch (SQLException e) {\n+            }\n+        }\n+        \n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/upgrade/dao/Upgrade410to420.java",
                "sha": "3a164c413bb7ab9be6a8793065b458adfbc99d34",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/vm/dao/NicDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/dao/NicDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/vm/dao/NicDao.java",
                "patch": "@@ -30,7 +30,7 @@\n     \n     List<NicVO> listByNetworkId(long networkId);\n     \n-    NicVO findByInstanceIdAndNetworkId(long networkId, long instanceId);\n+    NicVO findByNtwkIdAndInstanceId(long networkId, long instanceId);\n     \n     NicVO findByInstanceIdAndNetworkIdIncludingRemoved(long networkId, long instanceId);\n     ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/vm/dao/NicDao.java",
                "sha": "12efe08f91ac47dc6fa72d8ceee3a912841d1d5d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/vm/dao/NicDaoImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/dao/NicDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/vm/dao/NicDaoImpl.java",
                "patch": "@@ -113,7 +113,7 @@ public void removeNicsForInstance(long instanceId) {\n     }\n     \n     @Override\n-    public NicVO findByInstanceIdAndNetworkId(long networkId, long instanceId) {\n+    public NicVO findByNtwkIdAndInstanceId(long networkId, long instanceId) {\n         SearchCriteria<NicVO> sc = AllFieldsSearch.create();\n         sc.setParameters(\"network\", networkId);\n         sc.setParameters(\"instance\", instanceId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/com/cloud/vm/dao/NicDaoImpl.java",
                "sha": "fa30168bf863485f86b0792274ff7e4109610bf9",
                "status": "modified"
            },
            {
                "additions": 133,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/org/apache/cloudstack/lb/ApplicationLoadBalancerRuleVO.java",
                "changes": 133,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/org/apache/cloudstack/lb/ApplicationLoadBalancerRuleVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/org/apache/cloudstack/lb/ApplicationLoadBalancerRuleVO.java",
                "patch": "@@ -0,0 +1,133 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.lb;\n+\n+import javax.persistence.Column;\n+import javax.persistence.DiscriminatorValue;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.PrimaryKeyJoinColumn;\n+import javax.persistence.Table;\n+\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n+\n+import com.cloud.network.rules.FirewallRuleVO;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.utils.net.NetUtils;\n+\n+/**\n+ * This VO represent Internal Load Balancer rule.\n+ * Instead of pointing to the public ip address id directly as External Load Balancer rule does, it refers to the ip address by its value/sourceNetworkid\n+ *\n+ */\n+@Entity\n+@Table(name=(\"load_balancing_rules\"))\n+@DiscriminatorValue(value=\"LoadBalancing\")\n+@PrimaryKeyJoinColumn(name=\"id\")\n+public class ApplicationLoadBalancerRuleVO extends FirewallRuleVO implements ApplicationLoadBalancerRule{\n+    @Column(name=\"name\")\n+    private String name;\n+\n+    @Column(name=\"description\", length=4096)\n+    private String description;\n+\n+    @Column(name=\"algorithm\")\n+    private String algorithm;\n+\n+    @Column(name=\"default_port_start\")\n+    private int defaultPortStart;\n+    \n+    @Column(name=\"default_port_end\")\n+    private int defaultPortEnd;\n+    \n+    @Column(name=\"source_ip_address_network_id\")\n+    Long sourceIpNetworkId;\n+    \n+    @Column(name=\"source_ip_address\")\n+    @Enumerated(value=EnumType.STRING)\n+    private Ip sourceIp = null;\n+    \n+    @Enumerated(value=EnumType.STRING)\n+    @Column(name=\"scheme\")\n+    Scheme scheme;\n+\n+\n+    public ApplicationLoadBalancerRuleVO() {  \n+    }\n+    \n+    public ApplicationLoadBalancerRuleVO(String name, String description, int srcPort, int instancePort, String algorithm,\n+            long networkId, long accountId, long domainId, Ip sourceIp, long sourceIpNtwkId, Scheme scheme) {\n+        super(null, null, srcPort, srcPort, NetUtils.TCP_PROTO, networkId, accountId, domainId, Purpose.LoadBalancing, null, null,null, null, null);\n+        \n+        this.name = name;\n+        this.description = description;\n+        this.algorithm = algorithm;\n+        this.defaultPortStart = instancePort;\n+        this.defaultPortEnd = instancePort;\n+        this.sourceIp = sourceIp;\n+        this.sourceIpNetworkId = sourceIpNtwkId;\n+        this.scheme = scheme;\n+    }\n+    \n+    \n+    @Override\n+    public Long getSourceIpNetworkId() {\n+        return sourceIpNetworkId;\n+    }\n+\n+    @Override\n+    public Ip getSourceIp() {\n+        return sourceIp;\n+    }\n+    \n+    @Override\n+    public String getName() {\n+        return name;\n+    }\n+\n+    @Override\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    @Override\n+    public String getAlgorithm() {\n+        return algorithm;\n+    }\n+\n+    @Override\n+    public int getDefaultPortStart() {\n+        return defaultPortStart;\n+    }\n+\n+    @Override\n+    public int getDefaultPortEnd() {\n+        return defaultPortEnd;\n+    }\n+\n+    @Override\n+    public Scheme getScheme() {\n+        return scheme;\n+    }\n+\n+    @Override\n+    public int getInstancePort() {\n+        return defaultPortStart;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/org/apache/cloudstack/lb/ApplicationLoadBalancerRuleVO.java",
                "sha": "37a747e42722696e516d9e705baaa4cbde1c4905",
                "status": "added"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDao.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDao.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDao.java",
                "patch": "@@ -0,0 +1,35 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.lb.dao;\n+\n+import java.util.List;\n+\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.utils.db.GenericDao;\n+import com.cloud.utils.net.Ip;\n+\n+public interface ApplicationLoadBalancerRuleDao extends GenericDao<ApplicationLoadBalancerRuleVO, Long>{\n+    List<ApplicationLoadBalancerRuleVO> listBySrcIpSrcNtwkId(Ip sourceIp, long sourceNetworkId);\n+    List<String> listLbIpsBySourceIpNetworkId(long sourceIpNetworkId);\n+    long countBySourceIp(Ip sourceIp, long sourceIpNetworkId);\n+    List<ApplicationLoadBalancerRuleVO> listBySourceIpAndNotRevoked(Ip sourceIp, long sourceNetworkId);\n+    List<String> listLbIpsBySourceIpNetworkIdAndScheme(long sourceIpNetworkId, Scheme scheme);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDao.java",
                "sha": "c385e62f6abaa0057a1f4228cd6093998f3c88ce",
                "status": "added"
            },
            {
                "additions": 115,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDaoImpl.java",
                "changes": 115,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDaoImpl.java",
                "patch": "@@ -0,0 +1,115 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.lb.dao;\n+\n+import java.util.List;\n+\n+import javax.ejb.Local;\n+\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.GenericSearchBuilder;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.SearchCriteria.Func;\n+import com.cloud.utils.db.SearchCriteria.Op;\n+import com.cloud.utils.net.Ip;\n+\n+@Component\n+@Local(value = { ApplicationLoadBalancerRuleDao.class })\n+public class ApplicationLoadBalancerRuleDaoImpl extends GenericDaoBase<ApplicationLoadBalancerRuleVO, Long> implements ApplicationLoadBalancerRuleDao{\n+    protected final SearchBuilder<ApplicationLoadBalancerRuleVO> AllFieldsSearch;\n+    final GenericSearchBuilder<ApplicationLoadBalancerRuleVO, String> listIps;\n+    final GenericSearchBuilder<ApplicationLoadBalancerRuleVO, Long> CountBy;\n+    protected final SearchBuilder<ApplicationLoadBalancerRuleVO> NotRevokedSearch;\n+\n+\n+    \n+    protected ApplicationLoadBalancerRuleDaoImpl() {\n+        AllFieldsSearch = createSearchBuilder();\n+        AllFieldsSearch.and(\"sourceIp\", AllFieldsSearch.entity().getSourceIp(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.and(\"sourceIpNetworkId\", AllFieldsSearch.entity().getSourceIpNetworkId(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.and(\"networkId\", AllFieldsSearch.entity().getNetworkId(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.and(\"scheme\", AllFieldsSearch.entity().getScheme(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.done();\n+        \n+        listIps = createSearchBuilder(String.class);\n+        listIps.select(null, Func.DISTINCT, listIps.entity().getSourceIp());\n+        listIps.and(\"sourceIpNetworkId\", listIps.entity().getSourceIpNetworkId(), Op.EQ);\n+        listIps.and(\"scheme\", listIps.entity().getScheme(), Op.EQ);\n+        listIps.done();\n+        \n+        CountBy = createSearchBuilder(Long.class);\n+        CountBy.select(null, Func.COUNT, CountBy.entity().getId());\n+        CountBy.and(\"sourceIp\", CountBy.entity().getSourceIp(), Op.EQ);\n+        CountBy.and(\"sourceIpNetworkId\", CountBy.entity().getSourceIpNetworkId(), Op.EQ);\n+        CountBy.done();\n+        \n+        NotRevokedSearch = createSearchBuilder();\n+        NotRevokedSearch.and(\"sourceIp\", NotRevokedSearch.entity().getSourceIp(), SearchCriteria.Op.EQ);\n+        NotRevokedSearch.and(\"sourceIpNetworkId\", NotRevokedSearch.entity().getSourceIpNetworkId(), SearchCriteria.Op.EQ);\n+        NotRevokedSearch.and(\"state\", NotRevokedSearch.entity().getState(), SearchCriteria.Op.NEQ);\n+        NotRevokedSearch.done();\n+    }\n+\n+    @Override\n+    public List<ApplicationLoadBalancerRuleVO> listBySrcIpSrcNtwkId(Ip sourceIp, long sourceNetworkId) {\n+        SearchCriteria<ApplicationLoadBalancerRuleVO> sc = AllFieldsSearch.create();\n+        sc.setParameters(\"sourceIp\", sourceIp);\n+        sc.setParameters(\"sourceIpNetworkId\", sourceNetworkId);\n+        return listBy(sc);\n+    }\n+\n+    @Override\n+    public List<String> listLbIpsBySourceIpNetworkId(long sourceIpNetworkId) {\n+        SearchCriteria<String> sc = listIps.create();\n+        sc.setParameters(\"sourceIpNetworkId\", sourceIpNetworkId);\n+        return customSearch(sc, null);\n+    }\n+\n+    @Override\n+    public long countBySourceIp(Ip sourceIp, long sourceIpNetworkId) {\n+        SearchCriteria<Long> sc = CountBy.create();\n+        sc.setParameters(\"sourceIp\", sourceIp);\n+        sc.setParameters(\"sourceIpNetworkId\", sourceIpNetworkId);\n+        List<Long> results = customSearch(sc, null);\n+        return results.get(0);\n+    }\n+\n+    @Override\n+    public List<ApplicationLoadBalancerRuleVO> listBySourceIpAndNotRevoked(Ip sourceIp, long sourceNetworkId) {\n+        SearchCriteria<ApplicationLoadBalancerRuleVO> sc = NotRevokedSearch.create();\n+        sc.setParameters(\"sourceIp\", sourceIp);\n+        sc.setParameters(\"sourceIpNetworkId\", sourceNetworkId);\n+        sc.setParameters(\"state\", FirewallRule.State.Revoke);\n+        return listBy(sc);\n+    }\n+\n+    @Override\n+    public List<String> listLbIpsBySourceIpNetworkIdAndScheme(long sourceIpNetworkId, Scheme scheme) {\n+        SearchCriteria<String> sc = listIps.create();\n+        sc.setParameters(\"sourceIpNetworkId\", sourceIpNetworkId);\n+        sc.setParameters(\"scheme\", scheme);\n+        return customSearch(sc, null);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/engine/schema/src/org/apache/cloudstack/lb/dao/ApplicationLoadBalancerRuleDaoImpl.java",
                "sha": "880c67e732cd63b8fb9071d9fc2405f54d57577a",
                "status": "added"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/etc/init.d/cloud-early-config",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/patches/systemvm/debian/config/etc/init.d/cloud-early-config?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "patches/systemvm/debian/config/etc/init.d/cloud-early-config",
                "patch": "@@ -901,6 +901,28 @@ setup_elbvm() {\n   chkconfig portmap off\n }\n \n+setup_ilbvm() {\n+  log_it \"Setting up Internal Load Balancer system vm\"\n+  local hyp=$1\n+  setup_common eth0 eth1\n+  #eth0 = guest network, eth1=control network\n+\n+  sed -i  /$NAME/d /etc/hosts\n+  echo \"$ETH0_IP $NAME\" >> /etc/hosts\n+\n+  cp /etc/iptables/iptables-ilbvm /etc/iptables/rules.v4\n+  cp /etc/iptables/iptables-ilbvm /etc/iptables/rules\n+  setup_sshd $ETH1_IP \"eth1\"\n+  \n+  enable_fwding 0\n+  enable_svc haproxy 1\n+  enable_svc dnsmasq 0\n+  enable_svc cloud-passwd-srvr 0\n+  enable_svc cloud 0\n+  chkconfig nfs-common off\n+  chkconfig portmap off\n+}\n+\n setup_default() {\n   cat > /etc/network/interfaces << EOF\n auto lo\n@@ -951,6 +973,10 @@ start() {\n          [ \"$NAME\" == \"\" ] && NAME=elb\n          setup_elbvm\n \t  ;;\n+     ilbvm)\n+         [ \"$NAME\" == \"\" ] && NAME=ilb\n+         setup_ilbvm\n+\t  ;;\n      unknown)\n          [ \"$NAME\" == \"\" ] && NAME=systemvm\n          setup_default;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/etc/init.d/cloud-early-config",
                "sha": "a457f228653a800151c3e44b5b62a6b8fd64115d",
                "status": "modified"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/etc/iptables/iptables-ilbvm",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/patches/systemvm/debian/config/etc/iptables/iptables-ilbvm?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "patches/systemvm/debian/config/etc/iptables/iptables-ilbvm",
                "patch": "@@ -0,0 +1,33 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+# \n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+\n+*nat\n+:PREROUTING ACCEPT [0:0]\n+:POSTROUTING ACCEPT [0:0]\n+:OUTPUT ACCEPT [0:0]\n+COMMIT\n+*filter\n+:INPUT DROP [0:0]\n+:FORWARD DROP [0:0]\n+:OUTPUT ACCEPT [0:0]\n+-A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT\n+-A INPUT -i eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT\n+-A INPUT -p icmp -j ACCEPT\n+-A INPUT -i lo -j ACCEPT\n+-A INPUT -i eth1 -p tcp -m state --state NEW --dport 3922 -j ACCEPT\n+COMMIT\n+",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/etc/iptables/iptables-ilbvm",
                "sha": "8d5ca651c7549bd36d86da1645d3bbfa2cb9e219",
                "status": "added"
            },
            {
                "additions": 211,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/opt/cloud/bin/ilb.sh",
                "changes": 211,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/patches/systemvm/debian/config/opt/cloud/bin/ilb.sh?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "patches/systemvm/debian/config/opt/cloud/bin/ilb.sh",
                "patch": "@@ -0,0 +1,211 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+\n+source /root/func.sh\n+\n+lock=\"biglock\"\n+locked=$(getLockFile $lock)\n+if [ \"$locked\" != \"1\" ]\n+then\n+    exit 1\n+fi\n+\n+usage() {\n+  printf \"Usage: %s:  -a <added public ip address ip:port> -d <removed ip:port> -f <load balancer config> -s <stats ip ip:port:cidr>  \\n\" $(basename $0) >&2\n+}\n+\n+#set -x\n+\n+fw_remove_backup() {\n+  logger -t cloud \"$(basename $0): Entering fw_remove_backup\"\n+  local lb_vif_list=eth0\n+  for vif in $lb_vif_list; do \n+    sudo iptables -F back_load_balancer_$vif 2> /dev/null\n+    sudo iptables -D INPUT -i $vif -p tcp  -j back_load_balancer_$vif 2> /dev/null\n+    sudo iptables -X back_load_balancer_$vif 2> /dev/null\n+  done\n+  sudo iptables -F back_lb_stats 2> /dev/null\n+  sudo iptables -D INPUT -p tcp  -j back_lb_stats 2> /dev/null\n+  sudo iptables -X back_lb_stats 2> /dev/null\n+}\n+\n+fw_restore() {\n+  logger -t cloud \"$(basename $0): Entering fw_restore\"\n+  local lb_vif_list=\"eth0\"\n+  for vif in $lb_vif_list; do \n+    sudo iptables -F load_balancer_$vif 2> /dev/null\n+    sudo iptables -D INPUT -i $vif -p tcp  -j load_balancer_$vif 2> /dev/null\n+    sudo iptables -X load_balancer_$vif 2> /dev/null\n+    sudo iptables -E back_load_balancer_$vif load_balancer_$vif 2> /dev/null\n+  done\n+  sudo iptables -F lb_stats 2> /dev/null\n+  sudo iptables -D INPUT -p tcp  -j lb_stats 2> /dev/null\n+  sudo iptables -X lb_stats 2> /dev/null\n+  sudo iptables -E back_lb_stats lb_stats 2> /dev/null\n+}\n+\n+# firewall entry to ensure that haproxy can receive on specified port\n+fw_entry() {\n+  logger -t cloud \"$(basename $0): Entering fw_entry\"\n+  local added=$1\n+  local removed=$2\n+  local stats=$3\n+  \n+  if [ \"$added\" == \"none\" ]\n+  then\n+  \tadded=\"\"\n+  fi\n+  \n+  if [ \"$removed\" == \"none\" ]\n+  then\n+  \tremoved=\"\"\n+  fi\n+  \n+  local a=$(echo $added | cut -d, -f1- --output-delimiter=\" \")\n+  local r=$(echo $removed | cut -d, -f1- --output-delimiter=\" \")\n+\n+# back up the iptable rules by renaming before creating new. \n+  local lb_vif_list=eth0\n+  for vif in $lb_vif_list; do \n+    sudo iptables -E load_balancer_$vif back_load_balancer_$vif 2> /dev/null\n+    sudo iptables -N load_balancer_$vif 2> /dev/null\n+    sudo iptables -A INPUT -i $vif -p tcp  -j load_balancer_$vif\n+  done\n+  sudo iptables -E lb_stats back_lb_stats 2> /dev/null\n+  sudo iptables -N lb_stats 2> /dev/null\n+  sudo iptables -A INPUT  -p tcp  -j lb_stats\n+\n+  for i in $a\n+  do\n+    local pubIp=$(echo $i | cut -d: -f1)\n+    local dport=$(echo $i | cut -d: -f2)    \n+    local lb_vif_list=\"eth0\"\n+    for vif in $lb_vif_list; do \n+      sudo iptables -A load_balancer_$vif  -p tcp -d $pubIp --dport $dport -j ACCEPT\n+      if [ $? -gt 0 ]\n+      then\n+        return 1\n+      fi\n+    done      \n+  done\n+  local pubIp=$(echo $stats | cut -d: -f1)\n+  local dport=$(echo $stats | cut -d: -f2)    \n+  local cidrs=$(echo $stats | cut -d: -f3 | sed 's/-/,/')\n+  sudo iptables -A lb_stats -s $cidrs -p tcp -m state --state NEW -d $pubIp --dport $dport -j ACCEPT\n+ \n+  return 0\n+}\n+\n+#Hot reconfigure HA Proxy in the routing domain\n+reconfig_lb() {\n+  /root/reconfigLB.sh\n+  return $?\n+}\n+\n+# Restore the HA Proxy to its previous state, and revert iptables rules on loadbalancer\n+restore_lb() {\n+  logger -t cloud \"Restoring HA Proxy to previous state\"\n+  # Copy the old version of haproxy.cfg into the file that reconfigLB.sh uses\n+  cp /etc/haproxy/haproxy.cfg.old /etc/haproxy/haproxy.cfg.new\n+   \n+  if [ $? -eq 0 ]\n+  then\n+    # Run reconfigLB.sh again\n+    /root/reconfigLB.sh\n+  fi\n+}\n+\n+\n+logger -t cloud \"$(basename $0): Entering $(dirname $0)/$(basename $0)\"\n+\n+iflag=\n+aflag=\n+dflag=\n+sflag=\n+\n+while getopts 'i:a:d:s:' OPTION\n+do\n+  case $OPTION in\n+  i)\tiflag=1\n+\t\tdomRIp=\"$OPTARG\" #unused but passed in\n+\t\t;;\n+  a)\taflag=1\n+\t\taddedIps=\"$OPTARG\"\n+\t\t;;\n+  d)\tdflag=1\n+\t\tremovedIps=\"$OPTARG\"\n+\t\t;;\n+\n+  s)\tsflag=1\n+\t\tstatsIp=\"$OPTARG\"\n+\t\t;;\n+  ?)\tusage\n+                unlock_exit 2 $lock $locked\n+\t\t;;\n+  esac\n+done\n+\n+if [[ \"$aflag$dflag\" != \"1\" && \"$aflag$dflag\" != \"11\" ]]\n+then\n+   usage\n+   unlock_exit 2 $lock $locked\n+fi\n+\n+if [ \"$addedIps\" == \"\" ]\n+then\n+  addedIps=\"none\"\n+fi\n+\n+\n+if [ \"$removedIps\" == \"\" ]\n+then\n+  removedIps=\"none\"\n+fi\n+\n+\n+# hot reconfigure haproxy\n+reconfig_lb $cfgfile\n+\n+if [ $? -gt 0 ]\n+then\n+  logger -t cloud \"Reconfiguring ilb failed\"\n+  unlock_exit 1 $lock $locked\n+fi\n+\n+logger -t cloud \"HAProxy reconfigured successfully, configuring firewall\"\n+\n+# iptables entry to ensure that haproxy receives traffic\n+fw_entry $addedIps $removedIps $statsIp\n+  \t\n+if [ $? -gt 0 ]\n+then\n+  logger -t cloud \"Failed to apply firewall rules for internal load balancing, reverting HA Proxy config\"\n+  # Restore the LB\n+  restore_lb\n+\n+  logger -t cloud \"Reverting firewall config\"\n+  fw_restore\n+\n+  unlock_exit 1 $lock $locked\n+else\n+  # Remove backedup iptable rules\n+  logger -t cloud \"Firewall configured successfully, deleting backup firewall config\"\n+  fw_remove_backup\n+fi\n+ \n+unlock_exit 0 $lock $locked",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/opt/cloud/bin/ilb.sh",
                "sha": "2a298925be325241da0be7a664af360f725c30f9",
                "status": "added"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/opt/cloud/bin/patchsystemvm.sh",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/patches/systemvm/debian/config/opt/cloud/bin/patchsystemvm.sh?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "patches/systemvm/debian/config/opt/cloud/bin/patchsystemvm.sh",
                "patch": "@@ -135,6 +135,19 @@ elbvm_svcs() {\n    echo \"cloud dnsmasq cloud-passwd-srvr apache2 nfs-common portmap\" > /var/cache/cloud/disabled_svcs\n }\n \n+\n+ilbvm_svcs() {\n+   chkconfig cloud off\n+   chkconfig haproxy on ; \n+   chkconfig ssh on\n+   chkconfig nfs-common off\n+   chkconfig portmap off\n+   chkconfig keepalived off\n+   chkconfig conntrackd off\n+   echo \"ssh haproxy\" > /var/cache/cloud/enabled_svcs\n+   echo \"cloud dnsmasq cloud-passwd-srvr apache2 nfs-common portmap\" > /var/cache/cloud/disabled_svcs\n+}\n+\n enable_pcihotplug() {\n    sed -i -e \"/acpiphp/d\" /etc/modules\n    sed -i -e \"/pci_hotplug/d\" /etc/modules\n@@ -253,4 +266,14 @@ then\n   fi\n fi\n \n+if [ \"$TYPE\" == \"ilbvm\" ]\n+then\n+  ilbvm_svcs\n+  if [ $? -gt 0 ]\n+  then\n+    printf \"Failed to execute ilbvm svcs\\n\" >$logfile\n+    exit 9\n+  fi\n+fi\n+\n exit $?",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/opt/cloud/bin/patchsystemvm.sh",
                "sha": "9cb02502ef1ee588e4791ca1536df05796e6b43b",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/opt/cloud/bin/vpc_loadbalancer.sh",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/patches/systemvm/debian/config/opt/cloud/bin/vpc_loadbalancer.sh?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "patches/systemvm/debian/config/opt/cloud/bin/vpc_loadbalancer.sh",
                "patch": "@@ -18,6 +18,29 @@\n \n # @VERSION@\n \n+do_ilb_if_ilb () {\n+  local typ=\"\"\n+  local pattern=\"type=(.*)\"\n+\n+  for keyval in $(cat /var/cache/cloud/cmdline)\n+  do    \n+     if [[ $keyval =~ $pattern ]]; then      \n+        typ=${BASH_REMATCH[1]}; \n+     fi \n+  done\n+  if [ \"$typ\" == \"ilbvm\" ]\n+  then\n+     logger -t cloud \"$(basename $0): Detected that we are running in an internal load balancer vm\"\n+     $(dirname $0)/ilb.sh \"$@\"\n+     exit $?\n+  fi\n+\n+}\n+\n+logger -t cloud \"$(basename $0): Entering $(dirname $0)/$(basename $0)\"\n+\n+do_ilb_if_ilb \"$@\"\n+\n source /root/func.sh\n source /opt/cloud/bin/vpc_func.sh\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/patches/systemvm/debian/config/opt/cloud/bin/vpc_loadbalancer.sh",
                "sha": "36a2347a29790519dff309753f6132c7f16bfe5b",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/element/ElasticLoadBalancerElement.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/element/ElasticLoadBalancerElement.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 3,
                "filename": "plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/element/ElasticLoadBalancerElement.java",
                "patch": "@@ -35,6 +35,7 @@\n import com.cloud.exception.ConcurrentOperationException;\n import com.cloud.exception.InsufficientCapacityException;\n import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.exception.UnsupportedServiceException;\n import com.cloud.network.Network;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n@@ -46,6 +47,7 @@\n import com.cloud.network.dao.NetworkDao;\n import com.cloud.network.lb.ElasticLoadBalancerManager;\n import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.rules.LoadBalancerContainer;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offerings.dao.NetworkOfferingDao;\n import com.cloud.utils.component.AdapterBase;\n@@ -68,12 +70,25 @@\n     boolean _enabled;\n     TrafficType _frontEndTrafficType = TrafficType.Guest;\n     \n-    private boolean canHandle(Network network) {\n+    private boolean canHandle(Network network, List<LoadBalancingRule> rules) {\n         if (network.getGuestType() != Network.GuestType.Shared|| network.getTrafficType() != TrafficType.Guest) {\n             s_logger.debug(\"Not handling network with type  \" + network.getGuestType() + \" and traffic type \" + network.getTrafficType());\n             return false;\n         }\n         \n+        Map<Capability, String> lbCaps = this.getCapabilities().get(Service.Lb);\n+        if (!lbCaps.isEmpty()) {\n+            String schemeCaps = lbCaps.get(Capability.LbSchemes);\n+            if (schemeCaps != null) {\n+                for (LoadBalancingRule rule : rules) {\n+                    if (!schemeCaps.contains(rule.getScheme().toString())) {\n+                        s_logger.debug(\"Scheme \" + rules.get(0).getScheme() + \" is not supported by the provider \" + this.getName());\n+                        return false;\n+                    }\n+                }\n+            }\n+        }\n+        \n         return true;\n     }\n     \n@@ -94,6 +109,7 @@ public Provider getProvider() {\n         lbCapabilities.put(Capability.SupportedLBAlgorithms, \"roundrobin,leastconn,source\");\n         lbCapabilities.put(Capability.SupportedLBIsolation, \"shared\");\n         lbCapabilities.put(Capability.SupportedProtocols, \"tcp, udp\");\n+        lbCapabilities.put(Capability.LbSchemes, LoadBalancerContainer.Scheme.Public.toString());\n         \n         capabilities.put(Service.Lb, lbCapabilities);   \n         return capabilities;\n@@ -139,10 +155,10 @@ public boolean validateLBRule(Network network, LoadBalancingRule rule) {\n     \n     @Override\n     public boolean applyLBRules(Network network, List<LoadBalancingRule> rules) throws ResourceUnavailableException {\n-        if (!canHandle(network)) {\n+        if (!canHandle(network, rules)) {\n             return false;\n         }\n-        \n+                \n         return _lbMgr.applyLoadBalancerRules(network, rules);\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/element/ElasticLoadBalancerElement.java",
                "sha": "8b1b4140a8d78bb7a659ed7b32521db018fe748b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 2,
                "filename": "plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManager.java",
                "patch": "@@ -19,11 +19,11 @@\n import java.util.List;\n \n import org.apache.cloudstack.api.command.user.loadbalancer.CreateLoadBalancerRuleCmd;\n+\n import com.cloud.exception.InsufficientAddressCapacityException;\n import com.cloud.exception.NetworkRuleConflictException;\n import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.network.Network;\n-import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.LoadBalancer;\n import com.cloud.user.Account;\n \n@@ -32,7 +32,7 @@\n     public static final int DEFAULT_ELB_VM_CPU_MHZ = 256;               // 500 MHz\n \n     public boolean applyLoadBalancerRules(Network network, \n-            List<? extends FirewallRule> rules) \n+            List<LoadBalancingRule> rules) \n             throws ResourceUnavailableException;\n \n     public LoadBalancer handleCreateLoadBalancerRule(CreateLoadBalancerRuleCmd lb, Account caller, long networkId) throws InsufficientAddressCapacityException, NetworkRuleConflictException;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManager.java",
                "sha": "cce2b2c23c1e6d6fe11fa058c532aeaaaf1e1556",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 15,
                "filename": "plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java",
                "patch": "@@ -102,7 +102,6 @@\n import com.cloud.network.router.VirtualRouter.Role;\n import com.cloud.network.router.VpcVirtualNetworkApplianceManager;\n import com.cloud.network.rules.FirewallRule;\n-import com.cloud.network.rules.FirewallRule.Purpose;\n import com.cloud.network.rules.LoadBalancer;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offering.ServiceOffering;\n@@ -118,14 +117,14 @@\n import com.cloud.user.dao.AccountDao;\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.Pair;\n-import com.cloud.utils.component.Manager;\n import com.cloud.utils.component.ManagerBase;\n import com.cloud.utils.concurrency.NamedThreadFactory;\n import com.cloud.utils.db.DB;\n import com.cloud.utils.db.SearchBuilder;\n import com.cloud.utils.db.SearchCriteria;\n import com.cloud.utils.db.Transaction;\n import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n import com.cloud.vm.DomainRouterVO;\n import com.cloud.vm.NicProfile;\n import com.cloud.vm.ReservationContext;\n@@ -297,8 +296,7 @@ private void createApplyLoadBalancingRulesCommands(\n             String protocol = rule.getProtocol();\n             String algorithm = rule.getAlgorithm();\n \n-            String elbIp = _networkModel.getIp(rule.getSourceIpAddressId()).getAddress()\n-                    .addr();\n+            String elbIp = rule.getSourceIp().addr();\n             int srcPort = rule.getSourcePortStart();\n             String uuid = rule.getUuid();\n             List<LbDestination> destinations = rule.getDestinations();\n@@ -331,8 +329,10 @@ protected boolean applyLBRules(DomainRouterVO elbVm,\n         return sendCommandsToRouter(elbVm, cmds);\n     }\n     \n-    protected DomainRouterVO findElbVmForLb(FirewallRule lb) {//TODO: use a table to lookup\n-        ElasticLbVmMapVO map = _elbVmMapDao.findOneByIp(lb.getSourceIpAddressId());\n+    protected DomainRouterVO findElbVmForLb(LoadBalancingRule lb) {//TODO: use a table to lookup\n+        Network ntwk = _networkModel.getNetwork(lb.getNetworkId());\n+        long sourceIpId = _networkModel.getPublicIpAddress(lb.getSourceIp().addr(), ntwk.getDataCenterId()).getId();\n+        ElasticLbVmMapVO map = _elbVmMapDao.findOneByIp(sourceIpId);\n         if (map == null) {\n             return null;\n         }\n@@ -342,15 +342,11 @@ protected DomainRouterVO findElbVmForLb(FirewallRule lb) {//TODO: use a table to\n \n     @Override\n     public boolean applyLoadBalancerRules(Network network,\n-            List<? extends FirewallRule> rules)\n+            List<LoadBalancingRule> rules)\n             throws ResourceUnavailableException {\n         if (rules == null || rules.isEmpty()) {\n             return true;\n         }\n-        if (rules.get(0).getPurpose() != Purpose.LoadBalancing) {\n-            s_logger.warn(\"ELB: Not handling non-LB firewall rules\");\n-            return false;\n-        }\n         \n         DomainRouterVO elbVm = findElbVmForLb(rules.get(0));\n                                                                           \n@@ -363,14 +359,16 @@ public boolean applyLoadBalancerRules(Network network,\n \n         if (elbVm.getState() == State.Running) {\n             //resend all rules for the public ip\n-            List<LoadBalancerVO> lbs = _lbDao.listByIpAddress(rules.get(0).getSourceIpAddressId());\n+            long sourceIpId = _networkModel.getPublicIpAddress(rules.get(0).getSourceIp().addr(), network.getDataCenterId()).getId();\n+            List<LoadBalancerVO> lbs = _lbDao.listByIpAddress(sourceIpId);\n             List<LoadBalancingRule> lbRules = new ArrayList<LoadBalancingRule>();\n             for (LoadBalancerVO lb : lbs) {\n                 List<LbDestination> dstList = _lbMgr.getExistingDestinations(lb.getId());\n                 List<LbStickinessPolicy> policyList = _lbMgr.getStickinessPolicies(lb.getId());\n                 List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId());\n+                Ip sourceIp = _networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();\n                 LoadBalancingRule loadBalancing = new LoadBalancingRule(\n-                        lb, dstList, policyList, hcPolicyList);\n+                        lb, dstList, policyList, hcPolicyList, sourceIp);\n                 lbRules.add(loadBalancing);\n             }\n             return applyLBRules(elbVm, lbRules, network.getId());\n@@ -656,7 +654,10 @@ public LoadBalancer handleCreateLoadBalancerRule(CreateLoadBalancerRuleCmd lb, A\n             LoadBalancer result = null;\n             try {\n                 lb.setSourceIpAddressId(ipId);\n-                result = _lbMgr.createLoadBalancer(lb, false);\n+                \n+                result = _lbMgr.createPublicLoadBalancer(lb.getXid(), lb.getName(), lb.getDescription(), \n+                        lb.getSourcePortStart(), lb.getDefaultPortStart(), ipId.longValue(), lb.getProtocol(),\n+                        lb.getAlgorithm(), false, UserContext.current());\n             } catch (NetworkRuleConflictException e) {\n                 s_logger.warn(\"Failed to create LB rule, not continuing with ELB deployment\");\n                 if (newIp) {\n@@ -943,7 +944,8 @@ public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<Doma\n             List<LbDestination> dstList = _lbMgr.getExistingDestinations(lb.getId());\n             List<LbStickinessPolicy> policyList = _lbMgr.getStickinessPolicies(lb.getId());\n             List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId());\n-            LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList);\n+            Ip sourceIp = _networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();\n+            LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList, sourceIp);\n             lbRules.add(loadBalancing);\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/elastic-loadbalancer/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java",
                "sha": "b21e8f9dba393d5c960e0b7b6fcf63b98fdde33d",
                "status": "modified"
            },
            {
                "additions": 70,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/f5/src/com/cloud/network/element/F5ExternalLoadBalancerElement.java",
                "changes": 87,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/f5/src/com/cloud/network/element/F5ExternalLoadBalancerElement.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 17,
                "filename": "plugins/network-elements/f5/src/com/cloud/network/element/F5ExternalLoadBalancerElement.java",
                "patch": "@@ -16,9 +16,30 @@\n // under the License.\n package com.cloud.network.element;\n \n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.response.ExternalLoadBalancerResponse;\n+import org.apache.cloudstack.network.ExternalNetworkDeviceManager.NetworkDevice;\n+import org.apache.log4j.Logger;\n+\n import com.cloud.agent.api.to.LoadBalancerTO;\n import com.cloud.api.ApiDBUtils;\n-import com.cloud.api.commands.*;\n+import com.cloud.api.commands.AddExternalLoadBalancerCmd;\n+import com.cloud.api.commands.AddF5LoadBalancerCmd;\n+import com.cloud.api.commands.ConfigureF5LoadBalancerCmd;\n+import com.cloud.api.commands.DeleteExternalLoadBalancerCmd;\n+import com.cloud.api.commands.DeleteF5LoadBalancerCmd;\n+import com.cloud.api.commands.ListExternalLoadBalancersCmd;\n+import com.cloud.api.commands.ListF5LoadBalancerNetworksCmd;\n+import com.cloud.api.commands.ListF5LoadBalancersCmd;\n import com.cloud.api.response.F5LoadBalancerResponse;\n import com.cloud.configuration.Config;\n import com.cloud.configuration.ConfigurationManager;\n@@ -27,22 +48,41 @@\n import com.cloud.dc.DataCenterVO;\n import com.cloud.dc.dao.DataCenterDao;\n import com.cloud.deploy.DeployDestination;\n-import com.cloud.exception.*;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InsufficientNetworkCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.host.Host;\n import com.cloud.host.HostVO;\n import com.cloud.host.dao.HostDao;\n import com.cloud.host.dao.HostDetailsDao;\n-import com.cloud.network.*;\n+import com.cloud.network.ExternalLoadBalancerDeviceManager;\n+import com.cloud.network.ExternalLoadBalancerDeviceManagerImpl;\n+import com.cloud.network.Network;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkModel;\n import com.cloud.network.Networks.TrafficType;\n-import com.cloud.network.dao.*;\n+import com.cloud.network.PhysicalNetwork;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.PublicIpAddress;\n+import com.cloud.network.dao.ExternalLoadBalancerDeviceDao;\n+import com.cloud.network.dao.ExternalLoadBalancerDeviceVO;\n import com.cloud.network.dao.ExternalLoadBalancerDeviceVO.LBDeviceState;\n+import com.cloud.network.dao.NetworkDao;\n+import com.cloud.network.dao.NetworkExternalLoadBalancerDao;\n+import com.cloud.network.dao.NetworkExternalLoadBalancerVO;\n+import com.cloud.network.dao.NetworkServiceMapDao;\n+import com.cloud.network.dao.NetworkVO;\n+import com.cloud.network.dao.PhysicalNetworkDao;\n+import com.cloud.network.dao.PhysicalNetworkVO;\n import com.cloud.network.lb.LoadBalancingRule;\n import com.cloud.network.resource.F5BigIpResource;\n import com.cloud.network.rules.LbStickinessMethod;\n import com.cloud.network.rules.LbStickinessMethod.StickinessMethodType;\n+import com.cloud.network.rules.LoadBalancerContainer;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.exception.CloudRuntimeException;\n@@ -51,13 +91,6 @@\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachineProfile;\n import com.google.gson.Gson;\n-import org.apache.cloudstack.api.response.ExternalLoadBalancerResponse;\n-import org.apache.cloudstack.network.ExternalNetworkDeviceManager.NetworkDevice;\n-import org.apache.log4j.Logger;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-import java.util.*;\n \n @Local(value = {NetworkElement.class, LoadBalancingServiceProvider.class, IpDeployer.class})\n public class F5ExternalLoadBalancerElement extends ExternalLoadBalancerDeviceManagerImpl implements LoadBalancingServiceProvider, IpDeployer, F5ExternalLoadBalancerElementService, ExternalLoadBalancerDeviceManager {\n@@ -87,11 +120,25 @@\n     @Inject\n     ConfigurationDao _configDao;\n \n-    private boolean canHandle(Network config) {\n+    private boolean canHandle(Network config, List<LoadBalancingRule> rules) {\n         if ((config.getGuestType() != Network.GuestType.Isolated && config.getGuestType() != Network.GuestType.Shared) || config.getTrafficType() != TrafficType.Guest) {\n+\n             s_logger.trace(\"Not handling network with Type  \" + config.getGuestType() + \" and traffic type \" + config.getTrafficType());\n             return false;\n         }\n+        \n+        Map<Capability, String> lbCaps = this.getCapabilities().get(Service.Lb);\n+        if (!lbCaps.isEmpty()) {\n+            String schemeCaps = lbCaps.get(Capability.LbSchemes);\n+            if (schemeCaps != null && rules != null && !rules.isEmpty()) {\n+                for (LoadBalancingRule rule : rules) {\n+                    if (!schemeCaps.contains(rule.getScheme().toString())) {\n+                        s_logger.debug(\"Scheme \" + rules.get(0).getScheme() + \" is not supported by the provider \" + this.getName());\n+                        return false;\n+                    }\n+                }\n+            }\n+        }\n \n         return (_networkManager.isProviderForNetwork(getProvider(), config.getId()) && _ntwkSrvcDao.canProviderSupportServiceInNetwork(config.getId(), Service.Lb, Network.Provider.F5BigIp));\n     }\n@@ -100,7 +147,7 @@ private boolean canHandle(Network config) {\n     public boolean implement(Network guestConfig, NetworkOffering offering, DeployDestination dest, ReservationContext context) throws ResourceUnavailableException, ConcurrentOperationException,\n     InsufficientNetworkCapacityException {\n \n-        if (!canHandle(guestConfig)) {\n+        if (!canHandle(guestConfig, null)) {\n             return false;\n         }\n \n@@ -124,7 +171,7 @@ public boolean release(Network config, NicProfile nic, VirtualMachineProfile<? e\n \n     @Override\n     public boolean shutdown(Network guestConfig, ReservationContext context, boolean cleanup) throws ResourceUnavailableException, ConcurrentOperationException {\n-        if (!canHandle(guestConfig)) {\n+        if (!canHandle(guestConfig, null)) {\n             return false;\n         }\n \n@@ -143,13 +190,16 @@ public boolean destroy(Network config, ReservationContext context) {\n \n     @Override\n     public boolean validateLBRule(Network network, LoadBalancingRule rule) {\n-        String algo = rule.getAlgorithm();\n-        return (algo.equals(\"roundrobin\") || algo.equals(\"leastconn\"));\n+        if (canHandle(network, new ArrayList<LoadBalancingRule>(Arrays.asList(rule)))) {\n+            String algo = rule.getAlgorithm();\n+            return (algo.equals(\"roundrobin\") || algo.equals(\"leastconn\"));\n+        }\n+        return true;\n     }\n \n     @Override\n     public boolean applyLBRules(Network config, List<LoadBalancingRule> rules) throws ResourceUnavailableException {\n-        if (!canHandle(config)) {\n+        if (!canHandle(config, rules)) {\n             return false;\n         }\n \n@@ -180,6 +230,9 @@ public boolean applyLBRules(Network config, List<LoadBalancingRule> rules) throw\n \n         // Support inline mode with firewall\n         lbCapabilities.put(Capability.InlineMode, \"true\");\n+        \n+        //support only for public lb\n+        lbCapabilities.put(Capability.LbSchemes, LoadBalancerContainer.Scheme.Public.toString());\n \n         LbStickinessMethod method;\n         List<LbStickinessMethod> methodList = new ArrayList<LbStickinessMethod>();",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/f5/src/com/cloud/network/element/F5ExternalLoadBalancerElement.java",
                "sha": "80b42e030d812403d43548345b75751ab804e881",
                "status": "modified"
            },
            {
                "additions": 50,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/pom.xml",
                "changes": 50,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/pom.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/pom.xml",
                "patch": "@@ -0,0 +1,50 @@\n+<!--\n+  Licensed to the Apache Software Foundation (ASF) under one\n+  or more contributor license agreements. See the NOTICE file\n+  distributed with this work for additional information\n+  regarding copyright ownership. The ASF licenses this file\n+  to you under the Apache License, Version 2.0 (the\n+  \"License\"); you may not use this file except in compliance\n+  with the License. You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing,\n+  software distributed under the License is distributed on an\n+  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+  KIND, either express or implied. See the License for the\n+  specific language governing permissions and limitations\n+  under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <artifactId>cloud-plugin-network-internallb</artifactId>\n+  <name>Apache CloudStack Plugin - Network Internal Load Balancer</name>\n+  <parent>\n+    <groupId>org.apache.cloudstack</groupId>\n+    <artifactId>cloudstack-plugins</artifactId>\n+    <version>4.2.0-SNAPSHOT</version>\n+    <relativePath>../../pom.xml</relativePath>\n+  </parent>\n+  <build>\n+    <defaultGoal>install</defaultGoal>\n+    <sourceDirectory>src</sourceDirectory>\n+    <testSourceDirectory>test</testSourceDirectory>\n+    <resources>\n+      <resource>\n+        <directory>resources</directory>\n+        <includes>\n+          <include>**/*.xml</include>\n+        </includes>\n+      </resource>\n+    </resources>\n+    <testResources>\n+      <testResource>\n+        <directory>test/resources</directory>\n+          <excludes>\n+              <exclude>%regex[.*[0-9]*To[0-9]*.*Test.*]</exclude>\n+          </excludes>\n+      </testResource>\n+    </testResources>\n+  </build>\n+</project>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/pom.xml",
                "sha": "48e664ee0e5184a597102457bbc3c06c108b2476",
                "status": "added"
            },
            {
                "additions": 548,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/element/InternalLoadBalancerElement.java",
                "changes": 548,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/element/InternalLoadBalancerElement.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/element/InternalLoadBalancerElement.java",
                "patch": "@@ -0,0 +1,548 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the \n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.network.element;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.command.admin.internallb.ConfigureInternalLoadBalancerElementCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.CreateInternalLoadBalancerElementCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.ListInternalLoadBalancerElementsCmd;\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.cloudstack.network.lb.InternalLoadBalancerVMManager;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.agent.api.to.LoadBalancerTO;\n+import com.cloud.configuration.ConfigurationManager;\n+import com.cloud.dc.DataCenter;\n+import com.cloud.dc.DataCenter.NetworkType;\n+import com.cloud.deploy.DeployDestination;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.Network;\n+import com.cloud.network.Network.Capability;\n+import com.cloud.network.Network.Provider;\n+import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.PublicIpAddress;\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.network.VirtualRouterProvider.VirtualRouterProviderType;\n+import com.cloud.network.dao.NetworkServiceMapDao;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.dao.VirtualRouterProviderDao;\n+import com.cloud.network.element.IpDeployer;\n+import com.cloud.network.element.LoadBalancingServiceProvider;\n+import com.cloud.network.element.NetworkElement;\n+import com.cloud.network.element.VirtualRouterElement;\n+import com.cloud.network.element.VirtualRouterProviderVO;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n+import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.rules.LoadBalancerContainer;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.offering.NetworkOffering;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.User;\n+import com.cloud.utils.component.AdapterBase;\n+import com.cloud.utils.db.SearchCriteria.Op;\n+import com.cloud.utils.db.SearchCriteria2;\n+import com.cloud.utils.db.SearchCriteriaService;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.vm.DomainRouterVO;\n+import com.cloud.vm.NicProfile;\n+import com.cloud.vm.ReservationContext;\n+import com.cloud.vm.VirtualMachine;\n+import com.cloud.vm.VirtualMachineProfile;\n+import com.cloud.vm.dao.DomainRouterDao;\n+\n+@Local(value = {NetworkElement.class})\n+public class InternalLoadBalancerElement extends AdapterBase implements LoadBalancingServiceProvider, InternalLoadBalancerElementService, IpDeployer{\n+    private static final Logger s_logger = Logger.getLogger(InternalLoadBalancerElement.class);\n+    protected static final Map<Service, Map<Capability, String>> capabilities = setCapabilities();\n+    private static InternalLoadBalancerElement internalLbElement = null;\n+\n+    @Inject NetworkModel _ntwkModel;\n+    @Inject NetworkServiceMapDao _ntwkSrvcDao;\n+    @Inject DomainRouterDao _routerDao;\n+    @Inject VirtualRouterProviderDao _vrProviderDao;\n+    @Inject PhysicalNetworkServiceProviderDao _pNtwkSvcProviderDao;\n+    @Inject InternalLoadBalancerVMManager _internalLbMgr;\n+    @Inject ConfigurationManager _configMgr;\n+    @Inject AccountManager _accountMgr;\n+    @Inject ApplicationLoadBalancerRuleDao _appLbDao;\n+    \n+    protected InternalLoadBalancerElement() {\n+    }\n+    \n+    \n+    public static InternalLoadBalancerElement getInstance() {\n+        if ( internalLbElement == null) {\n+            internalLbElement = new InternalLoadBalancerElement();\n+        }\n+        return internalLbElement;\n+     }\n+    \n+    \n+    private boolean canHandle(Network config, Scheme lbScheme) {\n+        //works in Advance zone only\n+        DataCenter dc = _configMgr.getZone(config.getDataCenterId());\n+        if (dc.getNetworkType() != NetworkType.Advanced) {\n+            s_logger.trace(\"Not hanling zone of network type \" + dc.getNetworkType());\n+            return false;\n+        }\n+        if (config.getGuestType() != Network.GuestType.Isolated || config.getTrafficType() != TrafficType.Guest) {\n+            s_logger.trace(\"Not handling network with Type  \" + config.getGuestType() + \" and traffic type \" + config.getTrafficType());\n+            return false;\n+        }\n+        \n+        Map<Capability, String> lbCaps = this.getCapabilities().get(Service.Lb);\n+        if (!lbCaps.isEmpty()) {\n+            String schemeCaps = lbCaps.get(Capability.LbSchemes);\n+            if (schemeCaps != null && lbScheme != null) {\n+                if (!schemeCaps.contains(lbScheme.toString())) {\n+                    s_logger.debug(\"Scheme \" + lbScheme.toString() + \" is not supported by the provider \" + this.getName());\n+                    return false;\n+                }\n+            }\n+        }\n+        \n+        if (!_ntwkModel.isProviderSupportServiceInNetwork(config.getId(), Service.Lb, getProvider())) {\n+            s_logger.trace(\"Element \" + getProvider().getName() + \" doesn't support service \" + Service.Lb\n+                    + \" in the network \" + config);\n+            return false;\n+        }\n+        return true;\n+    }\n+\n+    \n+    @Override\n+    public Map<Service, Map<Capability, String>> getCapabilities() {\n+        return capabilities;\n+    }\n+\n+    \n+    @Override\n+    public Provider getProvider() {\n+        return Provider.InternalLbVm;\n+    }\n+\n+    \n+    @Override\n+    public boolean implement(Network network, NetworkOffering offering, DeployDestination dest, ReservationContext context)\n+            throws ConcurrentOperationException, ResourceUnavailableException,\n+            InsufficientCapacityException {\n+        \n+        if (!canHandle(network, null)) {\n+            s_logger.trace(\"No need to implement \" + this.getName());\n+            return true;\n+        }\n+        \n+        //1) Get all the Ips from the network having LB rules assigned\n+        List<String> ips = _appLbDao.listLbIpsBySourceIpNetworkIdAndScheme(network.getId(), Scheme.Internal);\n+        \n+        //2) Start those vms\n+        for (String ip : ips) {\n+            Ip sourceIp = new Ip(ip);\n+            List<? extends VirtualRouter> internalLbVms;\n+            try {\n+                internalLbVms = _internalLbMgr.deployInternalLbVm(network, sourceIp, dest, _accountMgr.getAccount(network.getAccountId()), null);\n+            } catch (InsufficientCapacityException e) {\n+                s_logger.warn(\"Failed to deploy element \" + this.getName() + \" for ip \" + sourceIp + \" due to:\", e);\n+                return false;\n+            } catch (ConcurrentOperationException e) {\n+                s_logger.warn(\"Failed to deploy element \" + this.getName() + \" for ip \" + sourceIp + \" due to:\", e);\n+                return false;\n+            }\n+            \n+            if (internalLbVms == null || internalLbVms.isEmpty()) {\n+                throw new ResourceUnavailableException(\"Can't deploy \" + this.getName() + \" to handle LB rules\",\n+                        DataCenter.class, network.getDataCenterId());\n+            }\n+        }\n+       \n+        return true;\n+    }\n+\n+    \n+    @Override\n+    public boolean prepare(Network network, NicProfile nic, VirtualMachineProfile<? extends VirtualMachine> vm, DeployDestination dest, ReservationContext context) throws ConcurrentOperationException,\n+            ResourceUnavailableException, InsufficientCapacityException {\n+        \n+        if (!canHandle(network, null)) {\n+            s_logger.trace(\"No need to prepare \" + this.getName());\n+            return true;\n+        }\n+        \n+        if (vm.getType() == VirtualMachine.Type.User) {\n+          //1) Get all the Ips from the network having LB rules assigned\n+            List<String> ips = _appLbDao.listLbIpsBySourceIpNetworkIdAndScheme(network.getId(), Scheme.Internal);\n+            \n+            //2) Start those vms\n+            for (String ip : ips) {\n+                Ip sourceIp = new Ip(ip);\n+                List<? extends VirtualRouter> internalLbVms;\n+                try {\n+                    internalLbVms = _internalLbMgr.deployInternalLbVm(network, sourceIp, dest, _accountMgr.getAccount(network.getAccountId()), null);\n+                } catch (InsufficientCapacityException e) {\n+                    s_logger.warn(\"Failed to deploy element \" + this.getName() + \" for ip \" + sourceIp + \" due to:\", e);\n+                    return false;\n+                } catch (ConcurrentOperationException e) {\n+                    s_logger.warn(\"Failed to deploy element \" + this.getName() + \" for ip \" + sourceIp +  \" due to:\", e);\n+                    return false;\n+                }\n+                \n+                if (internalLbVms == null || internalLbVms.isEmpty()) {\n+                    throw new ResourceUnavailableException(\"Can't deploy \" + this.getName() + \" to handle LB rules\",\n+                            DataCenter.class, network.getDataCenterId());\n+                }\n+            }\n+        }\n+        \n+        return true;\n+    }\n+\n+    @Override\n+    public boolean release(Network network, NicProfile nic, VirtualMachineProfile<? extends VirtualMachine> vm, ReservationContext context) throws ConcurrentOperationException, ResourceUnavailableException {\n+        return true;\n+    }\n+\n+    \n+    @Override\n+    public boolean shutdown(Network network, ReservationContext context, boolean cleanup) throws ConcurrentOperationException, ResourceUnavailableException {\n+        List<? extends VirtualRouter> internalLbVms = _routerDao.listByNetworkAndRole(network.getId(), Role.INTERNAL_LB_VM);\n+        if (internalLbVms == null || internalLbVms.isEmpty()) {\n+            return true;\n+        }\n+        boolean result = true;\n+        for (VirtualRouter internalLbVm : internalLbVms) {\n+            result = result && _internalLbMgr.destroyInternalLbVm(internalLbVm.getId(),\n+                    context.getAccount(), context.getCaller().getId());\n+            if (cleanup) {\n+                if (!result) {\n+                    s_logger.warn(\"Failed to stop internal lb element \" + internalLbVm + \", but would try to process clean up anyway.\");\n+                }\n+                result = (_internalLbMgr.destroyInternalLbVm(internalLbVm.getId(),\n+                        context.getAccount(), context.getCaller().getId()));\n+                if (!result) {\n+                    s_logger.warn(\"Failed to clean up internal lb element \" + internalLbVm);\n+                }\n+            }\n+        }\n+        return result;\n+    }\n+\n+    \n+    @Override\n+    public boolean destroy(Network network, ReservationContext context) throws ConcurrentOperationException, ResourceUnavailableException {\n+        List<? extends VirtualRouter> internalLbVms = _routerDao.listByNetworkAndRole(network.getId(), Role.INTERNAL_LB_VM);\n+        if (internalLbVms == null || internalLbVms.isEmpty()) {\n+            return true;\n+        }\n+        boolean result = true;\n+        for (VirtualRouter internalLbVm : internalLbVms) {\n+            result = result && (_internalLbMgr.destroyInternalLbVm(internalLbVm.getId(),\n+                    context.getAccount(), context.getCaller().getId()));\n+        }\n+        return result;\n+    }\n+\n+    \n+    @Override\n+    public boolean isReady(PhysicalNetworkServiceProvider provider) {\n+        VirtualRouterProviderVO element = _vrProviderDao.findByNspIdAndType(provider.getId(), \n+                VirtualRouterProviderType.InternalLbVm);\n+        if (element == null) {\n+            return false;\n+        }\n+        return element.isEnabled();\n+    }\n+\n+    \n+    @Override\n+    public boolean shutdownProviderInstances(PhysicalNetworkServiceProvider provider, ReservationContext context)\n+            throws ConcurrentOperationException, ResourceUnavailableException {\n+        VirtualRouterProviderVO element = _vrProviderDao.findByNspIdAndType(provider.getId(), \n+                VirtualRouterProviderType.InternalLbVm);\n+        if (element == null) {\n+            return true;\n+        }\n+        long elementId = element.getId();\n+        List<DomainRouterVO> internalLbVms = _routerDao.listByElementId(elementId);\n+        boolean result = true;\n+        for (DomainRouterVO internalLbVm : internalLbVms) {\n+            result = result && (_internalLbMgr.destroyInternalLbVm(internalLbVm.getId(),\n+                    context.getAccount(), context.getCaller().getId()));\n+        }\n+        _vrProviderDao.remove(elementId);\n+        \n+        return result;\n+    }\n+\n+    \n+    @Override\n+    public boolean canEnableIndividualServices() {\n+        return true;\n+    }\n+\n+    \n+    @Override\n+    public boolean verifyServicesCombination(Set<Service> services) {\n+        return true;\n+    }\n+\n+    \n+    @Override\n+    public IpDeployer getIpDeployer(Network network) {\n+        return this;\n+    }\n+\n+    \n+    @Override\n+    public boolean applyLBRules(Network network, List<LoadBalancingRule> rules) throws ResourceUnavailableException {\n+        //1) Get Internal LB VMs to destroy\n+        Set<Ip> vmsToDestroy = getVmsToDestroy(rules);\n+        \n+        //2) Get rules to apply\n+        Map<Ip, List<LoadBalancingRule>> rulesToApply = getLbRulesToApply(rules);\n+        s_logger.debug(\"Applying \" + rulesToApply.size() + \" on element \" + this.getName());\n+\n+ \n+        for (Ip sourceIp : rulesToApply.keySet()) {\n+            if (vmsToDestroy.contains(sourceIp)) {\n+                //2.1 Destroy internal lb vm\n+                List<? extends VirtualRouter> vms = _internalLbMgr.findInternalLbVms(network.getId(), sourceIp);\n+                if (vms.size() > 0) {\n+                    //only one internal lb per IP exists\n+                    try {\n+                        s_logger.debug(\"Destroying internal lb vm for ip \" + sourceIp.addr() + \" as all the rules for this vm are in Revoke state\");\n+                        return _internalLbMgr.destroyInternalLbVm(vms.get(0).getId(), _accountMgr.getAccount(Account.ACCOUNT_ID_SYSTEM),\n+                                _accountMgr.getUserIncludingRemoved(User.UID_SYSTEM).getId());\n+                    } catch (ConcurrentOperationException e) {\n+                        s_logger.warn(\"Failed to apply lb rule(s) for ip \" + sourceIp.addr() + \" on the element \" + this.getName() + \" due to:\", e);\n+                        return false;\n+                    }\n+                }\n+            } else {\n+                //2.2 Start Internal LB vm per IP address\n+                List<? extends VirtualRouter> internalLbVms;\n+                try {\n+                    DeployDestination dest = new DeployDestination(_configMgr.getZone(network.getDataCenterId()), null, null, null); \n+                    internalLbVms = _internalLbMgr.deployInternalLbVm(network, sourceIp, dest, _accountMgr.getAccount(network.getAccountId()), null);\n+                } catch (InsufficientCapacityException e) {\n+                    s_logger.warn(\"Failed to apply lb rule(s) for ip \" + sourceIp.addr() + \"on the element \" + this.getName() + \" due to:\", e);\n+                    return false;\n+                } catch (ConcurrentOperationException e) {\n+                    s_logger.warn(\"Failed to apply lb rule(s) for ip \" + sourceIp.addr() + \"on the element \" + this.getName() + \" due to:\", e);\n+                    return false;\n+                }\n+                \n+                if (internalLbVms == null || internalLbVms.isEmpty()) {\n+                    throw new ResourceUnavailableException(\"Can't find/deploy internal lb vm to handle LB rules\",\n+                            DataCenter.class, network.getDataCenterId());\n+                }\n+                 \n+                //2.3 Apply Internal LB rules on the VM\n+                if (!_internalLbMgr.applyLoadBalancingRules(network, rulesToApply.get(sourceIp), internalLbVms)) {\n+                    throw new CloudRuntimeException(\"Failed to apply load balancing rules for ip \" + sourceIp.addr() + \n+                            \" in network \" + network.getId() + \" on element \" + this.getName());\n+                }\n+            }\n+        }\n+\n+        return true;    \n+    }\n+\n+    \n+    protected Map<Ip, List<LoadBalancingRule>> getLbRulesToApply(List<LoadBalancingRule> rules) {\n+        //Group rules by the source ip address as NetworkManager always passes the entire network lb config to the element\n+        Map<Ip, List<LoadBalancingRule>> rulesToApply = groupBySourceIp(rules);\n+      \n+        return rulesToApply;\n+    }\n+    \n+    \n+    protected Set<Ip> getVmsToDestroy(List<LoadBalancingRule> rules) {\n+        //1) Group rules by the source ip address as NetworkManager always passes the entire network lb config to the element\n+        Map<Ip, List<LoadBalancingRule>> groupedRules = groupBySourceIp(rules);\n+\n+        //2) Count rules in revoke state\n+        Set<Ip> vmsToDestroy = new HashSet<Ip>();\n+        \n+        for (Ip sourceIp : groupedRules.keySet()) {\n+            List<LoadBalancingRule> rulesToCheck = groupedRules.get(sourceIp);\n+            int revoke = 0;\n+            for (LoadBalancingRule ruleToCheck : rulesToCheck) {\n+                if (ruleToCheck.getState() == FirewallRule.State.Revoke){\n+                    revoke++;\n+                }\n+            }\n+            \n+            if (revoke == rulesToCheck.size()) {\n+                s_logger.debug(\"Have to destroy internal lb vm for source ip \" + sourceIp);\n+                vmsToDestroy.add(sourceIp);\n+            } \n+        }        \n+        return vmsToDestroy;\n+    }\n+\n+    \n+    protected Map<Ip, List<LoadBalancingRule>> groupBySourceIp(List<LoadBalancingRule> rules) {\n+        Map<Ip, List<LoadBalancingRule>> groupedRules = new HashMap<Ip, List<LoadBalancingRule>>();\n+        for (LoadBalancingRule rule : rules) {\n+            Ip sourceIp = rule.getSourceIp();\n+            if (!groupedRules.containsKey(sourceIp)) {\n+                groupedRules.put(sourceIp, null);\n+            }\n+            \n+            List<LoadBalancingRule> rulesToApply = groupedRules.get(sourceIp);\n+            if (rulesToApply == null) {\n+                rulesToApply = new ArrayList<LoadBalancingRule>();\n+            }\n+            rulesToApply.add(rule);\n+            groupedRules.put(sourceIp, rulesToApply);\n+        }\n+        return groupedRules;\n+    }\n+\n+    @Override\n+    public boolean validateLBRule(Network network, LoadBalancingRule rule) {\n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        rules.add(rule);\n+        if (canHandle(network, rule.getScheme())) {\n+            List<DomainRouterVO> routers = _routerDao.listByNetworkAndRole(network.getId(), Role.INTERNAL_LB_VM);\n+            if (routers == null || routers.isEmpty()) {\n+                return true;\n+            }\n+            return VirtualRouterElement.validateHAProxyLBRule(rule);\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public List<LoadBalancerTO> updateHealthChecks(Network network, List<LoadBalancingRule> lbrules) {\n+        return null;\n+    }\n+    \n+    private static Map<Service, Map<Capability, String>> setCapabilities() {\n+        Map<Service, Map<Capability, String>> capabilities = new HashMap<Service, Map<Capability, String>>();\n+\n+        // Set capabilities for LB service\n+        Map<Capability, String> lbCapabilities = new HashMap<Capability, String>();\n+        lbCapabilities.put(Capability.SupportedLBAlgorithms, \"roundrobin,leastconn,source\");\n+        lbCapabilities.put(Capability.SupportedLBIsolation, \"dedicated\");\n+        lbCapabilities.put(Capability.SupportedProtocols, \"tcp, udp\");\n+        lbCapabilities.put(Capability.SupportedStickinessMethods, VirtualRouterElement.getHAProxyStickinessCapability());\n+        lbCapabilities.put(Capability.LbSchemes, LoadBalancerContainer.Scheme.Internal.toString());\n+\n+        capabilities.put(Service.Lb, lbCapabilities);\n+        return capabilities;\n+    }\n+\n+    @Override\n+    public List<Class<?>> getCommands() {\n+        List<Class<?>> cmdList = new ArrayList<Class<?>>();\n+        cmdList.add(CreateInternalLoadBalancerElementCmd.class);\n+        cmdList.add(ConfigureInternalLoadBalancerElementCmd.class);\n+        cmdList.add(ListInternalLoadBalancerElementsCmd.class);\n+        return cmdList;\n+    }\n+\n+    @Override\n+    public VirtualRouterProvider configureInternalLoadBalancerElement(long id, boolean enable) {\n+        VirtualRouterProviderVO element = _vrProviderDao.findById(id);\n+        if (element == null || element.getType() != VirtualRouterProviderType.InternalLbVm) {\n+            throw new InvalidParameterValueException(\"Can't find \" + this.getName() + \" element with network service provider id \" + id +\n+                    \" to be used as a provider for \" + this.getName());\n+        }\n+\n+        element.setEnabled(enable);\n+        element = _vrProviderDao.persist(element);\n+\n+        return element;\n+    }\n+\n+    @Override\n+    public VirtualRouterProvider addInternalLoadBalancerElement(long ntwkSvcProviderId) {\n+        VirtualRouterProviderVO element = _vrProviderDao.findByNspIdAndType(ntwkSvcProviderId, VirtualRouterProviderType.InternalLbVm);\n+        if (element != null) {\n+            s_logger.debug(\"There is already an \" + this.getName() + \" with service provider id \" + ntwkSvcProviderId);\n+            return null;\n+        }\n+        \n+        PhysicalNetworkServiceProvider provider = _pNtwkSvcProviderDao.findById(ntwkSvcProviderId);\n+        if (provider == null || !provider.getProviderName().equalsIgnoreCase(this.getName())) {\n+            throw new InvalidParameterValueException(\"Invalid network service provider is specified\");\n+        }\n+        \n+        element = new VirtualRouterProviderVO(ntwkSvcProviderId, VirtualRouterProviderType.InternalLbVm);\n+        element = _vrProviderDao.persist(element);\n+        return element;\n+    }\n+\n+    \n+    @Override\n+    public VirtualRouterProvider getInternalLoadBalancerElement(long id) {\n+        VirtualRouterProvider provider = _vrProviderDao.findById(id);\n+        if (provider == null || provider.getType() != VirtualRouterProviderType.InternalLbVm) {\n+            throw new InvalidParameterValueException(\"Unable to find \" + this.getName() + \" by id\");\n+        }\n+        return provider;\n+    }\n+\n+    @Override\n+    public List<? extends VirtualRouterProvider> searchForInternalLoadBalancerElements(Long id, Long ntwkSvsProviderId, Boolean enabled) {\n+\n+        SearchCriteriaService<VirtualRouterProviderVO, VirtualRouterProviderVO> sc = SearchCriteria2.create(VirtualRouterProviderVO.class);\n+        if (id != null) {\n+            sc.addAnd(sc.getEntity().getId(), Op.EQ, id);\n+        }\n+        if (ntwkSvsProviderId != null) {\n+            sc.addAnd(sc.getEntity().getNspId(), Op.EQ, ntwkSvsProviderId);\n+        }\n+        if (enabled != null) {\n+            sc.addAnd(sc.getEntity().isEnabled(), Op.EQ, enabled);\n+        }\n+        \n+        //return only Internal LB elements\n+        sc.addAnd(sc.getEntity().getType(), Op.EQ, VirtualRouterProvider.VirtualRouterProviderType.InternalLbVm);\n+        \n+        return sc.list();\n+    }\n+\n+    @Override\n+    public boolean applyIps(Network network, List<? extends PublicIpAddress> ipAddress, Set<Service> services) throws ResourceUnavailableException {\n+        //do nothing here; this element just has to extend the ip deployer\n+        //as the LB service implements IPDeployerRequester\n+        return true;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/element/InternalLoadBalancerElement.java",
                "sha": "4b9308b6606d89132c2dcdd949b6b7c1fae662bb",
                "status": "added"
            },
            {
                "additions": 90,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManager.java",
                "changes": 90,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManager.java",
                "patch": "@@ -0,0 +1,90 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.network.lb;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import com.cloud.deploy.DeployDestination;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.Network;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.user.Account;\n+import com.cloud.utils.component.Manager;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.vm.VirtualMachineProfile.Param;\n+\n+public interface InternalLoadBalancerVMManager extends Manager, InternalLoadBalancerVMService{\n+    //RAM/CPU for the system offering used by Internal LB VMs\n+    public static final int DEFAULT_INTERNALLB_VM_RAMSIZE = 128;            // 128 MB\n+    public static final int DEFAULT_INTERNALLB_VM_CPU_MHZ = 256;            // 256 MHz\n+    \n+    /**\n+     * Destroys Internal LB vm instance\n+     * @param vmId\n+     * @param caller\n+     * @param callerUserId\n+     * @return \n+     * @throws ResourceUnavailableException\n+     * @throws ConcurrentOperationException\n+     */\n+    boolean destroyInternalLbVm(long vmId, Account caller, Long callerUserId) \n+            throws ResourceUnavailableException, ConcurrentOperationException;\n+\n+\n+    /**\n+     * Deploys internal lb vm\n+     * @param guestNetwork\n+     * @param requestedGuestIp\n+     * @param dest\n+     * @param owner\n+     * @param params\n+     * @return\n+     * @throws InsufficientCapacityException\n+     * @throws ConcurrentOperationException\n+     * @throws ResourceUnavailableException\n+     */\n+    List<? extends VirtualRouter> deployInternalLbVm(Network guestNetwork, Ip requestedGuestIp, DeployDestination dest, Account owner,\n+            Map<Param, Object> params) throws InsufficientCapacityException,\n+            ConcurrentOperationException, ResourceUnavailableException;\n+\n+\n+\n+    /**\n+     * \n+     * @param network\n+     * @param rules\n+     * @param internalLbVms\n+     * @return\n+     * @throws ResourceUnavailableException\n+     */\n+    boolean applyLoadBalancingRules(Network network, List<LoadBalancingRule> rules, List<? extends VirtualRouter> internalLbVms)\n+            throws ResourceUnavailableException;\n+\n+\n+    /**\n+     * Returns existing Internal Load Balancer elements based on guestNetworkId (required) and requestedIp (optional)\n+     * @param guestNetworkId\n+     * @param requestedGuestIp\n+     * @return\n+     */\n+    List<? extends VirtualRouter> findInternalLbVms(long guestNetworkId, Ip requestedGuestIp);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManager.java",
                "sha": "9faca562bfbb038343d6a04fc5073130269017fc",
                "status": "added"
            },
            {
                "additions": 951,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManagerImpl.java",
                "changes": 951,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManagerImpl.java",
                "patch": "@@ -0,0 +1,951 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.network.lb;\n+\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloud.agent.AgentManager;\n+import com.cloud.agent.AgentManager.OnError;\n+import com.cloud.agent.api.Answer;\n+import com.cloud.agent.api.GetDomRVersionAnswer;\n+import com.cloud.agent.api.GetDomRVersionCmd;\n+import com.cloud.agent.api.StopAnswer;\n+import com.cloud.agent.api.check.CheckSshAnswer;\n+import com.cloud.agent.api.check.CheckSshCommand;\n+import com.cloud.agent.api.routing.LoadBalancerConfigCommand;\n+import com.cloud.agent.api.routing.NetworkElementCommand;\n+import com.cloud.agent.api.to.LoadBalancerTO;\n+import com.cloud.agent.api.to.NicTO;\n+import com.cloud.agent.api.to.VirtualMachineTO;\n+import com.cloud.agent.manager.Commands;\n+import com.cloud.configuration.Config;\n+import com.cloud.configuration.dao.ConfigurationDao;\n+import com.cloud.dc.DataCenter;\n+import com.cloud.dc.DataCenterVO;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.deploy.DataCenterDeployment;\n+import com.cloud.deploy.DeployDestination;\n+import com.cloud.deploy.DeploymentPlan;\n+import com.cloud.exception.AgentUnavailableException;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InsufficientServerCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.OperationTimedoutException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.exception.StorageUnavailableException;\n+import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.network.Network;\n+import com.cloud.network.Network.Provider;\n+import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.network.VirtualRouterProvider.VirtualRouterProviderType;\n+import com.cloud.network.dao.NetworkDao;\n+import com.cloud.network.dao.NetworkVO;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.dao.VirtualRouterProviderDao;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.lb.LoadBalancingRule.LbDestination;\n+import com.cloud.network.lb.LoadBalancingRule.LbHealthCheckPolicy;\n+import com.cloud.network.lb.LoadBalancingRule.LbStickinessPolicy;\n+import com.cloud.network.lb.LoadBalancingRulesManager;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.RedundantState;\n+import com.cloud.network.router.VirtualRouter.Role;\n+import com.cloud.network.rules.FirewallRule;\n+import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.ServiceOffering;\n+import com.cloud.offerings.dao.NetworkOfferingDao;\n+import com.cloud.resource.ResourceManager;\n+import com.cloud.server.ConfigurationServer;\n+import com.cloud.service.ServiceOfferingVO;\n+import com.cloud.service.dao.ServiceOfferingDao;\n+import com.cloud.storage.VMTemplateVO;\n+import com.cloud.storage.dao.VMTemplateDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.User;\n+import com.cloud.utils.Pair;\n+import com.cloud.utils.component.ManagerBase;\n+import com.cloud.utils.db.DB;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.utils.net.NetUtils;\n+import com.cloud.vm.DomainRouterVO;\n+import com.cloud.vm.Nic;\n+import com.cloud.vm.NicProfile;\n+import com.cloud.vm.NicVO;\n+import com.cloud.vm.ReservationContext;\n+import com.cloud.vm.VirtualMachine;\n+import com.cloud.vm.VirtualMachine.State;\n+import com.cloud.vm.VirtualMachineGuru;\n+import com.cloud.vm.VirtualMachineManager;\n+import com.cloud.vm.VirtualMachineName;\n+import com.cloud.vm.VirtualMachineProfile;\n+import com.cloud.vm.VirtualMachineProfile.Param;\n+import com.cloud.vm.dao.DomainRouterDao;\n+import com.cloud.vm.dao.NicDao;\n+\n+@Component\n+@Local(value = { InternalLoadBalancerVMManager.class, InternalLoadBalancerVMService.class})\n+public class InternalLoadBalancerVMManagerImpl extends ManagerBase implements\n+    InternalLoadBalancerVMManager, VirtualMachineGuru<DomainRouterVO> {\n+    private static final Logger s_logger = Logger\n+            .getLogger(InternalLoadBalancerVMManagerImpl.class);\n+    static final private String _internalLbVmNamePrefix = \"b\";\n+    \n+    private String _instance;\n+    private String _mgmtHost;\n+    private String _mgmtCidr;\n+    private long _internalLbVmOfferingId;\n+    \n+    @Inject VirtualMachineManager _itMgr;\n+    @Inject DomainRouterDao _internalLbVmDao;\n+    @Inject ConfigurationDao _configDao;\n+    @Inject AgentManager _agentMgr;\n+    @Inject DataCenterDao _dcDao;\n+    @Inject VirtualRouterProviderDao _vrProviderDao;\n+    @Inject ApplicationLoadBalancerRuleDao _lbDao;\n+    @Inject NetworkModel _ntwkModel;\n+    @Inject LoadBalancingRulesManager _lbMgr;\n+    @Inject NicDao _nicDao;\n+    @Inject AccountManager _accountMgr;\n+    @Inject NetworkDao _networkDao;\n+    @Inject NetworkManager _ntwkMgr;\n+    @Inject ServiceOfferingDao _serviceOfferingDao;\n+    @Inject PhysicalNetworkServiceProviderDao _physicalProviderDao;\n+    @Inject NetworkOfferingDao _networkOfferingDao;\n+    @Inject VMTemplateDao _templateDao;\n+    @Inject ResourceManager _resourceMgr;\n+    @Inject ConfigurationServer _configServer;\n+\n+    @Override\n+    public DomainRouterVO findByName(String name) {\n+        if (!VirtualMachineName.isValidSystemVmName(name, _instance, _internalLbVmNamePrefix)) {\n+            return null;\n+        }\n+\n+        return _internalLbVmDao.findById(VirtualMachineName.getRouterId(name));\n+    }\n+\n+    @Override\n+    public DomainRouterVO findById(long id) {\n+        return _internalLbVmDao.findById(id);\n+    }\n+\n+    @Override\n+    public DomainRouterVO persist(DomainRouterVO vm) {\n+        DomainRouterVO virtualRouter =  _internalLbVmDao.persist(vm);\n+        return virtualRouter;\n+    }\n+\n+    @Override\n+    public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<DomainRouterVO> profile,\n+            DeployDestination dest, ReservationContext context) {\n+\n+        //Internal LB vm starts up with 2 Nics\n+        //Nic #1 - Guest Nic with IP address that would act as the LB entry point\n+        //Nic #2 - Control/Management Nic\n+        \n+        StringBuilder buf = profile.getBootArgsBuilder();\n+        buf.append(\" template=domP\");\n+        buf.append(\" name=\").append(profile.getHostName());\n+\n+        if (Boolean.valueOf(_configDao.getValue(\"system.vm.random.password\"))) {\n+            buf.append(\" vmpassword=\").append(_configDao.getValue(\"system.vm.password\"));\n+        }\n+        \n+        NicProfile controlNic = null;\n+        Network guestNetwork = null;\n+      \n+        for (NicProfile nic : profile.getNics()) {\n+            int deviceId = nic.getDeviceId();\n+            buf.append(\" eth\").append(deviceId).append(\"ip=\").append(nic.getIp4Address());\n+            buf.append(\" eth\").append(deviceId).append(\"mask=\").append(nic.getNetmask());\n+            \n+            if (nic.isDefaultNic()) {\n+                buf.append(\" gateway=\").append(nic.getGateway());\n+                buf.append(\" dns1=\").append(nic.getGateway());\n+            }\n+\n+            if (nic.getTrafficType() == TrafficType.Guest) {\n+                guestNetwork = _ntwkModel.getNetwork(nic.getNetworkId());\n+            } else if (nic.getTrafficType() == TrafficType.Management) {\n+                buf.append(\" localgw=\").append(dest.getPod().getGateway());\n+            } else if (nic.getTrafficType() == TrafficType.Control) {\n+                controlNic = nic;\n+                // Internal LB control command is sent over management server in VMware\n+                if (dest.getHost().getHypervisorType() == HypervisorType.VMware) {\n+                    if (s_logger.isInfoEnabled()) {\n+                        s_logger.info(\"Check if we need to add management server explicit route to Internal LB. pod cidr: \" \n+                                + dest.getPod().getCidrAddress() + \"/\" + dest.getPod().getCidrSize()\n+                                + \", pod gateway: \" + dest.getPod().getGateway() + \", management host: \" + _mgmtHost);\n+                    }\n+\n+                    if (s_logger.isInfoEnabled()) {\n+                        s_logger.info(\"Add management server explicit route to Internal LB.\");\n+                    }\n+                    \n+               \n+                    buf.append(\" mgmtcidr=\").append(_mgmtCidr);\n+                    buf.append(\" localgw=\").append(dest.getPod().getGateway());\n+                }\n+            }\n+        }\n+\n+        if (controlNic == null) {\n+            throw new CloudRuntimeException(\"Didn't start a control port\");\n+        }\n+                \n+        if (guestNetwork != null) {\n+            String domain = guestNetwork.getNetworkDomain();\n+            if (domain != null) {\n+                buf.append(\" domain=\" + domain);\n+            }\n+        }\n+\n+        String type = \"ilbvm\";\n+        buf.append(\" type=\" + type);\n+\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Boot Args for \" + profile + \": \" + buf.toString());\n+        }\n+\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<DomainRouterVO> profile, DeployDestination dest, ReservationContext context) throws ResourceUnavailableException {\n+        DomainRouterVO internalLbVm = profile.getVirtualMachine();\n+\n+        List<NicProfile> nics = profile.getNics();\n+        for (NicProfile nic : nics) {\n+            if (nic.getTrafficType() == TrafficType.Control) {\n+                internalLbVm.setPrivateIpAddress(nic.getIp4Address());\n+                internalLbVm.setPrivateMacAddress(nic.getMacAddress());\n+            }\n+        }\n+        _internalLbVmDao.update(internalLbVm.getId(), internalLbVm);\n+\n+        finalizeCommandsOnStart(cmds, profile);\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean finalizeStart(VirtualMachineProfile<DomainRouterVO> profile, long hostId, Commands cmds, ReservationContext context) {\n+        DomainRouterVO internalLbVm = profile.getVirtualMachine();\n+        \n+        boolean result = true;\n+\n+        Answer answer = cmds.getAnswer(\"checkSsh\");\n+        if (answer != null && answer instanceof CheckSshAnswer) {\n+            CheckSshAnswer sshAnswer = (CheckSshAnswer) answer;\n+            if (sshAnswer == null || !sshAnswer.getResult()) {\n+                s_logger.warn(\"Unable to ssh to the internal LB VM: \" + sshAnswer.getDetails());\n+                result = false;\n+            }\n+        } else {\n+            result = false;\n+        }\n+        if (result == false) {\n+            return result;\n+        }\n+        \n+        //Get guest network info\n+        List<Network> guestNetworks = new ArrayList<Network>();\n+        List<? extends Nic> internalLbVmNics = _nicDao.listByVmId(profile.getId());\n+        for (Nic internalLbVmNic : internalLbVmNics) {\n+            Network network = _ntwkModel.getNetwork(internalLbVmNic.getNetworkId());\n+            if (network.getTrafficType() == TrafficType.Guest) {\n+                guestNetworks.add(network);\n+            }\n+        }\n+        \n+        answer = cmds.getAnswer(\"getDomRVersion\");\n+        if (answer != null && answer instanceof GetDomRVersionAnswer) {\n+            GetDomRVersionAnswer versionAnswer = (GetDomRVersionAnswer)answer;\n+            if (answer == null || !answer.getResult()) {\n+                s_logger.warn(\"Unable to get the template/scripts version of internal LB VM \" + internalLbVm.getInstanceName() +\n+                        \" due to: \" + versionAnswer.getDetails());\n+                result = false;\n+            } else {\n+                internalLbVm.setTemplateVersion(versionAnswer.getTemplateVersion());\n+                internalLbVm.setScriptsVersion(versionAnswer.getScriptsVersion());\n+                internalLbVm = _internalLbVmDao.persist(internalLbVm, guestNetworks);\n+            }\n+        } else {\n+            result = false;\n+        }\n+\n+        return result;\n+    }\n+\n+    @Override\n+    public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<DomainRouterVO> profile) {\n+        DomainRouterVO internalLbVm = profile.getVirtualMachine();\n+        NicProfile controlNic = getNicProfileByTrafficType(profile, TrafficType.Control);\n+\n+        if (controlNic == null) {\n+            s_logger.error(\"Control network doesn't exist for the internal LB vm \" + internalLbVm);\n+            return false;\n+        }\n+\n+        finalizeSshAndVersionOnStart(cmds, profile, internalLbVm, controlNic);\n+\n+        // restart network if restartNetwork = false is not specified in profile parameters\n+        boolean reprogramGuestNtwk = true;\n+        if (profile.getParameter(Param.ReProgramGuestNetworks) != null \n+                && (Boolean) profile.getParameter(Param.ReProgramGuestNetworks) == false) {\n+            reprogramGuestNtwk = false;\n+        }\n+\n+        VirtualRouterProvider lbProvider = _vrProviderDao.findById(internalLbVm.getElementId());\n+        if (lbProvider == null) {\n+            throw new CloudRuntimeException(\"Cannot find related element \" + VirtualRouterProviderType.InternalLbVm + \" of vm: \" + internalLbVm.getHostName());\n+        }\n+        \n+        Provider provider = Network.Provider.getProvider(lbProvider.getType().toString());\n+        if (provider == null) {\n+            throw new CloudRuntimeException(\"Cannot find related provider of provider: \" + lbProvider.getType().toString());\n+        }\n+\n+        if (reprogramGuestNtwk) {\n+            NicProfile guestNic = getNicProfileByTrafficType(profile, TrafficType.Guest);\n+            finalizeLbRulesForIp(cmds, internalLbVm, provider, new Ip(guestNic.getIp4Address()), guestNic.getNetworkId());\n+        }\n+\n+        return true;\n+    }\n+\n+    @Override\n+    public void finalizeStop(VirtualMachineProfile<DomainRouterVO> profile, StopAnswer answer) {\n+    }\n+\n+    @Override\n+    public void finalizeExpunge(DomainRouterVO vm) {\n+    }\n+\n+    @Override\n+    public Long convertToId(String vmName) {\n+        if (!VirtualMachineName.isValidSystemVmName(vmName, _instance, _internalLbVmNamePrefix)) {\n+            return null;\n+        }\n+\n+        return VirtualMachineName.getRouterId(vmName);\n+    }\n+\n+    @Override\n+    public boolean plugNic(Network network, NicTO nic, VirtualMachineTO vm, ReservationContext context, DeployDestination dest) throws ConcurrentOperationException, ResourceUnavailableException,\n+            InsufficientCapacityException {        \n+        //not supported\n+        throw new UnsupportedOperationException(\"Plug nic is not supported for vm of type \" + vm.getType());\n+    }\n+\n+    @Override\n+    public boolean unplugNic(Network network, NicTO nic, VirtualMachineTO vm, ReservationContext context, DeployDestination dest) throws ConcurrentOperationException, ResourceUnavailableException {\n+        //not supported\n+        throw new UnsupportedOperationException(\"Unplug nic is not supported for vm of type \" + vm.getType());\n+    }\n+\n+    @Override\n+    public void prepareStop(VirtualMachineProfile<DomainRouterVO> profile) {\n+    }\n+    \n+    @Override\n+    public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n+        final Map<String, String> configs = _configDao.getConfiguration(\"AgentManager\", params);\n+        _instance = configs.get(\"instance.name\");\n+        if (_instance == null) {\n+            _instance = \"DEFAULT\";\n+        }\n+        \n+        _mgmtHost = configs.get(\"host\");\n+        _mgmtCidr = _configDao.getValue(Config.ManagementNetwork.key());\n+        \n+        String offIdStr = configs.get(Config.InternalLbVmServiceOfferingId.key());\n+        if (offIdStr != null && !offIdStr.isEmpty()) {\n+            _internalLbVmOfferingId = Long.parseLong(offIdStr);\n+        } else {\n+            boolean useLocalStorage = Boolean.parseBoolean(configs.get(Config.SystemVMUseLocalStorage.key()));\n+            ServiceOfferingVO newOff = new ServiceOfferingVO(\"System Offering For Internal LB VM\", 1, InternalLoadBalancerVMManager.DEFAULT_INTERNALLB_VM_RAMSIZE, InternalLoadBalancerVMManager.DEFAULT_INTERNALLB_VM_CPU_MHZ, null,\n+                    null, true, null, useLocalStorage, true, null, true, VirtualMachine.Type.InternalLoadBalancerVm, true);\n+            newOff.setUniqueName(ServiceOffering.internalLbVmDefaultOffUniqueName);\n+            newOff = _serviceOfferingDao.persistSystemServiceOffering(newOff);\n+            _internalLbVmOfferingId = newOff.getId();\n+        }\n+        \n+        _itMgr.registerGuru(VirtualMachine.Type.InternalLoadBalancerVm, this);\n+\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(getName()  +  \" has been configured\");\n+        }\n+        \n+        return true;\n+    }\n+    \n+    @Override\n+    public String getName() {\n+        return _name;\n+    }\n+    \n+    protected NicProfile getNicProfileByTrafficType(VirtualMachineProfile<DomainRouterVO> profile, TrafficType trafficType) {\n+        for (NicProfile nic : profile.getNics()) {\n+            if (nic.getTrafficType() == trafficType && nic.getIp4Address() != null) {\n+                return nic;\n+            }\n+        }\n+        return null;\n+     }\n+    \n+    protected void finalizeSshAndVersionOnStart(Commands cmds, VirtualMachineProfile<DomainRouterVO> profile, DomainRouterVO router, NicProfile controlNic) {\n+        cmds.addCommand(\"checkSsh\", new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922));\n+\n+        // Update internal lb vm template/scripts version\n+        final GetDomRVersionCmd command = new GetDomRVersionCmd();\n+        command.setAccessDetail(NetworkElementCommand.ROUTER_IP, controlNic.getIp4Address());\n+        command.setAccessDetail(NetworkElementCommand.ROUTER_NAME, router.getInstanceName());\n+        cmds.addCommand(\"getDomRVersion\", command);\n+    }\n+    \n+    \n+    protected void finalizeLbRulesForIp(Commands cmds, DomainRouterVO internalLbVm, Provider provider, Ip sourceIp, long guestNtwkId) {\n+        s_logger.debug(\"Resending load balancing rules as a part of start for \" + internalLbVm);\n+        List<ApplicationLoadBalancerRuleVO> lbs = _lbDao.listBySrcIpSrcNtwkId(sourceIp, guestNtwkId);\n+        List<LoadBalancingRule> lbRules = new ArrayList<LoadBalancingRule>();\n+        if (_ntwkModel.isProviderSupportServiceInNetwork(guestNtwkId, Service.Lb, provider)) {\n+            // Re-apply load balancing rules\n+            for (ApplicationLoadBalancerRuleVO lb : lbs) {\n+                List<LbDestination> dstList = _lbMgr.getExistingDestinations(lb.getId());\n+                List<LbStickinessPolicy> policyList = _lbMgr.getStickinessPolicies(lb.getId());\n+                List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId());\n+                LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList, sourceIp);\n+                lbRules.add(loadBalancing);\n+            }\n+        }\n+\n+        s_logger.debug(\"Found \" + lbRules.size() + \" load balancing rule(s) to apply as a part of Intenrnal LB vm\" + internalLbVm + \" start.\");\n+        if (!lbRules.isEmpty()) {\n+            createApplyLoadBalancingRulesCommands(lbRules, internalLbVm, cmds, guestNtwkId);\n+        }\n+    }\n+    \n+    private void createApplyLoadBalancingRulesCommands(List<LoadBalancingRule> rules, VirtualRouter internalLbVm, Commands cmds, long guestNetworkId) {\n+\n+        LoadBalancerTO[] lbs = new LoadBalancerTO[rules.size()];\n+        int i = 0;\n+        boolean inline = false;\n+        for (LoadBalancingRule rule : rules) {\n+            boolean revoked = (rule.getState().equals(FirewallRule.State.Revoke));\n+            String protocol = rule.getProtocol();\n+            String algorithm = rule.getAlgorithm();\n+            String uuid = rule.getUuid();\n+\n+            String srcIp = rule.getSourceIp().addr();\n+            int srcPort = rule.getSourcePortStart();\n+            List<LbDestination> destinations = rule.getDestinations();\n+            List<LbStickinessPolicy> stickinessPolicies = rule.getStickinessPolicies();\n+            LoadBalancerTO lb = new LoadBalancerTO(uuid, srcIp, srcPort, protocol, algorithm, revoked, false, inline, destinations, stickinessPolicies);\n+            lbs[i++] = lb;\n+        }\n+        \n+        Network guestNetwork = _ntwkModel.getNetwork(guestNetworkId);\n+        Nic guestNic = _nicDao.findByNtwkIdAndInstanceId(guestNetwork.getId(), internalLbVm.getId());\n+        NicProfile guestNicProfile = new NicProfile(guestNic, guestNetwork, guestNic.getBroadcastUri(), guestNic.getIsolationUri(), \n+                _ntwkModel.getNetworkRate(guestNetwork.getId(), internalLbVm.getId()), \n+                _ntwkModel.isSecurityGroupSupportedInNetwork(guestNetwork), \n+                _ntwkModel.getNetworkTag(internalLbVm.getHypervisorType(), guestNetwork));\n+\n+        LoadBalancerConfigCommand cmd = new LoadBalancerConfigCommand(lbs, guestNic.getIp4Address(), \n+                guestNic.getIp4Address(), internalLbVm.getPrivateIpAddress(), \n+                _itMgr.toNicTO(guestNicProfile, internalLbVm.getHypervisorType()), internalLbVm.getVpcId());\n+\n+        cmd.lbStatsVisibility = _configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key());\n+        cmd.lbStatsUri = _configDao.getValue(Config.NetworkLBHaproxyStatsUri.key());\n+        cmd.lbStatsAuth = _configDao.getValue(Config.NetworkLBHaproxyStatsAuth.key());\n+        cmd.lbStatsPort = _configDao.getValue(Config.NetworkLBHaproxyStatsPort.key());\n+\n+        cmd.setAccessDetail(NetworkElementCommand.ROUTER_IP, getInternalLbControlIp(internalLbVm.getId()));\n+        cmd.setAccessDetail(NetworkElementCommand.ROUTER_GUEST_IP, guestNic.getIp4Address());\n+        cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME, internalLbVm.getInstanceName());\n+        DataCenterVO dcVo = _dcDao.findById(internalLbVm.getDataCenterId());\n+        cmd.setAccessDetail(NetworkElementCommand.ZONE_NETWORK_TYPE, dcVo.getNetworkType().toString());\n+        cmds.addCommand(cmd);\n+    }\n+    \n+    \n+    protected String getInternalLbControlIp(long internalLbVmId) {\n+        String controlIpAddress = null;\n+        List<NicVO> nics = _nicDao.listByVmId(internalLbVmId);\n+        for (NicVO nic : nics) {\n+            Network ntwk = _ntwkModel.getNetwork(nic.getNetworkId());\n+            if (ntwk.getTrafficType() == TrafficType.Control) {\n+                controlIpAddress = nic.getIp4Address();\n+            }\n+        }\n+        \n+        if(controlIpAddress == null) {\n+            s_logger.warn(\"Unable to find Internal LB control ip in its attached NICs!. Internal LB vm: \" + internalLbVmId);\n+            DomainRouterVO internalLbVm = _internalLbVmDao.findById(internalLbVmId);\n+            return internalLbVm.getPrivateIpAddress();\n+        }\n+            \n+        return controlIpAddress;\n+    }\n+\n+    @Override\n+    public boolean destroyInternalLbVm(long vmId, Account caller, Long callerUserId)\n+            throws ResourceUnavailableException, ConcurrentOperationException {\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Attempting to destroy Internal LB vm \" + vmId);\n+        }\n+\n+        DomainRouterVO internalLbVm = _internalLbVmDao.findById(vmId);\n+        if (internalLbVm == null) {\n+            return true;\n+        }\n+\n+        _accountMgr.checkAccess(caller, null, true, internalLbVm);\n+\n+        return _itMgr.expunge(internalLbVm, _accountMgr.getActiveUser(callerUserId), caller); \n+    }\n+\n+    \n+    @Override\n+    public VirtualRouter stopInternalLbVm(long vmId, boolean forced, Account caller, long callerUserId) throws ConcurrentOperationException,\n+    ResourceUnavailableException {\n+        DomainRouterVO internalLbVm = _internalLbVmDao.findById(vmId);\n+        if (internalLbVm == null || internalLbVm.getRole() != Role.INTERNAL_LB_VM) {\n+            throw new InvalidParameterValueException(\"Can't find internal lb vm by id specified\");\n+        }\n+        \n+        return stopInternalLbVm(internalLbVm, forced, caller, callerUserId);\n+    }\n+\n+    protected VirtualRouter stopInternalLbVm(DomainRouterVO internalLbVm, boolean forced, Account caller, long callerUserId) throws ResourceUnavailableException, ConcurrentOperationException {\n+        s_logger.debug(\"Stopping internal lb vm \" + internalLbVm);\n+        try {\n+            if (_itMgr.advanceStop((DomainRouterVO) internalLbVm, forced, _accountMgr.getActiveUser(callerUserId), caller)) {\n+                return _internalLbVmDao.findById(internalLbVm.getId());\n+            } else {\n+                return null;\n+            }\n+        } catch (OperationTimedoutException e) {\n+            throw new CloudRuntimeException(\"Unable to stop \" + internalLbVm, e);\n+        }\n+    }\n+    \n+    \n+    @Override\n+    public List<DomainRouterVO> deployInternalLbVm(Network guestNetwork, Ip requestedGuestIp, DeployDestination dest, \n+            Account owner, Map<Param, Object> params) throws InsufficientCapacityException,\n+            ConcurrentOperationException, ResourceUnavailableException {\n+\n+        List<DomainRouterVO> internalLbVms = findOrDeployInternalLbVm(guestNetwork, requestedGuestIp, dest, owner, params);\n+        \n+        return startInternalLbVms(params, internalLbVms);\n+    }\n+    \n+    protected List<DomainRouterVO> startInternalLbVms(Map<Param, Object> params, List<DomainRouterVO> internalLbVms) \n+            throws StorageUnavailableException, InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException {\n+        List<DomainRouterVO> runningInternalLbVms = null;\n+\n+        if (internalLbVms != null) {\n+            runningInternalLbVms = new ArrayList<DomainRouterVO>();\n+        } else {\n+            s_logger.debug(\"Have no internal lb vms to start\");\n+            return null;\n+        }\n+\n+        for (DomainRouterVO internalLbVm : internalLbVms) {\n+            if (internalLbVm.getState() != VirtualMachine.State.Running) {\n+                internalLbVm = startInternalLbVm(internalLbVm, _accountMgr.getSystemAccount(), User.UID_SYSTEM, params);\n+            }\n+            \n+            if (internalLbVm != null) {\n+                runningInternalLbVms.add(internalLbVm);\n+            }\n+        }\n+        return runningInternalLbVms;\n+    }\n+    \n+    \n+    \n+    @DB\n+    protected List<DomainRouterVO> findOrDeployInternalLbVm(Network guestNetwork, Ip requestedGuestIp, DeployDestination dest, \n+            Account owner, Map<Param, Object> params) throws ConcurrentOperationException, \n+            InsufficientCapacityException, ResourceUnavailableException {\n+\n+        List<DomainRouterVO> internalLbVms = new ArrayList<DomainRouterVO>();\n+        Network lock = _networkDao.acquireInLockTable(guestNetwork.getId(), _ntwkMgr.getNetworkLockTimeout());\n+        if (lock == null) {\n+            throw new ConcurrentOperationException(\"Unable to lock network \" + guestNetwork.getId());\n+        }\n+        \n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Lock is acquired for network id \" + lock.getId() + \" as a part of internal lb startup in \" + dest);\n+        }\n+        \n+        long internalLbProviderId = getInternalLbProviderId(guestNetwork);\n+        \n+        try {\n+            assert guestNetwork.getState() == Network.State.Implemented || guestNetwork.getState() == Network.State.Setup ||\n+                    guestNetwork.getState() == Network.State.Implementing : \"Network is not yet fully implemented: \"\n+                    + guestNetwork;\n+            assert guestNetwork.getTrafficType() == TrafficType.Guest;\n+\n+            //deploy internal lb vm\n+            Pair<DeploymentPlan, List<DomainRouterVO>> planAndInternalLbVms = getDeploymentPlanAndInternalLbVms(dest, guestNetwork.getId(), requestedGuestIp);\n+            internalLbVms = planAndInternalLbVms.second();\n+            DeploymentPlan plan = planAndInternalLbVms.first();\n+            \n+            if (internalLbVms.size() > 0) {\n+                s_logger.debug(\"Found \" + internalLbVms.size() + \" internal lb vms for the requested IP \" + requestedGuestIp.addr());\n+                return internalLbVms;\n+            }\n+\n+            List<Pair<NetworkVO, NicProfile>> networks = createInternalLbVmNetworks(guestNetwork, plan, requestedGuestIp);\n+            //Pass startVm=false as we are holding the network lock that needs to be released at the end of vm allocation\n+            DomainRouterVO internalLbVm = deployInternalLbVm(owner, dest, plan, params, internalLbProviderId, _internalLbVmOfferingId, guestNetwork.getVpcId(),\n+                networks, false);\n+            if (internalLbVm != null) {\n+                _internalLbVmDao.addRouterToGuestNetwork(internalLbVm, guestNetwork);\n+                internalLbVms.add(internalLbVm);\n+            }\n+        } finally {\n+            if (lock != null) {\n+                _networkDao.releaseFromLockTable(lock.getId());\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Lock is released for network id \" + lock.getId() + \" as a part of internal lb vm startup in \" + dest);\n+                }\n+            }\n+        }\n+        return internalLbVms;\n+    }\n+\n+    protected long getInternalLbProviderId(Network guestNetwork) {\n+        VirtualRouterProviderType type = VirtualRouterProviderType.InternalLbVm;\n+        long physicalNetworkId = _ntwkModel.getPhysicalNetworkId(guestNetwork);\n+        \n+        PhysicalNetworkServiceProvider provider = _physicalProviderDao.findByServiceProvider(physicalNetworkId, type.toString());\n+        if (provider == null) {\n+            throw new CloudRuntimeException(\"Cannot find service provider \" + type.toString() + \" in physical network \" + physicalNetworkId);\n+        }\n+        \n+        VirtualRouterProvider internalLbProvider = _vrProviderDao.findByNspIdAndType(provider.getId(), type);\n+        if (internalLbProvider == null) {\n+            throw new CloudRuntimeException(\"Cannot find provider \" + type.toString() + \" as service provider \" + provider.getId());\n+        }\n+        \n+        return internalLbProvider.getId();\n+    }\n+    \n+    protected List<Pair<NetworkVO, NicProfile>> createInternalLbVmNetworks(Network guestNetwork, DeploymentPlan plan, Ip guestIp) throws ConcurrentOperationException,\n+            InsufficientAddressCapacityException {\n+\n+        //Form networks\n+        List<Pair<NetworkVO, NicProfile>> networks = new ArrayList<Pair<NetworkVO, NicProfile>>(3);\n+        \n+        //1) Guest network - default\n+        if (guestNetwork != null) {\n+            s_logger.debug(\"Adding nic for Internal LB in Guest network \" + guestNetwork);\n+            NicProfile guestNic = new NicProfile();\n+            if (guestIp != null) {\n+                guestNic.setIp4Address(guestIp.addr());  \n+            } else {\n+                guestNic.setIp4Address(_ntwkMgr.acquireGuestIpAddress(guestNetwork, null));\n+            }\n+            guestNic.setGateway(guestNetwork.getGateway());\n+            guestNic.setBroadcastUri(guestNetwork.getBroadcastUri());\n+            guestNic.setBroadcastType(guestNetwork.getBroadcastDomainType());\n+            guestNic.setIsolationUri(guestNetwork.getBroadcastUri());\n+            guestNic.setMode(guestNetwork.getMode());\n+            String gatewayCidr = guestNetwork.getCidr();\n+            guestNic.setNetmask(NetUtils.getCidrNetmask(gatewayCidr));\n+            guestNic.setDefaultNic(true);\n+            networks.add(new Pair<NetworkVO, NicProfile>((NetworkVO) guestNetwork, guestNic));\n+        }\n+\n+        //2) Control network\n+        s_logger.debug(\"Adding nic for Internal LB vm in Control network \");\n+        List<? extends NetworkOffering> offerings = _ntwkModel.getSystemAccountNetworkOfferings(NetworkOffering.SystemControlNetwork);\n+        NetworkOffering controlOffering = offerings.get(0);\n+        NetworkVO controlConfig = _ntwkMgr.setupNetwork(_accountMgr.getSystemAccount(), controlOffering, plan, null, null, false).get(0);\n+        networks.add(new Pair<NetworkVO, NicProfile>(controlConfig, null));\n+\n+        return networks;\n+    }\n+    \n+    \n+    protected Pair<DeploymentPlan, List<DomainRouterVO>> getDeploymentPlanAndInternalLbVms(DeployDestination dest, long guestNetworkId, Ip requestedGuestIp) {\n+        long dcId = dest.getDataCenter().getId();\n+        DeploymentPlan plan = new DataCenterDeployment(dcId);\n+        List<DomainRouterVO> internalLbVms = findInternalLbVms(guestNetworkId, requestedGuestIp);\n+\n+        return new Pair<DeploymentPlan, List<DomainRouterVO>>(plan, internalLbVms);\n+    \n+    }\n+\n+    @Override\n+    public List<DomainRouterVO> findInternalLbVms(long guestNetworkId, Ip requestedGuestIp) {\n+        List<DomainRouterVO> internalLbVms = _internalLbVmDao.listByNetworkAndRole(guestNetworkId, Role.INTERNAL_LB_VM);\n+        if (requestedGuestIp != null && !internalLbVms.isEmpty()) {\n+            Iterator<DomainRouterVO> it = internalLbVms.iterator();\n+            while (it.hasNext()) {\n+                DomainRouterVO vm = it.next();\n+                Nic nic = _nicDao.findByNtwkIdAndInstanceId(guestNetworkId, vm.getId());\n+                if (!nic.getIp4Address().equalsIgnoreCase(requestedGuestIp.addr())) {\n+                    it.remove();\n+                }\n+            }\n+        }\n+        return internalLbVms;\n+    }\n+    \n+    \n+    protected DomainRouterVO deployInternalLbVm(Account owner, DeployDestination dest, DeploymentPlan plan, Map<Param, Object> params,\n+            long internalLbProviderId, long svcOffId, Long vpcId,\n+            List<Pair<NetworkVO, NicProfile>> networks, boolean startVm) throws ConcurrentOperationException,\n+            InsufficientAddressCapacityException, InsufficientServerCapacityException, InsufficientCapacityException,\n+            StorageUnavailableException, ResourceUnavailableException {\n+        \n+        long id = _internalLbVmDao.getNextInSequence(Long.class, \"id\");\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Creating the internal lb vm \" + id + \" in datacenter \"  + dest.getDataCenter());\n+        }\n+\n+        ServiceOfferingVO routerOffering = _serviceOfferingDao.findById(svcOffId);\n+\n+        // Internal lb is the network element, we don't know the hypervisor type yet.\n+        // Try to allocate the internal lb twice using diff hypervisors, and when failed both times, throw the exception up\n+        List<HypervisorType> hypervisors = getHypervisors(dest, plan, null);\n+\n+        int allocateRetry = 0;\n+        int startRetry = 0;\n+        DomainRouterVO internalLbVm = null;\n+        for (Iterator<HypervisorType> iter = hypervisors.iterator(); iter.hasNext();) {\n+            HypervisorType hType = iter.next();\n+            try {\n+                s_logger.debug(\"Allocating the Internal lb with the hypervisor type \" + hType);\n+                String templateName = null;\n+                switch (hType) {\n+                    case XenServer:\n+                        templateName = _configServer.getConfigValue(Config.RouterTemplateXen.key(), Config.ConfigurationParameterScope.zone.toString(), dest.getDataCenter().getId());\n+                        break;\n+                    case KVM:\n+                        templateName = _configServer.getConfigValue(Config.RouterTemplateKVM.key(), Config.ConfigurationParameterScope.zone.toString(), dest.getDataCenter().getId());\n+                        break;\n+                    case VMware:\n+                        templateName = _configServer.getConfigValue(Config.RouterTemplateVmware.key(), Config.ConfigurationParameterScope.zone.toString(), dest.getDataCenter().getId());\n+                        break;\n+                    case Hyperv:\n+                        templateName = _configServer.getConfigValue(Config.RouterTemplateHyperv.key(), Config.ConfigurationParameterScope.zone.toString(), dest.getDataCenter().getId());\n+                        break;\n+                    case LXC:\n+                        templateName = _configServer.getConfigValue(Config.RouterTemplateLXC.key(), Config.ConfigurationParameterScope.zone.toString(), dest.getDataCenter().getId());\n+                        break;\n+                    default: break;\n+                }\n+                VMTemplateVO template = _templateDao.findRoutingTemplate(hType, templateName);\n+\n+                if (template == null) {\n+                    s_logger.debug(hType + \" won't support system vm, skip it\");\n+                    continue;\n+                }\n+\n+                internalLbVm = new DomainRouterVO(id, routerOffering.getId(), internalLbProviderId, \n+                VirtualMachineName.getSystemVmName(id, _instance, _internalLbVmNamePrefix), template.getId(), template.getHypervisorType(),\n+                template.getGuestOSId(), owner.getDomainId(), owner.getId(), false, 0, false, \n+                RedundantState.UNKNOWN, false, false, VirtualMachine.Type.InternalLoadBalancerVm, vpcId);\n+                internalLbVm.setRole(Role.INTERNAL_LB_VM);\n+                internalLbVm = _itMgr.allocate(internalLbVm, template, routerOffering, networks, plan, null, owner);\n+            } catch (InsufficientCapacityException ex) {\n+                if (allocateRetry < 2 && iter.hasNext()) {\n+                    s_logger.debug(\"Failed to allocate the Internal lb vm with hypervisor type \" + hType + \", retrying one more time\");\n+                    continue;\n+                } else {\n+                    throw ex;\n+                }\n+            } finally {\n+                allocateRetry++;\n+            }\n+\n+            if (startVm) {\n+                try {\n+                    internalLbVm = startInternalLbVm(internalLbVm, _accountMgr.getSystemAccount(), User.UID_SYSTEM, params);\n+                    break;\n+                } catch (InsufficientCapacityException ex) {\n+                    if (startRetry < 2 && iter.hasNext()) {\n+                        s_logger.debug(\"Failed to start the Internal lb vm  \" + internalLbVm + \" with hypervisor type \" + hType + \", \" +\n+                                \"destroying it and recreating one more time\");\n+                        // destroy the internal lb vm\n+                        destroyInternalLbVm(internalLbVm.getId(), _accountMgr.getSystemAccount(), User.UID_SYSTEM);\n+                        continue;\n+                    } else {\n+                        throw ex;\n+                    }\n+                } finally {\n+                    startRetry++;\n+                }\n+            } else {\n+                //return stopped internal lb vm\n+                return internalLbVm;\n+            }\n+        }\n+        return internalLbVm;\n+    }\n+    \n+    \n+\n+    protected DomainRouterVO startInternalLbVm(DomainRouterVO internalLbVm, Account caller, long callerUserId, Map<Param, Object> params) \n+            throws StorageUnavailableException, InsufficientCapacityException,\n+            ConcurrentOperationException, ResourceUnavailableException {\n+        s_logger.debug(\"Starting Internal LB VM \" + internalLbVm);\n+        if (_itMgr.start(internalLbVm, params, _accountMgr.getUserIncludingRemoved(callerUserId), caller, null) != null) {\n+            if (internalLbVm.isStopPending()) {\n+                s_logger.info(\"Clear the stop pending flag of Internal LB VM \" + internalLbVm.getHostName() + \" after start router successfully!\");\n+                internalLbVm.setStopPending(false);\n+                internalLbVm = _internalLbVmDao.persist(internalLbVm);\n+            }\n+            return _internalLbVmDao.findById(internalLbVm.getId());\n+        } else {\n+            return null;\n+        }\n+    }\n+    \n+    \n+    protected List<HypervisorType> getHypervisors(DeployDestination dest, DeploymentPlan plan, \n+            List<HypervisorType> supportedHypervisors) throws InsufficientServerCapacityException {\n+        List<HypervisorType> hypervisors = new ArrayList<HypervisorType>();\n+\n+        HypervisorType defaults = _resourceMgr.getDefaultHypervisor(dest.getDataCenter().getId());\n+        if (defaults != HypervisorType.None) {\n+            hypervisors.add(defaults);\n+        } else {\n+            //if there is no default hypervisor, get it from the cluster\n+            hypervisors = _resourceMgr.getSupportedHypervisorTypes(dest.getDataCenter().getId(), true,\n+                plan.getPodId());\n+        }\n+\n+        //keep only elements defined in supported hypervisors\n+        StringBuilder hTypesStr = new StringBuilder();\n+        if (supportedHypervisors != null && !supportedHypervisors.isEmpty()) {\n+            hypervisors.retainAll(supportedHypervisors);\n+            for (HypervisorType hType : supportedHypervisors) {\n+                hTypesStr.append(hType).append(\" \");\n+            }\n+        }\n+\n+        if (hypervisors.isEmpty()) {\n+            throw new InsufficientServerCapacityException(\"Unable to create internal lb vm, \" +\n+                    \"there are no clusters in the zone \", DataCenter.class, dest.getDataCenter().getId());\n+        }\n+        return hypervisors;\n+    }\n+    \n+    @Override\n+    public boolean applyLoadBalancingRules(Network network, final List<LoadBalancingRule> rules, List<? extends VirtualRouter> internalLbVms) \n+            throws ResourceUnavailableException {\n+        if (rules == null || rules.isEmpty()) {\n+            s_logger.debug(\"No lb rules to be applied for network \" + network);\n+            return true;\n+        }\n+        \n+        //only one internal lb vm is supported per ip address at this time\n+        if (internalLbVms == null || internalLbVms.isEmpty()) {\n+            throw new CloudRuntimeException(\"Can't apply the lb rules on network \" + network + \" as the list of internal lb vms is empty\");\n+        }\n+        \n+        VirtualRouter lbVm = internalLbVms.get(0);\n+        if (lbVm.getState() == State.Running) {\n+            return sendLBRules(lbVm, rules, network.getId());\n+        } else if (lbVm.getState() == State.Stopped || lbVm.getState() == State.Stopping) {\n+            s_logger.debug(\"Internal LB VM \" + lbVm.getInstanceName() + \" is in \" + lbVm.getState() + \n+                    \", so not sending apply lb rules commands to the backend\");\n+            return true;\n+        } else {\n+            s_logger.warn(\"Unable to apply lb rules, Internal LB VM is not in the right state \" + lbVm.getState());\n+            throw new ResourceUnavailableException(\"Unable to apply lb rules; Internal LB VM is not in the right state\", DataCenter.class, lbVm.getDataCenterId());\n+        }\n+    }\n+    \n+    protected boolean sendLBRules(VirtualRouter internalLbVm, List<LoadBalancingRule> rules, long guestNetworkId) throws ResourceUnavailableException {\n+        Commands cmds = new Commands(OnError.Continue);\n+        createApplyLoadBalancingRulesCommands(rules, internalLbVm, cmds, guestNetworkId);\n+        return sendCommandsToInternalLbVm(internalLbVm, cmds);\n+    }\n+    \n+    \n+    protected boolean sendCommandsToInternalLbVm(final VirtualRouter internalLbVm, Commands cmds) throws AgentUnavailableException {\n+        Answer[] answers = null;\n+        try {\n+            answers = _agentMgr.send(internalLbVm.getHostId(), cmds);\n+        } catch (OperationTimedoutException e) {\n+            s_logger.warn(\"Timed Out\", e);\n+            throw new AgentUnavailableException(\"Unable to send commands to virtual router \", internalLbVm.getHostId(), e);\n+        }\n+\n+        if (answers == null) {\n+            return false;\n+        }\n+\n+        if (answers.length != cmds.size()) {\n+            return false;\n+        }\n+\n+        boolean result = true;\n+        if (answers.length > 0) {\n+            for (Answer answer : answers) {\n+                if (!answer.getResult()) {\n+                    result = false;\n+                    break;\n+                }\n+            }\n+        }\n+        return result;\n+    }\n+    \n+    \n+    @Override\n+    public VirtualRouter startInternalLbVm(long internalLbVmId, Account caller, long callerUserId) \n+            throws StorageUnavailableException, InsufficientCapacityException,\n+            ConcurrentOperationException, ResourceUnavailableException {\n+        \n+        DomainRouterVO internalLbVm = _internalLbVmDao.findById(internalLbVmId);\n+        if (internalLbVm == null || internalLbVm.getRole() != Role.INTERNAL_LB_VM) {\n+            throw new InvalidParameterValueException(\"Can't find internal lb vm by id specified\");\n+        }\n+        \n+        return startInternalLbVm(internalLbVm, caller, callerUserId, null);\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/src/org/apache/cloudstack/network/lb/InternalLoadBalancerVMManagerImpl.java",
                "sha": "fe32a7ba26ff5bbf21b573ac885a2f1608a6492c",
                "status": "added"
            },
            {
                "additions": 124,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/ElementChildTestConfiguration.java",
                "changes": 124,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/ElementChildTestConfiguration.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/ElementChildTestConfiguration.java",
                "patch": "@@ -0,0 +1,124 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.internallbelement;\n+\n+import java.io.IOException;\n+\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.cloudstack.network.lb.InternalLoadBalancerVMManager;\n+import org.apache.cloudstack.test.utils.SpringUtils;\n+import org.mockito.Mockito;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.context.annotation.ComponentScan.Filter;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.FilterType;\n+import org.springframework.core.type.classreading.MetadataReader;\n+import org.springframework.core.type.classreading.MetadataReaderFactory;\n+import org.springframework.core.type.filter.TypeFilter;\n+\n+import com.cloud.configuration.ConfigurationManager;\n+import com.cloud.dc.dao.AccountVlanMapDaoImpl;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.dao.NetworkServiceMapDao;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.dao.VirtualRouterProviderDao;\n+import com.cloud.user.AccountManager;\n+import com.cloud.vm.dao.DomainRouterDao;\n+\n+@Configuration\n+@ComponentScan(\n+    basePackageClasses={\n+        AccountVlanMapDaoImpl.class\n+    },\n+    includeFilters={@Filter(value=ElementChildTestConfiguration.Library.class, type=FilterType.CUSTOM)},\n+    useDefaultFilters=false\n+    )\n+\n+public class ElementChildTestConfiguration {\n+    public static class Library implements TypeFilter { \n+        @Bean\n+        public AccountManager accountManager() {\n+            return Mockito.mock(AccountManager.class);\n+        }\n+        \n+       \n+        @Bean\n+        public DomainRouterDao domainRouterDao() {\n+            return Mockito.mock(DomainRouterDao.class);\n+        }\n+        \n+        @Bean\n+        public VirtualRouterProviderDao virtualRouterProviderDao() {\n+            return Mockito.mock(VirtualRouterProviderDao.class);\n+        }\n+        \n+        @Bean\n+        public NetworkModel networkModel() {\n+            return Mockito.mock(NetworkModel.class);\n+        }\n+        \n+        \n+        @Bean\n+        public NetworkManager networkManager() {\n+            return Mockito.mock(NetworkManager.class);\n+        }\n+\n+        \n+        @Bean\n+        public PhysicalNetworkServiceProviderDao physicalNetworkServiceProviderDao() {\n+            return Mockito.mock(PhysicalNetworkServiceProviderDao.class);\n+        }\n+        \n+        @Bean\n+        public NetworkServiceMapDao networkServiceMapDao() {\n+            return Mockito.mock(NetworkServiceMapDao.class);\n+        }\n+        \n+        @Bean\n+        public InternalLoadBalancerVMManager internalLoadBalancerVMManager() {\n+            return Mockito.mock(InternalLoadBalancerVMManager.class);\n+        }\n+        \n+        @Bean\n+        public ConfigurationManager confugurationManager() {\n+            return Mockito.mock(ConfigurationManager.class);\n+        }\n+        \n+        \n+        @Bean\n+        public ApplicationLoadBalancerRuleDao applicationLoadBalancerRuleDao() {\n+            return Mockito.mock(ApplicationLoadBalancerRuleDao.class);\n+        }\n+        \n+        @Bean\n+        public DataCenterDao dataCenterDao() {\n+            return Mockito.mock(DataCenterDao.class);\n+        }\n+        \n+        \n+        \n+        @Override\n+        public boolean match(MetadataReader mdr, MetadataReaderFactory arg1) throws IOException {\n+            mdr.getClassMetadata().getClassName();\n+            ComponentScan cs = ElementChildTestConfiguration.class.getAnnotation(ComponentScan.class);\n+            return SpringUtils.includedInBasePackageClasses(mdr.getClassMetadata().getClassName(), cs);\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/ElementChildTestConfiguration.java",
                "sha": "6959b951fc344b19e2343b9995ca00830709aa06",
                "status": "added"
            },
            {
                "additions": 190,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementServiceTest.java",
                "changes": 190,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementServiceTest.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementServiceTest.java",
                "patch": "@@ -0,0 +1,190 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.internallbelement;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElementService;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.network.VirtualRouterProvider;\n+import com.cloud.network.VirtualRouterProvider.VirtualRouterProviderType;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderVO;\n+import com.cloud.network.dao.VirtualRouterProviderDao;\n+import com.cloud.network.element.VirtualRouterProviderVO;\n+import com.cloud.user.AccountManager;\n+import com.cloud.utils.component.ComponentContext;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations=\"classpath:/lb_element.xml\")\n+public class InternalLbElementServiceTest {\n+    //The interface to test\n+    @Inject InternalLoadBalancerElementService _lbElSvc;\n+    \n+    //Mocked interfaces\n+    @Inject AccountManager _accountMgr;\n+    @Inject VirtualRouterProviderDao _vrProviderDao;\n+    @Inject PhysicalNetworkServiceProviderDao _pNtwkProviderDao;\n+    \n+    long validElId = 1L;\n+    long nonExistingElId = 2L;\n+    long invalidElId = 3L; //not of VirtualRouterProviderType\n+    \n+    long validProviderId = 1L;\n+    long nonExistingProviderId = 2L;\n+    long invalidProviderId = 3L;\n+        \n+\n+    @Before\n+    public void setUp() {\n+        \n+        ComponentContext.initComponentsLifeCycle();\n+        VirtualRouterProviderVO validElement = new VirtualRouterProviderVO(1, VirtualRouterProviderType.InternalLbVm);\n+        VirtualRouterProviderVO invalidElement = new VirtualRouterProviderVO(1, VirtualRouterProviderType.VirtualRouter);\n+        \n+        Mockito.when(_vrProviderDao.findById(validElId)).thenReturn(validElement);\n+        Mockito.when(_vrProviderDao.findById(invalidElId)).thenReturn(invalidElement);\n+        \n+        Mockito.when(_vrProviderDao.persist(validElement)).thenReturn(validElement);\n+        \n+        Mockito.when(_vrProviderDao.findByNspIdAndType(validProviderId, VirtualRouterProviderType.InternalLbVm)).thenReturn(validElement);\n+        \n+        PhysicalNetworkServiceProviderVO validProvider = new PhysicalNetworkServiceProviderVO(1, \"InternalLoadBalancerElement\");\n+        PhysicalNetworkServiceProviderVO invalidProvider = new PhysicalNetworkServiceProviderVO(1, \"Invalid name!\");\n+\n+        Mockito.when(_pNtwkProviderDao.findById(validProviderId)).thenReturn(validProvider);\n+        Mockito.when(_pNtwkProviderDao.findById(invalidProviderId)).thenReturn(invalidProvider);\n+        \n+        Mockito.when(_vrProviderDao.persist(Mockito.any(VirtualRouterProviderVO.class))).thenReturn(validElement); \n+    }\n+    \n+    //TESTS FOR getInternalLoadBalancerElement METHOD\n+    \n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void findNonExistingVm() {\n+        String expectedExcText = null;\n+        try {\n+            _lbElSvc.getInternalLoadBalancerElement(nonExistingElId); \n+        } catch (InvalidParameterValueException e) {\n+            expectedExcText = e.getMessage();\n+            throw e;\n+        } finally {\n+            assertEquals(\"Test failed. The non-existing intenral lb provider was found\"\n+        + expectedExcText, expectedExcText, \"Unable to find InternalLoadBalancerElementService by id\");\n+        }\n+    }\n+    \n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void findInvalidVm() {\n+        String expectedExcText = null;\n+        try {\n+            _lbElSvc.getInternalLoadBalancerElement(invalidElId); \n+        } catch (InvalidParameterValueException e) {\n+            expectedExcText = e.getMessage();\n+            throw e;\n+        } finally {\n+            assertEquals(\"Test failed. The non-existing intenral lb provider was found\"\n+                    + expectedExcText, expectedExcText, \"Unable to find InternalLoadBalancerElementService by id\");\n+        }\n+    }\n+    \n+    \n+    @Test\n+    public void findValidVm() {\n+        VirtualRouterProvider provider = null;\n+        try {\n+            provider = _lbElSvc.getInternalLoadBalancerElement(validElId); \n+        } finally {\n+            assertNotNull(\"Test failed. Couldn't find the VR provider by the valid id\",provider); \n+        }\n+    }\n+    \n+    \n+    //TESTS FOR configureInternalLoadBalancerElement METHOD\n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void configureNonExistingVm() {\n+        \n+        _lbElSvc.configureInternalLoadBalancerElement(nonExistingElId, true); \n+        \n+    }\n+    \n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void ConfigureInvalidVm() {\n+        _lbElSvc.configureInternalLoadBalancerElement(invalidElId, true);    \n+    }\n+    \n+    \n+    @Test\n+    public void enableProvider() {\n+        VirtualRouterProvider provider = null;\n+        try {\n+            provider = _lbElSvc.configureInternalLoadBalancerElement(validElId, true); \n+        } finally {\n+            assertNotNull(\"Test failed. Couldn't find the VR provider by the valid id \",provider);\n+            assertTrue(\"Test failed. The provider wasn't eanbled \", provider.isEnabled()); \n+        }\n+    }\n+    \n+    @Test\n+    public void disableProvider() {\n+        VirtualRouterProvider provider = null;\n+        try {\n+            provider = _lbElSvc.configureInternalLoadBalancerElement(validElId, false); \n+        } finally {\n+            assertNotNull(\"Test failed. Couldn't find the VR provider by the valid id \",provider);\n+            assertFalse(\"Test failed. The provider wasn't disabled \", provider.isEnabled()); \n+        }\n+    } \n+    \n+    //TESTS FOR addInternalLoadBalancerElement METHOD\n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void addToNonExistingProvider() {\n+        \n+        _lbElSvc.addInternalLoadBalancerElement(nonExistingProviderId); \n+        \n+    }\n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void addToInvalidProvider() {\n+        _lbElSvc.addInternalLoadBalancerElement(invalidProviderId);   \n+    }\n+    \n+    @Test\n+    public void addToExistingProvider() {\n+        _lbElSvc.addInternalLoadBalancerElement(validProviderId);\n+    }\n+\n+}\n+\n+",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementServiceTest.java",
                "sha": "f0e951cdc7ab2ddc46be6fbc688337a1537e4464",
                "status": "added"
            },
            {
                "additions": 226,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementTest.java",
                "changes": 226,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementTest.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementTest.java",
                "patch": "@@ -0,0 +1,226 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.internallbelement;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElement;\n+import org.apache.cloudstack.network.lb.InternalLoadBalancerVMManager;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import com.cloud.agent.api.to.LoadBalancerTO;\n+import com.cloud.configuration.ConfigurationManager;\n+import com.cloud.dc.DataCenter.NetworkType;\n+import com.cloud.dc.DataCenterVO;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.Network.Provider;\n+import com.cloud.network.Network.Service;\n+import com.cloud.network.VirtualRouterProvider.VirtualRouterProviderType;\n+import com.cloud.network.addr.PublicIp;\n+import com.cloud.network.dao.NetworkVO;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderVO;\n+import com.cloud.network.dao.VirtualRouterProviderDao;\n+import com.cloud.network.element.VirtualRouterProviderVO;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.user.AccountManager;\n+import com.cloud.utils.component.ComponentContext;\n+import com.cloud.utils.net.Ip;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations=\"classpath:/lb_element.xml\")\n+public class InternalLbElementTest {\n+    //The class to test\n+    @Inject InternalLoadBalancerElement _lbEl;\n+    \n+    //Mocked interfaces\n+    @Inject AccountManager _accountMgr;\n+    @Inject VirtualRouterProviderDao _vrProviderDao;\n+    @Inject PhysicalNetworkServiceProviderDao _pNtwkProviderDao;\n+    @Inject InternalLoadBalancerVMManager _internalLbMgr;\n+    @Inject ConfigurationManager _configMgr;\n+    \n+    long validElId = 1L;\n+    long nonExistingElId = 2L;\n+    long invalidElId = 3L; //not of VirtualRouterProviderType\n+    long notEnabledElId = 4L;\n+    \n+    long validProviderId = 1L;\n+    long nonExistingProviderId = 2L;\n+    long invalidProviderId = 3L;\n+        \n+\n+    @Before\n+    public void setUp() {\n+        \n+        ComponentContext.initComponentsLifeCycle();\n+        VirtualRouterProviderVO validElement = new VirtualRouterProviderVO(1, VirtualRouterProviderType.InternalLbVm);\n+        validElement.setEnabled(true);\n+        VirtualRouterProviderVO invalidElement = new VirtualRouterProviderVO(1, VirtualRouterProviderType.VirtualRouter);\n+        VirtualRouterProviderVO notEnabledElement = new VirtualRouterProviderVO(1, VirtualRouterProviderType.InternalLbVm);\n+ \n+        Mockito.when(_vrProviderDao.findByNspIdAndType(validElId, VirtualRouterProviderType.InternalLbVm)).thenReturn(validElement);\n+        Mockito.when(_vrProviderDao.findByNspIdAndType(invalidElId, VirtualRouterProviderType.InternalLbVm)).thenReturn(invalidElement);\n+        Mockito.when(_vrProviderDao.findByNspIdAndType(notEnabledElId, VirtualRouterProviderType.InternalLbVm)).thenReturn(notEnabledElement);\n+\n+        Mockito.when(_vrProviderDao.persist(validElement)).thenReturn(validElement);\n+        \n+        Mockito.when(_vrProviderDao.findByNspIdAndType(validProviderId, VirtualRouterProviderType.InternalLbVm)).thenReturn(validElement);\n+        \n+        PhysicalNetworkServiceProviderVO validProvider = new PhysicalNetworkServiceProviderVO(1, \"InternalLoadBalancerElement\");\n+        PhysicalNetworkServiceProviderVO invalidProvider = new PhysicalNetworkServiceProviderVO(1, \"Invalid name!\");\n+\n+        Mockito.when(_pNtwkProviderDao.findById(validProviderId)).thenReturn(validProvider);\n+        Mockito.when(_pNtwkProviderDao.findById(invalidProviderId)).thenReturn(invalidProvider);\n+        \n+        Mockito.when(_vrProviderDao.persist(Mockito.any(VirtualRouterProviderVO.class))).thenReturn(validElement);\n+        \n+        DataCenterVO dc = new DataCenterVO\n+                (1L, null, null, null, null, null, null, null, null, null, NetworkType.Advanced, null, null);\n+        Mockito.when(_configMgr.getZone(Mockito.anyLong())).thenReturn(dc);\n+    }\n+    \n+    //TEST FOR getProvider() method\n+    \n+    @Test \n+    public void verifyProviderName() {  \n+       Provider pr = _lbEl.getProvider();\n+       assertEquals(\"Wrong provider is returned\", pr.getName(), Provider.InternalLbVm.getName());\n+    }\n+    \n+    //TEST FOR isReady() METHOD\n+    \n+    @Test \n+    public void verifyValidProviderState() {\n+       PhysicalNetworkServiceProviderVO provider = new PhysicalNetworkServiceProviderVO();\n+       provider = setId(provider, validElId);\n+       boolean isReady = _lbEl.isReady(provider);\n+       assertTrue(\"Valid provider is returned as not ready\", isReady);\n+    }\n+    \n+    \n+    @Test \n+    public void verifyNonExistingProviderState() {\n+       PhysicalNetworkServiceProviderVO provider = new PhysicalNetworkServiceProviderVO();\n+       provider = setId(provider, nonExistingElId);\n+       boolean isReady = _lbEl.isReady(provider);\n+       assertFalse(\"Non existing provider is returned as ready\", isReady);\n+    }\n+    \n+    \n+    @Test \n+    public void verifyInvalidProviderState() {\n+       PhysicalNetworkServiceProviderVO provider = new PhysicalNetworkServiceProviderVO();\n+       provider = setId(provider, invalidElId);\n+       boolean isReady = _lbEl.isReady(provider);\n+       assertFalse(\"Not valid provider is returned as ready\", isReady);\n+    }\n+    \n+    @Test \n+    public void verifyNotEnabledProviderState() {\n+       PhysicalNetworkServiceProviderVO provider = new PhysicalNetworkServiceProviderVO();\n+       provider = setId(provider, notEnabledElId);\n+       boolean isReady = _lbEl.isReady(provider);\n+       assertFalse(\"Not enabled provider is returned as ready\", isReady);\n+    }\n+    \n+    //TEST FOR canEnableIndividualServices METHOD\n+    @Test \n+    public void verifyCanEnableIndividualSvc() {  \n+       boolean result = _lbEl.canEnableIndividualServices();\n+       assertTrue(\"Wrong value is returned by canEnableIndividualSvc\", result);\n+    }\n+    \n+    //TEST FOR verifyServicesCombination METHOD\n+    @Test \n+    public void verifyServicesCombination() {  \n+       boolean result = _lbEl.verifyServicesCombination(new HashSet<Service>());\n+       assertTrue(\"Wrong value is returned by verifyServicesCombination\", result);\n+    }\n+    \n+    \n+    //TEST FOR applyIps METHOD\n+    @Test \n+    public void verifyApplyIps() throws ResourceUnavailableException {\n+       List<PublicIp> ips = new ArrayList<PublicIp>();\n+       boolean result = _lbEl.applyIps(new NetworkVO(), ips, new HashSet<Service>());\n+       assertTrue(\"Wrong value is returned by applyIps method\", result);\n+    }\n+    \n+    \n+    //TEST FOR updateHealthChecks METHOD\n+    @Test \n+    public void verifyUpdateHealthChecks() throws ResourceUnavailableException {\n+       List<LoadBalancerTO> check = _lbEl.updateHealthChecks(new NetworkVO(), new ArrayList<LoadBalancingRule>());\n+       assertNull(\"Wrong value is returned by updateHealthChecks method\", check);\n+    }\n+    \n+    //TEST FOR validateLBRule METHOD\n+    @Test \n+    public void verifyValidateLBRule() throws ResourceUnavailableException {\n+        ApplicationLoadBalancerRuleVO lb = new ApplicationLoadBalancerRuleVO(null, null, 22, 22, \"roundrobin\",\n+                1L, 1L, 1L, new Ip(\"10.10.10.1\"), 1L, Scheme.Internal);\n+        lb.setState(FirewallRule.State.Add);\n+        \n+        LoadBalancingRule rule = new LoadBalancingRule(lb, null,\n+                null, null, new Ip(\"10.10.10.1\"));\n+        \n+        \n+        boolean result = _lbEl.validateLBRule(new NetworkVO(), rule);\n+        assertTrue(\"Wrong value is returned by validateLBRule method\", result);\n+    }\n+    \n+    \n+    private static PhysicalNetworkServiceProviderVO setId(PhysicalNetworkServiceProviderVO vo, long id) {\n+        PhysicalNetworkServiceProviderVO voToReturn = vo;\n+        Class<?> c = voToReturn.getClass();\n+        try {\n+            Field f = c.getDeclaredField(\"id\");\n+            f.setAccessible(true);\n+            f.setLong(voToReturn, id);\n+        } catch (NoSuchFieldException ex) {\n+           return null;\n+        } catch (IllegalAccessException ex) {\n+            return null;\n+        }\n+        \n+        return voToReturn;\n+    }\n+    \n+    \n+    \n+}\n+\n+",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbelement/InternalLbElementTest.java",
                "sha": "f19612f6b0f4878e241c90e5c574f0b24cf3d3b2",
                "status": "added"
            },
            {
                "additions": 388,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMManagerTest.java",
                "changes": 388,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMManagerTest.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMManagerTest.java",
                "patch": "@@ -0,0 +1,388 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.internallbvmmgr;\n+\n+import java.lang.reflect.Field;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import junit.framework.TestCase;\n+\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+import org.apache.cloudstack.network.lb.InternalLoadBalancerVMManager;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import com.cloud.agent.AgentManager;\n+import com.cloud.agent.api.Answer;\n+import com.cloud.agent.manager.Commands;\n+import com.cloud.dc.DataCenter.NetworkType;\n+import com.cloud.dc.DataCenterVO;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.exception.AgentUnavailableException;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.OperationTimedoutException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.dao.NetworkVO;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n+import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.service.ServiceOfferingVO;\n+import com.cloud.service.dao.ServiceOfferingDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.User;\n+import com.cloud.utils.component.ComponentContext;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.vm.DomainRouterVO;\n+import com.cloud.vm.NicProfile;\n+import com.cloud.vm.NicVO;\n+import com.cloud.vm.VirtualMachine;\n+import com.cloud.vm.VirtualMachine.State;\n+import com.cloud.vm.VirtualMachineManager;\n+import com.cloud.vm.dao.DomainRouterDao;\n+import com.cloud.vm.dao.NicDao;\n+\n+/**\n+ * Set of unittests for InternalLoadBalancerVMManager\n+ *\n+ */\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations=\"classpath:/lb_mgr.xml\")\n+public class InternalLBVMManagerTest extends TestCase {\n+    //The interface to test\n+    @Inject InternalLoadBalancerVMManager _lbVmMgr;\n+    \n+    //Mocked interfaces\n+    @Inject AccountManager _accountMgr;\n+    @Inject ServiceOfferingDao _svcOffDao;\n+    @Inject DomainRouterDao _domainRouterDao;\n+    @Inject NicDao _nicDao;\n+    @Inject AgentManager _agentMgr;\n+    @Inject NetworkModel _ntwkModel;\n+    @Inject VirtualMachineManager _itMgr;\n+    @Inject DataCenterDao _dcDao;\n+    \n+    long validNtwkId = 1L;\n+    long invalidNtwkId = 2L;\n+    String requestedIp = \"10.1.1.1\";\n+    DomainRouterVO vm = null;\n+    NetworkVO ntwk = createNetwork();\n+    long validVmId = 1L;\n+    long invalidVmId = 2L;\n+    \n+    @Before\n+    public void setUp() {\n+        //mock system offering creation as it's used by configure() method called by initComponentsLifeCycle\n+        Mockito.when(_accountMgr.getAccount(1L)).thenReturn(new AccountVO());\n+        ServiceOfferingVO off = new ServiceOfferingVO(\"alena\", 1, 1,\n+                1, 1, 1, false, \"alena\", false, false, null, false, VirtualMachine.Type.InternalLoadBalancerVm, false);\n+        off = setId(off, 1);\n+        Mockito.when(_svcOffDao.persistSystemServiceOffering(Mockito.any(ServiceOfferingVO.class))).thenReturn(off);\n+        \n+        ComponentContext.initComponentsLifeCycle();\n+        \n+        vm = new DomainRouterVO(1L,off.getId(),1,\"alena\",1,HypervisorType.XenServer,1,1,1,\n+                false, 0,false,null,false,false,\n+                VirtualMachine.Type.InternalLoadBalancerVm, null);\n+        vm.setRole(Role.INTERNAL_LB_VM);\n+        vm = setId(vm, 1);\n+        vm.setPrivateIpAddress(\"10.2.2.2\");\n+        NicVO nic = new NicVO(\"somereserver\", 1L, 1L, VirtualMachine.Type.InternalLoadBalancerVm);\n+        nic.setIp4Address(requestedIp);\n+        \n+        List<DomainRouterVO> emptyList = new ArrayList<DomainRouterVO>();\n+        List<DomainRouterVO> nonEmptyList = new ArrayList<DomainRouterVO>();\n+        nonEmptyList.add(vm);\n+        \n+        Mockito.when(_domainRouterDao.listByNetworkAndRole(invalidNtwkId, Role.INTERNAL_LB_VM)).thenReturn(emptyList);\n+        Mockito.when(_domainRouterDao.listByNetworkAndRole(validNtwkId, Role.INTERNAL_LB_VM)).thenReturn(nonEmptyList);\n+        \n+        Mockito.when(_nicDao.findByNtwkIdAndInstanceId(validNtwkId, 1)).thenReturn(nic);\n+        Mockito.when(_nicDao.findByNtwkIdAndInstanceId(invalidNtwkId, 1)).thenReturn(nic);\n+\n+        Answer answer= new Answer(null, true, null);\n+        Answer[] answers = new Answer[1];\n+        answers[0] = answer;\n+        \n+        try {\n+            Mockito.when(_agentMgr.send(Mockito.anyLong(), Mockito.any(Commands.class))).thenReturn(answers);\n+        } catch (AgentUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (OperationTimedoutException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        }\n+        \n+        createNetwork();\n+        Mockito.when(_ntwkModel.getNetwork(Mockito.anyLong())).thenReturn(ntwk);\n+\n+        \n+        Mockito.when(_itMgr.toNicTO(Mockito.any(NicProfile.class), Mockito.any(HypervisorType.class))).thenReturn(null);\n+        Mockito.when(_domainRouterDao.findById(Mockito.anyLong())).thenReturn(vm);\n+        DataCenterVO dc = new DataCenterVO\n+                (1L, null, null, null, null, null, null, null, null, null, NetworkType.Advanced, null, null);\n+        Mockito.when(_dcDao.findById(Mockito.anyLong())).thenReturn(dc);\n+        \n+        \n+        try {\n+            Mockito.when(_itMgr.expunge(Mockito.any(DomainRouterVO.class), Mockito.any(User.class), Mockito.any(Account.class))).thenReturn(true);\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } \n+        \n+        Mockito.when(_domainRouterDao.findById(validVmId)).thenReturn(vm);\n+        Mockito.when(_domainRouterDao.findById(invalidVmId)).thenReturn(null);\n+\n+    }\n+\n+    protected NetworkVO createNetwork() {\n+        ntwk = new NetworkVO();\n+        try {\n+            ntwk.setBroadcastUri(new URI(\"somevlan\"));\n+        } catch (URISyntaxException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        }\n+        ntwk = setId(ntwk, 1L);\n+        return ntwk;\n+    }\n+    \n+    //TESTS FOR findInternalLbVms METHOD\n+    \n+    @Test\n+    public void findInternalLbVmsForInvalidNetwork() {\n+        List<? extends VirtualRouter> vms = _lbVmMgr.findInternalLbVms(invalidNtwkId, new Ip(requestedIp));\n+        assertTrue(\"Non empty vm list was returned for invalid network id\", vms.isEmpty());\n+    }\n+    \n+    @Test\n+    public void findInternalLbVmsForValidNetwork() {\n+        List<? extends VirtualRouter> vms = _lbVmMgr.findInternalLbVms(validNtwkId, new Ip(requestedIp));\n+        assertTrue(\"Empty vm list was returned for valid network id\", !vms.isEmpty());\n+    }\n+    \n+    \n+    //TESTS FOR applyLoadBalancingRules METHOD\n+    @Test\n+    public void applyEmptyRulesSet() {\n+        boolean result = false;\n+        List<DomainRouterVO> vms = new ArrayList<DomainRouterVO>();\n+        try {\n+            result = _lbVmMgr.applyLoadBalancingRules(new NetworkVO(), new ArrayList<LoadBalancingRule>(), vms);\n+        } catch (ResourceUnavailableException e) {\n+\n+        } finally {\n+            assertTrue(\"Got failure when tried to apply empty list of rules\", result);\n+        }\n+    }\n+    \n+    @Test (expected = CloudRuntimeException.class)\n+    public void applyWithEmptyVmsSet() {\n+        boolean result = false;\n+        List<DomainRouterVO> vms = new ArrayList<DomainRouterVO>();\n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        LoadBalancingRule rule = new LoadBalancingRule(null, null,\n+                null, null, null);\n+        \n+        rules.add(rule);\n+        try {\n+            result = _lbVmMgr.applyLoadBalancingRules(new NetworkVO(), rules, vms);\n+        } catch (ResourceUnavailableException e) {\n+        } finally {\n+            assertFalse(\"Got success when tried to apply with the empty internal lb vm list\", result);\n+        }\n+    }\n+    \n+    @Test (expected = ResourceUnavailableException.class)\n+    public void applyToVmInStartingState() throws ResourceUnavailableException {\n+        boolean result = false;\n+        List<DomainRouterVO> vms = new ArrayList<DomainRouterVO>();\n+        vm.setState(State.Starting);\n+        vms.add(vm);\n+        \n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        LoadBalancingRule rule = new LoadBalancingRule(null, null,\n+                null, null, null);\n+        \n+        rules.add(rule);\n+        try {\n+            result = _lbVmMgr.applyLoadBalancingRules(new NetworkVO(), rules, vms);\n+        } finally {\n+            assertFalse(\"Rules were applied to vm in Starting state\", result);\n+        }\n+    }\n+    \n+    \n+    @Test\n+    public void applyToVmInStoppedState() throws ResourceUnavailableException {\n+        boolean result = false;\n+        List<DomainRouterVO> vms = new ArrayList<DomainRouterVO>();\n+        vm.setState(State.Stopped);\n+        vms.add(vm);\n+        \n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        LoadBalancingRule rule = new LoadBalancingRule(null, null,\n+                null, null, null);\n+        \n+        rules.add(rule);\n+        try {\n+            result = _lbVmMgr.applyLoadBalancingRules(new NetworkVO(), rules, vms);\n+        } finally {\n+            assertTrue(\"Rules failed to apply to vm in Stopped state\", result);\n+        }\n+    }\n+    \n+    \n+    @Test\n+    public void applyToVmInStoppingState() throws ResourceUnavailableException {\n+        boolean result = false;\n+        List<DomainRouterVO> vms = new ArrayList<DomainRouterVO>();\n+        vm.setState(State.Stopping);\n+        vms.add(vm);\n+        \n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        LoadBalancingRule rule = new LoadBalancingRule(null, null,\n+                null, null, null);\n+        \n+        rules.add(rule);\n+        try {\n+            result = _lbVmMgr.applyLoadBalancingRules(new NetworkVO(), rules, vms);\n+        } finally {\n+            assertTrue(\"Rules failed to apply to vm in Stopping state\", result);\n+        }\n+    }\n+    \n+    \n+    @Test\n+    public void applyToVmInRunningState() throws ResourceUnavailableException {\n+        boolean result = false;\n+        List<DomainRouterVO> vms = new ArrayList<DomainRouterVO>();\n+        vm.setState(State.Running);\n+        vms.add(vm);\n+        \n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        ApplicationLoadBalancerRuleVO lb = new ApplicationLoadBalancerRuleVO(null, null, 22, 22, \"roundrobin\",\n+                1L, 1L, 1L, new Ip(requestedIp), 1L, Scheme.Internal);\n+        lb.setState(FirewallRule.State.Add);\n+        \n+        LoadBalancingRule rule = new LoadBalancingRule(lb, null,\n+                null, null, new Ip(requestedIp));\n+        \n+        rules.add(rule);\n+        \n+        ntwk.getId();\n+        \n+        try {\n+            result = _lbVmMgr.applyLoadBalancingRules(ntwk, rules, vms);\n+        } finally {\n+            assertTrue(\"Rules failed to apply to vm in Running state\", result);\n+        }\n+    }\n+    \n+    \n+    //TESTS FOR destroyInternalLbVm METHOD\n+    @Test\n+    public void destroyNonExistingVM() throws ResourceUnavailableException, ConcurrentOperationException {\n+        boolean result = false;\n+        \n+        try {\n+             result = _lbVmMgr.destroyInternalLbVm(invalidVmId, new AccountVO(), 1L);\n+        } finally {\n+            assertTrue(\"Failed to destroy non-existing vm\", result);\n+        }\n+    }\n+    \n+    @Test\n+    public void destroyExistingVM() throws ResourceUnavailableException, ConcurrentOperationException {\n+        boolean result = false;\n+        \n+        try {\n+             result = _lbVmMgr.destroyInternalLbVm(validVmId, new AccountVO(), 1L);\n+        } finally {\n+            assertTrue(\"Failed to destroy valid vm\", result);\n+        }\n+    }\n+    \n+    \n+    private static ServiceOfferingVO setId(ServiceOfferingVO vo, long id) {\n+        ServiceOfferingVO voToReturn = vo;\n+        Class<?> c = voToReturn.getClass();\n+        try {\n+            Field f = c.getSuperclass().getDeclaredField(\"id\");\n+            f.setAccessible(true);\n+            f.setLong(voToReturn, id);\n+        } catch (NoSuchFieldException ex) {\n+           return null;\n+        } catch (IllegalAccessException ex) {\n+            return null;\n+        }\n+        \n+        return voToReturn;\n+    }\n+    \n+    \n+    private static NetworkVO setId(NetworkVO vo, long id) {\n+        NetworkVO voToReturn = vo;\n+        Class<?> c = voToReturn.getClass();\n+        try {\n+            Field f = c.getDeclaredField(\"id\");\n+            f.setAccessible(true);\n+            f.setLong(voToReturn, id);\n+        } catch (NoSuchFieldException ex) {\n+           return null;\n+        } catch (IllegalAccessException ex) {\n+            return null;\n+        }\n+        \n+        return voToReturn;\n+    }\n+    \n+    private static DomainRouterVO setId(DomainRouterVO vo, long id) {\n+        DomainRouterVO voToReturn = vo;\n+        Class<?> c = voToReturn.getClass();\n+        try {\n+            Field f = c.getSuperclass().getDeclaredField(\"id\");\n+            f.setAccessible(true);\n+            f.setLong(voToReturn, id);\n+        } catch (NoSuchFieldException ex) {\n+           return null;\n+        } catch (IllegalAccessException ex) {\n+            return null;\n+        }\n+        \n+        return voToReturn;\n+    }\n+    \n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMManagerTest.java",
                "sha": "a19a82e30c1c8944ce26182d3e19ae11c40d874f",
                "status": "added"
            },
            {
                "additions": 291,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMServiceTest.java",
                "changes": 291,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMServiceTest.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMServiceTest.java",
                "patch": "@@ -0,0 +1,291 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.internallbvmmgr;\n+\n+import java.lang.reflect.Field;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import junit.framework.TestCase;\n+\n+import org.apache.cloudstack.network.lb.InternalLoadBalancerVMService;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import com.cloud.deploy.DeploymentPlan;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.OperationTimedoutException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.exception.StorageUnavailableException;\n+import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n+import com.cloud.service.ServiceOfferingVO;\n+import com.cloud.service.dao.ServiceOfferingDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.User;\n+import com.cloud.utils.component.ComponentContext;\n+import com.cloud.vm.DomainRouterVO;\n+import com.cloud.vm.VirtualMachine;\n+import com.cloud.vm.VirtualMachineManager;\n+import com.cloud.vm.dao.DomainRouterDao;\n+\n+/**\n+ * Set of unittests for InternalLoadBalancerVMService\n+ *\n+ */\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations=\"classpath:/lb_svc.xml\")\n+@SuppressWarnings(\"unchecked\")\n+public class InternalLBVMServiceTest extends TestCase {\n+    //The interface to test\n+    @Inject InternalLoadBalancerVMService _lbVmSvc;\n+    \n+    //Mocked interfaces\n+    @Inject AccountManager _accountMgr;\n+    @Inject ServiceOfferingDao _svcOffDao;\n+    @Inject DomainRouterDao _domainRouterDao;\n+    @Inject VirtualMachineManager _itMgr;\n+    \n+    long validVmId = 1L;\n+    long nonExistingVmId = 2L;\n+    long nonInternalLbVmId = 3L;\n+    \n+    @Before\n+    public void setUp() {\n+        //mock system offering creation as it's used by configure() method called by initComponentsLifeCycle\n+        Mockito.when(_accountMgr.getAccount(1L)).thenReturn(new AccountVO());\n+        ServiceOfferingVO off = new ServiceOfferingVO(\"alena\", 1, 1,\n+                1, 1, 1, false, \"alena\", false, false, null, false, VirtualMachine.Type.InternalLoadBalancerVm, false);\n+        off = setId(off, 1);\n+        Mockito.when(_svcOffDao.persistSystemServiceOffering(Mockito.any(ServiceOfferingVO.class))).thenReturn(off);\n+        \n+        ComponentContext.initComponentsLifeCycle();\n+        \n+        DomainRouterVO validVm = new DomainRouterVO(validVmId,off.getId(),1,\"alena\",1,HypervisorType.XenServer,1,1,1,\n+                false, 0,false,null,false,false,\n+                VirtualMachine.Type.InternalLoadBalancerVm, null);\n+        validVm.setRole(Role.INTERNAL_LB_VM);\n+        DomainRouterVO nonInternalLbVm = new DomainRouterVO(validVmId,off.getId(),1,\"alena\",1,HypervisorType.XenServer,1,1,1,\n+                false, 0,false,null,false,false,\n+                VirtualMachine.Type.DomainRouter, null);\n+        nonInternalLbVm.setRole(Role.VIRTUAL_ROUTER);\n+        \n+        Mockito.when(_domainRouterDao.findById(validVmId)).thenReturn(validVm);\n+        Mockito.when(_domainRouterDao.findById(nonExistingVmId)).thenReturn(null);\n+        Mockito.when(_domainRouterDao.findById(nonInternalLbVmId)).thenReturn(nonInternalLbVm);\n+        \n+        try {\n+            Mockito.when(_itMgr.start(Mockito.any(DomainRouterVO.class),\n+                    Mockito.any(Map.class), Mockito.any(User.class), Mockito.any(Account.class), Mockito.any(DeploymentPlan.class))).thenReturn(validVm);\n+        } catch (InsufficientCapacityException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        }\n+        \n+        try {\n+            Mockito.when(_itMgr.advanceStop(Mockito.any(DomainRouterVO.class), Mockito.any(Boolean.class), Mockito.any(User.class), Mockito.any(Account.class))).thenReturn(true);\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (OperationTimedoutException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        }\n+\n+    }\n+    \n+    //TESTS FOR START COMMAND\n+    \n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void startNonExistingVm() {\n+        String expectedExcText = null;\n+        try {\n+            _lbVmSvc.startInternalLbVm(nonExistingVmId, _accountMgr.getAccount(1L), 1L);\n+        } catch (StorageUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (InsufficientCapacityException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (InvalidParameterValueException e) {\n+            expectedExcText = e.getMessage();\n+            throw e;\n+        } finally {\n+            assertEquals(\"Test failed. The non-existing internal lb vm was attempted to start\"\n+        + expectedExcText, expectedExcText, \"Can't find internal lb vm by id specified\");\n+        }\n+    }\n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void startNonInternalLbVmVm() {\n+        String expectedExcText = null;\n+        try {\n+            _lbVmSvc.startInternalLbVm(nonInternalLbVmId, _accountMgr.getAccount(1L), 1L);\n+        } catch (StorageUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (InsufficientCapacityException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        }catch (InvalidParameterValueException e) {\n+            expectedExcText = e.getMessage();\n+            throw e;\n+        } finally {\n+            assertEquals(\"Test failed. The existing vm of not Internal lb vm type was attempted to start\"\n+        + expectedExcText, expectedExcText, \"Can't find internal lb vm by id specified\");\n+        }\n+    }\n+    \n+    @Test\n+    public void startValidLbVmVm() {\n+        VirtualRouter vr = null;\n+        try {\n+            vr = _lbVmSvc.startInternalLbVm(validVmId, _accountMgr.getAccount(1L), 1L);\n+        } catch (StorageUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (InsufficientCapacityException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } finally {\n+            assertNotNull(\"Internal LB vm is null which means it failed to start \" + vr, vr);\n+        }\n+    }\n+    \n+    \n+    //TEST FOR STOP COMMAND\n+    @Test (expected = InvalidParameterValueException.class)\n+    public void stopNonExistingVm() {\n+        String expectedExcText = null;\n+        try {\n+            _lbVmSvc.stopInternalLbVm(nonExistingVmId, false,_accountMgr.getAccount(1L), 1L);\n+        } catch (StorageUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (InvalidParameterValueException e) {\n+            expectedExcText = e.getMessage();\n+            throw e;\n+        } finally {\n+            assertEquals(\"Test failed. The non-existing internal lb vm was attempted to stop\"\n+        + expectedExcText, expectedExcText, \"Can't find internal lb vm by id specified\");\n+        }\n+    }\n+    \n+    \n+    @Test (expected = InvalidParameterValueException.class)\n+    public void stopNonInternalLbVmVm() {\n+        String expectedExcText = null;\n+        try {\n+            _lbVmSvc.stopInternalLbVm(nonInternalLbVmId, false, _accountMgr.getAccount(1L), 1L);\n+        } catch (StorageUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        }catch (InvalidParameterValueException e) {\n+            expectedExcText = e.getMessage();\n+            throw e;\n+        } finally {\n+            assertEquals(\"Test failed. The existing vm of not Internal lb vm type was attempted to stop\"\n+        + expectedExcText, expectedExcText, \"Can't find internal lb vm by id specified\");\n+        }\n+    }\n+    \n+    \n+    @Test\n+    public void stopValidLbVmVm() {\n+        VirtualRouter vr = null;\n+        try {\n+            vr = _lbVmSvc.stopInternalLbVm(validVmId, false, _accountMgr.getAccount(1L), 1L);\n+        } catch (StorageUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ConcurrentOperationException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } catch (ResourceUnavailableException e) {\n+            // TODO Auto-generated catch block\n+            e.printStackTrace();\n+        } finally {\n+            assertNotNull(\"Internal LB vm is null which means it failed to stop \" + vr, vr);\n+        }\n+    }\n+    \n+    \n+    \n+    private static ServiceOfferingVO setId(ServiceOfferingVO vo, long id) {\n+        ServiceOfferingVO voToReturn = vo;\n+        Class<?> c = voToReturn.getClass();\n+        try {\n+            Field f = c.getSuperclass().getDeclaredField(\"id\");\n+            f.setAccessible(true);\n+            f.setLong(voToReturn, id);\n+        } catch (NoSuchFieldException ex) {\n+           return null;\n+        } catch (IllegalAccessException ex) {\n+            return null;\n+        }\n+        \n+        return voToReturn;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/InternalLBVMServiceTest.java",
                "sha": "75f54faf8f059fc154a027c3efddad55a8732480",
                "status": "added"
            },
            {
                "additions": 170,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/LbChildTestConfiguration.java",
                "changes": 170,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/LbChildTestConfiguration.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/LbChildTestConfiguration.java",
                "patch": "@@ -0,0 +1,170 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.internallbvmmgr;\n+\n+import java.io.IOException;\n+\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.cloudstack.test.utils.SpringUtils;\n+import org.mockito.Mockito;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.context.annotation.ComponentScan.Filter;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.FilterType;\n+import org.springframework.core.type.classreading.MetadataReader;\n+import org.springframework.core.type.classreading.MetadataReaderFactory;\n+import org.springframework.core.type.filter.TypeFilter;\n+\n+import com.cloud.agent.AgentManager;\n+import com.cloud.configuration.dao.ConfigurationDao;\n+import com.cloud.dc.dao.AccountVlanMapDaoImpl;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.dao.NetworkDao;\n+import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.dao.VirtualRouterProviderDao;\n+import com.cloud.network.lb.LoadBalancingRulesManager;\n+import com.cloud.offerings.dao.NetworkOfferingDao;\n+import com.cloud.resource.ResourceManager;\n+import com.cloud.server.ConfigurationServer;\n+import com.cloud.service.dao.ServiceOfferingDao;\n+import com.cloud.storage.dao.VMTemplateDao;\n+import com.cloud.user.AccountManager;\n+import com.cloud.vm.VirtualMachineManager;\n+import com.cloud.vm.dao.DomainRouterDao;\n+import com.cloud.vm.dao.NicDao;\n+\n+@Configuration\n+@ComponentScan(\n+    basePackageClasses={\n+        AccountVlanMapDaoImpl.class\n+    },\n+    includeFilters={@Filter(value=LbChildTestConfiguration.Library.class, type=FilterType.CUSTOM)},\n+    useDefaultFilters=false\n+    )\n+\n+    public class LbChildTestConfiguration {\n+        \n+        public static class Library implements TypeFilter {\n+            \n+          \n+            @Bean\n+            public AccountManager accountManager() {\n+                return Mockito.mock(AccountManager.class);\n+            }\n+            \n+            @Bean\n+            public VirtualMachineManager virtualMachineManager() {\n+                return Mockito.mock(VirtualMachineManager.class);\n+            }\n+            \n+            @Bean\n+            public DomainRouterDao domainRouterDao() {\n+                return Mockito.mock(DomainRouterDao.class);\n+            }\n+            \n+            @Bean\n+            public ConfigurationDao configurationDao() {\n+                return Mockito.mock(ConfigurationDao.class);\n+            }\n+            \n+            @Bean\n+            public VirtualRouterProviderDao virtualRouterProviderDao() {\n+                return Mockito.mock(VirtualRouterProviderDao.class);\n+            }\n+            \n+            @Bean\n+            public ApplicationLoadBalancerRuleDao applicationLoadBalancerRuleDao() {\n+                return Mockito.mock(ApplicationLoadBalancerRuleDao.class);\n+            }\n+            \n+            @Bean\n+            public NetworkModel networkModel() {\n+                return Mockito.mock(NetworkModel.class);\n+            }\n+            \n+            @Bean\n+            public LoadBalancingRulesManager loadBalancingRulesManager() {\n+                return Mockito.mock(LoadBalancingRulesManager.class);\n+            }\n+            \n+            @Bean\n+            public NicDao nicDao() {\n+                return Mockito.mock(NicDao.class);\n+            }\n+            \n+            @Bean\n+            public NetworkDao networkDao() {\n+                return Mockito.mock(NetworkDao.class);\n+            }\n+            \n+            @Bean\n+            public NetworkManager networkManager() {\n+                return Mockito.mock(NetworkManager.class);\n+            }\n+            \n+            @Bean\n+            public ServiceOfferingDao serviceOfferingDao() {\n+                return Mockito.mock(ServiceOfferingDao.class);\n+            }\n+            \n+            @Bean\n+            public PhysicalNetworkServiceProviderDao physicalNetworkServiceProviderDao() {\n+                return Mockito.mock(PhysicalNetworkServiceProviderDao.class);\n+            }\n+            \n+            @Bean\n+            public NetworkOfferingDao networkOfferingDao() {\n+                return Mockito.mock(NetworkOfferingDao.class);\n+            }\n+            \n+            @Bean\n+            public VMTemplateDao vmTemplateDao() {\n+                return Mockito.mock(VMTemplateDao.class);\n+            }\n+            \n+            @Bean\n+            public ResourceManager resourceManager() {\n+                return Mockito.mock(ResourceManager.class);\n+            }\n+            \n+            @Bean\n+            public AgentManager agentManager() {\n+                return Mockito.mock(AgentManager.class);\n+            }\n+            \n+            @Bean\n+            public DataCenterDao dataCenterDao() {\n+                return Mockito.mock(DataCenterDao.class);\n+            }\n+            \n+            @Bean\n+            public ConfigurationServer configurationServer() {\n+                return Mockito.mock(ConfigurationServer.class);\n+            }\n+            \n+            @Override\n+            public boolean match(MetadataReader mdr, MetadataReaderFactory arg1) throws IOException {\n+                mdr.getClassMetadata().getClassName();\n+                ComponentScan cs = LbChildTestConfiguration.class.getAnnotation(ComponentScan.class);\n+                return SpringUtils.includedInBasePackageClasses(mdr.getClassMetadata().getClassName(), cs);\n+            }\n+    \n+        }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/org/apache/cloudstack/internallbvmmgr/LbChildTestConfiguration.java",
                "sha": "0f24f963ae6074eac187784b9df864e82450f3ec",
                "status": "added"
            },
            {
                "additions": 46,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/resources/lb_element.xml",
                "changes": 46,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/resources/lb_element.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/resources/lb_element.xml",
                "patch": "@@ -0,0 +1,46 @@\n+<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor \n+  license agreements. See the NOTICE file distributed with this work for additional \n+  information regarding copyright ownership. The ASF licenses this file to \n+  you under the Apache License, Version 2.0 (the \"License\"); you may not use \n+  this file except in compliance with the License. You may obtain a copy of \n+  the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required \n+  by applicable law or agreed to in writing, software distributed under the \n+  License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS \n+  OF ANY KIND, either express or implied. See the License for the specific \n+  language governing permissions and limitations under the License. -->\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+  xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n+  xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+                      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n+                      http://www.springframework.org/schema/tx \n+                      http://www.springframework.org/schema/tx/spring-tx-3.0.xsd\n+                      http://www.springframework.org/schema/aop\n+                      http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n+                      http://www.springframework.org/schema/context\n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n+\n+     <context:annotation-config />\n+\n+    <!-- @DB support -->\n+      \n+  <bean id=\"componentContext\" class=\"com.cloud.utils.component.ComponentContext\" />\n+\n+  <bean id=\"transactionContextBuilder\" class=\"com.cloud.utils.db.TransactionContextBuilder\" />\n+  <bean id=\"actionEventInterceptor\" class=\"com.cloud.event.ActionEventInterceptor\" />\n+  <bean id=\"instantiatePostProcessor\" class=\"com.cloud.utils.component.ComponentInstantiationPostProcessor\">\n+    <property name=\"Interceptors\">\n+        <list>\n+            <ref bean=\"transactionContextBuilder\" />\n+            <ref bean=\"actionEventInterceptor\" />\n+        </list>\n+    </property>\n+  </bean>\n+\n+    <bean id=\"InternalLoadBalancerElementService\" class=\"org.apache.cloudstack.network.element.InternalLoadBalancerElement\">\n+        <property name=\"name\" value=\"InternalLoadBalancerElementService\"/>\n+    </bean>\n+  \n+    <bean class=\"org.apache.cloudstack.internallbelement.ElementChildTestConfiguration\" />\n+    \n+</beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/resources/lb_element.xml",
                "sha": "5dec9c314f6133176a23b036c0883cb93a9a4ef3",
                "status": "added"
            },
            {
                "additions": 46,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/resources/lb_mgr.xml",
                "changes": 46,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/resources/lb_mgr.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/resources/lb_mgr.xml",
                "patch": "@@ -0,0 +1,46 @@\n+<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor \n+  license agreements. See the NOTICE file distributed with this work for additional \n+  information regarding copyright ownership. The ASF licenses this file to \n+  you under the Apache License, Version 2.0 (the \"License\"); you may not use \n+  this file except in compliance with the License. You may obtain a copy of \n+  the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required \n+  by applicable law or agreed to in writing, software distributed under the \n+  License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS \n+  OF ANY KIND, either express or implied. See the License for the specific \n+  language governing permissions and limitations under the License. -->\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+  xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n+  xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+                      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n+                      http://www.springframework.org/schema/tx \n+                      http://www.springframework.org/schema/tx/spring-tx-3.0.xsd\n+                      http://www.springframework.org/schema/aop\n+                      http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n+                      http://www.springframework.org/schema/context\n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n+\n+     <context:annotation-config />\n+\n+    <!-- @DB support -->\n+      \n+  <bean id=\"componentContext\" class=\"com.cloud.utils.component.ComponentContext\" />\n+\n+  <bean id=\"transactionContextBuilder\" class=\"com.cloud.utils.db.TransactionContextBuilder\" />\n+  <bean id=\"actionEventInterceptor\" class=\"com.cloud.event.ActionEventInterceptor\" />\n+  <bean id=\"instantiatePostProcessor\" class=\"com.cloud.utils.component.ComponentInstantiationPostProcessor\">\n+    <property name=\"Interceptors\">\n+        <list>\n+            <ref bean=\"transactionContextBuilder\" />\n+            <ref bean=\"actionEventInterceptor\" />\n+        </list>\n+    </property>\n+  </bean>\n+\n+    <bean id=\"InternalLoadBalancerVMManager\" class=\"org.apache.cloudstack.network.lb.InternalLoadBalancerVMManagerImpl\">\n+        <property name=\"name\" value=\"InternalLoadBalancerVMManager\"/>\n+    </bean>\n+  \n+    <bean class=\"org.apache.cloudstack.internallbvmmgr.LbChildTestConfiguration\" />\n+    \n+</beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/resources/lb_mgr.xml",
                "sha": "1ad6403861cdbf422bb0a250294e922702750799",
                "status": "added"
            },
            {
                "additions": 46,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/resources/lb_svc.xml",
                "changes": 46,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/internal-loadbalancer/test/resources/lb_svc.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/network-elements/internal-loadbalancer/test/resources/lb_svc.xml",
                "patch": "@@ -0,0 +1,46 @@\n+<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor \n+  license agreements. See the NOTICE file distributed with this work for additional \n+  information regarding copyright ownership. The ASF licenses this file to \n+  you under the Apache License, Version 2.0 (the \"License\"); you may not use \n+  this file except in compliance with the License. You may obtain a copy of \n+  the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required \n+  by applicable law or agreed to in writing, software distributed under the \n+  License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS \n+  OF ANY KIND, either express or implied. See the License for the specific \n+  language governing permissions and limitations under the License. -->\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+  xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n+  xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+                      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n+                      http://www.springframework.org/schema/tx \n+                      http://www.springframework.org/schema/tx/spring-tx-3.0.xsd\n+                      http://www.springframework.org/schema/aop\n+                      http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n+                      http://www.springframework.org/schema/context\n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n+\n+     <context:annotation-config />\n+\n+    <!-- @DB support -->\n+      \n+  <bean id=\"componentContext\" class=\"com.cloud.utils.component.ComponentContext\" />\n+\n+  <bean id=\"transactionContextBuilder\" class=\"com.cloud.utils.db.TransactionContextBuilder\" />\n+  <bean id=\"actionEventInterceptor\" class=\"com.cloud.event.ActionEventInterceptor\" />\n+  <bean id=\"instantiatePostProcessor\" class=\"com.cloud.utils.component.ComponentInstantiationPostProcessor\">\n+    <property name=\"Interceptors\">\n+        <list>\n+            <ref bean=\"transactionContextBuilder\" />\n+            <ref bean=\"actionEventInterceptor\" />\n+        </list>\n+    </property>\n+  </bean>\n+\n+    <bean id=\"InternalLoadBalancerVMService\" class=\"org.apache.cloudstack.network.lb.InternalLoadBalancerVMManagerImpl\">\n+        <property name=\"name\" value=\"InternalLoadBalancerVMService\"/>\n+    </bean>\n+  \n+    <bean class=\"org.apache.cloudstack.internallbvmmgr.LbChildTestConfiguration\" />\n+    \n+</beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/internal-loadbalancer/test/resources/lb_svc.xml",
                "sha": "fa822f3530261c7877fc62817f7e4a75413fa540",
                "status": "added"
            },
            {
                "additions": 75,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/netscaler/src/com/cloud/network/element/NetscalerElement.java",
                "changes": 108,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/netscaler/src/com/cloud/network/element/NetscalerElement.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 33,
                "filename": "plugins/network-elements/netscaler/src/com/cloud/network/element/NetscalerElement.java",
                "patch": "@@ -16,6 +16,22 @@\n // under the License.\n package com.cloud.network.element;\n \n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.network.ExternalNetworkDeviceManager.NetworkDevice;\n+import org.apache.cloudstack.region.gslb.GslbServiceProvider;\n+import org.apache.log4j.Logger;\n+\n import com.cloud.agent.AgentManager;\n import com.cloud.agent.api.Answer;\n import com.cloud.agent.api.routing.GlobalLoadBalancerConfigCommand;\n@@ -27,7 +43,11 @@\n import com.cloud.agent.api.to.LoadBalancerTO;\n import com.cloud.agent.api.to.StaticNatRuleTO;\n import com.cloud.api.ApiDBUtils;\n-import com.cloud.api.commands.*;\n+import com.cloud.api.commands.AddNetscalerLoadBalancerCmd;\n+import com.cloud.api.commands.ConfigureNetscalerLoadBalancerCmd;\n+import com.cloud.api.commands.DeleteNetscalerLoadBalancerCmd;\n+import com.cloud.api.commands.ListNetscalerLoadBalancerNetworksCmd;\n+import com.cloud.api.commands.ListNetscalerLoadBalancersCmd;\n import com.cloud.api.response.NetscalerLoadBalancerResponse;\n import com.cloud.configuration.Config;\n import com.cloud.configuration.ConfigurationManager;\n@@ -39,27 +59,48 @@\n import com.cloud.dc.dao.DataCenterDao;\n import com.cloud.dc.dao.DataCenterIpAddressDao;\n import com.cloud.deploy.DeployDestination;\n-import com.cloud.exception.*;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InsufficientNetworkCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.host.Host;\n import com.cloud.host.HostVO;\n import com.cloud.host.dao.HostDao;\n import com.cloud.host.dao.HostDetailsDao;\n-import com.cloud.network.*;\n+import com.cloud.network.ExternalLoadBalancerDeviceManager;\n+import com.cloud.network.ExternalLoadBalancerDeviceManagerImpl;\n+import com.cloud.network.IpAddress;\n+import com.cloud.network.NetScalerPodVO;\n+import com.cloud.network.Network;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkModel;\n import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.PhysicalNetwork;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.PublicIpAddress;\n import com.cloud.network.as.AutoScaleCounter;\n import com.cloud.network.as.AutoScaleCounter.AutoScaleCounterType;\n-import com.cloud.network.dao.*;\n+import com.cloud.network.dao.ExternalLoadBalancerDeviceDao;\n+import com.cloud.network.dao.ExternalLoadBalancerDeviceVO;\n import com.cloud.network.dao.ExternalLoadBalancerDeviceVO.LBDeviceState;\n+import com.cloud.network.dao.NetScalerPodDao;\n+import com.cloud.network.dao.NetworkDao;\n+import com.cloud.network.dao.NetworkExternalLoadBalancerDao;\n+import com.cloud.network.dao.NetworkExternalLoadBalancerVO;\n+import com.cloud.network.dao.NetworkServiceMapDao;\n+import com.cloud.network.dao.NetworkVO;\n+import com.cloud.network.dao.PhysicalNetworkDao;\n+import com.cloud.network.dao.PhysicalNetworkVO;\n import com.cloud.network.lb.LoadBalancingRule;\n import com.cloud.network.lb.LoadBalancingRule.LbDestination;\n import com.cloud.network.resource.NetscalerResource;\n import com.cloud.network.rules.FirewallRule;\n-import com.cloud.network.rules.FirewallRule.Purpose;\n import com.cloud.network.rules.LbStickinessMethod;\n import com.cloud.network.rules.LbStickinessMethod.StickinessMethodType;\n+import com.cloud.network.rules.LoadBalancerContainer;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.network.vpc.PrivateGateway;\n import com.cloud.network.vpc.StaticRouteProfile;\n@@ -75,15 +116,6 @@\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachineProfile;\n import com.google.gson.Gson;\n-import org.apache.cloudstack.api.ApiConstants;\n-import org.apache.cloudstack.network.ExternalNetworkDeviceManager.NetworkDevice;\n-import org.apache.cloudstack.region.gslb.GslbServiceProvider;\n-import org.apache.log4j.Logger;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-import java.net.URI;\n-import java.util.*;\n \n @Local(value = {NetworkElement.class, StaticNatServiceProvider.class, LoadBalancingServiceProvider.class, GslbServiceProvider.class})\n public class NetscalerElement extends ExternalLoadBalancerDeviceManagerImpl implements LoadBalancingServiceProvider,\n@@ -207,6 +239,10 @@ public boolean applyLBRules(Network config, List<LoadBalancingRule> rules) throw\n         if (!canHandle(config, Service.Lb)) {\n             return false;\n         }\n+        \n+        if (canHandleLbRules(rules)) {\n+            return false;\n+        }\n \n         if (isBasicZoneNetwok(config)) {\n             return applyElasticLoadBalancerRules(config, rules);\n@@ -237,6 +273,9 @@ public boolean applyLBRules(Network config, List<LoadBalancingRule> rules) throw\n         // Specifies that load balancing rules can only be made with public IPs that aren't source NAT IPs\n         lbCapabilities.put(Capability.LoadBalancingSupportedIps, \"additional\");\n \n+        // Supports only Public load balancing\n+        lbCapabilities.put(Capability.LbSchemes, LoadBalancerContainer.Scheme.Public.toString());\n+        \n         // Specifies that load balancing rules can support autoscaling and the list of counters it supports\n         AutoScaleCounter counter;\n         List<AutoScaleCounter> counterList = new ArrayList<AutoScaleCounter>();\n@@ -644,14 +683,7 @@ public IpDeployer getIpDeployer(Network network) {\n         return this;\n     }\n \n-    public boolean applyElasticLoadBalancerRules(Network network, List<? extends FirewallRule> rules) throws ResourceUnavailableException {\n-\n-        List<LoadBalancingRule> loadBalancingRules = new ArrayList<LoadBalancingRule>();\n-        for (FirewallRule rule : rules) {\n-            if (rule.getPurpose().equals(Purpose.LoadBalancing)) {\n-                loadBalancingRules.add((LoadBalancingRule) rule);\n-            }\n-        }\n+    public boolean applyElasticLoadBalancerRules(Network network, List<LoadBalancingRule> loadBalancingRules) throws ResourceUnavailableException {\n \n         if (loadBalancingRules == null || loadBalancingRules.isEmpty()) {\n             return true;\n@@ -682,7 +714,7 @@ public boolean applyElasticLoadBalancerRules(Network network, List<? extends Fir\n             String protocol = rule.getProtocol();\n             String algorithm = rule.getAlgorithm();\n             String lbUuid = rule.getUuid();\n-            String srcIp = _networkMgr.getIp(rule.getSourceIpAddressId()).getAddress().addr();\n+            String srcIp = rule.getSourceIp().addr();\n             int srcPort = rule.getSourcePortStart();\n             List<LbDestination> destinations = rule.getDestinations();\n \n@@ -813,16 +845,10 @@ private ExternalLoadBalancerDeviceVO getNetScalerForEIP(StaticNat rule) {\n         return null;\n     }\n \n-    public List<LoadBalancerTO> getElasticLBRulesHealthCheck(Network network, List<? extends FirewallRule> rules)\n+    public List<LoadBalancerTO> getElasticLBRulesHealthCheck(Network network, List<LoadBalancingRule> loadBalancingRules)\n             throws ResourceUnavailableException {\n \n         HealthCheckLBConfigAnswer answer = null;\n-        List<LoadBalancingRule> loadBalancingRules = new ArrayList<LoadBalancingRule>();\n-        for (FirewallRule rule : rules) {\n-            if (rule.getPurpose().equals(Purpose.LoadBalancing)) {\n-                loadBalancingRules.add((LoadBalancingRule) rule);\n-            }\n-        }\n \n         if (loadBalancingRules == null || loadBalancingRules.isEmpty()) {\n             return null;\n@@ -849,7 +875,7 @@ private ExternalLoadBalancerDeviceVO getNetScalerForEIP(StaticNat rule) {\n             String protocol = rule.getProtocol();\n             String algorithm = rule.getAlgorithm();\n             String lbUuid = rule.getUuid();\n-            String srcIp = _networkMgr.getIp(rule.getSourceIpAddressId()).getAddress().addr();\n+            String srcIp = rule.getSourceIp().addr();\n             int srcPort = rule.getSourcePortStart();\n             List<LbDestination> destinations = rule.getDestinations();\n \n@@ -874,7 +900,7 @@ private ExternalLoadBalancerDeviceVO getNetScalerForEIP(StaticNat rule) {\n \n     public List<LoadBalancerTO> updateHealthChecks(Network network, List<LoadBalancingRule> lbrules) {\n \n-        if (canHandle(network, Service.Lb)) {\n+        if (canHandle(network, Service.Lb) && canHandleLbRules(lbrules)) {\n             try {\n \n                 if (isBasicZoneNetwok(network)) {\n@@ -891,7 +917,7 @@ private ExternalLoadBalancerDeviceVO getNetScalerForEIP(StaticNat rule) {\n         return null;\n     }\n \n-    public List<LoadBalancerTO> getLBHealthChecks(Network network, List<? extends FirewallRule> rules)\n+    public List<LoadBalancerTO> getLBHealthChecks(Network network, List<LoadBalancingRule> rules)\n             throws ResourceUnavailableException {\n         return super.getLBHealthChecks(network, rules);\n     }\n@@ -960,6 +986,22 @@ public String getZoneGslbProviderPrivateIp(long zoneId) {\n         }\n         return null;\n     }\n+    \n+    private boolean canHandleLbRules(List<LoadBalancingRule> rules) {\n+        Map<Capability, String> lbCaps = this.getCapabilities().get(Service.Lb);\n+        if (!lbCaps.isEmpty()) {\n+            String schemeCaps = lbCaps.get(Capability.LbSchemes);\n+            if (schemeCaps != null) {\n+                for (LoadBalancingRule rule : rules) {\n+                    if (!schemeCaps.contains(rule.getScheme().toString())) {\n+                        s_logger.debug(\"Scheme \" + rules.get(0).getScheme() + \" is not supported by the provider \" + this.getName());\n+                        return false;\n+                    }\n+                }\n+            }\n+        }\n+        return true;\n+    }\n \n     @Override\n     public boolean implementVpc(Vpc vpc, DeployDestination dest, ReservationContext context)",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/network-elements/netscaler/src/com/cloud/network/element/NetscalerElement.java",
                "sha": "4f2a0a1da4264b271ba50d028cde2ce9d2962f92",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/plugins/pom.xml",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/pom.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "plugins/pom.xml",
                "patch": "@@ -62,6 +62,7 @@\n     <module>storage/volume/default</module>\n     <module>alert-handlers/snmp-alerts</module>\n     <module>alert-handlers/syslog-alerts</module>\n+    <module>network-elements/internal-loadbalancer</module>\n   </modules>\n \n   <dependencies>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/plugins/pom.xml",
                "sha": "e49fac9533a26bfa135d26dca4884951ddf8312f",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/ApiDBUtils.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiDBUtils.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 3,
                "filename": "server/src/com/cloud/api/ApiDBUtils.java",
                "patch": "@@ -25,8 +25,6 @@\n import javax.annotation.PostConstruct;\n import javax.inject.Inject;\n \n-import com.cloud.network.rules.LoadBalancer;\n-import com.cloud.region.ha.GlobalLoadBalancingRulesService;\n import org.apache.cloudstack.affinity.AffinityGroup;\n import org.apache.cloudstack.affinity.AffinityGroupResponse;\n import org.apache.cloudstack.affinity.dao.AffinityGroupDao;\n@@ -37,8 +35,8 @@\n import org.apache.cloudstack.api.response.DiskOfferingResponse;\n import org.apache.cloudstack.api.response.DomainRouterResponse;\n import org.apache.cloudstack.api.response.EventResponse;\n-import org.apache.cloudstack.api.response.HostResponse;\n import org.apache.cloudstack.api.response.HostForMigrationResponse;\n+import org.apache.cloudstack.api.response.HostResponse;\n import org.apache.cloudstack.api.response.InstanceGroupResponse;\n import org.apache.cloudstack.api.response.ProjectAccountResponse;\n import org.apache.cloudstack.api.response.ProjectInvitationResponse;\n@@ -52,6 +50,7 @@\n import org.apache.cloudstack.api.response.UserVmResponse;\n import org.apache.cloudstack.api.response.VolumeResponse;\n import org.apache.cloudstack.api.response.ZoneResponse;\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n import org.apache.cloudstack.storage.datastore.db.StoragePoolVO;\n import org.springframework.stereotype.Component;\n@@ -157,6 +156,8 @@\n import com.cloud.network.as.dao.AutoScaleVmProfileDao;\n import com.cloud.network.as.dao.ConditionDao;\n import com.cloud.network.as.dao.CounterDao;\n+import com.cloud.network.dao.AccountGuestVlanMapDao;\n+import com.cloud.network.dao.AccountGuestVlanMapVO;\n import com.cloud.network.dao.FirewallRulesCidrsDao;\n import com.cloud.network.dao.FirewallRulesDao;\n import com.cloud.network.dao.IPAddressDao;\n@@ -181,6 +182,7 @@\n import com.cloud.network.dao.Site2SiteVpnGatewayVO;\n import com.cloud.network.router.VirtualRouter;\n import com.cloud.network.rules.FirewallRuleVO;\n+import com.cloud.network.rules.LoadBalancer;\n import com.cloud.network.security.SecurityGroup;\n import com.cloud.network.security.SecurityGroupManager;\n import com.cloud.network.security.SecurityGroupVO;\n@@ -204,6 +206,7 @@\n import com.cloud.projects.ProjectAccount;\n import com.cloud.projects.ProjectInvitation;\n import com.cloud.projects.ProjectService;\n+import com.cloud.region.ha.GlobalLoadBalancingRulesService;\n import com.cloud.resource.ResourceManager;\n import com.cloud.server.Criteria;\n import com.cloud.server.ManagementServer;\n@@ -499,6 +502,7 @@\n     @Inject private VMSnapshotDao vmSnapshotDao;\n     @Inject private NicSecondaryIpDao nicSecondaryIpDao;\n     @Inject private VpcProvisioningService vpcProvSvc;\n+    @Inject private ApplicationLoadBalancerRuleDao _appLbDao;\n     @Inject private AffinityGroupDao affinityGroupDao;\n     @Inject private AffinityGroupJoinDao affinityGroupJoinDao;\n     @Inject private GlobalLoadBalancingRulesService gslbService;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/ApiDBUtils.java",
                "sha": "fce1f7190860507f2c27bf6cd4186fe702348908",
                "status": "modified"
            },
            {
                "additions": 107,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 108,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -44,6 +44,9 @@\n import org.apache.cloudstack.api.ResponseGenerator;\n import org.apache.cloudstack.api.command.user.job.QueryAsyncJobResultCmd;\n import org.apache.cloudstack.api.response.AccountResponse;\n+import org.apache.cloudstack.api.response.ApplicationLoadBalancerInstanceResponse;\n+import org.apache.cloudstack.api.response.ApplicationLoadBalancerResponse;\n+import org.apache.cloudstack.api.response.ApplicationLoadBalancerRuleResponse;\n import org.apache.cloudstack.api.response.AsyncJobResponse;\n import org.apache.cloudstack.api.response.AutoScalePolicyResponse;\n import org.apache.cloudstack.api.response.AutoScaleVmGroupResponse;\n@@ -72,6 +75,7 @@\n import org.apache.cloudstack.api.response.HypervisorCapabilitiesResponse;\n import org.apache.cloudstack.api.response.IPAddressResponse;\n import org.apache.cloudstack.api.response.InstanceGroupResponse;\n+import org.apache.cloudstack.api.response.InternalLoadBalancerElementResponse;\n import org.apache.cloudstack.api.response.IpForwardingRuleResponse;\n import org.apache.cloudstack.api.response.IsolationMethodResponse;\n import org.apache.cloudstack.api.response.LBHealthCheckPolicyResponse;\n@@ -130,6 +134,7 @@\n import org.apache.cloudstack.api.response.VpcResponse;\n import org.apache.cloudstack.api.response.VpnUsersResponse;\n import org.apache.cloudstack.api.response.ZoneResponse;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n import org.apache.cloudstack.region.Region;\n import org.apache.cloudstack.storage.datastore.db.StoragePoolVO;\n import org.apache.cloudstack.usage.Usage;\n@@ -189,6 +194,7 @@\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkModel;\n import com.cloud.network.NetworkProfile;\n import com.cloud.network.Networks.IsolationType;\n import com.cloud.network.Networks.TrafficType;\n@@ -216,6 +222,7 @@\n import com.cloud.network.rules.FirewallRuleVO;\n import com.cloud.network.rules.HealthCheckPolicy;\n import com.cloud.network.rules.LoadBalancer;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.PortForwardingRule;\n import com.cloud.network.rules.StaticNatRule;\n import com.cloud.network.rules.StickinessPolicy;\n@@ -229,6 +236,7 @@\n import com.cloud.network.vpc.VpcOffering;\n import com.cloud.offering.DiskOffering;\n import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.offering.ServiceOffering;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.org.Cluster;\n@@ -269,6 +277,7 @@\n import com.cloud.uservm.UserVm;\n import com.cloud.utils.Pair;\n import com.cloud.utils.StringUtils;\n+import com.cloud.utils.net.Ip;\n import com.cloud.utils.net.NetUtils;\n import com.cloud.vm.ConsoleProxyVO;\n import com.cloud.vm.InstanceGroup;\n@@ -289,6 +298,7 @@\n     private static final DecimalFormat s_percentFormat = new DecimalFormat(\"##.##\");\n     @Inject private EntityManager _entityMgr = null;\n     @Inject private UsageService _usageSvc = null;\n+    @Inject NetworkModel _ntwkModel;\n \n     @Override\n     public UserResponse createUserResponse(User user) {\n@@ -750,7 +760,7 @@ public LoadBalancerResponse createLoadBalancerResponse(LoadBalancer loadBalancer\n         }\n \n         //set tag information\n-        List<? extends ResourceTag> tags = ApiDBUtils.listByResourceTypeAndId(TaggedResourceType.UserVm, loadBalancer.getId());\n+        List<? extends ResourceTag> tags = ApiDBUtils.listByResourceTypeAndId(TaggedResourceType.LoadBalancer, loadBalancer.getId());\n         List<ResourceTagResponse> tagResponses = new ArrayList<ResourceTagResponse>();\n         for (ResourceTag tag : tags) {\n             ResourceTagResponse tagResponse = createResourceTagResponse(tag, true);\n@@ -2263,6 +2273,13 @@ public NetworkOfferingResponse createNetworkOfferingResponse(NetworkOffering off\n         response.setForVpc(ApiDBUtils.isOfferingForVpc(offering));\n \n         response.setServices(serviceResponses);\n+        \n+        //set network offering details\n+        Map<Detail, String> details = _ntwkModel.getNtwkOffDetails(offering.getId());\n+        if (details != null && !details.isEmpty()) {\n+            response.setDetails(details);\n+        }\n+        \n         response.setObjectName(\"networkoffering\");\n         return response;\n     }\n@@ -2826,6 +2843,11 @@ public TrafficTypeResponse createTrafficTypeResponse(PhysicalNetworkTrafficType\n \n     @Override\n     public VirtualRouterProviderResponse createVirtualRouterProviderResponse(VirtualRouterProvider result) {\n+        //generate only response of the VR/VPCVR provider type\n+        if (!(result.getType() == VirtualRouterProvider.VirtualRouterProviderType.VirtualRouter\n+                || result.getType() == VirtualRouterProvider.VirtualRouterProviderType.VPCVirtualRouter)) {\n+            return null;\n+        }\n         VirtualRouterProviderResponse response = new VirtualRouterProviderResponse();\n         response.setId(result.getUuid());\n         PhysicalNetworkServiceProvider nsp = ApiDBUtils.findPhysicalNetworkServiceProviderById(result.getNspId());\n@@ -3689,6 +3711,73 @@ public NicResponse createNicResponse(Nic result) {\n         return response;\n     }\n \n+    \n+    @Override\n+    public ApplicationLoadBalancerResponse createLoadBalancerContainerReponse(ApplicationLoadBalancerRule lb, Map<Ip, UserVm> lbInstances) {\n+\n+        ApplicationLoadBalancerResponse lbResponse = new ApplicationLoadBalancerResponse();\n+        lbResponse.setId(lb.getUuid());\n+        lbResponse.setName(lb.getName());\n+        lbResponse.setDescription(lb.getDescription());\n+        lbResponse.setAlgorithm(lb.getAlgorithm());\n+        Network nw = ApiDBUtils.findNetworkById(lb.getNetworkId());\n+        lbResponse.setNetworkId(nw.getUuid());\n+        populateOwner(lbResponse, lb);\n+        \n+        if (lb.getScheme() == Scheme.Internal) {\n+            lbResponse.setSourceIp(lb.getSourceIp().addr());\n+            //TODO - create the view for the load balancer rule to reflect the network uuid\n+            Network network = ApiDBUtils.findNetworkById(lb.getNetworkId());\n+            lbResponse.setSourceIpNetworkId(network.getUuid());\n+        } else {\n+            //for public, populate the ip information from the ip address\n+            IpAddress publicIp = ApiDBUtils.findIpAddressById(lb.getSourceIpAddressId());\n+            lbResponse.setSourceIp(publicIp.getAddress().addr());\n+            Network ntwk = ApiDBUtils.findNetworkById(publicIp.getNetworkId());\n+            lbResponse.setSourceIpNetworkId(ntwk.getUuid());\n+        }\n+        \n+        //set load balancer rules information (only one rule per load balancer in this release)\n+        List<ApplicationLoadBalancerRuleResponse> ruleResponses = new ArrayList<ApplicationLoadBalancerRuleResponse>();\n+        ApplicationLoadBalancerRuleResponse ruleResponse = new ApplicationLoadBalancerRuleResponse();\n+        ruleResponse.setInstancePort(lb.getDefaultPortStart());\n+        ruleResponse.setSourcePort(lb.getSourcePortStart());\n+        String stateToSet = lb.getState().toString();\n+        if (stateToSet.equals(FirewallRule.State.Revoke)) {\n+            stateToSet = \"Deleting\";\n+        }\n+        ruleResponse.setState(stateToSet);\n+        ruleResponse.setObjectName(\"loadbalancerrule\");\n+        ruleResponses.add(ruleResponse);\n+        lbResponse.setLbRules(ruleResponses);\n+        \n+        //set Lb instances information\n+        List<ApplicationLoadBalancerInstanceResponse> instanceResponses = new ArrayList<ApplicationLoadBalancerInstanceResponse>();\n+        for (Ip ip : lbInstances.keySet()) {\n+            ApplicationLoadBalancerInstanceResponse instanceResponse = new ApplicationLoadBalancerInstanceResponse();\n+            instanceResponse.setIpAddress(ip.addr());\n+            UserVm vm = lbInstances.get(ip);\n+            instanceResponse.setId(vm.getUuid());\n+            instanceResponse.setName(vm.getInstanceName());\n+            instanceResponse.setObjectName(\"loadbalancerinstance\");\n+            instanceResponses.add(instanceResponse);\n+        }\n+        \n+        lbResponse.setLbInstances(instanceResponses);\n+\n+        //set tag information\n+        List<? extends ResourceTag> tags = ApiDBUtils.listByResourceTypeAndId(TaggedResourceType.LoadBalancer, lb.getId());\n+        List<ResourceTagResponse> tagResponses = new ArrayList<ResourceTagResponse>();\n+        for (ResourceTag tag : tags) {\n+            ResourceTagResponse tagResponse = createResourceTagResponse(tag, true);\n+            tagResponses.add(tagResponse);\n+        }\n+        lbResponse.setTags(tagResponses);\n+\n+        lbResponse.setObjectName(\"loadbalancer\");\n+        return lbResponse;\n+    }\n+\n     @Override\n     public AffinityGroupResponse createAffinityGroupResponse(AffinityGroup group) {\n \n@@ -3719,8 +3808,25 @@ public Long getAffinityGroupId(String groupName, long accountId) {\n         }\n     }\n \n+    \n+    @Override\n+    public InternalLoadBalancerElementResponse createInternalLbElementResponse(VirtualRouterProvider result) {\n+        if (result.getType() != VirtualRouterProvider.VirtualRouterProviderType.InternalLbVm) {\n+            return null;\n+        }\n+        InternalLoadBalancerElementResponse response = new InternalLoadBalancerElementResponse();\n+        response.setId(result.getUuid());\n+        PhysicalNetworkServiceProvider nsp = ApiDBUtils.findPhysicalNetworkServiceProviderById(result.getNspId());\n+        if (nsp != null) {\n+            response.setNspId(nsp.getUuid());\n+        }\n+        response.setEnabled(result.isEnabled());\n \n+        response.setObjectName(\"internalloadbalancerelement\");\n+        return response;\n+    }\n \n+    \n     @Override\n     public IsolationMethodResponse createIsolationMethodResponse(IsolationType method) {\n         IsolationMethodResponse response = new IsolationMethodResponse();",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "d5960abba8b6e7c51be1b30416096a144cc7be6f",
                "status": "modified"
            },
            {
                "additions": 29,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/query/QueryManagerImpl.java",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/query/QueryManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 16,
                "filename": "server/src/com/cloud/api/query/QueryManagerImpl.java",
                "patch": "@@ -29,7 +29,9 @@\n import org.apache.cloudstack.affinity.AffinityGroupResponse;\n import org.apache.cloudstack.affinity.AffinityGroupVMMapVO;\n import org.apache.cloudstack.affinity.dao.AffinityGroupVMMapDao;\n+import org.apache.cloudstack.api.BaseListProjectAndAccountResourcesCmd;\n import org.apache.cloudstack.api.command.admin.host.ListHostsCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.ListInternalLBVMsCmd;\n import org.apache.cloudstack.api.command.admin.router.ListRoutersCmd;\n import org.apache.cloudstack.api.command.admin.storage.ListStoragePoolsCmd;\n import org.apache.cloudstack.api.command.admin.user.ListUsersCmd;\n@@ -981,27 +983,32 @@\n \n     @Override\n     public ListResponse<DomainRouterResponse> searchForRouters(ListRoutersCmd cmd) {\n-        Pair<List<DomainRouterJoinVO>, Integer> result = searchForRoutersInternal(cmd);\n+        Pair<List<DomainRouterJoinVO>, Integer> result = searchForRoutersInternal(cmd, cmd.getId(), cmd.getRouterName(),\n+                cmd.getState(), cmd.getZoneId(), cmd.getPodId(), cmd.getHostId(), cmd.getKeyword(), cmd.getNetworkId(),\n+                cmd.getVpcId(), cmd.getForVpc(), cmd.getRole(), cmd.getZoneType());\n         ListResponse<DomainRouterResponse> response = new ListResponse<DomainRouterResponse>();\n \n         List<DomainRouterResponse> routerResponses = ViewResponseHelper.createDomainRouterResponse(result.first().toArray(new DomainRouterJoinVO[result.first().size()]));\n         response.setResponses(routerResponses, result.second());\n         return response;\n     }\n+    \n+    @Override\n+    public ListResponse<DomainRouterResponse> searchForInternalLbVms(ListInternalLBVMsCmd cmd) {\n+        Pair<List<DomainRouterJoinVO>, Integer> result = searchForRoutersInternal(cmd, cmd.getId(), cmd.getRouterName(),\n+                cmd.getState(), cmd.getZoneId(), cmd.getPodId(), cmd.getHostId(), cmd.getKeyword(), cmd.getNetworkId(),\n+                cmd.getVpcId(), cmd.getForVpc(), cmd.getRole(), cmd.getZoneType());\n+        ListResponse<DomainRouterResponse> response = new ListResponse<DomainRouterResponse>();\n \n+        List<DomainRouterResponse> routerResponses = ViewResponseHelper.createDomainRouterResponse(result.first().toArray(new DomainRouterJoinVO[result.first().size()]));\n+        response.setResponses(routerResponses, result.second());\n+        return response;\n+    }\n \n-    private Pair<List<DomainRouterJoinVO>, Integer> searchForRoutersInternal(ListRoutersCmd cmd) {\n-        Long id = cmd.getId();\n-        String name = cmd.getRouterName();\n-        String state = cmd.getState();\n-        Long zoneId = cmd.getZoneId();\n-        String zoneType = cmd.getZoneType();\n-        Long pod = cmd.getPodId();\n-        Long hostId = cmd.getHostId();\n-        String keyword = cmd.getKeyword();\n-        Long networkId = cmd.getNetworkId();\n-        Long vpcId = cmd.getVpcId();\n-        Boolean forVpc = cmd.getForVpc();\n+\n+    private Pair<List<DomainRouterJoinVO>, Integer> searchForRoutersInternal(BaseListProjectAndAccountResourcesCmd cmd, Long id,\n+            String name, String state, Long zoneId, Long podId, Long hostId, String keyword, Long networkId, Long vpcId, Boolean forVpc, String role, String zoneType) {\n+       \n \n         Account caller = UserContext.current().getCaller();\n         List<Long> permittedAccounts = new ArrayList<Long>();\n@@ -1032,6 +1039,7 @@\n         sb.and(\"podId\", sb.entity().getPodId(), SearchCriteria.Op.EQ);\n         sb.and(\"hostId\", sb.entity().getHostId(), SearchCriteria.Op.EQ);\n         sb.and(\"vpcId\", sb.entity().getVpcId(), SearchCriteria.Op.EQ);\n+        sb.and(\"role\", sb.entity().getRole(), SearchCriteria.Op.EQ);\n \n         if (forVpc != null) {\n             if (forVpc) {\n@@ -1073,13 +1081,14 @@\n             sc.setParameters(\"dataCenterId\", zoneId);\n         }\n \n+        if (podId != null) {\n+            sc.setParameters(\"podId\", podId);\n+        }\n+\n         if (zoneType != null) {\n             sc.setParameters(\"dataCenterType\", zoneType);\n         }\n         \n-        if (pod != null) {\n-            sc.setParameters(\"podId\", pod);\n-        }\n \n         if (hostId != null) {\n             sc.setParameters(\"hostId\", hostId);\n@@ -1092,6 +1101,10 @@\n         if (vpcId != null) {\n             sc.setParameters(\"vpcId\", vpcId);\n         }\n+        \n+        if (role != null) {\n+            sc.setParameters(\"role\", role);\n+        }\n \n         // search VR details by ids\n         Pair<List<DomainRouterJoinVO>, Integer> uniqueVrPair = _routerJoinDao.searchAndCount(sc, searchFilter);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/query/QueryManagerImpl.java",
                "sha": "808b1efceb1f8f87baeb80c639079c2297af11b9",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/query/dao/DomainRouterJoinDaoImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/query/dao/DomainRouterJoinDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/query/dao/DomainRouterJoinDaoImpl.java",
                "patch": "@@ -32,6 +32,7 @@\n import com.cloud.configuration.dao.ConfigurationDao;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.network.router.VirtualRouter;\n+import com.cloud.network.router.VirtualRouter.Role;\n import com.cloud.user.Account;\n import com.cloud.utils.db.GenericDaoBase;\n import com.cloud.utils.db.SearchBuilder;\n@@ -156,14 +157,20 @@ public DomainRouterResponse newDomainRouterResponse(DomainRouterJoinVO router, A\n         routerResponse.setIp6Dns2(router.getIp6Dns2());\n \n         routerResponse.setVpcId(router.getVpcUuid());\n+        \n+        routerResponse.setRole(router.getRole().toString());\n \n         // set async job\n         if (router.getJobId() != null) {\n             routerResponse.setJobId(router.getJobUuid());\n             routerResponse.setJobStatus(router.getJobStatus());\n         }\n \n-        routerResponse.setObjectName(\"router\");\n+        if (router.getRole() == Role.INTERNAL_LB_VM) {\n+            routerResponse.setObjectName(\"internalloadbalancervm\");\n+        } else {\n+            routerResponse.setObjectName(\"router\");\n+        }\n \n         return routerResponse;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/query/dao/DomainRouterJoinDaoImpl.java",
                "sha": "a7a83de14a1883fb6b28861d57c6d1ca4f9eb46b",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/query/vo/DomainRouterJoinVO.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/query/vo/DomainRouterJoinVO.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 2,
                "filename": "server/src/com/cloud/api/query/vo/DomainRouterJoinVO.java",
                "patch": "@@ -28,6 +28,7 @@\n \n import com.cloud.network.Network.GuestType;\n import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.router.VirtualRouter;\n import com.cloud.network.router.VirtualRouter.RedundantState;\n import com.cloud.utils.db.GenericDao;\n import com.cloud.vm.VirtualMachine.State;\n@@ -238,14 +239,16 @@\n     @Column(name=\"guest_type\")\n     @Enumerated(value=EnumType.STRING)\n     private GuestType guestType;\n+    \n+    @Column(name=\"role\")\n+    @Enumerated(value=EnumType.STRING)\n+    private VirtualRouter.Role role;\n \n \n     public DomainRouterJoinVO() {\n     }\n \n \n-\n-\n     @Override\n     public long getId() {\n         return id;\n@@ -1003,4 +1006,14 @@ public String getIp6Dns2() {\n \tpublic void setIp6Dns2(String ip6Dns2) {\n \t\tthis.ip6Dns2 = ip6Dns2;\n \t}\n+\n+\n+    public VirtualRouter.Role getRole() {\n+        return role;\n+    }\n+\n+\n+    public void setRole(VirtualRouter.Role role) {\n+        this.role = role;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/api/query/vo/DomainRouterJoinVO.java",
                "sha": "9e9e4a2ba7bc23db833811eacd90299f915125a1",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/configuration/Config.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/Config.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/src/com/cloud/configuration/Config.java",
                "patch": "@@ -408,7 +408,10 @@\n     CloudDnsName(\"Advanced\", ManagementServer.class, String.class, \"cloud.dns.name\", \"default\", \" DNS name of the cloud\", null),\n \t\n     BlacklistedRoutes(\"Advanced\", VpcManager.class, String.class, \"blacklisted.routes\", null, \"Routes that are blacklisted, can not be used for Static Routes creation for the VPC Private Gateway\",\n-\t           \"routes\", ConfigurationParameterScope.zone.toString());\n+\t           \"routes\", ConfigurationParameterScope.zone.toString()),\n+\t\n+    InternalLbVmServiceOfferingId(\"Advanced\", ManagementServer.class, Long.class, \"internallbvm.service.offering\", null, \"Uuid of the service offering used by internal lb vm; if NULL - default system internal lb offering will be used\", null);\n+ \n     \n \t\n \tprivate final String _category;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/configuration/Config.java",
                "sha": "77ca2de1923aacaf7d83d7933d6f889b7f670a30",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/configuration/ConfigurationManager.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/ConfigurationManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 5,
                "filename": "server/src/com/cloud/configuration/ConfigurationManager.java",
                "patch": "@@ -30,13 +30,13 @@\n import com.cloud.exception.ConcurrentOperationException;\n import com.cloud.exception.InsufficientCapacityException;\n import com.cloud.exception.InvalidParameterValueException;\n-import com.cloud.exception.ResourceAllocationException;\n import com.cloud.network.Network;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.offering.DiskOffering;\n+import com.cloud.offering.NetworkOffering;\n import com.cloud.offering.NetworkOffering.Availability;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.org.Grouping.AllocationState;\n@@ -179,8 +179,6 @@ DataCenterVO createZone(long userId, String zoneName, String dns1, String dns2,\n      * @param trafficType\n      * @param tags\n      * @param specifyVlan\n-     * @param isPersistent\n-     *            ;\n      * @param networkRate\n      *            TODO\n      * @param serviceProviderMap\n@@ -196,14 +194,16 @@ DataCenterVO createZone(long userId, String zoneName, String dns1, String dns2,\n      *            ;\n      * @param specifyIpRanges\n      *            TODO\n+     * @param isPersistent\n+     *            ;\n+     * @param details TODO\n      * @param id\n-     * \n      * @return network offering object\n      */\n \n     NetworkOfferingVO createNetworkOffering(String name, String displayText, TrafficType trafficType, String tags, boolean specifyVlan, Availability availability, Integer networkRate, Map<Service, Set<Provider>> serviceProviderMap,\n             boolean isDefault, Network.GuestType type, boolean systemOnly, Long serviceOfferingId, boolean conserveMode, Map<Service, Map<Capability, String>> serviceCapabilityMap,\n-            boolean specifyIpRanges, boolean isPersistent);\n+            boolean specifyIpRanges, boolean isPersistent, Map<NetworkOffering.Detail,String> details);\n \n     Vlan createVlanAndPublicIpRange(long zoneId, long networkId, long physicalNetworkId, boolean forVirtualNetwork, Long podId, String startIP, String endIP, String vlanGateway, String vlanNetmask, String vlanId, Account vlanOwner, String startIPv6, String endIPv6, String vlanIp6Gateway, String vlanIp6Cidr) throws InsufficientCapacityException, ConcurrentOperationException, InvalidParameterValueException;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/configuration/ConfigurationManager.java",
                "sha": "d2f831905ee2d6bc7ac8ee61d8af1f7db87c1d82",
                "status": "modified"
            },
            {
                "additions": 113,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "changes": 123,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/ConfigurationManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 10,
                "filename": "server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "patch": "@@ -39,6 +39,7 @@\n import javax.naming.directory.DirContext;\n import javax.naming.directory.InitialDirContext;\n \n+\n import com.cloud.dc.*;\n import com.cloud.dc.dao.*;\n import com.cloud.user.*;\n@@ -81,6 +82,17 @@\n import com.cloud.configuration.dao.ConfigurationDao;\n import com.cloud.dc.DataCenter.NetworkType;\n import com.cloud.dc.Vlan.VlanType;\n+import com.cloud.dc.VlanVO;\n+import com.cloud.dc.dao.AccountVlanMapDao;\n+import com.cloud.dc.dao.ClusterDao;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.dc.dao.DataCenterIpAddressDao;\n+import com.cloud.dc.dao.DataCenterLinkLocalIpAddressDao;\n+import com.cloud.dc.dao.DcDetailsDao;\n+import com.cloud.dc.dao.HostPodDao;\n+import com.cloud.dc.dao.PodVlanMapDao;\n+import com.cloud.dc.dao.VlanDao;\n+\n import com.cloud.deploy.DataCenterDeployment;\n import com.cloud.domain.Domain;\n import com.cloud.domain.DomainVO;\n@@ -115,10 +127,12 @@\n import com.cloud.network.dao.PhysicalNetworkTrafficTypeDao;\n import com.cloud.network.dao.PhysicalNetworkTrafficTypeVO;\n import com.cloud.network.dao.PhysicalNetworkVO;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.vpc.VpcManager;\n import com.cloud.offering.DiskOffering;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offering.NetworkOffering.Availability;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.offering.ServiceOffering;\n import com.cloud.offerings.NetworkOfferingServiceMapVO;\n import com.cloud.offerings.NetworkOfferingVO;\n@@ -1919,6 +1933,8 @@ public ServiceOffering createServiceOffering(CreateServiceOfferingCmd cmd) {\n                 vmType = VirtualMachine.Type.ConsoleProxy;\n             } else if (VirtualMachine.Type.SecondaryStorageVm.toString().toLowerCase().equals(vmTypeString)) {\n                 vmType = VirtualMachine.Type.SecondaryStorageVm;\n+            } else if (VirtualMachine.Type.InternalLoadBalancerVm.toString().toLowerCase().equals(vmTypeString)) {\n+                vmType = VirtualMachine.Type.InternalLoadBalancerVm;\n             } else {\n                 throw new InvalidParameterValueException(\"Invalid systemVmType. Supported types are: \" + VirtualMachine.Type.DomainRouter + \", \" + VirtualMachine.Type.ConsoleProxy + \", \"\n                         + VirtualMachine.Type.SecondaryStorageVm);\n@@ -3340,6 +3356,7 @@ public NetworkOffering createNetworkOffering(CreateNetworkOfferingCmd cmd) {\n         Network.GuestType guestType = null;\n         boolean specifyIpRanges = cmd.getSpecifyIpRanges();\n         boolean isPersistent = cmd.getIsPersistent();\n+        Map<String, String> detailsStr = cmd.getDetails();\n \n         // Verify traffic type\n         for (TrafficType tType : TrafficType.values()) {\n@@ -3432,10 +3449,10 @@ public NetworkOffering createNetworkOffering(CreateNetworkOfferingCmd cmd) {\n                 Network.Service service = Network.Service.getService(serviceStr);\n                 if (serviceProviderMap.containsKey(service)) {\n                     Set<Provider> providers = new HashSet<Provider>();\n-                    // in Acton, don't allow to specify more than 1 provider per service\n-                    if (svcPrv.get(serviceStr) != null && svcPrv.get(serviceStr).size() > 1) {\n+                    // Allow to specify more than 1 provider per service only if the service is LB\n+                    if (!serviceStr.equalsIgnoreCase(Service.Lb.getName()) && svcPrv.get(serviceStr) != null && svcPrv.get(serviceStr).size() > 1) {\n                         throw new InvalidParameterValueException(\"In the current release only one provider can be \" +\n-                        \t\t\"specified for the service\");\n+                        \t\t\"specified for the service if the service is not LB\");\n                     }\n                     for (String prvNameStr : svcPrv.get(serviceStr)) {\n                         // check if provider is supported\n@@ -3508,9 +3525,26 @@ public NetworkOffering createNetworkOffering(CreateNetworkOfferingCmd cmd) {\n             firewallProviderSet.add(firewallProvider);\n             serviceProviderMap.put(Service.Firewall, firewallProviderSet);\n         }\n+        \n+        Map<NetworkOffering.Detail, String> details = new HashMap<NetworkOffering.Detail, String>();\n+        if (detailsStr != null) {\n+            for (String detailStr : detailsStr.keySet()) {\n+                NetworkOffering.Detail offDetail = null;\n+                for (NetworkOffering.Detail supportedDetail: NetworkOffering.Detail.values()) {\n+                    if (detailStr.equalsIgnoreCase(supportedDetail.toString())) {\n+                        offDetail = supportedDetail;\n+                        break;\n+                    }\n+                }\n+                if (offDetail == null) {\n+                    throw new InvalidParameterValueException(\"Unsupported detail \" + detailStr);\n+                }\n+                details.put(offDetail, detailsStr.get(detailStr));\n+            }\n+        }\n \n         return createNetworkOffering(name, displayText, trafficType, tags, specifyVlan, availability, networkRate, serviceProviderMap, false, guestType, false,\n-                serviceOfferingId, conserveMode, serviceCapabilityMap, specifyIpRanges, isPersistent);\n+                serviceOfferingId, conserveMode, serviceCapabilityMap, specifyIpRanges, isPersistent, details);\n     }\n \n     void validateLoadBalancerServiceCapabilities(Map<Capability, String> lbServiceCapabilityMap) {\n@@ -3539,8 +3573,16 @@ void validateLoadBalancerServiceCapabilities(Map<Capability, String> lbServiceCa\n                     if (!enabled && !disabled) {\n                         throw new InvalidParameterValueException(\"Unknown specified value for \" + Capability.InlineMode.getName());\n                     }\n+                } else if (cap == Capability.LbSchemes) {\n+                    boolean internalLb = value.contains(\"internal\");\n+                    boolean publicLb = value.contains(\"public\");\n+                    if (!internalLb && !publicLb) {\n+                        throw new InvalidParameterValueException(\"Unknown specified value for \" + Capability.LbSchemes.getName());\n+                    }\n                 } else {\n-                    throw new InvalidParameterValueException(\"Only \" + Capability.SupportedLBIsolation.getName() + \", \" + Capability.ElasticLb.getName() + \", \" + Capability.InlineMode.getName() + \" capabilities can be sepcified for LB service\");\n+                    throw new InvalidParameterValueException(\"Only \" + Capability.SupportedLBIsolation.getName() + \n+                            \", \" + Capability.ElasticLb.getName() + \", \" + Capability.InlineMode.getName()\n+                            + \", \" + Capability.LbSchemes.getName() + \" capabilities can be sepcified for LB service\");\n                 }\n             }\n         }\n@@ -3612,7 +3654,7 @@ void validateStaticNatServiceCapablities(Map<Capability, String> staticNatServic\n     @DB\n     public NetworkOfferingVO createNetworkOffering(String name, String displayText, TrafficType trafficType, String tags, boolean specifyVlan, Availability availability, Integer networkRate,\n             Map<Service, Set<Provider>> serviceProviderMap, boolean isDefault, Network.GuestType type, boolean systemOnly, Long serviceOfferingId,\n-            boolean conserveMode, Map<Service, Map<Capability, String>> serviceCapabilityMap, boolean specifyIpRanges, boolean isPersistent) {\n+            boolean conserveMode, Map<Service, Map<Capability, String>> serviceCapabilityMap, boolean specifyIpRanges, boolean isPersistent, Map<NetworkOffering.Detail,String> details) {\n \n         String multicastRateStr = _configDao.getValue(\"multicast.throttling.rate\");\n         int multicastRate = ((multicastRateStr == null) ? 10 : Integer.parseInt(multicastRateStr));\n@@ -3666,6 +3708,8 @@ public NetworkOfferingVO createNetworkOffering(String name, String displayText,\n         boolean elasticIp = false;\n         boolean associatePublicIp = false;\n         boolean inline = false;\n+        boolean publicLb = false;\n+        boolean internalLb = false;\n         if (serviceCapabilityMap != null && !serviceCapabilityMap.isEmpty()) {\n             Map<Capability, String> lbServiceCapabilityMap = serviceCapabilityMap.get(Service.Lb);\n             \n@@ -3690,6 +3734,23 @@ public NetworkOfferingVO createNetworkOffering(String name, String displayText,\n                 } else {\n                     inline = false;\n                 }\n+                \n+                String publicLbStr = lbServiceCapabilityMap.get(Capability.LbSchemes);\n+                if (serviceProviderMap.containsKey(Service.Lb)) {\n+                    if (publicLbStr != null) {\n+                        _networkModel.checkCapabilityForProvider(serviceProviderMap.get(Service.Lb), Service.Lb, Capability.LbSchemes, publicLbStr);\n+                        internalLb = publicLbStr.contains(\"internal\");\n+                        publicLb = publicLbStr.contains(\"public\");\n+                    } else {\n+                        //if not specified, default public lb to true\n+                        publicLb = true;\n+                    }\n+                }\n+            }\n+            \n+            //in the current version of the code, publicLb and specificLb can't both be set to true for the same network offering\n+            if (publicLb && internalLb) {\n+                throw new InvalidParameterValueException(\"Public lb and internal lb can't be enabled at the same time on the offering\");\n             }\n \n             Map<Capability, String> sourceNatServiceCapabilityMap = serviceCapabilityMap.get(Service.SourceNat);\n@@ -3724,18 +3785,23 @@ public NetworkOfferingVO createNetworkOffering(String name, String displayText,\n \n         NetworkOfferingVO offering = new NetworkOfferingVO(name, displayText, trafficType, systemOnly, specifyVlan, \n                 networkRate, multicastRate, isDefault, availability, tags, type, conserveMode, dedicatedLb,\n-                sharedSourceNat, redundantRouter, elasticIp, elasticLb, specifyIpRanges, inline, isPersistent, associatePublicIp);\n+                sharedSourceNat, redundantRouter, elasticIp, elasticLb, specifyIpRanges, inline, isPersistent, associatePublicIp, publicLb, internalLb);\n \n         if (serviceOfferingId != null) {\n             offering.setServiceOfferingId(serviceOfferingId);\n         }\n+        \n+        //validate the details\n+        if (details != null) {\n+            validateNtwkOffDetails(details, serviceProviderMap);\n+        }\n \n         Transaction txn = Transaction.currentTxn();\n         txn.start();\n-        // create network offering object\n+        //1) create network offering object\n         s_logger.debug(\"Adding network offering \" + offering);\n-        offering = _networkOfferingDao.persist(offering);\n-        // populate services and providers\n+        offering = _networkOfferingDao.persist(offering, details);\n+        //2) populate services and providers\n         if (serviceProviderMap != null) {\n             for (Network.Service service : serviceProviderMap.keySet()) {\n                 Set<Provider> providers = serviceProviderMap.get(service);\n@@ -3769,6 +3835,42 @@ public NetworkOfferingVO createNetworkOffering(String name, String displayText,\n         return offering;\n     }\n \n+    protected void validateNtwkOffDetails(Map<Detail, String> details, Map<Service, Set<Provider>> serviceProviderMap) {\n+        for (Detail detail : details.keySet()) {\n+            \n+            Provider lbProvider = null;\n+            if (detail == NetworkOffering.Detail.InternalLbProvider || detail == NetworkOffering.Detail.PublicLbProvider) {\n+                //1) Vaidate the detail values - have to match the lb provider name\n+                String providerStr = details.get(detail);\n+                if (Network.Provider.getProvider(providerStr) == null) {\n+                    throw new InvalidParameterValueException(\"Invalid value \" + providerStr + \" for the detail \" + detail);\n+                }\n+                if (serviceProviderMap.get(Service.Lb) != null) {\n+                    for (Provider provider : serviceProviderMap.get(Service.Lb)) {\n+                        if (provider.getName().equalsIgnoreCase(providerStr)) {\n+                            lbProvider = provider;\n+                            break;\n+                        }\n+                    }\n+                } \n+                \n+                if (lbProvider == null) {\n+                    throw new InvalidParameterValueException(\"Invalid value \" + details.get(detail)\n+                            + \" for the detail \" + detail + \". The provider is not supported by the network offering\");\n+                }\n+                \n+                //2) validate if the provider supports the scheme\n+                Set<Provider> lbProviders = new HashSet<Provider>();\n+                lbProviders.add(lbProvider);\n+                if (detail == NetworkOffering.Detail.InternalLbProvider) {\n+                    _networkModel.checkCapabilityForProvider(lbProviders, Service.Lb, Capability.LbSchemes, Scheme.Internal.toString());\n+                } else if (detail == NetworkOffering.Detail.PublicLbProvider){\n+                    _networkModel.checkCapabilityForProvider(lbProviders, Service.Lb, Capability.LbSchemes, Scheme.Public.toString());\n+                }\n+            }\n+        }\n+    }\n+\n \n     @Override\n     public List<? extends NetworkOffering> searchForNetworkOfferings(ListNetworkOfferingsCmd cmd) {\n@@ -3994,6 +4096,7 @@ public NetworkOfferingVO createNetworkOffering(String name, String displayText,\n     public boolean isOfferingForVpc(NetworkOffering offering) {\n         boolean vpcProvider = _ntwkOffServiceMapDao.isProviderForNetworkOffering(offering.getId(),\n                 Provider.VPCVirtualRouter);\n+        boolean internalLb = offering.getInternalLb();\n         return vpcProvider;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "sha": "fdc0ffbabe1f576bc9e01eb6f796a9dac8535f4c",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/ExternalLoadBalancerDeviceManager.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/ExternalLoadBalancerDeviceManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/ExternalLoadBalancerDeviceManager.java",
                "patch": "@@ -23,7 +23,7 @@\n import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.host.Host;\n import com.cloud.network.dao.ExternalLoadBalancerDeviceVO;\n-import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.lb.LoadBalancingRule;\n import com.cloud.resource.ServerResource;\n import com.cloud.utils.component.Manager;\n \n@@ -89,7 +89,7 @@ public ExternalLoadBalancerDeviceVO addExternalLoadBalancer(long physicalNetwork\n      * @return true if successfully applied rules\n      * @throws ResourceUnavailableException\n      */\n-    public boolean applyLoadBalancerRules(Network network, List<? extends FirewallRule> rules) throws ResourceUnavailableException;\n+    public boolean applyLoadBalancerRules(Network network, List<LoadBalancingRule> rules) throws ResourceUnavailableException;\n \n     /**\n      * implements or shutdowns guest network on the load balancer device assigned to the guest network\n@@ -102,6 +102,6 @@ public ExternalLoadBalancerDeviceVO addExternalLoadBalancer(long physicalNetwork\n     public boolean manageGuestNetworkWithExternalLoadBalancer(boolean add, Network guestConfig) throws ResourceUnavailableException,\n             InsufficientCapacityException;\n \n-    public List<LoadBalancerTO> getLBHealthChecks(Network network, List<? extends FirewallRule> rules)\n+    public List<LoadBalancerTO> getLBHealthChecks(Network network, List<LoadBalancingRule> rules)\n             throws ResourceUnavailableException;\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/ExternalLoadBalancerDeviceManager.java",
                "sha": "cb00614b086de7da7729fce989dff9f99c93892b",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 23,
                "filename": "server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java",
                "patch": "@@ -829,19 +829,11 @@ private MappingNic getLoadBalancingIpNic(DataCenterVO zone, Network network, lon\n     }\n \n     @Override\n-    public boolean applyLoadBalancerRules(Network network, List<? extends FirewallRule> rules) throws ResourceUnavailableException {\n+    public boolean applyLoadBalancerRules(Network network, List<LoadBalancingRule> loadBalancingRules) throws ResourceUnavailableException {\n         // Find the external load balancer in this zone\n         long zoneId = network.getDataCenterId();\n         DataCenterVO zone = _dcDao.findById(zoneId);\n \n-        List<LoadBalancingRule> loadBalancingRules = new ArrayList<LoadBalancingRule>();\n-\n-        for (FirewallRule rule : rules) {\n-            if (rule.getPurpose().equals(Purpose.LoadBalancing)) {\n-                loadBalancingRules.add((LoadBalancingRule) rule);\n-            }\n-        }\n-\n         if (loadBalancingRules == null || loadBalancingRules.isEmpty()) {\n             return true;\n         }\n@@ -870,12 +862,13 @@ public boolean applyLoadBalancerRules(Network network, List<? extends FirewallRu\n             String protocol = rule.getProtocol();\n             String algorithm = rule.getAlgorithm();\n             String uuid = rule.getUuid();\n-            String srcIp = _networkModel.getIp(rule.getSourceIpAddressId()).getAddress().addr();\n+            String srcIp = rule.getSourceIp().addr();\n             int srcPort = rule.getSourcePortStart();\n             List<LbDestination> destinations = rule.getDestinations();\n \n             if (externalLoadBalancerIsInline) {\n-                MappingNic nic = getLoadBalancingIpNic(zone, network, rule.getSourceIpAddressId(), revoked, null);\n+                long ipId = _networkModel.getPublicIpAddress(rule.getSourceIp().addr(), network.getDataCenterId()).getId();\n+                MappingNic nic = getLoadBalancingIpNic(zone, network, ipId, revoked, null);\n                 mappingStates.add(nic.getState());\n                 NicVO loadBalancingIpNic = nic.getNic();\n                 if (loadBalancingIpNic == null) {\n@@ -927,7 +920,8 @@ public boolean applyLoadBalancerRules(Network network, List<? extends FirewallRu\n                     } else {\n                         continue;\n                     }\n-                    getLoadBalancingIpNic(zone, network, rule.getSourceIpAddressId(), revoke, existedGuestIp);\n+                    long sourceIpId = _networkModel.getPublicIpAddress(rule.getSourceIp().addr(), network.getDataCenterId()).getId();\n+                    getLoadBalancingIpNic(zone, network, sourceIpId, revoke, existedGuestIp);\n                 }\n             }\n             throw new ResourceUnavailableException(ex.getMessage(), DataCenter.class, network.getDataCenterId());\n@@ -1113,22 +1107,14 @@ protected IpDeployer getIpDeployerForInlineMode(Network network) {\n     }\n \n     @Override\n-    public List<LoadBalancerTO> getLBHealthChecks(Network network, List<? extends FirewallRule> rules)\n+    public List<LoadBalancerTO> getLBHealthChecks(Network network, List<LoadBalancingRule> loadBalancingRules)\n             throws ResourceUnavailableException {\n \n         // Find the external load balancer in this zone\n         long zoneId = network.getDataCenterId();\n         DataCenterVO zone = _dcDao.findById(zoneId);\n         HealthCheckLBConfigAnswer answer = null;\n \n-        List<LoadBalancingRule> loadBalancingRules = new ArrayList<LoadBalancingRule>();\n-\n-        for (FirewallRule rule : rules) {\n-            if (rule.getPurpose().equals(Purpose.LoadBalancing)) {\n-                loadBalancingRules.add((LoadBalancingRule) rule);\n-            }\n-        }\n-\n         if (loadBalancingRules == null || loadBalancingRules.isEmpty()) {\n             return null;\n         }\n@@ -1158,12 +1144,13 @@ protected IpDeployer getIpDeployerForInlineMode(Network network) {\n             String protocol = rule.getProtocol();\n             String algorithm = rule.getAlgorithm();\n             String uuid = rule.getUuid();\n-            String srcIp = _networkModel.getIp(rule.getSourceIpAddressId()).getAddress().addr();\n+            String srcIp = rule.getSourceIp().addr();\n             int srcPort = rule.getSourcePortStart();\n             List<LbDestination> destinations = rule.getDestinations();\n \n             if (externalLoadBalancerIsInline) {\n-                MappingNic nic = getLoadBalancingIpNic(zone, network, rule.getSourceIpAddressId(), revoked, null);\n+                long sourceIpId = _networkModel.getPublicIpAddress(rule.getSourceIp().addr(), network.getDataCenterId()).getId();\n+                MappingNic nic = getLoadBalancingIpNic(zone, network, sourceIpId, revoked, null);\n                 mappingStates.add(nic.getState());\n                 NicVO loadBalancingIpNic = nic.getNic();\n                 if (loadBalancingIpNic == null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java",
                "sha": "f93bf7ae9b59ea6f914a88ed937e1f67ef3be050",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/ExternalLoadBalancerUsageManagerImpl.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/ExternalLoadBalancerUsageManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 15,
                "filename": "server/src/com/cloud/network/ExternalLoadBalancerUsageManagerImpl.java",
                "patch": "@@ -16,6 +16,22 @@\n // under the License.\n package com.cloud.network;\n \n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n import com.cloud.agent.AgentManager;\n import com.cloud.agent.api.ExternalNetworkResourceUsageAnswer;\n import com.cloud.agent.api.ExternalNetworkResourceUsageCommand;\n@@ -48,6 +64,7 @@\n import com.cloud.network.dao.NetworkVO;\n import com.cloud.network.dao.PhysicalNetworkDao;\n import com.cloud.network.dao.PhysicalNetworkServiceProviderDao;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.PortForwardingRuleVO;\n import com.cloud.network.rules.dao.PortForwardingRulesDao;\n import com.cloud.offerings.dao.NetworkOfferingDao;\n@@ -68,20 +85,6 @@\n import com.cloud.vm.NicVO;\n import com.cloud.vm.dao.DomainRouterDao;\n import com.cloud.vm.dao.NicDao;\n-import org.apache.log4j.Logger;\n-import org.springframework.stereotype.Component;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-import javax.naming.ConfigurationException;\n-import java.net.URI;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.ScheduledExecutorService;\n-import java.util.concurrent.TimeUnit;\n \n @Component\n @Local(value = { ExternalLoadBalancerUsageManager.class })\n@@ -647,9 +650,10 @@ private boolean manageStatsEntries(boolean create, long accountId, long zoneId,\n                 // If an external load balancer is added, manage one entry for each load balancing rule in this network\n                 if (externalLoadBalancer != null && lbAnswer != null) {\n                     boolean inline = _networkMgr.isNetworkInlineMode(network);\n-                    List<LoadBalancerVO> loadBalancers = _loadBalancerDao.listByNetworkId(network.getId());\n+                    List<LoadBalancerVO> loadBalancers = _loadBalancerDao.listByNetworkIdAndScheme(network.getId(), Scheme.Public);\n                     for (LoadBalancerVO loadBalancer : loadBalancers) {\n                         String publicIp = _networkMgr.getIp(loadBalancer.getSourceIpAddressId()).getAddress().addr();\n+                        \n                         if (!createOrUpdateStatsEntry(create, accountId, zoneId, network.getId(), publicIp, externalLoadBalancer.getId(), lbAnswer, inline)) {\n                             throw new ExecutionException(networkErrorMsg + \", load balancing rule public IP = \" + publicIp);\n                         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/ExternalLoadBalancerUsageManagerImpl.java",
                "sha": "2c8031c64f0f7cf38db45339741c0259eb118c8a",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkManager.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/NetworkManager.java",
                "patch": "@@ -43,6 +43,7 @@\n import com.cloud.network.element.UserDataServiceProvider;\n import com.cloud.network.guru.NetworkGuru;\n import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offerings.NetworkOfferingVO;\n@@ -333,7 +334,7 @@ IpAddress allocateIp(Account ipOwner, boolean isSystem, Account caller, long cal\n \n     int getRuleCountForIp(Long addressId, FirewallRule.Purpose purpose, FirewallRule.State state);\n \n-    LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network);\n+    LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network, Scheme lbScheme);\n \n \n     boolean isSecondaryIpSetForNic(long nicId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkManager.java",
                "sha": "34a092a465a9e5e9bba784cb49399913b1a7f0a2",
                "status": "modified"
            },
            {
                "additions": 78,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkManagerImpl.java",
                "changes": 103,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 25,
                "filename": "server/src/com/cloud/network/NetworkManagerImpl.java",
                "patch": "@@ -62,6 +62,13 @@\n import com.cloud.network.lb.LoadBalancingRulesManager;\n import com.cloud.network.rules.*;\n import com.cloud.network.rules.FirewallRule.Purpose;\n+import com.cloud.network.rules.FirewallRuleVO;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.network.rules.PortForwardingRuleVO;\n+import com.cloud.network.rules.RulesManager;\n+import com.cloud.network.rules.StaticNat;\n+import com.cloud.network.rules.StaticNatRule;\n+import com.cloud.network.rules.StaticNatRuleImpl;\n import com.cloud.network.rules.dao.PortForwardingRulesDao;\n import com.cloud.network.vpc.NetworkACLManager;\n import com.cloud.network.vpc.VpcManager;\n@@ -72,6 +79,7 @@\n import com.cloud.offerings.NetworkOfferingServiceMapVO;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.offerings.dao.NetworkOfferingDao;\n+import com.cloud.offerings.dao.NetworkOfferingDetailsDao;\n import com.cloud.offerings.dao.NetworkOfferingServiceMapDao;\n import com.cloud.org.Grouping;\n import com.cloud.user.*;\n@@ -156,6 +164,8 @@\n     @Inject\n     PodVlanMapDao _podVlanMapDao;\n     @Inject\n+    NetworkOfferingDetailsDao _ntwkOffDetailsDao;\n+    @Inject\n     ConfigurationServer _configServer;\n     @Inject\n     AccountGuestVlanMapDao _accountGuestVlanMapDao;\n@@ -948,7 +958,7 @@ public boolean configure(final String name, final Map<String, Object> params) th\n                     _configMgr.createNetworkOffering(NetworkOffering.QuickCloudNoServices,\n                             \"Offering for QuickCloud with no services\", TrafficType.Guest, null, true,\n                             Availability.Optional, null, new HashMap<Network.Service, Set<Network.Provider>>(), true,\n-                            Network.GuestType.Shared, false, null, true, null, true, false);\n+                            Network.GuestType.Shared, false, null, true, null, true, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n@@ -957,14 +967,14 @@ public boolean configure(final String name, final Map<String, Object> params) th\n                     _configMgr.createNetworkOffering(NetworkOffering.DefaultSharedNetworkOfferingWithSGService,\n                             \"Offering for Shared Security group enabled networks\", TrafficType.Guest, null, true,\n                             Availability.Optional, null, defaultSharedNetworkOfferingProviders, true,\n-                            Network.GuestType.Shared, false, null, true, null, true, false);\n+                            Network.GuestType.Shared, false, null, true, null, true, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n \n         if (_networkOfferingDao.findByUniqueName(NetworkOffering.DefaultSharedNetworkOffering) == null) {\n             offering = _configMgr.createNetworkOffering(NetworkOffering.DefaultSharedNetworkOffering, \"Offering for Shared networks\", TrafficType.Guest, null, true, Availability.Optional, null,\n-                    defaultSharedNetworkOfferingProviders, true, Network.GuestType.Shared, false, null, true, null, true, false);\n+                    defaultSharedNetworkOfferingProviders, true, Network.GuestType.Shared, false, null, true, null, true, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n@@ -987,7 +997,7 @@ public boolean configure(final String name, final Map<String, Object> params) th\n             offering = _configMgr.createNetworkOffering(NetworkOffering.DefaultIsolatedNetworkOfferingWithSourceNatService,\n                     \"Offering for Isolated networks with Source Nat service enabled\", TrafficType.Guest,\n                     null, false, Availability.Required, null, defaultINetworkOfferingProvidersForVpcNetwork,\n-                    true, Network.GuestType.Isolated, false, null, true, null, false, false);\n+                    true, Network.GuestType.Isolated, false, null, true, null, false, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n@@ -996,7 +1006,7 @@ public boolean configure(final String name, final Map<String, Object> params) th\n             offering = _configMgr.createNetworkOffering(NetworkOffering.DefaultIsolatedNetworkOfferingForVpcNetworks,\n                     \"Offering for Isolated VPC networks with Source Nat service enabled\", TrafficType.Guest,\n                     null, false, Availability.Optional, null, defaultVPCOffProviders,\n-                    true, Network.GuestType.Isolated, false, null, false, null, false, false);\n+                    true, Network.GuestType.Isolated, false, null, false, null, false, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n@@ -1007,7 +1017,7 @@ public boolean configure(final String name, final Map<String, Object> params) th\n             offering = _configMgr.createNetworkOffering(NetworkOffering.DefaultIsolatedNetworkOfferingForVpcNetworksNoLB,\n                     \"Offering for Isolated VPC networks with Source Nat service enabled and LB service disabled\", TrafficType.Guest,\n                     null, false, Availability.Optional, null, defaultVPCOffProviders,\n-                    true, Network.GuestType.Isolated, false, null, false, null, false, false);\n+                    true, Network.GuestType.Isolated, false, null, false, null, false, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n@@ -1016,7 +1026,7 @@ public boolean configure(final String name, final Map<String, Object> params) th\n             offering = _configMgr.createNetworkOffering(NetworkOffering.DefaultIsolatedNetworkOffering,\n                     \"Offering for Isolated networks with no Source Nat service\", TrafficType.Guest, null, true,\n                     Availability.Optional, null, defaultIsolatedNetworkOfferingProviders, true, Network.GuestType.Isolated,\n-                    false, null, true, null, true, false);\n+                    false, null, true, null, true, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             _networkOfferingDao.update(offering.getId(), offering);\n         }\n@@ -1045,7 +1055,7 @@ public boolean configure(final String name, final Map<String, Object> params) th\n \n         if (_networkOfferingDao.findByUniqueName(NetworkOffering.DefaultSharedEIPandELBNetworkOffering) == null) {\n             offering = _configMgr.createNetworkOffering(NetworkOffering.DefaultSharedEIPandELBNetworkOffering, \"Offering for Shared networks with Elastic IP and Elastic LB capabilities\", TrafficType.Guest, null, true,\n-                    Availability.Optional, null, netscalerServiceProviders, true, Network.GuestType.Shared, false, null, true, serviceCapabilityMap, true, false);\n+                    Availability.Optional, null, netscalerServiceProviders, true, Network.GuestType.Shared, false, null, true, serviceCapabilityMap, true, false, null);\n             offering.setState(NetworkOffering.State.Enabled);\n             offering.setDedicatedLB(false);\n             _networkOfferingDao.update(offering.getId(), offering);\n@@ -2651,9 +2661,15 @@ protected boolean reprogramNetworkRules(long networkId, Account caller, NetworkV\n             success = false;\n         }\n \n-        // apply load balancer rules\n-        if (!_lbMgr.applyLoadBalancersForNetwork(networkId)) {\n-            s_logger.warn(\"Failed to reapply load balancer rules as a part of network id=\" + networkId + \" restart\");\n+        // apply public load balancer rules\n+        if (!_lbMgr.applyLoadBalancersForNetwork(networkId, Scheme.Public)) {\n+            s_logger.warn(\"Failed to reapply Public load balancer rules as a part of network id=\" + networkId + \" restart\");\n+            success = false;\n+        }\n+        \n+        // apply internal load balancer rules\n+        if (!_lbMgr.applyLoadBalancersForNetwork(networkId, Scheme.Internal)) {\n+            s_logger.warn(\"Failed to reapply internal load balancer rules as a part of network id=\" + networkId + \" restart\");\n             success = false;\n         }\n \n@@ -3234,12 +3250,22 @@ private boolean shutdownNetworkResources(long networkId, Account caller, long ca\n         }\n \n         try {\n-            if (!_lbMgr.revokeLoadBalancersForNetwork(networkId)) {\n-                s_logger.warn(\"Failed to cleanup lb rules as a part of shutdownNetworkRules\");\n+            if (!_lbMgr.revokeLoadBalancersForNetwork(networkId, Scheme.Public)) {\n+                s_logger.warn(\"Failed to cleanup public lb rules as a part of shutdownNetworkRules\");\n+                success = false;\n+            }\n+        } catch (ResourceUnavailableException ex) {\n+            s_logger.warn(\"Failed to cleanup public lb rules as a part of shutdownNetworkRules due to \", ex);\n+            success = false;\n+        }\n+        \n+        try {\n+            if (!_lbMgr.revokeLoadBalancersForNetwork(networkId, Scheme.Internal)) {\n+                s_logger.warn(\"Failed to cleanup internal lb rules as a part of shutdownNetworkRules\");\n                 success = false;\n             }\n         } catch (ResourceUnavailableException ex) {\n-            s_logger.warn(\"Failed to cleanup lb rules as a part of shutdownNetworkRules due to \", ex);\n+            s_logger.warn(\"Failed to cleanup public lb rules as a part of shutdownNetworkRules due to \", ex);\n             success = false;\n         }\n \n@@ -3645,7 +3671,7 @@ protected NicProfile getNicProfileForVm(Network network, NicProfile requested, V\n                 }\n             }\n         } else {\n-            NicVO nicVO = _nicDao.findByInstanceIdAndNetworkId(network.getId(), vm.getId());\n+            NicVO nicVO = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n             if (nicVO != null) {\n                 nic = _networkModel.getNicProfile(vm, network.getId(), null);\n             }\n@@ -3747,35 +3773,62 @@ private void setStateMachine() {\n         return null;\n     }\n \n-    protected NetworkElement getElementForServiceInNetwork(Network network, Service service) {\n+    protected List<NetworkElement> getElementForServiceInNetwork(Network network, Service service) {\n+        List<NetworkElement> elements = new ArrayList<NetworkElement>();\n         List<Provider> providers = getProvidersForServiceInNetwork(network, service);\n         //Only support one provider now\n         if (providers == null)  {\n             s_logger.error(\"Cannot find \" + service.getName() + \" provider for network \" + network.getId());\n             return null;\n         }\n-        if (providers.size() != 1) {\n+        if (providers.size() != 1 && service != Service.Lb) {\n+            //support more than one LB providers only\n             s_logger.error(\"Found \" + providers.size() + \" \" + service.getName() + \" providers for network!\" + network.getId());\n             return null;\n+        } \n+        \n+        for (Provider provider : providers) {\n+            NetworkElement element = _networkModel.getElementImplementingProvider(provider.getName());\n+            s_logger.info(\"Let \" + element.getName() + \" handle \" + service.getName() + \" in network \" + network.getId());\n+            elements.add(element);\n         }\n-        NetworkElement element = _networkModel.getElementImplementingProvider(providers.get(0).getName());\n-        s_logger.info(\"Let \" + element.getName() + \" handle \" + service.getName() + \" in network \" + network.getId());\n-        return element;\n+        return elements;\n     }\n     \n     @Override\n     public StaticNatServiceProvider getStaticNatProviderForNetwork(Network network) {\n-        NetworkElement element = getElementForServiceInNetwork(network, Service.StaticNat);\n+        //only one provider per Static nat service is supoprted\n+        NetworkElement element = getElementForServiceInNetwork(network, Service.StaticNat).get(0);\n         assert element instanceof StaticNatServiceProvider;\n         return (StaticNatServiceProvider)element;\n     }\n \n     @Override\n-    public LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network) {\n-        NetworkElement element = getElementForServiceInNetwork(network, Service.Lb);\n-        assert element instanceof LoadBalancingServiceProvider; \n-        return (LoadBalancingServiceProvider)element;\n+    public LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network, Scheme lbScheme) {\n+        List<NetworkElement> lbElements = getElementForServiceInNetwork(network, Service.Lb);\n+        NetworkElement lbElement = null;\n+        if (lbElements.size() > 1) {\n+            String providerName = null;\n+            //get network offering details\n+            NetworkOffering off = _configMgr.getNetworkOffering(network.getNetworkOfferingId());\n+            if (lbScheme == Scheme.Public) {\n+                providerName = _ntwkOffDetailsDao.getDetail(off.getId(), NetworkOffering.Detail.PublicLbProvider);\n+            } else {\n+                providerName = _ntwkOffDetailsDao.getDetail(off.getId(), NetworkOffering.Detail.InternalLbProvider);\n+            }\n+            if (providerName == null) {\n+                throw new InvalidParameterValueException(\"Can't find Lb provider supporting scheme \" + lbScheme.toString() + \" in network \" + network);\n+            }\n+            lbElement =  _networkModel.getElementImplementingProvider(providerName);\n+        } else if (lbElements.size() == 1){\n+            lbElement = lbElements.get(0);\n+        }\n+                \n+        assert lbElement != null;\n+        assert lbElement instanceof LoadBalancingServiceProvider; \n+        return (LoadBalancingServiceProvider)lbElement;        \n     }\n+    \n     @Override\n     public boolean isNetworkInlineMode(Network network) {\n         NetworkOfferingVO offering = _networkOfferingDao.findById(network.getNetworkOfferingId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkManagerImpl.java",
                "sha": "c91243095dac924fddcb7004bf3e8c18822c52d6",
                "status": "modified"
            },
            {
                "additions": 44,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkModelImpl.java",
                "changes": 57,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkModelImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 13,
                "filename": "server/src/com/cloud/network/NetworkModelImpl.java",
                "patch": "@@ -32,6 +32,7 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n@@ -52,13 +53,11 @@\n import com.cloud.exception.PermissionDeniedException;\n import com.cloud.exception.UnsupportedServiceException;\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n-import com.cloud.server.ConfigurationServer;\n import com.cloud.network.IpAddress.State;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.GuestType;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n-import com.cloud.network.Networks.IsolationType;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.network.addr.PublicIp;\n import com.cloud.network.dao.FirewallRulesDao;\n@@ -86,11 +85,14 @@\n import com.cloud.network.rules.dao.PortForwardingRulesDao;\n import com.cloud.network.vpc.dao.PrivateIpDao;\n import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.offerings.NetworkOfferingServiceMapVO;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.offerings.dao.NetworkOfferingDao;\n+import com.cloud.offerings.dao.NetworkOfferingDetailsDao;\n import com.cloud.offerings.dao.NetworkOfferingServiceMapDao;\n import com.cloud.projects.dao.ProjectAccountDao;\n+import com.cloud.server.ConfigurationServer;\n import com.cloud.user.Account;\n import com.cloud.user.AccountVO;\n import com.cloud.user.DomainManager;\n@@ -183,9 +185,13 @@ public void setNetworkElements(List<NetworkElement> _networkElements) {\n     @Inject\n     UserIpv6AddressDao _ipv6Dao;\n     @Inject\n-    NicSecondaryIpDao _nicSecondaryIpDao;;\n+    NicSecondaryIpDao _nicSecondaryIpDao;\n+    @Inject\n+    ApplicationLoadBalancerRuleDao _appLbRuleDao;\n     @Inject\n     private ProjectAccountDao _projectAccountDao;\n+    @Inject\n+    NetworkOfferingDetailsDao _ntwkOffDetailsDao;\n \n     private final HashMap<String, NetworkOfferingVO> _systemNetworks = new HashMap<String, NetworkOfferingVO>(5);\n     static Long _privateOfferingId = null;\n@@ -604,7 +610,6 @@ public boolean isIP6AddressAvailableInVlan(long vlanId) {\n             NetworkElement element = getElementImplementingProvider(instance.getProvider());\n             if (element != null) {\n                 Map<Service, Map<Capability, String>> elementCapabilities = element.getCapabilities();\n-                ;\n                 if (elementCapabilities != null) {\n                     networkCapabilities.put(service, elementCapabilities.get(service));\n                 }\n@@ -917,7 +922,7 @@ public Integer getNetworkRate(long networkId, Long vmId) {\n         boolean isUserVmsDefaultNetwork = false;\n         boolean isDomRGuestOrPublicNetwork = false;\n         if (vm != null) {\n-            Nic nic = _nicDao.findByInstanceIdAndNetworkId(networkId, vmId);\n+            Nic nic = _nicDao.findByNtwkIdAndInstanceId(networkId, vmId);\n             if (vm.getType() == Type.User && nic != null && nic.isDefaultNic()) {\n                 isUserVmsDefaultNetwork = true;\n             } else if (vm.getType() == Type.DomainRouter && ntwkOff != null && (ntwkOff.getTrafficType() == TrafficType.Public || ntwkOff.getTrafficType() == TrafficType.Guest)) {\n@@ -1465,10 +1470,8 @@ public void checkCapabilityForProvider(Set<Provider> providers, Service service,\n                     throw new UnsupportedServiceException(\"Service \" + service.getName() + \" doesn't have capability \" + cap.getName() + \" for element=\" + element.getName() + \" implementing Provider=\"\n                             + provider.getName());\n                 }\n-    \n-                capValue = capValue.toLowerCase();\n-    \n-                if (!value.contains(capValue)) {\n+        \n+                if (!value.toLowerCase().contains(capValue.toLowerCase())) {\n                     throw new UnsupportedServiceException(\"Service \" + service.getName() + \" doesn't support value \" + capValue + \" for capability \" + cap.getName() + \" for element=\" + element.getName()\n                             + \" implementing Provider=\" + provider.getName());\n                 }\n@@ -1664,9 +1667,7 @@ public boolean isNetworkAvailableInDomain(long networkId, long domainId) {\n     @Override\n     public Set<Long> getAvailableIps(Network network, String requestedIp) {\n         String[] cidr = network.getCidr().split(\"/\");\n-        List<String> ips = _nicDao.listIpAddressInNetwork(network.getId());\n-        List<String> secondaryIps = _nicSecondaryIpDao.listSecondaryIpAddressInNetwork(network.getId());\n-        ips.addAll(secondaryIps);\n+        List<String> ips = getUsedIpsInNetwork(network);\n         Set<Long> usedIps = new TreeSet<Long>(); \n \n         for (String ip : ips) {\n@@ -1677,6 +1678,7 @@ public boolean isNetworkAvailableInDomain(long networkId, long domainId) {\n \n             usedIps.add(NetUtils.ip2Long(ip));\n         }\n+\n         Set<Long> allPossibleIps = NetUtils.getAllIpsFromCidr(cidr[0], Integer.parseInt(cidr[1]), usedIps);\n \n         String gateway = network.getGateway();\n@@ -1685,6 +1687,19 @@ public boolean isNetworkAvailableInDomain(long networkId, long domainId) {\n \n         return allPossibleIps;\n     }\n+    \n+    @Override\n+    public List<String> getUsedIpsInNetwork(Network network) {\n+        //Get all ips used by vms nics\n+        List<String> ips = _nicDao.listIpAddressInNetwork(network.getId());\n+        //Get all secondary ips for nics\n+        List<String> secondaryIps = _nicSecondaryIpDao.listSecondaryIpAddressInNetwork(network.getId());\n+        ips.addAll(secondaryIps);\n+        //Get ips used by load balancers\n+        List<String> lbIps = _appLbRuleDao.listLbIpsBySourceIpNetworkId(network.getId());\n+        ips.addAll(lbIps);\n+        return ips;\n+    }\n \n     @Override\n     public String getDomainNetworkDomain(long domainId, long zoneId) {\n@@ -1792,7 +1807,7 @@ public NicProfile getNicProfile(VirtualMachine vm, long networkId, String broadc\n         if (broadcastUri != null) {\n             nic = _nicDao.findByNetworkIdInstanceIdAndBroadcastUri(networkId, vm.getId(), broadcastUri);\n         } else {\n-           nic =  _nicDao.findByInstanceIdAndNetworkId(networkId, vm.getId());\n+           nic =  _nicDao.findByNtwkIdAndInstanceId(networkId, vm.getId());\n         }\n         if (nic == null) {\n            return null;\n@@ -2051,6 +2066,22 @@ public NicVO getPlaceholderNicForRouter(Network network, Long podId) {\n         return null;\n     }\n     \n+\n+    @Override\n+    public IpAddress getPublicIpAddress(String ipAddress, long zoneId) {\n+        List<? extends Network> networks = _networksDao.listByZoneAndTrafficType(zoneId, TrafficType.Public);\n+        if (networks.isEmpty() || networks.size() > 1) {\n+            throw new CloudRuntimeException(\"Can't find public network in the zone specified\");\n+        }\n+        \n+        return _ipAddressDao.findByIpAndSourceNetworkId(networks.get(0).getId(), ipAddress);\n+    }\n+    \n+    @Override\n+    public Map<Detail, String> getNtwkOffDetails(long offId) {\n+        return _ntwkOffDetailsDao.getNtwkOffDetails(offId);\n+    }\n+\n     \n     @Override\n     public Networks.IsolationType[] listNetworkIsolationMethods() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkModelImpl.java",
                "sha": "135fd2905358e72070af5e7117ea19ac68efb20f",
                "status": "modified"
            },
            {
                "additions": 64,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkServiceImpl.java",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkServiceImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 4,
                "filename": "server/src/com/cloud/network/NetworkServiceImpl.java",
                "patch": "@@ -47,6 +47,7 @@\n import org.apache.cloudstack.api.command.user.network.ListNetworksCmd;\n import org.apache.cloudstack.api.command.user.network.RestartNetworkCmd;\n import org.apache.cloudstack.api.command.user.vm.ListNicsCmd;\n+import org.apache.cloudstack.network.element.InternalLoadBalancerElementService;\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n@@ -170,6 +171,33 @@\n import com.cloud.vm.dao.NicSecondaryIpVO;\n import com.cloud.vm.dao.UserVmDao;\n import com.cloud.vm.dao.VMInstanceDao;\n+import com.cloud.vm.*;\n+import com.cloud.vm.dao.*;\n+import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n+import org.apache.cloudstack.acl.SecurityChecker;\n+import org.apache.cloudstack.acl.SecurityChecker.AccessType;\n+import org.apache.cloudstack.api.command.admin.network.DedicateGuestVlanRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListDedicatedGuestVlanRangesCmd;\n+import org.apache.cloudstack.api.command.admin.usage.ListTrafficTypeImplementorsCmd;\n+import org.apache.cloudstack.api.command.user.network.CreateNetworkCmd;\n+import org.apache.cloudstack.api.command.user.network.ListNetworksCmd;\n+import org.apache.cloudstack.api.command.user.network.RestartNetworkCmd;\n+import org.apache.cloudstack.api.command.user.vm.ListNicsCmd;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.security.InvalidParameterException;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.*;\n+\n \n /**\n  * NetworkServiceImpl implements NetworkService.\n@@ -267,6 +295,8 @@\n     HostDao _hostDao;\n     @Inject\n     HostPodDao _hostPodDao;\n+    @Inject \n+    InternalLoadBalancerElementService _internalLbElementSvc;\n     @Inject\n     DataCenterVnetDao _datacneter_vnet;\n     @Inject\n@@ -1187,6 +1217,10 @@ public Network createGuestNetwork(CreateNetworkCmd cmd) throws InsufficientCapac\n             if (_configMgr.isOfferingForVpc(ntwkOff)){\n                 throw new InvalidParameterValueException(\"Network offering can be used for VPC networks only\");\n             }\n+            if (ntwkOff.getInternalLb()) {\n+                throw new InvalidParameterValueException(\"Internal Lb can be enabled on vpc networks only\");\n+            }\n+\n             network = _networkMgr.createGuestNetwork(networkOfferingId, name, displayText, gateway, cidr, vlanId,\n             \t\tnetworkDomain, owner, sharedDomainId, pNtwk, zoneId, aclType, subdomainAccess, vpcId, ip6Gateway, ip6Cidr);\n         }\n@@ -2134,8 +2168,6 @@ public Network updateGuestNetwork(long networkId, String name, String displayTex\n     }\n \n \n-\n-\n     protected Set<Long> getAvailableIps(Network network, String requestedIp) {\n         String[] cidr = network.getCidr().split(\"/\");\n         List<String> ips = _nicDao.listIpAddressInNetwork(network.getId());\n@@ -2159,7 +2191,6 @@ public Network updateGuestNetwork(long networkId, String name, String displayTex\n     }\n \n \n-\n     protected boolean canUpgrade(Network network, long oldNetworkOfferingId, long newNetworkOfferingId) {\n         NetworkOffering oldNetworkOffering = _networkOfferingDao.findByIdIncludingRemoved(oldNetworkOfferingId);\n         NetworkOffering newNetworkOffering = _networkOfferingDao.findById(newNetworkOfferingId);\n@@ -2225,6 +2256,14 @@ protected boolean canUpgrade(Network network, long oldNetworkOfferingId, long ne\n                 return false;\n             }\n         }\n+        \n+        //can't update from internal LB to public LB\n+        if (areServicesSupportedByNetworkOffering(oldNetworkOfferingId, Service.Lb) && areServicesSupportedByNetworkOffering(newNetworkOfferingId, Service.Lb)) {\n+            if (oldNetworkOffering.getPublicLb() != newNetworkOffering.getPublicLb() || oldNetworkOffering.getInternalLb() != newNetworkOffering.getInternalLb()) {\n+                throw new InvalidParameterValueException(\"Original and new offerings support different types of LB - Internal vs Public,\" +\n+                \t\t\" can't upgrade\");\n+            }\n+        }\n \n         return canIpsUseOffering(publicIps, newNetworkOfferingId);\n     }\n@@ -2345,7 +2384,10 @@ public PhysicalNetwork createPhysicalNetwork(Long zoneId, String vnetRange, Stri\n \n             // add baremetal as the defualt network service provider\n             /* addDefaultBaremetalProvidersToPhysicalNetwork(pNetwork.getId()); */\n-\n+            \n+            //Add Internal Load Balancer element as a default network service provider\n+            addDefaultInternalLbProviderToPhysicalNetwork(pNetwork.getId());\n+            \n             txn.commit();\n             return pNetwork;\n         } catch (Exception ex) {\n@@ -3564,6 +3606,22 @@ protected PhysicalNetworkServiceProvider addDefaultVpcVirtualRouterToPhysicalNet\n \n         return nsp;\n     }\n+    \n+    \n+    protected PhysicalNetworkServiceProvider addDefaultInternalLbProviderToPhysicalNetwork(long physicalNetworkId) {\n+\n+        PhysicalNetworkServiceProvider nsp = addProviderToPhysicalNetwork(physicalNetworkId, \n+                Network.Provider.InternalLbVm.getName(), null, null);\n+ \n+        NetworkElement networkElement =  _networkModel.getElementImplementingProvider(Network.Provider.InternalLbVm.getName());\n+        if (networkElement == null) {\n+            throw new CloudRuntimeException(\"Unable to find the Network Element implementing the \" + Network.Provider.InternalLbVm.getName() + \" Provider\");\n+        }\n+        \n+        _internalLbElementSvc.addInternalLoadBalancerElement(nsp.getId());\n+\n+        return nsp;\n+    }\n \n     protected PhysicalNetworkServiceProvider addDefaultSecurityGroupProviderToPhysicalNetwork(long physicalNetworkId) {\n \n@@ -3572,6 +3630,8 @@ protected PhysicalNetworkServiceProvider addDefaultSecurityGroupProviderToPhysic\n \n         return nsp;\n     }\n+    \n+    \n \n     private PhysicalNetworkServiceProvider addDefaultBaremetalProvidersToPhysicalNetwork(long physicalNetworkId) {\n         PhysicalNetworkVO pvo = _physicalNetworkDao.findById(physicalNetworkId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/NetworkServiceImpl.java",
                "sha": "8815558256988edf89b0745a4386f239e86b56b7",
                "status": "modified"
            },
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 56,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 11,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -25,7 +25,6 @@\n import javax.ejb.Local;\n import javax.inject.Inject;\n \n-import com.cloud.utils.PropertiesUtil;\n import org.apache.cloudstack.api.command.admin.router.ConfigureVirtualRouterElementCmd;\n import org.apache.cloudstack.api.command.admin.router.CreateVirtualRouterElementCmd;\n import org.apache.cloudstack.api.command.admin.router.ListVirtualRouterElementsCmd;\n@@ -66,6 +65,7 @@\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.LbStickinessMethod;\n import com.cloud.network.rules.LbStickinessMethod.StickinessMethodType;\n+import com.cloud.network.rules.LoadBalancerContainer;\n import com.cloud.network.rules.PortForwardingRule;\n import com.cloud.network.rules.RulesManager;\n import com.cloud.network.rules.StaticNat;\n@@ -242,7 +242,7 @@ public boolean applyFWRules(Network config, List<? extends FirewallRule> rules)\n      * number like 12 2) time or tablesize like 12h, 34m, 45k, 54m , here\n      * last character is non-digit but from known characters .\n      */\n-    private boolean containsOnlyNumbers(String str, String endChar) {\n+    private static boolean containsOnlyNumbers(String str, String endChar) {\n         if (str == null)\n             return false;\n \n@@ -271,7 +271,7 @@ private boolean containsOnlyNumbers(String str, String endChar) {\n         return true;\n     }\n \n-    private boolean validateHAProxyLBRule(LoadBalancingRule rule) {\n+    public static boolean validateHAProxyLBRule(LoadBalancingRule rule) {\n         String timeEndChar = \"dhms\";\n \n         for (LbStickinessPolicy stickinessPolicy : rule.getStickinessPolicies()) {\n@@ -338,7 +338,9 @@ private boolean validateHAProxyLBRule(LoadBalancingRule rule) {\n \n     @Override\n     public boolean validateLBRule(Network network, LoadBalancingRule rule) {\n-        if (canHandle(network, Service.Lb)) {\n+        List<LoadBalancingRule> rules = new ArrayList<LoadBalancingRule>();\n+        rules.add(rule);\n+        if (canHandle(network, Service.Lb) && canHandleLbRules(rules)) {\n             List<DomainRouterVO> routers = _routerDao.listByNetworkAndRole(network.getId(), Role.VIRTUAL_ROUTER);\n             if (routers == null || routers.isEmpty()) {\n                 return true;\n@@ -351,15 +353,19 @@ public boolean validateLBRule(Network network, LoadBalancingRule rule) {\n     @Override\n     public boolean applyLBRules(Network network, List<LoadBalancingRule> rules) throws ResourceUnavailableException {\n         if (canHandle(network, Service.Lb)) {\n+            if (!canHandleLbRules(rules)) {\n+                return false;\n+            }\n+            \n             List<DomainRouterVO> routers = _routerDao.listByNetworkAndRole(network.getId(), Role.VIRTUAL_ROUTER);\n             if (routers == null || routers.isEmpty()) {\n                 s_logger.debug(\"Virtual router elemnt doesn't need to apply firewall rules on the backend; virtual \" +\n                 \t\t\"router doesn't exist in the network \" + network.getId());\n                 return true;\n             }\n \n-            if (!_routerMgr.applyFirewallRules(network, rules, routers)) {\n-                throw new CloudRuntimeException(\"Failed to apply firewall rules in network \" + network.getId());\n+            if (!_routerMgr.applyLoadBalancingRules(network, rules, routers)) {\n+                throw new CloudRuntimeException(\"Failed to apply load balancing rules in network \" + network.getId());\n             } else {\n                 return true;\n             }\n@@ -452,7 +458,7 @@ public Provider getProvider() {\n         return capabilities;\n     }\n \n-    private static String getHAProxyStickinessCapability() {\n+    public static String getHAProxyStickinessCapability() {\n         LbStickinessMethod method;\n         List<LbStickinessMethod> methodList = new ArrayList<LbStickinessMethod>(1);\n \n@@ -557,8 +563,8 @@ private static String getHAProxyStickinessCapability() {\n         lbCapabilities.put(Capability.SupportedLBAlgorithms, \"roundrobin,leastconn,source\");\n         lbCapabilities.put(Capability.SupportedLBIsolation, \"dedicated\");\n         lbCapabilities.put(Capability.SupportedProtocols, \"tcp, udp\");\n-\n         lbCapabilities.put(Capability.SupportedStickinessMethods, getHAProxyStickinessCapability());\n+        lbCapabilities.put(Capability.LbSchemes, LoadBalancerContainer.Scheme.Public.toString());\n \n         capabilities.put(Service.Lb, lbCapabilities);\n \n@@ -715,8 +721,8 @@ public boolean saveUserData(Network network, NicProfile nic, VirtualMachineProfi\n     @Override\n     public VirtualRouterProvider configure(ConfigureVirtualRouterElementCmd cmd) {\n         VirtualRouterProviderVO element = _vrProviderDao.findById(cmd.getId());\n-        if (element == null) {\n-            s_logger.debug(\"Can't find element with network service provider id \" + cmd.getId());\n+        if (element == null || !(element.getType() == VirtualRouterProviderType.VirtualRouter || element.getType() == VirtualRouterProviderType.VPCVirtualRouter)) {\n+            s_logger.debug(\"Can't find Virtual Router element with network service provider id \" + cmd.getId());\n             return null;\n         }\n \n@@ -728,6 +734,10 @@ public VirtualRouterProvider configure(ConfigureVirtualRouterElementCmd cmd) {\n \n     @Override\n     public VirtualRouterProvider addElement(Long nspId, VirtualRouterProviderType providerType) {\n+        if (!(providerType == VirtualRouterProviderType.VirtualRouter || providerType == VirtualRouterProviderType.VPCVirtualRouter)) {\n+            throw new InvalidParameterValueException(\"Element \" + this.getName() + \" supports only providerTypes: \" + \n+        VirtualRouterProviderType.VirtualRouter.toString() + \" and \" + VirtualRouterProviderType.VPCVirtualRouter);\n+        }\n         VirtualRouterProviderVO element = _vrProviderDao.findByNspIdAndType(nspId, providerType);\n         if (element != null) {\n             s_logger.debug(\"There is already a virtual router element with service provider id \" + nspId);\n@@ -801,7 +811,11 @@ public Long getIdByNspId(Long nspId) {\n \n     @Override\n     public VirtualRouterProvider getCreatedElement(long id) {\n-        return _vrProviderDao.findById(id);\n+        VirtualRouterProvider provider = _vrProviderDao.findById(id);\n+        if (!(provider.getType() == VirtualRouterProviderType.VirtualRouter || provider.getType() == VirtualRouterProviderType.VPCVirtualRouter)) {\n+            throw new InvalidParameterValueException(\"Unable to find provider by id\");\n+        }\n+        return provider;\n     }\n \n     @Override\n@@ -911,6 +925,10 @@ public boolean addPasswordAndUserdata(Network network, NicProfile nic, VirtualMa\n         if (enabled != null) {\n             sc.addAnd(sc.getEntity().isEnabled(), Op.EQ, enabled);\n         }\n+        \n+        //return only VR and VPC VR\n+        sc.addAnd(sc.getEntity().getType(), Op.IN, VirtualRouterProvider.VirtualRouterProviderType.VPCVirtualRouter, VirtualRouterProvider.VirtualRouterProviderType.VirtualRouter);\n+        \n         return sc.list();\n     }\n \n@@ -946,4 +964,20 @@ protected VirtualRouterProviderType getVirtualRouterProvider() {\n \t\t// TODO Auto-generated method stub\n \t\treturn null;\n \t}\n+\t\n+\tprivate boolean canHandleLbRules(List<LoadBalancingRule> rules) {\n+\t    Map<Capability, String> lbCaps = this.getCapabilities().get(Service.Lb);\n+\t    if (!lbCaps.isEmpty()) {\n+\t        String schemeCaps = lbCaps.get(Capability.LbSchemes);\n+\t        if (schemeCaps != null) {\n+\t            for (LoadBalancingRule rule : rules) {\n+\t                if (!schemeCaps.contains(rule.getScheme().toString())) {\n+\t                    s_logger.debug(\"Scheme \" + rules.get(0).getScheme() + \" is not supported by the provider \" + this.getName());\n+\t                    return false;\n+\t                }\n+\t            }\n+\t        }\n+\t    }\n+\t    return true;\n+\t}\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "28473cc7bc2bc43bbb0015d73d5fde409030e878",
                "status": "modified"
            },
            {
                "additions": 41,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/firewall/FirewallManagerImpl.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/firewall/FirewallManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 36,
                "filename": "server/src/com/cloud/network/firewall/FirewallManagerImpl.java",
                "patch": "@@ -27,17 +27,12 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+import org.apache.cloudstack.api.command.user.firewall.ListEgressFirewallRulesCmd;\n import com.cloud.network.dao.*;\n import org.apache.cloudstack.api.command.user.firewall.ListFirewallRulesCmd;\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n-import com.mysql.jdbc.ConnectionPropertiesImpl;\n-import org.apache.log4j.Logger;\n-\n-import org.apache.cloudstack.api.BaseListCmd;\n-import org.apache.cloudstack.api.command.user.firewall.ListEgressFirewallRulesCmd;\n-import org.apache.cloudstack.api.command.user.firewall.ListFirewallRulesCmd;\n import com.cloud.configuration.Config;\n import com.cloud.configuration.dao.ConfigurationDao;\n import com.cloud.domain.dao.DomainDao;\n@@ -53,18 +48,22 @@\n import com.cloud.network.Network;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Service;\n-import com.cloud.network.Networks.TrafficType;\n import com.cloud.network.NetworkManager;\n import com.cloud.network.NetworkModel;\n import com.cloud.network.NetworkRuleApplier;\n import com.cloud.network.element.FirewallServiceProvider;\n import com.cloud.network.element.NetworkACLServiceProvider;\n import com.cloud.network.element.PortForwardingServiceProvider;\n import com.cloud.network.element.StaticNatServiceProvider;\n-import com.cloud.network.rules.*;\n+import com.cloud.network.rules.FirewallManager;\n+import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRule.FirewallRuleType;\n import com.cloud.network.rules.FirewallRule.Purpose;\n import com.cloud.network.rules.FirewallRule.State;\n+import com.cloud.network.rules.FirewallRuleVO;\n+import com.cloud.network.rules.PortForwardingRule;\n+import com.cloud.network.rules.PortForwardingRuleVO;\n+import com.cloud.network.rules.StaticNat;\n import com.cloud.network.rules.dao.PortForwardingRulesDao;\n import com.cloud.network.vpc.VpcManager;\n import com.cloud.projects.Project.ListProjectResourcesCriteria;\n@@ -83,8 +82,8 @@\n import com.cloud.utils.db.JoinBuilder;\n import com.cloud.utils.db.SearchBuilder;\n import com.cloud.utils.db.SearchCriteria;\n-import com.cloud.utils.db.*;\n import com.cloud.utils.db.SearchCriteria.Op;\n+import com.cloud.utils.db.Transaction;\n import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.utils.net.NetUtils;\n import com.cloud.vm.UserVmVO;\n@@ -438,22 +437,28 @@ public void validateFirewallRule(Account caller, IPAddressVO ipAddress, Integer\n             return;\n         }\n \n-        if (ipAddress!=null){\n-        if (ipAddress.getAssociatedWithNetworkId() == null) {\n-                throw new InvalidParameterValueException(\"Unable to create firewall rule ; ip with specified id is not associated with any network\");\n-        } else {\n-            networkId = ipAddress.getAssociatedWithNetworkId();\n-        }\n-\n+        if (ipAddress != null){\n+            if (ipAddress.getAssociatedWithNetworkId() == null) {\n+                    throw new InvalidParameterValueException(\"Unable to create firewall rule ; ip with specified id is not associated with any network\");\n+            } else {\n+                networkId = ipAddress.getAssociatedWithNetworkId();\n+            }\n+    \n             // Validate ip address\n             _accountMgr.checkAccess(caller, null, true, ipAddress);\n-\n+        }\n+        \n+        //network id either has to be passed explicitly, or implicitly as a part of ipAddress object \n+        if (networkId == null) {\n+            throw new InvalidParameterValueException(\"Unable to retrieve network id to validate the rule\");\n+        }\n+    \n         Network network = _networkModel.getNetwork(networkId);\n-        assert network != null : \"Can't create port forwarding rule as network associated with public ip address is null?\";\n+        assert network != null : \"Can't create rule as network associated with public ip address is null?\";\n \n-            if (trafficType == FirewallRule.TrafficType.Egress) {\n-                _accountMgr.checkAccess(caller, null, true, network);\n-            }\n+        if (trafficType == FirewallRule.TrafficType.Egress) {\n+            _accountMgr.checkAccess(caller, null, true, network);\n+        }\n \n         // Verify that the network guru supports the protocol specified\n         Map<Network.Capability, String> caps = null;\n@@ -464,32 +469,32 @@ public void validateFirewallRule(Account caller, IPAddressVO ipAddress, Integer\n             }\n         } else if (purpose == Purpose.PortForwarding) {\n             caps = _networkModel.getNetworkServiceCapabilities(network.getId(), Service.PortForwarding);\n-            }else if (purpose == Purpose.Firewall){\n-                caps = _networkModel.getNetworkServiceCapabilities(network.getId(),Service.Firewall);\n+        } else if (purpose == Purpose.Firewall){\n+            caps = _networkModel.getNetworkServiceCapabilities(network.getId(),Service.Firewall);\n         }\n \n         if (caps != null) {\n-                String supportedProtocols;\n-                String supportedTrafficTypes = null;\n-                if (purpose == FirewallRule.Purpose.Firewall) {\n-                    supportedTrafficTypes = caps.get(Capability.SupportedTrafficDirection).toLowerCase();\n-                }\n+            String supportedProtocols;\n+            String supportedTrafficTypes = null;\n+            if (purpose == FirewallRule.Purpose.Firewall) {\n+                supportedTrafficTypes = caps.get(Capability.SupportedTrafficDirection).toLowerCase();\n+            }\n \n-                if (purpose == FirewallRule.Purpose.Firewall && trafficType == FirewallRule.TrafficType.Egress) {\n-                    supportedProtocols = caps.get(Capability.SupportedEgressProtocols).toLowerCase();\n-                } else {\n-                    supportedProtocols = caps.get(Capability.SupportedProtocols).toLowerCase();\n-                }\n+            if (purpose == FirewallRule.Purpose.Firewall && trafficType == FirewallRule.TrafficType.Egress) {\n+                supportedProtocols = caps.get(Capability.SupportedEgressProtocols).toLowerCase();\n+            } else {\n+                supportedProtocols = caps.get(Capability.SupportedProtocols).toLowerCase();\n+            }\n \n             if (!supportedProtocols.contains(proto.toLowerCase())) {\n                 throw new InvalidParameterValueException(\"Protocol \" + proto + \" is not supported in zone \" + network.getDataCenterId());\n             } else if (proto.equalsIgnoreCase(NetUtils.ICMP_PROTO) && purpose != Purpose.Firewall) {\n                 throw new InvalidParameterValueException(\"Protocol \" + proto + \" is currently supported only for rules with purpose \" + Purpose.Firewall);\n-                } else if (purpose == Purpose.Firewall && !supportedTrafficTypes.contains(trafficType.toString().toLowerCase())) {\n-                    throw new InvalidParameterValueException(\"Traffic Type \" + trafficType + \" is currently supported by Firewall in network \" + networkId);\n-                }\n+            } else if (purpose == Purpose.Firewall && !supportedTrafficTypes.contains(trafficType.toString().toLowerCase())) {\n+                throw new InvalidParameterValueException(\"Traffic Type \" + trafficType + \" is currently supported by Firewall in network \" + networkId);\n             }\n         }\n+        \n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/firewall/FirewallManagerImpl.java",
                "sha": "def4c1ed06f8037d72649432169754597595def8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/guru/GuestNetworkGuru.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/guru/GuestNetworkGuru.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 42,
                "filename": "server/src/com/cloud/network/guru/GuestNetworkGuru.java",
                "patch": "@@ -223,48 +223,7 @@ public void deallocate(Network network, NicProfile nic, VirtualMachineProfile<?\n             nic.deallocate();\n         }\n     }\n-\n-    public Ip4Address acquireIp4Address(Network network, Ip4Address requestedIp, String reservationId) {\n-        List<String> ips = _nicDao.listIpAddressInNetwork(network.getId());\n-        String[] cidr = network.getCidr().split(\"/\");\n-        SortedSet<Long> usedIps = new TreeSet<Long>();\n-\n-        if (requestedIp != null && requestedIp.equals(network.getGateway())) {\n-            s_logger.warn(\"Requested ip address \" + requestedIp + \" is used as a gateway address in network \" + network);\n-            return null;\n-        }\n-\n-        for (String ip : ips) {\n-            usedIps.add(NetUtils.ip2Long(ip));\n-        }\n-\n-        if (network.getGateway() != null) {\n-            usedIps.add(NetUtils.ip2Long(network.getGateway()));\n-        }\n-\n-        if (requestedIp != null) {\n-            if (usedIps.contains(requestedIp.toLong())) {\n-                s_logger.warn(\"Requested ip address \" + requestedIp + \" is already in used in \" + network);\n-                return null;\n-            }\n-            //check that requested ip has the same cidr\n-            boolean isSameCidr = NetUtils.sameSubnetCIDR(requestedIp.ip4(), cidr[0], Integer.parseInt(cidr[1]));\n-            if (!isSameCidr) {\n-                s_logger.warn(\"Requested ip address \" + requestedIp + \" doesn't belong to the network \" + network + \" cidr\");\n-                return null;\n-            }\n-\n-            return requestedIp;\n-        }\n-\n-        long ip = NetUtils.getRandomIpFromCidr(cidr[0], Integer.parseInt(cidr[1]), usedIps);\n-        if (ip == -1) {\n-            s_logger.warn(\"Unable to allocate any more ip address in \" + network);\n-            return null;\n-        }\n-\n-        return new Ip4Address(ip);\n-    }\n+    \n \n     public int getVlanOffset(long physicalNetworkId, int vlanTag) {\n         PhysicalNetworkVO pNetwork = _physicalNetworkDao.findById(physicalNetworkId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/guru/GuestNetworkGuru.java",
                "sha": "32ce744979bbf7baabc739951f20deb67128f169",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LBHealthCheckManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/lb/LBHealthCheckManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/lb/LBHealthCheckManager.java",
                "patch": "@@ -16,9 +16,11 @@\n // under the License.\n package com.cloud.network.lb;\n \n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+\n \n public interface LBHealthCheckManager {\n \n-    void updateLBHealthCheck();\n+    void updateLBHealthCheck(Scheme scheme);\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LBHealthCheckManager.java",
                "sha": "a9969eb7ce1be13b18e89bc7ff21e727703460d3",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LBHealthCheckManagerImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/lb/LBHealthCheckManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 4,
                "filename": "server/src/com/cloud/network/lb/LBHealthCheckManagerImpl.java",
                "patch": "@@ -19,7 +19,6 @@\n import static java.lang.String.format;\n \n import java.util.Map;\n-\n import java.util.concurrent.Executors;\n import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.TimeUnit;\n@@ -34,6 +33,7 @@\n import com.cloud.configuration.Config;\n import com.cloud.configuration.dao.ConfigurationDao;\n import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.component.Manager;\n import com.cloud.utils.component.ManagerBase;\n@@ -90,17 +90,18 @@ public String getName() {\n         @Override\n         public void run() {\n             try {\n-                updateLBHealthCheck();\n+                updateLBHealthCheck(Scheme.Public);\n+                updateLBHealthCheck(Scheme.Internal);\n             } catch (Exception e) {\n                 s_logger.error(\"Exception in LB HealthCheck Update Checker\", e);\n             }\n         }\n     }\n \n     @Override\n-    public void updateLBHealthCheck() {\n+    public void updateLBHealthCheck(Scheme scheme) {\n         try {\n-            _lbService.updateLBHealthChecks();\n+            _lbService.updateLBHealthChecks(scheme);\n         } catch (ResourceUnavailableException e) {\n             s_logger.debug(\"Error while updating the LB HealtCheck \", e);\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LBHealthCheckManagerImpl.java",
                "sha": "62b738bb4980afae4af7b59b5d4702214a871e4f",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LoadBalancingRulesManager.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/lb/LoadBalancingRulesManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 9,
                "filename": "server/src/com/cloud/network/lb/LoadBalancingRulesManager.java",
                "patch": "@@ -16,23 +16,24 @@\n // under the License.\n package com.cloud.network.lb;\n \n+import java.util.List;\n+\n import com.cloud.exception.NetworkRuleConflictException;\n import com.cloud.exception.ResourceUnavailableException;\n-import com.cloud.network.Network;\n import com.cloud.network.lb.LoadBalancingRule.LbDestination;\n import com.cloud.network.lb.LoadBalancingRule.LbHealthCheckPolicy;\n import com.cloud.network.lb.LoadBalancingRule.LbStickinessPolicy;\n-import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.LbStickinessMethod;\n import com.cloud.network.rules.LoadBalancer;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.user.Account;\n-import org.apache.cloudstack.api.command.user.loadbalancer.CreateLoadBalancerRuleCmd;\n-\n-import java.util.List;\n+import com.cloud.user.UserContext;\n \n public interface LoadBalancingRulesManager extends LoadBalancingRulesService {\n \n-    LoadBalancer createLoadBalancer(CreateLoadBalancerRuleCmd lb, boolean openFirewall) throws NetworkRuleConflictException;\n+    LoadBalancer createPublicLoadBalancer(String xId, String name, String description, \n+            int srcPort, int destPort, long sourceIpId, String protocol, String algorithm, boolean openFirewall, UserContext caller)\n+            throws NetworkRuleConflictException;\n \n     boolean removeAllLoadBalanacersForIp(long ipId, Account caller, long callerUserId);\n     boolean removeAllLoadBalanacersForNetwork(long networkId, Account caller, long callerUserId);\n@@ -47,9 +48,14 @@\n      * @return true if removal is successful\n      */\n     boolean removeVmFromLoadBalancers(long vmId);\n-    boolean applyRules(Network network, FirewallRule.Purpose purpose, List<? extends FirewallRule> rules) throws ResourceUnavailableException ;\n-    boolean applyLoadBalancersForNetwork(long networkId) throws ResourceUnavailableException;\n+    boolean applyLoadBalancersForNetwork(long networkId, Scheme scheme) throws ResourceUnavailableException;\n     String getLBCapability(long networkid, String capabilityName);\n     boolean configureLbAutoScaleVmGroup(long vmGroupid, String currentState) throws ResourceUnavailableException;\n-    boolean revokeLoadBalancersForNetwork(long networkId) throws ResourceUnavailableException;\n+    boolean revokeLoadBalancersForNetwork(long networkId, Scheme scheme) throws ResourceUnavailableException;\n+\n+    boolean validateLbRule(LoadBalancingRule lbRule);\n+\n+    void removeLBRule(LoadBalancer rule);\n+\n+    void isLbServiceSupportedInNetwork(long networkId, Scheme scheme);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LoadBalancingRulesManager.java",
                "sha": "a23d96f8aeac4c17ca43a6419ca8529adcf6aa7b",
                "status": "modified"
            },
            {
                "additions": 286,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java",
                "changes": 402,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 116,
                "filename": "server/src/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java",
                "patch": "@@ -16,6 +16,34 @@\n // under the License.\n package com.cloud.network.lb;\n \n+import java.security.InvalidParameterException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.command.user.loadbalancer.CreateLBHealthCheckPolicyCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.CreateLBStickinessPolicyCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLBHealthCheckPoliciesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLBStickinessPoliciesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLoadBalancerRuleInstancesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLoadBalancerRulesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.UpdateLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.response.ServiceResponse;\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n import com.cloud.agent.api.to.LoadBalancerTO;\n import com.cloud.configuration.Config;\n import com.cloud.configuration.ConfigurationManager;\n@@ -30,21 +58,70 @@\n import com.cloud.event.UsageEventUtils;\n import com.cloud.event.dao.EventDao;\n import com.cloud.event.dao.UsageEventDao;\n-import com.cloud.exception.*;\n-import com.cloud.network.*;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.NetworkRuleConflictException;\n+import com.cloud.exception.PermissionDeniedException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.ExternalLoadBalancerUsageManager;\n+import com.cloud.network.IpAddress;\n+import com.cloud.network.LBHealthCheckPolicyVO;\n+import com.cloud.network.Network;\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n-import com.cloud.network.as.*;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.addr.PublicIp;\n+import com.cloud.network.as.AutoScalePolicy;\n+import com.cloud.network.as.AutoScalePolicyConditionMapVO;\n+import com.cloud.network.as.AutoScaleVmGroup;\n+import com.cloud.network.as.AutoScaleVmGroupPolicyMapVO;\n+import com.cloud.network.as.AutoScaleVmGroupVO;\n+import com.cloud.network.as.AutoScaleVmProfile;\n import com.cloud.network.as.Condition;\n-import com.cloud.network.as.dao.*;\n-import com.cloud.network.dao.*;\n+import com.cloud.network.as.Counter;\n+import com.cloud.network.as.dao.AutoScalePolicyConditionMapDao;\n+import com.cloud.network.as.dao.AutoScalePolicyDao;\n+import com.cloud.network.as.dao.AutoScaleVmGroupDao;\n+import com.cloud.network.as.dao.AutoScaleVmGroupPolicyMapDao;\n+import com.cloud.network.as.dao.AutoScaleVmProfileDao;\n+import com.cloud.network.as.dao.ConditionDao;\n+import com.cloud.network.as.dao.CounterDao;\n+import com.cloud.network.dao.FirewallRulesCidrsDao;\n+import com.cloud.network.dao.FirewallRulesDao;\n+import com.cloud.network.dao.IPAddressDao;\n+import com.cloud.network.dao.IPAddressVO;\n+import com.cloud.network.dao.LBHealthCheckPolicyDao;\n+import com.cloud.network.dao.LBStickinessPolicyDao;\n+import com.cloud.network.dao.LBStickinessPolicyVO;\n+import com.cloud.network.dao.LoadBalancerDao;\n+import com.cloud.network.dao.LoadBalancerVMMapDao;\n+import com.cloud.network.dao.LoadBalancerVMMapVO;\n+import com.cloud.network.dao.LoadBalancerVO;\n+import com.cloud.network.dao.NetworkDao;\n+import com.cloud.network.dao.NetworkServiceMapDao;\n+import com.cloud.network.dao.NetworkVO;\n import com.cloud.network.element.LoadBalancingServiceProvider;\n-import com.cloud.network.lb.LoadBalancingRule.*;\n-import com.cloud.network.rules.*;\n+import com.cloud.network.lb.LoadBalancingRule.LbAutoScalePolicy;\n+import com.cloud.network.lb.LoadBalancingRule.LbAutoScaleVmGroup;\n+import com.cloud.network.lb.LoadBalancingRule.LbAutoScaleVmProfile;\n+import com.cloud.network.lb.LoadBalancingRule.LbCondition;\n+import com.cloud.network.lb.LoadBalancingRule.LbDestination;\n+import com.cloud.network.lb.LoadBalancingRule.LbHealthCheckPolicy;\n+import com.cloud.network.lb.LoadBalancingRule.LbStickinessPolicy;\n+import com.cloud.network.rules.FirewallManager;\n+import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRule.FirewallRuleType;\n import com.cloud.network.rules.FirewallRule.Purpose;\n+import com.cloud.network.rules.FirewallRuleVO;\n+import com.cloud.network.rules.HealthCheckPolicy;\n+import com.cloud.network.rules.LbStickinessMethod;\n import com.cloud.network.rules.LbStickinessMethod.LbStickinessMethodParam;\n+import com.cloud.network.rules.LoadBalancer;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.network.rules.RulesManager;\n+import com.cloud.network.rules.StickinessPolicy;\n import com.cloud.network.vpc.VpcManager;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.projects.Project.ListProjectResourcesCriteria;\n@@ -53,15 +130,25 @@\n import com.cloud.storage.dao.VMTemplateDao;\n import com.cloud.tags.ResourceTagVO;\n import com.cloud.tags.dao.ResourceTagDao;\n-import com.cloud.user.*;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.DomainService;\n+import com.cloud.user.User;\n+import com.cloud.user.UserContext;\n import com.cloud.user.dao.AccountDao;\n import com.cloud.user.dao.UserDao;\n import com.cloud.uservm.UserVm;\n import com.cloud.utils.Pair;\n import com.cloud.utils.Ternary;\n import com.cloud.utils.component.ManagerBase;\n-import com.cloud.utils.db.*;\n+import com.cloud.utils.db.DB;\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.JoinBuilder;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n import com.cloud.utils.net.NetUtils;\n import com.cloud.vm.Nic;\n import com.cloud.vm.UserVmVO;\n@@ -70,21 +157,11 @@\n import com.cloud.vm.dao.UserVmDao;\n import com.google.gson.Gson;\n import com.google.gson.reflect.TypeToken;\n-import org.apache.cloudstack.api.ApiConstants;\n-import org.apache.cloudstack.api.command.user.loadbalancer.*;\n-import org.apache.cloudstack.api.response.ServiceResponse;\n-import org.apache.log4j.Logger;\n-import org.springframework.stereotype.Component;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-import java.security.InvalidParameterException;\n-import java.util.*;\n \n @Component\n @Local(value = { LoadBalancingRulesManager.class, LoadBalancingRulesService.class })\n public class LoadBalancingRulesManagerImpl<Type> extends ManagerBase implements LoadBalancingRulesManager,\n-        LoadBalancingRulesService, NetworkRuleApplier {\n+        LoadBalancingRulesService {\n     private static final Logger s_logger = Logger.getLogger(LoadBalancingRulesManagerImpl.class);\n \n     @Inject\n@@ -166,6 +243,7 @@\n     UserDao _userDao;\n     @Inject\n     List<LoadBalancingServiceProvider> _lbProviders;\n+    @Inject ApplicationLoadBalancerRuleDao _appLbRuleDao;\n \n     // Will return a string. For LB Stickiness this will be a json, for\n     // autoscale this will be \",\" separated values\n@@ -261,8 +339,9 @@ private boolean applyAutoScaleConfig(LoadBalancerVO lb, AutoScaleVmGroupVO vmGro\n          * Regular config like destinations need not be packed for applying\n          * autoscale config as of today.\n          */\n-\tList<LbStickinessPolicy> policyList = getStickinessPolicies(lb.getId());\n-        LoadBalancingRule rule = new LoadBalancingRule(lb, null, policyList, null);\n+        List<LbStickinessPolicy> policyList = getStickinessPolicies(lb.getId());\n+        Ip sourceIp = getSourceIp(lb);\n+        LoadBalancingRule rule = new LoadBalancingRule(lb, null, policyList, null, sourceIp);\n         rule.setAutoScaleVmGroup(lbAutoScaleVmGroup);\n \n         if (!isRollBackAllowedForProvider(lb)) {\n@@ -273,14 +352,25 @@ private boolean applyAutoScaleConfig(LoadBalancerVO lb, AutoScaleVmGroupVO vmGro\n \n         List<LoadBalancingRule> rules = Arrays.asList(rule);\n \n-        if (!_networkMgr.applyRules(rules, FirewallRule.Purpose.LoadBalancing, this, false)) {\n+        if (!applyLbRules(rules, false)) {\n             s_logger.debug(\"LB rules' autoscale config are not completely applied\");\n             return false;\n         }\n \n         return true;\n     }\n \n+    private Ip getSourceIp(LoadBalancer lb) {\n+        Ip sourceIp = null;\n+        if (lb.getScheme() == Scheme.Public) {\n+            sourceIp = _networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();\n+        } else if (lb.getScheme() == Scheme.Internal) {\n+            ApplicationLoadBalancerRuleVO appLbRule = _appLbRuleDao.findById(lb.getId());\n+            sourceIp = appLbRule.getSourceIp();\n+        }\n+        return sourceIp;\n+    }\n+\n     @Override\n     @DB\n     public boolean configureLbAutoScaleVmGroup(long vmGroupid, String currentState) throws ResourceUnavailableException {\n@@ -454,9 +544,10 @@ public StickinessPolicy createLBStickinessPolicy(CreateLBStickinessPolicyCmd cmd\n                 cmd.getStickinessMethodName(), cmd.getparamList(), cmd.getDescription());\n         List<LbStickinessPolicy> policyList = new ArrayList<LbStickinessPolicy>();\n         policyList.add(new LbStickinessPolicy(cmd.getStickinessMethodName(), lbpolicy.getParams()));\n+        Ip sourceIp = getSourceIp(loadBalancer);\n         LoadBalancingRule lbRule = new LoadBalancingRule(loadBalancer, getExistingDestinations(lbpolicy.getId()),\n-                policyList, null);\n-        if (!validateRule(lbRule)) {\n+                policyList, null, sourceIp);\n+        if (!validateLbRule(lbRule)) {\n             throw new InvalidParameterValueException(\"Failed to create Stickiness policy: Validation Failed \"\n                     + cmd.getLbRuleId());\n         }\n@@ -539,7 +630,8 @@ public HealthCheckPolicy createLBHealthCheckPolicy(CreateLBHealthCheckPolicyCmd\n         return policy;\n     }\n \n-    private boolean validateRule(LoadBalancingRule lbRule) {\n+    @Override\n+    public boolean validateLbRule(LoadBalancingRule lbRule) {\n         Network network = _networkDao.findById(lbRule.getNetworkId());\n         Purpose purpose = lbRule.getPurpose();\n         if (purpose != Purpose.LoadBalancing) {\n@@ -748,7 +840,7 @@ public boolean deleteLBHealthCheckPolicy(long healthCheckPolicyId, boolean apply\n     // by CloudStack and update them in lbvmmap table\n     @DB\n     @Override\n-    public void updateLBHealthChecks() throws ResourceUnavailableException {\n+    public void updateLBHealthChecks(Scheme scheme) throws ResourceUnavailableException {\n         List<LoadBalancerVO> rules = _lbDao.listAll();\n         List<NetworkVO> networks = _networkDao.listAll();\n         List<LoadBalancerTO> stateRules = null;\n@@ -763,7 +855,7 @@ public void updateLBHealthChecks() throws ResourceUnavailableException {\n                  * \"HealthCheck Manager :: LB Provider in the Network has the Healthcheck policy capability :: \"\n                  * + provider.get(0).getName());\n                  */\n-                rules = _lbDao.listByNetworkId(network.getId());\n+                rules = _lbDao.listByNetworkIdAndScheme(network.getId(), scheme);\n                 if (rules != null && rules.size() > 0) {\n                     List<LoadBalancingRule> lbrules = new ArrayList<LoadBalancingRule>();\n                     for (LoadBalancerVO lb : rules) {\n@@ -772,7 +864,8 @@ public void updateLBHealthChecks() throws ResourceUnavailableException {\n                         // adding to lbrules list only if the LB rule\n                         // hashealtChecks\n                         if (hcPolicyList != null && hcPolicyList.size() > 0) {\n-                            LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, null, hcPolicyList);\n+                            Ip sourceIp = getSourceIp(lb);\n+                            LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, null, hcPolicyList, sourceIp);\n                             lbrules.add(loadBalancing);\n                         }\n                     }\n@@ -1168,31 +1261,21 @@ public boolean deleteLoadBalancerRule(long loadBalancerId, boolean apply, Accoun\n \n     @Override\n     @ActionEvent(eventType = EventTypes.EVENT_LOAD_BALANCER_CREATE, eventDescription = \"creating load balancer\")\n-    public LoadBalancer createLoadBalancerRule(CreateLoadBalancerRuleCmd lb, boolean openFirewall)\n+    public LoadBalancer createPublicLoadBalancerRule(String xId, String name, String description, \n+            int srcPortStart, int srcPortEnd, int defPortStart, int defPortEnd, Long ipAddrId, String protocol, String algorithm, long networkId, long lbOwnerId, boolean openFirewall)\n             throws NetworkRuleConflictException, InsufficientAddressCapacityException {\n-        Account lbOwner = _accountMgr.getAccount(lb.getEntityOwnerId());\n-\n-        int defPortStart = lb.getDefaultPortStart();\n-        int defPortEnd = lb.getDefaultPortEnd();\n-\n-        if (!NetUtils.isValidPort(defPortEnd)) {\n-            throw new InvalidParameterValueException(\"privatePort is an invalid value: \" + defPortEnd);\n-        }\n-        if (defPortStart > defPortEnd) {\n-            throw new InvalidParameterValueException(\"private port range is invalid: \" + defPortStart + \"-\"\n-                    + defPortEnd);\n-        }\n-        if ((lb.getAlgorithm() == null) || !NetUtils.isValidAlgorithm(lb.getAlgorithm())) {\n-            throw new InvalidParameterValueException(\"Invalid algorithm: \" + lb.getAlgorithm());\n+        Account lbOwner = _accountMgr.getAccount(lbOwnerId);\n+        \n+        if (srcPortStart != srcPortEnd) {\n+            throw new InvalidParameterValueException(\"Port ranges are not supported by the load balancer\");\n         }\n \n-        Long ipAddrId = lb.getSourceIpAddressId();\n         IPAddressVO ipVO = null;\n         if (ipAddrId != null) {\n             ipVO = _ipAddressDao.findById(ipAddrId);\n         }\n \n-        Network network = _networkModel.getNetwork(lb.getNetworkId());\n+        Network network = _networkModel.getNetwork(networkId);\n \n         // FIXME: breaking the dependency on ELB manager. This breaks\n         // functionality of ELB using virtual router\n@@ -1204,8 +1287,7 @@ public LoadBalancer createLoadBalancerRule(CreateLoadBalancerRuleCmd lb, boolean\n             IpAddress systemIp = null;\n             NetworkOffering off = _configMgr.getNetworkOffering(network.getNetworkOfferingId());\n             if (off.getElasticLb() && ipVO == null && network.getVpcId() == null) {\n-                systemIp = _networkMgr.assignSystemIp(lb.getNetworkId(), lbOwner, true, false);\n-                lb.setSourceIpAddressId(systemIp.getId());\n+                systemIp = _networkMgr.assignSystemIp(networkId, lbOwner, true, false);\n                 ipVO = _ipAddressDao.findById(systemIp.getId());\n             }\n \n@@ -1224,11 +1306,11 @@ public LoadBalancer createLoadBalancerRule(CreateLoadBalancerRuleCmd lb, boolean\n                             && ipVO.getVpcId().longValue() == network.getVpcId();\n                     if (assignToVpcNtwk) {\n                         // set networkId just for verification purposes\n-                        _networkModel.checkIpForService(ipVO, Service.Lb, lb.getNetworkId());\n+                        _networkModel.checkIpForService(ipVO, Service.Lb, networkId);\n \n-                        s_logger.debug(\"The ip is not associated with the VPC network id=\" + lb.getNetworkId()\n+                        s_logger.debug(\"The ip is not associated with the VPC network id=\" + networkId\n                                 + \" so assigning\");\n-                        ipVO = _networkMgr.associateIPToGuestNetwork(ipAddrId, lb.getNetworkId(), false);\n+                        ipVO = _networkMgr.associateIPToGuestNetwork(ipAddrId, networkId, false);\n                         performedIpAssoc = true;\n                     }\n                 } else {\n@@ -1240,10 +1322,7 @@ public LoadBalancer createLoadBalancerRule(CreateLoadBalancerRuleCmd lb, boolean\n                             + network);\n                 }\n \n-                if (lb.getSourceIpAddressId() == null) {\n-                    throw new CloudRuntimeException(\"No ip address is defined to assign the LB to\");\n-                }\n-                result = createLoadBalancer(lb, openFirewall);\n+                result = createPublicLoadBalancer(xId, name, description, srcPortStart, defPortStart, ipVO.getId(), protocol, algorithm, openFirewall, UserContext.current());\n             } catch (Exception ex) {\n                 s_logger.warn(\"Failed to create load balancer due to \", ex);\n                 if (ex instanceof NetworkRuleConflictException) {\n@@ -1258,27 +1337,31 @@ public LoadBalancer createLoadBalancerRule(CreateLoadBalancerRuleCmd lb, boolean\n                 // release ip address if ipassoc was perfored\n                 if (performedIpAssoc) {\n                     ipVO = _ipAddressDao.findById(ipVO.getId());\n-                    _vpcMgr.unassignIPFromVpcNetwork(ipVO.getId(), lb.getNetworkId());\n+                    _vpcMgr.unassignIPFromVpcNetwork(ipVO.getId(), networkId);\n                 }\n             }\n         }\n \n         if (result == null) {\n-            throw new CloudRuntimeException(\"Failed to create load balancer rule: \" + lb.getName());\n+            throw new CloudRuntimeException(\"Failed to create load balancer rule: \" + name);\n         }\n \n         return result;\n     }\n \n-    @Override\n     @DB\n-    public LoadBalancer createLoadBalancer(CreateLoadBalancerRuleCmd lb, boolean openFirewall)\n+    @Override\n+    public LoadBalancer createPublicLoadBalancer(String xId, String name, String description, \n+            int srcPort, int destPort, long sourceIpId, String protocol, String algorithm, boolean openFirewall, UserContext caller)\n             throws NetworkRuleConflictException {\n-        UserContext caller = UserContext.current();\n-        int srcPortStart = lb.getSourcePortStart();\n-        int defPortStart = lb.getDefaultPortStart();\n-        int srcPortEnd = lb.getSourcePortEnd();\n-        long sourceIpId = lb.getSourceIpAddressId();\n+        \n+        if (!NetUtils.isValidPort(destPort)) {\n+            throw new InvalidParameterValueException(\"privatePort is an invalid value: \" + destPort);\n+        }\n+       \n+        if ((algorithm == null) || !NetUtils.isValidAlgorithm(algorithm)) {\n+            throw new InvalidParameterValueException(\"Invalid algorithm: \" + algorithm);\n+        }\n \n         IPAddressVO ipAddr = _ipAddressDao.findById(sourceIpId);\n         // make sure ip address exists\n@@ -1293,6 +1376,9 @@ public LoadBalancer createLoadBalancer(CreateLoadBalancerRuleCmd lb, boolean ope\n             ex.addProxyObject(ipAddr, sourceIpId, \"sourceIpId\");\n             throw ex;\n         }\n+        \n+        _accountMgr.checkAccess(caller.getCaller(), null, true, ipAddr);\n+\n \n         Long networkId = ipAddr.getAssociatedWithNetworkId();\n         if (networkId == null) {\n@@ -1301,39 +1387,34 @@ public LoadBalancer createLoadBalancer(CreateLoadBalancerRuleCmd lb, boolean ope\n             ex.addProxyObject(ipAddr, sourceIpId, \"sourceIpId\");\n             throw ex;\n         }\n-\n-        _firewallMgr.validateFirewallRule(caller.getCaller(), ipAddr, srcPortStart, srcPortEnd, lb.getProtocol(),\n-                Purpose.LoadBalancing, FirewallRuleType.User, networkId, null);\n-        NetworkVO network = _networkDao.findById(networkId);\n-        _accountMgr.checkAccess(caller.getCaller(), null, true, ipAddr);\n-\n+        \n         // verify that lb service is supported by the network\n-        if (!_networkModel.areServicesSupportedInNetwork(network.getId(), Service.Lb)) {\n-            InvalidParameterValueException ex = new InvalidParameterValueException(\n-                    \"LB service is not supported in specified network id\");\n-            ex.addProxyObject(network, networkId, \"networkId\");\n-            throw ex;\n-        }\n+        isLbServiceSupportedInNetwork(networkId, Scheme.Public);\n \n-        Transaction txn = Transaction.currentTxn();\n-        txn.start();\n+        _firewallMgr.validateFirewallRule(caller.getCaller(), ipAddr, srcPort, srcPort, protocol,\n+                Purpose.LoadBalancing, FirewallRuleType.User, networkId, null);\n \n-        LoadBalancerVO newRule = new LoadBalancerVO(lb.getXid(), lb.getName(), lb.getDescription(),\n-                lb.getSourceIpAddressId(), lb.getSourcePortEnd(), lb.getDefaultPortStart(), lb.getAlgorithm(),\n-                network.getId(), ipAddr.getAllocatedToAccountId(), ipAddr.getAllocatedInDomainId());\n+        LoadBalancerVO newRule = new LoadBalancerVO(xId, name, description,\n+                sourceIpId, srcPort, srcPort, algorithm,\n+                networkId, ipAddr.getAllocatedToAccountId(), ipAddr.getAllocatedInDomainId());\n \n         // verify rule is supported by Lb provider of the network\n+        Ip sourceIp = getSourceIp(newRule);\n         LoadBalancingRule loadBalancing = new LoadBalancingRule(newRule, new ArrayList<LbDestination>(),\n-                new ArrayList<LbStickinessPolicy>(), new ArrayList<LbHealthCheckPolicy>());\n-        if (!validateRule(loadBalancing)) {\n+                new ArrayList<LbStickinessPolicy>(), new ArrayList<LbHealthCheckPolicy>(), sourceIp);\n+        if (!validateLbRule(loadBalancing)) {\n             throw new InvalidParameterValueException(\"LB service provider cannot support this rule\");\n         }\n \n+        Transaction txn = Transaction.currentTxn();\n+        txn.start();\n+        \n         newRule = _lbDao.persist(newRule);\n \n+        //create rule for all CIDRs\n         if (openFirewall) {\n-            _firewallMgr.createRuleForAllCidrs(sourceIpId, caller.getCaller(), lb.getSourcePortStart(),\n-                    lb.getSourcePortEnd(), lb.getProtocol(), null, null, newRule.getId(), networkId);\n+            _firewallMgr.createRuleForAllCidrs(sourceIpId, caller.getCaller(), srcPort,\n+                    srcPort, protocol, null, null, newRule.getId(), networkId);\n         }\n \n         boolean success = true;\n@@ -1344,7 +1425,7 @@ public LoadBalancer createLoadBalancer(CreateLoadBalancerRuleCmd lb, boolean ope\n                 throw new CloudRuntimeException(\"Unable to update the state to add for \" + newRule);\n             }\n             s_logger.debug(\"Load balancer \" + newRule.getId() + \" for Ip address id=\" + sourceIpId + \", public port \"\n-                    + srcPortStart + \", private port \" + defPortStart + \" is added successfully.\");\n+                    + srcPort + \", private port \" + destPort + \" is added successfully.\");\n             UserContext.current().setEventDetails(\"Load balancer Id: \" + newRule.getId());\n             UsageEventUtils.publishUsageEvent(EventTypes.EVENT_LOAD_BALANCER_CREATE, ipAddr.getAllocatedToAccountId(),\n                     ipAddr.getDataCenterId(), newRule.getId(), null, LoadBalancingRule.class.getName(),\n@@ -1380,14 +1461,17 @@ public boolean applyLoadBalancerConfig(long lbRuleId) throws ResourceUnavailable\n             lbs = Arrays.asList(lb);\n         } else {\n             // get all rules in transition state\n-            lbs = _lbDao.listInTransitionStateByNetworkId(lb.getNetworkId());\n+            lbs = _lbDao.listInTransitionStateByNetworkIdAndScheme(lb.getNetworkId(), lb.getScheme());\n         }\n         return applyLoadBalancerRules(lbs, true);\n     }\n \n     @Override\n-    public boolean revokeLoadBalancersForNetwork(long networkId) throws ResourceUnavailableException {\n-        List<LoadBalancerVO> lbs = _lbDao.listByNetworkId(networkId);\n+    public boolean revokeLoadBalancersForNetwork(long networkId, Scheme scheme) throws ResourceUnavailableException {\n+        List<LoadBalancerVO> lbs = _lbDao.listByNetworkIdAndScheme(networkId, scheme);\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Revoking \" + lbs.size() + \" \" + scheme + \" load balancing rules for network id=\" + networkId);\n+        }\n         if (lbs != null) {\n             for(LoadBalancerVO lb : lbs) { // called during restart, not persisting state in db\n                 lb.setState(FirewallRule.State.Revoke);\n@@ -1400,20 +1484,20 @@ public boolean revokeLoadBalancersForNetwork(long networkId) throws ResourceUnav\n     }\n \n     @Override\n-    public boolean applyLoadBalancersForNetwork(long networkId) throws ResourceUnavailableException {\n-        List<LoadBalancerVO> lbs = _lbDao.listByNetworkId(networkId);\n+    public boolean applyLoadBalancersForNetwork(long networkId, Scheme scheme) throws ResourceUnavailableException {\n+        List<LoadBalancerVO> lbs = _lbDao.listByNetworkIdAndScheme(networkId, scheme);\n         if (lbs != null) {\n+            s_logger.debug(\"Applying load balancer rules of scheme \" + scheme + \" in network id=\" + networkId);\n             return applyLoadBalancerRules(lbs, true);\n         } else {\n-            s_logger.info(\"Network id=\" + networkId + \" doesn't have load balancer rules, nothing to apply\");\n+            s_logger.info(\"Network id=\" + networkId + \" doesn't have load balancer rules of scheme \" + scheme + \", nothing to apply\");\n             return true;\n         }\n     }\n \n-    @Override\n-    public boolean applyRules(Network network, Purpose purpose, List<? extends FirewallRule> rules)\n+    \n+    protected boolean applyLbRules(Network network, List<LoadBalancingRule> rules)\n             throws ResourceUnavailableException {\n-        assert (purpose == Purpose.LoadBalancing) : \"LB Manager asked to handle non-LB rules\";\n         boolean handled = false;\n         for (LoadBalancingServiceProvider lbElement : _lbProviders) {\n             Provider provider = lbElement.getProvider();\n@@ -1422,7 +1506,7 @@ public boolean applyRules(Network network, Purpose purpose, List<? extends Firew\n             if (!isLbProvider) {\n                 continue;\n             }\n-            handled = lbElement.applyLBRules(network, (List<LoadBalancingRule>) rules);\n+            handled = lbElement.applyLBRules(network, rules);\n             if (handled)\n                 break;\n         }\n@@ -1432,7 +1516,8 @@ public boolean applyRules(Network network, Purpose purpose, List<? extends Firew\n     private LoadBalancingRule getLoadBalancerRuleToApply(LoadBalancerVO lb) {\n \n         List<LbStickinessPolicy> policyList = getStickinessPolicies(lb.getId());\n-        LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, null, policyList, null);\n+        Ip sourceIp = getSourceIp(lb);\n+        LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, null, policyList, null, sourceIp);\n \n         if (_autoScaleVmGroupDao.isAutoScaleLoadBalancer(lb.getId())) {\n             // Get the associated VmGroup\n@@ -1442,7 +1527,7 @@ private LoadBalancingRule getLoadBalancerRuleToApply(LoadBalancerVO lb) {\n         } else {\n             List<LbDestination> dstList = getExistingDestinations(lb.getId());\n             loadBalancing.setDestinations(dstList);\n-\t    List<LbHealthCheckPolicy> hcPolicyList = getHealthCheckPolicies(lb.getId());\n+            List<LbHealthCheckPolicy> hcPolicyList = getHealthCheckPolicies(lb.getId());\n             loadBalancing.setHealthCheckPolicies(hcPolicyList);\n         }\n \n@@ -1458,7 +1543,7 @@ protected boolean applyLoadBalancerRules(List<LoadBalancerVO> lbs, boolean updat\n             rules.add(getLoadBalancerRuleToApply(lb));\n         }\n \n-        if (!_networkMgr.applyRules(rules, FirewallRule.Purpose.LoadBalancing, this, false)) {\n+        if (!applyLbRules(rules, false)) {\n             s_logger.debug(\"LB rules are not completely applied\");\n             return false;\n         }\n@@ -1515,7 +1600,7 @@ protected boolean applyLoadBalancerRules(List<LoadBalancerVO> lbs, boolean updat\n                 }\n \n                 txn.commit();\n-                if (checkForReleaseElasticIp) {\n+                if (checkForReleaseElasticIp && lb.getSourceIpAddressId() != null) {\n                     boolean success = true;\n                     long count = _firewallDao.countRulesByIpId(lb.getSourceIpAddressId());\n                     if (count == 0) {\n@@ -1534,8 +1619,10 @@ protected boolean applyLoadBalancerRules(List<LoadBalancerVO> lbs, boolean updat\n                 }\n                 // if the rule is the last one for the ip address assigned to\n                 // VPC, unassign it from the network\n-                IpAddress ip = _ipAddressDao.findById(lb.getSourceIpAddressId());\n-                _vpcMgr.unassignIPFromVpcNetwork(ip.getId(), lb.getNetworkId());\n+                if (lb.getSourceIpAddressId() != null) {\n+                    IpAddress ip = _ipAddressDao.findById(lb.getSourceIpAddressId());\n+                    _vpcMgr.unassignIPFromVpcNetwork(ip.getId(), lb.getNetworkId());\n+                }\n             }\n         }\n \n@@ -1902,32 +1989,115 @@ public LoadBalancer updateLoadBalancerRule(UpdateLoadBalancerRuleCmd cmd) {\n                 count++;\n             }\n         }\n+        \n+        //list only Public load balancers using this command\n+        sc.setParameters(\"scheme\", Scheme.Public);\n \n         Pair<List<LoadBalancerVO>, Integer> result = _lbDao.searchAndCount(sc, searchFilter);\n         return new Pair<List<? extends LoadBalancer>, Integer>(result.first(), result.second());\n     }\n \n-    @Override\n-    public List<LoadBalancingRule> listByNetworkId(long networkId) {\n-        List<LoadBalancerVO> lbs = _lbDao.listByNetworkId(networkId);\n-        List<LoadBalancingRule> lbRules = new ArrayList<LoadBalancingRule>();\n-        for (LoadBalancerVO lb : lbs) {\n-            List<LbDestination> dstList = getExistingDestinations(lb.getId());\n-            List<LbStickinessPolicy> policyList = this.getStickinessPolicies(lb.getId());\n-            List<LbHealthCheckPolicy> hcPolicyList = this.getHealthCheckPolicies(lb.getId());\n-            LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList);\n-            lbRules.add(loadBalancing);\n-        }\n-        return lbRules;\n-    }\n \n     @Override\n     public LoadBalancerVO findById(long lbId) {\n         return _lbDao.findById(lbId);\n     }\n \n-    protected void removeLBRule(LoadBalancerVO rule) {\n+    @Override\n+    public void removeLBRule(LoadBalancer rule) {\n         // remove the rule\n         _lbDao.remove(rule.getId());\n     }\n+    \n+    \n+    public boolean applyLbRules(List<LoadBalancingRule> rules, boolean continueOnError) throws ResourceUnavailableException {\n+        if (rules == null || rules.size() == 0) {\n+            s_logger.debug(\"There are no Load Balancing Rules to forward to the network elements\");\n+            return true;\n+        }\n+\n+        boolean success = true;\n+        Network network = _networkModel.getNetwork(rules.get(0).getNetworkId());\n+        List<PublicIp> publicIps = new ArrayList<PublicIp>();\n+\n+        \n+        // get the list of public ip's owned by the network\n+        List<IPAddressVO> userIps = _ipAddressDao.listByAssociatedNetwork(network.getId(), null);\n+        if (userIps != null && !userIps.isEmpty()) {\n+            for (IPAddressVO userIp : userIps) {\n+                PublicIp publicIp = PublicIp.createFromAddrAndVlan(userIp, _vlanDao.findById(userIp.getVlanId()));\n+                publicIps.add(publicIp);\n+            }\n+        }\n+\n+        // rules can not programmed unless IP is associated with network\n+        // service provider, so run IP assoication for\n+        // the network so as to ensure IP is associated before applying\n+        // rules (in add state)\n+        _networkMgr.applyIpAssociations(network, false, continueOnError, publicIps);\n+        \n+\n+        try {\n+            applyLbRules(network, rules);\n+        } catch (ResourceUnavailableException e) {\n+            if (!continueOnError) {\n+                throw e;\n+            }\n+            s_logger.warn(\"Problems with applying load balancing rules but pushing on\", e);\n+            success = false;\n+        }\n+\n+        // if all the rules configured on public IP are revoked then\n+        // dis-associate IP with network service provider\n+        _networkMgr.applyIpAssociations(network, true, continueOnError, publicIps);\n+        \n+        return success;\n+    }\n+    \n+    @Override\n+    public Map<Ip, UserVm> getLbInstances(long lbId) {\n+        Map<Ip, UserVm> dstList = new HashMap<Ip, UserVm>();\n+        List<LoadBalancerVMMapVO> lbVmMaps = _lb2VmMapDao.listByLoadBalancerId(lbId);\n+        LoadBalancerVO lb = _lbDao.findById(lbId);\n+\n+        for (LoadBalancerVMMapVO lbVmMap : lbVmMaps) {\n+            UserVm vm = _vmDao.findById(lbVmMap.getInstanceId());\n+            Nic nic = _nicDao.findByInstanceIdAndNetworkIdIncludingRemoved(lb.getNetworkId(), vm.getId());\n+            Ip ip = new Ip(nic.getIp4Address());\n+            dstList.put(ip, vm);\n+        }\n+        return dstList;\n+    }\n+    \n+    @Override\n+    public void isLbServiceSupportedInNetwork(long networkId, Scheme scheme) {\n+        Network network = _networkDao.findById(networkId);\n+        \n+        //1) Check if the LB service is supported\n+        if (!_networkModel.areServicesSupportedInNetwork(network.getId(), Service.Lb)) {\n+            InvalidParameterValueException ex = new InvalidParameterValueException(\n+                    \"LB service is not supported in specified network id\");\n+            ex.addProxyObject(network, network.getId(), \"networkId\");\n+            throw ex;\n+        }\n+        \n+        //2) Check if the Scheme is supported\\\n+        NetworkOffering off = _configMgr.getNetworkOffering(network.getNetworkOfferingId());\n+        if (scheme == Scheme.Public) {\n+            if (!off.getPublicLb()) {\n+                throw new InvalidParameterValueException(\"Scheme \" + scheme + \" is not supported by the network offering \" + off);\n+            }\n+        } else {\n+            if (!off.getInternalLb()) {\n+                throw new InvalidParameterValueException(\"Scheme \" + scheme + \" is not supported by the network offering \" + off);    \n+            }\n+        }\n+        \n+        //3) Check if the provider supports the scheme\n+        LoadBalancingServiceProvider lbProvider = _networkMgr.getLoadBalancingProviderForNetwork(network, scheme);\n+        if (lbProvider == null) {\n+            throw new InvalidParameterValueException(\"Lb rule with scheme \" + scheme.toString() + \" is not supported by lb providers in network \" + network);\n+        }\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java",
                "sha": "520dd7636674e65e783574cc9b45835b5b9ff6f0",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/router/VirtualNetworkApplianceManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManager.java",
                "patch": "@@ -28,6 +28,7 @@\n import com.cloud.network.RemoteAccessVpn;\n import com.cloud.network.VirtualNetworkApplianceService;\n import com.cloud.network.VpnUser;\n+import com.cloud.network.lb.LoadBalancingRule;\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.user.Account;\n@@ -103,4 +104,7 @@ boolean applyDhcpEntry(Network config, NicProfile nic, VirtualMachineProfile<Use\n \t\n \tboolean applyUserData(Network config, NicProfile nic, VirtualMachineProfile<UserVm> vm, DeployDestination dest, \n \t        List<DomainRouterVO> routers) throws ResourceUnavailableException;\n+\n+    boolean applyLoadBalancingRules(Network network, List<? extends LoadBalancingRule> rules, List<? extends VirtualRouter> routers) throws ResourceUnavailableException;\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/router/VirtualNetworkApplianceManager.java",
                "sha": "fcf650f900c7eafc867ea4df3b0eb49677f7e101",
                "status": "modified"
            },
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 59,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 11,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -173,6 +173,7 @@\n import com.cloud.network.router.VirtualRouter.Role;\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRule.Purpose;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.PortForwardingRule;\n import com.cloud.network.rules.RulesManager;\n import com.cloud.network.rules.StaticNat;\n@@ -218,6 +219,7 @@\n import com.cloud.utils.db.SearchCriteria;\n import com.cloud.utils.db.Transaction;\n import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n import com.cloud.utils.net.MacAddress;\n import com.cloud.utils.net.NetUtils;\n import com.cloud.vm.DomainRouterVO;\n@@ -1526,7 +1528,7 @@ private HypervisorType getClusterToStartDomainRouterForOvm(long podId) {\n                 for (int i = 0; i < count; i++) {\n                 List<Pair<NetworkVO, NicProfile>> networks = createRouterNetworks(owner, isRedundant, plan, guestNetwork,\n                         new Pair<Boolean, PublicIp>(publicNetwork, sourceNatIp));\n-                //don't start the router as we are holding the network lock that needs to be released at the end of router allocation\n+                    //don't start the router as we are holding the network lock that needs to be released at the end of router allocation\n                     DomainRouterVO router = deployRouter(owner, destination, plan, params, isRedundant, vrProvider, offeringId,\n                         null, networks, false, null);\n \n@@ -2410,15 +2412,16 @@ protected void finalizeNetworkRulesForNetwork(Commands cmds, DomainRouterVO rout\n                 }\n             }\n    \n-            List<LoadBalancerVO> lbs = _loadBalancerDao.listByNetworkId(guestNetworkId);\n+            List<LoadBalancerVO> lbs = _loadBalancerDao.listByNetworkIdAndScheme(guestNetworkId, Scheme.Public);\n             List<LoadBalancingRule> lbRules = new ArrayList<LoadBalancingRule>();\n             if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId, Service.Lb, provider)) {\n                 // Re-apply load balancing rules\n                 for (LoadBalancerVO lb : lbs) {\n                     List<LbDestination> dstList = _lbMgr.getExistingDestinations(lb.getId());\n                     List<LbStickinessPolicy> policyList = _lbMgr.getStickinessPolicies(lb.getId());\n                     List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId());\n-                    LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList);\n+                    Ip sourceIp = _networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();\n+                    LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList, sourceIp);\n                     lbRules.add(loadBalancing);\n                 }\n             }\n@@ -2509,7 +2512,7 @@ public boolean finalizeStart(VirtualMachineProfile<DomainRouterVO> profile, long\n             Network network = _networkModel.getNetwork(routerNic.getNetworkId());\n             if (network.getTrafficType() == TrafficType.Guest) {\n                 guestNetworks.add(network);\n-            } \n+            }\n         }\n         \n         answer = cmds.getAnswer(\"getDomRVersion\");\n@@ -3036,7 +3039,7 @@ private void createApplyLoadBalancingRulesCommands(List<LoadBalancingRule> rules\n             String algorithm = rule.getAlgorithm();\n             String uuid = rule.getUuid();\n \n-            String srcIp = _networkModel.getIp(rule.getSourceIpAddressId()).getAddress().addr();\n+            String srcIp = rule.getSourceIp().addr();\n             int srcPort = rule.getSourcePortStart();\n             List<LbDestination> destinations = rule.getDestinations();\n             List<LbStickinessPolicy> stickinessPolicies = rule.getStickinessPolicies();\n@@ -3051,7 +3054,7 @@ private void createApplyLoadBalancingRulesCommands(List<LoadBalancingRule> rules\n         }\n         \n         Network guestNetwork = _networkModel.getNetwork(guestNetworkId);\n-        Nic nic = _nicDao.findByInstanceIdAndNetworkId(guestNetwork.getId(), router.getId());\n+        Nic nic = _nicDao.findByNtwkIdAndInstanceId(guestNetwork.getId(), router.getId());\n         NicProfile nicProfile = new NicProfile(nic, guestNetwork, nic.getBroadcastUri(), nic.getIsolationUri(), \n                 _networkModel.getNetworkRate(guestNetwork.getId(), router.getId()), \n                 _networkModel.isSecurityGroupSupportedInNetwork(guestNetwork), \n@@ -3144,7 +3147,7 @@ private void createVmDataCommandForVMs(DomainRouterVO router, Commands cmds, lon\n             }\n \n             if (createVmData) {\n-                NicVO nic = _nicDao.findByInstanceIdAndNetworkId(guestNetworkId, vm.getId());\n+                NicVO nic = _nicDao.findByNtwkIdAndInstanceId(guestNetworkId, vm.getId());\n                 if (nic != null) {\n                     s_logger.debug(\"Creating user data entry for vm \" + vm + \" on domR \" + router);\n                     createVmDataCommand(router, vm, nic, null, cmds);\n@@ -3197,7 +3200,7 @@ private void createDhcpEntryCommandsForVMs(DomainRouterVO router, Commands cmds,\n                 createDhcp = false;\n             }\n             if (createDhcp) {\n-                NicVO nic = _nicDao.findByInstanceIdAndNetworkId(guestNetworkId, vm.getId());\n+                NicVO nic = _nicDao.findByNtwkIdAndInstanceId(guestNetworkId, vm.getId());\n                 if (nic != null) {\n                     s_logger.debug(\"Creating dhcp entry for vm \" + vm + \" on domR \" + router + \".\");\n                     createDhcpEntryCommand(router, vm, nic, cmds);\n@@ -3315,13 +3318,14 @@ public boolean applyFirewallRules(Network network, final List<? extends Firewall\n             public boolean execute(Network network, VirtualRouter router) throws ResourceUnavailableException {\n                 if (rules.get(0).getPurpose() == Purpose.LoadBalancing) {\n                     // for load balancer we have to resend all lb rules for the network\n-                    List<LoadBalancerVO> lbs = _loadBalancerDao.listByNetworkId(network.getId());\n+                    List<LoadBalancerVO> lbs = _loadBalancerDao.listByNetworkIdAndScheme(network.getId(), Scheme.Public);\n                     List<LoadBalancingRule> lbRules = new ArrayList<LoadBalancingRule>();\n                     for (LoadBalancerVO lb : lbs) {\n                         List<LbDestination> dstList = _lbMgr.getExistingDestinations(lb.getId());\n                         List<LbStickinessPolicy> policyList = _lbMgr.getStickinessPolicies(lb.getId());\n-                        List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId() );\n-                        LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList);\n+                        List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId());\n+                        Ip sourceIp = _networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();\n+                        LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList, sourceIp);\n                         lbRules.add(loadBalancing);\n                     }\n                     return sendLBRules(router, lbRules, network.getId());\n@@ -3338,6 +3342,32 @@ public boolean execute(Network network, VirtualRouter router) throws ResourceUna\n             }\n         });\n     }\n+    \n+    \n+    @Override\n+    public boolean applyLoadBalancingRules(Network network, final List<? extends LoadBalancingRule> rules, List<? extends VirtualRouter> routers) throws ResourceUnavailableException {\n+        if (rules == null || rules.isEmpty()) {\n+            s_logger.debug(\"No lb rules to be applied for network \" + network.getId());\n+            return true;\n+        }\n+        return applyRules(network, routers, \"loadbalancing rules\", false, null, false, new RuleApplier() {\n+            @Override\n+            public boolean execute(Network network, VirtualRouter router) throws ResourceUnavailableException {\n+                // for load balancer we have to resend all lb rules for the network\n+                List<LoadBalancerVO> lbs = _loadBalancerDao.listByNetworkIdAndScheme(network.getId(), Scheme.Public);\n+                List<LoadBalancingRule> lbRules = new ArrayList<LoadBalancingRule>();\n+                for (LoadBalancerVO lb : lbs) {\n+                    List<LbDestination> dstList = _lbMgr.getExistingDestinations(lb.getId());\n+                    List<LbStickinessPolicy> policyList = _lbMgr.getStickinessPolicies(lb.getId());\n+                    List<LbHealthCheckPolicy> hcPolicyList = _lbMgr.getHealthCheckPolicies(lb.getId());\n+                    Ip sourceIp = _networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();\n+                    LoadBalancingRule loadBalancing = new LoadBalancingRule(lb, dstList, policyList, hcPolicyList, sourceIp);\n+                    lbRules.add(loadBalancing);\n+                }\n+                return sendLBRules(router, lbRules, network.getId());  \n+            }\n+        });\n+    }\n \n     protected boolean sendLBRules(VirtualRouter router, List<LoadBalancingRule> rules, long guestNetworkId) throws ResourceUnavailableException {\n         Commands cmds = new Commands(OnError.Continue);\n@@ -3734,4 +3764,11 @@ public void prepareStop(VirtualMachineProfile<DomainRouterVO> profile){\n             }\n         }\n     }\n+\n+\n+\n+    @Override\n+    public VirtualRouter findRouter(long routerId) {\n+        return _routerDao.findById(routerId);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "e3dd06ba47cbd86daddba6f01ae966f97314e087",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -440,7 +440,7 @@ protected SetupGuestNetworkCommand createSetupGuestNetworkCommand(VirtualRouter\n             defaultDns2 = guestNic.getDns2();\n         }\n         \n-        Nic nic = _nicDao.findByInstanceIdAndNetworkId(network.getId(), router.getId());\n+        Nic nic = _nicDao.findByNtwkIdAndInstanceId(network.getId(), router.getId());\n         String networkDomain = network.getNetworkDomain();\n         String dhcpRange = getGuestDhcpRange(guestNic, network, _configMgr.getZone(network.getDataCenterId()));\n         ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "sha": "611100955e7ee6a0f23e8987b579e40722e06428",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/VpcManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 5,
                "filename": "server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "patch": "@@ -184,7 +184,9 @@\n     private final ScheduledExecutorService _executor = Executors.newScheduledThreadPool(1, new NamedThreadFactory(\"VpcChecker\"));\n     private List<VpcProvider> vpcElements = null;\n     private final List<Service> nonSupportedServices = Arrays.asList(Service.SecurityGroup, Service.Firewall);\n-    private final List<Provider> supportedProviders = Arrays.asList(Provider.VPCVirtualRouter, Provider.NiciraNvp, Provider.Netscaler);\n+    private final List<Provider> supportedProviders = Arrays.asList(Provider.VPCVirtualRouter, Provider.NiciraNvp, Provider.InternalLbVm, Provider.Netscaler);\n+ \n+\n     int _cleanupInterval;\n     int _maxNetworks;\n     SearchBuilder<IPAddressVO> IpAddressSearch;\n@@ -206,6 +208,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n                 if (svc == Service.Lb) {\n                     Set<Provider> lbProviders = new HashSet<Provider>();\n                     lbProviders.add(Provider.VPCVirtualRouter);\n+                    lbProviders.add(Provider.InternalLbVm);\n                     svcProviderMap.put(svc, lbProviders);\n                 } else {\n                     svcProviderMap.put(svc, defaultProviders);\n@@ -1057,16 +1060,17 @@ public void validateNtwkOffForNtwkInVpc(Long networkId, long newNtwkOffId, Strin\n             }\n         }\n \n-        //4) Only one network in the VPC can support LB\n-        if (_ntwkModel.areServicesSupportedByNetworkOffering(guestNtwkOff.getId(), Service.Lb)) {\n+        //4) Only one network in the VPC can support public LB inside the VPC. Internal LB can be supported on multiple VPC tiers\n+        if (_ntwkModel.areServicesSupportedByNetworkOffering(guestNtwkOff.getId(), Service.Lb) && guestNtwkOff.getPublicLb()) {\n             List<? extends Network> networks = getVpcNetworks(vpc.getId());\n             for (Network network : networks) {\n                 if (networkId != null && network.getId() == networkId.longValue()) {\n                     //skip my own network\n                     continue;\n                 } else {\n-                    if (_ntwkModel.areServicesSupportedInNetwork(network.getId(), Service.Lb)) {\n-                        throw new InvalidParameterValueException(\"LB service is already supported \" +\n+                    NetworkOffering otherOff = _configMgr.getNetworkOffering(network.getNetworkOfferingId());\n+                    if (_ntwkModel.areServicesSupportedInNetwork(network.getId(), Service.Lb) && otherOff.getPublicLb()) {\n+                        throw new InvalidParameterValueException(\"Public LB service is already supported \" +\n                         \t\t\"by network \" + network + \" in VPC \" + vpc);\n                     }\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "sha": "55656d8b4fb42509ef50bce881898abec701ba33",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ConfigurationServerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 7,
                "filename": "server/src/com/cloud/server/ConfigurationServerImpl.java",
                "patch": "@@ -1017,7 +1017,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Shared Security group enabled networks\",\n                 TrafficType.Guest,\n                 false, true, null, null, true, Availability.Optional,\n-                null, Network.GuestType.Shared, true, true, false);\n+                null, Network.GuestType.Shared, true, true, false, false, false);\n \n         defaultSharedSGNetworkOffering.setState(NetworkOffering.State.Enabled);\n         defaultSharedSGNetworkOffering = _networkOfferingDao.persistDefaultNetworkOffering(defaultSharedSGNetworkOffering);\n@@ -1034,7 +1034,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Shared networks\",\n                 TrafficType.Guest,\n                 false, true, null, null, true, Availability.Optional,\n-                null, Network.GuestType.Shared, true, true, false);\n+                null, Network.GuestType.Shared, true, true, false, false, false);\n \n         defaultSharedNetworkOffering.setState(NetworkOffering.State.Enabled);\n         defaultSharedNetworkOffering = _networkOfferingDao.persistDefaultNetworkOffering(defaultSharedNetworkOffering);\n@@ -1051,7 +1051,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Isolated networks with Source Nat service enabled\",\n                 TrafficType.Guest,\n                 false, false, null, null, true, Availability.Required,\n-                null, Network.GuestType.Isolated, true, false, false);\n+                null, Network.GuestType.Isolated, true, false, false, false, true);\n \n         defaultIsolatedSourceNatEnabledNetworkOffering.setState(NetworkOffering.State.Enabled);\n         defaultIsolatedSourceNatEnabledNetworkOffering = _networkOfferingDao.persistDefaultNetworkOffering(defaultIsolatedSourceNatEnabledNetworkOffering);\n@@ -1069,7 +1069,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Isolated networks with no Source Nat service\",\n                 TrafficType.Guest,\n                 false, true, null, null, true, Availability.Optional,\n-                null, Network.GuestType.Isolated, true, true, false);\n+                null, Network.GuestType.Isolated, true, true, false, false, false);\n \n         defaultIsolatedEnabledNetworkOffering.setState(NetworkOffering.State.Enabled);\n         defaultIsolatedEnabledNetworkOffering = _networkOfferingDao.persistDefaultNetworkOffering(defaultIsolatedEnabledNetworkOffering);\n@@ -1086,7 +1086,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Shared networks with Elastic IP and Elastic LB capabilities\",\n                 TrafficType.Guest,\n                 false, true, null, null, true, Availability.Optional,\n-                null, Network.GuestType.Shared, true, false, false, false, true, true, true, false, false, true);\n+                null, Network.GuestType.Shared, true, false, false, false, true, true, true, false, false, true, true, false);\n \n         defaultNetscalerNetworkOffering.setState(NetworkOffering.State.Enabled);\n         defaultNetscalerNetworkOffering = _networkOfferingDao.persistDefaultNetworkOffering(defaultNetscalerNetworkOffering);\n@@ -1103,7 +1103,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Isolated Vpc networks with Source Nat service enabled\",\n                 TrafficType.Guest,\n                 false, false, null, null, true, Availability.Optional,\n-                null, Network.GuestType.Isolated, false, false, false);\n+                null, Network.GuestType.Isolated, false, false, false, false, true);\n \n         defaultNetworkOfferingForVpcNetworks.setState(NetworkOffering.State.Enabled);\n         defaultNetworkOfferingForVpcNetworks = _networkOfferingDao.persistDefaultNetworkOffering(defaultNetworkOfferingForVpcNetworks);\n@@ -1133,7 +1133,7 @@ protected void createDefaultNetworkOfferings() {\n                 \"Offering for Isolated Vpc networks with Source Nat service enabled and LB service Disabled\",\n                 TrafficType.Guest,\n                 false, false, null, null, true, Availability.Optional,\n-                null, Network.GuestType.Isolated, false, false, false);\n+                null, Network.GuestType.Isolated, false, false, false, false, false);\n \n         defaultNetworkOfferingForVpcNetworksNoLB.setState(NetworkOffering.State.Enabled);\n         defaultNetworkOfferingForVpcNetworksNoLB = _networkOfferingDao.persistDefaultNetworkOffering(defaultNetworkOfferingForVpcNetworksNoLB);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "sha": "bc52e9a881c3e57fb1dbae1f77b52c2bf9f68ab9",
                "status": "modified"
            },
            {
                "additions": 455,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 580,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 125,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -34,7 +34,6 @@\n import java.util.Map;\n import java.util.Set;\n import java.util.TimeZone;\n-import java.util.UUID;\n import java.util.concurrent.Executors;\n import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.TimeUnit;\n@@ -44,52 +43,371 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n-import com.cloud.configuration.*;\n-import com.cloud.storage.dao.*;\n+import org.apache.cloudstack.acl.ControlledEntity;\n import org.apache.cloudstack.acl.SecurityChecker.AccessType;\n-import org.apache.cloudstack.api.ApiConstants;\n-\n-import com.cloud.event.ActionEventUtils;\n-import org.apache.cloudstack.api.BaseUpdateTemplateOrIsoCmd;\n-import org.apache.cloudstack.api.command.admin.account.*;\n-import org.apache.cloudstack.api.command.admin.domain.*;\n-import org.apache.cloudstack.api.command.admin.host.*;\n-import org.apache.cloudstack.api.command.admin.network.*;\n-import org.apache.cloudstack.api.command.admin.offering.*;\n-import org.apache.cloudstack.api.command.admin.resource.*;\n-import org.apache.cloudstack.api.command.admin.router.*;\n-import org.apache.cloudstack.api.command.admin.storage.*;\n-import org.apache.cloudstack.api.command.admin.systemvm.*;\n-import org.apache.cloudstack.api.command.admin.usage.*;\n-import org.apache.cloudstack.api.command.admin.user.*;\n-import org.apache.cloudstack.api.command.admin.vlan.*;\n-import org.apache.cloudstack.api.command.admin.vpc.*;\n-import org.apache.cloudstack.api.command.user.autoscale.*;\n-import org.apache.cloudstack.api.command.user.firewall.*;\n-import org.apache.cloudstack.api.command.user.iso.*;\n-import org.apache.cloudstack.api.command.user.loadbalancer.*;\n-import org.apache.cloudstack.api.command.user.nat.*;\n-import org.apache.cloudstack.api.command.user.network.*;\n-import org.apache.cloudstack.api.command.user.project.*;\n-import org.apache.cloudstack.api.command.user.resource.*;\n-import org.apache.cloudstack.api.command.user.securitygroup.*;\n-import org.apache.cloudstack.api.command.user.snapshot.*;\n-import org.apache.cloudstack.api.command.user.template.*;\n-import org.apache.cloudstack.api.command.user.vm.*;\n-import org.apache.cloudstack.api.command.user.volume.*;\n-import org.apache.cloudstack.api.command.user.vpc.*;\n-import org.apache.cloudstack.api.command.user.vpn.*;\n-import org.apache.cloudstack.api.response.ExtractResponse;\n-import org.apache.commons.codec.binary.Base64;\n-import org.apache.log4j.Logger;\n import org.apache.cloudstack.affinity.AffinityGroupProcessor;\n import org.apache.cloudstack.affinity.dao.AffinityGroupVMMapDao;\n-\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseUpdateTemplateOrIsoCmd;\n+import org.apache.cloudstack.api.command.admin.account.CreateAccountCmd;\n+import org.apache.cloudstack.api.command.admin.account.DeleteAccountCmd;\n+import org.apache.cloudstack.api.command.admin.account.DisableAccountCmd;\n+import org.apache.cloudstack.api.command.admin.account.EnableAccountCmd;\n+import org.apache.cloudstack.api.command.admin.account.LockAccountCmd;\n+import org.apache.cloudstack.api.command.admin.account.UpdateAccountCmd;\n+import org.apache.cloudstack.api.command.admin.autoscale.CreateCounterCmd;\n+import org.apache.cloudstack.api.command.admin.autoscale.DeleteCounterCmd;\n+import org.apache.cloudstack.api.command.admin.cluster.AddClusterCmd;\n+import org.apache.cloudstack.api.command.admin.cluster.DeleteClusterCmd;\n+import org.apache.cloudstack.api.command.admin.cluster.ListClustersCmd;\n+import org.apache.cloudstack.api.command.admin.cluster.UpdateClusterCmd;\n+import org.apache.cloudstack.api.command.admin.config.ListCfgsByCmd;\n+import org.apache.cloudstack.api.command.admin.config.ListHypervisorCapabilitiesCmd;\n+import org.apache.cloudstack.api.command.admin.config.UpdateCfgCmd;\n+import org.apache.cloudstack.api.command.admin.config.UpdateHypervisorCapabilitiesCmd;\n+import org.apache.cloudstack.api.command.admin.domain.CreateDomainCmd;\n+import org.apache.cloudstack.api.command.admin.domain.DeleteDomainCmd;\n+import org.apache.cloudstack.api.command.admin.domain.ListDomainChildrenCmd;\n+import org.apache.cloudstack.api.command.admin.domain.ListDomainsCmd;\n+import org.apache.cloudstack.api.command.admin.domain.UpdateDomainCmd;\n+import org.apache.cloudstack.api.command.admin.host.AddHostCmd;\n+import org.apache.cloudstack.api.command.admin.host.AddSecondaryStorageCmd;\n+import org.apache.cloudstack.api.command.admin.host.CancelMaintenanceCmd;\n+import org.apache.cloudstack.api.command.admin.host.DeleteHostCmd;\n+import org.apache.cloudstack.api.command.admin.host.FindHostsForMigrationCmd;\n+import org.apache.cloudstack.api.command.admin.host.ListHostsCmd;\n+import org.apache.cloudstack.api.command.admin.host.PrepareForMaintenanceCmd;\n+import org.apache.cloudstack.api.command.admin.host.ReconnectHostCmd;\n+import org.apache.cloudstack.api.command.admin.host.UpdateHostCmd;\n+import org.apache.cloudstack.api.command.admin.host.UpdateHostPasswordCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.ConfigureInternalLoadBalancerElementCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.CreateInternalLoadBalancerElementCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.ListInternalLBVMsCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.ListInternalLoadBalancerElementsCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.StartInternalLBVMCmd;\n+import org.apache.cloudstack.api.command.admin.internallb.StopInternalLBVMCmd;\n+import org.apache.cloudstack.api.command.admin.ldap.LDAPConfigCmd;\n+import org.apache.cloudstack.api.command.admin.ldap.LDAPRemoveCmd;\n+import org.apache.cloudstack.api.command.admin.network.AddNetworkDeviceCmd;\n+import org.apache.cloudstack.api.command.admin.network.AddNetworkServiceProviderCmd;\n+import org.apache.cloudstack.api.command.admin.network.CreateNetworkOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.network.CreatePhysicalNetworkCmd;\n+import org.apache.cloudstack.api.command.admin.network.CreateStorageNetworkIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.DedicateGuestVlanRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.DeleteNetworkDeviceCmd;\n+import org.apache.cloudstack.api.command.admin.network.DeleteNetworkOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.network.DeleteNetworkServiceProviderCmd;\n+import org.apache.cloudstack.api.command.admin.network.DeletePhysicalNetworkCmd;\n+import org.apache.cloudstack.api.command.admin.network.DeleteStorageNetworkIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListDedicatedGuestVlanRangesCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListNetworkDeviceCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListNetworkIsolationMethodsCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListNetworkServiceProvidersCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListPhysicalNetworksCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListStorageNetworkIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListSupportedNetworkServicesCmd;\n+import org.apache.cloudstack.api.command.admin.network.ReleaseDedicatedGuestVlanRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.UpdateNetworkOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.network.UpdateNetworkServiceProviderCmd;\n+import org.apache.cloudstack.api.command.admin.network.UpdatePhysicalNetworkCmd;\n+import org.apache.cloudstack.api.command.admin.network.UpdateStorageNetworkIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.offering.CreateDiskOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.offering.CreateServiceOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.offering.DeleteDiskOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.offering.DeleteServiceOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.offering.UpdateDiskOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.offering.UpdateServiceOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.pod.CreatePodCmd;\n+import org.apache.cloudstack.api.command.admin.pod.DeletePodCmd;\n+import org.apache.cloudstack.api.command.admin.pod.ListPodsByCmd;\n+import org.apache.cloudstack.api.command.admin.pod.UpdatePodCmd;\n+import org.apache.cloudstack.api.command.admin.region.AddRegionCmd;\n+import org.apache.cloudstack.api.command.admin.region.RemoveRegionCmd;\n+import org.apache.cloudstack.api.command.admin.region.UpdateRegionCmd;\n+import org.apache.cloudstack.api.command.admin.resource.ArchiveAlertsCmd;\n+import org.apache.cloudstack.api.command.admin.resource.DeleteAlertsCmd;\n+import org.apache.cloudstack.api.command.admin.resource.ListAlertsCmd;\n+import org.apache.cloudstack.api.command.admin.resource.ListCapacityCmd;\n+import org.apache.cloudstack.api.command.admin.resource.UploadCustomCertificateCmd;\n+import org.apache.cloudstack.api.command.admin.router.ConfigureVirtualRouterElementCmd;\n+import org.apache.cloudstack.api.command.admin.router.CreateVirtualRouterElementCmd;\n+import org.apache.cloudstack.api.command.admin.router.DestroyRouterCmd;\n+import org.apache.cloudstack.api.command.admin.router.ListRoutersCmd;\n+import org.apache.cloudstack.api.command.admin.router.ListVirtualRouterElementsCmd;\n+import org.apache.cloudstack.api.command.admin.router.RebootRouterCmd;\n+import org.apache.cloudstack.api.command.admin.router.StartRouterCmd;\n+import org.apache.cloudstack.api.command.admin.router.StopRouterCmd;\n+import org.apache.cloudstack.api.command.admin.router.UpgradeRouterCmd;\n+import org.apache.cloudstack.api.command.admin.storage.AddS3Cmd;\n+import org.apache.cloudstack.api.command.admin.storage.CancelPrimaryStorageMaintenanceCmd;\n+import org.apache.cloudstack.api.command.admin.storage.CreateStoragePoolCmd;\n+import org.apache.cloudstack.api.command.admin.storage.DeletePoolCmd;\n+import org.apache.cloudstack.api.command.admin.storage.FindStoragePoolsForMigrationCmd;\n+import org.apache.cloudstack.api.command.admin.storage.ListS3sCmd;\n+import org.apache.cloudstack.api.command.admin.storage.ListStoragePoolsCmd;\n+import org.apache.cloudstack.api.command.admin.storage.ListStorageProvidersCmd;\n+import org.apache.cloudstack.api.command.admin.storage.PreparePrimaryStorageForMaintenanceCmd;\n+import org.apache.cloudstack.api.command.admin.storage.UpdateStoragePoolCmd;\n+import org.apache.cloudstack.api.command.admin.swift.AddSwiftCmd;\n+import org.apache.cloudstack.api.command.admin.swift.ListSwiftsCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.DestroySystemVmCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.ListSystemVMsCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.MigrateSystemVMCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.RebootSystemVmCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.StartSystemVMCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.StopSystemVmCmd;\n+import org.apache.cloudstack.api.command.admin.systemvm.UpgradeSystemVMCmd;\n+import org.apache.cloudstack.api.command.admin.template.PrepareTemplateCmd;\n+import org.apache.cloudstack.api.command.admin.usage.AddTrafficMonitorCmd;\n+import org.apache.cloudstack.api.command.admin.usage.AddTrafficTypeCmd;\n+import org.apache.cloudstack.api.command.admin.usage.DeleteTrafficMonitorCmd;\n+import org.apache.cloudstack.api.command.admin.usage.DeleteTrafficTypeCmd;\n+import org.apache.cloudstack.api.command.admin.usage.GenerateUsageRecordsCmd;\n+import org.apache.cloudstack.api.command.admin.usage.GetUsageRecordsCmd;\n+import org.apache.cloudstack.api.command.admin.usage.ListTrafficMonitorsCmd;\n+import org.apache.cloudstack.api.command.admin.usage.ListTrafficTypeImplementorsCmd;\n+import org.apache.cloudstack.api.command.admin.usage.ListTrafficTypesCmd;\n+import org.apache.cloudstack.api.command.admin.usage.ListUsageTypesCmd;\n+import org.apache.cloudstack.api.command.admin.usage.UpdateTrafficTypeCmd;\n+import org.apache.cloudstack.api.command.admin.user.CreateUserCmd;\n+import org.apache.cloudstack.api.command.admin.user.DeleteUserCmd;\n+import org.apache.cloudstack.api.command.admin.user.DisableUserCmd;\n+import org.apache.cloudstack.api.command.admin.user.EnableUserCmd;\n+import org.apache.cloudstack.api.command.admin.user.GetUserCmd;\n+import org.apache.cloudstack.api.command.admin.user.ListUsersCmd;\n+import org.apache.cloudstack.api.command.admin.user.LockUserCmd;\n+import org.apache.cloudstack.api.command.admin.user.RegisterCmd;\n+import org.apache.cloudstack.api.command.admin.user.UpdateUserCmd;\n+import org.apache.cloudstack.api.command.admin.vlan.CreateVlanIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.vlan.DedicatePublicIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.vlan.DeleteVlanIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.vlan.ListVlanIpRangesCmd;\n+import org.apache.cloudstack.api.command.admin.vlan.ReleasePublicIpRangeCmd;\n+import org.apache.cloudstack.api.command.admin.vm.AssignVMCmd;\n+import org.apache.cloudstack.api.command.admin.vm.MigrateVMCmd;\n+import org.apache.cloudstack.api.command.admin.vm.MigrateVirtualMachineWithVolumeCmd;\n+import org.apache.cloudstack.api.command.admin.vm.RecoverVMCmd;\n+import org.apache.cloudstack.api.command.admin.vpc.CreatePrivateGatewayCmd;\n+import org.apache.cloudstack.api.command.admin.vpc.CreateVPCOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.vpc.DeletePrivateGatewayCmd;\n+import org.apache.cloudstack.api.command.admin.vpc.DeleteVPCOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.vpc.UpdateVPCOfferingCmd;\n+import org.apache.cloudstack.api.command.admin.zone.CreateZoneCmd;\n+import org.apache.cloudstack.api.command.admin.zone.DeleteZoneCmd;\n+import org.apache.cloudstack.api.command.admin.zone.MarkDefaultZoneForAccountCmd;\n+import org.apache.cloudstack.api.command.admin.zone.UpdateZoneCmd;\n+import org.apache.cloudstack.api.command.user.account.AddAccountToProjectCmd;\n+import org.apache.cloudstack.api.command.user.account.DeleteAccountFromProjectCmd;\n+import org.apache.cloudstack.api.command.user.account.ListAccountsCmd;\n+import org.apache.cloudstack.api.command.user.account.ListProjectAccountsCmd;\n+import org.apache.cloudstack.api.command.user.address.AssociateIPAddrCmd;\n+import org.apache.cloudstack.api.command.user.address.DisassociateIPAddrCmd;\n+import org.apache.cloudstack.api.command.user.address.ListPublicIpAddressesCmd;\n import org.apache.cloudstack.api.command.user.affinitygroup.CreateAffinityGroupCmd;\n import org.apache.cloudstack.api.command.user.affinitygroup.DeleteAffinityGroupCmd;\n import org.apache.cloudstack.api.command.user.affinitygroup.ListAffinityGroupTypesCmd;\n import org.apache.cloudstack.api.command.user.affinitygroup.ListAffinityGroupsCmd;\n import org.apache.cloudstack.api.command.user.affinitygroup.UpdateVMAffinityGroupCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.CreateAutoScalePolicyCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.CreateAutoScaleVmGroupCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.CreateAutoScaleVmProfileCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.CreateConditionCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.DeleteAutoScalePolicyCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.DeleteAutoScaleVmGroupCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.DeleteAutoScaleVmProfileCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.DeleteConditionCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.DisableAutoScaleVmGroupCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.EnableAutoScaleVmGroupCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.ListAutoScalePoliciesCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.ListAutoScaleVmGroupsCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.ListAutoScaleVmProfilesCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.ListConditionsCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.ListCountersCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.UpdateAutoScalePolicyCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.UpdateAutoScaleVmGroupCmd;\n+import org.apache.cloudstack.api.command.user.autoscale.UpdateAutoScaleVmProfileCmd;\n+import org.apache.cloudstack.api.command.user.config.ListCapabilitiesCmd;\n+import org.apache.cloudstack.api.command.user.event.ArchiveEventsCmd;\n+import org.apache.cloudstack.api.command.user.event.DeleteEventsCmd;\n+import org.apache.cloudstack.api.command.user.event.ListEventTypesCmd;\n+import org.apache.cloudstack.api.command.user.event.ListEventsCmd;\n+import org.apache.cloudstack.api.command.user.firewall.CreateEgressFirewallRuleCmd;\n+import org.apache.cloudstack.api.command.user.firewall.CreateFirewallRuleCmd;\n+import org.apache.cloudstack.api.command.user.firewall.CreatePortForwardingRuleCmd;\n+import org.apache.cloudstack.api.command.user.firewall.DeleteEgressFirewallRuleCmd;\n+import org.apache.cloudstack.api.command.user.firewall.DeleteFirewallRuleCmd;\n+import org.apache.cloudstack.api.command.user.firewall.DeletePortForwardingRuleCmd;\n+import org.apache.cloudstack.api.command.user.firewall.ListEgressFirewallRulesCmd;\n+import org.apache.cloudstack.api.command.user.firewall.ListFirewallRulesCmd;\n+import org.apache.cloudstack.api.command.user.firewall.ListPortForwardingRulesCmd;\n+import org.apache.cloudstack.api.command.user.firewall.UpdatePortForwardingRuleCmd;\n+import org.apache.cloudstack.api.command.user.guest.ListGuestOsCategoriesCmd;\n+import org.apache.cloudstack.api.command.user.guest.ListGuestOsCmd;\n+import org.apache.cloudstack.api.command.user.iso.AttachIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.CopyIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.DeleteIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.DetachIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.ExtractIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.ListIsoPermissionsCmd;\n+import org.apache.cloudstack.api.command.user.iso.ListIsosCmd;\n+import org.apache.cloudstack.api.command.user.iso.RegisterIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.UpdateIsoCmd;\n+import org.apache.cloudstack.api.command.user.iso.UpdateIsoPermissionsCmd;\n+import org.apache.cloudstack.api.command.user.job.ListAsyncJobsCmd;\n+import org.apache.cloudstack.api.command.user.job.QueryAsyncJobResultCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.AssignToLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.CreateApplicationLoadBalancerCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.CreateLBHealthCheckPolicyCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.CreateLBStickinessPolicyCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.CreateLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.DeleteApplicationLoadBalancerCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.DeleteLBHealthCheckPolicyCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.DeleteLBStickinessPolicyCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.DeleteLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListApplicationLoadBalancersCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLBHealthCheckPoliciesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLBStickinessPoliciesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLoadBalancerRuleInstancesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListLoadBalancerRulesCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.RemoveFromLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.loadbalancer.UpdateLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.nat.CreateIpForwardingRuleCmd;\n+import org.apache.cloudstack.api.command.user.nat.DeleteIpForwardingRuleCmd;\n+import org.apache.cloudstack.api.command.user.nat.DisableStaticNatCmd;\n+import org.apache.cloudstack.api.command.user.nat.EnableStaticNatCmd;\n+import org.apache.cloudstack.api.command.user.nat.ListIpForwardingRulesCmd;\n+import org.apache.cloudstack.api.command.user.network.CreateNetworkACLCmd;\n+import org.apache.cloudstack.api.command.user.network.CreateNetworkCmd;\n+import org.apache.cloudstack.api.command.user.network.DeleteNetworkACLCmd;\n+import org.apache.cloudstack.api.command.user.network.DeleteNetworkCmd;\n+import org.apache.cloudstack.api.command.user.network.ListNetworkACLsCmd;\n+import org.apache.cloudstack.api.command.user.network.ListNetworkOfferingsCmd;\n+import org.apache.cloudstack.api.command.user.network.ListNetworksCmd;\n+import org.apache.cloudstack.api.command.user.network.RestartNetworkCmd;\n+import org.apache.cloudstack.api.command.user.network.UpdateNetworkCmd;\n+import org.apache.cloudstack.api.command.user.offering.ListDiskOfferingsCmd;\n+import org.apache.cloudstack.api.command.user.offering.ListServiceOfferingsCmd;\n+import org.apache.cloudstack.api.command.user.project.ActivateProjectCmd;\n+import org.apache.cloudstack.api.command.user.project.CreateProjectCmd;\n+import org.apache.cloudstack.api.command.user.project.DeleteProjectCmd;\n+import org.apache.cloudstack.api.command.user.project.DeleteProjectInvitationCmd;\n+import org.apache.cloudstack.api.command.user.project.ListProjectInvitationsCmd;\n+import org.apache.cloudstack.api.command.user.project.ListProjectsCmd;\n+import org.apache.cloudstack.api.command.user.project.SuspendProjectCmd;\n+import org.apache.cloudstack.api.command.user.project.UpdateProjectCmd;\n+import org.apache.cloudstack.api.command.user.project.UpdateProjectInvitationCmd;\n+import org.apache.cloudstack.api.command.user.region.ListRegionsCmd;\n+import org.apache.cloudstack.api.command.user.region.ha.gslb.AssignToGlobalLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.region.ha.gslb.CreateGlobalLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.region.ha.gslb.DeleteGlobalLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.region.ha.gslb.ListGlobalLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.region.ha.gslb.RemoveFromGlobalLoadBalancerRuleCmd;\n+import org.apache.cloudstack.api.command.user.resource.GetCloudIdentifierCmd;\n+import org.apache.cloudstack.api.command.user.resource.ListHypervisorsCmd;\n+import org.apache.cloudstack.api.command.user.resource.ListResourceLimitsCmd;\n+import org.apache.cloudstack.api.command.user.resource.UpdateResourceCountCmd;\n+import org.apache.cloudstack.api.command.user.resource.UpdateResourceLimitCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.AuthorizeSecurityGroupEgressCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.AuthorizeSecurityGroupIngressCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.CreateSecurityGroupCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.DeleteSecurityGroupCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.ListSecurityGroupsCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.RevokeSecurityGroupEgressCmd;\n+import org.apache.cloudstack.api.command.user.securitygroup.RevokeSecurityGroupIngressCmd;\n+import org.apache.cloudstack.api.command.user.snapshot.CreateSnapshotCmd;\n+import org.apache.cloudstack.api.command.user.snapshot.CreateSnapshotPolicyCmd;\n+import org.apache.cloudstack.api.command.user.snapshot.DeleteSnapshotCmd;\n+import org.apache.cloudstack.api.command.user.snapshot.DeleteSnapshotPoliciesCmd;\n+import org.apache.cloudstack.api.command.user.snapshot.ListSnapshotPoliciesCmd;\n+import org.apache.cloudstack.api.command.user.snapshot.ListSnapshotsCmd;\n+import org.apache.cloudstack.api.command.user.ssh.CreateSSHKeyPairCmd;\n+import org.apache.cloudstack.api.command.user.ssh.DeleteSSHKeyPairCmd;\n+import org.apache.cloudstack.api.command.user.ssh.ListSSHKeyPairsCmd;\n+import org.apache.cloudstack.api.command.user.ssh.RegisterSSHKeyPairCmd;\n+import org.apache.cloudstack.api.command.user.tag.CreateTagsCmd;\n+import org.apache.cloudstack.api.command.user.tag.DeleteTagsCmd;\n+import org.apache.cloudstack.api.command.user.tag.ListTagsCmd;\n+import org.apache.cloudstack.api.command.user.template.CopyTemplateCmd;\n+import org.apache.cloudstack.api.command.user.template.CreateTemplateCmd;\n+import org.apache.cloudstack.api.command.user.template.DeleteTemplateCmd;\n+import org.apache.cloudstack.api.command.user.template.ExtractTemplateCmd;\n+import org.apache.cloudstack.api.command.user.template.ListTemplatePermissionsCmd;\n+import org.apache.cloudstack.api.command.user.template.ListTemplatesCmd;\n+import org.apache.cloudstack.api.command.user.template.RegisterTemplateCmd;\n+import org.apache.cloudstack.api.command.user.template.UpdateTemplateCmd;\n+import org.apache.cloudstack.api.command.user.template.UpdateTemplatePermissionsCmd;\n+import org.apache.cloudstack.api.command.user.vm.AddIpToVmNicCmd;\n+import org.apache.cloudstack.api.command.user.vm.AddNicToVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.DeployVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.DestroyVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.GetVMPasswordCmd;\n+import org.apache.cloudstack.api.command.user.vm.ListNicsCmd;\n+import org.apache.cloudstack.api.command.user.vm.ListVMsCmd;\n+import org.apache.cloudstack.api.command.user.vm.RebootVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.RemoveIpFromVmNicCmd;\n+import org.apache.cloudstack.api.command.user.vm.RemoveNicFromVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.ResetVMPasswordCmd;\n+import org.apache.cloudstack.api.command.user.vm.ResetVMSSHKeyCmd;\n+import org.apache.cloudstack.api.command.user.vm.RestoreVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.ScaleVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.StartVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.StopVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.UpdateDefaultNicForVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.UpdateVMCmd;\n+import org.apache.cloudstack.api.command.user.vm.UpgradeVMCmd;\n+import org.apache.cloudstack.api.command.user.vmgroup.CreateVMGroupCmd;\n+import org.apache.cloudstack.api.command.user.vmgroup.DeleteVMGroupCmd;\n+import org.apache.cloudstack.api.command.user.vmgroup.ListVMGroupsCmd;\n+import org.apache.cloudstack.api.command.user.vmgroup.UpdateVMGroupCmd;\n+import org.apache.cloudstack.api.command.user.vmsnapshot.CreateVMSnapshotCmd;\n+import org.apache.cloudstack.api.command.user.vmsnapshot.DeleteVMSnapshotCmd;\n+import org.apache.cloudstack.api.command.user.vmsnapshot.ListVMSnapshotCmd;\n+import org.apache.cloudstack.api.command.user.vmsnapshot.RevertToVMSnapshotCmd;\n+import org.apache.cloudstack.api.command.user.volume.AttachVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.CreateVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.DeleteVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.DetachVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.ExtractVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.ListVolumesCmd;\n+import org.apache.cloudstack.api.command.user.volume.MigrateVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.ResizeVolumeCmd;\n+import org.apache.cloudstack.api.command.user.volume.UploadVolumeCmd;\n+import org.apache.cloudstack.api.command.user.vpc.CreateStaticRouteCmd;\n+import org.apache.cloudstack.api.command.user.vpc.CreateVPCCmd;\n+import org.apache.cloudstack.api.command.user.vpc.DeleteStaticRouteCmd;\n+import org.apache.cloudstack.api.command.user.vpc.DeleteVPCCmd;\n+import org.apache.cloudstack.api.command.user.vpc.ListPrivateGatewaysCmd;\n+import org.apache.cloudstack.api.command.user.vpc.ListStaticRoutesCmd;\n+import org.apache.cloudstack.api.command.user.vpc.ListVPCOfferingsCmd;\n+import org.apache.cloudstack.api.command.user.vpc.ListVPCsCmd;\n+import org.apache.cloudstack.api.command.user.vpc.RestartVPCCmd;\n+import org.apache.cloudstack.api.command.user.vpc.UpdateVPCCmd;\n+import org.apache.cloudstack.api.command.user.vpn.AddVpnUserCmd;\n+import org.apache.cloudstack.api.command.user.vpn.CreateRemoteAccessVpnCmd;\n+import org.apache.cloudstack.api.command.user.vpn.CreateVpnConnectionCmd;\n+import org.apache.cloudstack.api.command.user.vpn.CreateVpnCustomerGatewayCmd;\n+import org.apache.cloudstack.api.command.user.vpn.CreateVpnGatewayCmd;\n+import org.apache.cloudstack.api.command.user.vpn.DeleteRemoteAccessVpnCmd;\n+import org.apache.cloudstack.api.command.user.vpn.DeleteVpnConnectionCmd;\n+import org.apache.cloudstack.api.command.user.vpn.DeleteVpnCustomerGatewayCmd;\n+import org.apache.cloudstack.api.command.user.vpn.DeleteVpnGatewayCmd;\n+import org.apache.cloudstack.api.command.user.vpn.ListRemoteAccessVpnsCmd;\n+import org.apache.cloudstack.api.command.user.vpn.ListVpnConnectionsCmd;\n+import org.apache.cloudstack.api.command.user.vpn.ListVpnCustomerGatewaysCmd;\n+import org.apache.cloudstack.api.command.user.vpn.ListVpnGatewaysCmd;\n+import org.apache.cloudstack.api.command.user.vpn.ListVpnUsersCmd;\n+import org.apache.cloudstack.api.command.user.vpn.RemoveVpnUserCmd;\n+import org.apache.cloudstack.api.command.user.vpn.ResetVpnConnectionCmd;\n+import org.apache.cloudstack.api.command.user.vpn.UpdateVpnCustomerGatewayCmd;\n+import org.apache.cloudstack.api.command.user.zone.ListZonesByCmd;\n+import org.apache.cloudstack.api.response.ExtractResponse;\n+import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreManager;\n+import org.apache.cloudstack.engine.subsystem.api.storage.StoragePoolAllocator;\n+import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n+import org.apache.cloudstack.storage.datastore.db.StoragePoolVO;\n+import org.apache.commons.codec.binary.Base64;\n+import org.apache.log4j.Logger;\n+\n import com.cloud.agent.AgentManager;\n import com.cloud.agent.api.GetVncPortAnswer;\n import com.cloud.agent.api.GetVncPortCommand;\n@@ -103,28 +421,53 @@\n import com.cloud.alert.AlertVO;\n import com.cloud.alert.dao.AlertDao;\n import com.cloud.api.ApiDBUtils;\n-import com.cloud.async.*;\n+import com.cloud.async.AsyncJobExecutor;\n+import com.cloud.async.AsyncJobManager;\n+import com.cloud.async.AsyncJobResult;\n+import com.cloud.async.AsyncJobVO;\n+import com.cloud.async.BaseAsyncJobExecutor;\n import com.cloud.capacity.Capacity;\n import com.cloud.capacity.CapacityVO;\n import com.cloud.capacity.dao.CapacityDao;\n import com.cloud.capacity.dao.CapacityDaoImpl.SummedCapacity;\n import com.cloud.cluster.ClusterManager;\n+import com.cloud.configuration.Config;\n+import com.cloud.configuration.Configuration;\n+import com.cloud.configuration.ConfigurationManager;\n+import com.cloud.configuration.ConfigurationVO;\n import com.cloud.configuration.dao.ConfigurationDao;\n import com.cloud.consoleproxy.ConsoleProxyManagementState;\n import com.cloud.consoleproxy.ConsoleProxyManager;\n-import com.cloud.dc.*;\n+import com.cloud.dc.AccountVlanMapVO;\n+import com.cloud.dc.ClusterVO;\n+import com.cloud.dc.DataCenterVO;\n+import com.cloud.dc.HostPodVO;\n+import com.cloud.dc.Pod;\n+import com.cloud.dc.PodVlanMapVO;\n+import com.cloud.dc.Vlan;\n import com.cloud.dc.Vlan.VlanType;\n-import com.cloud.dc.dao.*;\n+import com.cloud.dc.VlanVO;\n+import com.cloud.dc.dao.AccountVlanMapDao;\n+import com.cloud.dc.dao.ClusterDao;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.dc.dao.HostPodDao;\n+import com.cloud.dc.dao.PodVlanMapDao;\n+import com.cloud.dc.dao.VlanDao;\n import com.cloud.deploy.DataCenterDeployment;\n-import com.cloud.deploy.DeploymentPlanner;\n import com.cloud.deploy.DeploymentPlanner.ExcludeList;\n import com.cloud.domain.DomainVO;\n import com.cloud.domain.dao.DomainDao;\n import com.cloud.event.ActionEvent;\n+import com.cloud.event.ActionEventUtils;\n import com.cloud.event.EventTypes;\n import com.cloud.event.EventVO;\n import com.cloud.event.dao.EventDao;\n-import com.cloud.exception.*;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.OperationTimedoutException;\n+import com.cloud.exception.PermissionDeniedException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.exception.StorageUnavailableException;\n import com.cloud.ha.HighAvailabilityManager;\n import com.cloud.host.DetailVO;\n import com.cloud.host.Host;\n@@ -141,7 +484,12 @@\n import com.cloud.info.ConsoleProxyInfo;\n import com.cloud.keystore.KeystoreManager;\n import com.cloud.network.IpAddress;\n-import com.cloud.network.dao.*;\n+import com.cloud.network.dao.IPAddressDao;\n+import com.cloud.network.dao.IPAddressVO;\n+import com.cloud.network.dao.LoadBalancerDao;\n+import com.cloud.network.dao.LoadBalancerVO;\n+import com.cloud.network.dao.NetworkDao;\n+import com.cloud.network.dao.NetworkVO;\n import com.cloud.org.Cluster;\n import com.cloud.org.Grouping.AllocationState;\n import com.cloud.projects.Project;\n@@ -150,11 +498,29 @@\n import com.cloud.resource.ResourceManager;\n import com.cloud.server.ResourceTag.TaggedResourceType;\n import com.cloud.server.auth.UserAuthenticator;\n-import com.cloud.service.ServiceOfferingVO;\n import com.cloud.service.dao.ServiceOfferingDao;\n-import com.cloud.storage.*;\n+import com.cloud.storage.DiskOfferingVO;\n+import com.cloud.storage.GuestOS;\n+import com.cloud.storage.GuestOSCategoryVO;\n+import com.cloud.storage.GuestOSVO;\n+import com.cloud.storage.GuestOsCategory;\n+import com.cloud.storage.Storage;\n import com.cloud.storage.Storage.ImageFormat;\n+import com.cloud.storage.StorageManager;\n+import com.cloud.storage.StoragePool;\n+import com.cloud.storage.Upload;\n import com.cloud.storage.Upload.Mode;\n+import com.cloud.storage.UploadVO;\n+import com.cloud.storage.VMTemplateVO;\n+import com.cloud.storage.Volume;\n+import com.cloud.storage.VolumeManager;\n+import com.cloud.storage.VolumeVO;\n+import com.cloud.storage.dao.DiskOfferingDao;\n+import com.cloud.storage.dao.GuestOSCategoryDao;\n+import com.cloud.storage.dao.GuestOSDao;\n+import com.cloud.storage.dao.UploadDao;\n+import com.cloud.storage.dao.VMTemplateDao;\n+import com.cloud.storage.dao.VolumeDao;\n import com.cloud.storage.s3.S3Manager;\n import com.cloud.storage.secondary.SecondaryStorageVmManager;\n import com.cloud.storage.snapshot.SnapshotManager;\n@@ -164,7 +530,13 @@\n import com.cloud.tags.dao.ResourceTagDao;\n import com.cloud.template.TemplateManager;\n import com.cloud.template.VirtualMachineTemplate.TemplateFilter;\n-import com.cloud.user.*;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.SSHKeyPair;\n+import com.cloud.user.SSHKeyPairVO;\n+import com.cloud.user.User;\n+import com.cloud.user.UserContext;\n+import com.cloud.user.UserVO;\n import com.cloud.user.dao.AccountDao;\n import com.cloud.user.dao.SSHKeyPairDao;\n import com.cloud.user.dao.UserDao;\n@@ -177,91 +549,39 @@\n import com.cloud.utils.component.ManagerBase;\n import com.cloud.utils.concurrency.NamedThreadFactory;\n import com.cloud.utils.crypt.DBEncryptionUtil;\n-import com.cloud.utils.db.*;\n+import com.cloud.utils.db.DB;\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.GlobalLock;\n+import com.cloud.utils.db.JoinBuilder;\n import com.cloud.utils.db.JoinBuilder.JoinType;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.utils.net.MacAddress;\n import com.cloud.utils.net.NetUtils;\n import com.cloud.utils.ssh.SSHKeysHelper;\n-import com.cloud.vm.*;\n+import com.cloud.vm.ConsoleProxyVO;\n+import com.cloud.vm.DiskProfile;\n+import com.cloud.vm.InstanceGroupVO;\n+import com.cloud.vm.SecondaryStorageVmVO;\n+import com.cloud.vm.UserVmVO;\n+import com.cloud.vm.VMInstanceVO;\n+import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachine.State;\n-import com.cloud.vm.dao.*;\n+import com.cloud.vm.VirtualMachineManager;\n+import com.cloud.vm.VirtualMachineProfile;\n+import com.cloud.vm.VirtualMachineProfileImpl;\n+import com.cloud.vm.dao.ConsoleProxyDao;\n+import com.cloud.vm.dao.DomainRouterDao;\n+import com.cloud.vm.dao.InstanceGroupDao;\n+import com.cloud.vm.dao.SecondaryStorageVmDao;\n+import com.cloud.vm.dao.UserVmDao;\n+import com.cloud.vm.dao.VMInstanceDao;\n+\n import edu.emory.mathcs.backport.java.util.Arrays;\n import edu.emory.mathcs.backport.java.util.Collections;\n-import org.apache.cloudstack.acl.ControlledEntity;\n-import org.apache.cloudstack.api.command.admin.autoscale.CreateCounterCmd;\n-import org.apache.cloudstack.api.command.admin.autoscale.DeleteCounterCmd;\n-import org.apache.cloudstack.api.command.admin.cluster.AddClusterCmd;\n-import org.apache.cloudstack.api.command.admin.cluster.DeleteClusterCmd;\n-import org.apache.cloudstack.api.command.admin.cluster.ListClustersCmd;\n-import org.apache.cloudstack.api.command.admin.cluster.UpdateClusterCmd;\n-import org.apache.cloudstack.api.command.admin.config.ListCfgsByCmd;\n-import org.apache.cloudstack.api.command.admin.config.ListHypervisorCapabilitiesCmd;\n-import org.apache.cloudstack.api.command.admin.config.UpdateCfgCmd;\n-import org.apache.cloudstack.api.command.admin.config.UpdateHypervisorCapabilitiesCmd;\n-import org.apache.cloudstack.api.command.admin.ldap.LDAPConfigCmd;\n-import org.apache.cloudstack.api.command.admin.ldap.LDAPRemoveCmd;\n-import org.apache.cloudstack.api.command.admin.pod.CreatePodCmd;\n-import org.apache.cloudstack.api.command.admin.pod.DeletePodCmd;\n-import org.apache.cloudstack.api.command.admin.pod.ListPodsByCmd;\n-import org.apache.cloudstack.api.command.admin.pod.UpdatePodCmd;\n-import org.apache.cloudstack.api.command.admin.region.AddRegionCmd;\n-import org.apache.cloudstack.api.command.admin.region.RemoveRegionCmd;\n-import org.apache.cloudstack.api.command.admin.region.UpdateRegionCmd;\n-import org.apache.cloudstack.api.command.admin.swift.AddSwiftCmd;\n-import org.apache.cloudstack.api.command.admin.swift.ListSwiftsCmd;\n-import org.apache.cloudstack.api.command.admin.template.PrepareTemplateCmd;\n-import org.apache.cloudstack.api.command.admin.vlan.CreateVlanIpRangeCmd;\n-import org.apache.cloudstack.api.command.admin.vlan.DeleteVlanIpRangeCmd;\n-import org.apache.cloudstack.api.command.admin.vlan.ListVlanIpRangesCmd;\n-import org.apache.cloudstack.api.command.admin.vm.AssignVMCmd;\n-import org.apache.cloudstack.api.command.admin.vm.MigrateVMCmd;\n-import org.apache.cloudstack.api.command.admin.vm.MigrateVirtualMachineWithVolumeCmd;\n-import org.apache.cloudstack.api.command.admin.vm.RecoverVMCmd;\n-import org.apache.cloudstack.api.command.admin.zone.CreateZoneCmd;\n-import org.apache.cloudstack.api.command.admin.zone.DeleteZoneCmd;\n-import org.apache.cloudstack.api.command.admin.zone.MarkDefaultZoneForAccountCmd;\n-import org.apache.cloudstack.api.command.admin.zone.UpdateZoneCmd;\n-import org.apache.cloudstack.api.command.user.account.AddAccountToProjectCmd;\n-import org.apache.cloudstack.api.command.user.account.DeleteAccountFromProjectCmd;\n-import org.apache.cloudstack.api.command.user.account.ListAccountsCmd;\n-import org.apache.cloudstack.api.command.user.account.ListProjectAccountsCmd;\n-import org.apache.cloudstack.api.command.user.address.AssociateIPAddrCmd;\n-import org.apache.cloudstack.api.command.user.address.DisassociateIPAddrCmd;\n-import org.apache.cloudstack.api.command.user.address.ListPublicIpAddressesCmd;\n-import org.apache.cloudstack.api.command.user.config.ListCapabilitiesCmd;\n-import org.apache.cloudstack.api.command.user.event.ArchiveEventsCmd;\n-import org.apache.cloudstack.api.command.user.event.DeleteEventsCmd;\n-import org.apache.cloudstack.api.command.user.event.ListEventTypesCmd;\n-import org.apache.cloudstack.api.command.user.event.ListEventsCmd;\n-import org.apache.cloudstack.api.command.user.guest.ListGuestOsCategoriesCmd;\n-import org.apache.cloudstack.api.command.user.guest.ListGuestOsCmd;\n-import org.apache.cloudstack.api.command.user.job.ListAsyncJobsCmd;\n-import org.apache.cloudstack.api.command.user.job.QueryAsyncJobResultCmd;\n-import org.apache.cloudstack.api.command.user.offering.ListDiskOfferingsCmd;\n-import org.apache.cloudstack.api.command.user.offering.ListServiceOfferingsCmd;\n-import org.apache.cloudstack.api.command.user.region.ListRegionsCmd;\n-import org.apache.cloudstack.api.command.user.region.ha.gslb.*;\n-import org.apache.cloudstack.api.command.user.ssh.CreateSSHKeyPairCmd;\n-import org.apache.cloudstack.api.command.user.ssh.DeleteSSHKeyPairCmd;\n-import org.apache.cloudstack.api.command.user.ssh.ListSSHKeyPairsCmd;\n-import org.apache.cloudstack.api.command.user.ssh.RegisterSSHKeyPairCmd;\n-import org.apache.cloudstack.api.command.user.tag.CreateTagsCmd;\n-import org.apache.cloudstack.api.command.user.tag.DeleteTagsCmd;\n-import org.apache.cloudstack.api.command.user.tag.ListTagsCmd;\n-import org.apache.cloudstack.api.command.user.vmgroup.CreateVMGroupCmd;\n-import org.apache.cloudstack.api.command.user.vmgroup.DeleteVMGroupCmd;\n-import org.apache.cloudstack.api.command.user.vmgroup.ListVMGroupsCmd;\n-import org.apache.cloudstack.api.command.user.vmgroup.UpdateVMGroupCmd;\n-import org.apache.cloudstack.api.command.user.vmsnapshot.CreateVMSnapshotCmd;\n-import org.apache.cloudstack.api.command.user.vmsnapshot.DeleteVMSnapshotCmd;\n-import org.apache.cloudstack.api.command.user.vmsnapshot.ListVMSnapshotCmd;\n-import org.apache.cloudstack.api.command.user.vmsnapshot.RevertToVMSnapshotCmd;\n-import org.apache.cloudstack.api.command.user.zone.ListZonesByCmd;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreManager;\n-import org.apache.cloudstack.engine.subsystem.api.storage.StoragePoolAllocator;\n-import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n-import org.apache.cloudstack.storage.datastore.db.StoragePoolVO;\n+\n \n public class ManagementServerImpl extends ManagerBase implements ManagementServer {\n     public static final Logger s_logger = Logger.getLogger(ManagementServerImpl.class.getName());\n@@ -2542,11 +2862,21 @@ public static boolean isAdmin(short accountType) {\n         cmdList.add(AssignToGlobalLoadBalancerRuleCmd.class);\n         cmdList.add(RemoveFromGlobalLoadBalancerRuleCmd.class);\n         cmdList.add(ListStorageProvidersCmd.class);\n+        cmdList.add(CreateApplicationLoadBalancerCmd.class);\n+        cmdList.add(ListApplicationLoadBalancersCmd.class);\n+        cmdList.add(DeleteApplicationLoadBalancerCmd.class);\n+        cmdList.add(ConfigureInternalLoadBalancerElementCmd.class);\n+        cmdList.add(CreateInternalLoadBalancerElementCmd.class);\n+        cmdList.add(ListInternalLoadBalancerElementsCmd.class);\n         cmdList.add(CreateAffinityGroupCmd.class);\n         cmdList.add(DeleteAffinityGroupCmd.class);\n         cmdList.add(ListAffinityGroupsCmd.class);\n         cmdList.add(UpdateVMAffinityGroupCmd.class);\n         cmdList.add(ListAffinityGroupTypesCmd.class);\n+        cmdList.add(StopInternalLBVMCmd.class);\n+        cmdList.add(StartInternalLBVMCmd.class);\n+        cmdList.add(ListInternalLBVMsCmd.class);\n+        cmdList.add(ListNetworkIsolationMethodsCmd.class);\n         cmdList.add(ListNetworkIsolationMethodsCmd.class);\n \n         return cmdList;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "86c1a640da91ce5e2a5fb6c297b826b9113d515b",
                "status": "modified"
            },
            {
                "additions": 524,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerManagerImpl.java",
                "changes": 524,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerManagerImpl.java",
                "patch": "@@ -0,0 +1,524 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.network.lb;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.acl.SecurityChecker.AccessType;\n+import org.apache.cloudstack.api.command.user.loadbalancer.ListApplicationLoadBalancersCmd;\n+import org.apache.cloudstack.lb.ApplicationLoadBalancerRuleVO;\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloud.event.ActionEvent;\n+import com.cloud.event.EventTypes;\n+import com.cloud.event.UsageEventUtils;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientVirtualNetworkCapcityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.NetworkRuleConflictException;\n+import com.cloud.exception.UnsupportedServiceException;\n+import com.cloud.network.Network;\n+import com.cloud.network.Network.Capability;\n+import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.dao.FirewallRulesDao;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.lb.LoadBalancingRule.LbDestination;\n+import com.cloud.network.lb.LoadBalancingRule.LbHealthCheckPolicy;\n+import com.cloud.network.lb.LoadBalancingRule.LbStickinessPolicy;\n+import com.cloud.network.lb.LoadBalancingRulesManager;\n+import com.cloud.network.rules.FirewallRule.State;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.projects.Project.ListProjectResourcesCriteria;\n+import com.cloud.server.ResourceTag.TaggedResourceType;\n+import com.cloud.tags.ResourceTagVO;\n+import com.cloud.tags.dao.ResourceTagDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.UserContext;\n+import com.cloud.utils.Pair;\n+import com.cloud.utils.Ternary;\n+import com.cloud.utils.component.ManagerBase;\n+import com.cloud.utils.db.DB;\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.JoinBuilder;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.utils.net.NetUtils;\n+\n+@Component\n+@Local(value = { ApplicationLoadBalancerService.class })\n+public class ApplicationLoadBalancerManagerImpl extends ManagerBase implements ApplicationLoadBalancerService {\n+    private static final Logger s_logger = Logger.getLogger(ApplicationLoadBalancerManagerImpl.class);\n+    \n+    @Inject NetworkModel _networkModel;\n+    @Inject ApplicationLoadBalancerRuleDao _lbDao;\n+    @Inject AccountManager _accountMgr;\n+    @Inject LoadBalancingRulesManager _lbMgr;\n+    @Inject FirewallRulesDao _firewallDao;\n+    @Inject ResourceTagDao _resourceTagDao;\n+    @Inject NetworkManager _ntwkMgr;\n+    \n+    \n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_LOAD_BALANCER_CREATE, eventDescription = \"creating load balancer\")\n+    public ApplicationLoadBalancerRule createApplicationLoadBalancer(String name, String description, Scheme scheme, long sourceIpNetworkId, String sourceIp,\n+            int sourcePort, int instancePort, String algorithm, long networkId, long lbOwnerId) throws InsufficientAddressCapacityException,\n+            NetworkRuleConflictException, InsufficientVirtualNetworkCapcityException {\n+        \n+        //Validate LB rule guest network\n+        Network guestNtwk = _networkModel.getNetwork(networkId);\n+        if (guestNtwk == null || guestNtwk.getTrafficType() != TrafficType.Guest) {\n+            throw new InvalidParameterValueException(\"Can't find guest network by id\");\n+        }\n+        \n+        Account caller = UserContext.current().getCaller();\n+        _accountMgr.checkAccess(caller, AccessType.UseNetwork, false, guestNtwk);\n+        \n+        Network sourceIpNtwk = _networkModel.getNetwork(sourceIpNetworkId);\n+        if (sourceIpNtwk == null) {\n+            throw new InvalidParameterValueException(\"Can't find source ip network by id\");\n+        }\n+        \n+        Account lbOwner = _accountMgr.getAccount(lbOwnerId);\n+        if (lbOwner == null) {\n+            throw new InvalidParameterValueException(\"Can't find the lb owner account\");\n+        }\n+        \n+        return createApplicationLoadBalancer(name, description, scheme, sourceIpNtwk, sourceIp, sourcePort, instancePort, algorithm, lbOwner, guestNtwk);\n+    }\n+\n+    \n+    protected ApplicationLoadBalancerRule createApplicationLoadBalancer(String name, String description, Scheme scheme, Network sourceIpNtwk, String sourceIp, int sourcePort, int instancePort, String algorithm,\n+            Account lbOwner, Network guestNtwk) throws NetworkRuleConflictException, InsufficientVirtualNetworkCapcityException {\n+        \n+        //Only Internal scheme is supported in this release\n+        if (scheme != Scheme.Internal) {\n+            throw new UnsupportedServiceException(\"Only scheme of type \" + Scheme.Internal + \" is supported\");\n+        }\n+        \n+        //1) Validate LB rule's parameters\n+        validateLbRule(sourcePort, instancePort, algorithm, guestNtwk, scheme);\n+        \n+        //2) Validate source network\n+        validateSourceIpNtwkForLbRule(sourceIpNtwk, scheme);\n+        \n+        //3) Get source ip address\n+        Ip sourceIpAddr = getSourceIp(scheme, sourceIpNtwk, sourceIp);\n+               \n+        ApplicationLoadBalancerRuleVO newRule = new ApplicationLoadBalancerRuleVO(name, description, sourcePort, instancePort, algorithm, guestNtwk.getId(),\n+                lbOwner.getId(), lbOwner.getDomainId(), sourceIpAddr, sourceIpNtwk.getId(), scheme);\n+        \n+        //4) Validate Load Balancing rule on the providers\n+        LoadBalancingRule loadBalancing = new LoadBalancingRule(newRule, new ArrayList<LbDestination>(),\n+                new ArrayList<LbStickinessPolicy>(), new ArrayList<LbHealthCheckPolicy>(), sourceIpAddr);\n+        if (!_lbMgr.validateLbRule(loadBalancing)) {\n+            throw new InvalidParameterValueException(\"LB service provider cannot support this rule\");\n+        }\n+\n+        //5) Persist Load Balancer rule\n+        return persistLbRule(newRule);\n+    }\n+\n+    \n+    @DB\n+    protected ApplicationLoadBalancerRule persistLbRule(ApplicationLoadBalancerRuleVO newRule) throws NetworkRuleConflictException {\n+        \n+        Transaction txn = Transaction.currentTxn();\n+        txn.start();\n+        \n+        //1) Persist the rule\n+        newRule = _lbDao.persist(newRule);\n+        boolean success = true;\n+\n+        try {\n+            //2) Detect conflicts\n+            detectLbRulesConflicts(newRule);\n+            if (!_firewallDao.setStateToAdd(newRule)) {\n+                throw new CloudRuntimeException(\"Unable to update the state to add for \" + newRule);\n+            }\n+            s_logger.debug(\"Load balancer \" + newRule.getId() + \" for Ip address \" + newRule.getSourceIp().addr() + \", source port \"\n+                    + newRule.getSourcePortStart() + \", instance port \" + newRule.getDefaultPortStart() + \" is added successfully.\");\n+            UserContext.current().setEventDetails(\"Load balancer Id: \" + newRule.getId());\n+            Network ntwk = _networkModel.getNetwork(newRule.getNetworkId());\n+            UsageEventUtils.publishUsageEvent(EventTypes.EVENT_LOAD_BALANCER_CREATE, newRule.getAccountId(),\n+                    ntwk.getDataCenterId(), newRule.getId(), null, LoadBalancingRule.class.getName(),\n+                    newRule.getUuid());\n+            txn.commit();\n+\n+            return newRule;\n+        } catch (Exception e) {\n+            success = false;\n+            if (e instanceof NetworkRuleConflictException) {\n+                throw (NetworkRuleConflictException) e;\n+            }\n+            throw new CloudRuntimeException(\"Unable to add lb rule for ip address \" + newRule.getSourceIpAddressId(), e);\n+        } finally {\n+            if (!success && newRule != null) {\n+                _lbMgr.removeLBRule(newRule);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Validates Lb rule parameters\n+     * @param sourcePort\n+     * @param instancePort\n+     * @param algorithm\n+     * @param network\n+     * @param scheme TODO\n+     * @param networkId\n+     */\n+    protected void validateLbRule(int sourcePort, int instancePort, String algorithm, Network network, Scheme scheme) {\n+        //1) verify that lb service is supported by the network\n+        if (!_networkModel.areServicesSupportedInNetwork(network.getId(), Service.Lb)) {\n+            InvalidParameterValueException ex = new InvalidParameterValueException(\n+                    \"LB service is not supported in specified network id\");\n+            ex.addProxyObject(network, network.getId(), \"networkId\");\n+            throw ex;\n+        }\n+        \n+        //2) verify that lb service is supported by the network\n+        _lbMgr.isLbServiceSupportedInNetwork(network.getId(), scheme);\n+        \n+        Map<Network.Capability, String> caps = _networkModel.getNetworkServiceCapabilities(network.getId(), Service.Lb);\n+        String supportedProtocols = caps.get(Capability.SupportedProtocols).toLowerCase();\n+        if (!supportedProtocols.contains(NetUtils.TCP_PROTO.toLowerCase())) {\n+            throw new InvalidParameterValueException(\"Protocol \" + NetUtils.TCP_PROTO.toLowerCase() + \" is not supported in zone \" + network.getDataCenterId());\n+        }\n+        \n+        //3) Validate rule parameters\n+        if (!NetUtils.isValidPort(instancePort)) {\n+            throw new InvalidParameterValueException(\"Invalid value for instance port: \" + instancePort);\n+        }\n+        \n+        if (!NetUtils.isValidPort(sourcePort)) {\n+            throw new InvalidParameterValueException(\"Invalid value for source port: \" + sourcePort);\n+        }\n+       \n+        if ((algorithm == null) || !NetUtils.isValidAlgorithm(algorithm)) {\n+            throw new InvalidParameterValueException(\"Invalid algorithm: \" + algorithm);\n+        }\n+    }\n+    \n+\n+    /**\n+     * Gets source ip address based on the LB rule scheme/source IP network/requested IP address\n+     * @param scheme\n+     * @param sourceIpNtwk\n+     * @param requestedIp\n+     * @return\n+     * @throws InsufficientVirtualNetworkCapcityException\n+     */\n+    protected Ip getSourceIp(Scheme scheme, Network sourceIpNtwk, String requestedIp) throws InsufficientVirtualNetworkCapcityException {       \n+        \n+        if (requestedIp != null) {\n+            if (_lbDao.countBySourceIp(new Ip(requestedIp), sourceIpNtwk.getId()) > 0)  {\n+                s_logger.debug(\"IP address \" + requestedIp + \" is already used by existing LB rule, returning it\");\n+                return new Ip(requestedIp);\n+            }\n+            \n+            validateRequestedSourceIpForLbRule(sourceIpNtwk, new Ip(requestedIp), scheme);\n+        }\n+        \n+        requestedIp = allocateSourceIpForLbRule(scheme, sourceIpNtwk, requestedIp);\n+        \n+        if (requestedIp == null) {\n+            throw new InsufficientVirtualNetworkCapcityException(\"Unable to acquire IP address for network \" + sourceIpNtwk, Network.class, sourceIpNtwk.getId());\n+        }\n+        return new Ip(requestedIp);\n+    }\n+\n+\n+    /**\n+     * Allocates new Source IP address for the Load Balancer rule based on LB rule scheme/sourceNetwork\n+     * @param scheme\n+     * @param sourceIpNtwk\n+     * @param requestedIp TODO\n+     * @param sourceIp\n+     * @return\n+     */\n+    protected String allocateSourceIpForLbRule(Scheme scheme, Network sourceIpNtwk, String requestedIp) {\n+        String sourceIp = null;\n+        if (scheme != Scheme.Internal) {\n+            throw new InvalidParameterValueException(\"Only scheme \" + Scheme.Internal + \" is supported\");\n+        } else {\n+            sourceIp = allocateSourceIpForInternalLbRule(sourceIpNtwk, requestedIp);\n+        }\n+        return sourceIp;\n+    }\n+    \n+\n+    /**\n+     * Allocates sourceIp for the Internal LB rule\n+     * @param sourceIpNtwk\n+     * @param requestedIp TODO\n+     * @return\n+     */\n+    protected String allocateSourceIpForInternalLbRule(Network sourceIpNtwk, String requestedIp) {\n+        return _ntwkMgr.acquireGuestIpAddress(sourceIpNtwk, requestedIp);\n+    }\n+\n+    \n+    /**\n+     * Validates requested source ip address of the LB rule based on Lb rule scheme/sourceNetwork\n+     * @param sourceIpNtwk\n+     * @param requestedSourceIp\n+     * @param scheme\n+     */\n+    void validateRequestedSourceIpForLbRule(Network sourceIpNtwk, Ip requestedSourceIp, Scheme scheme) {\n+        //only Internal scheme is supported in this release\n+        if (scheme != Scheme.Internal) {\n+            throw new UnsupportedServiceException(\"Only scheme of type \" + Scheme.Internal + \" is supported\");\n+        } else {\n+            //validate guest source ip\n+            validateRequestedSourceIpForInternalLbRule(sourceIpNtwk, requestedSourceIp);\n+        }\n+    }\n+\n+    \n+    /**\n+     * Validates requested source IP address of Internal Lb rule against sourceNetworkId\n+     * @param sourceIpNtwk\n+     * @param requestedSourceIp\n+     */\n+    protected void validateRequestedSourceIpForInternalLbRule(Network sourceIpNtwk, Ip requestedSourceIp) {\n+        //Check if the IP is within the network cidr\n+        Pair<String, Integer> cidr = NetUtils.getCidr(sourceIpNtwk.getCidr());\n+        if (!NetUtils.getCidrSubNet(requestedSourceIp.addr(), cidr.second()).equalsIgnoreCase(NetUtils.getCidrSubNet(cidr.first(), cidr.second()))) {\n+            throw new InvalidParameterValueException(\"The requested IP is not in the network's CIDR subnet.\");\n+        }\n+    }\n+\n+    \n+    /**\n+     * Validates source IP network for the LB rule\n+     * @param sourceNtwk\n+     * @param scheme\n+     * @return\n+     */\n+    protected Network validateSourceIpNtwkForLbRule(Network sourceNtwk, Scheme scheme) {\n+        //only Internal scheme is supported in this release\n+        if (scheme != Scheme.Internal) {\n+            throw new UnsupportedServiceException(\"Only scheme of type \" + Scheme.Internal + \" is supported\");\n+        } else {\n+            //validate source ip network\n+            return validateSourceIpNtwkForInternalLbRule(sourceNtwk);\n+        }\n+        \n+    }\n+\n+    /**\n+     * Validates source IP network for the Internal LB rule\n+     * @param sourceIpNtwk\n+     * @return\n+     */\n+    protected Network validateSourceIpNtwkForInternalLbRule(Network sourceIpNtwk) {\n+        if (sourceIpNtwk.getTrafficType() != TrafficType.Guest) {\n+            throw new InvalidParameterValueException(\"Only traffic type \" + TrafficType.Guest + \" is supported\");\n+        } \n+        \n+        //Can't create the LB rule if the network's cidr is NULL\n+        String ntwkCidr = sourceIpNtwk.getCidr();\n+        if (ntwkCidr == null) {\n+            throw new InvalidParameterValueException(\"Can't create the application load balancer rule for the network having NULL cidr\");\n+        }\n+        \n+        //check if the requested ip address is within the cidr\n+        return sourceIpNtwk;\n+    }\n+\n+    \n+    @Override\n+    public boolean deleteApplicationLoadBalancer(long id) {\n+        return _lbMgr.deleteLoadBalancerRule(id, true);\n+    }\n+\n+    @Override\n+    public Pair<List<? extends ApplicationLoadBalancerRule>, Integer> listApplicationLoadBalancers(ListApplicationLoadBalancersCmd cmd) {\n+        Long id = cmd.getId();\n+        String name = cmd.getLoadBalancerRuleName();\n+        String ip = cmd.getSourceIp();\n+        Long ipNtwkId = cmd.getSourceIpNetworkId();\n+        String keyword = cmd.getKeyword();\n+        Scheme scheme = cmd.getScheme();\n+        Long networkId = cmd.getNetworkId();\n+        \n+        Map<String, String> tags = cmd.getTags();\n+\n+        Account caller = UserContext.current().getCaller();\n+        List<Long> permittedAccounts = new ArrayList<Long>();\n+\n+        Ternary<Long, Boolean, ListProjectResourcesCriteria> domainIdRecursiveListProject = new Ternary<Long, Boolean, ListProjectResourcesCriteria>(\n+                cmd.getDomainId(), cmd.isRecursive(), null);\n+        _accountMgr.buildACLSearchParameters(caller, id, cmd.getAccountName(), cmd.getProjectId(), permittedAccounts,\n+                domainIdRecursiveListProject, cmd.listAll(), false);\n+        Long domainId = domainIdRecursiveListProject.first();\n+        Boolean isRecursive = domainIdRecursiveListProject.second();\n+        ListProjectResourcesCriteria listProjectResourcesCriteria = domainIdRecursiveListProject.third();\n+\n+        Filter searchFilter = new Filter(ApplicationLoadBalancerRuleVO.class, \"id\", true, cmd.getStartIndex(), cmd.getPageSizeVal());\n+        SearchBuilder<ApplicationLoadBalancerRuleVO> sb = _lbDao.createSearchBuilder();\n+        _accountMgr.buildACLSearchBuilder(sb, domainId, isRecursive, permittedAccounts, listProjectResourcesCriteria);\n+\n+        sb.and(\"id\", sb.entity().getId(), SearchCriteria.Op.EQ);\n+        sb.and(\"name\", sb.entity().getName(), SearchCriteria.Op.EQ);\n+        sb.and(\"sourceIpAddress\", sb.entity().getSourceIp(), SearchCriteria.Op.EQ);\n+        sb.and(\"sourceIpAddressNetworkId\", sb.entity().getSourceIpNetworkId(), SearchCriteria.Op.EQ);\n+        sb.and(\"scheme\", sb.entity().getScheme(), SearchCriteria.Op.EQ);\n+        sb.and(\"networkId\", sb.entity().getNetworkId(), SearchCriteria.Op.EQ);\n+        \n+        //list only load balancers having not null sourceIp/sourceIpNtwkId\n+        sb.and(\"sourceIpAddress\", sb.entity().getSourceIp(), SearchCriteria.Op.NNULL);\n+        sb.and(\"sourceIpAddressNetworkId\", sb.entity().getSourceIpNetworkId(), SearchCriteria.Op.NNULL);\n+\n+        if (tags != null && !tags.isEmpty()) {\n+            SearchBuilder<ResourceTagVO> tagSearch = _resourceTagDao.createSearchBuilder();\n+            for (int count = 0; count < tags.size(); count++) {\n+                tagSearch.or().op(\"key\" + String.valueOf(count), tagSearch.entity().getKey(), SearchCriteria.Op.EQ);\n+                tagSearch.and(\"value\" + String.valueOf(count), tagSearch.entity().getValue(), SearchCriteria.Op.EQ);\n+                tagSearch.cp();\n+            }\n+            tagSearch.and(\"resourceType\", tagSearch.entity().getResourceType(), SearchCriteria.Op.EQ);\n+            sb.groupBy(sb.entity().getId());\n+            sb.join(\"tagSearch\", tagSearch, sb.entity().getId(), tagSearch.entity().getResourceId(),\n+                    JoinBuilder.JoinType.INNER);\n+        }\n+\n+        SearchCriteria<ApplicationLoadBalancerRuleVO> sc = sb.create();\n+        _accountMgr.buildACLSearchCriteria(sc, domainId, isRecursive, permittedAccounts, listProjectResourcesCriteria);\n+\n+        if (keyword != null) {\n+            SearchCriteria<ApplicationLoadBalancerRuleVO> ssc = _lbDao.createSearchCriteria();\n+            ssc.addOr(\"name\", SearchCriteria.Op.LIKE, \"%\" + keyword + \"%\");\n+            ssc.addOr(\"description\", SearchCriteria.Op.LIKE, \"%\" + keyword + \"%\");\n+            sc.addAnd(\"name\", SearchCriteria.Op.SC, ssc);\n+        }\n+\n+        if (name != null) {\n+            sc.setParameters(\"name\", name);\n+        }\n+\n+        if (id != null) {\n+            sc.setParameters(\"id\", id);\n+        }\n+        \n+        if (ip != null) {\n+            sc.setParameters(\"sourceIpAddress\", ip);\n+        }\n+\n+        if (ipNtwkId != null) {\n+            sc.setParameters(\"sourceIpAddressNetworkId\", ipNtwkId);\n+        }\n+        \n+        if (scheme != null) {\n+            sc.setParameters(\"scheme\", scheme);\n+        }\n+        \n+        if (networkId != null) {\n+            sc.setParameters(\"networkId\", networkId);    \n+        }\n+        \n+        if (tags != null && !tags.isEmpty()) {\n+            int count = 0;\n+            sc.setJoinParameters(\"tagSearch\", \"resourceType\", TaggedResourceType.LoadBalancer.toString());\n+            for (String key : tags.keySet()) {\n+                sc.setJoinParameters(\"tagSearch\", \"key\" + String.valueOf(count), key);\n+                sc.setJoinParameters(\"tagSearch\", \"value\" + String.valueOf(count), tags.get(key));\n+                count++;\n+            }\n+        }\n+        \n+        Pair<List<ApplicationLoadBalancerRuleVO>, Integer> result = _lbDao.searchAndCount(sc, searchFilter);\n+        return new Pair<List<? extends ApplicationLoadBalancerRule>, Integer>(result.first(), result.second());\n+    }\n+\n+    @Override\n+    public ApplicationLoadBalancerRule getApplicationLoadBalancer(long ruleId) {\n+        ApplicationLoadBalancerRule lbRule = _lbDao.findById(ruleId);\n+        if (lbRule == null) {\n+            throw new InvalidParameterValueException(\"Can't find the load balancer by id\");\n+        }\n+        return lbRule;\n+    }\n+   \n+    \n+    /**\n+     * Detects lb rule conflicts against other rules\n+     * @param newLbRule\n+     * @throws NetworkRuleConflictException\n+     */\n+    protected void detectLbRulesConflicts(ApplicationLoadBalancerRule newLbRule) throws NetworkRuleConflictException {\n+        if (newLbRule.getScheme() != Scheme.Internal) {\n+            throw new UnsupportedServiceException(\"Only scheme of type \" + Scheme.Internal + \" is supported\");\n+        } else {\n+            detectInternalLbRulesConflict(newLbRule);\n+        }\n+    }\n+    \n+    \n+    /**\n+     * Detects Internal Lb Rules conflicts\n+     * @param newLbRule\n+     * @throws NetworkRuleConflictException\n+     */\n+    protected void detectInternalLbRulesConflict(ApplicationLoadBalancerRule newLbRule) throws NetworkRuleConflictException {\n+        List<ApplicationLoadBalancerRuleVO> lbRules = _lbDao.listBySourceIpAndNotRevoked(newLbRule.getSourceIp(), newLbRule.getSourceIpNetworkId());\n+\n+        for (ApplicationLoadBalancerRuleVO lbRule : lbRules) {\n+            if (lbRule.getId() == newLbRule.getId()) {\n+                continue; // Skips my own rule.\n+            }\n+\n+            if (lbRule.getNetworkId() != newLbRule.getNetworkId() && lbRule.getState() != State.Revoke) {\n+                throw new NetworkRuleConflictException(\"New rule is for a different network than what's specified in rule \"\n+                        + lbRule.getXid());\n+            }\n+\n+          if ((lbRule.getSourcePortStart().intValue() <= newLbRule.getSourcePortStart().intValue() \n+                  && lbRule.getSourcePortEnd().intValue() >= newLbRule.getSourcePortStart().intValue())\n+                  || (lbRule.getSourcePortStart().intValue() <= newLbRule.getSourcePortEnd().intValue() \n+                  && lbRule.getSourcePortEnd().intValue() >= newLbRule.getSourcePortEnd().intValue())\n+                  || (newLbRule.getSourcePortStart().intValue() <= lbRule.getSourcePortStart().intValue() \n+                  && newLbRule.getSourcePortEnd().intValue() >= lbRule.getSourcePortStart().intValue())\n+                  || (newLbRule.getSourcePortStart().intValue() <= lbRule.getSourcePortEnd().intValue() \n+                  && newLbRule.getSourcePortEnd().intValue() >= lbRule.getSourcePortEnd().intValue())) {\n+\n+\n+                    throw new NetworkRuleConflictException(\"The range specified, \" + newLbRule.getSourcePortStart() + \"-\" + newLbRule.getSourcePortEnd() + \", conflicts with rule \" + lbRule.getId()\n+                            + \" which has \" + lbRule.getSourcePortStart() + \"-\" + lbRule.getSourcePortEnd());\n+            }\n+        }\n+\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"No network rule conflicts detected for \" + newLbRule + \" against \" + (lbRules.size() - 1) + \" existing rules\");\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerManagerImpl.java",
                "sha": "ec0be8c9d96a74ce86d8de2b94a4963955594554",
                "status": "added"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/network/MockNetworkManagerImpl.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/network/MockNetworkManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 2,
                "filename": "server/test/com/cloud/network/MockNetworkManagerImpl.java",
                "patch": "@@ -16,13 +16,33 @@\n // under the License.\n package com.cloud.network;\n \n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.ejb.Local;\n+import javax.naming.ConfigurationException;\n+\n+import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n+import org.apache.cloudstack.api.command.admin.usage.ListTrafficTypeImplementorsCmd;\n+import org.apache.cloudstack.api.command.user.network.CreateNetworkCmd;\n+import org.apache.cloudstack.api.command.user.network.ListNetworksCmd;\n+import org.apache.cloudstack.api.command.user.network.RestartNetworkCmd;\n+import org.apache.cloudstack.api.command.user.vm.ListNicsCmd;\n+import org.springframework.stereotype.Component;\n+\n import com.cloud.dc.DataCenter;\n import com.cloud.dc.Pod;\n import com.cloud.dc.Vlan.VlanType;\n import com.cloud.deploy.DataCenterDeployment;\n import com.cloud.deploy.DeployDestination;\n import com.cloud.deploy.DeploymentPlan;\n-import com.cloud.exception.*;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InsufficientVirtualNetworkCapcityException;\n+import com.cloud.exception.ResourceAllocationException;\n+import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n import com.cloud.network.Networks.TrafficType;\n@@ -37,6 +57,7 @@\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRule.Purpose;\n import com.cloud.network.rules.FirewallRule.State;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offerings.NetworkOfferingVO;\n@@ -46,6 +67,7 @@\n import com.cloud.utils.component.ManagerBase;\n import com.cloud.vm.*;\n import com.cloud.vm.VirtualMachine.Type;\n+import com.cloud.vm.VirtualMachineProfile;\n import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n import org.apache.cloudstack.api.command.admin.network.DedicateGuestVlanRangeCmd;\n import org.apache.cloudstack.api.command.admin.network.ListDedicatedGuestVlanRangesCmd;\n@@ -62,6 +84,7 @@\n import java.util.Map;\n import java.util.Set;\n \n+\n @Component\n @Local(value = { NetworkManager.class, NetworkService.class })\n public class MockNetworkManagerImpl extends ManagerBase implements NetworkManager, NetworkService {\n@@ -820,7 +843,7 @@ public int getRuleCountForIp(Long addressId, Purpose purpose, State state) {\n     }\n \n     @Override\n-    public LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network) {\n+    public LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network, Scheme lbScheme) {\n         // TODO Auto-generated method stub\n         return null;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/network/MockNetworkManagerImpl.java",
                "sha": "eb5fc2537847974161549cb42ad0522d67286e7e",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/network/MockNetworkModelImpl.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/network/MockNetworkModelImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/test/com/cloud/network/MockNetworkModelImpl.java",
                "patch": "@@ -40,6 +40,7 @@\n import com.cloud.network.element.NetworkElement;\n import com.cloud.network.element.UserDataServiceProvider;\n import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.user.Account;\n import com.cloud.utils.component.ManagerBase;\n@@ -853,6 +854,22 @@ public Nic getPlaceholderNicForRouter(Network network, Long podId) {\n     }\n \n     @Override\n+    public IpAddress getPublicIpAddress(String ipAddress, long zoneId) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n+    @Override\n+    public List<String> getUsedIpsInNetwork(Network network) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n+    @Override\n+    public Map<Detail, String> getNtwkOffDetails(long offId) {\n+        return null;\n+    }\n+    \n     public IsolationType[] listNetworkIsolationMethods() {\n         // TODO Auto-generated method stub\n         return null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/network/MockNetworkModelImpl.java",
                "sha": "c3a0d6c5ae987dd75ecd64aa4a4a9556726cf4fa",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockConfigurationManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockConfigurationManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/test/com/cloud/vpc/MockConfigurationManagerImpl.java",
                "patch": "@@ -501,7 +501,7 @@ public void checkDiskOfferingAccess(Account caller, DiskOffering dof) {\n     @Override\n     public NetworkOfferingVO createNetworkOffering(String name, String displayText, TrafficType trafficType, String tags, boolean specifyVlan, Availability availability, Integer networkRate,\n             Map<Service, Set<Provider>> serviceProviderMap, boolean isDefault, GuestType type, boolean systemOnly, Long serviceOfferingId, boolean conserveMode,\n-            Map<Service, Map<Capability, String>> serviceCapabilityMap, boolean specifyIpRanges, boolean isPersistent) {\n+            Map<Service, Map<Capability, String>> serviceCapabilityMap, boolean specifyIpRanges, boolean isPersistent, Map<NetworkOffering.Detail,String> details) {\n         // TODO Auto-generated method stub\n         return null;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockConfigurationManagerImpl.java",
                "sha": "90587985f7476330cde21efefbd86cba88298652",
                "status": "modified"
            },
            {
                "additions": 46,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockNetworkManagerImpl.java",
                "changes": 56,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockNetworkManagerImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 10,
                "filename": "server/test/com/cloud/vpc/MockNetworkManagerImpl.java",
                "patch": "@@ -16,17 +16,51 @@\n // under the License.\n package com.cloud.vpc;\n \n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+\n+import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n+import org.apache.cloudstack.api.command.admin.network.DedicateGuestVlanRangeCmd;\n+import org.apache.cloudstack.api.command.admin.network.ListDedicatedGuestVlanRangesCmd;\n+import org.apache.cloudstack.api.command.admin.usage.ListTrafficTypeImplementorsCmd;\n+import org.apache.cloudstack.api.command.user.network.CreateNetworkCmd;\n+import org.apache.cloudstack.api.command.user.network.ListNetworksCmd;\n+import org.apache.cloudstack.api.command.user.network.RestartNetworkCmd;\n+import org.apache.cloudstack.api.command.user.vm.ListNicsCmd;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n import com.cloud.dc.DataCenter;\n import com.cloud.dc.Pod;\n import com.cloud.dc.Vlan.VlanType;\n import com.cloud.deploy.DataCenterDeployment;\n import com.cloud.deploy.DeployDestination;\n import com.cloud.deploy.DeploymentPlan;\n-import com.cloud.exception.*;\n-import com.cloud.network.*;\n+import com.cloud.exception.ConcurrentOperationException;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InsufficientVirtualNetworkCapcityException;\n+import com.cloud.exception.ResourceAllocationException;\n+import com.cloud.exception.ResourceUnavailableException;\n+import com.cloud.network.GuestVlan;\n+import com.cloud.network.IpAddress;\n+import com.cloud.network.Network;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkProfile;\n+import com.cloud.network.NetworkRuleApplier;\n+import com.cloud.network.NetworkService;\n import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.PhysicalNetwork;\n+import com.cloud.network.PhysicalNetworkServiceProvider;\n+import com.cloud.network.PhysicalNetworkTrafficType;\n+import com.cloud.network.PublicIpAddress;\n import com.cloud.network.addr.PublicIp;\n import com.cloud.network.dao.AccountGuestVlanMapVO;\n import com.cloud.network.dao.IPAddressVO;\n@@ -40,6 +74,7 @@\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRule.Purpose;\n import com.cloud.network.rules.FirewallRule.State;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.offerings.NetworkOfferingVO;\n@@ -48,8 +83,15 @@\n import com.cloud.user.User;\n import com.cloud.utils.Pair;\n import com.cloud.utils.component.ManagerBase;\n-import com.cloud.vm.*;\n+import com.cloud.vm.Nic;\n+import com.cloud.vm.NicProfile;\n+import com.cloud.vm.NicSecondaryIp;\n+import com.cloud.vm.NicVO;\n+import com.cloud.vm.ReservationContext;\n+import com.cloud.vm.VMInstanceVO;\n+import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachine.Type;\n+import com.cloud.vm.VirtualMachineProfile;\n import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n import org.apache.cloudstack.api.command.admin.network.DedicateGuestVlanRangeCmd;\n import org.apache.cloudstack.api.command.admin.network.ListDedicatedGuestVlanRangesCmd;\n@@ -61,12 +103,6 @@\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-import javax.naming.ConfigurationException;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n \n @Component\n @Local(value = { NetworkManager.class, NetworkService.class })\n@@ -1301,7 +1337,7 @@ public int getRuleCountForIp(Long addressId, Purpose purpose, State state) {\n     }\n \n     @Override\n-    public LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network) {\n+    public LoadBalancingServiceProvider getLoadBalancingProviderForNetwork(Network network, Scheme lbScheme) {\n         // TODO Auto-generated method stub\n         return null;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockNetworkManagerImpl.java",
                "sha": "84ae818f489da07597da1d869da9a35176c3d683",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockNetworkModelImpl.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockNetworkModelImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/test/com/cloud/vpc/MockNetworkModelImpl.java",
                "patch": "@@ -47,6 +47,7 @@\n import com.cloud.network.element.NetworkElement;\n import com.cloud.network.element.UserDataServiceProvider;\n import com.cloud.offering.NetworkOffering;\n+import com.cloud.offering.NetworkOffering.Detail;\n import com.cloud.offerings.NetworkOfferingVO;\n import com.cloud.offerings.dao.NetworkOfferingServiceMapDao;\n import com.cloud.user.Account;\n@@ -865,6 +866,22 @@ public Nic getPlaceholderNicForRouter(Network network, Long podId) {\n     }\n \n     @Override\n+    public IpAddress getPublicIpAddress(String ipAddress, long zoneId) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n+    @Override\n+    public List<String> getUsedIpsInNetwork(Network network) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n+    @Override\n+    public Map<Detail, String> getNtwkOffDetails(long offId) {\n+        return null;\n+    }\n+    \n     public IsolationType[] listNetworkIsolationMethods() {\n         // TODO Auto-generated method stub\n         return null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockNetworkModelImpl.java",
                "sha": "d9e33b75616d25f1e122b089a3133e9e99501129",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java",
                "patch": "@@ -36,6 +36,7 @@\n import com.cloud.network.Site2SiteVpnConnection;\n import com.cloud.network.VpcVirtualNetworkApplianceService;\n import com.cloud.network.VpnUser;\n+import com.cloud.network.lb.LoadBalancingRule;\n import com.cloud.network.router.VirtualRouter;\n import com.cloud.network.router.VpcVirtualNetworkApplianceManager;\n import com.cloud.network.rules.FirewallRule;\n@@ -46,7 +47,6 @@\n import com.cloud.user.Account;\n import com.cloud.user.User;\n import com.cloud.uservm.UserVm;\n-import com.cloud.utils.component.Manager;\n import com.cloud.utils.component.ManagerBase;\n import com.cloud.vm.DomainRouterVO;\n import com.cloud.vm.NicProfile;\n@@ -402,4 +402,16 @@ public boolean stopSite2SiteVpn(Site2SiteVpnConnection conn, VirtualRouter route\n         return null;\n     }\n \n+    @Override\n+    public boolean applyLoadBalancingRules(Network network, List<? extends LoadBalancingRule> rules, List<? extends VirtualRouter> routers) throws ResourceUnavailableException {\n+        // TODO Auto-generated method stub\n+        return false;\n+    }\n+\n+    @Override\n+    public VirtualRouter findRouter(long routerId) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java",
                "sha": "9010f1f5acb0a4b6433038e67f59bcff8bbd7e10",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/dao/MockNetworkOfferingDaoImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/dao/MockNetworkOfferingDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 6,
                "filename": "server/test/com/cloud/vpc/dao/MockNetworkOfferingDaoImpl.java",
                "patch": "@@ -101,28 +101,28 @@ public NetworkOfferingVO findById(Long id) {\n         if (id.longValue() == 1) {\n             //network offering valid for vpc\n             vo = new NetworkOfferingVO(\"vpc\", \"vpc\", TrafficType.Guest, false, true, null, null, false,\n-                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false);\n+                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false, false, false);\n         } else if (id.longValue() == 2) {\n             //invalid offering - source nat is not included\n             vo = new NetworkOfferingVO(\"vpc\", \"vpc\", TrafficType.Guest, false, true, null, null, false,\n-                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false);\n+                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false, false, false);\n         } else if (id.longValue() == 3) {\n             //network offering invalid for vpc (conserve mode off)\n             vo = new NetworkOfferingVO(\"non vpc\", \"non vpc\", TrafficType.Guest, false, true, null, null, false,\n-                    Availability.Optional, null, Network.GuestType.Isolated, true, false, false);\n+                    Availability.Optional, null, Network.GuestType.Isolated, true, false, false, false, false);\n         } else if (id.longValue() == 4) {\n             //network offering invalid for vpc (Shared)\n             vo = new NetworkOfferingVO(\"non vpc\", \"non vpc\", TrafficType.Guest, false, true, null, null, false,\n-                    Availability.Optional, null, Network.GuestType.Shared, false, false, false);\n+                    Availability.Optional, null, Network.GuestType.Shared, false, false, false, false, false);\n         } else if (id.longValue() == 5) {\n             //network offering invalid for vpc (has redundant router)\n             vo = new NetworkOfferingVO(\"vpc\", \"vpc\", TrafficType.Guest, false, true, null, null, false,\n-                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false);\n+                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false, false, false);\n             vo.setRedundantRouter(true);\n         } else if (id.longValue() == 6) {\n             //network offering invalid for vpc (has lb service)   \n             vo = new NetworkOfferingVO(\"vpc\", \"vpc\", TrafficType.Guest, false, true, null, null, false,\n-                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false);\n+                    Availability.Optional, null, Network.GuestType.Isolated, false, false, false, false, false);\n         }\n         \n         if (vo != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/dao/MockNetworkOfferingDaoImpl.java",
                "sha": "a8208dd7d9c4444f712e3b3a4f4ce1a8f3bca569",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/dao/MockNetworkServiceMapDaoImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/dao/MockNetworkServiceMapDaoImpl.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/test/com/cloud/vpc/dao/MockNetworkServiceMapDaoImpl.java",
                "patch": "@@ -95,4 +95,10 @@ public String isProviderForNetwork(long networkId, Provider provider) {\n         // TODO Auto-generated method stub\n         return null;\n     }\n+\n+    @Override\n+    public List<String> getProvidersForServiceInNetwork(long networkId, Service service) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/com/cloud/vpc/dao/MockNetworkServiceMapDaoImpl.java",
                "sha": "103f04ea8b90d3351c246645899da34e7b18f32b",
                "status": "modified"
            },
            {
                "additions": 292,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/org/apache/cloudstack/lb/ApplicationLoadBalancerTest.java",
                "changes": 292,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/org/apache/cloudstack/lb/ApplicationLoadBalancerTest.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/test/org/apache/cloudstack/lb/ApplicationLoadBalancerTest.java",
                "patch": "@@ -0,0 +1,292 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.lb;\n+\n+import java.lang.reflect.Field;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import junit.framework.TestCase;\n+\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerManagerImpl;\n+import org.apache.cloudstack.network.lb.ApplicationLoadBalancerRule;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mockito;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import com.cloud.event.dao.UsageEventDao;\n+import com.cloud.exception.InsufficientAddressCapacityException;\n+import com.cloud.exception.InsufficientVirtualNetworkCapcityException;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.NetworkRuleConflictException;\n+import com.cloud.exception.UnsupportedServiceException;\n+import com.cloud.network.Network;\n+import com.cloud.network.Network.Capability;\n+import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.Networks.TrafficType;\n+import com.cloud.network.dao.FirewallRulesDao;\n+import com.cloud.network.dao.NetworkVO;\n+import com.cloud.network.lb.LoadBalancingRule;\n+import com.cloud.network.lb.LoadBalancingRulesManager;\n+import com.cloud.network.rules.FirewallRuleVO;\n+import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n+import com.cloud.user.AccountManager;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.UserContext;\n+import com.cloud.user.UserVO;\n+import com.cloud.utils.component.ComponentContext;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.cloud.utils.net.Ip;\n+import com.cloud.utils.net.NetUtils;\n+\n+/**\n+ * This class is responsible for unittesting the methods defined in ApplicationLoadBalancerService\n+ *\n+ */\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextConfiguration(locations=\"classpath:/appLoadBalancer.xml\")\n+public class ApplicationLoadBalancerTest extends TestCase{\n+    //The interface to test\n+    @Inject ApplicationLoadBalancerManagerImpl _appLbSvc;\n+    \n+    //The interfaces below are mocked\n+    @Inject ApplicationLoadBalancerRuleDao _lbDao;\n+    @Inject LoadBalancingRulesManager _lbMgr;\n+    @Inject NetworkModel _ntwkModel;\n+    @Inject AccountManager _accountMgr;\n+    @Inject FirewallRulesDao _firewallDao;\n+    @Inject UsageEventDao _usageEventDao;\n+\n+    \n+    public static long existingLbId = 1L;\n+    public static long nonExistingLbId = 2L;\n+    \n+    public static long validGuestNetworkId = 1L;\n+    public static long invalidGuestNetworkId = 2L;\n+    public static long validPublicNetworkId = 3L;\n+    \n+    public static long validAccountId = 1L;\n+    public static long invalidAccountId = 2L;\n+    \n+    public String validRequestedIp = \"10.1.1.1\";\n+\n+\n+    \n+    @Before\n+    public void setUp() {\n+        ComponentContext.initComponentsLifeCycle();\n+        //mockito for .getApplicationLoadBalancer tests\n+        Mockito.when(_lbDao.findById(1L)).thenReturn(new ApplicationLoadBalancerRuleVO());\n+        Mockito.when(_lbDao.findById(2L)).thenReturn(null);\n+        \n+        //mockito for .deleteApplicationLoadBalancer tests\n+        Mockito.when(_lbMgr.deleteLoadBalancerRule(existingLbId, true)).thenReturn(true);\n+        Mockito.when(_lbMgr.deleteLoadBalancerRule(nonExistingLbId, true)).thenReturn(false);\n+        \n+        //mockito for .createApplicationLoadBalancer tests\n+        NetworkVO guestNetwork = new NetworkVO(TrafficType.Guest, null, null, 1,\n+                null, 1, 1L);\n+        setId(guestNetwork, validGuestNetworkId);\n+        guestNetwork.setCidr(\"10.1.1.1/24\");\n+        \n+        NetworkVO publicNetwork = new NetworkVO(TrafficType.Public, null, null, 1,\n+                null, 1, 1L);\n+   \n+        Mockito.when(_ntwkModel.getNetwork(validGuestNetworkId)).thenReturn(guestNetwork);\n+        Mockito.when(_ntwkModel.getNetwork(invalidGuestNetworkId)).thenReturn(null);\n+        Mockito.when(_ntwkModel.getNetwork(validPublicNetworkId)).thenReturn(publicNetwork);\n+\n+        Mockito.when(_accountMgr.getAccount(validAccountId)).thenReturn(new AccountVO());\n+        Mockito.when(_accountMgr.getAccount(invalidAccountId)).thenReturn(null);\n+        Mockito.when(_ntwkModel.areServicesSupportedInNetwork(validGuestNetworkId, Service.Lb)).thenReturn(true);\n+        Mockito.when(_ntwkModel.areServicesSupportedInNetwork(invalidGuestNetworkId, Service.Lb)).thenReturn(false);\n+        \n+        ApplicationLoadBalancerRuleVO lbRule = new ApplicationLoadBalancerRuleVO(\"new\", \"new\", 22, 22, \"roundrobin\",\n+                validGuestNetworkId, validAccountId, 1L, new Ip(validRequestedIp), validGuestNetworkId, Scheme.Internal);\n+        Mockito.when(_lbDao.persist(Mockito.any(ApplicationLoadBalancerRuleVO.class))).thenReturn(lbRule);\n+        \n+        Mockito.when(_lbMgr.validateLbRule(Mockito.any(LoadBalancingRule.class))).thenReturn(true);\n+        \n+        Mockito.when(_firewallDao.setStateToAdd(Mockito.any(FirewallRuleVO.class))).thenReturn(true);\n+        \n+        Mockito.when(_accountMgr.getSystemUser()).thenReturn(new UserVO(1));\n+        Mockito.when(_accountMgr.getSystemAccount()).thenReturn(new AccountVO(2));\n+        UserContext.registerContext(_accountMgr.getSystemUser().getId(), _accountMgr.getSystemAccount(), null, false);\n+        \n+        Mockito.when(_ntwkModel.areServicesSupportedInNetwork(Mockito.anyLong(), Mockito.any(Network.Service.class))).thenReturn(true);\n+        \n+        Map<Network.Capability, String> caps = new HashMap<Network.Capability, String>();\n+        caps.put(Capability.SupportedProtocols, NetUtils.TCP_PROTO);\n+        Mockito.when(_ntwkModel.getNetworkServiceCapabilities(Mockito.anyLong(), Mockito.any(Network.Service.class))).thenReturn(caps);\n+        \n+        \n+        Mockito.when(_lbDao.countBySourceIp(new Ip(validRequestedIp), validGuestNetworkId)).thenReturn(1L);\n+        \n+    }\n+    \n+    /**\n+     * TESTS FOR .getApplicationLoadBalancer\n+     */\n+    \n+    @Test\n+    //Positive test - retrieve existing lb\n+    public void searchForExistingLoadBalancer() {\n+        ApplicationLoadBalancerRule rule = _appLbSvc.getApplicationLoadBalancer(existingLbId);\n+        assertNotNull(\"Couldn't find existing application load balancer\", rule);\n+    }\n+    \n+    @Test\n+    //Negative test - try to retrieve non-existing lb\n+    public void searchForNonExistingLoadBalancer() {\n+        boolean notFound = false;\n+        ApplicationLoadBalancerRule rule = null;\n+        try {\n+            rule = _appLbSvc.getApplicationLoadBalancer(nonExistingLbId);\n+            if (rule != null) {\n+                notFound = false; \n+            }\n+        } catch (InvalidParameterValueException ex) {\n+            notFound = true;\n+        }\n+        \n+        assertTrue(\"Found non-existing load balancer; no invalid parameter value exception was thrown\", notFound);\n+    }\n+    \n+    /**\n+     * TESTS FOR .deleteApplicationLoadBalancer\n+     */\n+    \n+    \n+    @Test\n+    //Positive test - delete existing lb\n+    public void deleteExistingLoadBalancer() {\n+        boolean result = false; \n+        try {\n+            result = _appLbSvc.deleteApplicationLoadBalancer(existingLbId);\n+        } finally {\n+            assertTrue(\"Couldn't delete existing application load balancer\", result);   \n+        }\n+    }\n+    \n+    \n+    @Test\n+    //Negative test - try to delete non-existing lb\n+    public void deleteNonExistingLoadBalancer() {\n+        boolean result = true;\n+        try {\n+            result = _appLbSvc.deleteApplicationLoadBalancer(nonExistingLbId);\n+        } finally {\n+            assertFalse(\"Didn't fail when try to delete non-existing load balancer\", result);\n+        }\n+    }\n+    \n+    /**\n+     * TESTS FOR .createApplicationLoadBalancer\n+     * @throws NetworkRuleConflictException \n+     * @throws InsufficientVirtualNetworkCapcityException \n+     * @throws InsufficientAddressCapacityException \n+     */\n+    \n+    @Test (expected = CloudRuntimeException.class)\n+    //Positive test\n+    public void createValidLoadBalancer() throws InsufficientAddressCapacityException,\n+        InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {    \n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Internal, validGuestNetworkId, validRequestedIp,\n+                            22, 22, \"roundrobin\", validGuestNetworkId, validAccountId); \n+    }\n+    \n+    \n+    @Test(expected = UnsupportedServiceException.class)\n+    //Negative test - only internal scheme value is supported in the current release\n+    public void createPublicLoadBalancer() throws InsufficientAddressCapacityException,\n+    InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {\n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Public, validGuestNetworkId, validRequestedIp,\n+                            22, 22, \"roundrobin\", validGuestNetworkId, validAccountId);\n+    }\n+    \n+    \n+    @Test(expected = InvalidParameterValueException.class)\n+    //Negative test - invalid SourcePort\n+    public void createWithInvalidSourcePort() throws InsufficientAddressCapacityException,\n+        InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {        \n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Internal, validGuestNetworkId, validRequestedIp,\n+                    65536, 22, \"roundrobin\", validGuestNetworkId, validAccountId);\n+    }\n+    \n+    @Test(expected = InvalidParameterValueException.class)\n+    //Negative test - invalid instancePort\n+    public void createWithInvalidInstandePort() throws InsufficientAddressCapacityException,\n+        InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {\n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Internal, validGuestNetworkId, validRequestedIp,\n+                22, 65536, \"roundrobin\", validGuestNetworkId, validAccountId);\n+        \n+    }\n+    \n+    \n+    @Test(expected = InvalidParameterValueException.class)\n+    //Negative test - invalid algorithm\n+    public void createWithInvalidAlgorithm() throws InsufficientAddressCapacityException, InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {\n+        String expectedExcText = null;\n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Internal, validGuestNetworkId, validRequestedIp,\n+                22, 22, \"invalidalgorithm\", validGuestNetworkId, validAccountId);\n+        \n+    }\n+    \n+    @Test(expected = InvalidParameterValueException.class)\n+    //Negative test - invalid sourceNetworkId (of Public type, which is not supported)\n+    public void createWithInvalidSourceIpNtwk() throws InsufficientAddressCapacityException,\n+        InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {\n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Internal, validPublicNetworkId, validRequestedIp,\n+                22, 22, \"roundrobin\", validGuestNetworkId, validAccountId);\n+        \n+    }\n+    \n+    \n+    @Test(expected = InvalidParameterValueException.class)\n+    //Negative test - invalid requested IP (outside of guest network cidr range)\n+    public void createWithInvalidRequestedIp() throws InsufficientAddressCapacityException,\n+        InsufficientVirtualNetworkCapcityException, NetworkRuleConflictException {\n+       \n+        _appLbSvc.createApplicationLoadBalancer(\"alena\", \"alena\", Scheme.Internal, validGuestNetworkId, \"10.2.1.1\",\n+                    22, 22, \"roundrobin\", validGuestNetworkId, validAccountId);\n+    }\n+    \n+    \n+    private static NetworkVO setId(NetworkVO vo, long id) {\n+        NetworkVO voToReturn = vo;\n+        Class<?> c = voToReturn.getClass();\n+        try {\n+            Field f = c.getDeclaredField(\"id\");\n+            f.setAccessible(true);\n+            f.setLong(voToReturn, id);\n+        } catch (NoSuchFieldException ex) {\n+           return null;\n+        } catch (IllegalAccessException ex) {\n+            return null;\n+        }\n+        \n+        return voToReturn;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/org/apache/cloudstack/lb/ApplicationLoadBalancerTest.java",
                "sha": "461cbbdf0127210c64b1897cfae09189d537666e",
                "status": "added"
            },
            {
                "additions": 103,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/org/apache/cloudstack/lb/ChildTestConfiguration.java",
                "changes": 103,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/org/apache/cloudstack/lb/ChildTestConfiguration.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/test/org/apache/cloudstack/lb/ChildTestConfiguration.java",
                "patch": "@@ -0,0 +1,103 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+// \n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.lb;\n+\n+import java.io.IOException;\n+\n+import org.apache.cloudstack.lb.dao.ApplicationLoadBalancerRuleDao;\n+import org.apache.cloudstack.test.utils.SpringUtils;\n+import org.mockito.Mockito;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.context.annotation.ComponentScan.Filter;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.FilterType;\n+import org.springframework.core.type.classreading.MetadataReader;\n+import org.springframework.core.type.classreading.MetadataReaderFactory;\n+import org.springframework.core.type.filter.TypeFilter;\n+\n+import com.cloud.dc.dao.AccountVlanMapDaoImpl;\n+import com.cloud.event.dao.UsageEventDao;\n+import com.cloud.network.NetworkManager;\n+import com.cloud.network.NetworkModel;\n+import com.cloud.network.dao.FirewallRulesDao;\n+import com.cloud.network.lb.LoadBalancingRulesManager;\n+import com.cloud.tags.dao.ResourceTagDao;\n+import com.cloud.user.AccountManager;\n+\n+@Configuration\n+@ComponentScan(\n+    basePackageClasses={\n+        AccountVlanMapDaoImpl.class\n+    },\n+    includeFilters={@Filter(value=ChildTestConfiguration.Library.class, type=FilterType.CUSTOM)},\n+    useDefaultFilters=false\n+    )\n+\n+    public class ChildTestConfiguration {\n+        \n+        public static class Library implements TypeFilter {\n+            \n+            @Bean\n+            public ApplicationLoadBalancerRuleDao applicationLoadBalancerDao() {\n+                return Mockito.mock(ApplicationLoadBalancerRuleDao.class);\n+            }\n+            \n+            @Bean\n+            public NetworkModel networkModel() {\n+                return Mockito.mock(NetworkModel.class);\n+            }\n+            \n+            @Bean\n+            public AccountManager accountManager() {\n+                return Mockito.mock(AccountManager.class);\n+            }\n+            \n+            @Bean\n+            public LoadBalancingRulesManager loadBalancingRulesManager() {\n+                return Mockito.mock(LoadBalancingRulesManager.class);\n+            }\n+            \n+            @Bean\n+            public FirewallRulesDao firewallRulesDao() {\n+                return Mockito.mock(FirewallRulesDao.class);\n+            }\n+            \n+            @Bean\n+            public ResourceTagDao resourceTagDao() {\n+                return Mockito.mock(ResourceTagDao.class);\n+            }\n+            \n+            @Bean\n+            public NetworkManager networkManager() {\n+                return Mockito.mock(NetworkManager.class);\n+            }\n+            \n+            @Bean\n+            public UsageEventDao UsageEventDao() {\n+                return Mockito.mock(UsageEventDao.class);\n+            }\n+            \n+            @Override\n+            public boolean match(MetadataReader mdr, MetadataReaderFactory arg1) throws IOException {\n+                mdr.getClassMetadata().getClassName();\n+                ComponentScan cs = ChildTestConfiguration.class.getAnnotation(ComponentScan.class);\n+                return SpringUtils.includedInBasePackageClasses(mdr.getClassMetadata().getClassName(), cs);\n+            }\n+    \n+        }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/org/apache/cloudstack/lb/ChildTestConfiguration.java",
                "sha": "918de81c0c5f0b42b22a99aee98aaae565206cc6",
                "status": "added"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/org/apache/cloudstack/networkoffering/CreateNetworkOfferingTest.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/org/apache/cloudstack/networkoffering/CreateNetworkOfferingTest.java?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 10,
                "filename": "server/test/org/apache/cloudstack/networkoffering/CreateNetworkOfferingTest.java",
                "patch": "@@ -84,6 +84,7 @@ public void setUp() {\n         Mockito.when(configDao.findByName(Mockito.anyString())).thenReturn(configVO);\n         \n         Mockito.when(offDao.persist(Mockito.any(NetworkOfferingVO.class))).thenReturn(new NetworkOfferingVO());\n+        Mockito.when(offDao.persist(Mockito.any(NetworkOfferingVO.class), Mockito.anyMap())).thenReturn(new NetworkOfferingVO());\n         Mockito.when(mapDao.persist(Mockito.any(NetworkOfferingServiceMapVO.class))).thenReturn(new NetworkOfferingServiceMapVO());\n         Mockito.when(accountMgr.getSystemUser()).thenReturn(new UserVO(1));\n         Mockito.when(accountMgr.getSystemAccount()).thenReturn(new AccountVO(2));\n@@ -96,7 +97,7 @@ public void setUp() {\n     public void createSharedNtwkOffWithVlan() {\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"shared\", \"shared\", TrafficType.Guest, null, true,\n                 Availability.Optional, 200, null, false, Network.GuestType.Shared, false,\n-                null, false, null, true, false);\n+                null, false, null, true, false, null);\n         assertNotNull(\"Shared network offering with specifyVlan=true failed to create \", off);\n     }\n     \n@@ -105,7 +106,7 @@ public void createSharedNtwkOffWithNoVlan() {\n         try {\n             NetworkOfferingVO off = configMgr.createNetworkOffering(\"shared\", \"shared\", TrafficType.Guest, null, false,\n                     Availability.Optional, 200, null, false, Network.GuestType.Shared, false,\n-                    null, false, null, true, false);\n+                    null, false, null, true, false, null);\n             assertNull(\"Shared network offering with specifyVlan=false was created\", off);\n         } catch (InvalidParameterValueException ex) {\n         }\n@@ -115,7 +116,7 @@ public void createSharedNtwkOffWithNoVlan() {\n     public void createSharedNtwkOffWithSpecifyIpRanges() {\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"shared\", \"shared\", TrafficType.Guest, null, true,\n                 Availability.Optional, 200, null, false, Network.GuestType.Shared, false,\n-                null, false, null, true, false);\n+                null, false, null, true, false, null);\n         \n         assertNotNull(\"Shared network offering with specifyIpRanges=true failed to create \", off);\n     }\n@@ -125,7 +126,7 @@ public void createSharedNtwkOffWithoutSpecifyIpRanges() {\n         try {\n             NetworkOfferingVO off = configMgr.createNetworkOffering(\"shared\", \"shared\", TrafficType.Guest, null, true,\n                     Availability.Optional, 200, null, false, Network.GuestType.Shared, false,\n-                    null, false, null, false, false);\n+                    null, false, null, false, false, null);\n             assertNull(\"Shared network offering with specifyIpRanges=false was created\", off);\n         } catch (InvalidParameterValueException ex) {\n         }\n@@ -140,7 +141,7 @@ public void createIsolatedNtwkOffWithNoVlan() {\n         serviceProviderMap.put(Network.Service.SourceNat, vrProvider);\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"isolated\", \"isolated\", TrafficType.Guest, null, false,\n                 Availability.Optional, 200, serviceProviderMap, false, Network.GuestType.Isolated, false,\n-                null, false, null, false, false);\n+                null, false, null, false, false, null);\n         \n         assertNotNull(\"Isolated network offering with specifyIpRanges=false failed to create \", off);\n     }\n@@ -153,7 +154,7 @@ public void createIsolatedNtwkOffWithVlan() {\n         serviceProviderMap.put(Network.Service.SourceNat, vrProvider);\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"isolated\", \"isolated\", TrafficType.Guest, null, true,\n                 Availability.Optional, 200, serviceProviderMap, false, Network.GuestType.Isolated, false,\n-                null, false, null, false, false);\n+                null, false, null, false, false, null);\n         assertNotNull(\"Isolated network offering with specifyVlan=true wasn't created\", off);\n        \n     }\n@@ -167,7 +168,7 @@ public void createIsolatedNtwkOffWithSpecifyIpRangesAndSourceNat() {\n             serviceProviderMap.put(Network.Service.SourceNat, vrProvider);\n             NetworkOfferingVO off = configMgr.createNetworkOffering(\"isolated\", \"isolated\", TrafficType.Guest, null, false,\n                     Availability.Optional, 200, serviceProviderMap, false, Network.GuestType.Isolated, false,\n-                    null, false, null, true, false);\n+                    null, false, null, true, false, null);\n             assertNull(\"Isolated network offering with specifyIpRanges=true and source nat service enabled, was created\", off);\n         } catch (InvalidParameterValueException ex) {\n         }\n@@ -180,7 +181,7 @@ public void createIsolatedNtwkOffWithSpecifyIpRangesAndNoSourceNat() {\n         Set<Network.Provider> vrProvider = new HashSet<Network.Provider>();\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"isolated\", \"isolated\", TrafficType.Guest, null, false,\n                 Availability.Optional, 200, serviceProviderMap, false, Network.GuestType.Isolated, false,\n-                null, false, null, true, false);\n+                null, false, null, true, false, null);\n         assertNotNull(\"Isolated network offering with specifyIpRanges=true and with no sourceNatService, failed to create\", off);\n         \n     }\n@@ -198,7 +199,7 @@ public void createVpcNtwkOff() {\n         serviceProviderMap.put(Network.Service.Lb , vrProvider);\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"isolated\", \"isolated\", TrafficType.Guest, null, true,\n                 Availability.Optional, 200, serviceProviderMap, false, Network.GuestType.Isolated, false,\n-                null, false, null, false, false);\n+                null, false, null, false, false, null);\n         // System.out.println(\"Creating Vpc Network Offering\");\n         assertNotNull(\"Vpc Isolated network offering with Vpc provider \", off);\n     }\n@@ -218,7 +219,7 @@ public void createVpcNtwkOffWithNetscaler() {\n         serviceProviderMap.put(Network.Service.Lb, lbProvider);\n         NetworkOfferingVO off = configMgr.createNetworkOffering(\"isolated\", \"isolated\", TrafficType.Guest, null, true,\n                 Availability.Optional, 200, serviceProviderMap, false, Network.GuestType.Isolated, false, null, false,\n-                null, false, false);\n+                null, false, false, null);\n         // System.out.println(\"Creating Vpc Network Offering\");\n         assertNotNull(\"Vpc Isolated network offering with Vpc and Netscaler provider \", off);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/org/apache/cloudstack/networkoffering/CreateNetworkOfferingTest.java",
                "sha": "92aa2a2c8ff7d1060a45afd46948c7956c9ccb6d",
                "status": "modified"
            },
            {
                "additions": 43,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/server/test/resources/appLoadBalancer.xml",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/resources/appLoadBalancer.xml?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "server/test/resources/appLoadBalancer.xml",
                "patch": "@@ -0,0 +1,43 @@\n+<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor \n+  license agreements. See the NOTICE file distributed with this work for additional \n+  information regarding copyright ownership. The ASF licenses this file to \n+  you under the Apache License, Version 2.0 (the \"License\"); you may not use \n+  this file except in compliance with the License. You may obtain a copy of \n+  the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required \n+  by applicable law or agreed to in writing, software distributed under the \n+  License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS \n+  OF ANY KIND, either express or implied. See the License for the specific \n+  language governing permissions and limitations under the License. -->\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+  xmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n+  xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+                      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n+                      http://www.springframework.org/schema/tx \n+                      http://www.springframework.org/schema/tx/spring-tx-3.0.xsd\n+                      http://www.springframework.org/schema/aop\n+                      http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n+                      http://www.springframework.org/schema/context\n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n+\n+     <context:annotation-config />\n+\n+    <!-- @DB support -->\n+      \n+  <bean id=\"componentContext\" class=\"com.cloud.utils.component.ComponentContext\" />\n+\n+  <bean id=\"transactionContextBuilder\" class=\"com.cloud.utils.db.TransactionContextBuilder\" />\n+  <bean id=\"actionEventInterceptor\" class=\"com.cloud.event.ActionEventInterceptor\" />\n+  <bean id=\"instantiatePostProcessor\" class=\"com.cloud.utils.component.ComponentInstantiationPostProcessor\">\n+    <property name=\"Interceptors\">\n+        <list>\n+            <ref bean=\"transactionContextBuilder\" />\n+        </list>\n+    </property> </bean> \n+    <bean id=\"ApplicationLoadBalancerManager\" class=\"org.apache.cloudstack.network.lb.ApplicationLoadBalancerManagerImpl\">\n+        <property name=\"name\" value=\"ApplicationLoadBalancerManager\"/>\n+    </bean>\n+  \n+    <bean class=\"org.apache.cloudstack.lb.ChildTestConfiguration\" />\n+    \n+</beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/server/test/resources/appLoadBalancer.xml",
                "sha": "d7c1502a715427f5fb3df730f8821afb74b27e05",
                "status": "added"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/setup/db/db/schema-40to410.sql",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-40to410.sql?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 1,
                "filename": "setup/db/db/schema-40to410.sql",
                "patch": "@@ -644,6 +644,7 @@ CREATE VIEW `cloud`.`domain_router_view` AS\n         data_center.id data_center_id,\n         data_center.uuid data_center_uuid,\n         data_center.name data_center_name,\n+        data_center.networktype data_center_type,\n         data_center.dns1 dns1,\n         data_center.dns2 dns2,\n         data_center.ip6_dns1 ip6_dns1,\n@@ -684,7 +685,8 @@ CREATE VIEW `cloud`.`domain_router_view` AS\n         domain_router.scripts_version scripts_version,\n         domain_router.is_redundant_router is_redundant_router,\n         domain_router.redundant_state redundant_state,\n-        domain_router.stop_pending stop_pending\n+        domain_router.stop_pending stop_pending,\n+        domain_router.role role\n     from\n         `cloud`.`domain_router`\n             inner join",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/setup/db/db/schema-40to410.sql",
                "sha": "b7b1c7a91dd1f30fd7c707f84c510118a7621f84",
                "status": "modified"
            },
            {
                "additions": 40,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/setup/db/db/schema-410to420.sql",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-410to420.sql?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 5,
                "filename": "setup/db/db/schema-410to420.sql",
                "patch": "@@ -339,7 +339,7 @@ CREATE TABLE `cloud`.`vm_snapshots` (\n ALTER TABLE `cloud`.`hypervisor_capabilities` ADD COLUMN `vm_snapshot_enabled` tinyint(1) DEFAULT 0 NOT NULL COMMENT 'Whether VM snapshot is supported by hypervisor';\n UPDATE `cloud`.`hypervisor_capabilities` SET `vm_snapshot_enabled`=1 WHERE `hypervisor_type` in ('VMware', 'XenServer');\n \n-\t\t\t\n+      \n DROP VIEW IF EXISTS `cloud`.`user_vm_view`;\n CREATE VIEW `cloud`.`user_vm_view` AS\n     select \n@@ -450,7 +450,7 @@ CREATE VIEW `cloud`.`user_vm_view` AS\n         async_job.uuid job_uuid,\n         async_job.job_status job_status,\n         async_job.account_id job_account_id,\n-\t\taffinity_group.id affinity_group_id,\n+    affinity_group.id affinity_group_id,\n         affinity_group.uuid affinity_group_uuid,\n         affinity_group.name affinity_group_name,\n         affinity_group.description affinity_group_description\n@@ -515,7 +515,7 @@ CREATE VIEW `cloud`.`user_vm_view` AS\n             and async_job.job_status = 0\n             left join\n         `cloud`.`affinity_group_vm_map` ON vm_instance.id = affinity_group_vm_map.instance_id\n-\t\t\tleft join\n+      left join\n         `cloud`.`affinity_group` ON affinity_group_vm_map.affinity_group_id = affinity_group.id;\n \n DROP VIEW IF EXISTS `cloud`.`affinity_group_view`;\n@@ -844,7 +844,8 @@ CREATE VIEW `cloud`.`domain_router_view` AS\n         domain_router.scripts_version scripts_version,\n         domain_router.is_redundant_router is_redundant_router,\n         domain_router.redundant_state redundant_state,\n-        domain_router.stop_pending stop_pending\n+        domain_router.stop_pending stop_pending,\n+        domain_router.role role\n     from\n         `cloud`.`domain_router`\n             inner join\n@@ -919,7 +920,7 @@ CREATE TABLE `cloud`.`network_asa1000v_map` (\n ALTER TABLE `cloud`.`network_offerings` ADD COLUMN `eip_associate_public_ip` int(1) unsigned NOT NULL DEFAULT 0 COMMENT 'true if public IP is associated with user VM creation by default when EIP service is enabled.' AFTER `elastic_ip_service`;\n \n -- Re-enable foreign key checking, at the end of the upgrade path\n-SET foreign_key_checks = 1;\t\t\t\n+SET foreign_key_checks = 1;     \n \n \n -- Add \"default\" field to account/user tables\n@@ -1116,6 +1117,40 @@ CREATE VIEW `cloud`.`account_view` AS\n             and async_job.job_status = 0;\n \n \n+\n+ALTER TABLE `cloud`.`load_balancing_rules` ADD COLUMN `source_ip_address` varchar(40) COMMENT 'source ip address for the load balancer rule';\n+ALTER TABLE `cloud`.`load_balancing_rules` ADD COLUMN `source_ip_address_network_id` bigint unsigned COMMENT 'the id of the network where source ip belongs to';\n+ALTER TABLE `cloud`.`load_balancing_rules` ADD COLUMN `scheme` varchar(40) NOT NULL COMMENT 'load balancer scheme; can be Internal or Public';\n+UPDATE `cloud`.`load_balancing_rules` SET `scheme`='Public';\n+\n+\n+\n+-- Add details talbe for the network offering\n+CREATE TABLE `cloud`.`network_offering_details` (\n+  `id` bigint unsigned NOT NULL auto_increment,\n+  `network_offering_id` bigint unsigned NOT NULL COMMENT 'network offering id',\n+  `name` varchar(255) NOT NULL,\n+  `value` varchar(1024) NOT NULL,\n+  PRIMARY KEY (`id`),\n+  CONSTRAINT `fk_network_offering_details__network_offering_id` FOREIGN KEY `fk_network_offering_details__network_offering_id`(`network_offering_id`) REFERENCES `network_offerings`(`id`) ON DELETE CASCADE\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n+\n+-- Change the constraint for the network service map table. Now we support multiple provider for the same service\n+ALTER TABLE `cloud`.`ntwk_service_map` DROP FOREIGN KEY `fk_ntwk_service_map__network_id`;\n+ALTER TABLE `cloud`.`ntwk_service_map` DROP INDEX `network_id`;\n+\n+ALTER TABLE `cloud`.`ntwk_service_map` ADD UNIQUE `network_id` (`network_id`,`service`,`provider`);\n+ALTER TABLE `cloud`.`ntwk_service_map` ADD  CONSTRAINT `fk_ntwk_service_map__network_id` FOREIGN KEY (`network_id`) REFERENCES `networks` (`id`) ON DELETE CASCADE;\n+\n+\n+ALTER TABLE `cloud`.`network_offerings` ADD COLUMN `internal_lb` int(1) unsigned NOT NULL DEFAULT '0' COMMENT 'true if the network offering supports Internal lb service';\n+ALTER TABLE `cloud`.`network_offerings` ADD COLUMN `public_lb` int(1) unsigned NOT NULL DEFAULT '0' COMMENT 'true if the network offering supports Public lb service';\n+UPDATE `cloud`.`network_offerings` SET public_lb=1 where id IN (SELECT DISTINCT network_offering_id FROM `cloud`.`ntwk_offering_service_map` WHERE service='Lb');\n+\n+\n+INSERT IGNORE INTO `cloud`.`configuration` VALUES ('Advanced', 'DEFAULT', 'NetworkManager', 'internallbvm.service.offering', null, 'Uuid of the service offering used by internal lb vm; if NULL - default system internal lb offering will be used');\n+\n+\n alter table `cloud_usage`.`usage_network_offering` add column nic_id bigint(20) unsigned NOT NULL;\n ALTER TABLE `cloud`.`data_center_details` MODIFY value varchar(1024);\n ALTER TABLE `cloud`.`cluster_details` MODIFY value varchar(255);",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/setup/db/db/schema-410to420.sql",
                "sha": "065b35ca5012b771301c6cfb3adbb7254d5fd386",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/setup/dev/advanced.cfg",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/dev/advanced.cfg?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "setup/dev/advanced.cfg",
                "patch": "@@ -45,6 +45,10 @@\n                         {\n                             \"broadcastdomainrange\": \"ZONE\",\n                             \"name\": \"VpcVirtualRouter\"\n+                        },\n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\",\n+                            \"name\": \"InternalLbVm\"\n                         }\n                     ],\n                     \"isolationmethods\": [",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/setup/dev/advanced.cfg",
                "sha": "83357866ca7939e0e0f14e29084d79a1ea4bd0fa",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/test/integration/component/test_multiple_ip_ranges.py",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/component/test_multiple_ip_ranges.py?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "test/integration/component/test_multiple_ip_ranges.py",
                "patch": "@@ -369,6 +369,7 @@ def test_05_add_overlapped_ip_range(self):\n         self.fail(\"CS should not accept overlapped ip ranges in guest traffic, but it allowed\")\n         return\n \n+\n     @attr(tags=[\"advanced_sg\", \"sg\"])\n     def test_06_add_ip_range_overlapped_with_two_ranges(self):\n         \"\"\"Test adding overlapped ip range in existing cidr",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/test/integration/component/test_multiple_ip_ranges.py",
                "sha": "7e9e712aef0d8d55f694cd93eca7f740aca290d7",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/test/integration/smoke/test_guest_vlan_range.py",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_guest_vlan_range.py?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "test/integration/smoke/test_guest_vlan_range.py",
                "patch": "@@ -44,6 +44,7 @@ def __init__(self):\n                                     \"password\": \"password\",\n                          },\n                         \"name\": \"testphysicalnetwork\",\n+\n                         \"vlan\": \"2118-2120\",\n                     }\n \n@@ -149,6 +150,19 @@ def test_dedicateGuestVlanRange(self):\n                         )\n \n         self.debug(\"Releasing guest vlan range\");\n+<<<<<<< HEAD\n+        dedicated_guest_vlan_response.release(self.apiclient)\n+        list_dedicated_guest_vlan_range_response = PhysicalNetwork.listDedicated(\n+                                                self.apiclient,\n+                                                id=dedicate_guest_vlan_range_response.id\n+                                        )\n+        dedicated_guest_vlan_response = list_dedicated_guest_vlan_range_response[0]\n+        self.assertEqual(\n+                            dedicated_guest_vlan_response.account,\n+                            \"system\",\n+                            \"Check account name is system account in listDedicatedGuestVlanRanges\"\n+                        )\n+=======\n         dedicate_guest_vlan_range_response.release(self.apiclient)\n         list_dedicated_guest_vlan_range_response = PhysicalNetwork.listDedicated(self.apiclient)\n         self.assertEqual(\n@@ -157,4 +171,5 @@ def test_dedicateGuestVlanRange(self):\n                         \"Check vlan range is not available in listDedicatedGuestVlanRanges\"\n \n                         )                    \n+>>>>>>> master\n         ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/test/integration/smoke/test_guest_vlan_range.py",
                "sha": "704fe59bfffb76ad325d49a7058acc9816705bed",
                "status": "modified"
            },
            {
                "additions": 250,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/test/integration/smoke/test_internal_lb.py",
                "changes": 250,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_internal_lb.py?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "test/integration/smoke/test_internal_lb.py",
                "patch": "@@ -0,0 +1,250 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+\"\"\" Tests for configuring Internal Load Balancing Rules.\n+\"\"\"\n+#Import Local Modules\n+from marvin.cloudstackTestCase import *\n+from marvin.cloudstackAPI import *\n+from marvin.integration.lib.utils import *\n+from marvin.integration.lib.base import *\n+from marvin.integration.lib.common import *\n+\n+\n+class TestInternalLb(cloudstackTestCase):\n+    networkOfferingId = None\n+    networkId = None\n+    vmId = None\n+    lbId = None\n+\n+    zoneId = 1\n+    serviceOfferingId = 1 \n+    templateId = 5\n+\n+\n+    serviceProviderList = [\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"Vpn\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"UserData\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"Dhcp\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"Dns\"\n+        },\n+        {\n+            \"provider\": \"InternalLbVM\",\n+            \"service\": \"Lb\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"SourceNat\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"StaticNat\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"PortForwarding\"\n+        },\n+        {\n+            \"provider\": \"VpcVirtualRouter\",\n+            \"service\": \"NetworkACL\"\n+        }\n+    ]\n+\n+    serviceCapsList = [\n+        {\n+            \"service\": \"SourceNat\",\n+            \"capabilitytype\": \"SupportedSourceNatTypes\",\n+            \"capabilityvalue\": \"peraccount\"\n+        },\n+        {\n+            \"service\": \"Lb\",\n+            \"capabilitytype\": \"SupportedLbIsolation\",\n+            \"capabilityvalue\": \"dedicated\"\n+        },\n+        {\n+            \"service\": \"Lb\",\n+            \"capabilitytype\": \"lbSchemes\",\n+            \"capabilityvalue\": \"internal\"\n+        }\n+    ]\n+\n+    def setUp(self):\n+        self.apiClient = self.testClient.getApiClient()\n+\n+\n+    \n+    def test_internallb(self):\n+\n+        #1) Create and enable network offering with Internal Lb vm service\n+        self.createNetworkOffering()\n+        \n+        #2) Create VPC and network in it\n+        self.createNetwork()\n+      \n+        #3) Deploy a vm \n+        self.deployVm()\n+        \n+        #4) Create an Internal Load Balancer\n+        self.createInternalLoadBalancer()\n+\n+        #5) Assign the VM to the Internal Load Balancer\n+        self.assignToLoadBalancerRule()\n+\n+        #6) Remove the vm from the Interanl Load Balancer\n+        self.removeFromLoadBalancerRule()\n+\n+        #7) Delete the Load Balancer\n+        self.deleteLoadBalancer()\n+\n+\n+    def deployVm(self):\n+        deployVirtualMachineCmd = deployVirtualMachine.deployVirtualMachineCmd()\n+        deployVirtualMachineCmd.networkids = TestInternalLb.networkId\n+        deployVirtualMachineCmd.serviceofferingid = TestInternalLb.serviceOfferingId\n+        deployVirtualMachineCmd.zoneid = TestInternalLb.zoneId\n+        deployVirtualMachineCmd.templateid = TestInternalLb.templateId\n+        deployVirtualMachineCmd.hypervisor = \"XenServer\"\n+        deployVMResponse = self.apiClient.deployVirtualMachine(deployVirtualMachineCmd)\n+        TestInternalLb.vmId = deployVMResponse.id\n+\n+\n+    def createInternalLoadBalancer(self):\n+        createLoadBalancerCmd = createLoadBalancer.createLoadBalancerCmd()\n+        createLoadBalancerCmd.name = \"lb rule\"\n+        createLoadBalancerCmd.sourceport = 22\n+        createLoadBalancerCmd.instanceport = 22\n+        createLoadBalancerCmd.algorithm = \"roundrobin\"\n+        createLoadBalancerCmd.scheme = \"internal\"\n+        createLoadBalancerCmd.sourceipaddressnetworkid = TestInternalLb.networkId\n+        createLoadBalancerCmd.networkid = TestInternalLb.networkId\n+        createLoadBalancerResponse = self.apiClient.createLoadBalancer(createLoadBalancerCmd)\n+        TestInternalLb.lbId = createLoadBalancerResponse.id\n+        self.assertIsNotNone(createLoadBalancerResponse.id, \"Failed to create a load balancer\")\n+\n+\n+    def assignToLoadBalancerRule(self):\n+        assignToLoadBalancerRuleCmd = assignToLoadBalancerRule.assignToLoadBalancerRuleCmd()\n+        assignToLoadBalancerRuleCmd.id = TestInternalLb.lbId\n+        assignToLoadBalancerRuleCmd.virtualMachineIds = TestInternalLb.vmId\n+        assignToLoadBalancerRuleResponse = self.apiClient.assignToLoadBalancerRule(assignToLoadBalancerRuleCmd)\n+        self.assertTrue(assignToLoadBalancerRuleResponse.success, \"Failed to assign the vm to the load balancer\")\n+\n+\n+\n+    def removeFromLoadBalancerRule(self):\n+        removeFromLoadBalancerRuleCmd = removeFromLoadBalancerRule.removeFromLoadBalancerRuleCmd()\n+        removeFromLoadBalancerRuleCmd.id = TestInternalLb.lbId\n+        removeFromLoadBalancerRuleCmd.virtualMachineIds = TestInternalLb.vmId\n+        removeFromLoadBalancerRuleResponse = self.apiClient.removeFromLoadBalancerRule(removeFromLoadBalancerRuleCmd)\n+        self.assertTrue(removeFromLoadBalancerRuleResponse.success, \"Failed to remove the vm from the load balancer\")\n+\n+\n+\n+    #def removeInternalLoadBalancer(self):\n+    def deleteLoadBalancer(self):\n+        deleteLoadBalancerCmd = deleteLoadBalancer.deleteLoadBalancerCmd()\n+        deleteLoadBalancerCmd.id = TestInternalLb.lbId\n+        deleteLoadBalancerResponse = self.apiClient.deleteLoadBalancer(deleteLoadBalancerCmd)\n+        self.assertTrue(deleteLoadBalancerResponse.success, \"Failed to remove the load balancer\")\n+\n+\n+\n+    def createNetwork(self):\n+        createVPCCmd = createVPC.createVPCCmd()\n+        createVPCCmd.name = \"new vpc\"\n+        createVPCCmd.cidr = \"10.1.1.0/24\"\n+        createVPCCmd.displaytext = \"new vpc\"\n+        createVPCCmd.vpcofferingid = 1\n+        createVPCCmd.zoneid = self.zoneId\n+        createVPCResponse = self.apiClient.createVPC(createVPCCmd)\n+\n+\n+        createNetworkCmd = createNetwork.createNetworkCmd()\n+        createNetworkCmd.name = \"vpc network\"\n+        createNetworkCmd.displaytext = \"vpc network\"\n+        createNetworkCmd.netmask = \"255.255.255.0\"\n+        createNetworkCmd.gateway = \"10.1.1.1\"\n+        createNetworkCmd.zoneid = self.zoneId\n+        createNetworkCmd.vpcid = createVPCResponse.id\n+        createNetworkCmd.networkofferingid = TestInternalLb.networkOfferingId\n+        createNetworkResponse = self.apiClient.createNetwork(createNetworkCmd)\n+        TestInternalLb.networkId = createNetworkResponse.id\n+\n+        self.assertIsNotNone(createNetworkResponse.id, \"Network failed to create\")\n+\n+\n+    def createNetworkOffering(self):\n+            createNetworkOfferingCmd = createNetworkOffering.createNetworkOfferingCmd()\n+            createNetworkOfferingCmd.name = \"Network offering for internal lb service - \" + str(random.randrange(1,100+1))\n+            createNetworkOfferingCmd.displaytext = \"Network offering for internal lb service\"\n+            createNetworkOfferingCmd.guestiptype = \"isolated\"\n+            createNetworkOfferingCmd.traffictype = \"Guest\"\n+            createNetworkOfferingCmd.conservemode = \"false\"\n+            createNetworkOfferingCmd.supportedservices = \"Vpn,Dhcp,Dns,Lb,UserData,SourceNat,StaticNat,PortForwarding,NetworkACL\"\n+\n+\n+            createNetworkOfferingCmd.serviceproviderlist = []\n+            for item in self.serviceProviderList:\n+                createNetworkOfferingCmd.serviceproviderlist.append({\n+                                                'service': item['service'],\n+                                                'provider': item['provider']\n+                                               })\n+                \n+            createNetworkOfferingCmd.servicecapabilitylist = []\n+            for item in self.serviceCapsList:\n+                createNetworkOfferingCmd.servicecapabilitylist.append({\n+                                                'service': item['service'],\n+                                                'capabilitytype': item['capabilitytype'],\n+                                                'capabilityvalue': item['capabilityvalue']\n+                                               })\n+\n+\n+            createNetworkOfferingResponse = self.apiClient.createNetworkOffering(createNetworkOfferingCmd)\n+            TestInternalLb.networkOfferingId = createNetworkOfferingResponse.id\n+\n+            #enable network offering\n+            updateNetworkOfferingCmd = updateNetworkOffering.updateNetworkOfferingCmd()\n+            updateNetworkOfferingCmd.id = TestInternalLb.networkOfferingId\n+            updateNetworkOfferingCmd.state = \"Enabled\"\n+            updateNetworkOfferingResponse = self.apiClient.updateNetworkOffering(updateNetworkOfferingCmd)\n+\n+\n+            #list network offering to see if its enabled\n+            listNetworkOfferingsCmd = listNetworkOfferings.listNetworkOfferingsCmd()\n+            listNetworkOfferingsCmd.id = TestInternalLb.networkOfferingId\n+            listOffResponse = self.apiClient.listNetworkOfferings(listNetworkOfferingsCmd)\n+\n+            self.assertNotEqual(len(listOffResponse), 0, \"Check if the list network offerings API \\\n+                                returns a non-empty response\")\n+\n+\n+    def tearDown(self):\n+        #destroy the vm\n+        if TestInternalLb.vmId is not None:\n+            destroyVirtualMachineCmd = destroyVirtualMachine.destroyVirtualMachineCmd()\n+            destroyVirtualMachineCmd.id = TestInternalLb.vmId\n+            destroyVirtualMachineResponse = self.apiClient.destroyVirtualMachine(destroyVirtualMachineCmd)",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/test/integration/smoke/test_internal_lb.py",
                "sha": "ae64297bf1c968c3684fa906b242c38fe805a039",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/tools/apidoc/gen_toc.py",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/apidoc/gen_toc.py?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "tools/apidoc/gen_toc.py",
                "patch": "@@ -140,6 +140,7 @@\n     'removeIpFromNic': 'Nic',\n     'listNics':'Nic',\n \t'AffinityGroup': 'Affinity Group',\n+    'InternalLoadBalancer': 'Internal LB',\n     }\n \n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/tools/apidoc/gen_toc.py",
                "sha": "bd8c0f1668fb34a130285ec49526ced5760f738c",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/tools/marvin/marvin/deployDataCenter.py",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/marvin/marvin/deployDataCenter.py?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "tools/marvin/marvin/deployDataCenter.py",
                "patch": "@@ -216,6 +216,18 @@ def configureProviders(self, phynetwrk, providers):\n                     vrconfig.id = vrprovid\n                     self.apiClient.configureVirtualRouterElement(vrconfig)\n                     self.enableProvider(pnetprovres[0].id)\n+                elif provider.name == 'InternalLbVm':\n+                    internallbprov = listInternalLoadBalancerElements.listInternalLoadBalancerElementsCmd() \n+                    internallbprov.nspid = pnetprovres[0].id\n+                    internallbresponse = self.apiClient.listInternalLoadBalancerElements(internallbprov)\n+                    internallbid = internallbresponse[0].id\n+\n+                    internallbconfig = \\\n+                            configureInternalLoadBalancerElement.configureInternalLoadBalancerElementCmd()\n+                    internallbconfig.enabled = \"true\"\n+                    internallbconfig.id = internallbid\n+                    self.apiClient.configureInternalLoadBalancerElement(internallbconfig)\n+                    self.enableProvider(pnetprovres[0].id)\n                 elif provider.name == 'SecurityGroupProvider':\n                     self.enableProvider(pnetprovres[0].id)\n             elif provider.name in ['Netscaler', 'JuniperSRX', 'F5BigIp']:",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/tools/marvin/marvin/deployDataCenter.py",
                "sha": "7059059beb1fadbae21ce36b3f0ff58401d2b2bd",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/tools/marvin/marvin/sandbox/advanced/advanced_env.py",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/marvin/marvin/sandbox/advanced/advanced_env.py?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "tools/marvin/marvin/sandbox/advanced/advanced_env.py",
                "patch": "@@ -50,6 +50,9 @@ def describeResources(config):\n     \n     vpcprovider = provider()\n     vpcprovider.name = 'VpcVirtualRouter'\n+\n+    lbprovider = provider()\n+    lbprovider.name = 'InternalLbVm'\n     \n     pn = physical_network()\n     pn.name = \"Sandbox-pnet\"\n@@ -60,6 +63,7 @@ def describeResources(config):\n             traffictype(\"Public\", {\"simulator\":\"cloud-simulator-public\"})]\n     pn.isolationmethods = [\"VLAN\"]\n     pn.providers.append(vpcprovider)\n+    pn.providers.append(lbprovider)\n \n     pn2 = physical_network()\n     pn2.name = \"Sandbox-pnet2\"\n@@ -68,6 +72,7 @@ def describeResources(config):\n     pn2.traffictypes = [traffictype('Guest', {'simulator': 'cloud-simulator-guest'})]\n     pn2.isolationmethods = [\"VLAN\"]\n     pn2.providers.append(vpcprovider)\n+    pn2.providers.append(lbprovider)\n     \n     z.physical_networks.append(pn)\n     z.physical_networks.append(pn2)",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/tools/marvin/marvin/sandbox/advanced/advanced_env.py",
                "sha": "6343293aa6291262d783a66e190dd03400da1e0d",
                "status": "modified"
            },
            {
                "additions": 209,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/tools/marvin/marvin/sandbox/advanced/sandbox.cfg",
                "changes": 209,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/marvin/marvin/sandbox/advanced/sandbox.cfg?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "tools/marvin/marvin/sandbox/advanced/sandbox.cfg",
                "patch": "@@ -0,0 +1,209 @@\n+{\n+    \"zones\": [\n+        {\n+            \"name\": \"Sandbox-Simulator\", \n+            \"guestcidraddress\": \"10.1.1.0/24\", \n+            \"dns1\": \"10.147.28.6\", \n+            \"physical_networks\": [\n+                {\n+                    \"providers\": [\n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\", \n+                            \"name\": \"VirtualRouter\"\n+                        }, \n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\", \n+                            \"name\": \"VpcVirtualRouter\"\n+                        }, \n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\", \n+                            \"name\": \"InternalLb\"\n+                        }\n+                    ], \n+                    \"name\": \"Sandbox-pnet\", \n+                    \"tags\": [\n+                        \"cloud-simulator-public\"\n+                    ], \n+                    \"broadcastdomainrange\": \"Zone\", \n+                    \"vlan\": \"675-679\", \n+                    \"traffictypes\": [\n+                        {\n+                            \"typ\": \"Guest\"\n+                        }, \n+                        {\n+                            \"typ\": \"Management\", \n+                            \"simulator\": \"cloud-simulator-mgmt\"\n+                        }, \n+                        {\n+                            \"typ\": \"Public\", \n+                            \"simulator\": \"cloud-simulator-public\"\n+                        }\n+                    ], \n+                    \"isolationmethods\": [\n+                        \"VLAN\"\n+                    ]\n+                }, \n+                {\n+                    \"providers\": [\n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\", \n+                            \"name\": \"VirtualRouter\"\n+                        }, \n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\", \n+                            \"name\": \"VpcVirtualRouter\"\n+                        }, \n+                        {\n+                            \"broadcastdomainrange\": \"ZONE\", \n+                            \"name\": \"InternalLb\"\n+                        }\n+                    ], \n+                    \"name\": \"Sandbox-pnet2\", \n+                    \"tags\": [\n+                        \"cloud-simulator-guest\"\n+                    ], \n+                    \"broadcastdomainrange\": \"Zone\", \n+                    \"vlan\": \"800-1000\", \n+                    \"traffictypes\": [\n+                        {\n+                            \"typ\": \"Guest\", \n+                            \"simulator\": \"cloud-simulator-guest\"\n+                        }\n+                    ], \n+                    \"isolationmethods\": [\n+                        \"VLAN\"\n+                    ]\n+                }\n+            ], \n+            \"securitygroupenabled\": \"false\", \n+            \"ipranges\": [\n+                {\n+                    \"startip\": \"10.147.31.150\", \n+                    \"endip\": \"10.147.31.159\", \n+                    \"netmask\": \"255.255.255.0\", \n+                    \"vlan\": \"31\", \n+                    \"gateway\": \"10.147.31.1\"\n+                }\n+            ], \n+            \"networktype\": \"Advanced\", \n+            \"pods\": [\n+                {\n+                    \"endip\": \"10.147.29.159\", \n+                    \"name\": \"POD0\", \n+                    \"startip\": \"10.147.29.150\", \n+                    \"netmask\": \"255.255.255.0\", \n+                    \"clusters\": [\n+                        {\n+                            \"clustername\": \"C0\", \n+                            \"hypervisor\": \"Simulator\", \n+                            \"hosts\": [\n+                                {\n+                                    \"username\": \"root\", \n+                                    \"url\": \"http://simulator0\", \n+                                    \"password\": \"password\"\n+                                }\n+                            ], \n+                            \"clustertype\": \"CloudManaged\", \n+                            \"primaryStorages\": [\n+                                {\n+                                    \"url\": \"nfs://10.147.28.6:/export/home/sandbox/primary\", \n+                                    \"name\": \"PS0\"\n+                                }\n+                            ]\n+                        }\n+                    ], \n+                    \"gateway\": \"10.147.29.1\"\n+                }\n+            ], \n+            \"internaldns1\": \"10.147.28.6\", \n+            \"secondaryStorages\": [\n+                {\n+                    \"url\": \"nfs://10.147.28.6:/export/home/sandbox/sstor\"\n+                }\n+            ]\n+        }\n+    ], \n+    \"dbSvr\": {\n+        \"dbSvr\": \"localhost\", \n+        \"passwd\": \"cloud\", \n+        \"db\": \"cloud\", \n+        \"port\": 3306, \n+        \"user\": \"cloud\"\n+    }, \n+    \"logger\": [\n+        {\n+            \"name\": \"TestClient\", \n+            \"file\": \"testclient.log\"\n+        }, \n+        {\n+            \"name\": \"TestCase\", \n+            \"file\": \"testcase.log\"\n+        }\n+    ], \n+    \"globalConfig\": [\n+        {\n+            \"name\": \"storage.cleanup.interval\", \n+            \"value\": \"300\"\n+        }, \n+        {\n+            \"name\": \"direct.agent.load.size\", \n+            \"value\": \"1000\"\n+        }, \n+        {\n+            \"name\": \"default.page.size\", \n+            \"value\": \"10000\"\n+        }, \n+        {\n+            \"name\": \"instance.name\", \n+            \"value\": \"QA\"\n+        }, \n+        {\n+            \"name\": \"workers\", \n+            \"value\": \"10\"\n+        }, \n+        {\n+            \"name\": \"vm.op.wait.interval\", \n+            \"value\": \"5\"\n+        }, \n+        {\n+            \"name\": \"account.cleanup.interval\", \n+            \"value\": \"600\"\n+        }, \n+        {\n+            \"name\": \"guest.domain.suffix\", \n+            \"value\": \"sandbox.simulator\"\n+        }, \n+        {\n+            \"name\": \"expunge.delay\", \n+            \"value\": \"60\"\n+        }, \n+        {\n+            \"name\": \"vm.allocation.algorithm\", \n+            \"value\": \"random\"\n+        }, \n+        {\n+            \"name\": \"expunge.interval\", \n+            \"value\": \"60\"\n+        }, \n+        {\n+            \"name\": \"expunge.workers\", \n+            \"value\": \"3\"\n+        }, \n+        {\n+            \"name\": \"secstorage.allowed.internal.sites\", \n+            \"value\": \"10.147.28.0/24\"\n+        }, \n+        {\n+            \"name\": \"check.pod.cidrs\", \n+            \"value\": \"true\"\n+        }\n+    ], \n+    \"mgtSvr\": [\n+        {\n+            \"mgtSvrIp\": \"localhost\", \n+            \"passwd\": \"password\", \n+            \"user\": \"root\", \n+            \"port\": 8096\n+        }\n+    ]\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/tools/marvin/marvin/sandbox/advanced/sandbox.cfg",
                "sha": "01a84730dadb8ccde32d9838e13483b888a06ed7",
                "status": "added"
            },
            {
                "additions": 104,
                "blob_url": "https://github.com/apache/cloudstack/blob/2660a6b7a7f226ab757d2175222db62571813120/ui/scripts/zoneWizard.js",
                "changes": 104,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/zoneWizard.js?ref=2660a6b7a7f226ab757d2175222db62571813120",
                "deletions": 0,
                "filename": "ui/scripts/zoneWizard.js",
                "patch": "@@ -2376,6 +2376,110 @@\n                             });\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t// ***** Virtual Router ***** (end) *****\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\t// ***** Internal LB ***** (begin) *****\n+\t\t\t\t\t\t\tvar internalLbProviderId;\n+\t\t\t\t\t\t\t$.ajax({\n+\t\t\t\t\t\t\t\turl: createURL(\"listNetworkServiceProviders&name=Internallbvm&physicalNetworkId=\" + thisPhysicalNetwork.id),\n+\t\t\t\t\t\t\t\tdataType: \"json\",\n+\t\t\t\t\t\t\t\tasync: false,\n+\t\t\t\t\t\t\t\tsuccess: function(json) {\n+\t\t\t\t\t\t\t\t\tvar items = json.listnetworkserviceprovidersresponse.networkserviceprovider;\n+\t\t\t\t\t\t\t\t\tif(items != null && items.length > 0) {\n+\t\t\t\t\t\t\t\t\t\tinternalLbProviderId = items[0].id;\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t});\n+\t\t\t\t\t\t\tif(internalLbProviderId == null) {\n+\t\t\t\t\t\t\t\talert(\"error: listNetworkServiceProviders API doesn't return internalLb provider ID\");\n+\t\t\t\t\t\t\t\treturn;\n+\t\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t\tvar internalLbElementId;\n+\t\t\t\t\t\t\t$.ajax({\n+\t\t\t\t\t\t\t\turl: createURL(\"listInternalLoadBalancerElements&nspid=\" + internalLbProviderId),\n+\t\t\t\t\t\t\t\tdataType: \"json\",\n+\t\t\t\t\t\t\t\tasync: false,\n+\t\t\t\t\t\t\t\tsuccess: function(json) {\n+\t\t\t\t\t\t\t\t\tvar items = json.listinternalloadbalancerelementsresponse.internalloadbalancerelement;\n+\t\t\t\t\t\t\t\t\tif(items != null && items.length > 0) {\n+\t\t\t\t\t\t\t\t\t\tinternalLbElementId = items[0].id;\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t});\n+\t\t\t\t\t\t\tif(internalLbElementId == null) {\n+\t\t\t\t\t\t\t\talert(\"error: listInternalLoadBalancerElements API doesn't return Internal LB Element Id\");\n+\t\t\t\t\t\t\t\treturn;\n+\t\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t\t$.ajax({\n+\t\t\t\t\t\t\t\turl: createURL(\"configureInternalLoadBalancerElement&enabled=true&id=\" + internalLbElementId),\n+\t\t\t\t\t\t\t\tdataType: \"json\",\n+\t\t\t\t\t\t\t\tasync: false,\n+\t\t\t\t\t\t\t\tsuccess: function(json) {\n+\t\t\t\t\t\t\t\t\tvar jobId = json.configureinternalloadbalancerelementresponse.jobid;                                \n+\t\t\t\t\t\t\t\t\tvar enableInternalLbElementIntervalID = setInterval(function() { \t\n+\t\t\t\t\t\t\t\t\t\t$.ajax({\n+\t\t\t\t\t\t\t\t\t\t\turl: createURL(\"queryAsyncJobResult&jobId=\"+jobId),\n+\t\t\t\t\t\t\t\t\t\t\tdataType: \"json\",\n+\t\t\t\t\t\t\t\t\t\t\tsuccess: function(json) {\n+\t\t\t\t\t\t\t\t\t\t\t\tvar result = json.queryasyncjobresultresponse;\n+\t\t\t\t\t\t\t\t\t\t\t\tif (result.jobstatus == 0) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\treturn; //Job has not completed\n+\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\telse {                                        \n+\t\t\t\t\t\t\t\t\t\t\t\t\tclearInterval(enableInternalLbElementIntervalID); \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\t\t\t\t\t\t\tif (result.jobstatus == 1) { //configureVirtualRouterElement succeeded\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t$.ajax({\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\turl: createURL(\"updateNetworkServiceProvider&state=Enabled&id=\" + internalLbProviderId),\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdataType: \"json\",\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tasync: false,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsuccess: function(json) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar jobId = json.updatenetworkserviceproviderresponse.jobid;                                             \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar enableInternalLbProviderIntervalID = setInterval(function() { \t\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$.ajax({\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\turl: createURL(\"queryAsyncJobResult&jobId=\"+jobId),\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdataType: \"json\",\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsuccess: function(json) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar result = json.queryasyncjobresultresponse;\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (result.jobstatus == 0) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\treturn; //Job has not completed\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\telse {                                                      \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclearInterval(enableInternalLbProviderIntervalID); \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (result.jobstatus == 1) { //Internal LB has been enabled successfully\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//don't need to do anything here\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\telse if (result.jobstatus == 2) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\talert(\"failed to enable Internal LB Provider. Error: \" + _s(result.jobresult.errortext));\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\terror: function(XMLHttpResponse) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar errorMsg = parseXMLHttpResponse(XMLHttpResponse);\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\talert(\"failed to enable Internal LB Provider. Error: \" + errorMsg);\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t});                                              \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}, g_queryAsyncJobResultInterval); \t\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\n+\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t\telse if (result.jobstatus == 2) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\talert(\"configureVirtualRouterElement failed. Error: \" + _s(result.jobresult.errortext));\n+\t\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t},\n+\t\t\t\t\t\t\t\t\t\t\terror: function(XMLHttpResponse) {\n+\t\t\t\t\t\t\t\t\t\t\t\tvar errorMsg = parseXMLHttpResponse(XMLHttpResponse);\n+\t\t\t\t\t\t\t\t\t\t\t\talert(\"configureVirtualRouterElement failed. Error: \" + errorMsg);\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t});                                \n+\t\t\t\t\t\t\t\t\t}, g_queryAsyncJobResultInterval); \t\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t});\n+\t\t\t\t\t\t\t// ***** Internal LB ***** (end) *****\n+                            \n \t\t\t\t\t\t\t\t\t\t\t\t\t\tif(args.data.zone.sgEnabled != true) { //Advanced SG-disabled zone\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ***** VPC Virtual Router ***** (begin) *****\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvar vpcVirtualRouterProviderId;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2660a6b7a7f226ab757d2175222db62571813120/ui/scripts/zoneWizard.js",
                "sha": "9b28c327b78c5796453d87af78bccc94b7e13e80",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-747: Internal LB between VPC tiers support\n\nSquashed commit of the following:\n\ncommit def0861d5a12202260cb6672c12d77075a0de26e\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu May 9 10:53:09 2013 -0700\n\n    Inernallb: added internalLbVm to the list of network elements for nonoss build\n\ncommit 56d94fc074db52ef00ace1703081a342dfb63db0\nMerge: d828c15 8f9a42e\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu May 9 09:51:36 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tplugins/network-elements/netscaler/src/com/cloud/network/element/NetscalerElement.java\n    \tserver/src/com/cloud/network/vpc/VpcManagerImpl.java\n\ncommit d828c154fd05fbfeb9c142b27e3d26e7dd755c77\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed May 8 14:58:22 2013 -0700\n\n    internallb: Fixed nonoss build\n\ncommit 1b8a6986a6fd1808ba7285589f9a007b52feb7e5\nMerge: 9e74fa9 738d35a\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed May 8 13:20:07 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tapi/src/com/cloud/async/AsyncJob.java\n    \tapi/src/com/cloud/network/NetworkModel.java\n    \tapi/src/com/cloud/network/rules/LoadBalancerContainer.java\n    \tapi/src/org/apache/cloudstack/api/BaseCmd.java\n    \tapi/src/org/apache/cloudstack/api/ResponseGenerator.java\n    \tapi/src/org/apache/cloudstack/network/lb/ApplicationLoadBalancerContainer.java\n    \tclient/tomcatconf/commands.properties.in\n    \tengine/schema/src/com/cloud/network/dao/LoadBalancerDaoImpl.java\n    \tserver/src/com/cloud/api/ApiResponseHelper.java\n    \tserver/src/com/cloud/network/NetworkManagerImpl.java\n    \tserver/src/com/cloud/network/NetworkModelImpl.java\n    \tserver/src/com/cloud/network/NetworkServiceImpl.java\n    \tserver/src/com/cloud/server/ManagementServerImpl.java\n    \tserver/test/com/cloud/network/MockNetworkModelImpl.java\n    \tserver/test/com/cloud/vpc/MockNetworkManagerImpl.java\n    \tserver/test/com/cloud/vpc/MockNetworkModelImpl.java\n    \tserver/test/resources/appLoadBalancer.xml\n    \tsetup/db/db/schema-410to420.sql\n    \ttest/integration/component/test_multiple_ip_ranges.py\n    \ttest/integration/smoke/test_guest_vlan_range.py\n    \ttools/marvin/marvin/integration/lib/base.py\n\ncommit 9e74fa94067997f0ae6d469f3564df602dd274a6\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Thu May 9 00:11:40 2013 +0530\n\n    marvin changes for internallbvm provider\n\n    - changed the simulator context to load the internallb bean\n    - fixed deployDataCenter to use the additional provider by default\n    - fixed the sandbox script and the setup script for simulator checkin\n      tests\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 0a2d49301b170171ebe8d6646236854f488d06ba\nAuthor: Jessica Wang <jessicawang@apache.org>\nDate:   Tue May 7 15:50:41 2013 -0700\n\n    Internal LB - UI - zone wizard - advanced zone - enable internal LB element, enable internal LB provider.\n\ncommit 43e1667f90b01e2b4095009b997b3b2665087fb4\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue May 7 13:26:53 2013 -0700\n\n    Moved all DAOs and VOs to the cloud-engine-schema project\n\ncommit 2fd94c8bbe24da86e6bd004ee8165e08038a3e1d\nAuthor: Radhika PC <radhika.puthiyetath@citrix.com>\nDate:   Tue May 7 18:26:08 2013 +0530\n\n    CLOUDSTACK-893 api\n\ncommit 12b64d6c00940a4b5c4aa059f2c36ae7cc1b79bd\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 17:06:15 2013 +0530\n\n    Fixing the gmaven configuration for marvin/pom.xml\n\n    For the marvin checkin test custom properties had a typo when run for\n    the *nix environment.\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 1e4274dd9f55a6eea7121d50e361babcafe70725\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 15:28:43 2013 +0530\n\n    Renaming TesDedicateVlanRange -> TestDedicateVlanRange\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 9264ac526f854c980afb669631177c99e4bbbed7\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 15:28:20 2013 +0530\n\n    Adding isolation method to the zone creation of marvin\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 3a0dc67de0285fffa7739b25286df71f92470ddf\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 15:27:26 2013 +0530\n\n    adding ACL for dedicateGuestVlanRange set of APIs\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 79f6e11368d4b6227e9055bb58cce8e5b9872cfe\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 15:26:48 2013 +0530\n\n    add debug logs when access checkers fail to find API\n\n    When the access checkers fail for api discovery, we fail silently.\n    instead record a debug message.\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 92cb7d3e0f3ef052104f698e005ab8dd243f9885\nAuthor: Hugo Trippaers <trippie@gmail.com>\nDate:   Tue May 7 11:44:23 2013 +0200\n\n    commit e0d8f01ecd92a1a7b74558d02a28be3b2f20a10d enabled all tests. Fix\n    AWSAPI build by removing broken tests and excluding failing tests.\n\ncommit 4a391464c7359689915c4230dfa07d728acfb752\nAuthor: Hugo Trippaers <htrippaers@schubergphilis.com>\nDate:   Tue May 7 10:57:23 2013 +0200\n\n    commit e0d8f01ecd92a1a7b74558d02a28be3b2f20a10d enabled all tests, but the tests in vmware-base are horribly broken and will not compile with the current CloudStack.\n\n    Removing the tests to fix the nonoss build and they are so broken they should be rewritten from scratch anyway.\n\ncommit 2ca03a851360c733ddacbe6a5490b6812dfc6bec\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 13:51:34 2013 +0530\n\n    moving test data to top level dictionary\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit ceaa4e1b0d77ccb811a7e1f56ae212034b3f4a90\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 13:50:56 2013 +0530\n\n    Adding tracelogs to the API discovery service\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit a3f5f01c7e78e045fdc1302ab484282b0d43e014\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Tue May 7 13:50:12 2013 +0530\n\n    dedicateGuestVlanRange is admin only API\n\n    Adding ACL for the dedicateGuestVlanRange API.\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 1c4c80fe91c7aeec0689fa9a06ae80d2bdf1b0c0\nAuthor: Hugo Trippaers <htrippaers@schubergphilis.com>\nDate:   Tue May 7 09:58:16 2013 +0200\n\n    Recent pom switcharoo caused the client to lose the dependecy on console-proxy, which it needs to include the systemvm\n\ncommit 8103f3c386a8f57c520388ea73965a4cb7f15b91\nAuthor: Radhika PC <radhika.puthiyetath@citrix.com>\nDate:   Tue May 7 11:30:17 2013 +0530\n\n    CLOUDSTACK-893 first cut\n\ncommit 67d0411d739417aae4910251e86981e6d1340da0\nAuthor: Dave Cahill <dcahill@midokura.com>\nDate:   Fri Apr 19 17:31:44 2013 +0900\n\n    Add docs for MidoNet networking plugin [CLOUDSTACK-996]\n\n    Signed-off-by: Dave Cahill <dcahill@midokura.com>\n\ncommit c745e6d28e63ef1cacdf18a98ce47d162d260978\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Mon May 6 16:34:03 2013 -0700\n\n    Fixed up the simulator to run with windows paths in cygwin\n\ncommit be91c037021ad17f16b22599acbdd46062a665a8\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Mon May 6 10:34:22 2013 -0700\n\n    Moved over the VLAN daos\n\ncommit dcc09f8472d4c94cebae5b430b7eb983037a9935\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Mon May 6 06:31:47 2013 -0700\n\n    Missing file and updated .gitignore\n\ncommit e9953cd1a8b1247ce569d22ffa820f51d072c841\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Mon May 6 06:29:59 2013 -0700\n\n    Fixed up unit testing to use only an in class TestConfiguration\n\ncommit 67275714035ea2a55c11ee7acf1e915598670845\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Thu May 2 15:20:49 2013 -0700\n\n    Fixed an incorrect unit test for affinity group.  Removed some useless pom.xml.\n\ncommit d015fb352023a5d2ec07b4d66612836e0a928679\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Thu May 2 06:50:38 2013 -0700\n\n    Moved most of the VOs and DAOs from server package into engine-schema as well\n\ncommit 77547a58df5f529031516273015bb770717c5b88\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Wed May 1 15:15:57 2013 -0700\n\n    Removed files that are no longer used and further separated out the files in the core project\n\ncommit 345f3d34828a9b573971104cbb6132a777a58ed4\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Wed May 1 05:46:15 2013 -0700\n\n    Moved agent commands to core and out of api\n\ncommit e91ca00571ddf078150165a33cd3cbcee5564fe2\nAuthor: Alex Huang <alex.huang@gmail.com>\nDate:   Tue Apr 30 19:06:20 2013 -0700\n\n    Removed framework-api which is completely useless.  Changed framework-ipc to reference gson itself.  Move VOs into engine-schema.\n\ncommit f64564e49001ee0f52120a10665979887fd0ebd1\nAuthor: Dennis Lawler <dlawler@gmail.com>\nDate:   Mon Apr 29 15:10:09 2013 -0700\n\n    Removing filterwin2k option\n\n    Signed-off-by: Chiradeep Vittal <chiradeep@apache.org>\n\ncommit 944a7ea5d6e6728903074ec18754ce2041aaf7a3\nAuthor: Wei Zhou <w.zhou@leaseweb.com>\nDate:   Mon May 6 20:57:02 2013 +0100\n\n    CLOUDSTACK-2319: fix \"unable to add egress rules\" in SecurityGroup\n\n    Signed-off-by: Chip Childers <chip.childers@gmail.com>\n\ncommit ff7f8ba3623927b6cef2deb0069e7f839d933fd5\nAuthor: Wei Zhou <w.zhou@leaseweb.com>\nDate:   Mon May 6 20:56:06 2013 +0100\n\n    CLOUDSTACK-2322: update network.gateway to fix deployVm error on\n    SharedNetwork after ipv6 support\n\n    Signed-off-by: Chip Childers <chip.childers@gmail.com>\n\ncommit a153373c7eade440c707bfaeeb9831f8179ab51a\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon May 6 11:45:19 2013 -0700\n\n    CLOUDSTACK-129: added new API - listNetworkIsolationMethods - for displaying isolation methods supported by the cloudStack\n\ncommit 46f59cd49effc43ffea610cc5b7cab90f601b011\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Mon May 6 20:39:36 2013 +0530\n\n    Fixed the incorrect assertion in noncontiguous_vlan test\n\n    The assertion fails if the VLAN is found in which case find returns a\n    positive number. So here the assertion should infact assert < 0 result.\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit bd1dcc10b381b33ab5503f42075999365197168b\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Mon May 6 19:53:42 2013 +0530\n\n    Affinity Groups requires multiple storage pools\n\n    Fixing the affinity group test which would fail to find the appropriate\n    storage pool to satisfy the anti-affinity group of the second VM\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 7f853cdb8f8074408205f38c5e63c2dce187b40b\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Mon May 6 19:16:15 2013 +0530\n\n    fixing double calls to VM deploy\n\n    This fixes regression introduced in commit 2f40a90c that made duplicate\n    calls to deployVirtualMachine.\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 646e810fcf0f2c0c3fac02a37eb4301fd913b008\nAuthor: Prasanna Santhanam <tsp@apache.org>\nDate:   Mon May 6 18:51:53 2013 +0530\n\n    fixing wildcard imports\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit b29b6e8525ed367cb6f481c7eb116abe1fb847a2\nAuthor: Hugo Trippaers <htrippaers@schubergphilis.com>\nDate:   Fri May 3 14:03:53 2013 +0200\n\n    BigSwitch should only respond if it is the actual provider on the network.\n\n    This fixes an NPE during the release call.\n\ncommit 6fcc9b009b5609756fd5195847557b56f9642ecd\nAuthor: Hugo Trippaers <htrippaers@schubergphilis.com>\nDate:   Thu May 2 17:38:27 2013 +0200\n\n    Prevent Nicira NVP tags from exceeding the 40 character limit.\n\ncommit d8e61a1c0a02cef67377f1fd1f638d77652edecf\nAuthor: Sanjay Tripathi <sanjay.tripathi@citrix.com>\nDate:   Thu May 2 13:45:39 2013 +0530\n\n    CLOUDSTACK-2188 : Parsing error with Download Monitor while checking the health of downloaded templates\n\n    Signed-off-by: Sateesh Chodapuneedi <sateesh@apache.org>\n\ncommit 5b6e1140f90b4625d02b9a0bb035342139c1b6f4\nAuthor: Sebastien Goasguen <runseb@gmail.com>\nDate:   Mon May 6 05:35:58 2013 -0400\n\n    CLOUDSTACK-2339: Adding libcloud example\n\ncommit 7be62d2374ef5910728627b583ac33498ad7fdce\nAuthor: Sebastien Goasguen <runseb@gmail.com>\nDate:   Mon May 6 05:35:19 2013 -0400\n\n    CLOUDSTACK-2338: Adding example of how to sign api requests in python\n\ncommit 156fd689026ca23e583fa32e5013183e13086a57\nAuthor: Talluri <Srikanteswararao.Talluri@citrix.com>\nDate:   Fri May 3 23:11:56 2013 +0530\n\n    CLOUDSTACK-2323: fix test scripts to conform with library changes\n\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 33ff5e91079b262562b17701d5266bcfd2674ffd\nAuthor: sanjeevneelarapu <sanjeev.neelarapu@citrix.com>\nDate:   Tue Apr 30 20:09:46 2013 +0530\n\n    CLOUDSTACK-702: Tests for Multiple IP Ranges\n\n    1.Deleting IP Range from the existing CIDR\n    2.Add non-contiguous guest IP range in new CIDR\n    3.Add overlapped guest IP range in existing CIDR\n\n    Signed-off-by: sanjeevneelarapu <sanjeev.neelarapu@citrix.com>\n    Signed-off-by: Prasanna Santhanam <tsp@apache.org>\n\ncommit 33059d1f66fdc7d925f6b087a97912b8bc4598d5\nAuthor: Pranav Saxena <pranav.saxena@citrix.com>\nDate:   Mon May 6 14:08:40 2013 +0530\n\n    scaleUp VM response change corresponding UI changes\n\ncommit 92e18d81060a9e766e1cfce3f41bbd6ddd6d5ff5\nAuthor: Pranav Saxena <pranav.saxena@citrix.com>\nDate:   Mon May 6 13:45:32 2013 +0530\n\n    CLOUDSTACK-2337:Resize button available for root/domain admin and normal users\n\ncommit d5cd3f7e006d688d052f7fe797180753dae989e7\nAuthor: Likitha Shetty <likitha.shetty@citrix.com>\nDate:   Wed May 1 13:47:26 2013 +0530\n\n    Dedicate guest vlan range to account\n\ncommit 12c79c8377d45df2ccec217bbcb9023840a2c064\nAuthor: Pranav Saxena <pranav.saxena@citrix.com>\nDate:   Sun May 5 12:02:32 2013 +0530\n\n    scale up virtual machine response change in the backend\n\ncommit 94bac276228fb2ede08de063e1b789d917c8425f\nAuthor: Rohit Yadav <bhaisaab@apache.org>\nDate:   Sun May 5 09:58:04 2013 +0530\n\n    appliance: Upgrade systemvm appliance from rc1 to Debian7 GA\n\n    Signed-off-by: Rohit Yadav <bhaisaab@apache.org>\n\ncommit c598bb0038750c18223115026774c56de1366696\nAuthor: Isaac Chiang <isaacchiang@gmail.com>\nDate:   Sun May 5 01:57:35 2013 +0530\n\n    CLOUDSTACK-2076:Listview widget infinte scrolling error\n\ncommit d0615ea9a1560b7330066544f5ddf4d5c2713f70\nAuthor: Pranav Saxena <pranav.saxena@citrix.com>\nDate:   Sun May 5 01:15:14 2013 +0530\n\n    CLOUDSTACK-2274:Detail view loading problem when deleting a zone\n\ncommit 733b513c3ac10dadf33f187d29651494197678b4\nAuthor: Isaac Chiang <isaacchiang@gmail.com>\nDate:   Sat May 4 13:41:02 2013 +0530\n\n    CLOUDSTACK-2160:Refresh button functionality for security groups and statistics tab\n\ncommit 418d75d7a4dd4f9785846e3ecbe9f0135d751fe3\nAuthor: Marcus Sorensen <marcus@betterservers.com>\nDate:   Fri May 3 14:09:52 2013 -0600\n\n    Summary: Release old DHCP entries\n\n    Detail: Refresh dnsmasq with updated entries live, no outage\n\n    BUG-ID: CLOUDSTACK-2299\n    Submitted-by: Dennis Lawler <dlawler@gmail.com>\n    Signed-off-by: Marcus Sorensen <marcus@betterservers.com> 1367611792 -0600\n\ncommit b3dce6457739c0f737ed8f2f61ad108bfee13eba\nAuthor: Kelven Yang <kelveny@gmail.com>\nDate:   Tue May 7 10:57:19 2013 -0700\n\n    fix unitest\n\ncommit b17885f0f68affe060a95e3f264b9ac5e3a98a4b\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue May 7 09:55:47 2013 -0700\n\n    InternalLb: some fixes to the unittest\n\ncommit 1cff609347eed3fb3a5e2e3a76b2f36404ea0b81\nMerge: 053e184 a3a5c13\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri May 3 11:23:08 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tserver/src/com/cloud/network/NetworkModelImpl.java\n    \tserver/src/com/cloud/network/NetworkServiceImpl.java\n    \tserver/src/com/cloud/server/ManagementServerImpl.java\n    \tserver/test/com/cloud/network/MockNetworkManagerImpl.java\n    \tserver/test/com/cloud/vpc/MockNetworkManagerImpl.java\n\ncommit 053e18454d105e9785768123259bacc48383bcea\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri May 3 11:07:07 2013 -0700\n\n    InternalLB: marvin integration test for internal lb feature\n\ncommit 2e8e2f98f59eecfc37a2645bd353de7f592d8149\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed May 1 13:53:20 2013 -0700\n\n    InternalLB: don't allow to upgrade the network from the network offering with internal LB to the offering with public LB, and vice versa\n\ncommit c773d204c8e3b4715b3466f732bdff3100f58cfe\nAuthor: Chiradeep Vittal <chiradeep@apache.org>\nDate:   Wed May 1 13:21:52 2013 -0700\n\n    Internal LB: if we detect that we are inside an internal lb vm, call out to the ilb script to perform LB configuration\n\n    Signed-off-by: Chiradeep Vittal <chiradeep@apache.org>\n\ncommit 8c8845bf77f1258e54998f509df6163df82ce24e\nMerge: 7e95545 471ca30\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed May 1 10:14:06 2013 -0700\n\n    Merge branch 'master' into internallb1\n\ncommit 7e9554596f3d0e1d68ada880c2c17c01a526b0f5\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed May 1 10:01:16 2013 -0700\n\n    InternalLb: boot args parameters cleanup for the internal lb vm\n\ncommit b7cf8700749893abcac1d3a3d20ec32c4cb5d37f\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 30 10:31:28 2013 -0700\n\n    InternalLb: more unittests for internal lb element\n\ncommit 63bb98ebe2fa8279138f8b32aa4264b547726224\nAuthor: Chiradeep Vittal <chiradeep@apache.org>\nDate:   Mon Apr 29 18:29:25 2013 -0700\n\n    allow ssh on eth1\n\n    Signed-off-by: Chiradeep Vittal <chiradeep@apache.org>\n\ncommit ca1c313c2901a2ce1e7e6e3ce3a566bbf4c817b4\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 29 17:58:45 2013 -0700\n\n    InternalLb: DB upgrade - update existing physical networks with InternalLbVm provider\n\ncommit ed50caa01c12320c4fa5ff7d4e0818840a6c764d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 29 17:48:36 2013 -0700\n\n    InternalLbVM: handle the scenario when sourceIpAddress is not passed when create internal Lb rule\n\ncommit 4c22c911a9ca5d7e05e9eaf0e971cbe56345fa52\nAuthor: Chiradeep Vittal <chiradeep@apache.org>\nDate:   Mon Apr 29 15:56:00 2013 -0700\n\n    backend support for Internal LB\n\n    Signed-off-by: Chiradeep Vittal <chiradeep@apache.org>\n\ncommit 7b24a7640c53e5b5ab4493de309b43714f4646c6\nMerge: 440e848 a0dbf89\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 29 15:49:48 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tserver/src/com/cloud/api/ApiResponseHelper.java\n    \tserver/src/com/cloud/api/query/QueryManagerImpl.java\n    \tserver/src/com/cloud/configuration/ConfigurationManagerImpl.java\n    \tserver/src/com/cloud/network/NetworkManagerImpl.java\n    \tserver/src/com/cloud/network/firewall/FirewallManagerImpl.java\n    \tsetup/db/db/schema-410to420.sql\n\ncommit 440e8484d66e3e0366b6d61f930fa13a07d0ce5f\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 29 13:27:06 2013 -0700\n\n    InternalLB: unittests for InternalLoadBalancerVMManager\n\ncommit 63babe4b7e8baa1027ac66a7d0b505caafc36d5e\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 26 13:44:01 2013 -0700\n\n    InternalLb:\n\n    1) Added unittests for InternalLoadBalancerVMService\n    2) Added unittests for InternalLoadBalancerElementService\n\ncommit 4f9c47ce54915f9c9eb8042936f3a1b19553399d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 25 14:46:42 2013 -0700\n\n    InternalLb: create internal lb vm specific service offering\n\ncommit 408ee59d1fe64ce5d6a5e57b76e25cc505fda5dc\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 24 17:08:08 2013 -0700\n\n    Internallb: new set of Web services APIs for managing Internal LB VMs\n\ncommit 7680e1cc10b4e48be78668b31ba1af44d1528a67\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 24 17:08:08 2013 -0700\n\n    Internallb:\n\n    1) InternalLb and PublicLb can't be enabled on the same network offering\n    2) Can have internalLb only on VPC tier\n\ncommit d73ca7ef73ce8f16cd355e48a96c0fc35b037fed\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 24 13:02:32 2013 -0700\n\n    InternalLb:\n    1) fixed the bug when the guest nic on internal lb vm wasnt set to be default\n    2) Don't send the rules to the internal lb vm if its in Stopped state\n\ncommit ca2fc30655eace01857181ac50789a6632f51d29\nMerge: 8057567 04a2b2d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 23 16:56:11 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tserver/src/com/cloud/network/vpc/VpcManagerImpl.java\n    \tserver/src/com/cloud/server/ManagementServerImpl.java\n    \tsetup/db/db/schema-410to420.sql\n\ncommit 8057567aaab5000b2f6d3aec8ace65631092adc1\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 23 13:15:36 2013 -0700\n\n    Internallb: more unittests for ApplicationLoadBalancerService\n\ncommit 35c0273b857073a7018fb1a59a33f43f6f112a9c\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 19 16:17:45 2013 -0700\n\n    InternalLb: unittests for ApplicationLoadBalancerService\n\ncommit 69b23f700348a56f97bc2118166799332a47b3a5\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 18 14:01:10 2013 -0700\n\n    InternalLb: create/configure/listInternalLoadBalancerElement - fixes to the API response\n\ncommit a3321ce617eab795288ab75357345d45794db93d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 18 13:31:16 2013 -0700\n\n    Internal LB : renamed the classes responsible for managing internal lb elements. Now the names are InternalLoadBalancerVMManager, InternalLoadBalancerVMService and InternalLoadBalancerVMManagerImpl\n\ncommit 2baf7c365c4847ae49cd90ee25d4e3d7d346464d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 18 10:02:17 2013 -0700\n\n    Internallb: verify requested IP for LB rule (if specified) against guest network cidr\n\ncommit 0cfe96bd00a79ccb9ddebed760c6dde257599074\nMerge: 501f2ff 11162f5\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 17 15:41:51 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tapi/src/com/cloud/network/IpAddress.java\n    \tserver/src/com/cloud/network/NetworkServiceImpl.java\n    \tsetup/db/db/schema-410to420.sql\n\ncommit 501f2ffa0b07e80c17e4d6f7a73721d034c8e46a\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 16 17:03:50 2013 -0700\n\n    InternalLb: validate source ip network as a part of LB rule creation\n\ncommit 4d9a7dfd85f010918749dfe3166d75fe4db68d90\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 16 16:03:32 2013 -0700\n\n    InternalLB: in VPC, restrict public LB to one tier only. Internal LB can be supported on multiple tiers\n\ncommit 8689bf9eb38a416997d5ae4d326c51b57b57553e\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 16 15:59:56 2013 -0700\n\n    Internal LB: added internal lb vm to the list of supported providers in VPC default offering\n\ncommit b7709b89ff94a7c1eeb0e6dff0eca6220a0aed25\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 16 11:04:22 2013 -0700\n\n    Internal Lb: added 2 boolean fields - internal_lb and public_lb - to the network offering. Define if internal or public LB service is supported. In the current release it's either one or another; in the future releases we might support both on the same network\n\ncommit 014689e45eeaedd9b695ec20dfb2db631f433e14\nMerge: b3b16ba 90e8158\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 16 09:55:45 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tapi/src/com/cloud/network/Network.java\n    \tplugins/network-elements/f5/src/com/cloud/network/element/F5ExternalLoadBalancerElement.java\n    \tserver/src/com/cloud/network/NetworkManagerImpl.java\n    \tserver/src/com/cloud/network/NetworkServiceImpl.java\n    \tserver/test/com/cloud/network/MockNetworkManagerImpl.java\n    \tserver/test/com/cloud/vpc/MockNetworkManagerImpl.java\n    \tsetup/db/db/schema-410to420.sql\n\ncommit b3b16bae48976c027e3439f2e0a84cfb2cb72166\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 15 17:00:31 2013 -0700\n\n    InternalLB: allow to specify more than one provider for the LB service when create network offering as diff providers can support internal and public LB for the same network\n\ncommit a4fc1d7d65191da6a49bce9fa0a64ce6e46ac85d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 15 13:45:25 2013 -0700\n\n    Internal LB:\n\n    1) Added network_offering_details DB table and corresponding VO/DAO objects. Change createNetworkOffering web services api to accept the map of key/value pairs as details.\n    2) Allow to have multiple providers for the same service for the network to support the case when LB service can have separate providers for Internal LB and Public LB\n\ncommit 4530cebf2bef515f86fa29b3798d51e81089f92f\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 15 10:06:10 2013 -0700\n\n    InternalLbVm: support for start/stop Internal lb vm\n\ncommit ae69f0ae5612834b8bc911bd074cfb050c0b164c\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 12 17:25:02 2013 -0700\n\n    InternalLb: fixed prepare() in InternalLbElement - have to prepare nics of User vms only\n\ncommit 888a83c22111f3792850e6bb6235d30a93408d1d\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 12 15:58:27 2013 -0700\n\n    InternalLb: Start/deploy internal LB vms for the existing LB rules as a part of network implement\n\ncommit 3b41d5bee1ac04d3e9cf837a2be4398b7597d1a0\nMerge: bb73531 4b1a9f1\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 12 15:32:40 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tserver/src/com/cloud/network/NetworkModelImpl.java\n    \tserver/src/com/cloud/server/ManagementServerImpl.java\n\ncommit bb73531fed72cc81012624fd3bae5ec22d23daa2\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 12 15:13:55 2013 -0700\n\n    Internal Lb: list internal lb vms as a part of listRouters response. Introduced new parameter - role (can be virtual_router or internal_lb_vm)\n\ncommit c113ea184b575ccae5d2be411c5bbc345473e35e\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 12 12:00:09 2013 -0700\n\n    Add Internal Lb Provider/Element as a part of adding a physical network\n\ncommit 78c9db79dae3bc38699050b05baae32fd02204f6\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 12 10:05:28 2013 -0700\n\n    InternalLbVm: destroy the internal lb vm when the last rule for the ip is being revoked\n\ncommit af6201257b28a0d9177330c8c76b0ec979725870\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 11 16:55:37 2013 -0700\n\n    Internal LB: fixed some bugs in internal lb vm startup process\n\ncommit 1db240c2b668e6cbbea4e09979c34d84fe54a624\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 11 14:23:55 2013 -0700\n\n    InternalLb: fixed searchCriteria constructor in ApplicationLoadBalancerDaoImpl\n\ncommit 3795048fcc68ef23c24d82c9064946dfc082b1b6\nMerge: f4c2b53 5f8a278\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 11 14:09:31 2013 -0700\n\n    Merge branch 'master' into internallb1\n\n    Conflicts:\n    \tapi/src/com/cloud/async/AsyncJob.java\n    \tapi/src/org/apache/cloudstack/api/ApiConstants.java\n    \tapi/src/org/apache/cloudstack/api/BaseCmd.java\n    \tapi/src/org/apache/cloudstack/api/ResponseGenerator.java\n    \tclient/tomcatconf/commands.properties.in\n    \tserver/src/com/cloud/api/ApiDBUtils.java\n    \tserver/src/com/cloud/api/ApiResponseHelper.java\n    \tserver/src/com/cloud/server/ManagementServerImpl.java\n    \tsetup/db/db/schema-410to420.sql\n\ncommit f4c2b53c218b2d11d510b9acc6baeb0d62042e5c\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 11 13:46:47 2013 -0700\n\n    InternalLB: modified InternalLbElement to start the Internal Lb vm for each ip address (if not already started)\n\ncommit 76a4b1cf81610d931d6098ca94fa509c9ba2e274\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 11 11:41:47 2013 -0700\n\n    InternalLB: added logic for acquiring guest ip address for the Internal LB rule\n\ncommit 915e39fbaa9a6b6898e2aa13cbf8ef60a7b9d70e\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 11 10:19:18 2013 -0700\n\n    Removed unused methods doing ipAllocation from GuestNetworkGuru and NetworkServiceImpl. The correct method is located in NetworkModelImpl\n\ncommit 3f2a62c7f62d23da23f65ff3842049243ef268e3\nMerge: 20beb7a a0b5ebc\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 10 17:16:07 2013 -0700\n\n    Merge branch 'master' into internallb1\n\ncommit 20beb7a16c1a592cd7500148ea8988fe119d34fb\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 10 15:28:12 2013 -0700\n\n    Internal LB: applyLoadBalancerRules - put not null check for sourceIpAddressId (can be null when Schema is not Public)\n\ncommit 87e5f5b9a6b006893ee30662fc06ea430e7b70dc\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Wed Apr 10 15:17:58 2013 -0700\n\n    Internal LB: intermediate checkin - added InternalLBAppliance manager and managerImpl\n\ncommit 53b9c0d142bd2b99dd00c17987dcf5dc54e3ef56\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 9 17:55:10 2013 -0700\n\n    Internal LB: added @Since to API docs for Internal LB related commands\n\ncommit 867b305ea852dcbe224645dc4e5ffb950d8db8f7\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 9 17:51:19 2013 -0700\n\n    Internal LB: Made InternalLbElement to extend the ip deployer as the LB service implements IPDeployerRequester\n\ncommit 7b9af2809410132db451e48b7b829bf019512a92\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 9 15:45:30 2013 -0700\n\n    InternalLb: new set of Web Services APIs to add InternalLB as a network element to the cloudStack (the element is packaged as an independent plugin). New APIs:\n\n    1) configureInternalLoadBalancerElement\n    2) createInternalLoadBalancerElement\n    3) listInternalLoadBalancerElements\n\ncommit 039e303d4aec5618cc3914ee1a581d2f7b926e1c\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 9 14:01:11 2013 -0700\n\n    InternalLB: Modified pluggable service VirtualRouterElementService to accept only VirtualRouter and VpcVirtualRouter as a VirtualRouterProvider type when add/configure elements. Other VirtualRouterProviderTypes are are taken care by elb/internal lb plugins.\n\ncommit f0018b451281bf02964dbe71d704c9a931783cae\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Tue Apr 9 12:56:42 2013 -0700\n\n    Internal LB:\n\n    1)Added InternalLoadBalancerManager and corresponding Impl\n    2)Add InternalLbVm as a default CS provider. DB upgrade is covered as well\n\ncommit e344cf250af6a67a17f082f1c646e6ef5ce9a0a7\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 8 16:57:47 2013 -0700\n\n    InternalLB - removed unused code from LoadBalancerDao\n\ncommit 3588f468482e43181802730ed5a059897eb85458\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 8 16:23:03 2013 -0700\n\n    Internal LB - added network-element plugin for internal lb service\n\ncommit 76325e61681c7e191308b27514ba69e523cf12bd\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 8 13:58:08 2013 -0700\n\n    Internal Lb:\n\n    1) When network has both kinds of LB rules - Public and Internal - never send them in the same set to the provider\n    2) Added extra checks on the provider side to validate if the schema - Public or Internal - is supported.\n\ncommit 56c2fe1d376c407a248fba789dd67ff36493a0ed\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 8 12:34:59 2013 -0700\n\n    InternalLB:\n\n    1) Added new capability for the LB service - LbSchemes. Can take 2 values - Internal and Public.\n    2) F5 and Netscaler LB providers - changes all LB related methods to accept LoadBalancingRule instead of ? extends FirewallRule.\n\ncommit 34bcb2d026e1951f7b115d71830c69e1ad5ed89a\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Mon Apr 8 12:11:11 2013 -0700\n\n    InternalLB: implemented list/delete/create web services API commands that will be used for Internal LB creation\n\ncommit 9ab31e11f7ebd431f9ebdf9d8582f5c126b14928\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Fri Apr 5 15:59:55 2013 -0700\n\n    InternalLB: change LoadBalancingRule - reference sourceIpAddress of th load balancer by its value, not DB id\n\ncommit 08f855d4e4b3888b3b4a163ce73c0e444b91e6b7\nAuthor: Alena Prokharchyk <alena.prokharchyk@citrix.com>\nDate:   Thu Apr 4 09:26:21 2013 -0700\n\n    InternalLB:\n\n    1) Added new set of Interfaces - including the new VO - for the internal load balancer\n    2) DB change - added source_ip_address/source_ip_address_network_id/scheme (Internal/Public) fields to the load_balancer table",
        "parent": "https://github.com/apache/cloudstack/commit/8f9a42e0af7424517c7853197a781c0c81addad1",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkTest.java",
            "NetworkModelTest.java",
            "BaseCmdTest.java",
            "ElasticLoadBalancerManagerImplTest.java",
            "ApiResponseHelperTest.java",
            "ConfigTest.java",
            "ConfigurationManagerTest.java",
            "ExternalLoadBalancerDeviceManagerImplTest.java",
            "VirtualRouterElementTest.java",
            "VirtualNetworkApplianceManagerImplTest.java",
            "VpcManagerImplTest.java",
            "ConfigurationServerImplTest.java",
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_2694ad7": {
        "bug_id": "cloudstack_2694ad7",
        "commit": "https://github.com/apache/cloudstack/commit/2694ad7bd91671629831f9feede879cb24d05d69",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/2694ad7bd91671629831f9feede879cb24d05d69/server/src/com/cloud/api/ApiServlet.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiServlet.java?ref=2694ad7bd91671629831f9feede879cb24d05d69",
                "deletions": 3,
                "filename": "server/src/com/cloud/api/ApiServlet.java",
                "patch": "@@ -201,9 +201,6 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                             } catch (final IllegalStateException ignored) {\n                             }\n                         }\n-                    } else {\n-                        auditTrailSb.insert(0, \"(userId=\" + session.getAttribute(\"userid\") + \" accountId=\" + ((Account) session.getAttribute(\"accountobj\")).getId() +\n-                                \" sessionId=\" + session.getId() + \")\");\n                     }\n                     HttpUtils.writeHttpResponse(resp, responseString, httpResponseCode, responseType);\n                     return;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2694ad7bd91671629831f9feede879cb24d05d69/server/src/com/cloud/api/ApiServlet.java",
                "sha": "8dff6ebc952241a88f9cd9e99399f8f5ffab8613",
                "status": "modified"
            }
        ],
        "message": "ApiServlet: Fix NPE while inserting to auditTrail\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/a1dc9e8189ebdab3f7e8b849f1777f282a7a295b",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiServletTest.java"
        ]
    },
    "cloudstack_27ba020": {
        "bug_id": "cloudstack_27ba020",
        "commit": "https://github.com/apache/cloudstack/commit/27ba0208f068e60f588d25a5d0ad9c4d6503ad14",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/27ba0208f068e60f588d25a5d0ad9c4d6503ad14/server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java?ref=27ba0208f068e60f588d25a5d0ad9c4d6503ad14",
                "deletions": 4,
                "filename": "server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java",
                "patch": "@@ -819,7 +819,8 @@ private MappingNic getLoadBalancingIpNic(DataCenterVO zone, Network network, lon\n                 }\n             } else {\n                 s_logger.debug(\"Revoking a rule for an inline load balancer that has not been programmed yet.\");\n-                return null;\n+                nic.setNic(null);\n+                return nic;\n             }\n         }\n         \n@@ -877,9 +878,9 @@ public boolean applyLoadBalancerRules(Network network, List<? extends FirewallRu\n                 MappingNic nic = getLoadBalancingIpNic(zone, network, rule.getSourceIpAddressId(), revoked, null);\n                 mappingStates.add(nic.getState());\n                 NicVO loadBalancingIpNic = nic.getNic();\n-                        if (loadBalancingIpNic == null) {\n-                        continue;\n-                    }\n+                if (loadBalancingIpNic == null) {\n+                \tcontinue;\n+                }\n \n                 // Change the source IP address for the load balancing rule to be the load balancing IP address\n                 srcIp = loadBalancingIpNic.getIp4Address();",
                "raw_url": "https://github.com/apache/cloudstack/raw/27ba0208f068e60f588d25a5d0ad9c4d6503ad14/server/src/com/cloud/network/ExternalLoadBalancerDeviceManagerImpl.java",
                "sha": "d7b6d78c9bba1540919f62f96c54c7679780ec16",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-1315: Fix NPE when try to upgrade network from VR to SRX-F5\n\nStill return a valid object when reverting non-existed rules.",
        "parent": "https://github.com/apache/cloudstack/commit/e31cd2b3d20fcd6f7e42bb44fe38f714aae04003",
        "repo": "cloudstack",
        "unit_tests": [
            "ExternalLoadBalancerDeviceManagerImplTest.java"
        ]
    },
    "cloudstack_287a695": {
        "bug_id": "cloudstack_287a695",
        "commit": "https://github.com/apache/cloudstack/commit/287a695664dfddebd600385210ba80be5b5b76ef",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/287a695664dfddebd600385210ba80be5b5b76ef/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=287a695664dfddebd600385210ba80be5b5b76ef",
                "deletions": 8,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -824,14 +824,12 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            if (vm != null) {\n-                volResponse.setVirtualMachineId(vm.getId());\n-                volResponse.setVirtualMachineName(vm.getHostName());\n-                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-                if (userVm != null) {\n-                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                    volResponse.setVirtualMachineState(vm.getState().toString());\n-                }\n+            volResponse.setVirtualMachineId(vm.getId());\n+            volResponse.setVirtualMachineName(vm.getHostName());\n+            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+            if (userVm != null) {\n+                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                volResponse.setVirtualMachineState(vm.getState().toString());\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/287a695664dfddebd600385210ba80be5b5b76ef/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "cb7a3a5521960098b06a97cf7ad26908ca42d1f0",
                "status": "modified"
            }
        ],
        "message": "Revert \"fix NPE when listvolume if vm got destroyed\"\n\nThis reverts commit d028454ab46f1e901e2517dd64a0b8a9780c9968.",
        "parent": "https://github.com/apache/cloudstack/commit/4df7423f70e6dc31f1ab5040e17f63f4c2103c4c",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_2b7b837": {
        "bug_id": "cloudstack_2b7b837",
        "commit": "https://github.com/apache/cloudstack/commit/2b7b837b28f847eedf3cd7bd034dc23ba43d8a63",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2b7b837b28f847eedf3cd7bd034dc23ba43d8a63/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=2b7b837b28f847eedf3cd7bd034dc23ba43d8a63",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1843,7 +1843,7 @@ protected void migrate(VMInstanceVO vm, long srcHostId, DeployDestination dest)\n             vmSrc.addNic(nic);\n         }\n \n-        VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+        VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, _offeringDao.findById(vm.getId(), vm.getServiceOfferingId()), null, null);\n         _networkMgr.prepareNicForMigration(profile, dest);\n         volumeMgr.prepareForMigration(profile, dest);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2b7b837b28f847eedf3cd7bd034dc23ba43d8a63/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "0e12bcb26740c976cdb4a21845ff23ebe212cb8c",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6099 live migration is failing for vm deployed using dynaic compute offerings with NPE",
        "parent": "https://github.com/apache/cloudstack/commit/70142c4acb84a2d2b1fe8806c159493e4a556532",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_2c31f38": {
        "bug_id": "cloudstack_2c31f38",
        "commit": "https://github.com/apache/cloudstack/commit/2c31f38c05c16d661812cb89317eb2d4e6c8faf3",
        "file": [
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/cloudstack/blob/2c31f38c05c16d661812cb89317eb2d4e6c8faf3/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 156,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=2c31f38c05c16d661812cb89317eb2d4e6c8faf3",
                "deletions": 111,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -42,7 +42,6 @@\n import javax.naming.ConfigurationException;\n \n import org.apache.cloudstack.api.command.admin.storage.AddImageStoreCmd;\n-import com.cloud.server.ConfigurationServer;\n import org.apache.cloudstack.api.command.admin.storage.CancelPrimaryStorageMaintenanceCmd;\n import org.apache.cloudstack.api.command.admin.storage.CreateCacheStoreCmd;\n import org.apache.cloudstack.api.command.admin.storage.CreateStoragePoolCmd;\n@@ -55,25 +54,21 @@\n import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreManager;\n import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreProvider;\n import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreProviderManager;\n-import org.apache.cloudstack.engine.subsystem.api.storage.EndPoint;\n import org.apache.cloudstack.engine.subsystem.api.storage.EndPointSelector;\n import org.apache.cloudstack.engine.subsystem.api.storage.HostScope;\n import org.apache.cloudstack.engine.subsystem.api.storage.HypervisorHostListener;\n-import org.apache.cloudstack.engine.subsystem.api.storage.SnapshotInfo;\n-import org.apache.cloudstack.engine.subsystem.api.storage.TemplateDataFactory;\n import org.apache.cloudstack.engine.subsystem.api.storage.ImageStoreProvider;\n import org.apache.cloudstack.engine.subsystem.api.storage.PrimaryDataStoreInfo;\n import org.apache.cloudstack.engine.subsystem.api.storage.SnapshotDataFactory;\n+import org.apache.cloudstack.engine.subsystem.api.storage.SnapshotInfo;\n import org.apache.cloudstack.engine.subsystem.api.storage.StoragePoolAllocator;\n-import org.apache.cloudstack.engine.subsystem.api.storage.TemplateInfo;\n+import org.apache.cloudstack.engine.subsystem.api.storage.TemplateDataFactory;\n import org.apache.cloudstack.engine.subsystem.api.storage.TemplateService;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n-import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService.VolumeApiResult;\n import org.apache.cloudstack.engine.subsystem.api.storage.ZoneScope;\n import org.apache.cloudstack.framework.async.AsyncCallFuture;\n-import org.apache.cloudstack.storage.command.DeleteCommand;\n import org.apache.cloudstack.storage.datastore.db.ImageStoreDao;\n import org.apache.cloudstack.storage.datastore.db.ImageStoreDetailsDao;\n import org.apache.cloudstack.storage.datastore.db.ImageStoreVO;\n@@ -132,9 +127,9 @@\n import com.cloud.org.Grouping;\n import com.cloud.org.Grouping.AllocationState;\n import com.cloud.resource.ResourceState;\n+import com.cloud.server.ConfigurationServer;\n import com.cloud.server.ManagementServer;\n import com.cloud.server.StatsCollector;\n-import com.cloud.service.dao.ServiceOfferingDao;\n import com.cloud.service.ServiceOfferingVO;\n import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.storage.Storage.StoragePoolType;\n@@ -146,9 +141,6 @@\n import com.cloud.storage.dao.VMTemplatePoolDao;\n import com.cloud.storage.dao.VMTemplateZoneDao;\n import com.cloud.storage.dao.VolumeDao;\n-import com.cloud.storage.dao.VolumeHostDao;\n-import com.cloud.storage.DiskOfferingVO;\n-import com.cloud.storage.download.DownloadMonitor;\n import com.cloud.storage.listener.StoragePoolMonitor;\n import com.cloud.storage.listener.VolumeStateListener;\n import com.cloud.template.TemplateManager;\n@@ -631,7 +623,7 @@ public DataStore createLocalStorage(Host host, StoragePoolInfo pInfo) throws Con\n \n                 store = lifeCycle.initialize(params);\n             } else {\n-                store = (DataStore) dataStoreMgr.getDataStore(pool.getId(), DataStoreRole.Primary);\n+                store = dataStoreMgr.getDataStore(pool.getId(), DataStoreRole.Primary);\n             }\n \n             HostScope scope = new HostScope(host.getId(), host.getDataCenterId());\n@@ -641,13 +633,13 @@ public DataStore createLocalStorage(Host host, StoragePoolInfo pInfo) throws Con\n             throw new ConnectionException(true, \"Unable to setup the local storage pool for \" + host, e);\n         }\n \n-        return (DataStore) dataStoreMgr.getDataStore(store.getId(), DataStoreRole.Primary);\n+        return dataStoreMgr.getDataStore(store.getId(), DataStoreRole.Primary);\n     }\n \n     @Override\n     @SuppressWarnings(\"rawtypes\")\n     public PrimaryDataStoreInfo createPool(CreateStoragePoolCmd cmd) throws ResourceInUseException, IllegalArgumentException, UnknownHostException,\n-            ResourceUnavailableException {\n+    ResourceUnavailableException {\n         String providerName = cmd.getStorageProviderName();\n         DataStoreProvider storeProvider = dataStoreProviderMgr.getDataStoreProvider(providerName);\n \n@@ -695,7 +687,7 @@ public PrimaryDataStoreInfo createPool(CreateStoragePoolCmd cmd) throws Resource\n                         \"Missing parameter hypervisor. Hypervisor type is required to create zone wide primary storage.\");\n             }\n             if (hypervisorType != HypervisorType.KVM && hypervisorType != HypervisorType.VMware &&\n-                hypervisorType != HypervisorType.Any) {\n+                    hypervisorType != HypervisorType.Any) {\n                 throw new InvalidParameterValueException(\n                         \"zone wide storage pool is not supported for hypervisor type \" + hypervisor);\n             }\n@@ -883,16 +875,16 @@ public void createCapacityEntry(StoragePoolVO storagePool, short capacityType, l\n         if (storagePool.getPoolType() == StoragePoolType.NetworkFilesystem) {\n             BigDecimal overProvFactor = getStorageOverProvisioningFactor(storagePool.getDataCenterId());\n             totalOverProvCapacity = overProvFactor.multiply(new BigDecimal(storagePool.getCapacityBytes())).longValue();// All\n-                                                                                                                        // this\n-                                                                                                                        // for\n-                                                                                                                        // the\n-                                                                                                                        // inaccuracy\n-                                                                                                                        // of\n-                                                                                                                        // floats\n-                                                                                                                        // for\n-                                                                                                                        // big\n-                                                                                                                        // number\n-                                                                                                                        // multiplication.\n+            // this\n+            // for\n+            // the\n+            // inaccuracy\n+            // of\n+            // floats\n+            // for\n+            // big\n+            // number\n+            // multiplication.\n         } else {\n             totalOverProvCapacity = storagePool.getCapacityBytes();\n         }\n@@ -1103,63 +1095,34 @@ public void cleanupStorage(boolean recurring) {\n     @Override\n     @DB\n     public void cleanupSecondaryStorage(boolean recurring) {\n+        // NOTE that object_store refactor will immediately delete the object from secondary storage when deleteTemplate etc api is issued.\n+        // so here we don't need to issue DeleteCommand to resource anymore, only need to remove db entry.\n         try {\n-            // Cleanup templates in secondary storage hosts\n+            // Cleanup templates in template_store_ref\n             List<DataStore> imageStores = this.dataStoreMgr.getImageStoresByScope(new ZoneScope(null));\n             for (DataStore store : imageStores) {\n                 try {\n                     long storeId = store.getId();\n                     List<TemplateDataStoreVO> destroyedTemplateStoreVOs = this._templateStoreDao.listDestroyed(storeId);\n                     s_logger.debug(\"Secondary storage garbage collector found \" + destroyedTemplateStoreVOs.size()\n-                            + \" templates to cleanup on secondary storage host: \" + store.getName());\n+                            + \" templates to cleanup on template_store_ref for store: \" + store.getName());\n                     for (TemplateDataStoreVO destroyedTemplateStoreVO : destroyedTemplateStoreVOs) {\n-                        if (!_tmpltMgr.templateIsDeleteable(destroyedTemplateStoreVO.getTemplateId())) {\n-                            if (s_logger.isDebugEnabled()) {\n-                                s_logger.debug(\"Not deleting template at: \" + destroyedTemplateStoreVO);\n-                            }\n-                            continue;\n-                        }\n-\n                         if (s_logger.isDebugEnabled()) {\n-                            s_logger.debug(\"Deleting template store: \" + destroyedTemplateStoreVO);\n-                        }\n-\n-                        VMTemplateVO destroyedTemplate = this._vmTemplateDao.findById(destroyedTemplateStoreVO.getTemplateId());\n-                        if (destroyedTemplate == null) {\n-                            s_logger.error(\"Cannot find template : \" + destroyedTemplateStoreVO.getTemplateId() + \" from template table\");\n-                            throw new CloudRuntimeException(\"Template \" + destroyedTemplateStoreVO.getTemplateId()\n-                                    + \" is found in secondary storage, but not found in template table\");\n-                        }\n-                        String installPath = destroyedTemplateStoreVO.getInstallPath();\n-\n-                        TemplateInfo tmpl = tmplFactory.getTemplate(destroyedTemplateStoreVO.getTemplateId(), store);\n-                        if (installPath != null) {\n-                            EndPoint ep = _epSelector.select(store);\n-                            Command cmd = new DeleteCommand(tmpl.getTO());\n-                            Answer answer = ep.sendMessage(cmd);\n-\n-                            if (answer == null || !answer.getResult()) {\n-                                s_logger.debug(\"Failed to delete \" + destroyedTemplateStoreVO + \" due to \"\n-                                        + ((answer == null) ? \"answer is null\" : answer.getDetails()));\n-                            } else {\n-                                _templateStoreDao.remove(destroyedTemplateStoreVO.getId());\n-                                s_logger.debug(\"Deleted template at: \" + destroyedTemplateStoreVO.getInstallPath());\n-                            }\n-                        } else {\n-                            _templateStoreDao.remove(destroyedTemplateStoreVO.getId());\n+                            s_logger.debug(\"Deleting template store DB entry: \" + destroyedTemplateStoreVO);\n                         }\n+                        _templateStoreDao.remove(destroyedTemplateStoreVO.getId());\n                     }\n                 } catch (Exception e) {\n-                    s_logger.warn(\"problem cleaning up templates in secondary storage store \" + store.getName(), e);\n+                    s_logger.warn(\"problem cleaning up templates in template_store_ref for store: \" + store.getName(), e);\n                 }\n             }\n \n-            // CleanUp snapshots on Secondary Storage.\n+            // CleanUp snapshots on snapshot_store_ref\n             for (DataStore store : imageStores) {\n                 try {\n                     List<SnapshotDataStoreVO> destroyedSnapshotStoreVOs = _snapshotStoreDao.listDestroyed(store.getId());\n                     s_logger.debug(\"Secondary storage garbage collector found \" + destroyedSnapshotStoreVOs.size()\n-                            + \" snapshots to cleanup on secondary storage host: \" + store.getName());\n+                            + \" snapshots to cleanup on snapshot_store_ref for store: \" + store.getName());\n                     for (SnapshotDataStoreVO destroyedSnapshotStoreVO : destroyedSnapshotStoreVOs) {\n                         // check if this snapshot has child\n                         SnapshotInfo snap = snapshotFactory.getSnapshot(destroyedSnapshotStoreVO.getSnapshotId(), store);\n@@ -1169,70 +1132,37 @@ public void cleanupSecondaryStorage(boolean recurring) {\n                         }\n \n                         if (s_logger.isDebugEnabled()) {\n-                            s_logger.debug(\"Deleting snapshot on store: \" + destroyedSnapshotStoreVO);\n+                            s_logger.debug(\"Deleting snapshot store DB entry: \" + destroyedSnapshotStoreVO);\n                         }\n \n-                        String installPath = destroyedSnapshotStoreVO.getInstallPath();\n-\n-                        if (installPath != null) {\n-                            EndPoint ep = _epSelector.select(store);\n-                            DeleteCommand cmd = new DeleteCommand(snap.getTO());\n-                            Answer answer = ep.sendMessage(cmd);\n-                            if (answer == null || !answer.getResult()) {\n-                                s_logger.debug(\"Failed to delete \" + destroyedSnapshotStoreVO + \" due to \"\n-                                        + ((answer == null) ? \"answer is null\" : answer.getDetails()));\n-                            } else {\n-                                _volumeStoreDao.remove(destroyedSnapshotStoreVO.getId());\n-                                s_logger.debug(\"Deleted snapshot at: \" + destroyedSnapshotStoreVO.getInstallPath());\n-                            }\n-                        } else {\n-                            _snapshotStoreDao.remove(destroyedSnapshotStoreVO.getId());\n-                        }\n+                        _snapshotStoreDao.remove(destroyedSnapshotStoreVO.getId());\n                     }\n \n                 } catch (Exception e2) {\n-                    s_logger.warn(\"problem cleaning up snapshots in secondary storage store \" + store.getName(), e2);\n+                    s_logger.warn(\"problem cleaning up snapshots in snapshot_store_ref for store: \" + store.getName(), e2);\n                 }\n \n             }\n \n-            // CleanUp volumes on Secondary Storage.\n+            // CleanUp volumes on volume_store_ref\n             for (DataStore store : imageStores) {\n                 try {\n                     List<VolumeDataStoreVO> destroyedStoreVOs = _volumeStoreDao.listDestroyed(store.getId());\n                     s_logger.debug(\"Secondary storage garbage collector found \" + destroyedStoreVOs.size()\n-                            + \" volumes to cleanup on secondary storage host: \" + store.getName());\n+                            + \" volumes to cleanup on volume_store_ref for store: \" + store.getName());\n                     for (VolumeDataStoreVO destroyedStoreVO : destroyedStoreVOs) {\n                         if (s_logger.isDebugEnabled()) {\n-                            s_logger.debug(\"Deleting volume on store: \" + destroyedStoreVO);\n-                        }\n-\n-                        String installPath = destroyedStoreVO.getInstallPath();\n-\n-                        VolumeInfo vol = this.volFactory.getVolume(destroyedStoreVO.getVolumeId(), store);\n-\n-                        if (installPath != null) {\n-                            EndPoint ep = _epSelector.select(store);\n-                            DeleteCommand cmd = new DeleteCommand(vol.getTO());\n-                            Answer answer = ep.sendMessage(cmd);\n-                            if (answer == null || !answer.getResult()) {\n-                                s_logger.debug(\"Failed to delete \" + destroyedStoreVO + \" due to \"\n-                                        + ((answer == null) ? \"answer is null\" : answer.getDetails()));\n-                            } else {\n-                                _volumeStoreDao.remove(destroyedStoreVO.getId());\n-                                s_logger.debug(\"Deleted volume at: \" + destroyedStoreVO.getInstallPath());\n-                            }\n-                        } else {\n-                            _volumeStoreDao.remove(destroyedStoreVO.getId());\n+                            s_logger.debug(\"Deleting volume store DB entry: \" + destroyedStoreVO);\n                         }\n+                        _volumeStoreDao.remove(destroyedStoreVO.getId());\n                     }\n \n                 } catch (Exception e2) {\n-                    s_logger.warn(\"problem cleaning up volumes in secondary storage store \" + store.getName(), e2);\n+                    s_logger.warn(\"problem cleaning up volumes in volume_store_ref for store: \" + store.getName(), e2);\n                 }\n             }\n         } catch (Exception e3) {\n-            s_logger.warn(\"problem cleaning up secondary storage \", e3);\n+            s_logger.warn(\"problem cleaning up secondary storage DB entries. \", e3);\n         }\n     }\n \n@@ -1251,7 +1181,7 @@ public String getPrimaryStorageNameLabel(VolumeVO volume) {\n     @Override\n     @DB\n     public PrimaryDataStoreInfo preparePrimaryStorageForMaintenance(Long primaryStorageId) throws ResourceUnavailableException,\n-            InsufficientCapacityException {\n+    InsufficientCapacityException {\n         Long userId = UserContext.current().getCallerUserId();\n         User user = _userDao.findById(userId);\n         Account account = UserContext.current().getCaller();\n@@ -1356,7 +1286,7 @@ public void onManagementNodeLeft(List<ManagementServerHostVO> nodeList, long sel\n                         if (pool != null\n                                 && (pool.getStatus().equals(StoragePoolStatus.ErrorInMaintenance)\n                                         || pool.getStatus().equals(StoragePoolStatus.PrepareForMaintenance) || pool.getStatus().equals(\n-                                        StoragePoolStatus.CancelMaintenance))) {\n+                                                StoragePoolStatus.CancelMaintenance))) {\n                             _storagePoolWorkDao.removePendingJobsOnMsRestart(vo.getMsid(), poolId);\n                             pool.setStatus(StoragePoolStatus.ErrorInMaintenance);\n                             _storagePoolDao.update(poolId, pool);\n@@ -1567,8 +1497,9 @@ private boolean checkUsagedSpace(StoragePool pool) {\n     @Override\n     public boolean storagePoolHasEnoughIops(List<Volume> requestedVolumes,\n             StoragePool pool) {\n-        if (requestedVolumes == null || requestedVolumes.isEmpty() || pool == null)\n+        if (requestedVolumes == null || requestedVolumes.isEmpty() || pool == null) {\n             return false;\n+        }\n \n         long currentIops = 0;\n \n@@ -1600,11 +1531,13 @@ public boolean storagePoolHasEnoughIops(List<Volume> requestedVolumes,\n     @Override\n     public boolean storagePoolHasEnoughSpace(List<Volume> volumes,\n             StoragePool pool) {\n-        if (volumes == null || volumes.isEmpty())\n+        if (volumes == null || volumes.isEmpty()){\n             return false;\n+        }\n \n-        if (!checkUsagedSpace(pool))\n+        if (!checkUsagedSpace(pool)) {\n             return false;\n+        }\n \n         // allocated space includes template of specified volume\n         StoragePoolVO poolVO = _storagePoolDao.findById(pool.getId());\n@@ -1617,8 +1550,9 @@ public boolean storagePoolHasEnoughSpace(List<Volume> volumes,\n                     allocatedSizeWithtemplate = _capacityMgr.getAllocatedPoolCapacity(poolVO, tmpl);\n                 }\n             }\n-            if (volume.getState() != Volume.State.Ready)\n+            if (volume.getState() != Volume.State.Ready) {\n                 totalAskingSize = totalAskingSize + volume.getSize();\n+            }\n         }\n \n         long totalOverProvCapacity;",
                "raw_url": "https://github.com/apache/cloudstack/raw/2c31f38c05c16d661812cb89317eb2d4e6c8faf3/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "ff323cbbedfb03a16f65510d8e6e1d72d23076ae",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3145:StorageManager-Scavenger NPEs when cleaning up\ntemplates.",
        "parent": "https://github.com/apache/cloudstack/commit/1659ee225c936b074bae1ede955194f60c546c02",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_2c3c88e": {
        "bug_id": "cloudstack_2c3c88e",
        "commit": "https://github.com/apache/cloudstack/commit/2c3c88e2092dae44de823cf52cb3e2cc787bb3a1",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/2c3c88e2092dae44de823cf52cb3e2cc787bb3a1/core/src/main/java/com/cloud/info/ConsoleProxyInfo.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/main/java/com/cloud/info/ConsoleProxyInfo.java?ref=2c3c88e2092dae44de823cf52cb3e2cc787bb3a1",
                "deletions": 9,
                "filename": "core/src/main/java/com/cloud/info/ConsoleProxyInfo.java",
                "patch": "@@ -55,18 +55,16 @@ public ConsoleProxyInfo(boolean sslEnabled, String proxyIpAddress, int port, int\n \n     private String formatProxyAddress(String consoleProxyUrlDomain, String proxyIpAddress) {\n         StringBuffer sb = new StringBuffer();\n-        // Domain in format *.example.com, proxy IP is 1.2.3.4 --> 1-2-3-4.example.com\n-        if (consoleProxyUrlDomain.startsWith(\"*\")) {\n+        if (StringUtils.isBlank(consoleProxyUrlDomain)) {\n+            // Blank config, we use the proxy IP\n+            sb.append(proxyIpAddress);\n+        } else if (consoleProxyUrlDomain.startsWith(\"*\")) {\n+            // Domain in format *.example.com, proxy IP is 1.2.3.4 --> 1-2-3-4.example.com\n             sb.append(proxyIpAddress.replaceAll(\"\\\\.\", \"-\"));\n             sb.append(consoleProxyUrlDomain.substring(1)); // skip the *\n-\n-        // Otherwise we assume a valid domain if config not blank\n-        } else if (StringUtils.isNotBlank(consoleProxyUrlDomain)) {\n-            sb.append(consoleProxyUrlDomain);\n-\n-        // Blank config, we use the proxy IP\n         } else {\n-            sb.append(proxyIpAddress);\n+            // Otherwise we assume a valid domain if config not blank\n+            sb.append(consoleProxyUrlDomain);\n         }\n         return sb.toString();\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/2c3c88e2092dae44de823cf52cb3e2cc787bb3a1/core/src/main/java/com/cloud/info/ConsoleProxyInfo.java",
                "sha": "7e1be6a9cadbad623e2a745c161a4ccde22d7765",
                "status": "modified"
            }
        ],
        "message": "console-proxy: fix potential NPE condition (#3419)\n\nWhen checking if the console proxy URL domain starts with *, the code\r\ndoes not check if the provided string is null. When domain is not\r\nconfigured the IP address should be used.\r\n\r\nFixes #3164\r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/6784cc516b76fb73b9f454c1ffaddb9a6c928a82",
        "repo": "cloudstack",
        "unit_tests": [
            "ConsoleProxyInfoTest.java"
        ]
    },
    "cloudstack_2e29c89": {
        "bug_id": "cloudstack_2e29c89",
        "commit": "https://github.com/apache/cloudstack/commit/2e29c89b841f6c00e30ea8fdc02510c2dbb41d39",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2e29c89b841f6c00e30ea8fdc02510c2dbb41d39/framework/config/src/org/apache/cloudstack/framework/config/impl/ConfigDepotImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/config/src/org/apache/cloudstack/framework/config/impl/ConfigDepotImpl.java?ref=2e29c89b841f6c00e30ea8fdc02510c2dbb41d39",
                "deletions": 5,
                "filename": "framework/config/src/org/apache/cloudstack/framework/config/impl/ConfigDepotImpl.java",
                "patch": "@@ -25,13 +25,13 @@\n import javax.inject.Inject;\n \n import org.apache.log4j.Logger;\n-\n import org.apache.cloudstack.framework.config.ConfigDepot;\n import org.apache.cloudstack.framework.config.ConfigDepotAdmin;\n import org.apache.cloudstack.framework.config.ConfigKey;\n import org.apache.cloudstack.framework.config.Configurable;\n import org.apache.cloudstack.framework.config.ScopedConfigStorage;\n import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.commons.lang.ObjectUtils;\n \n import com.cloud.utils.Pair;\n import com.cloud.utils.component.SystemIntegrityChecker;\n@@ -97,10 +97,8 @@ public void populateConfigurations() {\n                     _configDao.persist(vo);\n                 } else {\n                     if (vo.isDynamic() != key.isDynamic() ||\n-                        !vo.getDescription().equals(key.description()) ||\n-                        ((vo.getDefaultValue() != null && key.defaultValue() == null) ||\n-                         (vo.getDefaultValue() == null && key.defaultValue() != null) ||\n-                        !vo.getDefaultValue().equals(key.defaultValue()))) {\n+                        !ObjectUtils.equals(vo.getDescription(), vo.getDescription()) ||\n+                        !ObjectUtils.equals(vo.getDefaultValue(), key.defaultValue())) {\n                         vo.setDynamic(key.isDynamic());\n                         vo.setDescription(key.description());\n                         vo.setDefaultValue(key.defaultValue());",
                "raw_url": "https://github.com/apache/cloudstack/raw/2e29c89b841f6c00e30ea8fdc02510c2dbb41d39/framework/config/src/org/apache/cloudstack/framework/config/impl/ConfigDepotImpl.java",
                "sha": "97430ef91f927b1a852ca12556d4a772cce3245e",
                "status": "modified"
            }
        ],
        "message": "Default null value in ConfigKey results in NPE on second start",
        "parent": "https://github.com/apache/cloudstack/commit/13e7a7308b75bfccd1f3fb9686244ad2129ef7f0",
        "repo": "cloudstack",
        "unit_tests": [
            "ConfigDepotImplTest.java"
        ]
    },
    "cloudstack_2f832fd": {
        "bug_id": "cloudstack_2f832fd",
        "commit": "https://github.com/apache/cloudstack/commit/2f832fddff4786dbc3cafd5934cf65e3c6f2db99",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/2f832fddff4786dbc3cafd5934cf65e3c6f2db99/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=2f832fddff4786dbc3cafd5934cf65e3c6f2db99",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -1406,7 +1406,9 @@ public boolean deleteUserAccount(long accountId) {\n         AccountVO account = _accountDao.findById(accountId);\n \n         if (account == null || account.getRemoved() != null) {\n-            s_logger.info(\"The account:\" + account.getAccountName() + \" is already removed\");\n+            if (account != null) {\n+                s_logger.info(\"The account:\" + account.getAccountName() + \" is already removed\");\n+            }\n             return true;\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/2f832fddff4786dbc3cafd5934cf65e3c6f2db99/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "75a97bc29f9a8b51fe6cf76c71613be7f1b9029f",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7164: fix NPE",
        "parent": "https://github.com/apache/cloudstack/commit/165618ac9ac2937fbb1d7ff0da89de1abba4ccc1",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_2fca9d0": {
        "bug_id": "cloudstack_2fca9d0",
        "commit": "https://github.com/apache/cloudstack/commit/2fca9d0a49ff1747256537b49baafd1d991ef41b",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/2fca9d0a49ff1747256537b49baafd1d991ef41b/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=2fca9d0a49ff1747256537b49baafd1d991ef41b",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1304,7 +1304,7 @@ public TemplateResponse createIsoResponse(VirtualMachineTemplate result) {\n     @Override\n     public List<TemplateResponse> createTemplateResponses(long templateId, Long zoneId, boolean readyOnly) {\n         List<DataCenterVO> dcs = new ArrayList<DataCenterVO>();\n-        if (zoneId == -1) {\n+        if (zoneId == null || zoneId == -1) {\n             dcs.addAll(ApiDBUtils.listZones());\n             List<TemplateResponse> response = new ArrayList<TemplateResponse>();\n             for (DataCenterVO dc : dcs ) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/2fca9d0a49ff1747256537b49baafd1d991ef41b/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "25b7d7140dab58d7ad9abbd87175ea4fbf34302a",
                "status": "modified"
            }
        ],
        "message": "bug 10603: fixed NPE in listTemplates\nstatus 10603: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/01a47e0717d5db995ce6b7c72325e19a45a6018b",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_31df729": {
        "bug_id": "cloudstack_31df729",
        "commit": "https://github.com/apache/cloudstack/commit/31df729008c748e6eafe49ff86e1da618013c551",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/31df729008c748e6eafe49ff86e1da618013c551/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=31df729008c748e6eafe49ff86e1da618013c551",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1782,7 +1782,7 @@ public UserVm updateVirtualMachine(UpdateVMCmd cmd)\n \n         String description = \"\";\n \n-        if (!displayName.equals(vmInstance.getDisplayName())) {\n+        if (displayName != null && !displayName.equals(vmInstance.getDisplayName())) {\n             description += \"New display name: \" + displayName + \". \";\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/31df729008c748e6eafe49ff86e1da618013c551/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "e5faaf142e02798a8dd1e94221b5652619ff48e5",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3184: updateVirtualMachine api gives java NPE.\n\nSigned-off-by: Prasanna Santhanam <tsp@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/c49674300a84f65395db003f2250b987c61f05f6",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_32e84fe": {
        "bug_id": "cloudstack_32e84fe",
        "commit": "https://github.com/apache/cloudstack/commit/32e84feeccf5342dcb1bb39fb3ecc9077a7d89a5",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/32e84feeccf5342dcb1bb39fb3ecc9077a7d89a5/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java?ref=32e84feeccf5342dcb1bb39fb3ecc9077a7d89a5",
                "deletions": 2,
                "filename": "agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "patch": "@@ -1836,12 +1836,13 @@ protected Answer execute(final PrimaryStorageDownloadCommand cmd) {\n \t\t\t\t}\n \n \t\t\t\tif (secondaryPool != null) {\n-\t\t\t\t\tsynchronized (getStoragePool(secondaryPool.getUUIDString())) {\n+\t\t\t\t\tString uuid = secondaryPool.getUUIDString();\n+\t\t\t\t\tsynchronized (getStoragePool(uuid)) {\n \t\t\t\t\t\tsecondaryPool.destroy();\n \t\t\t\t\t\tsecondaryPool.undefine();\n \t\t\t\t\t\tsecondaryPool.free();\n \t\t\t\t\t}\n-\t\t\t\t\trmStoragePool(secondaryPool.getUUIDString());\n+\t\t\t\t\trmStoragePool(uuid);\n \t\t\t\t}\n \t\t\t} catch (LibvirtException l) {\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/32e84feeccf5342dcb1bb39fb3ecc9077a7d89a5/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "sha": "3157bd86c35d2d16e505d1fa0a91a2db7d1861db",
                "status": "modified"
            }
        ],
        "message": "bug 7308: fix NPE when downloading primarystorage\nstatus 7308: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/85cc68a74226cc09d16ee3ab9e70bca15ea220c9",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_33a249e": {
        "bug_id": "cloudstack_33a249e",
        "commit": "https://github.com/apache/cloudstack/commit/33a249e77aeaaaecccf355938890a63d2dce18cd",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/33a249e77aeaaaecccf355938890a63d2dce18cd/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/GetServiceProviderMetaDataCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/GetServiceProviderMetaDataCmd.java?ref=33a249e77aeaaaecccf355938890a63d2dce18cd",
                "deletions": 1,
                "filename": "plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/GetServiceProviderMetaDataCmd.java",
                "patch": "@@ -191,7 +191,7 @@ public APIAuthenticationType getAPIType() {\n     @Override\n     public void setAuthenticators(List<PluggableAPIAuthenticator> authenticators) {\n         for (PluggableAPIAuthenticator authManager: authenticators) {\n-            if (authManager instanceof SAML2AuthManager) {\n+            if (authManager != null && authManager instanceof SAML2AuthManager) {\n                 _samlAuthManager = (SAML2AuthManager) authManager;\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/33a249e77aeaaaecccf355938890a63d2dce18cd/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/GetServiceProviderMetaDataCmd.java",
                "sha": "437f4a38202e5c0efbfc6f3e2e6c2bd6fc98458a",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/33a249e77aeaaaecccf355938890a63d2dce18cd/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LoginAPIAuthenticatorCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LoginAPIAuthenticatorCmd.java?ref=33a249e77aeaaaecccf355938890a63d2dce18cd",
                "deletions": 1,
                "filename": "plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LoginAPIAuthenticatorCmd.java",
                "patch": "@@ -292,7 +292,7 @@ public APIAuthenticationType getAPIType() {\n     @Override\n     public void setAuthenticators(List<PluggableAPIAuthenticator> authenticators) {\n         for (PluggableAPIAuthenticator authManager: authenticators) {\n-            if (authManager instanceof SAML2AuthManager) {\n+            if (authManager != null && authManager instanceof SAML2AuthManager) {\n                 _samlAuthManager = (SAML2AuthManager) authManager;\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/33a249e77aeaaaecccf355938890a63d2dce18cd/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LoginAPIAuthenticatorCmd.java",
                "sha": "b279977577262297378554b792b16b2798491119",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/33a249e77aeaaaecccf355938890a63d2dce18cd/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LogoutAPIAuthenticatorCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LogoutAPIAuthenticatorCmd.java?ref=33a249e77aeaaaecccf355938890a63d2dce18cd",
                "deletions": 1,
                "filename": "plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LogoutAPIAuthenticatorCmd.java",
                "patch": "@@ -158,7 +158,7 @@ public APIAuthenticationType getAPIType() {\n     @Override\n     public void setAuthenticators(List<PluggableAPIAuthenticator> authenticators) {\n         for (PluggableAPIAuthenticator authManager: authenticators) {\n-            if (authManager instanceof SAML2AuthManager) {\n+            if (authManager != null && authManager instanceof SAML2AuthManager) {\n                 _samlAuthManager = (SAML2AuthManager) authManager;\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/33a249e77aeaaaecccf355938890a63d2dce18cd/plugins/user-authenticators/saml2/src/org/apache/cloudstack/api/command/SAML2LogoutAPIAuthenticatorCmd.java",
                "sha": "cdc24e0e10a8b2a1d627b744b38f0e87d7b1e6b0",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/33a249e77aeaaaecccf355938890a63d2dce18cd/server/src/com/cloud/api/auth/APIAuthenticationManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/auth/APIAuthenticationManagerImpl.java?ref=33a249e77aeaaaecccf355938890a63d2dce18cd",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/auth/APIAuthenticationManagerImpl.java",
                "patch": "@@ -69,7 +69,12 @@ public boolean start() {\n         cmdList.add(DefaultLoginAPIAuthenticatorCmd.class);\n         cmdList.add(DefaultLogoutAPIAuthenticatorCmd.class);\n         for (PluggableAPIAuthenticator apiAuthenticator: _apiAuthenticators) {\n-            cmdList.addAll(apiAuthenticator.getAuthCommands());\n+            List<Class<?>> commands = apiAuthenticator.getAuthCommands();\n+            if (commands != null) {\n+                cmdList.addAll(commands);\n+            } else {\n+                s_logger.warn(\"API Authenticator returned null api commands:\" + apiAuthenticator.getName());\n+            }\n         }\n         return cmdList;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/33a249e77aeaaaecccf355938890a63d2dce18cd/server/src/com/cloud/api/auth/APIAuthenticationManagerImpl.java",
                "sha": "fc21b1913e45ea3eb596396e87f1276e2f938338",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7455: Fix possible case for NPE\n\nNPE can happen if Spring fails to inject api authenticator, so better check\nand set list of commands if the authenticator is not null or returning null cmds\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/550762a0dcecc04e7b40302322864ea6b52c0098",
        "repo": "cloudstack",
        "unit_tests": [
            "GetServiceProviderMetaDataCmdTest.java",
            "SAML2LoginAPIAuthenticatorCmdTest.java",
            "SAML2LogoutAPIAuthenticatorCmdTest.java"
        ]
    },
    "cloudstack_3455a0f": {
        "bug_id": "cloudstack_3455a0f",
        "commit": "https://github.com/apache/cloudstack/commit/3455a0f563d364cfb51816f0ba52461fef136ea8",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/3455a0f563d364cfb51816f0ba52461fef136ea8/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=3455a0f563d364cfb51816f0ba52461fef136ea8",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -4012,7 +4012,8 @@ protected boolean updateTemplateOrIsoPermissions(UpdateTemplateOrIsoPermissionsC\n         \n         _templateDao.update(template.getId(), updatedTemplate);\n \n-        Long domainId = account.getDomainId();\n+        Long domainId;\n+        domainId =  (null == account) ?  DomainVO.ROOT_DOMAIN : account.getDomainId(); // Account == null for 8096 and so its safe for domainid = ROOT\n         if (\"add\".equalsIgnoreCase(operation)) {\n             txn.start();\n             for (String accountName : accountNames) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/3455a0f563d364cfb51816f0ba52461fef136ea8/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "2f2b5ab10c87cfc44d66b8d451d2371fd5c9a004",
                "status": "modified"
            }
        ],
        "message": "bug 7114: Fix NPE for  updateTemplatePermissions when accessed via 8096. This was happening due to accountObj being null in User Context when accessed via 8096. Why we set it to null seems to be a hack to me.\nstatus 7114: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/351f98ceef78154a4ad9eceedd59b3104e85e6b6",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_346a6fe": {
        "bug_id": "cloudstack_346a6fe",
        "commit": "https://github.com/apache/cloudstack/commit/346a6fe80a2dba71fbca15283155cfbc0d36ff98",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/346a6fe80a2dba71fbca15283155cfbc0d36ff98/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=346a6fe80a2dba71fbca15283155cfbc0d36ff98",
                "deletions": 2,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -2383,8 +2383,10 @@ public UserVmResponse newUserVmResponse(UserVmData userVmData, boolean caller_is\n                 sgr.setDescription(sgd.getDescription());\n                 \n                 Account account = ApiDBUtils.findAccountByNameDomain(sgd.getAccountName(), sgd.getDomainId());\n-                populateAccount(sgr, account.getId());\n-                populateDomain(sgr, sgd.getDomainId());\n+                if (account != null) {\n+                    populateAccount(sgr, account.getId());\n+                    populateDomain(sgr, account.getDomainId());\n+                }\n                 \n                 sgr.setObjectName(sgd.getObjectName());\n                 securityGroupResponse.add(sgr);",
                "raw_url": "https://github.com/apache/cloudstack/raw/346a6fe80a2dba71fbca15283155cfbc0d36ff98/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "4c22de4318ad342092e5b268029952d8cd4379b5",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE.",
        "parent": "https://github.com/apache/cloudstack/commit/80dc2c0b1ab1124468dc13c6b88123ea10d579dd",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_3624fee": {
        "bug_id": "cloudstack_3624fee",
        "commit": "https://github.com/apache/cloudstack/commit/3624fee85d675814f37ab4517c30360c212449e6",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/deploy/FirstFitPlanner.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/deploy/FirstFitPlanner.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 1,
                "filename": "server/src/com/cloud/deploy/FirstFitPlanner.java",
                "patch": "@@ -457,7 +457,7 @@ protected boolean hostCanAccessSPool(Host host, StoragePool pool){\n \t\t\tEnumeration<StoragePoolAllocator> enPool = _storagePoolAllocators.enumeration();\n \t        while (enPool.hasMoreElements()) {\n \t            final StoragePoolAllocator allocator = enPool.nextElement();\n-\t            final List<StoragePool> suitablePools = allocator.allocateToPool(diskProfile, vmProfile, plan, avoid, returnUpTo);\n+\t            final List<StoragePool> suitablePools = allocator.allocateToPool(diskProfile, vmProfile.getTemplate(), plan, avoid, returnUpTo);\n \t            if (suitablePools != null && !suitablePools.isEmpty()) {\n \t            \tsuitableVolumeStoragePools.put(toBeCreated, suitablePools);\n \t            \tfoundPotentialPools = true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/deploy/FirstFitPlanner.java",
                "sha": "a05970045bc8527eac76342481d763322d83f28c",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 7,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -330,13 +330,13 @@ public boolean isLocalStorageActiveOnHost(Host host) {\n         return false;\n     }\n \n-    protected StoragePoolVO findStoragePool(DiskProfile dskCh, final DataCenterVO dc, HostPodVO pod, Long clusterId, final ServiceOffering offering,\n-            final VMInstanceVO vm, final VMTemplateVO template, final Set<StoragePool> avoid) {\n-    \tVirtualMachineProfileImpl<VMInstanceVO> vmProfile = new VirtualMachineProfileImpl<VMInstanceVO>(vm, template, (ServiceOfferingVO)offering, null, null);\n+    protected StoragePoolVO findStoragePool(DiskProfile dskCh, final DataCenterVO dc, HostPodVO pod, Long clusterId,\n+            final VMTemplateVO template, final Set<StoragePool> avoid) {\n+\n         Enumeration<StoragePoolAllocator> en = _storagePoolAllocators.enumeration();\n         while (en.hasMoreElements()) {\n             final StoragePoolAllocator allocator = en.nextElement();\n-            final List<StoragePool> poolList = allocator.allocateToPool(dskCh, vmProfile, dc.getId(), pod.getId(), clusterId, avoid, 1);\n+            final List<StoragePool> poolList = allocator.allocateToPool(dskCh, template, dc.getId(), pod.getId(), clusterId, avoid, 1);\n             if (poolList != null && !poolList.isEmpty()) {\n                 return (StoragePoolVO) poolList.get(0);\n             }\n@@ -439,7 +439,7 @@ public boolean canVmRestartOnAnotherServer(long vmId) {\n         while ((pod = _agentMgr.findPod(null, null, dc, account.getId(), podsToAvoid)) != null) {\n             podsToAvoid.add(pod.first().getId());\n             // Determine what storage pool to store the volume in\n-            while ((pool = findStoragePool(dskCh, dc, pod.first(), null, null, null, null, poolsToAvoid)) != null) {\n+            while ((pool = findStoragePool(dskCh, dc, pod.first(), null, null, poolsToAvoid)) != null) {\n                 poolsToAvoid.add(pool);\n                 volumeFolder = pool.getPath();\n                 if (s_logger.isDebugEnabled()) {\n@@ -636,7 +636,7 @@ public VolumeVO createVolume(VolumeVO volume, VMInstanceVO vm, VMTemplateVO temp\n                 break;\n             }\n \n-            pool = findStoragePool(dskCh, dc, pod, clusterId, offering, vm, template, avoidPools);\n+            pool = findStoragePool(dskCh, dc, pod, clusterId, template, avoidPools);\n             if (pool == null) {\n                 s_logger.warn(\"Unable to find storage poll when create volume \" + volume.getName());\n                 break;\n@@ -1317,7 +1317,7 @@ public VolumeVO moveVolume(VolumeVO volume, long destPoolDcId, Long destPoolPodI\n         dskCh.setHyperType(dataDiskHyperType);\n         DataCenterVO destPoolDataCenter = _dcDao.findById(destPoolDcId);\n         HostPodVO destPoolPod = _podDao.findById(destPoolPodId);\n-        StoragePoolVO destPool = findStoragePool(dskCh, destPoolDataCenter, destPoolPod, destPoolClusterId, null, null, null,\n+        StoragePoolVO destPool = findStoragePool(dskCh, destPoolDataCenter, destPoolPod, destPoolClusterId, null,\n                 new HashSet<StoragePool>());\n         String secondaryStorageURL = getSecondaryStorageURL(volume.getDataCenterId());\n         String secondaryStorageVolumePath = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "8f263cd7eb8e233b9e527e60f7979616c8ca58db",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/AbstractStoragePoolAllocator.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/AbstractStoragePoolAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 8,
                "filename": "server/src/com/cloud/storage/allocator/AbstractStoragePoolAllocator.java",
                "patch": "@@ -54,6 +54,7 @@\n import com.cloud.storage.dao.VMTemplatePoolDao;\n import com.cloud.storage.dao.VolumeDao;\n import com.cloud.template.TemplateManager;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.Pair;\n import com.cloud.utils.component.AdapterBase;\n@@ -104,7 +105,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         return true;\n     }\n     \n-    abstract boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm);\n+    abstract boolean allocatorIsCorrectType(DiskProfile dskCh);\n     \n \tprotected boolean templateAvailable(long templateId, long poolId) {\n     \tVMTemplateStorageResourceAssoc thvo = _templatePoolDao.findByPoolTemplate(poolId, templateId);\n@@ -118,12 +119,12 @@ protected boolean templateAvailable(long templateId, long poolId) {\n     \t}\n     }\n \t\n-\tprotected boolean localStorageAllocationNeeded(DiskProfile dskCh, VMInstanceVO vm) {\n+\tprotected boolean localStorageAllocationNeeded(DiskProfile dskCh) {\n \t    return dskCh.useLocalStorage();\n \t}\n \t\n-\tprotected boolean poolIsCorrectType(DiskProfile dskCh, StoragePool pool, VMInstanceVO vm) {\n-\t\tboolean localStorageAllocationNeeded = localStorageAllocationNeeded(dskCh, vm);\n+\tprotected boolean poolIsCorrectType(DiskProfile dskCh, StoragePool pool) {\n+\t\tboolean localStorageAllocationNeeded = localStorageAllocationNeeded(dskCh);\n \t\tif (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Is localStorageAllocationNeeded? \"+ localStorageAllocationNeeded);\n             s_logger.debug(\"Is storage pool shared? \"+ pool.getPoolType().isShared());\n@@ -133,7 +134,7 @@ protected boolean poolIsCorrectType(DiskProfile dskCh, StoragePool pool, VMInsta\n \t}\n \t\n \tprotected boolean checkPool(ExcludeList avoid, StoragePoolVO pool, DiskProfile dskCh, VMTemplateVO template, List<VMTemplateStoragePoolVO> templatesInPool, \n-\t\t\tVMInstanceVO vm, StatsCollector sc) {\n+\t\t\tStatsCollector sc) {\n \t\t\n \t\tif (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Checking if storage pool is suitable, name: \" + pool.getName()+ \" ,poolId: \"+ pool.getId());\n@@ -162,7 +163,7 @@ protected boolean checkPool(ExcludeList avoid, StoragePoolVO pool, DiskProfile d\n         }\n         \n \t\t// Check that the pool type is correct\n-\t\tif (!poolIsCorrectType(dskCh, pool, vm)) {\n+\t\tif (!poolIsCorrectType(dskCh, pool)) {\n     \t\tif (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"StoragePool is not of correct type, skipping this pool\");\n             }\n@@ -269,15 +270,15 @@ public String chooseStorageIp(VirtualMachine vm, Host host, Host storage) {\n \t\n \t\n \t@Override\n-\tpublic List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vm, long dcId, long podId, Long clusterId, Set<? extends StoragePool> avoids, int returnUpTo) {\n+\tpublic List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, long dcId, long podId, Long clusterId, Set<? extends StoragePool> avoids, int returnUpTo) {\n \t    \n \t    ExcludeList avoid = new ExcludeList();\n \t    for(StoragePool pool : avoids){\n \t    \tavoid.addPool(pool.getId());\n \t    }\n \t    \n \t    DataCenterDeployment plan = new DataCenterDeployment(dcId, podId, clusterId, null);\n-\t    return allocateToPool(dskCh, vm, plan, avoid, returnUpTo);\n+\t    return allocateToPool(dskCh, VMtemplate, plan, avoid, returnUpTo);\n \t}\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/AbstractStoragePoolAllocator.java",
                "sha": "0ccb080c32a181d2793e0eebb88bb261524c4a61",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/FirstFitStoragePoolAllocator.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/FirstFitStoragePoolAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 7,
                "filename": "server/src/com/cloud/storage/allocator/FirstFitStoragePoolAllocator.java",
                "patch": "@@ -31,6 +31,7 @@\n import com.cloud.storage.StoragePool;\n import com.cloud.storage.StoragePoolVO;\n import com.cloud.storage.VMTemplateVO;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.vm.DiskProfile;\n import com.cloud.vm.VMInstanceVO;\n import com.cloud.vm.VirtualMachine;\n@@ -41,21 +42,20 @@\n     private static final Logger s_logger = Logger.getLogger(FirstFitStoragePoolAllocator.class);\n \n     @Override\n-    public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n-    \treturn !localStorageAllocationNeeded(dskCh, vm);\n+    public boolean allocatorIsCorrectType(DiskProfile dskCh) {\n+    \treturn !localStorageAllocationNeeded(dskCh);\n     }\n \n     @Override\n-\tpublic List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vmProfile, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n+\tpublic List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n \n-    \tVMInstanceVO vm = (VMInstanceVO)(vmProfile.getVirtualMachine());\n \t    \n-\t    VMTemplateVO template = _templateDao.findById(vm.getTemplateId());\n+\t    VMTemplateVO template = (VMTemplateVO)VMtemplate;\n \t    \n     \tList<StoragePool> suitablePools = new ArrayList<StoragePool>();\n \n     \t// Check that the allocator type is correct\n-        if (!allocatorIsCorrectType(dskCh, vm)) {\n+        if (!allocatorIsCorrectType(dskCh)) {\n         \treturn suitablePools;\n         }\n \t\tlong dcId = plan.getDataCenterId();\n@@ -88,7 +88,7 @@ public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n         \tif(suitablePools.size() == returnUpTo){\n         \t\tbreak;\n         \t}\n-        \tif (checkPool(avoid, pool, dskCh, template, null, vm, sc)) {\n+        \tif (checkPool(avoid, pool, dskCh, template, null, sc)) {\n         \t\tsuitablePools.add(pool);\n         \t}\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/FirstFitStoragePoolAllocator.java",
                "sha": "7b854b1619ccea0b68040b6577f3cefb7e002308",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/GarbageCollectingStoragePoolAllocator.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/GarbageCollectingStoragePoolAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 5,
                "filename": "server/src/com/cloud/storage/allocator/GarbageCollectingStoragePoolAllocator.java",
                "patch": "@@ -30,6 +30,7 @@\n import com.cloud.deploy.DeploymentPlanner.ExcludeList;\n import com.cloud.storage.StorageManager;\n import com.cloud.storage.StoragePool;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.utils.component.ComponentLocator;\n import com.cloud.vm.DiskProfile;\n import com.cloud.vm.VMInstanceVO;\n@@ -47,7 +48,7 @@\n     boolean _storagePoolCleanupEnabled;\n     \n     @Override\n-    public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n+    public boolean allocatorIsCorrectType(DiskProfile dskCh) {\n     \treturn true;\n     }\n     \n@@ -60,7 +61,7 @@ public Long getExtraBytesPerVolume() {\n     }\n     \n     @Override\n-    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vmProfile, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n+    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n     \t\n     \tif (!_storagePoolCleanupEnabled) {\n     \t\ts_logger.debug(\"Storage pool cleanup is not enabled, so GarbageCollectingStoragePoolAllocator is being skipped.\");\n@@ -69,10 +70,9 @@ public Long getExtraBytesPerVolume() {\n     \t\n     \t// Clean up all storage pools\n     \t_storageMgr.cleanupStorage(false);\n-    \tVMInstanceVO vm = (VMInstanceVO)(vmProfile.getVirtualMachine());\n     \t// Determine what allocator to use\n     \tStoragePoolAllocator allocator;\n-    \tif (localStorageAllocationNeeded(dskCh, vm)) {\n+    \tif (localStorageAllocationNeeded(dskCh)) {\n     \t\tallocator = _localStoragePoolAllocator;\n     \t} else {\n     \t\tallocator = _firstFitStoragePoolAllocator;\n@@ -81,7 +81,7 @@ public Long getExtraBytesPerVolume() {\n     \t// Try to find a storage pool after cleanup\n         ExcludeList myAvoids = new ExcludeList(avoid.getDataCentersToAvoid(), avoid.getPodsToAvoid(), avoid.getClustersToAvoid(), avoid.getHostsToAvoid(), avoid.getPoolsToAvoid());\n         \n-        return allocator.allocateToPool(dskCh, vmProfile, plan, myAvoids, returnUpTo);\n+        return allocator.allocateToPool(dskCh, VMtemplate, plan, myAvoids, returnUpTo);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/GarbageCollectingStoragePoolAllocator.java",
                "sha": "2f899435e55ce17a66be1ac845c191cf17530908",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/LocalStoragePoolAllocator.java",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/LocalStoragePoolAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 33,
                "filename": "server/src/com/cloud/storage/allocator/LocalStoragePoolAllocator.java",
                "patch": "@@ -38,6 +38,7 @@\n import com.cloud.storage.StoragePoolHostVO;\n import com.cloud.storage.VolumeVO;\n import com.cloud.storage.dao.StoragePoolHostDao;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.utils.DateUtil;\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.component.Inject;\n@@ -81,18 +82,17 @@\n     \n     \n     @Override\n-    public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n-    \treturn localStorageAllocationNeeded(dskCh, vm);\n+    public boolean allocatorIsCorrectType(DiskProfile dskCh) {\n+    \treturn localStorageAllocationNeeded(dskCh);\n     }\n     \n     @Override\n-    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vmProfile, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n+    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n \n-    \tVMInstanceVO vm = (VMInstanceVO)(vmProfile.getVirtualMachine());\n     \tList<StoragePool> suitablePools = new ArrayList<StoragePool>();\n     \t\n     \t// Check that the allocator type is correct\n-        if (!allocatorIsCorrectType(dskCh, vm)) {\n+        if (!allocatorIsCorrectType(dskCh)) {\n         \treturn suitablePools;\n         }\n \n@@ -103,36 +103,14 @@ public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n     \t}\n     \t\n         List<StoragePool> availablePool;\n-        while (!(availablePool = super.allocateToPool(dskCh, vmProfile, plan, myAvoids, 1)).isEmpty()) {\n+        while (!(availablePool = super.allocateToPool(dskCh, VMtemplate, plan, myAvoids, 1)).isEmpty()) {\n         \tStoragePool pool = availablePool.get(0);\n         \tmyAvoids.addPool(pool.getId());\n-            if (pool.getPoolType().isShared()) {\n-            \tsuitablePools.add(pool);\n-            }else{\n-\t        \tList<StoragePoolHostVO> hostsInSPool = _poolHostDao.listByPoolId(pool.getId());\n-\t        \tassert(hostsInSPool.size() == 1) : \"Local storage pool should be one host per pool\";\n-\t        \t\n-\t        \tStoragePoolHostVO spHost = hostsInSPool.get(0);\n-\t        \t\n-\t        \tSearchCriteria<Long> sc = VmsOnPoolSearch.create();\n-\t        \tsc.setJoinParameters(\"volumeJoin\", \"poolId\", pool.getId());\n-\t        \tsc.setParameters(\"state\", State.Expunging);\n-\t        \tList<Long> vmsOnHost = _vmInstanceDao.customSearchIncludingRemoved(sc, null);\n-\t            \n-\t        \tif(s_logger.isDebugEnabled()) {\n-\t        \t\ts_logger.debug(\"Found \" + vmsOnHost.size() + \" VM instances are alloacated at host \" + spHost.getHostId() + \" with local storage pool \" + pool.getName());\n-\t        \t\tfor(Long vmId : vmsOnHost) {\n-\t                    s_logger.debug(\"VM \" + vmId + \" is allocated on host \" + spHost.getHostId() + \" with local storage pool \" + pool.getName());\n-\t                }\n-\t        \t}\n-\t        \t\n-\t        \tif(hostHasCpuMemoryCapacity(spHost.getHostId(), vmsOnHost, vm)) {\n-\t        \t\ts_logger.debug(\"Found suitable local storage pool \" + pool.getId() + \", adding to list\");\n-\t        \t\tsuitablePools.add(pool);\n-\t            }else{\n-\t            \ts_logger.debug(\"Found pool \" + pool.getId() + \" but host doesn't fit, skipping this pool\");\n-\t            }\n-            }\n+        \tList<StoragePoolHostVO> hostsInSPool = _poolHostDao.listByPoolId(pool.getId());\n+        \tassert(hostsInSPool.size() == 1) : \"Local storage pool should be one host per pool\";\n+        \t\n+    \t\ts_logger.debug(\"Found suitable local storage pool \" + pool.getId() + \", adding to list\");\n+    \t\tsuitablePools.add(pool);\n             \n         \tif(suitablePools.size() == returnUpTo){\n         \t\tbreak;\n@@ -151,6 +129,7 @@ public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n         return suitablePools;\n     }\n     \n+    //we don't need to check host capacity now, since hostAllocators will do that anyway\n     private boolean hostHasCpuMemoryCapacity(long hostId, List<Long> vmOnHost, VMInstanceVO vm) {\n     \t\n         ServiceOffering so = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/LocalStoragePoolAllocator.java",
                "sha": "9dbdd98dc016a25b58cd3a57b07aa4b3daa695a0",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/RandomStoragePoolAllocator.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/RandomStoragePoolAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 6,
                "filename": "server/src/com/cloud/storage/allocator/RandomStoragePoolAllocator.java",
                "patch": "@@ -31,6 +31,7 @@\n import com.cloud.storage.StoragePool;\n import com.cloud.storage.StoragePoolVO;\n import com.cloud.storage.VMTemplateVO;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.vm.DiskProfile;\n import com.cloud.vm.VMInstanceVO;\n import com.cloud.vm.VirtualMachine;\n@@ -41,19 +42,18 @@\n     private static final Logger s_logger = Logger.getLogger(RandomStoragePoolAllocator.class);\n     \n     @Override\n-    public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n+    public boolean allocatorIsCorrectType(DiskProfile dskCh) {\n     \treturn true;\n     }\n     \n     @Override\n-    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vmProfile, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n+    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n \n     \tList<StoragePool> suitablePools = new ArrayList<StoragePool>();\n     \t\n-    \tVMInstanceVO vm = (VMInstanceVO)(vmProfile.getVirtualMachine());\n-    \tVMTemplateVO template = _templateDao.findById(vm.getTemplateId());    \t\n+    \tVMTemplateVO template = (VMTemplateVO)VMtemplate;    \t\n     \t// Check that the allocator type is correct\n-        if (!allocatorIsCorrectType(dskCh, vm)) {\n+        if (!allocatorIsCorrectType(dskCh)) {\n         \treturn suitablePools;\n         }\n \t\tlong dcId = plan.getDataCenterId();\n@@ -78,7 +78,7 @@ public boolean allocatorIsCorrectType(DiskProfile dskCh, VMInstanceVO vm) {\n         \tif(suitablePools.size() == returnUpTo){\n         \t\tbreak;\n         \t}        \t\n-        \tif (checkPool(avoid, pool, dskCh, template, null, vm, sc)) {\n+        \tif (checkPool(avoid, pool, dskCh, template, null, sc)) {\n         \t\tsuitablePools.add(pool);\n         \t}\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/RandomStoragePoolAllocator.java",
                "sha": "c7539ff4a7da50786eb6898cfbb3c82b0566fdca",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/StoragePoolAllocator.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/StoragePoolAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/allocator/StoragePoolAllocator.java",
                "patch": "@@ -23,6 +23,7 @@\n import com.cloud.deploy.DeploymentPlanner.ExcludeList;\n import com.cloud.host.Host;\n import com.cloud.storage.StoragePool;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.utils.component.Adapter;\n import com.cloud.vm.DiskProfile;\n import com.cloud.vm.VirtualMachine;\n@@ -35,7 +36,7 @@\n public interface StoragePoolAllocator extends Adapter {\n \t\n \t//keeping since storageMgr is using this API for some existing functionalities\n-\tList<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vm, long dcId, long podId, Long clusterId, Set<? extends StoragePool> avoids, int returnUpTo);\t\n+\tList<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, long dcId, long podId, Long clusterId, Set<? extends StoragePool> avoids, int returnUpTo);\t\n \t\n \tString chooseStorageIp(VirtualMachine vm, Host host, Host storage);\n \n@@ -49,5 +50,5 @@\n \t* @param int returnUpTo (use -1 to return all possible pools)\n \t* @return List<StoragePool> List of storage pools that are suitable for the VM \n \t**/ \n-\tList<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vm, DeploymentPlan plan, ExcludeList avoid, int returnUpTo);\t\n+\tList<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, DeploymentPlan plan, ExcludeList avoid, int returnUpTo);\t\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/StoragePoolAllocator.java",
                "sha": "5b6f61db6cdcdd38f5a66e7c999a70722bdd9492",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/UseLocalForRootAllocator.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/allocator/UseLocalForRootAllocator.java?ref=3624fee85d675814f37ab4517c30360c212449e6",
                "deletions": 4,
                "filename": "server/src/com/cloud/storage/allocator/UseLocalForRootAllocator.java",
                "patch": "@@ -30,6 +30,7 @@\n import com.cloud.host.Host;\n import com.cloud.storage.StoragePool;\n import com.cloud.storage.Volume.VolumeType;\n+import com.cloud.template.VirtualMachineTemplate;\n import com.cloud.utils.component.ComponentLocator;\n import com.cloud.vm.DiskProfile;\n import com.cloud.vm.VMInstanceVO;\n@@ -41,12 +42,12 @@\n     boolean _useLocalStorage;\n \n     @Override\n-    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineProfile<? extends VirtualMachine> vmProfile, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n+    public List<StoragePool> allocateToPool(DiskProfile dskCh, VirtualMachineTemplate VMtemplate, DeploymentPlan plan, ExcludeList avoid, int returnUpTo) {\n         if (!_useLocalStorage) {\n             return null;\n         }\n         \n-        return super.allocateToPool(dskCh, vmProfile, plan, avoid, returnUpTo);\n+        return super.allocateToPool(dskCh, VMtemplate, plan, avoid, returnUpTo);\n     }\n \n     @Override\n@@ -68,13 +69,13 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n     }\n     \n     @Override\n-    protected boolean localStorageAllocationNeeded(DiskProfile dskCh, VMInstanceVO vm) {\n+    protected boolean localStorageAllocationNeeded(DiskProfile dskCh) {\n         if (dskCh.getType() == VolumeType.ROOT) {\n             return true;\n         } else if (dskCh.getType() == VolumeType.DATADISK) {\n             return false;\n         } else {\n-            return super.localStorageAllocationNeeded(dskCh, vm);\n+            return super.localStorageAllocationNeeded(dskCh);\n         }\n     }\n     ",
                "raw_url": "https://github.com/apache/cloudstack/raw/3624fee85d675814f37ab4517c30360c212449e6/server/src/com/cloud/storage/allocator/UseLocalForRootAllocator.java",
                "sha": "5b493e4d283bd126c16a43238259d89f71b3a2cb",
                "status": "modified"
            }
        ],
        "message": "Changed the interface in StoragePoolAllocator to avoid a potential NPE in LocalStoragePoolAllocator. Allocators were taking in an instance of VM enclosed inside VirtualMachineProfile.\n\nHowever in case of createVolume from Snapshot, there is no VM associated. So VM passed is null and this can cause a NPE.\n\nAllocators hardly use the VM instance. LocalStoragePoolAllocator was mainly using it for checking if host has capacity. But it need not do this check, since that is done by HostAllocators anyway.\nSo removing the use of VM in StoragePoolAllocators.",
        "parent": "https://github.com/apache/cloudstack/commit/7668e1878acea6f380e167338248f1f3f8affca0",
        "repo": "cloudstack",
        "unit_tests": [
            "FirstFitPlannerTest.java",
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_364e1e1": {
        "bug_id": "cloudstack_364e1e1",
        "commit": "https://github.com/apache/cloudstack/commit/364e1e1c4a64036497d47b71708ec75bb5b592bc",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/364e1e1c4a64036497d47b71708ec75bb5b592bc/server/src/com/cloud/network/NetworkManagerImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManagerImpl.java?ref=364e1e1c4a64036497d47b71708ec75bb5b592bc",
                "deletions": 2,
                "filename": "server/src/com/cloud/network/NetworkManagerImpl.java",
                "patch": "@@ -1180,8 +1180,13 @@ public void assignToLoadBalancer(AssignToLoadBalancerRuleCmd cmd)  throws Networ\n         }\n \n         DomainRouterVO syncObject = _routerMgr.getRouter(loadBalancer.getIpAddress());\n-        cmd.synchronizeCommand(\"Router\", syncObject.getId());\n-\n+        if(syncObject == null){\n+        \tthrow new InvalidParameterValueException(\"Failed to assign to load balancer \" + loadBalancerId + \", the domain router was not found at \"+loadBalancer.getIpAddress());\n+        }\n+        else{\n+        \tcmd.synchronizeCommand(\"Router\", syncObject.getId());\n+        }\n+        \n         // Permission check...\n         Account account = UserContext.current().getAccount();\n         if (account != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/364e1e1c4a64036497d47b71708ec75bb5b592bc/server/src/com/cloud/network/NetworkManagerImpl.java",
                "sha": "7c4982a741b202bdfdc323efc11ff6c7597f073c",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/364e1e1c4a64036497d47b71708ec75bb5b592bc/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=364e1e1c4a64036497d47b71708ec75bb5b592bc",
                "deletions": 11,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -2160,17 +2160,10 @@ public synchronized StoragePoolVO preparePrimaryStorageForMaintenance(PreparePri\n \t\t\t\ts_logger.error(msg);\n \t\t\t\tthrow new ResourceUnavailableException(msg);\n \t\t\t}\n-\t\t\t\n-        \tprimaryStorage = _storagePoolDao.findById(primaryStorageId);\n-        \tif(primaryStorage == null)\n-        \t{\n-        \t\ts_logger.warn(\"The primary storage does not exist\");\n-        \t\tthrow new InvalidParameterValueException(\"Primary storage doesn't exist\");\n-        \t}\t\n         \t\n-//        \tif (!primaryStorage.getStatus().equals(Status.Up)) {\n-//    \t\t\tthrow new InvalidParameterValueException(\"Primary storage with id \" + primaryStorageId + \" is not ready for migration, as the status is:\" + primaryStorage.getStatus().toString());\n-//        \t}        \n+        \tif (!primaryStorage.getStatus().equals(Status.Up) && !primaryStorage.getStatus().equals(Status.ErrorInMaintenance)) {\n+    \t\t\tthrow new InvalidParameterValueException(\"Primary storage with id \" + primaryStorageId + \" is not ready for migration, as the status is:\" + primaryStorage.getStatus().toString());\n+        \t}        \n         \t//set the pool state to prepare for maintenance\n         \tprimaryStorage.setStatus(Status.PrepareForMaintenance);\n         \t_storagePoolDao.persist(primaryStorage);\n@@ -2195,7 +2188,7 @@ public synchronized StoragePoolVO preparePrimaryStorageForMaintenance(PreparePri\n         \t\t\tcontinue;\n         \t\t\n         \t\t//shut down the running vms\n-        \t\tif(vmInstance.getState().equals(State.Running) || vmInstance.getState().equals(State.Stopped) || vmInstance.getState().equals(State.Stopping) || vmInstance.getState().equals(State.Starting))\n+        \t\tif(vmInstance.getState().equals(State.Running) || vmInstance.getState().equals(State.Starting))\n         \t\t{\n         \t\t\t\n         \t\t\t//if the instance is of type consoleproxy, call the console proxy",
                "raw_url": "https://github.com/apache/cloudstack/raw/364e1e1c4a64036497d47b71708ec75bb5b592bc/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "1c84aca230798cacfef391071c28bf360cba6595",
                "status": "modified"
            }
        ],
        "message": "bug 7034,6869: fixing the storage pools issue, and the npe at load balancer if the router is not found.\nstatus 7034, 6869: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/1eef924c6c68b91f7404d129792655c3c2c288bd",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_3817178": {
        "bug_id": "cloudstack_3817178",
        "commit": "https://github.com/apache/cloudstack/commit/381717854c3ad9f2b3450a5195b7457bb453f296",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/381717854c3ad9f2b3450a5195b7457bb453f296/api/src/com/cloud/user/AccountService.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/user/AccountService.java?ref=381717854c3ad9f2b3450a5195b7457bb453f296",
                "deletions": 1,
                "filename": "api/src/com/cloud/user/AccountService.java",
                "patch": "@@ -145,7 +145,8 @@\n \t\n \tAccount getActiveAccount(String accountName, Long domainId);\n \t\n-\tAccount getAccount(Long accountId);\n+\tAccount getActiveAccount(Long accountId);\n \t\n+\tAccount getAccount(Long accountId);\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/381717854c3ad9f2b3450a5195b7457bb453f296/api/src/com/cloud/user/AccountService.java",
                "sha": "49fa836369c18822bbc000aa24fd1213a368698c",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/381717854c3ad9f2b3450a5195b7457bb453f296/server/src/com/cloud/network/NetworkManagerImpl.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManagerImpl.java?ref=381717854c3ad9f2b3450a5195b7457bb453f296",
                "deletions": 7,
                "filename": "server/src/com/cloud/network/NetworkManagerImpl.java",
                "patch": "@@ -1121,7 +1121,7 @@ public void release(VirtualMachineProfile<? extends VMInstanceVO> vmProfile, boo\n     private Account findAccountByIpAddress(Ip ipAddress) {\n         IPAddressVO address = _ipAddressDao.findById(ipAddress);\n         if ((address != null) && (address.getAllocatedToAccountId() != null)) {\n-            return _accountMgr.getAccount(address.getAllocatedToAccountId());\n+            return _accountMgr.getActiveAccount(address.getAllocatedToAccountId());\n         }\n         return null;\n     }\n@@ -1160,14 +1160,14 @@ public boolean disassociateIpAddress(DisassociateIPAddrCmd cmd) throws Permissio\n                 return true;\n             }\n \n-            Account Account = _accountMgr.getAccount(accountId);\n-            if (Account == null) {\n+            Account account = _accountMgr.getAccount(accountId);\n+            if (account == null) {\n                 return false;\n             }\n \n             if ((ipVO.getAllocatedToAccountId() == null) || (ipVO.getAllocatedToAccountId().longValue() != accountId)) {\n                 // FIXME: is the user visible in the admin account's domain????\n-                if (!BaseCmd.isAdmin(Account.getType())) {\n+                if (!BaseCmd.isAdmin(account.getType())) {\n                     if (s_logger.isDebugEnabled()) {\n                         s_logger.debug(\"permission denied disassociating IP address \" + ipAddress + \"; acct: \" + accountId + \"; ip (acct / dc / dom / alloc): \"\n                                 + ipVO.getAllocatedToAccountId() + \" / \" + ipVO.getDataCenterId() + \" / \" + ipVO.getAllocatedInDomainId() + \" / \" + ipVO.getAllocatedTime());\n@@ -1566,8 +1566,7 @@ public boolean deleteNetwork(long networkId) throws InvalidParameterValueExcepti\n             }\n         } else {\n             Account owner = _accountMgr.getAccount(network.getAccountId());\n-            Domain domain = _domainDao.findById(owner.getDomainId());\n-            _accountMgr.checkAccess(caller, domain);\n+            _accountMgr.checkAccess(caller, owner);\n         }\n         \n         //Don't allow to remove network if there are non-destroyed vms using it\n@@ -1747,7 +1746,7 @@ public boolean restartNetwork(RestartNetworkCmd cmd) throws ConcurrentOperationE\n             }\n         }\n         \n-        Account owner = _accountMgr.getAccount(cmd.getEntityOwnerId());\n+        Account owner = _accountMgr.getActiveAccount(cmd.getEntityOwnerId());\n         if (!_accountMgr.isAdmin(caller.getType())) {\n             _accountMgr.checkAccess(caller, network);\n         } else {",
                "raw_url": "https://github.com/apache/cloudstack/raw/381717854c3ad9f2b3450a5195b7457bb453f296/server/src/com/cloud/network/NetworkManagerImpl.java",
                "sha": "ffcae31a0631b345fb4b6e968cc5df8603ce6593",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/381717854c3ad9f2b3450a5195b7457bb453f296/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=381717854c3ad9f2b3450a5195b7457bb453f296",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -1613,12 +1613,22 @@ public Account getActiveAccount(String accountName, Long domainId) {\n        } \n     }\n     \n+    \n     @Override\n-    public Account getAccount(Long accountId) {\n+    public Account getActiveAccount(Long accountId) {\n        if (accountId == null) {\n            throw new InvalidParameterValueException(\"AccountId is required by account search\");\n        } else {\n           return  _accountDao.findById(accountId);\n        } \n     }\n+    \n+    @Override\n+    public Account getAccount(Long accountId) {\n+       if (accountId == null) {\n+           throw new InvalidParameterValueException(\"AccountId is required by account search\");\n+       } else {\n+          return  _accountDao.findByIdIncludingRemoved(accountId);\n+       } \n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/381717854c3ad9f2b3450a5195b7457bb453f296/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "f0dbd1f403f57703753f71996973722cd4fabc0c",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in deleteAccount - search for all accounts (instead of searching for active accounts only)  when do deleteNetwork",
        "parent": "https://github.com/apache/cloudstack/commit/158ed4c622fac32fc04be3f7f5d490f02350810f",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_3a14357": {
        "bug_id": "cloudstack_3a14357",
        "commit": "https://github.com/apache/cloudstack/commit/3a143577b9827bd5ab7aaf77e619437f46519b8e",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/3a143577b9827bd5ab7aaf77e619437f46519b8e/scripts/vm/network/security_group.py",
                "changes": 62,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/scripts/vm/network/security_group.py?ref=3a143577b9827bd5ab7aaf77e619437f46519b8e",
                "deletions": 57,
                "filename": "scripts/vm/network/security_group.py",
                "patch": "@@ -116,7 +116,7 @@ def destroy_network_rules_for_vm(vm_name):\n     delete_rules_for_vm_in_bridge_firewall_chain(vm_name)\n     if vm_name.startswith('i-') or vm_name.startswith('r-'):\n         vmchain =  '-'.join(vm_name.split('-')[:-1])\n-        vmchain_default =  '-'.join(vm_name.split('-')[:-2]) + \"-def\"\n+        vmchain_default =  '-'.join(vm_name.split('-')[:-1]) + \"-def\"\n \n     destroy_ebtables_rules(vmchain)\n     \n@@ -201,8 +201,6 @@ def default_network_rules_systemvm(vm_name):\n     vifs = getVifs(vm_name)\n     domid = getvmId(vm_name)\n     vmchain = vm_name\n-    if vm_name.startswith('r-'):\n-        vmchain = '-'.join(vm_name.split('-')[:-1])\n  \n     delete_rules_for_vm_in_bridge_firewall_chain(vm_name)\n   \n@@ -234,7 +232,6 @@ def default_network_rules(vm_name, vm_ip, vm_id, vm_mac):\n     vmName = vm_name \n     domID = getvmId(vm_name)\n     delete_rules_for_vm_in_bridge_firewall_chain(vmName)\n-    vm_name =  '-'.join(vm_name.split('-')[:-1])\n     vmchain = vm_name\n     vmchain_default = '-'.join(vmchain.split('-')[:-1]) + \"-def\"\n     \n@@ -282,7 +279,7 @@ def default_network_rules(vm_name, vm_ip, vm_id, vm_mac):\n def delete_rules_for_vm_in_bridge_firewall_chain(vmName):\n     vm_name = vmName\n     if vm_name.startswith('i-') or vm_name.startswith('r-'):\n-        vm_name =  '-'.join(vm_name.split('-')[:-2])\n+        vm_name =  '-'.join(vm_name.split('-')[:-1])\n     \n     vmchain = vm_name\n     \n@@ -295,52 +292,6 @@ def delete_rules_for_vm_in_bridge_firewall_chain(vmName):\n         except:\n               logging.exception(\"Ignoring failure to delete rules for vm \" + vmName)\n \n-'''  \n-def network_rules_for_rebooted_vm(vmName):\n-    vm_name = vmName\n-    vifs = getVifs(vmName) \n-    logging.debug(\"Found a rebooted VM -- reprogramming rules for  \" + vmName)\n-    \n-    delete_rules_for_vm_in_bridge_firewall_chain(vmName)\n-    if 1 in [ vm_name.startswith(c) for c in ['r-', 's-', 'v-'] ]:\n-        default_network_rules_systemvm(session, {\"vmName\":vmName})\n-        return True\n-    \n-    vmchain = '-'.join(vm_name.split('-')[:-1])\n-    vmchain_default = '-'.join(vm_name.split('-')[:-2]) + \"-def\"\n-\n-    for v in vifs:\n-        iptables('-A', 'BRIDGE-FIREWALL', '-m', 'physdev', '--physdev-is-bridged', '--physdev-out', v, '-j', vmchain_default)\n-        iptables('-A', 'BRIDGE-FIREWALL', '-m', 'physdev', '--physdev-is-bridged', '--physdev-in', v, '-j', vmchain_default)\n-\n-    #change antispoof rule in vmchain\n-    try:\n-        delcmd = \"iptables -S \" +  vmchain_default + \" | grep  physdev-in | sed 's/-A/-D/'\"\n-        inscmd = \"iptables -S \" +  vmchain_default + \" | grep  physdev-in | grep vif | sed -r 's/vif[0-9]+.0/\" + vif + \"/' | sed 's/-A/-I/'\"\n-        inscmd2 = \"iptables -S \" +  vmchain_default + \" | grep  physdev-in | grep tap | sed -r 's/tap[0-9]+.0/\" + tap + \"/' | sed 's/-A/-I/'\"\n-        \n-        ipts = []\n-        for cmd in [delcmd, inscmd, inscmd2]:\n-            cmds = bash('-c', cmd.split(' ')).split('\\n')\n-            cmds.pop()\n-            for c in cmds:\n-                    ipt = c.split(' ')\n-                    ipt.pop()\n-                    ipts.append(ipt)\n-        \n-        for ipt in ipts:\n-            try:\n-                iptables(ipt)\n-            except:\n-                logging.debug(\"Failed to rewrite antispoofing rules for vm \" + vmName)\n-    except:\n-        logging.debug(\"No rules found for vm \" + vmchain)\n-\n-\n-    rewrite_rule_log_for_vm(vmName, curr_domid)\n-    return True\n-'''  \n-\n def rewrite_rule_log_for_vm(vm_name, new_domid):\n     logfilename = \"/var/run/cloud/\" + vm_name +\".log\"\n     if not os.path.exists(logfilename):\n@@ -395,16 +346,13 @@ def cleanup_rules_for_dead_vms():\n def cleanup_rules():\n   try:\n \n-    chainscmd = \"iptables-save | grep '^:' | grep '.*-def' | awk '{print $1}' | cut -d':' -f2\"\n+    chainscmd = \"iptables-save | grep '^:' | grep -v '.*-def' | awk '{print $1}' | cut -d':' -f2\"\n     chains = execute(chainscmd).split('\\n')\n     cleaned = 0\n     cleanup = []\n     for chain in chains:\n         if 1 in [ chain.startswith(c) for c in ['r-', 'i-', 's-', 'v-'] ]:\n-            if chain.startswith('i-') or chain.startswith('r-'):\n-                vm_name = chain + '-untagged'\n-            else:\n-                vm_name = chain\n+            vm_name = chain\n                 \n             cmd = \"virsh list |grep \" + vm_name \n             try:\n@@ -421,7 +369,7 @@ def cleanup_rules():\n                 cleanup.append(vm_name)\n                 \n     for vmname in cleanup:\n-        destroy_network_rules_for_vm({'vmName':vmname})\n+        destroy_network_rules_for_vm(vmname)\n                     \n     logging.debug(\"Cleaned up rules for \" + str(len(cleanup)) + \" chains\")                \n   except:",
                "raw_url": "https://github.com/apache/cloudstack/raw/3a143577b9827bd5ab7aaf77e619437f46519b8e/scripts/vm/network/security_group.py",
                "sha": "abd7da8c4419519fd02172fd74b81c254563019d",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java?ref=3a143577b9827bd5ab7aaf77e619437f46519b8e",
                "deletions": 10,
                "filename": "server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "patch": "@@ -2010,16 +2010,6 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<ConsolePr\n     \tNicProfile controlNic = (NicProfile)profile.getParameter(\"control.nic\");\n         CheckSshCommand check = new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20);\n         cmds.addCommand(\"checkSsh\", check);\n-        return true;\n-    }\n-    \n-    @Override\n-    public boolean finalizeStart(Commands cmds, VirtualMachineProfile<ConsoleProxyVO> profile, DeployDestination dest, ReservationContext context) {\n-        CheckSshAnswer answer = (CheckSshAnswer)cmds.getAnswer(\"checkSsh\");\n-        if (!answer.getResult()) {\n-            s_logger.warn(\"Unable to ssh to the VM: \" + answer.getDetails());\n-            return false;\n-        }\n         \n         ConsoleProxyVO proxy = profile.getVirtualMachine();\n         List<NicVO> nics = _nicDao.listBy(proxy.getId());\n@@ -2039,6 +2029,17 @@ public boolean finalizeStart(Commands cmds, VirtualMachineProfile<ConsoleProxyVO\n         \t\tproxy.setPrivateMacAddress(nic.getMacAddress());\n         \t}\n         }\n+        _consoleProxyDao.update(proxy.getId(), proxy);\n+        return true;\n+    }\n+    \n+    @Override\n+    public boolean finalizeStart(Commands cmds, VirtualMachineProfile<ConsoleProxyVO> profile, DeployDestination dest, ReservationContext context) {\n+        CheckSshAnswer answer = (CheckSshAnswer)cmds.getAnswer(\"checkSsh\");\n+        if (!answer.getResult()) {\n+            s_logger.warn(\"Unable to ssh to the VM: \" + answer.getDetails());\n+            return false;\n+        }\n         \n         return true;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "sha": "da41b0e05b14897065dfeaddf671cd6f41bc85f4",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=3a143577b9827bd5ab7aaf77e619437f46519b8e",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1524,6 +1524,7 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<DomainRou\n         \t\trouter.setPrivateMacAddress(nic.getMacAddress());\n         \t}\n         }\n+        _routerDao.update(router.getId(), router);\n         //source NAT address is stored in /proc/cmdline of the domR and gets\n \t\t//reassigned upon powerup. Source NAT rule gets configured in StartRouter command\n         //The command should be sent for domR only, skip for DHCP",
                "raw_url": "https://github.com/apache/cloudstack/raw/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "e913d48d65be81a1df49db9c7c0b67852060342e",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/cloudstack/blob/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java?ref=3a143577b9827bd5ab7aaf77e619437f46519b8e",
                "deletions": 18,
                "filename": "server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "patch": "@@ -1509,6 +1509,26 @@ public boolean finalizeDeployment(Commands cmds,\n \t\tNicProfile controlNic = (NicProfile)profile.getParameter(\"control.nic\");\n         CheckSshCommand check = new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20);\n         cmds.addCommand(\"checkSsh\", check);\n+        \n+        SecondaryStorageVmVO secVm = profile.getVirtualMachine();\n+\t\t List<NicVO> nics = _nicDao.listBy(secVm.getId());\n+        for (NicVO nic : nics) {\n+        \tNetworkVO network = _networkDao.findById(nic.getNetworkId());\n+        \tif (network.getTrafficType() == TrafficType.Public) {\n+        \t\tsecVm.setPublicIpAddress(nic.getIp4Address());\n+        \t\tsecVm.setPublicNetmask(nic.getNetmask());\n+        \t\tsecVm.setPublicMacAddress(nic.getMacAddress());\n+        \t} else if (network.getTrafficType() == TrafficType.Control) {\n+        \t\tsecVm.setGuestIpAddress(nic.getIp4Address());\n+        \t\tsecVm.setGuestNetmask(nic.getNetmask());\n+        \t\tsecVm.setGuestMacAddress(nic.getMacAddress());\n+        \t} else if (network.getTrafficType() == TrafficType.Management) {\n+        \t\tsecVm.setPrivateIpAddress(nic.getIp4Address());\n+        \t\tsecVm.setPrivateNetmask(nic.getNetmask());\n+        \t\tsecVm.setPrivateMacAddress(nic.getMacAddress());\n+        \t}\n+        }\n+        _secStorageVmDao.update(secVm.getId(), secVm);\n         return true;\n \t}\n \n@@ -1521,24 +1541,7 @@ public boolean finalizeStart(Commands cmds,\n \t\t\ts_logger.warn(\"Unable to ssh to the VM: \" + answer.getDetails());\n \t\t\treturn false;\n \t\t}\n-\t\tSecondaryStorageVmVO secVm = profile.getVirtualMachine();\n-\t\t List<NicVO> nics = _nicDao.listBy(secVm.getId());\n-         for (NicVO nic : nics) {\n-         \tNetworkVO network = _networkDao.findById(nic.getNetworkId());\n-         \tif (network.getTrafficType() == TrafficType.Public) {\n-         \t\tsecVm.setPublicIpAddress(nic.getIp4Address());\n-         \t\tsecVm.setPublicNetmask(nic.getNetmask());\n-         \t\tsecVm.setPublicMacAddress(nic.getMacAddress());\n-         \t} else if (network.getTrafficType() == TrafficType.Control) {\n-         \t\tsecVm.setGuestIpAddress(nic.getIp4Address());\n-         \t\tsecVm.setGuestNetmask(nic.getNetmask());\n-         \t\tsecVm.setGuestMacAddress(nic.getMacAddress());\n-         \t} else if (network.getTrafficType() == TrafficType.Management) {\n-         \t\tsecVm.setPrivateIpAddress(nic.getIp4Address());\n-         \t\tsecVm.setPrivateNetmask(nic.getNetmask());\n-         \t\tsecVm.setPrivateMacAddress(nic.getMacAddress());\n-         \t}\n-         }\n+\t\t\n \t\treturn true;\n \t}\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "sha": "b2f7dc294feb561e7222d848e1013c819df7e7af",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 30,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=3a143577b9827bd5ab7aaf77e619437f46519b8e",
                "deletions": 14,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -2495,23 +2495,25 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<UserVmVO> pro\n \t\treturn true;\n \t}\n \t\n-    @Override\n-    public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<UserVmVO> profile, DeployDestination dest, ReservationContext context) {\n-        return true;\n-    }\n+\t@Override\n+\tpublic boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<UserVmVO> profile, DeployDestination dest, ReservationContext context) {\n+\t\tUserVmVO userVm = profile.getVirtualMachine();\n+\t\tList<NicVO> nics = _nicDao.listBy(userVm.getId());\n+\t\tfor (NicVO nic : nics) {\n+\t\t\tNetworkVO network = _networkDao.findById(nic.getNetworkId());\n+\t\t\tif (network.getTrafficType() == TrafficType.Guest) {\n+\t\t\t\tuserVm.setPrivateIpAddress(nic.getIp4Address());\n+\t\t\t\tuserVm.setPrivateNetmask(nic.getNetmask());\n+\t\t\t\tuserVm.setPrivateMacAddress(nic.getMacAddress());\n+\t\t\t}\n+\t\t}\n+\t\t_vmDao.update(userVm.getId(), userVm);\n+\t\n+\t\treturn true;\n+\t}\n \n     @Override\n     public boolean finalizeStart(Commands cmds, VirtualMachineProfile<UserVmVO> profile, DeployDestination dest, ReservationContext context) {\n-    \tUserVmVO userVm = profile.getVirtualMachine();\n-\t\t List<NicVO> nics = _nicDao.listBy(userVm.getId());\n-        for (NicVO nic : nics) {\n-        \tNetworkVO network = _networkDao.findById(nic.getNetworkId());\n-        \tif (network.getTrafficType() == TrafficType.Guest) {\n-        \t\tuserVm.setPrivateIpAddress(nic.getIp4Address());\n-        \t\tuserVm.setPrivateNetmask(nic.getNetmask());\n-        \t\tuserVm.setPrivateMacAddress(nic.getMacAddress());\n-        \t}\n-        }\n         return true;\n     }\n     ",
                "raw_url": "https://github.com/apache/cloudstack/raw/3a143577b9827bd5ab7aaf77e619437f46519b8e/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "36ba50a218aab2f93a6705fefbf767c889b580fc",
                "status": "modified"
            }
        ],
        "message": "bug 7659: fix the race condition that agent inside systemvm connecting to mgt server at the head of startcommand returning to mgt server, then got a NPE. and fix bugs in security group of KVM\nstatus 7659: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/960b91acc58bf6a9dfb9c3f5031c5bbe992851ad",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_3d9d73e": {
        "bug_id": "cloudstack_3d9d73e",
        "commit": "https://github.com/apache/cloudstack/commit/3d9d73e6277cc7b9b864ba19db6411191f736448",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/3d9d73e6277cc7b9b864ba19db6411191f736448/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=3d9d73e6277cc7b9b864ba19db6411191f736448",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -4360,7 +4360,7 @@ public Long extractVolume(ExtractVolumeCmd cmd) throws URISyntaxException {\n                 return uploadJob.getId();\n             }else{ // Volume is copied now make it visible under apache and create a URL.\n                 _uploadMonitor.createVolumeDownloadURL(volumeId, volumeLocalPath, Upload.Type.VOLUME, zoneId, uploadJob.getId());                \n-                EventUtils.saveEvent(userId, accountId, EventVO.LEVEL_INFO, cmd.getEventType(), \"Completed extraction of \"+volume.getName()+ \" in mode:\" +mode, null, cmd.getStartEventId());\n+                EventUtils.saveEvent(userId, accountId, EventVO.LEVEL_INFO, cmd.getEventType(), \"Completed extraction of \"+volume.getName()+ \" in mode:\" +mode, null, cmd.getStartEventId() == null ? 0:cmd.getStartEventId());\n                 return uploadJob.getId();\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/3d9d73e6277cc7b9b864ba19db6411191f736448/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "32ddef4fea4749702137238fc651a692d8b38298",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/3d9d73e6277cc7b9b864ba19db6411191f736448/server/src/com/cloud/storage/upload/UploadMonitorImpl.java",
                "changes": 48,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/upload/UploadMonitorImpl.java?ref=3d9d73e6277cc7b9b864ba19db6411191f736448",
                "deletions": 21,
                "filename": "server/src/com/cloud/storage/upload/UploadMonitorImpl.java",
                "patch": "@@ -186,14 +186,19 @@ public UploadVO createEntityDownloadURL(VMTemplateVO template, VMTemplateHostVO\n \t    \n \t    Type type = (template.getFormat() == ImageFormat.ISO) ? Type.ISO : Type.TEMPLATE ;\n \t    \n+\t    //Check if ssvm is up\n+\t    HostVO sserver = storageServers.get(0);\n+\t    if(sserver.getStatus() != com.cloud.host.Status.Up){\n+\t    \tthrow new CloudRuntimeException(\"Couldnt create extract link - Secondary Storage Vm is not up\");\n+\t    }\n+\t    \n \t    //Check if it already exists.\n \t    List<UploadVO> extractURLList = _uploadDao.listByTypeUploadStatus(template.getId(), type, UploadVO.Status.DOWNLOAD_URL_CREATED);\t    \n \t    if (extractURLList.size() > 0) {\n             return extractURLList.get(0);\n         }\n \t    \n-\t    // It doesn't exist so create a DB entry.\n-\t    HostVO sserver = storageServers.get(0);\n+\t    // It doesn't exist so create a DB entry.\t    \n \t    UploadVO uploadTemplateObj = new UploadVO(sserver.getId(), template.getId(), new Date(), \n \t                                                Status.DOWNLOAD_URL_NOT_CREATED, 0, type, Mode.HTTP_DOWNLOAD); \n \t    uploadTemplateObj.setInstallPath(vmTemplateHost.getInstallPath());\t                                                \n@@ -259,6 +264,11 @@ public void createVolumeDownloadURL(Long entityId, String path, Type type, Long\n             uploadJob.setLastUpdated(new Date());\n             _uploadDao.update(uploadJob.getId(), uploadJob);\n             \n+            List<SecondaryStorageVmVO> ssVms = _secStorageVmDao.getSecStorageVmListInStates(dataCenterId, State.Running);\n+            if (ssVms.size() == 0){\n+            \terrorString = \"Couldnt find a running SSVM in the zone\" + dataCenterId+ \". Couldnt create the extraction URL.\";\n+                throw new CloudRuntimeException(errorString);\n+            }\n             // Create Symlink at ssvm\n             String uuid = UUID.randomUUID().toString() + \".vhd\";\n             CreateEntityDownloadURLCommand cmd = new CreateEntityDownloadURLCommand(path, uuid);\n@@ -269,26 +279,22 @@ public void createVolumeDownloadURL(Long entityId, String path, Type type, Long\n                 throw new CloudRuntimeException(errorString);\n             }\n             \n-            //Construct actual URL locally now that the symlink exists at SSVM\n-            List<SecondaryStorageVmVO> ssVms = _secStorageVmDao.getSecStorageVmListInStates(dataCenterId, State.Running);\n-            if (ssVms.size() > 0) {\n-                SecondaryStorageVmVO ssVm = ssVms.get(0);\n-                if (ssVm.getPublicIpAddress() == null) {\n-                    errorString = \"A running secondary storage vm has a null public ip?\";\n-                    s_logger.warn(errorString);\n-                    throw new CloudRuntimeException(errorString);\n-                }\n-                String extractURL = generateCopyUrl(ssVm.getPublicIpAddress(), uuid);\n-                UploadVO vo = _uploadDao.createForUpdate();\n-                vo.setLastUpdated(new Date());\n-                vo.setUploadUrl(extractURL);\n-                vo.setUploadState(Status.DOWNLOAD_URL_CREATED);\n-                _uploadDao.update(uploadId, vo);\n-                success = true;\n-                return;\n+            //Construct actual URL locally now that the symlink exists at SSVM            \n+            SecondaryStorageVmVO ssVm = ssVms.get(0);\n+            if (ssVm.getPublicIpAddress() == null) {\n+                errorString = \"A running secondary storage vm has a null public ip?\";\n+                s_logger.warn(errorString);\n+                throw new CloudRuntimeException(errorString);\n             }\n-            errorString = \"Couldnt find a running SSVM in the zone\" + dataCenterId+ \". Couldnt create the extraction URL.\";\n-            throw new CloudRuntimeException(errorString);\n+            String extractURL = generateCopyUrl(ssVm.getPublicIpAddress(), uuid);\n+            UploadVO vo = _uploadDao.createForUpdate();\n+            vo.setLastUpdated(new Date());\n+            vo.setUploadUrl(extractURL);\n+            vo.setUploadState(Status.DOWNLOAD_URL_CREATED);\n+            _uploadDao.update(uploadId, vo);\n+            success = true;\n+            return;\n+                        \n \t    }finally{\n \t        if(!success){\n \t            UploadVO uploadJob = _uploadDao.createForUpdate(uploadId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/3d9d73e6277cc7b9b864ba19db6411191f736448/server/src/com/cloud/storage/upload/UploadMonitorImpl.java",
                "sha": "2258d0ba6b8b3044fe06a087efaac3aa28921406",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/3d9d73e6277cc7b9b864ba19db6411191f736448/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=3d9d73e6277cc7b9b864ba19db6411191f736448",
                "deletions": 1,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -493,7 +493,7 @@ private Long extract(Account account, Long templateId, String url, Long zoneId,\n         if (isISO) {\n             desc = \"ISO\";\n         }\n-\n+        eventId = eventId == null ? 0:eventId;\n         VMTemplateVO template = _tmpltDao.findById(templateId);\n         if (template == null) {\n             throw new InvalidParameterValueException(\"Unable to find \" +desc+ \" with id \" + templateId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/3d9d73e6277cc7b9b864ba19db6411191f736448/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "654d35c281a9a59f4e9646c7fde555fbd6a4ae5a",
                "status": "modified"
            }
        ],
        "message": "bug 7519 : Correcting the NPE getting thrown due to a recent rewrite of events. Also improving the logging when ssvm is not up.\nstatus 7519 : resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/03a66d4b90ee6640c65925e45fee6b3b70d30699",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java",
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_3e4b83d": {
        "bug_id": "cloudstack_3e4b83d",
        "commit": "https://github.com/apache/cloudstack/commit/3e4b83db86ab961d4857a1e3e8aa2b7f67bfe5b8",
        "file": [
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/cloudstack/blob/3e4b83db86ab961d4857a1e3e8aa2b7f67bfe5b8/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 46,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=3e4b83db86ab961d4857a1e3e8aa2b7f67bfe5b8",
                "deletions": 18,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1638,6 +1638,12 @@ public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<Doma\n \n         cmds.addCommand(\"checkSsh\", new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20));\n \n+        // Update router template/scripts version\n+        final GetDomRVersionCmd command = new GetDomRVersionCmd();\n+        command.setAccessDetail(NetworkElementCommand.ROUTER_IP, router.getPrivateIpAddress());\n+        command.setAccessDetail(NetworkElementCommand.ROUTER_NAME, router.getInstanceName());\n+        cmds.addCommand(\"getDomRVersion\", command);\n+\n         // Network usage command to create iptables rules\n         cmds.addCommand(\"networkUsage\", new NetworkUsageCommand(controlNic.getIp4Address(), router.getHostName(), \"create\"));\n         \n@@ -1753,35 +1759,39 @@ public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<Doma\n         s_logger.debug(\"Reapplying vm data (userData and metaData) entries as a part of domR \" + router + \" start...\");\n         createVmDataCommands(router, cmds);\n \n-        // Update router template/scripts version\n-        final GetDomRVersionCmd command = new GetDomRVersionCmd();\n-        command.setAccessDetail(NetworkElementCommand.ROUTER_IP, router.getPrivateIpAddress());\n-        command.setAccessDetail(NetworkElementCommand.ROUTER_NAME, router.getInstanceName());\n-        cmds.addCommand(\"getDomRVersion\", command);\n-\n         return true;\n     }\n \n     @Override\n     public boolean finalizeStart(VirtualMachineProfile<DomainRouterVO> profile, long hostId, Commands cmds, ReservationContext context) {\n         DomainRouterVO router = profile.getVirtualMachine();\n+        boolean result = true;\n         \n-        CheckSshAnswer answer = (CheckSshAnswer) cmds.getAnswer(\"checkSsh\");\n-        if (answer == null || !answer.getResult()) {\n-            s_logger.warn(\"Unable to ssh to the VM: \" + answer.getDetails());\n-            return false;\n+        Answer answer = cmds.getAnswer(\"checkSsh\");\n+        if (answer != null && answer instanceof CheckSshAnswer) {\n+            CheckSshAnswer sshAnswer = (CheckSshAnswer) answer;\n+            if (sshAnswer == null || !sshAnswer.getResult()) {\n+                s_logger.warn(\"Unable to ssh to the VM: \" + sshAnswer.getDetails());\n+                result = false;\n+            }\n+        } else {\n+            result = false;\n         }\n         \n-        GetDomRVersionAnswer versionAnswer = (GetDomRVersionAnswer) cmds.getAnswer(\"getDomRVersion\");\n-        if (answer == null || !answer.getResult()) {\n-            s_logger.warn(\"Unable to get the template/scripts version of router \" + router.getInstanceName() + \" due to: \" + versionAnswer.getDetails() + \", but we would continue\");\n-            return true;\n+        answer = cmds.getAnswer(\"getDomRVersion\");\n+        if (answer != null && answer instanceof GetDomRVersionAnswer) {\n+            GetDomRVersionAnswer versionAnswer = (GetDomRVersionAnswer)answer;\n+            if (answer == null || !answer.getResult()) {\n+                /* Try to push on because it's not a critical error */\n+                s_logger.warn(\"Unable to get the template/scripts version of router \" + router.getInstanceName() + \" due to: \" + versionAnswer.getDetails() + \", but we would continue\");\n+            } else {\n+                router.setTemplateVersion(versionAnswer.getTemplateVersion());\n+                router.setScriptsVersion(versionAnswer.getScriptsVersion());\n+                router = _routerDao.persist(router);\n+            }\n         }\n-        router.setTemplateVersion(versionAnswer.getTemplateVersion());\n-        router.setScriptsVersion(versionAnswer.getScriptsVersion());\n-        router = _routerDao.persist(router);\n \n-        return true;\n+        return result;\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/3e4b83db86ab961d4857a1e3e8aa2b7f67bfe5b8/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "d33ab633f334867309daaafbf26c928e2b10a6aa",
                "status": "modified"
            }
        ],
        "message": "Fix NPE in finalizeStart()\n\nThe command can be only failure Answer, rather than CheckSshAnswer or\nGetDomRVersionAnswer, then casting may fail.",
        "parent": "https://github.com/apache/cloudstack/commit/4a4abac1418bd9b98598374fec5f3dc8eb544277",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_40c3a0a": {
        "bug_id": "cloudstack_40c3a0a",
        "commit": "https://github.com/apache/cloudstack/commit/40c3a0afa2c721f36f5aeb05631ca0a7bbd81e31",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/40c3a0afa2c721f36f5aeb05631ca0a7bbd81e31/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=40c3a0afa2c721f36f5aeb05631ca0a7bbd81e31",
                "deletions": 0,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -823,6 +823,7 @@ public VolumeVO createVolume(VolumeVO volume, VMInstanceVO vm, VMTemplateVO temp\n             volume.setPoolType(pool.getPoolType());\n             volume.setPoolId(pool.getId());\n             volume.setPodId(pod.getId());\n+            volume.setState(Volume.State.Ready);\n             _volsDao.persist(volume);\n         }\n         txn.commit();",
                "raw_url": "https://github.com/apache/cloudstack/raw/40c3a0afa2c721f36f5aeb05631ca0a7bbd81e31/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "4dc3eb3559469357dfc53dc151b739ca7fcf8327",
                "status": "modified"
            }
        ],
        "message": "bug 7249: during volume creation (root and data) for a vm, there was no state being set (we need to set it to ready). Hence, whilst re-attaching a detached vol, we hit a NPE. Fixed the root cause of the state not being set during vm creation, and consequently, fixed this npe\nstatus 7249: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/69ce2a090e68c10d961da7b6bece2800fb6f99f1",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_4312d88": {
        "bug_id": "cloudstack_4312d88",
        "commit": "https://github.com/apache/cloudstack/commit/4312d884629d4a9e7716da4c869433cdaa8181b8",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/4312d884629d4a9e7716da4c869433cdaa8181b8/server/src/com/cloud/capacity/CapacityManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/capacity/CapacityManagerImpl.java?ref=4312d884629d4a9e7716da4c869433cdaa8181b8",
                "deletions": 0,
                "filename": "server/src/com/cloud/capacity/CapacityManagerImpl.java",
                "patch": "@@ -188,6 +188,11 @@ public boolean releaseVmCapacity(VirtualMachine vm, final boolean moveFromReserv\n         Long clusterId = null;\n         if (hostId != null) {\n             HostVO host = _hostDao.findById(hostId);\n+            if (host == null) {\n+                s_logger.warn(\"Host \" + hostId + \" no long exist anymore!\");\n+                return true;\n+            }\n+\n             clusterId = host.getClusterId();\n         }\n         if (capacityCpu == null || capacityMemory == null || svo == null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/4312d884629d4a9e7716da4c869433cdaa8181b8/server/src/com/cloud/capacity/CapacityManagerImpl.java",
                "sha": "69e8cfa169b9f064718461b2acac8aa6f66b431c",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/4312d884629d4a9e7716da4c869433cdaa8181b8/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java?ref=4312d884629d4a9e7716da4c869433cdaa8181b8",
                "deletions": 0,
                "filename": "server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -701,6 +701,7 @@ protected Long stopVM(final HaWorkVO work) throws ConcurrentOperationException {\n                         (vm.getHostId() != null ? vm.getHostId() : \"none\") + \" State: \" + vm.getState());\n                     return null;\n                 }\n+\n                 _itMgr.advanceStop(vm.getUuid(), false);\n                 s_logger.info(\"Stop for \" + vm + \" was successful\");\n                 return null;\n@@ -711,6 +712,7 @@ protected Long stopVM(final HaWorkVO work) throws ConcurrentOperationException {\n                         (vm.getHostId() != null ? vm.getHostId() : \"none\") + \" State: \" + vm.getState());\n                     return null;\n                 }\n+\n                 _itMgr.advanceStop(vm.getUuid(), true);\n                 s_logger.info(\"Stop for \" + vm + \" was successful\");\n                 return null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/4312d884629d4a9e7716da4c869433cdaa8181b8/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "sha": "8bd569a96a7749533dec558189bfc2acc05df1c0",
                "status": "modified"
            }
        ],
        "message": "HA manager to check target state of the VM to make decisions on whether or not to carry on a cheduled step. Fix NPE in capacity manager when releasing capacity of a stopped VM.",
        "parent": "https://github.com/apache/cloudstack/commit/3d5fbe7073d4b7234611e972ca030088bff2f3f2",
        "repo": "cloudstack",
        "unit_tests": [
            "HighAvailabilityManagerImplTest.java"
        ]
    },
    "cloudstack_433c28f": {
        "bug_id": "cloudstack_433c28f",
        "commit": "https://github.com/apache/cloudstack/commit/433c28fb16118fe744b4df73487a58a3254dbff2",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/433c28fb16118fe744b4df73487a58a3254dbff2/api/src/com/cloud/storage/Storage.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/storage/Storage.java?ref=433c28fb16118fe744b4df73487a58a3254dbff2",
                "deletions": 2,
                "filename": "api/src/com/cloud/storage/Storage.java",
                "patch": "@@ -80,8 +80,8 @@ public String getFileExtension() {\n     }\n     \n     public static enum TemplateType {\n-    \tSYSTEM,\n-    \tBUILTIN\n+    \tSYSTEM, /*routing, system vm template*/\n+    \tBUILTIN /*buildin template*/\n     }\n     \n     public static enum StoragePoolType {",
                "raw_url": "https://github.com/apache/cloudstack/raw/433c28fb16118fe744b4df73487a58a3254dbff2/api/src/com/cloud/storage/Storage.java",
                "sha": "98137a3cca376f0fa45c11ac8babcb4466bed6c1",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/433c28fb16118fe744b4df73487a58a3254dbff2/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=433c28fb16118fe744b4df73487a58a3254dbff2",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -231,6 +231,7 @@\n import com.cloud.storage.SnapshotVO;\n import com.cloud.storage.Storage;\n import com.cloud.storage.Storage.ImageFormat;\n+import com.cloud.storage.Storage.TemplateType;\n import com.cloud.storage.StorageManager;\n import com.cloud.storage.StoragePoolHostVO;\n import com.cloud.storage.StoragePoolVO;\n@@ -3723,7 +3724,7 @@ public IPAddressVO findIPAddressById(String ipAddress) {\n         for(VolumeVO v:allVolumes)\n         {\n         \tVMTemplateVO template = _templateDao.findById(v.getTemplateId());\n-        \tif(template!=null && template.getUniqueName().startsWith(\"routing\"))\n+        \tif(template!=null && (template.getTemplateType() == TemplateType.SYSTEM))\n         \t{\n         \t\t//do nothing\n         \t}",
                "raw_url": "https://github.com/apache/cloudstack/raw/433c28fb16118fe744b4df73487a58a3254dbff2/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "cae27f3c542e73e2de6a09296bdfbab98174c71e",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/433c28fb16118fe744b4df73487a58a3254dbff2/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=433c28fb16118fe744b4df73487a58a3254dbff2",
                "deletions": 6,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -953,10 +953,10 @@ public boolean delete(long userId, long templateId, Long zoneId) {\n \t\tList<VMTemplateStoragePoolVO> allTemplatesInPool = _tmpltPoolDao.listByPoolId(pool.getId());\n \t\t\n \t\tfor (VMTemplateStoragePoolVO templatePoolVO : allTemplatesInPool) {\n-\t\t\tVMTemplateVO template = _tmpltDao.findById(templatePoolVO.getTemplateId());\n-\t\t\t\n+\t\t\tVMTemplateVO template = _tmpltDao.findByIdIncludingRemoved(templatePoolVO.getTemplateId());\t\t\t\n+\t\t\n \t\t\t// If this is a routing template, consider it in use\n-\t\t\tif (template.getUniqueName().equals(\"routing\")) {\n+\t\t\tif (template.getTemplateType() == TemplateType.SYSTEM) {\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\t\n@@ -976,7 +976,7 @@ public boolean delete(long userId, long templateId, Long zoneId) {\n     @Override\n     public void evictTemplateFromStoragePool(VMTemplateStoragePoolVO templatePoolVO) {\n \t\tStoragePoolVO pool = _poolDao.findById(templatePoolVO.getPoolId());\n-\t\tVMTemplateVO template = _tmpltDao.findById(templatePoolVO.getTemplateId());\n+\t\tVMTemplateVO template = _tmpltDao.findByIdIncludingRemoved(templatePoolVO.getTemplateId());\n \t\t\n \t\tlong hostId;\n \t\tList<StoragePoolHostVO> poolHostVOs = _poolHostDao.listByPoolId(pool.getId());\n@@ -1096,7 +1096,7 @@ public Long createInZone(long zoneId, long userId, String displayText,\n \t\n \t@Override\n     public boolean templateIsDeleteable(VMTemplateHostVO templateHostRef) {\n-\t\tVMTemplateVO template = _tmpltDao.findById(templateHostRef.getTemplateId());\n+\t\tVMTemplateVO template = _tmpltDao.findByIdIncludingRemoved(templateHostRef.getTemplateId());\n \t\tlong templateId = template.getId();\n \t\tHostVO secondaryStorageHost = _hostDao.findById(templateHostRef.getHostId());\n \t\tlong zoneId = secondaryStorageHost.getDataCenterId();\n@@ -1284,7 +1284,7 @@ public boolean deleteTemplate(DeleteTemplateCmd cmd) {\n     \t\tthrow new InvalidParameterValueException(\"Please specify a valid template.\");\n     \t}\n     \t\n-    \tif (template.getUniqueName().equals(\"routing\")) {\n+    \tif (template.getTemplateType() == TemplateType.SYSTEM) {\n     \t\tthrow new InvalidParameterValueException(\"The DomR template cannot be deleted.\");\n     \t}\n     \t",
                "raw_url": "https://github.com/apache/cloudstack/raw/433c28fb16118fe744b4df73487a58a3254dbff2/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "a1fb6f0dae7f951208e2c789d40a3e04b20a1f99",
                "status": "modified"
            }
        ],
        "message": "bug 7041: fix npe in delete template from storage pool, if the template already marked as removed\nstatus 7041: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/e2aa4738ecf99aebf8b9bba3b96a0f803326ec81",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageTest.java",
            "ManagementServerImplTest.java",
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_43cf1da": {
        "bug_id": "cloudstack_43cf1da",
        "commit": "https://github.com/apache/cloudstack/commit/43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java",
                "patch": "@@ -192,7 +192,7 @@ public void setParent(String parent) {\n       this.parent = parent;\n     }\n \n-  public String getType() {\n+    public String getType() {\n         return type;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java",
                "sha": "1285f73f633eb66e65e1cfb1211a5e03bd459ab3",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java",
                "patch": "@@ -36,4 +36,6 @@\n     List<VMSnapshotVO> listByParent(Long vmSnapshotId);\n \n     VMSnapshotVO findByName(Long vmId, String name);\n+\n+    List<VMSnapshotVO> listByAccountId(Long accountId);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java",
                "sha": "31999ef15d66e3dcc6e5a18fddfd0a20fb81e0ec",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java",
                "patch": "@@ -121,6 +121,12 @@ public VMSnapshotVO findByName(Long vmId, String name) {\n         return null;\n     }\n \n+    public List<VMSnapshotVO> listByAccountId(Long accountId) {\n+        SearchCriteria sc = this.AllFieldsSearch.create();\n+        sc.setParameters(\"accountId\", new Object[] { accountId });\n+        return listBy(sc, null);\n+    }\n+\n     @Override\n     public boolean updateState(State currentState, Event event, State nextState, VMSnapshot vo, Object data) {\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java",
                "sha": "a87d284dc12161d367481e56f739cfe70b203665",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 0,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -472,6 +472,10 @@ public SnapshotResponse createSnapshotResponse(Snapshot snapshot) {\n             snapshotResponse.setVolumeId(volume.getUuid());\n             snapshotResponse.setVolumeName(volume.getName());\n             snapshotResponse.setVolumeType(volume.getVolumeType().name());\n+            DataCenter zone = ApiDBUtils.findZoneById(volume.getDeviceId());\n+            if (zone != null) {\n+                snapshotResponse.setZoneId(zone.getUuid());\n+            }\n         }\n         snapshotResponse.setCreated(snapshot.getCreated());\n         snapshotResponse.setName(snapshot.getName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "b17b5cc67c87056860eb7a2299426353d849b6b4",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 0,
                "filename": "server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java",
                "patch": "@@ -63,6 +63,7 @@ protected HighAvailabilityDaoImpl() {\n         TBASearch.and(\"server\", TBASearch.entity().getServerId(), Op.NULL);\n         TBASearch.and(\"taken\", TBASearch.entity().getDateTaken(), Op.NULL);\n         TBASearch.and(\"time\", TBASearch.entity().getTimeToTry(), Op.LTEQ);\n+        TBASearch.and(\"step\", TBASearch.entity().getStep(), Op.NIN);\n         TBASearch.done();\n \n         PreviousInstanceSearch = createSearchBuilder();\n@@ -151,6 +152,7 @@ public HaWorkVO take(final long serverId) {\n         try {\n             final SearchCriteria<HaWorkVO> sc = TBASearch.create();\n             sc.setParameters(\"time\", System.currentTimeMillis() >> 10);\n+            sc.setParameters(\"step\", Step.Done, Step.Cancelled);\n \n             final Filter filter = new Filter(HaWorkVO.class, null, true, 0l, 1l);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java",
                "sha": "724f4f6d7c9ee6fc32c42aa0ec5feed77ba71bde",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/hypervisor/HypervisorGuruBase.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/HypervisorGuruBase.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 2,
                "filename": "server/src/com/cloud/hypervisor/HypervisorGuruBase.java",
                "patch": "@@ -35,6 +35,7 @@\n import com.cloud.resource.ResourceManager;\n import com.cloud.server.ConfigurationServer;\n import com.cloud.service.ServiceOfferingDetailsVO;\n+import com.cloud.service.dao.ServiceOfferingDao;\n import com.cloud.service.dao.ServiceOfferingDetailsDao;\n import com.cloud.storage.dao.VMTemplateDetailsDao;\n import com.cloud.utils.Pair;\n@@ -71,6 +72,8 @@\n     ResourceManager _resourceMgr;\n     @Inject\n     ServiceOfferingDetailsDao _serviceOfferingDetailsDao;\n+    @Inject\n+    ServiceOfferingDao _serviceOfferingDao;\n \n     protected HypervisorGuruBase() {\n         super();\n@@ -125,8 +128,7 @@ public NicTO toNicTO(NicProfile profile) {\n     }\n \n     protected VirtualMachineTO toVirtualMachineTO(VirtualMachineProfile vmProfile) {\n-\n-        ServiceOffering offering = vmProfile.getServiceOffering();\n+        ServiceOffering offering = _serviceOfferingDao.findById(vmProfile.getId(), vmProfile.getServiceOfferingId());\n         VirtualMachine vm = vmProfile.getVirtualMachine();\n         Long minMemory = (long)(offering.getRamSize() / vmProfile.getMemoryOvercommitRatio());\n         int minspeed = (int)(offering.getSpeed() / vmProfile.getCpuOvercommitRatio());",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/hypervisor/HypervisorGuruBase.java",
                "sha": "0188778e7641a45080e3bfe73ad79cd651a76377",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/hypervisor/KVMGuru.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/KVMGuru.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 7,
                "filename": "server/src/com/cloud/hypervisor/KVMGuru.java",
                "patch": "@@ -16,24 +16,25 @@\n // under the License.\n package com.cloud.hypervisor;\n \n-import java.util.Map;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-\n-import org.apache.cloudstack.storage.command.StorageSubSystemCommand;\n-\n import com.cloud.agent.api.Command;\n+import com.cloud.agent.api.to.DataObjectType;\n import com.cloud.agent.api.to.VirtualMachineTO;\n import com.cloud.host.HostVO;\n import com.cloud.host.dao.HostDao;\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.storage.DataStoreRole;\n import com.cloud.storage.GuestOSHypervisorVO;\n import com.cloud.storage.GuestOSVO;\n import com.cloud.storage.dao.GuestOSDao;\n import com.cloud.storage.dao.GuestOSHypervisorDao;\n import com.cloud.utils.Pair;\n import com.cloud.vm.VirtualMachineProfile;\n+import org.apache.cloudstack.storage.command.CopyCommand;\n+import org.apache.cloudstack.storage.command.StorageSubSystemCommand;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import java.util.Map;\n \n @Local(value = HypervisorGuru.class)\n public class KVMGuru extends HypervisorGuruBase implements HypervisorGuru {\n@@ -77,6 +78,18 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n \n     @Override\n     public Pair<Boolean, Long> getCommandHostDelegation(long hostId, Command cmd) {\n+        if (cmd instanceof CopyCommand) {\n+            CopyCommand c = (CopyCommand) cmd;\n+            boolean inSeq = true;\n+            if (c.getSrcTO().getObjectType() == DataObjectType.SNAPSHOT ||\n+                    c.getDestTO().getObjectType() == DataObjectType.SNAPSHOT) {\n+                inSeq = false;\n+            } else if (c.getDestTO().getDataStore().getRole() == DataStoreRole.Image ||\n+                    c.getDestTO().getDataStore().getRole() == DataStoreRole.ImageCache) {\n+                inSeq = false;\n+            }\n+            c.setExecuteInSequence(inSeq);\n+        }\n         if (cmd instanceof StorageSubSystemCommand) {\n             StorageSubSystemCommand c = (StorageSubSystemCommand)cmd;\n             c.setExecuteInSequence(false);",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/hypervisor/KVMGuru.java",
                "sha": "e15a41752e6f673e01c1055d1243e997b3c823c0",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 3,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -30,7 +30,6 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n-import com.cloud.capacity.CapacityState;\n import com.cloud.vm.VirtualMachine;\n \n import org.apache.cloudstack.api.ApiConstants;\n@@ -71,6 +70,7 @@\n import com.cloud.agent.transport.Request;\n import com.cloud.capacity.Capacity;\n import com.cloud.capacity.CapacityManager;\n+import com.cloud.capacity.CapacityState;\n import com.cloud.capacity.CapacityVO;\n import com.cloud.capacity.dao.CapacityDao;\n import com.cloud.cluster.ClusterManager;\n@@ -1174,12 +1174,13 @@ private boolean doMaintain(final long hostId) {\n         MaintainAnswer answer = (MaintainAnswer)_agentMgr.easySend(hostId, new MaintainCommand());\n         if (answer == null || !answer.getResult()) {\n             s_logger.warn(\"Unable to send MaintainCommand to host: \" + hostId);\n+            return false;\n         }\n \n         try {\n             resourceStateTransitTo(host, ResourceState.Event.AdminAskMaintenace, _nodeId);\n         } catch (NoTransitionException e) {\n-            String err = \"Cannot transimit resource state of host \" + host.getId() + \" to \" + ResourceState.Maintenance;\n+            String err = \"Cannot transmit resource state of host \" + host.getId() + \" to \" + ResourceState.Maintenance;\n             s_logger.debug(err, e);\n             throw new CloudRuntimeException(err + e.getMessage());\n         }\n@@ -1210,7 +1211,6 @@ private boolean doMaintain(final long hostId) {\n                 }\n             }\n         }\n-\n         return true;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "6beea231c053100e35be863bf5b05f3166f96118",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 1,
                "filename": "server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java",
                "patch": "@@ -868,8 +868,9 @@ public Long doInTransaction(TransactionStatus status) {\n \n         // this lock guards against the updates to user_vm, volume, snapshot, public _ip and template table\n         // as any resource creation precedes with the resourceLimitExceeded check which needs this lock too\n+        Set rowIdsToLock = _resourceCountDao.listAllRowsToUpdate(accountId, Resource.ResourceOwnerType.Account, type);\n         SearchCriteria<ResourceCountVO> sc = ResourceCountSearch.create();\n-        sc.setParameters(\"accountId\", accountId);\n+        sc.setParameters(\"id\", rowIdsToLock.toArray());\n         _resourceCountDao.lockRows(sc, null, true);\n \n         ResourceCountVO accountRC = _resourceCountDao.findByOwnerAndType(accountId, ResourceOwnerType.Account, type);",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java",
                "sha": "1651ad7ba2881cb546565afc14054e36b7d6b387",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ConfigurationServerImpl.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 0,
                "filename": "server/src/com/cloud/server/ConfigurationServerImpl.java",
                "patch": "@@ -219,6 +219,9 @@ public void persistDefaultValues() throws InternalErrorException {\n             _configDao.update(\"secstorage.secure.copy.cert\", \"realhostip\");\n             s_logger.debug(\"ConfigurationServer made secondary storage copy use realhostip.\");\n \n+            _configDao.update(\"user.password.encoders.exclude\", \"MD5,LDAP,PLAINTEXT\");\n+            s_logger.debug(\"Configuration server excluded insecure encoders\");\n+\n             // Save default service offerings\n             createServiceOffering(User.UID_SYSTEM, \"Small Instance\", 1, 512, 500, \"Small Instance\", ProvisioningType.THIN, false, false, null);\n             createServiceOffering(User.UID_SYSTEM, \"Medium Instance\", 1, 1024, 1000, \"Medium Instance\", ProvisioningType.THIN, false, false, null);",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "sha": "a3bd14ad9b0044807968c638d1218083c84098f6",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=43cf1da865c1e4ed6523fb5b2ba315a547fac79f",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -117,6 +117,10 @@\n import com.cloud.vm.dao.InstanceGroupDao;\n import com.cloud.vm.dao.UserVmDao;\n import com.cloud.vm.dao.VMInstanceDao;\n+import com.cloud.vm.snapshot.VMSnapshot;\n+import com.cloud.vm.snapshot.VMSnapshotManager;\n+import com.cloud.vm.snapshot.VMSnapshotVO;\n+import com.cloud.vm.snapshot.dao.VMSnapshotDao;\n import org.apache.cloudstack.acl.ControlledEntity;\n import org.apache.cloudstack.acl.QuerySelector;\n import org.apache.cloudstack.acl.RoleType;\n@@ -201,6 +205,10 @@\n     @Inject\n     private SnapshotManager _snapMgr;\n     @Inject\n+    private VMSnapshotManager _vmSnapshotMgr;\n+    @Inject\n+    private VMSnapshotDao _vmSnapshotDao;\n+    @Inject\n     private UserVmManager _vmMgr;\n     @Inject\n     private TemplateManager _tmpltMgr;\n@@ -730,6 +738,16 @@ protected boolean cleanupAccount(AccountVO account, long callerUserId, Account c\n                 accountCleanupNeeded = true;\n             }\n \n+            // Destroy VM Snapshots\n+            List<VMSnapshotVO> vmSnapshots = _vmSnapshotDao.listByAccountId(Long.valueOf(accountId));\n+            for (VMSnapshot vmSnapshot : vmSnapshots) {\n+                try {\n+                    _vmSnapshotMgr.deleteVMSnapshot(vmSnapshot.getId());\n+                } catch (Exception e) {\n+                    s_logger.debug(\"Failed to cleanup vm snapshot \" + vmSnapshot.getId() + \" due to \" + e.toString());\n+                }\n+            }\n+\n             // Destroy the account's VMs\n             List<UserVmVO> vms = _userVmDao.listByAccountId(accountId);\n             if (s_logger.isDebugEnabled()) {\n@@ -1169,6 +1187,9 @@ public UserAccount updateUser(Long userId, String firstName, String lastName, St\n         }\n \n         if (password != null) {\n+            if (password.isEmpty()) {\n+                throw new InvalidParameterValueException(\"Password cannot be empty\");\n+            }\n             String encodedPassword = null;\n             for (Iterator<UserAuthenticator> en = _userPasswordEncoders.iterator(); en.hasNext();) {\n                 UserAuthenticator authenticator = en.next();\n@@ -1977,7 +1998,7 @@ public void logoutUser(long userId) {\n     @Override\n     public UserAccount authenticateUser(String username, String password, Long domainId, InetAddress loginIpAddress, Map<String, Object[]> requestParameters) {\n         UserAccount user = null;\n-        if (password != null) {\n+        if (password != null && !password.isEmpty()) {\n             user = getUserAccount(username, password, domainId, requestParameters);\n         } else {\n             String key = _configDao.getValue(\"security.singlesignon.key\");",
                "raw_url": "https://github.com/apache/cloudstack/raw/43cf1da865c1e4ed6523fb5b2ba315a547fac79f/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "f40cd8f898de7933aa6d0c9344c3d2f2bdb75204",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-5238: password checks, NPE fixes and minor fixes\n\n- insecure authenticators excluded in configuration\n- snapshot response should have zone\n- remove vmsnapshots when removing accounts\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit 5481485a083957ff58da3b6fea9d7b6d20f06875)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n\nConflicts:\n\tapi/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java\n\tserver/src/com/cloud/api/ApiResponseHelper.java\n\tserver/src/com/cloud/storage/download/DownloadActiveState.java",
        "parent": "https://github.com/apache/cloudstack/commit/8829a0d4a7f396549af9ce6071c75eac86ae0bfe",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java",
            "KVMGuruTest.java",
            "ResourceManagerImplTest.java",
            "ResourceLimitManagerImplTest.java",
            "ConfigurationServerImplTest.java",
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_45c6111": {
        "bug_id": "cloudstack_45c6111",
        "commit": "https://github.com/apache/cloudstack/commit/45c611100a9e103e991c5afaf286484e8f2f0bef",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/45c611100a9e103e991c5afaf286484e8f2f0bef/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=45c611100a9e103e991c5afaf286484e8f2f0bef",
                "deletions": 6,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -471,13 +471,15 @@ public ResourceLimitVO updateResourceLimit(UpdateResourceLimitCmd cmd) throws In\n \n         if (domainId == null) {\n             throw new ServerApiException(BaseCmd.PARAM_ERROR, \"Unable to update resource limit, unable to determine domain in which to update limit.\");\n-        } else if (account.getAccountName() != null) {\n-            Account userAccount = _accountDao.findActiveAccount(account.getAccountName(), domainId);\n-            if (userAccount == null) {\n-                throw new ServerApiException(BaseCmd.PARAM_ERROR, \"unable to find account by name \" + account.getAccountName() + \" in domain with id \" + domainId);\n+        } else if (account != null) {\n+            if (account.getAccountName() != null) {\n+                Account userAccount = _accountDao.findActiveAccount(account.getAccountName(), domainId);\n+                if (userAccount == null) {\n+                    throw new ServerApiException(BaseCmd.PARAM_ERROR, \"unable to find account by name \" + account.getAccountName() + \" in domain with id \" + domainId);\n+                }\n+                accountId = userAccount.getId();\n+                domainId = userAccount.getDomainId();\n             }\n-            accountId = userAccount.getId();\n-            domainId = userAccount.getDomainId();\n         }               \n \n         if (accountId != null) domainId = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/45c611100a9e103e991c5afaf286484e8f2f0bef/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "19b95442d030b2ab92cb9ab3a3c55b73a6d987f7",
                "status": "modified"
            }
        ],
        "message": "fix NPE when updating a resource limit using the internal API port",
        "parent": "https://github.com/apache/cloudstack/commit/55201432f61e874b1848aba6eade8afebb365547",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_4727b12": {
        "bug_id": "cloudstack_4727b12",
        "commit": "https://github.com/apache/cloudstack/commit/4727b1229eba6bcc53aa8e7b1223db179034a31d",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/4727b1229eba6bcc53aa8e7b1223db179034a31d/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=4727b1229eba6bcc53aa8e7b1223db179034a31d",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1263,7 +1263,7 @@ public TemplateResponse createIsoResponse(VirtualMachineTemplate result) {\n     @Override\n     public List<TemplateResponse> createTemplateResponses(long templateId, Long zoneId, boolean readyOnly) {\n         List<DataCenterVO> dcs = new ArrayList<DataCenterVO>();\n-        if (zoneId == -1) {\n+        if (zoneId == null || zoneId == -1) {\n             dcs.addAll(ApiDBUtils.listZones());\n             List<TemplateResponse> response = new ArrayList<TemplateResponse>();\n             for (DataCenterVO dc : dcs ) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/4727b1229eba6bcc53aa8e7b1223db179034a31d/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "7ab1d3fdd18ae254becbd6312cead34cc413e8ab",
                "status": "modified"
            }
        ],
        "message": "bug 10603: fixed NPE in listTemplates\nstatus 10603: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/a8a9b37824cfe4e83d463f676f673dc466b0e17a",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_473c3d3": {
        "bug_id": "cloudstack_473c3d3",
        "commit": "https://github.com/apache/cloudstack/commit/473c3d33c31fb96952d5dcc3539153eaa25be79a",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/473c3d33c31fb96952d5dcc3539153eaa25be79a/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=473c3d33c31fb96952d5dcc3539153eaa25be79a",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -3210,8 +3210,10 @@ public FirewallRuleVO updatePortForwardingRule(UpdateIPForwardingRuleCmd cmd) th\n             _firewallRulesDao.update(fwRule.getId(), fwRule);\n             _networkMgr.updateFirewallRule(fwRule, oldPrivateIP, oldPrivatePort);\n             return fwRule;\n+        }else{\n+        \ts_logger.warn(\"Unable to find the rule to be updated for public ip:public port\"+publicIp+\":\"+publicPort+ \"private ip:private port:\"+privateIp+\":\"+privatePort);\n+        \tthrow new InvalidParameterValueException(\"Unable to find the rule to be updated for public ip:public port\"+publicIp+\":\"+publicPort+ \" private ip:private port:\"+privateIp+\":\"+privatePort);\n         }\n-        return null;\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/473c3d33c31fb96952d5dcc3539153eaa25be79a/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "e747e9a58cb19755ead1b6d021052e50d39c5eb5",
                "status": "modified"
            }
        ],
        "message": "bug 6870: during updating of pf rules, it is possible one might try to update a non existing rule via the api cmd. hitherto, we were returning a null which was assumed as a success by the cmd api, which failed with a npe. instead, we ought to throw back an error since we did not find any rule to be updated. i am checking in the same change. this also will fix the npe.\nstatus 6870: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/95c99a5c6e3bc3b67126d5617cd6330ff4aca12d",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_47d6a64": {
        "bug_id": "cloudstack_47d6a64",
        "commit": "https://github.com/apache/cloudstack/commit/47d6a64b319ab064c4b855346f2bfdb250fb9ad8",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/47d6a64b319ab064c4b855346f2bfdb250fb9ad8/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java?ref=47d6a64b319ab064c4b855346f2bfdb250fb9ad8",
                "deletions": 2,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "patch": "@@ -925,7 +925,7 @@ protected NicTO toNicTO(NicVO nic, NicProfile profile, NetworkVO config) {\n \n     boolean isNetworkImplemented(NetworkVO network) {\n         Network.State state = network.getState();\n-        if (state == Network.State.Implemented || state == Network.State.Implementing) {\n+        if (state == Network.State.Implemented) {\n             return true;\n         } else if (state == Network.State.Setup) {\n             DataCenterVO zone = _dcDao.findById(network.getDataCenterId());\n@@ -1277,7 +1277,19 @@ public int compare(NicVO nic1, NicVO nic2) {\n         });\n \n         for (NicVO nic : nics) {\n-            Pair<NetworkGuru, NetworkVO> implemented = implementNetwork(nic.getNetworkId(), dest, context);\n+            Pair<NetworkGuru, NetworkVO> implemented = null;\n+            if (vmProfile.getVirtualMachine().getType() != Type.DomainRouter) {\n+                implemented = implementNetwork(nic.getNetworkId(), dest, context);\n+            } else {\n+                // At the time of implementing network (using implementNetwork() method), if the VR needs to be deployed then\n+                // it follows the same path of regular VM deployment. This leads to a nested call to implementNetwork() while\n+                // preparing VR nics. This flow creates issues in dealing with network state transitions. The original call\n+                // puts network in \"Implementing\" state and then the nested call again tries to put it into same state resulting\n+                // in issues. In order to avoid it, implementNetwork() call for VR is replaced with below code.\n+                NetworkVO network = _networksDao.findById(nic.getNetworkId());\n+                NetworkGuru guru = AdapterBase.getAdapterByName(networkGurus, network.getGuruName());\n+                implemented = new Pair<NetworkGuru, NetworkVO>(guru, network);\n+            }\n             if (implemented == null || implemented.first() == null) {\n                 s_logger.warn(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part of preparing nic id=\" + nic.getId());\n                 throw new CloudRuntimeException(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part preparing nic id=\" + nic.getId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/47d6a64b319ab064c4b855346f2bfdb250fb9ad8/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "sha": "265515c50b54707a1223418f8348071d0a398232",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7182: NPE while trying to deploy VMs in parallel in isolated network\nThe following changes are made:\n- Check to see if network is implemented changed from 'state == Implementing||Implemented' to 'state == Implemented'.\nThe earlier check was a hack to prevent the issue described below.\n- At the time of implementing network (using implementNetwork() method), if the VR needs to be deployed then\nit follows the same path of regular VM deployment. This leads to a nested call to implementNetwork() while\npreparing VR nics. This flow creates issues in dealing with network state transitions. The original call\nputs network in \"Implementing\" state and then the nested call again tries to put it into same state resulting\nin issues. In order to avoid it, implementNetwork() call for VR is replaced with below code.",
        "parent": "https://github.com/apache/cloudstack/commit/ea740aa0e10e22da751ff1d0405ac307f2f7e7ce",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkOrchestratorTest.java"
        ]
    },
    "cloudstack_47f43df": {
        "bug_id": "cloudstack_47f43df",
        "commit": "https://github.com/apache/cloudstack/commit/47f43df01b1f64e6798eb0155175936b5fd206ae",
        "file": [
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/47f43df01b1f64e6798eb0155175936b5fd206ae/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=47f43df01b1f64e6798eb0155175936b5fd206ae",
                "deletions": 0,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -2477,6 +2477,18 @@ public void prepareForMigration(VirtualMachineProfile<? extends VirtualMachine>\n \n     @Override\n     public void prepare(VirtualMachineProfile<? extends VirtualMachine> vm, DeployDestination dest) throws StorageUnavailableException, InsufficientStorageCapacityException {\n+    \t\n+    \tif(dest == null){\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"DeployDestination cannot be null, cannot prepare Volumes for the vm: \"+ vm);\n+            }\n+            throw new CloudRuntimeException(\"Unable to prepare Volume for vm because DeployDestination is null\");\n+    \t}else if(dest.getStorageForDisks() == null){\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"DeployDestination has no storage pools specified, cannot prepare Volumes for the vm: \"+ vm);\n+            }\n+            throw new CloudRuntimeException(\"Unable to prepare Volume for vm because DeployDestination DeployDestination has no storage pools specified\");\n+    \t}\n         List<VolumeVO> vols = _volsDao.findUsableVolumesForInstance(vm.getId());\n         if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Preparing \" + vols.size() + \" volumes for \" + vm);\n@@ -2489,6 +2501,9 @@ public void prepare(VirtualMachineProfile<? extends VirtualMachine> vm, DeployDe\n         \t\t recreateVols.add(vol);\n         \t}else{\n         \t\tStoragePool assignedPool = dest.getStorageForDisks().get(vol);\n+        \t\tif(assignedPool == null){\n+        \t\t\tthrow new StorageUnavailableException(\"No storage pool assigned in DeployDestination, Unable to create \" + vol,  -1L);\n+        \t\t}\n         \t\tif(vol.getPoolId() != assignedPool.getId()){\n         \t\t\tif (vol.isRecreatable()) {\n                         if (s_logger.isDebugEnabled()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/47f43df01b1f64e6798eb0155175936b5fd206ae/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "31e70cbc7bd0e72a73ff83b9af033df549a1b562",
                "status": "modified"
            }
        ],
        "message": "More changes for 9387:\n\nChecks in StorageManagerImpl :: prepare() method to avoid NPE's if DeployDestination passed in is null.",
        "parent": "https://github.com/apache/cloudstack/commit/47c31a077a614d425910b69d339fb427ae054782",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_497e586": {
        "bug_id": "cloudstack_497e586",
        "commit": "https://github.com/apache/cloudstack/commit/497e5863297c97c3e621b29758664af67a9eb05b",
        "file": [
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/cloudstack/blob/497e5863297c97c3e621b29758664af67a9eb05b/server/src/com/cloud/server/StatsCollector.java",
                "changes": 54,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=497e5863297c97c3e621b29758664af67a9eb05b",
                "deletions": 26,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -339,32 +339,34 @@ public void run() {\n \t\t\t\t}\r\n \t\t\t\tConcurrentHashMap<Long, VolumeStats> volumeStats = new ConcurrentHashMap<Long, VolumeStats>();\r\n \t\t\t\tfor (Iterator<Long> iter = commandsByPool.keySet().iterator(); iter.hasNext();) {\r\n-\t\t\t\t\tLong poolId = iter.next();\r\n-\t\t\t\t\tList<VolumeCommand> commandsList = commandsByPool.get(poolId);\r\n-\t\t\t\t\t\r\n-\t\t\t\t\tlong[] volumeIdArray = new long[commandsList.size()];\r\n-\t\t\t\t\tCommands commands = new Commands(OnError.Continue);\r\n-\t\t\t\t\tfor (int i = 0; i < commandsList.size(); i++) {\r\n-\t\t\t\t\t\tVolumeCommand vCommand = commandsList.get(i);\r\n-\t\t\t\t\t\tvolumeIdArray[i] = vCommand.volumeId;\r\n-\t\t\t\t\t\tcommands.addCommand(vCommand.command);\r\n-\t\t\t\t\t}\n-\t\t\t\t\t\n-\t\t            List<StoragePoolHostVO> poolhosts = _storagePoolHostDao.listByPoolId(poolId);\n-\t\t            for(StoragePoolHostVO poolhost : poolhosts) {\n-    \t\t\t\t\tAnswer[] answers = _agentMgr.send(poolhost.getHostId(), commands);\r\n-    \t\t\t\t\tif (answers != null) {\r\n-    \t\t\t\t\t    long totalBytes = 0L;\r\n-    \t\t\t\t\t\tfor (int i = 0; i < answers.length; i++) {\r\n-    \t\t\t\t\t\t\tif (answers[i].getResult()) {\r\n-    \t\t\t\t\t\t\t    VolumeStats vStats = (VolumeStats)answers[i];\r\n-    \t\t\t\t\t\t\t\tvolumeStats.put(volumeIdArray[i], vStats);\r\n-    \t\t\t\t\t\t\t\ttotalBytes += vStats.getBytesUsed();\r\n-    \t\t\t\t\t\t\t}\r\n-    \t\t\t\t\t\t}\n-    \t\t\t\t\t\tbreak;\n-                        }\n-\t\t            }\r\n+\t\t\t\t\tLong poolId = iter.next();\n+\t\t\t\t\tif(poolId != null) {\r\n+\t\t\t\t\t\tList<VolumeCommand> commandsList = commandsByPool.get(poolId);\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tlong[] volumeIdArray = new long[commandsList.size()];\r\n+\t\t\t\t\t\tCommands commands = new Commands(OnError.Continue);\r\n+\t\t\t\t\t\tfor (int i = 0; i < commandsList.size(); i++) {\r\n+\t\t\t\t\t\t\tVolumeCommand vCommand = commandsList.get(i);\r\n+\t\t\t\t\t\t\tvolumeIdArray[i] = vCommand.volumeId;\r\n+\t\t\t\t\t\t\tcommands.addCommand(vCommand.command);\r\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\t\n+\t\t\t            List<StoragePoolHostVO> poolhosts = _storagePoolHostDao.listByPoolId(poolId);\n+\t\t\t            for(StoragePoolHostVO poolhost : poolhosts) {\n+\t    \t\t\t\t\tAnswer[] answers = _agentMgr.send(poolhost.getHostId(), commands);\r\n+\t    \t\t\t\t\tif (answers != null) {\r\n+\t    \t\t\t\t\t    long totalBytes = 0L;\r\n+\t    \t\t\t\t\t\tfor (int i = 0; i < answers.length; i++) {\r\n+\t    \t\t\t\t\t\t\tif (answers[i].getResult()) {\r\n+\t    \t\t\t\t\t\t\t    VolumeStats vStats = (VolumeStats)answers[i];\r\n+\t    \t\t\t\t\t\t\t\tvolumeStats.put(volumeIdArray[i], vStats);\r\n+\t    \t\t\t\t\t\t\t\ttotalBytes += vStats.getBytesUsed();\r\n+\t    \t\t\t\t\t\t\t}\r\n+\t    \t\t\t\t\t\t}\n+\t    \t\t\t\t\t\tbreak;\n+\t                        }\n+\t\t\t            }\n+\t\t\t\t\t}\r\n \t\t\t\t}\r\n \r\n \t\t\t\t// We replace the existing volumeStats so that it does not grow with no bounds\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/497e5863297c97c3e621b29758664af67a9eb05b/server/src/com/cloud/server/StatsCollector.java",
                "sha": "cb2ce49a1cdacfc8bcf75a0e6cab3240ef4cccea",
                "status": "modified"
            }
        ],
        "message": "Fix the annoying NPE in StatsCollector",
        "parent": "https://github.com/apache/cloudstack/commit/b828af8f58b7fdd9efb741637cdefec4e7a41b8e",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_49999bf": {
        "bug_id": "cloudstack_49999bf",
        "commit": "https://github.com/apache/cloudstack/commit/49999bf609e29b85f86581c3cb4b02ad496edb84",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/49999bf609e29b85f86581c3cb4b02ad496edb84/core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java?ref=49999bf609e29b85f86581c3cb4b02ad496edb84",
                "deletions": 1,
                "filename": "core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java",
                "patch": "@@ -192,7 +192,8 @@ private Answer execute(ComputeChecksumCommand cmd) {\n         }\n         finally {\n             try {\n-                is.close();\n+            \tif(is != null)\n+            \t\tis.close();\n             } catch (IOException e) {\n                 if(s_logger.isDebugEnabled()){\n                   s_logger.debug(\"Could not close the file \" +absoluteTemplatePath);   ",
                "raw_url": "https://github.com/apache/cloudstack/raw/49999bf609e29b85f86581c3cb4b02ad496edb84/core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java",
                "sha": "855ceb9b40c2297d534fe4f49b842c735c549972",
                "status": "modified"
            }
        ],
        "message": "bug 10618: another place that could possibly throw NPE",
        "parent": "https://github.com/apache/cloudstack/commit/62a570484c4565254e4dda0370cae2ef713b366b",
        "repo": "cloudstack",
        "unit_tests": [
            "NfsSecondaryStorageResourceTest.java"
        ]
    },
    "cloudstack_4b21650": {
        "bug_id": "cloudstack_4b21650",
        "commit": "https://github.com/apache/cloudstack/commit/4b21650e233261cc9cf2464d3a5babf7bc80a49b",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/api/src/com/cloud/capacity/Capacity.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/capacity/Capacity.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 2,
                "filename": "api/src/com/cloud/capacity/Capacity.java",
                "patch": "@@ -26,11 +26,11 @@\n     public static final short CAPACITY_TYPE_CPU = 1;\n     public static final short CAPACITY_TYPE_STORAGE = 2;\n     public static final short CAPACITY_TYPE_STORAGE_ALLOCATED = 3;\n-    public static final short CAPACITY_TYPE_PUBLIC_IP = 4;\n+    public static final short CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP = 4;\n     public static final short CAPACITY_TYPE_PRIVATE_IP = 5;\n     public static final short CAPACITY_TYPE_SECONDARY_STORAGE = 6;\n     public static final short CAPACITY_TYPE_VLAN = 7;\n-    \n+    public static final short CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP = 8;\n     \n     public long getId();\n     ",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/api/src/com/cloud/capacity/Capacity.java",
                "sha": "2151a86c3f83f38907cee291d18604aea4bb2724",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/core/src/com/cloud/alert/AlertManager.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/alert/AlertManager.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 1,
                "filename": "core/src/com/cloud/alert/AlertManager.java",
                "patch": "@@ -26,8 +26,9 @@\n     public static final short ALERT_TYPE_CPU = CapacityVO.CAPACITY_TYPE_CPU;\n     public static final short ALERT_TYPE_STORAGE = CapacityVO.CAPACITY_TYPE_STORAGE;\n     public static final short ALERT_TYPE_STORAGE_ALLOCATED = CapacityVO.CAPACITY_TYPE_STORAGE_ALLOCATED;\n-    public static final short ALERT_TYPE_PUBLIC_IP = CapacityVO.CAPACITY_TYPE_PUBLIC_IP;\n+    public static final short ALERT_TYPE_VIRTUAL_NETWORK_PUBLIC_IP = CapacityVO.CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP;\n     public static final short ALERT_TYPE_PRIVATE_IP = CapacityVO.CAPACITY_TYPE_PRIVATE_IP;\n+    public static final short ALERT_TYPE_SECONDARY_STORAGE = CapacityVO.CAPACITY_TYPE_SECONDARY_STORAGE;\n     public static final short ALERT_TYPE_HOST = 6;\n     public static final short ALERT_TYPE_USERVM = 7;\n     public static final short ALERT_TYPE_DOMAIN_ROUTER = 8;",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/core/src/com/cloud/alert/AlertManager.java",
                "sha": "ecb52e92f805db269786672ed1b7a5f61197a3c2",
                "status": "modified"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/alert/AlertManagerImpl.java",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/alert/AlertManagerImpl.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 17,
                "filename": "server/src/com/cloud/alert/AlertManagerImpl.java",
                "patch": "@@ -31,11 +31,11 @@\n \n import javax.ejb.Local;\n import javax.mail.Authenticator;\n-import javax.mail.Message.RecipientType;\n import javax.mail.MessagingException;\n import javax.mail.PasswordAuthentication;\n import javax.mail.Session;\n import javax.mail.URLName;\n+import javax.mail.Message.RecipientType;\n import javax.mail.internet.InternetAddress;\n import javax.naming.ConfigurationException;\n \n@@ -53,18 +53,15 @@\n import com.cloud.dc.ClusterVO;\n import com.cloud.dc.DataCenterVO;\n import com.cloud.dc.HostPodVO;\n+import com.cloud.dc.Vlan.VlanType;\n import com.cloud.dc.dao.ClusterDao;\n import com.cloud.dc.dao.DataCenterDao;\n import com.cloud.dc.dao.DataCenterIpAddressDao;\n-import com.cloud.dc.dao.DataCenterVnetDaoImpl;\n import com.cloud.dc.dao.HostPodDao;\n import com.cloud.host.Host;\n import com.cloud.host.HostVO;\n-import com.cloud.host.Status;\n import com.cloud.host.dao.HostDao;\n import com.cloud.network.dao.IPAddressDao;\n-import com.cloud.service.ServiceOfferingVO;\n-import com.cloud.service.dao.ServiceOfferingDao;\n import com.cloud.storage.StorageManager;\n import com.cloud.storage.StoragePoolVO;\n import com.cloud.storage.dao.StoragePoolDao;\n@@ -75,7 +72,6 @@\n import com.cloud.utils.component.Inject;\n import com.cloud.utils.db.DB;\n import com.cloud.utils.db.SearchCriteria;\n-import com.cloud.utils.db.Transaction;\n import com.sun.mail.smtp.SMTPMessage;\n import com.sun.mail.smtp.SMTPSSLTransport;\n import com.sun.mail.smtp.SMTPTransport;\n@@ -114,6 +110,8 @@\n     private double _publicIPCapacityThreshold = 0.75;\r\n     private double _privateIPCapacityThreshold = 0.75;\n     private double _secondaryStorageCapacityThreshold = 0.75; \n+\tprivate double _vlanCapacityThreshold = 0.75;\n+\tprivate double _directNetworkPublicIpCapacityThreshold = 0.75;\n     Map<Short,Double> _capacityTypeThresholdMap = new HashMap<Short, Double>();\r\n \r\n     @Override\r\n@@ -157,7 +155,9 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         String storageAllocCapacityThreshold = configs.get(\"storage.allocated.capacity.threshold\");\r\n         String publicIPCapacityThreshold = configs.get(\"public.ip.capacity.threshold\");\r\n         String privateIPCapacityThreshold = configs.get(\"private.ip.capacity.threshold\");\n-        String secondaryStorageCapacityThreshold = configs.get(\"secondarystorage.capacity.threshold\");\r\n+        String secondaryStorageCapacityThreshold = configs.get(\"secondarystorage.capacity.threshold\");\n+        String vlanCapacityThreshold = configs.get(\"vlan.capacity.threshold\");\n+        String directNetworkPublicIpCapacityThreshold = configs.get(\"directnetwork.public.ip.capacity.threshold\");\r\n         \r\n         if (storageCapacityThreshold != null) {\r\n             _storageCapacityThreshold = Double.parseDouble(storageCapacityThreshold);\r\n@@ -180,14 +180,22 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         if (secondaryStorageCapacityThreshold != null) {\n             _secondaryStorageCapacityThreshold = Double.parseDouble(secondaryStorageCapacityThreshold);\n         }\n+        if (vlanCapacityThreshold != null) {\n+            _vlanCapacityThreshold = Double.parseDouble(vlanCapacityThreshold);\n+        }\n+        if (directNetworkPublicIpCapacityThreshold != null) {\n+            _directNetworkPublicIpCapacityThreshold = Double.parseDouble(directNetworkPublicIpCapacityThreshold);\n+        }\n         \n         _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_STORAGE, _storageCapacityThreshold);\n         _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_STORAGE_ALLOCATED, _storageAllocCapacityThreshold);\r\n         _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_CPU, _cpuCapacityThreshold);\n         _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_MEMORY, _memoryCapacityThreshold);\n-        _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_PUBLIC_IP, _publicIPCapacityThreshold);\n+        _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP, _publicIPCapacityThreshold);\n         _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_PRIVATE_IP, _privateIPCapacityThreshold);\n         _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_SECONDARY_STORAGE, _secondaryStorageCapacityThreshold);\n+        _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_VLAN, _vlanCapacityThreshold);\n+        _capacityTypeThresholdMap.put(Capacity.CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP, _directNetworkPublicIpCapacityThreshold);\n         \r\n         String capacityCheckPeriodStr = configs.get(\"capacity.check.period\");\r\n         if (capacityCheckPeriodStr != null) {\r\n@@ -291,10 +299,15 @@ public void recalculateCapacity() {\n \t\t        //ideal way would be to remove out the vlan param, and filter only on dcId\n \t\t        //implementing the same\n         \t\t\r\n-            \t// Calculate new Public IP capacity\n-            \ts_logger.trace(\"Executing public ip capacity update\");\n-\t\t        createOrUpdateIpCapacity(dcId, null, CapacityVO.CAPACITY_TYPE_PUBLIC_IP);\n-                s_logger.trace(\"Done with public ip capacity update\");\n+            \t// Calculate new Public IP capacity for Virtual Network\n+            \ts_logger.trace(\"Executing public ip capacity update for Virtual Network\");\n+\t\t        createOrUpdateIpCapacity(dcId, null, CapacityVO.CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP);\n+                s_logger.trace(\"Done with public ip capacity update for Virtual Network\");\n+                \n+            \t// Calculate new Public IP capacity for Direct Attached Network\n+            \ts_logger.trace(\"Executing public ip capacity update for Direct Attached Network\");\n+\t\t        createOrUpdateIpCapacity(dcId, null, CapacityVO.CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP);\n+                s_logger.trace(\"Done with public ip capacity update for Direct Attached Network\");\n                 \n                 //Calculate VLAN's capacity\n             \ts_logger.trace(\"Executing VLAN capacity update\");\n@@ -364,9 +377,12 @@ public void createOrUpdateIpCapacity(Long dcId, Long podId, short capacityType){\n         if (capacityType == CapacityVO.CAPACITY_TYPE_PRIVATE_IP){\n         \ttotalIPs = _privateIPAddressDao.countIPs(podId, dcId, false);\n         \tallocatedIPs = _privateIPAddressDao.countIPs(podId, dcId, true);\n-        }else{\n-        \ttotalIPs = _publicIPAddressDao.countIPsForDashboard(dcId, false);\n-            allocatedIPs = _publicIPAddressDao.countIPsForDashboard(dcId, true);\n+        }else if (capacityType == CapacityVO.CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP){\n+        \ttotalIPs = _publicIPAddressDao.countIPsForNetwork(dcId, false, VlanType.VirtualNetwork);\n+            allocatedIPs = _publicIPAddressDao.countIPsForNetwork(dcId, true, VlanType.VirtualNetwork);\n+        }else {\n+        \ttotalIPs = _publicIPAddressDao.countIPsForNetwork(dcId, false, VlanType.DirectAttached);\n+            allocatedIPs = _publicIPAddressDao.countIPsForNetwork(dcId, true, VlanType.DirectAttached);\n         }\n         \n         if (capacities.size() == 0){\n@@ -416,6 +432,9 @@ public void checkForAlerts(){\n         for(DataCenterVO dc : dataCenterList){\n         \tfor (Short capacityType : dataCenterCapacityTypes){\n         \t\tList<SummedCapacity> capacity = _capacityDao.findCapacityBy(capacityType.intValue(), dc.getId(), null, null);\n+        \t\tif (capacity == null || capacity.size() == 0){\n+        \t\t\tcontinue;\n+        \t\t}\n         \t\tdouble totalCapacity = capacity.get(0).getTotalCapacity(); \n                 double usedCapacity =  capacity.get(0).getUsedCapacity();\n                 if (totalCapacity != 0 && usedCapacity/totalCapacity > _capacityTypeThresholdMap.get(capacityType)){\n@@ -428,6 +447,9 @@ public void checkForAlerts(){\n         for( HostPodVO pod : podList){\n         \tfor (Short capacityType : podCapacityTypes){\n         \t\tList<SummedCapacity> capacity = _capacityDao.findCapacityBy(capacityType.intValue(), pod.getDataCenterId(), pod.getId(), null);\n+        \t\tif (capacity == null || capacity.size() == 0){\n+        \t\t\tcontinue;\n+        \t\t}\n         \t\tdouble totalCapacity = capacity.get(0).getTotalCapacity(); \n                 double usedCapacity =  capacity.get(0).getUsedCapacity();\n                 if (totalCapacity != 0 && usedCapacity/totalCapacity > _capacityTypeThresholdMap.get(capacityType)){\n@@ -441,6 +463,9 @@ public void checkForAlerts(){\n         for( ClusterVO cluster : clusterList){\n         \tfor (Short capacityType : clusterCapacityTypes){\n         \t\tList<SummedCapacity> capacity = _capacityDao.findCapacityBy(capacityType.intValue(), cluster.getDataCenterId(), null, cluster.getId());\n+        \t\tif (capacity == null || capacity.size() == 0){\n+        \t\t\tcontinue;\n+        \t\t}\n         \t\tdouble totalCapacity = capacity.get(0).getTotalCapacity(); \n                 double usedCapacity =  capacity.get(0).getUsedCapacity();\n                 if (totalCapacity != 0 && usedCapacity/totalCapacity > _capacityTypeThresholdMap.get(capacityType)){\n@@ -485,7 +510,7 @@ private void generateEmailAlert(DataCenterVO dc, HostPodVO pod, ClusterVO cluste\n             usedStr = formatBytesToMegabytes(usedCapacity);\n             msgContent = \"Unallocated storage space is low, total: \" + totalStr + \" MB, allocated: \" + usedStr + \" MB (\" + pctStr + \"%)\";\n             break;\n-        case CapacityVO.CAPACITY_TYPE_PUBLIC_IP:\n+        case CapacityVO.CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP:\n             msgSubject = \"System Alert: Number of unallocated public IPs is low in availablity zone \" + dc.getName();\n             totalStr = Double.toString(totalCapacity);\n             usedStr = Double.toString(usedCapacity);\n@@ -497,6 +522,13 @@ private void generateEmailAlert(DataCenterVO dc, HostPodVO pod, ClusterVO cluste\n             usedStr = Double.toString(usedCapacity);\n         \tmsgContent = \"Number of unallocated private IPs is low, total: \" + totalStr + \", allocated: \" + usedStr + \" (\" + pctStr + \"%)\";\n         \tbreak;\n+        \t\n+        case CapacityVO.CAPACITY_TYPE_SECONDARY_STORAGE:        \t\n+        \tmsgSubject = \"System Alert: Low Available Storage in availablity zone \" + dc.getName();\n+        \ttotalStr = Double.toString(totalCapacity);\n+            usedStr = Double.toString(usedCapacity);\n+        \tmsgContent = \"Available secondary storage space is low, total: \" + totalStr + \" MB, used: \" + usedStr + \" MB (\" + pctStr + \"%)\";\n+        \tbreak;        \n         }\n     \t\n     \ttry {\n@@ -509,8 +541,10 @@ private void generateEmailAlert(DataCenterVO dc, HostPodVO pod, ClusterVO cluste\n     private List<Short> getCapacityTypesAtZoneLevel(){\n     \t\n     \tList<Short> dataCenterCapacityTypes = new ArrayList<Short>();\n-    \tdataCenterCapacityTypes.add(Capacity.CAPACITY_TYPE_PUBLIC_IP);\n+    \tdataCenterCapacityTypes.add(Capacity.CAPACITY_TYPE_VIRTUAL_NETWORK_PUBLIC_IP);\n+    \tdataCenterCapacityTypes.add(Capacity.CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP);\n     \tdataCenterCapacityTypes.add(Capacity.CAPACITY_TYPE_SECONDARY_STORAGE);\n+    \tdataCenterCapacityTypes.add(Capacity.CAPACITY_TYPE_VLAN);\n \t\treturn dataCenterCapacityTypes;\n     \t\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/alert/AlertManagerImpl.java",
                "sha": "d8f1d78eb1ca30b7324985d0af4d2e3f4da5d4ef",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/configuration/Config.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/Config.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 0,
                "filename": "server/src/com/cloud/configuration/Config.java",
                "patch": "@@ -101,6 +101,8 @@\n \tPublicIpCapacityThreshold(\"Usage\", ManagementServer.class, Float.class, \"public.ip.capacity.threshold\", \"0.85\", \"Percentage (as a value between 0 and 1) of public IP address space utilization above which alerts will be sent.\", null),\n \tPrivateIpCapacityThreshold(\"Usage\", ManagementServer.class, Float.class, \"private.ip.capacity.threshold\", \"0.85\", \"Percentage (as a value between 0 and 1) of private IP address space utilization above which alerts will be sent.\", null),\n \tSecondaryStorageCapacityThreshold(\"Usage\", ManagementServer.class, Float.class, \"secondarystorage.capacity.threshold\", \"0.85\", \"Percentage (as a value between 0 and 1) of secondary storage utilization above which alerts will be sent about low storage available.\", null),\n+\tVlanCapacityThreshold(\"Usage\", ManagementServer.class, Float.class, \"vlan.capacity.threshold\", \"0.85\", \"Percentage (as a value between 0 and 1) of Zone Vlan utilization above which alerts will be sent about low number of Zone Vlans.\", null),\n+\tDirectNetworkPublicIpCapacityThreshold(\"Usage\", ManagementServer.class, Float.class, \"directnetwork.public.ip.capacity.threshold\", \"0.85\", \"Percentage (as a value between 0 and 1) of Direct Network Public Ip Utilization above which alerts will be sent about low number of direct network public ips.\", null),\n \t\n \t// Console Proxy\n \tConsoleProxyCapacityStandby(\"Console Proxy\", AgentManager.class, String.class, \"consoleproxy.capacity.standby\", \"10\", \"The minimal number of console proxy viewer sessions that system is able to serve immediately(standby capacity)\", null),",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/configuration/Config.java",
                "sha": "40ebebbca86e3dae5acda9f13784eb870272cfb2",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/network/dao/IPAddressDao.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/dao/IPAddressDao.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/dao/IPAddressDao.java",
                "patch": "@@ -20,6 +20,7 @@\n \r\n import java.util.List;\n \n+import com.cloud.dc.Vlan.VlanType;\n import com.cloud.network.IPAddressVO;\n import com.cloud.utils.db.GenericDao;\n import com.cloud.utils.net.Ip;\n@@ -48,7 +49,7 @@\n \t\r\n \tboolean mark(long dcId, Ip ip);\n \n-\tint countIPsForDashboard(long dcId, boolean onlyCountAllocated);\n+\tint countIPsForNetwork(long dcId, boolean onlyCountAllocated, VlanType vlanType);\n \t\n \tIPAddressVO findByAssociatedVmId(long vmId);\n \t",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/network/dao/IPAddressDao.java",
                "sha": "8352dbbd95e99bb0c91a0f830ba815ebe0dbc9b5",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/network/dao/IPAddressDaoImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/dao/IPAddressDaoImpl.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 2,
                "filename": "server/src/com/cloud/network/dao/IPAddressDaoImpl.java",
                "patch": "@@ -245,16 +245,17 @@ public int countIPs(long dcId, long vlanId, boolean onlyCountAllocated) {\n     }\n \n     @Override\n-    public int countIPsForDashboard(long dcId, boolean onlyCountAllocated) {\n+    public int countIPsForNetwork(long dcId, boolean onlyCountAllocated, VlanType vlanType) {\n         SearchCriteria<Integer> sc = AllIpCountForDashboard.create();\n         sc.setParameters(\"dc\", dcId);\n         if (onlyCountAllocated){\n         \tsc.setParameters(\"state\", State.Free);\n         }\n-        sc.setJoinParameters(\"vlan\", \"vlanType\", VlanType.VirtualNetwork.toString());\n+        sc.setJoinParameters(\"vlan\", \"vlanType\", vlanType.toString());\n         return customSearch(sc, null).get(0);\n     }\n \n+    \n     @Override\n     @DB\n     public int countIPs(long dcId, Long accountId, String vlanId, String vlanGateway, String vlanNetmask) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/network/dao/IPAddressDaoImpl.java",
                "sha": "fac3f748b6e1b4a4ac0b158e17fe606245d32e11",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=4b21650e233261cc9cf2464d3a5babf7bc80a49b",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -2484,7 +2484,7 @@ private void updateDomainChildren(DomainVO domain, String updatedDomainPrefix) {\n         \t\t\tsummedCapacity.getUsedCapacity() + summedCapacity.getReservedCapacity(), \n         \t\t\tsummedCapacity.getTotalCapacity(), summedCapacity.getCapacityType());\n         \t\n-        \tif (capacityType == Capacity.CAPACITY_TYPE_CPU){\n+        \tif ( summedCapacity.getCapacityType() == Capacity.CAPACITY_TYPE_CPU){\n         \t\tcapacity.setTotalCapacity((long)(summedCapacity.getTotalCapacity() * ApiDBUtils.getCpuOverprovisioningFactor()));\n         \t}\n         \tcapacities.add(capacity);\t\t",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b21650e233261cc9cf2464d3a5babf7bc80a49b/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "e7472d0720da007703ea32e6966e36cea29baea2",
                "status": "modified"
            }
        ],
        "message": "bug 10848: Removing NPE from listCapacity and new alert code. Adding CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP. Introducing thresholds for vlan and direct attached public ips.",
        "parent": "https://github.com/apache/cloudstack/commit/3921421ce56a4de11ddf00f79ba84d7943f6a0fd",
        "repo": "cloudstack",
        "unit_tests": [
            "ConfigTest.java",
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_4b8bfe2": {
        "bug_id": "cloudstack_4b8bfe2",
        "commit": "https://github.com/apache/cloudstack/commit/4b8bfe26275f7eb6e98abe77849153eaa93e8205",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/4b8bfe26275f7eb6e98abe77849153eaa93e8205/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=4b8bfe26275f7eb6e98abe77849153eaa93e8205",
                "deletions": 5,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1873,7 +1873,8 @@ protected void migrate(VMInstanceVO vm, long srcHostId, DeployDestination dest)\n         try {\n             pfma = _agentMgr.send(dstHostId, pfmc);\n             if (pfma == null || !pfma.getResult()) {\n-                String msg = \"Unable to prepare for migration due to \" + pfma.getDetails();\n+                String details = (pfma != null) ? pfma.getDetails() : \"null answer returned\";\n+                String msg = \"Unable to prepare for migration due to \" + details;\n                 pfma = null;\n                 throw new AgentUnavailableException(msg, dstHostId);\n             }\n@@ -1909,7 +1910,8 @@ protected void migrate(VMInstanceVO vm, long srcHostId, DeployDestination dest)\n             try {\n                 Answer ma = _agentMgr.send(vm.getLastHostId(), mc);\n                 if (ma == null || !ma.getResult()) {\n-                    throw new CloudRuntimeException(\"Unable to migrate due to \" + ma.getDetails());\n+                    String details = (ma != null) ? ma.getDetails() : \"null answer returned\";\n+                    throw new CloudRuntimeException(\"Unable to migrate due to \" + details);\n                 }\n             } catch (OperationTimedoutException e) {\n                 if (e.isActive()) {\n@@ -3263,7 +3265,8 @@ private void orchestrateMigrateForScale(String vmUuid, long srcHostId, DeployDes\n         try {\n             pfma = _agentMgr.send(dstHostId, pfmc);\n             if (pfma == null || !pfma.getResult()) {\n-                String msg = \"Unable to prepare for migration due to \" + pfma.getDetails();\n+                String details = (pfma != null) ? pfma.getDetails() : \"null answer returned\";\n+                String msg = \"Unable to prepare for migration due to \" + details;\n                 pfma = null;\n                 throw new AgentUnavailableException(msg, dstHostId);\n             }\n@@ -3296,8 +3299,10 @@ private void orchestrateMigrateForScale(String vmUuid, long srcHostId, DeployDes\n             try {\n                 Answer ma = _agentMgr.send(vm.getLastHostId(), mc);\n                 if (ma == null || !ma.getResult()) {\n-                    s_logger.error(\"Unable to migrate due to \" + ma.getDetails());\n-                    throw new CloudRuntimeException(\"Unable to migrate due to \" + ma.getDetails());\n+                    String details = (ma != null) ? ma.getDetails() : \"null answer returned\";\n+                    String msg = \"Unable to migrate due to \" + details;\n+                    s_logger.error(msg);\n+                    throw new CloudRuntimeException(msg);\n                 }\n             } catch (OperationTimedoutException e) {\n                 if (e.isActive()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/4b8bfe26275f7eb6e98abe77849153eaa93e8205/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "de2fd28e3a18af0c114553e6dcfaf9485036aaee",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7563: Fix potential NPE from FingBugs.",
        "parent": "https://github.com/apache/cloudstack/commit/771d05238160764b4eb222d80696a3dce1422fa6",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_4c42aaf": {
        "bug_id": "cloudstack_4c42aaf",
        "commit": "https://github.com/apache/cloudstack/commit/4c42aafae0d3286a38d796a7c69a6aec6810cf79",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 0,
                "filename": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "patch": "@@ -499,6 +499,9 @@ public VolumeInfo copyVolumeFromSecToPrimary(VolumeInfo volume, VirtualMachine v\n \n         // Find a suitable storage to create volume on\n         StoragePool destPool = findStoragePool(dskCh, dc, pod, clusterId, null, vm, avoidPools);\n+        if (destPool == null) {\n+            throw new CloudRuntimeException(\"Failed to find a suitable storage pool to create Volume in the pod/cluster of the provided VM \"+ vm.getUuid());\n+        }\n         DataStore destStore = dataStoreMgr.getDataStore(destPool.getId(), DataStoreRole.Primary);\n         AsyncCallFuture<VolumeApiResult> future = volService.copyVolume(volume, destStore);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "sha": "c8279ff3f99c85b0fdcce52ba5d3dbc4ae6db1e4",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDao.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDao.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 3,
                "filename": "engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDao.java",
                "patch": "@@ -39,9 +39,6 @@\n      */\n     void setResourceCount(long ownerId, ResourceOwnerType ownerType, ResourceType type, long count);\n \n-    @Deprecated\n-    void updateDomainCount(long domainId, ResourceType type, boolean increment, long delta);\n-\n     boolean updateById(long id, boolean increment, long delta);\n \n     void createResourceCounts(long ownerId, ResourceOwnerType ownerType);",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDao.java",
                "sha": "28f2a53607162264d07361027e3a24a0d0c53161",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDaoImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDaoImpl.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 10,
                "filename": "engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDaoImpl.java",
                "patch": "@@ -120,16 +120,6 @@ public void setResourceCount(long ownerId, ResourceOwnerType ownerType, Resource\n         }\n     }\n \n-    @Override\n-    @Deprecated\n-    public void updateDomainCount(long domainId, ResourceType type, boolean increment, long delta) {\n-        delta = increment ? delta : delta * -1;\n-\n-        ResourceCountVO resourceCountVO = findByOwnerAndType(domainId, ResourceOwnerType.Domain, type);\n-        resourceCountVO.setCount(resourceCountVO.getCount() + delta);\n-        update(resourceCountVO.getId(), resourceCountVO);\n-    }\n-\n     @Override\n     public boolean updateById(long id, boolean increment, long delta) {\n         delta = increment ? delta : delta * -1;",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/engine/schema/src/main/java/com/cloud/configuration/dao/ResourceCountDaoImpl.java",
                "sha": "dbf2228183bc8fd89f9b897bb3efeb86863a6781",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/plugins/deployment-planners/implicit-dedication/src/main/java/com/cloud/deploy/ImplicitDedicationPlanner.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/deployment-planners/implicit-dedication/src/main/java/com/cloud/deploy/ImplicitDedicationPlanner.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 5,
                "filename": "plugins/deployment-planners/implicit-dedication/src/main/java/com/cloud/deploy/ImplicitDedicationPlanner.java",
                "patch": "@@ -39,6 +39,7 @@\n import com.cloud.utils.NumbersUtil;\n import com.cloud.vm.VMInstanceVO;\n import com.cloud.vm.VirtualMachineProfile;\n+import org.springframework.util.CollectionUtils;\n \n public class ImplicitDedicationPlanner extends FirstFitPlanner implements DeploymentClusterPlanner {\n \n@@ -256,14 +257,15 @@ public PlannerResourceUsage getResourceUsage(VirtualMachineProfile vmProfile, De\n \n             // Get the list of all the hosts in the given clusters\n             List<Long> allHosts = new ArrayList<Long>();\n-            for (Long cluster : clusterList) {\n-                List<HostVO> hostsInCluster = resourceMgr.listAllHostsInCluster(cluster);\n-                for (HostVO hostVO : hostsInCluster) {\n+            if (!CollectionUtils.isEmpty(clusterList)) {\n+                for (Long cluster : clusterList) {\n+                    List<HostVO> hostsInCluster = resourceMgr.listAllHostsInCluster(cluster);\n+                    for (HostVO hostVO : hostsInCluster) {\n \n-                    allHosts.add(hostVO.getId());\n+                        allHosts.add(hostVO.getId());\n+                    }\n                 }\n             }\n-\n             // Go over all the hosts in the cluster and get a list of\n             // 1. All empty hosts, not running any vms.\n             // 2. Hosts running vms for this account and created by a service",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/plugins/deployment-planners/implicit-dedication/src/main/java/com/cloud/deploy/ImplicitDedicationPlanner.java",
                "sha": "45f16abd2af678266ec011300a582afde0b4b7c3",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 2,
                "filename": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "patch": "@@ -2339,7 +2339,10 @@ public int compare(final DiskTO arg0, final DiskTO arg1) {\n                     disk.setCacheMode(DiskDef.DiskCacheMode.valueOf(volumeObjectTO.getCacheMode().toString().toUpperCase()));\n                 }\n             }\n-\n+            if (vm.getDevices() == null) {\n+                s_logger.error(\"There is no devices for\" + vm);\n+                throw new RuntimeException(\"There is no devices for\" + vm);\n+            }\n             vm.getDevices().addDevice(disk);\n         }\n \n@@ -2393,7 +2396,10 @@ private void createVif(final LibvirtVMDef vm, final NicTO nic, final String nicA\n                         + \") is \" + nic.getType() + \" traffic type. So, vsp-vr-ip \" + vrIp + \" is set in the metadata\");\n             }\n         }\n-\n+        if (vm.getDevices() == null) {\n+            s_logger.error(\"LibvirtVMDef object get devices with null result\");\n+            throw new InternalErrorException(\"LibvirtVMDef object get devices with null result\");\n+        }\n         vm.getDevices().addDevice(getVifDriver(nic.getType(), nic.getName()).plug(nic, vm.getPlatformEmulator(), nicAdapter));\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "sha": "f26d8ded0a453038f0bf5d6aaa621fbd8c00ebe6",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 1,
                "filename": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "patch": "@@ -522,7 +522,9 @@ public KVMStoragePool createStoragePool(String name, String host, int port, Stri\n                     s_logger.debug(\"Checking path of existing pool \" + poolname + \" against pool we want to create\");\n                     StoragePool p = conn.storagePoolLookupByName(poolname);\n                     LibvirtStoragePoolDef pdef = getStoragePoolDef(conn, p);\n-\n+                    if (pdef == null) {\n+                        throw new CloudRuntimeException(\"Unable to parse the storage pool definition for storage pool \" + poolname);\n+                    }\n                     String targetPath = pdef.getTargetPath();\n                     if (targetPath != null && targetPath.equals(path)) {\n                         s_logger.debug(\"Storage pool utilizing path '\" + path + \"' already exists as pool \" + poolname +",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "sha": "63f7872d05e8fb88b9e54e8593b47e3e8cdcdf1e",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 0,
                "filename": "server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -2139,6 +2139,12 @@ public boolean startRemoteAccessVpn(final Network network, final RemoteAccessVpn\n             }\n \n             Answer answer = cmds.getAnswer(\"users\");\n+            if (answer == null) {\n+                s_logger.error(\"Unable to start vpn: unable add users to vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \"\n+                        + router.getInstanceName() + \" due to null answer\");\n+                throw new ResourceUnavailableException(\"Unable to start vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \"\n+                        + router.getInstanceName() + \" due to null answer\", DataCenter.class, router.getDataCenterId());\n+            }\n             if (!answer.getResult()) {\n                 s_logger.error(\"Unable to start vpn: unable add users to vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \"\n                         + router.getInstanceName() + \" due to \" + answer.getDetails());",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "63587a898359568c0a95956755d406773ce1194b",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 6,
                "filename": "server/src/main/java/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -740,18 +740,20 @@ public boolean startRemoteAccessVpn(final RemoteAccessVpn vpn, final VirtualRout\n             throw new AgentUnavailableException(\"Unable to send commands to virtual router \", router.getHostId(), e);\n         }\n         Answer answer = cmds.getAnswer(\"users\");\n-        if (!answer.getResult()) {\n+        if (answer == null || !answer.getResult()) {\n+            String errorMessage = (answer == null) ? \"null answer object\" : answer.getDetails();\n             s_logger.error(\"Unable to start vpn: unable add users to vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \"\n-                    + router.getInstanceName() + \" due to \" + answer.getDetails());\n+                    + router.getInstanceName() + \" due to \" + errorMessage);\n             throw new ResourceUnavailableException(\"Unable to start vpn: Unable to add users to vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId()\n-            + \" on domR: \" + router.getInstanceName() + \" due to \" + answer.getDetails(), DataCenter.class, router.getDataCenterId());\n+            + \" on domR: \" + router.getInstanceName() + \" due to \" + errorMessage, DataCenter.class, router.getDataCenterId());\n         }\n         answer = cmds.getAnswer(\"startVpn\");\n-        if (!answer.getResult()) {\n+        if (answer == null || !answer.getResult()) {\n+            String errorMessage = (answer == null) ? \"null answer object\" : answer.getDetails();\n             s_logger.error(\"Unable to start vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \" + router.getInstanceName() + \" due to \"\n-                    + answer.getDetails());\n+                    + errorMessage);\n             throw new ResourceUnavailableException(\"Unable to start vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \"\n-                    + router.getInstanceName() + \" due to \" + answer.getDetails(), DataCenter.class, router.getDataCenterId());\n+                    + router.getInstanceName() + \" due to \" + errorMessage, DataCenter.class, router.getDataCenterId());\n         }\n \n         return true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "sha": "eabfb4337f4ef4b0d719f7b3888abcac98188bc0",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/projects/ProjectManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/projects/ProjectManagerImpl.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 0,
                "filename": "server/src/main/java/com/cloud/projects/ProjectManagerImpl.java",
                "patch": "@@ -479,6 +479,10 @@ public void doInTransactionWithoutResult(TransactionStatus status) throws Resour\n                 throw new InvalidParameterValueException(\"Unable to find account name=\" + newOwnerName + \" in domain id=\" + project.getDomainId());\n             }\n             Account currentOwnerAccount = getProjectOwner(projectId);\n+            if (currentOwnerAccount == null) {\n+                s_logger.error(\"Unable to find the current owner for the project id=\" + projectId);\n+                throw new InvalidParameterValueException(\"Unable to find the current owner for the project id=\" + projectId);\n+            }\n             if (currentOwnerAccount.getId() != futureOwnerAccount.getId()) {\n                 ProjectAccountVO futureOwner = _projectAccountDao.findByProjectIdAccountId(projectId, futureOwnerAccount.getAccountId());\n                 if (futureOwner == null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/projects/ProjectManagerImpl.java",
                "sha": "48d65189476fd034368461e1458f006fad17a387",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/template/TemplateManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/template/TemplateManagerImpl.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 1,
                "filename": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -1232,7 +1232,10 @@ private boolean attachISOToVM(long vmId, long isoId, boolean attach) {\n \n         // prepare ISO ready to mount on hypervisor resource level\n         TemplateInfo tmplt = prepareIso(isoId, vm.getDataCenterId(), vm.getHostId(), null);\n-\n+        if (tmplt == null) {\n+            s_logger.error(\"Failed to prepare ISO ready to mount on hypervisor resource level\");\n+            throw new CloudRuntimeException(\"Failed to prepare ISO ready to mount on hypervisor resource level\");\n+        }\n         String vmName = vm.getInstanceName();\n \n         HostVO host = _hostDao.findById(vm.getHostId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/com/cloud/template/TemplateManagerImpl.java",
                "sha": "c862adae61fc0d71428b0baadf9186fccbfb1789",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/org/apache/cloudstack/region/gslb/GlobalLoadBalancingRulesServiceImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/org/apache/cloudstack/region/gslb/GlobalLoadBalancingRulesServiceImpl.java?ref=4c42aafae0d3286a38d796a7c69a6aec6810cf79",
                "deletions": 3,
                "filename": "server/src/main/java/org/apache/cloudstack/region/gslb/GlobalLoadBalancingRulesServiceImpl.java",
                "patch": "@@ -650,9 +650,12 @@ private boolean applyGlobalLoadBalancerRuleConfig(long gslbRuleId, boolean revok\n             SiteLoadBalancerConfig siteLb =\n                 new SiteLoadBalancerConfig(gslbLbMapVo.isRevoke(), serviceType, ip.getAddress().addr(), Integer.toString(loadBalancer.getDefaultPortStart()),\n                     dataCenterId);\n-\n-            siteLb.setGslbProviderPublicIp(lookupGslbServiceProvider().getZoneGslbProviderPublicIp(dataCenterId, physicalNetworkId));\n-            siteLb.setGslbProviderPrivateIp(lookupGslbServiceProvider().getZoneGslbProviderPrivateIp(dataCenterId, physicalNetworkId));\n+            GslbServiceProvider gslbProvider = lookupGslbServiceProvider();\n+            if (gslbProvider == null) {\n+                throw new CloudRuntimeException(\"No GSLB provider is available\");\n+            }\n+            siteLb.setGslbProviderPublicIp(gslbProvider.getZoneGslbProviderPublicIp(dataCenterId, physicalNetworkId));\n+            siteLb.setGslbProviderPrivateIp(gslbProvider.getZoneGslbProviderPrivateIp(dataCenterId, physicalNetworkId));\n             siteLb.setWeight(gslbLbMapVo.getWeight());\n \n             zoneSiteLoadbalancerMap.put(network.getDataCenterId(), siteLb);",
                "raw_url": "https://github.com/apache/cloudstack/raw/4c42aafae0d3286a38d796a7c69a6aec6810cf79/server/src/main/java/org/apache/cloudstack/region/gslb/GlobalLoadBalancingRulesServiceImpl.java",
                "sha": "baa3ba02562202bb9a04a2db7c764fcaabb38ade",
                "status": "modified"
            }
        ],
        "message": "[CLOUDSTACK-10356] Fix NPE in Cloudstack found with NPEDetector  (#2573)\n\n* fix https://issues.apache.org/jira/browse/CLOUDSTACK-10356\r\n\r\n* del patch file\r\n\r\n* Update ResourceCountDaoImpl.java\r\n\r\n* fix some format\r\n\r\n* fix code\r\n\r\n* fix error message in VolumeOrchestrator\r\n\r\n* add check null stmt\r\n\r\n* del import unuse class\r\n\r\n* use BooleanUtils to check Boolean\r\n\r\n* fix error message\r\n\r\n* delete unuse function\r\n\r\n* delete the deprecated function  updateDomainCount\r\n\r\n* add error log and throw exception in ProjectManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/efcd24c2a2cdc5d04b3f6d424305288b1cf88852",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java",
            "VirtualNetworkApplianceManagerImplTest.java",
            "TemplateManagerImplTest.java",
            "GlobalLoadBalancingRulesServiceImplTest.java"
        ]
    },
    "cloudstack_4d4fb9c": {
        "bug_id": "cloudstack_4d4fb9c",
        "commit": "https://github.com/apache/cloudstack/commit/4d4fb9c95964d1981c7ac497fe317f997d367193",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/4d4fb9c95964d1981c7ac497fe317f997d367193/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ConfigurationServerImpl.java?ref=4d4fb9c95964d1981c7ac497fe317f997d367193",
                "deletions": 2,
                "filename": "server/src/com/cloud/server/ConfigurationServerImpl.java",
                "patch": "@@ -341,8 +341,8 @@ protected void saveUser() {\n         }\n \n         // now insert the user\n-        insertSql = \"INSERT INTO `cloud`.`user` (id, uuid, username, account_id, firstname, lastname, created, state) \" +\n-                \"VALUES (\" + id + \", UUID(), '\" + username + \"', 2, '\" + firstname + \"','\" + lastname + \"',now(), 'disabled')\";\n+        insertSql = \"INSERT INTO `cloud`.`user` (id, username, password, account_id, firstname, lastname, created, state) \" +\n+                \"VALUES (\" + id + \",'\" + username + \"', RAND(), 2, '\" + firstname + \"','\" + lastname + \"',now(), 'disabled')\";\n \n         txn = Transaction.currentTxn();\n         try {",
                "raw_url": "https://github.com/apache/cloudstack/raw/4d4fb9c95964d1981c7ac497fe317f997d367193/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "sha": "74fba8967531e5d0f5566708803aab23a1fbe23d",
                "status": "modified"
            }
        ],
        "message": "https://issues.apache.org/jira/browse/CLOUDSTACK-993\n\nChanges:\n- Introduction of maven skipped the java code that inserts the admin user. This causes the NPE in management server while trying to find the user and also, admin user cannot login as expected.\n- Fixing the insertion of the admin user as part of startup.",
        "parent": "https://github.com/apache/cloudstack/commit/cadca5fc0cfdbdcdf6cd193b02f097155f3a7377",
        "repo": "cloudstack",
        "unit_tests": [
            "ConfigurationServerImplTest.java"
        ]
    },
    "cloudstack_4df7423": {
        "bug_id": "cloudstack_4df7423",
        "commit": "https://github.com/apache/cloudstack/commit/4df7423f70e6dc31f1ab5040e17f63f4c2103c4c",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/4df7423f70e6dc31f1ab5040e17f63f4c2103c4c/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=4df7423f70e6dc31f1ab5040e17f63f4c2103c4c",
                "deletions": 6,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -824,12 +824,14 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            volResponse.setVirtualMachineId(vm.getId());\n-            volResponse.setVirtualMachineName(vm.getHostName());\n-            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-            if (userVm != null) {\n-                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                volResponse.setVirtualMachineState(vm.getState().toString());\n+            if (vm != null) {\n+                volResponse.setVirtualMachineId(vm.getId());\n+                volResponse.setVirtualMachineName(vm.getHostName());\n+                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+                if (userVm != null) {\n+                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                    volResponse.setVirtualMachineState(vm.getState().toString());\n+                }\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/4df7423f70e6dc31f1ab5040e17f63f4c2103c4c/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "f668f5a7f3c8e718c7946dc49b97ed2f64c27088",
                "status": "modified"
            }
        ],
        "message": "fix NPE when listvolume if vm got destroyed",
        "parent": "https://github.com/apache/cloudstack/commit/407b45ee2e9981c45b91c99598dc557b9d3acc84",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_4e07dd1": {
        "bug_id": "cloudstack_4e07dd1",
        "commit": "https://github.com/apache/cloudstack/commit/4e07dd1dc4b4618fff2ef25c846ce6b95a8e580d",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/4e07dd1dc4b4618fff2ef25c846ce6b95a8e580d/server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/dispatch/ParamProcessWorker.java?ref=4e07dd1dc4b4618fff2ef25c846ce6b95a8e580d",
                "deletions": 2,
                "filename": "server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "patch": "@@ -329,8 +329,6 @@ private void setFieldValue(final Field field, final BaseCmd cmdObj, final Object\n                     field.set(cmdObj, listParam);\n                     break;\n                 case UUID:\n-                    if (paramObj.toString().isEmpty())\n-                        break;\n                     final Long internalId = translateUuidToInternalId(paramObj.toString(), annotation);\n                     field.set(cmdObj, internalId);\n                     break;",
                "raw_url": "https://github.com/apache/cloudstack/raw/4e07dd1dc4b4618fff2ef25c846ce6b95a8e580d/server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "sha": "ff6d666a8fe9aa27fd6aa256fea8774008b29a4c",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7581: Empty 'ID' parameters allowed in API calls\nFix is to fail API calls with empty 'id' parameter value upfront rather than going ahead and failing with NPE later on",
        "parent": "https://github.com/apache/cloudstack/commit/7f440854f7bcd41a1bd6581c0239cde2e98261b7",
        "repo": "cloudstack",
        "unit_tests": [
            "ParamProcessWorkerTest.java"
        ]
    },
    "cloudstack_4e21948": {
        "bug_id": "cloudstack_4e21948",
        "commit": "https://github.com/apache/cloudstack/commit/4e21948f5c73e10cf5d9731b16da3e47a8d46093",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/4e21948f5c73e10cf5d9731b16da3e47a8d46093/server/src/com/cloud/network/router/NetworkHelperImpl.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/NetworkHelperImpl.java?ref=4e21948f5c73e10cf5d9731b16da3e47a8d46093",
                "deletions": 18,
                "filename": "server/src/com/cloud/network/router/NetworkHelperImpl.java",
                "patch": "@@ -372,14 +372,6 @@ protected DomainRouterVO waitRouter(final DomainRouterVO router) {\n         return null;\n     }\n \n-    // @Override\n-    /*\n-     * (non-Javadoc)\n-     * \n-     * @see\n-     * com.cloud.network.router.NetworkHelper#startRouters(org.cloud.network\n-     * .router.deployment.RouterDeploymentDefinition)\n-     */\n     @Override\n     public List<DomainRouterVO> startRouters(final RouterDeploymentDefinition routerDeploymentDefinition) throws StorageUnavailableException, InsufficientCapacityException,\n             ConcurrentOperationException, ResourceUnavailableException {\n@@ -407,15 +399,6 @@ protected DomainRouterVO waitRouter(final DomainRouterVO router) {\n         return runningRouters;\n     }\n \n-    // @Override\n-    /*\n-     * (non-Javadoc)\n-     * \n-     * @see\n-     * com.cloud.network.router.NetworkHelper#startVirtualRouter(com.cloud.vm\n-     * .DomainRouterVO, com.cloud.user.User, com.cloud.user.Account,\n-     * java.util.Map)\n-     */\n     @Override\n     public DomainRouterVO startVirtualRouter(final DomainRouterVO router, final User user, final Account caller, final Map<Param, Object> params)\n             throws StorageUnavailableException, InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException {\n@@ -513,7 +496,16 @@ protected String retrieveTemplateName(HypervisorType hType, final long datacente\n             }\n         }\n \n-        return hypervisorsMap.get(hType).valueIn(datacenterId);\n+        // Returning NULL is fine because the simulator will need it when being\n+        // used instead of a real hypervisor.\n+        // The hypervisorsMap contains only real hypervisors.\n+        String templateName = null;\n+        ConfigKey<String> hypervisorConfigKey = hypervisorsMap.get(hType);\n+\n+        if (hypervisorConfigKey != null) {\n+            templateName = hypervisorConfigKey.valueIn(datacenterId);\n+        }\n+        return templateName;\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/4e21948f5c73e10cf5d9731b16da3e47a8d46093/server/src/com/cloud/network/router/NetworkHelperImpl.java",
                "sha": "f589394103ee1f4c1a366e5c9f9b4e91551ed581",
                "status": "modified"
            }
        ],
        "message": "Fixing the NetworkHelperImpl class. It was throwing a NPE due to a hypervisor type SIMULATOR not being in the hashmap.\n\nWhen the refactor took place, we should have changed first structure, then behaviour. By refactoring the deployRouter method\nwe changed how the templateName was retrieved.\nFixed and tested using the simulator and the following Marvin tests\n\ntest_privategateway_acl\ntest_routers\ntest_vpc_vpn\ntest_service_offerings\ntest_volumes\ntest_reset_vm_on_reboot\ntest_multipleips_per_nic\n\nConflicts:\n\tserver/src/com/cloud/network/router/NetworkHelperImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/025ff72410385941c5da40ad42247f672af50bbe",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkHelperImplTest.java"
        ]
    },
    "cloudstack_4e823e3": {
        "bug_id": "cloudstack_4e823e3",
        "commit": "https://github.com/apache/cloudstack/commit/4e823e3a3e0c571de10e2675107da52fbc0b9eff",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/4e823e3a3e0c571de10e2675107da52fbc0b9eff/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=4e823e3a3e0c571de10e2675107da52fbc0b9eff",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1522,7 +1522,13 @@ public boolean storagePoolHasEnoughIops(List<Volume> requestedVolumes,\n         }\n \n         long futureIops = currentIops + requestedIops;\n-\n+        \n+        // getCapacityIops returns a Long so we need to check for null\n+        if (pool.getCapacityIops() == null) {\n+            s_logger.warn(\"Storage pool \" + pool.getName() + \" (\" + pool.getId() + \") does not supply Iops capacity, assuming enough capacity\");\n+            return true;\n+        }\n+        \n         return futureIops <= pool.getCapacityIops();\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/4e823e3a3e0c571de10e2675107da52fbc0b9eff/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "9ddcb7866fdf7af994fcf8abf2a04f7302fa2d5e",
                "status": "modified"
            }
        ],
        "message": "Workaround for NPE",
        "parent": "https://github.com/apache/cloudstack/commit/5396dfa55c343a146667b7148a66864ef6093cc2",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_530b0be": {
        "bug_id": "cloudstack_530b0be",
        "commit": "https://github.com/apache/cloudstack/commit/530b0beb3c8b172fbfaf89584cd24785b7513998",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-egress-acl-rule.xml",
                "changes": 53,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-egress-acl-rule.xml?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 43,
                "filename": "plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-egress-acl-rule.xml",
                "patch": "@@ -118,70 +118,38 @@ under the License.\n       <policyNetworkExpression\r\n         dn=\"%aclruledn%/rule-cond-4/nw-expr2\"\r\n         id=\"2\"\r\n-        opr=\"eq\"\r\n+        opr=\"range\"\r\n         status=\"created\"/>\r\n     </pair>\r\n     <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-attr-qual\">\r\n       <policyNwAttrQualifier\r\n-        attrEp=\"source\"\r\n+        attrEp=\"destination\"\r\n         dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-attr-qual\"\r\n         status=\"created\"/>\r\n     </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-ip-2\">\r\n-      <policyIPAddress\r\n-        dataType=\"string\"\r\n-        descr=\"\"\r\n-        dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-ip-2\"\r\n-        id=\"2\"\r\n-        name=\"\"\r\n-        placement=\"none\"\r\n-        status=\"created\"\r\n-        value=\"%sourceip%\"/>\r\n-    </pair>\r\n-\r\n-    <pair key=\"%aclruledn%/rule-cond-5\">\r\n-      <policyRuleCondition\r\n-        dn=\"%aclruledn%/rule-cond-5\"\r\n-        id=\"5\"\r\n-        order=\"unspecified\"\r\n-        status=\"created\"/>\r\n-    </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2\">\r\n-      <policyNetworkExpression\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2\"\r\n-        id=\"2\"\r\n-        opr=\"range\"\r\n-        status=\"created\"/>\r\n-    </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2/nw-attr-qual\">\r\n-      <policyNwAttrQualifier\r\n-        attrEp=\"source\"\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2/nw-attr-qual\"\r\n-        status=\"created\"/>\r\n-    </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-2\">\r\n+    <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-2\">\r\n       <policyNetworkPort\r\n         appType=\"Other\"\r\n         dataType=\"string\"\r\n         descr=\"\"\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-2\"\r\n+        dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-2\"\r\n         id=\"2\"\r\n         name=\"\"\r\n         placement=\"begin\"\r\n         status=\"created\"\r\n-        value=\"%sourcestartport%\"/>\r\n+        value=\"%deststartport%\"/>\r\n     </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-3\">\r\n+    <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-3\">\r\n       <policyNetworkPort\r\n         appType=\"Other\"\r\n         dataType=\"string\"\r\n         descr=\"\"\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-3\"\r\n+        dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-3\"\r\n         id=\"3\"\r\n         name=\"\"\r\n         placement=\"end\"\r\n         status=\"created\"\r\n-        value=\"%sourceendport%\"/>\r\n+        value=\"%destendport%\"/>\r\n     </pair>\r\n \r\n   </inConfigs>\r\n@@ -195,7 +163,6 @@ under the License.\n     protocolvalue = \"TCP\" or \"UDP\"\r\n     deststartip=\"destination start ip\"\r\n     destendip=\"destination end ip\"\r\n-    sourcestartport=\"start port at source\"\r\n-    sourceendport=\"end port at source\"\r\n-    sourceip=\"source ip\"\r\n+    deststartport=\"start port at destination\"\r\n+    destendport=\"end port at destination\"\r\n --!>\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-egress-acl-rule.xml",
                "sha": "05c066d6d53356da5fddc73e97cb116e4d25acf6",
                "status": "modified"
            },
            {
                "additions": 94,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-no-protocol-rule.xml",
                "changes": 94,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-no-protocol-rule.xml?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 0,
                "filename": "plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-no-protocol-rule.xml",
                "patch": "@@ -0,0 +1,94 @@\n+<!--\r\n+Licensed to the Apache Software Foundation (ASF) under one\r\n+or more contributor license agreements.  See the NOTICE file\r\n+distributed with this work for additional information\r\n+regarding copyright ownership.  The ASF licenses this file\r\n+to you under the Apache License, Version 2.0 (the\r\n+\"License\"); you may not use this file except in compliance\r\n+with the License.  You may obtain a copy of the License at\r\n+\r\n+  http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+Unless required by applicable law or agreed to in writing,\r\n+software distributed under the License is distributed on an\r\n+\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+KIND, either express or implied.  See the License for the\r\n+specific language governing permissions and limitations\r\n+under the License.\r\n+-->\r\n+<configConfMos\r\n+  cookie=\"%cookie%\"\r\n+  inHierarchical=\"false\">\r\n+  <inConfigs>\r\n+\r\n+    <pair key=\"%aclruledn%\">\r\n+      <policyRule\r\n+        descr=\"%descr%\"\r\n+        dn=\"%aclruledn%\"\r\n+        name=\"%aclrulename%\"\r\n+        order=\"%order%\"\r\n+        status=\"created\"/>\r\n+    </pair>\r\n+\r\n+    <pair key=\"%aclruledn%/rule-action-0\">\r\n+      <fwpolicyAction\r\n+        actionType=\"%actiontype%\"\r\n+        dn=\"%aclruledn%/rule-action-0\"\r\n+        id=\"0\"\r\n+        status=\"created\"/>\r\n+    </pair>\r\n+\r\n+    <pair key=\"%aclruledn%/rule-cond-2\">\r\n+      <policyRuleCondition\r\n+        dn=\"%aclruledn%/rule-cond-2\"\r\n+        id=\"2\"\r\n+        order=\"unspecified\"\r\n+        status=\"created\"/>\r\n+    </pair>\r\n+    <pair key=\"%aclruledn%/rule-cond-2/nw-expr2\">\r\n+      <policyNetworkExpression\r\n+        dn=\"%aclruledn%/rule-cond-2/nw-expr2\"\r\n+        id=\"2\"\r\n+        opr=\"range\"\r\n+        status=\"created\"/>\r\n+    </pair>\r\n+    <pair key=\"%aclruledn%/rule-cond-2/nw-expr2/nw-attr-qual\">\r\n+      <policyNwAttrQualifier\r\n+        attrEp=\"destination\"\r\n+        dn=\"%aclruledn%/rule-cond-2/nw-expr2/nw-attr-qual\"\r\n+        status=\"created\"/>\r\n+    </pair>\r\n+    <pair key=\"%aclruledn%/rule-cond-2/nw-expr2/nw-ip-2\">\r\n+      <policyIPAddress\r\n+        dataType=\"string\"\r\n+        descr=\"\"\r\n+        dn=\"%aclruledn%/rule-cond-2/nw-expr2/nw-ip-2\"\r\n+        id=\"2\"\r\n+        name=\"\"\r\n+        placement=\"begin\"\r\n+        status=\"created\"\r\n+        value=\"%deststartip%\"/>\r\n+    </pair>\r\n+    <pair key=\"%aclruledn%/rule-cond-2/nw-expr2/nw-ip-3\">\r\n+      <policyIPAddress\r\n+        dataType=\"string\"\r\n+        descr=\"\"\r\n+        dn=\"%aclruledn%/rule-cond-2/nw-expr2/nw-ip-3\"\r\n+        id=\"3\"\r\n+        name=\"\"\r\n+        placement=\"end\"\r\n+        status=\"created\"\r\n+        value=\"%destendip%\"/>\r\n+    </pair>\r\n+\r\n+  </inConfigs>\r\n+</configConfMos>\r\n+\r\n+<!--\r\n+    aclruledn=\"org-root/org-vlan-123/org-VDC-vlan-123/pol-test_policy/rule-dummy\"\r\n+    aclrulename=\"dummy\"\r\n+    descr=value\r\n+    actiontype=\"drop\" or \"permit\"\r\n+    deststartip=\"destination start ip\"\r\n+    destendip=\"destination end ip\"\r\n+--!>\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-no-protocol-rule.xml",
                "sha": "17cfa54a34e760e389beddf43bc9b81e0e4d7cd6",
                "status": "added"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-rule.xml",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-rule.xml?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 1,
                "filename": "plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-rule.xml",
                "patch": "@@ -118,5 +118,4 @@ under the License.\n     protocolvalue = \"TCP\" or \"UDP\" or \"ICMP\"\r\n     deststartip=\"destination start ip\"\r\n     destendip=\"destination end ip\"\r\n-    sourceip=\"source ip\"\r\n --!>\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-generic-egress-acl-rule.xml",
                "sha": "436e3eae790145fad7215f4e0a8229b9dfeb52f2",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-ingress-acl-rule.xml",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-ingress-acl-rule.xml?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 38,
                "filename": "plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-ingress-acl-rule.xml",
                "patch": "@@ -118,7 +118,7 @@ under the License.\n       <policyNetworkExpression\r\n         dn=\"%aclruledn%/rule-cond-4/nw-expr2\"\r\n         id=\"2\"\r\n-        opr=\"eq\"\r\n+        opr=\"range\"\r\n         status=\"created\"/>\r\n     </pair>\r\n     <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-attr-qual\">\r\n@@ -127,56 +127,24 @@ under the License.\n         dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-attr-qual\"\r\n         status=\"created\"/>\r\n     </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-ip-2\">\r\n-      <policyIPAddress\r\n-        dataType=\"string\"\r\n-        descr=\"\"\r\n-        dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-ip-2\"\r\n-        id=\"2\"\r\n-        name=\"\"\r\n-        placement=\"none\"\r\n-        status=\"created\"\r\n-        value=\"%destip%\"/>\r\n-    </pair>\r\n-\r\n-    <pair key=\"%aclruledn%/rule-cond-5\">\r\n-      <policyRuleCondition\r\n-        dn=\"%aclruledn%/rule-cond-5\"\r\n-        id=\"5\"\r\n-        order=\"unspecified\"\r\n-        status=\"created\"/>\r\n-    </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2\">\r\n-      <policyNetworkExpression\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2\"\r\n-        id=\"2\"\r\n-        opr=\"range\"\r\n-        status=\"created\"/>\r\n-    </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2/nw-attr-qual\">\r\n-      <policyNwAttrQualifier\r\n-        attrEp=\"destination\"\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2/nw-attr-qual\"\r\n-        status=\"created\"/>\r\n-    </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-2\">\r\n+    <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-2\">\r\n       <policyNetworkPort\r\n         appType=\"Other\"\r\n         dataType=\"string\"\r\n         descr=\"\"\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-2\"\r\n+        dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-2\"\r\n         id=\"2\"\r\n         name=\"\"\r\n         placement=\"begin\"\r\n         status=\"created\"\r\n         value=\"%deststartport%\"/>\r\n     </pair>\r\n-    <pair key=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-3\">\r\n+    <pair key=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-3\">\r\n       <policyNetworkPort\r\n         appType=\"Other\"\r\n         dataType=\"string\"\r\n         descr=\"\"\r\n-        dn=\"%aclruledn%/rule-cond-5/nw-expr2/nw-port-3\"\r\n+        dn=\"%aclruledn%/rule-cond-4/nw-expr2/nw-port-3\"\r\n         id=\"3\"\r\n         name=\"\"\r\n         placement=\"end\"\r\n@@ -197,5 +165,4 @@ under the License.\n     sourceendip=\"source end ip\"\r\n     deststartport=\"start port at destination\"\r\n     destendport=\"end port at destination\"\r\n-    destip=\"destination ip\"\r\n --!>\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/scripts/network/cisco/create-ingress-acl-rule.xml",
                "sha": "f283ffeb3339d084a7d1f1adfad1592e2f268210",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnection.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnection.java?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 5,
                "filename": "plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnection.java",
                "patch": "@@ -140,23 +140,23 @@ public boolean associateNatPolicySet(String tenantName)\n     public boolean createTenantVDCIngressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n             String protocol, String sourceStartIp, String sourceEndIp,\n-            String destStartPort, String destEndPort, String destIp)\n+            String destStartPort, String destEndPort)\n             throws ExecutionException;\n \n     public boolean createTenantVDCIngressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n-            String protocol, String sourceStartIp, String sourceEndIp, String destIp)\n+            String protocol, String sourceStartIp, String sourceEndIp)\n             throws ExecutionException;\n \n     public boolean createTenantVDCEgressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n-            String protocol, String sourceStartPort, String sourceEndPort, String sourceIp,\n-            String destStartIp, String destEndIp)\n+            String protocol, String destStartIp, String destEndIp,\n+            String destStartPort, String destEndPort)\n             throws ExecutionException;\n \n     public boolean createTenantVDCEgressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n-            String protocol, String sourceIp, String destStartIp, String destEndIp)\n+            String protocol, String destStartIp, String destEndIp)\n             throws ExecutionException;\n \n     public boolean deleteTenantVDCAclRule(String tenantName,",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnection.java",
                "sha": "fed6724418d463a917d1ebe978688aa73f0db5f1",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnectionImpl.java",
                "changes": 30,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnectionImpl.java?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 15,
                "filename": "plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnectionImpl.java",
                "patch": "@@ -95,6 +95,7 @@\n         CREATE_EGRESS_ACL_RULE(\"create-egress-acl-rule.xml\", \"policy-mgr\"),\n         CREATE_GENERIC_INGRESS_ACL_RULE(\"create-generic-ingress-acl-rule.xml\", \"policy-mgr\"),\n         CREATE_GENERIC_EGRESS_ACL_RULE(\"create-generic-egress-acl-rule.xml\", \"policy-mgr\"),\n+        CREATE_GENERIC_EGRESS_ACL_NO_PROTOCOL_RULE(\"create-generic-egress-acl-no-protocol-rule.xml\", \"policy-mgr\"),\n \n         DELETE_RULE(\"delete-rule.xml\", \"policy-mgr\"),\n \n@@ -660,8 +661,7 @@ public boolean associateAclPolicySet(String tenantName) throws ExecutionExceptio\n         xml = replaceXmlValue(xml, \"descr\", \"Edge Security Profile for Tenant VDC \" + tenantName);\n         xml = replaceXmlValue(xml, \"name\", getNameForEdgeDeviceSecurityProfile(tenantName));\n         xml = replaceXmlValue(xml, \"espdn\", getDnForTenantVDCEdgeSecurityProfile(tenantName));\n-        //xml = replaceXmlValue(xml, \"egresspolicysetname\", getNameForAclPolicySet(tenantName, false));\n-        xml = replaceXmlValue(xml, \"egresspolicysetname\", \"default-egress\");\n+        xml = replaceXmlValue(xml, \"egresspolicysetname\", getNameForAclPolicySet(tenantName, false));\n         xml = replaceXmlValue(xml, \"ingresspolicysetname\", getNameForAclPolicySet(tenantName, true));\n         xml = replaceXmlValue(xml, \"natpolicysetname\", getNameForNatPolicySet(tenantName));\n \n@@ -673,7 +673,7 @@ public boolean associateAclPolicySet(String tenantName) throws ExecutionExceptio\n     public boolean createTenantVDCIngressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n             String protocol, String sourceStartIp, String sourceEndIp,\n-            String destStartPort, String destEndPort, String destIp) throws ExecutionException {\n+            String destStartPort, String destEndPort) throws ExecutionException {\n         String xml = VnmcXml.CREATE_INGRESS_ACL_RULE.getXml();\n         String service = VnmcXml.CREATE_INGRESS_ACL_RULE.getService();\n \n@@ -687,7 +687,6 @@ public boolean createTenantVDCIngressAclRule(String tenantName,\n         xml = replaceXmlValue(xml, \"sourceendip\", sourceEndIp);\n         xml = replaceXmlValue(xml, \"deststartport\", destStartPort);\n         xml = replaceXmlValue(xml, \"destendport\", destEndPort);\n-        xml = replaceXmlValue(xml, \"destip\", destIp);\n \n         List<String> rules = listChildren(getDnForAclPolicy(tenantName, policyIdentifier));\n         int order = 100;\n@@ -703,8 +702,7 @@ public boolean createTenantVDCIngressAclRule(String tenantName,\n     @Override\n     public boolean createTenantVDCIngressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n-            String protocol, String sourceStartIp, String sourceEndIp,\n-            String destIp) throws ExecutionException {\n+            String protocol, String sourceStartIp, String sourceEndIp) throws ExecutionException {\n         String xml = VnmcXml.CREATE_GENERIC_INGRESS_ACL_RULE.getXml();\n         String service = VnmcXml.CREATE_GENERIC_INGRESS_ACL_RULE.getService();\n \n@@ -731,8 +729,8 @@ public boolean createTenantVDCIngressAclRule(String tenantName,\n     @Override\n     public boolean createTenantVDCEgressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n-            String protocol, String sourceStartPort, String sourceEndPort, String sourceIp,\n-            String destStartIp, String destEndIp) throws ExecutionException {\n+            String protocol, String destStartIp, String destEndIp,\n+            String destStartPort, String destEndPort) throws ExecutionException {\n         String xml = VnmcXml.CREATE_EGRESS_ACL_RULE.getXml();\n         String service = VnmcXml.CREATE_EGRESS_ACL_RULE.getService();\n \n@@ -744,9 +742,8 @@ public boolean createTenantVDCEgressAclRule(String tenantName,\n         xml = replaceXmlValue(xml, \"protocolvalue\", protocol);\n         xml = replaceXmlValue(xml, \"deststartip\", destStartIp);\n         xml = replaceXmlValue(xml, \"destendip\", destEndIp);\n-        xml = replaceXmlValue(xml, \"sourcestartport\", sourceStartPort);\n-        xml = replaceXmlValue(xml, \"sourceendport\", sourceEndPort);\n-        xml = replaceXmlValue(xml, \"sourceip\", sourceIp);\n+        xml = replaceXmlValue(xml, \"deststartport\", destStartPort);\n+        xml = replaceXmlValue(xml, \"destendport\", destEndPort);\n \n         List<String> rules = listChildren(getDnForAclPolicy(tenantName, policyIdentifier));\n         int order = 100;\n@@ -762,17 +759,20 @@ public boolean createTenantVDCEgressAclRule(String tenantName,\n     @Override\n     public boolean createTenantVDCEgressAclRule(String tenantName,\n             String identifier, String policyIdentifier,\n-            String protocol, String sourceIp,\n-            String destStartIp, String destEndIp) throws ExecutionException {\n+            String protocol, String destStartIp, String destEndIp) throws ExecutionException {\n         String xml = VnmcXml.CREATE_GENERIC_EGRESS_ACL_RULE.getXml();\n         String service = VnmcXml.CREATE_GENERIC_EGRESS_ACL_RULE.getService();\n-\n+        if (protocol.equalsIgnoreCase(\"all\")) { // any protocol\n+            xml = VnmcXml.CREATE_GENERIC_EGRESS_ACL_NO_PROTOCOL_RULE.getXml();\n+            service = VnmcXml.CREATE_GENERIC_EGRESS_ACL_NO_PROTOCOL_RULE.getService();\n+        } else { // specific protocol\n+            xml = replaceXmlValue(xml, \"protocolvalue\", protocol);\n+        }\n         xml = replaceXmlValue(xml, \"cookie\", _cookie);\n         xml = replaceXmlValue(xml, \"aclruledn\", getDnForAclRule(tenantName, identifier, policyIdentifier));\n         xml = replaceXmlValue(xml, \"aclrulename\", getNameForAclRule(tenantName, identifier));\n         xml = replaceXmlValue(xml, \"descr\", \"Egress ACL rule for Tenant VDC \" + tenantName);\n         xml = replaceXmlValue(xml, \"actiontype\", \"permit\");\n-        xml = replaceXmlValue(xml, \"protocolvalue\", protocol);\n         xml = replaceXmlValue(xml, \"deststartip\", destStartIp);\n         xml = replaceXmlValue(xml, \"destendip\", destEndIp);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/cisco/CiscoVnmcConnectionImpl.java",
                "sha": "c7380ab11d8f0af1824f5f587bc8cb2bc45bdc2f",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/element/CiscoVnmcElement.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/src/com/cloud/network/element/CiscoVnmcElement.java?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 2,
                "filename": "plugins/network-elements/cisco-vnmc/src/com/cloud/network/element/CiscoVnmcElement.java",
                "patch": "@@ -105,6 +105,7 @@\n import com.cloud.network.dao.PhysicalNetworkServiceProviderVO;\n import com.cloud.network.resource.CiscoVnmcResource;\n import com.cloud.network.rules.FirewallRule;\n+import com.cloud.network.rules.FirewallRule.TrafficType;\n import com.cloud.network.rules.PortForwardingRule;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.offering.NetworkOffering;\n@@ -677,8 +678,12 @@ public boolean applyFWRules(Network network,\n \n         List<FirewallRuleTO> rulesTO = new ArrayList<FirewallRuleTO>();\n         for (FirewallRule rule : rules) {\n-            IpAddress sourceIp = _networkModel.getIp(rule.getSourceIpAddressId());\n-            FirewallRuleTO ruleTO = new FirewallRuleTO(rule, null, sourceIp.getAddress().addr(), rule.getPurpose(), rule.getTrafficType());\n+            String address = \"0.0.0.0\";\n+            if (rule.getTrafficType() == TrafficType.Ingress) {\n+                IpAddress sourceIp = _networkModel.getIp(rule.getSourceIpAddressId());\n+                address = sourceIp.getAddress().addr();\n+            }\n+            FirewallRuleTO ruleTO = new FirewallRuleTO(rule, null, address, rule.getPurpose(), rule.getTrafficType());\n             rulesTO.add(ruleTO);\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/element/CiscoVnmcElement.java",
                "sha": "b335edb9f631bcd5930d2ed94019f85c09d430d2",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/resource/CiscoVnmcResource.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/src/com/cloud/network/resource/CiscoVnmcResource.java?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 6,
                "filename": "plugins/network-elements/cisco-vnmc/src/com/cloud/network/resource/CiscoVnmcResource.java",
                "patch": "@@ -368,29 +368,29 @@ private Answer execute(SetFirewallRulesCommand cmd, int numRetries) {\n                                 if (!_connection.createTenantVDCIngressAclRule(tenant,\n                                         Long.toString(rule.getId()), policyIdentifier,\n                                         rule.getProtocol().toUpperCase(), externalIpRange[0], externalIpRange[1],\n-                                        Integer.toString(rule.getSrcPortRange()[0]), Integer.toString(rule.getSrcPortRange()[1]), publicIp)) {\n+                                        Integer.toString(rule.getSrcPortRange()[0]), Integer.toString(rule.getSrcPortRange()[1]))) {\n                                     throw new Exception(\"Failed to create ACL ingress rule in VNMC for guest network with vlan \" + vlanId);\n                                 }\n                             } else {\n                                 if (!_connection.createTenantVDCIngressAclRule(tenant,\n                                         Long.toString(rule.getId()), policyIdentifier,\n-                                        rule.getProtocol().toUpperCase(), externalIpRange[0], externalIpRange[1], publicIp)) {\n+                                        rule.getProtocol().toUpperCase(), externalIpRange[0], externalIpRange[1])) {\n                                     throw new Exception(\"Failed to create ACL ingress rule in VNMC for guest network with vlan \" + vlanId);\n                                 }\n                             }\n                         } else {\n-                            if (!rule.getProtocol().equalsIgnoreCase(\"icmp\")) {\n+                            if (rule.getProtocol().equalsIgnoreCase(\"tcp\") || rule.getProtocol().equalsIgnoreCase(\"udp\")) {\n                                 if (!_connection.createTenantVDCEgressAclRule(tenant,\n                                         Long.toString(rule.getId()), policyIdentifier,\n                                         rule.getProtocol().toUpperCase(),\n-                                        Integer.toString(rule.getSrcPortRange()[0]), Integer.toString(rule.getSrcPortRange()[1]), publicIp,\n-                                        externalIpRange[0], externalIpRange[1])) {\n+                                        externalIpRange[0], externalIpRange[1],\n+                                        Integer.toString(rule.getSrcPortRange()[0]), Integer.toString(rule.getSrcPortRange()[1]))) {\n                                     throw new Exception(\"Failed to create ACL egress rule in VNMC for guest network with vlan \" + vlanId);\n                                 }\n                             } else {\n                                 if (!_connection.createTenantVDCEgressAclRule(tenant,\n                                         Long.toString(rule.getId()), policyIdentifier,\n-                                        rule.getProtocol().toUpperCase(), publicIp, externalIpRange[0], externalIpRange[1])) {\n+                                        rule.getProtocol().toUpperCase(), externalIpRange[0], externalIpRange[1])) {\n                                     throw new Exception(\"Failed to create ACL egress rule in VNMC for guest network with vlan \" + vlanId);\n                                 }\n                             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/src/com/cloud/network/resource/CiscoVnmcResource.java",
                "sha": "906e0ae6e856cff717430a0ac18e5cdc7c0d8c4b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/test/com/cloud/network/resource/CiscoVnmcResourceTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/cisco-vnmc/test/com/cloud/network/resource/CiscoVnmcResourceTest.java?ref=530b0beb3c8b172fbfaf89584cd24785b7513998",
                "deletions": 2,
                "filename": "plugins/network-elements/cisco-vnmc/test/com/cloud/network/resource/CiscoVnmcResourceTest.java",
                "patch": "@@ -171,11 +171,11 @@ public void testFirewall() throws ConfigurationException, Exception {\n         when(_connection.createTenantVDCIngressAclRule(\n                 anyString(), anyString(), anyString(),\n                 anyString(), anyString(), anyString(),\n-                anyString(), anyString(), anyString())).thenReturn(true);\n+                anyString(), anyString())).thenReturn(true);\n         when(_connection.createTenantVDCEgressAclRule(\n                 anyString(), anyString(), anyString(),\n                 anyString(), anyString(), anyString(),\n-                anyString(), anyString(), anyString())).thenReturn(true);\n+                anyString(), anyString())).thenReturn(true);\n         when(_connection.associateAclPolicySet(anyString())).thenReturn(true);\n \n         Answer answer = _resource.executeRequest(cmd);",
                "raw_url": "https://github.com/apache/cloudstack/raw/530b0beb3c8b172fbfaf89584cd24785b7513998/plugins/network-elements/cisco-vnmc/test/com/cloud/network/resource/CiscoVnmcResourceTest.java",
                "sha": "acfc5ebaaa7de26cd90920bb29c8d095c2a634d5",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-2417: NPE while creating Egress rules with Networking using Cisco ASA firewall provider\n\nAn input parameter was incorrectly interpreted during egress rule creation and so resulted in NPE. Created a new vnmc xml for handling creation of egress rule with protocol as 'All'",
        "parent": "https://github.com/apache/cloudstack/commit/b4aff6190f741cffa0bd945cfa9d7d7b11ada47b",
        "repo": "cloudstack",
        "unit_tests": [
            "CiscoVnmcConnectionTest.java",
            "CiscoVnmcElementTest.java",
            "CiscoVnmcResourceTest.java"
        ]
    },
    "cloudstack_53473c0": {
        "bug_id": "cloudstack_53473c0",
        "commit": "https://github.com/apache/cloudstack/commit/53473c07b904dc97630d635dfac9d94c3c5c4f17",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/exception/CloudRuntimeException.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/exception/CloudRuntimeException.java?ref=53473c07b904dc97630d635dfac9d94c3c5c4f17",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/exception/CloudRuntimeException.java",
                "patch": "@@ -16,6 +16,8 @@\n // under the License.\n package com.cloud.utils.exception;\n \n+import java.io.FileNotFoundException;\n+\n import com.cloud.utils.SerialVersionUID;\n \n /**\n@@ -36,4 +38,8 @@ public CloudRuntimeException(String message, Throwable th) {\n     protected CloudRuntimeException() {\n         super();\n     }\n+\n+    public CloudRuntimeException(Throwable t) {\n+        super(t);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/exception/CloudRuntimeException.java",
                "sha": "dabb715086fd755cf40b64959815fbf6bf155528",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/exception/RuntimeCloudException.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/exception/RuntimeCloudException.java?ref=53473c07b904dc97630d635dfac9d94c3c5c4f17",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/exception/RuntimeCloudException.java",
                "patch": "@@ -64,6 +64,10 @@ public RuntimeCloudException() {\n         setCSErrorCode(CSExceptionErrorCode.getCSErrCode(this.getClass().getName()));\n     }\n \n+    public RuntimeCloudException(Throwable t) {\n+        super(t);\n+    }\n+\n     public ArrayList<String> getIdProxyList() {\n         return idList;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/exception/RuntimeCloudException.java",
                "sha": "422d66cfb17338dee41d6ca74b4cce08e6a3510a",
                "status": "modified"
            },
            {
                "additions": 117,
                "blob_url": "https://github.com/apache/cloudstack/blob/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/xmlobject/XmlObject.java",
                "changes": 117,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/xmlobject/XmlObject.java?ref=53473c07b904dc97630d635dfac9d94c3c5c4f17",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/xmlobject/XmlObject.java",
                "patch": "@@ -0,0 +1,117 @@\n+package com.cloud.utils.xmlobject;\r\n+\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.InputStream;\r\n+import java.util.ArrayList;\r\n+import java.util.HashMap;\r\n+import java.util.Iterator;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+\r\n+import javax.xml.parsers.ParserConfigurationException;\r\n+import javax.xml.parsers.SAXParser;\r\n+import javax.xml.parsers.SAXParserFactory;\r\n+\r\n+import org.xml.sax.SAXException;\r\n+\r\n+import com.cloud.utils.exception.CloudRuntimeException;\r\n+\r\n+import edu.emory.mathcs.backport.java.util.Collections;\r\n+\r\n+public class XmlObject {\r\n+    private Map<String, Object> elements = new HashMap<String, Object>();\r\n+    private String text;\r\n+    private String tag;\r\n+    \r\n+    XmlObject() {\r\n+    }\r\n+    \r\n+    XmlObject putElement(String key, Object e) {\r\n+        Object old = elements.get(key);\r\n+        if (old == null) {\r\n+            System.out.println(String.format(\"no %s, add new\", key));\r\n+            elements.put(key, e);\r\n+        } else {\r\n+            if (old instanceof List) {\r\n+                System.out.println(String.format(\"already list %s, add\", key));\r\n+                ((List)old).add(e);\r\n+            } else {\r\n+                System.out.println(String.format(\"not list list %s, add list\", key));\r\n+                List lst = new ArrayList();\r\n+                lst.add(old);\r\n+                lst.add(e);\r\n+                elements.put(key, lst);\r\n+            }\r\n+        }\r\n+        \r\n+        return this;\r\n+    }\r\n+    \r\n+    private Object recurGet(XmlObject obj, Iterator<String> it) {\r\n+        String key = it.next();\r\n+        Object e = obj.elements.get(key);\r\n+        if (!it.hasNext()) {\r\n+            return e;\r\n+        } else {\r\n+            if (!(e instanceof XmlObject)) {\r\n+                throw new CloudRuntimeException(String.format(\"%s doesn't reference to a XmlObject\", it.next()));\r\n+            }\r\n+            return recurGet((XmlObject) e, it);\r\n+        }\r\n+    }\r\n+    \r\n+    public <T> T get(String elementStr) {\r\n+        String[] strs = elementStr.split(\"\\\\.\");\r\n+        List<String> lst = new ArrayList<String>(strs.length);\r\n+        Collections.addAll(lst, strs);\r\n+        return (T)recurGet(this, lst.iterator());\r\n+    }\r\n+    \r\n+    public <T> List<T> getAsList(String elementStr) {\r\n+        Object e = get(elementStr);\r\n+        if (e instanceof List) {\r\n+            return (List<T>)e;\r\n+        }\r\n+        List lst = new ArrayList(1);\r\n+        lst.add(e);\r\n+        return lst;\r\n+    }\r\n+    \r\n+    public String getText() {\r\n+        return text;\r\n+    }\r\n+\r\n+    void setText(String text) {\r\n+        this.text = text;\r\n+    }\r\n+\r\n+    public String getTag() {\r\n+        return tag;\r\n+    }\r\n+\r\n+    void setTag(String tag) {\r\n+        this.tag = tag;\r\n+    }\r\n+    \r\n+    @Override\r\n+    public String toString() {\r\n+        StringBuilder sb = new StringBuilder(\"<\" + tag);\r\n+        for (Map.Entry<String, Object> e : elements.entrySet()) {\r\n+            String key = e.getKey();\r\n+            Object value = e.getValue();\r\n+            if (!(value instanceof String)) {\r\n+                continue;\r\n+            }\r\n+            sb.append(String.format(\" %s=\\\"%s\\\"\", key, value.toString()));\r\n+        }\r\n+        \r\n+        if (text == null || \"\".equals(text.trim())) {\r\n+            sb.append(\" />\");\r\n+        } else {\r\n+            sb.append(\">\").append(text).append(String.format(\"</ %s>\", tag));\r\n+        }\r\n+        return sb.toString();\r\n+    }\r\n+}\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/xmlobject/XmlObject.java",
                "sha": "4ebf3718113e4d0efa860de56a4fe00ab3b823d6",
                "status": "added"
            },
            {
                "additions": 107,
                "blob_url": "https://github.com/apache/cloudstack/blob/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/xmlobject/XmlObjectParser.java",
                "changes": 107,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/xmlobject/XmlObjectParser.java?ref=53473c07b904dc97630d635dfac9d94c3c5c4f17",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/xmlobject/XmlObjectParser.java",
                "patch": "@@ -0,0 +1,107 @@\n+package com.cloud.utils.xmlobject;\r\n+\r\n+import java.io.ByteArrayInputStream;\r\n+import java.io.File;\r\n+import java.io.FileInputStream;\r\n+import java.io.FileNotFoundException;\r\n+import java.io.InputStream;\r\n+import java.util.Stack;\r\n+\r\n+import javax.xml.parsers.SAXParser;\r\n+import javax.xml.parsers.SAXParserFactory;\r\n+\r\n+import org.xml.sax.Attributes;\r\n+import org.xml.sax.SAXException;\r\n+import org.xml.sax.helpers.DefaultHandler;\r\n+\r\n+import com.cloud.utils.exception.CloudRuntimeException;\r\n+\r\n+public class XmlObjectParser {\r\n+    final private InputStream is;\r\n+\r\n+    private class XmlHandler extends DefaultHandler {\r\n+        private Stack<XmlObject> stack;\r\n+        private String currentValue;\r\n+        private XmlObject root;\r\n+\r\n+        XmlHandler() {\r\n+            stack = new Stack<XmlObject>();\r\n+        }\r\n+\r\n+        @Override\r\n+        public void startElement(String namespaceURI, String localName, String qName, Attributes atts) throws SAXException {\r\n+            //System.out.println(String.format(\"startElement: namespaceURI:%s, localName:%s, qName:%s\", namespaceURI, localName, qName));\r\n+            currentValue = null;\r\n+            XmlObject obj = new XmlObject();\r\n+            for (int i=0; i<atts.getLength(); i++) {\r\n+                obj.putElement(atts.getQName(i), atts.getValue(i));\r\n+            }\r\n+            obj.setTag(qName);\r\n+            if (!stack.isEmpty()) {\r\n+                XmlObject parent = stack.peek();\r\n+                parent.putElement(qName, obj);\r\n+            }\r\n+            stack.push(obj);\r\n+        }\r\n+\r\n+        @Override\r\n+        public void endElement(String namespaceURI, String localName, String qName) throws SAXException {\r\n+            XmlObject currObj = stack.pop();\r\n+            if (currentValue != null) {\r\n+                currObj.setText(currentValue);\r\n+            }\r\n+            \r\n+            if (stack.isEmpty()) {\r\n+                root = currObj;\r\n+            }\r\n+            \r\n+            //System.out.println(String.format(\"endElement: namespaceURI:%s, localName:%s, qName:%s\", namespaceURI, localName, qName));\r\n+        }\r\n+        \r\n+        @Override\r\n+        public void characters(char[] ch, int start, int length) throws SAXException {\r\n+            StringBuilder str = new StringBuilder();\r\n+            str.append(ch, start, length);\r\n+            currentValue = str.toString();\r\n+            //System.out.println(String.format(\"characters: %s\", str.toString()));\r\n+        }\r\n+        \r\n+        XmlObject getRoot() {\r\n+            return root;\r\n+        }\r\n+    }\r\n+\r\n+    private XmlObjectParser(InputStream is) {\r\n+        super();\r\n+        this.is = is;\r\n+    }\r\n+\r\n+    public static XmlObject parseFromFile(String filePath) {\r\n+        FileInputStream fs;\r\n+        try {\r\n+            fs = new FileInputStream(new File(filePath));\r\n+            XmlObjectParser p = new XmlObjectParser(fs);\r\n+            return p.parse();\r\n+        } catch (FileNotFoundException e) {\r\n+            throw new CloudRuntimeException(e);\r\n+        }\r\n+    }\r\n+    \r\n+    public static XmlObject parseFromString(String xmlString) {\r\n+        InputStream stream = new ByteArrayInputStream(xmlString.getBytes());\r\n+        XmlObjectParser p = new XmlObjectParser(stream);\r\n+        return p.parse();\r\n+    }\r\n+\r\n+    private XmlObject parse() {\r\n+        SAXParserFactory spfactory = SAXParserFactory.newInstance();\r\n+        try {\r\n+            SAXParser saxParser = spfactory.newSAXParser();\r\n+            XmlHandler handler = new XmlHandler();\r\n+            saxParser.parse(is, handler);\r\n+            return handler.getRoot();\r\n+        } catch (Exception e) {\r\n+            throw new CloudRuntimeException(e);\r\n+        }\r\n+    }\r\n+}\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/src/com/cloud/utils/xmlobject/XmlObjectParser.java",
                "sha": "68a822f542940a1d3915e9efd7775bb5efa6a8c7",
                "status": "added"
            },
            {
                "additions": 29,
                "blob_url": "https://github.com/apache/cloudstack/blob/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/test/com/cloud/utils/xmlobject/TestXmlObject.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/test/com/cloud/utils/xmlobject/TestXmlObject.java?ref=53473c07b904dc97630d635dfac9d94c3c5c4f17",
                "deletions": 0,
                "filename": "utils/test/com/cloud/utils/xmlobject/TestXmlObject.java",
                "patch": "@@ -0,0 +1,29 @@\n+package com.cloud.utils.xmlobject;\r\n+\r\n+import static org.junit.Assert.*;\r\n+\r\n+import java.util.List;\r\n+\r\n+import org.junit.Test;\r\n+\r\n+public class TestXmlObject {\r\n+\r\n+    void p(String str) {\r\n+        System.out.println(str);\r\n+    }\r\n+    \r\n+    @Test\r\n+    public void test() {\r\n+        XmlObject xo = XmlObjectParser.parseFromFile(\"z:/components.xml.in\");\r\n+        p(xo.getTag());\r\n+        p((String) xo.get(\"system-integrity-checker.checker\").toString());\r\n+        List<XmlObject> lst = xo.get(\"management-server.adapters\");\r\n+        for (XmlObject x : lst) {\r\n+            List<XmlObject> lst1 = x.getAsList(\"adapter\");\r\n+            for (XmlObject y : lst1) {\r\n+                p(y.toString());\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+}\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/53473c07b904dc97630d635dfac9d94c3c5c4f17/utils/test/com/cloud/utils/xmlobject/TestXmlObject.java",
                "sha": "f94c68c46310dcd69cda5e7209efa7ca44b36b1a",
                "status": "added"
            }
        ],
        "message": "CloudStack CLOUDSTACK-723\nEnhanced baremetal servers support on Cisco UCS\n\nintroduce an python etree like xml helper.\nOk, this is not a new wheel. Frankly speaking, all Java XML API just suc**.\nthere are two popular types of XML API in java, one class is for data binding, JAXB,\nXStream fall into this category. Another class is tree based, like JDOM, XOM ...\n\nfor XML api call, data binding library is painful as you have to specify the schema\nthat how xml stream converts to java object, which means you have to pre-define all\nschemas(xsd file for JAXB, java object for XStream ...). This is not productive, because you\nmust add new schema when XML document grows.\n\nTree based library shines in this case, for it's able to dynamically create an object tree\nfrom xml stream without any knowledge of its structure. However, all tree based\nXML API library fall into below convention:\n\nElement e = root.getChildElement(\"child1\").getChildElement(\"child2\").getChildElement(\"child3\")...getChildElement(\"childN\")\n\nanything wrong with it???\n\nthe sadness is if there is no \"child2\", you will get a NPE with above code, which means you have to judge\nbefore getting.\n\nAnd, why so verbose?? why not:\n\nElement e = root.child1.child2.child3...childN ???\n\nOk I am joking, it's impossible in Java the world knows Java is a static language.\n\nbut you can actually do:\n\nElement e = root.get(\"child1.child2.child3\");\n\nor\n\nList<Element> e = root.getAsList(\"child1.child2.child3\")\n\nthis is known as XPath style(though XPATH use '/'), python etree has supported it.\n\nso I did this toy for my UCS xml api call, it's quite like etree which is easy to use, for example:\n\n<components.xml>\n    <system-integrity-checker class=\"com.cloud.upgrade.DatabaseUpgradeChecker\">\n        <checker name=\"ManagementServerNode\" class=\"com.cloud.cluster.ManagementServerNode\"/>\n        <checker name=\"EncryptionSecretKeyChecker\" class=\"com.cloud.utils.crypt.EncryptionSecretKeyChecker\"/>\n        <checker name=\"DatabaseIntegrityChecker\" class=\"com.cloud.upgrade.DatabaseIntegrityChecker\"/>\n        <checker name=\"DatabaseUpgradeChecker\" class=\"com.cloud.upgrade.PremiumDatabaseUpgradeChecker\"/>\n    </system-integrity-checker>\n</components.xml>\n\nXmlObject xo = XmlObjectParser.parseFromFile(\"~/components.xml.in\");\nList<XmlObject> checkers = xo.getAsList(\"system-integrity-checker.checker\");\n\nthen you get a list of XmlObject which represent each 'checker' element:\n\nXmlObject firstChecker = checkers.get(0);\n// firstChecker.get(\"name\") == \"ManagementServerNode\"\n// firstChecker.get(\"class\") == \"com.cloud.cluster.ManagementServerNode\"\n// firstChecker.getTag() == \"checker\"\n// firstChecker.getText() == \"\" if it's <checker/>xxx</checker>, then getText() == \"xxx\"\n\nexample 2:\n<checker name=\"ManagementServerNode\" class=\"com.cloud.cluster.ManagementServerNode\"/>\n    <system-integrity-checker class=\"com.cloud.upgrade.DatabaseUpgradeChecker\">\n        <checker name=\"ManagementServerNode\" class=\"com.cloud.cluster.ManagementServerNode\"/>\n    </system-integrity-checker>\n</components.xml>\n\nyout can do:\n\nXmlObject xo = XmlObjectParser.parseFromFile(\"~/components.xml.in\");\nXmlObject checker = xo.get(\"system-integrity-checker.checker\");\n\nthen it returns a single object as we only have one \"checker\" in xml stream,\n\nor you still do\n\nList<XmlObject> checkers = xo.getAsList(\"system-integrity-checker.checker\");\n\nit returns a list which only contains one element of \"checker\"\n\nif you do:\n\nXmlObject checker = xo.get(\"system-integrity-checker.checker.this_middle_element_doesnt_exist.some_element\");\n\nit returns a null without any exception, so you don't have to worry if a parent element is missing when getting a leaf element\n\nagain it's not a new wheel, I just hate JAVA xml api",
        "parent": "https://github.com/apache/cloudstack/commit/339c09bdefd43293dd61d1ff118909809604a582",
        "repo": "cloudstack",
        "unit_tests": [
            "TestXmlObject.java"
        ]
    },
    "cloudstack_53ca0b1": {
        "bug_id": "cloudstack_53ca0b1",
        "commit": "https://github.com/apache/cloudstack/commit/53ca0b1861c743caf61ec04f776c87eac334f185",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/53ca0b1861c743caf61ec04f776c87eac334f185/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java?ref=53ca0b1861c743caf61ec04f776c87eac334f185",
                "deletions": 1,
                "filename": "engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "patch": "@@ -190,7 +190,9 @@ public void processEvent(ObjectInDataStoreStateMachine.Event event, Answer answe\n                     TemplateObjectTO newTemplate = (TemplateObjectTO)cpyAnswer.getNewData();\n                     VMTemplateStoragePoolVO templatePoolRef = templatePoolDao.findByPoolTemplate(getDataStore().getId(), getId());\n                     templatePoolRef.setDownloadPercent(100);\n-                    templatePoolRef.setTemplateSize(newTemplate.getSize());\n+                    if (newTemplate.getSize() != null) {\n+                        templatePoolRef.setTemplateSize(newTemplate.getSize());\n+                    }\n                     templatePoolRef.setDownloadState(Status.DOWNLOADED);\n                     templatePoolRef.setLocalDownloadPath(newTemplate.getPath());\n                     templatePoolRef.setInstallPath(newTemplate.getPath());",
                "raw_url": "https://github.com/apache/cloudstack/raw/53ca0b1861c743caf61ec04f776c87eac334f185/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "sha": "fa2c80b0ed9388e542c05f9c66765b45878f7bcf",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/53ca0b1861c743caf61ec04f776c87eac334f185/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java?ref=53ca0b1861c743caf61ec04f776c87eac334f185",
                "deletions": 1,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java",
                "patch": "@@ -843,7 +843,9 @@ public Answer copyTemplateToPrimaryStorage(CopyCommand cmd) {\n \n                 newVol.setUuid(uuidToReturn);\n                 newVol.setPath(uuidToReturn);\n-                newVol.setSize(physicalSize);\n+                if (physicalSize != null) {\n+                    newVol.setSize(physicalSize);\n+                }\n                 newVol.setFormat(ImageFormat.VHD);\n \n                 return new CopyCmdAnswer(newVol);",
                "raw_url": "https://github.com/apache/cloudstack/raw/53ca0b1861c743caf61ec04f776c87eac334f185/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java",
                "sha": "c3c36d0a4888ff290bc100252f6c21d17448483e",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/53ca0b1861c743caf61ec04f776c87eac334f185/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java?ref=53ca0b1861c743caf61ec04f776c87eac334f185",
                "deletions": 1,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java",
                "patch": "@@ -263,7 +263,9 @@ public Answer copyTemplateToPrimaryStorage(CopyCommand cmd) {\n \n                 newVol.setUuid(uuidToReturn);\n                 newVol.setPath(uuidToReturn);\n-                newVol.setSize(physicalSize);\n+                if (physicalSize != null) {\n+                    newVol.setSize(physicalSize);\n+                }\n                 newVol.setFormat(Storage.ImageFormat.VHD);\n \n                 return new CopyCmdAnswer(newVol);",
                "raw_url": "https://github.com/apache/cloudstack/raw/53ca0b1861c743caf61ec04f776c87eac334f185/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java",
                "sha": "6e000efe559d6f6b36b7f7286e7535bb49cfc21d",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8312: Fix NPE regression, copy template can have NULL volume size\n\nThe copy command reply can have null size returned, so check and set values\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/d70937aeb92e89efa8fcc39d7f89bdd8c885b2a2",
        "repo": "cloudstack",
        "unit_tests": [
            "XenServerStorageProcessorTest.java",
            "Xenserver625StorageProcessorTest.java"
        ]
    },
    "cloudstack_542230f": {
        "bug_id": "cloudstack_542230f",
        "commit": "https://github.com/apache/cloudstack/commit/542230fc2621ed3951a6af74bdc586606b902790",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/542230fc2621ed3951a6af74bdc586606b902790/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=542230fc2621ed3951a6af74bdc586606b902790",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -308,7 +308,7 @@ public VolumeVO allocateSystemVm(VMInstanceVO vm, VMTemplateVO template, DiskOff\n             {\n             \tStoragePoolVO sp = _storagePoolDao.findById(vol.getPoolId());\n             \t\n-            \tif(sp.getStatus().equals(Status.PrepareForMaintenance))\n+            \tif(sp!=null && sp.getStatus().equals(Status.PrepareForMaintenance))\n             \t{\n             \t\trecreateVols.add(vol);\n             \t\tcontinue;",
                "raw_url": "https://github.com/apache/cloudstack/raw/542230fc2621ed3951a6af74bdc586606b902790/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "4f8176eada9eaae18cb0334ea3731539e06e9c21",
                "status": "modified"
            }
        ],
        "message": "null check for the npe",
        "parent": "https://github.com/apache/cloudstack/commit/f82e73b861b4d0f32994b6a588d262c5a4c477f2",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_5481485": {
        "bug_id": "cloudstack_5481485",
        "commit": "https://github.com/apache/cloudstack/commit/5481485a083957ff58da3b6fea9d7b6d20f06875",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java",
                "patch": "@@ -184,6 +184,14 @@ public String getParentName() {\n         return parentName;\n     }\n \n+    public String getParent() {\n+        return parent;\n+    }\n+\n+    public void setParent(String parent) {\n+        this.parent = parent;\n+    }\n+\n     public String getType() {\n         return type;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/api/src/org/apache/cloudstack/api/response/VMSnapshotResponse.java",
                "sha": "4d430a5d64474a7da220bb89f359ba403923896f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java",
                "patch": "@@ -36,4 +36,6 @@\n     List<VMSnapshotVO> listByParent(Long vmSnapshotId);\n \n     VMSnapshotVO findByName(Long vmId, String name);\n+\n+    List<VMSnapshotVO> listByAccountId(Long accountId);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDao.java",
                "sha": "31999ef15d66e3dcc6e5a18fddfd0a20fb81e0ec",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java",
                "patch": "@@ -121,6 +121,12 @@ public VMSnapshotVO findByName(Long vmId, String name) {\n         return null;\n     }\n \n+    public List<VMSnapshotVO> listByAccountId(Long accountId) {\n+        SearchCriteria sc = this.AllFieldsSearch.create();\n+        sc.setParameters(\"accountId\", new Object[] { accountId });\n+        return listBy(sc, null);\n+    }\n+\n     @Override\n     public boolean updateState(State currentState, Event event, State nextState, VMSnapshot vo, Object data) {\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/engine/schema/src/com/cloud/vm/snapshot/dao/VMSnapshotDaoImpl.java",
                "sha": "a87d284dc12161d367481e56f739cfe70b203665",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 3,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -452,6 +452,10 @@ public SnapshotResponse createSnapshotResponse(Snapshot snapshot) {\n             snapshotResponse.setVolumeId(volume.getUuid());\n             snapshotResponse.setVolumeName(volume.getName());\n             snapshotResponse.setVolumeType(volume.getVolumeType().name());\n+            DataCenter zone = ApiDBUtils.findZoneById(volume.getDeviceId());\n+            if (zone != null) {\n+                snapshotResponse.setZoneId(zone.getUuid());\n+            }\n         }\n         snapshotResponse.setCreated(snapshot.getCreated());\n         snapshotResponse.setName(snapshot.getName());\n@@ -502,6 +506,7 @@ public VMSnapshotResponse createVMSnapshotResponse(VMSnapshot vmSnapshot) {\n         if (vmSnapshot.getParent() != null) {\n             VMSnapshot vmSnapshotParent = ApiDBUtils.getVMSnapshotById(vmSnapshot.getParent());\n             if (vmSnapshotParent != null) {\n+                vmSnapshotResponse.setParent(vmSnapshotParent.getUuid());\n                 vmSnapshotResponse.setParentName(vmSnapshotParent.getDisplayName());\n             }\n         }\n@@ -3096,9 +3101,11 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n                 }\n             }\n             //Network ID\n-            NetworkVO network = _entityMgr.findByIdIncludingRemoved(NetworkVO.class, usageRecord.getNetworkId().toString());\n-            if (network != null) {\n-                usageRecResponse.setNetworkId(network.getUuid());\n+            if (usageRecord.getNetworkId() != null && usageRecord.getNetworkId() != 0L) {\n+                NetworkVO network = _entityMgr.findByIdIncludingRemoved(NetworkVO.class, usageRecord.getNetworkId().toString());\n+                if (network != null) {\n+                    usageRecResponse.setNetworkId(network.getUuid());\n+                }\n             }\n \n         } else if (usageRecord.getUsageType() == UsageTypes.VM_DISK_IO_READ || usageRecord.getUsageType() == UsageTypes.VM_DISK_IO_WRITE",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "c943f6f223a117376cf7beb2e0b51a33ff924f66",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 0,
                "filename": "server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java",
                "patch": "@@ -63,6 +63,7 @@ protected HighAvailabilityDaoImpl() {\n         TBASearch.and(\"server\", TBASearch.entity().getServerId(), Op.NULL);\n         TBASearch.and(\"taken\", TBASearch.entity().getDateTaken(), Op.NULL);\n         TBASearch.and(\"time\", TBASearch.entity().getTimeToTry(), Op.LTEQ);\n+        TBASearch.and(\"step\", TBASearch.entity().getStep(), Op.NIN);\n         TBASearch.done();\n \n         PreviousInstanceSearch = createSearchBuilder();\n@@ -151,6 +152,7 @@ public HaWorkVO take(final long serverId) {\n         try {\n             final SearchCriteria<HaWorkVO> sc = TBASearch.create();\n             sc.setParameters(\"time\", System.currentTimeMillis() >> 10);\n+            sc.setParameters(\"step\", Step.Done, Step.Cancelled);\n \n             final Filter filter = new Filter(HaWorkVO.class, null, true, 0l, 1l);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/ha/dao/HighAvailabilityDaoImpl.java",
                "sha": "724f4f6d7c9ee6fc32c42aa0ec5feed77ba71bde",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/hypervisor/HypervisorGuruBase.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/HypervisorGuruBase.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 2,
                "filename": "server/src/com/cloud/hypervisor/HypervisorGuruBase.java",
                "patch": "@@ -35,6 +35,7 @@\n import com.cloud.resource.ResourceManager;\n import com.cloud.server.ConfigurationServer;\n import com.cloud.service.ServiceOfferingDetailsVO;\n+import com.cloud.service.dao.ServiceOfferingDao;\n import com.cloud.service.dao.ServiceOfferingDetailsDao;\n import com.cloud.storage.dao.VMTemplateDetailsDao;\n import com.cloud.utils.Pair;\n@@ -71,6 +72,8 @@\n     ResourceManager _resourceMgr;\n     @Inject\n     ServiceOfferingDetailsDao _serviceOfferingDetailsDao;\n+    @Inject\n+    ServiceOfferingDao _serviceOfferingDao;\n \n     protected HypervisorGuruBase() {\n         super();\n@@ -125,8 +128,7 @@ public NicTO toNicTO(NicProfile profile) {\n     }\n \n     protected VirtualMachineTO toVirtualMachineTO(VirtualMachineProfile vmProfile) {\n-\n-        ServiceOffering offering = vmProfile.getServiceOffering();\n+        ServiceOffering offering = _serviceOfferingDao.findById(vmProfile.getId(), vmProfile.getServiceOfferingId());\n         VirtualMachine vm = vmProfile.getVirtualMachine();\n         Long minMemory = (long)(offering.getRamSize() / vmProfile.getMemoryOvercommitRatio());\n         int minspeed = (int)(offering.getSpeed() / vmProfile.getCpuOvercommitRatio());",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/hypervisor/HypervisorGuruBase.java",
                "sha": "0188778e7641a45080e3bfe73ad79cd651a76377",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/hypervisor/KVMGuru.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/KVMGuru.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 7,
                "filename": "server/src/com/cloud/hypervisor/KVMGuru.java",
                "patch": "@@ -16,24 +16,25 @@\n // under the License.\n package com.cloud.hypervisor;\n \n-import java.util.Map;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-\n-import org.apache.cloudstack.storage.command.StorageSubSystemCommand;\n-\n import com.cloud.agent.api.Command;\n+import com.cloud.agent.api.to.DataObjectType;\n import com.cloud.agent.api.to.VirtualMachineTO;\n import com.cloud.host.HostVO;\n import com.cloud.host.dao.HostDao;\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.storage.DataStoreRole;\n import com.cloud.storage.GuestOSHypervisorVO;\n import com.cloud.storage.GuestOSVO;\n import com.cloud.storage.dao.GuestOSDao;\n import com.cloud.storage.dao.GuestOSHypervisorDao;\n import com.cloud.utils.Pair;\n import com.cloud.vm.VirtualMachineProfile;\n+import org.apache.cloudstack.storage.command.CopyCommand;\n+import org.apache.cloudstack.storage.command.StorageSubSystemCommand;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import java.util.Map;\n \n @Local(value = HypervisorGuru.class)\n public class KVMGuru extends HypervisorGuruBase implements HypervisorGuru {\n@@ -77,6 +78,18 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n \n     @Override\n     public Pair<Boolean, Long> getCommandHostDelegation(long hostId, Command cmd) {\n+        if (cmd instanceof CopyCommand) {\n+            CopyCommand c = (CopyCommand) cmd;\n+            boolean inSeq = true;\n+            if (c.getSrcTO().getObjectType() == DataObjectType.SNAPSHOT ||\n+                    c.getDestTO().getObjectType() == DataObjectType.SNAPSHOT) {\n+                inSeq = false;\n+            } else if (c.getDestTO().getDataStore().getRole() == DataStoreRole.Image ||\n+                    c.getDestTO().getDataStore().getRole() == DataStoreRole.ImageCache) {\n+                inSeq = false;\n+            }\n+            c.setExecuteInSequence(inSeq);\n+        }\n         if (cmd instanceof StorageSubSystemCommand) {\n             StorageSubSystemCommand c = (StorageSubSystemCommand)cmd;\n             c.setExecuteInSequence(false);",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/hypervisor/KVMGuru.java",
                "sha": "e15a41752e6f673e01c1055d1243e997b3c823c0",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 3,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -30,7 +30,6 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n-import com.cloud.capacity.CapacityState;\n import com.cloud.vm.VirtualMachine;\n \n import org.apache.cloudstack.api.ApiConstants;\n@@ -71,6 +70,7 @@\n import com.cloud.agent.transport.Request;\n import com.cloud.capacity.Capacity;\n import com.cloud.capacity.CapacityManager;\n+import com.cloud.capacity.CapacityState;\n import com.cloud.capacity.CapacityVO;\n import com.cloud.capacity.dao.CapacityDao;\n import com.cloud.cluster.ClusterManager;\n@@ -1174,12 +1174,13 @@ private boolean doMaintain(final long hostId) {\n         MaintainAnswer answer = (MaintainAnswer)_agentMgr.easySend(hostId, new MaintainCommand());\n         if (answer == null || !answer.getResult()) {\n             s_logger.warn(\"Unable to send MaintainCommand to host: \" + hostId);\n+            return false;\n         }\n \n         try {\n             resourceStateTransitTo(host, ResourceState.Event.AdminAskMaintenace, _nodeId);\n         } catch (NoTransitionException e) {\n-            String err = \"Cannot transimit resource state of host \" + host.getId() + \" to \" + ResourceState.Maintenance;\n+            String err = \"Cannot transmit resource state of host \" + host.getId() + \" to \" + ResourceState.Maintenance;\n             s_logger.debug(err, e);\n             throw new CloudRuntimeException(err + e.getMessage());\n         }\n@@ -1210,7 +1211,6 @@ private boolean doMaintain(final long hostId) {\n                 }\n             }\n         }\n-\n         return true;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "b0b18490cab7a1d1a12f57207ae0098da14f3103",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 1,
                "filename": "server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java",
                "patch": "@@ -847,8 +847,9 @@ public Long doInTransaction(TransactionStatus status) {\n \n         // this lock guards against the updates to user_vm, volume, snapshot, public _ip and template table\n         // as any resource creation precedes with the resourceLimitExceeded check which needs this lock too\n+        Set rowIdsToLock = _resourceCountDao.listAllRowsToUpdate(accountId, Resource.ResourceOwnerType.Account, type);\n         SearchCriteria<ResourceCountVO> sc = ResourceCountSearch.create();\n-        sc.setParameters(\"accountId\", accountId);\n+        sc.setParameters(\"id\", rowIdsToLock.toArray());\n         _resourceCountDao.lockRows(sc, null, true);\n \n         ResourceCountVO accountRC = _resourceCountDao.findByOwnerAndType(accountId, ResourceOwnerType.Account, type);",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/resourcelimit/ResourceLimitManagerImpl.java",
                "sha": "8bf091811bdabf9e2398c3a4b32b36c82f080bdd",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ConfigurationServerImpl.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 0,
                "filename": "server/src/com/cloud/server/ConfigurationServerImpl.java",
                "patch": "@@ -219,6 +219,9 @@ public void persistDefaultValues() throws InternalErrorException {\n             _configDao.update(\"secstorage.secure.copy.cert\", \"realhostip\");\n             s_logger.debug(\"ConfigurationServer made secondary storage copy use realhostip.\");\n \n+            _configDao.update(\"user.password.encoders.exclude\", \"MD5,LDAP,PLAINTEXT\");\n+            s_logger.debug(\"Configuration server excluded insecure encoders\");\n+\n             // Save default service offerings\n             createServiceOffering(User.UID_SYSTEM, \"Small Instance\", 1, 512, 500, \"Small Instance\", ProvisioningType.THIN, false, false, null);\n             createServiceOffering(User.UID_SYSTEM, \"Medium Instance\", 1, 1024, 1000, \"Medium Instance\", ProvisioningType.THIN, false, false, null);",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "sha": "b85f13764b0901aad36e9eeb3aa23f8e721c3041",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/storage/download/DownloadActiveState.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/download/DownloadActiveState.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 0,
                "filename": "server/src/com/cloud/storage/download/DownloadActiveState.java",
                "patch": "@@ -59,6 +59,7 @@ public String handleAnswer(DownloadAnswer answer) {\n \n     @Override\n     public void onEntry(String prevState, DownloadEvent event, Object evtObj) {\n+        super.onEntry(prevState, event, evtObj);\n         if (s_logger.isTraceEnabled()) {\n             getDownloadListener().log(\"onEntry, prev state= \" + prevState + \", curr state=\" + getName() + \", event=\" + event, Level.TRACE);\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/storage/download/DownloadActiveState.java",
                "sha": "d202d9add3162582c9b65211ee4dd6016df9bfe3",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=5481485a083957ff58da3b6fea9d7b6d20f06875",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -115,6 +115,10 @@\n import com.cloud.vm.dao.InstanceGroupDao;\n import com.cloud.vm.dao.UserVmDao;\n import com.cloud.vm.dao.VMInstanceDao;\n+import com.cloud.vm.snapshot.VMSnapshot;\n+import com.cloud.vm.snapshot.VMSnapshotManager;\n+import com.cloud.vm.snapshot.VMSnapshotVO;\n+import com.cloud.vm.snapshot.dao.VMSnapshotDao;\n import org.apache.cloudstack.acl.ControlledEntity;\n import org.apache.cloudstack.acl.QuerySelector;\n import org.apache.cloudstack.acl.RoleType;\n@@ -198,6 +202,10 @@\n     @Inject\n     private SnapshotManager _snapMgr;\n     @Inject\n+    private VMSnapshotManager _vmSnapshotMgr;\n+    @Inject\n+    private VMSnapshotDao _vmSnapshotDao;\n+    @Inject\n     private UserVmManager _vmMgr;\n     @Inject\n     private TemplateManager _tmpltMgr;\n@@ -727,6 +735,16 @@ protected boolean cleanupAccount(AccountVO account, long callerUserId, Account c\n                 accountCleanupNeeded = true;\n             }\n \n+            // Destroy VM Snapshots\n+            List<VMSnapshotVO> vmSnapshots = _vmSnapshotDao.listByAccountId(Long.valueOf(accountId));\n+            for (VMSnapshot vmSnapshot : vmSnapshots) {\n+                try {\n+                    _vmSnapshotMgr.deleteVMSnapshot(vmSnapshot.getId());\n+                } catch (Exception e) {\n+                    s_logger.debug(\"Failed to cleanup vm snapshot \" + vmSnapshot.getId() + \" due to \" + e.toString());\n+                }\n+            }\n+\n             // Destroy the account's VMs\n             List<UserVmVO> vms = _userVmDao.listByAccountId(accountId);\n             if (s_logger.isDebugEnabled()) {\n@@ -1166,6 +1184,9 @@ public UserAccount updateUser(Long userId, String firstName, String lastName, St\n         }\n \n         if (password != null) {\n+            if (password.isEmpty()) {\n+                throw new InvalidParameterValueException(\"Password cannot be empty\");\n+            }\n             String encodedPassword = null;\n             for (Iterator<UserAuthenticator> en = _userPasswordEncoders.iterator(); en.hasNext();) {\n                 UserAuthenticator authenticator = en.next();\n@@ -1974,7 +1995,7 @@ public void logoutUser(long userId) {\n     @Override\n     public UserAccount authenticateUser(String username, String password, Long domainId, String loginIpAddress, Map<String, Object[]> requestParameters) {\n         UserAccount user = null;\n-        if (password != null) {\n+        if (password != null && !password.isEmpty()) {\n             user = getUserAccount(username, password, domainId, requestParameters);\n         } else {\n             String key = _configDao.getValue(\"security.singlesignon.key\");",
                "raw_url": "https://github.com/apache/cloudstack/raw/5481485a083957ff58da3b6fea9d7b6d20f06875/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "3d818ab0239f7c1eeaa764ea64a8863dc4e29b8d",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-5238: password checks, NPE fixes and minor fixes\n\n- insecure authenticators excluded in configuration\n- snapshot response should have zone\n- remove vmsnapshots when removing accounts\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/e000646790597cb6c245311f57761b41d23a4e34",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java",
            "KVMGuruTest.java",
            "ResourceManagerImplTest.java",
            "ResourceLimitManagerImplTest.java",
            "ConfigurationServerImplTest.java",
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_55447c2": {
        "bug_id": "cloudstack_55447c2",
        "commit": "https://github.com/apache/cloudstack/commit/55447c25720b929c4544789542e0c87e88430d23",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/55447c25720b929c4544789542e0c87e88430d23/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=55447c25720b929c4544789542e0c87e88430d23",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1763,7 +1763,7 @@ public UserVm updateVirtualMachine(UpdateVMCmd cmd)\n         Boolean ha = cmd.getHaEnable();\n         Long id = cmd.getId();\n         Long osTypeId = cmd.getOsTypeId();\n-        String userData = cmd.getUserData().replace(\"\\\\n\", \"\");\n+        String userData = cmd.getUserData();\n \n         // Input validation\n         UserVmVO vmInstance = null;\n@@ -1802,6 +1802,8 @@ public UserVm updateVirtualMachine(UpdateVMCmd cmd)\n \n         boolean updateUserdata = false;\n         if (userData != null) {\n+            // check and replace newlines\n+            userData = userData.replace(\"\\\\n\", \"\");\n             validateUserData(userData);\n             // update userData on domain router.\n             updateUserdata = true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/55447c25720b929c4544789542e0c87e88430d23/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "687f521e08c5362ed805f2a29c99f8f0a5b08833",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-424: Fix NPE while updating user data\n\nReplace newlines in userdata only when it's not null.\n\nSigned-off-by: Rohit Yadav <bhaisaab@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/6d200c5021171a0f5e7452e1c7d00ee21b2c2351",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_55c059c": {
        "bug_id": "cloudstack_55c059c",
        "commit": "https://github.com/apache/cloudstack/commit/55c059c09887651cab59e292bedafbbf9f1699df",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/55c059c09887651cab59e292bedafbbf9f1699df/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=55c059c09887651cab59e292bedafbbf9f1699df",
                "deletions": 4,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -2365,12 +2365,18 @@ public static void populateOwner(ControlledViewEntityResponse response, Controll\n \n     private void populateAccount(ControlledEntityResponse response, long accountId) {\n         Account account = ApiDBUtils.findAccountById(accountId);\n-        if (account.getType() == Account.ACCOUNT_TYPE_PROJECT) {\n+        if (account == null) {\n+            s_logger.debug(\"Unable to find account with id: \" + accountId);\n+        } else if (account.getType() == Account.ACCOUNT_TYPE_PROJECT) {\n             // find the project\n             Project project = ApiDBUtils.findProjectByProjectAccountId(account.getId());\n-            response.setProjectId(project.getUuid());\n-            response.setProjectName(project.getName());\n-            response.setAccountName(account.getAccountName());\n+            if (project != null) {\n+                response.setProjectId(project.getUuid());\n+                response.setProjectName(project.getName());\n+                response.setAccountName(account.getAccountName());\n+            } else {\n+                s_logger.debug(\"Unable to find project with id: \" + account.getId());\n+            }\n         } else {\n             response.setAccountName(account.getAccountName());\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/55c059c09887651cab59e292bedafbbf9f1699df/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "0081b9d209a0a79f90314553933989c5a768bf61",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-10144: fix possible NPE in listVlanIpRanges",
        "parent": "https://github.com/apache/cloudstack/commit/7f6ae15972fde879bb13efce105f9cca515b638f",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_571ca42": {
        "bug_id": "cloudstack_571ca42",
        "commit": "https://github.com/apache/cloudstack/commit/571ca42c4490ff5ed9be024a6d6086e45962cf05",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/core/src/com/cloud/configuration/dao/ConfigurationDao.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/configuration/dao/ConfigurationDao.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 1,
                "filename": "core/src/com/cloud/configuration/dao/ConfigurationDao.java",
                "patch": "@@ -63,5 +63,7 @@\n      * returns whether or not this is a premium configuration\n      * @return true if premium configuration, false otherwise\n      */\r\n-    boolean isPremium();\r\n+    boolean isPremium();\n+    \n+    ConfigurationVO findByName(String name);\r\n }\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/core/src/com/cloud/configuration/dao/ConfigurationDao.java",
                "sha": "b44343ffe52e452241d955da0b28b4f3d033bd70",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/core/src/com/cloud/configuration/dao/ConfigurationDaoImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/configuration/dao/ConfigurationDaoImpl.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 0,
                "filename": "core/src/com/cloud/configuration/dao/ConfigurationDaoImpl.java",
                "patch": "@@ -145,5 +145,12 @@ public String getValue(String name) {\n         String value = config.getValue();\n         return value;\r\n        \r\n+    }\n+    \n+    @Override\n+    public ConfigurationVO findByName(String name) {\n+        SearchCriteria<ConfigurationVO> sc = NameSearch.create();\n+        sc.setParameters(\"name\", name);\n+        return findOneIncludingRemovedBy(sc);\n     }\r\n }\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/core/src/com/cloud/configuration/dao/ConfigurationDaoImpl.java",
                "sha": "5a5e684ee8aefee03da5f3d0e806c26812a6d38b",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 0,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -21,11 +21,13 @@\n import java.util.List;\n \n import com.cloud.api.response.AccountResponse;\n+import com.cloud.api.response.ConfigurationResponse;\n import com.cloud.api.response.DiskOfferingResponse;\n import com.cloud.api.response.DomainResponse;\n import com.cloud.api.response.ResourceLimitResponse;\n import com.cloud.api.response.ServiceOfferingResponse;\n import com.cloud.api.response.UserResponse;\n+import com.cloud.configuration.ConfigurationVO;\n import com.cloud.configuration.ResourceCount.ResourceType;\n import com.cloud.configuration.ResourceLimitVO;\n import com.cloud.domain.DomainVO;\n@@ -227,5 +229,15 @@ public static ServiceOfferingResponse createServiceOfferingResponse (ServiceOffe\n        return offeringResponse;\n    }\n    \n+   public static ConfigurationResponse createConfigurationResponse (ConfigurationVO cfg) {\n+       ConfigurationResponse cfgResponse = new ConfigurationResponse();\n+       cfgResponse.setCategory(cfg.getCategory());\n+       cfgResponse.setDescription(cfg.getDescription());\n+       cfgResponse.setName(cfg.getName());\n+       cfgResponse.setValue(cfg.getValue());\n+       \n+       return cfgResponse;\n+   }\n+   \n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "89d702e5e7388c0d2aa13bc14089a3890784dccd",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/commands/AddConfigCmd.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/commands/AddConfigCmd.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 11,
                "filename": "server/src/com/cloud/api/commands/AddConfigCmd.java",
                "patch": "@@ -20,6 +20,7 @@\n import org.apache.log4j.Logger;\n \n import com.cloud.api.ApiConstants;\n+import com.cloud.api.ApiResponseHelper;\n import com.cloud.api.BaseCmd;\n import com.cloud.api.Implementation;\n import com.cloud.api.Parameter;\n@@ -98,19 +99,13 @@ public String getName() {\n     \n     @Override @SuppressWarnings(\"unchecked\")\n     public ConfigurationResponse getResponse() {\n-        ConfigurationResponse response = new ConfigurationResponse();\n-        ConfigurationVO responseObject = (ConfigurationVO)getResponseObject();\n-        if (responseObject != null) {\n-            response.setName(responseObject.getName());\n-            response.setValue(responseObject.getValue());\n-            //TODO - return description and category if needed (didn't return in 2.1 release)\n-\n+        ConfigurationVO cfg = (ConfigurationVO)getResponseObject();\n+        if (cfg != null) {\n+            ConfigurationResponse response = ApiResponseHelper.createConfigurationResponse(cfg);\n+            response.setResponseName(getName());\n+            return response;\n         } else {\n             throw new ServerApiException(BaseCmd.INTERNAL_ERROR, \"Failed to add config\");\n         }\n-\n-        response.setResponseName(getName());\n-        return response;\n-        //return ApiResponseSerializer.toSerializedString(response);\n     }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/commands/AddConfigCmd.java",
                "sha": "33dd3ac82378c4ff535846801e64d0af5361290c",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/commands/ListCfgsByCmd.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/commands/ListCfgsByCmd.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 6,
                "filename": "server/src/com/cloud/api/commands/ListCfgsByCmd.java",
                "patch": "@@ -24,6 +24,7 @@\n import org.apache.log4j.Logger;\n \n import com.cloud.api.ApiConstants;\n+import com.cloud.api.ApiResponseHelper;\n import com.cloud.api.BaseListCmd;\n import com.cloud.api.Implementation;\n import com.cloud.api.Parameter;\n@@ -77,12 +78,7 @@ public String getName() {\n         ListResponse<ConfigurationResponse> response = new ListResponse<ConfigurationResponse>();\n         List<ConfigurationResponse> configResponses = new ArrayList<ConfigurationResponse>();\n         for (ConfigurationVO cfg : configurations) {\n-            ConfigurationResponse cfgResponse = new ConfigurationResponse();\n-            cfgResponse.setCategory(cfg.getCategory());\n-            cfgResponse.setDescription(cfg.getDescription());\n-            cfgResponse.setName(cfg.getName());\n-            cfgResponse.setValue(cfg.getValue());\n-\n+            ConfigurationResponse cfgResponse = ApiResponseHelper.createConfigurationResponse(cfg);\n             cfgResponse.setResponseName(\"configuration\");\n             configResponses.add(cfgResponse);\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/commands/ListCfgsByCmd.java",
                "sha": "1949a5d237e6acd11a708ee02a47425635f4efb6",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/commands/UpdateCfgCmd.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/commands/UpdateCfgCmd.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 10,
                "filename": "server/src/com/cloud/api/commands/UpdateCfgCmd.java",
                "patch": "@@ -21,12 +21,14 @@\n import org.apache.log4j.Logger;\n \n import com.cloud.api.ApiConstants;\n+import com.cloud.api.ApiResponseHelper;\n import com.cloud.api.BaseCmd;\n import com.cloud.api.Implementation;\n import com.cloud.api.Parameter;\n import com.cloud.api.ServerApiException;\n-import com.cloud.api.response.SuccessResponse;\n+import com.cloud.api.response.ConfigurationResponse;\n import com.cloud.configuration.ConfigurationManager;\n+import com.cloud.configuration.ConfigurationVO;\n \n @Implementation(method=\"updateConfiguration\", manager=ConfigurationManager.class, description=\"Updates a configuration.\")\n public class UpdateCfgCmd extends BaseCmd {\n@@ -64,18 +66,15 @@ public String getName() {\n     }\n     \n     @Override @SuppressWarnings(\"unchecked\")\n-    public SuccessResponse getResponse() {\n-        SuccessResponse response = new SuccessResponse();\n-        Boolean responseObject = (Boolean)getResponseObject();\n+    public ConfigurationResponse getResponse() {\n+        ConfigurationVO cfg = (ConfigurationVO)getResponseObject();\n       \n-        if (responseObject != null) {\n-        \tresponse.setSuccess(responseObject);\n-        \tresponse.setDisplayText(\"Successfully updated configuration value.\");\n+        if (cfg != null) {\n+            ConfigurationResponse response = ApiResponseHelper.createConfigurationResponse(cfg);\n+            response.setResponseName(getName());\n+            return response;\n         } else {\n             throw new ServerApiException(BaseCmd.INTERNAL_ERROR, \"Failed to update config\");\n         }\n-\n-        response.setResponseName(getName());\n-        return response;\n     }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/api/commands/UpdateCfgCmd.java",
                "sha": "2c6dfb13469ba1f5c50dc79d07a8ba4a021dde39",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/configuration/ConfigurationManager.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/ConfigurationManager.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 7,
                "filename": "server/src/com/cloud/configuration/ConfigurationManager.java",
                "patch": "@@ -41,6 +41,7 @@\n import com.cloud.exception.ConcurrentOperationException;\n import com.cloud.exception.InsufficientAddressCapacityException;\n import com.cloud.exception.InsufficientCapacityException;\n+import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.service.ServiceOfferingVO;\n import com.cloud.storage.DiskOfferingVO;\n import com.cloud.utils.component.Manager;\n@@ -63,10 +64,10 @@\n \t/**\n \t * Updates a configuration entry with a new value\n \t * @param cmd - the command wrapping name and value parameters\n-\t * @return true or false\n-\t * @throws , \n+\t * @return updated configuration object if successful\n+\t * @throws InvalidParameterValueException\n \t */\n-\tboolean updateConfiguration(UpdateCfgCmd cmd);\n+\tConfigurationVO updateConfiguration(UpdateCfgCmd cmd) throws InvalidParameterValueException;\n \n \t/**\n \t * Creates a new service offering\n@@ -298,9 +299,7 @@\n \t\n \t/**\n \t * Persists a config value via the API call\n-\t * @param cmd - the command that wraps instance, component, category, name, value, description parameters\n-\t * @throws , \n-\t * @return true or false\n+\t * @return newly created Config object\n \t */\n-\tboolean addConfig(AddConfigCmd cmd);\n+\tConfigurationVO addConfig(AddConfigCmd cmd);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/configuration/ConfigurationManager.java",
                "sha": "c95e1d30f5d7f8db8566e5696164463cdc105763",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/ConfigurationManagerImpl.java?ref=571ca42c4490ff5ed9be024a6d6086e45962cf05",
                "deletions": 7,
                "filename": "server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "patch": "@@ -184,15 +184,23 @@ public void updateConfiguration(long userId, String name, String value)  {\n     }\n     \n     @Override\n-    public boolean updateConfiguration(UpdateCfgCmd cmd) {\n+    public ConfigurationVO updateConfiguration(UpdateCfgCmd cmd) throws InvalidParameterValueException{\n     \tLong userId = UserContext.current().getUserId();\n     \tString name = cmd.getCfgName();\n     \tString value = cmd.getValue();\n+    \t\n+    \t//check if config value exists\n+    \tif (_configDao.findByName(name) == null)\n+    \t    throw new InvalidParameterValueException(\"Config parameter with name \" + name + \" doesn't exist\");\n+    \t\n+    \tif (value == null)\n+    \t    return _configDao.findByName(name);\n+    \t\n     \tupdateConfiguration (userId, name, value);\n     \tif (_configDao.getValue(name).equalsIgnoreCase(value))\n-    \t\treturn true;\n+    \t\treturn _configDao.findByName(name);\n     \telse \n-    \t\treturn false;\n+    \t\tthrow new CloudRuntimeException(\"Unable to update configuration parameter\" + name);\n     }\n     \n     \n@@ -2139,24 +2147,24 @@ private Long saveConfigurationEvent(long userId, Long accountId, String type, St\n     }\n \n \t@Override\n-\tpublic boolean addConfig(AddConfigCmd cmd){\n+\tpublic ConfigurationVO addConfig(AddConfigCmd cmd){\n \t\tString category = cmd.getCategory();\n \t\tString instance = cmd.getInstance();\n \t\tString component = cmd.getComponent();\n-\t\tString name = cmd.getName();\n+\t\tString name = cmd.getConfigPropName();\n \t\tString value = cmd.getValue();\n \t\tString description = cmd.getDescription();\n \t\ttry\n \t\t{\n \t\t\tConfigurationVO entity = new ConfigurationVO(category, instance, component, name, value, description);\n \t\t\t_configDao.persist(entity);\n \t\t\ts_logger.info(\"Successfully added configuration value into db: category:\"+category+\" instance:\"+instance+\" component:\"+component+\" name:\"+name+\" value:\"+value);\n-\t\t\treturn true;\n+\t\t\treturn _configDao.findByName(name);\n \t\t}\n \t\tcatch(Exception ex)\n \t\t{\n \t\t\ts_logger.error(\"Unable to add the new config entry:\",ex);\n-\t\t\treturn false;\n+\t\t\tthrow new CloudRuntimeException(\"Unable to add configuration parameter\" + name);\n \t\t}\n \t}\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/571ca42c4490ff5ed9be024a6d6086e45962cf05/server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "sha": "daa6fee8182244aecd851e9c8ef048415cbf5099",
                "status": "modified"
            }
        ],
        "message": "1) Return embedded object for addCfg/updateCfg/listCfg.\n2) Fixed NPE in updateCfg command (used to happen when no value was specified)\n3) Fixed addCfg command to call correct getName method while setting config name (used to call the method returning the command name)",
        "parent": "https://github.com/apache/cloudstack/commit/5fe5450abc61e088843e23ae649feae1223f51e8",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java",
            "UpdateCfgCmdTest.java",
            "ConfigurationManagerTest.java"
        ]
    },
    "cloudstack_57f6b16": {
        "bug_id": "cloudstack_57f6b16",
        "commit": "https://github.com/apache/cloudstack/commit/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4",
        "file": [
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java?ref=57f6b16cdb94ce2b5bfff657b32552c9bf22fae4",
                "deletions": 16,
                "filename": "server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "patch": "@@ -1388,8 +1388,6 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<ConsoleProxyV\n             externalDhcp = true;\n         }\n         \n-        NicProfile controlNic = null;\n-        NicProfile managementNic = null;\n         for (NicProfile nic : profile.getNics()) {\n             int deviceId = nic.getDeviceId();\n             if(nic.getIp4Address() == null) {\n@@ -1410,31 +1408,19 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<ConsoleProxyV\n             \n             if (nic.getTrafficType() == TrafficType.Management) {\n                 buf.append(\" localgw=\").append(dest.getPod().getGateway());\n-                managementNic = nic;\n-            } else if (nic.getTrafficType() == TrafficType.Control) {\n-                if(nic.getIp4Address() != null) {\n-                    controlNic = nic;\n-                }\n-            }\n+            } \n         }\n \n \t\t/*External DHCP mode*/\n \t\tif(externalDhcp) {\n             buf.append(\" bootproto=dhcp\");\n         }\n         \n-        if(controlNic == null) {\n-        \tassert(managementNic != null);\n-        \tcontrolNic = managementNic;\n-        }\n-        \n         String bootArgs = buf.toString();\n         if (s_logger.isDebugEnabled()) {\n             s_logger.debug(\"Boot Args for \" + profile + \": \" + bootArgs);\n         }\n         \n-        profile.setParameter(VirtualMachineProfile.Param.ControlNic, controlNic);\n-        \n         return true;\n     }\n \n@@ -1462,7 +1448,22 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<ConsolePr\n     \n     @Override\n     public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<ConsoleProxyVO> profile) {\n-        NicProfile controlNic = (NicProfile)profile.getParameter(VirtualMachineProfile.Param.ControlNic);\n+        \n+        NicProfile managementNic = null;\n+        NicProfile controlNic = null;\n+        for (NicProfile nic : profile.getNics()) {\n+           if (nic.getTrafficType() == TrafficType.Management) {\n+               managementNic = nic;\n+           } else if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n+               controlNic = nic;\n+           }\n+        }\n+\n+        if (controlNic == null) {\n+          assert (managementNic != null);\n+          controlNic = managementNic;\n+        }\n+\n         CheckSshCommand check = new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20);\n         cmds.addCommand(\"checkSsh\", check);\n         ",
                "raw_url": "https://github.com/apache/cloudstack/raw/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/consoleproxy/ConsoleProxyManagerImpl.java",
                "sha": "d45c1bea35b81ede686bf2b31894f269cbf504dd",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=57f6b16cdb94ce2b5bfff657b32552c9bf22fae4",
                "deletions": 5,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -934,8 +934,6 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<DomainRouterV\n             throw new CloudRuntimeException(\"Didn't start a control port\");\n         }\n \n-        profile.setParameter(VirtualMachineProfile.Param.ControlNic, controlNic);\n-\n         return true;\n     }\n \n@@ -964,9 +962,21 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<DomainRou\n     \n     @Override\n     public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<DomainRouterVO> profile) {\n-        DomainRouterVO router = profile.getVirtualMachine();\n-        NicProfile controlNic = (NicProfile) profile.getParameter(VirtualMachineProfile.Param.ControlNic);\n-        cmds.addCommand(\"checkSsh\", new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20));\n+       DomainRouterVO router = profile.getVirtualMachine();\n+        \n+       NicProfile controlNic = null;\n+       for (NicProfile nic : profile.getNics()) {\n+           if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n+               controlNic = nic;\n+           }\n+       }\n+\n+       if (controlNic == null) {\n+           s_logger.error(\"Control network doesn't exist for the router \" + router);\n+           return false;\n+       }\n+        \n+       cmds.addCommand(\"checkSsh\", new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20));\n         \n         //restart network if restartNetwork = false is not specified in profile parameters\n         boolean restartNetwork = true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "cad6914b161de7adca34357a4cdf784161db6ef6",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java?ref=57f6b16cdb94ce2b5bfff657b32552c9bf22fae4",
                "deletions": 16,
                "filename": "server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "patch": "@@ -984,9 +984,6 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n         buf.append(\" instance=SecStorage\");\n         buf.append(\" sslcopy=\").append(Boolean.toString(_useSSlCopy));\n \n-        NicProfile controlNic = null;\n-        NicProfile managementNic = null;\n-\n         boolean externalDhcp = false;\n         String externalDhcpStr = _configDao.getValue(\"direct.attach.network.externalIpAllocator.enabled\");\n         if (externalDhcpStr != null && externalDhcpStr.equalsIgnoreCase(\"true\")) {\n@@ -1009,12 +1006,7 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n             }\n             if (nic.getTrafficType() == TrafficType.Management) {\n                 buf.append(\" localgw=\").append(dest.getPod().getGateway());\n-                managementNic = nic;\n                 buf.append(\" private.network.device=\").append(\"eth\").append(deviceId);\n-            } else if (nic.getTrafficType() == TrafficType.Control) {\n-                if (nic.getIp4Address() != null) {\n-                    controlNic = nic;\n-                }\n             } else if (nic.getTrafficType() == TrafficType.Public) {\n                 buf.append(\" public.network.device=\").append(\"eth\").append(deviceId);\n             }\n@@ -1025,11 +1017,6 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n             buf.append(\" bootproto=dhcp\");\n         }\n \n-        if (controlNic == null) {\n-            assert (managementNic != null);\n-            controlNic = managementNic;\n-        }\n-\n         DataCenterVO dc = _dcDao.findById(profile.getVirtualMachine().getDataCenterId());\n         buf.append(\" dns1=\").append(dc.getInternalDns1());\n         if (dc.getInternalDns2() != null) {\n@@ -1041,8 +1028,6 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile<SecondaryStor\n             s_logger.debug(\"Boot Args for \" + profile + \": \" + bootArgs);\n         }\n \n-        profile.setParameter(VirtualMachineProfile.Param.ControlNic, controlNic);\n-\n         return true;\n     }\n \n@@ -1072,7 +1057,22 @@ public boolean finalizeDeployment(Commands cmds, VirtualMachineProfile<Secondary\n     \n     @Override\n     public boolean finalizeCommandsOnStart(Commands cmds, VirtualMachineProfile<SecondaryStorageVmVO> profile) {\n-        NicProfile controlNic = (NicProfile) profile.getParameter(VirtualMachineProfile.Param.ControlNic);\n+        \n+        NicProfile managementNic = null;\n+        NicProfile controlNic = null;\n+        for (NicProfile nic : profile.getNics()) {\n+           if (nic.getTrafficType() == TrafficType.Management) {\n+               managementNic = nic;\n+           } else if (nic.getTrafficType() == TrafficType.Control && nic.getIp4Address() != null) {\n+               controlNic = nic;\n+           }\n+        }\n+\n+        if (controlNic == null) {\n+          assert (managementNic != null);\n+          controlNic = managementNic;\n+        }\n+\n         CheckSshCommand check = new CheckSshCommand(profile.getInstanceName(), controlNic.getIp4Address(), 3922, 5, 20);\n         cmds.addCommand(\"checkSsh\", check);\n         ",
                "raw_url": "https://github.com/apache/cloudstack/raw/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/storage/secondary/SecondaryStorageManagerImpl.java",
                "sha": "8e5eaf17f22785ed8c2582e6523c5b133272acd3",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/cloudstack/blob/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=57f6b16cdb94ce2b5bfff657b32552c9bf22fae4",
                "deletions": 14,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1331,26 +1331,33 @@ protected Command compareState(VMInstanceVO vm, final AgentVmInfo info, final bo\n                     \n                     Commands cmds = new Commands(OnError.Revert);\n                     s_logger.debug(\"Finalizing commands that need to be send to complete Start process for the vm \" + vm);\n-                    vmGuru.finalizeCommandsOnStart(cmds, profile);\n                     \n-                    if (cmds.size() != 0) {\n-                        try {\n-                            _agentMgr.send(vm.getHostId(), cmds);\n-                        } catch (OperationTimedoutException e){\n-                            s_logger.error(\"Exception during update for running vm: \" + vm, e);                        \n-                            return null;\n-                        } catch (ResourceUnavailableException e) {\n-                            s_logger.error(\"Exception during update for running vm: \" + vm, e); \n+                    \n+                    if (vmGuru.finalizeCommandsOnStart(cmds, profile)) {\n+                        if (cmds.size() != 0) {\n+                            try {\n+                                _agentMgr.send(vm.getHostId(), cmds);\n+                            } catch (OperationTimedoutException e){\n+                                s_logger.error(\"Exception during update for running vm: \" + vm, e);                        \n+                                return null;\n+                            } catch (ResourceUnavailableException e) {\n+                                s_logger.error(\"Exception during update for running vm: \" + vm, e); \n+                                return null;\n+                            }\n+                        }\n+                        \n+                        if (vmGuru.finalizeStart(profile, vm.getHostId(), cmds, null)) {\n+                            stateTransitTo(vm, Event.AgentReportRunning, vm.getHostId());\n+                        } else {\n+                            s_logger.error(\"Exception during update for running vm: \" + vm); \n                             return null;\n                         }\n-                    }\n-                    \n-                    if (vmGuru.finalizeStart(profile, vm.getHostId(), cmds, null)) {\n-                        stateTransitTo(vm, Event.AgentReportRunning, vm.getHostId());\n                     } else {\n-                        s_logger.error(\"Exception during update for running vm: \" + vm); \n+                        s_logger.error(\"Unable to finalize commands on start for vm: \" + vm);\n                         return null;\n                     }\n+                    \n+                    \n                 }\n             } else if (serverState == State.Stopping) {\n                 s_logger.debug(\"Scheduling a stop command for \" + vm);",
                "raw_url": "https://github.com/apache/cloudstack/raw/57f6b16cdb94ce2b5bfff657b32552c9bf22fae4/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "d544eb01673ead7efeb6c37ca629336501145c69",
                "status": "modified"
            }
        ],
        "message": "bug 8719: fixed NPE happening during HA process - get control nic infrormation in finalizeCommandsOnStart() method instead of setting it in caller methods\nstatus 8719: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/54b3fff12340dbc5150ce82ecd4ada3bfc63b834",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java",
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_5881dfa": {
        "bug_id": "cloudstack_5881dfa",
        "commit": "https://github.com/apache/cloudstack/commit/5881dfafa67cfe56411b1dd98e63035aa9e707f7",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/5881dfafa67cfe56411b1dd98e63035aa9e707f7/core/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java?ref=5881dfafa67cfe56411b1dd98e63035aa9e707f7",
                "deletions": 0,
                "filename": "core/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "patch": "@@ -1674,8 +1674,15 @@ protected GetVmStatsAnswer execute(GetVmStatsCommand cmd) {\n         try {\n             doc = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(statsSource);\n         } catch (Exception e) {\n+        \ts_logger.warn(\"Exception caught whilst processing the document via document factory:\"+e);\n+        \treturn null;\n         }\n \n+        if(doc==null){\n+        \ts_logger.warn(\"Null document found after tryinh to parse the stats source\");\n+        \treturn null;\n+        }\n+        \n         NodeList firstLevelChildren = doc.getChildNodes();\n         NodeList secondLevelChildren = (firstLevelChildren.item(0)).getChildNodes();\n         Node metaNode = secondLevelChildren.item(0);",
                "raw_url": "https://github.com/apache/cloudstack/raw/5881dfafa67cfe56411b1dd98e63035aa9e707f7/core/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "sha": "2aef2983f241067f2ae6dac1cadc92086946dee2",
                "status": "modified"
            }
        ],
        "message": "bug 5119: fixing the npe, the document obj we parse might be null, as a result of which there can be a npe. adding a check against the same\nstatus 5119: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/33d97d32c79e3eb6a5883b1157490c755714f802",
        "repo": "cloudstack",
        "unit_tests": [
            "CitrixResourceBaseTest.java"
        ]
    },
    "cloudstack_58b57ca": {
        "bug_id": "cloudstack_58b57ca",
        "commit": "https://github.com/apache/cloudstack/commit/58b57ca5dbe514c94469a28d2ebaf0474550ecec",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/58b57ca5dbe514c94469a28d2ebaf0474550ecec/api/src/org/apache/cloudstack/api/ApiConstants.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/ApiConstants.java?ref=58b57ca5dbe514c94469a28d2ebaf0474550ecec",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/ApiConstants.java",
                "patch": "@@ -405,6 +405,7 @@\n     public static final String VSM_CONFIG_MODE = \"vsmconfigmode\";\n     public static final String VSM_CONFIG_STATE = \"vsmconfigstate\";\n     public static final String VSM_DEVICE_STATE = \"vsmdevicestate\";\n+    public static final String VCENTER = \"vcenter\";\n     public static final String ADD_VSM_FLAG = \"addvsmflag\";\n     public static final String END_POINT = \"endpoint\";\n     public static final String REGION_ID = \"regionid\";",
                "raw_url": "https://github.com/apache/cloudstack/raw/58b57ca5dbe514c94469a28d2ebaf0474550ecec/api/src/org/apache/cloudstack/api/ApiConstants.java",
                "sha": "ab1402ccde952f13a75e08ee07b227af2bee80b5",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/dao/VmwareDatacenterDaoImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/dao/VmwareDatacenterDaoImpl.java?ref=58b57ca5dbe514c94469a28d2ebaf0474550ecec",
                "deletions": 2,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/dao/VmwareDatacenterDaoImpl.java",
                "patch": "@@ -75,15 +75,15 @@ public VmwareDatacenterVO getVmwareDatacenterByGuid(String guid) {\n \n     @Override\n     public List<VmwareDatacenterVO> getVmwareDatacenterByNameAndVcenter(String name, String vCenterHost) {\n-        SearchCriteria<VmwareDatacenterVO> sc = guidSearch.create();\n+        SearchCriteria<VmwareDatacenterVO> sc = nameVcSearch.create();\n         sc.setParameters(\"name\", name);\n         sc.setParameters(\"vCenterHost\", vCenterHost);\n         return search(sc, null);\n     }\n \n     @Override\n     public List<VmwareDatacenterVO> listVmwareDatacenterByName(String name) {\n-        SearchCriteria<VmwareDatacenterVO> sc = guidSearch.create();\n+        SearchCriteria<VmwareDatacenterVO> sc = nameSearch.create();\n         sc.setParameters(\"name\", name);\n         return search(sc, null);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/dao/VmwareDatacenterDaoImpl.java",
                "sha": "9f5796a073ad739f9ca903d5f036da9e70ff57e2",
                "status": "modified"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/cloudstack/blob/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java",
                "changes": 102,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java?ref=58b57ca5dbe514c94469a28d2ebaf0474550ecec",
                "deletions": 69,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java",
                "patch": "@@ -21,7 +21,7 @@\n import java.net.URI;\n import java.net.URISyntaxException;\n import java.net.URL;\n-import java.net.URLDecoder;\n+import java.rmi.RemoteException;\n import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n@@ -38,8 +38,6 @@\n \n import org.apache.cloudstack.api.command.admin.zone.AddVmwareDcCmd;\n import org.apache.cloudstack.api.command.admin.zone.RemoveVmwareDcCmd;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreManager;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataStoreRole;\n import org.apache.log4j.Logger;\n \n import com.cloud.agent.AgentManager;\n@@ -50,8 +48,6 @@\n import com.cloud.agent.api.Command;\n import com.cloud.agent.api.StartupCommand;\n import com.cloud.agent.api.StartupRoutingCommand;\n-import com.cloud.agent.api.storage.MigrateVolumeAnswer;\n-import com.cloud.agent.api.to.VolumeTO;\n import com.cloud.cluster.ClusterManager;\n import com.cloud.configuration.Config;\n import com.cloud.configuration.dao.ConfigurationDao;\n@@ -80,7 +76,6 @@\n import com.cloud.hypervisor.vmware.dao.VmwareDatacenterDao;\n import com.cloud.hypervisor.vmware.dao.VmwareDatacenterZoneMapDao;\n import com.cloud.hypervisor.vmware.mo.CustomFieldConstants;\n-import com.cloud.hypervisor.vmware.mo.CustomFieldsManagerMO;\n import com.cloud.hypervisor.vmware.mo.DatacenterMO;\n import com.cloud.hypervisor.vmware.mo.DiskControllerType;\n import com.cloud.hypervisor.vmware.mo.HostFirewallSystemMO;\n@@ -89,7 +84,6 @@\n import com.cloud.hypervisor.vmware.mo.TaskMO;\n import com.cloud.hypervisor.vmware.mo.VirtualEthernetCardType;\n import com.cloud.hypervisor.vmware.mo.VmwareHostType;\n-import com.cloud.utils.ssh.SshHelper;\n import com.cloud.hypervisor.vmware.resource.VmwareContextFactory;\n import com.cloud.hypervisor.vmware.util.VmwareClient;\n import com.cloud.hypervisor.vmware.util.VmwareContext;\n@@ -103,15 +97,10 @@\n import com.cloud.server.ConfigurationServer;\n import com.cloud.storage.JavaStorageLayer;\n import com.cloud.storage.StorageLayer;\n-import com.cloud.storage.StoragePool;\n-import com.cloud.storage.VolumeVO;\n-import com.cloud.storage.dao.VolumeDao;\n import com.cloud.storage.secondary.SecondaryStorageVmManager;\n import com.cloud.utils.FileUtil;\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.Pair;\n-import com.cloud.utils.UriUtils;\n-import com.cloud.utils.component.Manager;\n import com.cloud.utils.component.ManagerBase;\n import com.cloud.utils.concurrency.NamedThreadFactory;\n import com.cloud.utils.db.DB;\n@@ -121,8 +110,6 @@\n import com.cloud.utils.script.Script;\n import com.cloud.utils.ssh.SshHelper;\n import com.cloud.vm.DomainRouterVO;\n-import com.cloud.vm.VMInstanceVO;\n-import com.cloud.vm.dao.VMInstanceDao;\n import com.google.gson.Gson;\n import com.vmware.vim25.AboutInfo;\n import com.vmware.vim25.HostConnectSpec;\n@@ -530,7 +517,7 @@ public void prepareSecondaryStorageStore(String storageUrl) {\n                         _configServer.updateKeyPairs();\n \n                         s_logger.info(\"Copy System VM patch ISO file to secondary storage. source ISO: \" + srcIso.getAbsolutePath() +\n-                        \t\", destination: \" + destIso.getAbsolutePath());\n+                                \", destination: \" + destIso.getAbsolutePath());\n                         try {\n                             FileUtil.copyfile(srcIso, destIso);\n                         } catch(IOException e) {\n@@ -579,7 +566,7 @@ private File getSystemVMPatchIsoFile() {\n \n         assert(isoFile != null);\n         if(!isoFile.exists()) {\n-        \ts_logger.error(\"Unable to locate systemvm.iso in your setup at \" + isoFile.toString());\n+            s_logger.error(\"Unable to locate systemvm.iso in your setup at \" + isoFile.toString());\n         }\n         return isoFile;\n     }\n@@ -596,7 +583,7 @@ public File getSystemVMKeyFile() {\n         }\n         assert(keyFile != null);\n         if(!keyFile.exists()) {\n-        \ts_logger.error(\"Unable to locate id_rsa.cloud in your setup at \" + keyFile.toString());\n+            s_logger.error(\"Unable to locate id_rsa.cloud in your setup at \" + keyFile.toString());\n         }\n         return keyFile;\n     }\n@@ -914,9 +901,9 @@ public String getRootDiskController() {\n     public VmwareDatacenterVO addVmwareDatacenter(AddVmwareDcCmd cmd) throws ResourceInUseException {\n         VmwareDatacenterVO vmwareDc = null;\n         Long zoneId = cmd.getZoneId();\n-        String url = cmd.getUrl();\n         String userName = cmd.getUsername();\n         String password = cmd.getPassword();\n+        String vCenterHost = cmd.getVcenter();\n         String vmwareDcName = cmd.getName();\n \n         // Zone validation\n@@ -928,25 +915,26 @@ public VmwareDatacenterVO addVmwareDatacenter(AddVmwareDcCmd cmd) throws Resourc\n             throw new CloudRuntimeException(\"Zone \" + zoneId + \" is already associated with a VMware datacenter.\");\n         }\n \n-        // Validate url and get uri\n-        URI uri = getUri(url);\n-\n-        // Validate username and password and DC name\n+        // Validate username, password, VMware DC name and vCenter\n         if (userName == null) {\n-            throw new InvalidParameterValueException(\"Invalid parameter username.\");\n+            throw new InvalidParameterValueException(\"Missing or invalid parameter username.\");\n         }\n \n         if (password == null) {\n-            throw new InvalidParameterValueException(\"Invalid parameter password.\");\n+            throw new InvalidParameterValueException(\"Missing or invalid parameter username.\");\n         }\n \n         if (vmwareDcName == null) {\n-            throw new InvalidParameterValueException(\"Invalid parameter name. Please provide valid VMware datacenter name.\");\n+            throw new InvalidParameterValueException(\"Missing or invalid parameter name. Please provide valid VMware datacenter name.\");\n+        }\n+\n+        if (vCenterHost == null) {\n+            throw new InvalidParameterValueException(\"Missing or invalid parameter name. \" +\n+                    \"Please provide valid VMware vCenter server's IP address or fully qualified domain name.\");\n         }\n \n         // Check if DC is already part of zone\n         // In that case vmware_data_center table should have the DC\n-        String vCenterHost = uri.getHost();\n         vmwareDc = _vmwareDcDao.getVmwareDatacenterByGuid(vmwareDcName + \"@\" + vCenterHost);\n         if (vmwareDc != null) {\n             throw new ResourceInUseException(\"This DC is already part of other CloudStack zone(s). Cannot add this DC to more zones.\");\n@@ -963,14 +951,13 @@ public VmwareDatacenterVO addVmwareDatacenter(AddVmwareDcCmd cmd) throws Resourc\n             context = VmwareContextFactory.create(vCenterHost, userName, password);\n \n             // Check if DC exists on vCenter\n-            try {\n-                dcMo = new DatacenterMO(context, vmwareDcName);\n-            } catch(Throwable t) {\n-                String msg = \"Unable to find DC \" + vmwareDcName + \" in vCenter \" + vCenterHost;\n+            dcMo = new DatacenterMO(context, vmwareDcName);\n+            dcMor = dcMo.getMor();\n+            if (dcMor == null) {\n+                String msg = \"Unable to find VMware DC \" + vmwareDcName + \" in vCenter \" + vCenterHost + \". \";\n                 s_logger.error(msg);\n-                throw new DiscoveryException(msg);\n+                throw new InvalidParameterValueException(msg);\n             }\n-            assert (dcMo != null);\n \n             // Check if DC is already associated with another cloudstack deployment\n             // Get custom field property cloud.zone over this DC\n@@ -1020,9 +1007,13 @@ public VmwareDatacenterVO addVmwareDatacenter(AddVmwareDcCmd cmd) throws Resourc\n             }\n             dcMo.setCustomFieldValue(CustomFieldConstants.CLOUD_ZONE, \"true\");\n \n-        } catch (Exception e) {\n-            String msg = \"VMware DC discovery failed due to : \" + VmwareHelper.getExceptionMessage(e);\n-            s_logger.error(msg);\n+        } catch (Throwable e) {\n+            String msg = \"Failed to add VMware DC to zone \";\n+            if (e instanceof RemoteException) {\n+                msg = \"Encountered remote exception at vCenter. \" + VmwareHelper.getExceptionMessage(e);\n+            } else {\n+                msg += \"due to : \" + e.getMessage();\n+            }\n             throw new CloudRuntimeException(msg);\n         } finally {\n             if (context != null)\n@@ -1032,6 +1023,7 @@ public VmwareDatacenterVO addVmwareDatacenter(AddVmwareDcCmd cmd) throws Resourc\n         return vmwareDc;\n     }\n \n+\n     @Override\n     public boolean removeVmwareDatacenter(RemoveVmwareDcCmd cmd) throws ResourceInUseException {\n         Long zoneId = cmd.getZoneId();\n@@ -1070,8 +1062,8 @@ public boolean removeVmwareDatacenter(RemoveVmwareDcCmd cmd) throws ResourceInUs\n             _vmwareDcZoneMapDao.remove(vmwareDcZoneMap.getId());\n             txn.commit();\n         } catch (Exception e) {\n-            s_logger.info(\"Caught exception when trying to delete VMware datacenter record..\" + e.getMessage());\n-            throw new CloudRuntimeException(\"Failed to delete VMware datacenter \");\n+            s_logger.info(\"Caught exception when trying to delete VMware datacenter record.\" + e.getMessage());\n+            throw new CloudRuntimeException(\"Failed to delete VMware datacenter.\");\n         }\n \n         // Construct context\n@@ -1083,7 +1075,7 @@ public boolean removeVmwareDatacenter(RemoveVmwareDcCmd cmd) throws ResourceInUs\n             try {\n                 dcMo = new DatacenterMO(context, vmwareDcName);\n             } catch(Throwable t) {\n-                String msg = \"able to find DC \" + vmwareDcName + \" in vCenter \" + vCenterHost;\n+                String msg = \"Unable to find DC \" + vmwareDcName + \" in vCenter \" + vCenterHost;\n                 s_logger.error(msg);\n                 throw new DiscoveryException(msg);\n             }\n@@ -1095,7 +1087,7 @@ public boolean removeVmwareDatacenter(RemoveVmwareDcCmd cmd) throws ResourceInUs\n             s_logger.info(\"Sucessfully reset custom field property cloud.zone over DC \" + vmwareDcName);\n         } catch (Exception e) {\n             String msg = \"Unable to reset custom field property cloud.zone over DC \" + vmwareDcName\n-                       + \" due to : \" + VmwareHelper.getExceptionMessage(e);\n+                    + \" due to : \" + VmwareHelper.getExceptionMessage(e);\n             s_logger.error(msg);\n             throw new CloudRuntimeException(msg);\n         } finally {\n@@ -1111,7 +1103,7 @@ private void validateZone(Long zoneId, String errStr) throws ResourceInUseExcept\n         DataCenterVO zone = _dcDao.findById(zoneId);\n         if (zone == null) {\n             InvalidParameterValueException ex = new InvalidParameterValueException(\n-                    \"Can't find zone by the id specified\");\n+                    \"Can't find zone by the id specified.\");\n             throw ex;\n         }\n \n@@ -1122,38 +1114,10 @@ private void validateZone(Long zoneId, String errStr) throws ResourceInUseExcept\n             for (ClusterVO cluster : clusters) {\n                 if (cluster.getHypervisorType().equals(HypervisorType.VMware)) {\n                     throw new ResourceInUseException(\"Zone has one or more clusters.\"\n-                        + \" Can't \" + errStr + \" which already has clusters.\");\n-                }\n-            }\n-        }\n-    }\n-\n-    private URI getUri(String url) throws InvalidParameterValueException {\n-        if (url == null) {\n-            throw new InvalidParameterValueException(\"Invalid url.\");\n-        }\n-\n-        URI uri = null;\n-        try {\n-            uri = new URI(UriUtils.encodeURIComponent(url));\n-            if (uri.getScheme() == null) {\n-                throw new InvalidParameterValueException(\n-                        \"uri.scheme is null \" + url\n-                                + \", add http:// as a prefix\");\n-            } else if (uri.getScheme().equalsIgnoreCase(\"http\")) {\n-                if (uri.getHost() == null\n-                        || uri.getHost().equalsIgnoreCase(\"\")\n-                        || uri.getPath() == null\n-                        || uri.getPath().equalsIgnoreCase(\"\")) {\n-                    throw new InvalidParameterValueException(\n-                            \"Your host and/or path is wrong.  Make sure it's of the format http://hostname/path\");\n+                            + \" Can't \" + errStr + \" which already has clusters.\");\n                 }\n             }\n-        } catch (URISyntaxException e) {\n-            throw new InvalidParameterValueException(url\n-                    + \" is not a valid uri\");\n         }\n-        return uri;\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java",
                "sha": "a604392f7a9c1afc40fd232be7983ca68f7ecffb",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/src/org/apache/cloudstack/api/command/admin/zone/AddVmwareDcCmd.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/org/apache/cloudstack/api/command/admin/zone/AddVmwareDcCmd.java?ref=58b57ca5dbe514c94469a28d2ebaf0474550ecec",
                "deletions": 4,
                "filename": "plugins/hypervisors/vmware/src/org/apache/cloudstack/api/command/admin/zone/AddVmwareDcCmd.java",
                "patch": "@@ -48,8 +48,8 @@\n     @Parameter(name=ApiConstants.NAME, type=CommandType.STRING, required=true, description=\"Name of VMware datacenter to be added to specified zone.\")\n     private String name;\n \n-    @Parameter(name=ApiConstants.URL, type=CommandType.STRING, required=false, description=\"The URL of vCenter.\")\n-    private String url;\n+    @Parameter(name=ApiConstants.VCENTER, type=CommandType.STRING, required=true, description=\"The name/ip of vCenter. Make sure it is IP address or full qualified domain name for host running vCenter server.\")\n+    private String vCenter;\n \n     @Parameter(name=ApiConstants.USERNAME, type=CommandType.STRING, required=false, description=\"The Username required to connect to resource.\")\n     private String username;\n@@ -64,8 +64,8 @@ public String getName() {\n         return name;\n     }\n \n-    public String getUrl() {\n-        return url;\n+    public String getVcenter() {\n+        return vCenter;\n     }\n \n     public String getUsername() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/src/org/apache/cloudstack/api/command/admin/zone/AddVmwareDcCmd.java",
                "sha": "317452b7b7f1b1f7267be009cf0911d5630e17d5",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/test/com/cloud/hypervisor/vmware/VmwareDatacenterApiUnitTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/test/com/cloud/hypervisor/vmware/VmwareDatacenterApiUnitTest.java?ref=58b57ca5dbe514c94469a28d2ebaf0474550ecec",
                "deletions": 2,
                "filename": "plugins/hypervisors/vmware/test/com/cloud/hypervisor/vmware/VmwareDatacenterApiUnitTest.java",
                "patch": "@@ -214,7 +214,7 @@ public void testSetUp() {\n         Mockito.when(_vmwareDcZoneMapDao.findByZoneId(1L)).thenReturn(null);\n         Mockito.when(_vmwareDcZoneMapDao.expunge(1L)).thenReturn(true);\n         Mockito.when(addCmd.getZoneId()).thenReturn(1L);\n-        Mockito.when(addCmd.getUrl()).thenReturn(url);\n+        Mockito.when(addCmd.getVcenter()).thenReturn(vCenterHost);\n         Mockito.when(addCmd.getUsername()).thenReturn(user);\n         Mockito.when(addCmd.getPassword()).thenReturn(password);\n         Mockito.when(addCmd.getName()).thenReturn(vmwareDcName);\n@@ -265,7 +265,7 @@ public void testAddVmwareDcWithNullPassword() throws ResourceInUseException, Ill\n \n     //@Test(expected = InvalidParameterValueException.class)\n     public void testAddVmwareDcWithNullUrl() throws ResourceInUseException, IllegalArgumentException, DiscoveryException, Exception {\n-        Mockito.when(addCmd.getUrl()).thenReturn(null);\n+        Mockito.when(addCmd.getVcenter()).thenReturn(null);\n         _vmwareDatacenterService.addVmwareDatacenter(addCmd);\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/58b57ca5dbe514c94469a28d2ebaf0474550ecec/plugins/hypervisors/vmware/test/com/cloud/hypervisor/vmware/VmwareDatacenterApiUnitTest.java",
                "sha": "de08c93c78a326fcc84cac52fe759a334fbcf8f9",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-2805 [VMware] addVmwareDc fails with NPE when non-existent DC name is passed to the API\nMade vcenter as required parameter to addVmwareDc API.\nRemoved stale parameter url from addVmwareDc API.\nImproved Exception handling, logging remote exception details.",
        "parent": "https://github.com/apache/cloudstack/commit/89fa121a0cfb2bca978d4c72a91c1ba33326af68",
        "repo": "cloudstack",
        "unit_tests": [
            "VmwareManagerImplTest.java"
        ]
    },
    "cloudstack_5a0ed87": {
        "bug_id": "cloudstack_5a0ed87",
        "commit": "https://github.com/apache/cloudstack/commit/5a0ed8764be12cbf028f829d2db1d1af01a8a283",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/5a0ed8764be12cbf028f829d2db1d1af01a8a283/utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java?ref=5a0ed8764be12cbf028f829d2db1d1af01a8a283",
                "deletions": 0,
                "filename": "utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java",
                "patch": "@@ -218,6 +218,9 @@ public static Response decodeSAMLResponse(String responseMessage)\n \n     public static String generateSAMLRequestSignature(String urlEncodedString, PrivateKey signingKey)\n             throws NoSuchAlgorithmException, SignatureException, InvalidKeyException, UnsupportedEncodingException {\n+        if (signingKey == null || urlEncodedString == null) {\n+            return null;\n+        }\n         String url = urlEncodedString + \"&SigAlg=\" + URLEncoder.encode(SignatureConstants.ALGO_ID_SIGNATURE_RSA_SHA1, HttpUtils.UTF_8);\n         Signature signature = Signature.getInstance(\"SHA1withRSA\");\n         signature.initSign(signingKey);",
                "raw_url": "https://github.com/apache/cloudstack/raw/5a0ed8764be12cbf028f829d2db1d1af01a8a283/utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java",
                "sha": "b085e49f4ea406208f323a41a9bc93ed2bb7a6a0",
                "status": "modified"
            }
        ],
        "message": "SAMLUtils: Fix NPE incase signature is generated with a null privateKey\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/a66127dfb12476d098dfbdcc12dbc0beb29c92ee",
        "repo": "cloudstack",
        "unit_tests": [
            "SAMLUtilsTest.java"
        ]
    },
    "cloudstack_5bee237": {
        "bug_id": "cloudstack_5bee237",
        "commit": "https://github.com/apache/cloudstack/commit/5bee237972b84cc8cb5b588cb1dca95cc98ab8e4",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/5bee237972b84cc8cb5b588cb1dca95cc98ab8e4/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java?ref=5bee237972b84cc8cb5b588cb1dca95cc98ab8e4",
                "deletions": 6,
                "filename": "agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "patch": "@@ -1988,12 +1988,6 @@ protected Answer execute(StopCommand cmd) {\n         try {\n         \tConnect conn = LibvirtConnection.getConnection();\n         \t\n-        \tString macAddress = null;\n-        \tif (vmName.startsWith(\"i-\")) {\n-        \t    List<InterfaceDef> nics = getInterfaces(conn, vmName);\n-        \t    macAddress = nics.get(0).getMacAddress();\n-        \t}\n-        \t\n         \tdestroy_network_rules_for_vm(conn, vmName);\n             String result = stopVM(conn, vmName, defineOps.UNDEFINE_VM);\n             ",
                "raw_url": "https://github.com/apache/cloudstack/raw/5bee237972b84cc8cb5b588cb1dca95cc98ab8e4/agent/src/com/cloud/agent/resource/computing/LibvirtComputingResource.java",
                "sha": "0caa6ff15e581dbb0b809fe2f4791aae926e681d",
                "status": "modified"
            }
        ],
        "message": "fix NPE when stopvm",
        "parent": "https://github.com/apache/cloudstack/commit/902f8172e39d7b007168a0537fa3f4d26ba163d4",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_5c2bbf4": {
        "bug_id": "cloudstack_5c2bbf4",
        "commit": "https://github.com/apache/cloudstack/commit/5c2bbf48f0cdcf3988193e679c2089a6527f11ee",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/5c2bbf48f0cdcf3988193e679c2089a6527f11ee/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=5c2bbf48f0cdcf3988193e679c2089a6527f11ee",
                "deletions": 2,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1789,8 +1789,11 @@ public AsyncJobResponse createAsyncJobResponse(AsyncJob job) {\n         jobResponse.setCmd(job.getCmd());\n         jobResponse.setCreated(job.getCreated());\n         jobResponse.setId(job.getId());\n-        jobResponse.setJobInstanceId(job.getInstanceId());\n-        jobResponse.setJobInstanceType(job.getInstanceType().toString());\n+\n+        if (job.getInstanceType() != null && job.getInstanceId() != null) {\n+            jobResponse.setJobInstanceId(job.getInstanceId());\n+            jobResponse.setJobInstanceType(job.getInstanceType().toString());\n+        } \n         jobResponse.setJobProcStatus(job.getProcessStatus());\n         jobResponse.setJobResult((ResponseObject)ApiSerializerHelper.fromSerializedString(job.getResult()));\n         jobResponse.setJobResultCode(job.getResultCode());",
                "raw_url": "https://github.com/apache/cloudstack/raw/5c2bbf48f0cdcf3988193e679c2089a6527f11ee/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "ebb447ad075385384b2bb3720953b77c297c1ced",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in listAsyncJob apis: don't include instanceId/instanceType in the response when these values are null",
        "parent": "https://github.com/apache/cloudstack/commit/c6fe6f2f45a63e36375813e85ba49b891b198437",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_5f06654": {
        "bug_id": "cloudstack_5f06654",
        "commit": "https://github.com/apache/cloudstack/commit/5f06654b389db31179858f785735db8c99d45764",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/5f06654b389db31179858f785735db8c99d45764/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=5f06654b389db31179858f785735db8c99d45764",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -2441,7 +2441,12 @@ public boolean deleteVolume(DeleteVolumeCmd cmd) throws ConcurrentOperationExcep\n             destroyVolume(volume);\n         }\n         \n-        expungeVolume(volume);\n+        try {\n+\t\t\texpungeVolume(volume);\n+\t\t} catch (Exception e) {\n+\t\t\ts_logger.warn(\"Failed to expunge volume:\"+e);\n+\t\t\treturn false;\n+\t\t}\n         \n         return true;\n \t}",
                "raw_url": "https://github.com/apache/cloudstack/raw/5f06654b389db31179858f785735db8c99d45764/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "550bc7cdcbc350d039e17beddb4a263ff873de88",
                "status": "modified"
            }
        ],
        "message": "bug 7960: the npe should be fixed with my previous fix. adding better logging and some exception handling\nstatus 7960: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/9f9b838c4118aaea5cc6e5b577740003c5b15900",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_62a71e0": {
        "bug_id": "cloudstack_62a71e0",
        "commit": "https://github.com/apache/cloudstack/commit/62a71e055bbd69a195258f6fc871378070efdcc2",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/62a71e055bbd69a195258f6fc871378070efdcc2/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java?ref=62a71e055bbd69a195258f6fc871378070efdcc2",
                "deletions": 2,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "patch": "@@ -300,6 +300,11 @@ public int compare(NicTO arg0, NicTO arg1) {\n     public Pair<Boolean, Long> getCommandHostDelegation(long hostId, Command cmd) {\n         boolean needDelegation = false;\n \n+        HostVO host = _hostDao.findById(hostId);\n+        if (host.getHypervisorType() != HypervisorType.VMware) {\n+            return new Pair<Boolean, Long>(Boolean.FALSE, new Long(hostId));\n+        }\n+\n         if (cmd instanceof CopyCommand) {\n             CopyCommand cpyCommand = (CopyCommand)cmd;\n             DataTO srcData = cpyCommand.getSrcTO();\n@@ -343,9 +348,7 @@ public int compare(NicTO arg0, NicTO arg1) {\n             return new Pair<Boolean, Long>(Boolean.FALSE, new Long(hostId));\n         }\n \n-        HostVO host = _hostDao.findById(hostId);\n         long dcId = host.getDataCenterId();\n-\n         Pair<HostVO, SecondaryStorageVmVO> cmdTarget = _secStorageMgr.assignSecStorageVm(dcId, cmd);\n         if(cmdTarget != null) {\n             // TODO, we need to make sure agent is actually connected too",
                "raw_url": "https://github.com/apache/cloudstack/raw/62a71e055bbd69a195258f6fc871378070efdcc2/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "sha": "7d0c12a9433723284f448128c3a3b51bbacb8274",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3937: Attaching uploaded volume is failing\nThe method getCommandHostDelegation(long hostId, Command cmid) got overidden in VmwareGuru.java as part of\ncommit bfe30cd2e31906365a306d87fe331ccdcec5c33c. Earlier there was no HV specific implementation and copy\nvolume from secondary to primary worked fine. With the Vmware specific change the code was getting hit even\nin case of XS and other hypervisors and failed with NPE.\nNow there is a check in the Vmware implementation to check if the HV is of type Vmware.",
        "parent": "https://github.com/apache/cloudstack/commit/452176c0b43c9122e73f89d6ccd86cb36823ec68",
        "repo": "cloudstack",
        "unit_tests": [
            "VMwareGuruTest.java"
        ]
    },
    "cloudstack_6397f1c": {
        "bug_id": "cloudstack_6397f1c",
        "commit": "https://github.com/apache/cloudstack/commit/6397f1c82ef52fb23b4040f8836b3757cce63769",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/6397f1c82ef52fb23b4040f8836b3757cce63769/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=6397f1c82ef52fb23b4040f8836b3757cce63769",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -290,7 +290,7 @@\n     }\n \n     public void setHostAllocators(List<HostAllocator> hostAllocators) {\n-        hostAllocators = hostAllocators;\n+        this.hostAllocators = hostAllocators;\n     }\n \n     protected List<StoragePoolAllocator> _storagePoolAllocators;",
                "raw_url": "https://github.com/apache/cloudstack/raw/6397f1c82ef52fb23b4040f8836b3757cce63769/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "db3e7c2f695b58895e7cbb0f672374e0148db056",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6329 [Automation] Changing service offering of VM from medium to small failing with NPE\n\n- The hostAllocators were not getting set",
        "parent": "https://github.com/apache/cloudstack/commit/7819775bb81f713d564ba0f49d67044885e03998",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_640a3dc": {
        "bug_id": "cloudstack_640a3dc",
        "commit": "https://github.com/apache/cloudstack/commit/640a3dc239a2f5fb8ad03ee6792a166d48c67c7d",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/640a3dc239a2f5fb8ad03ee6792a166d48c67c7d/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=640a3dc239a2f5fb8ad03ee6792a166d48c67c7d",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -4535,7 +4535,9 @@ public UserAccount authenticateUser(String username, String password, Long domai\n     @Override\n     public void logoutUser(Long userId) {\n         UserAccount userAcct = _userAccountDao.findById(userId);\n-        EventUtils.saveEvent(userId, userAcct.getAccountId(), EventTypes.EVENT_USER_LOGOUT, \"user has logged out\");\n+        if (userAcct != null) {\n+            EventUtils.saveEvent(userId, userAcct.getAccountId(), EventTypes.EVENT_USER_LOGOUT, \"user has logged out\");\n+        } // else log some kind of error event?  This likely means the user doesn't exist, or has been deleted...\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/640a3dc239a2f5fb8ad03ee6792a166d48c67c7d/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "adf6fc98160419e719dfe52863257520fe26d885",
                "status": "modified"
            }
        ],
        "message": "bug 6818:  if the userAccount is null, the user is either removed or does not exist.  Since we can't log them out in those cases, just skip saving the logout event (and hence avoid the NPE).\n\nstatus 6818: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/e2f725308d5e372a954c2be618a318b28e807aa6",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_64e938b": {
        "bug_id": "cloudstack_64e938b",
        "commit": "https://github.com/apache/cloudstack/commit/64e938b7014da9994185dfe80120254cd96d4f7a",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/64e938b7014da9994185dfe80120254cd96d4f7a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java?ref=64e938b7014da9994185dfe80120254cd96d4f7a",
                "deletions": 6,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "patch": "@@ -6232,11 +6232,11 @@ private long getVMSnapshotChainSize(Connection conn, VolumeObjectTO volumeTo, St\n                     // add size of snapshot vdi node, usually this only contains meta data\n                     size = size + vdi.getPhysicalUtilisation(conn);\n                     // add size of snapshot vdi parent, this contains data\n-                    if (parentVDI != null)\n+                    if (!isRefNull(parentVDI))\n                         size = size + parentVDI.getPhysicalUtilisation(conn).longValue();\n                 }\n             } catch (Exception e) {\n-                s_logger.debug(\"Exception occurs when calculate \" + \"snapshot capacity for volumes: \" + e.getMessage());\n+                s_logger.debug(\"Exception occurs when calculate snapshot capacity for volumes: due to \" + e.toString());\n                 continue;\n             }\n         }\n@@ -6248,13 +6248,17 @@ private long getVMSnapshotChainSize(Connection conn, VolumeObjectTO volumeTo, St\n                     try {\n                         String vName = vmr.getNameLabel(conn);\n                         if (vName != null && vName.contains(vmName) && vmr.getIsASnapshot(conn)) {\n-\n                             VDI memoryVDI = vmr.getSuspendVDI(conn);\n-                            size = size + memoryVDI.getParent(conn).getPhysicalUtilisation(conn);\n-                            size = size + memoryVDI.getPhysicalUtilisation(conn);\n+                            if (!isRefNull(memoryVDI)) {\n+                                size = size + memoryVDI.getPhysicalUtilisation(conn);\n+                                VDI pMemoryVDI = memoryVDI.getParent(conn);\n+                                if (!isRefNull(pMemoryVDI)) {\n+                                    size = size + pMemoryVDI.getPhysicalUtilisation(conn);\n+                                }\n+                            }\n                         }\n                     } catch (Exception e) {\n-                        s_logger.debug(\"Exception occurs when calculate \" + \"snapshot capacity for memory: \" + e.getMessage());\n+                        s_logger.debug(\"Exception occurs when calculate snapshot capacity for memory: due to \" + e.toString());\n                         continue;\n                     }\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/64e938b7014da9994185dfe80120254cd96d4f7a/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "sha": "a90f99d0fc2e7665c66efdb21efdb918474b697b",
                "status": "modified"
            }
        ],
        "message": "fixed NPE on calculating vm snasphot volume size\n\n(cherry picked from commit 95c7ffbd46f9f674b8813a7b992c17019eb00137)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/86fe713ab9ca40f0be1b0d6a8142352a54dc6079",
        "repo": "cloudstack",
        "unit_tests": [
            "CitrixResourceBaseTest.java"
        ]
    },
    "cloudstack_66fc7c6": {
        "bug_id": "cloudstack_66fc7c6",
        "commit": "https://github.com/apache/cloudstack/commit/66fc7c62f4b21e770ecc6d6dfa99b3b06f410e89",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/66fc7c62f4b21e770ecc6d6dfa99b3b06f410e89/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=66fc7c62f4b21e770ecc6d6dfa99b3b06f410e89",
                "deletions": 4,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1013,10 +1013,12 @@ protected void updateRoutersRedundantState(final List<DomainRouterVO> routers) {\n                         s_logger.warn(\"Unable to update router \" + router.getHostName() + \"'s status\");\n                     }\n                     RedundantState state = RedundantState.UNKNOWN;\n-                    if (answer != null && answer.getResult()) {\n-                        state = answer.getState();\n-                    } else {\n-                        s_logger.info(\"Agent response doesn't seem to be correct ==> \" + answer.getResult());\n+                    if (answer != null) {\n+                        if (answer.getResult()) {\n+                            state = answer.getState();\n+                        } else {\n+                            s_logger.info(\"Agent response doesn't seem to be correct ==> \" + answer.getResult());\n+                        }\n                     }\n                     router.setRedundantState(state);\n                     updated = true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/66fc7c62f4b21e770ecc6d6dfa99b3b06f410e89/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "ca1f67dbb69b7b98ae38a851e54398cd05075875",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9055: fix NPE in updating Redundant State of VPC networks",
        "parent": "https://github.com/apache/cloudstack/commit/f6db0a2a4948753c9ff584c20b5ae45ada6486f4",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_6715f98": {
        "bug_id": "cloudstack_6715f98",
        "commit": "https://github.com/apache/cloudstack/commit/6715f98087541440f1737912f15d9e3408793834",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/6715f98087541440f1737912f15d9e3408793834/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=6715f98087541440f1737912f15d9e3408793834",
                "deletions": 0,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -770,6 +770,13 @@ public S3 discoverS3(final AddS3Cmd cmd) throws DiscoveryException {\n                 }\n             }\n             clusterId = cluster.getId();\n+            if (_clusterDetailsDao.findDetail(clusterId,\"cpuOvercommitRatio\") == null) {\n+            ClusterDetailsVO cluster_cpu_detail = new ClusterDetailsVO(clusterId,\"cpuOvercommitRatio\",\"1\");\n+            ClusterDetailsVO cluster_memory_detail = new ClusterDetailsVO(clusterId,\"memoryOvercommitRatio\",\"1\");\n+            _clusterDetailsDao.persist(cluster_cpu_detail);\n+            _clusterDetailsDao.persist(cluster_memory_detail);\n+            }\n+\n         }\n \n         try {",
                "raw_url": "https://github.com/apache/cloudstack/raw/6715f98087541440f1737912f15d9e3408793834/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "15d32e0640d377d50d54983dabca2d0f322e85af",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-1551: Failed to list clusters due to NPE at createClusterResponse(ApiResponseHelper.java:837) when cluster is added automatically as a part of addHostCommand\n\nSigned-off-by: Abhinandan Prateek <aprateek@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/27b753a434de087a9cd8ec50bfa1deb2de7a7925",
        "repo": "cloudstack",
        "unit_tests": [
            "ResourceManagerImplTest.java"
        ]
    },
    "cloudstack_6765e97": {
        "bug_id": "cloudstack_6765e97",
        "commit": "https://github.com/apache/cloudstack/commit/6765e9797678a9867f113f42b0fcf7caf83aba2a",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/6765e9797678a9867f113f42b0fcf7caf83aba2a/api/src/com/cloud/api/ResponseGenerator.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/api/ResponseGenerator.java?ref=6765e9797678a9867f113f42b0fcf7caf83aba2a",
                "deletions": 12,
                "filename": "api/src/com/cloud/api/ResponseGenerator.java",
                "patch": "@@ -12,7 +12,7 @@\n  * GNU General Public License for more details.\n  * \n  * You should have received a copy of the GNU General Public License\n- * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ * aLong with this program.  If not, see <http://www.gnu.org/licenses/>.\n  * \n  */\n package com.cloud.api;\n@@ -147,17 +147,17 @@\n \n     SystemVmResponse createSystemVm2Response(VirtualMachine systemVM);\n \n-    void synchronizeCommand(Object job, String syncObjType, long syncObjId);\n+    void synchronizeCommand(Object job, String syncObjType, Long syncObjId);\n \n-    User findUserById(long userId);\n+    User findUserById(Long userId);\n \n-    UserVm findUserVmById(long vmId);\n+    UserVm findUserVmById(Long vmId);\n \n-    Volume findVolumeById(long volumeId);\n+    Volume findVolumeById(Long volumeId);\n \n-    Account findAccountByNameDomain(String accountName, long domainId);\n+    Account findAccountByNameDomain(String accountName, Long domainId);\n \n-    VirtualMachineTemplate findTemplateById(long templateId);\n+    VirtualMachineTemplate findTemplateById(Long templateId);\n \n     VpnUsersResponse createVpnUserResponse(VpnUser user);\n \n@@ -174,17 +174,17 @@ void createTemplateResponse(List<TemplateResponse> responses, VirtualMachineTemp\n \n     NetworkGroupResponse createNetworkGroupResponse(NetworkGroup group);\n \n-    ExtractResponse createExtractResponse(long uploadId, long id, long zoneId, long accountId, String mode);\n+    ExtractResponse createExtractResponse(Long uploadId, Long id, Long zoneId, Long accountId, String mode);\n \n-    TemplateResponse createTemplateResponse(VirtualMachineTemplate template, long destZoneId);\n+    TemplateResponse createTemplateResponse(VirtualMachineTemplate template, Long destZoneId);\n \n-    TemplateResponse createIsoResponse3(VirtualMachineTemplate iso, long destZoneId);\n+    TemplateResponse createIsoResponse3(VirtualMachineTemplate iso, Long destZoneId);\n \n     String toSerializedString(CreateCmdResponse response, String responseType);\n \n     AsyncJobResponse createAsyncJobResponse(AsyncJob job);\n \n-    TemplateResponse createTemplateResponse(VirtualMachineTemplate template, Long snapshotId, long volumeId);\n+    TemplateResponse createTemplateResponse(VirtualMachineTemplate template, Long snapshotId, Long volumeId);\n \n     EventResponse createEventResponse(Event event);\n \n@@ -195,7 +195,7 @@ void createTemplateResponse(List<TemplateResponse> responses, VirtualMachineTemp\n \n     List<CapacityResponse> createCapacityResponse(List<? extends Capacity> result, DecimalFormat format);\n \n-    TemplatePermissionsResponse createTemplatePermissionsResponse(List<String> accountNames, long id, boolean isAdmin);\n+    TemplatePermissionsResponse createTemplatePermissionsResponse(List<String> accountNames, Long id, boolean isAdmin);\n \n     AsyncJobResponse queryJobResult(QueryAsyncJobResultCmd cmd);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/6765e9797678a9867f113f42b0fcf7caf83aba2a/api/src/com/cloud/api/ResponseGenerator.java",
                "sha": "504054b22a724f7a32e5dc65d6458392aa19140b",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/6765e9797678a9867f113f42b0fcf7caf83aba2a/api/src/com/cloud/api/commands/DetachIsoCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/api/commands/DetachIsoCmd.java?ref=6765e9797678a9867f113f42b0fcf7caf83aba2a",
                "deletions": 1,
                "filename": "api/src/com/cloud/api/commands/DetachIsoCmd.java",
                "patch": "@@ -40,7 +40,7 @@\n     //////////////// API parameters /////////////////////\n     /////////////////////////////////////////////////////\n \n-    @Parameter(name=ApiConstants.VIRTUAL_MACHINE_ID, type=CommandType.LONG, required=true, description=\"\tThe ID of the virtual machine\")\n+    @Parameter(name=ApiConstants.VIRTUAL_MACHINE_ID, type=CommandType.LONG, required=true, description=\"The ID of the virtual machine\")\n     private Long virtualMachineId;\n \n     /////////////////////////////////////////////////////",
                "raw_url": "https://github.com/apache/cloudstack/raw/6765e9797678a9867f113f42b0fcf7caf83aba2a/api/src/com/cloud/api/commands/DetachIsoCmd.java",
                "sha": "44b78ff4e8ed82ee4a5f1da464c1487069a627f8",
                "status": "modified"
            },
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/cloudstack/blob/6765e9797678a9867f113f42b0fcf7caf83aba2a/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 96,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=6765e9797678a9867f113f42b0fcf7caf83aba2a",
                "deletions": 48,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -12,7 +12,7 @@\n  * GNU General Public License for more details.\n  * \n  * You should have received a copy of the GNU General Public License\n- * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ * aLong with this program.  If not, see <http://www.gnu.org/licenses/>.\n  * \n  */\n package com.cloud.api;\n@@ -188,11 +188,11 @@ public AccountResponse createAccountResponse(Account account) {\n             throw new ServerApiException(BaseCmd.INTERNAL_ERROR, \"Internal error searching for user stats\");\n         }\n \n-        long bytesSent = 0;\n-        long bytesReceived = 0;\n+        Long bytesSent = 0L;\n+        Long bytesReceived = 0L;\n         for (UserStatisticsVO stat : stats) {\n-            long rx = stat.getNetBytesReceived() + stat.getCurrentBytesReceived();\n-            long tx = stat.getNetBytesSent() + stat.getCurrentBytesSent();\n+            Long rx = stat.getNetBytesReceived() + stat.getCurrentBytesReceived();\n+            Long tx = stat.getNetBytesSent() + stat.getCurrentBytesSent();\n             bytesReceived = bytesReceived + Long.valueOf(rx);\n             bytesSent = bytesSent + Long.valueOf(tx);\n         }\n@@ -201,41 +201,41 @@ public AccountResponse createAccountResponse(Account account) {\n \n         // Get resource limits and counts\n \n-        long vmLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.user_vm, account.getId());\n+        Long vmLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.user_vm, account.getId());\n         String vmLimitDisplay = (accountIsAdmin || vmLimit == -1) ? \"Unlimited\" : String.valueOf(vmLimit);\n-        long vmTotal = ApiDBUtils.getResourceCount(ResourceType.user_vm, account.getId());\n+        Long vmTotal = ApiDBUtils.getResourceCount(ResourceType.user_vm, account.getId());\n         String vmAvail = (accountIsAdmin || vmLimit == -1) ? \"Unlimited\" : String.valueOf(vmLimit - vmTotal);\n         accountResponse.setVmLimit(vmLimitDisplay);\n         accountResponse.setVmTotal(vmTotal);\n         accountResponse.setVmAvailable(vmAvail);\n \n-        long ipLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.public_ip, account.getId());\n+        Long ipLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.public_ip, account.getId());\n         String ipLimitDisplay = (accountIsAdmin || ipLimit == -1) ? \"Unlimited\" : String.valueOf(ipLimit);\n-        long ipTotal = ApiDBUtils.getResourceCount(ResourceType.public_ip, account.getId());\n+        Long ipTotal = ApiDBUtils.getResourceCount(ResourceType.public_ip, account.getId());\n         String ipAvail = (accountIsAdmin || ipLimit == -1) ? \"Unlimited\" : String.valueOf(ipLimit - ipTotal);\n         accountResponse.setIpLimit(ipLimitDisplay);\n         accountResponse.setIpTotal(ipTotal);\n         accountResponse.setIpAvailable(ipAvail);\n \n-        long volumeLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.volume, account.getId());\n+        Long volumeLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.volume, account.getId());\n         String volumeLimitDisplay = (accountIsAdmin || volumeLimit == -1) ? \"Unlimited\" : String.valueOf(volumeLimit);\n-        long volumeTotal = ApiDBUtils.getResourceCount(ResourceType.volume, account.getId());\n+        Long volumeTotal = ApiDBUtils.getResourceCount(ResourceType.volume, account.getId());\n         String volumeAvail = (accountIsAdmin || volumeLimit == -1) ? \"Unlimited\" : String.valueOf(volumeLimit - volumeTotal);\n         accountResponse.setVolumeLimit(volumeLimitDisplay);\n         accountResponse.setVolumeTotal(volumeTotal);\n         accountResponse.setVolumeAvailable(volumeAvail);\n \n-        long snapshotLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.snapshot, account.getId());\n+        Long snapshotLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.snapshot, account.getId());\n         String snapshotLimitDisplay = (accountIsAdmin || snapshotLimit == -1) ? \"Unlimited\" : String.valueOf(snapshotLimit);\n-        long snapshotTotal = ApiDBUtils.getResourceCount(ResourceType.snapshot, account.getId());\n+        Long snapshotTotal = ApiDBUtils.getResourceCount(ResourceType.snapshot, account.getId());\n         String snapshotAvail = (accountIsAdmin || snapshotLimit == -1) ? \"Unlimited\" : String.valueOf(snapshotLimit - snapshotTotal);\n         accountResponse.setSnapshotLimit(snapshotLimitDisplay);\n         accountResponse.setSnapshotTotal(snapshotTotal);\n         accountResponse.setSnapshotAvailable(snapshotAvail);\n \n-        long templateLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.template, account.getId());\n+        Long templateLimit = ApiDBUtils.findCorrectResourceLimit(ResourceType.template, account.getId());\n         String templateLimitDisplay = (accountIsAdmin || templateLimit == -1) ? \"Unlimited\" : String.valueOf(templateLimit);\n-        long templateTotal = ApiDBUtils.getResourceCount(ResourceType.template, account.getId());\n+        Long templateTotal = ApiDBUtils.getResourceCount(ResourceType.template, account.getId());\n         String templateAvail = (accountIsAdmin || templateLimit == -1) ? \"Unlimited\" : String.valueOf(templateLimit - templateTotal);\n         accountResponse.setTemplateLimit(templateLimitDisplay);\n         accountResponse.setTemplateTotal(templateTotal);\n@@ -483,7 +483,7 @@ public UserVmResponse createUserVmResponse(UserVm userVm) {\n \n         // ISO Info\n         if (userVm.getIsoId() != null) {\n-            VMTemplateVO iso = ApiDBUtils.findTemplateById(userVm.getIsoId().longValue());\n+            VMTemplateVO iso = ApiDBUtils.findTemplateById(userVm.getIsoId());\n             if (iso != null) {\n                 userVmResponse.setIsoId(userVm.getIsoId());\n                 userVmResponse.setIsoName(iso.getName());\n@@ -519,10 +519,10 @@ public UserVmResponse createUserVmResponse(UserVm userVm) {\n             cpuUsed = decimalFormat.format(cpuUtil) + \"%\";\n             userVmResponse.setCpuUsed(cpuUsed);\n \n-            long networkKbRead = (long) vmStats.getNetworkReadKBs();\n+            Long networkKbRead = Double.doubleToLongBits(vmStats.getNetworkReadKBs());\n             userVmResponse.setNetworkKbsRead(networkKbRead);\n \n-            long networkKbWrite = (long) vmStats.getNetworkWriteKBs();\n+            Long networkKbWrite = Double.doubleToLongBits(vmStats.getNetworkWriteKBs());\n             userVmResponse.setNetworkKbsWrite(networkKbWrite);\n         }\n \n@@ -702,16 +702,16 @@ public HostResponse createHostResponse(Host host) {\n             float cpuUtil = (float) hostStats.getCpuUtilization();\n             cpuUsed = decimalFormat.format(cpuUtil) + \"%\";\n             hostResponse.setCpuUsed(cpuUsed);\n-            hostResponse.setAverageLoad((long) hostStats.getAverageLoad());\n-            hostResponse.setNetworkKbsRead((long) hostStats.getNetworkReadKBs());\n-            hostResponse.setNetworkKbsWrite((long) hostStats.getNetworkWriteKBs());\n+            hostResponse.setAverageLoad(Double.doubleToLongBits(hostStats.getAverageLoad()));\n+            hostResponse.setNetworkKbsRead(Double.doubleToLongBits(hostStats.getNetworkReadKBs()));\n+            hostResponse.setNetworkKbsWrite(Double.doubleToLongBits(hostStats.getNetworkWriteKBs()));\n         }\n \n         if (host.getType() == Host.Type.Routing) {\n             hostResponse.setMemoryTotal(host.getTotalMemory());\n \n             // calculate memory allocated by systemVM and userVm\n-            long mem = ApiDBUtils.getMemoryUsagebyHost(host.getId());\n+            Long mem = ApiDBUtils.getMemoryUsagebyHost(host.getId());\n             hostResponse.setMemoryAllocated(mem);\n             hostResponse.setMemoryUsed(mem);\n         } else if (host.getType().toString().equals(\"Storage\")) {\n@@ -1028,9 +1028,9 @@ public StoragePoolResponse createStoragePoolResponse(StoragePool pool) {\n         }\n \n         StorageStats stats = ApiDBUtils.getStoragePoolStatistics(pool.getId());\n-        long capacity = pool.getCapacityBytes();\n-        long available = pool.getAvailableBytes();\n-        long used = capacity - available;\n+        Long capacity = pool.getCapacityBytes();\n+        Long available = pool.getAvailableBytes();\n+        Long used = capacity - available;\n \n         if (stats != null) {\n             used = stats.getByteUsed();\n@@ -1177,7 +1177,7 @@ public UserVmResponse createUserVm2Response(UserVm userVm) {\n \n         // ISO Info\n         if (userVm.getIsoId() != null) {\n-            VMTemplateVO iso = ApiDBUtils.findTemplateById(userVm.getIsoId().longValue());\n+            VMTemplateVO iso = ApiDBUtils.findTemplateById(userVm.getIsoId());\n             if (iso != null) {\n                 userVmResponse.setIsoId(userVm.getIsoId());\n                 userVmResponse.setIsoName(iso.getName());\n@@ -1212,10 +1212,10 @@ public UserVmResponse createUserVm2Response(UserVm userVm) {\n             cpuUsed = decimalFormat.format(cpuUtil) + \"%\";\n             userVmResponse.setCpuUsed(cpuUsed);\n \n-            long networkKbRead = (long) vmStats.getNetworkReadKBs();\n+            Long networkKbRead = Double.doubleToLongBits(vmStats.getNetworkReadKBs());\n             userVmResponse.setNetworkKbsRead(networkKbRead);\n \n-            long networkKbWrite = (long) vmStats.getNetworkWriteKBs();\n+            Long networkKbWrite = Double.doubleToLongBits(vmStats.getNetworkWriteKBs());\n             userVmResponse.setNetworkKbsWrite(networkKbWrite);\n         }\n \n@@ -1225,7 +1225,7 @@ public UserVmResponse createUserVm2Response(UserVm userVm) {\n \n         List<? extends Nic> nics = ApiDBUtils.getNics(userVm);\n         for (Nic singleNic : nics) {\n-            long configId = singleNic.getNetworkId();\n+            Long configId = singleNic.getNetworkId();\n             Network networkConf = ApiDBUtils.getNetwork(configId);\n             if (networkConf.getTrafficType() == TrafficType.Guest) {\n                 userVmResponse.setIpAddress(singleNic.getIp4Address());\n@@ -1268,7 +1268,7 @@ public DomainRouterResponse createDomainRouter2Response(VirtualRouter router) {\n \n         List<? extends Nic> nics = ApiDBUtils.getNics(router);\n         for (Nic singleNic : nics) {\n-            long configId = singleNic.getNetworkId();\n+            Long configId = singleNic.getNetworkId();\n             Network networkConf = ApiDBUtils.getNetwork(configId);\n \n             if (networkConf.getTrafficType() == TrafficType.Guest) {\n@@ -1359,7 +1359,7 @@ public SystemVmResponse createSystemVm2Response(VirtualMachine systemVM) {\n \n             List<? extends Nic> nics = ApiDBUtils.getNics(systemVM);\n             for (Nic singleNic : nics) {\n-                long configId = singleNic.getNetworkId();\n+                Long configId = singleNic.getNetworkId();\n                 Network networkConf = ApiDBUtils.getNetwork(configId);\n \n                 if (networkConf.getTrafficType() == TrafficType.Management) {\n@@ -1382,33 +1382,33 @@ public SystemVmResponse createSystemVm2Response(VirtualMachine systemVM) {\n     }\n     \n     @Override\n-    public void synchronizeCommand(Object job, String syncObjType, long syncObjId) {\n+    public void synchronizeCommand(Object job, String syncObjType, Long syncObjId) {\n         ApiDBUtils.synchronizeCommand(job, syncObjType, syncObjId);\n     }\n     \n     @Override\n-    public User findUserById(long userId) {\n+    public User findUserById(Long userId) {\n         return ApiDBUtils.findUserById(userId);\n     }\n     \n     @Override\n-    public UserVm findUserVmById(long vmId) {\n+    public UserVm findUserVmById(Long vmId) {\n         return ApiDBUtils.findUserVmById(vmId);\n \n     }\n \n     @Override\n-    public Volume findVolumeById(long volumeId) {\n+    public Volume findVolumeById(Long volumeId) {\n         return ApiDBUtils.findVolumeById(volumeId);\n     }\n     \n     @Override\n-    public Account findAccountByNameDomain(String accountName, long domainId) {\n+    public Account findAccountByNameDomain(String accountName, Long domainId) {\n         return ApiDBUtils.findAccountByNameDomain(accountName, domainId);        \n     }\n     \n     @Override\n-    public VirtualMachineTemplate findTemplateById(long templateId) {\n+    public VirtualMachineTemplate findTemplateById(Long templateId) {\n         return ApiDBUtils.findTemplateById(templateId);\n     }\n     \n@@ -1536,7 +1536,7 @@ public void createTemplateResponse(List<TemplateResponse> responses, VirtualMach\n                 }\n             }\n             \n-            long templateSize = templateHostRef.getSize();\n+            Long templateSize = templateHostRef.getSize();\n             if (templateSize > 0) {\n                 templateResponse.setSize(templateSize);\n             }\n@@ -1727,7 +1727,7 @@ public NetworkGroupResponse createNetworkGroupResponse(NetworkGroup group) {\n     }\n     \n     @Override\n-    public ExtractResponse createExtractResponse(long uploadId, long id, long zoneId, long accountId, String mode) {\n+    public ExtractResponse createExtractResponse(Long uploadId, Long id, Long zoneId, Long accountId, String mode) {\n         UploadVO uploadInfo = ApiDBUtils.findUploadById(uploadId);\n         ExtractResponse response = new ExtractResponse();\n         response.setObjectName(\"template\");\n@@ -1747,7 +1747,7 @@ public ExtractResponse createExtractResponse(long uploadId, long id, long zoneId\n     }\n \n     @Override\n-    public TemplateResponse createTemplateResponse(VirtualMachineTemplate template, long destZoneId) {\n+    public TemplateResponse createTemplateResponse(VirtualMachineTemplate template, Long destZoneId) {\n         TemplateResponse templateResponse = new TemplateResponse();\n         if (template != null) {\n             templateResponse.setId(template.getId());\n@@ -1821,7 +1821,7 @@ public TemplateResponse createTemplateResponse(VirtualMachineTemplate template,\n     }\n     \n     @Override\n-    public TemplateResponse createIsoResponse3(VirtualMachineTemplate iso, long destZoneId) {\n+    public TemplateResponse createIsoResponse3(VirtualMachineTemplate iso, Long destZoneId) {\n         TemplateResponse isoResponse = new TemplateResponse();\n         if (iso != null) {\n             isoResponse.setId(iso.getId());\n@@ -1917,7 +1917,7 @@ public AsyncJobResponse createAsyncJobResponse(AsyncJob job) {\n     }\n     \n     @Override\n-    public TemplateResponse createTemplateResponse(VirtualMachineTemplate template, Long snapshotId, long volumeId) {\n+    public TemplateResponse createTemplateResponse(VirtualMachineTemplate template, Long snapshotId, Long volumeId) {\n         TemplateResponse response = new TemplateResponse();\n         response.setId(template.getId());\n         response.setName(template.getName());\n@@ -2080,7 +2080,7 @@ public EventResponse createEventResponse(Event event) {\n                     }\n                 }\n \n-                long isoSize = isoHost.getSize();\n+                Long isoSize = isoHost.getSize();\n                 if (isoSize > 0) {\n                     isoResponse.setSize(isoSize);\n                 }\n@@ -2137,13 +2137,13 @@ public EventResponse createEventResponse(Event event) {\n             if (totalCapacity == null) {\n                 totalCapacity = new Long(capacity.getTotalCapacity());\n             } else {\n-                totalCapacity = new Long(capacity.getTotalCapacity() + totalCapacity.longValue());\n+                totalCapacity = new Long(capacity.getTotalCapacity() + totalCapacity);\n             }\n \n             if (usedCapacity == null) {\n                 usedCapacity = new Long(capacity.getUsedCapacity());\n             } else {\n-                usedCapacity = new Long(capacity.getUsedCapacity() + usedCapacity.longValue());\n+                usedCapacity = new Long(capacity.getUsedCapacity() + usedCapacity);\n             }\n \n             totalCapacityMap.put(key, totalCapacity);\n@@ -2156,13 +2156,13 @@ public EventResponse createEventResponse(Event event) {\n                 if (totalCapacity == null) {\n                     totalCapacity = new Long(capacity.getTotalCapacity());\n                 } else {\n-                    totalCapacity = new Long(capacity.getTotalCapacity() + totalCapacity.longValue());\n+                    totalCapacity = new Long(capacity.getTotalCapacity() + totalCapacity);\n                 }\n \n                 if (usedCapacity == null) {\n                     usedCapacity = new Long(capacity.getUsedCapacity());\n                 } else {\n-                    usedCapacity = new Long(capacity.getUsedCapacity() + usedCapacity.longValue());\n+                    usedCapacity = new Long(capacity.getUsedCapacity() + usedCapacity);\n                 }\n \n                 totalCapacityMap.put(keyForPodTotal, totalCapacity);\n@@ -2224,7 +2224,7 @@ public EventResponse createEventResponse(Event event) {\n     }\n \n     @Override\n-    public TemplatePermissionsResponse createTemplatePermissionsResponse(List<String> accountNames, long id, boolean isAdmin) {\n+    public TemplatePermissionsResponse createTemplatePermissionsResponse(List<String> accountNames, Long id, boolean isAdmin) {\n         Long templateOwnerDomain = null;\n         VirtualMachineTemplate template = ApiDBUtils.findTemplateById(id);\n         if (isAdmin) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/6765e9797678a9867f113f42b0fcf7caf83aba2a/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "1205efcfdbd8deb35ab0deff11ab7799237bdbd1",
                "status": "modified"
            }
        ],
        "message": "Made ApiResponseHelper to use Long instead of long for response parameters to eliminate possible NPEs during building an api response.",
        "parent": "https://github.com/apache/cloudstack/commit/cdea2d210d07eb14d7a04a2b45a739bd5b0d025d",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_67e2f13": {
        "bug_id": "cloudstack_67e2f13",
        "commit": "https://github.com/apache/cloudstack/commit/67e2f130d02226f12e2d9f7f374e0d6f9e693793",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/67e2f130d02226f12e2d9f7f374e0d6f9e693793/server/src/com/cloud/server/StatsCollector.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=67e2f130d02226f12e2d9f7f374e0d6f9e693793",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -265,7 +265,10 @@ public void run() {\n                 ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\r\n                 for (HostVO host : hosts) {\r\n                     GetStorageStatsCommand command = new GetStorageStatsCommand(host.getStorageUrl());\n-        \t\t\tHostVO ssAhost = _agentMgr.getSSAgent(host);\n+                    HostVO ssAhost = _agentMgr.getSSAgent(host);\n+                    if (ssAhost == null) {\n+                        return;\n+                    }\n                     long hostId = host.getId();\r\n                     Answer answer = _agentMgr.easySend(ssAhost.getId(), command);\r\n                     if (answer != null && answer.getResult()) {\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/67e2f130d02226f12e2d9f7f374e0d6f9e693793/server/src/com/cloud/server/StatsCollector.java",
                "sha": "fb9a0104c87fe1d503a621719485444a16f5b692",
                "status": "modified"
            }
        ],
        "message": "fixed a NPE",
        "parent": "https://github.com/apache/cloudstack/commit/79f5ece7dc6c603ded3ab5faf3eb682960f1f44c",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_68b5440": {
        "bug_id": "cloudstack_68b5440",
        "commit": "https://github.com/apache/cloudstack/commit/68b5440d442aa5946cd3f37b6b7581e582946e68",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/68b5440d442aa5946cd3f37b6b7581e582946e68/framework/jobs/src/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/jobs/src/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java?ref=68b5440d442aa5946cd3f37b6b7581e582946e68",
                "deletions": 1,
                "filename": "framework/jobs/src/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java",
                "patch": "@@ -698,7 +698,7 @@ public String marshallResultObject(Serializable obj) {\n \n     @Override\n     public Object unmarshallResultObject(AsyncJob job) {\n-        if(job.getResult() != null)\n+        if(job != null && job.getResult() != null)\n             return JobSerializerHelper.fromObjectSerializedString(job.getResult());\n         return null;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/68b5440d442aa5946cd3f37b6b7581e582946e68/framework/jobs/src/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java",
                "sha": "e7d95a99c6abdaf6ce5af063d958c45edd8b9f34",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/68b5440d442aa5946cd3f37b6b7581e582946e68/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java?ref=68b5440d442aa5946cd3f37b6b7581e582946e68",
                "deletions": 0,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "patch": "@@ -4027,6 +4027,8 @@ public int compare(DiskTO arg0, DiskTO arg1) {\n                             diskdef.defBlockBasedDisk(device, devId, DiskDef.diskBus.VIRTIO);\n                             diskdef.setQemuDriver(false);\n                             vm.getDevices().addDevice(diskdef);\n+                        } else {\n+                           throw new InternalErrorException(\"Error while mapping RBD device on host\");\n                         }\n                     }\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/68b5440d442aa5946cd3f37b6b7581e582946e68/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "sha": "f2b3c6341be84ab649c1816b4404a47e3c2b23bf",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/68b5440d442aa5946cd3f37b6b7581e582946e68/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java?ref=68b5440d442aa5946cd3f37b6b7581e582946e68",
                "deletions": 0,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "patch": "@@ -363,6 +363,9 @@ public KVMStoragePool getStoragePool(String uuid, boolean refreshInfo) {\n                 storage.create(0);\n             }\n             LibvirtStoragePoolDef spd = getStoragePoolDef(conn, storage);\n+            if (spd == null) {\n+                throw new CloudRuntimeException(\"Unable to parse the storage pool definition for storage pool \" + uuid);\n+            }\n             StoragePoolType type = null;\n             if (spd.getPoolType() == LibvirtStoragePoolDef.poolType.NETFS) {\n                 type = StoragePoolType.NetworkFilesystem;",
                "raw_url": "https://github.com/apache/cloudstack/raw/68b5440d442aa5946cd3f37b6b7581e582946e68/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "sha": "9da833e4595f621a0006810f0433c5ff93ea2408",
                "status": "modified"
            }
        ],
        "message": "fix NPE cases, throw exceptions early on\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/9658569f5ab15c528ebfe2b43bc02b43c297db85",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_694b723": {
        "bug_id": "cloudstack_694b723",
        "commit": "https://github.com/apache/cloudstack/commit/694b7238998a8f7b03662fe50017de9d80d969c0",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/694b7238998a8f7b03662fe50017de9d80d969c0/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java?ref=694b7238998a8f7b03662fe50017de9d80d969c0",
                "deletions": 1,
                "filename": "engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "patch": "@@ -190,7 +190,9 @@ public void processEvent(ObjectInDataStoreStateMachine.Event event, Answer answe\n                     TemplateObjectTO newTemplate = (TemplateObjectTO)cpyAnswer.getNewData();\n                     VMTemplateStoragePoolVO templatePoolRef = templatePoolDao.findByPoolTemplate(getDataStore().getId(), getId());\n                     templatePoolRef.setDownloadPercent(100);\n-                    templatePoolRef.setTemplateSize(newTemplate.getSize());\n+                    if (newTemplate.getSize() != null) {\n+                        templatePoolRef.setTemplateSize(newTemplate.getSize());\n+                    }\n                     templatePoolRef.setDownloadState(Status.DOWNLOADED);\n                     templatePoolRef.setLocalDownloadPath(newTemplate.getPath());\n                     templatePoolRef.setInstallPath(newTemplate.getPath());",
                "raw_url": "https://github.com/apache/cloudstack/raw/694b7238998a8f7b03662fe50017de9d80d969c0/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "sha": "c5ca5b9990af10cdf3ea6b9e3b3394545205fdb6",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/694b7238998a8f7b03662fe50017de9d80d969c0/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java?ref=694b7238998a8f7b03662fe50017de9d80d969c0",
                "deletions": 1,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java",
                "patch": "@@ -877,7 +877,9 @@ public Answer copyTemplateToPrimaryStorage(CopyCommand cmd) {\n \n                 newVol.setUuid(uuidToReturn);\n                 newVol.setPath(uuidToReturn);\n-                newVol.setSize(physicalSize);\n+                if (physicalSize != null) {\n+                    newVol.setSize(physicalSize);\n+                }\n                 newVol.setFormat(ImageFormat.VHD);\n \n                 return new CopyCmdAnswer(newVol);",
                "raw_url": "https://github.com/apache/cloudstack/raw/694b7238998a8f7b03662fe50017de9d80d969c0/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/XenServerStorageProcessor.java",
                "sha": "10a97a21c125c0c41edcee0ebf8d6e0a2c1a2cbc",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/694b7238998a8f7b03662fe50017de9d80d969c0/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java?ref=694b7238998a8f7b03662fe50017de9d80d969c0",
                "deletions": 1,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java",
                "patch": "@@ -292,7 +292,9 @@ public Answer copyTemplateToPrimaryStorage(CopyCommand cmd) {\n \n                 newVol.setUuid(uuidToReturn);\n                 newVol.setPath(uuidToReturn);\n-                newVol.setSize(physicalSize);\n+                if (physicalSize != null) {\n+                    newVol.setSize(physicalSize);\n+                }\n                 newVol.setFormat(Storage.ImageFormat.VHD);\n \n                 return new CopyCmdAnswer(newVol);",
                "raw_url": "https://github.com/apache/cloudstack/raw/694b7238998a8f7b03662fe50017de9d80d969c0/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/Xenserver625StorageProcessor.java",
                "sha": "c4f2dc916ea1fa185ea7d24c94133cca20327a2d",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8312: Fix NPE regression, copy template can have NULL volume size\n\nThe copy command reply can have null size returned, so check and set values\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit 53ca0b1861c743caf61ec04f776c87eac334f185)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/62a733e8cf7a2a29517d17c158a8271ce20a74cc",
        "repo": "cloudstack",
        "unit_tests": [
            "XenServerStorageProcessorTest.java",
            "Xenserver625StorageProcessorTest.java"
        ]
    },
    "cloudstack_6a18cdd": {
        "bug_id": "cloudstack_6a18cdd",
        "commit": "https://github.com/apache/cloudstack/commit/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/schema/src/com/cloud/storage/dao/VolumeDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/storage/dao/VolumeDao.java?ref=6a18cdd6ef969cca3a063356d4a9a68163b5ff6e",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/storage/dao/VolumeDao.java",
                "patch": "@@ -80,7 +80,7 @@\n \n     List<VolumeVO> listVolumesToBeDestroyed();\n \n-    List<VolumeVO> listVolumesToBeDestroyed(Date date);\n+    List<VolumeVO> listNonRootVolumesToBeDestroyed(Date date);\n \n     ImageFormat getImageFormat(Long volumeId);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/schema/src/com/cloud/storage/dao/VolumeDao.java",
                "sha": "f2d5fc735207a0c267a05d3e5e2d147c6f06cc1f",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java?ref=6a18cdd6ef969cca3a063356d4a9a68163b5ff6e",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java",
                "patch": "@@ -325,6 +325,7 @@ public VolumeDaoImpl() {\n         AllFieldsSearch.and(\"deviceId\", AllFieldsSearch.entity().getDeviceId(), Op.EQ);\n         AllFieldsSearch.and(\"poolId\", AllFieldsSearch.entity().getPoolId(), Op.EQ);\n         AllFieldsSearch.and(\"vType\", AllFieldsSearch.entity().getVolumeType(), Op.EQ);\n+        AllFieldsSearch.and(\"notVolumeType\", AllFieldsSearch.entity().getVolumeType(), Op.NEQ);\n         AllFieldsSearch.and(\"id\", AllFieldsSearch.entity().getId(), Op.EQ);\n         AllFieldsSearch.and(\"destroyed\", AllFieldsSearch.entity().getState(), Op.EQ);\n         AllFieldsSearch.and(\"notDestroyed\", AllFieldsSearch.entity().getState(), Op.NEQ);\n@@ -481,9 +482,10 @@ public SumCount() {\n     }\n \n     @Override\n-    public List<VolumeVO> listVolumesToBeDestroyed(Date date) {\n+    public List<VolumeVO> listNonRootVolumesToBeDestroyed(Date date) {\n         SearchCriteria<VolumeVO> sc = AllFieldsSearch.create();\n         sc.setParameters(\"state\", Volume.State.Destroy);\n+        sc.setParameters(\"notVolumeType\", Volume.Type.ROOT.toString());\n         sc.setParameters(\"updateTime\", date);\n \n         return listBy(sc);",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java",
                "sha": "4f5b613ddd156049079df8f22fd1d62e6d5ce35d",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java?ref=6a18cdd6ef969cca3a063356d4a9a68163b5ff6e",
                "deletions": 3,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "patch": "@@ -174,11 +174,11 @@ public long getVolumeId() {\n     }\n \n     @Override\n-    public boolean  stateTransit(Volume.Event event) {\n+    public boolean stateTransit(Volume.Event event) {\n         boolean result = false;\n         try {\n             volumeVO = volumeDao.findById(volumeVO.getId());\n-            if(volumeVO != null) {\n+            if (volumeVO != null) {\n                 result = _volStateMachine.transitTo(volumeVO, event, null, volumeDao);\n                 volumeVO = volumeDao.findById(volumeVO.getId());\n             }\n@@ -332,8 +332,9 @@ public void processEvent(ObjectInDataStoreStateMachine.Event event) {\n             throw new CloudRuntimeException(\"Failed to update state:\" + e.toString());\n         } finally {\n             // in case of OperationFailed, expunge the entry\n+            // state transit call reloads the volume from DB and so check for null as well\n             if (event == ObjectInDataStoreStateMachine.Event.OperationFailed &&\n-                (volumeVO.getState() != Volume.State.Copying && volumeVO.getState() != Volume.State.Uploaded && volumeVO.getState() != Volume.State.UploadError)) {\n+                (volumeVO != null && volumeVO.getState() != Volume.State.Copying && volumeVO.getState() != Volume.State.Uploaded && volumeVO.getState() != Volume.State.UploadError)) {\n                 objectInStoreMgr.deleteIfNotReady(this);\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "sha": "b7f459227aaa6843124912d204385957bbe77cff",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java?ref=6a18cdd6ef969cca3a063356d4a9a68163b5ff6e",
                "deletions": 0,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "patch": "@@ -316,6 +316,11 @@ private boolean canVolumeBeRemoved(long volumeId) {\n         }\n \n         VolumeVO vol = volDao.findById(volume.getId());\n+        if (vol == null) {\n+            s_logger.debug(\"Volume \" + volume.getId() + \" is not found\");\n+            future.complete(result);\n+            return future;\n+        }\n \n         if (!volumeExistsOnPrimary(vol)) {\n             // not created on primary store",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "sha": "2e72286b2224c9fd7b471a6dc734813a43957a1b",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=6a18cdd6ef969cca3a063356d4a9a68163b5ff6e",
                "deletions": 3,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1080,8 +1080,8 @@ public void cleanupStorage(boolean recurring) {\n \n                     cleanupSecondaryStorage(recurring);\n \n-                    List<VolumeVO> vols = _volsDao.listVolumesToBeDestroyed(new Date(System.currentTimeMillis() - ((long) StorageCleanupDelay.value() << 10)));\n-\n+                    // ROOT volumes will be destroyed as part of VM cleanup\n+                    List<VolumeVO> vols = _volsDao.listNonRootVolumesToBeDestroyed(new Date(System.currentTimeMillis() - ((long) StorageCleanupDelay.value() << 10)));\n                     for (VolumeVO vol : vols) {\n                         try {\n                             // If this fails, just log a warning. It's ideal if we clean up the host-side clustered file\n@@ -1092,7 +1092,12 @@ public void cleanupStorage(boolean recurring) {\n                         }\n \n                         try {\n-                            volService.expungeVolumeAsync(volFactory.getVolume(vol.getId()));\n+                            VolumeInfo volumeInfo = volFactory.getVolume(vol.getId());\n+                            if (volumeInfo != null) {\n+                                volService.expungeVolumeAsync(volumeInfo);\n+                            } else {\n+                                s_logger.debug(\"Volume \" + vol.getUuid() + \" is already destroyed\");\n+                            }\n                         } catch (Exception e) {\n                             s_logger.warn(\"Unable to destroy volume \" + vol.getUuid(), e);\n                         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a18cdd6ef969cca3a063356d4a9a68163b5ff6e/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "5d1ee584ad4897f39be42e3fb7beec25a3aadf37",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1825 from Accelerite/CLOUDSTACK-9660\n\nCLOUDSTACK-9660: NPE while destroying volumes during 1000 VMs deploy and destroy tests\n\nNPE is seen as VM destroy and storage cleanup threads try to remove the same root volume. Fix is to handle\nonly non-root volumes in storage cleanup thread, root volumes will be handled as part of VM destroy.\n\n* pr/1825:\n  CLOUDSTACK-9660: NPE while destroying volumes during 1000 VMs deploy and destroy tests NPE is seen as VM destroy and storage cleanup threads try to remove the same root volume. Fix is to handle only non-root volumes in storage cleanup thread, root volumes will be handled as part of VM destroy.\n\nSigned-off-by: Rajani Karuturi <rajani.karuturi@accelerite.com>",
        "parent": "https://github.com/apache/cloudstack/commit/017c42b6251ea095a7879fd2e8df1138f8b57380",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeObjectTest.java",
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_6a5d3e9": {
        "bug_id": "cloudstack_6a5d3e9",
        "commit": "https://github.com/apache/cloudstack/commit/6a5d3e96c96c0cd5ec9e1ec1e1c4ed42dc73f84f",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a5d3e96c96c0cd5ec9e1ec1e1c4ed42dc73f84f/server/src/com/cloud/server/StatsCollector.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=6a5d3e96c96c0cd5ec9e1ec1e1c4ed42dc73f84f",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -343,7 +343,9 @@ protected void runInContext() {\n                 }\n                 for (HostVO host : gpuEnabledHosts) {\n                     HashMap<String, HashMap<String, Long>> groupDetails = _resourceMgr.getGPUStatistics(host);\n-                    _resourceMgr.updateGPUDetails(host.getId(), groupDetails);\n+                    if (groupDetails != null) {\n+                        _resourceMgr.updateGPUDetails(host.getId(), groupDetails);\n+                    }\n                 }\n                 hostIds = _hostGpuGroupsDao.listHostIds();\n             } catch (Throwable t) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a5d3e96c96c0cd5ec9e1ec1e1c4ed42dc73f84f/server/src/com/cloud/server/StatsCollector.java",
                "sha": "50aa93cd5ee424395314c4db57b69742396c3db7",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6238: NPE in HostStatsCollector.",
        "parent": "https://github.com/apache/cloudstack/commit/286974488eab03efddfea35962161a224e997ab0",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_6a7fd4d": {
        "bug_id": "cloudstack_6a7fd4d",
        "commit": "https://github.com/apache/cloudstack/commit/6a7fd4d96c01a25220fffde74be0de226d39ac20",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/6a7fd4d96c01a25220fffde74be0de226d39ac20/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=6a7fd4d96c01a25220fffde74be0de226d39ac20",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -24,6 +24,7 @@\n import java.util.Date;\n import java.util.HashMap;\n import java.util.HashSet;\n+import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n@@ -1340,7 +1341,10 @@ private HypervisorType getClusterToStartDomainRouterForOvm(long podId) {\n                 \n                 int allocateRetry = 0;\n                 int startRetry = 0;\n-                for (HypervisorType hType : supportedHypervisors) {\n+                \n+                \n+                for (Iterator<HypervisorType> iter = supportedHypervisors.iterator();iter.hasNext();) {\n+                    HypervisorType hType = iter.next();\n                     try {\n                         s_logger.debug(\"Allocating the domR with the hypervisor type \" + hType);\n                         VMTemplateVO template = _templateDao.findRoutingTemplate(hType);\n@@ -1361,7 +1365,7 @@ private HypervisorType getClusterToStartDomainRouterForOvm(long podId) {\n                         router.setRole(Role.VIRTUAL_ROUTER);\n                         router = _itMgr.allocate(router, template, routerOffering, networks, plan, null, owner);\n                     } catch (InsufficientCapacityException ex) {\n-                        if (allocateRetry < 2) {\n+                        if (allocateRetry < 2 && iter.hasNext()) {\n                             s_logger.debug(\"Failed to allocate the domR with hypervisor type \" + hType + \", retrying one more time\");\n                             continue;\n                         } else {\n@@ -1375,7 +1379,7 @@ private HypervisorType getClusterToStartDomainRouterForOvm(long podId) {\n                         router = startVirtualRouter(router, _accountMgr.getSystemUser(), _accountMgr.getSystemAccount(), params);\n                         break;\n                     } catch (InsufficientCapacityException ex) {\n-                        if (startRetry < 2) {\n+                        if (startRetry < 2 && iter.hasNext()) {\n                             s_logger.debug(\"Failed to start the domR  \" + router + \" with hypervisor type \" + hType + \", destroying it and recreating one more time\");\n                             //destroy the router\n                             destroyRouter(router.getId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/6a7fd4d96c01a25220fffde74be0de226d39ac20/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "4fde78c1b54fab58e4d7d957323d6a2a2f6572eb",
                "status": "modified"
            }
        ],
        "message": "Bug 13248 - NPE: DeployVMCmd fired during 2.2.x regression test on Acton build\n\nChanges:\n- After deployment of Router failed, we did not throw out the error inorder to retry the start using another hypervisorType.\n- But there is no other hypervisor to try, causing the failed and expunged router to be passed on further leading to an NPE later\n- So in case there are no more hypervisors to retry the router start, we should throw out the original error.",
        "parent": "https://github.com/apache/cloudstack/commit/e87e30bc3d57ba0a94ac9d83fb87bcbdc58ababf",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_6b79945": {
        "bug_id": "cloudstack_6b79945",
        "commit": "https://github.com/apache/cloudstack/commit/6b7994512d77f235296fa05baa0ba4a82897165a",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/6b7994512d77f235296fa05baa0ba4a82897165a/api/src/com/cloud/storage/StoragePool.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/storage/StoragePool.java?ref=6b7994512d77f235296fa05baa0ba4a82897165a",
                "deletions": 5,
                "filename": "api/src/com/cloud/storage/StoragePool.java",
                "patch": "@@ -18,6 +18,7 @@\n \n import java.util.Date;\n \n+import com.cloud.hypervisor.Hypervisor;\n import org.apache.cloudstack.api.Identity;\n import org.apache.cloudstack.api.InternalIdentity;\n \n@@ -98,10 +99,13 @@\n \n     Long getPodId();\n \n-    /**\n-     * @return\n-     */\n-    String getStorageProviderName();\n+\t/**\n+\t * @return\n+\t */\n+\tString getStorageProviderName();\n+\t\n+\tboolean isInMaintenance();\n+\n+    Hypervisor.HypervisorType getHypervisor();\n \n-    boolean isInMaintenance();\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/6b7994512d77f235296fa05baa0ba4a82897165a/api/src/com/cloud/storage/StoragePool.java",
                "sha": "7d541623256125a7d739c159413c6c997bf3ad5d",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/6b7994512d77f235296fa05baa0ba4a82897165a/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=6b7994512d77f235296fa05baa0ba4a82897165a",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -35,6 +35,7 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+\n import org.apache.commons.codec.binary.Base64;\n import org.apache.log4j.Logger;\n \n@@ -3731,7 +3732,12 @@ public VirtualMachine vmStorageMigration(Long vmId, StoragePool destPool) {\n             throw new InvalidParameterValueException(\"Data disks attached to the vm, can not migrate. Need to dettach data disks at first\");\n         }\n \n-        HypervisorType destHypervisorType = _clusterDao.findById(destPool.getClusterId()).getHypervisorType();\n+        HypervisorType destHypervisorType = destPool.getHypervisor();\n+        if (destHypervisorType == null) {\n+            destHypervisorType = _clusterDao.findById(\n+                destPool.getClusterId()).getHypervisorType();\n+        }\n+\n         if (vm.getHypervisorType() != destHypervisorType) {\n             throw new InvalidParameterValueException(\"hypervisor is not compatible: dest: \" + destHypervisorType.toString() + \", vm: \" + vm.getHypervisorType().toString());\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/6b7994512d77f235296fa05baa0ba4a82897165a/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "741b21c640fdef3a2beae2504c53fd6c5f074109",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-5329: fix NPE, in case of zone wide primary storage\n\nConflicts:\n\n\tapi/src/com/cloud/storage/StoragePool.java\n\tserver/src/com/cloud/vm/UserVmManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/a1762a6e7e716a205c6e4eab1b20b8ebeb9caff6",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_6cf0c56": {
        "bug_id": "cloudstack_6cf0c56",
        "commit": "https://github.com/apache/cloudstack/commit/6cf0c5683d518bd6dcd6c51bfa0290e96c6804f3",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/6cf0c5683d518bd6dcd6c51bfa0290e96c6804f3/plugins/network-elements/nicira-nvp/src/com/cloud/network/element/NiciraNvpElement.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/nicira-nvp/src/com/cloud/network/element/NiciraNvpElement.java?ref=6cf0c5683d518bd6dcd6c51bfa0290e96c6804f3",
                "deletions": 1,
                "filename": "plugins/network-elements/nicira-nvp/src/com/cloud/network/element/NiciraNvpElement.java",
                "patch": "@@ -173,7 +173,7 @@ public Provider getProvider() {\n \t\treturn Provider.NiciraNvp;\n \t}\n \n-\tprivate boolean canHandle(Network network, Service service) {\n+\tprotected boolean canHandle(Network network, Service service) {\n \t\ts_logger.debug(\"Checking if NiciraNvpElement can handle service \"\n \t\t\t\t+ service.getName() + \" on network \" + network.getDisplayText());\n \t\tif (network.getBroadcastDomainType() != BroadcastDomainType.Lswitch) {\n@@ -845,6 +845,7 @@ public boolean applyIps(Network network,\n \t\t\tConfigurePublicIpsOnLogicalRouterCommand cmd = new ConfigurePublicIpsOnLogicalRouterCommand(routermapping.getLogicalRouterUuid(), \n \t\t\t\t\tniciraNvpHost.getDetail(\"l3gatewayserviceuuid\"), cidrs);\n \t\t\tConfigurePublicIpsOnLogicalRouterAnswer answer = (ConfigurePublicIpsOnLogicalRouterAnswer) _agentMgr.easySend(niciraNvpHost.getId(), cmd);\n+\t\t\t//FIXME answer can be null if the host is down\n \t\t\treturn answer.getResult();\n \t\t}\n \t\telse {",
                "raw_url": "https://github.com/apache/cloudstack/raw/6cf0c5683d518bd6dcd6c51bfa0290e96c6804f3/plugins/network-elements/nicira-nvp/src/com/cloud/network/element/NiciraNvpElement.java",
                "sha": "0a7d042a96d7b4debb79f230946732232d544d80",
                "status": "modified"
            }
        ],
        "message": "Summary: Make canHandle protected\n\nChange access to canHandle so it's easier to unittest. \n\nMake a note that answers can be null if the host is down, there should\nbe a way to deal with this, but for now an NPE is an adequate indication\nthat something is wrong.",
        "parent": "https://github.com/apache/cloudstack/commit/9122809e00949230cb18211c3a3af0a44f57fd28",
        "repo": "cloudstack",
        "unit_tests": [
            "NiciraNvpElementTest.java"
        ]
    },
    "cloudstack_6e63f10": {
        "bug_id": "cloudstack_6e63f10",
        "commit": "https://github.com/apache/cloudstack/commit/6e63f10a4f4f77c1b57f1e804b44445a443c6b75",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/6e63f10a4f4f77c1b57f1e804b44445a443c6b75/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java?ref=6e63f10a4f4f77c1b57f1e804b44445a443c6b75",
                "deletions": 0,
                "filename": "plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "patch": "@@ -364,6 +364,7 @@ public boolean attachCluster(DataStore store, ClusterScope scope) {\n         List<HostVO> allHosts = _resourceMgr.listAllUpAndEnabledHosts(Host.Type.Routing, primarystore.getClusterId(),\n                 primarystore.getPodId(), primarystore.getDataCenterId());\n         if (allHosts.isEmpty()) {\n+            primaryDataStoreDao.expunge(primarystore.getId());\n             throw new CloudRuntimeException(\"No host up to associate a storage pool with in cluster \"\n                     + primarystore.getClusterId());\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/6e63f10a4f4f77c1b57f1e804b44445a443c6b75/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "sha": "17e80b843820322dc3eea3e54d645549c409e1f5",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-2510: Getting NPE while executinng listStoragePools API command.",
        "parent": "https://github.com/apache/cloudstack/commit/34c6c023e64a874b06cbd147c23fe04848699b75",
        "repo": "cloudstack",
        "unit_tests": [
            "CloudStackPrimaryDataStoreLifeCycleImplTest.java"
        ]
    },
    "cloudstack_6eacc11": {
        "bug_id": "cloudstack_6eacc11",
        "commit": "https://github.com/apache/cloudstack/commit/6eacc112221265bdbc5acbbd092f9be2ee872daf",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/6eacc112221265bdbc5acbbd092f9be2ee872daf/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=6eacc112221265bdbc5acbbd092f9be2ee872daf",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1174,7 +1174,10 @@ public SystemVmResponse createSystemVmResponse(VirtualMachine vm) {\n             // for console proxies, add the active sessions\n             if (vm.getType() == Type.ConsoleProxy) {\n                 ConsoleProxyVO proxy = ApiDBUtils.findConsoleProxy(vm.getId());\n-                vmResponse.setActiveViewerSessions(proxy.getActiveSession());\n+                //proxy can be already destroyed\n+                if (proxy != null) {\n+                    vmResponse.setActiveViewerSessions(proxy.getActiveSession());\n+                } \n             }\n \n             DataCenter zone = ApiDBUtils.findZoneById(vm.getDataCenterIdToDeployIn());",
                "raw_url": "https://github.com/apache/cloudstack/raw/6eacc112221265bdbc5acbbd092f9be2ee872daf/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "0fb45aa819f9bd6809faf5c7716efbbc2fd4f808",
                "status": "modified"
            }
        ],
        "message": "bug 10994: Fixed NPE in destroySystemVm api\nstatus 10994: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/ee6236125070bd41e24665fb9918d3a85fe7f19a",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_6f98fcd": {
        "bug_id": "cloudstack_6f98fcd",
        "commit": "https://github.com/apache/cloudstack/commit/6f98fcd3a5b1b498a9c1f53e85522282b1cc2b28",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/6f98fcd3a5b1b498a9c1f53e85522282b1cc2b28/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=6f98fcd3a5b1b498a9c1f53e85522282b1cc2b28",
                "deletions": 1,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -1740,7 +1740,7 @@ public VMTemplateVO createPrivateTemplateRecord(CreateTemplateCmd cmd, Account t\n \n             if (sourceTemplateId != null) {\n                 VMTemplateVO sourceTemplate = _tmpltDao.findById(sourceTemplateId);\n-                if(sourceTemplate != null){\n+                if (sourceTemplate != null && sourceTemplate.getDetails() != null) {\n                     details.putAll(sourceTemplate.getDetails());\n                 }\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/6f98fcd3a5b1b498a9c1f53e85522282b1cc2b28/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "7130042bc5c8153324989d7a956fb46ce8a3bfe0",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9688: Fix failing smoke tests\n\nFixes failing smoke tests due to enviroment issues or corner cases:\n- Fixes NPE in Template Manager\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/5e19e64f2f24d90d8f15d30b82d2a066061425a7",
        "repo": "cloudstack",
        "unit_tests": [
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_7089e1c": {
        "bug_id": "cloudstack_7089e1c",
        "commit": "https://github.com/apache/cloudstack/commit/7089e1ce44151702f36a8135e3b74752631a1894",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/7089e1ce44151702f36a8135e3b74752631a1894/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=7089e1ce44151702f36a8135e3b74752631a1894",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1499,11 +1499,15 @@ public boolean storagePoolHasEnoughIops(List<Volume> requestedVolumes,\n         if (requestedVolumes == null || requestedVolumes.isEmpty() || pool == null) {\n             return false;\n         }\n-\n+        // Only Solidfire type primary storage is using/setting Iops.\n+        // This check will fix to return the storage has enough Iops when capacityIops is set to NULL for any PS Storage provider\n+        if (pool.getCapacityIops() == null ) {\n+            return true;\n+        }\n         long currentIops = 0;\n-\n         List<VolumeVO> volumesInPool = _volumeDao.findByPoolId(pool.getId(), null);\n \n+\n         for (VolumeVO volumeInPool : volumesInPool) {\n             Long minIops = volumeInPool.getMinIops();\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/7089e1ce44151702f36a8135e3b74752631a1894/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "7378708a420432ecacc27bf026fd30fbe2816324",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3301 NPE wile deployVM in kvm Only solidfire type PS is setting/using the capacityIops, This check will fix to return the storage has enough Iops when capacityIops is set to NULL for any PS Storage provider",
        "parent": "https://github.com/apache/cloudstack/commit/7eb3d49e8e0a9b247ea974cad744803420982eda",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_7120c1e": {
        "bug_id": "cloudstack_7120c1e",
        "commit": "https://github.com/apache/cloudstack/commit/7120c1eb975cdee4b861f904c6bd9dcd379c2a7c",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/7120c1eb975cdee4b861f904c6bd9dcd379c2a7c/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServer56FP1Resource.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServer56FP1Resource.java?ref=7120c1eb975cdee4b861f904c6bd9dcd379c2a7c",
                "deletions": 12,
                "filename": "plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServer56FP1Resource.java",
                "patch": "@@ -169,7 +169,6 @@ protected VM createVmFromTemplate(Connection conn, VirtualMachineTO vmSpec, Host\n         vmr.actionsAfterCrash = Types.OnCrashBehaviour.DESTROY;\n         vmr.actionsAfterShutdown = Types.OnNormalExit.DESTROY;\n \n-        Map<String, String> details = vmSpec.getDetails();\n         if (isDmcEnabled(conn, host) && vmSpec.isEnableDynamicallyScaleVm()) {\n             //scaling is allowed\n             vmr.memoryStaticMin = getStaticMin(vmSpec.getOs(), vmSpec.getBootloader() == BootloaderType.CD, vmSpec.getMinRam(), vmSpec.getMaxRam());\n@@ -193,18 +192,21 @@ protected VM createVmFromTemplate(Connection conn, VirtualMachineTO vmSpec, Host\n             vmr.VCPUsMax = 32L;\n         }\n \n-        String timeoffset = details.get(\"timeoffset\");\n-        if (timeoffset != null) {\n-            Map<String, String> platform = vmr.platform;\n-            platform.put(\"timeoffset\", timeoffset);\n-            vmr.platform = platform;\n-        }\n+        Map<String, String> details = vmSpec.getDetails();\n+        if ( details != null ) {\n+            String timeoffset = details.get(\"timeoffset\");\n+            if (timeoffset != null) {\n+                Map<String, String> platform = vmr.platform;\n+                platform.put(\"timeoffset\", timeoffset);\n+                vmr.platform = platform;\n+            }\n \n-        String coresPerSocket = details.get(\"cpu.corespersocket\");\n-        if (coresPerSocket != null) {\n-            Map<String, String> platform = vmr.platform;\n-            platform.put(\"cores-per-socket\", coresPerSocket);\n-            vmr.platform = platform;\n+            String coresPerSocket = details.get(\"cpu.corespersocket\");\n+            if (coresPerSocket != null) {\n+                Map<String, String> platform = vmr.platform;\n+                platform.put(\"cores-per-socket\", coresPerSocket);\n+                vmr.platform = platform;\n+            }            \n         }\n \n         vmr.VCPUsAtStartup = (long) vmSpec.getCpus();",
                "raw_url": "https://github.com/apache/cloudstack/raw/7120c1eb975cdee4b861f904c6bd9dcd379c2a7c/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServer56FP1Resource.java",
                "sha": "4a9b526766ee4ba973ef2afad0adb7f07487860c",
                "status": "modified"
            }
        ],
        "message": "fixed NPE",
        "parent": "https://github.com/apache/cloudstack/commit/891b85d5168ebe1fe7fa0522e3191c30d3fb01db",
        "repo": "cloudstack",
        "unit_tests": [
            "XenServer56FP1ResourceTest.java"
        ]
    },
    "cloudstack_71a0148": {
        "bug_id": "cloudstack_71a0148",
        "commit": "https://github.com/apache/cloudstack/commit/71a01485657420da5b2a8dc05d11be18bb927494",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/71a01485657420da5b2a8dc05d11be18bb927494/developer/developer-prefill.sql",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/developer/developer-prefill.sql?ref=71a01485657420da5b2a8dc05d11be18bb927494",
                "deletions": 16,
                "filename": "developer/developer-prefill.sql",
                "patch": "@@ -62,22 +62,6 @@ INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n             VALUES ('Advanced', 'DEFAULT', 'management-server',\n             'expunge.interval', '60');\n \n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'cluster.cpu.allocated.capacity.disablethreshold', '0.95');\n-\n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'cluster.memory.allocated.capacity.disablethreshold ', '0.95');\n-\n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'pool.storage.allocated.capacity.disablethreshold ', '0.95');\n-\n-INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n-            VALUES ('Advanced', 'DEFAULT', 'management-server',\n-            'pool.storage.capacity.disablethreshold ', '0.95');\n-\n -- Add developer configuration entry; allows management server to be run as a user other than \"cloud\"\n INSERT INTO `cloud`.`configuration` (category, instance, component, name, value)\n             VALUES ('Advanced', 'DEFAULT', 'management-server',",
                "raw_url": "https://github.com/apache/cloudstack/raw/71a01485657420da5b2a8dc05d11be18bb927494/developer/developer-prefill.sql",
                "sha": "89d9c7ebe28402f53b3dd5f10d852107ae6711af",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/71a01485657420da5b2a8dc05d11be18bb927494/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=71a01485657420da5b2a8dc05d11be18bb927494",
                "deletions": 3,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1709,9 +1709,18 @@ private boolean hasSuitablePoolsForVolume(VolumeVO volume, Host host, VirtualMac\n             List<ConfigurationVO> configVOList = new ArrayList<ConfigurationVO>();\n             for (ConfigurationVO param : result.first()) {\n                 ConfigurationVO configVo = _configDao.findByName(param.getName());\n-                configVo.setValue(_configDepot.get(param.getName()).valueIn(id).toString());\n-                configVOList.add(configVo);\n-    }\n+                if (configVo != null) {\n+                    ConfigKey<?> key = _configDepot.get(param.getName());\n+                    if (key != null) {\n+                        configVo.setValue(key.valueIn(id).toString());\n+                        configVOList.add(configVo);\n+                    } else {\n+                        s_logger.warn(\"ConfigDepot could not find parameter \" + param.getName() + \" for scope \" + scope);\n+                    }\n+                } else {\n+                    s_logger.warn(\"Configuration item  \" + param.getName() + \" not found in \" + scope);\n+                }\n+            }\n \n             return new Pair<List<? extends Configuration>, Integer>(configVOList, configVOList.size());\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/71a01485657420da5b2a8dc05d11be18bb927494/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "e61a9f42dc082f74dcc29db8abef24de557380e2",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7219: Fix NPE, log warning when config item is missing from scope\n\n- Cherry picked from Daan's fix 63fbd16dd11388bd93cdbec4ea7fe6de37aa7fc5\n- Added another check if configDepot returned null\n- Removed developer prefill values\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit 188924751ed87a01541a094e03e958cd8d01653b)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/3fddfe0e1081e505ad270439658729ca0d4486cf",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_71b8f60": {
        "bug_id": "cloudstack_71b8f60",
        "commit": "https://github.com/apache/cloudstack/commit/71b8f6061f187d9b8fb555731c051bc9f074d430",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/71b8f6061f187d9b8fb555731c051bc9f074d430/patches/systemvm/debian/config/etc/init.d/cloud-early-config",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/patches/systemvm/debian/config/etc/init.d/cloud-early-config?ref=71b8f6061f187d9b8fb555731c051bc9f074d430",
                "deletions": 4,
                "filename": "patches/systemvm/debian/config/etc/init.d/cloud-early-config",
                "patch": "@@ -196,6 +196,7 @@ patch() {\n \n patch_log4j() {\n log_it \"Updating log4j-cloud.xml\"\n+mkdir -p /usr/local/cloud/systemvm/conf\n cat << \"EOF\" > /usr/local/cloud/systemvm/conf/temp.xml\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <!DOCTYPE log4j:configuration SYSTEM \"log4j.dtd\">\n@@ -936,10 +937,6 @@ setup_router() {\n setup_vpcrouter() {\n   log_it \"Setting up VPC virtual router system vm\"\n \n-  if [ \"$hyp\" == \"vmware\" ]; then\n-    setup_vmware_extra_nics\n-  fi\n-\n   if [ -f /etc/hosts ]; then\n     grep -q $NAME /etc/hosts || echo \"127.0.0.1 $NAME\" >> /etc/hosts;\n   fi\n@@ -984,6 +981,11 @@ EOF\n      if [ \"$hyp\" == \"vmware\" ]\n      then\n          ip route add $MGMTNET via $LOCAL_GW dev eth0\n+         \n+          # a hacking way to activate vSwitch under VMware\n+         ping -n -c 3 $LOCAL_GW &\n+         sleep 3\n+         pkill ping\n      fi\n   fi\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/71b8f6061f187d9b8fb555731c051bc9f074d430/patches/systemvm/debian/config/etc/init.d/cloud-early-config",
                "sha": "88ecc119b61874db5ca026e97a86db1f2533904c",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/71b8f6061f187d9b8fb555731c051bc9f074d430/server/src/com/cloud/agent/manager/DirectAgentAttache.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/agent/manager/DirectAgentAttache.java?ref=71b8f6061f187d9b8fb555731c051bc9f074d430",
                "deletions": 0,
                "filename": "server/src/com/cloud/agent/manager/DirectAgentAttache.java",
                "patch": "@@ -184,6 +184,10 @@ public void run() {\n                     try {\n                         if (resource != null) {\n                             answer = resource.executeRequest(cmds[i]);\n+                            if(answer == null) {\n+                            \ts_logger.warn(\"Resource returned null answer!\");\n+                                answer = new Answer(cmds[i], false, \"Resource returned null answer\");\n+                            }\n                         } else {\n                             answer = new Answer(cmds[i], false, \"Agent is disconnected\");\n                         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/71b8f6061f187d9b8fb555731c051bc9f074d430/server/src/com/cloud/agent/manager/DirectAgentAttache.java",
                "sha": "5b5d8d212894f2aabbbe3d7aff07f980ff66f1b2",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4376: fix cloud-early-config to workaround vSwitch stall in VPC mode. fix potential NPE in DirectAgentAttache in processing answers from resource",
        "parent": "https://github.com/apache/cloudstack/commit/c528e71fec9f81c9475a8ae427ef95e9550909ad",
        "repo": "cloudstack",
        "unit_tests": [
            "DirectAgentAttacheTest.java"
        ]
    },
    "cloudstack_737edd9": {
        "bug_id": "cloudstack_737edd9",
        "commit": "https://github.com/apache/cloudstack/commit/737edd90dc253789e442634b389ca5db835ee6e0",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/api/src/org/apache/cloudstack/api/command/admin/network/UpdatePhysicalNetworkCmd.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/network/UpdatePhysicalNetworkCmd.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 3,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/network/UpdatePhysicalNetworkCmd.java",
                "patch": "@@ -97,9 +97,11 @@ public long getEntityOwnerId() {\n     @Override\n     public void execute() {\n         PhysicalNetwork result = _networkService.updatePhysicalNetwork(getId(), getNetworkSpeed(), getTags(), getVlan(), getState());\n-        PhysicalNetworkResponse response = _responseGenerator.createPhysicalNetworkResponse(result);\n-        response.setResponseName(getCommandName());\n-        this.setResponseObject(response);\n+        if (result != null) {\n+            PhysicalNetworkResponse response = _responseGenerator.createPhysicalNetworkResponse(result);\n+            response.setResponseName(getCommandName());\n+            this.setResponseObject(response);\n+        }\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/api/src/org/apache/cloudstack/api/command/admin/network/UpdatePhysicalNetworkCmd.java",
                "sha": "ed3fa97ce7a965be55b928498467c848f9ef67ea",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/api/src/org/apache/cloudstack/api/command/user/firewall/DeleteFirewallRuleCmd.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/firewall/DeleteFirewallRuleCmd.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/user/firewall/DeleteFirewallRuleCmd.java",
                "patch": "@@ -113,7 +113,10 @@ public String getSyncObjType() {\n \n     @Override\n     public Long getSyncObjId() {\n-        return _firewallService.getFirewallRule(id).getNetworkId();\n+        FirewallRule fwlrule = _firewallService.getFirewallRule(id);\n+        if (fwlrule != null)\n+            return fwlrule.getNetworkId();\n+        return null;\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/api/src/org/apache/cloudstack/api/command/user/firewall/DeleteFirewallRuleCmd.java",
                "sha": "0f1001246109e2f330db7339e0b1c6bf3833b2d1",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/api/src/org/apache/cloudstack/api/command/user/vpn/UpdateVpnGatewayCmd.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/vpn/UpdateVpnGatewayCmd.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 2,
                "filename": "api/src/org/apache/cloudstack/api/command/user/vpn/UpdateVpnGatewayCmd.java",
                "patch": "@@ -85,8 +85,10 @@ public String getEventType() {\n     @Override\n     public void execute() {\n         Site2SiteVpnGateway result = _s2sVpnService.updateVpnGateway(id, this.getCustomId(), getDisplay());\n-        Site2SiteVpnGatewayResponse response = _responseGenerator.createSite2SiteVpnGatewayResponse(result);\n-        response.setResponseName(getCommandName());\n+        if (result != null) {\n+            Site2SiteVpnGatewayResponse response = _responseGenerator.createSite2SiteVpnGatewayResponse(result);\n+            response.setResponseName(getCommandName());\n+        }\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/api/src/org/apache/cloudstack/api/command/user/vpn/UpdateVpnGatewayCmd.java",
                "sha": "bbe820a83c44a688dd782f249b6ebcd78715731d",
                "status": "modified"
            },
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/engine/orchestration/src/com/cloud/agent/manager/ClusteredAgentManagerImpl.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/agent/manager/ClusteredAgentManagerImpl.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 21,
                "filename": "engine/orchestration/src/com/cloud/agent/manager/ClusteredAgentManagerImpl.java",
                "patch": "@@ -195,35 +195,36 @@ private void scanDirectAgentToLoad() {\n         long cutSeconds = (System.currentTimeMillis() >> 10) - getTimeout();\n         List<HostVO> hosts = _hostDao.findAndUpdateDirectAgentToLoad(cutSeconds, LoadSize.value().longValue(), _nodeId);\n         List<HostVO> appliances = _hostDao.findAndUpdateApplianceToLoad(cutSeconds, _nodeId);\n-        hosts.addAll(appliances);\n \n-        if (hosts != null && hosts.size() > 0) {\n-            s_logger.debug(\"Found \" + hosts.size() + \" unmanaged direct hosts, processing connect for them...\");\n-            for (HostVO host : hosts) {\n-                try {\n-                    AgentAttache agentattache = findAttache(host.getId());\n-                    if (agentattache != null) {\n-                        // already loaded, skip\n-                        if (agentattache.forForward()) {\n-                            if (s_logger.isInfoEnabled()) {\n-                                s_logger.info(host + \" is detected down, but we have a forward attache running, disconnect this one before launching the host\");\n+       if (hosts != null) {\n+            hosts.addAll(appliances);\n+            if (hosts.size() > 0) {\n+                s_logger.debug(\"Found \" + hosts.size() + \" unmanaged direct hosts, processing connect for them...\");\n+                for (HostVO host : hosts) {\n+                    try {\n+                        AgentAttache agentattache = findAttache(host.getId());\n+                        if (agentattache != null) {\n+                            // already loaded, skip\n+                            if (agentattache.forForward()) {\n+                                if (s_logger.isInfoEnabled()) {\n+                                    s_logger.info(host + \" is detected down, but we have a forward attache running, disconnect this one before launching the host\");\n+                                }\n+                                removeAgent(agentattache, Status.Disconnected);\n+                            } else {\n+                                continue;\n                             }\n-                            removeAgent(agentattache, Status.Disconnected);\n-                        } else {\n-                            continue;\n                         }\n-                    }\n \n-                    if (s_logger.isDebugEnabled()) {\n-                        s_logger.debug(\"Loading directly connected host \" + host.getId() + \"(\" + host.getName() + \")\");\n+                        if (s_logger.isDebugEnabled()) {\n+                            s_logger.debug(\"Loading directly connected host \" + host.getId() + \"(\" + host.getName() + \")\");\n+                        }\n+                        loadDirectlyConnectedHost(host, false);\n+                    } catch (Throwable e) {\n+                        s_logger.warn(\" can not load directly connected host \" + host.getId() + \"(\" + host.getName() + \") due to \", e);\n                     }\n-                    loadDirectlyConnectedHost(host, false);\n-                } catch (Throwable e) {\n-                    s_logger.warn(\" can not load directly connected host \" + host.getId() + \"(\" + host.getName() + \") due to \", e);\n                 }\n             }\n         }\n-\n         if (s_logger.isTraceEnabled()) {\n             s_logger.trace(\"End scanning directly connected hosts\");\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/engine/orchestration/src/com/cloud/agent/manager/ClusteredAgentManagerImpl.java",
                "sha": "600dca262fbef86cc2c7137c30b02fd8674ed8fc",
                "status": "modified"
            },
            {
                "additions": 56,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/framework/db/src/com/cloud/utils/db/GenericDaoBase.java",
                "changes": 122,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/db/src/com/cloud/utils/db/GenericDaoBase.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 66,
                "filename": "framework/db/src/com/cloud/utils/db/GenericDaoBase.java",
                "patch": "@@ -1641,81 +1641,71 @@ protected void toEntityBean(final ResultSet result, final T entity) throws SQLEx\n     @SuppressWarnings(\"unchecked\")\n     protected void loadCollection(T entity, Attribute attr) {\n         EcInfo ec = (EcInfo)attr.attache;\n-\n         TransactionLegacy txn = TransactionLegacy.currentTxn();\n-        ResultSet rs = null;\n-        PreparedStatement pstmt = null;\n-        try {\n-            pstmt = txn.prepareStatement(ec.selectSql);\n+        try(PreparedStatement pstmt = txn.prepareStatement(ec.selectSql);)\n+        {\n             pstmt.setObject(1, _idField.get(entity));\n-            rs = pstmt.executeQuery();\n-            ArrayList lst = new ArrayList();\n-            if (ec.targetClass == Integer.class) {\n-                while (rs.next()) {\n-                    lst.add(rs.getInt(1));\n-                }\n-            } else if (ec.targetClass == Long.class) {\n-                while (rs.next()) {\n-                    lst.add(rs.getLong(1));\n-                }\n-            } else if (ec.targetClass == String.class) {\n-                while (rs.next()) {\n-                    lst.add(rs.getString(1));\n-                }\n-            } else if (ec.targetClass == Short.class) {\n-                while (rs.next()) {\n-                    lst.add(rs.getShort(1));\n-                }\n-            } else if (ec.targetClass == Date.class) {\n-                while (rs.next()) {\n-                    lst.add(DateUtil.parseDateString(s_gmtTimeZone, rs.getString(1)));\n+            try(ResultSet rs = pstmt.executeQuery();)\n+            {\n+                ArrayList lst = new ArrayList();\n+                if (ec.targetClass == Integer.class) {\n+                    while (rs.next()) {\n+                        lst.add(rs.getInt(1));\n+                    }\n+                } else if (ec.targetClass == Long.class) {\n+                    while (rs.next()) {\n+                        lst.add(rs.getLong(1));\n+                    }\n+                } else if (ec.targetClass == String.class) {\n+                    while (rs.next()) {\n+                        lst.add(rs.getString(1));\n+                    }\n+                } else if (ec.targetClass == Short.class) {\n+                    while (rs.next()) {\n+                        lst.add(rs.getShort(1));\n+                    }\n+                } else if (ec.targetClass == Date.class) {\n+                    while (rs.next()) {\n+                        lst.add(DateUtil.parseDateString(s_gmtTimeZone, rs.getString(1)));\n+                    }\n+                } else if (ec.targetClass == Boolean.class) {\n+                    while (rs.next()) {\n+                        lst.add(rs.getBoolean(1));\n+                    }\n+                } else {\n+                    assert (false) : \"You'll need to add more classeses\";\n                 }\n-            } else if (ec.targetClass == Boolean.class) {\n-                while (rs.next()) {\n-                    lst.add(rs.getBoolean(1));\n+                if (ec.rawClass == null) {\n+                    Object[] array = (Object[]) Array.newInstance(ec.targetClass);\n+                    lst.toArray(array);\n+                    try {\n+                        attr.field.set(entity, array);\n+                    } catch (IllegalArgumentException e) {\n+                        throw new CloudRuntimeException(\"Come on we screen for this stuff, don't we?\", e);\n+                    } catch (IllegalAccessException e) {\n+                        throw new CloudRuntimeException(\"Come on we screen for this stuff, don't we?\", e);\n+                    }\n+                } else {\n+                    try {\n+                        Collection coll = (Collection) ec.rawClass.newInstance();\n+                        coll.addAll(lst);\n+                        attr.field.set(entity, coll);\n+                    } catch (IllegalAccessException e) {\n+                        throw new CloudRuntimeException(\"Come on we screen for this stuff, don't we?\", e);\n+                    } catch (InstantiationException e) {\n+                        throw new CloudRuntimeException(\"Never should happen\", e);\n+                    }\n                 }\n-            } else {\n-                assert (false) : \"You'll need to add more classeses\";\n             }\n-\n-            if (ec.rawClass == null) {\n-                Object[] array = (Object[])Array.newInstance(ec.targetClass);\n-                lst.toArray(array);\n-                try {\n-                    attr.field.set(entity, array);\n-                } catch (IllegalArgumentException e) {\n-                    throw new CloudRuntimeException(\"Come on we screen for this stuff, don't we?\", e);\n-                } catch (IllegalAccessException e) {\n-                    throw new CloudRuntimeException(\"Come on we screen for this stuff, don't we?\", e);\n-                }\n-            } else {\n-                try {\n-                    Collection coll = (Collection)ec.rawClass.newInstance();\n-                    coll.addAll(lst);\n-                    attr.field.set(entity, coll);\n-                } catch (IllegalAccessException e) {\n-                    throw new CloudRuntimeException(\"Come on we screen for this stuff, don't we?\", e);\n-                } catch (InstantiationException e) {\n-                    throw new CloudRuntimeException(\"Never should happen\", e);\n-                }\n+            catch (SQLException e) {\n+                throw new CloudRuntimeException(\"loadCollection: Exception : \" +e.getMessage(), e);\n             }\n         } catch (SQLException e) {\n-            throw new CloudRuntimeException(\"Error executing \" + pstmt, e);\n+            throw new CloudRuntimeException(\"loadCollection: Exception : \" +e.getMessage(), e);\n         } catch (IllegalArgumentException e) {\n-            throw new CloudRuntimeException(\"Error executing \" + pstmt, e);\n+            throw new CloudRuntimeException(\"loadCollection: Exception : \" +e.getMessage(), e);\n         } catch (IllegalAccessException e) {\n-            throw new CloudRuntimeException(\"Error executing \" + pstmt, e);\n-        } finally {\n-            try {\n-                if (rs != null) {\n-                    rs.close();\n-                }\n-                if (pstmt != null) {\n-                    pstmt.close();\n-                }\n-            } catch (SQLException e) {\n-                s_logger.error(\"Why are we getting an exception at close? \", e);\n-            }\n+            throw new CloudRuntimeException(\"loadCollection: Exception : \" +e.getMessage(), e);\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/framework/db/src/com/cloud/utils/db/GenericDaoBase.java",
                "sha": "e75646a79fab4febe15bf62d47ef8db0679e3a49",
                "status": "modified"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/plugins/api/discovery/test/org/apache/cloudstack/discovery/ApiDiscoveryTest.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/api/discovery/test/org/apache/cloudstack/discovery/ApiDiscoveryTest.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 10,
                "filename": "plugins/api/discovery/test/org/apache/cloudstack/discovery/ApiDiscoveryTest.java",
                "patch": "@@ -82,21 +82,25 @@ public static void setUp() throws ConfigurationException {\n     @Test\n     public void verifyListSingleApi() throws Exception {\n         ListResponse<ApiDiscoveryResponse> responses = (ListResponse<ApiDiscoveryResponse>)s_discoveryService.listApis(testUser, testApiName);\n-        ApiDiscoveryResponse response = responses.getResponses().get(0);\n-        assertTrue(\"No. of response items should be one\", responses.getCount() == 1);\n-        assertEquals(\"Error in api name\", testApiName, response.getName());\n-        assertEquals(\"Error in api description\", testApiDescription, response.getDescription());\n-        assertEquals(\"Error in api since\", testApiSince, response.getSince());\n-        assertEquals(\"Error in api isAsync\", testApiAsync, response.getAsync());\n+        if (responses != null) {\n+            ApiDiscoveryResponse response = responses.getResponses().get(0);\n+            assertTrue(\"No. of response items should be one\", responses.getCount() == 1);\n+            assertEquals(\"Error in api name\", testApiName, response.getName());\n+            assertEquals(\"Error in api description\", testApiDescription, response.getDescription());\n+            assertEquals(\"Error in api since\", testApiSince, response.getSince());\n+            assertEquals(\"Error in api isAsync\", testApiAsync, response.getAsync());\n+        }\n     }\n \n     @Test\n     public void verifyListApis() throws Exception {\n         ListResponse<ApiDiscoveryResponse> responses = (ListResponse<ApiDiscoveryResponse>)s_discoveryService.listApis(testUser, null);\n-        assertTrue(\"No. of response items > 1\", responses.getCount() == 1);\n-        for (ApiDiscoveryResponse response : responses.getResponses()) {\n-            assertFalse(\"API name is empty\", response.getName().isEmpty());\n-            assertFalse(\"API description is empty\", response.getDescription().isEmpty());\n+        if (responses != null) {\n+            assertTrue(\"No. of response items > 1\", responses.getCount().intValue() == 1);\n+            for (ApiDiscoveryResponse response : responses.getResponses()) {\n+                assertFalse(\"API name is empty\", response.getName().isEmpty());\n+                assertFalse(\"API description is empty\", response.getDescription().isEmpty());\n+            }\n         }\n     }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/plugins/api/discovery/test/org/apache/cloudstack/discovery/ApiDiscoveryTest.java",
                "sha": "49bf5a55dc57bc5057f9b6089ba1a017853f69f1",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/plugins/network-elements/nuage-vsp/src/com/cloud/network/element/NuageVspElement.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/nuage-vsp/src/com/cloud/network/element/NuageVspElement.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 2,
                "filename": "plugins/network-elements/nuage-vsp/src/com/cloud/network/element/NuageVspElement.java",
                "patch": "@@ -405,13 +405,15 @@ public boolean applyFWRules(Network network, List<? extends FirewallRule> rules)\n \n     @Override\n     public boolean applyNetworkACLs(Network network, List<? extends NetworkACLItem> rules) throws ResourceUnavailableException {\n-        s_logger.debug(\"Handling applyNetworkACLs for network \" + network.getName() + \" with \" + rules.size() + \" Network ACLs\");\n         if (rules == null || rules.isEmpty()) {\n             s_logger.debug(\"No rules to apply. So, delete all the existing ACL in VSP from Subnet with uuid \" + network.getUuid());\n         } else {\n             s_logger.debug(\"New rules has to applied. So, delete all the existing ACL in VSP from Subnet with uuid \" + network.getUuid());\n         }\n-        applyACLRules(network, rules, true);\n+        if (rules != null) {\n+            s_logger.debug(\"Handling applyNetworkACLs for network \" + network.getName() + \" with \" + rules.size() + \" Network ACLs\");\n+            applyACLRules(network, rules, true);\n+        }\n         return true;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/plugins/network-elements/nuage-vsp/src/com/cloud/network/element/NuageVspElement.java",
                "sha": "e777268e4245c196071d7675a1d7ab97ecdf0b4e",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/737edd90dc253789e442634b389ca5db835ee6e0/utils/src/com/cloud/utils/script/Script.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/script/Script.java?ref=737edd90dc253789e442634b389ca5db835ee6e0",
                "deletions": 12,
                "filename": "utils/src/com/cloud/utils/script/Script.java",
                "patch": "@@ -313,19 +313,19 @@ public Task(OutputInterpreter interpreter, BufferedReader reader) {\n \n         @Override\n         public void run() {\n-            done = false;\n-            try {\n-                result = interpreter.interpret(reader);\n-            } catch (IOException ex) {\n-                result = stackTraceAsString(ex);\n-            } catch (Exception ex) {\n-                result = stackTraceAsString(ex);\n-            } finally {\n-                synchronized (this) {\n-                    done = true;\n-                    notifyAll();\n+            synchronized(this) {\n+                done = false;\n+                try {\n+                    result = interpreter.interpret(reader);\n+                } catch (IOException ex) {\n+                    result = stackTraceAsString(ex);\n+                } catch (Exception ex) {\n+                    result = stackTraceAsString(ex);\n+                } finally {\n+                        done = true;\n+                        notifyAll();\n+                        IOUtils.closeQuietly(reader);\n                 }\n-                IOUtils.closeQuietly(reader);\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/737edd90dc253789e442634b389ca5db835ee6e0/utils/src/com/cloud/utils/script/Script.java",
                "sha": "49734ae808a7510984db37b644c7b1b40aec34ec",
                "status": "modified"
            }
        ],
        "message": "Fixed few coverity patches\n\nNPE in delete firewall rules observed, cherry-picking fix from master.\n\n(cherry picked from commit 31a42d2b7a5a9d3dbf10dc680d7e8877ed4e40c6)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/1bab1d0855f8813a54028aa58715db75d9c06ca0",
        "repo": "cloudstack",
        "unit_tests": [
            "GenericDaoBaseTest.java",
            "ScriptTest.java"
        ]
    },
    "cloudstack_7795cfd": {
        "bug_id": "cloudstack_7795cfd",
        "commit": "https://github.com/apache/cloudstack/commit/7795cfd75986874f9a947260379a761b0f3bde82",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/7795cfd75986874f9a947260379a761b0f3bde82/utils/src/com/cloud/utils/db/Transaction.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/db/Transaction.java?ref=7795cfd75986874f9a947260379a761b0f3bde82",
                "deletions": 4,
                "filename": "utils/src/com/cloud/utils/db/Transaction.java",
                "patch": "@@ -1006,10 +1006,7 @@ public String toString() {\n \n     public static void initDataSource(String propsFileName) {\n         try {\n-            File dbPropsFile = new File(propsFileName);\n-            if (!dbPropsFile.exists()) {\n-                dbPropsFile = PropertiesUtil.findConfigFile(propsFileName);\n-            }\n+            File dbPropsFile = PropertiesUtil.findConfigFile(propsFileName);\n             final Properties dbProps;\n             if (EncryptionSecretKeyChecker.useEncryption()) {\n                 StandardPBEStringEncryptor encryptor = EncryptionSecretKeyChecker.getEncryptor();\n@@ -1022,6 +1019,9 @@ public static void initDataSource(String propsFileName) {\n             } catch (IOException e) {\n                 s_logger.fatal(\"Unable to load db properties file, pl. check the classpath and file path configuration\", e);\n                 return;\n+            } catch (NullPointerException e) {\n+                s_logger.fatal(\"Unable to load and read db properties file \" + propsFileName + \"Error: \" + e);\n+                return;\n             }\n \n             // FIXME:  If params are missing...default them????",
                "raw_url": "https://github.com/apache/cloudstack/raw/7795cfd75986874f9a947260379a761b0f3bde82/utils/src/com/cloud/utils/db/Transaction.java",
                "sha": "8bc2a04f0979b713d96140e252e4becbaa3ed1c8",
                "status": "modified"
            }
        ],
        "message": "Transaction: Fix NPE while reading db.properties file\n\nHandle NPE while setting up data source in Transaction\n\n- This occured as Transaction is called it would run the following which\n  assumed db.properties file, which may not be in one's classpath;\n\n        // Initialize with assumed db.properties file\n        initDataSource(\"db.properties\");\n- So, while this would be logged in logs, this is ignored for DatabaseCreator's\n  case. In DatabaseCreator we call initDataSource with full path anyway.\n\nSigned-off-by: Rohit Yadav <bhaisaab@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/c61156e9651d42295a5dca554af2de73cd442ec7",
        "repo": "cloudstack",
        "unit_tests": [
            "TestTransaction.java"
        ]
    },
    "cloudstack_78849c2": {
        "bug_id": "cloudstack_78849c2",
        "commit": "https://github.com/apache/cloudstack/commit/78849c29593781170534dd6ed47781776ad074d0",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/78849c29593781170534dd6ed47781776ad074d0/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=78849c29593781170534dd6ed47781776ad074d0",
                "deletions": 8,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -822,14 +822,12 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            if (vm != null) {\n-                volResponse.setVirtualMachineId(vm.getId());\n-                volResponse.setVirtualMachineName(vm.getHostName());\n-                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-                if (userVm != null) {\n-                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                    volResponse.setVirtualMachineState(vm.getState().toString());\n-                }\n+            volResponse.setVirtualMachineId(vm.getId());\n+            volResponse.setVirtualMachineName(vm.getHostName());\n+            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+            if (userVm != null) {\n+                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                volResponse.setVirtualMachineState(vm.getState().toString());\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/78849c29593781170534dd6ed47781776ad074d0/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "37e794ddcd55402292b23a9d97bceae283ea8b89",
                "status": "modified"
            }
        ],
        "message": "Revert \"fix NPE when listvolume if vm got destroyed\"\n\nThis reverts commit 9bdaa9d967a6390cc1655ce7344d5af474890e4c.",
        "parent": "https://github.com/apache/cloudstack/commit/4a3635ee348d245293cdc44219386854e8000dbe",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_7972632": {
        "bug_id": "cloudstack_7972632",
        "commit": "https://github.com/apache/cloudstack/commit/797263265eb3f8e775f40b295c2a96f6467e677d",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/797263265eb3f8e775f40b295c2a96f6467e677d/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=797263265eb3f8e775f40b295c2a96f6467e677d",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1176,7 +1176,10 @@ public SystemVmResponse createSystemVmResponse(VirtualMachine vm) {\n             // for console proxies, add the active sessions\n             if (vm.getType() == Type.ConsoleProxy) {\n                 ConsoleProxyVO proxy = ApiDBUtils.findConsoleProxy(vm.getId());\n-                vmResponse.setActiveViewerSessions(proxy.getActiveSession());\n+                //proxy can be already destroyed\n+                if (proxy != null) {\n+                    vmResponse.setActiveViewerSessions(proxy.getActiveSession());\n+                } \n             }\n \n             DataCenter zone = ApiDBUtils.findZoneById(vm.getDataCenterIdToDeployIn());",
                "raw_url": "https://github.com/apache/cloudstack/raw/797263265eb3f8e775f40b295c2a96f6467e677d/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "779319c870c730ec1c87c9264f35923b11f388c7",
                "status": "modified"
            }
        ],
        "message": "bug 10994: Fixed NPE in destroySystemVm api\nstatus 10994: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/7a3edd74d5734d14387888c0fc0fbfe0eee84b9e",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_79f5ece": {
        "bug_id": "cloudstack_79f5ece",
        "commit": "https://github.com/apache/cloudstack/commit/79f5ece7dc6c603ded3ab5faf3eb682960f1f44c",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/79f5ece7dc6c603ded3ab5faf3eb682960f1f44c/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=79f5ece7dc6c603ded3ab5faf3eb682960f1f44c",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -2808,7 +2808,7 @@ public UserVm stopVirtualMachine(long vmId, boolean forced) throws ConcurrentOpe\n \n     @Override\n     public void finalizeStop(VirtualMachineProfile<UserVmVO> profile, StopAnswer answer) {\n-        if(\"VM does not exist\".equals(answer.getDetails())){\n+        if(answer != null && \"VM does not exist\".equals(answer.getDetails())){\n             // Stop answer returns true when Vm does not exist.\n             // This is a hack to avoid logging usage events\n             return;",
                "raw_url": "https://github.com/apache/cloudstack/raw/79f5ece7dc6c603ded3ab5faf3eb682960f1f44c/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "067b638cdfdafad8a1deed1d2b6e75d91fb28f5e",
                "status": "modified"
            }
        ],
        "message": "fix NPE in put primary storage into maintainance mode",
        "parent": "https://github.com/apache/cloudstack/commit/b0d64033693082a66b7607c5659210ffc5d45780",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_7ada4ad": {
        "bug_id": "cloudstack_7ada4ad",
        "commit": "https://github.com/apache/cloudstack/commit/7ada4ad50b683268f4031ff05e9d19d15d2c35f1",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/7ada4ad50b683268f4031ff05e9d19d15d2c35f1/utils/src/com/cloud/utils/net/NetUtils.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/net/NetUtils.java?ref=7ada4ad50b683268f4031ff05e9d19d15d2c35f1",
                "deletions": 1,
                "filename": "utils/src/com/cloud/utils/net/NetUtils.java",
                "patch": "@@ -191,7 +191,12 @@ public static String getDefaultHostIp() {\n                 return null;\n             }\n \n-            String[] info = NetUtils.getNetworkParams(nic);\n+            String[] info = null;\n+            try {\n+                info = NetUtils.getNetworkParams(nic);\n+            } catch (NullPointerException ignored) {\n+                s_logger.debug(\"Caught NullPointerException when trying to getDefaultHostIp\");\n+            }\n             if (info != null) {\n                 return info[0];\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/7ada4ad50b683268f4031ff05e9d19d15d2c35f1/utils/src/com/cloud/utils/net/NetUtils.java",
                "sha": "016ad470d0b013b5911a505fb48c67aea0b7d0eb",
                "status": "modified"
            }
        ],
        "message": "NetUtils: Check for NPE in getDefaultHostIp method when processing nic/mac\n\nOn hosts or containers where they don't have valid mac address on nic resulting\nin null, NetUtils.getNetworkParam can throw NPE.\n\nThis was a case found on TravisCI where OpenVZ containers are used. This method\n(getDefaultHostIp) is used at several other places within the ACS codebase to\nget the host IP and if null is caught we fallback to localhost or 127.0.0.1, so\nwe therefore set info to null before trying to process network param and if we\nfail we return null and expect other layers to use localhost.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/e3b3a18aefb8364543cb162a289dabd3ff8293a5",
        "repo": "cloudstack",
        "unit_tests": [
            "NetUtilsTest.java"
        ]
    },
    "cloudstack_7c58c37": {
        "bug_id": "cloudstack_7c58c37",
        "commit": "https://github.com/apache/cloudstack/commit/7c58c37f08cca55ab7ea5a37031a91e9d84b693a",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/7c58c37f08cca55ab7ea5a37031a91e9d84b693a/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java?ref=7c58c37f08cca55ab7ea5a37031a91e9d84b693a",
                "deletions": 0,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "patch": "@@ -1351,6 +1351,8 @@ public NicProfile prepareNic(final VirtualMachineProfile vmProfile, final Deploy\n             nic.setIPv4Address(profile.getIPv4Address());\n             nic.setAddressFormat(profile.getFormat());\n             nic.setIPv6Address(profile.getIPv6Address());\n+            nic.setIPv6Cidr(profile.getIPv6Cidr());\n+            nic.setIPv6Gateway(profile.getIPv6Gateway());\n             nic.setMacAddress(profile.getMacAddress());\n             nic.setIsolationUri(profile.getIsolationUri());\n             nic.setBroadcastUri(profile.getBroadCastUri());",
                "raw_url": "https://github.com/apache/cloudstack/raw/7c58c37f08cca55ab7ea5a37031a91e9d84b693a/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "sha": "c4c344dddcc20c1fabc28a7a9d978c8167c9e142",
                "status": "modified"
            }
        ],
        "message": "ipv6: Set IPv6 CIDR and Gateway in 'nic' profile\n\nWithout this information a NPE might be triggered when starting a VR, SSVM or CP\nas this information is read from the 'nics' table and causes a NPE.\n\nDuring deployment we should set the IPv6 Gateway and CIDR for the NIC object so that\nit is persisted to the database.\n\nSigned-off-by: Wido den Hollander <wido@widodh.nl>\n(cherry picked from commit f661b631a13ba7f0c501eb5d1915eab3d097a37e)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/c2060987830ab14ba92e2dd9fc66fb5a56c5fed3",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkOrchestratorTest.java"
        ]
    },
    "cloudstack_7cc82db": {
        "bug_id": "cloudstack_7cc82db",
        "commit": "https://github.com/apache/cloudstack/commit/7cc82db345b341f4be3695dfd2406169fedba2c1",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/7cc82db345b341f4be3695dfd2406169fedba2c1/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java?ref=7cc82db345b341f4be3695dfd2406169fedba2c1",
                "deletions": 2,
                "filename": "plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "patch": "@@ -532,8 +532,7 @@ public boolean deleteDataStore(DataStore store) {\n             throw new CloudRuntimeException(\"Failed to delete storage pool on host\");\n         }\n         \n-        this.dataStoreHelper.deletePrimaryDataStore(store);\n-        return false;\n+        return this.dataStoreHelper.deletePrimaryDataStore(store);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/7cc82db345b341f4be3695dfd2406169fedba2c1/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "sha": "a0c991b5ad6be9aac7275aa3b41c26c8f7f53d52",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/7cc82db345b341f4be3695dfd2406169fedba2c1/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=7cc82db345b341f4be3695dfd2406169fedba2c1",
                "deletions": 3,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -963,9 +963,7 @@ public boolean deletePool(DeletePoolCmd cmd) {\n         DataStoreLifeCycle lifeCycle = storeProvider.getDataStoreLifeCycle();\n         DataStore store = dataStoreMgr.getDataStore(\n                 sPool.getId(), DataStoreRole.Primary);\n-        lifeCycle.deleteDataStore(store);\n-\n-        return false;\n+        return lifeCycle.deleteDataStore(store);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/7cc82db345b341f4be3695dfd2406169fedba2c1/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "a182e39dd86e1e88455e0a97b8ccac314945f754",
                "status": "modified"
            }
        ],
        "message": "Fix CLOUDSTACK-2062 NPE while deleting the primary storage[Added with scope=cluster]",
        "parent": "https://github.com/apache/cloudstack/commit/167781ec0184f1332c0b45ca599f460d7d7b5c92",
        "repo": "cloudstack",
        "unit_tests": [
            "CloudStackPrimaryDataStoreLifeCycleImplTest.java",
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_7ea8c5f": {
        "bug_id": "cloudstack_7ea8c5f",
        "commit": "https://github.com/apache/cloudstack/commit/7ea8c5fd9a19b9f34158e2ab8db840967db6663d",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/api/src/org/apache/cloudstack/api/command/admin/storage/CreateStoragePoolCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/storage/CreateStoragePoolCmd.java?ref=7ea8c5fd9a19b9f34158e2ab8db840967db6663d",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/storage/CreateStoragePoolCmd.java",
                "patch": "@@ -182,6 +182,8 @@ public void execute(){\n         } catch (UnknownHostException ex3) {\n             s_logger.warn(\"Exception: \", ex3);\n             throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, ex3.getMessage());\n+        } catch (Exception ex4) {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, ex4.getMessage());\n         }\n     }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/api/src/org/apache/cloudstack/api/command/admin/storage/CreateStoragePoolCmd.java",
                "sha": "c26d1991f61cb58411cb69503e2976819fea5801",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java?ref=7ea8c5fd9a19b9f34158e2ab8db840967db6663d",
                "deletions": 2,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "patch": "@@ -128,7 +128,7 @@ public void storagePoolRefresh(StoragePool pool) {\n     }\n \n     private StoragePool createNfsStoragePool(Connect conn, String uuid,\n-            String host, String path) {\n+            String host, String path) throws LibvirtException {\n         String targetPath = _mountPoint + File.separator + uuid;\n         LibvirtStoragePoolDef spd = new LibvirtStoragePoolDef(poolType.NETFS,\n                 uuid, uuid, host, path, targetPath);\n@@ -156,6 +156,9 @@ private StoragePool createNfsStoragePool(Connect conn, String uuid,\n                 } else {\n                     s_logger.error(\"Failed in unmounting and redefining storage\");\n                 }\n+            } else {\n+                s_logger.error(\"Internal error occurred when attempting to mount: specified path may be invalid\");\n+                throw e;\n             }\n             if (sp != null) {\n                 try {\n@@ -496,7 +499,13 @@ public KVMStoragePool createStoragePool(String name, String host, int port,\n             s_logger.debug(\"Attempting to create storage pool \" + name);\n \n             if (type == StoragePoolType.NetworkFilesystem) {\n-                sp = createNfsStoragePool(conn, name, host, path);\n+                try {\n+                        sp = createNfsStoragePool(conn, name, host, path);\n+                } catch (LibvirtException e) {\n+                        s_logger.error(\"Failed to create mount\");\n+                        s_logger.error(e.getStackTrace());\n+                        throw new CloudRuntimeException(e.toString());\n+                }\n             } else if (type == StoragePoolType.SharedMountPoint\n                     || type == StoragePoolType.Filesystem) {\n                 sp = createSharedStoragePool(conn, name, host, path);",
                "raw_url": "https://github.com/apache/cloudstack/raw/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/LibvirtStorageAdaptor.java",
                "sha": "db1811e6a59949e448fd39457b1191514d5e051b",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java?ref=7ea8c5fd9a19b9f34158e2ab8db840967db6663d",
                "deletions": 1,
                "filename": "plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "patch": "@@ -60,6 +60,7 @@\n import com.cloud.storage.StoragePoolAutomation;\n import com.cloud.storage.StoragePoolDiscoverer;\n import com.cloud.storage.StoragePoolHostVO;\n+import com.cloud.storage.StoragePoolStatus;\n import com.cloud.storage.dao.StoragePoolHostDao;\n import com.cloud.storage.dao.StoragePoolWorkDao;\n import com.cloud.storage.dao.VolumeDao;\n@@ -396,7 +397,7 @@ public boolean attachCluster(DataStore store, ClusterScope scope) {\n             s_logger.warn(\"No host can access storage pool \" + primarystore + \" on cluster \"\n                     + primarystore.getClusterId());\n             primaryDataStoreDao.expunge(primarystore.getId());\n-            return false;\n+            throw new CloudRuntimeException(\"Failed to access storage pool\");\n         }\n \n         this.dataStoreHelper.attachCluster(store);\n@@ -437,6 +438,10 @@ public boolean deleteDataStore(DataStore store) {\n         List<StoragePoolHostVO> hostPoolRecords = this._storagePoolHostDao.listByPoolId(store.getId());\n         StoragePool pool = (StoragePool) store;\n         boolean deleteFlag = false;\n+        // If datastore is not in ready state, simply delete its db entry.\n+        if (pool.getStatus() != StoragePoolStatus.Up) {\n+            return this.dataStoreHelper.deletePrimaryDataStore(store);\n+        }\n         // Remove the SR associated with the Xenserver\n         for (StoragePoolHostVO host : hostPoolRecords) {\n             DeleteStoragePoolCommand deleteCmd = new DeleteStoragePoolCommand(pool);",
                "raw_url": "https://github.com/apache/cloudstack/raw/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "sha": "26733d443ebcc566314ac72c181b454971e9432f",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=7ea8c5fd9a19b9f34158e2ab8db840967db6663d",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -717,7 +717,7 @@ public PrimaryDataStoreInfo createPool(CreateStoragePoolCmd cmd) throws Resource\n         params.put(\"capacityIops\", cmd.getCapacityIops());\n \n         DataStoreLifeCycle lifeCycle = storeProvider.getDataStoreLifeCycle();\n-        DataStore store;\n+        DataStore store = null;\n         try {\n             store = lifeCycle.initialize(params);\n             if (scopeType == ScopeType.CLUSTER) {\n@@ -729,6 +729,10 @@ public PrimaryDataStoreInfo createPool(CreateStoragePoolCmd cmd) throws Resource\n             }\n         } catch (Exception e) {\n             s_logger.debug(\"Failed to add data store\", e);\n+            // clean up the db\n+            if (store != null) {\n+                lifeCycle.deleteDataStore(store);\n+            }\n             throw new CloudRuntimeException(\"Failed to add data store\", e);\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/7ea8c5fd9a19b9f34158e2ab8db840967db6663d/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "830fd368fed757002f54a595c1be4f56da9d2dfa",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-1510: NPE when primary storage is added with wrong path\n\nDescription:\n\n\ta) Fixing NPE when wrong path is provided for primary datastore.\n\tb) No error dialog shows up in GUI when wrong path is provided,\n\t   after NPE fix - propagating exception upward.\n\tc) If the KVM agent is down, an invalid datastore gets logged in\n\t   storage_pool table and doesn't get removed, so it shows up\n\t   in the GUI in the list of datastores - fixing this as well.",
        "parent": "https://github.com/apache/cloudstack/commit/7089e1ce44151702f36a8135e3b74752631a1894",
        "repo": "cloudstack",
        "unit_tests": [
            "CloudStackPrimaryDataStoreLifeCycleImplTest.java",
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_807562d": {
        "bug_id": "cloudstack_807562d",
        "commit": "https://github.com/apache/cloudstack/commit/807562da50743438d78efff17d58401f43abb7a4",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/807562da50743438d78efff17d58401f43abb7a4/server/src/com/cloud/network/rules/RulesManagerImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/rules/RulesManagerImpl.java?ref=807562da50743438d78efff17d58401f43abb7a4",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/rules/RulesManagerImpl.java",
                "patch": "@@ -358,6 +358,8 @@ public boolean revokePortForwardingRule(long ruleId, boolean apply) {\n             throw new InvalidParameterValueException(\"Unable to find \" + ruleId);\n         }\n         \n+        long ownerId = rule.getAccountId();\n+        \n         _accountMgr.checkAccess(caller, rule);\n         revokeRule(rule, caller, ctx.getCallerUserId());\n         \n@@ -369,7 +371,7 @@ public boolean revokePortForwardingRule(long ruleId, boolean apply) {\n             success = true;\n         }\n         if(success){\n-            UsageEventVO usageEvent = new UsageEventVO(EventTypes.EVENT_NET_RULE_DELETE, rule.getAccountId(), 0, rule.getId(), null);\n+            UsageEventVO usageEvent = new UsageEventVO(EventTypes.EVENT_NET_RULE_DELETE, ownerId, 0, ruleId, null);\n             _usageEventDao.persist(usageEvent);\n         }\n         return success;\n@@ -383,6 +385,11 @@ public boolean revokePortForwardingRule(long vmId) {\n     \t}\n     \t\n     \tList<PortForwardingRuleVO> rules = _forwardingDao.listByVm(vmId);\n+    \t\n+    \tif (rules == null || rules.isEmpty()) {\n+            return true;\n+        }\n+    \t\n     \tfor (PortForwardingRuleVO rule : rules) {\n     \t\trevokePortForwardingRule(rule.getId(), true);\n     \t}",
                "raw_url": "https://github.com/apache/cloudstack/raw/807562da50743438d78efff17d58401f43abb7a4/server/src/com/cloud/network/rules/RulesManagerImpl.java",
                "sha": "7eb22e694c10ef5d9f56e6f1d74f40273d81322f",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/807562da50743438d78efff17d58401f43abb7a4/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=807562da50743438d78efff17d58401f43abb7a4",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1111,6 +1111,9 @@ public UserVm startUserVm(long vmId) throws ConcurrentOperationException, Execut\n \n     @Override\n     public boolean expunge(UserVmVO vm, long callerUserId, Account caller) {\n+        UserContext ctx = UserContext.current();\n+        ctx.setAccountId(vm.getAccountId());\n+        \n \t    try {\n \t        \n \t        if (!_itMgr.advanceExpunge(vm, _accountMgr.getSystemUser(), caller)) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/807562da50743438d78efff17d58401f43abb7a4/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "3e8ee037aef833a51872da367936ef29522800e2",
                "status": "modified"
            }
        ],
        "message": "bug 8424: fixed NPE in vmExpunge thread - set accountId for UserContext to the vm's ownerId (this value is being read by UsageEvents generator)\nstatus 8424: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/87b3f4a17da3ee8dcbb36586d03a6f2fce316171",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_81b4731": {
        "bug_id": "cloudstack_81b4731",
        "commit": "https://github.com/apache/cloudstack/commit/81b4731e3b5265943017f88b850421154184f7c5",
        "file": [
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/81b4731e3b5265943017f88b850421154184f7c5/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 36,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=81b4731e3b5265943017f88b850421154184f7c5",
                "deletions": 18,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -2968,7 +2968,7 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n         usageRecResponse.setUsage(usageRecord.getUsageDisplay());\n         usageRecResponse.setUsageType(usageRecord.getUsageType());\n         if (usageRecord.getVmInstanceId() != null) {\n-            VMInstanceVO vm = _entityMgr.findById(VMInstanceVO.class, usageRecord.getVmInstanceId());\n+            VMInstanceVO vm = _entityMgr.findByIdIncludingRemoved(VMInstanceVO.class, usageRecord.getVmInstanceId());\n             if (vm != null) {\n                 usageRecResponse.setVirtualMachineId(vm.getUuid());\n             }\n@@ -2986,7 +2986,7 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n             //Service Offering Id\n             usageRecResponse.setOfferingId(svcOffering.getUuid());\n             //VM Instance ID\n-            VMInstanceVO vm = _entityMgr.findById(VMInstanceVO.class, usageRecord.getUsageId().toString());\n+            VMInstanceVO vm = _entityMgr.findByIdIncludingRemoved(VMInstanceVO.class, usageRecord.getUsageId().toString());\n             if (vm != null) {\n                 usageRecResponse.setUsageId(vm.getUuid());\n             }\n@@ -2999,7 +2999,7 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n             //isSystem\n             usageRecResponse.setSystem((usageRecord.getSize() == 1) ? true : false);\n             //IP Address ID\n-            IPAddressVO ip = _entityMgr.findById(IPAddressVO.class, usageRecord.getUsageId().toString());\n+            IPAddressVO ip = _entityMgr.findByIdIncludingRemoved(IPAddressVO.class, usageRecord.getUsageId().toString());\n             if (ip != null) {\n                 usageRecResponse.setUsageId(ip.getUuid());\n             }\n@@ -3009,19 +3009,19 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n             usageRecResponse.setType(usageRecord.getType());\n             if (usageRecord.getType().equals(\"DomainRouter\")) {\n                 //Domain Router Id\n-                VMInstanceVO vm = _entityMgr.findById(VMInstanceVO.class, usageRecord.getUsageId().toString());\n+                VMInstanceVO vm = _entityMgr.findByIdIncludingRemoved(VMInstanceVO.class, usageRecord.getUsageId().toString());\n                 if (vm != null) {\n                     usageRecResponse.setUsageId(vm.getUuid());\n                 }\n             } else {\n                 //External Device Host Id\n-                HostVO host = _entityMgr.findById(HostVO.class, usageRecord.getUsageId().toString());\n+                HostVO host = _entityMgr.findByIdIncludingRemoved(HostVO.class, usageRecord.getUsageId().toString());\n                 if (host != null) {\n                     usageRecResponse.setUsageId(host.getUuid());\n                 }\n             }\n             //Network ID\n-            NetworkVO network = _entityMgr.findById(NetworkVO.class, usageRecord.getNetworkId().toString());\n+            NetworkVO network = _entityMgr.findByIdIncludingRemoved(NetworkVO.class, usageRecord.getNetworkId().toString());\n             if (network != null) {\n                 usageRecResponse.setNetworkId(network.getUuid());\n             }\n@@ -3031,33 +3031,33 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n             //Device Type\n             usageRecResponse.setType(usageRecord.getType());\n             //VM Instance Id\n-            VMInstanceVO vm = _entityMgr.findById(VMInstanceVO.class, usageRecord.getVmInstanceId().toString());\n+            VMInstanceVO vm = _entityMgr.findByIdIncludingRemoved(VMInstanceVO.class, usageRecord.getVmInstanceId().toString());\n             if (vm != null) {\n                 usageRecResponse.setVirtualMachineId(vm.getUuid());\n             }\n             //Volume ID\n-            VolumeVO volume = _entityMgr.findById(VolumeVO.class, usageRecord.getUsageId().toString());\n+            VolumeVO volume = _entityMgr.findByIdIncludingRemoved(VolumeVO.class, usageRecord.getUsageId().toString());\n             if (volume != null) {\n                 usageRecResponse.setUsageId(volume.getUuid());\n             }\n \n         } else if (usageRecord.getUsageType() == UsageTypes.VOLUME) {\n             //Volume ID\n-            VolumeVO volume = _entityMgr.findById(VolumeVO.class, usageRecord.getUsageId().toString());\n+            VolumeVO volume = _entityMgr.findByIdIncludingRemoved(VolumeVO.class, usageRecord.getUsageId().toString());\n             if (volume != null) {\n                 usageRecResponse.setUsageId(volume.getUuid());\n             }\n             //Volume Size\n             usageRecResponse.setSize(usageRecord.getSize());\n             //Disk Offering Id\n             if (usageRecord.getOfferingId() != null) {\n-                DiskOfferingVO diskOff = _entityMgr.findById(DiskOfferingVO.class, usageRecord.getOfferingId().toString());\n+                DiskOfferingVO diskOff = _entityMgr.findByIdIncludingRemoved(DiskOfferingVO.class, usageRecord.getOfferingId().toString());\n                 usageRecResponse.setOfferingId(diskOff.getUuid());\n             }\n \n         } else if (usageRecord.getUsageType() == UsageTypes.TEMPLATE || usageRecord.getUsageType() == UsageTypes.ISO) {\n             //Template/ISO ID\n-            VMTemplateVO tmpl = _entityMgr.findById(VMTemplateVO.class, usageRecord.getUsageId().toString());\n+            VMTemplateVO tmpl = _entityMgr.findByIdIncludingRemoved(VMTemplateVO.class, usageRecord.getUsageId().toString());\n             usageRecResponse.setUsageId(tmpl.getUuid());\n             if (tmpl != null) {\n                 usageRecResponse.setUsageId(tmpl.getUuid());\n@@ -3072,7 +3072,7 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n \n         } else if (usageRecord.getUsageType() == UsageTypes.SNAPSHOT) {\n             //Snapshot ID\n-            SnapshotVO snap = _entityMgr.findById(SnapshotVO.class, usageRecord.getUsageId().toString());\n+            SnapshotVO snap = _entityMgr.findByIdIncludingRemoved(SnapshotVO.class, usageRecord.getUsageId().toString());\n             if (snap != null) {\n                 usageRecResponse.setUsageId(snap.getUuid());\n             }\n@@ -3081,39 +3081,39 @@ public UsageRecordResponse createUsageResponse(Usage usageRecord) {\n \n         } else if (usageRecord.getUsageType() == UsageTypes.LOAD_BALANCER_POLICY) {\n             //Load Balancer Policy ID\n-            LoadBalancerVO lb = _entityMgr.findById(LoadBalancerVO.class, usageRecord.getUsageId().toString());\n+            LoadBalancerVO lb = _entityMgr.findByIdIncludingRemoved(LoadBalancerVO.class, usageRecord.getUsageId().toString());\n             if (lb != null) {\n                 usageRecResponse.setUsageId(lb.getUuid());\n             }\n         } else if (usageRecord.getUsageType() == UsageTypes.PORT_FORWARDING_RULE) {\n             //Port Forwarding Rule ID\n-            PortForwardingRuleVO pf = _entityMgr.findById(PortForwardingRuleVO.class, usageRecord.getUsageId().toString());\n+            PortForwardingRuleVO pf = _entityMgr.findByIdIncludingRemoved(PortForwardingRuleVO.class, usageRecord.getUsageId().toString());\n             if (pf != null) {\n                 usageRecResponse.setUsageId(pf.getUuid());\n             }\n \n         } else if (usageRecord.getUsageType() == UsageTypes.NETWORK_OFFERING) {\n             //Network Offering Id\n-            NetworkOfferingVO netOff = _entityMgr.findById(NetworkOfferingVO.class, usageRecord.getOfferingId().toString());\n+            NetworkOfferingVO netOff = _entityMgr.findByIdIncludingRemoved(NetworkOfferingVO.class, usageRecord.getOfferingId().toString());\n             usageRecResponse.setOfferingId(netOff.getUuid());\n             //is Default\n             usageRecResponse.setDefault((usageRecord.getUsageId() == 1) ? true : false);\n \n         } else if (usageRecord.getUsageType() == UsageTypes.VPN_USERS) {\n             //VPN User ID\n-            VpnUserVO vpnUser = _entityMgr.findById(VpnUserVO.class, usageRecord.getUsageId().toString());\n+            VpnUserVO vpnUser = _entityMgr.findByIdIncludingRemoved(VpnUserVO.class, usageRecord.getUsageId().toString());\n             if (vpnUser != null) {\n                 usageRecResponse.setUsageId(vpnUser.getUuid());\n             }\n \n         } else if (usageRecord.getUsageType() == UsageTypes.SECURITY_GROUP) {\n             //Security Group Id\n-            SecurityGroupVO sg = _entityMgr.findById(SecurityGroupVO.class, usageRecord.getUsageId().toString());\n+            SecurityGroupVO sg = _entityMgr.findByIdIncludingRemoved(SecurityGroupVO.class, usageRecord.getUsageId().toString());\n             if (sg != null) {\n                 usageRecResponse.setUsageId(sg.getUuid());\n             }\n         } else if (usageRecord.getUsageType() == UsageTypes.VM_SNAPSHOT) {\n-            VMInstanceVO vm = _entityMgr.findById(VMInstanceVO.class, usageRecord.getVmInstanceId().toString());\n+            VMInstanceVO vm = _entityMgr.findByIdIncludingRemoved(VMInstanceVO.class, usageRecord.getVmInstanceId().toString());\n             if (vm != null) {\n                 usageRecResponse.setVmName(vm.getInstanceName());\n                 usageRecResponse.setUsageId(vm.getUuid());",
                "raw_url": "https://github.com/apache/cloudstack/raw/81b4731e3b5265943017f88b850421154184f7c5/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "12d09b23c4a62467d845f63946f6ca9f5e9c5872",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6472 listUsageRecords: Pull information from removed items as well, fixing NPEs/Null UUIDs with usage API calls.\n\nSigned-off-by: Sebastien Goasguen <runseb@gmail.com>",
        "parent": "https://github.com/apache/cloudstack/commit/178240a7da4915541c64d675398f6b8b8715b7bf",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_8442a4d": {
        "bug_id": "cloudstack_8442a4d",
        "commit": "https://github.com/apache/cloudstack/commit/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/engine/schema/src/com/cloud/storage/dao/SnapshotDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/storage/dao/SnapshotDao.java?ref=8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/storage/dao/SnapshotDao.java",
                "patch": "@@ -61,4 +61,6 @@\n \n     void updateVolumeIds(long oldVolId, long newVolId);\n \n+    List<SnapshotVO> listByStatusNotIn(long volumeId, Snapshot.State... status);\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/engine/schema/src/com/cloud/storage/dao/SnapshotDao.java",
                "sha": "1c11f9b61801bfe9d06a4a82a3975e014ef9433c",
                "status": "modified"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/engine/schema/src/com/cloud/storage/dao/SnapshotDaoImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/storage/dao/SnapshotDaoImpl.java?ref=8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/storage/dao/SnapshotDaoImpl.java",
                "patch": "@@ -69,6 +69,7 @@\n     private SearchBuilder<SnapshotVO> AccountIdSearch;\n     private SearchBuilder<SnapshotVO> InstanceIdSearch;\n     private SearchBuilder<SnapshotVO> StatusSearch;\n+    private SearchBuilder<SnapshotVO> notInStatusSearch;\n     private GenericSearchBuilder<SnapshotVO, Long> CountSnapshotsByAccount;\n     @Inject\n     ResourceTagDao _tagsDao;\n@@ -187,6 +188,11 @@ protected void init() {\n         StatusSearch.and(\"status\", StatusSearch.entity().getState(), SearchCriteria.Op.IN);\n         StatusSearch.done();\n \n+        notInStatusSearch  = createSearchBuilder();\n+        notInStatusSearch.and(\"volumeId\", notInStatusSearch.entity().getVolumeId(), SearchCriteria.Op.EQ);\n+        notInStatusSearch.and(\"status\", notInStatusSearch.entity().getState(), SearchCriteria.Op.NOTIN);\n+        notInStatusSearch.done();\n+\n         CountSnapshotsByAccount = createSearchBuilder(Long.class);\n         CountSnapshotsByAccount.select(null, Func.COUNT, null);\n         CountSnapshotsByAccount.and(\"account\", CountSnapshotsByAccount.entity().getAccountId(), SearchCriteria.Op.EQ);\n@@ -352,4 +358,12 @@ public void updateVolumeIds(long oldVolId, long newVolId) {\n         UpdateBuilder ub = getUpdateBuilder(snapshot);\n         update(ub, sc, null);\n     }\n+\n+    @Override\n+    public List<SnapshotVO> listByStatusNotIn(long volumeId, Snapshot.State... status) {\n+        SearchCriteria<SnapshotVO> sc = this.notInStatusSearch.create();\n+        sc.setParameters(\"volumeId\", volumeId);\n+        sc.setParameters(\"status\", (Object[]) status);\n+        return listBy(sc, null);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/engine/schema/src/com/cloud/storage/dao/SnapshotDaoImpl.java",
                "sha": "560edc93816c0d470cf564d2cd145fac2b6b4878",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf",
                "deletions": 12,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -231,10 +231,10 @@\n import com.cloud.storage.GuestOSVO;\n import com.cloud.storage.SnapshotVO;\n import com.cloud.storage.Storage;\n+import com.cloud.storage.Snapshot;\n import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.storage.Storage.StoragePoolType;\n import com.cloud.storage.Storage.TemplateType;\n-import com.cloud.storage.Snapshot;\n import com.cloud.storage.StorageManager;\n import com.cloud.storage.StoragePool;\n import com.cloud.storage.StoragePoolStatus;\n@@ -5457,11 +5457,20 @@ public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationExcep\n             }\n         }\n \n+        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n+\n+        for (VolumeVO volume : volumes) {\n+            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n+            if (snapshots != null && snapshots.size() > 0) {\n+                throw new InvalidParameterValueException(\n+                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n+            }\n+        }\n+\n         DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n \n         // Get serviceOffering and Volumes for Virtual Machine\n         final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n-        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n \n         //Remove vm from instance group\n         removeInstanceFromInstanceGroup(cmd.getVmId());\n@@ -5516,16 +5525,6 @@ public void doInTransactionWithoutResult(TransactionStatus status) {\n             _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n             UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                     volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n-            //snapshots: mark these removed in db\n-            List<SnapshotVO> snapshots = _snapshotDao.listByVolumeIdIncludingRemoved(volume.getId());\n-            for (SnapshotVO snapshot : snapshots) {\n-                    boolean result = _snapshotService.deleteSnapshot(snapshot.getId());\n-                    if (result) {\n-                        s_logger.info(\"Snapshot id: \" + snapshot.getId() + \" delete successfully \");\n-                    } else {\n-                        s_logger.error(\"Unable to delete Snapshot id: \" + snapshot.getId());\n-                    }\n-            }\n         }\n \n         //update resource count of new account",
                "raw_url": "https://github.com/apache/cloudstack/raw/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "df9130c682dac480c72c4a7f7859f9f9db8c4c10",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/test/integration/component/test_assign_vm.py",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/component/test_assign_vm.py?ref=8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf",
                "deletions": 8,
                "filename": "test/integration/component/test_assign_vm.py",
                "patch": "@@ -112,6 +112,7 @@ def setUpClass(cls):\n                                     cls.services[\"ostype\"])\n         cls.services[\"virtual_machine\"][\"zoneid\"] = cls.zone.id\n         cls.services[\"virtual_machine\"][\"template\"] = cls.template.id\n+        cls.hypervisor = cls.testClient.getHypervisorInfo()\n \n         def create_domain_account_user(parentDomain=None):\n             domain  =  Domain.create(cls.api_client,\n@@ -415,17 +416,13 @@ def test_13_move_across_subdomain_vm_snapshot(self):\n         \"\"\"\n         # Validate the following:\n         # 1. deploy VM in sub subdomain1 with snapshot.\n-        # 3. assignVirtualMachine to subdomain2\n+        # 3. assign VM will fail with Exception as VM with snapshots cannot be assigned to other users.\n         if self.hypervisor.lower() in ['hyperv', 'lxc']:\n             self.skipTest(\"Snapshots feature is not supported on %s\" % self.hypervisor)\n         self.create_vm(self.sdomain_account_user1['account'], self.sdomain_account_user1['domain'], snapshot=True)\n-        self.virtual_machine.assign_virtual_machine(self.apiclient, self.sdomain_account_user2['account'].name ,self.sdomain_account_user2['domain'].id)\n-        snapshots = list_snapshots(self.apiclient,\n-                                   id=self.snapshot.id)\n-        self.assertEqual(snapshots,\n-                         None,\n-                         \"Snapshots stil present for a vm in domain\")\n-\n+        with self.assertRaises(Exception):\n+            self.virtual_machine.assign_virtual_machine(self.apiclient, self.sdomain_account_user2['account'].name ,self.sdomain_account_user2['domain'].id)\n+\t\t\n     @attr(tags = [\"advanced\"])\n     @log_test_exceptions\n     def test_14_move_across_subdomain_vm_project(self):",
                "raw_url": "https://github.com/apache/cloudstack/raw/8442a4d9dfcfdd7bb92e9039a7923f1c3915fddf/test/integration/component/test_assign_vm.py",
                "sha": "9d8ccea37b72bbf2fc329891d518ec9a4f6f3164",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9921: Fix NPE when storage garbage collector is running (#2139)\n\nSteps to reproduce issue\r\n\r\nDeploy a VM\r\nTake snapshot of the root volume\r\nDelete the snapshot\r\nBefore the garbage collector has run, shutdown the VM and assign the VM to other user.\r\nWhen garage collector executes NPE shows in the logs.",
        "parent": "https://github.com/apache/cloudstack/commit/4d7a9d82cc2df041c59a6d126b8b5d5228b3de5d",
        "repo": "cloudstack",
        "unit_tests": [
            "SnapshotDaoTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_850fb1a": {
        "bug_id": "cloudstack_850fb1a",
        "commit": "https://github.com/apache/cloudstack/commit/850fb1a557b8eec04de79124fea5b6f923530d66",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=850fb1a557b8eec04de79124fea5b6f923530d66",
                "deletions": 12,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -24,18 +24,6 @@\n \n import javax.inject.Inject;\n \n-import org.apache.cloudstack.api.command.admin.router.ConfigureOvsElementCmd;\n-import org.apache.cloudstack.api.command.admin.router.ConfigureVirtualRouterElementCmd;\n-import org.apache.cloudstack.api.command.admin.router.CreateVirtualRouterElementCmd;\n-import org.apache.cloudstack.api.command.admin.router.ListOvsElementsCmd;\n-import org.apache.cloudstack.api.command.admin.router.ListVirtualRouterElementsCmd;\n-import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n-import org.apache.cloudstack.network.topology.NetworkTopology;\n-import org.apache.cloudstack.network.topology.NetworkTopologyContext;\n-import org.apache.log4j.Logger;\n-import org.cloud.network.router.deployment.RouterDeploymentDefinition;\n-import org.cloud.network.router.deployment.RouterDeploymentDefinitionBuilder;\n-\n import com.cloud.agent.api.to.LoadBalancerTO;\n import com.cloud.configuration.ConfigurationManager;\n import com.cloud.dc.DataCenter;\n@@ -107,6 +95,18 @@\n import com.cloud.vm.dao.UserVmDao;\n import com.google.gson.Gson;\n \n+import org.apache.cloudstack.api.command.admin.router.ConfigureOvsElementCmd;\n+import org.apache.cloudstack.api.command.admin.router.ConfigureVirtualRouterElementCmd;\n+import org.apache.cloudstack.api.command.admin.router.CreateVirtualRouterElementCmd;\n+import org.apache.cloudstack.api.command.admin.router.ListOvsElementsCmd;\n+import org.apache.cloudstack.api.command.admin.router.ListVirtualRouterElementsCmd;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.network.topology.NetworkTopology;\n+import org.apache.cloudstack.network.topology.NetworkTopologyContext;\n+import org.apache.log4j.Logger;\n+import org.cloud.network.router.deployment.RouterDeploymentDefinition;\n+import org.cloud.network.router.deployment.RouterDeploymentDefinitionBuilder;\n+\n public class VirtualRouterElement extends AdapterBase implements VirtualRouterElementService, DhcpServiceProvider, UserDataServiceProvider, SourceNatServiceProvider,\n StaticNatServiceProvider, FirewallServiceProvider, LoadBalancingServiceProvider, PortForwardingServiceProvider, RemoteAccessVPNServiceProvider, IpDeployer,\n NetworkMigrationResponder, AggregatedCommandExecutor {\n@@ -153,6 +153,8 @@\n     IPAddressDao _ipAddressDao;\n     @Inject\n     DataCenterDao _dcDao;\n+    @Inject\n+    NetworkModel _networkModel;\n \n     @Inject\n     NetworkTopologyContext networkTopologyContext;",
                "raw_url": "https://github.com/apache/cloudstack/raw/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "d802188e4c4bd4c63a11e032085f4918af340b0c",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VpcVirtualRouterElement.java?ref=850fb1a557b8eec04de79124fea5b6f923530d66",
                "deletions": 9,
                "filename": "server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "patch": "@@ -25,13 +25,6 @@\n \n import javax.inject.Inject;\n \n-import org.apache.cloudstack.network.topology.NetworkTopology;\n-import org.apache.log4j.Logger;\n-import org.cloud.network.router.deployment.RouterDeploymentDefinition;\n-import org.cloud.network.router.deployment.RouterDeploymentDefinitionBuilder;\n-import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.beans.factory.annotation.Qualifier;\n-\n import com.cloud.dc.DataCenter;\n import com.cloud.dc.DataCenterVO;\n import com.cloud.deploy.DeployDestination;\n@@ -79,6 +72,13 @@\n import com.cloud.vm.VirtualMachineManager;\n import com.cloud.vm.VirtualMachineProfile;\n \n+import org.apache.cloudstack.network.topology.NetworkTopology;\n+import org.apache.log4j.Logger;\n+import org.cloud.network.router.deployment.RouterDeploymentDefinition;\n+import org.cloud.network.router.deployment.RouterDeploymentDefinitionBuilder;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+\n public class VpcVirtualRouterElement extends VirtualRouterElement implements VpcProvider, Site2SiteVpnServiceProvider, NetworkACLServiceProvider {\n \n     private static final Logger s_logger = Logger.getLogger(VpcVirtualRouterElement.class);\n@@ -466,7 +466,7 @@ public boolean deletePrivateGateway(final PrivateGateway gateway) throws Concurr\n             }\n         }\n \n-        return result > 0 ? true : false;\n+        return result == routers.size() ? true : false;\n     }\n \n     @Override\n@@ -559,9 +559,16 @@ public boolean applyACLItemsToPrivateGw(final PrivateGateway gateway, final List\n         final DataCenterVO dcVO = _dcDao.findById(network.getDataCenterId());\n         final NetworkTopology networkTopology = networkTopologyContext.retrieveNetworkTopology(dcVO);\n \n+        final Network privateNetwork = _networkModel.getNetwork(gateway.getNetworkId());\n+\n         boolean result = true;\n         for (final DomainRouterVO domainRouterVO : routers) {\n-            result = result && networkTopology.applyNetworkACLs(network, rules, domainRouterVO, isPrivateGateway);\n+            final NicProfile nicProfile = _networkModel.getNicProfile(domainRouterVO, privateNetwork.getId(), null);\n+            if (nicProfile != null) {\n+                result = result && networkTopology.applyNetworkACLs(network, rules, domainRouterVO, isPrivateGateway);\n+            } else {\n+                s_logger.warn(\"Nic Profile for router '\" + domainRouterVO + \"' has already been removed. Router is redundant = \" + domainRouterVO.getIsRedundantRouter());\n+            }\n         }\n         return result;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "sha": "9999ee62cb8f7a1953a3175009c8f2882060d19f",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/router/CommandSetupHelper.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/CommandSetupHelper.java?ref=850fb1a557b8eec04de79124fea5b6f923530d66",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/CommandSetupHelper.java",
                "patch": "@@ -58,6 +58,7 @@\n import com.cloud.agent.api.to.IpAddressTO;\n import com.cloud.agent.api.to.LoadBalancerTO;\n import com.cloud.agent.api.to.NetworkACLTO;\n+import com.cloud.agent.api.to.NicTO;\n import com.cloud.agent.api.to.PortForwardingRuleTO;\n import com.cloud.agent.api.to.StaticNatRuleTO;\n import com.cloud.agent.manager.Commands;\n@@ -504,7 +505,8 @@ public void createNetworkACLsCommands(final List<? extends NetworkACLItem> rules\n             }\n         }\n \n-        final SetNetworkACLCommand cmd = new SetNetworkACLCommand(rulesTO, _networkHelper.getNicTO(router, guestNetworkId, null));\n+        NicTO nicTO = _networkHelper.getNicTO(router, guestNetworkId, null);\n+        final SetNetworkACLCommand cmd = new SetNetworkACLCommand(rulesTO, nicTO);\n         cmd.setAccessDetail(NetworkElementCommand.ROUTER_IP, _routerControlHelper.getRouterControlIp(router.getId()));\n         cmd.setAccessDetail(NetworkElementCommand.ROUTER_GUEST_IP, _routerControlHelper.getRouterIpInNetwork(guestNetworkId, router.getId()));\n         cmd.setAccessDetail(NetworkElementCommand.GUEST_VLAN_TAG, guestVlan);",
                "raw_url": "https://github.com/apache/cloudstack/raw/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/router/CommandSetupHelper.java",
                "sha": "7208b2568139f4508b3b4b32e4ae94ceb432587b",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java?ref=850fb1a557b8eec04de79124fea5b6f923530d66",
                "deletions": 6,
                "filename": "server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -26,9 +26,6 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n-import org.apache.log4j.Logger;\n-import org.springframework.stereotype.Component;\n-\n import com.cloud.agent.api.Answer;\n import com.cloud.agent.api.Command;\n import com.cloud.agent.api.Command.OnError;\n@@ -91,6 +88,9 @@\n import com.cloud.vm.VirtualMachineProfile.Param;\n import com.cloud.vm.dao.VMInstanceDao;\n \n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n @Component\n public class VpcVirtualNetworkApplianceManagerImpl extends VirtualNetworkApplianceManagerImpl implements VpcVirtualNetworkApplianceManager {\n     private static final Logger s_logger = Logger.getLogger(VpcVirtualNetworkApplianceManagerImpl.class);\n@@ -531,16 +531,18 @@ protected boolean setupVpcPrivateNetwork(final VirtualRouter router, final boole\n \n     @Override\n     public boolean destroyPrivateGateway(final PrivateGateway gateway, final VirtualRouter router) throws ConcurrentOperationException, ResourceUnavailableException {\n+        boolean result = true;\n \n         if (!_networkModel.isVmPartOfNetwork(router.getId(), gateway.getNetworkId())) {\n             s_logger.debug(\"Router doesn't have nic for gateway \" + gateway + \" so no need to removed it\");\n-            return true;\n+            return result;\n         }\n \n         final Network privateNetwork = _networkModel.getNetwork(gateway.getNetworkId());\n+        final NicProfile nicProfile = _networkModel.getNicProfile(router, privateNetwork.getId(), null);\n \n         s_logger.debug(\"Releasing private ip for gateway \" + gateway + \" from \" + router);\n-        boolean result = setupVpcPrivateNetwork(router, false, _networkModel.getNicProfile(router, privateNetwork.getId(), null));\n+        result = setupVpcPrivateNetwork(router, false, nicProfile);\n         if (!result) {\n             s_logger.warn(\"Failed to release private ip for gateway \" + gateway + \" on router \" + router);\n             return false;\n@@ -706,7 +708,7 @@ public boolean startRemoteAccessVpn(final RemoteAccessVpn vpn, final VirtualRout\n             s_logger.error(\"Unable to start vpn: unable add users to vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId() + \" on domR: \"\n                     + router.getInstanceName() + \" due to \" + answer.getDetails());\n             throw new ResourceUnavailableException(\"Unable to start vpn: Unable to add users to vpn in zone \" + router.getDataCenterId() + \" for account \" + vpn.getAccountId()\n-                    + \" on domR: \" + router.getInstanceName() + \" due to \" + answer.getDetails(), DataCenter.class, router.getDataCenterId());\n+            + \" on domR: \" + router.getInstanceName() + \" due to \" + answer.getDetails(), DataCenter.class, router.getDataCenterId());\n         }\n         answer = cmds.getAnswer(\"startVpn\");\n         if (!answer.getResult()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "sha": "5785e2a6b5e72d670fbd82e88fe92e626ab673c5",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/vpc/NetworkACLManagerImpl.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/NetworkACLManagerImpl.java?ref=850fb1a557b8eec04de79124fea5b6f923530d66",
                "deletions": 8,
                "filename": "server/src/com/cloud/network/vpc/NetworkACLManagerImpl.java",
                "patch": "@@ -21,11 +21,6 @@\n \n import javax.inject.Inject;\n \n-import org.apache.cloudstack.context.CallContext;\n-import org.apache.cloudstack.framework.messagebus.MessageBus;\n-import org.apache.cloudstack.framework.messagebus.PublishScope;\n-import org.apache.log4j.Logger;\n-\n import com.cloud.configuration.ConfigurationManager;\n import com.cloud.event.ActionEvent;\n import com.cloud.event.EventTypes;\n@@ -52,6 +47,11 @@\n import com.cloud.utils.db.TransactionStatus;\n import com.cloud.utils.exception.CloudRuntimeException;\n \n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.cloudstack.framework.messagebus.MessageBus;\n+import org.apache.cloudstack.framework.messagebus.PublishScope;\n+import org.apache.log4j.Logger;\n+\n public class NetworkACLManagerImpl extends ManagerBase implements NetworkACLManager {\n     private static final Logger s_logger = Logger.getLogger(NetworkACLManagerImpl.class);\n \n@@ -335,10 +335,10 @@ public boolean revokeACLItemsForNetwork(final long networkId) throws ResourceUna\n \n     @Override\n     public boolean revokeACLItemsForPrivateGw(final PrivateGateway gateway) throws ResourceUnavailableException {\n-\n-        final List<NetworkACLItemVO> aclItems = _networkACLItemDao.listByACL(gateway.getNetworkACLId());\n+        final long networkACLId = gateway.getNetworkACLId();\n+        final List<NetworkACLItemVO> aclItems = _networkACLItemDao.listByACL(networkACLId);\n         if (aclItems.isEmpty()) {\n-            s_logger.debug(\"Found no network ACL Items for private gateway  id=\" + gateway.getId());\n+            s_logger.debug(\"Found no network ACL Items for private gateway 'id=\" + gateway.getId() + \"'\");\n             return true;\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/com/cloud/network/vpc/NetworkACLManagerImpl.java",
                "sha": "c64a36b7c9fa92bcff4ba4c76fe25c3d8654d334",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/org/apache/cloudstack/network/topology/AdvancedNetworkTopology.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/org/apache/cloudstack/network/topology/AdvancedNetworkTopology.java?ref=850fb1a557b8eec04de79124fea5b6f923530d66",
                "deletions": 6,
                "filename": "server/src/org/apache/cloudstack/network/topology/AdvancedNetworkTopology.java",
                "patch": "@@ -19,11 +19,6 @@\n \n import java.util.List;\n \n-import org.apache.log4j.Logger;\n-import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.beans.factory.annotation.Qualifier;\n-import org.springframework.stereotype.Component;\n-\n import com.cloud.dc.DataCenter;\n import com.cloud.deploy.DeployDestination;\n import com.cloud.exception.ConcurrentOperationException;\n@@ -52,6 +47,11 @@\n import com.cloud.vm.VirtualMachine.State;\n import com.cloud.vm.VirtualMachineProfile;\n \n+import org.apache.log4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n @Component\n public class AdvancedNetworkTopology extends BasicNetworkTopology {\n \n@@ -223,6 +223,7 @@ public boolean applyNetworkACLs(final Network network, final List<? extends Netw\n \n         final NetworkAclsRules aclsRules = new NetworkAclsRules(network, rules, isPrivateGateway);\n \n-        return applyRules(network, router, typeString, isPodLevelException, podId, failWhenDisconnect, new RuleApplierWrapper<RuleApplier>(aclsRules));\n+        final boolean result = applyRules(network, router, typeString, isPodLevelException, podId, failWhenDisconnect, new RuleApplierWrapper<RuleApplier>(aclsRules));\n+        return result;\n     }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/850fb1a557b8eec04de79124fea5b6f923530d66/server/src/org/apache/cloudstack/network/topology/AdvancedNetworkTopology.java",
                "sha": "f456fcee177490713b7b54916899f09b9a17694e",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9287 - Check if the nic profile has already been removed from a certain router\n\n   - In case of redundant VPCs, the ACL items are revoked in the first iteration. Since the econd iteration\n     is needed in order to remove the private network, we have to check if the nic profile is gone before trying\n     to revoke the ACL items again, which would throw a NPE.\n   - Some variable extraction in order to ease debugging.",
        "parent": "https://github.com/apache/cloudstack/commit/6a767732f959186e95c71d31a2ed49bb67a85473",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRouterElementTest.java",
            "VpcVirtualRouterElementTest.java",
            "NetworkACLManagerImplTest.java"
        ]
    },
    "cloudstack_852cf0e": {
        "bug_id": "cloudstack_852cf0e",
        "commit": "https://github.com/apache/cloudstack/commit/852cf0e6c7a06bb9fc9a4c6695a0b27fd8825ec8",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/852cf0e6c7a06bb9fc9a4c6695a0b27fd8825ec8/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java?ref=852cf0e6c7a06bb9fc9a4c6695a0b27fd8825ec8",
                "deletions": 3,
                "filename": "server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -261,9 +261,11 @@ protected void wakeupWorkers() {\n \n     @Override\n     public boolean scheduleMigration(final VMInstanceVO vm) {\n-        final HaWorkVO work = new HaWorkVO(vm.getId(), vm.getType(), WorkType.Migration, Step.Scheduled, vm.getHostId(), vm.getState(), 0, vm.getUpdated());\n-        _haDao.persist(work);\n-        wakeupWorkers();\n+        if (vm.getHostId() != null) {\n+            final HaWorkVO work = new HaWorkVO(vm.getId(), vm.getType(), WorkType.Migration, Step.Scheduled, vm.getHostId(), vm.getState(), 0, vm.getUpdated());\n+            _haDao.persist(work);\n+            wakeupWorkers();\n+        }\n         return true;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/852cf0e6c7a06bb9fc9a4c6695a0b27fd8825ec8/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "sha": "cf0bd0bcba5cb8ef0add75faf229851927e07638",
                "status": "modified"
            }
        ],
        "message": "fix migration npe when recovering",
        "parent": "https://github.com/apache/cloudstack/commit/ccc12793c63a9388f6503d5447519c6ef1c06859",
        "repo": "cloudstack",
        "unit_tests": [
            "HighAvailabilityManagerImplTest.java"
        ]
    },
    "cloudstack_85bb685": {
        "bug_id": "cloudstack_85bb685",
        "commit": "https://github.com/apache/cloudstack/commit/85bb685662507897dd6238c3ec723c5258eb54e4",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/85bb685662507897dd6238c3ec723c5258eb54e4/server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java?ref=85bb685662507897dd6238c3ec723c5258eb54e4",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java",
                "patch": "@@ -612,13 +612,14 @@ public boolean revokeNetworkACLItem(long ruleId) {\n \n             Vpc vpc = _entityMgr.findById(Vpc.class, acl.getVpcId());\n \n+            if((aclItem.getAclId() == NetworkACL.DEFAULT_ALLOW) || (aclItem.getAclId() == NetworkACL.DEFAULT_DENY)){\n+                throw new InvalidParameterValueException(\"ACL Items in default ACL cannot be deleted\");\n+            }\n+\n             Account caller = CallContext.current().getCallingAccount();\n \n             _accountMgr.checkAccess(caller, null, true, vpc);\n \n-            if((aclItem.getAclId() == NetworkACL.DEFAULT_ALLOW) || (aclItem.getAclId() == NetworkACL.DEFAULT_DENY)){\n-                throw new InvalidParameterValueException(\"ACL Items in default ACL cannot be deleted\");\n-            }\n         }\n         return _networkAclMgr.revokeNetworkACLItem(ruleId);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/85bb685662507897dd6238c3ec723c5258eb54e4/server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java",
                "sha": "bee4018145d28f58d16b77d5cf2d12cf3e704db2",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8072: Fixed NPE in deleting default ACL items in default ACL",
        "parent": "https://github.com/apache/cloudstack/commit/6fb9746e5eeacadc10b7d0977b03959683058b33",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkACLServiceImplTest.java"
        ]
    },
    "cloudstack_86df2c1": {
        "bug_id": "cloudstack_86df2c1",
        "commit": "https://github.com/apache/cloudstack/commit/86df2c1f8022bbd4417a06aea22693f14b1db733",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/86df2c1f8022bbd4417a06aea22693f14b1db733/vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java?ref=86df2c1f8022bbd4417a06aea22693f14b1db733",
                "deletions": 2,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java",
                "patch": "@@ -32,6 +32,7 @@\n import com.vmware.vim25.SelectionSpec;\n import com.vmware.vim25.TraversalSpec;\n \n+import com.cloud.exception.CloudException;\n import com.cloud.hypervisor.vmware.util.VmwareContext;\n import com.cloud.utils.Pair;\n \n@@ -181,7 +182,7 @@ public boolean deleteFile(String path, ManagedObjectReference morDc, boolean tes\n     }\n \n     public boolean copyDatastoreFile(String srcFilePath, ManagedObjectReference morSrcDc, ManagedObjectReference morDestDs, String destFilePath,\n-        ManagedObjectReference morDestDc, boolean forceOverwrite) throws Exception {\n+            ManagedObjectReference morDestDc, boolean forceOverwrite) throws Exception {\n \n         String srcDsName = getName();\n         DatastoreMO destDsMo = new DatastoreMO(_context, morDestDs);\n@@ -209,7 +210,7 @@ public boolean copyDatastoreFile(String srcFilePath, ManagedObjectReference morS\n     }\n \n     public boolean moveDatastoreFile(String srcFilePath, ManagedObjectReference morSrcDc, ManagedObjectReference morDestDs, String destFilePath,\n-        ManagedObjectReference morDestDc, boolean forceOverwrite) throws Exception {\n+            ManagedObjectReference morDestDc, boolean forceOverwrite) throws Exception {\n \n         String srcDsName = getName();\n         DatastoreMO destDsMo = new DatastoreMO(_context, morDestDs);\n@@ -342,6 +343,10 @@ public String searchFileInSubFolders(String fileName, boolean caseInsensitive) t\n         ArrayList<HostDatastoreBrowserSearchResults> results = browserMo.searchDatastoreSubFolders(\"[\" + getName() + \"]\", fileName, caseInsensitive);\n         if (results != null && results.size() > 1) {\n             s_logger.warn(\"Multiple files with name \" + fileName + \" exists in datastore \" + datastorePath + \". Trying to choose first file found in search attempt.\");\n+        } else if (results == null) {\n+            String msg = \"No file found with name \" + fileName + \" found in datastore \" + datastorePath;\n+            s_logger.error(msg);\n+            throw new CloudException(msg);\n         }\n         for (HostDatastoreBrowserSearchResults result : results) {\n             List<FileInfo> info = result.getFile();",
                "raw_url": "https://github.com/apache/cloudstack/raw/86df2c1f8022bbd4417a06aea22693f14b1db733/vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java",
                "sha": "363b91f9c68e395d8a804c9d537877379b7a1d18",
                "status": "modified"
            }
        ],
        "message": "Findbugs finding: Fix potential NPE",
        "parent": "https://github.com/apache/cloudstack/commit/e668c3f4e5cd7b1ea38ff5b8b5808b6c0879cb55",
        "repo": "cloudstack",
        "unit_tests": [
            "DatastoreMOTest.java"
        ]
    },
    "cloudstack_88c6072": {
        "bug_id": "cloudstack_88c6072",
        "commit": "https://github.com/apache/cloudstack/commit/88c6072b4dd4d4bdea196e915a8c7b2bb27feba0",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/88c6072b4dd4d4bdea196e915a8c7b2bb27feba0/utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java?ref=88c6072b4dd4d4bdea196e915a8c7b2bb27feba0",
                "deletions": 1,
                "filename": "utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java",
                "patch": "@@ -225,7 +225,11 @@ public static String generateSAMLRequestSignature(String urlEncodedString, Priva\n         Signature signature = Signature.getInstance(\"SHA1withRSA\");\n         signature.initSign(signingKey);\n         signature.update(url.getBytes());\n-        return url + \"&Signature=\" + URLEncoder.encode(Base64.encodeBytes(signature.sign(), Base64.DONT_BREAK_LINES), HttpUtils.UTF_8);\n+        String signatureString = Base64.encodeBytes(signature.sign(), Base64.DONT_BREAK_LINES);\n+        if (signatureString != null) {\n+            return url + \"&Signature=\" + URLEncoder.encode(signatureString, HttpUtils.UTF_8);\n+        }\n+        return url;\n     }\n \n     public static KeyFactory getKeyFactory() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/88c6072b4dd4d4bdea196e915a8c7b2bb27feba0/utils/src/org/apache/cloudstack/utils/auth/SAMLUtils.java",
                "sha": "36c4d0f90c49f90260225384bc1b3e684d91e428",
                "status": "modified"
            }
        ],
        "message": "CID-1237196: Fix potential NPE in SAMLUtils\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/ba93200917cc54317010c5f54c00fcfb5a5f9d23",
        "repo": "cloudstack",
        "unit_tests": [
            "SAMLUtilsTest.java"
        ]
    },
    "cloudstack_898051e": {
        "bug_id": "cloudstack_898051e",
        "commit": "https://github.com/apache/cloudstack/commit/898051ecff5c10540ea9a0933a0df3f752d87826",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/898051ecff5c10540ea9a0933a0df3f752d87826/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=898051ecff5c10540ea9a0933a0df3f752d87826",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -63,6 +63,7 @@\n import com.cloud.vm.UserVmManager;\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachineProfile;\n+import com.cloud.vm.VirtualMachine.State;\n import com.cloud.vm.dao.DomainRouterDao;\n import com.cloud.vm.dao.UserVmDao;\n \n@@ -153,17 +154,22 @@ public boolean restart(Network network, ReservationContext context) throws Concu\n         }\n \n         /* Get the host_id in order to find the cluster */\n-        long host_id = 0;\n+        Long host_id = new Long(0);\n         for (DomainRouterVO router : routers) {\n-            host_id = router.getHostId();\n+            if (host_id == null || host_id == 0) {\n+                host_id = (router.getHostId() != null ? router.getHostId() : router.getLastHostId());\n+            }\n             /* FIXME it's not completely safe to ignore these failure, but we would try to push on now */\n-            if (_routerMgr.stopRouter(router.getId(), false) == null) {\n+            if (router.getState() != State.Stopped || _routerMgr.stopRouter(router.getId(), false) == null) {\n                 s_logger.warn(\"Failed to stop virtual router element \" + router + \" as a part of network \" + network + \" restart\");\n             }\n             if (!_routerMgr.destroyRouter(router.getId())) {\n                 s_logger.warn(\"Failed to destroy virtual router element \" + router + \" as a part of network \" + network + \" restart\");\n             }\n         }\n+        if (host_id == null || host_id == 0) {\n+            throw new ResourceUnavailableException(\"Fail to locate virtual router element in network \" + network.getId(), this.getClass(), 0);\n+        }\n         \n         /* The cluster here is only used to determine hypervisor type, not the real deployment */\n         Cluster cluster = _configMgr.getCluster(_hostDao.findById(host_id).getClusterId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/898051ecff5c10540ea9a0933a0df3f752d87826/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "4cfc3fccbaaf1e71e4816446c7b13ab5a8a7f3c5",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/898051ecff5c10540ea9a0933a0df3f752d87826/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=898051ecff5c10540ea9a0933a0df3f752d87826",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1066,7 +1066,9 @@ private DomainRouterVO startVirtualRouter(DomainRouterVO router, User user, Acco\n                 if (state != State.Running) {\n                     router = startVirtualRouter(router, _accountService.getSystemUser(), _accountService.getSystemAccount(), params);\n                 }\n-                runningRouters.add(router);\n+                if (router != null) {\n+                    runningRouters.add(router);\n+                }\n             }\n         }\n         return runningRouters;",
                "raw_url": "https://github.com/apache/cloudstack/raw/898051ecff5c10540ea9a0933a0df3f752d87826/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "85e7236a4bb2de2a49f98219c59ef5b203ea8454",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when a router is fail to start\n\nAlso enforce the check for restartNetworkCommand",
        "parent": "https://github.com/apache/cloudstack/commit/bc8c78f102a2eeeb184a1d350f6e08997058cdd3",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRouterElementTest.java",
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_898990a": {
        "bug_id": "cloudstack_898990a",
        "commit": "https://github.com/apache/cloudstack/commit/898990a11dd86b7682a06a9fdf5e888c325a3d4a",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/898990a11dd86b7682a06a9fdf5e888c325a3d4a/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=898990a11dd86b7682a06a9fdf5e888c325a3d4a",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1988,7 +1988,7 @@ public DomainRouterVO findDomainRouterById(long domainRouterId) {\n     \t\t//right now, we made the decision to only list zones associated with this domain\n     \t\tdcs  = _dcDao.findZonesByDomainId(domainId); //private zones\n     \t}\n-    \telse if((account.getType() ==  Account.ACCOUNT_TYPE_ADMIN)){\n+    \telse if((account == null || account.getType() ==  Account.ACCOUNT_TYPE_ADMIN)){\n     \t\tdcs = _dcDao.listAll(); //all zones\n     \t}else if(account.getType() ==  Account.ACCOUNT_TYPE_NORMAL){\n     \t\t//it was decided to return all zones for the user's domain, and everything above till root",
                "raw_url": "https://github.com/apache/cloudstack/raw/898990a11dd86b7682a06a9fdf5e888c325a3d4a/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "6910478c99c285760c89eaeae6fa4563b3792002",
                "status": "modified"
            }
        ],
        "message": "fixing the npe which occurs when we list zones from 8096. this has a null account.",
        "parent": "https://github.com/apache/cloudstack/commit/01154ebf0fcd3ff6d21c21d8647d28ac597cc24d",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_8bc7ae6": {
        "bug_id": "cloudstack_8bc7ae6",
        "commit": "https://github.com/apache/cloudstack/commit/8bc7ae695d621b67e1e5d1916a1852cad1f4dda0",
        "file": [
            {
                "additions": 24,
                "blob_url": "https://github.com/apache/cloudstack/blob/8bc7ae695d621b67e1e5d1916a1852cad1f4dda0/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java?ref=8bc7ae695d621b67e1e5d1916a1852cad1f4dda0",
                "deletions": 5,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "patch": "@@ -928,7 +928,7 @@ protected NicTO toNicTO(NicVO nic, NicProfile profile, NetworkVO config) {\n \n     boolean isNetworkImplemented(NetworkVO network) {\n         Network.State state = network.getState();\n-        if (state == Network.State.Implemented || state == Network.State.Implementing) {\n+        if (state == Network.State.Implemented) {\n             return true;\n         } else if (state == Network.State.Setup) {\n             DataCenterVO zone = _dcDao.findById(network.getDataCenterId());\n@@ -939,6 +939,24 @@ boolean isNetworkImplemented(NetworkVO network) {\n         return false;\n     }\n \n+    Pair<NetworkGuru, NetworkVO> implementNetwork(long networkId, DeployDestination dest, ReservationContext context, boolean isRouter) throws ConcurrentOperationException,\n+    ResourceUnavailableException, InsufficientCapacityException {\n+        Pair<NetworkGuru, NetworkVO> implemented = null;\n+        if (!isRouter) {\n+            implemented = implementNetwork(networkId, dest, context);\n+        } else {\n+            // At the time of implementing network (using implementNetwork() method), if the VR needs to be deployed then\n+            // it follows the same path of regular VM deployment. This leads to a nested call to implementNetwork() while\n+            // preparing VR nics. This flow creates issues in dealing with network state transitions. The original call\n+            // puts network in \"Implementing\" state and then the nested call again tries to put it into same state resulting\n+            // in issues. In order to avoid it, implementNetwork() call for VR is replaced with below code.\n+            NetworkVO network = _networksDao.findById(networkId);\n+            NetworkGuru guru = AdapterBase.getAdapterByName(networkGurus, network.getGuruName());\n+            implemented = new Pair<NetworkGuru, NetworkVO>(guru, network);\n+        }\n+        return implemented;\n+    }\n+\n     @Override\n     @DB\n     public Pair<NetworkGuru, NetworkVO> implementNetwork(long networkId, DeployDestination dest, ReservationContext context) throws ConcurrentOperationException,\n@@ -1280,7 +1298,7 @@ public int compare(NicVO nic1, NicVO nic2) {\n         });\n \n         for (NicVO nic : nics) {\n-            Pair<NetworkGuru, NetworkVO> implemented = implementNetwork(nic.getNetworkId(), dest, context);\n+            Pair<NetworkGuru, NetworkVO> implemented = implementNetwork(nic.getNetworkId(), dest, context, vmProfile.getVirtualMachine().getType() == Type.DomainRouter);\n             if (implemented == null || implemented.first() == null) {\n                 s_logger.warn(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part of preparing nic id=\" + nic.getId());\n                 throw new CloudRuntimeException(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part preparing nic id=\" + nic.getId());\n@@ -3082,9 +3100,10 @@ public NicProfile createNicForVm(Network network, NicProfile requested, Reservat\n \n         //2) prepare nic\n         if (prepare) {\n-            Pair<NetworkGuru, NetworkVO> implemented = implementNetwork(nic.getNetworkId(), dest, context);\n-            if (implemented == null) {\n-                throw new CloudRuntimeException(\"Failed to prepare the nic as a part of creating nic \" + nic + \" for vm \"+ vm + \" due to network \" + network + \" implement failure\");\n+            Pair<NetworkGuru, NetworkVO> implemented = implementNetwork(nic.getNetworkId(), dest, context, vmProfile.getVirtualMachine().getType() == Type.DomainRouter);\n+            if (implemented == null || implemented.first() == null) {\n+                s_logger.warn(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part of preparing nic id=\" + nic.getId());\n+                throw new CloudRuntimeException(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part preparing nic id=\" + nic.getId());\n             }\n             nic = prepareNic(vmProfile, dest, context, nic.getId(), implemented.second());\n             s_logger.debug(\"Nic is prepared successfully for vm \" + vm + \" in network \" + network);",
                "raw_url": "https://github.com/apache/cloudstack/raw/8bc7ae695d621b67e1e5d1916a1852cad1f4dda0/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "sha": "ca0b86d0e168b38e885d69f22a272f6c883c092d",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7182: NPE while trying to deploy VMs in parallel in isolated network\n- Check to see if network is implemented changed from 'state == Implementing||Implemented' to 'state == Implemented'.\nThe earlier check was a hack to prevent the issue described below.\n- At the time of implementing network (using implementNetwork() method), if the VR needs to be deployed then it follows\nthe same path of regular VM deployment. This leads to a nested call to implementNetwork() while preparing VR nics. This\nflow creates issues in dealing with network state transitions. The original call puts network in \"Implementing\" state\nand then the nested call again tries to put it into same state resulting in issues. In order to avoid it, implementNetwork()\ncall for VR is replaced with below code.",
        "parent": "https://github.com/apache/cloudstack/commit/59ea2e2960b3447344365d2dfce745e0a7ba7816",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkOrchestratorTest.java"
        ]
    },
    "cloudstack_8c387f9": {
        "bug_id": "cloudstack_8c387f9",
        "commit": "https://github.com/apache/cloudstack/commit/8c387f9de6d76cfa983b6fa7f39b2e9df4be4266",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/8c387f9de6d76cfa983b6fa7f39b2e9df4be4266/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java?ref=8c387f9de6d76cfa983b6fa7f39b2e9df4be4266",
                "deletions": 1,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "patch": "@@ -3281,7 +3281,7 @@ public boolean isMemoryHotAddSupported(String guestOsId) throws Exception {\n         virtualHardwareVersion = getVirtualHardwareVersion();\n \n         // Check if guest operating system supports memory hotadd\n-        if (guestOsDescriptor.isSupportsMemoryHotAdd()) {\n+        if (guestOsDescriptor != null && guestOsDescriptor.isSupportsMemoryHotAdd()) {\n             guestOsSupportsMemoryHotAdd = true;\n         }\n         // Check if virtual machine is using hardware version 7 or later.",
                "raw_url": "https://github.com/apache/cloudstack/raw/8c387f9de6d76cfa983b6fa7f39b2e9df4be4266/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "sha": "1ab325be14ccf37bbcf91f20c39ae7d9b922f931",
                "status": "modified"
            }
        ],
        "message": "vmware: fix potential NPE when memory hotplug capability is checked (#3362)\n\nThis fixes potential NPE case when memory hotpluggability is checked\r\nbased on the guest OS descriptor.\r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/f6f381fc68dc4a27a6ec212966f55c58264596bc",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineMOTest.java"
        ]
    },
    "cloudstack_8c5cd42": {
        "bug_id": "cloudstack_8c5cd42",
        "commit": "https://github.com/apache/cloudstack/commit/8c5cd42b56c3161c6dbac714f4ba82f6b183b2ff",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/8c5cd42b56c3161c6dbac714f4ba82f6b183b2ff/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=8c5cd42b56c3161c6dbac714f4ba82f6b183b2ff",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1819,8 +1819,9 @@ public static boolean isAdmin(short accountType) {\n \n     @Override\n     public List<Class<?>> getCommands() {\n+        List<Class<?>> cmdList = new ArrayList<Class<?>>();\n         //TODO: Add cmd classes\n-        return null;\n+        return cmdList;\n     }\n \n     protected class EventPurgeTask implements Runnable {",
                "raw_url": "https://github.com/apache/cloudstack/raw/8c5cd42b56c3161c6dbac714f4ba82f6b183b2ff/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "5306bc0928db7e9869a15587af5f1eff33e46c4a",
                "status": "modified"
            }
        ],
        "message": "ManagementServerImpl: Fix NPE, PluggableService should not return null list\n\nSigned-off-by: Rohit Yadav <bhaisaab@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/d99f836d5d72fee807569bfb27ba53d2492ccfc8",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_8ce576d": {
        "bug_id": "cloudstack_8ce576d",
        "commit": "https://github.com/apache/cloudstack/commit/8ce576dde56a6477378f0da36416355277120b8b",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/8ce576dde56a6477378f0da36416355277120b8b/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=8ce576dde56a6477378f0da36416355277120b8b",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -197,7 +197,7 @@ public void incrementResourceCount(long accountId, ResourceType type, Long...del\n \n                 // on a per-domain basis, increment the count\n                 // FIXME:  can this increment be done on the database side in a custom update statement?\n-                Account account = _accountDao.findById(accountId);\n+                Account account = _accountDao.findByIdIncludingRemoved(accountId);\n                 Long domainId = account.getDomainId();\n                 while (domainId != null) {\n                     _resourceCountDao.updateDomainCount(domainId, type, true, numToIncrement);",
                "raw_url": "https://github.com/apache/cloudstack/raw/8ce576dde56a6477378f0da36416355277120b8b/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "1d64994f1bcc98f3056d35854b1008eefc4a8172",
                "status": "modified"
            }
        ],
        "message": "bug 8239: NPE while executing CreateSnapshotCmd\nstatus 8239: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/222c865975235ef0220098d0e866ba71f0504ce4",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_8e4644e": {
        "bug_id": "cloudstack_8e4644e",
        "commit": "https://github.com/apache/cloudstack/commit/8e4644e413777d0a58edd5405a928df8256fdbd9",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/api/src/com/cloud/vm/VmDetailConstants.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/vm/VmDetailConstants.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 1,
                "filename": "api/src/com/cloud/vm/VmDetailConstants.java",
                "patch": "@@ -19,7 +19,7 @@\n public interface VmDetailConstants {\n     public static final String KEYBOARD = \"keyboard\";\n     public static final String NIC_ADAPTER = \"nicAdapter\";\n-    public static final String ROOK_DISK_CONTROLLER = \"rootDiskController\";\n+    public static final String ROOT_DISK_CONTROLLER = \"rootDiskController\";\n     public static final String NESTED_VIRTUALIZATION_FLAG = \"nestedVirtualizationFlag\";\n     public static final String HYPERVISOR_TOOLS_VERSION = \"hypervisortoolsversion\";\n     public static final String DATA_DISK_CONTROLLER = \"dataDiskController\";",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/api/src/com/cloud/vm/VmDetailConstants.java",
                "sha": "d34afc13a1696aa00ebd9c047bd3a3af137656cf",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 2,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "patch": "@@ -200,10 +200,10 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n             }\n         }\n \n-        String diskDeviceType = details.get(VmDetailConstants.ROOK_DISK_CONTROLLER);\n+        String diskDeviceType = details.get(VmDetailConstants.ROOT_DISK_CONTROLLER);\n         if (userVm) {\n             if (diskDeviceType == null) {\n-                details.put(VmDetailConstants.ROOK_DISK_CONTROLLER, _vmwareMgr.getRootDiskController());\n+                details.put(VmDetailConstants.ROOT_DISK_CONTROLLER, _vmwareMgr.getRootDiskController());\n             }\n         }\n         String diskController = details.get(VmDetailConstants.DATA_DISK_CONTROLLER);",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "sha": "986000aa9389cf2e67953631a20eecbb5344a4fe",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 9,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "patch": "@@ -236,7 +236,7 @@\n import com.cloud.hypervisor.vmware.mo.NetworkDetails;\n import com.cloud.hypervisor.vmware.mo.TaskMO;\n import com.cloud.hypervisor.vmware.mo.VirtualEthernetCardType;\n-import com.cloud.hypervisor.vmware.mo.VirtualMachineDiskInfo;\n+import org.apache.cloudstack.utils.volume.VirtualMachineDiskInfo;\n import com.cloud.hypervisor.vmware.mo.VirtualMachineDiskInfoBuilder;\n import com.cloud.hypervisor.vmware.mo.VirtualMachineMO;\n import com.cloud.hypervisor.vmware.mo.VirtualSwitchType;\n@@ -1412,7 +1412,7 @@ protected StartAnswer execute(StartCommand cmd) {\n         String vmInternalCSName = names.first();\n         String vmNameOnVcenter = names.second();\n         String dataDiskController = vmSpec.getDetails().get(VmDetailConstants.DATA_DISK_CONTROLLER);\n-        String rootDiskController = vmSpec.getDetails().get(VmDetailConstants.ROOK_DISK_CONTROLLER);\n+        String rootDiskController = vmSpec.getDetails().get(VmDetailConstants.ROOT_DISK_CONTROLLER);\n \n         // If root disk controller is scsi, then data disk controller would also be scsi instead of using 'osdefault'\n         // This helps avoid mix of different scsi subtype controllers in instance.\n@@ -1451,7 +1451,7 @@ protected StartAnswer execute(StartCommand cmd) {\n                 s_logger.error(msg);\n                 throw new Exception(msg);\n             }\n-\n+            String guestOsId = translateGuestOsIdentifier(vmSpec.getArch(), vmSpec.getOs(), vmSpec.getPlatformEmulator()).value();\n             DiskTO[] disks = validateDisks(vmSpec.getDisks());\n             assert (disks.length > 0);\n             NicTO[] nics = vmSpec.getNics();\n@@ -1564,7 +1564,7 @@ protected StartAnswer execute(StartCommand cmd) {\n                         tearDownVm(vmMo);\n                     }else if (!hyperHost.createBlankVm(vmNameOnVcenter, vmInternalCSName, vmSpec.getCpus(), vmSpec.getMaxSpeed().intValue(),\n                             getReservedCpuMHZ(vmSpec), vmSpec.getLimitCpuUse(), (int)(vmSpec.getMaxRam() / (1024 * 1024)), getReservedMemoryMb(vmSpec),\n-                            translateGuestOsIdentifier(vmSpec.getArch(), vmSpec.getOs(), vmSpec.getPlatformEmulator()).value(), rootDiskDataStoreDetails.first(), false, controllerInfo, systemVm)) {\n+                            guestOsId, rootDiskDataStoreDetails.first(), false, controllerInfo, systemVm)) {\n                         throw new Exception(\"Failed to create VM. vmName: \" + vmInternalCSName);\n                     }\n                 }\n@@ -1588,7 +1588,6 @@ protected StartAnswer execute(StartCommand cmd) {\n             }\n \n             VirtualMachineConfigSpec vmConfigSpec = new VirtualMachineConfigSpec();\n-            String guestOsId = translateGuestOsIdentifier(vmSpec.getArch(), vmSpec.getOs(), vmSpec.getPlatformEmulator()).value();\n \n             VmwareHelper.setBasicVmConfig(vmConfigSpec, vmSpec.getCpus(), vmSpec.getMaxSpeed(),\n                     getReservedCpuMHZ(vmSpec), (int)(vmSpec.getMaxRam() / (1024 * 1024)), getReservedMemoryMb(vmSpec),\n@@ -2322,14 +2321,14 @@ private int getDiskController(VirtualMachineDiskInfo matchingExistingDisk, DiskT\n \n         if (vol.getType() == Volume.Type.ROOT) {\n             Map<String, String> vmDetails = vmSpec.getDetails();\n-            if (vmDetails != null && vmDetails.get(VmDetailConstants.ROOK_DISK_CONTROLLER) != null) {\n-                if (vmDetails.get(VmDetailConstants.ROOK_DISK_CONTROLLER).equalsIgnoreCase(\"scsi\")) {\n+            if (vmDetails != null && vmDetails.get(VmDetailConstants.ROOT_DISK_CONTROLLER) != null) {\n+                if (vmDetails.get(VmDetailConstants.ROOT_DISK_CONTROLLER).equalsIgnoreCase(\"scsi\")) {\n                     s_logger.info(\"Chose disk controller for vol \" + vol.getType() + \" -> scsi, based on root disk controller settings: \" +\n-                            vmDetails.get(VmDetailConstants.ROOK_DISK_CONTROLLER));\n+                            vmDetails.get(VmDetailConstants.ROOT_DISK_CONTROLLER));\n                     controllerKey = scsiControllerKey;\n                 } else {\n                     s_logger.info(\"Chose disk controller for vol \" + vol.getType() + \" -> ide, based on root disk controller settings: \" +\n-                            vmDetails.get(VmDetailConstants.ROOK_DISK_CONTROLLER));\n+                            vmDetails.get(VmDetailConstants.ROOT_DISK_CONTROLLER));\n                     controllerKey = ideControllerKey;\n                 }\n             } else {",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "sha": "dd419f2574ff61a1063af69fe313df34ff5cad52",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 18,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java",
                "patch": "@@ -33,6 +33,7 @@\n import java.util.concurrent.Executors;\n import java.util.concurrent.TimeUnit;\n \n+import com.google.common.base.Strings;\n import org.apache.commons.lang.StringUtils;\n import org.apache.log4j.Logger;\n \n@@ -88,7 +89,7 @@\n import com.cloud.hypervisor.vmware.mo.HostStorageSystemMO;\n import com.cloud.hypervisor.vmware.mo.HypervisorHostHelper;\n import com.cloud.hypervisor.vmware.mo.NetworkDetails;\n-import com.cloud.hypervisor.vmware.mo.VirtualMachineDiskInfo;\n+import org.apache.cloudstack.utils.volume.VirtualMachineDiskInfo;\n import com.cloud.hypervisor.vmware.mo.VirtualMachineMO;\n import com.cloud.hypervisor.vmware.mo.VmwareHypervisorHost;\n import com.cloud.hypervisor.vmware.resource.VmwareResource;\n@@ -1363,24 +1364,15 @@ private Answer attachVolume(Command cmd, DiskTO disk, boolean isAttach, boolean\n             AttachAnswer answer = new AttachAnswer(disk);\n \n             if (isAttach) {\n-                String dataDiskController = controllerInfo.get(VmDetailConstants.DATA_DISK_CONTROLLER);\n-                String rootDiskController = controllerInfo.get(VmDetailConstants.ROOK_DISK_CONTROLLER);\n-                DiskControllerType rootDiskControllerType = DiskControllerType.getType(rootDiskController);\n-\n-                if (dataDiskController == null) {\n-                    dataDiskController = getLegacyVmDataDiskController();\n-                } else if ((rootDiskControllerType == DiskControllerType.lsilogic) ||\n-                           (rootDiskControllerType == DiskControllerType.lsisas1068) ||\n-                           (rootDiskControllerType == DiskControllerType.pvscsi) ||\n-                           (rootDiskControllerType == DiskControllerType.buslogic)) {\n-                    //TODO: Support mix of SCSI controller types for single VM. If root disk is already over\n-                    //a SCSI controller then use the same for data volume as well. This limitation will go once mix\n-                    //of SCSI controller types for single VM.\n-                    dataDiskController = rootDiskController;\n-                } else if (DiskControllerType.getType(dataDiskController) == DiskControllerType.osdefault) {\n-                    dataDiskController = vmMo.getRecommendedDiskController(null);\n+                String diskController = getLegacyVmDataDiskController();\n+                if (controllerInfo != null &&\n+                        !Strings.isNullOrEmpty(controllerInfo.get(VmDetailConstants.DATA_DISK_CONTROLLER))) {\n+                    diskController = controllerInfo.get(VmDetailConstants.DATA_DISK_CONTROLLER);\n                 }\n-                vmMo.attachDisk(new String[] {datastoreVolumePath}, morDs, dataDiskController);\n+                if (DiskControllerType.getType(diskController) == DiskControllerType.osdefault) {\n+                    diskController = vmMo.getRecommendedDiskController(null);\n+                }\n+                vmMo.attachDisk(new String[] {datastoreVolumePath}, morDs, diskController);\n             } else {\n                 vmMo.removeAllSnapshots();\n                 vmMo.detachDisk(datastoreVolumePath, false);",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java",
                "sha": "567f8576d7bea6632df4a84b508660c1e28682bf",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/pom.xml",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/pom.xml?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 1,
                "filename": "pom.xml",
                "patch": "@@ -92,7 +92,7 @@\n     <cs.servlet.version>2.5</cs.servlet.version>\n     <cs.jstl.version>1.2</cs.jstl.version>\n     <cs.selenium.server.version>1.0-20081010.060147</cs.selenium.server.version>\n-    <cs.vmware.api.version>5.5</cs.vmware.api.version>\n+    <cs.vmware.api.version>6.0</cs.vmware.api.version>\n     <org.springframework.version>3.2.12.RELEASE</org.springframework.version>\n     <cs.mockito.version>1.9.5</cs.mockito.version>\n     <cs.powermock.version>1.5.3</cs.powermock.version>",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/pom.xml",
                "sha": "af9eb765665e23a9594250a27d12185a902663a3",
                "status": "modified"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 36,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -30,15 +30,18 @@\n \n import com.cloud.utils.EncryptionUtil;\n import com.cloud.utils.db.TransactionCallbackWithException;\n+import com.google.common.base.Strings;\n import com.google.gson.Gson;\n import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonParseException;\n \n import org.apache.cloudstack.api.command.user.volume.GetUploadParamsForVolumeCmd;\n import org.apache.cloudstack.api.response.GetUploadParamsResponse;\n import org.apache.cloudstack.engine.subsystem.api.storage.DataObject;\n import org.apache.cloudstack.engine.subsystem.api.storage.EndPoint;\n import org.apache.cloudstack.storage.command.TemplateOrVolumePostUploadCommand;\n import org.apache.cloudstack.utils.imagestore.ImageStoreUtil;\n+import org.apache.cloudstack.utils.volume.VirtualMachineDiskInfo;\n import org.apache.log4j.Logger;\n import org.apache.cloudstack.api.command.user.volume.AttachVolumeCmd;\n import org.apache.cloudstack.api.command.user.volume.CreateVolumeCmd;\n@@ -112,12 +115,14 @@\n import com.cloud.hypervisor.HypervisorCapabilitiesVO;\n import com.cloud.hypervisor.dao.HypervisorCapabilitiesDao;\n import com.cloud.org.Grouping;\n+import com.cloud.serializer.GsonHelper;\n import com.cloud.service.dao.ServiceOfferingDetailsDao;\n import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.storage.dao.DiskOfferingDao;\n import com.cloud.storage.dao.SnapshotDao;\n import com.cloud.storage.dao.VMTemplateDao;\n import com.cloud.storage.dao.VolumeDao;\n+import com.cloud.storage.dao.VolumeDetailsDao;\n import com.cloud.storage.snapshot.SnapshotApiService;\n import com.cloud.storage.snapshot.SnapshotManager;\n import com.cloud.template.TemplateManager;\n@@ -146,6 +151,7 @@\n import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.utils.fsm.NoTransitionException;\n import com.cloud.utils.fsm.StateMachine2;\n+import com.cloud.vm.UserVmManager;\n import com.cloud.vm.UserVmVO;\n import com.cloud.vm.VMInstanceVO;\n import com.cloud.vm.VirtualMachine;\n@@ -191,6 +197,8 @@\n     @Inject\n     VolumeDao _volsDao;\n     @Inject\n+    VolumeDetailsDao _volDetailDao;\n+    @Inject\n     HostDao _hostDao;\n     @Inject\n     SnapshotDao _snapshotDao;\n@@ -240,6 +248,9 @@\n     VmWorkJobDao _workJobDao;\n     @Inject\n     ClusterDetailsDao _clusterDetailsDao;\n+    @Inject\n+    UserVmManager _userVmMgr;\n+    protected Gson _gson;\n \n     private List<StoragePoolAllocator> _storagePoolAllocators;\n \n@@ -253,6 +264,7 @@\n \n     protected VolumeApiServiceImpl() {\n         _volStateMachine = Volume.State.getStateMachine();\n+        _gson = GsonHelper.getGsonLogger();\n     }\n \n     /*\n@@ -1835,6 +1847,26 @@ private Volume orchestrateDetachVolumeFromVM(long vmId, long volumeId) {\n         }\n     }\n \n+    public void updateMissingRootDiskController(final VMInstanceVO vm, final String rootVolChainInfo) {\n+        if (vm == null || !VirtualMachine.Type.User.equals(vm.getType()) || Strings.isNullOrEmpty(rootVolChainInfo)) {\n+            return;\n+        }\n+        String rootDiskController = null;\n+        try {\n+            final VirtualMachineDiskInfo infoInChain = _gson.fromJson(rootVolChainInfo, VirtualMachineDiskInfo.class);\n+            if (infoInChain != null) {\n+                rootDiskController = infoInChain.getControllerFromDeviceBusName();\n+            }\n+            final UserVmVO userVmVo = _userVmDao.findById(vm.getId());\n+            if ((rootDiskController != null) && (!rootDiskController.isEmpty())) {\n+                _userVmDao.loadDetails(userVmVo);\n+                _userVmMgr.persistDeviceBusInfo(userVmVo, rootDiskController);\n+            }\n+        } catch (JsonParseException e) {\n+            s_logger.debug(\"Error parsing chain info json: \" + e.getMessage());\n+        }\n+    }\n+\n     @DB\n     @Override\n     @ActionEvent(eventType = EventTypes.EVENT_VOLUME_MIGRATE, eventDescription = \"migrating volume\", async = true)\n@@ -1924,6 +1956,7 @@ public Volume migrateVolume(MigrateVolumeCmd cmd) {\n                                 throw new InvalidParameterValueException(\"Cannot migrate ROOT volume of a stopped VM to a storage pool in a different VMware datacenter\");\n                             }\n                         }\n+                        updateMissingRootDiskController(vm, vol.getChainInfo());\n                     }\n                 }\n             }\n@@ -2472,9 +2505,10 @@ private VolumeVO sendAttachVolumeCommand(UserVmVO vm, VolumeVO volumeToAttach, L\n             }\n             _userVmDao.loadDetails(vm);\n             Map<String, String> controllerInfo = new HashMap<String, String>();\n-            controllerInfo.put(VmDetailConstants.ROOK_DISK_CONTROLLER, vm.getDetail(VmDetailConstants.ROOK_DISK_CONTROLLER));\n+            controllerInfo.put(VmDetailConstants.ROOT_DISK_CONTROLLER, vm.getDetail(VmDetailConstants.ROOT_DISK_CONTROLLER));\n             controllerInfo.put(VmDetailConstants.DATA_DISK_CONTROLLER, vm.getDetail(VmDetailConstants.DATA_DISK_CONTROLLER));\n             cmd.setControllerInfo(controllerInfo);\n+            s_logger.debug(\"Attach volume id:\" + volumeToAttach.getId() +  \" on VM id:\" + vm.getId() + \" has controller info:\" + controllerInfo);\n \n             try {\n                 answer = (AttachAnswer)_agentMgr.send(hostId, cmd);",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "fdd237cecaf38be359377203de70216a61bafeb9",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/server/src/com/cloud/vm/UserVmManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManager.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/UserVmManager.java",
                "patch": "@@ -114,4 +114,6 @@ UserVm updateVirtualMachine(long id, String displayName, String group, Boolean h\n     public void removeCustomOfferingDetails(long vmId);\n \n     void generateUsageEvent(VirtualMachine vm, boolean isDisplay, String eventType);\n+\n+    void persistDeviceBusInfo(UserVmVO paramUserVmVO, String paramString);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/server/src/com/cloud/vm/UserVmManager.java",
                "sha": "fe0e98c8cd593f67a307918d06c29c2d09d6340d",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 3,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -89,6 +89,7 @@\n import org.apache.cloudstack.storage.datastore.db.TemplateDataStoreDao;\n import org.apache.cloudstack.storage.datastore.db.TemplateDataStoreVO;\n import org.apache.commons.codec.binary.Base64;\n+import org.apache.commons.lang.StringUtils;\n import org.apache.log4j.Logger;\n \n import com.cloud.agent.AgentManager;\n@@ -3509,15 +3510,15 @@ public UserVmVO doInTransaction(TransactionStatus status) throws InsufficientCap\n                 if (hypervisorType.equals(HypervisorType.VMware)) {\n                     if (guestOS.getDisplayName().toLowerCase().contains(\"apple mac os\")) {\n                         vm.setDetail(\"smc.present\", \"TRUE\");\n-                        vm.setDetail(VmDetailConstants.ROOK_DISK_CONTROLLER, \"scsi\");\n+                        vm.setDetail(VmDetailConstants.ROOT_DISK_CONTROLLER, \"scsi\");\n                         vm.setDetail(VmDetailConstants.DATA_DISK_CONTROLLER, \"scsi\");\n                         vm.setDetail(\"firmware\", \"efi\");\n                         s_logger.info(\"guestOS is OSX : overwrite root disk controller to scsi, use smc and efi\");\n                     } else {\n                         String controllerSetting = _configDao.getValue(\"vmware.root.disk.controller\");\n                         // Don't override if VM already has root/data disk controller detail\n-                        if (vm.getDetail(VmDetailConstants.ROOK_DISK_CONTROLLER) == null) {\n-                            vm.setDetail(VmDetailConstants.ROOK_DISK_CONTROLLER, controllerSetting);\n+                        if (vm.getDetail(VmDetailConstants.ROOT_DISK_CONTROLLER) == null) {\n+                            vm.setDetail(VmDetailConstants.ROOT_DISK_CONTROLLER, controllerSetting);\n                         }\n                         if (vm.getDetail(VmDetailConstants.DATA_DISK_CONTROLLER) == null) {\n                             if (controllerSetting.equalsIgnoreCase(\"scsi\")) {\n@@ -5455,6 +5456,17 @@ private void encryptAndStorePassword(UserVmVO vm, String password) {\n         }\n     }\n \n+    public void persistDeviceBusInfo(UserVmVO vm, String rootDiskController) {\n+        String existingVmRootDiskController = vm.getDetail(VmDetailConstants.ROOT_DISK_CONTROLLER);\n+        if (StringUtils.isEmpty(existingVmRootDiskController) && !StringUtils.isEmpty(rootDiskController)) {\n+            vm.setDetail(VmDetailConstants.ROOT_DISK_CONTROLLER, rootDiskController);\n+            _vmDao.saveDetails(vm);\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Persisted device bus information rootDiskController=\" + rootDiskController + \" for vm: \" + vm.getDisplayName());\n+            }\n+        }\n+    }\n+\n     @Override\n     public String getConfigComponentName() {\n         return UserVmManager.class.getSimpleName();",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "832a94881765ccf2455a6daab7a0026b7f88299f",
                "status": "modified"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/server/test/com/cloud/storage/VolumeApiServiceImplTest.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/storage/VolumeApiServiceImplTest.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 0,
                "filename": "server/test/com/cloud/storage/VolumeApiServiceImplTest.java",
                "patch": "@@ -18,7 +18,11 @@\n \n import static org.mockito.Matchers.any;\n import static org.mockito.Matchers.anyLong;\n+import static org.mockito.Matchers.anyString;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n \n import java.lang.reflect.Field;\n@@ -28,7 +32,10 @@\n \n import javax.inject.Inject;\n \n+import com.cloud.serializer.GsonHelper;\n import com.cloud.user.User;\n+import com.cloud.vm.UserVmManager;\n+import com.cloud.vm.VirtualMachine;\n import junit.framework.Assert;\n import org.apache.cloudstack.api.command.user.volume.CreateVolumeCmd;\n import org.junit.After;\n@@ -101,6 +108,8 @@\n     VolumeService volService;\n     @Mock\n     CreateVolumeCmd createVol;\n+    @Mock\n+    UserVmManager _userVmMgr;\n \n     DetachVolumeCmd detachCmd = new DetachVolumeCmd();\n     Class<?> _detachCmdClass = detachCmd.getClass();\n@@ -118,6 +127,8 @@ public void setup() throws Exception {\n         _svc._jobMgr = _jobMgr;\n         _svc.volFactory = _volFactory;\n         _svc.volService = volService;\n+        _svc._userVmMgr = _userVmMgr;\n+        _svc._gson = GsonHelper.getGsonLogger();\n \n         // mock caller context\n         AccountVO account = new AccountVO(\"admin\", 1L, \"networkDomain\", Account.ACCOUNT_TYPE_NORMAL, \"uuid\");\n@@ -383,6 +394,20 @@ public void testNonEmptyGetVolumeNameFromCmd() {\n         Assert.assertSame(_svc.getVolumeNameFromCommand(createVol), \"abc\");\n     }\n \n+    @Test\n+    public void testUpdateMissingRootDiskControllerWithNullChainInfo() {\n+        _svc.updateMissingRootDiskController(null, null);\n+        verify(_svc._userVmMgr, times(0)).persistDeviceBusInfo(any(UserVmVO.class), anyString());\n+    }\n+\n+    @Test\n+    public void testUpdateMissingRootDiskControllerWithValidChainInfo() {\n+        UserVmVO vm = _svc._userVmDao.findById(1L);\n+        assert vm.getType() == VirtualMachine.Type.User;\n+        _svc.updateMissingRootDiskController(vm, \"{\\\"diskDeviceBusName\\\":\\\"scsi0:0\\\",\\\"diskChain\\\":[\\\"[somedatastore] i-3-VM-somePath/ROOT-1.vmdk\\\"]}\");\n+        verify(_svc._userVmMgr, times(1)).persistDeviceBusInfo(any(UserVmVO.class), eq(\"scsi\"));\n+    }\n+\n     @After\n     public void tearDown() {\n         CallContext.unregister();",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/server/test/com/cloud/storage/VolumeApiServiceImplTest.java",
                "sha": "71f6deddf60c0ba6b6a1cb2ac869b78cf6ce9c75",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/server/test/com/cloud/vm/UserVmManagerTest.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vm/UserVmManagerTest.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 0,
                "filename": "server/test/com/cloud/vm/UserVmManagerTest.java",
                "patch": "@@ -928,4 +928,25 @@ public void testUpdateVmNicIpFailure3() throws Exception {\n             CallContext.unregister();\n         }\n     }\n+\n+    @Test\n+    public void testPersistDeviceBusInfoWithNullController() {\n+        when(_vmMock.getDetail(any(String.class))).thenReturn(null);\n+        _userVmMgr.persistDeviceBusInfo(_vmMock, null);\n+        verify(_vmDao, times(0)).saveDetails(any(UserVmVO.class));\n+    }\n+\n+    @Test\n+    public void testPersistDeviceBusInfoWithEmptyController() {\n+        when(_vmMock.getDetail(any(String.class))).thenReturn(\"\");\n+        _userVmMgr.persistDeviceBusInfo(_vmMock, \"\");\n+        verify(_vmDao, times(0)).saveDetails(any(UserVmVO.class));\n+    }\n+\n+    @Test\n+    public void testPersistDeviceBusInfo() {\n+        when(_vmMock.getDetail(any(String.class))).thenReturn(null);\n+        _userVmMgr.persistDeviceBusInfo(_vmMock, \"lsilogic\");\n+        verify(_vmDao, times(1)).saveDetails(any(UserVmVO.class));\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/server/test/com/cloud/vm/UserVmManagerTest.java",
                "sha": "637a30922190c69d90a99b57c8d73229aaf8ff7a",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/utils/src/main/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfo.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/main/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfo.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 6,
                "filename": "utils/src/main/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfo.java",
                "patch": "@@ -15,14 +15,13 @@\n // specific language governing permissions and limitations\n // under the License.\n \n-package com.cloud.hypervisor.vmware.mo;\n+package org.apache.cloudstack.utils.volume;\n \n-public class VirtualMachineDiskInfo {\n-    String diskDeviceBusName;\n-    String[] diskChain;\n+import org.apache.commons.lang.StringUtils;\n \n-    public VirtualMachineDiskInfo() {\n-    }\n+public class VirtualMachineDiskInfo {\n+    private String diskDeviceBusName;\n+    private String[] diskChain;\n \n     public String getDiskDeviceBusName() {\n         return diskDeviceBusName;\n@@ -39,4 +38,11 @@ public void setDiskDeviceBusName(String diskDeviceBusName) {\n     public void setDiskChain(String[] diskChain) {\n         this.diskChain = diskChain;\n     }\n+\n+    public String getControllerFromDeviceBusName() {\n+        if (StringUtils.isEmpty(diskDeviceBusName) || !diskDeviceBusName.contains(\":\")) {\n+            return null;\n+        }\n+        return diskDeviceBusName.substring(0, diskDeviceBusName.indexOf(\":\") - 1);\n+    }\n }",
                "previous_filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineDiskInfo.java",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/utils/src/main/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfo.java",
                "sha": "c158f10d3a392df789838acbeab3ad4a5a754fa6",
                "status": "renamed"
            },
            {
                "additions": 55,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/utils/src/test/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfoTest.java",
                "changes": 55,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/test/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfoTest.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 0,
                "filename": "utils/src/test/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfoTest.java",
                "patch": "@@ -0,0 +1,55 @@\n+//\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+//\n+\n+package org.apache.cloudstack.utils.volume;\n+\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonParseException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class VirtualMachineDiskInfoTest {\n+\n+    @Test\n+    public void testGetControllerFromDeviceBusName() {\n+        VirtualMachineDiskInfo vmDiskInfo = new VirtualMachineDiskInfo();\n+        vmDiskInfo.setDiskDeviceBusName(\"scsi0:0\");\n+        String[] diskChain = new String[]{\"[somedatastore] i-3-VM-somePath/ROOT-1.vmdk\"};\n+        vmDiskInfo.setDiskChain(diskChain);\n+        Assert.assertEquals(vmDiskInfo.getControllerFromDeviceBusName(), \"scsi\");\n+        Assert.assertArrayEquals(vmDiskInfo.getDiskChain(), diskChain);\n+    }\n+\n+    @Test\n+    public void testGetControllerFromDeviceBusNameWithInvalidBusName() {\n+        VirtualMachineDiskInfo vmDiskInfo = new VirtualMachineDiskInfo();\n+        vmDiskInfo.setDiskDeviceBusName(\"scsi0\");\n+        Assert.assertEquals(vmDiskInfo.getControllerFromDeviceBusName(), null);\n+    }\n+\n+    @Test\n+    public void testGSonDeserialization() throws JsonParseException {\n+        VirtualMachineDiskInfo infoInChain = new GsonBuilder().create().fromJson(\"{\\\"diskDeviceBusName\\\":\\\"scsi0:0\\\",\\\"diskChain\\\":[\\\"[somedatastore] i-3-VM-somePath/ROOT-1.vmdk\\\"]}\", VirtualMachineDiskInfo.class);\n+        Assert.assertEquals(infoInChain.getDiskDeviceBusName(), \"scsi0:0\");\n+        Assert.assertEquals(infoInChain.getControllerFromDeviceBusName(), \"scsi\");\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/utils/src/test/java/org/apache/cloudstack/utils/volume/VirtualMachineDiskInfoTest.java",
                "sha": "8b858d4c9ab6afce8f6c00ec99f734543bc57016",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineDiskInfoBuilder.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineDiskInfoBuilder.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 0,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineDiskInfoBuilder.java",
                "patch": "@@ -17,6 +17,8 @@\n \n package com.cloud.hypervisor.vmware.mo;\n \n+import org.apache.cloudstack.utils.volume.VirtualMachineDiskInfo;\n+\n import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineDiskInfoBuilder.java",
                "sha": "3b310fb586e34b88212d7f222b5ccdd863efe3d7",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/8e4644e413777d0a58edd5405a928df8256fdbd9/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java?ref=8e4644e413777d0a58edd5405a928df8256fdbd9",
                "deletions": 1,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "patch": "@@ -2137,7 +2137,7 @@ public int getScsiDiskControllerKey(String diskController) throws Exception {\n         }\n \n         assert (false);\n-        throw new Exception(diskController + \" Controller Not Found\");\n+        throw new IllegalStateException(\"Scsi disk controller of type \" + diskController + \" not found among configured devices.\");\n     }\n \n     public int getScsiDiskControllerKeyNoException(String diskController) throws Exception {",
                "raw_url": "https://github.com/apache/cloudstack/raw/8e4644e413777d0a58edd5405a928df8256fdbd9/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "sha": "8b9d4e73beaa1dedcf10ecd09765a687658b0d06",
                "status": "modified"
            }
        ],
        "message": "vmware: improve support for disks\n\n- Improve disk chain usage while attaching, migrating disks\n- Gets root disk controller based diskDeviceBusName from volume's chain info\n- Refactor and move VirtualMachineDiskInfo to cloud-utils\n- Allows mixing of scsi controller types\n- Fixes a NPE case with map passed as null, for example in case of detach volume\n  command\n- Use a osdefault translator that allow use of recent os types added (enums of\n  which) are not available in the sdk\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/6f703c4cdc32f4edbf95a5c8f0959fab9beea01b",
        "repo": "cloudstack",
        "unit_tests": [
            "VMwareGuruTest.java",
            "VmwareResourceTest.java",
            "VolumeApiServiceImplTest.java",
            "UserVmManagerTest.java",
            "UserVmManagerImplTest.java",
            "VirtualMachineDiskInfoTest.java",
            "VirtualMachineMOTest.java"
        ]
    },
    "cloudstack_8f6fdc3": {
        "bug_id": "cloudstack_8f6fdc3",
        "commit": "https://github.com/apache/cloudstack/commit/8f6fdc3efc37a2e97d1b745e9109e1fc85a990f4",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/8f6fdc3efc37a2e97d1b745e9109e1fc85a990f4/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java?ref=8f6fdc3efc37a2e97d1b745e9109e1fc85a990f4",
                "deletions": 2,
                "filename": "plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "patch": "@@ -4333,8 +4333,13 @@ protected boolean getHostInfo(Connection conn) throws IllegalArgumentException{\n             }\n             XsLocalNetwork storageNic1 = null;\n             storageNic1 = getNetworkByName(conn, _storageNetworkName1);\n-            _host.storageNetwork1 = storageNic1.getNetworkRecord(conn).uuid;\n-            _host.storagePif1 = storageNic1.getPifRecord(conn).uuid;\n+            if (storageNic1 == null) {\n+                s_logger.warn(\"Unable to find storage network \" + _storageNetworkName1 + \" for host \" + _host.ip);\n+                throw new IllegalArgumentException(\"Unable to find storage network \" + _storageNetworkName1 + \" for host \" + _host.ip);\n+            } else {\n+                _host.storageNetwork1 = storageNic1.getNetworkRecord(conn).uuid;\n+                _host.storagePif1 = storageNic1.getPifRecord(conn).uuid;\n+            }\n \n             XsLocalNetwork storageNic2 = null;\n             if (_storageNetworkName2 != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/8f6fdc3efc37a2e97d1b745e9109e1fc85a990f4/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "sha": "36a12b1b4fa8163248daf5000e8c36dec2990574",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-227: Fix NPE and throw an exception if the network is not found in Xen\n\nSigned-off-by: Rohit Yadav <bhaisaab@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/f0c3b4c62a7a1a440d723696d61b42dad58f6faf",
        "repo": "cloudstack",
        "unit_tests": [
            "CitrixResourceBaseTest.java"
        ]
    },
    "cloudstack_8f9f39f": {
        "bug_id": "cloudstack_8f9f39f",
        "commit": "https://github.com/apache/cloudstack/commit/8f9f39fa39867467d73b58cd4b7de118cd8fa47f",
        "file": [
            {
                "additions": 808,
                "blob_url": "https://github.com/apache/cloudstack/blob/8f9f39fa39867467d73b58cd4b7de118cd8fa47f/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 1591,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=8f9f39fa39867467d73b58cd4b7de118cd8fa47f",
                "deletions": 783,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "raw_url": "https://github.com/apache/cloudstack/raw/8f9f39fa39867467d73b58cd4b7de118cd8fa47f/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "d6b2da5f45e23aba5915f643a7f014dcbeeec35f",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/cloudstack/blob/8f9f39fa39867467d73b58cd4b7de118cd8fa47f/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=8f9f39fa39867467d73b58cd4b7de118cd8fa47f",
                "deletions": 15,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -169,13 +169,13 @@\n import com.cloud.network.router.VirtualRouter.Role;\n import com.cloud.network.rules.FirewallRule;\n import com.cloud.network.rules.FirewallRule.Purpose;\n+import com.cloud.network.rules.FirewallRuleVO;\n import com.cloud.network.rules.LoadBalancerContainer.Scheme;\n import com.cloud.network.rules.PortForwardingRule;\n import com.cloud.network.rules.RulesManager;\n import com.cloud.network.rules.StaticNat;\n import com.cloud.network.rules.StaticNatImpl;\n import com.cloud.network.rules.StaticNatRule;\n-import com.cloud.network.rules.FirewallRuleVO;\n import com.cloud.network.rules.dao.PortForwardingRulesDao;\n import com.cloud.network.vpn.Site2SiteVpnManager;\n import com.cloud.offering.NetworkOffering;\n@@ -745,10 +745,14 @@ protected void runInContext() {\n                         final List<? extends Nic> routerNics = _nicDao.listByVmId(router.getId());\n                         for (final Nic routerNic : routerNics) {\n                             final Network network = _networkModel.getNetwork(routerNic.getNetworkId());\n-                            // Send network usage command for public nic in VPC\n-                            // VR\n-                            // Send network usage command for isolated guest nic\n-                            // of non VPC VR\n+                            // Send network usage command for public nic in VPC VR\n+                            // Send network usage command for isolated guest nic of non) VPC VR\n+\n+                            //[TODO] Avoiding the NPE now, but I have to find out what is going on with the network. - Wilder Rodrigues\n+                            if (network == null) {\n+                                s_logger.error(\"Could not find a network with ID => \" + routerNic.getNetworkId() + \". It might be a problem!\");\n+                                continue;\n+                            }\n                             if (forVpc && network.getTrafficType() == TrafficType.Public || !forVpc && network.getTrafficType() == TrafficType.Guest\n                                     && network.getGuestType() == Network.GuestType.Isolated) {\n                                 final NetworkUsageCommand usageCmd = new NetworkUsageCommand(privateIP, router.getHostName(), forVpc, routerNic.getIp4Address());\n@@ -1917,23 +1921,23 @@ protected void finalizeNetworkRulesForNetwork(final Commands cmds, final DomainR\n         }\n     }\n \n-    private void createDefaultEgressFirewallRule(List<FirewallRule> rules, long networkId) {\n+    private void createDefaultEgressFirewallRule(final List<FirewallRule> rules, final long networkId) {\n         String systemRule = null;\n \n         Boolean defaultEgressPolicy = false;\n-        NetworkVO network = _networkDao.findById(networkId);\n-        NetworkOfferingVO offering = _networkOfferingDao.findById(network.getNetworkOfferingId());\n+        final NetworkVO network = _networkDao.findById(networkId);\n+        final NetworkOfferingVO offering = _networkOfferingDao.findById(network.getNetworkOfferingId());\n         defaultEgressPolicy = offering.getEgressDefaultPolicy();\n \n \n         // construct rule when egress policy is true. In true case for VR we default allow rule need to be added\n         if (!defaultEgressPolicy) {\n             systemRule = String.valueOf(FirewallRule.FirewallRuleType.System);\n \n-            List<String> sourceCidr = new ArrayList<String>();\n+            final List<String> sourceCidr = new ArrayList<String>();\n \n             sourceCidr.add(NetUtils.ALL_CIDRS);\n-            FirewallRule rule = new FirewallRuleVO(null, null, null, null, \"all\", networkId, network.getAccountId(), network.getDomainId(), Purpose.Firewall, sourceCidr,\n+            final FirewallRule rule = new FirewallRuleVO(null, null, null, null, \"all\", networkId, network.getAccountId(), network.getDomainId(), Purpose.Firewall, sourceCidr,\n                     null, null, null, FirewallRule.TrafficType.Egress, FirewallRule.FirewallRuleType.System);\n \n             rules.add(rule);\n@@ -2023,6 +2027,7 @@ public boolean finalizeStart(final VirtualMachineProfile profile, final long hos\n                 final String errorDetails = \"Details: \" + answer.getDetails() + \" \" + answer.toString();\n                 // add alerts for the failed commands\n                 _alertMgr.sendAlert(AlertService.AlertType.ALERT_TYPE_DOMAIN_ROUTER, router.getDataCenterId(), router.getPodIdToDeployIn(), errorMessage, errorDetails);\n+                s_logger.error(answer.getDetails());\n                 s_logger.warn(errorMessage);\n                 // Stop the router if any of the commands failed\n                 return false;\n@@ -2590,20 +2595,20 @@ public boolean postStateTransitionEvent(final StateMachine2.Transition<State, Vi\n             if (vo.getType() == VirtualMachine.Type.DomainRouter) {\n                 // opaque -> <hostId, powerHostId>\n                 if (opaque != null && opaque instanceof Pair<?, ?>) {\n-                    Pair<?, ?> pair = (Pair<?, ?>)opaque;\n-                    Object first = pair.first();\n-                    Object second = pair.second();\n+                    final Pair<?, ?> pair = (Pair<?, ?>)opaque;\n+                    final Object first = pair.first();\n+                    final Object second = pair.second();\n                     // powerHostId cannot be null in case of out-of-band VM movement\n                     if (second != null && second instanceof Long) {\n-                        Long powerHostId = (Long)second;\n+                        final Long powerHostId = (Long)second;\n                         Long hostId = null;\n                         if (first != null && first instanceof Long) {\n                             hostId = (Long)first;\n                         }\n                         // The following scenarios are due to out-of-band VM movement\n                         // 1. If VM is in stopped state in CS due to 'PowerMissing' report from old host (hostId is null) and then there is a 'PowerOn' report from new host\n                         // 2. If VM is in running state in CS and there is a 'PowerOn' report from new host\n-                        if (hostId == null || (hostId.longValue() != powerHostId.longValue())) {\n+                        if (hostId == null || hostId.longValue() != powerHostId.longValue()) {\n                             s_logger.info(\"Schedule a router reboot task as router \" + vo.getId() + \" is powered-on out-of-band, need to reboot to refresh network rules\");\n                             _executor.schedule(new RebootTask(vo.getId()), 1000, TimeUnit.MICROSECONDS);\n                         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/8f9f39fa39867467d73b58cd4b7de118cd8fa47f/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "37abd7182a7e5ffb1fd0959154e6e70a86b6582a",
                "status": "modified"
            }
        ],
        "message": "[TK-3119] Fix NPEs and improve exception handling + error messages",
        "parent": "https://github.com/apache/cloudstack/commit/406af7e855f39adb4cb72486575ac90ecf57c873",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java",
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_901f52e": {
        "bug_id": "cloudstack_901f52e",
        "commit": "https://github.com/apache/cloudstack/commit/901f52eb99ea82effc8b50e6db8528ed42424681",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/901f52eb99ea82effc8b50e6db8528ed42424681/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=901f52eb99ea82effc8b50e6db8528ed42424681",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -821,7 +821,7 @@ private boolean deleteUserInternal(long userId) {\n                 s_logger.debug(\"Remove account \" + accountId);\n             }\n \n-            AccountVO account = _accountDao.findById(accountId);\n+            AccountVO account = _accountDao.findByIdIncludingRemoved(accountId);\n             deleteAccount(account);\n             EventUtils.saveEvent(Long.valueOf(1), Long.valueOf(1), EventVO.LEVEL_INFO, EventTypes.EVENT_USER_DELETE, \"User \" + username + \" (id: \" + userId\n                     + \") for accountId = \" + accountId + \" and domainId = \" + userAccount.getDomainId() + \" was deleted.\");",
                "raw_url": "https://github.com/apache/cloudstack/raw/901f52eb99ea82effc8b50e6db8528ed42424681/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "b346e2fa2747808224c94d0423fdd7b240d0a600",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/901f52eb99ea82effc8b50e6db8528ed42424681/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=901f52eb99ea82effc8b50e6db8528ed42424681",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -125,7 +125,7 @@ public void decrementResourceCount(long accountId, ResourceType type, Long...del\n \n                 // on a per-domain basis, decrement the count\n                 // FIXME:  can this decrement be done on the database side in a custom update statement?\n-                Account account = _accountDao.findById(accountId);\n+                Account account = _accountDao.findByIdIncludingRemoved(accountId);  // find all accounts, even removed accounts if this happens to be for an account that's being deleted\n                 Long domainId = account.getDomainId();\n                 while (domainId != null) {\n                     _resourceCountDao.updateDomainCount(domainId, type, false, numToDecrement);",
                "raw_url": "https://github.com/apache/cloudstack/raw/901f52eb99ea82effc8b50e6db8528ed42424681/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "05b2f75e68e3d712be2783e0824aaeb0f6fa808d",
                "status": "modified"
            }
        ],
        "message": "bug 6782:  incremental checkin for deleting an account.  Since there was a change to findById to not find removed objects, these NPEs pop up from time to time where we expected to find the object previously and now it's not found.  Since the account is getting deleted, do a findByIdIncludingRemoved to make sure the actual account object is retrieved.",
        "parent": "https://github.com/apache/cloudstack/commit/f26f40c04956f3fb429fcd0d98346aff38ba8c05",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java",
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_91a87f9": {
        "bug_id": "cloudstack_91a87f9",
        "commit": "https://github.com/apache/cloudstack/commit/91a87f9d8f34231dd7b580ed72ad7f0edef28acf",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/91a87f9d8f34231dd7b580ed72ad7f0edef28acf/server/src/com/cloud/api/ApiServlet.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiServlet.java?ref=91a87f9d8f34231dd7b580ed72ad7f0edef28acf",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiServlet.java",
                "patch": "@@ -97,8 +97,12 @@ private void processRequest(HttpServletRequest req, HttpServletResponse resp) {\n                     if (session != null) {  \r\n                         Long userId = (Long)session.getAttribute(\"userid\");\n                         Account account = (Account)session.getAttribute(\"accountobj\");\n+                        Long accountId = null;\n+                        if (account != null) {\n+                            accountId = account.getId();\n+                        }\n                         auditTrailSb.insert(0, \"(userId=\"+userId+ \n-                                \" accountId=\"+ account==null ? null:account.getId()+ \n+                                \" accountId=\"+ accountId + \n                                 \" sessionId=\"+session.getId() +\")\" );\r\n                         if (userId != null) {\r\n                             _apiServer.logoutUser(userId);\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/91a87f9d8f34231dd7b580ed72ad7f0edef28acf/server/src/com/cloud/api/ApiServlet.java",
                "sha": "5620015508fe6744661896fe23c125437b2f1337",
                "status": "modified"
            }
        ],
        "message": "bug 7155: fixed NPE in AuditTrial which used to happen when logout command was executed when session was already invalidated.\nstatus 7155: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/28dd8185ddb950e0c216eeef31efde3ce0fc3e56",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiServletTest.java"
        ]
    },
    "cloudstack_91bfedd": {
        "bug_id": "cloudstack_91bfedd",
        "commit": "https://github.com/apache/cloudstack/commit/91bfedd2c7ed7db86a5b1167bb955977da0f1817",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/91bfedd2c7ed7db86a5b1167bb955977da0f1817/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=91bfedd2c7ed7db86a5b1167bb955977da0f1817",
                "deletions": 4,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -744,14 +744,17 @@ protected boolean checkWorkItems(final VMInstanceVO vm, final State state) throw\n \n     protected <T extends VMInstanceVO> boolean changeState(final T vm, final Event event, final Long hostId, final ItWorkVO work, final Step step) throws NoTransitionException {\n         // FIXME: We should do this better.\n-        final Step previousStep = work.getStep();\n-        _workDao.updateStep(work, step);\n+        Step previousStep = null;\n+        if (work != null) {\n+            previousStep = work.getStep();\n+            _workDao.updateStep(work, step);\n+        }\n         boolean result = false;\n         try {\n             result = stateTransitTo(vm, event, hostId);\n             return result;\n         } finally {\n-            if (!result) {\n+            if (!result && work != null) {\n                 _workDao.updateStep(work, previousStep);\n             }\n         }\n@@ -1507,12 +1510,13 @@ private void advanceStop(final VMInstanceVO vm, final boolean cleanUpEvenIfUnabl\n             if (doCleanup) {\n                 if (cleanup(vmGuru, new VirtualMachineProfileImpl(vm), work, Event.StopRequested, cleanUpEvenIfUnableToStop)) {\n                     try {\n-                        if (s_logger.isDebugEnabled()) {\n+                        if (s_logger.isDebugEnabled() && work != null) {\n                             s_logger.debug(\"Updating work item to Done, id:\" + work.getId());\n                         }\n                         if (!changeState(vm, Event.AgentReportStopped, null, work, Step.Done)) {\n                             throw new CloudRuntimeException(\"Unable to stop \" + vm);\n                         }\n+\n                     } catch (final NoTransitionException e) {\n                         s_logger.warn(\"Unable to cleanup \" + vm);\n                         throw new CloudRuntimeException(\"Unable to stop \" + vm, e);",
                "raw_url": "https://github.com/apache/cloudstack/raw/91bfedd2c7ed7db86a5b1167bb955977da0f1817/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "03a37987752f51590c78c40fa7a65f5052aa7fa1",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9796 - Fix NPE in VirtualMachineManagerImpl.java\n\nThis checks the work variable for NULL in all cases where it is\nused.  Fixes CLOUDSTACK-9796.",
        "parent": "https://github.com/apache/cloudstack/commit/e860249e4f0cfc8b93b46f870efa2eeace8bb703",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_92ad6ab": {
        "bug_id": "cloudstack_92ad6ab",
        "commit": "https://github.com/apache/cloudstack/commit/92ad6abab0063771dffaabb7c9d6d8256083c5be",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/92ad6abab0063771dffaabb7c9d6d8256083c5be/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=92ad6abab0063771dffaabb7c9d6d8256083c5be",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -2609,7 +2609,7 @@ public void finalizeStop(VirtualMachineProfile<DomainRouterVO> profile, StopAnsw\n             List<? extends Nic> routerNics = _nicDao.listByVmId(profile.getId());\n             for (Nic nic : routerNics) {\n             \tNetwork network = _networkModel.getNetwork(nic.getNetworkId());\n-            \tif (network.getTrafficType() == TrafficType.Guest && nic.getBroadcastUri().getScheme().equals(\"pvlan\")) {\n+            \tif (network.getTrafficType() == TrafficType.Guest && nic.getBroadcastUri() != null && nic.getBroadcastUri().getScheme().equals(\"pvlan\")) {\n                 \tNicProfile nicProfile = new NicProfile(nic, network, nic.getBroadcastUri(), nic.getIsolationUri(), 0, false, \"pvlan-nic\");\n             \t\tsetupDhcpForPvlan(false, domR, domR.getHostId(), nicProfile);\n             \t}",
                "raw_url": "https://github.com/apache/cloudstack/raw/92ad6abab0063771dffaabb7c9d6d8256083c5be/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "b969be25fde564eb02b0a6eb0b120e94b5560ebf",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/92ad6abab0063771dffaabb7c9d6d8256083c5be/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=92ad6abab0063771dffaabb7c9d6d8256083c5be",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -3059,7 +3059,7 @@ public void finalizeStop(VirtualMachineProfile<UserVmVO> profile,\n         for (NicVO nic : nics) {\n             NetworkVO network = _networkDao.findById(nic.getNetworkId());\n             if (network.getTrafficType() == TrafficType.Guest) {\n-                if (nic.getBroadcastUri().getScheme().equals(\"pvlan\")) {\n+                if (nic.getBroadcastUri() != null && nic.getBroadcastUri().getScheme().equals(\"pvlan\")) {\n                 \tNicProfile nicProfile = new NicProfile(nic, network, nic.getBroadcastUri(), nic.getIsolationUri(), 0, false, \"pvlan-nic\");\n                 \tsetupVmForPvlan(false, vm.getHostId(), nicProfile);\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/92ad6abab0063771dffaabb7c9d6d8256083c5be/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "5e206567beda74e90f425ac2274512dc41b9c608",
                "status": "modified"
            }
        ],
        "message": "PVLAN: Fix NPE when VM are in allocated state\n\nIf vlan is not assigned for VM, nic.getBroadcastUri() would be null. Then just\nignore it.",
        "parent": "https://github.com/apache/cloudstack/commit/a75cf9a79d9f3f3c6c399b03e73362523e3d815a",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_9366290": {
        "bug_id": "cloudstack_9366290",
        "commit": "https://github.com/apache/cloudstack/commit/93662904236e3b888f07ad77d506d5d656d20b33",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/93662904236e3b888f07ad77d506d5d656d20b33/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=93662904236e3b888f07ad77d506d5d656d20b33",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -62,6 +62,7 @@\n import com.cloud.vm.UserVmManager;\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachineProfile;\n+import com.cloud.vm.VirtualMachine.State;\n import com.cloud.vm.dao.DomainRouterDao;\n import com.cloud.vm.dao.UserVmDao;\n \n@@ -152,17 +153,22 @@ public boolean restart(Network network, ReservationContext context) throws Concu\n         }\n         \n         /* Get the host_id in order to find the cluster */\n-        long host_id = 0;\n+        Long host_id = new Long(0);\n         for (DomainRouterVO router : routers) {\n-            host_id = router.getHostId();\n+            if (host_id == null || host_id == 0) {\n+                host_id = (router.getHostId() != null ? router.getHostId() : router.getLastHostId());\n+            }\n             /* FIXME it's not completely safe to ignore these failure, but we would try to push on now */\n-            if (_routerMgr.stopRouter(router.getId(), false) == null) {\n+            if (router.getState() != State.Stopped || _routerMgr.stopRouter(router.getId(), false) == null) {\n                 s_logger.warn(\"Failed to stop virtual router element \" + router + \" as a part of network \" + network + \" restart\");\n             }\n             if (!_routerMgr.destroyRouter(router.getId())) {\n                 s_logger.warn(\"Failed to destroy virtual router element \" + router + \" as a part of network \" + network + \" restart\");\n             }\n         }\n+        if (host_id == null || host_id == 0) {\n+            throw new ResourceUnavailableException(\"Fail to locate virtual router element in network \" + network.getId(), this.getClass(), 0);\n+        }\n         \n         /* The cluster here is only used to determine hypervisor type, not the real deployment */\n         Cluster cluster = _configMgr.getCluster(_hostDao.findById(host_id).getClusterId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/93662904236e3b888f07ad77d506d5d656d20b33/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "661930a51d744d7719be65dbd25d3e75381273c4",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/93662904236e3b888f07ad77d506d5d656d20b33/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=93662904236e3b888f07ad77d506d5d656d20b33",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1061,7 +1061,9 @@ private DomainRouterVO startVirtualRouter(DomainRouterVO router, User user, Acco\n                 if (state != State.Running) {\n                     router = startVirtualRouter(router, _accountService.getSystemUser(), _accountService.getSystemAccount(), params);\n                 }\n-                runningRouters.add(router);\n+                if (router != null) {\n+                    runningRouters.add(router);\n+                }\n             }\n         }\n         return runningRouters;",
                "raw_url": "https://github.com/apache/cloudstack/raw/93662904236e3b888f07ad77d506d5d656d20b33/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "9cfba5d02fa92f19f725dad40b675e54d1e14561",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when a router is fail to start\n\nAlso enforce the check for restartNetworkCommand",
        "parent": "https://github.com/apache/cloudstack/commit/92131e985975c2d8930875c2168e18ff8364041d",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRouterElementTest.java",
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_954dacd": {
        "bug_id": "cloudstack_954dacd",
        "commit": "https://github.com/apache/cloudstack/commit/954dacdbda8ab41bcd5dca12f2b19fbc55c11ec9",
        "file": [
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/cloudstack/blob/954dacdbda8ab41bcd5dca12f2b19fbc55c11ec9/agent/src/com/cloud/agent/resource/computing/LibvirtDomainXMLParser.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/agent/src/com/cloud/agent/resource/computing/LibvirtDomainXMLParser.java?ref=954dacdbda8ab41bcd5dca12f2b19fbc55c11ec9",
                "deletions": 14,
                "filename": "agent/src/com/cloud/agent/resource/computing/LibvirtDomainXMLParser.java",
                "patch": "@@ -137,21 +137,27 @@ public boolean parseDomainXML(String domXML) {\n         return false;\n \t}\n \t\n-\t private static String getTagValue(String tag, Element eElement){\n-\t        NodeList nlList= eElement.getElementsByTagName(tag).item(0).getChildNodes();\n-\t        Node nValue = (Node) nlList.item(0); \n-\t     \n-\t        return nValue.getNodeValue();    \n-\t     }\n+\tprivate static String getTagValue(String tag, Element eElement){\n+\t    NodeList tagNodeList = eElement.getElementsByTagName(tag);\n+\t    if (tagNodeList == null || tagNodeList.getLength() == 0) {\n+\t        return null;\n+\t    }\n \t    \n-\t    private static String getAttrValue(String tag, String attr, Element eElement){\n-\t        NodeList tagNode = eElement.getElementsByTagName(tag);\n-\t        if (tagNode.getLength() == 0) {\n-\t            return null;\n-\t        }\n-\t        Element node = (Element)tagNode.item(0);\n-\t        return node.getAttribute(attr);\n-\t     }\n+\t    NodeList nlList= tagNodeList.item(0).getChildNodes();\n+\n+\t    Node nValue = (Node) nlList.item(0); \n+\n+\t    return nValue.getNodeValue();    \n+\t}\n+\n+\tprivate static String getAttrValue(String tag, String attr, Element eElement){\n+\t    NodeList tagNode = eElement.getElementsByTagName(tag);\n+\t    if (tagNode.getLength() == 0) {\n+\t        return null;\n+\t    }\n+\t    Element node = (Element)tagNode.item(0);\n+\t    return node.getAttribute(attr);\n+\t}\n \t\n \tpublic Integer getVncPort() {\n \t\treturn vncPort;",
                "raw_url": "https://github.com/apache/cloudstack/raw/954dacdbda8ab41bcd5dca12f2b19fbc55c11ec9/agent/src/com/cloud/agent/resource/computing/LibvirtDomainXMLParser.java",
                "sha": "59a7c99face56673cc556c6fdcd55ec4482800f5",
                "status": "modified"
            }
        ],
        "message": "fix NPE on centos when dumpxml",
        "parent": "https://github.com/apache/cloudstack/commit/c93abe014c54a07de3ec63a177c7d2a3f22db1c9",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtDomainXMLParserTest.java"
        ]
    },
    "cloudstack_95c7ffb": {
        "bug_id": "cloudstack_95c7ffb",
        "commit": "https://github.com/apache/cloudstack/commit/95c7ffbd46f9f674b8813a7b992c17019eb00137",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/95c7ffbd46f9f674b8813a7b992c17019eb00137/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java?ref=95c7ffbd46f9f674b8813a7b992c17019eb00137",
                "deletions": 6,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "patch": "@@ -6241,11 +6241,11 @@ private long getVMSnapshotChainSize(Connection conn, VolumeObjectTO volumeTo, St\n                     // add size of snapshot vdi node, usually this only contains meta data\n                     size = size + vdi.getPhysicalUtilisation(conn);\n                     // add size of snapshot vdi parent, this contains data\n-                    if (parentVDI != null)\n+                    if (!isRefNull(parentVDI))\n                         size = size + parentVDI.getPhysicalUtilisation(conn).longValue();\n                 }\n             } catch (Exception e) {\n-                s_logger.debug(\"Exception occurs when calculate \" + \"snapshot capacity for volumes: \" + e.getMessage());\n+                s_logger.debug(\"Exception occurs when calculate snapshot capacity for volumes: due to \" + e.toString());\n                 continue;\n             }\n         }\n@@ -6257,13 +6257,17 @@ private long getVMSnapshotChainSize(Connection conn, VolumeObjectTO volumeTo, St\n                     try {\n                         String vName = vmr.getNameLabel(conn);\n                         if (vName != null && vName.contains(vmName) && vmr.getIsASnapshot(conn)) {\n-\n                             VDI memoryVDI = vmr.getSuspendVDI(conn);\n-                            size = size + memoryVDI.getParent(conn).getPhysicalUtilisation(conn);\n-                            size = size + memoryVDI.getPhysicalUtilisation(conn);\n+                            if (!isRefNull(memoryVDI)) {\n+                                size = size + memoryVDI.getPhysicalUtilisation(conn);\n+                                VDI pMemoryVDI = memoryVDI.getParent(conn);\n+                                if (!isRefNull(pMemoryVDI)) {\n+                                    size = size + pMemoryVDI.getPhysicalUtilisation(conn);\n+                                }\n+                            }\n                         }\n                     } catch (Exception e) {\n-                        s_logger.debug(\"Exception occurs when calculate \" + \"snapshot capacity for memory: \" + e.getMessage());\n+                        s_logger.debug(\"Exception occurs when calculate snapshot capacity for memory: due to \" + e.toString());\n                         continue;\n                     }\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/95c7ffbd46f9f674b8813a7b992c17019eb00137/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java",
                "sha": "b669181932eaa4df9a713125b11fab0c63164a18",
                "status": "modified"
            }
        ],
        "message": "fixed NPE on calculating vm snasphot volume size",
        "parent": "https://github.com/apache/cloudstack/commit/e717450e0edd2406c4c3fc7341b3669c4390d507",
        "repo": "cloudstack",
        "unit_tests": [
            "CitrixResourceBaseTest.java"
        ]
    },
    "cloudstack_95daa14": {
        "bug_id": "cloudstack_95daa14",
        "commit": "https://github.com/apache/cloudstack/commit/95daa14e2ac4bec09cfad890220e98eaa577c134",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/95daa14e2ac4bec09cfad890220e98eaa577c134/server/src/com/cloud/server/StatsCollector.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=95daa14e2ac4bec09cfad890220e98eaa577c134",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -260,7 +260,7 @@ private void init(Map<String, String> configs) {\n \n         /* URI to send statistics to. Currently only Graphite is supported */\n         String externalStatsUri = configs.get(\"stats.output.uri\");\n-        if (externalStatsUri != null) {\n+        if (externalStatsUri != null && !externalStatsUri.equals(\"\")) {\n             try {\n                 URI uri = new URI(externalStatsUri);\n                 String scheme = uri.getScheme();",
                "raw_url": "https://github.com/apache/cloudstack/raw/95daa14e2ac4bec09cfad890220e98eaa577c134/server/src/com/cloud/server/StatsCollector.java",
                "sha": "cd4475f90be99f99401c18ac9f402b5b19d15695",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7583: Fix NPE caused by previous commit",
        "parent": "https://github.com/apache/cloudstack/commit/69ee01af9df8d72ccd8901d146726e74edda95d7",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_96b5c08": {
        "bug_id": "cloudstack_96b5c08",
        "commit": "https://github.com/apache/cloudstack/commit/96b5c08250984b50369eafe4a850fdad902ce70f",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/96b5c08250984b50369eafe4a850fdad902ce70f/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=96b5c08250984b50369eafe4a850fdad902ce70f",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1152,7 +1152,7 @@ public boolean deleteEvents(DeleteEventsCmd cmd) {\n         }\n \n         // Check if the vm is using any disks on local storage.\n-        VirtualMachineProfile vmProfile = new VirtualMachineProfileImpl(vm);\n+        VirtualMachineProfile vmProfile = new VirtualMachineProfileImpl(vm, null, _offeringDao.findById(vm.getId(), vm.getServiceOfferingId()), null, null);\n         List<VolumeVO> volumes = _volumeDao.findCreatedByInstance(vmProfile.getId());\n         boolean usesLocal = false;\n         for (VolumeVO volume : volumes) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/96b5c08250984b50369eafe4a850fdad902ce70f/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "2227c995ad018e53d5efe2c83162f68dda7e3a92",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7136. While listing hosts for migration, the offering details were\nnot correctly initialized in the vmprofile. With a custom offering the cpu,\ncpu-speed and memory were getting initialized to null which caused a NPE in\nthe allocator. Fixed it by explicitly initializing the offering details in the\nvm profile before calling into the allocator for listing suitable hosts.",
        "parent": "https://github.com/apache/cloudstack/commit/fc14fe1132d03ad8828faf434989d3cd394d023b",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_96bb6a7": {
        "bug_id": "cloudstack_96bb6a7",
        "commit": "https://github.com/apache/cloudstack/commit/96bb6a7b7cca090b6347a3a581828f2b670a5f61",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/96bb6a7b7cca090b6347a3a581828f2b670a5f61/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=96bb6a7b7cca090b6347a3a581828f2b670a5f61",
                "deletions": 3,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -289,7 +289,7 @@ public UserVm resetVMPassword(ResetVMPasswordCmd cmd, String password) throws Re\n     \t    throw new InvalidParameterValueException(\"unable to find a virtual machine with id \" + cmd.getId());\n     \t}\n     \t\n-    \tVMTemplateVO template = _templateDao.findById(userVm.getTemplateId());\n+    \tVMTemplateVO template = _templateDao.findByIdIncludingRemoved(userVm.getTemplateId());\n     \tif (template == null || !template.getEnablePassword()) {\n     \t    throw new InvalidParameterValueException(\"Fail to reset password for the virtual machine, the template is not password enabled\");\n     \t}\n@@ -319,7 +319,7 @@ private boolean resetVMPasswordInternal(ResetVMPasswordCmd cmd, String password)\n             return false;\n         }\n \n-        VMTemplateVO template = _templateDao.findById(vmInstance.getTemplateId());\n+        VMTemplateVO template = _templateDao.findByIdIncludingRemoved(vmInstance.getTemplateId());\n         if (template.getEnablePassword()) {\n             Nic defaultNic = _networkMgr.getDefaultNic(vmId);\n             if (defaultNic == null) {\n@@ -2240,7 +2240,7 @@ protected UserVm startVirtualMachine(DeployVMCmd cmd, Map<VirtualMachineProfile.\n \t    _vmDao.loadDetails(vm);\n \t    \n         // Check that the password was passed in and is valid\n-        VMTemplateVO template = _templateDao.findById(vm.getTemplateId());\n+        VMTemplateVO template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n         \n         String password = \"saved_password\";\n         if (template.getEnablePassword()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/96bb6a7b7cca090b6347a3a581828f2b670a5f61/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "8618b01d511d808b143bccd4f1ef9446f6f2019f",
                "status": "modified"
            }
        ],
        "message": "fix NPE that template was deleted",
        "parent": "https://github.com/apache/cloudstack/commit/a5816ce48e15d07897a9ab21d8c95a91adc3c415",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_972caf1": {
        "bug_id": "cloudstack_972caf1",
        "commit": "https://github.com/apache/cloudstack/commit/972caf1936f338d5f10c6bca7d32d29b785182d7",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/972caf1936f338d5f10c6bca7d32d29b785182d7/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=972caf1936f338d5f10c6bca7d32d29b785182d7",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1479,7 +1479,10 @@ public TemplateResponse createIsoResponse(VirtualMachineTemplate result) {\n             isoResponse.setChecksum(iso.getChecksum());\n             isoResponse.setPasswordEnabled(false);\n             \n-            populateOwner(isoResponse, iso);\n+            // add account ID and name\n+            Account owner = ApiDBUtils.findAccountById(iso.getAccountId());\n+            populateAccount(isoResponse, owner.getId());\n+            populateDomain(isoResponse, owner.getDomainId());\n             \n             isoResponse.setObjectName(\"iso\");\n             isoResponses.add(isoResponse);",
                "raw_url": "https://github.com/apache/cloudstack/raw/972caf1936f338d5f10c6bca7d32d29b785182d7/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "c449232e910220ad3587730f937ae6b53fc5fa4c",
                "status": "modified"
            }
        ],
        "message": "bug 11777: resolved NPE in listIsos - get domain id from the iso's account owner object\nstatus 11777: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/cd929e69fadec0fdd5fdd42f0e56f75b6d7273fd",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_97cdf2e": {
        "bug_id": "cloudstack_97cdf2e",
        "commit": "https://github.com/apache/cloudstack/commit/97cdf2eccd9b50eb58bf1531d17b078676496839",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/97cdf2eccd9b50eb58bf1531d17b078676496839/core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java?ref=97cdf2eccd9b50eb58bf1531d17b078676496839",
                "deletions": 1,
                "filename": "core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java",
                "patch": "@@ -192,7 +192,8 @@ private Answer execute(ComputeChecksumCommand cmd) {\n         }\n         finally {\n             try {\n-                is.close();\n+            \tif(is != null)\n+            \t\tis.close();\n             } catch (IOException e) {\n                 if(s_logger.isDebugEnabled()){\n                   s_logger.debug(\"Could not close the file \" +absoluteTemplatePath);   ",
                "raw_url": "https://github.com/apache/cloudstack/raw/97cdf2eccd9b50eb58bf1531d17b078676496839/core/src/com/cloud/storage/resource/NfsSecondaryStorageResource.java",
                "sha": "855ceb9b40c2297d534fe4f49b842c735c549972",
                "status": "modified"
            }
        ],
        "message": "bug 10618: another place that could possibly throw NPE",
        "parent": "https://github.com/apache/cloudstack/commit/70b1c69ef3a1c5f56bab0921670df74735581226",
        "repo": "cloudstack",
        "unit_tests": [
            "NfsSecondaryStorageResourceTest.java"
        ]
    },
    "cloudstack_983dee7": {
        "bug_id": "cloudstack_983dee7",
        "commit": "https://github.com/apache/cloudstack/commit/983dee7f20bdcfb27cab20a46905ed58a558cb73",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/983dee7f20bdcfb27cab20a46905ed58a558cb73/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java?ref=983dee7f20bdcfb27cab20a46905ed58a558cb73",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "patch": "@@ -153,6 +153,7 @@ public void checkAndSendQuotaAlertEmails() {\n             BigDecimal thresholdBalance = quotaAccount.getQuotaMinBalance();\n             if (accountBalance != null) {\n                 AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                if (account == null) continue; // the account is removed\n                 if (s_logger.isDebugEnabled()) {\n                     s_logger.debug(\"checkAndSendQuotaAlertEmails: Check id=\" + account.getId() + \" bal=\" + accountBalance + \", alertDate=\" + alertDate + \", lockable=\" + lockable);\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/983dee7f20bdcfb27cab20a46905ed58a558cb73/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "sha": "a25ed04282507ba78c43df9dbf2f6075ae7a22d8",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/983dee7f20bdcfb27cab20a46905ed58a558cb73/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java?ref=983dee7f20bdcfb27cab20a46905ed58a558cb73",
                "deletions": 3,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "patch": "@@ -358,10 +358,11 @@ public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal a\n         BigDecimal rawusage;\n         // get service offering details\n         ServiceOfferingVO serviceoffering = _serviceOfferingDao.findServiceOffering(usageRecord.getVmInstanceId(), usageRecord.getOfferingId());\n+        if (serviceoffering == null) return quotalist;\n         rawusage = new BigDecimal(usageRecord.getRawUsage());\n \n         QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.CPU_NUMBER, usageRecord.getEndDate());\n-        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0 && serviceoffering.getCpu() != null) {\n             BigDecimal cpu = new BigDecimal(serviceoffering.getCpu());\n             onehourcostpercpu = tariff.getCurrencyValue().multiply(aggregationRatio);\n             cpuquotausgage = rawusage.multiply(onehourcostpercpu).multiply(cpu);\n@@ -371,7 +372,7 @@ public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal a\n             quotalist.add(quota_usage);\n         }\n         tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.CPU_CLOCK_RATE, usageRecord.getEndDate());\n-        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0 && serviceoffering.getSpeed() != null) {\n             BigDecimal speed = new BigDecimal(serviceoffering.getSpeed() / 100.00);\n             onehourcostper100mhz = tariff.getCurrencyValue().multiply(aggregationRatio);\n             speedquotausage = rawusage.multiply(onehourcostper100mhz).multiply(speed);\n@@ -381,7 +382,7 @@ public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal a\n             quotalist.add(quota_usage);\n         }\n         tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.MEMORY, usageRecord.getEndDate());\n-        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0 && serviceoffering.getRamSize() != null) {\n             BigDecimal memory = new BigDecimal(serviceoffering.getRamSize());\n             onehourcostper1mb = tariff.getCurrencyValue().multiply(aggregationRatio);\n             memoryquotausage = rawusage.multiply(onehourcostper1mb).multiply(memory);",
                "raw_url": "https://github.com/apache/cloudstack/raw/983dee7f20bdcfb27cab20a46905ed58a558cb73/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "sha": "f4012b134cbf4a8646515a808fab41810241c93c",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/983dee7f20bdcfb27cab20a46905ed58a558cb73/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java?ref=983dee7f20bdcfb27cab20a46905ed58a558cb73",
                "deletions": 8,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "patch": "@@ -122,15 +122,17 @@ public void sendStatement() {\n             Date lastStatementDate = quotaAccount.getLastStatementDate();\n             if (interval != null) {\n                 AccountVO account = _accountDao.findById(quotaAccount.getId());\n-                if (lastStatementDate == null || getDifferenceDays(lastStatementDate, new Date()) >= s_LAST_STATEMENT_SENT_DAYS + 1) {\n-                    BigDecimal quotaUsage = _quotaUsage.findTotalQuotaUsage(account.getAccountId(), account.getDomainId(), null, interval[0].getTime(), interval[1].getTime());\n-                    s_logger.info(\"For account=\" + quotaAccount.getId() + \", quota used = \" + quotaUsage);\n-                    // send statement\n-                    deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, quotaUsage, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_STATEMENT));\n-                } else {\n-                    if (s_logger.isDebugEnabled()) {\n-                        s_logger.debug(\"For \" + quotaAccount.getId() + \" the statement has been sent recently\");\n+                if (account != null) {\n+                    if (lastStatementDate == null || getDifferenceDays(lastStatementDate, new Date()) >= s_LAST_STATEMENT_SENT_DAYS + 1) {\n+                        BigDecimal quotaUsage = _quotaUsage.findTotalQuotaUsage(account.getAccountId(), account.getDomainId(), null, interval[0].getTime(), interval[1].getTime());\n+                        s_logger.info(\"For account=\" + quotaAccount.getId() + \", quota used = \" + quotaUsage);\n+                        // send statement\n+                        deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, quotaUsage, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_STATEMENT));\n+                    } else {\n+                        if (s_logger.isDebugEnabled()) {\n+                            s_logger.debug(\"For \" + quotaAccount.getId() + \" the statement has been sent recently\");\n \n+                        }\n                     }\n                 }\n             } else if (lastStatementDate != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/983dee7f20bdcfb27cab20a46905ed58a558cb73/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "sha": "dde30697213b1fa62c2f7330bacf75232dc67016",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/983dee7f20bdcfb27cab20a46905ed58a558cb73/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java?ref=983dee7f20bdcfb27cab20a46905ed58a558cb73",
                "deletions": 1,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "patch": "@@ -59,7 +59,7 @@ public QuotaSummaryCmd() {\n     public void execute() {\n         Account caller = CallContext.current().getCallingAccount();\n         List<QuotaSummaryResponse> responses;\n-        if (caller.getAccountId() <= 2) { //non root admin or system\n+        if (caller.getType() == Account.ACCOUNT_TYPE_ADMIN) { //admin account\n             if (getAccountName() != null && getDomainId() != null)\n                 responses = _responseBuilder.createQuotaSummaryResponse(caller.getAccountName(), caller.getDomainId());\n             else",
                "raw_url": "https://github.com/apache/cloudstack/raw/983dee7f20bdcfb27cab20a46905ed58a558cb73/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "sha": "88466e08c6b93aa6af16e246aee51e48f47e0c83",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/983dee7f20bdcfb27cab20a46905ed58a558cb73/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java?ref=983dee7f20bdcfb27cab20a46905ed58a558cb73",
                "deletions": 1,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "patch": "@@ -138,6 +138,7 @@ public QuotaTariffResponse createQuotaTariffResponse(QuotaTariffVO tariff) {\n         } else {\n             for (final QuotaAccountVO quotaAccount : _quotaAccountDao.listAllQuotaAccount()) {\n                 AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                if (account == null) continue;\n                 QuotaSummaryResponse qr = getQuotaSummaryResponse(account);\n                 result.add(qr);\n             }\n@@ -167,7 +168,7 @@ private QuotaSummaryResponse getQuotaSummaryResponse(final Account account) {\n             qr.setObjectName(\"summary\");\n             return qr;\n         } else {\n-            throw new InvalidParameterValueException(\"Quota summary response for an account requires a valid account.\");\n+            return new QuotaSummaryResponse();\n         }\n     }\n \n@@ -396,6 +397,9 @@ public QuotaCreditsResponse addQuotaCredits(Long accountId, Long domainId, Doubl\n         QuotaCreditsVO result = _quotaCreditsDao.saveCredits(credits);\n \n         final AccountVO account = _accountDao.findById(accountId);\n+        if (account == null) {\n+            throw new InvalidParameterValueException(\"Account does not exist with account id \" + accountId);\n+        }\n         final boolean lockAccountEnforcement = \"true\".equalsIgnoreCase(QuotaConfig.QuotaEnableEnforcement.value());\n         final BigDecimal currentAccountBalance = _quotaBalanceDao.lastQuotaBalance(accountId, domainId, startOfNextDay(new Date(despositedOn.getTime())));\n         if (s_logger.isDebugEnabled()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/983dee7f20bdcfb27cab20a46905ed58a558cb73/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "sha": "59c53ecb5d1a6d258d94d249ada7215159132aab",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/983dee7f20bdcfb27cab20a46905ed58a558cb73/ui/plugins/quota/quota.js",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/quota/quota.js?ref=983dee7f20bdcfb27cab20a46905ed58a558cb73",
                "deletions": 7,
                "filename": "ui/plugins/quota/quota.js",
                "patch": "@@ -329,13 +329,6 @@\n                           });\n                       },\n                       detailView: {\n-                          viewAll: [{\n-                              path: 'quota.quotastatement',\n-                              label: 'label.quota.statement.quota'\n-                          },{\n-                              path: 'quota.balancestatement',\n-                              label: 'label.quota.statement.balance'\n-                          }],\n                           actions: {\n                              add: {\n                                 label: 'label.quota.add.credits',",
                "raw_url": "https://github.com/apache/cloudstack/raw/983dee7f20bdcfb27cab20a46905ed58a558cb73/ui/plugins/quota/quota.js",
                "sha": "d9f61b2371c17cd87b102ffbf564eedf8b46ba9e",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9174: A deleted account results in NPE\n\nWhen an account is deleted from cloudstack for which quota is still\nbeing calculated and if the quota reaches minimum threshold then\nquota service will try to alert the user. This results in NPE and is\nfixed by excluding such accounts from alerting and other quota related\nmechanisms.\n\nQuota service: Fix check for admin account",
        "parent": "https://github.com/apache/cloudstack/commit/94a14485f76e6c6a5416f7840a6e857bdc38cfce",
        "repo": "cloudstack",
        "unit_tests": [
            "QuotaAlertManagerImplTest.java",
            "QuotaManagerImplTest.java",
            "QuotaResponseBuilderImplTest.java"
        ]
    },
    "cloudstack_987fcbd": {
        "bug_id": "cloudstack_987fcbd",
        "commit": "https://github.com/apache/cloudstack/commit/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/api/ApiConstants.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/ApiConstants.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/ApiConstants.java",
                "patch": "@@ -273,6 +273,7 @@\n     public static final String VIRTUAL_MACHINE_ID_IP = \"vmidipmap\";\n     public static final String VIRTUAL_MACHINE_COUNT = \"virtualmachinecount\";\n     public static final String USAGE_ID = \"usageid\";\n+    public static final String USAGE_TYPE = \"usagetype\";\n \n     public static final String VLAN = \"vlan\";\n     public static final String VLAN_RANGE = \"vlanrange\";",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/api/ApiConstants.java",
                "sha": "742d2f42abf35ed52f054d2b96d4dcd2eda6d04d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/api/BaseCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/BaseCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/BaseCmd.java",
                "patch": "@@ -95,7 +95,7 @@\n         GET, POST, PUT, DELETE\n     }\n     public static enum CommandType {\n-        BOOLEAN, DATE, FLOAT, INTEGER, SHORT, LIST, LONG, OBJECT, MAP, STRING, TZDATE, UUID\n+        BOOLEAN, DATE, FLOAT, DOUBLE, INTEGER, SHORT, LIST, LONG, OBJECT, MAP, STRING, TZDATE, UUID\n     }\n \n     private Object _responseObject;",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/api/BaseCmd.java",
                "sha": "360b277d8979ffb9df7478b84dedb80ab587a38b",
                "status": "modified"
            },
            {
                "additions": 24,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/api/command/admin/usage/GetUsageRecordsCmd.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/usage/GetUsageRecordsCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/usage/GetUsageRecordsCmd.java",
                "patch": "@@ -111,6 +111,30 @@ public Long getProjectId() {\n     public String getUsageId() {\n         return usageId;\n     }\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public void setUsageId(String usageId) {\n+        this.usageId = usageId;\n+    }\n+\n \n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/api/command/admin/usage/GetUsageRecordsCmd.java",
                "sha": "4cceb3b5f9fcb3df4f1fca3f15c989bb7a587931",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/usage/UsageTypes.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/usage/UsageTypes.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/usage/UsageTypes.java",
                "patch": "@@ -22,6 +22,7 @@\n import org.apache.cloudstack.api.response.UsageTypeResponse;\n \n public class UsageTypes {\n+    /* Any changes here should also reflect in cloud_usage.quota_mapping table */\n     public static final int RUNNING_VM = 1;\n     public static final int ALLOCATED_VM = 2; // used for tracking how long storage has been allocated for a VM\n     public static final int IP_ADDRESS = 3;",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/src/org/apache/cloudstack/usage/UsageTypes.java",
                "sha": "d9cfc132e15da5c89a6f2e4edd37a2383f098a20",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/test/org/apache/cloudstack/api/command/test/UsageCmdTest.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/test/org/apache/cloudstack/api/command/test/UsageCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "api/test/org/apache/cloudstack/api/command/test/UsageCmdTest.java",
                "patch": "@@ -17,6 +17,7 @@\n package org.apache.cloudstack.api.command.test;\n \n import java.util.ArrayList;\n+import java.util.Date;\n import java.util.List;\n \n import junit.framework.TestCase;\n@@ -70,4 +71,22 @@ public void testExecuteEmptyResult() {\n \n     }\n \n+    @Test\n+    public void testCrud() {\n+        getUsageRecordsCmd.setDomainId(1L);\n+        assertTrue(getUsageRecordsCmd.getDomainId().equals(1L));\n+\n+        getUsageRecordsCmd.setAccountName(\"someAccount\");\n+        assertTrue(getUsageRecordsCmd.getAccountName().equals(\"someAccount\"));\n+\n+        Date d = new Date();\n+        getUsageRecordsCmd.setStartDate(d);\n+        getUsageRecordsCmd.setEndDate(d);\n+        assertTrue(getUsageRecordsCmd.getStartDate().equals(d));\n+        assertTrue(getUsageRecordsCmd.getEndDate().equals(d));\n+\n+        getUsageRecordsCmd.setUsageId(\"someId\");\n+        assertTrue(getUsageRecordsCmd.getUsageId().equals(\"someId\"));\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/api/test/org/apache/cloudstack/api/command/test/UsageCmdTest.java",
                "sha": "e5f3e27aa5615de7497091d5e29ef64093055d8a",
                "status": "modified"
            },
            {
                "additions": 41,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/client/WEB-INF/classes/resources/messages.properties",
                "changes": 41,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/WEB-INF/classes/resources/messages.properties?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "client/WEB-INF/classes/resources/messages.properties",
                "patch": "@@ -1423,6 +1423,47 @@ label.show.advanced.settings=Show advanced settings\n label.delete.OpenDaylight.device=Delete OpenDaylight Controller\n label.polling.interval.sec=Polling Interval (in sec)\n label.quiet.time.sec=Quiet Time (in sec)\n+label.usage.type=Usage Type\n+label.usage.unit=Unit\n+label.quota.value=Quota Value\n+label.quota.description=Quota Description\n+label.quota.configuration=Quota Configuration\n+label.quota.configure=Configure Quota\n+label.quota.remove=Remove Quota\n+label.quota.totalusage=Total Usage\n+label.quota.balance=Balance\n+label.quota.minbalance=Min Balance\n+label.quota.enforcequota=Enforce Quota\n+label.quota.summary=Summary\n+label.quota.fullsummary=All Accounts\n+label.quota.tariff=Tariff\n+label.quota.state=State\n+label.quota.startdate=Start Date\n+label.quota.enddate=End Date\n+label.quota.total=Total\n+label.quota.startquota=Start Quota\n+label.quota.endquota=End Quota\n+label.quota.type.name=Usage Type\n+label.quota.type.unit=Usage Unit\n+label.quota.usage=Quota Consumption\n+label.quota.add.credits=Add Credits\n+label.quota.email.template=Email Template\n+label.quota.statement=Statement\n+label.quota.statement.balance=Quota Balance\n+label.quota.statement.quota=Quota Usage\n+label.quota.statement.tariff=Quota Tariff\n+label.quota.tariff.value=Tariff Value\n+label.quota.tariff.edit=Edit Tariff\n+label.quota.tariff.effectivedate=Effective Date\n+label.quota.date=Date\n+label.quota.dates=Update Dates\n+label.quota.credit=Credit\n+label.quota.credits=Credits\n+label.quota.value=Quota Value\n+label.quota.statement.bydates=Statement\n+label.quota.email.subject=Subject\n+label.quota.email.body=Body\n+label.quota.email.lastupdated=Last Update\n label.destroy.vm.graceperiod=Destroy VM Grace Period\n label.SNMP.community=SNMP Community\n label.SNMP.port=SNMP Port",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/client/WEB-INF/classes/resources/messages.properties",
                "sha": "e7beaa9304d59d60fa001725cf1187a85d30b07d",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/client/pom.xml",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "client/pom.xml",
                "patch": "@@ -256,6 +256,11 @@\n       <artifactId>cloud-framework-ipc</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-framework-quota</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n     <dependency>\n       <groupId>org.apache.cloudstack</groupId>\n       <artifactId>cloud-framework-rest</artifactId>\n@@ -366,6 +371,11 @@\n       <artifactId>cloud-plugin-network-globodns</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-plugin-database-quota</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n   </dependencies>\n   <build>\n     <plugins>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/client/pom.xml",
                "sha": "d4478304c434461bd249fcaa266ff0d40ccdf220",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/client/tomcatconf/commands.properties.in",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/commands.properties.in?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "client/tomcatconf/commands.properties.in",
                "patch": "@@ -787,3 +787,14 @@ addGloboDnsHost=1\n ### volume/template post upload\n getUploadParamsForVolume=15\n getUploadParamsForTemplate=15\n+\n+### Quota Service\n+quotaStatement=15\n+quotaBalance=15\n+quotaSummary=15\n+quotaUpdate=1\n+quotaTariffList=15\n+quotaTariffUpdate=1\n+quotaCredits=1\n+quotaEmailTemplateList=1\n+quotaEmailTemplateUpdate=1",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/client/tomcatconf/commands.properties.in",
                "sha": "485abea099c29287592e20709c4dca94b7099391",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/upgrade/dao/Upgrade452to460.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/upgrade/dao/Upgrade452to460.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/upgrade/dao/Upgrade452to460.java",
                "patch": "@@ -340,4 +340,4 @@ private void updateSystemVmTemplates(final Connection conn) {\n         }\n         s_logger.debug(\"Updating System Vm Template IDs Complete\");\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/upgrade/dao/Upgrade452to460.java",
                "sha": "6b78a7ed611ab8fa274382a032989c02e14a35af",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/upgrade/dao/Upgrade461to470.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/upgrade/dao/Upgrade461to470.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/upgrade/dao/Upgrade461to470.java",
                "patch": "@@ -23,6 +23,8 @@\n \n import java.io.File;\n import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n \n public class Upgrade461to470 implements DbUpgrade {\n     final static Logger s_logger = Logger.getLogger(Upgrade461to470.class);\n@@ -51,8 +53,23 @@ public boolean supportsRollingUpgrade() {\n         return new File[] {new File(script)};\n     }\n \n+    public void alterAddColumnToCloudUsage(final Connection conn) {\n+        final String alterTableSql = \"ALTER TABLE `cloud_usage`.`cloud_usage` ADD COLUMN `quota_calculated` tinyint(1) DEFAULT 0 NOT NULL COMMENT 'quota calculation status'\";\n+        try (PreparedStatement pstmt = conn.prepareStatement(alterTableSql)) {\n+            pstmt.executeUpdate();\n+            s_logger.info(\"Altered cloud_usage.cloud_usage table and added column quota_calculated\");\n+        } catch (SQLException e) {\n+            if (e.getMessage().contains(\"quota_calculated\")) {\n+                s_logger.warn(\"cloud_usage.cloud_usage table already has a column called quota_calculated\");\n+            } else {\n+                throw new CloudRuntimeException(\"Unable to create column quota_calculated in table cloud_usage.cloud_usage\", e);\n+            }\n+        }\n+    }\n+\n     @Override\n     public void performDataMigration(Connection conn) {\n+        alterAddColumnToCloudUsage(conn);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/upgrade/dao/Upgrade461to470.java",
                "sha": "8dbbdb2e9ec8c22bfd45d6a5c9428a5d41649e5b",
                "status": "modified"
            },
            {
                "additions": 69,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/usage/UsageVO.java",
                "changes": 83,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/usage/UsageVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 14,
                "filename": "engine/schema/src/com/cloud/usage/UsageVO.java",
                "patch": "@@ -103,6 +103,17 @@\n     @Temporal(value = TemporalType.TIMESTAMP)\n     private Date endDate = null;\n \n+    @Column(name = \"quota_calculated\")\n+    private Integer quotaCalculated = 0;\n+\n+    public Integer getQuotaCalculated() {\n+        return quotaCalculated;\n+    }\n+\n+    public void setQuotaCalculated(Integer quotaCalculated) {\n+        this.quotaCalculated = quotaCalculated;\n+    }\n+\n     public UsageVO() {\n     }\n \n@@ -121,8 +132,8 @@ public UsageVO(Long zoneId, Long accountId, Long domainId, String description, S\n         this.templateId = templateId;\n         this.usageId = usageId;\n         this.size = size;\n-        this.startDate = startDate;\n-        this.endDate = endDate;\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n     }\n \n     public UsageVO(Long zoneId, Long accountId, Long domainId, String description, String usageDisplay, int usageType, Double rawUsage, Long vmId, String vmName,\n@@ -141,8 +152,8 @@ public UsageVO(Long zoneId, Long accountId, Long domainId, String description, S\n         this.usageId = usageId;\n         this.size = size;\n         this.virtualSize = virtualSize;\n-        this.startDate = startDate;\n-        this.endDate = endDate;\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n     }\n \n     public UsageVO(Long zoneId, Long accountId, Long domainId, String description, String usageDisplay, int usageType, Double rawUsage, Long usageId, String type,\n@@ -157,8 +168,8 @@ public UsageVO(Long zoneId, Long accountId, Long domainId, String description, S\n         this.usageId = usageId;\n         this.type = type;\n         this.networkId = networkId;\n-        this.startDate = startDate;\n-        this.endDate = endDate;\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n     }\n \n     public UsageVO(Long zoneId, Long accountId, Long domainId, String description, String usageDisplay, int usageType, Double rawUsage, Long vmId, String vmName,\n@@ -176,8 +187,8 @@ public UsageVO(Long zoneId, Long accountId, Long domainId, String description, S\n         this.templateId = templateId;\n         this.usageId = usageId;\n         this.type = type;\n-        this.startDate = startDate;\n-        this.endDate = endDate;\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n     }\n \n     public UsageVO(Long zoneId, Long accountId, Long domainId, String description, String usageDisplay, int usageType, Double rawUsage, Long vmId, String vmName,\n@@ -198,8 +209,8 @@ public UsageVO(Long zoneId, Long accountId, Long domainId, String description, S\n         this.templateId = templateId;\n         this.usageId = usageId;\n         this.type = type;\n-        this.startDate = startDate;\n-        this.endDate = endDate;\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n     }\n \n     //IPAddress Usage\n@@ -215,8 +226,8 @@ public UsageVO(Long zoneId, Long accountId, Long domainId, String description, S\n         this.usageId = usageId;\n         this.size = size;\n         this.type = type;\n-        this.startDate = startDate;\n-        this.endDate = endDate;\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n     }\n \n     @Override\n@@ -321,11 +332,55 @@ public Long getVirtualSize() {\n \n     @Override\n     public Date getStartDate() {\n-        return startDate;\n+        return startDate  == null ? null : new Date(startDate.getTime());\n     }\n \n     @Override\n     public Date getEndDate() {\n-        return endDate;\n+        return endDate  == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setId(Long id) {\n+        this.id = id;\n+    }\n+\n+    public void setType(String type) {\n+        this.type = type;\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate  == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate  == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public void setZoneId(Long zoneId) {\n+        this.zoneId = zoneId;\n+    }\n+\n+    public void setUsageType(int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public void setRawUsage(Double rawUsage) {\n+        this.rawUsage = rawUsage;\n+    }\n+\n+    public void setSize(Long size) {\n+        this.size = size;\n+    }\n+\n+    public void setVirtualSize(Long virtualSize) {\n+        this.virtualSize = virtualSize;\n     }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/usage/UsageVO.java",
                "sha": "cc90d71c8b289c5e3d750a7d5b4a704a069f55c9",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/usage/dao/UsageDao.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/usage/dao/UsageDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "engine/schema/src/com/cloud/usage/dao/UsageDao.java",
                "patch": "@@ -55,4 +55,8 @@\n     void saveUsageRecords(List<UsageVO> usageRecords);\n \n     void removeOldUsageRecords(int days);\n+\n+    UsageVO persistUsage(final UsageVO usage);\n+\n+    Pair<List<? extends UsageVO>, Integer> getUsageRecordsPendingQuotaAggregation(long accountId, long domainId);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/usage/dao/UsageDao.java",
                "sha": "4822dd60acff1512c9dcfb11574cdcccc053a4df",
                "status": "modified"
            },
            {
                "additions": 52,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/usage/dao/UsageDaoImpl.java",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/usage/dao/UsageDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 16,
                "filename": "engine/schema/src/com/cloud/usage/dao/UsageDaoImpl.java",
                "patch": "@@ -24,9 +24,14 @@\n import com.cloud.utils.Pair;\n import com.cloud.utils.db.Filter;\n import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.QueryBuilder;\n import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n import com.cloud.utils.exception.CloudRuntimeException;\n+\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n@@ -45,29 +50,24 @@\n     private static final String DELETE_ALL_BY_ACCOUNTID = \"DELETE FROM cloud_usage WHERE account_id = ?\";\n     private static final String DELETE_ALL_BY_INTERVAL = \"DELETE FROM cloud_usage WHERE end_date < DATE_SUB(CURRENT_DATE(), INTERVAL ? DAY)\";\n     private static final String INSERT_ACCOUNT = \"INSERT INTO cloud_usage.account (id, account_name, type, domain_id, removed, cleanup_needed) VALUES (?,?,?,?,?,?)\";\n-    private static final String INSERT_USER_STATS =\n-            \"INSERT INTO cloud_usage.user_statistics (id, data_center_id, account_id, public_ip_address, device_id, device_type, network_id, net_bytes_received,\"\n-                    + \" net_bytes_sent, current_bytes_received, current_bytes_sent, agg_bytes_received, agg_bytes_sent) VALUES (?,?,?,?,?,?,?,?,?,?, ?, ?, ?)\";\n+    private static final String INSERT_USER_STATS = \"INSERT INTO cloud_usage.user_statistics (id, data_center_id, account_id, public_ip_address, device_id, device_type, network_id, net_bytes_received,\"\n+            + \" net_bytes_sent, current_bytes_received, current_bytes_sent, agg_bytes_received, agg_bytes_sent) VALUES (?,?,?,?,?,?,?,?,?,?, ?, ?, ?)\";\n \n     private static final String UPDATE_ACCOUNT = \"UPDATE cloud_usage.account SET account_name=?, removed=? WHERE id=?\";\n-    private static final String UPDATE_USER_STATS =\n-            \"UPDATE cloud_usage.user_statistics SET net_bytes_received=?, net_bytes_sent=?, current_bytes_received=?, current_bytes_sent=?, agg_bytes_received=?, agg_bytes_sent=? WHERE id=?\";\n+    private static final String UPDATE_USER_STATS = \"UPDATE cloud_usage.user_statistics SET net_bytes_received=?, net_bytes_sent=?, current_bytes_received=?, current_bytes_sent=?, agg_bytes_received=?, agg_bytes_sent=? WHERE id=?\";\n \n     private static final String GET_LAST_ACCOUNT = \"SELECT id FROM cloud_usage.account ORDER BY id DESC LIMIT 1\";\n     private static final String GET_LAST_USER_STATS = \"SELECT id FROM cloud_usage.user_statistics ORDER BY id DESC LIMIT 1\";\n     private static final String GET_PUBLIC_TEMPLATES_BY_ACCOUNTID = \"SELECT id FROM cloud.vm_template WHERE account_id = ? AND public = '1' AND removed IS NULL\";\n \n     private static final String GET_LAST_VM_DISK_STATS = \"SELECT id FROM cloud_usage.vm_disk_statistics ORDER BY id DESC LIMIT 1\";\n-    private static final String INSERT_VM_DISK_STATS =\n-            \"INSERT INTO cloud_usage.vm_disk_statistics (id, data_center_id, account_id, vm_id, volume_id, net_io_read, net_io_write, current_io_read, \"\n-                    + \"current_io_write, agg_io_read, agg_io_write, net_bytes_read, net_bytes_write, current_bytes_read, current_bytes_write, agg_bytes_read, agg_bytes_write) \"\n-                    + \" VALUES (?,?,?,?,?,?,?,?,?,?, ?, ?, ?, ?,?, ?, ?)\";\n-    private static final String UPDATE_VM_DISK_STATS =\n-            \"UPDATE cloud_usage.vm_disk_statistics SET net_io_read=?, net_io_write=?, current_io_read=?, current_io_write=?, agg_io_read=?, agg_io_write=?, \"\n-                    + \"net_bytes_read=?, net_bytes_write=?, current_bytes_read=?, current_bytes_write=?, agg_bytes_read=?, agg_bytes_write=?  WHERE id=?\";\n+    private static final String INSERT_VM_DISK_STATS = \"INSERT INTO cloud_usage.vm_disk_statistics (id, data_center_id, account_id, vm_id, volume_id, net_io_read, net_io_write, current_io_read, \"\n+            + \"current_io_write, agg_io_read, agg_io_write, net_bytes_read, net_bytes_write, current_bytes_read, current_bytes_write, agg_bytes_read, agg_bytes_write) \"\n+            + \" VALUES (?,?,?,?,?,?,?,?,?,?, ?, ?, ?, ?,?, ?, ?)\";\n+    private static final String UPDATE_VM_DISK_STATS = \"UPDATE cloud_usage.vm_disk_statistics SET net_io_read=?, net_io_write=?, current_io_read=?, current_io_write=?, agg_io_read=?, agg_io_write=?, \"\n+            + \"net_bytes_read=?, net_bytes_write=?, current_bytes_read=?, current_bytes_write=?, agg_bytes_read=?, agg_bytes_write=?  WHERE id=?\";\n     private static final String INSERT_USAGE_RECORDS = \"INSERT INTO cloud_usage.cloud_usage (zone_id, account_id, domain_id, description, usage_display, \"\n-            +\n-            \"usage_type, raw_usage, vm_instance_id, vm_name, offering_id, template_id, \"\n+            + \"usage_type, raw_usage, vm_instance_id, vm_name, offering_id, template_id, \"\n             + \"usage_id, type, size, network_id, start_date, end_date, virtual_size) VALUES (?,?,?,?,?,?,?,?,?, ?, ?, ?,?,?,?,?,?,?)\";\n \n     protected final static TimeZone s_gmtTimeZone = TimeZone.getTimeZone(\"GMT\");\n@@ -213,7 +213,7 @@ public void updateUserStats(List<UserStatisticsVO> userStats) {\n             txn.start();\n             String sql = UPDATE_USER_STATS;\n             PreparedStatement pstmt = null;\n-            pstmt = txn.prepareAutoCloseStatement(sql);  // in reality I just want CLOUD_USAGE dataSource connection\n+            pstmt = txn.prepareAutoCloseStatement(sql); // in reality I just want CLOUD_USAGE dataSource connection\n             for (UserStatisticsVO userStat : userStats) {\n                 pstmt.setLong(1, userStat.getNetBytesReceived());\n                 pstmt.setLong(2, userStat.getNetBytesSent());\n@@ -310,7 +310,7 @@ public void updateVmDiskStats(List<VmDiskStatisticsVO> vmDiskStats) {\n             txn.start();\n             String sql = UPDATE_VM_DISK_STATS;\n             PreparedStatement pstmt = null;\n-            pstmt = txn.prepareAutoCloseStatement(sql);  // in reality I just want CLOUD_USAGE dataSource connection\n+            pstmt = txn.prepareAutoCloseStatement(sql); // in reality I just want CLOUD_USAGE dataSource connection\n             for (VmDiskStatisticsVO vmDiskStat : vmDiskStats) {\n                 pstmt.setLong(1, vmDiskStat.getNetIORead());\n                 pstmt.setLong(2, vmDiskStat.getNetIOWrite());\n@@ -467,4 +467,40 @@ public void removeOldUsageRecords(int days) {\n             txn.close();\n         }\n     }\n+\n+    public UsageVO persistUsage(final UsageVO usage) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<UsageVO>() {\n+            @Override\n+            public UsageVO doInTransaction(final TransactionStatus status) {\n+                return persist(usage);\n+            }\n+        });\n+    }\n+\n+    public Pair<List<? extends UsageVO>, Integer> getUsageRecordsPendingQuotaAggregation(final long accountId, final long domainId) {\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Getting usage records for account: \" + accountId + \", domainId: \" + domainId);\n+        }\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<Pair<List<? extends UsageVO>, Integer>>() {\n+            @Override\n+            public Pair<List<? extends UsageVO>, Integer> doInTransaction(final TransactionStatus status) {\n+                Pair<List<UsageVO>, Integer> usageRecords = new Pair<List<UsageVO>, Integer>(new ArrayList<UsageVO>(), 0);\n+                Filter usageFilter = new Filter(UsageVO.class, \"startDate\", true, 0L, Long.MAX_VALUE);\n+                QueryBuilder<UsageVO> qb = QueryBuilder.create(UsageVO.class);\n+                if (accountId != -1) {\n+                    qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                }\n+                if (domainId != -1) {\n+                    qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                }\n+                qb.and(qb.entity().getQuotaCalculated(), SearchCriteria.Op.NEQ, 1);\n+                qb.and(qb.entity().getRawUsage(), SearchCriteria.Op.GT, 0);\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Getting usage records\" + usageFilter.getOrderBy());\n+                }\n+                usageRecords = searchAndCountAllRecords(qb.create(), usageFilter);\n+                return new Pair<List<? extends UsageVO>, Integer>(usageRecords.first(), usageRecords.second());\n+            }\n+        });\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/engine/schema/src/com/cloud/usage/dao/UsageDaoImpl.java",
                "sha": "9c9ab0bbc0894ad770fb5667cca248cb79751abb",
                "status": "modified"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/db/src/com/cloud/utils/db/Transaction.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/db/src/com/cloud/utils/db/Transaction.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 8,
                "filename": "framework/db/src/com/cloud/utils/db/Transaction.java",
                "patch": "@@ -35,18 +35,11 @@\n         if (currentTxn != null) {\n             databaseId = currentTxn.getDatabaseId();\n         }\n-        TransactionLegacy txn = TransactionLegacy.open(name, databaseId, false);\n-        try {\n-//            if (txn.dbTxnStarted()){\n-//                String warnMsg = \"Potential Wrong Usage: TRANSACTION.EXECUTE IS WRAPPED INSIDE ANOTHER DB TRANSACTION!\";\n-//                s_logger.warn(warnMsg, new CloudRuntimeException(warnMsg));\n-//            }\n+        try (final TransactionLegacy txn = TransactionLegacy.open(name, databaseId, false)) {\n             txn.start();\n             T result = callback.doInTransaction(STATUS);\n             txn.commit();\n             return result;\n-        } finally {\n-            txn.close();\n         }\n     }\n \n@@ -59,4 +52,28 @@ public T doInTransaction(TransactionStatus status) throws RuntimeException {\n         });\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n+    public static <T, E extends Throwable> T execute(final short databaseId, TransactionCallbackWithException<T, E> callback) throws E {\n+        String name = \"tx-\" + counter.incrementAndGet();\n+        TransactionLegacy currentTxn = TransactionLegacy.currentTxn(false);\n+        short outer_txn_databaseId = (currentTxn != null ? currentTxn.getDatabaseId() : databaseId);\n+        try (final TransactionLegacy txn = TransactionLegacy.open(name, databaseId, true)) {\n+            txn.start();\n+            T result = callback.doInTransaction(STATUS);\n+            txn.commit();\n+            return result;\n+        } finally {\n+            TransactionLegacy.open(outer_txn_databaseId).close();\n+        }\n+    }\n+\n+    public static <T> T execute(final short databaseId, final TransactionCallback<T> callback) {\n+        return execute(databaseId, new TransactionCallbackWithException<T, RuntimeException>() {\n+            @Override\n+            public T doInTransaction(TransactionStatus status) throws RuntimeException {\n+                return callback.doInTransaction(status);\n+            }\n+        });\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/db/src/com/cloud/utils/db/Transaction.java",
                "sha": "c6a491a216d0ec1d14a4da0ef5efd3c8342f64de",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/pom.xml",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/pom.xml",
                "patch": "@@ -47,6 +47,7 @@\n     <module>rest</module>\n     <module>events</module>\n     <module>jobs</module>\n+    <module>quota</module>\n     <module>cluster</module>\n     <module>db</module>\n     <module>config</module>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/pom.xml",
                "sha": "3cfc6d0a3cedd747717a664a6b4d265bee1f7214",
                "status": "modified"
            },
            {
                "additions": 73,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/pom.xml",
                "changes": 73,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/pom.xml",
                "patch": "@@ -0,0 +1,73 @@\n+<!--\n+  Licensed to the Apache Software Foundation (ASF) under one\n+  or more contributor license agreements. See the NOTICE file\n+  distributed with this work for additional information\n+  regarding copyright ownership. The ASF licenses this file\n+  to you under the Apache License, Version 2.0 (the\n+  \"License\"); you may not use this file except in compliance\n+  with the License. You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing,\n+  software distributed under the License is distributed on an\n+  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+  KIND, either express or implied. See the License for the\n+  specific language governing permissions and limitations\n+  under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <artifactId>cloud-framework-quota</artifactId>\n+  <name>Apache CloudStack Framework - Quota</name>\n+  <parent>\n+    <groupId>org.apache.cloudstack</groupId>\n+    <artifactId>cloudstack-framework</artifactId>\n+    <version>4.7.0-SNAPSHOT</version>\n+    <relativePath>../pom.xml</relativePath>\n+  </parent>\n+  <dependencies>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-utils</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-engine-schema</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n+    <dependency>\n+        <groupId>junit</groupId>\n+        <artifactId>junit</artifactId>\n+        <version>${cs.junit.version}</version>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.mockito</groupId>\n+        <artifactId>mockito-all</artifactId>\n+        <version>${cs.mockito.version}</version>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.powermock</groupId>\n+        <artifactId>powermock-module-junit4</artifactId>\n+        <version>${cs.powermock.version}</version>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.powermock</groupId>\n+        <artifactId>powermock-api-mockito</artifactId>\n+        <version>${cs.powermock.version}</version>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.commons</groupId>\n+      <artifactId>commons-lang3</artifactId>\n+      <version>${cs.commons-lang3.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>javax.mail</groupId>\n+      <artifactId>mail</artifactId>\n+    </dependency>\n+  </dependencies>\n+</project>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/pom.xml",
                "sha": "c0ed3c8498601f5bf92c35d7923f0df143fc2749",
                "status": "added"
            },
            {
                "additions": 34,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/resources/META-INF/cloudstack/quota/spring-framework-quota-context.xml",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/resources/META-INF/cloudstack/quota/spring-framework-quota-context.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/resources/META-INF/cloudstack/quota/spring-framework-quota-context.xml",
                "patch": "@@ -0,0 +1,34 @@\n+<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor\n+\tlicense agreements. See the NOTICE file distributed with this work for additional\n+\tinformation regarding copyright ownership. The ASF licenses this file to\n+\tyou under the Apache License, Version 2.0 (the \"License\"); you may not use\n+\tthis file except in compliance with the License. You may obtain a copy of\n+\tthe License at http://www.apache.org/licenses/LICENSE-2.0 Unless required\n+\tby applicable law or agreed to in writing, software distributed under the\n+\tLicense is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS\n+\tOF ANY KIND, either express or implied. See the License for the specific\n+\tlanguage governing permissions and limitations under the License. -->\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+\txmlns:aop=\"http://www.springframework.org/schema/aop\"\n+\txsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+                      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n+                      http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n+                      http://www.springframework.org/schema/context\n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n+\n+\t<bean id=\"QuotaTariffDao\" class=\"org.apache.cloudstack.quota.dao.QuotaTariffDaoImpl\" />\n+    <bean id=\"QuotaAccountDao\" class=\"org.apache.cloudstack.quota.dao.QuotaAccountDaoImpl\" />\n+\t<bean id=\"QuotaBalanceDao\" class=\"org.apache.cloudstack.quota.dao.QuotaBalanceDaoImpl\" />\n+\t<bean id=\"QuotaCreditsDao\" class=\"org.apache.cloudstack.quota.dao.QuotaCreditsDaoImpl\" />\n+\t<bean id=\"QuotaEmailTemplatesDao\"\n+\t\tclass=\"org.apache.cloudstack.quota.dao.QuotaEmailTemplatesDaoImpl\" />\n+\t<bean id=\"QuotaUsageDao\" class=\"org.apache.cloudstack.quota.dao.QuotaUsageDaoImpl\" />\n+    <bean id=\"ServiceOfferingDao\" class=\"org.apache.cloudstack.quota.dao.ServiceOfferingDaoImpl\" />\n+    <bean id=\"UserVmDetailsDao\" class=\"org.apache.cloudstack.quota.dao.UserVmDetailsDaoImpl\" />\n+\n+\t<bean id=\"QuotaManager\" class=\"org.apache.cloudstack.quota.QuotaManagerImpl\" />\n+    <bean id=\"QuotaAlertManager\" class=\"org.apache.cloudstack.quota.QuotaAlertManagerImpl\" />\n+\t<bean id=\"QuotaStatement\" class=\"org.apache.cloudstack.quota.QuotaStatementImpl\" />\n+\n+</beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/resources/META-INF/cloudstack/quota/spring-framework-quota-context.xml",
                "sha": "f7a3accdc3995239797a2f6412449b0e3650dbe8",
                "status": "added"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManager.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManager.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManager.java",
                "patch": "@@ -0,0 +1,26 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.utils.component.Manager;\n+\n+import org.apache.cloudstack.quota.QuotaAlertManagerImpl.DeferredQuotaEmail;\n+\n+public interface QuotaAlertManager extends Manager {\n+    void checkAndSendQuotaAlertEmails();\n+    void sendQuotaAlert(DeferredQuotaEmail emailToBeSent);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManager.java",
                "sha": "44204e8d1167990cbbe178d27072961e257c180a",
                "status": "added"
            },
            {
                "additions": 418,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "changes": 418,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "patch": "@@ -0,0 +1,418 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.domain.DomainVO;\n+import com.cloud.domain.dao.DomainDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.Account.State;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.UserVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.user.dao.UserDao;\n+import com.cloud.utils.NumbersUtil;\n+import com.cloud.utils.component.ManagerBase;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.google.common.base.Strings;\n+import com.sun.mail.smtp.SMTPMessage;\n+import com.sun.mail.smtp.SMTPSSLTransport;\n+import com.sun.mail.smtp.SMTPTransport;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.cloudstack.quota.constant.QuotaConfig.QuotaEmailTemplateTypes;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaEmailTemplatesDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaEmailTemplatesVO;\n+import org.apache.commons.lang3.text.StrSubstitutor;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.mail.Authenticator;\n+import javax.mail.Message;\n+import javax.mail.MessagingException;\n+import javax.mail.PasswordAuthentication;\n+import javax.mail.Session;\n+import javax.mail.URLName;\n+import javax.mail.internet.InternetAddress;\n+import javax.naming.ConfigurationException;\n+import java.io.UnsupportedEncodingException;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+\n+@Component\n+@Local(value = QuotaAlertManager.class)\n+public class QuotaAlertManagerImpl extends ManagerBase implements QuotaAlertManager {\n+    private static final Logger s_logger = Logger.getLogger(QuotaAlertManagerImpl.class);\n+\n+    @Inject\n+    private AccountDao _accountDao;\n+    @Inject\n+    private QuotaAccountDao _quotaAcc;\n+    @Inject\n+    private UserDao _userDao;\n+    @Inject\n+    private DomainDao _domainDao;\n+    @Inject\n+    private QuotaEmailTemplatesDao _quotaEmailTemplateDao;\n+    @Inject\n+    private ConfigurationDao _configDao;\n+    @Inject\n+    private QuotaUsageDao _quotaUsage;\n+\n+    private EmailQuotaAlert _emailQuotaAlert;\n+    private boolean _lockAccountEnforcement = false;\n+\n+    boolean _smtpDebug = false;\n+\n+    public QuotaAlertManagerImpl() {\n+        super();\n+    }\n+\n+    private void mergeConfigs(Map<String, String> dbParams, Map<String, Object> xmlParams) {\n+        for (Map.Entry<String, Object> param : xmlParams.entrySet()) {\n+            dbParams.put(param.getKey(), (String)param.getValue());\n+        }\n+    }\n+\n+    @Override\n+    public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n+        super.configure(name, params);\n+\n+        Map<String, String> configs = _configDao.getConfiguration(params);\n+\n+        if (params != null) {\n+            mergeConfigs(configs, params);\n+        }\n+\n+        final String smtpHost = configs.get(QuotaConfig.QuotaSmtpHost.key());\n+        int smtpPort = NumbersUtil.parseInt(configs.get(QuotaConfig.QuotaSmtpPort.key()), 25);\n+        String useAuthStr = configs.get(QuotaConfig.QuotaSmtpAuthType.key());\n+        boolean useAuth = ((useAuthStr != null) && Boolean.parseBoolean(useAuthStr));\n+        String smtpUsername = configs.get(QuotaConfig.QuotaSmtpUser.key());\n+        String smtpPassword = configs.get(QuotaConfig.QuotaSmtpPassword.key());\n+        String emailSender = configs.get(QuotaConfig.QuotaSmtpSender.key());\n+        _lockAccountEnforcement = \"true\".equalsIgnoreCase(configs.get(QuotaConfig.QuotaEnableEnforcement.key()));\n+        _emailQuotaAlert = new EmailQuotaAlert(smtpHost, smtpPort, useAuth, smtpUsername, smtpPassword, emailSender, _smtpDebug);\n+\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean start() {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(\"Starting Alert Manager\");\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean stop() {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(\"Stopping Alert Manager\");\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public void checkAndSendQuotaAlertEmails() {\n+        List<DeferredQuotaEmail> deferredQuotaEmailList = new ArrayList<DeferredQuotaEmail>();\n+        final BigDecimal zeroBalance = new BigDecimal(0);\n+        for (final QuotaAccountVO quotaAccount : _quotaAcc.listAllQuotaAccount()) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"checkAndSendQuotaAlertEmails accId=\" + quotaAccount.getId());\n+            }\n+            BigDecimal accountBalance = quotaAccount.getQuotaBalance();\n+            Date balanceDate = quotaAccount.getQuotaBalanceDate();\n+            Date alertDate = quotaAccount.getQuotaAlertDate();\n+            int lockable = quotaAccount.getQuotaEnforce();\n+            BigDecimal thresholdBalance = quotaAccount.getQuotaMinBalance();\n+            if (accountBalance != null) {\n+                AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"checkAndSendQuotaAlertEmails: Check id=\" + account.getId() + \" bal=\" + accountBalance + \", alertDate=\" + alertDate + \", lockable=\" + lockable);\n+                }\n+                if (accountBalance.compareTo(zeroBalance) < 0) {\n+                    if (_lockAccountEnforcement && (lockable == 1)) {\n+                        if (account.getType() == Account.ACCOUNT_TYPE_NORMAL) {\n+                            s_logger.info(\"Locking account \" + account.getAccountName() + \" due to quota < 0.\");\n+                            lockAccount(account.getId());\n+                        }\n+                    }\n+                    if (alertDate == null || (balanceDate.after(alertDate) && getDifferenceDays(alertDate, new Date()) > 1)) {\n+                        s_logger.info(\"Sending alert \" + account.getAccountName() + \" due to quota < 0.\");\n+                        deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_EMPTY));\n+                    }\n+                } else if (accountBalance.compareTo(thresholdBalance) < 0) {\n+                    if (alertDate == null || (balanceDate.after(alertDate) && getDifferenceDays(alertDate, new Date()) > 1)) {\n+                        s_logger.info(\"Sending alert \" + account.getAccountName() + \" due to quota below threshold.\");\n+                        deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_LOW));\n+                    }\n+                }\n+            }\n+        }\n+\n+        for (DeferredQuotaEmail emailToBeSent : deferredQuotaEmailList) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"checkAndSendQuotaAlertEmails: Attempting to send quota alert email to users of account: \" + emailToBeSent.getAccount().getAccountName());\n+            }\n+            sendQuotaAlert(emailToBeSent);\n+        }\n+    }\n+\n+    public void sendQuotaAlert(DeferredQuotaEmail emailToBeSent) {\n+        final AccountVO account = emailToBeSent.getAccount();\n+        final BigDecimal balance = emailToBeSent.getQuotaBalance();\n+        final BigDecimal usage = emailToBeSent.getQuotaUsage();\n+        final QuotaConfig.QuotaEmailTemplateTypes emailType = emailToBeSent.getEmailTemplateType();\n+\n+        final List<QuotaEmailTemplatesVO> emailTemplates = _quotaEmailTemplateDao.listAllQuotaEmailTemplates(emailType.toString());\n+        if (emailTemplates != null && emailTemplates.get(0) != null) {\n+            final QuotaEmailTemplatesVO emailTemplate = emailTemplates.get(0);\n+\n+            final DomainVO accountDomain = _domainDao.findByIdIncludingRemoved(account.getDomainId());\n+            final List<UserVO> usersInAccount = _userDao.listByAccount(account.getId());\n+\n+            String userNames = \"\";\n+            final List<String> emailRecipients = new ArrayList<String>();\n+            for (UserVO user : usersInAccount) {\n+                userNames += String.format(\"%s <%s>,\", user.getUsername(), user.getEmail());\n+                emailRecipients.add(user.getEmail());\n+            }\n+            if (userNames.endsWith(\",\")) {\n+                userNames = userNames.substring(0, userNames.length() - 1);\n+            }\n+\n+            final Map<String, String> optionMap = new HashMap<String, String>();\n+            optionMap.put(\"accountName\", account.getAccountName());\n+            optionMap.put(\"accountID\", account.getUuid());\n+            optionMap.put(\"accountUsers\", userNames);\n+            optionMap.put(\"domainName\", accountDomain.getName());\n+            optionMap.put(\"domainID\", accountDomain.getUuid());\n+            optionMap.put(\"quotaBalance\", QuotaConfig.QuotaCurrencySymbol.value() + \" \" + balance.toString());\n+            if (emailType == QuotaEmailTemplateTypes.QUOTA_STATEMENT) {\n+                optionMap.put(\"quotaUsage\", QuotaConfig.QuotaCurrencySymbol.value() + \" \" + usage.toString());\n+            }\n+\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"accountName\" + account.getAccountName() + \"accountID\" + account.getUuid() + \"accountUsers\" + userNames + \"domainName\" + accountDomain.getName()\n+                        + \"domainID\" + accountDomain.getUuid());\n+            }\n+\n+            final StrSubstitutor templateEngine = new StrSubstitutor(optionMap);\n+            final String subject = templateEngine.replace(emailTemplate.getTemplateSubject());\n+            final String body = templateEngine.replace(emailTemplate.getTemplateBody());\n+            try {\n+                _emailQuotaAlert.sendQuotaAlert(emailRecipients, subject, body);\n+                emailToBeSent.sentSuccessfully(_quotaAcc);\n+            } catch (Exception e) {\n+                s_logger.error(String.format(\"Unable to send quota alert email (subject=%s; body=%s) to account %s (%s) recipients (%s) due to error (%s)\", subject, body,\n+                        account.getAccountName(), account.getUuid(), emailRecipients, e));\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Exception\", e);\n+                }\n+            }\n+        } else {\n+            s_logger.error(String.format(\"No quota email template found for type %s, cannot send quota alert email to account %s(%s)\", emailType, account.getAccountName(),\n+                    account.getUuid()));\n+        }\n+    }\n+\n+    public static long getDifferenceDays(Date d1, Date d2) {\n+        long diff = d2.getTime() - d1.getTime();\n+        return TimeUnit.DAYS.convert(diff, TimeUnit.MILLISECONDS);\n+    }\n+\n+    protected boolean lockAccount(long accountId) {\n+        final short opendb = TransactionLegacy.currentTxn().getDatabaseId();\n+        boolean success = false;\n+        try (TransactionLegacy txn = TransactionLegacy.open(TransactionLegacy.CLOUD_DB)) {\n+            Account account = _accountDao.findById(accountId);\n+            if (account != null) {\n+                if (account.getState() == State.locked) {\n+                    return true; // already locked, no-op\n+                } else if (account.getState() == State.enabled) {\n+                    AccountVO acctForUpdate = _accountDao.createForUpdate();\n+                    acctForUpdate.setState(State.locked);\n+                    success = _accountDao.update(Long.valueOf(accountId), acctForUpdate);\n+                } else {\n+                    if (s_logger.isInfoEnabled()) {\n+                        s_logger.info(\"Attempting to lock a non-enabled account, current state is \" + account.getState() + \" (accountId: \" + accountId + \"), locking failed.\");\n+                    }\n+                }\n+            } else {\n+                s_logger.warn(\"Failed to lock account \" + accountId + \", account not found.\");\n+            }\n+        } catch (Exception e) {\n+            s_logger.error(\"Exception occured while locking account by Quota Alert Manager\", e);\n+            throw e;\n+        } finally {\n+            TransactionLegacy.open(opendb).close();\n+        }\n+        return success;\n+    }\n+\n+    public static class DeferredQuotaEmail {\n+        private AccountVO account;\n+        private QuotaAccountVO quotaAccount;\n+        private QuotaConfig.QuotaEmailTemplateTypes emailTemplateType;\n+        private BigDecimal quotaUsage;\n+\n+        public DeferredQuotaEmail(AccountVO account, QuotaAccountVO quotaAccount, BigDecimal quotaUsage, QuotaConfig.QuotaEmailTemplateTypes emailTemplateType) {\n+            this.account = account;\n+            this.quotaAccount = quotaAccount;\n+            this.emailTemplateType = emailTemplateType;\n+            this.quotaUsage = quotaUsage;\n+        }\n+\n+        public DeferredQuotaEmail(AccountVO account, QuotaAccountVO quotaAccount, QuotaConfig.QuotaEmailTemplateTypes emailTemplateType) {\n+            this.account = account;\n+            this.quotaAccount = quotaAccount;\n+            this.emailTemplateType = emailTemplateType;\n+            this.quotaUsage = new BigDecimal(-1);\n+        }\n+\n+        public AccountVO getAccount() {\n+            return account;\n+        }\n+\n+        public BigDecimal getQuotaBalance() {\n+            return quotaAccount.getQuotaBalance();\n+        }\n+\n+        public BigDecimal getQuotaUsage() {\n+            return quotaUsage;\n+        }\n+\n+        public Date getSendDate() {\n+            if (emailTemplateType == QuotaEmailTemplateTypes.QUOTA_STATEMENT) {\n+                return quotaAccount.getLastStatementDate();\n+            } else {\n+                return quotaAccount.getQuotaAlertDate();\n+            }\n+        }\n+\n+        public QuotaConfig.QuotaEmailTemplateTypes getEmailTemplateType() {\n+            return emailTemplateType;\n+        }\n+\n+        public void sentSuccessfully(final QuotaAccountDao quotaAccountDao) {\n+            if (emailTemplateType == QuotaEmailTemplateTypes.QUOTA_STATEMENT) {\n+                quotaAccount.setLastStatementDate(new Date());\n+            } else {\n+                quotaAccount.setQuotaAlertDate(new Date());\n+                quotaAccount.setQuotaAlertType(emailTemplateType.ordinal());\n+            }\n+            quotaAccountDao.updateQuotaAccount(quotaAccount.getAccountId(), quotaAccount);\n+        }\n+    };\n+\n+    static class EmailQuotaAlert {\n+        private final Session _smtpSession;\n+        private final String _smtpHost;\n+        private final int _smtpPort;\n+        private final boolean _smtpUseAuth;\n+        private final String _smtpUsername;\n+        private final String _smtpPassword;\n+        private final String _emailSender;\n+\n+        public EmailQuotaAlert(String smtpHost, int smtpPort, boolean smtpUseAuth, final String smtpUsername, final String smtpPassword, String emailSender, boolean smtpDebug) {\n+            _smtpHost = smtpHost;\n+            _smtpPort = smtpPort;\n+            _smtpUseAuth = smtpUseAuth;\n+            _smtpUsername = smtpUsername;\n+            _smtpPassword = smtpPassword;\n+            _emailSender = emailSender;\n+\n+            if (!Strings.isNullOrEmpty(_smtpHost)) {\n+                Properties smtpProps = new Properties();\n+                smtpProps.put(\"mail.smtp.host\", smtpHost);\n+                smtpProps.put(\"mail.smtp.port\", smtpPort);\n+                smtpProps.put(\"mail.smtp.auth\", \"\" + smtpUseAuth);\n+                if (smtpUsername != null) {\n+                    smtpProps.put(\"mail.smtp.user\", smtpUsername);\n+                }\n+\n+                smtpProps.put(\"mail.smtps.host\", smtpHost);\n+                smtpProps.put(\"mail.smtps.port\", smtpPort);\n+                smtpProps.put(\"mail.smtps.auth\", \"\" + smtpUseAuth);\n+                if (!Strings.isNullOrEmpty(smtpUsername)) {\n+                    smtpProps.put(\"mail.smtps.user\", smtpUsername);\n+                }\n+\n+                if (!Strings.isNullOrEmpty(smtpUsername) && !Strings.isNullOrEmpty(smtpPassword)) {\n+                    _smtpSession = Session.getInstance(smtpProps, new Authenticator() {\n+                        @Override\n+                        protected PasswordAuthentication getPasswordAuthentication() {\n+                            return new PasswordAuthentication(smtpUsername, smtpPassword);\n+                        }\n+                    });\n+                } else {\n+                    _smtpSession = Session.getInstance(smtpProps);\n+                }\n+                _smtpSession.setDebug(smtpDebug);\n+            } else {\n+                _smtpSession = null;\n+            }\n+        }\n+\n+        public void sendQuotaAlert(List<String> emails, String subject, String body) throws MessagingException, UnsupportedEncodingException {\n+            if (_smtpSession == null) {\n+                throw new CloudRuntimeException(\"Unable to create smtp session.\");\n+            }\n+            SMTPMessage msg = new SMTPMessage(_smtpSession);\n+            msg.setSender(new InternetAddress(_emailSender, _emailSender));\n+            msg.setFrom(new InternetAddress(_emailSender, _emailSender));\n+\n+            for (String email : emails) {\n+                if (email != null && !email.isEmpty()) {\n+                    try {\n+                        InternetAddress address = new InternetAddress(email, email);\n+                        msg.addRecipient(Message.RecipientType.TO, address);\n+                    } catch (Exception pokemon) {\n+                        s_logger.error(\"Exception in creating address for:\" + email, pokemon);\n+                    }\n+                }\n+            }\n+\n+            msg.setSubject(subject);\n+            msg.setSentDate(new Date());\n+            msg.setContent(body, \"text/html; charset=utf-8\");\n+            msg.saveChanges();\n+\n+            SMTPTransport smtpTrans = null;\n+            if (_smtpUseAuth) {\n+                smtpTrans = new SMTPSSLTransport(_smtpSession, new URLName(\"smtp\", _smtpHost, _smtpPort, null, _smtpUsername, _smtpPassword));\n+            } else {\n+                smtpTrans = new SMTPTransport(_smtpSession, new URLName(\"smtp\", _smtpHost, _smtpPort, null, _smtpUsername, _smtpPassword));\n+            }\n+            smtpTrans.connect();\n+            smtpTrans.sendMessage(msg, msg.getAllRecipients());\n+            smtpTrans.close();\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "sha": "a57e0c27db9c9c97c2da39ed1979cd651c13877b",
                "status": "added"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaManager.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaManager.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaManager.java",
                "patch": "@@ -0,0 +1,25 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.utils.component.Manager;\n+\n+public interface QuotaManager extends Manager {\n+\n+    boolean calculateQuotaUsage();\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaManager.java",
                "sha": "1cda3b22e440fd86d79b3283ebced6c3e92e5e5d",
                "status": "added"
            },
            {
                "additions": 464,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "changes": 464,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "patch": "@@ -0,0 +1,464 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.usage.UsageVO;\n+import com.cloud.usage.dao.UsageDao;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.Pair;\n+import com.cloud.utils.component.ManagerBase;\n+\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaBalanceDao;\n+import org.apache.cloudstack.quota.dao.QuotaTariffDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.dao.ServiceOfferingDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.apache.cloudstack.quota.vo.ServiceOfferingVO;\n+import org.apache.cloudstack.utils.usage.UsageUtils;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TimeZone;\n+\n+@Component\n+@Local(value = QuotaManager.class)\n+public class QuotaManagerImpl extends ManagerBase implements QuotaManager {\n+    private static final Logger s_logger = Logger.getLogger(QuotaManagerImpl.class.getName());\n+\n+    @Inject\n+    private AccountDao _accountDao;\n+    @Inject\n+    private QuotaAccountDao _quotaAcc;\n+    @Inject\n+    private UsageDao _usageDao;\n+    @Inject\n+    private QuotaTariffDao _quotaTariffDao;\n+    @Inject\n+    private QuotaUsageDao _quotaUsageDao;\n+    @Inject\n+    private ServiceOfferingDao _serviceOfferingDao;\n+    @Inject\n+    private QuotaBalanceDao _quotaBalanceDao;\n+    @Inject\n+    private ConfigurationDao _configDao;\n+\n+    private TimeZone _usageTimezone;\n+    private int _aggregationDuration = 0;\n+\n+    final static BigDecimal s_hoursInMonth = new BigDecimal(30 * 24);\n+    final static BigDecimal s_minutesInMonth = new BigDecimal(30 * 24 * 60);\n+    final static BigDecimal s_gb = new BigDecimal(1024 * 1024 * 1024);\n+\n+    public QuotaManagerImpl() {\n+        super();\n+    }\n+\n+    private void mergeConfigs(Map<String, String> dbParams, Map<String, Object> xmlParams) {\n+        for (Map.Entry<String, Object> param : xmlParams.entrySet()) {\n+            dbParams.put(param.getKey(), (String)param.getValue());\n+        }\n+    }\n+\n+    @Override\n+    public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n+        super.configure(name, params);\n+\n+        Map<String, String> configs = _configDao.getConfiguration(params);\n+\n+        if (params != null) {\n+            mergeConfigs(configs, params);\n+        }\n+\n+        String aggregationRange = configs.get(\"usage.stats.job.aggregation.range\");\n+        String timeZoneStr = configs.get(\"usage.aggregation.timezone\");\n+\n+        if (timeZoneStr == null) {\n+            timeZoneStr = \"GMT\";\n+        }\n+        _usageTimezone = TimeZone.getTimeZone(timeZoneStr);\n+\n+        _aggregationDuration = Integer.parseInt(aggregationRange);\n+        if (_aggregationDuration < UsageUtils.USAGE_AGGREGATION_RANGE_MIN) {\n+            s_logger.warn(\"Usage stats job aggregation range is to small, using the minimum value of \" + UsageUtils.USAGE_AGGREGATION_RANGE_MIN);\n+            _aggregationDuration = UsageUtils.USAGE_AGGREGATION_RANGE_MIN;\n+        }\n+        s_logger.info(\"Usage timezone = \" + _usageTimezone + \" AggregationDuration=\" + _aggregationDuration);\n+\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean start() {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(\"Starting Quota Manager\");\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean stop() {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(\"Stopping Quota Manager\");\n+        }\n+        return true;\n+    }\n+\n+    public List<QuotaUsageVO> aggregatePendingQuotaRecordsForAccount(final AccountVO account, final Pair<List<? extends UsageVO>, Integer> usageRecords) {\n+        List<QuotaUsageVO> quotaListForAccount = new ArrayList<>();\n+        if (usageRecords == null || usageRecords.first() == null || usageRecords.first().isEmpty()) {\n+            return quotaListForAccount;\n+        }\n+        s_logger.info(\"Getting pending quota records for account=\" + account.getAccountName());\n+        for (UsageVO usageRecord : usageRecords.first()) {\n+            BigDecimal aggregationRatio = new BigDecimal(_aggregationDuration).divide(s_minutesInMonth, 8, RoundingMode.HALF_EVEN);\n+            switch (usageRecord.getUsageType()) {\n+            case QuotaTypes.RUNNING_VM:\n+                List<QuotaUsageVO> lq = updateQuotaRunningVMUsage(usageRecord, aggregationRatio);\n+                if (!lq.isEmpty()) {\n+                    quotaListForAccount.addAll(lq);\n+                }\n+                break;\n+            case QuotaTypes.ALLOCATED_VM:\n+                QuotaUsageVO qu = updateQuotaAllocatedVMUsage(usageRecord, aggregationRatio);\n+                if (qu != null) {\n+                    quotaListForAccount.add(qu);\n+                }\n+                break;\n+            case QuotaTypes.SNAPSHOT:\n+            case QuotaTypes.TEMPLATE:\n+            case QuotaTypes.ISO:\n+            case QuotaTypes.VOLUME:\n+            case QuotaTypes.VM_SNAPSHOT:\n+                qu = updateQuotaDiskUsage(usageRecord, aggregationRatio, usageRecord.getUsageType());\n+                if (qu != null) {\n+                    quotaListForAccount.add(qu);\n+                }\n+                break;\n+            case QuotaTypes.LOAD_BALANCER_POLICY:\n+            case QuotaTypes.PORT_FORWARDING_RULE:\n+            case QuotaTypes.IP_ADDRESS:\n+            case QuotaTypes.NETWORK_OFFERING:\n+            case QuotaTypes.SECURITY_GROUP:\n+            case QuotaTypes.VPN_USERS:\n+                qu = updateQuotaRaw(usageRecord, aggregationRatio, usageRecord.getUsageType());\n+                if (qu != null) {\n+                    quotaListForAccount.add(qu);\n+                }\n+                break;\n+            case QuotaTypes.NETWORK_BYTES_RECEIVED:\n+            case QuotaTypes.NETWORK_BYTES_SENT:\n+                qu = updateQuotaNetwork(usageRecord, usageRecord.getUsageType());\n+                if (qu != null) {\n+                    quotaListForAccount.add(qu);\n+                }\n+                break;\n+            case QuotaTypes.VM_DISK_IO_READ:\n+            case QuotaTypes.VM_DISK_IO_WRITE:\n+            case QuotaTypes.VM_DISK_BYTES_READ:\n+            case QuotaTypes.VM_DISK_BYTES_WRITE:\n+            default:\n+                break;\n+            }\n+        }\n+        return quotaListForAccount;\n+    }\n+\n+    public void processQuotaBalanceForAccount(final AccountVO account, final List<QuotaUsageVO> quotaListForAccount) {\n+        if (quotaListForAccount == null || quotaListForAccount.isEmpty()) {\n+            return;\n+        }\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(quotaListForAccount.get(0));\n+        }\n+        Date startDate = quotaListForAccount.get(0).getStartDate();\n+        Date endDate = quotaListForAccount.get(0).getEndDate();\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"processQuotaBalanceForAccount startDate \" + startDate + \" endDate=\" + endDate);\n+            s_logger.debug(\"processQuotaBalanceForAccount last items startDate \" + quotaListForAccount.get(quotaListForAccount.size() - 1).getStartDate() + \" items endDate=\"\n+                    + quotaListForAccount.get(quotaListForAccount.size() - 1).getEndDate());\n+        }\n+        quotaListForAccount.add(new QuotaUsageVO());\n+        BigDecimal aggrUsage = new BigDecimal(0);\n+        List<QuotaBalanceVO> creditsReceived = null;\n+\n+        //bootstrapping\n+        QuotaUsageVO lastQuotaUsage = _quotaUsageDao.findLastQuotaUsageEntry(account.getAccountId(), account.getDomainId(), startDate);\n+        if (lastQuotaUsage == null) {\n+            creditsReceived = _quotaBalanceDao.findCreditBalance(account.getAccountId(), account.getDomainId(), new Date(0), startDate);\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Credit entries count \" + creditsReceived.size() + \" on Before Date=\" + startDate);\n+            }\n+            if (creditsReceived != null) {\n+                for (QuotaBalanceVO credit : creditsReceived) {\n+                    if (s_logger.isDebugEnabled()) {\n+                        s_logger.debug(\"Credit entry found \" + credit);\n+                        s_logger.debug(\"Total = \" + aggrUsage);\n+                    }\n+                    aggrUsage = aggrUsage.add(credit.getCreditBalance());\n+                }\n+            }\n+            // create a balance entry for these accumulated credits\n+            QuotaBalanceVO firstBalance = new QuotaBalanceVO(account.getAccountId(), account.getDomainId(), aggrUsage, startDate);\n+            _quotaBalanceDao.saveQuotaBalance(firstBalance);\n+        }\n+        else {\n+            QuotaBalanceVO lastRealBalanceEntry = _quotaBalanceDao.findLastBalanceEntry(account.getAccountId(), account.getDomainId(), endDate);\n+            aggrUsage = aggrUsage.add(lastRealBalanceEntry.getCreditBalance());\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Last balance entry  \" + lastRealBalanceEntry + \" AggrUsage=\" + aggrUsage);\n+            }\n+        }\n+\n+        for (QuotaUsageVO entry : quotaListForAccount) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Usage entry found \" + entry);\n+            }\n+            if (entry.getQuotaUsed().compareTo(BigDecimal.ZERO) == 0) {\n+                // check if there were credits\n+                creditsReceived = _quotaBalanceDao.findCreditBalance(account.getAccountId(), account.getDomainId(), entry.getStartDate(), entry.getEndDate());\n+                if (creditsReceived != null) {\n+                    for (QuotaBalanceVO credit : creditsReceived) {\n+                        if (s_logger.isDebugEnabled()) {\n+                            s_logger.debug(\"Credit entry found \" + credit);\n+                            s_logger.debug(\"Total = \" + aggrUsage);\n+                        }\n+                        aggrUsage = aggrUsage.add(credit.getCreditBalance());\n+                    }\n+                }\n+                continue;\n+            }\n+            if (startDate.compareTo(entry.getStartDate()) != 0) {\n+                QuotaBalanceVO newBalance = new QuotaBalanceVO(account.getAccountId(), account.getDomainId(), aggrUsage, endDate);\n+                _quotaBalanceDao.saveQuotaBalance(newBalance);\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Saving Balance\" + newBalance);\n+                }\n+\n+                //New balance entry\n+                aggrUsage = new BigDecimal(0);\n+                startDate = entry.getStartDate();\n+                endDate = entry.getEndDate();\n+\n+                QuotaBalanceVO lastRealBalanceEntry = _quotaBalanceDao.findLastBalanceEntry(account.getAccountId(), account.getDomainId(), endDate);\n+                Date lastBalanceDate = new Date(0);\n+                if (lastRealBalanceEntry != null) {\n+                    lastBalanceDate = lastRealBalanceEntry.getUpdatedOn();\n+                    aggrUsage = aggrUsage.add(lastRealBalanceEntry.getCreditBalance());\n+                }\n+                creditsReceived = _quotaBalanceDao.findCreditBalance(account.getAccountId(), account.getDomainId(), lastBalanceDate, endDate);\n+                if (creditsReceived != null) {\n+                    for (QuotaBalanceVO credit : creditsReceived) {\n+                        aggrUsage = aggrUsage.add(credit.getCreditBalance());\n+                    }\n+                }\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Getting Balance\" + account.getAccountName() + \",Balance entry=\" + aggrUsage + \" on Date=\" + endDate);\n+                }\n+            }\n+            aggrUsage = aggrUsage.subtract(entry.getQuotaUsed());\n+        }\n+        QuotaBalanceVO newBalance = new QuotaBalanceVO(account.getAccountId(), account.getDomainId(), aggrUsage, endDate);\n+        _quotaBalanceDao.saveQuotaBalance(newBalance);\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Saving Balance\" + newBalance);\n+        }\n+\n+        // update quota_accounts\n+        QuotaAccountVO quota_account = _quotaAcc.findByIdQuotaAccount(account.getAccountId());\n+\n+        if (quota_account == null) {\n+            quota_account = new QuotaAccountVO(account.getAccountId());\n+            quota_account.setQuotaBalance(aggrUsage);\n+            quota_account.setQuotaBalanceDate(endDate);\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(quota_account);\n+            }\n+            _quotaAcc.persistQuotaAccount(quota_account);\n+        } else {\n+            quota_account.setQuotaBalance(aggrUsage);\n+            quota_account.setQuotaBalanceDate(endDate);\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(quota_account);\n+            }\n+            _quotaAcc.updateQuotaAccount(account.getAccountId(), quota_account);\n+        }\n+    }\n+\n+    @Override\n+    public boolean calculateQuotaUsage() {\n+        List<AccountVO> accounts = _accountDao.listAll();\n+        for (AccountVO account : accounts) {\n+            Pair<List<? extends UsageVO>, Integer> usageRecords = _usageDao.getUsageRecordsPendingQuotaAggregation(account.getAccountId(), account.getDomainId());\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Usage entries size = \" + usageRecords.second().intValue() + \", accId\" + account.getAccountId() + \", domId\" + account.getDomainId());\n+            }\n+            List<QuotaUsageVO> quotaListForAccount = aggregatePendingQuotaRecordsForAccount(account, usageRecords);\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Quota entries size = \" + quotaListForAccount.size() + \", accId\" + account.getAccountId() + \", domId\" + account.getDomainId());\n+            }\n+            processQuotaBalanceForAccount(account, quotaListForAccount);\n+        }\n+        return true;\n+    }\n+\n+    public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal aggregationRatio, final int quotaType) {\n+        QuotaUsageVO quota_usage = null;\n+        QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(quotaType, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal quotaUsgage;\n+            BigDecimal onehourcostpergb;\n+            BigDecimal noofgbinuse;\n+            onehourcostpergb = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            noofgbinuse = new BigDecimal(usageRecord.getSize()).divide(s_gb, 8, RoundingMode.HALF_EVEN);\n+            quotaUsgage = new BigDecimal(usageRecord.getRawUsage()).multiply(onehourcostpergb).multiply(noofgbinuse);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), usageRecord.getUsageType(),\n+                    quotaUsgage, usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+        }\n+        usageRecord.setQuotaCalculated(1);\n+        _usageDao.persistUsage(usageRecord);\n+        return quota_usage;\n+    }\n+\n+    public List<QuotaUsageVO> updateQuotaRunningVMUsage(UsageVO usageRecord, final BigDecimal aggregationRatio) {\n+        List<QuotaUsageVO> quotalist = new ArrayList<QuotaUsageVO>();\n+        QuotaUsageVO quota_usage;\n+        BigDecimal cpuquotausgage, speedquotausage, memoryquotausage, vmusage;\n+        BigDecimal onehourcostpercpu, onehourcostper100mhz, onehourcostper1mb, onehourcostforvmusage;\n+        BigDecimal rawusage;\n+        // get service offering details\n+        ServiceOfferingVO serviceoffering = _serviceOfferingDao.findServiceOffering(usageRecord.getVmInstanceId(), usageRecord.getOfferingId());\n+        rawusage = new BigDecimal(usageRecord.getRawUsage());\n+\n+        QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.CPU_NUMBER, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal cpu = new BigDecimal(serviceoffering.getCpu());\n+            onehourcostpercpu = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            cpuquotausgage = rawusage.multiply(onehourcostpercpu).multiply(cpu);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), QuotaTypes.CPU_NUMBER,\n+                    cpuquotausgage, usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+            quotalist.add(quota_usage);\n+        }\n+        tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.CPU_CLOCK_RATE, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal speed = new BigDecimal(serviceoffering.getSpeed() / 100.00);\n+            onehourcostper100mhz = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            speedquotausage = rawusage.multiply(onehourcostper100mhz).multiply(speed);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), QuotaTypes.CPU_CLOCK_RATE,\n+                    speedquotausage, usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+            quotalist.add(quota_usage);\n+        }\n+        tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.MEMORY, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal memory = new BigDecimal(serviceoffering.getRamSize());\n+            onehourcostper1mb = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            memoryquotausage = rawusage.multiply(onehourcostper1mb).multiply(memory);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), QuotaTypes.MEMORY, memoryquotausage,\n+                    usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+            quotalist.add(quota_usage);\n+        }\n+        tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.RUNNING_VM, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            onehourcostforvmusage = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            vmusage = rawusage.multiply(onehourcostforvmusage);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), QuotaTypes.RUNNING_VM, vmusage,\n+                    usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+            quotalist.add(quota_usage);\n+        }\n+\n+        usageRecord.setQuotaCalculated(1);\n+        _usageDao.persistUsage(usageRecord);\n+        return quotalist;\n+    }\n+\n+    public QuotaUsageVO updateQuotaAllocatedVMUsage(UsageVO usageRecord, final BigDecimal aggregationRatio) {\n+        QuotaUsageVO quota_usage = null;\n+        QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.ALLOCATED_VM, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal vmusage;\n+            BigDecimal onehourcostforvmusage;\n+            onehourcostforvmusage = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            vmusage = new BigDecimal(usageRecord.getRawUsage()).multiply(onehourcostforvmusage);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), QuotaTypes.ALLOCATED_VM, vmusage,\n+                    usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+        }\n+\n+        usageRecord.setQuotaCalculated(1);\n+        _usageDao.persistUsage(usageRecord);\n+        return quota_usage;\n+    }\n+\n+    public QuotaUsageVO updateQuotaRaw(UsageVO usageRecord, final BigDecimal aggregationRatio, final int ruleType) {\n+        QuotaUsageVO quota_usage = null;\n+        QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(ruleType, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal ruleusage;\n+            BigDecimal onehourcost;\n+            onehourcost = tariff.getCurrencyValue().multiply(aggregationRatio);\n+            ruleusage = new BigDecimal(usageRecord.getRawUsage()).multiply(onehourcost);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), ruleType, ruleusage,\n+                    usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+        }\n+\n+        usageRecord.setQuotaCalculated(1);\n+        _usageDao.persistUsage(usageRecord);\n+        return quota_usage;\n+    }\n+\n+    public QuotaUsageVO updateQuotaNetwork(UsageVO usageRecord, final int transferType) {\n+        QuotaUsageVO quota_usage = null;\n+        QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(transferType, usageRecord.getEndDate());\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+            BigDecimal onegbcost;\n+            BigDecimal rawusageingb;\n+            BigDecimal networkusage;\n+            onegbcost = tariff.getCurrencyValue();\n+            rawusageingb = new BigDecimal(usageRecord.getRawUsage()).divide(s_gb, 8, RoundingMode.HALF_EVEN);\n+            networkusage = rawusageingb.multiply(onegbcost);\n+            quota_usage = new QuotaUsageVO(usageRecord.getId(), usageRecord.getZoneId(), usageRecord.getAccountId(), usageRecord.getDomainId(), transferType, networkusage,\n+                    usageRecord.getStartDate(), usageRecord.getEndDate());\n+            _quotaUsageDao.persistQuotaUsage(quota_usage);\n+        }\n+\n+        usageRecord.setQuotaCalculated(1);\n+        _usageDao.persistUsage(usageRecord);\n+        return quota_usage;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "sha": "d7c301e1beac578713cfb3a0599485b1bd8c0aa9",
                "status": "added"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaStatement.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaStatement.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaStatement.java",
                "patch": "@@ -0,0 +1,26 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import java.util.Calendar;\n+\n+import com.cloud.utils.component.Manager;\n+\n+public interface QuotaStatement extends Manager {\n+    void sendStatement();\n+    Calendar[] getCurrentStatementTime();\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaStatement.java",
                "sha": "e6f5e25eaea834ef5e7797b89dc8beaa376d8f23",
                "status": "added"
            },
            {
                "additions": 376,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "changes": 376,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "patch": "@@ -0,0 +1,376 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.QuotaAlertManagerImpl.DeferredQuotaEmail;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.component.ManagerBase;\n+\n+@Component\n+@Local(value = QuotaStatement.class)\n+public class QuotaStatementImpl extends ManagerBase implements QuotaStatement {\n+    private static final Logger s_logger = Logger.getLogger(QuotaStatementImpl.class);\n+\n+    @Inject\n+    private AccountDao _accountDao;\n+    @Inject\n+    private QuotaAccountDao _quotaAcc;\n+    @Inject\n+    private QuotaUsageDao _quotaUsage;\n+    @Inject\n+    private QuotaAlertManager _quotaAlert;\n+    @Inject\n+    private ConfigurationDao _configDao;\n+\n+    final public static int s_LAST_STATEMENT_SENT_DAYS = 6; //ideally should be less than 7 days\n+\n+    public enum STATEMENT_PERIODS {\n+        BIMONTHLY, MONTHLY, QUATERLY, HALFYEARLY, YEARLY\n+    };\n+\n+    private STATEMENT_PERIODS _period = STATEMENT_PERIODS.MONTHLY;\n+\n+    public QuotaStatementImpl() {\n+        super();\n+    }\n+\n+    private void mergeConfigs(Map<String, String> dbParams, Map<String, Object> xmlParams) {\n+        for (Map.Entry<String, Object> param : xmlParams.entrySet()) {\n+            dbParams.put(param.getKey(), (String)param.getValue());\n+        }\n+    }\n+\n+    @Override\n+    public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n+        super.configure(name, params);\n+\n+        Map<String, String> configs = _configDao.getConfiguration(params);\n+\n+        if (params != null) {\n+            mergeConfigs(configs, params);\n+        }\n+        String period_str = configs.get(QuotaConfig.QuotaStatementPeriod.key());\n+        int period = period_str == null ? 1 : Integer.valueOf(period_str);\n+\n+        STATEMENT_PERIODS _period = STATEMENT_PERIODS.values()[period];\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean start() {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(\"Starting Statement Manager\");\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean stop() {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(\"Stopping Statement Manager\");\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public void sendStatement() {\n+\n+        List<DeferredQuotaEmail> deferredQuotaEmailList = new ArrayList<DeferredQuotaEmail>();\n+        for (final QuotaAccountVO quotaAccount : _quotaAcc.listAllQuotaAccount()) {\n+            if (quotaAccount.getQuotaBalance() == null) {\n+                continue; // no quota usage for this account ever, ignore\n+            }\n+\n+            //check if it is statement time\n+            Calendar interval[] = statementTime(Calendar.getInstance(), _period);\n+\n+            Date lastStatementDate = quotaAccount.getLastStatementDate();\n+            if (interval != null) {\n+                AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                if (lastStatementDate == null || getDifferenceDays(lastStatementDate, new Date()) >= s_LAST_STATEMENT_SENT_DAYS + 1) {\n+                    BigDecimal quotaUsage = _quotaUsage.findTotalQuotaUsage(account.getAccountId(), account.getDomainId(), null, interval[0].getTime(), interval[1].getTime());\n+                    s_logger.info(\"For account=\" + quotaAccount.getId() + \", quota used = \" + quotaUsage);\n+                    // send statement\n+                    deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, quotaUsage, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_STATEMENT));\n+                } else {\n+                    if (s_logger.isDebugEnabled()) {\n+                        s_logger.debug(\"For \" + quotaAccount.getId() + \" the statement has been sent recently\");\n+\n+                    }\n+                }\n+            } else if (lastStatementDate != null) {\n+                s_logger.info(\"For \" + quotaAccount.getId() + \" it is already more than \" + getDifferenceDays(lastStatementDate, new Date())\n+                        + \" days, will send statement in next cycle\");\n+            }\n+        }\n+\n+        for (DeferredQuotaEmail emailToBeSent : deferredQuotaEmailList) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Attempting to send quota STATEMENT email to users of account: \" + emailToBeSent.getAccount().getAccountName());\n+            }\n+            _quotaAlert.sendQuotaAlert(emailToBeSent);\n+        }\n+    }\n+\n+    @Override\n+    public Calendar[] getCurrentStatementTime() {\n+        final Calendar today = Calendar.getInstance();\n+        int day_of_month = today.get(Calendar.DAY_OF_MONTH);\n+        int month_of_year = today.get(Calendar.MONTH);\n+\n+        Calendar firstDateOfCurrentPeriod, lastDateOfCurrentPeriod;\n+        Calendar aCalendar = (Calendar)today.clone();\n+        aCalendar.add(Calendar.DATE, 1);\n+        aCalendar.set(Calendar.HOUR, 0);\n+        aCalendar.set(Calendar.MINUTE, 0);\n+        aCalendar.set(Calendar.SECOND, 0);\n+        lastDateOfCurrentPeriod = aCalendar;\n+\n+        switch (_period) {\n+        case BIMONTHLY:\n+            if (day_of_month < 16) {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.add(Calendar.MONTH, 0);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            } else {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.DATE, 16);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            }\n+        case MONTHLY:\n+            aCalendar = (Calendar)today.clone();\n+            aCalendar.set(Calendar.DATE, 1);\n+            aCalendar.set(Calendar.HOUR, 0);\n+            aCalendar.set(Calendar.MINUTE, 0);\n+            aCalendar.set(Calendar.SECOND, 0);\n+            firstDateOfCurrentPeriod = aCalendar;\n+            return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+        case QUATERLY:\n+            if (month_of_year < Calendar.APRIL) {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.MONTH, Calendar.JANUARY);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            } else if (month_of_year < Calendar.JULY) {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.MONTH, Calendar.APRIL);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            } else if (month_of_year < Calendar.OCTOBER) {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.MONTH, Calendar.JULY);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            } else {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.MONTH, Calendar.OCTOBER);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            }\n+        case HALFYEARLY:\n+            // statements are sent in Jan=1, Jul 7,\n+            if (month_of_year < Calendar.JULY) {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.MONTH, Calendar.JANUARY);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            } else {\n+                aCalendar = (Calendar)today.clone();\n+                aCalendar.set(Calendar.MONTH, Calendar.JULY);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfCurrentPeriod = aCalendar;\n+                return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+            }\n+        case YEARLY:\n+            aCalendar = (Calendar)today.clone();\n+            aCalendar.add(Calendar.MONTH, Calendar.JANUARY);\n+            aCalendar.set(Calendar.DATE, 1);\n+            aCalendar.set(Calendar.HOUR, 0);\n+            aCalendar.set(Calendar.MINUTE, 0);\n+            aCalendar.set(Calendar.SECOND, 0);\n+            firstDateOfCurrentPeriod = aCalendar;\n+            return new Calendar[] {firstDateOfCurrentPeriod, lastDateOfCurrentPeriod};\n+        default:\n+            break;\n+        }\n+        return null;\n+    }\n+\n+    public Calendar[] statementTime(final Calendar today, final STATEMENT_PERIODS period) {\n+        //check if it is statement time\n+        int day_of_month = today.get(Calendar.DAY_OF_MONTH);\n+        int month_of_year = today.get(Calendar.MONTH);\n+        Calendar firstDateOfPreviousPeriod, lastDateOfPreviousPeriod;\n+        switch (period) {\n+        case BIMONTHLY:\n+            if (day_of_month < s_LAST_STATEMENT_SENT_DAYS) {\n+                Calendar aCalendar = (Calendar)today.clone();\n+                aCalendar.add(Calendar.MONTH, 0);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                aCalendar.set(Calendar.DATE, 15);\n+                lastDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                return new Calendar[] {firstDateOfPreviousPeriod, lastDateOfPreviousPeriod};\n+            } else if (day_of_month > 15 && (day_of_month - 15) < s_LAST_STATEMENT_SENT_DAYS) {\n+                Calendar aCalendar = (Calendar)today.clone();\n+                aCalendar.add(Calendar.MONTH, -1);\n+                aCalendar.set(Calendar.DATE, 16);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+                lastDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                return new Calendar[] {firstDateOfPreviousPeriod, lastDateOfPreviousPeriod};\n+            }\n+            return null;\n+        case MONTHLY:\n+            if (day_of_month < s_LAST_STATEMENT_SENT_DAYS) {\n+                Calendar aCalendar = (Calendar)today.clone();\n+                aCalendar.add(Calendar.MONTH, -1);\n+                aCalendar.set(Calendar.DATE, 1);\n+                aCalendar.set(Calendar.HOUR, 0);\n+                aCalendar.set(Calendar.MINUTE, 0);\n+                aCalendar.set(Calendar.SECOND, 0);\n+                firstDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+                lastDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                return new Calendar[] {firstDateOfPreviousPeriod, lastDateOfPreviousPeriod};\n+            }\n+            return null;\n+        case QUATERLY:\n+            // statements are sent in Jan=1, Apr 4, Jul 7, Oct 10\n+            if (month_of_year == Calendar.JANUARY || month_of_year == Calendar.APRIL || month_of_year == Calendar.JULY || month_of_year == Calendar.OCTOBER) {\n+                if (day_of_month < s_LAST_STATEMENT_SENT_DAYS) {\n+                    Calendar aCalendar = (Calendar)today.clone();\n+                    aCalendar.add(Calendar.MONTH, -3);\n+                    aCalendar.set(Calendar.DATE, 1);\n+                    aCalendar.set(Calendar.HOUR, 0);\n+                    aCalendar.set(Calendar.MINUTE, 0);\n+                    aCalendar.set(Calendar.SECOND, 0);\n+                    firstDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                    aCalendar.add(Calendar.MONTH, 2);\n+                    aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+                    lastDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                    return new Calendar[] {firstDateOfPreviousPeriod, lastDateOfPreviousPeriod};\n+                }\n+            }\n+            return null;\n+        case HALFYEARLY:\n+            // statements are sent in Jan=1, Jul 7,\n+            if (month_of_year == Calendar.JANUARY || month_of_year == Calendar.JULY) {\n+                if (day_of_month < s_LAST_STATEMENT_SENT_DAYS) {\n+                    Calendar aCalendar = (Calendar)today.clone();\n+                    aCalendar.add(Calendar.MONTH, -6);\n+                    aCalendar.set(Calendar.DATE, 1);\n+                    aCalendar.set(Calendar.HOUR, 0);\n+                    aCalendar.set(Calendar.MINUTE, 0);\n+                    aCalendar.set(Calendar.SECOND, 0);\n+                    firstDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                    aCalendar.add(Calendar.MONTH, 5);\n+                    aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+                    lastDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                    return new Calendar[] {firstDateOfPreviousPeriod, lastDateOfPreviousPeriod};\n+                }\n+            }\n+            return null;\n+        case YEARLY:\n+            // statements are sent in Jan=1\n+            if (month_of_year == Calendar.JANUARY) {\n+                if (day_of_month < s_LAST_STATEMENT_SENT_DAYS) {\n+                    Calendar aCalendar = (Calendar)today.clone();\n+                    aCalendar.add(Calendar.MONTH, -12);\n+                    aCalendar.set(Calendar.DATE, 1);\n+                    aCalendar.set(Calendar.HOUR, 0);\n+                    aCalendar.set(Calendar.MINUTE, 0);\n+                    aCalendar.set(Calendar.SECOND, 0);\n+                    firstDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                    aCalendar.add(Calendar.MONTH, 11);\n+                    aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+                    lastDateOfPreviousPeriod = (Calendar)aCalendar.clone();\n+                    return new Calendar[] {firstDateOfPreviousPeriod, lastDateOfPreviousPeriod};\n+                }\n+            }\n+            return null;\n+        default:\n+            break;\n+        }\n+        return null;\n+    }\n+\n+    public static long getDifferenceDays(Date d1, Date d2) {\n+        long diff = d2.getTime() - d1.getTime();\n+        return TimeUnit.DAYS.convert(diff, TimeUnit.MILLISECONDS);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "sha": "682b2ef0366dded6b048dcd350eeb0e940a82259",
                "status": "added"
            },
            {
                "additions": 57,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/constant/QuotaConfig.java",
                "changes": 57,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/constant/QuotaConfig.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/constant/QuotaConfig.java",
                "patch": "@@ -0,0 +1,57 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+\n+package org.apache.cloudstack.quota.constant;\n+\n+import org.apache.cloudstack.framework.config.ConfigKey;\n+\n+public interface QuotaConfig {\n+\n+    public static final ConfigKey<Boolean> QuotaPluginEnabled = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"quota.enable.service\", \"false\",\n+            \"Indicates whether Quota plugin is enabled or not\", true);\n+\n+    public static final ConfigKey<String> QuotaEnableEnforcement = new ConfigKey<String>(\"Advanced\", String.class, \"quota.enable.enforcement\", \"false\",\n+            \"Enable the usage quota enforcement, i.e. on true when exceeding quota the respective account will be locked.\", true);\n+\n+    public static final ConfigKey<String> QuotaCurrencySymbol = new ConfigKey<String>(\"Advanced\", String.class, \"quota.currency.symbol\", \"$\",\n+            \"The symbol for the currency in use to measure usage.\", true);\n+\n+    public static final ConfigKey<Integer> QuotaStatementPeriod = new ConfigKey<Integer>(\"Advanced\", Integer.class, \"quota.statement.period\", \"1\",\n+            \"This variables define the statement generation interval. Values correspond to bimonthly=0, monthly=1, quarterly=2, half-yearly=3 and yearly=4.\", true);\n+\n+    public static final ConfigKey<String> QuotaSmtpHost = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.host\", \"\", \"Quota SMTP host for quota related emails\",\n+            true);\n+\n+    public static final ConfigKey<String> QuotaSmtpTimeout = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.connection.timeout\", \"60\",\n+            \"Quota SMTP server connection timeout duration\", true);\n+\n+    public static final ConfigKey<String> QuotaSmtpUser = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.user\", \"\", \"Quota SMTP server username\", true);\n+\n+    public static final ConfigKey<String> QuotaSmtpPassword = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.password\", \"\", \"Quota SMTP server password\", true);\n+\n+    public static final ConfigKey<String> QuotaSmtpPort = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.port\", \"\", \"Quota SMTP port\", true);\n+\n+    public static final ConfigKey<String> QuotaSmtpAuthType = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.useAuth\", \"\",\n+            \"If true, use secure SMTP authentication when sending emails.\", true);\n+\n+    public static final ConfigKey<String> QuotaSmtpSender = new ConfigKey<String>(\"Advanced\", String.class, \"quota.usage.smtp.sender\", \"\",\n+            \"Sender of quota alert email (will be in the From header of the email)\", true);\n+\n+    enum QuotaEmailTemplateTypes {\n+        QUOTA_LOW, QUOTA_EMPTY, QUOTA_UNLOCK_ACCOUNT, QUOTA_STATEMENT\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/constant/QuotaConfig.java",
                "sha": "73c9a80e3c913f29df3a48c3b78e7db681eb4df1",
                "status": "added"
            },
            {
                "additions": 103,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/constant/QuotaTypes.java",
                "changes": 103,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/constant/QuotaTypes.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/constant/QuotaTypes.java",
                "patch": "@@ -0,0 +1,103 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota.constant;\n+\n+import org.apache.cloudstack.usage.UsageTypes;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class QuotaTypes extends UsageTypes {\n+    public static final int CPU_CLOCK_RATE = 15;\n+    public static final int CPU_NUMBER = 16;\n+    public static final int MEMORY = 17;\n+\n+    private final Integer quotaType;\n+    private final String quotaName;\n+    private final String quotaUnit;\n+    private final String description;\n+    private final String discriminator;\n+    private final static Map<Integer, QuotaTypes> quotaTypeMap;\n+\n+    static {\n+        final HashMap<Integer, QuotaTypes> quotaTypeList = new HashMap<Integer, QuotaTypes>();\n+        quotaTypeList.put(RUNNING_VM, new QuotaTypes(RUNNING_VM, \"RUNNING_VM\", \"Compute-Month\", \"Running Vm Usage\"));\n+        quotaTypeList.put(ALLOCATED_VM, new QuotaTypes(ALLOCATED_VM, \"ALLOCATED_VM\", \"Compute-Month\", \"Allocated Vm Usage\"));\n+        quotaTypeList.put(IP_ADDRESS, new QuotaTypes(IP_ADDRESS, \"IP_ADDRESS\", \"IP-Month\", \"IP Address Usage\"));\n+        quotaTypeList.put(NETWORK_BYTES_SENT, new QuotaTypes(NETWORK_BYTES_SENT, \"NETWORK_BYTES_SENT\", \"GB\", \"Network Usage (Bytes Sent)\"));\n+        quotaTypeList.put(NETWORK_BYTES_RECEIVED, new QuotaTypes(NETWORK_BYTES_RECEIVED, \"NETWORK_BYTES_RECEIVED\", \"GB\", \"Network Usage (Bytes Received)\"));\n+        quotaTypeList.put(VOLUME, new QuotaTypes(VOLUME, \"VOLUME\", \"GB-Month\", \"Volume Usage\"));\n+        quotaTypeList.put(TEMPLATE, new QuotaTypes(TEMPLATE, \"TEMPLATE\", \"GB-Month\", \"Template Usage\"));\n+        quotaTypeList.put(ISO, new QuotaTypes(ISO, \"ISO\", \"GB-Month\", \"ISO Usage\"));\n+        quotaTypeList.put(SNAPSHOT, new QuotaTypes(SNAPSHOT, \"SNAPSHOT\", \"GB-Month\", \"Snapshot Usage\"));\n+        quotaTypeList.put(SECURITY_GROUP, new QuotaTypes(SECURITY_GROUP, \"SECURITY_GROUP\", \"Policy-Month\", \"Security Group Usage\"));\n+        quotaTypeList.put(LOAD_BALANCER_POLICY, new QuotaTypes(LOAD_BALANCER_POLICY, \"LOAD_BALANCER_POLICY\", \"Policy-Month\", \"Load Balancer Usage\"));\n+        quotaTypeList.put(PORT_FORWARDING_RULE, new QuotaTypes(PORT_FORWARDING_RULE, \"PORT_FORWARDING_RULE\", \"Policy-Month\", \"Port Forwarding Usage\"));\n+        quotaTypeList.put(NETWORK_OFFERING, new QuotaTypes(NETWORK_OFFERING, \"NETWORK_OFFERING\", \"Policy-Month\", \"Network Offering Usage\"));\n+        quotaTypeList.put(VPN_USERS, new QuotaTypes(VPN_USERS, \"VPN_USERS\", \"Policy-Month\", \"VPN users usage\"));\n+        quotaTypeList.put(VM_DISK_IO_READ, new QuotaTypes(VM_DISK_IO_READ, \"VM_DISK_IO_READ\", \"GB\", \"VM Disk usage(I/O Read)\"));\n+        quotaTypeList.put(VM_DISK_IO_WRITE, new QuotaTypes(VM_DISK_IO_WRITE, \"VM_DISK_IO_WRITE\", \"GB\", \"VM Disk usage(I/O Write)\"));\n+        quotaTypeList.put(VM_DISK_BYTES_READ, new QuotaTypes(VM_DISK_BYTES_READ, \"VM_DISK_BYTES_READ\", \"GB\", \"VM Disk usage(Bytes Read)\"));\n+        quotaTypeList.put(VM_DISK_BYTES_WRITE, new QuotaTypes(VM_DISK_BYTES_WRITE, \"VPN_USERS\", \"GB\", \"VM Disk usage(Bytes Write)\"));\n+        quotaTypeList.put(VM_SNAPSHOT, new QuotaTypes(VM_SNAPSHOT, \"VM_SNAPSHOT\", \"GB-Month\", \"VM Snapshot storage usage\"));\n+        quotaTypeList.put(CPU_CLOCK_RATE, new QuotaTypes(CPU_CLOCK_RATE, \"CPU_CLOCK_RATE\", \"Compute-Month\", \"Quota tariff for using 1 CPU of clock rate 100MHz\"));\n+        quotaTypeList.put(CPU_NUMBER, new QuotaTypes(CPU_NUMBER, \"CPU_NUMBER\", \"Compute-Month\", \"Quota tariff for running VM that has 1vCPU\"));\n+        quotaTypeList.put(MEMORY, new QuotaTypes(MEMORY, \"MEMORY\", \"Compute-Month\", \"Quota tariff for using 1MB or RAM for 1 hour\"));\n+        quotaTypeMap = Collections.unmodifiableMap(quotaTypeList);\n+    }\n+\n+    private QuotaTypes(Integer quotaType, String name, String unit, String description) {\n+        this.quotaType = quotaType;\n+        this.description = description;\n+        this.quotaName = name;\n+        this.quotaUnit = unit;\n+        this.discriminator = \"None\";\n+    }\n+\n+    public static Map<Integer, QuotaTypes> listQuotaTypes() {\n+        return quotaTypeMap;\n+    }\n+\n+    public String getDiscriminator() {\n+        return discriminator;\n+    }\n+\n+    public String getQuotaName() {\n+        return quotaName;\n+    }\n+\n+    public String getQuotaUnit() {\n+        return quotaUnit;\n+    }\n+\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    public Integer getQuotaType() {\n+        return quotaType;\n+    }\n+\n+    static public String getDescription(int quotaType) {\n+        QuotaTypes t = quotaTypeMap.get(quotaType);\n+        if (t != null) {\n+            return t.getDescription();\n+        }\n+        return null;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/constant/QuotaTypes.java",
                "sha": "36910f47741ea77ca0734df6ef91154562970870",
                "status": "added"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDao.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDao.java",
                "patch": "@@ -0,0 +1,35 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.util.List;\n+\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+\n+import com.cloud.utils.db.GenericDao;\n+\n+public interface QuotaAccountDao extends GenericDao<QuotaAccountVO, Long> {\n+\n+    List<QuotaAccountVO> listAllQuotaAccount();\n+\n+    QuotaAccountVO findByIdQuotaAccount(Long id);\n+\n+    QuotaAccountVO persistQuotaAccount(QuotaAccountVO entity);\n+\n+    boolean updateQuotaAccount(Long id, QuotaAccountVO entity);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDao.java",
                "sha": "d1b441b831f3dcd9a98bb399dd133298acf4f04b",
                "status": "added"
            },
            {
                "additions": 74,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDaoImpl.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDaoImpl.java",
                "patch": "@@ -0,0 +1,74 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+\n+import java.util.List;\n+\n+@Component\n+@Local(value = { QuotaAccountDao.class })\n+public class QuotaAccountDaoImpl extends GenericDaoBase<QuotaAccountVO, Long> implements QuotaAccountDao {\n+    public static final Logger s_logger = Logger.getLogger(QuotaAccountDaoImpl.class);\n+\n+    public List<QuotaAccountVO> listAllQuotaAccount() {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaAccountVO>>() {\n+            @Override\n+            public List<QuotaAccountVO> doInTransaction(final TransactionStatus status) {\n+                return listAll();\n+            }\n+        });\n+    }\n+\n+    public QuotaAccountVO findByIdQuotaAccount(final Long id) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaAccountVO>() {\n+            @Override\n+            public QuotaAccountVO doInTransaction(final TransactionStatus status) {\n+                return findById(id);\n+            }\n+        });\n+    }\n+\n+    public QuotaAccountVO persistQuotaAccount(final QuotaAccountVO entity) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaAccountVO>() {\n+            @Override\n+            public QuotaAccountVO doInTransaction(final TransactionStatus status) {\n+                return persist(entity);\n+            }\n+        });\n+    }\n+\n+    public boolean updateQuotaAccount(final Long id, final QuotaAccountVO entity) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<Boolean>() {\n+            @Override\n+            public Boolean doInTransaction(final TransactionStatus status) {\n+                return update(id, entity);\n+            }\n+        });\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaAccountDaoImpl.java",
                "sha": "e3de1889de9f505162c0664ce0bf4521ed1a46b1",
                "status": "added"
            },
            {
                "additions": 43,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDao.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDao.java",
                "patch": "@@ -0,0 +1,43 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+import java.util.List;\n+\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+\n+import com.cloud.utils.db.GenericDao;\n+\n+public interface QuotaBalanceDao extends GenericDao<QuotaBalanceVO, Long> {\n+\n+    QuotaBalanceVO saveQuotaBalance(QuotaBalanceVO qb);\n+\n+    List<QuotaBalanceVO> findCreditBalance(Long accountId, Long domainId, Date startDate, Date endDate);\n+\n+    QuotaBalanceVO findLastBalanceEntry(Long accountId, Long domainId, Date beforeThis);\n+\n+    QuotaBalanceVO findLaterBalanceEntry(Long accountId, Long domainId, Date afterThis);\n+\n+    List<QuotaBalanceVO> findQuotaBalance(Long accountId, Long domainId, Date startDate, Date endDate);\n+\n+    List<QuotaBalanceVO> lastQuotaBalanceVO(Long accountId, Long domainId, Date startDate);\n+\n+    BigDecimal lastQuotaBalance(Long accountId, Long domainId, Date startDate);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDao.java",
                "sha": "c694eaeefbe8d63537b9090810ebd692f33f959d",
                "status": "added"
            },
            {
                "additions": 189,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDaoImpl.java",
                "changes": 189,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDaoImpl.java",
                "patch": "@@ -0,0 +1,189 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.QueryBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+\n+@Component\n+@Local(value = {QuotaBalanceDao.class})\n+public class QuotaBalanceDaoImpl extends GenericDaoBase<QuotaBalanceVO, Long> implements QuotaBalanceDao {\n+    private static final Logger s_logger = Logger.getLogger(QuotaBalanceDaoImpl.class.getName());\n+\n+    public QuotaBalanceVO findLastBalanceEntry(final Long accountId, final Long domainId, final Date beforeThis) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaBalanceVO>() {\n+            @Override\n+            public QuotaBalanceVO doInTransaction(final TransactionStatus status) {\n+                List<QuotaBalanceVO> quotaBalanceEntries = new ArrayList<>();\n+                Filter filter = new Filter(QuotaBalanceVO.class, \"updatedOn\", false, 0L, 1L);\n+                QueryBuilder<QuotaBalanceVO> qb = QueryBuilder.create(QuotaBalanceVO.class);\n+                qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                qb.and(qb.entity().getCreditsId(), SearchCriteria.Op.EQ, 0);\n+                qb.and(qb.entity().getUpdatedOn(), SearchCriteria.Op.LT, beforeThis);\n+                quotaBalanceEntries = search(qb.create(), filter);\n+                return !quotaBalanceEntries.isEmpty() ? quotaBalanceEntries.get(0) : null;\n+            }\n+        });\n+    }\n+\n+    public QuotaBalanceVO findLaterBalanceEntry(final Long accountId, final Long domainId, final Date afterThis) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaBalanceVO>() {\n+            @Override\n+            public QuotaBalanceVO doInTransaction(final TransactionStatus status) {\n+                List<QuotaBalanceVO> quotaBalanceEntries = new ArrayList<>();\n+                Filter filter = new Filter(QuotaBalanceVO.class, \"updatedOn\", true, 0L, 1L);\n+                QueryBuilder<QuotaBalanceVO> qb = QueryBuilder.create(QuotaBalanceVO.class);\n+                qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                qb.and(qb.entity().getCreditsId(), SearchCriteria.Op.EQ, 0);\n+                qb.and(qb.entity().getUpdatedOn(), SearchCriteria.Op.GT, afterThis);\n+                quotaBalanceEntries = search(qb.create(), filter);\n+                return quotaBalanceEntries.size() > 0 ? quotaBalanceEntries.get(0) : null;\n+            }\n+        });\n+    }\n+\n+    public QuotaBalanceVO saveQuotaBalance(final QuotaBalanceVO qb) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaBalanceVO>() {\n+            @Override\n+            public QuotaBalanceVO doInTransaction(final TransactionStatus status) {\n+                return persist(qb);\n+            }\n+        });\n+    }\n+\n+    public List<QuotaBalanceVO> findCreditBalance(final Long accountId, final Long domainId, final Date lastbalancedate, final Date beforeThis) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaBalanceVO>>() {\n+            @Override\n+            public List<QuotaBalanceVO> doInTransaction(final TransactionStatus status) {\n+                if ((lastbalancedate != null) && (beforeThis != null) && lastbalancedate.before(beforeThis)) {\n+                    Filter filter = new Filter(QuotaBalanceVO.class, \"updatedOn\", true, 0L, Long.MAX_VALUE);\n+                    QueryBuilder<QuotaBalanceVO> qb = QueryBuilder.create(QuotaBalanceVO.class);\n+                    qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                    qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                    qb.and(qb.entity().getCreditsId(), SearchCriteria.Op.GT, 0);\n+                    qb.and(qb.entity().getUpdatedOn(), SearchCriteria.Op.BETWEEN, lastbalancedate, beforeThis);\n+                    return search(qb.create(), filter);\n+                } else {\n+                    return new ArrayList<QuotaBalanceVO>();\n+                }\n+            }\n+        });\n+    }\n+\n+    public List<QuotaBalanceVO> findQuotaBalance(final Long accountId, final Long domainId, final Date startDate, final Date endDate) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaBalanceVO>>() {\n+            @Override\n+            public List<QuotaBalanceVO> doInTransaction(final TransactionStatus status) {\n+                List<QuotaBalanceVO> quotaUsageRecords = null;\n+                QueryBuilder<QuotaBalanceVO> qb = QueryBuilder.create(QuotaBalanceVO.class);\n+                if (accountId != null) {\n+                    qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                }\n+                if (domainId != null) {\n+                    qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                }\n+                if ((startDate != null) && (endDate != null) && startDate.before(endDate)) {\n+                    qb.and(qb.entity().getUpdatedOn(), SearchCriteria.Op.BETWEEN, startDate, endDate);\n+                } else {\n+                    return Collections.<QuotaBalanceVO> emptyList();\n+                }\n+                quotaUsageRecords = listBy(qb.create());\n+                if (quotaUsageRecords.size() == 0) {\n+                    quotaUsageRecords.addAll(lastQuotaBalanceVO(accountId, domainId, startDate));\n+                }\n+                return quotaUsageRecords;\n+\n+            }\n+        });\n+\n+    }\n+\n+    public List<QuotaBalanceVO> lastQuotaBalanceVO(final Long accountId, final Long domainId, final Date pivotDate) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaBalanceVO>>() {\n+            @Override\n+            public List<QuotaBalanceVO> doInTransaction(final TransactionStatus status) {\n+                List<QuotaBalanceVO> quotaUsageRecords = null;\n+                List<QuotaBalanceVO> trimmedRecords = new ArrayList<QuotaBalanceVO>();\n+                Filter filter = new Filter(QuotaBalanceVO.class, \"updatedOn\", false, 0L, 100L);\n+                // ASSUMPTION there will be less than 100 continuous credit\n+                // transactions\n+                QueryBuilder<QuotaBalanceVO> qb = QueryBuilder.create(QuotaBalanceVO.class);\n+                if (accountId != null) {\n+                    qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                }\n+                if (domainId != null) {\n+                    qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                }\n+                if ((pivotDate != null)) {\n+                    qb.and(qb.entity().getUpdatedOn(), SearchCriteria.Op.LTEQ, pivotDate);\n+                }\n+                quotaUsageRecords = search(qb.create(), filter);\n+\n+                // get records before startDate to find start balance\n+                for (QuotaBalanceVO entry : quotaUsageRecords) {\n+                    if (s_logger.isDebugEnabled()) {\n+                        s_logger.debug(\"FindQuotaBalIance Entry=\" + entry);\n+                    }\n+                    if (entry.getCreditsId() > 0) {\n+                        trimmedRecords.add(entry);\n+                    } else {\n+                        trimmedRecords.add(entry);\n+                        break; // add only consecutive credit entries and last balance entry\n+                    }\n+                }\n+                return trimmedRecords;\n+            }\n+        });\n+    }\n+\n+    public BigDecimal lastQuotaBalance(final Long accountId, final Long domainId, Date startDate) {\n+        List<QuotaBalanceVO> quotaBalance = lastQuotaBalanceVO(accountId, domainId, startDate);\n+        BigDecimal finalBalance = new BigDecimal(0);\n+        if (quotaBalance.isEmpty()) {\n+            s_logger.info(\"There are no balance entries on or before the requested date.\");\n+            return finalBalance;\n+        }\n+        for (QuotaBalanceVO entry : quotaBalance) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"lastQuotaBalance Entry=\" + entry);\n+            }\n+            finalBalance = finalBalance.add(entry.getCreditBalance());\n+        }\n+        return finalBalance;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaBalanceDaoImpl.java",
                "sha": "aa650e165adbdb61f86fcc0c025544272e47fb42",
                "status": "added"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDao.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDao.java",
                "patch": "@@ -0,0 +1,32 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.util.Date;\n+import java.util.List;\n+\n+import org.apache.cloudstack.quota.vo.QuotaCreditsVO;\n+\n+import com.cloud.utils.db.GenericDao;\n+\n+public interface QuotaCreditsDao extends GenericDao<QuotaCreditsVO, Long> {\n+\n+    List<QuotaCreditsVO> findCredits(long accountId, long domainId, Date startDate, Date endDate);\n+\n+    QuotaCreditsVO saveCredits(QuotaCreditsVO credits);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDao.java",
                "sha": "f08d8f96ca85bcb63a5ccce180bb4363fee33bcc",
                "status": "added"
            },
            {
                "additions": 78,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDaoImpl.java",
                "changes": 78,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDaoImpl.java",
                "patch": "@@ -0,0 +1,78 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaCreditsVO;\n+\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.QueryBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+\n+@Component\n+@Local(value = { QuotaCreditsDao.class })\n+public class QuotaCreditsDaoImpl extends GenericDaoBase<QuotaCreditsVO, Long> implements QuotaCreditsDao {\n+\n+    @Inject\n+    QuotaBalanceDao _quotaBalanceDao;\n+\n+    @Override\n+    public List<QuotaCreditsVO> findCredits(final long accountId, final long domainId, final Date startDate, final Date endDate) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaCreditsVO>>() {\n+            @Override\n+            public List<QuotaCreditsVO> doInTransaction(final TransactionStatus status) {\n+                if ((startDate != null) && (endDate != null) && startDate.before(endDate)) {\n+                    Filter filter = new Filter(QuotaCreditsVO.class, \"updatedOn\", true, 0L, Long.MAX_VALUE);\n+                    QueryBuilder<QuotaCreditsVO> qb = QueryBuilder.create(QuotaCreditsVO.class);\n+                    qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                    qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                    qb.and(qb.entity().getUpdatedOn(), SearchCriteria.Op.BETWEEN, startDate, endDate);\n+                    return search(qb.create(), filter);\n+                } else {\n+                    return Collections.<QuotaCreditsVO> emptyList();\n+                }\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public QuotaCreditsVO saveCredits(final QuotaCreditsVO credits) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaCreditsVO>() {\n+            @Override\n+            public QuotaCreditsVO doInTransaction(final TransactionStatus status) {\n+                persist(credits);\n+                // make an entry in the balance table\n+                QuotaBalanceVO bal = new QuotaBalanceVO(credits);\n+                _quotaBalanceDao.persist(bal);\n+                return credits;\n+            }\n+        });\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaCreditsDaoImpl.java",
                "sha": "4b777104145f9b2d246b0c87beb69bc5f2a26f80",
                "status": "added"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDao.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDao.java",
                "patch": "@@ -0,0 +1,27 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.GenericDao;\n+import org.apache.cloudstack.quota.vo.QuotaEmailTemplatesVO;\n+\n+import java.util.List;\n+\n+public interface QuotaEmailTemplatesDao extends GenericDao<QuotaEmailTemplatesVO, Long> {\n+    List<QuotaEmailTemplatesVO> listAllQuotaEmailTemplates(String templateName);\n+    boolean updateQuotaEmailTemplate(QuotaEmailTemplatesVO template);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDao.java",
                "sha": "573a75397442bf2deb16d62a85995748c8291fdb",
                "status": "added"
            },
            {
                "additions": 74,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDaoImpl.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDaoImpl.java",
                "patch": "@@ -0,0 +1,74 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+import com.google.common.base.Strings;\n+\n+import org.apache.cloudstack.quota.vo.QuotaEmailTemplatesVO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+\n+import java.util.List;\n+\n+@Component\n+@Local(value = { QuotaEmailTemplatesDao.class })\n+public class QuotaEmailTemplatesDaoImpl extends GenericDaoBase<QuotaEmailTemplatesVO, Long> implements QuotaEmailTemplatesDao {\n+    private static final Logger s_logger = Logger.getLogger(QuotaEmailTemplatesDaoImpl.class);\n+\n+    protected SearchBuilder<QuotaEmailTemplatesVO> QuotaEmailTemplateSearch;\n+\n+    public QuotaEmailTemplatesDaoImpl() {\n+        super();\n+\n+        QuotaEmailTemplateSearch = createSearchBuilder();\n+        QuotaEmailTemplateSearch.and(\"template_name\", QuotaEmailTemplateSearch.entity().getTemplateName(), SearchCriteria.Op.EQ);\n+        QuotaEmailTemplateSearch.done();\n+    }\n+\n+    @Override\n+    public List<QuotaEmailTemplatesVO> listAllQuotaEmailTemplates(final String templateName) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaEmailTemplatesVO>>() {\n+            @Override\n+            public List<QuotaEmailTemplatesVO> doInTransaction(final TransactionStatus status) {\n+                SearchCriteria<QuotaEmailTemplatesVO> sc = QuotaEmailTemplateSearch.create();\n+                if (!Strings.isNullOrEmpty(templateName)) {\n+                    sc.setParameters(\"template_name\", templateName);\n+                }\n+                return listBy(sc);\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public boolean updateQuotaEmailTemplate(final QuotaEmailTemplatesVO template) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<Boolean>() {\n+            @Override\n+            public Boolean doInTransaction(final TransactionStatus status) {\n+                return update(template.getId(), template);\n+            }\n+        });\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaEmailTemplatesDaoImpl.java",
                "sha": "a971603c577537a341b7005648cb6986314f4357",
                "status": "added"
            },
            {
                "additions": 37,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDao.java",
                "changes": 37,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDao.java",
                "patch": "@@ -0,0 +1,37 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.GenericDao;\n+\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+\n+import java.util.Date;\n+import java.util.List;\n+\n+public interface QuotaTariffDao extends GenericDao<QuotaTariffVO, Long> {\n+\n+    QuotaTariffVO findTariffPlanByUsageType(int quotaType, Date onOrBefore);\n+\n+    List<QuotaTariffVO> listAllTariffPlans();\n+\n+    List<QuotaTariffVO> listAllTariffPlans(Date onOrBefore);\n+\n+    Boolean updateQuotaTariff(QuotaTariffVO plan);\n+\n+    QuotaTariffVO addQuotaTariff(QuotaTariffVO plan);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDao.java",
                "sha": "fda2cf67cafaf4b747bf42e9911506cdd49e4921",
                "status": "added"
            },
            {
                "additions": 133,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDaoImpl.java",
                "changes": 133,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDaoImpl.java",
                "patch": "@@ -0,0 +1,133 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@Component\n+@Local(value = {QuotaTariffDao.class})\n+public class QuotaTariffDaoImpl extends GenericDaoBase<QuotaTariffVO, Long> implements QuotaTariffDao {\n+    private static final Logger s_logger = Logger.getLogger(QuotaTariffDaoImpl.class.getName());\n+\n+    private final SearchBuilder<QuotaTariffVO> searchUsageType;\n+    private final SearchBuilder<QuotaTariffVO> listAllIncludedUsageType;\n+\n+    public QuotaTariffDaoImpl() {\n+        super();\n+        searchUsageType = createSearchBuilder();\n+        searchUsageType.and(\"usage_type\", searchUsageType.entity().getUsageType(), SearchCriteria.Op.EQ);\n+        searchUsageType.done();\n+\n+        listAllIncludedUsageType = createSearchBuilder();\n+        listAllIncludedUsageType.and(\"onorbefore\", listAllIncludedUsageType.entity().getEffectiveOn(), SearchCriteria.Op.LTEQ);\n+        listAllIncludedUsageType.and(\"quotatype\", listAllIncludedUsageType.entity().getUsageType(), SearchCriteria.Op.EQ);\n+        listAllIncludedUsageType.done();\n+    }\n+\n+    public QuotaTariffVO findTariffPlanByUsageType(final int quotaType, final Date effectiveDate) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaTariffVO>() {\n+            @Override\n+            public QuotaTariffVO doInTransaction(final TransactionStatus status) {\n+                List<QuotaTariffVO> result = new ArrayList<>();\n+                final Filter filter = new Filter(QuotaTariffVO.class, \"updatedOn\", false, 0L, 1L);\n+                final SearchCriteria<QuotaTariffVO> sc = listAllIncludedUsageType.create();\n+                sc.setParameters(\"onorbefore\", effectiveDate);\n+                sc.setParameters(\"quotatype\", quotaType);\n+                result = search(sc, filter);\n+                if (result != null && !result.isEmpty()) {\n+                    return result.get(0);\n+                } else {\n+                    if (s_logger.isDebugEnabled()) {\n+                        s_logger.debug(\"QuotaTariffDaoImpl::findTariffPlanByUsageType: Missing quota type \" + quotaType);\n+                    }\n+                    return null;\n+                }\n+            }\n+        });\n+    }\n+\n+    public List<QuotaTariffVO> listAllTariffPlans() {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaTariffVO>>() {\n+            @Override\n+            public List<QuotaTariffVO> doInTransaction(final TransactionStatus status) {\n+                return listAll();\n+            }\n+        });\n+    }\n+\n+    public List<QuotaTariffVO> listAllTariffPlans(final Date effectiveDate) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaTariffVO>>() {\n+            @Override\n+            public List<QuotaTariffVO> doInTransaction(final TransactionStatus status) {\n+                List<QuotaTariffVO> tariffs = new ArrayList<QuotaTariffVO>();\n+                final Filter filter = new Filter(QuotaTariffVO.class, \"updatedOn\", false, 0L, 1L);\n+                final SearchCriteria<QuotaTariffVO> sc = listAllIncludedUsageType.create();\n+                sc.setParameters(\"onorbefore\", effectiveDate);\n+                for (Integer quotaType : QuotaTypes.listQuotaTypes().keySet()) {\n+                    sc.setParameters(\"quotatype\", quotaType);\n+                    List<QuotaTariffVO> result = search(sc, filter);\n+                    if (result != null && !result.isEmpty()) {\n+                        tariffs.add(result.get(0));\n+                        if (s_logger.isDebugEnabled()) {\n+                            s_logger.debug(\"ListAllTariffPlans on or before \" + effectiveDate + \" quota type \" + result.get(0).getDescription() + \" , effective Date=\"\n+                                    + result.get(0).getEffectiveOn() + \" val=\" + result.get(0).getCurrencyValue());\n+                        }\n+                    }\n+                }\n+                return tariffs;\n+            }\n+        });\n+    }\n+\n+    public Boolean updateQuotaTariff(final QuotaTariffVO plan) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<Boolean>() {\n+            @Override\n+            public Boolean doInTransaction(final TransactionStatus status) {\n+                return update(plan.getId(), plan);\n+            }\n+        });\n+    }\n+\n+    public QuotaTariffVO addQuotaTariff(final QuotaTariffVO plan) {\n+        if (plan.getIdObj() != null) {\n+            throw new IllegalStateException(\"The QuotaTariffVO being added should not have an Id set \");\n+        }\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaTariffVO>() {\n+            @Override\n+            public QuotaTariffVO doInTransaction(final TransactionStatus status) {\n+                return persist(plan);\n+            }\n+        });\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaTariffDaoImpl.java",
                "sha": "294b404d928968fe010528d88f974cc2dd19dca7",
                "status": "added"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDao.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDao.java",
                "patch": "@@ -0,0 +1,35 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.GenericDao;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+import java.util.List;\n+\n+public interface QuotaUsageDao extends GenericDao<QuotaUsageVO, Long> {\n+\n+    QuotaUsageVO persistQuotaUsage(QuotaUsageVO quotaUsage);\n+\n+    List<QuotaUsageVO> findQuotaUsage(Long accountId, Long domainId, Integer usageType, Date startDate, Date endDate);\n+\n+    BigDecimal findTotalQuotaUsage(Long accountId, Long domainId, Integer usageType, Date startDate, Date endDate);\n+\n+    QuotaUsageVO findLastQuotaUsageEntry(Long accountId, Long domainId, Date beforeThis);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDao.java",
                "sha": "d0c984c6f6b6c051e6e4c26c5ee976f2ece9e0ed",
                "status": "added"
            },
            {
                "additions": 116,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDaoImpl.java",
                "changes": 116,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDaoImpl.java",
                "patch": "@@ -0,0 +1,116 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import com.cloud.utils.db.Filter;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.QueryBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@Component\n+@Local(value = {QuotaUsageDao.class})\n+public class QuotaUsageDaoImpl extends GenericDaoBase<QuotaUsageVO, Long> implements QuotaUsageDao {\n+    private static final Logger s_logger = Logger.getLogger(QuotaUsageDaoImpl.class);\n+\n+    public BigDecimal findTotalQuotaUsage(final Long accountId, final Long domainId, final Integer usageType, final Date startDate, final Date endDate) {\n+        List<QuotaUsageVO> quotaUsage = findQuotaUsage(accountId, domainId, null, startDate, endDate);\n+        BigDecimal total = new BigDecimal(0);\n+        for (QuotaUsageVO quotaRecord : quotaUsage) {\n+            total = total.add(quotaRecord.getQuotaUsed());\n+        }\n+        return total;\n+    }\n+\n+    public List<QuotaUsageVO> findQuotaUsage(final Long accountId, final Long domainId, final Integer usageType, final Date startDate, final Date endDate) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<List<QuotaUsageVO>>() {\n+            @Override\n+            public List<QuotaUsageVO> doInTransaction(final TransactionStatus status) {\n+                List<QuotaUsageVO> quv;\n+                if ((startDate != null) && (endDate != null) && startDate.before(endDate)) {\n+                    QueryBuilder<QuotaUsageVO> qb = QueryBuilder.create(QuotaUsageVO.class);\n+                    if (accountId != null) {\n+                        qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                    }\n+                    if (domainId != null) {\n+                        qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                    }\n+                    if (usageType != null) {\n+                        qb.and(qb.entity().getUsageType(), SearchCriteria.Op.EQ, usageType);\n+                    }\n+                    qb.and(qb.entity().getStartDate(), SearchCriteria.Op.BETWEEN, startDate, endDate);\n+                    qb.and(qb.entity().getEndDate(), SearchCriteria.Op.BETWEEN, startDate, endDate);\n+                    quv = listBy(qb.create());\n+                } else {\n+                    quv = new ArrayList<QuotaUsageVO>();\n+                }\n+                if (quv.isEmpty()){\n+                    //add a dummy entry\n+                    QuotaUsageVO qu = new  QuotaUsageVO();\n+                    qu.setAccountId(accountId);\n+                    qu.setDomainId(domainId);\n+                    qu.setStartDate(startDate);\n+                    qu.setEndDate(endDate);\n+                    qu.setQuotaUsed(new BigDecimal(0));\n+                    qu.setUsageType(-1);\n+                    quv.add(qu);\n+                }\n+                return quv;\n+            }\n+        });\n+    }\n+\n+    public QuotaUsageVO findLastQuotaUsageEntry(final Long accountId, final Long domainId, final Date beforeThis) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaUsageVO>() {\n+            @Override\n+            public QuotaUsageVO doInTransaction(final TransactionStatus status) {\n+                List<QuotaUsageVO> quotaUsageEntries = new ArrayList<>();\n+                Filter filter = new Filter(QuotaUsageVO.class, \"startDate\", false, 0L, 1L);\n+                QueryBuilder<QuotaUsageVO> qb = QueryBuilder.create(QuotaUsageVO.class);\n+                qb.and(qb.entity().getAccountId(), SearchCriteria.Op.EQ, accountId);\n+                qb.and(qb.entity().getDomainId(), SearchCriteria.Op.EQ, domainId);\n+                qb.and(qb.entity().getStartDate(), SearchCriteria.Op.LT, beforeThis);\n+                quotaUsageEntries = search(qb.create(), filter);\n+                return !quotaUsageEntries.isEmpty() ? quotaUsageEntries.get(0) : null;\n+            }\n+        });\n+    }\n+\n+    public QuotaUsageVO persistQuotaUsage(final QuotaUsageVO quotaUsage) {\n+        return Transaction.execute(TransactionLegacy.USAGE_DB, new TransactionCallback<QuotaUsageVO>() {\n+            @Override\n+            public QuotaUsageVO doInTransaction(final TransactionStatus status) {\n+                return persist(quotaUsage);\n+            }\n+        });\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/QuotaUsageDaoImpl.java",
                "sha": "8c0fae6391e110a763bd17bbc95a97362b20236b",
                "status": "added"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDao.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDao.java",
                "patch": "@@ -0,0 +1,25 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import org.apache.cloudstack.quota.vo.ServiceOfferingVO;\n+\n+import com.cloud.utils.db.GenericDao;\n+\n+public interface ServiceOfferingDao extends GenericDao<ServiceOfferingVO, Long> {\n+    ServiceOfferingVO findServiceOffering(Long vmId, long serviceOfferingId);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDao.java",
                "sha": "8353977aa0d8fc8d1b7c788ce6bfd05950398fd1",
                "status": "added"
            },
            {
                "additions": 84,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDaoImpl.java",
                "changes": 84,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDaoImpl.java",
                "patch": "@@ -0,0 +1,84 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.util.Map;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+import org.apache.cloudstack.quota.vo.ServiceOfferingVO;\n+\n+import com.cloud.event.UsageEventVO;\n+import com.cloud.utils.db.DB;\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionLegacy;\n+import com.cloud.utils.db.TransactionStatus;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+\n+@Component\n+@Local(value = {ServiceOfferingDao.class})\n+@DB()\n+public class ServiceOfferingDaoImpl extends GenericDaoBase<ServiceOfferingVO, Long> implements ServiceOfferingDao {\n+    protected static final Logger s_logger = Logger.getLogger(ServiceOfferingDaoImpl.class);\n+\n+    @Inject\n+    UserVmDetailsDao userVmDetailsDao;\n+\n+    public ServiceOfferingVO findServiceOffering(final Long vmId, final long serviceOfferingId) {\n+        return Transaction.execute(TransactionLegacy.CLOUD_DB, new TransactionCallback<ServiceOfferingVO>() {\n+            @Override\n+            public ServiceOfferingVO doInTransaction(final TransactionStatus status) {\n+                ServiceOfferingVO offering = findById(serviceOfferingId);\n+                if (offering.isDynamic()) {\n+                    if (vmId == null) {\n+                        throw new CloudRuntimeException(\"missing argument vmId\");\n+                    }\n+                    offering.setDynamicFlag(true);\n+                    Map<String, String> dynamicOffering = userVmDetailsDao.listDetailsKeyPairs(vmId);\n+                    return getcomputeOffering(offering, dynamicOffering);\n+                }\n+                return offering;\n+            }\n+        });\n+    }\n+\n+    private ServiceOfferingVO getcomputeOffering(final ServiceOfferingVO serviceOffering, final Map<String, String> customParameters) {\n+        return Transaction.execute(TransactionLegacy.CLOUD_DB, new TransactionCallback<ServiceOfferingVO>() {\n+            @Override\n+            public ServiceOfferingVO doInTransaction(final TransactionStatus status) {\n+                ServiceOfferingVO dummyoffering = new ServiceOfferingVO(serviceOffering);\n+                dummyoffering.setDynamicFlag(true);\n+                if (customParameters.containsKey(UsageEventVO.DynamicParameters.cpuNumber.name())) {\n+                    dummyoffering.setCpu(Integer.parseInt(customParameters.get(UsageEventVO.DynamicParameters.cpuNumber.name())));\n+                }\n+                if (customParameters.containsKey(UsageEventVO.DynamicParameters.cpuSpeed.name())) {\n+                    dummyoffering.setSpeed(Integer.parseInt(customParameters.get(UsageEventVO.DynamicParameters.cpuSpeed.name())));\n+                }\n+                if (customParameters.containsKey(UsageEventVO.DynamicParameters.memory.name())) {\n+                    dummyoffering.setRamSize(Integer.parseInt(customParameters.get(UsageEventVO.DynamicParameters.memory.name())));\n+                }\n+                return dummyoffering;\n+            }\n+        });\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/ServiceOfferingDaoImpl.java",
                "sha": "1d8b1b6b648e4a573fc906bc65d028e4f846e49d",
                "status": "added"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDao.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDao.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDao.java",
                "patch": "@@ -0,0 +1,27 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.util.Map;\n+\n+import com.cloud.utils.db.GenericDao;\n+\n+import org.apache.cloudstack.quota.vo.UserVmDetailVO;\n+\n+public interface UserVmDetailsDao extends GenericDao<UserVmDetailVO, Long> {\n+    Map<String, String> listDetailsKeyPairs(long resourceId);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDao.java",
                "sha": "f8ab3b9dbc46e8c061ea5a7ddc5730fbff06caa4",
                "status": "added"
            },
            {
                "additions": 59,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDaoImpl.java",
                "changes": 59,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDaoImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDaoImpl.java",
                "patch": "@@ -0,0 +1,59 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota.dao;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.ejb.Local;\n+\n+import org.springframework.stereotype.Component;\n+import org.apache.cloudstack.quota.vo.UserVmDetailVO;\n+\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+\n+@Component\n+@Local(value = UserVmDetailsDao.class)\n+public class UserVmDetailsDaoImpl extends GenericDaoBase<UserVmDetailVO, Long> implements UserVmDetailsDao {\n+    private SearchBuilder<UserVmDetailVO> AllFieldsSearch;\n+\n+    public UserVmDetailsDaoImpl() {\n+        AllFieldsSearch = createSearchBuilder();\n+        AllFieldsSearch.and(\"resourceId\", AllFieldsSearch.entity().getResourceId(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.and(\"name\", AllFieldsSearch.entity().getName(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.and(\"value\", AllFieldsSearch.entity().getValue(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.and(\"display\", AllFieldsSearch.entity().isDisplay(), SearchCriteria.Op.EQ);\n+        AllFieldsSearch.done();\n+    }\n+\n+    @Override\n+    public Map<String, String> listDetailsKeyPairs(long resourceId) {\n+        Map<String, String> details = new HashMap<String, String>();\n+        SearchCriteria<UserVmDetailVO> sc = AllFieldsSearch.create();\n+        sc.setParameters(\"resourceId\", resourceId);\n+\n+        List<UserVmDetailVO> results = search(sc, null);\n+        for (UserVmDetailVO result : results) {\n+            details.put(result.getName(), result.getValue());\n+        }\n+        return details;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/dao/UserVmDetailsDaoImpl.java",
                "sha": "beb3cdfbcb1fbf641b7dcf755aca1a28761d6191",
                "status": "added"
            },
            {
                "additions": 149,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaAccountVO.java",
                "changes": 149,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaAccountVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/QuotaAccountVO.java",
                "patch": "@@ -0,0 +1,149 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import javax.persistence.Temporal;\n+import javax.persistence.TemporalType;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+@Entity\n+@Table(name = \"quota_account\")\n+public class QuotaAccountVO implements InternalIdentity {\n+\n+    private static final long serialVersionUID = -7112846845287653210L;\n+\n+    @Id\n+    @Column(name = \"account_id\")\n+    private Long accountId = null;\n+\n+    @Column(name = \"quota_enforce\")\n+    private Integer quotaEnforce = 0;\n+\n+    @Column(name = \"quota_balance\")\n+    private BigDecimal quotaBalance;\n+\n+    @Column(name = \"quota_balance_date\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date quotaBalanceDate = null;\n+\n+    @Column(name = \"quota_min_balance\")\n+    private BigDecimal quotaMinBalance;\n+\n+    @Column(name = \"quota_alert_type\")\n+    private Integer quotaAlertType = null;\n+\n+    @Column(name = \"quota_alert_date\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date quotaAlertDate = null;\n+\n+    @Column(name = \"last_statement_date\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date lastStatementDate = null;\n+\n+    public QuotaAccountVO() {\n+    }\n+\n+    public QuotaAccountVO(Long accountId) {\n+        super();\n+        this.accountId = accountId;\n+    }\n+\n+    @Override\n+    public long getId() {\n+        return accountId;\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public Integer getQuotaEnforce() {\n+        return quotaEnforce == null ? 0 : quotaEnforce;\n+    }\n+\n+    public void setQuotaEnforce(Integer quotaEnforce) {\n+        this.quotaEnforce = quotaEnforce;\n+    }\n+\n+    public BigDecimal getQuotaBalance() {\n+        return quotaBalance;\n+    }\n+\n+    public void setQuotaBalance(BigDecimal quotaBalance) {\n+        this.quotaBalance = quotaBalance;\n+    }\n+\n+    public BigDecimal getQuotaMinBalance() {\n+        return quotaMinBalance == null ? new BigDecimal(0) : quotaMinBalance;\n+    }\n+\n+    public void setQuotaMinBalance(BigDecimal quotaMinBalance) {\n+        this.quotaMinBalance = quotaMinBalance;\n+    }\n+\n+    public Integer getQuotaAlertType() {\n+        return quotaAlertType;\n+    }\n+\n+    public void setQuotaAlertType(Integer quotaAlertType) {\n+        this.quotaAlertType = quotaAlertType;\n+    }\n+\n+    public Date getQuotaAlertDate() {\n+        return quotaAlertDate == null ? null : new Date(quotaAlertDate.getTime());\n+    }\n+\n+    public void setQuotaAlertDate(Date quotaAlertDate) {\n+        this.quotaAlertDate = quotaAlertDate == null ? null : new Date(quotaAlertDate.getTime());\n+    }\n+\n+    public Date getQuotaBalanceDate() {\n+        return quotaBalanceDate  == null ? null : new Date(quotaBalanceDate.getTime());\n+    }\n+\n+    public void setQuotaBalanceDate(Date quotaBalanceDate) {\n+        this.quotaBalanceDate = quotaBalanceDate == null ? null : new Date(quotaBalanceDate.getTime());\n+    }\n+\n+    public Date getLastStatementDate() {\n+        return lastStatementDate  == null ? null : new Date(lastStatementDate.getTime());\n+    }\n+\n+    public void setLastStatementDate(Date lastStatementDate) {\n+        this.lastStatementDate = lastStatementDate  == null ? null : new Date(lastStatementDate.getTime());\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"QuotaAccountVO [accountId=\" + accountId + \", quotaEnforce=\" + quotaEnforce + \", quotaBalance=\" + quotaBalance + \", quotaBalanceDate=\" + quotaBalanceDate\n+                + \", quotaMinBalance=\" + quotaMinBalance + \", quotaAlertType=\" + quotaAlertType + \", quotaAlertDate=\" + quotaAlertDate + \", lastStatementDate=\" + lastStatementDate\n+                + \"]\";\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaAccountVO.java",
                "sha": "00bc33a98dc8c4400b663a98b732db127a3edeba",
                "status": "added"
            },
            {
                "additions": 133,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaBalanceVO.java",
                "changes": 133,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaBalanceVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/QuotaBalanceVO.java",
                "patch": "@@ -0,0 +1,133 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import javax.persistence.Temporal;\n+import javax.persistence.TemporalType;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+@Entity\n+@Table(name = \"quota_balance\")\n+public class QuotaBalanceVO implements InternalIdentity {\n+\n+    private static final long serialVersionUID = -7112846845287653210L;\n+\n+    @Id\n+    @Column(name = \"id\")\n+    private Long id;\n+\n+    @Column(name = \"account_id\")\n+    private Long accountId = null;\n+\n+    @Column(name = \"domain_id\")\n+    private Long domainId = null;\n+\n+    @Column(name = \"credit_balance\")\n+    private BigDecimal creditBalance;\n+\n+    @Column(name = \"credits_id\")\n+    private Long creditsId;\n+\n+    @Column(name = \"updated_on\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date updatedOn = null;\n+\n+    public QuotaBalanceVO() {\n+    }\n+\n+    public QuotaBalanceVO(final QuotaCreditsVO credit) {\n+        super();\n+        this.accountId = credit.getAccountId();\n+        this.domainId = credit.getDomainId();\n+        this.creditBalance = credit.getCredit();\n+        this.updatedOn = credit.getUpdatedOn()  == null ? null : new Date(credit.getUpdatedOn().getTime());\n+        this.creditsId = credit.getId();\n+    }\n+\n+    public QuotaBalanceVO(final Long accountId, final Long domainId, final BigDecimal creditBalance, final Date updatedOn) {\n+        super();\n+        this.accountId = accountId;\n+        this.domainId = domainId;\n+        this.creditBalance = creditBalance;\n+        this.creditsId = 0L;\n+        this.updatedOn = updatedOn  == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    @Override\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public void setId(Long id) {\n+        this.id = id;\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public Long getCreditsId() {\n+        return creditsId;\n+    }\n+\n+    public void setCreditsId(Long creditsId) {\n+        this.creditsId = creditsId;\n+    }\n+\n+    public BigDecimal getCreditBalance() {\n+        return creditBalance;\n+    }\n+\n+    public void setCreditBalance(BigDecimal creditBalance) {\n+        this.creditBalance = creditBalance;\n+    }\n+\n+    public Date getUpdatedOn() {\n+        return updatedOn == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    public void setUpdatedOn(Date updatedOn) {\n+        this.updatedOn =  updatedOn == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"QuotaBalanceVO [id=\" + id + \", accountId=\" + accountId + \", domainId=\" + domainId + \", creditBalance=\" + creditBalance + \", creditsId=\" + creditsId + \", updatedOn=\"\n+                + updatedOn + \"]\";\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaBalanceVO.java",
                "sha": "b454a14b925ac8b15765b88b1d9579d48384a126",
                "status": "added"
            },
            {
                "additions": 116,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaCreditsVO.java",
                "changes": 116,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaCreditsVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/QuotaCreditsVO.java",
                "patch": "@@ -0,0 +1,116 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import javax.persistence.Temporal;\n+import javax.persistence.TemporalType;\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+@Entity\n+@Table(name = \"quota_credits\")\n+public class QuotaCreditsVO implements InternalIdentity {\n+\n+    private static final long serialVersionUID = -3576833845287653210L;\n+\n+    @Id\n+    @Column(name = \"id\")\n+    private Long id;\n+\n+    @Column(name = \"account_id\")\n+    private Long accountId = null;\n+\n+    @Column(name = \"domain_id\")\n+    private Long domainId = null;\n+\n+    @Column(name = \"credit\")\n+    private BigDecimal credit;\n+\n+    @Column(name = \"updated_on\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date updatedOn = null;\n+\n+    public QuotaCreditsVO() {\n+    }\n+\n+    public QuotaCreditsVO(long accountId, long domainId, BigDecimal credit, long updatedBy) {\n+        super();\n+        this.accountId = accountId;\n+        this.domainId = domainId;\n+        this.credit = credit;\n+        this.updatedBy = updatedBy;\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public BigDecimal getCredit() {\n+        return credit;\n+    }\n+\n+    public void setCredit(BigDecimal credit) {\n+        this.credit = credit;\n+    }\n+\n+    public Date getUpdatedOn() {\n+        return updatedOn == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    public void setUpdatedOn(Date updatedOn) {\n+        this.updatedOn = updatedOn == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    public Long getUpdatedBy() {\n+        return updatedBy;\n+    }\n+\n+    public void setUpdatedBy(Long updatedBy) {\n+        this.updatedBy = updatedBy;\n+    }\n+\n+    public void setId(Long id) {\n+        this.id = id;\n+    }\n+\n+    // User ID of the creditor\n+    @Column(name = \"updated_by\")\n+    private Long updatedBy = null;\n+\n+    @Override\n+    public long getId() {\n+        return this.id;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaCreditsVO.java",
                "sha": "f9c7b45b8a49b7cea699fec7b022a2291373bb8b",
                "status": "added"
            },
            {
                "additions": 109,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaEmailTemplatesVO.java",
                "changes": 109,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaEmailTemplatesVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/QuotaEmailTemplatesVO.java",
                "patch": "@@ -0,0 +1,109 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import javax.persistence.Temporal;\n+import javax.persistence.TemporalType;\n+import java.util.Date;\n+\n+@Entity\n+@Table(name = \"quota_email_templates\")\n+public class QuotaEmailTemplatesVO implements InternalIdentity {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @Column(name = \"id\")\n+    private Long id;\n+\n+    @Column(name = \"template_name\")\n+    private String templateName;\n+\n+    @Column(name = \"template_subject\")\n+    private String templateSubject;\n+\n+    @Column(name = \"template_body\")\n+    private String templateBody;\n+\n+    @Column(name = \"locale\")\n+    private String locale;\n+\n+    @Column(name = \"updated\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date lastUpdated = null;\n+\n+    public QuotaEmailTemplatesVO() {\n+    }\n+\n+    public QuotaEmailTemplatesVO(String templateName, String templateSubject, String templateBody) {\n+        super();\n+        this.templateName = templateName;\n+        this.templateSubject = templateSubject;\n+        this.templateBody = templateBody;\n+    }\n+\n+    @Override\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public String getTemplateName() {\n+        return templateName;\n+    }\n+\n+    public void setTemplateName(String templateName) {\n+        this.templateName = templateName;\n+    }\n+\n+    public String getTemplateSubject() {\n+        return templateSubject;\n+    }\n+\n+    public void setTemplateSubject(String templateSubject) {\n+        this.templateSubject = templateSubject;\n+    }\n+\n+    public String getTemplateBody() {\n+        return templateBody;\n+    }\n+\n+    public void setTemplateBody(String templateBody) {\n+        this.templateBody = templateBody;\n+    }\n+\n+    public Date getLastUpdated() {\n+        return lastUpdated == null ? null : new Date(lastUpdated.getTime());\n+    }\n+\n+    public void setLastUpdated(Date lastUpdated) {\n+        this.lastUpdated = lastUpdated == null ? null : new Date(lastUpdated.getTime());\n+    }\n+\n+    public String getLocale() {\n+        return locale;\n+    }\n+\n+    public void setLocale(String locale) {\n+        this.locale = locale;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaEmailTemplatesVO.java",
                "sha": "1ad4b379b566be52bf7afe41195845abd279e9c6",
                "status": "added"
            },
            {
                "additions": 170,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaTariffVO.java",
                "changes": 170,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaTariffVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/QuotaTariffVO.java",
                "patch": "@@ -0,0 +1,170 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import javax.persistence.Temporal;\n+import javax.persistence.TemporalType;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+@Entity\n+@Table(name = \"quota_tariff\")\n+public class QuotaTariffVO implements InternalIdentity {\n+    private static final long serialVersionUID = -7117933766387653203L;\n+\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @Column(name = \"id\")\n+    private Long id;\n+\n+    @Column(name = \"usage_type\")\n+    private int usageType;\n+\n+    @Column(name = \"usage_name\")\n+    private String usageName;\n+\n+    @Column(name = \"usage_unit\")\n+    private String usageUnit;\n+\n+    @Column(name = \"usage_discriminator\")\n+    private String usageDiscriminator;\n+\n+    @Column(name = \"currency_value\")\n+    private BigDecimal currencyValue;\n+\n+    @Column(name = \"effective_on\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date effectiveOn = null;\n+\n+    @Column(name = \"updated_on\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date updatedOn = null;\n+\n+    @Column(name = \"updated_by\")\n+    private Long updatedBy = null;\n+\n+    public QuotaTariffVO() {\n+    }\n+\n+    public QuotaTariffVO(final int usagetype) {\n+        this.usageType = usagetype;\n+    }\n+\n+    public QuotaTariffVO(final int usagetype, final String usagename, final String usageunit, final String usagediscriminator, final BigDecimal currencyvalue,\n+            final Date effectiveOn, final Date updatedOn, final long updatedBy) {\n+        this.usageType = usagetype;\n+        this.usageName = usagename;\n+        this.usageUnit = usageunit;\n+        this.usageDiscriminator = usagediscriminator;\n+        this.currencyValue = currencyvalue;\n+        this.effectiveOn = effectiveOn;\n+        this.updatedOn = updatedOn == null ? null : new Date(updatedOn.getTime());\n+        this.updatedBy = updatedBy;\n+    }\n+\n+\n+    public void setId(Long id) {\n+        this.id = id;\n+    }\n+\n+    public Date getEffectiveOn() {\n+        return effectiveOn == null ? null : new Date(effectiveOn.getTime());\n+    }\n+\n+    public void setEffectiveOn(Date effectiveOn) {\n+        this.effectiveOn = effectiveOn == null ? null : new Date(effectiveOn.getTime());\n+    }\n+\n+    public Date getUpdatedOn() {\n+        return updatedOn == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    public void setUpdatedOn(Date updatedOn) {\n+        this.updatedOn = updatedOn == null ? null : new Date(updatedOn.getTime());\n+    }\n+\n+    public Long getUpdatedBy() {\n+        return updatedBy;\n+    }\n+\n+    public void setUpdatedBy(Long updatedBy) {\n+        this.updatedBy = updatedBy;\n+    }\n+\n+    public int getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public String getUsageName() {\n+        return usageName;\n+    }\n+\n+    public void setUsageName(String usageName) {\n+        this.usageName = usageName;\n+    }\n+\n+    public String getUsageUnit() {\n+        return usageUnit;\n+    }\n+\n+    public void setUsageUnit(String usageUnit) {\n+        this.usageUnit = usageUnit;\n+    }\n+\n+    public String getUsageDiscriminator() {\n+        return usageDiscriminator;\n+    }\n+\n+    public void setUsageDiscriminator(String usageDiscriminator) {\n+        this.usageDiscriminator = usageDiscriminator;\n+    }\n+\n+    public BigDecimal getCurrencyValue() {\n+        return currencyValue;\n+    }\n+\n+    public void setCurrencyValue(BigDecimal currencyValue) {\n+        this.currencyValue = currencyValue;\n+    }\n+\n+    public String getDescription() {\n+        return QuotaTypes.getDescription(usageType);\n+    }\n+\n+    public Long getIdObj(){\n+        return id;\n+    }\n+\n+    @Override\n+    public long getId() {\n+        return this.id;\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaTariffVO.java",
                "sha": "8450d09e1e5ebf5d59e82d7ff2cd32a2cf57e9dc",
                "status": "added"
            },
            {
                "additions": 177,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaUsageVO.java",
                "changes": 177,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaUsageVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/QuotaUsageVO.java",
                "patch": "@@ -0,0 +1,177 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+import javax.persistence.Temporal;\n+import javax.persistence.TemporalType;\n+\n+import org.apache.cloudstack.api.InternalIdentity;\n+\n+@Entity\n+@Table(name = \"quota_usage\")\n+public class QuotaUsageVO implements InternalIdentity {\n+\n+    private static final long serialVersionUID = -7117933845287204781L;\n+\n+    @Id\n+    @Column(name = \"id\")\n+    private Long id;\n+\n+    @Column(name = \"zone_id\")\n+    private Long zoneId = null;\n+\n+    @Column(name = \"account_id\")\n+    private Long accountId = null;\n+\n+    @Column(name = \"domain_id\")\n+    private Long domainId = null;\n+\n+    @Column(name = \"usage_item_id\")\n+    private Long usageItemId;\n+\n+    @Column(name = \"usage_type\")\n+    private int usageType;\n+\n+    @Column(name = \"quota_used\")\n+    private BigDecimal quotaUsed;\n+\n+    @Column(name = \"start_date\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date startDate = null;\n+\n+    @Column(name = \"end_date\")\n+    @Temporal(value = TemporalType.TIMESTAMP)\n+    private Date endDate = null;\n+\n+    public QuotaUsageVO() {\n+        usageType = -1;\n+        quotaUsed = new BigDecimal(0);\n+        endDate = new Date();\n+        startDate = new Date();\n+    }\n+\n+    public QuotaUsageVO(Long usageItemId, Long zoneId, Long accountId, Long domainId, int usageType, BigDecimal quotaUsed, Date startDate, Date endDate) {\n+        super();\n+        this.usageItemId = usageItemId;\n+        this.zoneId = zoneId;\n+        this.accountId = accountId;\n+        this.domainId = domainId;\n+        this.usageType = usageType;\n+        this.quotaUsed = quotaUsed;\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public QuotaUsageVO(QuotaUsageVO toclone) {\n+        super();\n+        this.usageItemId = toclone.usageItemId;\n+        this.zoneId = toclone.zoneId;\n+        this.accountId = toclone.accountId;\n+        this.domainId = toclone.domainId;\n+        this.usageType = toclone.usageType;\n+        this.quotaUsed = toclone.quotaUsed;\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public Long getZoneId() {\n+        return zoneId;\n+    }\n+\n+    public void setZoneId(Long zoneId) {\n+        this.zoneId = zoneId;\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    @Override\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public Long getUsageItemId() {\n+        return usageItemId;\n+    }\n+\n+    public void setUsageItemId(Long usageItemId) {\n+        this.usageItemId = usageItemId;\n+    }\n+\n+    public int getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public BigDecimal getQuotaUsed() {\n+        return quotaUsed;\n+    }\n+\n+    public void setQuotaUsed(BigDecimal quotaUsed) {\n+        this.quotaUsed = quotaUsed;\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public Date getEndDate() {\n+        return endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setId(Long id) {\n+        this.id = id;\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"QuotaUsageVO [id=\" + id + \", zoneId=\" + zoneId + \", accountId=\" + accountId + \", domainId=\" + domainId + \", usageItemId=\" + usageItemId + \", usageType=\" + usageType\n+                + \", quotaUsed=\" + quotaUsed + \", startDate=\" + startDate + \", endDate=\" + endDate + \"]\";\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/QuotaUsageVO.java",
                "sha": "2a26951237ea3dfd4bb4f397fe29a6b8417aba79",
                "status": "added"
            },
            {
                "additions": 336,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/ServiceOfferingVO.java",
                "changes": 336,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/ServiceOfferingVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/ServiceOfferingVO.java",
                "patch": "@@ -0,0 +1,336 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import java.util.Map;\n+\n+import javax.persistence.Column;\n+import javax.persistence.DiscriminatorValue;\n+import javax.persistence.Entity;\n+import javax.persistence.PrimaryKeyJoinColumn;\n+import javax.persistence.Table;\n+import javax.persistence.Transient;\n+\n+import com.cloud.offering.ServiceOffering;\n+import com.cloud.storage.DiskOfferingVO;\n+import com.cloud.storage.Storage.ProvisioningType;\n+import com.cloud.vm.VirtualMachine;\n+\n+@Entity\n+@Table(name = \"service_offering\")\n+@DiscriminatorValue(value = \"Service\")\n+@PrimaryKeyJoinColumn(name = \"id\")\n+public class ServiceOfferingVO extends DiskOfferingVO implements ServiceOffering {\n+    @Column(name = \"cpu\")\n+    private Integer cpu;\n+\n+    @Column(name = \"speed\")\n+    private Integer speed;\n+\n+    @Column(name = \"ram_size\")\n+    private Integer ramSize;\n+\n+    @Column(name = \"nw_rate\")\n+    private Integer rateMbps;\n+\n+    @Column(name = \"mc_rate\")\n+    private Integer multicastRateMbps;\n+\n+    @Column(name = \"ha_enabled\")\n+    private boolean offerHA;\n+\n+    @Column(name = \"limit_cpu_use\")\n+    private boolean limitCpuUse;\n+\n+    @Column(name = \"is_volatile\")\n+    private boolean volatileVm;\n+\n+    @Column(name = \"host_tag\")\n+    private String hostTag;\n+\n+    @Column(name = \"default_use\")\n+    private boolean defaultUse;\n+\n+    @Column(name = \"vm_type\")\n+    private String vmType;\n+\n+    @Column(name = \"sort_key\")\n+    int sortKey;\n+\n+    @Column(name = \"deployment_planner\")\n+    private String deploymentPlanner = null;\n+\n+    // This is a delayed load value.  If the value is null,\n+    // then this field has not been loaded yet.\n+    // Call service offering dao to load it.\n+    @Transient\n+    Map<String, String> details;\n+\n+    // This flag is required to tell if the offering is dynamic once the cpu, memory and speed are set.\n+    // In some cases cpu, memory and speed are set to non-null values even if the offering is dynamic.\n+    @Transient\n+    boolean isDynamic;\n+\n+    protected ServiceOfferingVO() {\n+        super();\n+    }\n+\n+    public ServiceOfferingVO(String name, Integer cpu, Integer ramSize, Integer speed, Integer rateMbps, Integer multicastRateMbps, boolean offerHA, String displayText,\n+                             ProvisioningType provisioningType, boolean useLocalStorage, boolean recreatable, String tags, boolean systemUse, VirtualMachine.Type vmType, boolean defaultUse) {\n+        super(name, displayText, provisioningType, false, tags, recreatable, useLocalStorage, systemUse, true);\n+        this.cpu = cpu;\n+        this.ramSize = ramSize;\n+        this.speed = speed;\n+        this.rateMbps = rateMbps;\n+        this.multicastRateMbps = multicastRateMbps;\n+        this.offerHA = offerHA;\n+        limitCpuUse = false;\n+        volatileVm = false;\n+        this.defaultUse = defaultUse;\n+        this.vmType = vmType == null ? null : vmType.toString().toLowerCase();\n+    }\n+\n+    public ServiceOfferingVO(String name, Integer cpu, Integer ramSize, Integer speed, Integer rateMbps, Integer multicastRateMbps, boolean offerHA, boolean limitCpuUse,\n+                             boolean volatileVm, String displayText, ProvisioningType provisioningType, boolean useLocalStorage, boolean recreatable, String tags, boolean systemUse, VirtualMachine.Type vmType, Long domainId) {\n+        super(name, displayText, provisioningType, false, tags, recreatable, useLocalStorage, systemUse, true, domainId);\n+        this.cpu = cpu;\n+        this.ramSize = ramSize;\n+        this.speed = speed;\n+        this.rateMbps = rateMbps;\n+        this.multicastRateMbps = multicastRateMbps;\n+        this.offerHA = offerHA;\n+        this.limitCpuUse = limitCpuUse;\n+        this.volatileVm = volatileVm;\n+        this.vmType = vmType == null ? null : vmType.toString().toLowerCase();\n+    }\n+\n+    public ServiceOfferingVO(String name, Integer cpu, Integer ramSize, Integer speed, Integer rateMbps, Integer multicastRateMbps, boolean offerHA,\n+                             boolean limitResourceUse, boolean volatileVm, String displayText, ProvisioningType provisioningType, boolean useLocalStorage, boolean recreatable, String tags, boolean systemUse,\n+                             VirtualMachine.Type vmType, Long domainId, String hostTag) {\n+        this(name,\n+                cpu,\n+                ramSize,\n+                speed,\n+                rateMbps,\n+                multicastRateMbps,\n+                offerHA,\n+                limitResourceUse,\n+                volatileVm,\n+                displayText,\n+                provisioningType,\n+                useLocalStorage,\n+                recreatable,\n+                tags,\n+                systemUse,\n+                vmType,\n+                domainId);\n+        this.hostTag = hostTag;\n+    }\n+\n+    public ServiceOfferingVO(String name, Integer cpu, Integer ramSize, Integer speed, Integer rateMbps, Integer multicastRateMbps, boolean offerHA,\n+                             boolean limitResourceUse, boolean volatileVm, String displayText, ProvisioningType provisioningType, boolean useLocalStorage, boolean recreatable, String tags, boolean systemUse,\n+                             VirtualMachine.Type vmType, Long domainId, String hostTag, String deploymentPlanner) {\n+        this(name,\n+                cpu,\n+                ramSize,\n+                speed,\n+                rateMbps,\n+                multicastRateMbps,\n+                offerHA,\n+                limitResourceUse,\n+                volatileVm,\n+                displayText,\n+                provisioningType,\n+                useLocalStorage,\n+                recreatable,\n+                tags,\n+                systemUse,\n+                vmType,\n+                domainId,\n+                hostTag);\n+        this.deploymentPlanner = deploymentPlanner;\n+    }\n+\n+    public ServiceOfferingVO(ServiceOfferingVO offering) {\n+        super(offering.getId(),\n+                offering.getName(),\n+                offering.getDisplayText(),\n+                offering.getProvisioningType(),\n+                false,\n+                offering.getTags(),\n+                offering.isRecreatable(),\n+                offering.getUseLocalStorage(),\n+                offering.getSystemUse(),\n+                true,\n+                offering.isCustomizedIops()== null ? false:offering.isCustomizedIops(),\n+                offering.getDomainId(),\n+                offering.getMinIops(),\n+                offering.getMaxIops());\n+        cpu = offering.getCpu();\n+        ramSize = offering.getRamSize();\n+        speed = offering.getSpeed();\n+        rateMbps = offering.getRateMbps();\n+        multicastRateMbps = offering.getMulticastRateMbps();\n+        offerHA = offering.getOfferHA();\n+        limitCpuUse = offering.getLimitCpuUse();\n+        volatileVm = offering.getVolatileVm();\n+        hostTag = offering.getHostTag();\n+        vmType = offering.getSystemVmType();\n+    }\n+\n+    @Override\n+    public boolean getOfferHA() {\n+        return offerHA;\n+    }\n+\n+    public void setOfferHA(boolean offerHA) {\n+        this.offerHA = offerHA;\n+    }\n+\n+    @Override\n+    public boolean getLimitCpuUse() {\n+        return limitCpuUse;\n+    }\n+\n+    public void setLimitResourceUse(boolean limitCpuUse) {\n+        this.limitCpuUse = limitCpuUse;\n+    }\n+\n+    @Override\n+    public boolean getDefaultUse() {\n+        return defaultUse;\n+    }\n+\n+    @Override\n+    @Transient\n+    public String[] getTagsArray() {\n+        String tags = getTags();\n+        if (tags == null || tags.length() == 0) {\n+            return new String[0];\n+        }\n+\n+        return tags.split(\",\");\n+    }\n+\n+    @Override\n+    public Integer getCpu() {\n+        return cpu;\n+    }\n+\n+    public void setCpu(int cpu) {\n+        this.cpu = cpu;\n+    }\n+\n+    public void setSpeed(int speed) {\n+        this.speed = speed;\n+    }\n+\n+    public void setRamSize(int ramSize) {\n+        this.ramSize = ramSize;\n+    }\n+\n+    @Override\n+    public Integer getSpeed() {\n+        return speed;\n+    }\n+\n+    @Override\n+    public Integer getRamSize() {\n+        return ramSize;\n+    }\n+\n+    public void setRateMbps(Integer rateMbps) {\n+        this.rateMbps = rateMbps;\n+    }\n+\n+    @Override\n+    public Integer getRateMbps() {\n+        return rateMbps;\n+    }\n+\n+    public void setMulticastRateMbps(Integer multicastRateMbps) {\n+        this.multicastRateMbps = multicastRateMbps;\n+    }\n+\n+    @Override\n+    public Integer getMulticastRateMbps() {\n+        return multicastRateMbps;\n+    }\n+\n+    public void setHostTag(String hostTag) {\n+        this.hostTag = hostTag;\n+    }\n+\n+    @Override\n+    public String getHostTag() {\n+        return hostTag;\n+    }\n+\n+    @Override\n+    public String getSystemVmType() {\n+        return vmType;\n+    }\n+\n+    @Override\n+    public void setSortKey(int key) {\n+        sortKey = key;\n+    }\n+\n+    @Override\n+    public int getSortKey() {\n+        return sortKey;\n+    }\n+\n+    @Override\n+    public boolean getVolatileVm() {\n+        return volatileVm;\n+    }\n+\n+    @Override\n+    public String getDeploymentPlanner() {\n+        return deploymentPlanner;\n+    }\n+\n+    public Map<String, String> getDetails() {\n+        return details;\n+    }\n+\n+    public String getDetail(String name) {\n+        assert (details != null) : \"Did you forget to load the details?\";\n+\n+        return details != null ? details.get(name) : null;\n+    }\n+\n+    public void setDetail(String name, String value) {\n+        assert (details != null) : \"Did you forget to load the details?\";\n+\n+        details.put(name, value);\n+    }\n+\n+    public void setDetails(Map<String, String> details) {\n+        this.details = details;\n+    }\n+\n+    @Override\n+    public boolean isDynamic() {\n+        return cpu == null || speed == null || ramSize == null || isDynamic;\n+    }\n+\n+    public void setDynamicFlag(boolean isdynamic) {\n+        isDynamic = isdynamic;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/ServiceOfferingVO.java",
                "sha": "2d11edda779bf57b0a0dccbf91a7a69f816ff3fd",
                "status": "added"
            },
            {
                "additions": 83,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/UserVmDetailVO.java",
                "changes": 83,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/vo/UserVmDetailVO.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/vo/UserVmDetailVO.java",
                "patch": "@@ -0,0 +1,83 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota.vo;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.Table;\n+\n+import org.apache.cloudstack.api.ResourceDetail;\n+\n+@Entity\n+@Table(name = \"user_vm_details\")\n+public class UserVmDetailVO implements ResourceDetail {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @Column(name = \"id\")\n+    private long id;\n+\n+    @Column(name = \"vm_id\")\n+    private long resourceId;\n+\n+    @Column(name = \"name\")\n+    private String name;\n+\n+    @Column(name = \"value\", length = 5120)\n+    private String value;\n+\n+    @Column(name = \"display\")\n+    private boolean display = true;\n+\n+    public UserVmDetailVO() {\n+    }\n+\n+    public UserVmDetailVO(long vmId, String name, String value, boolean display) {\n+        this.resourceId = vmId;\n+        this.name = name;\n+        this.value = value;\n+        this.display = display;\n+    }\n+\n+    @Override\n+    public long getId() {\n+        return id;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return name;\n+    }\n+\n+    @Override\n+    public String getValue() {\n+        return value;\n+    }\n+\n+    @Override\n+    public long getResourceId() {\n+        return resourceId;\n+    }\n+\n+    @Override\n+    public boolean isDisplay() {\n+        return display;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/src/org/apache/cloudstack/quota/vo/UserVmDetailVO.java",
                "sha": "21fcdbdb52a2e394f4097430ec5c31b1fbe78c54",
                "status": "added"
            },
            {
                "additions": 197,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/QuotaAlertManagerImplTest.java",
                "changes": 197,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/test/org/apache/cloudstack/quota/QuotaAlertManagerImplTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/test/org/apache/cloudstack/quota/QuotaAlertManagerImplTest.java",
                "patch": "@@ -0,0 +1,197 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.domain.DomainVO;\n+import com.cloud.domain.dao.DomainDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.UserVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.user.dao.UserDao;\n+import com.cloud.utils.db.TransactionLegacy;\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaEmailTemplatesDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaEmailTemplatesVO;\n+import org.joda.time.DateTime;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.Spy;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import javax.mail.MessagingException;\n+import javax.naming.ConfigurationException;\n+import java.io.UnsupportedEncodingException;\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaAlertManagerImplTest extends TestCase {\n+\n+    @Mock\n+    AccountDao accountDao;\n+    @Mock\n+    QuotaAccountDao quotaAcc;\n+    @Mock\n+    UserDao userDao;\n+    @Mock\n+    DomainDao domainDao;\n+    @Mock\n+    QuotaEmailTemplatesDao quotaEmailTemplateDao;\n+    @Mock\n+    ConfigurationDao configDao;\n+    @Mock\n+    QuotaUsageDao quotaUsage;\n+    @Mock\n+    QuotaAlertManagerImpl.EmailQuotaAlert emailQuotaAlert;\n+\n+    @Spy\n+    QuotaAlertManagerImpl quotaAlertManager = new QuotaAlertManagerImpl();\n+\n+    private void injectMockToField(Object mock, String fieldName) throws NoSuchFieldException, IllegalAccessException {\n+        Field f = QuotaAlertManagerImpl.class.getDeclaredField(fieldName);\n+        f.setAccessible(true);\n+        f.set(quotaAlertManager, mock);\n+    }\n+\n+    @Before\n+    public void setup() throws IllegalAccessException, NoSuchFieldException, ConfigurationException {\n+        // Dummy transaction stack setup\n+        TransactionLegacy.open(\"QuotaAlertManagerImplTest\");\n+\n+        injectMockToField(accountDao, \"_accountDao\");\n+        injectMockToField(quotaAcc, \"_quotaAcc\");\n+        injectMockToField(userDao, \"_userDao\");\n+        injectMockToField(domainDao, \"_domainDao\");\n+        injectMockToField(quotaEmailTemplateDao, \"_quotaEmailTemplateDao\");\n+        injectMockToField(configDao, \"_configDao\");\n+        injectMockToField(quotaUsage, \"_quotaUsage\");\n+        injectMockToField(emailQuotaAlert, \"_emailQuotaAlert\");\n+    }\n+\n+    @Test\n+    public void testCheckAndSendQuotaAlertEmails() {\n+        AccountVO accountVO = new AccountVO();\n+        accountVO.setId(2L);\n+        accountVO.setDomainId(1L);\n+        accountVO.setType(Account.ACCOUNT_TYPE_NORMAL);\n+        Mockito.when(accountDao.findById(Mockito.anyLong())).thenReturn(accountVO);\n+\n+        QuotaAccountVO acc = new QuotaAccountVO(2L);\n+        acc.setQuotaBalance(new BigDecimal(404));\n+        acc.setQuotaMinBalance(new BigDecimal(100));\n+        acc.setQuotaBalanceDate(new Date());\n+        acc.setQuotaAlertDate(null);\n+        acc.setQuotaEnforce(0);\n+        List<QuotaAccountVO> accounts = new ArrayList<>();\n+        accounts.add(acc);\n+        Mockito.when(quotaAcc.listAllQuotaAccount()).thenReturn(accounts);\n+\n+        // Don't test sendQuotaAlert yet\n+        Mockito.doNothing().when(quotaAlertManager).sendQuotaAlert(Mockito.any(QuotaAlertManagerImpl.DeferredQuotaEmail.class));\n+        Mockito.doReturn(true).when(quotaAlertManager).lockAccount(Mockito.anyLong());\n+\n+        // call real method on send monthly statement\n+        Mockito.doCallRealMethod().when(quotaAlertManager).checkAndSendQuotaAlertEmails();\n+\n+        // Case1: valid balance, no email should be sent\n+        quotaAlertManager.checkAndSendQuotaAlertEmails();\n+        Mockito.verify(quotaAlertManager, Mockito.times(0)).sendQuotaAlert(Mockito.any(QuotaAlertManagerImpl.DeferredQuotaEmail.class));\n+\n+        // Case2: low balance, email should be sent\n+        accounts.get(0).setQuotaBalance(new BigDecimal(99));\n+        //Mockito.when(quotaAcc.listAll()).thenReturn(accounts);\n+        quotaAlertManager.checkAndSendQuotaAlertEmails();\n+        Mockito.verify(quotaAlertManager, Mockito.times(1)).sendQuotaAlert(Mockito.any(QuotaAlertManagerImpl.DeferredQuotaEmail.class));\n+    }\n+\n+    @Test\n+    public void testSendQuotaAlert() throws UnsupportedEncodingException, MessagingException {\n+        Mockito.doCallRealMethod().when(quotaAlertManager).sendQuotaAlert(Mockito.any(QuotaAlertManagerImpl.DeferredQuotaEmail.class));\n+\n+        AccountVO account = new AccountVO();\n+        account.setId(2L);\n+        account.setDomainId(1L);\n+        account.setType(Account.ACCOUNT_TYPE_NORMAL);\n+        account.setAccountName(\"admin\");\n+        account.setUuid(\"uuid\");\n+\n+        QuotaAccountVO quotaAccount = new QuotaAccountVO(2L);\n+        quotaAccount.setQuotaBalance(new BigDecimal(404));\n+        quotaAccount.setQuotaMinBalance(new BigDecimal(100));\n+        quotaAccount.setQuotaBalanceDate(new Date());\n+        quotaAccount.setQuotaAlertDate(null);\n+        quotaAccount.setQuotaEnforce(0);\n+\n+        QuotaAlertManagerImpl.DeferredQuotaEmail email = new QuotaAlertManagerImpl.DeferredQuotaEmail(account, quotaAccount, new BigDecimal(100),\n+                QuotaConfig.QuotaEmailTemplateTypes.QUOTA_LOW);\n+\n+        QuotaEmailTemplatesVO quotaEmailTemplatesVO = new QuotaEmailTemplatesVO();\n+        quotaEmailTemplatesVO.setTemplateSubject(\"Low quota\");\n+        quotaEmailTemplatesVO.setTemplateBody(\"Low quota {{accountID}}\");\n+        List<QuotaEmailTemplatesVO> emailTemplates = new ArrayList<>();\n+        emailTemplates.add(quotaEmailTemplatesVO);\n+        Mockito.when(quotaEmailTemplateDao.listAllQuotaEmailTemplates(Mockito.anyString())).thenReturn(emailTemplates);\n+\n+        DomainVO domain = new DomainVO();\n+        domain.setUuid(\"uuid\");\n+        domain.setName(\"/domain\");\n+        Mockito.when(domainDao.findByIdIncludingRemoved(Mockito.anyLong())).thenReturn(new DomainVO());\n+\n+        UserVO user = new UserVO();\n+        user.setUsername(\"user1\");\n+        user.setEmail(\"user1@apache.org\");\n+        List<UserVO> users = new ArrayList<>();\n+        users.add(user);\n+        Mockito.when(userDao.listByAccount(Mockito.anyLong())).thenReturn(users);\n+\n+        quotaAlertManager.sendQuotaAlert(email);\n+        assertTrue(email.getSendDate()!= null);\n+        Mockito.verify(emailQuotaAlert, Mockito.times(1)).sendQuotaAlert(Mockito.anyList(), Mockito.anyString(), Mockito.anyString());\n+    }\n+\n+    @Test\n+    public void testGetDifferenceDays() {\n+        Date now = new Date();\n+        assertTrue(QuotaAlertManagerImpl.getDifferenceDays(now, now) == 0L);\n+        assertTrue(QuotaAlertManagerImpl.getDifferenceDays(now, new DateTime(now).plusDays(1).toDate()) == 1L);\n+    }\n+\n+    @Test\n+    public void testLockAccount() {\n+        AccountVO accountVO = new AccountVO();\n+        accountVO.setId(2L);\n+        accountVO.setDomainId(1L);\n+        accountVO.setType(Account.ACCOUNT_TYPE_NORMAL);\n+        accountVO.setState(Account.State.enabled);\n+        Mockito.when(accountDao.findById(Mockito.anyLong())).thenReturn(accountVO);\n+        Mockito.when(accountDao.createForUpdate()).thenReturn(accountVO);\n+        Mockito.when(accountDao.update(Mockito.eq(accountVO.getId()), Mockito.eq(accountVO))).thenReturn(true);\n+        assertTrue(quotaAlertManager.lockAccount(accountVO.getId()));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/QuotaAlertManagerImplTest.java",
                "sha": "14244fc204d9f5868e2c57a1c226fa728224bda4",
                "status": "added"
            },
            {
                "additions": 200,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/QuotaManagerImplTest.java",
                "changes": 200,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/test/org/apache/cloudstack/quota/QuotaManagerImplTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/test/org/apache/cloudstack/quota/QuotaManagerImplTest.java",
                "patch": "@@ -0,0 +1,200 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.usage.UsageVO;\n+import com.cloud.usage.dao.UsageDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.Pair;\n+import com.cloud.utils.db.TransactionLegacy;\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaBalanceDao;\n+import org.apache.cloudstack.quota.dao.QuotaTariffDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.dao.ServiceOfferingDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.apache.cloudstack.usage.UsageTypes;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.Spy;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import javax.naming.ConfigurationException;\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaManagerImplTest extends TestCase {\n+\n+    @Mock\n+    private AccountDao accountDao;\n+    @Mock\n+    private QuotaAccountDao quotaAcc;\n+    @Mock\n+    private UsageDao usageDao;\n+    @Mock\n+    private QuotaTariffDao quotaTariffDao;\n+    @Mock\n+    private QuotaUsageDao quotaUsageDao;\n+    @Mock\n+    private ServiceOfferingDao serviceOfferingDao;\n+    @Mock\n+    private QuotaBalanceDao quotaBalanceDao;\n+    @Mock\n+    private ConfigurationDao configDao;\n+\n+    @Spy\n+    QuotaManagerImpl quotaManager = new QuotaManagerImpl();\n+\n+    private void injectMockToField(Object mock, String fieldName) throws NoSuchFieldException, IllegalAccessException {\n+        Field f = QuotaManagerImpl.class.getDeclaredField(fieldName);\n+        f.setAccessible(true);\n+        f.set(quotaManager, mock);\n+    }\n+\n+    @Before\n+    public void setup() throws IllegalAccessException, NoSuchFieldException, ConfigurationException {\n+        // Dummy transaction stack setup\n+        TransactionLegacy.open(\"QuotaManagerImplTest\");\n+\n+        injectMockToField(accountDao, \"_accountDao\");\n+        injectMockToField(quotaAcc, \"_quotaAcc\");\n+        injectMockToField(usageDao, \"_usageDao\");\n+        injectMockToField(quotaTariffDao, \"_quotaTariffDao\");\n+        injectMockToField(quotaUsageDao, \"_quotaUsageDao\");\n+        injectMockToField(serviceOfferingDao, \"_serviceOfferingDao\");\n+        injectMockToField(quotaBalanceDao, \"_quotaBalanceDao\");\n+        injectMockToField(configDao, \"_configDao\");\n+    }\n+\n+    @Test\n+    public void testConfig() throws ConfigurationException {\n+        Mockito.when(configDao.getConfiguration(Mockito.anyMapOf(String.class, Object.class))).thenReturn(new HashMap<String, String>());\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"usage.stats.job.aggregation.range\", \"0\");\n+        assertTrue(quotaManager.configure(\"quotaManager\", map));\n+    }\n+\n+    @Test\n+    public void testCalculateQuotaUsage() {\n+        AccountVO accountVO = new AccountVO();\n+        accountVO.setId(2L);\n+        accountVO.setDomainId(1L);\n+        accountVO.setType(Account.ACCOUNT_TYPE_NORMAL);\n+        List<AccountVO> accountVOList = new ArrayList<>();\n+        accountVOList.add(accountVO);\n+        Mockito.when(accountDao.listAll()).thenReturn(accountVOList);\n+\n+        UsageVO usageVO = new UsageVO();\n+        usageVO.setQuotaCalculated(0);\n+        List<UsageVO> usageVOList = new ArrayList<UsageVO>();\n+        usageVOList.add(usageVO);\n+        Pair<List<? extends UsageVO>, Integer> usageRecords = new Pair<List<? extends UsageVO>, Integer>(usageVOList, usageVOList.size());\n+        Mockito.when(usageDao.getUsageRecordsPendingQuotaAggregation(Mockito.anyLong(), Mockito.anyLong())).thenReturn(usageRecords);\n+\n+        QuotaUsageVO quotaUsageVO = new QuotaUsageVO();\n+        quotaUsageVO.setAccountId(2L);\n+        List<QuotaUsageVO> quotaListForAccount = new ArrayList<>();\n+        quotaListForAccount.add(quotaUsageVO);\n+        Mockito.doReturn(quotaListForAccount).when(quotaManager).aggregatePendingQuotaRecordsForAccount(Mockito.eq(accountVO), Mockito.eq(usageRecords));\n+        Mockito.doNothing().when(quotaManager).processQuotaBalanceForAccount(Mockito.eq(accountVO), Mockito.eq(quotaListForAccount));\n+\n+        assertTrue(quotaManager.calculateQuotaUsage());\n+    }\n+\n+    @Test\n+    public void testAggregatePendingQuotaRecordsForAccount() {\n+        AccountVO accountVO = new AccountVO();\n+        accountVO.setId(2L);\n+        accountVO.setDomainId(1L);\n+        accountVO.setType(Account.ACCOUNT_TYPE_NORMAL);\n+\n+        UsageVO usageVO = new UsageVO();\n+        usageVO.setQuotaCalculated(0);\n+        usageVO.setUsageType(UsageTypes.ALLOCATED_VM);\n+        List<UsageVO> usageVOList = new ArrayList<UsageVO>();\n+        usageVOList.add(usageVO);\n+        Pair<List<? extends UsageVO>, Integer> usageRecords = new Pair<List<? extends UsageVO>, Integer>(usageVOList, usageVOList.size());\n+\n+        QuotaUsageVO quotaUsageVO = new QuotaUsageVO();\n+        quotaUsageVO.setAccountId(2L);\n+        Mockito.doReturn(quotaUsageVO).when(quotaManager).updateQuotaAllocatedVMUsage(Mockito.eq(usageVO), Mockito.any(BigDecimal.class));\n+\n+        assertTrue(quotaManager.aggregatePendingQuotaRecordsForAccount(accountVO, new Pair<List<? extends UsageVO>, Integer>(null, 0)).size() == 0);\n+        assertTrue(quotaManager.aggregatePendingQuotaRecordsForAccount(accountVO, usageRecords).size() == 1);\n+    }\n+\n+    @Test\n+    public void testUpdateQuotaRecords() {\n+        UsageVO usageVO = new UsageVO();\n+        usageVO.setId(100L);\n+        usageVO.setQuotaCalculated(0);\n+        usageVO.setUsageType(UsageTypes.NETWORK_BYTES_SENT);\n+        usageVO.setRawUsage(9000000000.0);\n+        usageVO.setSize(1010101010L);\n+\n+        QuotaTariffVO tariffVO = new QuotaTariffVO();\n+        tariffVO.setCurrencyValue(new BigDecimal(1));\n+        Mockito.when(quotaTariffDao.findTariffPlanByUsageType(Mockito.anyInt(), Mockito.any(Date.class))).thenReturn(tariffVO);\n+\n+        QuotaUsageVO qu = quotaManager.updateQuotaNetwork(usageVO, UsageTypes.NETWORK_BYTES_SENT);\n+        assertTrue(qu.getQuotaUsed().compareTo(BigDecimal.ZERO) > 0);\n+        qu = quotaManager.updateQuotaAllocatedVMUsage(usageVO, new BigDecimal(0.5));\n+        assertTrue(qu.getQuotaUsed().compareTo(BigDecimal.ZERO) > 0);\n+        qu = quotaManager.updateQuotaDiskUsage(usageVO, new BigDecimal(0.5), UsageTypes.VOLUME);\n+        assertTrue(qu.getQuotaUsed().compareTo(BigDecimal.ZERO) > 0);\n+        qu = quotaManager.updateQuotaRaw(usageVO, new BigDecimal(0.5), UsageTypes.VPN_USERS);\n+        assertTrue(qu.getQuotaUsed().compareTo(BigDecimal.ZERO) > 0);\n+\n+        Mockito.verify(quotaUsageDao, Mockito.times(4)).persistQuotaUsage(Mockito.any(QuotaUsageVO.class));\n+        Mockito.verify(usageDao, Mockito.times(4)).persistUsage(Mockito.any(UsageVO.class));\n+    }\n+\n+    @Test\n+    public void testProcessQuotaBalanceForAccount() {\n+        Date now = new Date();\n+        AccountVO accountVO = new AccountVO();\n+        accountVO.setId(2L);\n+        accountVO.setDomainId(1L);\n+        accountVO.setType(Account.ACCOUNT_TYPE_NORMAL);\n+\n+        QuotaUsageVO quotaUsageVO = new QuotaUsageVO();\n+        quotaUsageVO.setAccountId(2L);\n+        quotaUsageVO.setStartDate(new Date(now.getTime()));\n+        quotaUsageVO.setEndDate(new Date(now.getTime()));\n+        List<QuotaUsageVO> quotaListForAccount = new ArrayList<>();\n+        quotaListForAccount.add(quotaUsageVO);\n+\n+        quotaManager.processQuotaBalanceForAccount(accountVO, quotaListForAccount);\n+        Mockito.verify(quotaAcc, Mockito.times(1)).persistQuotaAccount(Mockito.any(QuotaAccountVO.class));\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/QuotaManagerImplTest.java",
                "sha": "792728f5e889fe4041eba77e8d3e37967aabfafb",
                "status": "added"
            },
            {
                "additions": 255,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/QuotaStatementTest.java",
                "changes": 255,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/test/org/apache/cloudstack/quota/QuotaStatementTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/test/org/apache/cloudstack/quota/QuotaStatementTest.java",
                "patch": "@@ -0,0 +1,255 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.db.TransactionLegacy;\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.QuotaStatementImpl.STATEMENT_PERIODS;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.Spy;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import javax.mail.MessagingException;\n+import javax.naming.ConfigurationException;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaStatementTest extends TestCase {\n+\n+    @Mock\n+    AccountDao accountDao;\n+    @Mock\n+    QuotaAccountDao quotaAcc;\n+    @Mock\n+    ConfigurationDao configDao;\n+    @Mock\n+    QuotaUsageDao quotaUsage;\n+    @Mock\n+    QuotaAlertManager alertManager;\n+\n+    @Spy\n+    QuotaStatementImpl quotaStatement = new QuotaStatementImpl();\n+\n+    private void injectMockToField(Object mock, String fieldName) throws NoSuchFieldException, IllegalAccessException {\n+        Field f = QuotaStatementImpl.class.getDeclaredField(fieldName);\n+        f.setAccessible(true);\n+        f.set(quotaStatement, mock);\n+    }\n+\n+    @Before\n+    public void setup() throws IllegalAccessException, NoSuchFieldException, ConfigurationException {\n+        // Dummy transaction stack setup\n+        TransactionLegacy.open(\"QuotaStatementImplTest\");\n+\n+        injectMockToField(accountDao, \"_accountDao\");\n+        injectMockToField(quotaAcc, \"_quotaAcc\");\n+        injectMockToField(configDao, \"_configDao\");\n+        injectMockToField(quotaUsage, \"_quotaUsage\");\n+        injectMockToField(alertManager, \"_quotaAlert\");\n+    }\n+\n+    @Test\n+    public void testStatementPeriodBIMONTHLY() {\n+        Calendar date = Calendar.getInstance();\n+\n+        //BIMONTHLY - first statement of month\n+        date.set(Calendar.DATE, QuotaStatementImpl.s_LAST_STATEMENT_SENT_DAYS + 1);\n+        Calendar period[] = quotaStatement.statementTime(date, STATEMENT_PERIODS.BIMONTHLY);\n+        assertTrue(period == null);\n+\n+        //1 of this month\n+        date.set(Calendar.DATE, 1);\n+        period = quotaStatement.statementTime(date, STATEMENT_PERIODS.BIMONTHLY);\n+        assertTrue(period != null);\n+        assertTrue(period.length == 2);\n+        assertTrue(period[0].toString(), period[0].before(period[1]));\n+        assertTrue(period[0].toString(), period[0].get(Calendar.DATE) == 1);\n+        assertTrue(period[1].toString(), period[1].get(Calendar.DATE) == 15);\n+\n+        //BIMONTHLY - second statement of month\n+        date = Calendar.getInstance();\n+        date.set(Calendar.DATE, QuotaStatementImpl.s_LAST_STATEMENT_SENT_DAYS + 16);\n+        period = quotaStatement.statementTime(date, STATEMENT_PERIODS.BIMONTHLY);\n+        assertTrue(period == null);\n+\n+        //17 of this month\n+        date.set(Calendar.DATE, 17);\n+        period = quotaStatement.statementTime(date, STATEMENT_PERIODS.BIMONTHLY);\n+        assertTrue(period != null);\n+        assertTrue(period.length == 2);\n+        assertTrue(period[0].toString(), period[0].before(period[1]));\n+        assertTrue(period[0].toString(), period[0].get(Calendar.DATE) == 16);\n+\n+        //get last day of the previous month\n+        Calendar aCalendar = Calendar.getInstance();\n+        aCalendar.add(Calendar.MONTH, -1);\n+        aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+\n+        assertTrue(period[1].toString(), period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE));\n+\n+    }\n+\n+    @Test\n+    public void testStatementPeriodMONTHLY() {\n+        Calendar date = Calendar.getInstance();\n+        Calendar aCalendar = Calendar.getInstance();\n+\n+        //MONTHLY\n+        date = Calendar.getInstance();\n+        date.set(Calendar.DATE, QuotaStatementImpl.s_LAST_STATEMENT_SENT_DAYS + 1);\n+        Calendar period[] = quotaStatement.statementTime(date, STATEMENT_PERIODS.MONTHLY);\n+        assertTrue(period == null);\n+\n+        //1 of this month\n+        date.set(Calendar.DATE, QuotaStatementImpl.s_LAST_STATEMENT_SENT_DAYS - 1);\n+        period = quotaStatement.statementTime(date, STATEMENT_PERIODS.MONTHLY);\n+        assertTrue(period != null);\n+        assertTrue(period.length == 2);\n+        assertTrue(period[0].toString(), period[0].before(period[1]));\n+        assertTrue(period[0].toString(), period[0].get(Calendar.DATE) == 1);\n+\n+        //get last day of the previous month\n+        aCalendar = Calendar.getInstance();\n+        aCalendar.add(Calendar.MONTH, -1);\n+        aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+\n+        assertTrue(period[1].toString(), period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE));\n+\n+    }\n+\n+    @Test\n+    public void testStatementPeriodQUATERLY() {\n+        Calendar date = Calendar.getInstance();\n+        Calendar aCalendar = Calendar.getInstance();\n+\n+        //QUATERLY\n+        date = Calendar.getInstance();\n+        date.set(Calendar.MONTH, Calendar.JANUARY); // 1 Jan\n+        date.set(Calendar.DATE, 1);\n+        Calendar period[] = quotaStatement.statementTime(date, STATEMENT_PERIODS.QUATERLY);\n+        assertTrue(period != null);\n+        assertTrue(period.length == 2);\n+        assertTrue(\"period[0].before(period[1])\" + period[0].toString(), period[0].before(period[1]));\n+        assertTrue(\"period[0].get(Calendar.DATE) == 1\" + period[0].toString(), period[0].get(Calendar.DATE) == 1);\n+        assertTrue(\"period[0].get(Calendar.MONTH) == Calendar.OCTOBER\" + period[0].toString(), period[0].get(Calendar.MONTH) == Calendar.OCTOBER); //october\n+\n+        //get last day of the previous month\n+        aCalendar = Calendar.getInstance();\n+        aCalendar.set(Calendar.MONTH, Calendar.DECEMBER);\n+        aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+        assertTrue(\" period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE)\" + period[1].toString(), period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE));\n+        assertTrue(\"period[1].get(Calendar.MONTH) == aCalendar.get(Calendar.MONTH)\" + period[1].toString(), period[1].get(Calendar.MONTH) == aCalendar.get(Calendar.MONTH));\n+\n+    }\n+\n+    @Test\n+    public void testStatementPeriodHALFYEARLY() {\n+        Calendar date = Calendar.getInstance();\n+        Calendar aCalendar = Calendar.getInstance();\n+\n+        //QUATERLY\n+        date = Calendar.getInstance();\n+        date.set(Calendar.MONTH, Calendar.JANUARY); // 1 Jan\n+        date.set(Calendar.DATE, 1);\n+        Calendar period[] = quotaStatement.statementTime(date, STATEMENT_PERIODS.HALFYEARLY);\n+        assertTrue(period != null);\n+        assertTrue(period.length == 2);\n+        assertTrue(\"period[0].before(period[1])\" + period[0].toString(), period[0].before(period[1]));\n+        assertTrue(\"period[0].get(Calendar.DATE) == 1\" + period[0].toString(), period[0].get(Calendar.DATE) == 1);\n+        assertTrue(\"period[0].get(Calendar.MONTH) == Calendar.JULY\" + period[0].toString(), period[0].get(Calendar.MONTH) == Calendar.JULY); //july\n+\n+        //get last day of the previous month\n+        aCalendar = Calendar.getInstance();\n+        aCalendar.set(Calendar.MONTH, Calendar.DECEMBER);\n+        aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+        assertTrue(\" period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE)\" + period[1].toString(), period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE));\n+        assertTrue(\"period[1].get(Calendar.MONTH) == aCalendar.get(Calendar.MONTH)\" + period[1].toString(), period[1].get(Calendar.MONTH) == aCalendar.get(Calendar.MONTH));\n+\n+    }\n+\n+    @Test\n+    public void testStatementPeriodYEARLY() {\n+        Calendar date = Calendar.getInstance();\n+        Calendar aCalendar = Calendar.getInstance();\n+\n+        //QUATERLY\n+        date = Calendar.getInstance();\n+        date.set(Calendar.MONTH, Calendar.JANUARY); // 1 Jan\n+        date.set(Calendar.DATE, 1);\n+        Calendar period[] = quotaStatement.statementTime(date, STATEMENT_PERIODS.YEARLY);\n+        assertTrue(\"period != null\", period != null);\n+        assertTrue(period.length == 2);\n+        assertTrue(\"period[0].before(period[1])\" + period[0].toString(), period[0].before(period[1]));\n+        assertTrue(\"period[0].get(Calendar.DATE) == 1\" + period[0].toString(), period[0].get(Calendar.DATE) == 1);\n+        assertTrue(\"period[0].get(Calendar.MONTH) == Calendar.JANUARY\" + period[0].toString(), period[0].get(Calendar.MONTH) == Calendar.JANUARY); //january\n+\n+        //get last day of the previous month\n+        aCalendar = Calendar.getInstance();\n+        aCalendar.set(Calendar.MONTH, Calendar.DECEMBER);\n+        aCalendar.set(Calendar.DATE, aCalendar.getActualMaximum(Calendar.DAY_OF_MONTH) + 1);\n+        assertTrue(\" period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE)\" + period[1].toString(), period[1].get(Calendar.DATE) == aCalendar.get(Calendar.DATE));\n+        assertTrue(\"period[1].get(Calendar.MONTH) == aCalendar.get(Calendar.MONTH)\" + period[1].toString(), period[1].get(Calendar.MONTH) == aCalendar.get(Calendar.MONTH));\n+\n+    }\n+\n+    @Test\n+    public void testSendStatement() throws UnsupportedEncodingException, MessagingException {\n+        Calendar date = Calendar.getInstance();\n+        AccountVO accountVO = new AccountVO();\n+        accountVO.setId(2L);\n+        accountVO.setDomainId(1L);\n+        Mockito.when(accountDao.findById(Mockito.anyLong())).thenReturn(accountVO);\n+\n+        QuotaAccountVO acc = new QuotaAccountVO(2L);\n+        acc.setQuotaBalance(new BigDecimal(404));\n+        acc.setLastStatementDate(null);\n+        List<QuotaAccountVO> accounts = new ArrayList<>();\n+        accounts.add(acc);\n+        Mockito.when(quotaAcc.listAllQuotaAccount()).thenReturn(accounts);\n+\n+        Mockito.when(quotaUsage.findTotalQuotaUsage(Mockito.anyLong(), Mockito.anyLong(), Mockito.anyInt(), Mockito.any(Date.class), Mockito.any(Date.class)))\n+                .thenReturn(new BigDecimal(100));\n+\n+        QuotaAlertManagerImpl.DeferredQuotaEmail email = new QuotaAlertManagerImpl.DeferredQuotaEmail(accountVO, acc, new BigDecimal(100),\n+                QuotaConfig.QuotaEmailTemplateTypes.QUOTA_LOW);\n+        // call real method on send monthly statement\n+        Mockito.doCallRealMethod().when(quotaStatement).sendStatement();\n+        Calendar period[] = quotaStatement.statementTime(date, STATEMENT_PERIODS.MONTHLY);\n+        if (period != null){\n+            Mockito.verify(alertManager, Mockito.times(1)).sendQuotaAlert(email);\n+        }\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/QuotaStatementTest.java",
                "sha": "f2a0deda3c72837c7b58886625eadbde971936c6",
                "status": "added"
            },
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/constant/QuotaTypesTest.java",
                "changes": 48,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/test/org/apache/cloudstack/quota/constant/QuotaTypesTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "framework/quota/test/org/apache/cloudstack/quota/constant/QuotaTypesTest.java",
                "patch": "@@ -0,0 +1,48 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota.constant;\n+\n+import junit.framework.TestCase;\n+\n+import org.apache.cloudstack.api.response.UsageTypeResponse;\n+import org.apache.cloudstack.usage.UsageTypes;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaTypesTest extends TestCase {\n+\n+    @Test\n+    public void testQuotaTypesList() {\n+        Map<Integer, QuotaTypes> quotaTypes = QuotaTypes.listQuotaTypes();\n+        List<UsageTypeResponse> usageTypesResponseList = UsageTypes.listUsageTypes();\n+        for (UsageTypeResponse usageTypeResponse : usageTypesResponseList) {\n+            final Integer usageTypeInt = usageTypeResponse.getUsageType();\n+            assertTrue(quotaTypes.containsKey(usageTypeInt));\n+        }\n+    }\n+\n+    @Test\n+    public void testQuotaTypeDescription() {\n+        assertNull(QuotaTypes.getDescription(-1));\n+        assertNotNull(QuotaTypes.getDescription(QuotaTypes.MEMORY));\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/framework/quota/test/org/apache/cloudstack/quota/constant/QuotaTypesTest.java",
                "sha": "427043951a16cd51ea99f6fe3748321a38643372",
                "status": "added"
            },
            {
                "additions": 99,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/pom.xml",
                "changes": 99,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/pom.xml",
                "patch": "@@ -0,0 +1,99 @@\n+<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor\n+    license agreements. See the NOTICE file distributed with this work for additional\n+    information regarding copyright ownership. The ASF licenses this file to\n+    you under the Apache License, Version 2.0 (the \"License\"); you may not use\n+    this file except in compliance with the License. You may obtain a copy of\n+    the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required\n+    by applicable law or agreed to in writing, software distributed under the\n+    License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS\n+    OF ANY KIND, either express or implied. See the License for the specific\n+    language governing permissions and limitations under the License. -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+    xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <artifactId>cloud-plugin-database-quota</artifactId>\n+  <name>Apache CloudStack Plugin - Quota Service</name>\n+  <parent>\n+    <groupId>org.apache.cloudstack</groupId>\n+    <artifactId>cloudstack-plugins</artifactId>\n+    <version>4.7.0-SNAPSHOT</version>\n+    <relativePath>../../pom.xml</relativePath>\n+  </parent>\n+  <dependencies>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-api</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-engine-schema</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-utils</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.cloudstack</groupId>\n+      <artifactId>cloud-framework-quota</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>mysql</groupId>\n+      <artifactId>mysql-connector-java</artifactId>\n+      <scope>provided</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.commons</groupId>\n+      <artifactId>commons-lang3</artifactId>\n+      <version>${cs.commons-lang3.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>joda-time</groupId>\n+      <artifactId>joda-time</artifactId>\n+      <version>${cs.joda-time.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>junit</groupId>\n+      <artifactId>junit</artifactId>\n+      <version>${cs.junit.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.hamcrest</groupId>\n+      <artifactId>hamcrest-library</artifactId>\n+      <version>${cs.hamcrest.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.mockito</groupId>\n+      <artifactId>mockito-all</artifactId>\n+      <version>${cs.mockito.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.powermock</groupId>\n+      <artifactId>powermock-module-junit4</artifactId>\n+      <version>${cs.powermock.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.powermock</groupId>\n+      <artifactId>powermock-api-mockito</artifactId>\n+      <version>${cs.powermock.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.springframework</groupId>\n+      <artifactId>spring-test</artifactId>\n+      <version>${org.springframework.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>javax.inject</groupId>\n+      <artifactId>javax.inject</artifactId>\n+      <version>1</version>\n+    </dependency>\n+  </dependencies>\n+</project>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/pom.xml",
                "sha": "ee0a04baeeedd6971ea709637314cb5d965f16ab",
                "status": "added"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/resources/META-INF/cloudstack/quota/module.properties",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/resources/META-INF/cloudstack/quota/module.properties?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/resources/META-INF/cloudstack/quota/module.properties",
                "patch": "@@ -0,0 +1,18 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+name=quota\n+parent=api",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/resources/META-INF/cloudstack/quota/module.properties",
                "sha": "7332f1518283ee9a63519bfd98c54f264ff77f40",
                "status": "added"
            },
            {
                "additions": 31,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/resources/META-INF/cloudstack/quota/spring-quota-context.xml",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/resources/META-INF/cloudstack/quota/spring-quota-context.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/resources/META-INF/cloudstack/quota/spring-quota-context.xml",
                "patch": "@@ -0,0 +1,31 @@\n+<!--\n+  Licensed to the Apache Software Foundation (ASF) under one\n+  or more contributor license agreements. See the NOTICE file\n+  distributed with this work for additional information\n+  regarding copyright ownership. The ASF licenses this file\n+  to you under the Apache License, Version 2.0 (the\n+  \"License\"); you may not use this file except in compliance\n+  with the License. You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing,\n+  software distributed under the License is distributed on an\n+  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+  KIND, either express or implied. See the License for the\n+  specific language governing permissions and limitations\n+  under the License.\n+-->\n+<beans xmlns=\"http://www.springframework.org/schema/beans\"\n+    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+    xmlns:aop=\"http://www.springframework.org/schema/aop\"\n+    xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+                      http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n+                      http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n+                      http://www.springframework.org/schema/context\n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n+\n+    <bean id=\"QuotaService\" class=\"org.apache.cloudstack.quota.QuotaServiceImpl\" />\n+    <bean id=\"QuotaResponseBuilder\" class=\"org.apache.cloudstack.api.response.QuotaResponseBuilderImpl\"/>\n+\n+</beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/resources/META-INF/cloudstack/quota/spring-quota-context.xml",
                "sha": "15bc144e31a7278f82529a6dbb05a74e1bbe1d16",
                "status": "added"
            },
            {
                "additions": 125,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaBalanceCmd.java",
                "changes": 125,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaBalanceCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaBalanceCmd.java",
                "patch": "@@ -0,0 +1,125 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import java.util.Date;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.log4j.Logger;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.response.AccountResponse;\n+import org.apache.cloudstack.api.response.DomainResponse;\n+import org.apache.cloudstack.api.response.QuotaBalanceResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.api.response.QuotaStatementItemResponse;\n+\n+@APICommand(name = \"quotaBalance\", responseObject = QuotaStatementItemResponse.class, description = \"Create a quota balance statement\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaBalanceCmd extends BaseCmd {\n+\n+    public static final Logger s_logger = Logger.getLogger(QuotaBalanceCmd.class);\n+\n+    private static final String s_name = \"quotabalanceresponse\";\n+\n+    @Parameter(name = ApiConstants.ACCOUNT, type = CommandType.STRING, required = true, description = \"Account Id for which statement needs to be generated\")\n+    private String accountName;\n+\n+    @Parameter(name = ApiConstants.DOMAIN_ID, type = CommandType.UUID, required = true, entityType = DomainResponse.class, description = \"If domain Id is given and the caller is domain admin then the statement is generated for domain.\")\n+    private Long domainId;\n+\n+    @Parameter(name = ApiConstants.END_DATE, type = CommandType.DATE, description = \"End date range for quota query. Use yyyy-MM-dd as the date format, e.g. startDate=2009-06-03.\")\n+    private Date endDate;\n+\n+    @Parameter(name = ApiConstants.START_DATE, type = CommandType.DATE, description = \"Start date range quota query. Use yyyy-MM-dd as the date format, e.g. startDate=2009-06-01.\")\n+    private Date startDate;\n+\n+    @Parameter(name = ApiConstants.ACCOUNT_ID, type = CommandType.UUID, entityType = AccountResponse.class, description = \"List usage records for the specified account\")\n+    private Long accountId;\n+\n+    @Inject\n+    QuotaResponseBuilder _responseBuilder;\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public Date getEndDate() {\n+        return endDate == null ? null : _responseBuilder.startOfNextDay(endDate == null ? null : new Date(endDate.getTime()));\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+       return _accountService.getActiveAccountByName(accountName, domainId).getAccountId();\n+    }\n+\n+    @Override\n+    public void execute() {\n+        List<QuotaBalanceVO> quotaUsage = _responseBuilder.getQuotaBalance(this);\n+\n+        QuotaBalanceResponse response;\n+        if (getEndDate() == null) {\n+            response = _responseBuilder.createQuotaLastBalanceResponse(quotaUsage, getStartDate());\n+        } else {\n+            response = _responseBuilder.createQuotaBalanceResponse(quotaUsage, getStartDate(), endDate == null ? null : new Date(endDate.getTime()));\n+        }\n+        response.setResponseName(getCommandName());\n+        setResponseObject(response);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaBalanceCmd.java",
                "sha": "ef9d49a3beb3ab3803e484a42300b63cfa2de86c",
                "status": "added"
            },
            {
                "additions": 147,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaCreditsCmd.java",
                "changes": 147,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaCreditsCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaCreditsCmd.java",
                "patch": "@@ -0,0 +1,147 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.Account;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.DomainResponse;\n+import org.apache.cloudstack.api.response.QuotaCreditsResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.cloudstack.quota.QuotaService;\n+import org.apache.log4j.Logger;\n+\n+import javax.inject.Inject;\n+\n+@APICommand(name = \"quotaCredits\", responseObject = QuotaCreditsResponse.class, description = \"Add +-credits to an account\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaCreditsCmd extends BaseCmd {\n+\n+    @Inject\n+    QuotaResponseBuilder _responseBuilder;\n+\n+    @Inject\n+    QuotaService _quotaService;\n+\n+    public static final Logger s_logger = Logger.getLogger(QuotaStatementCmd.class);\n+\n+    private static final String s_name = \"quotacreditsresponse\";\n+\n+    @Parameter(name = ApiConstants.ACCOUNT, type = CommandType.STRING, required = true, description = \"Account Id for which quota credits need to be added\")\n+    private String accountName;\n+\n+    @Parameter(name = ApiConstants.DOMAIN_ID, type = CommandType.UUID, required = true, entityType = DomainResponse.class, description = \"Domain for which quota credits need to be added\")\n+    private Long domainId;\n+\n+    @Parameter(name = ApiConstants.VALUE, type = CommandType.DOUBLE, required = true, description = \"Value of the credits to be added+, subtracted-\")\n+    private Double value;\n+\n+    @Parameter(name = \"min_balance\", type = CommandType.DOUBLE, required = false, description = \"Minimum balance threshold of the account\")\n+    private Double minBalance;\n+\n+    @Parameter(name = \"quota_enforce\", type = CommandType.BOOLEAN, required = false, description = \"Account for which quota enforce is set to false will not be locked when there is no credit balance\")\n+    private Boolean quotaEnforce;\n+\n+    public Double getMinBalance() {\n+        return minBalance;\n+    }\n+\n+    public void setMinBalance(Double minBalance) {\n+        this.minBalance = minBalance;\n+    }\n+\n+    public Boolean getQuotaEnforce() {\n+        return quotaEnforce;\n+    }\n+\n+    public void setQuotaEnforce(Boolean quotaEnforce) {\n+        this.quotaEnforce = quotaEnforce;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public Double getValue() {\n+        return value;\n+    }\n+\n+    public void setValue(Double value) {\n+        this.value = value;\n+    }\n+\n+    public QuotaCreditsCmd() {\n+        super();\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        Long accountId = null;\n+        Account account = _accountService.getActiveAccountByName(accountName, domainId);\n+        if (account != null) {\n+            accountId = account.getAccountId();\n+        }\n+        if (accountId == null) {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"The account does not exists or has been removed/disabled\");\n+        }\n+        if (getValue() == null) {\n+            throw new ServerApiException(ApiErrorCode.PARAM_ERROR, \"Please send a valid non-empty quota value\");\n+        }\n+        if (getQuotaEnforce() != null && getQuotaEnforce()) {\n+            _quotaService.setLockAccount(accountId, getQuotaEnforce());\n+        }\n+        if (getMinBalance() != null) {\n+            _quotaService.setMinBalance(accountId, getMinBalance());\n+        }\n+        else {\n+            throw new ServerApiException(ApiErrorCode.PARAM_ERROR, \"Please set a value for min balance\");\n+        }\n+\n+        final QuotaCreditsResponse response = _responseBuilder.addQuotaCredits(accountId, getDomainId(), getValue(), CallContext.current().getCallingUserId());\n+        response.setResponseName(getCommandName());\n+        response.setObjectName(\"quotacredits\");\n+        setResponseObject(response);\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaCreditsCmd.java",
                "sha": "ce00e23e5c9a7e154595424b309392b26cc44d02",
                "status": "added"
            },
            {
                "additions": 60,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmd.java",
                "changes": 60,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmd.java",
                "patch": "@@ -0,0 +1,60 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.BaseListCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.response.ListResponse;\n+import org.apache.cloudstack.api.response.QuotaEmailTemplateResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.log4j.Logger;\n+\n+import javax.inject.Inject;\n+\n+@APICommand(name = \"quotaEmailTemplateList\", responseObject = QuotaEmailTemplateResponse.class, description = \"Lists all quota email templates\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaEmailTemplateListCmd extends BaseListCmd {\n+    public static final Logger s_logger = Logger.getLogger(QuotaEmailTemplateListCmd.class);\n+    private static final String s_name = \"quotaemailtemplatelistresponse\";\n+\n+    @Inject\n+    QuotaResponseBuilder _quotaResponseBuilder;\n+\n+    @Parameter(name = \"templatetype\", type = CommandType.STRING, description = \"List by type of the quota email template, allowed types: QUOTA_LOW, QUOTA_EMPTY\")\n+    private String templateName;\n+\n+    public String getTemplateName() {\n+        return templateName;\n+    }\n+\n+    public void setTemplateName(String templateName) {\n+        this.templateName = templateName;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        final ListResponse<QuotaEmailTemplateResponse> response = new ListResponse<QuotaEmailTemplateResponse>();\n+        response.setResponses(_quotaResponseBuilder.listQuotaEmailTemplates(this));\n+        response.setResponseName(getCommandName());\n+        setResponseObject(response);\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmd.java",
                "sha": "8b717eb41ec9f34ba6c6beca92b321adf1d15e1f",
                "status": "added"
            },
            {
                "additions": 122,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmd.java",
                "changes": 122,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmd.java",
                "patch": "@@ -0,0 +1,122 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.Account;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.SuccessResponse;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.log4j.Logger;\n+\n+import javax.inject.Inject;\n+import java.util.Arrays;\n+\n+@APICommand(name = \"quotaEmailTemplateUpdate\", responseObject = SuccessResponse.class, description = \"Updates existing email templates for quota alerts\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaEmailTemplateUpdateCmd extends BaseCmd {\n+    public static final Logger s_logger = Logger.getLogger(QuotaEmailTemplateUpdateCmd.class);\n+    private static final String s_name = \"quotaemailtemplateupdateresponse\";\n+\n+    @Inject\n+    QuotaResponseBuilder _quotaResponseBuilder;\n+\n+    @Parameter(name = \"templatetype\", type = CommandType.STRING, required=true, description = \"Type of the quota email template, allowed types: QUOTA_LOW, QUOTA_EMPTY\")\n+    private String templateName;\n+\n+    @Parameter(name = \"templatesubject\", type = CommandType.STRING, required=true, description = \"The quota email template subject, max: 77 characters\", length = 77)\n+    private String templateSubject;\n+\n+    @Parameter(name = \"templatebody\", type = CommandType.STRING, required=true, description = \"The quota email template body, max: 500k characters\", length = 512000)\n+    private String templateBody;\n+\n+    @Parameter(name = \"locale\", type = CommandType.STRING, description = \"The locale of the email text\")\n+    private String locale;\n+\n+    @Override\n+    public void execute() {\n+        final String templateName = getTemplateName();\n+        if (templateName == null || getTemplateSubject() == null || getTemplateBody() == null) {\n+            throw new ServerApiException(ApiErrorCode.PARAM_ERROR, \"Failed to update quota email template due to empty or invalid template name or text\");\n+        }\n+\n+        boolean isValidTemplateName = false;\n+        for (QuotaConfig.QuotaEmailTemplateTypes e: QuotaConfig.QuotaEmailTemplateTypes.values()) {\n+            if (e.toString().equalsIgnoreCase(templateName)) {\n+                isValidTemplateName = true;\n+                setTemplateName(e.toString());\n+                break;\n+            }\n+        }\n+        if (!isValidTemplateName) {\n+            throw new ServerApiException(ApiErrorCode.PARAM_ERROR, \"Invalid quota email template type, allowed values are: \" + Arrays.toString(QuotaConfig.QuotaEmailTemplateTypes.values()));\n+        }\n+\n+        if (!_quotaResponseBuilder.updateQuotaEmailTemplate(this)) {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Unable to update quota email template due to an internal error\");\n+        }\n+        final SuccessResponse response = new SuccessResponse();\n+        response.setResponseName(getCommandName());\n+        response.setSuccess(true);\n+        setResponseObject(response);\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+    public void setTemplateName(String templateName) {\n+        this.templateName = templateName;\n+    }\n+\n+    public String getTemplateName() {\n+        return templateName;\n+    }\n+\n+    public String getTemplateSubject() {\n+        return templateSubject;\n+    }\n+\n+    public String getTemplateBody() {\n+        return templateBody;\n+    }\n+\n+    public String getLocale() {\n+        return locale;\n+    }\n+\n+    public void setTemplateSubject(String templateSubject) {\n+        this.templateSubject = templateSubject;\n+    }\n+\n+    public void setTemplateBody(String templateBody) {\n+        this.templateBody = templateBody;\n+    }\n+\n+    public void setLocale(String locale) {\n+        this.locale = locale;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmd.java",
                "sha": "469fd4dd0029be178e3e338c2dcf15e3d060d3cd",
                "status": "added"
            },
            {
                "additions": 141,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaStatementCmd.java",
                "changes": 141,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaStatementCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaStatementCmd.java",
                "patch": "@@ -0,0 +1,141 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import java.util.Date;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.log4j.Logger;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.response.AccountResponse;\n+import org.apache.cloudstack.api.response.DomainResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaStatementResponse;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.apache.cloudstack.api.response.QuotaStatementItemResponse;\n+\n+import com.cloud.user.Account;\n+\n+@APICommand(name = \"quotaStatement\", responseObject = QuotaStatementItemResponse.class, description = \"Create a quota statement\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaStatementCmd extends BaseCmd {\n+\n+    public static final Logger s_logger = Logger.getLogger(QuotaStatementCmd.class);\n+\n+    private static final String s_name = \"quotastatementresponse\";\n+\n+    @Parameter(name = ApiConstants.ACCOUNT, type = CommandType.STRING, required = true, description = \"Optional, Account Id for which statement needs to be generated\")\n+    private String accountName;\n+\n+    @Parameter(name = ApiConstants.DOMAIN_ID, type = CommandType.UUID, required = true, entityType = DomainResponse.class, description = \"Optional, If domain Id is given and the caller is domain admin then the statement is generated for domain.\")\n+    private Long domainId;\n+\n+    @Parameter(name = ApiConstants.END_DATE, type = CommandType.DATE, required = true, description = \"End date range for quota query. Use yyyy-MM-dd as the date format, e.g. startDate=2009-06-03.\")\n+    private Date endDate;\n+\n+    @Parameter(name = ApiConstants.START_DATE, type = CommandType.DATE, required = true, description = \"Start date range quota query. Use yyyy-MM-dd as the date format, e.g. startDate=2009-06-01.\")\n+    private Date startDate;\n+\n+    @Parameter(name = ApiConstants.TYPE, type = CommandType.INTEGER, description = \"List quota usage records for the specified usage type\")\n+    private Integer usageType;\n+\n+    @Parameter(name = ApiConstants.ACCOUNT_ID, type = CommandType.UUID, entityType = AccountResponse.class, description = \"List usage records for the specified account\")\n+    private Long accountId;\n+\n+    @Inject\n+    QuotaResponseBuilder _responseBuilder;\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public Integer getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(Integer usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public Date getEndDate() {\n+        return _responseBuilder.startOfNextDay(endDate == null ? new Date() : new Date(endDate.getTime()));\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        Long accountId = _accountService.getActiveAccountByName(accountName, domainId).getAccountId();\n+        if (accountId == null) {\n+            return CallContext.current().getCallingAccount().getId();\n+        }\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        List<QuotaUsageVO> quotaUsage = _responseBuilder.getQuotaUsage(this);\n+\n+        QuotaStatementResponse response = _responseBuilder.createQuotaStatementResponse(quotaUsage);\n+        response.setStartDate(startDate == null ? null : new Date(startDate.getTime()));\n+        response.setEndDate(endDate == null ? null : new Date(endDate.getTime()));\n+\n+        response.setResponseName(getCommandName());\n+        setResponseObject(response);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaStatementCmd.java",
                "sha": "fa9796009b71a566c07f7ec8c080e033cdc47e36",
                "status": "added"
            },
            {
                "additions": 110,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "changes": 110,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "patch": "@@ -0,0 +1,110 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.Account;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseListCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.BaseCmd.CommandType;\n+import org.apache.cloudstack.api.response.DomainResponse;\n+import org.apache.cloudstack.api.response.ListResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaSummaryResponse;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.log4j.Logger;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+@APICommand(name = \"quotaSummary\", responseObject = QuotaSummaryResponse.class, description = \"Lists balance and quota usage for all accounts\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaSummaryCmd extends BaseListCmd {\n+    public static final Logger s_logger = Logger.getLogger(QuotaSummaryCmd.class);\n+    private static final String s_name = \"quotasummaryresponse\";\n+\n+    @Parameter(name = ApiConstants.ACCOUNT, type = CommandType.STRING, required = false, description = \"Optional, Account Id for which statement needs to be generated\")\n+    private String accountName;\n+\n+    @Parameter(name = ApiConstants.DOMAIN_ID, type = CommandType.UUID, required = false, entityType = DomainResponse.class, description = \"Optional, If domain Id is given and the caller is domain admin then the statement is generated for domain.\")\n+    private Long domainId;\n+\n+    @Parameter(name = ApiConstants.LIST_ALL, type = CommandType.BOOLEAN, required = false, description = \"Optional, to list all accounts irrespective of the quota activity\")\n+    private Boolean listAll;\n+\n+    @Inject\n+    QuotaResponseBuilder _responseBuilder;\n+\n+    public QuotaSummaryCmd() {\n+        super();\n+    }\n+\n+    @Override\n+    public void execute() {\n+        Account caller = CallContext.current().getCallingAccount();\n+        List<QuotaSummaryResponse> responses;\n+        if (caller.getAccountId() <= 2) { //non root admin or system\n+            if (getAccountName() != null && getDomainId() != null)\n+                responses = _responseBuilder.createQuotaSummaryResponse(caller.getAccountName(), caller.getDomainId());\n+            else\n+                responses = _responseBuilder.createQuotaSummaryResponse(getListAll());\n+        } else {\n+            responses = _responseBuilder.createQuotaSummaryResponse(caller.getAccountName(), caller.getDomainId());\n+        }\n+        final ListResponse<QuotaSummaryResponse> response = new ListResponse<QuotaSummaryResponse>();\n+        response.setResponses(responses);\n+        response.setResponseName(getCommandName());\n+        setResponseObject(response);\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    public Boolean getListAll() {\n+        return listAll == null ? false: listAll;\n+    }\n+\n+    public void setListAll(Boolean listAll) {\n+        this.listAll = listAll;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "sha": "773bac6e0e464919735f9b4963625acd146e7dcf",
                "status": "added"
            },
            {
                "additions": 95,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffListCmd.java",
                "changes": 95,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffListCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffListCmd.java",
                "patch": "@@ -0,0 +1,95 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.Account;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseListCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.response.ListResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaTariffResponse;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.log4j.Logger;\n+\n+import javax.inject.Inject;\n+\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@APICommand(name = \"quotaTariffList\", responseObject = QuotaTariffResponse.class, description = \"Lists all quota tariff plans\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaTariffListCmd extends BaseListCmd {\n+    public static final Logger s_logger = Logger.getLogger(QuotaTariffListCmd.class);\n+    private static final String s_name = \"quotatarifflistresponse\";\n+\n+    @Inject\n+    QuotaResponseBuilder _responseBuilder;\n+\n+    @Parameter(name = ApiConstants.USAGE_TYPE, type = CommandType.INTEGER, required = false, description = \"Usage type of the resource\")\n+    private Integer usageType;\n+\n+    @Parameter(name = ApiConstants.START_DATE, type = CommandType.DATE, required = false, description = \"The effective start date on/after which the quota tariff is effective and older tariffs are no longer used for the usage type. Use yyyy-MM-dd as the date format, e.g. startDate=2009-06-03.\")\n+    private Date effectiveDate;\n+\n+    public QuotaTariffListCmd() {\n+        super();\n+    }\n+\n+    @Override\n+    public void execute() {\n+        final List<QuotaTariffVO> result = _responseBuilder.listQuotaTariffPlans(this);\n+\n+        final List<QuotaTariffResponse> responses = new ArrayList<QuotaTariffResponse>();\n+        for (final QuotaTariffVO resource : result) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Result desc=\" + resource.getDescription() + \" date=\" + resource.getEffectiveOn() + \" val=\" + resource.getCurrencyValue());\n+            }\n+            responses.add(_responseBuilder.createQuotaTariffResponse(resource));\n+        }\n+\n+        final ListResponse<QuotaTariffResponse> response = new ListResponse<QuotaTariffResponse>();\n+        response.setResponses(responses);\n+        response.setResponseName(getCommandName());\n+        setResponseObject(response);\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+    public Date getEffectiveDate() {\n+        return effectiveDate ==null ? null : new Date(effectiveDate.getTime());\n+    }\n+\n+    public Integer getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(Integer usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffListCmd.java",
                "sha": "c1905944c52c8f03a9eb9318241d3051a37c3744",
                "status": "added"
            },
            {
                "additions": 102,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffUpdateCmd.java",
                "changes": 102,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffUpdateCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffUpdateCmd.java",
                "patch": "@@ -0,0 +1,102 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.Account;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaTariffResponse;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.log4j.Logger;\n+\n+import javax.inject.Inject;\n+\n+import java.util.Date;\n+\n+@APICommand(name = \"quotaTariffUpdate\", responseObject = QuotaTariffResponse.class, description = \"Update the tariff plan for a resource\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaTariffUpdateCmd extends BaseCmd {\n+    public static final Logger s_logger = Logger.getLogger(QuotaTariffUpdateCmd.class);\n+    private static final String s_name = \"quotatariffupdateresponse\";\n+\n+    @Inject\n+    QuotaResponseBuilder _responseBuilder;\n+\n+    @Parameter(name = ApiConstants.USAGE_TYPE, type = CommandType.INTEGER, required = true, description = \"Integer value for the usage type of the resource\")\n+    private Integer usageType;\n+\n+    @Parameter(name = \"value\", type = CommandType.DOUBLE, required = true,  description = \"The quota tariff value of the resource as per the default unit\")\n+    private Double value;\n+\n+    @Parameter(name = ApiConstants.START_DATE, type = CommandType.DATE, required = true, description = \"The effective start date on/after which the quota tariff is effective and older tariffs are no longer used for the usage type. Use yyyy-MM-dd as the date format, e.g. startDate=2009-06-03.\")\n+    private Date startDate;\n+\n+    public int getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public Double getValue() {\n+        return value;\n+    }\n+\n+    public void setValue(Double value) {\n+        this.value = value;\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public QuotaTariffUpdateCmd() {\n+        super();\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        final QuotaTariffVO result = _responseBuilder.updateQuotaTariffPlan(this);\n+        if (result == null) {\n+            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, \"Failed to update quota tariff plan\");\n+        }\n+        final QuotaTariffResponse response = _responseBuilder.createQuotaTariffResponse(result);\n+        response.setResponseName(getCommandName());\n+        setResponseObject(response);\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaTariffUpdateCmd.java",
                "sha": "04af3eca1eeaebf9f1d8bd2d0a775f5a9af1d245",
                "status": "added"
            },
            {
                "additions": 72,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaUpdateCmd.java",
                "changes": 72,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaUpdateCmd.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaUpdateCmd.java",
                "patch": "@@ -0,0 +1,72 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.Account;\n+\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.response.QuotaUpdateResponse;\n+import org.apache.cloudstack.quota.QuotaAlertManager;\n+import org.apache.cloudstack.quota.QuotaManager;\n+import org.apache.cloudstack.quota.QuotaStatement;\n+import org.apache.log4j.Logger;\n+\n+import java.util.Calendar;\n+\n+import javax.inject.Inject;\n+\n+@APICommand(name = \"quotaUpdate\", responseObject = QuotaUpdateResponse.class, description = \"Update quota calculations, alerts and statements\", since = \"4.6.0\", requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n+public class QuotaUpdateCmd extends BaseCmd {\n+\n+    public static final Logger s_logger = Logger.getLogger(QuotaUpdateCmd.class);\n+\n+    private static final String s_name = \"quotaupdateresponse\";\n+\n+    @Inject\n+    QuotaManager _manager;\n+    @Inject\n+    QuotaStatement _statement;\n+    @Inject\n+    QuotaAlertManager _alert;\n+\n+    public QuotaUpdateCmd() {\n+        super();\n+    }\n+\n+    @Override\n+    public String getCommandName() {\n+        return s_name;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        _manager.calculateQuotaUsage();\n+        _statement.sendStatement();\n+        _alert.checkAndSendQuotaAlertEmails();\n+        QuotaUpdateResponse response = new QuotaUpdateResponse(Calendar.getInstance());\n+        response.setResponseName(getCommandName());\n+        response.setObjectName(\"quotacredits\");\n+        setResponseObject(response);\n+    }\n+\n+    @Override\n+    public long getEntityOwnerId() {\n+        return Account.ACCOUNT_ID_SYSTEM;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaUpdateCmd.java",
                "sha": "e3c0fd279fe5d1f94915d30d423a4bbcf54ca6c7",
                "status": "added"
            },
            {
                "additions": 153,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaBalanceResponse.java",
                "changes": 153,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaBalanceResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaBalanceResponse.java",
                "patch": "@@ -0,0 +1,153 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.BaseResponse;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+\n+import com.cloud.serializer.Param;\n+\n+public class QuotaBalanceResponse extends BaseResponse {\n+\n+    @SerializedName(\"accountid\")\n+    @Param(description = \"account id\")\n+    private Long accountId;\n+\n+    @SerializedName(\"account\")\n+    @Param(description = \"account name\")\n+    private String accountName;\n+\n+    @SerializedName(\"domain\")\n+    @Param(description = \"domain id\")\n+    private Long domainId;\n+\n+    @SerializedName(\"startquota\")\n+    @Param(description = \"quota started with\")\n+    private BigDecimal startQuota;\n+\n+    @SerializedName(\"endquota\")\n+    @Param(description = \"quota by end of this period\")\n+    private BigDecimal endQuota;\n+\n+    @SerializedName(\"credits\")\n+    @Param(description = \"list of credits made during this period\")\n+    private List<QuotaCreditsResponse> credits = null;\n+\n+    @SerializedName(\"startdate\")\n+    @Param(description = \"start date\")\n+    private Date startDate = null;\n+\n+    @SerializedName(\"enddate\")\n+    @Param(description = \"end date\")\n+    private Date endDate = null;\n+\n+    @SerializedName(\"currency\")\n+    @Param(description = \"currency\")\n+    private String currency;\n+\n+    public QuotaBalanceResponse() {\n+        super();\n+        credits = new ArrayList<QuotaCreditsResponse>();\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public BigDecimal getStartQuota() {\n+        return startQuota;\n+    }\n+\n+    public void setStartQuota(BigDecimal startQuota) {\n+        this.startQuota = startQuota.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+    public BigDecimal getEndQuota() {\n+        return endQuota;\n+    }\n+\n+    public void setEndQuota(BigDecimal endQuota) {\n+        this.endQuota = endQuota.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+    public List<QuotaCreditsResponse> getCredits() {\n+        return credits;\n+    }\n+\n+    public void setCredits(List<QuotaCreditsResponse> credits) {\n+        this.credits = credits;\n+    }\n+\n+    public void addCredits(QuotaBalanceVO credit) {\n+        QuotaCreditsResponse cr = new QuotaCreditsResponse();\n+        cr.setCredits(credit.getCreditBalance());\n+        cr.setUpdatedOn(credit.getUpdatedOn() == null ? null : new Date(credit.getUpdatedOn().getTime()));\n+        credits.add(0, cr);\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public Date getEndDate() {\n+        return endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public String getCurrency() {\n+        return currency;\n+    }\n+\n+    public void setCurrency(String currency) {\n+        this.currency = currency;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaBalanceResponse.java",
                "sha": "fca6b6cbb1aa11829dcf8ffd7e06972dd962b859",
                "status": "added"
            },
            {
                "additions": 91,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaCreditsResponse.java",
                "changes": 91,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaCreditsResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaCreditsResponse.java",
                "patch": "@@ -0,0 +1,91 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.BaseResponse;\n+import org.apache.cloudstack.quota.vo.QuotaCreditsVO;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.Date;\n+\n+public class QuotaCreditsResponse extends BaseResponse {\n+\n+    @SerializedName(\"credits\")\n+    @Param(description = \"the credit deposited\")\n+    private BigDecimal credits;\n+\n+    @SerializedName(\"updated_by\")\n+    @Param(description = \"the user name of the admin who updated the credits\")\n+    private String updatedBy;\n+\n+    @SerializedName(\"updated_on\")\n+    @Param(description = \"the account name of the admin who updated the credits\")\n+    private Date updatedOn;\n+\n+    @SerializedName(\"currency\")\n+    @Param(description = \"currency\")\n+    private String currency;\n+\n+    public QuotaCreditsResponse() {\n+        super();\n+    }\n+\n+    public QuotaCreditsResponse(QuotaCreditsVO result, String updatedBy) {\n+        super();\n+        if (result != null) {\n+            setCredits(result.getCredit());\n+            setUpdatedBy(updatedBy);\n+            setUpdatedOn(new Date());\n+        }\n+    }\n+\n+    public BigDecimal getCredits() {\n+        return credits;\n+    }\n+\n+    public void setCredits(BigDecimal credits) {\n+        this.credits = credits.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+    public String getUpdatedBy() {\n+        return updatedBy;\n+    }\n+\n+    public void setUpdatedBy(String updatedBy) {\n+        this.updatedBy = updatedBy;\n+    }\n+\n+    public Date getUpdatedOn() {\n+        return updatedOn;\n+    }\n+\n+    public void setUpdatedOn(Date updatedOn) {\n+        this.updatedOn = updatedOn;\n+    }\n+\n+    public String getCurrency() {\n+        return currency;\n+    }\n+\n+    public void setCurrency(String currency) {\n+        this.currency = currency;\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaCreditsResponse.java",
                "sha": "2c16cf44b7cf74f7f2e87664be8706ed9c6753ea",
                "status": "added"
            },
            {
                "additions": 90,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaEmailTemplateResponse.java",
                "changes": 90,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaEmailTemplateResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaEmailTemplateResponse.java",
                "patch": "@@ -0,0 +1,90 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import java.util.Date;\n+\n+public class QuotaEmailTemplateResponse extends BaseResponse {\n+    @SerializedName(\"templatetype\")\n+    @Param(description = \"Template type\")\n+    private String templateType;\n+\n+    @SerializedName(\"templatesubject\")\n+    @Param(description = \"The quota email template subject\")\n+    private String templateSubject;\n+\n+    @SerializedName(\"templatebody\")\n+    @Param(description = \"The quota email template content\")\n+    private String templateText;\n+\n+    @SerializedName(\"locale\")\n+    @Param(description = \"The quota email template locale\")\n+    private String locale;\n+\n+    @SerializedName(\"last_updated\")\n+    @Param(description = \"Last date/time when template was updated\")\n+    private Date lastUpdatedOn;\n+\n+    public QuotaEmailTemplateResponse() {\n+        super();\n+        this.setObjectName(\"quotaemailtemplate\");\n+    }\n+\n+    public String getTemplateType() {\n+        return templateType;\n+    }\n+\n+    public void setTemplateType(String templateType) {\n+        this.templateType = templateType;\n+    }\n+\n+    public String getTemplateSubject() {\n+        return templateSubject;\n+    }\n+\n+    public void setTemplateSubject(String templateSubject) {\n+        this.templateSubject = templateSubject;\n+    }\n+\n+    public String getTemplateText() {\n+        return templateText;\n+    }\n+\n+    public void setTemplateText(String templateText) {\n+        this.templateText = templateText;\n+    }\n+\n+    public String getLocale() {\n+        return locale;\n+    }\n+\n+    public void setLocale(String locale) {\n+        this.locale = locale;\n+    }\n+\n+    public Date getLastUpdatedOn() {\n+        return lastUpdatedOn;\n+    }\n+\n+    public void setLastUpdatedOn(Date lastUpdatedOn) {\n+        this.lastUpdatedOn = lastUpdatedOn;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaEmailTemplateResponse.java",
                "sha": "c4a2b7c3a6059b61626c101b19877d825aba4f90",
                "status": "added"
            },
            {
                "additions": 65,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilder.java",
                "changes": 65,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilder.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilder.java",
                "patch": "@@ -0,0 +1,65 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import org.apache.cloudstack.api.command.QuotaBalanceCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateListCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateUpdateCmd;\n+import org.apache.cloudstack.api.command.QuotaStatementCmd;\n+import org.apache.cloudstack.api.command.QuotaTariffListCmd;\n+import org.apache.cloudstack.api.command.QuotaTariffUpdateCmd;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+\n+import java.util.Date;\n+import java.util.List;\n+\n+public interface QuotaResponseBuilder {\n+\n+    QuotaTariffVO updateQuotaTariffPlan(QuotaTariffUpdateCmd cmd);\n+\n+    List<QuotaTariffVO> listQuotaTariffPlans(QuotaTariffListCmd cmd);\n+\n+    QuotaTariffResponse createQuotaTariffResponse(QuotaTariffVO configuration);\n+\n+    QuotaStatementResponse createQuotaStatementResponse(List<QuotaUsageVO> quotaUsage);\n+\n+    QuotaBalanceResponse createQuotaBalanceResponse(List<QuotaBalanceVO> quotaUsage, Date startDate, Date endDate);\n+\n+    List<QuotaSummaryResponse> createQuotaSummaryResponse(Boolean listAll);\n+\n+    List<QuotaSummaryResponse> createQuotaSummaryResponse(String accountName, Long domainId);\n+\n+    QuotaBalanceResponse createQuotaLastBalanceResponse(List<QuotaBalanceVO> quotaBalance, Date startDate);\n+\n+    QuotaCreditsResponse addQuotaCredits(Long accountId, Long domainId, Double amount, Long updatedBy, Date despositedOn);\n+\n+    List<QuotaUsageVO> getQuotaUsage(QuotaStatementCmd cmd);\n+\n+    List<QuotaBalanceVO> getQuotaBalance(QuotaBalanceCmd cmd);\n+\n+    QuotaCreditsResponse addQuotaCredits(Long accountId, Long domainId, Double amount, Long updatedBy);\n+\n+    List<QuotaEmailTemplateResponse> listQuotaEmailTemplates(QuotaEmailTemplateListCmd cmd);\n+\n+    boolean updateQuotaEmailTemplate(QuotaEmailTemplateUpdateCmd cmd);\n+\n+    Date startOfNextDay(Date dt);\n+\n+    Date startOfNextDay();\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilder.java",
                "sha": "a4260cb937dc3e97403ea4405585478c6b8eef8b",
                "status": "added"
            },
            {
                "additions": 516,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "changes": 516,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "patch": "@@ -0,0 +1,516 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.domain.DomainVO;\n+import com.cloud.domain.dao.DomainDao;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.User;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.user.dao.UserDao;\n+\n+import org.apache.cloudstack.api.command.QuotaBalanceCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateListCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateUpdateCmd;\n+import org.apache.cloudstack.api.command.QuotaStatementCmd;\n+import org.apache.cloudstack.api.command.QuotaTariffListCmd;\n+import org.apache.cloudstack.api.command.QuotaTariffUpdateCmd;\n+import org.apache.cloudstack.quota.QuotaService;\n+import org.apache.cloudstack.quota.QuotaStatement;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaBalanceDao;\n+import org.apache.cloudstack.quota.dao.QuotaCreditsDao;\n+import org.apache.cloudstack.quota.dao.QuotaEmailTemplatesDao;\n+import org.apache.cloudstack.quota.dao.QuotaTariffDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaCreditsVO;\n+import org.apache.cloudstack.quota.vo.QuotaEmailTemplatesVO;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.apache.cloudstack.region.RegionManager;\n+import org.apache.commons.lang.StringEscapeUtils;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.ListIterator;\n+\n+@Component\n+@Local(value = QuotaResponseBuilderImpl.class)\n+public class QuotaResponseBuilderImpl implements QuotaResponseBuilder {\n+    private static final Logger s_logger = Logger.getLogger(QuotaResponseBuilderImpl.class);\n+\n+    @Inject\n+    private QuotaTariffDao _quotaTariffDao;\n+    @Inject\n+    private QuotaBalanceDao _quotaBalanceDao;\n+    @Inject\n+    private QuotaCreditsDao _quotaCreditsDao;\n+    @Inject\n+    private QuotaUsageDao _quotaUsageDao;\n+    @Inject\n+    private QuotaEmailTemplatesDao _quotaEmailTemplateDao;\n+\n+    @Inject\n+    private UserDao _userDao;\n+    @Inject\n+    private QuotaService _quotaService;\n+    @Inject\n+    private AccountDao _accountDao;\n+    @Inject\n+    private QuotaAccountDao _quotaAccountDao;\n+    @Inject\n+    private DomainDao _domainDao;\n+    @Inject\n+    private RegionManager _regionMgr;\n+    @Inject\n+    private QuotaStatement _statement;\n+\n+    @Override\n+    public QuotaTariffResponse createQuotaTariffResponse(QuotaTariffVO tariff) {\n+        final QuotaTariffResponse response = new QuotaTariffResponse();\n+        response.setUsageType(tariff.getUsageType());\n+        response.setUsageName(tariff.getUsageName());\n+        response.setUsageUnit(tariff.getUsageUnit());\n+        response.setUsageDiscriminator(tariff.getUsageDiscriminator());\n+        response.setTariffValue(tariff.getCurrencyValue());\n+        response.setEffectiveOn(tariff.getEffectiveOn());\n+        response.setDescription(tariff.getDescription());\n+        response.setCurrency(QuotaConfig.QuotaCurrencySymbol.value());\n+        return response;\n+    }\n+\n+    @Override\n+    public List<QuotaSummaryResponse> createQuotaSummaryResponse(final String accountName, final Long domainId) {\n+        List<QuotaSummaryResponse> result = new ArrayList<QuotaSummaryResponse>();\n+\n+        if (accountName != null && domainId != null) {\n+            Account account = _accountDao.findActiveAccount(accountName, domainId);\n+            QuotaSummaryResponse qr = getQuotaSummaryResponse(account);\n+            result.add(qr);\n+        }\n+\n+        return result;\n+    }\n+\n+    @Override\n+    public List<QuotaSummaryResponse> createQuotaSummaryResponse(Boolean listAll) {\n+        List<QuotaSummaryResponse> result = new ArrayList<QuotaSummaryResponse>();\n+\n+        if (listAll) {\n+            for (final AccountVO account : _accountDao.listAll()) {\n+                QuotaSummaryResponse qr = getQuotaSummaryResponse(account);\n+                result.add(qr);\n+            }\n+        } else {\n+            for (final QuotaAccountVO quotaAccount : _quotaAccountDao.listAllQuotaAccount()) {\n+                AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                QuotaSummaryResponse qr = getQuotaSummaryResponse(account);\n+                result.add(qr);\n+            }\n+        }\n+        return result;\n+    }\n+\n+    private QuotaSummaryResponse getQuotaSummaryResponse(final Account account) {\n+        Calendar[] period = _statement.getCurrentStatementTime();\n+\n+        if (account != null) {\n+            QuotaSummaryResponse qr = new QuotaSummaryResponse();\n+            DomainVO domain = _domainDao.findById(account.getDomainId());\n+            BigDecimal curBalance = _quotaBalanceDao.lastQuotaBalance(account.getAccountId(), account.getDomainId(), period[1].getTime());\n+            BigDecimal quotaUsage = _quotaUsageDao.findTotalQuotaUsage(account.getAccountId(), account.getDomainId(), null, period[0].getTime(), period[1].getTime());\n+\n+            qr.setAccountId(account.getAccountId());\n+            qr.setAccountName(account.getAccountName());\n+            qr.setDomainId(account.getDomainId());\n+            qr.setDomainName(domain.getName());\n+            qr.setBalance(curBalance);\n+            qr.setQuotaUsage(quotaUsage);\n+            qr.setState(account.getState());\n+            qr.setStartDate(period[0].getTime());\n+            qr.setEndDate(period[1].getTime());\n+            qr.setCurrency(QuotaConfig.QuotaCurrencySymbol.value());\n+            qr.setObjectName(\"summary\");\n+            return qr;\n+        } else {\n+            throw new InvalidParameterValueException(\"Quota summary response for an account requires a valid account.\");\n+        }\n+    }\n+\n+    @Override\n+    public QuotaBalanceResponse createQuotaBalanceResponse(List<QuotaBalanceVO> quotaBalance, Date startDate, Date endDate) {\n+        if (quotaBalance == null || quotaBalance.isEmpty()) {\n+            new InvalidParameterValueException(\"The request period does not contain balance entries.\");\n+        }\n+        Collections.sort(quotaBalance, new Comparator<QuotaBalanceVO>() {\n+            public int compare(QuotaBalanceVO o1, QuotaBalanceVO o2) {\n+                return o2.getUpdatedOn().compareTo(o1.getUpdatedOn()); // desc\n+            }\n+        });\n+\n+        boolean have_balance_entries = false;\n+        //check that there is at least one balance entry\n+        for (Iterator<QuotaBalanceVO> it = quotaBalance.iterator(); it.hasNext();) {\n+            QuotaBalanceVO entry = it.next();\n+            if (entry.getCreditsId() > 0) {\n+                have_balance_entries = true;\n+                break;\n+            }\n+        }\n+        //if last entry is a credit deposit then remove that as that is already\n+        //accounted for in the starting balance after that entry, note the sort is desc\n+        if (have_balance_entries) {\n+            ListIterator<QuotaBalanceVO> li = quotaBalance.listIterator(quotaBalance.size());\n+            // Iterate in reverse.\n+            while (li.hasPrevious()) {\n+                QuotaBalanceVO entry = li.previous();\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"createQuotaBalanceResponse: Entry=\" + entry);\n+                }\n+                if (entry.getCreditsId() > 0) {\n+                    li.remove();\n+                } else {\n+                    break;\n+                }\n+            }\n+        }\n+\n+        int quota_activity = quotaBalance.size();\n+        QuotaBalanceResponse resp = new QuotaBalanceResponse();\n+        BigDecimal lastCredits = new BigDecimal(0);\n+        boolean consecutive = true;\n+        for (Iterator<QuotaBalanceVO> it = quotaBalance.iterator(); it.hasNext();) {\n+            QuotaBalanceVO entry = it.next();\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"createQuotaBalanceResponse: All Credit Entry=\" + entry);\n+            }\n+            if (entry.getCreditsId() > 0) {\n+                if (consecutive) {\n+                    lastCredits = lastCredits.add(entry.getCreditBalance());\n+                }\n+                resp.addCredits(entry);\n+                it.remove();\n+            } else {\n+                consecutive = false;\n+            }\n+        }\n+\n+        if (quota_activity > 0 && quotaBalance.size() > 0) {\n+            // order is desc last item is the start item\n+            QuotaBalanceVO startItem = quotaBalance.get(quotaBalance.size() - 1);\n+            QuotaBalanceVO endItem = quotaBalance.get(0);\n+            resp.setStartDate(startItem.getUpdatedOn());\n+            resp.setStartQuota(startItem.getCreditBalance());\n+            resp.setEndDate(endItem.getUpdatedOn());\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"createQuotaBalanceResponse: Start Entry=\" + startItem);\n+                s_logger.debug(\"createQuotaBalanceResponse: End Entry=\" + endItem);\n+            }\n+            resp.setEndQuota(endItem.getCreditBalance().add(lastCredits));\n+        } else if (quota_activity > 0) {\n+            // order is desc last item is the start item\n+            resp.setStartDate(startDate);\n+            resp.setStartQuota(new BigDecimal(0));\n+            resp.setEndDate(endDate);\n+            resp.setEndQuota(new BigDecimal(0).add(lastCredits));\n+        } else {\n+            resp.setStartDate(startDate);\n+            resp.setEndDate(endDate);\n+            resp.setStartQuota(new BigDecimal(0));\n+            resp.setEndQuota(new BigDecimal(0));\n+        }\n+        resp.setCurrency(QuotaConfig.QuotaCurrencySymbol.value());\n+        resp.setObjectName(\"balance\");\n+        return resp;\n+    }\n+\n+    @Override\n+    public QuotaStatementResponse createQuotaStatementResponse(final List<QuotaUsageVO> quotaUsage) {\n+        if (quotaUsage == null || quotaUsage.isEmpty()) {\n+            throw new InvalidParameterValueException(\"There is no usage data found for period mentioned.\");\n+        }\n+\n+        QuotaStatementResponse statement = new QuotaStatementResponse();\n+\n+        HashMap<Integer, QuotaTypes> quotaTariffMap = new HashMap<Integer, QuotaTypes>();\n+        Collection<QuotaTypes> result = QuotaTypes.listQuotaTypes().values();\n+\n+        for (QuotaTypes quotaTariff : result) {\n+            quotaTariffMap.put(quotaTariff.getQuotaType(), quotaTariff);\n+            // add dummy record for each usage type\n+            QuotaUsageVO dummy = new QuotaUsageVO(quotaUsage.get(0));\n+            dummy.setUsageType(quotaTariff.getQuotaType());\n+            dummy.setQuotaUsed(new BigDecimal(0));\n+            quotaUsage.add(dummy);\n+        }\n+\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\n+                    \"createQuotaStatementResponse Type=\" + quotaUsage.get(0).getUsageType() + \" usage=\" + quotaUsage.get(0).getQuotaUsed().setScale(2, RoundingMode.HALF_EVEN)\n+                            + \" rec.id=\" + quotaUsage.get(0).getUsageItemId() + \" SD=\" + quotaUsage.get(0).getStartDate() + \" ED=\" + quotaUsage.get(0).getEndDate());\n+        }\n+\n+        Collections.sort(quotaUsage, new Comparator<QuotaUsageVO>() {\n+            public int compare(QuotaUsageVO o1, QuotaUsageVO o2) {\n+                if (o1.getUsageType() == o2.getUsageType())\n+                    return 0;\n+                return o1.getUsageType() < o2.getUsageType() ? -1 : 1;\n+            }\n+        });\n+\n+        List<QuotaStatementItemResponse> items = new ArrayList<QuotaStatementItemResponse>();\n+        QuotaStatementItemResponse lineitem;\n+        int type = -1;\n+        BigDecimal usage = new BigDecimal(0);\n+        BigDecimal totalUsage = new BigDecimal(0);\n+        quotaUsage.add(new QuotaUsageVO());// boundary\n+        QuotaUsageVO prev = quotaUsage.get(0);\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"createQuotaStatementResponse record count=\" + quotaUsage.size());\n+        }\n+        for (final QuotaUsageVO quotaRecord : quotaUsage) {\n+            if (type != quotaRecord.getUsageType()) {\n+                if (type != -1) {\n+                    lineitem = new QuotaStatementItemResponse(type);\n+                    lineitem.setQuotaUsed(usage);\n+                    lineitem.setAccountId(prev.getAccountId());\n+                    lineitem.setDomainId(prev.getDomainId());\n+                    lineitem.setUsageUnit(quotaTariffMap.get(type).getQuotaUnit());\n+                    lineitem.setUsageName(quotaTariffMap.get(type).getQuotaName());\n+                    lineitem.setObjectName(\"quotausage\");\n+                    items.add(lineitem);\n+                    totalUsage = totalUsage.add(usage);\n+                    usage = new BigDecimal(0);\n+                }\n+                type = quotaRecord.getUsageType();\n+            }\n+            prev = quotaRecord;\n+            usage = usage.add(quotaRecord.getQuotaUsed());\n+        }\n+\n+        statement.setLineItem(items);\n+        statement.setTotalQuota(totalUsage);\n+        statement.setCurrency(QuotaConfig.QuotaCurrencySymbol.value());\n+        statement.setObjectName(\"statement\");\n+        return statement;\n+    }\n+\n+    @Override\n+    public List<QuotaTariffVO> listQuotaTariffPlans(final QuotaTariffListCmd cmd) {\n+        List<QuotaTariffVO> result = new ArrayList<QuotaTariffVO>();\n+        Date effectiveDate = cmd.getEffectiveDate() == null ? new Date() : cmd.getEffectiveDate();\n+        Date adjustedEffectiveDate = _quotaService.computeAdjustedTime(effectiveDate);\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Effective datec=\" + effectiveDate + \" quotatype=\" + cmd.getUsageType() + \" Adjusted date=\" + adjustedEffectiveDate);\n+        }\n+        if (cmd.getUsageType() != null) {\n+            QuotaTariffVO tariffPlan = _quotaTariffDao.findTariffPlanByUsageType(cmd.getUsageType(), adjustedEffectiveDate);\n+            if (tariffPlan != null) {\n+                result.add(tariffPlan);\n+            }\n+        } else {\n+            result = _quotaTariffDao.listAllTariffPlans(adjustedEffectiveDate);\n+        }\n+        return result;\n+    }\n+\n+    @Override\n+    public QuotaTariffVO updateQuotaTariffPlan(QuotaTariffUpdateCmd cmd) {\n+        final int quotaType = cmd.getUsageType();\n+        final BigDecimal quotaCost = new BigDecimal(cmd.getValue());\n+        final Date effectiveDate = _quotaService.computeAdjustedTime(cmd.getStartDate());\n+        final Date now = _quotaService.computeAdjustedTime(new Date());\n+        // if effective date is in the past return error\n+        if (effectiveDate.compareTo(now) < 0) {\n+            throw new InvalidParameterValueException(\"Incorrect effective date for tariff \" + effectiveDate + \" is less than now \" + now);\n+        }\n+        QuotaTypes quotaConstant = QuotaTypes.listQuotaTypes().get(quotaType);\n+        if (quotaConstant == null) {\n+            throw new InvalidParameterValueException(\"Quota type does not exists \" + quotaType);\n+        }\n+\n+        QuotaTariffVO result = null;\n+        result = new QuotaTariffVO(quotaType);\n+        result.setUsageName(quotaConstant.getQuotaName());\n+        result.setUsageUnit(quotaConstant.getQuotaUnit());\n+        result.setUsageDiscriminator(quotaConstant.getDiscriminator());\n+        result.setCurrencyValue(quotaCost);\n+        result.setEffectiveOn(effectiveDate);\n+        result.setUpdatedOn(now);\n+        result.setUpdatedBy(cmd.getEntityOwnerId());\n+\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(String.format(\"Updating Quota Tariff Plan: New value=%s for resource type=%d effective on date=%s\", quotaCost, quotaType, effectiveDate));\n+        }\n+        _quotaTariffDao.addQuotaTariff(result);\n+\n+        return result;\n+    }\n+\n+    @Override\n+    public QuotaCreditsResponse addQuotaCredits(Long accountId, Long domainId, Double amount, Long updatedBy) {\n+        Date depositDate = new Date();\n+        Date adjustedStartDate = _quotaService.computeAdjustedTime(depositDate);\n+        QuotaBalanceVO qb = _quotaBalanceDao.findLaterBalanceEntry(accountId, domainId, adjustedStartDate);\n+\n+        if (qb != null) {\n+            throw new InvalidParameterValueException(\"Incorrect deposit date: \" + adjustedStartDate + \" there are balance entries after this date\");\n+        }\n+\n+        return addQuotaCredits(accountId, domainId, amount, updatedBy, adjustedStartDate);\n+    }\n+\n+    @Override\n+    public QuotaCreditsResponse addQuotaCredits(final Long accountId, final Long domainId, final Double amount, final Long updatedBy, final Date despositedOn) {\n+\n+        QuotaCreditsVO credits = new QuotaCreditsVO(accountId, domainId, new BigDecimal(amount), updatedBy);\n+        s_logger.debug(\"AddQuotaCredits: Depositing \" + amount + \" on adjusted date \" + despositedOn);\n+        credits.setUpdatedOn(despositedOn);\n+        QuotaCreditsVO result = _quotaCreditsDao.saveCredits(credits);\n+\n+        final AccountVO account = _accountDao.findById(accountId);\n+        final boolean lockAccountEnforcement = \"true\".equalsIgnoreCase(QuotaConfig.QuotaEnableEnforcement.value());\n+        final BigDecimal currentAccountBalance = _quotaBalanceDao.lastQuotaBalance(accountId, domainId, startOfNextDay(despositedOn));\n+        if (lockAccountEnforcement && (currentAccountBalance.compareTo(new BigDecimal(0)) >= 0)) {\n+            if (account.getState() == Account.State.locked) {\n+                _regionMgr.enableAccount(account.getAccountName(), domainId, accountId);\n+            }\n+        }\n+\n+        String creditor = String.valueOf(Account.ACCOUNT_ID_SYSTEM);\n+        User creditorUser = _userDao.getUser(updatedBy);\n+        if (creditorUser != null) {\n+            creditor = creditorUser.getUsername();\n+        }\n+        QuotaCreditsResponse response = new QuotaCreditsResponse(result, creditor);\n+        response.setCurrency(QuotaConfig.QuotaCurrencySymbol.value());\n+        return response;\n+    }\n+\n+    private QuotaEmailTemplateResponse createQuotaEmailResponse(QuotaEmailTemplatesVO template) {\n+        QuotaEmailTemplateResponse response = new QuotaEmailTemplateResponse();\n+        response.setTemplateType(template.getTemplateName());\n+        response.setTemplateSubject(template.getTemplateSubject());\n+        response.setTemplateText(template.getTemplateBody());\n+        response.setLocale(template.getLocale());\n+        response.setLastUpdatedOn(template.getLastUpdated());\n+        return response;\n+    }\n+\n+    @Override\n+    public List<QuotaEmailTemplateResponse> listQuotaEmailTemplates(QuotaEmailTemplateListCmd cmd) {\n+        final String templateName = cmd.getTemplateName();\n+        List<QuotaEmailTemplatesVO> templates = _quotaEmailTemplateDao.listAllQuotaEmailTemplates(templateName);\n+        final List<QuotaEmailTemplateResponse> responses = new ArrayList<QuotaEmailTemplateResponse>();\n+        for (final QuotaEmailTemplatesVO template : templates) {\n+            responses.add(createQuotaEmailResponse(template));\n+        }\n+        return responses;\n+    }\n+\n+    @Override\n+    public boolean updateQuotaEmailTemplate(QuotaEmailTemplateUpdateCmd cmd) {\n+        final String templateName = cmd.getTemplateName();\n+        final String templateSubject = StringEscapeUtils.escapeJavaScript(cmd.getTemplateSubject());\n+        final String templateBody = StringEscapeUtils.escapeJavaScript(cmd.getTemplateBody());\n+        final String locale = cmd.getLocale();\n+\n+        final List<QuotaEmailTemplatesVO> templates = _quotaEmailTemplateDao.listAllQuotaEmailTemplates(templateName);\n+        if (templates.size() == 1) {\n+            final QuotaEmailTemplatesVO template = templates.get(0);\n+            template.setTemplateSubject(templateSubject);\n+            template.setTemplateBody(templateBody);\n+            if (locale != null) {\n+                template.setLocale(locale);\n+            }\n+            return _quotaEmailTemplateDao.updateQuotaEmailTemplate(template);\n+        }\n+        return false;\n+    }\n+\n+    @Override\n+    public QuotaBalanceResponse createQuotaLastBalanceResponse(List<QuotaBalanceVO> quotaBalance, Date startDate) {\n+        if (quotaBalance == null) {\n+            throw new InvalidParameterValueException(\"There are no balance entries on or before the requested date.\");\n+        }\n+        if (startDate == null) {\n+            startDate = new Date();\n+        }\n+        QuotaBalanceResponse resp = new QuotaBalanceResponse();\n+        BigDecimal lastCredits = new BigDecimal(0);\n+        for (QuotaBalanceVO entry : quotaBalance) {\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"createQuotaLastBalanceResponse Date=\" + entry.getUpdatedOn() + \" balance=\" + entry.getCreditBalance() + \" credit=\" + entry.getCreditsId());\n+            }\n+            lastCredits = lastCredits.add(entry.getCreditBalance());\n+        }\n+        resp.setStartQuota(lastCredits);\n+        resp.setStartDate(_quotaService.computeAdjustedTime(startDate));\n+        resp.setCurrency(QuotaConfig.QuotaCurrencySymbol.value());\n+        resp.setObjectName(\"balance\");\n+        return resp;\n+    }\n+\n+    @Override\n+    public List<QuotaUsageVO> getQuotaUsage(QuotaStatementCmd cmd) {\n+        return _quotaService.getQuotaUsage(cmd.getAccountId(), cmd.getAccountName(), cmd.getDomainId(), cmd.getUsageType(), cmd.getStartDate(), cmd.getEndDate());\n+    }\n+\n+    @Override\n+    public List<QuotaBalanceVO> getQuotaBalance(QuotaBalanceCmd cmd) {\n+        return _quotaService.findQuotaBalanceVO(cmd.getAccountId(), cmd.getAccountName(), cmd.getDomainId(), cmd.getStartDate(), cmd.getEndDate());\n+    }\n+\n+    @Override\n+    public Date startOfNextDay(Date dt) {\n+        Calendar c = Calendar.getInstance();\n+        c.setTime(dt);\n+        c.add(Calendar.DATE, 1);\n+        dt = c.getTime();\n+        return dt;\n+    }\n+\n+    @Override\n+    public Date startOfNextDay() {\n+        Calendar c = Calendar.getInstance();\n+        c.setTime(new Date());\n+        c.add(Calendar.DATE, 1);\n+        Date dt = c.getTime();\n+        return dt;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "sha": "23b136363c1f3b07bd3c40b9025a6f90ad5bd1c7",
                "status": "added"
            },
            {
                "additions": 118,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementItemResponse.java",
                "changes": 118,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementItemResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementItemResponse.java",
                "patch": "@@ -0,0 +1,118 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import com.cloud.serializer.Param;\n+\n+public class QuotaStatementItemResponse extends BaseResponse {\n+\n+    @SerializedName(\"type\")\n+    @Param(description = \"usage type\")\n+    private int usageType;\n+\n+    @SerializedName(\"accountid\")\n+    @Param(description = \"account id\")\n+    private Long accountId;\n+\n+    @SerializedName(\"account\")\n+    @Param(description = \"account name\")\n+    private String accountName;\n+\n+    @SerializedName(\"domain\")\n+    @Param(description = \"domain id\")\n+    private Long domainId;\n+\n+    @SerializedName(\"name\")\n+    @Param(description = \"usage type name\")\n+    private String usageName;\n+\n+    @SerializedName(\"unit\")\n+    @Param(description = \"usage unit\")\n+    private String usageUnit;\n+\n+    @SerializedName(\"quota\")\n+    @Param(description = \"quota consumed\")\n+    private BigDecimal quotaUsed;\n+\n+    public QuotaStatementItemResponse(final int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public String getUsageName() {\n+        return usageName;\n+    }\n+\n+    public void setUsageName(String usageName) {\n+        this.usageName = usageName;\n+    }\n+\n+    public int getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public String getUsageUnit() {\n+        return usageUnit;\n+    }\n+\n+    public void setUsageUnit(String usageUnit) {\n+        this.usageUnit = usageUnit;\n+    }\n+\n+    public BigDecimal getQuotaUsed() {\n+        return quotaUsed;\n+    }\n+\n+    public void setQuotaUsed(BigDecimal quotaUsed) {\n+        this.quotaUsed = quotaUsed.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementItemResponse.java",
                "sha": "dec67606a164466fd49dbf4c983ba7aa529cbfa3",
                "status": "added"
            },
            {
                "additions": 130,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementResponse.java",
                "changes": 130,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementResponse.java",
                "patch": "@@ -0,0 +1,130 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.Date;\n+import java.util.List;\n+\n+public class QuotaStatementResponse  extends BaseResponse {\n+\n+    @SerializedName(\"accountid\")\n+    @Param(description = \"account id\")\n+    private Long accountId;\n+\n+    @SerializedName(\"account\")\n+    @Param(description = \"account name\")\n+    private String accountName;\n+\n+    @SerializedName(\"domain\")\n+    @Param(description = \"domain id\")\n+    private Long domainId;\n+\n+    @SerializedName(\"quotausage\")\n+    @Param(description = \"list of quota usage under various types\", responseObject = QuotaStatementItemResponse.class)\n+    private List<QuotaStatementItemResponse> lineItem;\n+\n+    @SerializedName(\"totalquota\")\n+    @Param(description = \"total quota used during this period\")\n+    private BigDecimal totalQuota;\n+\n+    @SerializedName(\"startdate\")\n+    @Param(description = \"start date\")\n+    private Date startDate = null;\n+\n+    @SerializedName(\"enddate\")\n+    @Param(description = \"end date\")\n+    private Date endDate = null;\n+\n+    @SerializedName(\"currency\")\n+    @Param(description = \"currency\")\n+    private String currency;\n+\n+    public QuotaStatementResponse() {\n+        super();\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public List<QuotaStatementItemResponse> getLineItem() {\n+        return lineItem;\n+    }\n+\n+    public void setLineItem(List<QuotaStatementItemResponse> lineItem) {\n+        this.lineItem = lineItem;\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate = startDate == null ? null : new Date(startDate.getTime());\n+    }\n+\n+    public Date getEndDate() {\n+        return endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ? null : new Date(endDate.getTime());\n+    }\n+\n+\n+    public BigDecimal getTotalQuota() {\n+        return totalQuota;\n+    }\n+\n+    public void setTotalQuota(BigDecimal totalQuota) {\n+        this.totalQuota = totalQuota.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+    public String getCurrency() {\n+        return currency;\n+    }\n+\n+    public void setCurrency(String currency) {\n+        this.currency = currency;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaStatementResponse.java",
                "sha": "efe8e8ecac060579aeca9d69249166788a8836f4",
                "status": "added"
            },
            {
                "additions": 155,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaSummaryResponse.java",
                "changes": 155,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaSummaryResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaSummaryResponse.java",
                "patch": "@@ -0,0 +1,155 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import java.math.BigDecimal;\n+import java.math.RoundingMode;\n+import java.util.Date;\n+\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import com.cloud.serializer.Param;\n+import com.cloud.user.Account.State;\n+\n+public class QuotaSummaryResponse extends BaseResponse {\n+\n+    @SerializedName(\"accountid\")\n+    @Param(description = \"account id\")\n+    private Long accountId;\n+\n+    @SerializedName(\"account\")\n+    @Param(description = \"account name\")\n+    private String accountName;\n+\n+    @SerializedName(\"domainid\")\n+    @Param(description = \"domain id\")\n+    private Long domainId;\n+\n+    @SerializedName(\"domain\")\n+    @Param(description = \"domain name\")\n+    private String domainName;\n+\n+    @SerializedName(\"balance\")\n+    @Param(description = \"account balance\")\n+    private BigDecimal balance;\n+\n+    @SerializedName(\"state\")\n+    @Param(description = \"account state\")\n+    private State state;\n+\n+    @SerializedName(\"quota\")\n+    @Param(description = \"quota usage of this period\")\n+    private BigDecimal quotaUsage;\n+\n+    @SerializedName(\"startdate\")\n+    @Param(description = \"start date\")\n+    private Date startDate = null;\n+\n+    @SerializedName(\"enddate\")\n+    @Param(description = \"end date\")\n+    private Date endDate = null;\n+\n+    @SerializedName(\"currency\")\n+    @Param(description = \"currency\")\n+    private String currency;\n+\n+    public QuotaSummaryResponse() {\n+        super();\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n+    public void setAccountId(Long accountId) {\n+        this.accountId = accountId;\n+    }\n+\n+    public String getAccountName() {\n+        return accountName;\n+    }\n+\n+    public void setAccountName(String accountName) {\n+        this.accountName = accountName;\n+    }\n+\n+    public Long getDomainId() {\n+        return domainId;\n+    }\n+\n+    public void setDomainId(Long domainId) {\n+        this.domainId = domainId;\n+    }\n+\n+    public String getDomainName() {\n+        return domainName;\n+    }\n+\n+    public void setDomainName(String domainName) {\n+        this.domainName = domainName;\n+    }\n+\n+    public BigDecimal getQuotaUsage() {\n+        return quotaUsage;\n+    }\n+\n+    public State getState() {\n+        return state;\n+    }\n+\n+    public void setState(State state) {\n+        this.state = state;\n+    }\n+\n+    public void setQuotaUsage(BigDecimal startQuota) {\n+        this.quotaUsage = startQuota.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+    public BigDecimal getBalance() {\n+        return balance;\n+    }\n+\n+    public void setBalance(BigDecimal balance) {\n+        this.balance = balance.setScale(2, RoundingMode.HALF_EVEN);\n+    }\n+\n+    public Date getStartDate() {\n+        return startDate == null ?  null : new Date(startDate.getTime());\n+    }\n+\n+    public void setStartDate(Date startDate) {\n+        this.startDate =  startDate == null ?  null : new Date(startDate.getTime());\n+    }\n+\n+    public Date getEndDate() {\n+        return  endDate == null ?  null : new Date(endDate.getTime());\n+    }\n+\n+    public void setEndDate(Date endDate) {\n+        this.endDate = endDate == null ?  null : new Date(endDate.getTime());\n+    }\n+\n+    public String getCurrency() {\n+        return currency;\n+    }\n+\n+    public void setCurrency(String currency) {\n+        this.currency = currency;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaSummaryResponse.java",
                "sha": "4e6f684c606ee6f262567b846b37b6f0ea6497eb",
                "status": "added"
            },
            {
                "additions": 134,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTariffResponse.java",
                "changes": 134,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTariffResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTariffResponse.java",
                "patch": "@@ -0,0 +1,134 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+public class QuotaTariffResponse extends BaseResponse {\n+\n+    @SerializedName(\"usageType\")\n+    @Param(description = \"usageType\")\n+    private int usageType;\n+\n+    @SerializedName(\"usageName\")\n+    @Param(description = \"usageName\")\n+    private String usageName;\n+\n+    @SerializedName(\"usageUnit\")\n+    @Param(description = \"usageUnit\")\n+    private String usageUnit;\n+\n+    @SerializedName(\"usageDiscriminator\")\n+    @Param(description = \"usageDiscriminator\")\n+    private String usageDiscriminator;\n+\n+    @SerializedName(\"tariffValue\")\n+    @Param(description = \"tariffValue\")\n+    private BigDecimal tariffValue;\n+\n+    @SerializedName(\"effectiveDate\")\n+    @Param(description = \"the date on/after which this quota value will be effective\")\n+    private Date effectiveOn = null;\n+\n+    @SerializedName(\"description\")\n+    @Param(description = \"description\")\n+    private String description;\n+\n+    @SerializedName(\"currency\")\n+    @Param(description = \"currency\")\n+    private String currency;\n+\n+    public QuotaTariffResponse() {\n+        super();\n+        this.setObjectName(\"quotatariff\");\n+    }\n+\n+    public QuotaTariffResponse(final int usageType) {\n+        super();\n+        this.usageType = usageType;\n+    }\n+\n+    public String getUsageName() {\n+        return usageName;\n+    }\n+\n+    public void setUsageName(String usageName) {\n+        this.usageName = usageName;\n+    }\n+\n+    public int getUsageType() {\n+        return usageType;\n+    }\n+\n+    public void setUsageType(int usageType) {\n+        this.usageType = usageType;\n+    }\n+\n+    public String getUsageUnit() {\n+        return usageUnit;\n+    }\n+\n+    public void setUsageUnit(String usageUnit) {\n+        this.usageUnit = usageUnit;\n+    }\n+\n+    public String getUsageDiscriminator() {\n+        return usageDiscriminator;\n+    }\n+\n+    public void setUsageDiscriminator(String usageDiscriminator) {\n+        this.usageDiscriminator = usageDiscriminator;\n+    }\n+\n+    public BigDecimal getTariffValue() {\n+        return tariffValue;\n+    }\n+\n+    public void setTariffValue(BigDecimal tariffValue) {\n+        this.tariffValue = tariffValue;\n+    }\n+\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    public void setDescription(String description) {\n+        this.description = description;\n+    }\n+\n+    public Date getEffectiveOn() {\n+        return effectiveOn;\n+    }\n+\n+    public void setEffectiveOn(Date effectiveOn) {\n+        this.effectiveOn = effectiveOn;\n+    }\n+\n+    public String getCurrency() {\n+        return currency;\n+    }\n+\n+    public void setCurrency(String currency) {\n+        this.currency = currency;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTariffResponse.java",
                "sha": "48697fd2a822924e398bb80ff6c360f0e9198357",
                "status": "added"
            },
            {
                "additions": 58,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTypeResponse.java",
                "changes": 58,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTypeResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTypeResponse.java",
                "patch": "@@ -0,0 +1,58 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import com.cloud.serializer.Param;\n+\n+public class QuotaTypeResponse extends BaseResponse {\n+\n+    @SerializedName(\"quotatypeid\")\n+    @Param(description = \"quota type\")\n+    private Integer quotaType;\n+\n+    @SerializedName(ApiConstants.DESCRIPTION)\n+    @Param(description = \"description of usage type\")\n+    private String description;\n+\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    public void setDescription(String description) {\n+        this.description = description;\n+    }\n+\n+    public Integer getQuotaType() {\n+        return quotaType;\n+    }\n+\n+    public void setQuotaType(Integer quotaType) {\n+        this.quotaType = quotaType;\n+    }\n+\n+    public QuotaTypeResponse(Integer quotaType, String description) {\n+        this.quotaType = quotaType;\n+        this.description = description;\n+        setObjectName(ApiConstants.USAGE_TYPE);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaTypeResponse.java",
                "sha": "989fba54e7f20a34af661b650e9f5ff706b5af44",
                "status": "added"
            },
            {
                "additions": 38,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaUpdateResponse.java",
                "changes": 38,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaUpdateResponse.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaUpdateResponse.java",
                "patch": "@@ -0,0 +1,38 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.serializer.Param;\n+import com.google.gson.annotations.SerializedName;\n+\n+import org.apache.cloudstack.api.BaseResponse;\n+\n+import java.util.Calendar;\n+import java.util.Date;\n+\n+public class QuotaUpdateResponse extends BaseResponse {\n+\n+    @SerializedName(\"updated_on\")\n+    @Param(description = \"timestamp when the run got over\")\n+    private Date updatedOn;\n+\n+    public QuotaUpdateResponse(Calendar now) {\n+        super();\n+        updatedOn=now.getTime();\n+    }\n+\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaUpdateResponse.java",
                "sha": "e98da9b0004e8663ae6255545ae3cef9a41591cc",
                "status": "added"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/quota/QuotaService.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/quota/QuotaService.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/quota/QuotaService.java",
                "patch": "@@ -0,0 +1,39 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.utils.component.PluggableService;\n+\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+\n+import java.util.Date;\n+import java.util.List;\n+\n+public interface QuotaService extends PluggableService {\n+\n+    List<QuotaUsageVO> getQuotaUsage(Long accountId, String accountName, Long domainId, Integer usageType, Date startDate, Date endDate);\n+\n+    List<QuotaBalanceVO> findQuotaBalanceVO(Long accountId, String accountName, Long domainId, Date startDate, Date endDate);\n+\n+    Date computeAdjustedTime(Date date);\n+\n+    void setLockAccount(Long accountId, Boolean state);\n+\n+    void setMinBalance(Long accountId, Double balance);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/quota/QuotaService.java",
                "sha": "8ee39b878aff037a85722629a958c07b7073262d",
                "status": "added"
            },
            {
                "additions": 299,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/quota/QuotaServiceImpl.java",
                "changes": 299,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/quota/QuotaServiceImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/quota/QuotaServiceImpl.java",
                "patch": "@@ -0,0 +1,299 @@\n+//Licensed to the Apache Software Foundation (ASF) under one\n+//or more contributor license agreements.  See the NOTICE file\n+//distributed with this work for additional information\n+//regarding copyright ownership.  The ASF licenses this file\n+//to you under the Apache License, Version 2.0 (the\n+//\"License\"); you may not use this file except in compliance\n+//with the License.  You may obtain a copy of the License at\n+//\n+//http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//Unless required by applicable law or agreed to in writing,\n+//software distributed under the License is distributed on an\n+//\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+//KIND, either express or implied.  See the License for the\n+//specific language governing permissions and limitations\n+//under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.configuration.Config;\n+import com.cloud.domain.dao.DomainDao;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.exception.PermissionDeniedException;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.component.ManagerBase;\n+import com.cloud.utils.db.Filter;\n+\n+import org.apache.cloudstack.api.command.QuotaBalanceCmd;\n+import org.apache.cloudstack.api.command.QuotaCreditsCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateUpdateCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateListCmd;\n+import org.apache.cloudstack.api.command.QuotaStatementCmd;\n+import org.apache.cloudstack.api.command.QuotaSummaryCmd;\n+import org.apache.cloudstack.api.command.QuotaTariffListCmd;\n+import org.apache.cloudstack.api.command.QuotaTariffUpdateCmd;\n+import org.apache.cloudstack.api.command.QuotaUpdateCmd;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.cloudstack.framework.config.ConfigKey;\n+import org.apache.cloudstack.framework.config.Configurable;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaBalanceDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.apache.cloudstack.utils.usage.UsageUtils;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n+\n+import javax.ejb.Local;\n+import javax.inject.Inject;\n+import javax.naming.ConfigurationException;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TimeZone;\n+\n+@Component\n+@Local(value = QuotaService.class)\n+public class QuotaServiceImpl extends ManagerBase implements QuotaService, Configurable, QuotaConfig {\n+    private static final Logger s_logger = Logger.getLogger(QuotaServiceImpl.class);\n+\n+    @Inject\n+    private AccountDao _accountDao;\n+    @Inject\n+    private QuotaAccountDao _quotaAcc;\n+    @Inject\n+    private QuotaUsageDao _quotaUsageDao;\n+    @Inject\n+    private DomainDao _domainDao;\n+    @Inject\n+    private ConfigurationDao _configDao;\n+    @Inject\n+    private QuotaBalanceDao _quotaBalanceDao;\n+    @Inject\n+    private QuotaResponseBuilder _respBldr;\n+\n+    private TimeZone _usageTimezone;\n+    private int _aggregationDuration = 0;\n+\n+    public QuotaServiceImpl() {\n+        super();\n+    }\n+\n+    @Override\n+    public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n+        super.configure(name, params);\n+        String timeZoneStr = _configDao.getValue(Config.UsageAggregationTimezone.toString());\n+        String aggregationRange = _configDao.getValue(Config.UsageStatsJobAggregationRange.toString());\n+        if (timeZoneStr == null) {\n+            timeZoneStr = \"GMT\";\n+        }\n+        _usageTimezone = TimeZone.getTimeZone(timeZoneStr);\n+\n+        _aggregationDuration = Integer.parseInt(aggregationRange);\n+        if (_aggregationDuration < UsageUtils.USAGE_AGGREGATION_RANGE_MIN) {\n+            s_logger.warn(\"Usage stats job aggregation range is to small, using the minimum value of \" + UsageUtils.USAGE_AGGREGATION_RANGE_MIN);\n+            _aggregationDuration = UsageUtils.USAGE_AGGREGATION_RANGE_MIN;\n+        }\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Usage timezone = \" + _usageTimezone + \" AggregationDuration=\" + _aggregationDuration);\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public List<Class<?>> getCommands() {\n+        final List<Class<?>> cmdList = new ArrayList<Class<?>>();\n+        if (!isQuotaServiceEnabled()) {\n+            return cmdList;\n+        }\n+        cmdList.add(QuotaStatementCmd.class);\n+        cmdList.add(QuotaBalanceCmd.class);\n+        cmdList.add(QuotaSummaryCmd.class);\n+        cmdList.add(QuotaUpdateCmd.class);\n+        cmdList.add(QuotaTariffListCmd.class);\n+        cmdList.add(QuotaTariffUpdateCmd.class);\n+        cmdList.add(QuotaCreditsCmd.class);\n+        cmdList.add(QuotaEmailTemplateListCmd.class);\n+        cmdList.add(QuotaEmailTemplateUpdateCmd.class);\n+        return cmdList;\n+    }\n+\n+    @Override\n+    public String getConfigComponentName() {\n+        return \"QUOTA-PLUGIN\";\n+    }\n+\n+    @Override\n+    public ConfigKey<?>[] getConfigKeys() {\n+        return new ConfigKey<?>[] { QuotaPluginEnabled, QuotaEnableEnforcement, QuotaCurrencySymbol, QuotaStatementPeriod, QuotaSmtpHost, QuotaSmtpPort, QuotaSmtpTimeout, QuotaSmtpUser, QuotaSmtpPassword,\n+                QuotaSmtpAuthType, QuotaSmtpSender };\n+    }\n+\n+    public Boolean isQuotaServiceEnabled() {\n+        return QuotaPluginEnabled.value();\n+    }\n+\n+    @Override\n+    public List<QuotaBalanceVO> findQuotaBalanceVO(Long accountId, String accountName, Long domainId, Date startDate, Date endDate) {\n+        if ((accountId == null) && (accountName != null) && (domainId != null)) {\n+            Account userAccount = null;\n+            Account caller = CallContext.current().getCallingAccount();\n+            if (_domainDao.isChildDomain(caller.getDomainId(), domainId)) {\n+                Filter filter = new Filter(AccountVO.class, \"id\", Boolean.FALSE, null, null);\n+                List<AccountVO> accounts = _accountDao.listAccounts(accountName, domainId, filter);\n+                if (!accounts.isEmpty()) {\n+                    userAccount = accounts.get(0);\n+                }\n+                if (userAccount != null) {\n+                    accountId = userAccount.getId();\n+                } else {\n+                    throw new InvalidParameterValueException(\"Unable to find account \" + accountName + \" in domain \" + domainId);\n+                }\n+            } else {\n+                throw new PermissionDeniedException(\"Invalid Domain Id or Account\");\n+            }\n+        }\n+\n+        startDate = startDate == null ? new Date() : startDate;\n+\n+        if (endDate == null) {\n+            // adjust start date to end of day as there is no end date\n+            Date adjustedStartDate = computeAdjustedTime(_respBldr.startOfNextDay(startDate));\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"getQuotaBalance1: Getting quota balance records for account: \" + accountId + \", domainId: \" + domainId + \", on or before \" + adjustedStartDate);\n+            }\n+            List<QuotaBalanceVO> qbrecords = _quotaBalanceDao.lastQuotaBalanceVO(accountId, domainId, adjustedStartDate);\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Found records size=\" + qbrecords.size());\n+            }\n+            if (qbrecords.isEmpty()) {\n+                s_logger.info(\"Incorrect Date there are no quota records before this date \" + adjustedStartDate);\n+                return qbrecords;\n+            } else {\n+                return qbrecords;\n+            }\n+        } else {\n+            Date adjustedStartDate = computeAdjustedTime(startDate);\n+            if (endDate.after(_respBldr.startOfNextDay())) {\n+                throw new InvalidParameterValueException(\"Incorrect Date Range. End date:\" + endDate + \" should not be in future. \");\n+            } else if (startDate.before(endDate)) {\n+                Date adjustedEndDate = computeAdjustedTime(endDate);\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"getQuotaBalance2: Getting quota balance records for account: \" + accountId + \", domainId: \" + domainId + \", between \" + adjustedStartDate + \" and \"\n+                            + adjustedEndDate);\n+                }\n+                List<QuotaBalanceVO> qbrecords = _quotaBalanceDao.findQuotaBalance(accountId, domainId, adjustedStartDate, adjustedEndDate);\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"getQuotaBalance3: Found records size=\" + qbrecords.size());\n+                }\n+                if (qbrecords.isEmpty()) {\n+                    s_logger.info(\"There are no quota records between these dates start date \" + adjustedStartDate + \" and end date:\" + endDate);\n+                    return qbrecords;\n+                } else {\n+                    return qbrecords;\n+                }\n+            } else {\n+                throw new InvalidParameterValueException(\"Incorrect Date Range. Start date: \" + startDate + \" is after end date:\" + endDate);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public List<QuotaUsageVO> getQuotaUsage(Long accountId, String accountName, Long domainId, Integer usageType, Date startDate, Date endDate) {\n+        // if accountId is not specified, use accountName and domainId\n+        if ((accountId == null) && (accountName != null) && (domainId != null)) {\n+            Account userAccount = null;\n+            Account caller = CallContext.current().getCallingAccount();\n+            if (_domainDao.isChildDomain(caller.getDomainId(), domainId)) {\n+                Filter filter = new Filter(AccountVO.class, \"id\", Boolean.FALSE, null, null);\n+                List<AccountVO> accounts = _accountDao.listAccounts(accountName, domainId, filter);\n+                if (!accounts.isEmpty()) {\n+                    userAccount = accounts.get(0);\n+                }\n+                if (userAccount != null) {\n+                    accountId = userAccount.getId();\n+                } else {\n+                    throw new InvalidParameterValueException(\"Unable to find account \" + accountName + \" in domain \" + domainId);\n+                }\n+            } else {\n+                throw new PermissionDeniedException(\"Invalid Domain Id or Account\");\n+            }\n+        }\n+\n+        if (startDate.after(endDate)) {\n+            throw new InvalidParameterValueException(\"Incorrect Date Range. Start date: \" + startDate + \" is after end date:\" + endDate);\n+        }\n+        if (endDate.after(_respBldr.startOfNextDay())) {\n+            throw new InvalidParameterValueException(\"Incorrect Date Range. End date:\" + endDate + \" should not be in future. \");\n+        }\n+        Date adjustedEndDate = computeAdjustedTime(endDate);\n+        Date adjustedStartDate = computeAdjustedTime(startDate);\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Getting quota records for account: \" + accountId + \", domainId: \" + domainId + \", between \" + startDate + \" and \" + endDate);\n+        }\n+        return _quotaUsageDao.findQuotaUsage(accountId, domainId, usageType, adjustedStartDate, adjustedEndDate);\n+    }\n+\n+    @Override\n+    public Date computeAdjustedTime(final Date date) {\n+        Calendar cal = Calendar.getInstance();\n+        cal.setTime(date);\n+        TimeZone localTZ = cal.getTimeZone();\n+        int timezoneOffset = cal.get(Calendar.ZONE_OFFSET);\n+        if (localTZ.inDaylightTime(date)) {\n+            timezoneOffset += (60 * 60 * 1000);\n+        }\n+        cal.add(Calendar.MILLISECOND, timezoneOffset);\n+\n+        Date newTime = cal.getTime();\n+\n+        Calendar calTS = Calendar.getInstance(_usageTimezone);\n+        calTS.setTime(newTime);\n+        timezoneOffset = calTS.get(Calendar.ZONE_OFFSET);\n+        if (_usageTimezone.inDaylightTime(date)) {\n+            timezoneOffset += (60 * 60 * 1000);\n+        }\n+\n+        calTS.add(Calendar.MILLISECOND, -1 * timezoneOffset);\n+\n+        return calTS.getTime();\n+    }\n+\n+    @Override\n+    public void setLockAccount(Long accountId, Boolean state) {\n+        QuotaAccountVO acc = _quotaAcc.findByIdQuotaAccount(accountId);\n+        if (acc == null) {\n+            acc = new QuotaAccountVO(accountId);\n+            acc.setQuotaEnforce(state ? 1 : 0);\n+            _quotaAcc.persistQuotaAccount(acc);\n+        } else {\n+            acc.setQuotaEnforce(state ? 1 : 0);\n+            _quotaAcc.updateQuotaAccount(accountId, acc);\n+        }\n+    }\n+\n+    @Override\n+    public void setMinBalance(Long accountId, Double balance) {\n+        QuotaAccountVO acc = _quotaAcc.findByIdQuotaAccount(accountId);\n+        if (acc == null) {\n+            acc = new QuotaAccountVO(accountId);\n+            acc.setQuotaMinBalance(new BigDecimal(balance));\n+            _quotaAcc.persistQuotaAccount(acc);\n+        } else {\n+            acc.setQuotaMinBalance(new BigDecimal(balance));\n+            _quotaAcc.updateQuotaAccount(accountId, acc);\n+        }\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/src/org/apache/cloudstack/quota/QuotaServiceImpl.java",
                "sha": "1b4c98f6997a3e0f72117e30ef9e3e71c8d779ca",
                "status": "added"
            },
            {
                "additions": 65,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaBalanceCmdTest.java",
                "changes": 65,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaBalanceCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaBalanceCmdTest.java",
                "patch": "@@ -0,0 +1,65 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.response.QuotaBalanceResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaBalanceCmdTest extends TestCase {\n+\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+\n+    @Test\n+    public void testQuotaBalanceCmd() throws NoSuchFieldException, IllegalAccessException {\n+        QuotaBalanceCmd cmd = new QuotaBalanceCmd();\n+        Field rbField = QuotaBalanceCmd.class.getDeclaredField(\"_responseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        List<QuotaBalanceVO> quotaBalanceVOList = new ArrayList<QuotaBalanceVO>();\n+        Mockito.when(responseBuilder.getQuotaBalance(Mockito.any(cmd.getClass()))).thenReturn(quotaBalanceVOList);\n+        Mockito.when(responseBuilder.createQuotaLastBalanceResponse(Mockito.eq(quotaBalanceVOList), Mockito.any(Date.class))).thenReturn(new QuotaBalanceResponse());\n+        Mockito.when(responseBuilder.createQuotaBalanceResponse(Mockito.eq(quotaBalanceVOList), Mockito.any(Date.class), Mockito.any(Date.class))).thenReturn(new QuotaBalanceResponse());\n+        Mockito.when(responseBuilder.startOfNextDay(Mockito.any(Date.class))).thenReturn(new Date());\n+\n+        // end date not specified\n+        cmd.setStartDate(new Date());\n+        cmd.setEndDate(null);\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).createQuotaLastBalanceResponse(Mockito.eq(quotaBalanceVOList), Mockito.any(Date.class));\n+        Mockito.verify(responseBuilder, Mockito.times(0)).createQuotaBalanceResponse(Mockito.eq(quotaBalanceVOList), Mockito.any(Date.class), Mockito.any(Date.class));\n+\n+        // end date specified\n+        cmd.setEndDate(new Date());\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).createQuotaBalanceResponse(Mockito.eq(quotaBalanceVOList), Mockito.any(Date.class), Mockito.any(Date.class));\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaBalanceCmdTest.java",
                "sha": "4369a8c9f0cd9f32d696c8adae37635a9c32271d",
                "status": "added"
            },
            {
                "additions": 87,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaCreditsCmdTest.java",
                "changes": 87,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaCreditsCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaCreditsCmdTest.java",
                "patch": "@@ -0,0 +1,87 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import com.cloud.user.AccountService;\n+import com.cloud.user.AccountVO;\n+\n+import junit.framework.TestCase;\n+\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.QuotaCreditsResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.quota.QuotaService;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaCreditsCmdTest extends TestCase {\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+    @Mock\n+    QuotaService quotaService;\n+    @Mock\n+    AccountService accountService;\n+\n+    @Test\n+    public void testQuotaCreditsCmd() throws NoSuchFieldException, IllegalAccessException {\n+        QuotaCreditsCmd cmd = new QuotaCreditsCmd();\n+        cmd.setAccountName(\"admin\");\n+        cmd.setMinBalance(200.0);\n+\n+        Field rbField = QuotaCreditsCmd.class.getDeclaredField(\"_responseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        Field qsbField = QuotaCreditsCmd.class.getDeclaredField(\"_quotaService\");\n+        qsbField.setAccessible(true);\n+        qsbField.set(cmd, quotaService);\n+\n+        Field asField = BaseCmd.class.getDeclaredField(\"_accountService\");\n+        asField.setAccessible(true);\n+        asField.set(cmd, accountService);\n+\n+        AccountVO acc = new AccountVO();\n+        acc.setId(2L);\n+        Mockito.when(accountService.getActiveAccountByName(Mockito.anyString(), Mockito.anyLong())).thenReturn(acc);\n+        Mockito.when(responseBuilder.addQuotaCredits(Mockito.anyLong(), Mockito.anyLong(), Mockito.anyDouble(), Mockito.anyLong())).thenReturn(new QuotaCreditsResponse());\n+\n+        // No value provided test\n+        try {\n+            cmd.execute();\n+        } catch (ServerApiException e) {\n+            assertTrue(e.getErrorCode().equals(ApiErrorCode.PARAM_ERROR));\n+        }\n+\n+        // With value provided test\n+        cmd.setValue(11.80);\n+        cmd.execute();\n+        Mockito.verify(quotaService, Mockito.times(0)).setLockAccount(Mockito.anyLong(), Mockito.anyBoolean());\n+        Mockito.verify(quotaService, Mockito.times(1)).setMinBalance(Mockito.anyLong(), Mockito.anyDouble());\n+        Mockito.verify(responseBuilder, Mockito.times(1)).addQuotaCredits(Mockito.anyLong(), Mockito.anyLong(), Mockito.anyDouble(), Mockito.anyLong());\n+\n+\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaCreditsCmdTest.java",
                "sha": "f4d16b7b68ea6f99d632834d8b1e9fe744d04526",
                "status": "added"
            },
            {
                "additions": 50,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmdTest.java",
                "changes": 50,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmdTest.java",
                "patch": "@@ -0,0 +1,50 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.response.QuotaEmailTemplateResponse;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaEmailTemplateListCmdTest extends TestCase {\n+\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+\n+    @Test\n+    public void testQuotaEmailTemplateListCmd() throws NoSuchFieldException, IllegalAccessException {\n+        QuotaEmailTemplateListCmd cmd = new QuotaEmailTemplateListCmd();\n+        Field rbField = QuotaEmailTemplateListCmd.class.getDeclaredField(\"_quotaResponseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        List<QuotaEmailTemplateResponse> responses = new ArrayList<QuotaEmailTemplateResponse>();\n+        Mockito.when(responseBuilder.listQuotaEmailTemplates(Mockito.eq(cmd))).thenReturn(responses);\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).listQuotaEmailTemplates(cmd);\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateListCmdTest.java",
                "sha": "aecee6ba84c89f026f074a1d0d568edfdf33fdf3",
                "status": "added"
            },
            {
                "additions": 68,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmdTest.java",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmdTest.java",
                "patch": "@@ -0,0 +1,68 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.quota.constant.QuotaConfig;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaEmailTemplateUpdateCmdTest extends TestCase {\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+\n+    @Test\n+    public void testQuotaEmailTemplateUpdateCmd () throws NoSuchFieldException, IllegalAccessException {\n+        QuotaEmailTemplateUpdateCmd cmd = new QuotaEmailTemplateUpdateCmd();\n+\n+        Field rbField = QuotaEmailTemplateUpdateCmd.class.getDeclaredField(\"_quotaResponseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        // templatename parameter check\n+        try {\n+            cmd.execute();\n+        } catch (ServerApiException e) {\n+            assertTrue(e.getErrorCode().equals(ApiErrorCode.PARAM_ERROR));\n+        }\n+\n+        // invalid template name test\n+        cmd.setTemplateName(\"randomTemplate\");\n+        cmd.setTemplateBody(\"some body\");\n+        cmd.setTemplateSubject(\"some subject\");\n+        try {\n+            cmd.execute();\n+        } catch (ServerApiException e) {\n+            assertTrue(e.getErrorCode().equals(ApiErrorCode.PARAM_ERROR));\n+        }\n+\n+        // valid template test\n+        cmd.setTemplateName(QuotaConfig.QuotaEmailTemplateTypes.QUOTA_EMPTY.toString());\n+        Mockito.when(responseBuilder.updateQuotaEmailTemplate(Mockito.eq(cmd))).thenReturn(true);\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).updateQuotaEmailTemplate(Mockito.eq(cmd));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaEmailTemplateUpdateCmdTest.java",
                "sha": "a357a181c38c5dcf4740dfe6ce474864e3a3fa98",
                "status": "added"
            },
            {
                "additions": 53,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaStatementCmdTest.java",
                "changes": 53,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaStatementCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaStatementCmdTest.java",
                "patch": "@@ -0,0 +1,53 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaStatementResponse;\n+import org.apache.cloudstack.quota.vo.QuotaUsageVO;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaStatementCmdTest extends TestCase {\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+\n+    @Test\n+    public void testQuotaStatementCmd() throws NoSuchFieldException, IllegalAccessException {\n+        QuotaStatementCmd cmd = new QuotaStatementCmd();\n+        cmd.setAccountName(\"admin\");\n+\n+        Field rbField = QuotaStatementCmd.class.getDeclaredField(\"_responseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        List<QuotaUsageVO> quotaUsageVOList = new ArrayList<QuotaUsageVO>();\n+        Mockito.when(responseBuilder.getQuotaUsage(Mockito.eq(cmd))).thenReturn(quotaUsageVOList);\n+        Mockito.when(responseBuilder.createQuotaStatementResponse(Mockito.eq(quotaUsageVOList))).thenReturn(new QuotaStatementResponse());\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).getQuotaUsage(Mockito.eq(cmd));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaStatementCmdTest.java",
                "sha": "0492ae84b8df6827d08062f59055c9601c244853",
                "status": "added"
            },
            {
                "additions": 62,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffListCmdTest.java",
                "changes": 62,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffListCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffListCmdTest.java",
                "patch": "@@ -0,0 +1,62 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaTariffResponse;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaTariffListCmdTest extends TestCase {\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+\n+    @Test\n+    public void testQuotaTariffListCmd() throws NoSuchFieldException, IllegalAccessException {\n+        QuotaTariffListCmd cmd = new QuotaTariffListCmd();\n+\n+        Field rbField = QuotaTariffListCmd.class.getDeclaredField(\"_responseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        List<QuotaTariffVO> quotaTariffVOList = new ArrayList<QuotaTariffVO>();\n+        QuotaTariffVO tariff = new QuotaTariffVO();\n+        tariff.setEffectiveOn(new Date());\n+        tariff.setCurrencyValue(new BigDecimal(100));\n+        tariff.setUsageType(QuotaTypes.MEMORY);\n+\n+        quotaTariffVOList.add(new QuotaTariffVO());\n+        Mockito.when(responseBuilder.listQuotaTariffPlans(Mockito.eq(cmd))).thenReturn(quotaTariffVOList);\n+        Mockito.when(responseBuilder.createQuotaTariffResponse(Mockito.any(QuotaTariffVO.class))).thenReturn(new QuotaTariffResponse());\n+\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).createQuotaTariffResponse(Mockito.any(QuotaTariffVO.class));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffListCmdTest.java",
                "sha": "5781103f0275865a0cc2046df32163d9ea06a0a6",
                "status": "added"
            },
            {
                "additions": 67,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffUpdateCmdTest.java",
                "changes": 67,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffUpdateCmdTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffUpdateCmdTest.java",
                "patch": "@@ -0,0 +1,67 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command;\n+\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.api.response.QuotaTariffResponse;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.Date;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaTariffUpdateCmdTest extends TestCase {\n+\n+    @Mock\n+    QuotaResponseBuilder responseBuilder;\n+\n+    @Test\n+    public void testQuotaTariffUpdateCmd() throws NoSuchFieldException, IllegalAccessException {\n+        QuotaTariffUpdateCmd cmd = new QuotaTariffUpdateCmd();\n+\n+        Field rbField = QuotaTariffUpdateCmd.class.getDeclaredField(\"_responseBuilder\");\n+        rbField.setAccessible(true);\n+        rbField.set(cmd, responseBuilder);\n+\n+        QuotaTariffVO tariff = new QuotaTariffVO();\n+        tariff.setEffectiveOn(new Date());\n+        tariff.setCurrencyValue(new BigDecimal(100));\n+        tariff.setUsageType(QuotaTypes.MEMORY);\n+\n+        Mockito.when(responseBuilder.updateQuotaTariffPlan(Mockito.eq(cmd))).thenReturn(null);\n+        try {\n+            cmd.execute();\n+        } catch (ServerApiException e) {\n+            assertTrue(e.getErrorCode().equals(ApiErrorCode.INTERNAL_ERROR));\n+        }\n+\n+        Mockito.when(responseBuilder.updateQuotaTariffPlan(Mockito.eq(cmd))).thenReturn(tariff);\n+        Mockito.when(responseBuilder.createQuotaTariffResponse(Mockito.eq(tariff))).thenReturn(new QuotaTariffResponse());\n+        cmd.execute();\n+        Mockito.verify(responseBuilder, Mockito.times(1)).createQuotaTariffResponse(Mockito.eq(tariff));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/command/QuotaTariffUpdateCmdTest.java",
                "sha": "dc50af1c28dd7d72aea76253df517f2c7cc4e642",
                "status": "added"
            },
            {
                "additions": 228,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/response/QuotaResponseBuilderImplTest.java",
                "changes": 228,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/api/response/QuotaResponseBuilderImplTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/api/response/QuotaResponseBuilderImplTest.java",
                "patch": "@@ -0,0 +1,228 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.response;\n+\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.user.dao.UserDao;\n+import com.cloud.utils.db.TransactionLegacy;\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateListCmd;\n+import org.apache.cloudstack.api.command.QuotaEmailTemplateUpdateCmd;\n+import org.apache.cloudstack.quota.QuotaService;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.dao.QuotaBalanceDao;\n+import org.apache.cloudstack.quota.dao.QuotaCreditsDao;\n+import org.apache.cloudstack.quota.dao.QuotaEmailTemplatesDao;\n+import org.apache.cloudstack.quota.dao.QuotaTariffDao;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.apache.cloudstack.quota.vo.QuotaCreditsVO;\n+import org.apache.cloudstack.quota.vo.QuotaEmailTemplatesVO;\n+import org.apache.cloudstack.quota.vo.QuotaTariffVO;\n+import org.apache.cloudstack.region.RegionManager;\n+import org.joda.time.DateTime;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaResponseBuilderImplTest extends TestCase {\n+\n+    @Mock\n+    QuotaTariffDao quotaTariffDao;\n+    @Mock\n+    QuotaBalanceDao quotaBalanceDao;\n+    @Mock\n+    QuotaCreditsDao quotaCreditsDao;\n+    @Mock\n+    QuotaEmailTemplatesDao quotaEmailTemplateDao;\n+\n+    @Mock\n+    UserDao userDao;\n+    @Mock\n+    QuotaService quotaService;\n+    @Mock\n+    AccountDao accountDao;\n+    @Mock\n+    RegionManager regionMgr;\n+\n+    QuotaResponseBuilderImpl quotaResponseBuilder = new QuotaResponseBuilderImpl();\n+\n+    @Before\n+    public void setup() throws IllegalAccessException, NoSuchFieldException {\n+        // Dummy transaction stack setup\n+        TransactionLegacy.open(\"QuotaResponseBuilderImplTest\");\n+\n+        Field tariffDaoField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_quotaTariffDao\");\n+        tariffDaoField.setAccessible(true);\n+        tariffDaoField.set(quotaResponseBuilder, quotaTariffDao);\n+\n+        Field balanceDaoField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_quotaBalanceDao\");\n+        balanceDaoField.setAccessible(true);\n+        balanceDaoField.set(quotaResponseBuilder, quotaBalanceDao);\n+\n+        Field quotaCreditsDaoField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_quotaCreditsDao\");\n+        quotaCreditsDaoField.setAccessible(true);\n+        quotaCreditsDaoField.set(quotaResponseBuilder, quotaCreditsDao);\n+\n+        Field quotaEmailTemplateDaoField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_quotaEmailTemplateDao\");\n+        quotaEmailTemplateDaoField.setAccessible(true);\n+        quotaEmailTemplateDaoField.set(quotaResponseBuilder, quotaEmailTemplateDao);\n+\n+        Field userDaoField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_userDao\");\n+        userDaoField.setAccessible(true);\n+        userDaoField.set(quotaResponseBuilder, userDao);\n+\n+        Field quotaServiceField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_quotaService\");\n+        quotaServiceField.setAccessible(true);\n+        quotaServiceField.set(quotaResponseBuilder, quotaService);\n+\n+        Field accountDaoField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_accountDao\");\n+        accountDaoField.setAccessible(true);\n+        accountDaoField.set(quotaResponseBuilder, accountDao);\n+\n+        Field regionMgrField = QuotaResponseBuilderImpl.class.getDeclaredField(\"_regionMgr\");\n+        regionMgrField.setAccessible(true);\n+        regionMgrField.set(quotaResponseBuilder, regionMgr);\n+    }\n+\n+    private QuotaTariffVO makeTariffTestData() {\n+        QuotaTariffVO tariffVO = new QuotaTariffVO();\n+        tariffVO.setUsageType(QuotaTypes.IP_ADDRESS);\n+        tariffVO.setUsageName(\"ip address\");\n+        tariffVO.setUsageUnit(\"IP-Month\");\n+        tariffVO.setCurrencyValue(new BigDecimal(100.19));\n+        tariffVO.setEffectiveOn(new Date());\n+        tariffVO.setUsageDiscriminator(\"\");\n+        return tariffVO;\n+    }\n+\n+    @Test\n+    public void testQuotaResponse() {\n+        QuotaTariffVO tariffVO = makeTariffTestData();\n+        QuotaTariffResponse response = quotaResponseBuilder.createQuotaTariffResponse(tariffVO);\n+        assertTrue(tariffVO.getUsageType() == response.getUsageType());\n+        assertTrue(tariffVO.getCurrencyValue().equals(response.getTariffValue()));\n+    }\n+\n+    @Test\n+    public void testAddQuotaCredits() {\n+        final long accountId = 2L;\n+        final long domainId = 2L;\n+        final double amount = 11.0;\n+        final long updatedBy = 2L;\n+        final Date now = new Date();\n+\n+        QuotaCreditsVO credit = new QuotaCreditsVO();\n+        credit.setCredit(new BigDecimal(amount));\n+\n+        Mockito.when(quotaCreditsDao.saveCredits(Mockito.any(QuotaCreditsVO.class))).thenReturn(credit);\n+        Mockito.when(quotaBalanceDao.lastQuotaBalance(Mockito.anyLong(), Mockito.anyLong(), Mockito.any(Date.class))).thenReturn(new BigDecimal(111));\n+\n+        AccountVO account = new AccountVO();\n+        account.setState(Account.State.locked);\n+        Mockito.when(accountDao.findById(Mockito.anyLong())).thenReturn(account);\n+\n+        QuotaCreditsResponse resp = quotaResponseBuilder.addQuotaCredits(accountId, domainId, amount, updatedBy, now);\n+        assertTrue(resp.getCredits().compareTo(credit.getCredit()) == 0);\n+    }\n+\n+    @Test\n+    public void testListQuotaEmailTemplates() {\n+        QuotaEmailTemplateListCmd cmd = new QuotaEmailTemplateListCmd();\n+        cmd.setTemplateName(\"some name\");\n+        List<QuotaEmailTemplatesVO> templates = new ArrayList<>();\n+        QuotaEmailTemplatesVO template = new QuotaEmailTemplatesVO();\n+        template.setTemplateName(\"template\");\n+        templates.add(template);\n+        Mockito.when(quotaEmailTemplateDao.listAllQuotaEmailTemplates(Mockito.anyString())).thenReturn(templates);\n+\n+        assertTrue(quotaResponseBuilder.listQuotaEmailTemplates(cmd).size() == 1);\n+    }\n+\n+    @Test\n+    public void testUpdateQuotaEmailTemplate() {\n+        QuotaEmailTemplateUpdateCmd cmd = new QuotaEmailTemplateUpdateCmd();\n+        cmd.setTemplateBody(\"some body\");\n+        cmd.setTemplateName(\"some name\");\n+        cmd.setTemplateSubject(\"some subject\");\n+\n+        List<QuotaEmailTemplatesVO> templates = new ArrayList<>();\n+\n+        Mockito.when(quotaEmailTemplateDao.listAllQuotaEmailTemplates(Mockito.anyString())).thenReturn(templates);\n+        Mockito.when(quotaEmailTemplateDao.updateQuotaEmailTemplate(Mockito.any(QuotaEmailTemplatesVO.class))).thenReturn(true);\n+\n+        // invalid template test\n+        assertFalse(quotaResponseBuilder.updateQuotaEmailTemplate(cmd));\n+\n+        // valid template test\n+        QuotaEmailTemplatesVO template = new QuotaEmailTemplatesVO();\n+        template.setTemplateName(\"template\");\n+        templates.add(template);\n+        assertTrue(quotaResponseBuilder.updateQuotaEmailTemplate(cmd));\n+    }\n+\n+    @Test\n+    public void testCreateQuotaLastBalanceResponse() {\n+        List<QuotaBalanceVO> quotaBalance = new ArrayList<>();\n+        // null balance test\n+        try {\n+            quotaResponseBuilder.createQuotaLastBalanceResponse(null, new Date());\n+        } catch (InvalidParameterValueException e) {\n+            assertTrue(e.getMessage().equals(\"There are no balance entries on or before the requested date.\"));\n+        }\n+\n+        // empty balance test\n+        try {\n+            quotaResponseBuilder.createQuotaLastBalanceResponse(quotaBalance, new Date());\n+        } catch (InvalidParameterValueException e) {\n+            assertTrue(e.getMessage().equals(\"There are no balance entries on or before the requested date.\"));\n+        }\n+\n+        // valid balance test\n+        QuotaBalanceVO entry = new QuotaBalanceVO();\n+        entry.setAccountId(2L);\n+        entry.setCreditBalance(new BigDecimal(100));\n+        quotaBalance.add(entry);\n+        quotaBalance.add(entry);\n+        Mockito.when(quotaService.computeAdjustedTime(Mockito.any(Date.class))).thenReturn(new Date());\n+        QuotaBalanceResponse resp = quotaResponseBuilder.createQuotaLastBalanceResponse(quotaBalance, null);\n+        assertTrue(resp.getStartQuota().compareTo(new BigDecimal(200)) == 0);\n+    }\n+\n+    @Test\n+    public void testStartOfNextDay() {\n+        DateTime now = new DateTime();\n+        DateTime nextDay = new DateTime(quotaResponseBuilder.startOfNextDay(now.toDate()));\n+        DateTime nextDay2 = new DateTime(quotaResponseBuilder.startOfNextDay());\n+        assertTrue(now.toLocalDate().equals(nextDay.minusDays(1).toLocalDate()));\n+        assertTrue(now.toLocalDate().equals(nextDay2.minusDays(1).toLocalDate()));\n+    }\n+\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/api/response/QuotaResponseBuilderImplTest.java",
                "sha": "65aadd80dee0b33f29cacb3c76d9eb51cbee6f7b",
                "status": "added"
            },
            {
                "additions": 183,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/quota/QuotaServiceImplTest.java",
                "changes": 183,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/test/org/apache/cloudstack/quota/QuotaServiceImplTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/database/quota/test/org/apache/cloudstack/quota/QuotaServiceImplTest.java",
                "patch": "@@ -0,0 +1,183 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.quota;\n+\n+import com.cloud.configuration.Config;\n+import com.cloud.domain.dao.DomainDao;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.db.TransactionLegacy;\n+import junit.framework.TestCase;\n+import org.apache.cloudstack.api.response.QuotaResponseBuilder;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n+import org.apache.cloudstack.quota.constant.QuotaTypes;\n+import org.apache.cloudstack.quota.dao.QuotaAccountDao;\n+import org.apache.cloudstack.quota.dao.QuotaBalanceDao;\n+import org.apache.cloudstack.quota.dao.QuotaUsageDao;\n+import org.apache.cloudstack.quota.vo.QuotaAccountVO;\n+import org.apache.cloudstack.quota.vo.QuotaBalanceVO;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeZone;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import javax.naming.ConfigurationException;\n+import java.lang.reflect.Field;\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class QuotaServiceImplTest extends TestCase {\n+\n+    @Mock\n+    AccountDao accountDao;\n+    @Mock\n+    QuotaAccountDao quotaAcc;\n+    @Mock\n+    QuotaUsageDao quotaUsageDao;\n+    @Mock\n+    DomainDao domainDao;\n+    @Mock\n+    ConfigurationDao configDao;\n+    @Mock\n+    QuotaBalanceDao quotaBalanceDao;\n+    @Mock\n+    QuotaResponseBuilder respBldr;\n+\n+    QuotaServiceImpl quotaService = new QuotaServiceImpl();\n+\n+    @Before\n+    public void setup() throws IllegalAccessException, NoSuchFieldException, ConfigurationException {\n+        // Dummy transaction stack setup\n+        TransactionLegacy.open(\"QuotaServiceImplTest\");\n+\n+        Field accountDaoField = QuotaServiceImpl.class.getDeclaredField(\"_accountDao\");\n+        accountDaoField.setAccessible(true);\n+        accountDaoField.set(quotaService, accountDao);\n+\n+        Field quotaAccountDaoField = QuotaServiceImpl.class.getDeclaredField(\"_quotaAcc\");\n+        quotaAccountDaoField.setAccessible(true);\n+        quotaAccountDaoField.set(quotaService, quotaAcc);\n+\n+        Field quotaUsageDaoField = QuotaServiceImpl.class.getDeclaredField(\"_quotaUsageDao\");\n+        quotaUsageDaoField.setAccessible(true);\n+        quotaUsageDaoField.set(quotaService, quotaUsageDao);\n+\n+        Field domainDaoField = QuotaServiceImpl.class.getDeclaredField(\"_domainDao\");\n+        domainDaoField.setAccessible(true);\n+        domainDaoField.set(quotaService, domainDao);\n+\n+        Field configDaoField = QuotaServiceImpl.class.getDeclaredField(\"_configDao\");\n+        configDaoField.setAccessible(true);\n+        configDaoField.set(quotaService, configDao);\n+\n+        Field balanceDaoField = QuotaServiceImpl.class.getDeclaredField(\"_quotaBalanceDao\");\n+        balanceDaoField.setAccessible(true);\n+        balanceDaoField.set(quotaService, quotaBalanceDao);\n+\n+        Field QuotaResponseBuilderField = QuotaServiceImpl.class.getDeclaredField(\"_respBldr\");\n+        QuotaResponseBuilderField.setAccessible(true);\n+        QuotaResponseBuilderField.set(quotaService, respBldr);\n+\n+        Mockito.when(configDao.getValue(Mockito.eq(Config.UsageAggregationTimezone.toString()))).thenReturn(\"IST\");\n+        Mockito.when(configDao.getValue(Mockito.eq(Config.UsageStatsJobAggregationRange.toString()))).thenReturn(\"1\");\n+        quotaService.configure(\"randomName\", null);\n+    }\n+\n+    @Test\n+    public void testComputeAdjustedTime() {\n+        DateTime now = new DateTime(DateTimeZone.UTC);\n+        DateTime result = new DateTime(quotaService.computeAdjustedTime(now.toDate()));\n+        // FIXME: fix this test\n+    }\n+\n+    @Test\n+    public void testFindQuotaBalanceVO() {\n+        final long accountId = 2L;\n+        final String accountName = \"admin123\";\n+        final long domainId = 1L;\n+        final Date startDate = new DateTime().minusDays(2).toDate();\n+        final Date endDate = new Date();\n+\n+        List<QuotaBalanceVO> records = new ArrayList<>();\n+        QuotaBalanceVO qb = new QuotaBalanceVO();\n+        qb.setCreditBalance(new BigDecimal(100));\n+        qb.setAccountId(accountId);\n+        records.add(qb);\n+\n+        Mockito.when(respBldr.startOfNextDay()).thenReturn(endDate);\n+        Mockito.when(respBldr.startOfNextDay(Mockito.any(Date.class))).thenReturn(startDate);\n+        Mockito.when(quotaBalanceDao.findQuotaBalance(Mockito.eq(accountId), Mockito.eq(domainId), Mockito.any(Date.class), Mockito.any(Date.class))).thenReturn(records);\n+        Mockito.when(quotaBalanceDao.lastQuotaBalanceVO(Mockito.eq(accountId), Mockito.eq(domainId), Mockito.any(Date.class))).thenReturn(records);\n+\n+        // with enddate\n+        assertTrue(quotaService.findQuotaBalanceVO(accountId, accountName, domainId, startDate, endDate).get(0).equals(qb));\n+        // without enddate\n+        assertTrue(quotaService.findQuotaBalanceVO(accountId, accountName, domainId, startDate, null).get(0).equals(qb));\n+    }\n+\n+    @Test\n+    public void testGetQuotaUsage() {\n+        final long accountId = 2L;\n+        final String accountName = \"admin123\";\n+        final long domainId = 1L;\n+        final Date startDate = new DateTime().minusDays(2).toDate();\n+        final Date endDate = new Date();\n+\n+        Mockito.when(respBldr.startOfNextDay()).thenReturn(endDate);\n+        quotaService.getQuotaUsage(accountId, accountName, domainId, QuotaTypes.IP_ADDRESS, startDate, endDate);\n+        Mockito.verify(quotaUsageDao, Mockito.times(1)).findQuotaUsage(Mockito.eq(accountId), Mockito.eq(domainId), Mockito.eq(QuotaTypes.IP_ADDRESS), Mockito.any(Date.class), Mockito.any(Date.class));\n+    }\n+\n+    @Test\n+    public void testSetLockAccount() {\n+        // existing account\n+        QuotaAccountVO quotaAccountVO = new QuotaAccountVO();\n+        Mockito.when(quotaAcc.findByIdQuotaAccount(Mockito.anyLong())).thenReturn(quotaAccountVO);\n+        quotaService.setLockAccount(2L, true);\n+        Mockito.verify(quotaAcc, Mockito.times(0)).persistQuotaAccount(Mockito.any(QuotaAccountVO.class));\n+        Mockito.verify(quotaAcc, Mockito.times(1)).updateQuotaAccount(Mockito.anyLong(), Mockito.any(QuotaAccountVO.class));\n+\n+        // new account\n+        Mockito.when(quotaAcc.findByIdQuotaAccount(Mockito.anyLong())).thenReturn(null);\n+        quotaService.setLockAccount(2L, true);\n+        Mockito.verify(quotaAcc, Mockito.times(1)).persistQuotaAccount(Mockito.any(QuotaAccountVO.class));\n+    }\n+\n+    @Test\n+    public void testSetMinBalance() {\n+        final long accountId = 2L;\n+        final double balance = 10.3F;\n+\n+        // existing account setting\n+        QuotaAccountVO quotaAccountVO = new QuotaAccountVO();\n+        Mockito.when(quotaAcc.findByIdQuotaAccount(Mockito.anyLong())).thenReturn(quotaAccountVO);\n+        quotaService.setMinBalance(accountId, balance);\n+        Mockito.verify(quotaAcc, Mockito.times(0)).persistQuotaAccount(Mockito.any(QuotaAccountVO.class));\n+        Mockito.verify(quotaAcc, Mockito.times(1)).updateQuotaAccount(Mockito.anyLong(), Mockito.any(QuotaAccountVO.class));\n+\n+        // no account with limit set\n+        Mockito.when(quotaAcc.findByIdQuotaAccount(Mockito.anyLong())).thenReturn(null);\n+        quotaService.setMinBalance(accountId, balance);\n+        Mockito.verify(quotaAcc, Mockito.times(1)).persistQuotaAccount(Mockito.any(QuotaAccountVO.class));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/database/quota/test/org/apache/cloudstack/quota/QuotaServiceImplTest.java",
                "sha": "310e9ced72fd15c4c9ebadf6b7e148db6613e69b",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/hypervisors/ovm3/pom.xml",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/ovm3/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "plugins/hypervisors/ovm3/pom.xml",
                "patch": "@@ -45,7 +45,7 @@\n     <dependency>\n \t<groupId>org.apache.commons</groupId>\n \t<artifactId>commons-lang3</artifactId>\n-\t<version>${cs.lang3.version}</version>\n+\t<version>${cs.commons-lang3.version}</version>\n     </dependency>\n     <dependency>\n \t<groupId>log4j</groupId>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/hypervisors/ovm3/pom.xml",
                "sha": "8afd3712c303a547afe4b09b0d978ed84be4b9f3",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/network-elements/nuage-vsp/pom.xml",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/network-elements/nuage-vsp/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "plugins/network-elements/nuage-vsp/pom.xml",
                "patch": "@@ -32,7 +32,7 @@\n     <dependency>\n       <groupId>org.apache.commons</groupId>\n       <artifactId>commons-lang3</artifactId>\n-      <version>${cs.lang3.version}</version>\n+      <version>${cs.commons-lang3.version}</version>\n     </dependency>\n   </dependencies>\n   <build>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/network-elements/nuage-vsp/pom.xml",
                "sha": "6c11acf19ed73fdac7c0ca8fbc8860e253ee06cf",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/pom.xml",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "plugins/pom.xml",
                "patch": "@@ -101,6 +101,7 @@\n     <module>network-elements/internal-loadbalancer</module>\n     <module>network-elements/vxlan</module>\n     <module>network-elements/globodns</module>\n+    <module>database/quota</module>\n   </modules>\n \n   <dependencies>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/plugins/pom.xml",
                "sha": "5305d943feebd0ec2838212fdf1c3a91435d8782",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/pom.xml",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "pom.xml",
                "patch": "@@ -99,7 +99,7 @@\n     <cs.aws.sdk.version>1.10.34</cs.aws.sdk.version>\n     <cs.jackson.version>2.6.3</cs.jackson.version>\n     <cs.lang.version>2.6</cs.lang.version>\n-    <cs.lang3.version>3.4</cs.lang3.version>\n+    <cs.commons-lang3.version>3.4</cs.commons-lang3.version>\n     <cs.commons-io.version>2.4</cs.commons-io.version>\n     <cs.commons-validator.version>1.4.0</cs.commons-validator.version>\n     <cs.reflections.version>0.9.9</cs.reflections.version>\n@@ -116,6 +116,7 @@\n     <cs.javadoc.version>2.10.1</cs.javadoc.version>\n     <cs.opensaml.version>2.6.1</cs.opensaml.version>\n     <cs.xml-apis.version>1.4.01</cs.xml-apis.version>\n+    <cs.joda-time.version>2.8.1</cs.joda-time.version>\n   </properties>\n \n   <distributionManagement>\n@@ -714,6 +715,19 @@\n                     <ignore></ignore>\n                   </action>\n                 </pluginExecution>\n+                <pluginExecution>\n+\t\t\t<pluginExecutionFilter>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-checkstyle-plugin</artifactId>\n+\t\t\t\t<versionRange>[2.11,)</versionRange>\n+\t\t\t\t<goals>\n+\t\t\t\t\t<goal>check</goal>\n+\t\t\t\t</goals>\n+\t\t\t</pluginExecutionFilter>\n+\t\t\t<action>\n+\t\t\t\t<ignore></ignore>\n+\t\t\t</action>\n+                </pluginExecution>\n               </pluginExecutions>\n             </lifecycleMappingMetadata>\n           </configuration>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/pom.xml",
                "sha": "9ff47e26cef96757bc13797e48b6479a4a697da9",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/dispatch/ParamProcessWorker.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "patch": "@@ -294,6 +294,14 @@ private void setFieldValue(final Field field, final BaseCmd cmdObj, final Object\n                     field.set(cmdObj, Float.valueOf(paramObj.toString()));\n                 }\n                 break;\n+            case DOUBLE:\n+                // Assuming that the parameters have been checked for required before now,\n+                // we ignore blank or null values and defer to the command to set a default\n+                // value for optional parameters ...\n+                if (paramObj != null && isNotBlank(paramObj.toString())) {\n+                    field.set(cmdObj, Double.valueOf(paramObj.toString()));\n+                }\n+                break;\n             case INTEGER:\n                 // Assuming that the parameters have been checked for required before now,\n                 // we ignore blank or null values and defer to the command to set a default",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "sha": "099c0c91e667636b9e47f553e2994a7e0504bd03",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 2,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -2184,8 +2184,7 @@ private UserAccount getUserAccount(String username, String password, Long domain\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"User \" + username + \" in domain \" + domainName + \" is disabled/locked (or account is disabled/locked)\");\n                 }\n-                throw new CloudAuthenticationException(\"User \" + username + \" in domain \" + domainName + \" is disabled/locked (or account is disabled/locked)\");\n-                // return null;\n+                throw new CloudAuthenticationException(\"User \" + username + \" (or their account) in domain \" + domainName + \" is disabled/locked. Please contact the administrator.\");\n             }\n             // Whenever the user is able to log in successfully, reset the login attempts to zero\n             if (!isInternalAccount(userAccount.getId()))",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "d3eb40c7db69d2c3a3a4ef3ff59b77ed92991e84",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/server/test/com/cloud/api/dispatch/ParamProcessWorkerTest.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/api/dispatch/ParamProcessWorkerTest.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "server/test/com/cloud/api/dispatch/ParamProcessWorkerTest.java",
                "patch": "@@ -62,6 +62,9 @@\n         @Parameter(name = \"boolparam1\", type = CommandType.BOOLEAN)\n         boolean boolparam1;\n \n+        @Parameter(name = \"doubleparam1\", type = CommandType.DOUBLE)\n+        double doubleparam1;\n+\n         @Override\n         public void execute() throws ResourceUnavailableException, InsufficientCapacityException, ServerApiException, ConcurrentOperationException,\n             ResourceAllocationException, NetworkRuleConflictException {\n@@ -98,10 +101,12 @@ public void processParameters() {\n         params.put(\"strparam1\", \"foo\");\n         params.put(\"intparam1\", \"100\");\n         params.put(\"boolparam1\", \"true\");\n+        params.put(\"doubleparam1\", \"11.89\");\n         final TestCmd cmd = new TestCmd();\n         paramProcessWorker.processParameters(cmd, params);\n         Assert.assertEquals(\"foo\", cmd.strparam1);\n         Assert.assertEquals(100, cmd.intparam1);\n+        Assert.assertTrue(Double.compare(cmd.doubleparam1, 11.89) == 0);\n     }\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/server/test/com/cloud/api/dispatch/ParamProcessWorkerTest.java",
                "sha": "7ac982db6234ca2620182d7539af652bfa399bd7",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/setup/db/db/schema-421to430-cleanup.sql",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-421to430-cleanup.sql?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "setup/db/db/schema-421to430-cleanup.sql",
                "patch": "@@ -19,4 +19,3 @@\n -- Schema cleanup from 4.2.0 to 4.3.0;\n --;\n \n-",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/setup/db/db/schema-421to430-cleanup.sql",
                "sha": "4a58e65477d01ef9b82e0462945d26941510d2fb",
                "status": "modified"
            },
            {
                "additions": 110,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/setup/db/db/schema-461to470.sql",
                "changes": 110,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/setup/db/db/schema-461to470.sql?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "setup/db/db/schema-461to470.sql",
                "patch": "@@ -30,3 +30,113 @@ CREATE TABLE IF NOT EXISTS `cloud`.`domain_vlan_map` (\n   INDEX `i_account_vlan_map__vlan_id`(`vlan_db_id`)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n \n+-- Quota\n+\n+CREATE TABLE IF NOT EXISTS `cloud_usage`.`quota_account` (\n+      `account_id` int(11) NOT NULL,\n+      `quota_balance` decimal(15,2) NULL,\n+      `quota_balance_date` datetime NULL,\n+      `quota_enforce` int(1) DEFAULT NULL,\n+      `quota_min_balance` decimal(15,2) DEFAULT NULL,\n+      `quota_alert_date` datetime DEFAULT NULL,\n+      `quota_alert_type` int(11) DEFAULT NULL,\n+      `last_statement_date` datetime DEFAULT NULL,\n+      PRIMARY KEY (`account_id`),\n+  CONSTRAINT `account_id` FOREIGN KEY (`account_id`) REFERENCES `cloud_usage`.`account` (`quota_enforce`)\n+  ON DELETE NO ACTION\n+  ON UPDATE NO ACTION\n+) ENGINE=MyISAM DEFAULT CHARSET=utf8;\n+\n+\n+CREATE TABLE IF NOT EXISTS `cloud_usage`.`quota_tariff` (\n+  `id` bigint unsigned NOT NULL AUTO_INCREMENT,\n+  `usage_type` int(2) unsigned DEFAULT NULL,\n+  `usage_name` varchar(255) NOT NULL COMMENT 'usage type',\n+  `usage_unit` varchar(255) NOT NULL COMMENT 'usage type',\n+  `usage_discriminator` varchar(255) NOT NULL COMMENT 'usage type',\n+  `currency_value` decimal(15,2) NOT NULL COMMENT 'usage type',\n+  `effective_on` datetime NOT NULL COMMENT 'date time on which this quota values will become effective',\n+  `updated_on` datetime NOT NULL COMMENT 'date this entry was updated on',\n+  `updated_by` bigint unsigned NOT NULL,\n+  PRIMARY KEY (`id`)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n+\n+\n+LOCK TABLES `cloud_usage`.`quota_tariff` WRITE;\n+INSERT IGNORE INTO `cloud_usage`.`quota_tariff` (`usage_type`, `usage_name`, `usage_unit`, `usage_discriminator`, `currency_value`, `effective_on`,  `updated_on`, `updated_by`) VALUES\n+ (1,'RUNNING_VM','Compute-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (2,'ALLOCATED_VM','Compute-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (3,'IP_ADDRESS','IP-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (4,'NETWORK_BYTES_SENT','GB','',0.00,'2010-05-04', '2010-05-04',1),\n+ (5,'NETWORK_BYTES_RECEIVED','GB','',0.00,'2010-05-04', '2010-05-04',1),\n+ (6,'VOLUME','GB-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (7,'TEMPLATE','GB-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (8,'ISO','GB-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (9,'SNAPSHOT','GB-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (10,'SECURITY_GROUP','Policy-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (11,'LOAD_BALANCER_POLICY','Policy-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (12,'PORT_FORWARDING_RULE','Policy-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (13,'NETWORK_OFFERING','Policy-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (14,'VPN_USERS','Policy-Month','',0.00,'2010-05-04', '2010-05-04',1),\n+ (15,'CPU_SPEED','Compute-Month','100MHz',0.00,'2010-05-04', '2010-05-04',1),\n+ (16,'vCPU','Compute-Month','1VCPU',0.00,'2010-05-04', '2010-05-04',1),\n+ (17,'MEMORY','Compute-Month','1MB',0.00,'2010-05-04', '2010-05-04',1),\n+ (21,'VM_DISK_IO_READ','GB','1',0.00,'2010-05-04', '2010-05-04',1),\n+ (22,'VM_DISK_IO_WRITE','GB','1',0.00,'2010-05-04', '2010-05-04',1),\n+ (23,'VM_DISK_BYTES_READ','GB','1',0.00,'2010-05-04', '2010-05-04',1),\n+ (24,'VM_DISK_BYTES_WRITE','GB','1',0.00,'2010-05-04', '2010-05-04',1),\n+ (25,'VM_SNAPSHOT','GB-Month','',0.00,'2010-05-04', '2010-05-04',1);\n+UNLOCK TABLES;\n+\n+CREATE TABLE IF NOT EXISTS `cloud_usage`.`quota_credits` (\n+  `id` bigint unsigned NOT NULL auto_increment COMMENT 'id',\n+  `account_id` bigint unsigned NOT NULL,\n+  `domain_id` bigint(20) unsigned NOT NULL,\n+  `credit` decimal(15,4) COMMENT 'amount credited',\n+  `updated_on` datetime NOT NULL COMMENT 'date created',\n+  `updated_by` bigint unsigned NOT NULL,\n+  PRIMARY KEY  (`id`)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n+\n+CREATE TABLE IF NOT EXISTS `cloud_usage`.`quota_usage` (\n+  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',\n+  `usage_item_id` bigint(20) unsigned NOT NULL,\n+  `zone_id` bigint(20) unsigned NOT NULL,\n+  `account_id` bigint(20) unsigned NOT NULL,\n+  `domain_id` bigint(20) unsigned NOT NULL,\n+  `usage_type` varchar(64) DEFAULT NULL,\n+  `quota_used` decimal(15,8) unsigned NOT NULL,\n+  `start_date` datetime NOT NULL COMMENT 'start time for this usage item',\n+  `end_date` datetime NOT NULL COMMENT 'end time for this usage item',\n+  PRIMARY KEY (`id`)\n+) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;\n+\n+\n+CREATE TABLE IF NOT EXISTS `cloud_usage`.`quota_balance` (\n+  `id` bigint unsigned NOT NULL auto_increment COMMENT 'id',\n+  `account_id` bigint unsigned NOT NULL,\n+  `domain_id` bigint(20) unsigned NOT NULL,\n+  `credit_balance` decimal(15,8) COMMENT 'amount of credits remaining',\n+  `credits_id`  bigint unsigned COMMENT 'if not null then this entry corresponds to credit change quota_credits',\n+  `updated_on` datetime NOT NULL COMMENT 'date updated on',\n+  PRIMARY KEY  (`id`)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n+\n+\n+CREATE TABLE IF NOT EXISTS `cloud_usage`.`quota_email_templates` (\n+  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n+  `template_name` varchar(64) NOT NULL UNIQUE,\n+  `template_subject` longtext,\n+  `template_body` longtext,\n+  `locale` varchar(25) DEFAULT 'en_US',\n+  `updated` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n+  PRIMARY KEY (`id`)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n+\n+LOCK TABLES `cloud_usage`.`quota_email_templates` WRITE;\n+INSERT IGNORE INTO `cloud_usage`.`quota_email_templates` (`template_name`, `template_subject`, `template_body`) VALUES\n+ ('QUOTA_LOW', 'Quota Usage Threshold crossed by your account ${accountName}', 'Your account ${accountName} in the domain ${domainName} has reached quota usage threshold, your current quota balance is ${quotaBalance}.'),\n+ ('QUOTA_EMPTY', 'Quota Exhausted, account ${accountName} has no quota left.', 'Your account ${accountName} in the domain ${domainName} has exhausted allocated quota, please contact the administrator.'),\n+ ('QUOTA_UNLOCK_ACCOUNT', 'Quota credits added, account ${accountName} is unlocked now, if it was locked', 'Your account ${accountName} in the domain ${domainName} has enough quota credits now with the current balance of ${quotaBalance}.'),\n+ ('QUOTA_STATEMENT', 'Quota Statement for your account ${accountName}', 'Monthly quota statement of your account ${accountName} in the domain ${domainName}:<br>Balance = ${quotaBalance}<br>Total Usage = ${quotaUsage}.');\n+UNLOCK TABLES;",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/setup/db/db/schema-461to470.sql",
                "sha": "d738545c2ca97414719da282925c97bebdc2f233",
                "status": "modified"
            },
            {
                "additions": 204,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/test/integration/smoke/test_quota.py",
                "changes": 204,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_quota.py?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "test/integration/smoke/test_quota.py",
                "patch": "@@ -0,0 +1,204 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+\"\"\" Test cases for checking quota API\n+\"\"\"\n+\n+#Import Local Modules\n+import marvin\n+from marvin.cloudstackTestCase import *\n+from marvin.cloudstackAPI import *\n+from marvin.lib.utils import *\n+from marvin.lib.base import *\n+from marvin.lib.common import *\n+from marvin.lib.utils import (random_gen)\n+from nose.plugins.attrib import attr\n+\n+#Import System modules\n+import time\n+\n+#ENABLE THE QUOTA PLUGIN AND RESTART THE MANAGEMENT SERVER TO RUN QUOTA TESTS\n+\n+class TestQuota(cloudstackTestCase):\n+\n+    def setUp(self):\n+        self.apiclient = self.testClient.getApiClient()\n+        self.hypervisor = self.testClient.getHypervisorInfo()\n+        self.dbclient = self.testClient.getDbConnection()\n+        self.services = self.testClient.getParsedTestDataConfig()\n+        self.zone = get_zone(self.apiclient, self.testClient.getZoneForTests())\n+        self.pod = get_pod(self.apiclient, self.zone.id)\n+        self.cleanup = []\n+        return\n+\n+    def tearDown(self):\n+        try:\n+            #Clean up, terminate the created templates\n+            cleanup_resources(self.apiclient, self.cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+        return\n+\n+    #Check quotaTariffList API returning 22 items\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_01_quota(self):\n+        cmd = quotaTariffList.quotaTariffListCmd()\n+        response = self.apiclient.quotaTariffList(cmd)\n+\n+        self.debug(\"Number of quota usage types: %s\" % len(response))\n+        self.assertEqual(\n+                         len(response), 22\n+                         )\n+        for quota in response:\n+            self.debug(\"Usage Name: %s\" % quota.usageName)\n+            self.assertEqual(\n+                hasattr(quota, 'usageName'),\n+                True,\n+                \"Check whether usgaeName field is there\"\n+            )\n+\n+        return\n+\n+    #Check quota tariff on a particualr day\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_02_quota(self):\n+        cmd = quotaTariffList.quotaTariffListCmd()\n+        cmd.startdate='2015-07-06'\n+        response = self.apiclient.quotaTariffList(cmd)\n+\n+        self.debug(\"Number of quota usage types: %s\" % len(response))\n+        self.assertEqual(\n+                         len(response), 22\n+                         )\n+\n+        return\n+\n+    #check quota tariff of a particular item\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_03_quota(self):\n+        cmd = quotaTariffList.quotaTariffListCmd()\n+        cmd.startdate='2015-07-06'\n+        cmd.usagetype='10'\n+        response = self.apiclient.quotaTariffList(cmd)\n+\n+        self.debug(\"Number of quota usage types: %s\" % len(response))\n+        self.assertEqual(\n+                         len(response), 1\n+                         )\n+        return\n+\n+\n+    #check quota tariff\n+    #Change it\n+    #Check on affective date the new tariff should be applicable\n+    #check the old tariff it should be same\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_04_quota(self):\n+        cmd = quotaTariffList.quotaTariffListCmd()\n+        cmd.startdate='2015-07-06'\n+        cmd.usagetype='10'\n+        response = self.apiclient.quotaTariffList(cmd)\n+\n+        self.debug(\"Number of quota usage types: %s\" % len(response))\n+        self.assertEqual(\n+                         len(response), 1\n+                         )\n+        quota = response[0]\n+        self.debug(\"Tariff Value for 10: %s\" % quota.tariffValue)\n+\n+        cmd = quotaTariffUpdate.quotaTariffUpdateCmd()\n+        tomorrow = datetime.date.today() + datetime.timedelta(days=1)\n+        cmd.startdate=tomorrow\n+        cmd.usagetype='10'\n+        cmd.value='2.9'\n+        response = self.apiclient.quotaTariffUpdate(cmd)\n+\n+        cmd = quotaTariffList.quotaTariffListCmd()\n+        cmd.startdate=tomorrow\n+        cmd.usagetype='10'\n+        response = self.apiclient.quotaTariffList(cmd)\n+        self.assertEqual(\n+                         len(response), 1\n+                         )\n+        quota = response[0]\n+        self.debug(\"Tariff Value for 10: %s\" % quota.tariffValue)\n+\n+        self.assertEqual( quota.tariffValue, 2.9)\n+\n+\n+        cmd = quotaTariffList.quotaTariffListCmd()\n+        cmd.startdate='2015-07-07'\n+        cmd.usagetype='10'\n+        response = self.apiclient.quotaTariffList(cmd)\n+        self.assertEqual(\n+                         len(response), 1\n+                         )\n+        quota = response[0]\n+        self.debug(\"Tariff Value for 10: %s\" % quota.tariffValue)\n+\n+        self.assertEqual( quota.tariffValue, 0)\n+\n+        return\n+\n+\n+    #Make credit deposit\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_05_quota(self):\n+        cmd = quotaCredits.quotaCreditsCmd()\n+        cmd.domainid = '1'\n+        cmd.account = 'admin'\n+        cmd.value = '10'\n+        cmd.quota_enforce = '1'\n+        cmd.min_balance = '9'\n+        response = self.apiclient.quotaCredits(cmd)\n+\n+        self.debug(\"Credit response update on: %s\" % response.updated_on)\n+\n+        return\n+\n+\n+    #Make credit deposit and check today balance\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_06_quota(self):\n+        cmd = quotaBalance.quotaBalanceCmd()\n+        today = datetime.date.today()\n+        cmd.domainid = '1'\n+        cmd.account = 'admin'\n+        cmd.startdate = today\n+        response = self.apiclient.quotaBalance(cmd)\n+\n+        self.debug(\"Quota Balance on: %s\" % response.startdate)\n+        self.debug(\"is: %s\" % response.startquota)\n+\n+        self.assertGreater( response.startquota, 9)\n+        return\n+\n+    #make credit deposit and check start and end date balances\n+    @attr(tags=[\"smoke\", \"advanced\"], required_hardware=\"false\")\n+    def test_07_quota(self):\n+        cmd = quotaBalance.quotaBalanceCmd()\n+        today = datetime.date.today()\n+        cmd.domainid = '1'\n+        cmd.account = 'admin'\n+        cmd.startdate = today - datetime.timedelta(days=2)\n+        cmd.enddate = today\n+        response = self.apiclient.quotaBalance(cmd)\n+\n+        self.debug(\"Quota Balance on: %s\" % response.startdate)\n+        self.debug(\"is: %s\" % response.startquota)\n+\n+        self.assertGreater( response.endquota, 9)\n+        return",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/test/integration/smoke/test_quota.py",
                "sha": "d4e4323e9b3dcaaf81cc5e8d9d161914d084aea4",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/tools/apidoc/gen_toc.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/apidoc/gen_toc.py?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "tools/apidoc/gen_toc.py",
                "patch": "@@ -118,6 +118,8 @@\n     'listIdps': 'Authentication',\n     'authorizeSamlSso': 'Authentication',\n     'listSamlAuthorization': 'Authentication',\n+    'quota': 'Quota',\n+    'emailTemplate': 'Quota',\n     'Capacity': 'System Capacity',\n     'NetworkDevice': 'Network Device',\n     'ExternalLoadBalancer': 'Ext Load Balancer',",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/tools/apidoc/gen_toc.py",
                "sha": "6974fd74231a3e7a8b9c91945267f0c6087dbd20",
                "status": "modified"
            },
            {
                "additions": 44,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/dictionary.jsp",
                "changes": 44,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/dictionary.jsp?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "ui/dictionary.jsp",
                "patch": "@@ -1024,6 +1024,50 @@ dictionary = {\n 'label.purpose': '<fmt:message key=\"label.purpose\" />',\n 'label.Pxe.server.type': '<fmt:message key=\"label.Pxe.server.type\" />',\n 'label.quickview': '<fmt:message key=\"label.quickview\" />',\n+'label.usage.type': '<fmt:message key=\"label.usage.type\" />',\n+'label.usage.unit': '<fmt:message key=\"label.usage.unit\" />',\n+'label.quota.value': '<fmt:message key=\"label.quota.value\" />',\n+'label.quota.description': '<fmt:message key=\"label.quota.description\" />',\n+'label.quota.configuration': '<fmt:message key=\"label.quota.configuration\" />',\n+'label.quota.configure': '<fmt:message key=\"label.quota.configure\" />',\n+'label.quota.remove': '<fmt:message key=\"label.quota.remove\" />',\n+'label.quota.totalusage': '<fmt:message key=\"label.quota.totalusage\" />',\n+'label.quota.balance': '<fmt:message key=\"label.quota.balance\" />',\n+'label.quota.summary': '<fmt:message key=\"label.quota.summary\" />',\n+'label.quota.fullsummary': '<fmt:message key=\"label.quota.fullsummary\" />',\n+'label.quota.minbalance': '<fmt:message key=\"label.quota.minbalance\" />',\n+'label.quota.enforcequota': '<fmt:message key=\"label.quota.enforcequota\" />',\n+'label.quota.tariff': '<fmt:message key=\"label.quota.tariff\" />',\n+'label.quota.state': '<fmt:message key=\"label.quota.state\" />',\n+'label.quota.startdate': '<fmt:message key=\"label.quota.startdate\" />',\n+'label.quota.enddate': '<fmt:message key=\"label.quota.enddate\" />',\n+'label.quota.total': '<fmt:message key=\"label.quota.total\" />',\n+'label.quota.type.name': '<fmt:message key=\"label.quota.type.name\" />',\n+'label.quota.type.unit': '<fmt:message key=\"label.quota.type.unit\" />',\n+'label.quota.usage': '<fmt:message key=\"label.quota.usage\" />',\n+'label.quota.startquota': '<fmt:message key=\"label.quota.startquota\" />',\n+'label.quota.endquota': '<fmt:message key=\"label.quota.endquota\" />',\n+'label.quota.statement.quota': '<fmt:message key=\"label.quota.statement.quota\" />',\n+'label.quota.add.credits': '<fmt:message key=\"label.quota.add.credits\" />',\n+'label.quota.date': '<fmt:message key=\"label.quota.date\" />',\n+'label.quota.dates': '<fmt:message key=\"label.quota.dates\" />',\n+'label.quota.credit': '<fmt:message key=\"label.quota.credit\" />',\n+'label.quota.credits': '<fmt:message key=\"label.quota.credits\" />',\n+'label.quota.value': '<fmt:message key=\"label.quota.value\" />',\n+'label.quota.statement.bydates': '<fmt:message key=\"label.quota.statement.bydates\" />',\n+'label.quota.email.template': '<fmt:message key=\"label.quota.email.template\" />',\n+'label.quota.statement': '<fmt:message key=\"label.quota.statement\" />',\n+'label.quota.statement.balance': '<fmt:message key=\"label.quota.statement.balance\" />',\n+'label.quota.statement.tariff': '<fmt:message key=\"label.quota.statement.tariff\" />',\n+'label.quota.statement.balance': '<fmt:message key=\"label.quota.statement.balance\" />',\n+'label.quota.statement.tariff': '<fmt:message key=\"label.quota.statement.tariff\" />',\n+'label.quota.tariff.edit': '<fmt:message key=\"label.quota.tariff.edit\" />',\n+'label.quota.tariff.effectivedate': '<fmt:message key=\"label.quota.tariff.effectivedate\" />',\n+'label.quota.email.subject': '<fmt:message key=\"label.quota.email.subject\" />',\n+'label.quota.tariff.value': '<fmt:message key=\"label.quota.tariff.value\" />',\n+'label.quota.email.subject': '<fmt:message key=\"label.quota.email.subject\" />',\n+'label.quota.email.body': '<fmt:message key=\"label.quota.email.body\" />',\n+'label.quota.email.lastupdated': '<fmt:message key=\"label.quota.email.lastupdated\" />',\n 'label.rbd': '<fmt:message key=\"label.rbd\" />',\n 'label.rbd.monitor': '<fmt:message key=\"label.rbd.monitor\" />',\n 'label.rbd.pool': '<fmt:message key=\"label.rbd.pool\" />',",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/dictionary.jsp",
                "sha": "e82ae19ebbcdae86bdd68c44e2d75cf4519ed551",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/plugins.js",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/plugins.js?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "ui/plugins/plugins.js",
                "patch": "@@ -16,6 +16,7 @@\n // under the License.\n (function($, cloudStack) {\n   cloudStack.plugins = [\n-    // 'testPlugin'\n+    'quota',\n+    //'testPlugin'\n   ];\n }(jQuery, cloudStack));",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/plugins.js",
                "sha": "b629e3095b6c469fea5354f41501ddac15025da8",
                "status": "modified"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/config.js",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/quota/config.js?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "ui/plugins/quota/config.js",
                "patch": "@@ -0,0 +1,25 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+(function (cloudStack) {\n+  cloudStack.plugins.quota.config = {\n+    title: 'Quota',\n+    desc: 'CloudStack Quota',\n+    externalLink: 'http://www.cloudstack.org/',\n+    authorName: 'Apache CloudStack',\n+    authorEmail: 'dev@cloudstack.apache.org'\n+  };\n+}(cloudStack));",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/config.js",
                "sha": "186d50778400e8f67e8f539666db9bf14a1ba1e7",
                "status": "added"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/icon.png",
                "changes": 0,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/quota/icon.png?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "ui/plugins/quota/icon.png",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/icon.png",
                "sha": "a7ef5521d0fb2dc2d86b8259d7ac0db68c74d25d",
                "status": "added"
            },
            {
                "additions": 68,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/quota.css",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/quota/quota.css?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "ui/plugins/quota/quota.css",
                "patch": "@@ -0,0 +1,68 @@\n+/*\n+* Licensed to the Apache Software Foundation (ASF) under one\n+* or more contributor license agreements.  See the NOTICE file\n+* distributed with this work for additional information\n+* regarding copyright ownership.  The ASF licenses this file\n+* to you under the Apache License, Version 2.0 (the\n+* \"License\"); you may not use this file except in compliance\n+* with the License.  You may obtain a copy of the License at\n+*\n+*   http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing,\n+* software distributed under the License is distributed on an\n+* \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+* KIND, either express or implied.  See the License for the\n+* specific language governing permissions and limitations\n+* under the License.\n+*/\n+\n+.quota-tariff-edit {\n+    float: right;\n+}\n+\n+.quota-bold {\n+    font-size: 12px;\n+    font-weight: bold;\n+    color: #6D6D6D;\n+}\n+\n+.quota-text {\n+    font-size: 11px;\n+    color: #282828;\n+}\n+\n+.quota-element {\n+    margin: 5px;\n+    margin-left: 13px;\n+}\n+\n+.quota-input {\n+    background: #F6F6F6;\n+    border: 1px solid #AFAFAF;\n+    border-radius: 4px;\n+}\n+\n+.quota-button {\n+    border:1px solid #0077c7; -webkit-border-radius: 4px; -moz-border-radius: 4px; border-radius: 4px;\n+    font-size:11px;\n+    padding: 8px;\n+    margin-top: 12px;\n+    text-shadow: -1px -1px 0 rgba(0,0,0,0.3);font-weight:bold; color: #FFFFFF;\n+    background-color: #0099FF; background-image: -webkit-gradient(linear, left top, left bottom, from(#0099FF), to(#004FF7));\n+    background-image: -webkit-linear-gradient(top, #0099FF, #004FF7);\n+    background-image: -moz-linear-gradient(top, #0099FF, #004FF7);\n+    background-image: -ms-linear-gradient(top, #0099FF, #004FF7);\n+    background-image: -o-linear-gradient(top, #0099FF, #004FF7);\n+    background-image: linear-gradient(to bottom, #0099FF, #004FF7);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#0099FF, endColorstr=#004FF7);\n+}\n+\n+.quota-button:hover {\n+    border:1px solid #005c99;\n+    background-color: #0039B3; background-image: -webkit-gradient(linear, left top, left bottom, from(#0039B3), to(#004FF7));\n+    background-image: -webkit-linear-gradient(top, #0039B3, #004FF7);\n+    background-image: -moz-linear-gradient(top, #0039B3, #004FF7);\n+    background-image: -ms-linear-gradient(top, #0039B3, #004FF7);\n+    background-image: -o-linear-gradient(top, #0039B3, #004FF7);\n+    background-image: linear-gradient(to bottom, #0039B3, #004FF7);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#0039B3, endColorstr=#004FF7);\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/quota.css",
                "sha": "e9c0d8ff358c9ef16f8f4d04e7afc97578106500",
                "status": "added"
            },
            {
                "additions": 971,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/quota.js",
                "changes": 971,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/quota/quota.js?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 0,
                "filename": "ui/plugins/quota/quota.js",
                "patch": "@@ -0,0 +1,971 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+(function (cloudStack) {\n+    var now = new Date();\n+    var newstartdate;\n+    var newenddate;\n+    var currency;\n+    cloudStack.plugins.quota = function(plugin) {\n+        plugin.ui.addSection({\n+          id: 'quota',\n+          title: 'Quota',\n+          preFilter: function(args) {\n+              var retval = $.ajax({\n+              url: createURL(\"listConfigurations&name=quota.enable.service\"),\n+              async: false\n+                  });\n+              var json = JSON.parse(retval.responseText);\n+              return json.listconfigurationsresponse.configuration[0].value == 'true';\n+          },\n+          showOnNavigation: true,\n+          sectionSelect: {\n+              label: 'label.select-view',\n+              preFilter: function(args) {\n+              if (isAdmin())\n+                  return ['summary', 'fullSummary', 'tariffEdit', 'emailTemplates'];\n+              else\n+                  return  ['summary', 'tariffView'];\n+              }\n+          },\n+          sections: {\n+\n+              summary: {\n+                  type: 'select',\n+                  title: 'label.quota.summary',\n+                  listView: {\n+                      label: 'label.quota.summary',\n+                      disableInfiniteScrolling: true,\n+                      fields: {\n+                          account: {\n+                              label: 'label.account',\n+                              truncate: true\n+                          },\n+                          domain: {\n+                              label: 'label.domain'\n+                          },\n+                          balance: {\n+                              label: 'label.quota.balance',\n+                              limitcolor: true,\n+                              limits: {\n+                                  upperlimit: 'upperlimit',\n+                                  lowerlimit: 'lowerlimit'\n+                              },\n+                              converter: function(args){\n+                                  return currency + args.toString();\n+                              }\n+                          },\n+                          quota: {\n+                              label: 'label.quota.totalusage',\n+                              editable: true,\n+                              truncate: true\n+                          },\n+                          state: {\n+                              label: 'label.quota.state',\n+                              indicator: {\n+                                  'enabled': 'on',\n+                                  'disabled': 'off',\n+                                  'locked': 'off',\n+                              }\n+                          },\n+                      },\n+                      dataProvider: function(args) {\n+                          var data = {\n+                              page: args.page,\n+                              pagesize: pageSize\n+                          };\n+\n+                          // TODO: add logic in mgmt server to filter by account\n+                          if (args.filterBy.search.value) {\n+                              data.search = args.filterBy.search.value;\n+                          }\n+\n+                          $.ajax({\n+                              url: createURL('quotaSummary'),\n+                              data: data,\n+                              dataType: \"json\",\n+                              async: true,\n+                              success: function(json) {\n+                                  var items = json.quotasummaryresponse.summary;\n+                                  if(items){\n+                                      var array=[];\n+                                      for (var i = 0; i < items.length; i++) {\n+                                          if (typeof data.search != 'undefine' && items[i].account.search(data.search) < 0 && items[i].domain.search(data.search) < 0) {\n+                                              continue;\n+                                          }\n+                                          currency = items[i].currency;\n+                                          items[i].quota = currency + ' ' + items[i].quota;\n+                                          items[i].lowerlimit = -1;\n+                                          items[i].upperlimit = 0;\n+                                          array.push(items[i]);\n+                                      }\n+                                      args.response.success({\n+                                          data: array\n+                                      });\n+                                  }\n+                                  else {\n+                                      args.response.success({\n+                                          data: 0\n+                                      });\n+                                  }\n+                              },\n+                              error: function(data) {\n+                                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      },\n+                      detailView: {\n+                          viewAll: [{\n+                              path: 'quota.quotastatement',\n+                              label: 'label.quota.statement.quota'\n+                          },{\n+                              path: 'quota.balancestatement',\n+                              label: 'label.quota.statement.balance'\n+                          }],\n+                          actions: {\n+                             add: {\n+                                label: 'label.quota.add.credits',\n+                                preFilter: function(args) { return isAdmin(); },\n+                                messages: {\n+                                    confirm: function(args) {\n+                                        return 'label.quota.add.credits';\n+                                    },\n+                                    notification: function(args) {\n+                                        return 'label.quota.add.credits';\n+                                    }\n+                                },\n+\n+                                createForm: {\n+                                    title: 'label.quota.credits',\n+                                    desc: '',\n+                                    fields: {\n+                                         value: {\n+                                            label: 'label.quota.credits',\n+                                            validation: {\n+                                                required: true\n+                                            }\n+                                        },\n+                                        min_balance: {\n+                                            label: 'label.quota.minbalance',\n+                                            validation: {\n+                                                required: true\n+                                            }\n+                                        },\n+                                        quota_enforce: {\n+                                            label: 'label.quota.enforcequota',\n+                                            isBoolean: true,\n+                                            isChecked: false\n+                                        },\n+                                    }\n+\n+                                },\n+\n+                                action: function(args) {\n+                                    var enforce=args.data.quota_enforce == 'on' ? true: false;\n+                                    $.ajax({\n+                                        url: createURL('quotaCredits'),\n+                                        data: {\n+                                            domainid: args.context.summary[0].domainid,\n+                                            account: args.context.summary[0].account,\n+                                            value: args.data.value,\n+                                            min_balance: args.data.min_balance,\n+                                            quota_enforce: enforce\n+                                        },\n+                                        async: false,\n+                                        success: function(json) {\n+                                            args.response.success({\n+                                                data: json.quotacreditsresponse.totalquota\n+                                            });\n+                                        }\n+                                    });\n+                                    $(window).trigger('cloudStack.fullRefresh');\n+                                 }\n+                            },\n+                          },\n+                          tabs: {\n+                             details: {\n+                                    title: 'label.details',\n+                                    fields: [{\n+                                        id: {\n+                                            label: 'label.quota.statement.balance'\n+                                        }\n+                                    }, {\n+                                        startdate: {\n+                                            label: 'label.quota.date',\n+                                        },\n+                                        startquota: {\n+                                            label: 'label.quota.value',\n+                                        }\n+                                    }],\n+                                    dataProvider: function(args) {\n+                                        $.ajax({\n+                                            url: createURL('quotaBalance'),\n+                                            dataType: 'json',\n+                                            async: true,\n+                                            data: {\n+                                                domainid: args.context.summary[0].domainid,\n+                                                account: args.context.summary[0].account\n+                                            },\n+                                            success: function(json) {\n+                                                var item = json.quotabalanceresponse.balance;\n+                                                item.startdate = now.toJSON().slice(0,10);\n+                                                item.startquota = item.currency + ' ' + item.startquota;\n+                                                args.response.success({\n+                                                    data: item\n+                                                });\n+                                            } ,\n+                                            error:function(data) {\n+                                                args.response.error(parseXMLHttpResponse(data));\n+                                            }\n+                                        });\n+                                    }\n+                                },\n+\n+                          }\n+                      }\n+                  }\n+              },\n+\n+              fullSummary: {\n+                  type: 'select',\n+                  title: 'label.quota.fullsummary',\n+                  listView: {\n+                      label: 'label.quota.fullsummary',\n+                      disableInfiniteScrolling: true,\n+                      fields: {\n+                          account: {\n+                              label: 'label.account',\n+                              truncate: true\n+                          },\n+                          domain: {\n+                              label: 'label.domain'\n+                          },\n+                          balance: {\n+                              label: 'label.quota.balance',\n+                              limitcolor: true,\n+                              limits: {\n+                                  upperlimit: 'upperlimit',\n+                                  lowerlimit: 'lowerlimit'\n+                              },\n+                              converter: function(args){\n+                                  return currency + args.toString();\n+                              }\n+                          },\n+                          quota: {\n+                              label: 'label.quota.totalusage',\n+                              editable: true,\n+                              truncate: true\n+                          },\n+                          state: {\n+                              label: 'label.quota.state',\n+                              indicator: {\n+                                  'enabled': 'on',\n+                                  'disabled': 'off',\n+                                  'locked': 'off',\n+                              }\n+                          },\n+                      },\n+                      dataProvider: function(args) {\n+                          var data = {\n+                              page: args.page,\n+                              pagesize: pageSize\n+                          };\n+\n+                          // TODO: add logic in mgmt server to filter by account\n+                          if (args.filterBy.search.value) {\n+                              data.search = args.filterBy.search.value;\n+                          }\n+\n+                          $.ajax({\n+                              url: createURL('quotaSummary&listall=true'),\n+                              data: data,\n+                              dataType: \"json\",\n+                              async: true,\n+                              success: function(json) {\n+                                  var items = json.quotasummaryresponse.summary;\n+                                  if(items){\n+                                      var array=[];\n+                                      for (var i = 0; i < items.length; i++) {\n+                                          if (typeof data.search != 'undefine' && items[i].account.search(data.search) < 0 && items[i].domain.search(data.search) < 0) {\n+                                              continue;\n+                                          }\n+                                          currency = items[i].currency;\n+                                          items[i].quota = currency + ' ' + items[i].quota;\n+                                          items[i].lowerlimit = -1;\n+                                          items[i].upperlimit = 0;\n+                                          array.push(items[i]);\n+                                      }\n+                                      args.response.success({\n+                                          data: array\n+                                      });\n+                                  }\n+                                  else {\n+                                      args.response.success({\n+                                          data: 0\n+                                      });\n+                                  }\n+                              },\n+                              error: function(data) {\n+                                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      },\n+                      detailView: {\n+                          viewAll: [{\n+                              path: 'quota.quotastatement',\n+                              label: 'label.quota.statement.quota'\n+                          },{\n+                              path: 'quota.balancestatement',\n+                              label: 'label.quota.statement.balance'\n+                          }],\n+                          actions: {\n+                             add: {\n+                                label: 'label.quota.add.credits',\n+                                preFilter: function(args) { return isAdmin(); },\n+                                messages: {\n+                                    confirm: function(args) {\n+                                        return 'label.quota.add.credits';\n+                                    },\n+                                    notification: function(args) {\n+                                        return 'label.quota.add.credits';\n+                                    }\n+                                },\n+\n+                                createForm: {\n+                                    title: 'label.quota.credits',\n+                                    desc: '',\n+                                    fields: {\n+                                         value: {\n+                                            label: 'label.quota.credits',\n+                                            validation: {\n+                                                required: true\n+                                            }\n+                                        },\n+                                        min_balance: {\n+                                            label: 'label.quota.minbalance',\n+                                            validation: {\n+                                                required: true\n+                                            }\n+                                        },\n+                                        quota_enforce: {\n+                                            label: 'label.quota.enforcequota',\n+                                            isBoolean: true,\n+                                            isChecked: false\n+                                        },\n+                                    }\n+\n+                                },\n+\n+                                action: function(args) {\n+                                     var enforce=args.data.quota_enforce == 'on' ? true: false;\n+                                     $.ajax({\n+                                         url: createURL('quotaCredits'),\n+                                         data: {\n+                                             domainid: args.context.fullSummary[0].domainid,\n+                                             account: args.context.fullSummary[0].account,\n+                                             value: args.data.value,\n+                                             min_balance: args.data.min_balance,\n+                                             quota_enforce: enforce\n+                                         },\n+                                        async: false,\n+                                        success: function(json) {\n+                                            args.response.success({\n+                                                data: json.quotacreditsresponse.totalquota\n+                                            });\n+                                        }\n+                                    });\n+                                    $(window).trigger('cloudStack.fullRefresh');\n+                                 }\n+                            },\n+                          },\n+                          tabs: {\n+                             details: {\n+                                    title: 'label.details',\n+                                    fields: [{\n+                                        id: {\n+                                            label: 'label.quota.statement.balance'\n+                                        }\n+                                    }, {\n+                                        startdate: {\n+                                            label: 'label.quota.date',\n+                                        },\n+                                        startquota: {\n+                                            label: 'label.quota.value',\n+                                        }\n+                                    }],\n+                                    dataProvider: function(args) {\n+                                        $.ajax({\n+                                            url: createURL('quotaBalance'),\n+                                            dataType: 'json',\n+                                            async: true,\n+                                            data: {\n+                                                domainid: args.context.fullSummary[0].domainid,\n+                                                account: args.context.fullSummary[0].account\n+                                            },\n+                                            success: function(json) {\n+                                                var item = json.quotabalanceresponse.balance;\n+                                                item.startdate = now.toJSON().slice(0,10);\n+                                                item.startquota = item.currency + ' ' + item.startquota;\n+                                                args.response.success({\n+                                                    data: item\n+                                                });\n+                                            } ,\n+                                            error:function(data) {\n+                                                args.response.error(parseXMLHttpResponse(data));\n+                                            }\n+                                        });\n+                                    }\n+                                },\n+                           }\n+                      }\n+                  }\n+              },\n+\n+             quotastatement:{\n+                  id: 'statementbalance',\n+                  title: 'label.quota.statement',\n+                  preFilter: function(args) {\n+                      return false;\n+                  },\n+                  listView: {\n+                      label: 'label.quota.statement.quota',\n+                      disableInfiniteScrolling: true,\n+                      fields: {\n+                            name: {\n+                                label: 'label.quota.type.name'\n+                            },\n+                            unit: {\n+                                label: 'label.quota.type.unit'\n+                            },\n+                            quota: {\n+                                label: 'label.quota.usage'\n+                            }\n+                      },\n+                      actions: {\n+                              add: {\n+                                    label: 'label.quota.dates',\n+                                    createForm: {\n+                                          title: 'label.quota.dates',\n+                                          fields: {\n+                                            startdate: {\n+                                                label: 'label.quota.startdate',\n+                                                isDatepicker: true,\n+                                                maxDate: '+0d',\n+                                                validation: {\n+                                                    required: true\n+                                                }\n+                                            },\n+                                            enddate: {\n+                                                label: 'label.quota.enddate',\n+                                                isDatepicker: true,\n+                                                maxDate: '+0d',\n+                                                validation: {\n+                                                    required: true\n+                                                }\n+                                            }\n+                                        }\n+                                      },\n+                                     action: function(args) {\n+                                        newstartdate= args.data.startdate.slice(0,10);\n+                                        newenddate= args.data.enddate.slice(0,10);\n+                                        $(window).trigger('cloudStack.fullRefresh');\n+                                    }\n+                            }\n+                       },\n+                      dataProvider: function(args) {\n+                          $.ajax({\n+                              url: createURL('quotaStatement'),\n+                              dataType: 'json',\n+                              async: true,\n+                              data: {\n+                                  domainid: args.context.summary[0].domainid,\n+                                  account: args.context.summary[0].account,\n+                                  startdate: function() {\n+                                         if (typeof newstartdate == 'undefined') {\n+                                             return  args.context.summary[0].startdate.slice(0,10);\n+                                         } else {\n+                                             return newstartdate;\n+                                         }\n+                                },\n+                                  enddate: function() {\n+                                     if (typeof newenddate == 'undefined') {\n+                                          return  now.toJSON().slice(0,10);\n+                              } else {\n+                                                      return newenddate;\n+                              }\n+                   }\n+                              },\n+                              success: function(json) {\n+                                  var usages = json.quotastatementresponse.statement.quotausage;\n+                                  var currency = json.quotastatementresponse.statement.currency;\n+                                  $.each(usages, function(idx, item) {\n+                                      usages[idx].quota = currency + ' ' + usages[idx].quota;\n+                                  });\n+                                  usages.push({\n+                                        name: _l('label.quota.total') + ' : ',\n+                                        unit:'',\n+                                        quota: currency + ' ' + json.quotastatementresponse.statement.totalquota\n+                                    });\n+\n+                                  usages.unshift({\n+                                      name: _l('label.quota.startdate')  + ' : ' + json.quotastatementresponse.statement.startdate.slice(0,10),\n+                                      unit: _l('label.quota.enddate')  + ' : ' + json.quotastatementresponse.statement.enddate.slice(0,10),\n+                                      quota: ''\n+                                  });\n+\n+\n+                                  args.response.success({\n+                                      data: usages\n+                                  });\n+                              },\n+                              error:function(data) {\n+                                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      }\n+                  } // end list view\n+              }, // end statement\n+\n+\n+              balancestatement:{\n+                  id: 'balancestatement',\n+                  title: 'label.quota.statement.balance',\n+                  listView: {\n+                      label: 'label.quota.statement.balance',\n+                      disableInfiniteScrolling: true,\n+                      fields: {\n+                            date: {\n+                                label: 'label.quota.date'\n+                            },\n+                            quota: {\n+                                label: 'label.quota.value'\n+                            },\n+                            credit: {\n+                                label: 'label.quota.credit'\n+                            }\n+                      },\n+\n+                      actions: {\n+                              add: {\n+                                    label: 'label.quota.dates',\n+                                    createForm: {\n+                                          title: 'label.quota.dates',\n+                                          fields: {\n+                                            startdate: {\n+                                                label: 'label.quota.startdate',\n+                                                isDatepicker: true,\n+                                                maxDate: '+0d',\n+                                                validation: {\n+                                                    required: true\n+                                                }\n+                                            },\n+                                            enddate: {\n+                                                label: 'label.quota.enddate',\n+                                                isDatepicker: true,\n+                                                maxDate: '+0d',\n+                                                validation: {\n+                                                    required: true\n+                                                }\n+                                            }\n+                                        }\n+                                      },\n+                                    action: function(args) {\n+                                            newstartdate= args.data.startdate.slice(0,10);\n+                                            newenddate= args.data.enddate.slice(0,10);\n+                                            $(window).trigger('cloudStack.fullRefresh');\n+                                        }\n+                                  }\n+                           },\n+\n+                      dataProvider: function(args) {\n+                          $.ajax({\n+                              url: createURL('quotaBalance'),\n+                              dataType: 'json',\n+                              async: true,\n+                              data: {\n+                                  domainid: args.context.summary[0].domainid,\n+                                  account: args.context.summary[0].account,\n+                                  startdate: function() {\n+                                       if (typeof newstartdate == 'undefined') {\n+                                           return  args.context.summary[0].startdate.slice(0,10);\n+                                       } else {\n+                                           return newstartdate;\n+                                       }\n+                                    },\n+                                   enddate: function() {\n+                             if (typeof newenddate == 'undefined') {\n+                                  return  now.toJSON().slice(0,10);\n+                          } else {\n+                                           return newenddate;\n+                          }\n+                                  }\n+                              },\n+                              success: function(json) {\n+                                  var bal = json.quotabalanceresponse.balance;\n+                                  var currency = bal.currency;\n+                                  var array=[{\n+                                               date: bal.startdate.slice(0,10),\n+                                               quota: currency + ' ' + bal.startquota,\n+                                               credit: ''\n+                                  }];\n+                                  //now add all credits\n+                                  for (var i = 0; i < bal.credits.length; i++) {\n+                                        array.push({\n+                                            date: bal.credits[i].updated_on.slice(0,10),\n+                                            quota: '',\n+                                            credit:  currency + ' ' + bal.credits[i].credits\n+                                        });\n+                                    }\n+                                  array.push({\n+                                            date: bal.enddate.slice(0,10),\n+                                            quota:  currency + ' ' + bal.endquota,\n+                                            credit: ''\n+                                        });\n+                                  args.response.success({\n+                                      data: array\n+                                  });\n+                              },\n+                              error:function(data) {\n+                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      }\n+                  } // end list view\n+              }, // end statement\n+\n+\n+              tariffEdit: {\n+                  type: 'select',\n+                  title: 'label.quota.tariff',\n+                  listView: {\n+                      label: 'label.quota.tariff',\n+                      disableInfiniteScrolling: true,\n+                      actions: {\n+                          edit: {\n+                              label: 'label.change.value',\n+                              action: function(args) {\n+                                  if (isAdmin()) {\n+                                       var data = {\n+                                            usagetype: args.data.jsonObj.usageType,\n+                                       };\n+                                      var tariffVal = args.data.tariffValue.split(' ');\n+                                      if (tariffVal.length==2){\n+                                          data.value = tariffVal[1];\n+                                      }\n+                                      else {\n+                                          data.value = tariffVal[0];\n+                                      }\n+                                      if (!isNaN(parseFloat(data.value)) && isFinite(data.value)){\n+                                          var updateTariffForm = cloudStack.dialog.createForm({\n+                                              form: {\n+                                                  title: 'label.quota.configuration',\n+                                                  fields: {\n+                                                      tariffValue: {\n+                                                          label: 'label.quota.value',\n+                                                          number: true,\n+                                                          validation: {\n+                                                              required: true\n+                                                          }\n+                                                      },\n+                                                      effectiveDate: {\n+                                                          label: 'label.quota.tariff.effectivedate',\n+                                                          isDatepicker: true,\n+                                                          dependsOn: 'startdate',\n+                                                          minDate: '+1d',\n+                                                          validation: {\n+                                                              required: true\n+                                                          }\n+                                                      },\n+                                                  }\n+                                              },\n+                                              after: function(argsLocal) {\n+                                                  data.startDate = argsLocal.data.effectiveDate;\n+                                                  data.value = argsLocal.data.tariffValue;\n+                                                  $.ajax({\n+                                                      url: createURL('quotaTariffUpdate'),\n+                                                      data: data,\n+                                                      type: \"POST\",\n+                                                      success: function(json) {\n+                                                          // Refresh listings on chosen date to reflect new tariff\n+                                                          $($.find('div.search-bar input')).val(data.startDate);\n+                                                          $('#basic_search').click();\n+                                                      }\n+                                                  });\n+                                              }\n+                                          });\n+                                          updateTariffForm.find('input[name=tariffValue]').val(data.value);\n+                                          updateTariffForm.find('input[name=effectiveDate]').focus();\n+                                      }\n+                                      else {\n+                                          alert(\"Bad tariff value, this should be a number \" + data.value);\n+                                          $(window).trigger('cloudStack.fullRefresh');\n+                                      }//bad data.value - NaN\n+                                  } // if is ADMIN\n+                              } // end action\n+                          }//edits\n+                      },//actions\n+                      fields: {\n+                          usageName: {\n+                              label: 'label.usage.type',\n+                              id: true,\n+                              truncate: true\n+                          },\n+                          usageUnit: {\n+                              label: 'label.usage.unit'\n+                          },\n+                          tariffValue: {\n+                              label: 'label.quota.tariff.value',\n+                              editable: true\n+                          },\n+                          description: {\n+                              label: 'label.quota.description',\n+                              truncate: true\n+                          }\n+                      },\n+                      dataProvider: function(args) {\n+                          var data = {};\n+                          if (args.filterBy.search.value) {\n+                              data.startdate = args.filterBy.search.value;\n+                          }\n+                          $.ajax({\n+                              url: createURL('quotaTariffList'),\n+                              data: data,\n+                              dataType: \"json\",\n+                              async: true,\n+                              success: function(json) {\n+                                  var items = json.quotatarifflistresponse.quotatariff;\n+                                  $.each(items, function(idx, item) {\n+                                      items[idx].tariffValue =  items[idx].currency + ' ' + items[idx].tariffValue;\n+                                  });\n+                                  args.response.success({\n+                                      data: items\n+                                  });\n+\n+                                  $($.find('.list-view')).data('end-of-table', true);\n+                                  // Hook up date picker\n+                                  var input = $($.find('div.search-bar input'));\n+                                  input.datepicker({\n+                                      defaultDate: new Date(),\n+                                      changeMonth: true,\n+                                      dateFormat: \"yy-mm-dd\",\n+                                  });\n+                                  input.parent().attr('title', _l('label.quota.effectivedate'));\n+                              },\n+                              error: function(data) {\n+                                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      }\n+                  }\n+              },\n+\n+\n+              tariffView: {\n+                  type: 'select',\n+                  title: 'label.quota.tariff',\n+                  listView: {\n+                      label: 'label.quota.tariff',\n+                      disableInfiniteScrolling: true,\n+                      fields: {\n+                          usageName: {\n+                              label: 'label.usage.type',\n+                              id: true,\n+                              truncate: true\n+                          },\n+                          usageUnit: {\n+                              label: 'label.usage.unit'\n+                          },\n+                          tariffValue: {\n+                              label: 'label.quota.tariff.value',\n+                          },\n+                          description: {\n+                              label: 'label.quota.description',\n+                              truncate: true\n+                          }\n+                      },\n+                      dataProvider: function(args) {\n+                          var data = {};\n+                          if (args.filterBy.search.value) {\n+                              data.startdate = args.filterBy.search.value;\n+                          }\n+                          $.ajax({\n+                              url: createURL('quotaTariffList'),\n+                              data: data,\n+                              dataType: \"json\",\n+                              async: true,\n+                              success: function(json) {\n+                                  var items = json.quotatarifflistresponse.quotatariff;\n+                                  $.each(items, function(idx, item) {\n+                                      items[idx].tariffValue =  items[idx].currency + ' ' + items[idx].tariffValue;\n+                                  });\n+                                  args.response.success({\n+                                      data: items\n+                                  });\n+\n+                                  $($.find('.list-view')).data('end-of-table', true);\n+                                  // Hook up date picker\n+                                  var input = $($.find('div.search-bar input'));\n+                                  input.datepicker({\n+                                      defaultDate: new Date(),\n+                                      changeMonth: true,\n+                                      dateFormat: \"yy-mm-dd\",\n+                                  });\n+                                  input.parent().attr('title', _l('label.quota.effectivedate'));\n+                              },\n+                              error: function(data) {\n+                                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      }\n+                  }\n+              },\n+\n+              emailTemplates: {\n+                  type: 'select',\n+                  title: 'label.quota.email.template',\n+                  listView: {\n+                      label: 'label.quota.email.template',\n+                      disableInfiniteScrolling: true,\n+                      fields: {\n+                          templatetype: {\n+                              label: 'label.quota.email.template',\n+                          },\n+                          templatesubject: {\n+                              label: 'label.quota.email.subject',\n+                              truncate: true\n+                          },\n+                          templatebody: {\n+                              label: 'label.quota.email.body',\n+                              truncate: true\n+                          },\n+                          last_updated: {\n+                              label: 'label.quota.email.lastupdated',\n+                              truncate: true\n+                          },\n+                      },\n+                      dataProvider: function(args) {\n+                          var data = {};\n+                          if (args.filterBy.search.value) {\n+                              data.templatetype = args.filterBy.search.value;\n+                          }\n+\n+                          $.ajax({\n+                              url: createURL('quotaEmailTemplateList'),\n+                              data: data,\n+                              dataType: \"json\",\n+                              async: true,\n+                              success: function(json) {\n+                                  if (!json.hasOwnProperty('quotaemailtemplatelistresponse') || !json.quotaemailtemplatelistresponse.hasOwnProperty('quotaemailtemplate')) {\n+                                      return;\n+                                  }\n+                                  var items = json.quotaemailtemplatelistresponse.quotaemailtemplate;\n+                                  args.response.success({\n+                                      data: items\n+                                  });\n+                              },\n+                              error: function(data) {\n+                                  cloudStack.dialog.notice({\n+                                      message: parseXMLHttpResponse(data)\n+                                  });\n+                              }\n+                          });\n+                      },\n+                      detailView: {\n+                          actions: {\n+                              edit: {\n+                                  label: 'label.quota.email.edit',\n+                                  messages: {\n+                                      notification: function(args) {\n+                                          return 'label.quota.email.edit';\n+                                      }\n+                                  },\n+                                  action: function(args) {\n+                                      args.data.templatetype = args.context.emailTemplates[0].templatetype;\n+                                      $.ajax({\n+                                          url: createURL('quotaEmailTemplateUpdate'),\n+                                          data: args.data,\n+                                          success: function(json) {\n+                                              args.response.success({\n+                                                  _custom: {\n+                                                      success: true\n+                                                  }\n+                                              });\n+                                          }\n+                                      });\n+                                  }\n+                              }\n+                          },\n+\n+                          tabs: {\n+                              details: {\n+                                  title: 'label.details',\n+                                  fields: [{\n+                                      templatetype: {\n+                                          label: 'label.quota.email.template'\n+                                      }\n+                                  }, {\n+                                      templatesubject: {\n+                                          label: 'label.quota.email.subject',\n+                                          isEditable: true,\n+                                          textArea: true\n+                                      },\n+                                      templatebody: {\n+                                          label: 'label.quota.email.body',\n+                                          isEditable: true,\n+                                          textArea: true\n+                                      },\n+                                      last_updated: {\n+                                          label: 'label.quota.email.lastupdated',\n+                                      },\n+                                  }],\n+\n+                                  dataProvider: function(args) {\n+                                      $.ajax({\n+                                          url: createURL('quotaEmailTemplateList'),\n+                                          data: {\n+                                              templatetype: args.context.emailTemplates[0].templatetype\n+                                          },\n+                                          success: function(json) {\n+                                              var item = json.quotaemailtemplatelistresponse.quotaemailtemplate[0];\n+                                              args.response.success({\n+                                                  data: item\n+                                              });\n+                                          }\n+                                      });\n+                                  }\n+                              }\n+                          }\n+                      }\n+                  }\n+              }\n+\n+          }\n+      });\n+  };\n+}(cloudStack));",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/plugins/quota/quota.js",
                "sha": "6051b2c8fc8e10ad43f02c3374c2d90bfb9e162b",
                "status": "added"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/scripts/ui/dialog.js",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/ui/dialog.js?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "ui/scripts/ui/dialog.js",
                "patch": "@@ -527,7 +527,9 @@\n                     }\n                     $input.addClass(\"disallowSpecialCharacters\");\n                     $input.datepicker({\n-                        dateFormat: 'yy-mm-dd'\n+\t\t\tdateFormat: 'yy-mm-dd',\n+\t\t\tmaxDate: field.maxDate,\n+\t\t\tminDate: field.minDate\n                     });\n \n                 } else if (field.range) { //2 text fields on the same line (e.g. port range: startPort - endPort)",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/scripts/ui/dialog.js",
                "sha": "5e28ba3a10da09647fff1e9c4aa0a4dfe3ede877",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/scripts/ui/widgets/detailView.js",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/ui/widgets/detailView.js?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 3,
                "filename": "ui/scripts/ui/widgets/detailView.js",
                "patch": "@@ -442,7 +442,7 @@\n             if ($detailView.find('.button.done').size()) return false;\n \n             // Convert value TDs\n-            var $inputs = $detailView.find('input, select').filter(function() {\n+            var $inputs = $detailView.find('input, select, textarea').filter(function() {\n                 return !$(this).closest('.tagger').size() && !$(this).attr('type') == 'submit';\n             });\n             var action = args.actions[args.actionName];\n@@ -507,11 +507,17 @@\n                             $input.find('option:selected').html()\n                         ));\n                         $value.data('detail-view-selected-option', _s($input.find('option:selected').val()));\n+                    } else if ($input.is('textarea')) {\n+                        $value.html(_s(\n+                            $input.val()\n+                        ));\n+                        $value.data('detail-view-editable-textarea', _s($input.find('option:selected').val()));\n                     }\n                 });\n \n-                if ($token != null)\n+                if ($token) {\n                     $token.html(_s(tags_value));\n+                }\n             };\n \n             var removeEditForm = function() {\n@@ -627,7 +633,7 @@\n             };\n \n             $editButton.click(function() {\n-                var $inputs = $detailView.find('input, select').filter(function() {\n+                var $inputs = $detailView.find('input, select, textarea').filter(function() {\n                     return !$(this).closest('.tagger').size();\n                 });\n                 var $form = $detailView.find('form').filter(function() {\n@@ -673,6 +679,7 @@\n                 // Turn into form field\n                 var selectData = $value.data('detail-view-editable-select');\n                 var isBoolean = $value.data('detail-view-editable-boolean');\n+                var textArea = $value.data('detail-view-editable-textarea');\n                 var isTokenInput = $value.data('detail-view-is-token-input');\n                 var data = !isBoolean ? cloudStack.sanitizeReverse($value.html()) : $value.data('detail-view-boolean-value');\n                 var rules = $value.data('validation-rules') ? $value.data('validation-rules') : {};\n@@ -761,6 +768,15 @@\n                     $value.append($input);\n                     token_value = data;\n                     $value.data('value-token').dataProvider(selectArgs);\n+                } else if (textArea) {\n+                    // Text area\n+                    $value.append(\n+                        $('<textarea>').attr({\n+                            name: name,\n+                            value: data\n+                        }).css({'min-height': '80px'}).data('original-value', data)\n+                    );\n+                    $value.css({'width': '100%', 'height': '100%'});\n                 } else {\n                     // Text input\n                     $value.append(\n@@ -1131,6 +1147,8 @@\n                 } else if (value.isBoolean) {\n                     $value.data('detail-view-editable-boolean', true);\n                     $value.data('detail-view-boolean-value', content == 'Yes' ? true : false);\n+                } else if (value.textArea) {\n+                    $value.data('detail-view-editable-textarea', true);\n                 } else {\n                     $value.data('detail-view-is-password', value.isPassword);\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/scripts/ui/widgets/detailView.js",
                "sha": "ddd726577475b29a5b1ad7609effbb779935d0a3",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/scripts/ui/widgets/listView.js",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/ui/widgets/listView.js?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "ui/scripts/ui/widgets/listView.js",
                "patch": "@@ -1256,6 +1256,20 @@\n                     }\n                 }\n \n+\n+                if (field.limitcolor && field.limits) {\n+                    if ((field.limits.lowerlimit in dataItem) && (field.limits.upperlimit in dataItem)) {\n+                        var upperlimit = parseFloat(dataItem[field.limits.upperlimit]);\n+                        var lowerlimit = parseFloat(dataItem[field.limits.lowerlimit ]);\n+                        var value = parseFloat(content);\n+                        if (value <= lowerlimit) {\n+                            $td.addClass('alert-disable-threshold');\n+                        } else if (value <= upperlimit) {\n+                            $td.addClass('alert-notification-threshold');\n+                        }\n+                    }\n+                }\n+\n                 if (field.id == true) id = field.id;\n                 if ($td.index()) $td.addClass('reduced-hide');\n                 if (field.action) {\n@@ -2162,7 +2176,11 @@\n \n         // Infinite scrolling event\n         $listView.bind('scroll', function(event) {\n-            if (args.listView && args.listView.disableInfiniteScrolling) return false;\n+            var listView = args.listView;\n+            if (!listView && args.sections && args.sections.hasOwnProperty(args.activeSection)) {\n+                listView = args.sections[args.activeSection].listView;\n+            }\n+            if (listView && listView.disableInfiniteScrolling) return false;\n             if ($listView.find('tr.last, td.loading:visible').size()) return false;\n \n             clearTimeout(infScrollTimer);",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/ui/scripts/ui/widgets/listView.js",
                "sha": "e61f43c837228da960883a0ba17d8caf714de4be",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/usage/pom.xml",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/usage/pom.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 4,
                "filename": "usage/pom.xml",
                "patch": "@@ -35,6 +35,11 @@\n       <artifactId>cloud-engine-components-api</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n+    <dependency>\n+        <groupId>org.apache.cloudstack</groupId>\n+        <artifactId>cloud-framework-quota</artifactId>\n+        <version>${project.version}</version>\n+    </dependency>\n     <dependency>\n       <groupId>commons-daemon</groupId>\n       <artifactId>commons-daemon</artifactId>\n@@ -55,10 +60,6 @@\n         <artifactId>slf4j-log4j12</artifactId>\n         <version>1.7.7</version>\n       </dependency>\n-    <dependency>\n-      <groupId>javax.mail</groupId>\n-      <artifactId>mail</artifactId>\n-    </dependency>\n     <dependency>\n       <groupId>org.dbunit</groupId>\n       <artifactId>dbunit</artifactId>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/usage/pom.xml",
                "sha": "74273a027e2d99e59100ab5348d3c7407d2ad31d",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/usage/resources/usageApplicationContext.xml",
                "changes": 47,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/usage/resources/usageApplicationContext.xml?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 24,
                "filename": "usage/resources/usageApplicationContext.xml",
                "patch": "@@ -17,36 +17,35 @@\n   under the License.\n -->\n <beans xmlns=\"http://www.springframework.org/schema/beans\"\n-  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" \n-  xmlns:context=\"http://www.springframework.org/schema/context\"\n-  xmlns:tx=\"http://www.springframework.org/schema/tx\" \n-  xmlns:aop=\"http://www.springframework.org/schema/aop\"\n-  xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n+\txmlns:tx=\"http://www.springframework.org/schema/tx\" xmlns:aop=\"http://www.springframework.org/schema/aop\"\n+\txsi:schemaLocation=\"http://www.springframework.org/schema/beans\n                       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\n                       http://www.springframework.org/schema/tx \n                       http://www.springframework.org/schema/tx/spring-tx-3.0.xsd\n                       http://www.springframework.org/schema/aop\n                       http://www.springframework.org/schema/aop/spring-aop-3.0.xsd\n                       http://www.springframework.org/schema/context\n-                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">                     \n+                      http://www.springframework.org/schema/context/spring-context-3.0.xsd\">\n \n-  <context:annotation-config />\n-  <context:component-scan base-package=\"com.cloud.usage, com.cloud.event.dao, com.cloud.user.dao, com.cloud.configuration.dao, com.cloud.alert.dao, com.cloud.domain.dao, org.apache.cloudstack.framework.config.dao\">\n-  </context:component-scan>\n-  \n-  <!--\n-    @DB support\n-  -->\n-  <bean id=\"transactionContextBuilder\" class=\"com.cloud.utils.db.TransactionContextBuilder\" />\n+\t<context:annotation-config />\n+\t<context:component-scan\n+\t\tbase-package=\"com.cloud.usage, com.cloud.event.dao, com.cloud.user.dao, com.cloud.configuration.dao, com.cloud.alert.dao, com.cloud.domain.dao, org.apache.cloudstack.framework.config.dao, org.apache.cloudstack.quota,\n+      org.apache.cloudstack.quota.constant, org.apache.cloudstack.quota.dao, org.apache.cloudstack.quota.vo\">\n+\t</context:component-scan>\n+\n+\t<!-- @DB support -->\n+\t<bean id=\"transactionContextBuilder\" class=\"com.cloud.utils.db.TransactionContextBuilder\" />\n+\n+\t<bean id=\"instantiatePostProcessor\"\n+\t\tclass=\"com.cloud.utils.component.ComponentInstantiationPostProcessor\">\n+\t\t<property name=\"Interceptors\">\n+\t\t\t<list>\n+\t\t\t\t<ref bean=\"transactionContextBuilder\" />\n+\t\t\t</list>\n+\t\t</property>\n+\t</bean>\n+\n+\t<bean id=\"ComponentContext\" class=\"com.cloud.utils.component.ComponentContext\" />\n \n-  <bean id=\"instantiatePostProcessor\" class=\"com.cloud.utils.component.ComponentInstantiationPostProcessor\">\n-    <property name=\"Interceptors\">\n-        <list>\n-            <ref bean=\"transactionContextBuilder\" />\n-        </list>\n-    </property>\n-  </bean>\n-  \n-  <bean id=\"ComponentContext\" class=\"com.cloud.utils.component.ComponentContext\" />\n- \n </beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/usage/resources/usageApplicationContext.xml",
                "sha": "f5cc9a370ee3f16f9391b4b648e1f0690487b4e4",
                "status": "modified"
            },
            {
                "additions": 30,
                "blob_url": "https://github.com/apache/cloudstack/blob/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/usage/src/com/cloud/usage/UsageManagerImpl.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/usage/src/com/cloud/usage/UsageManagerImpl.java?ref=987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9",
                "deletions": 1,
                "filename": "usage/src/com/cloud/usage/UsageManagerImpl.java",
                "patch": "@@ -33,10 +33,12 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+import org.apache.cloudstack.quota.QuotaAlertManager;\n+import org.apache.cloudstack.quota.QuotaManager;\n+import org.apache.cloudstack.quota.QuotaStatement;\n import org.apache.cloudstack.utils.usage.UsageUtils;\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n-\n import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n import org.apache.cloudstack.usage.UsageTypes;\n@@ -142,11 +144,18 @@\n     ConfigurationDao _configDao;\n     @Inject\n     private UsageVMSnapshotDao _usageVMSnapshotDao;\n+    @Inject\n+    private QuotaManager _quotaManager;\n+    @Inject\n+    private QuotaAlertManager _alertManager;\n+    @Inject\n+    private QuotaStatement _quotaStatement;\n \n     private String _version = null;\n     private final Calendar _jobExecTime = Calendar.getInstance();\n     private int _aggregationDuration = 0;\n     private int _sanityCheckInterval = 0;\n+    private boolean _runQuota=false;\n     String _hostname = null;\n     int _pid = 0;\n     TimeZone _usageTimezone = TimeZone.getTimeZone(\"GMT\");;\n@@ -197,6 +206,8 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         String execTimeZone = configs.get(\"usage.execution.timezone\");\n         String aggreagationTimeZone = configs.get(\"usage.aggregation.timezone\");\n         String sanityCheckInterval = configs.get(\"usage.sanity.check.interval\");\n+        String quotaEnable = configs.get(\"quota.enable.service\");\n+        _runQuota = Boolean.valueOf(quotaEnable == null ? \"false\" : quotaEnable );\n         if (sanityCheckInterval != null) {\n             _sanityCheckInterval = Integer.parseInt(sanityCheckInterval);\n         }\n@@ -371,6 +382,24 @@ protected void runInContextInternal() {\n             }\n \n             parse(job, startDate, endDate);\n+            if (_runQuota){\n+                try {\n+                    _quotaManager.calculateQuotaUsage();\n+                }\n+                catch (Exception e){\n+                    s_logger.error(\"Exception received while calculating quota\", e);\n+                }\n+                try {\n+                    _quotaStatement.sendStatement();\n+                } catch (Exception e) {\n+                    s_logger.error(\"Exception received while sending statements\", e);\n+                }\n+                try {\n+                    _alertManager.checkAndSendQuotaAlertEmails();\n+                } catch (Exception e) {\n+                    s_logger.error(\"Exception received while sending alerts\", e);\n+                }\n+            }\n         } else {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Not owner of usage job, skipping...\");",
                "raw_url": "https://github.com/apache/cloudstack/raw/987fcbd441fd9f48f72fe19dab94b8bbcc5df2a9/usage/src/com/cloud/usage/UsageManagerImpl.java",
                "sha": "886405637c07a716f8a78e42e4c5229c3ac827fa",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8592: Implement Quota service\n\nQuota service while allowing for scalability will make sure that the cloud is\nnot exploited by attacks, careless use and program errors. To address this\nproblem, we propose to employ a quota-enforcement service that allows resource\nusage within certain bounds as defined by policies and available quotas for\nvarious entities.  Quota service extends the functionality of usage server to\nprovide a measurement for the resources used by the accounts and domains using a\ncommon unit referred to as cloud currency in this document. It can be configured\nto ensure that your usage won\u2019t exceed the budget allocated to accounts/domain\nin cloud currency.  It will let user know how much of the cloud resources he is\nusing. It will help the cloud admins, if they want, to ensure that a user does\nnot go beyond his allocated quota. Per usage cycle if a account is found to be\nexceeding its quota then it is locked. Locking an account means that it will not\nbe able to initiat e a new resource allocation request, whether it is more\nstorage or an additional ip. Needless to say quota service as well as any action\non the account is configurable.\n\nChanges from Github code review:\n\n- Added marvin test for quota plugin API\n- removed unused commented code\n- debug messages in debug enabled check\n- checks for nulls, fixed access to member variables and feature\n- changes based on PR comments\n- unit tests for UsageTypes\n- unit tests for all Cmd classes\n- unit tests for all service and manager impls\n- try-catch-finally or try-with-resource in dao impls for failsafe db switching\n- remove dead code\n- add missing quota calculation case (regression fixed)\n- replace tabs with spaces in pom.xmls\n- quota: though default value for quota_calculated is 0, the usage server\n  makes it null while entering usage entries. Flipping the condition so\n  as to acocunt for that.\n- quotatypes: fix NPE in quota type\n- quota framework test fixes\n- made statement period configurable\n- changed default email templates to reflect the fact that exhausted quota may not result in a locked account\n- added quotaUpdateCmd that refreshes quota balances and sends alerts and statements\n- report quotaSummary command returns quota balance, quota usage and state for all account\n- made UI framework changes to allow for text area input in edit views\n- process usage entries that have greater than 0 usage\n- orocess quota entries only if tariff is non zero\n- if there are credit entries but no balance entry create a dummy balance entry\n- remove any credit entries that are before the last balance entry\n  when displaying balance statement\n- on a rerun the last balance is now getting added\n\nFS: https://cwiki.apache.org/confluence/display/CLOUDSTACK/Quota+Service+-+FS\nPR: https://github.com/apache/cloudstack/pull/768\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/f30fbe9a5c7eee1c5f260316f887d9d7881272b3",
        "repo": "cloudstack",
        "unit_tests": [
            "BaseCmdTest.java",
            "TestTransaction.java",
            "QuotaAlertManagerImplTest.java",
            "QuotaManagerImplTest.java",
            "QuotaStatementTest.java",
            "QuotaTypesTest.java",
            "ServiceOfferingVOTest.java",
            "QuotaBalanceCmdTest.java",
            "QuotaCreditsCmdTest.java",
            "QuotaEmailTemplateListCmdTest.java",
            "QuotaEmailTemplateUpdateCmdTest.java",
            "QuotaStatementCmdTest.java",
            "QuotaTariffListCmdTest.java",
            "QuotaTariffUpdateCmdTest.java",
            "QuotaResponseBuilderImplTest.java",
            "QuotaServiceImplTest.java",
            "ParamProcessWorkerTest.java",
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_98b416b": {
        "bug_id": "cloudstack_98b416b",
        "commit": "https://github.com/apache/cloudstack/commit/98b416b7f07220cc765be14e30382feb25dd3e75",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/98b416b7f07220cc765be14e30382feb25dd3e75/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=98b416b7f07220cc765be14e30382feb25dd3e75",
                "deletions": 1,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -2107,7 +2107,7 @@ private boolean doCancelMaintenance(long hostId) {\n         _haMgr.cancelScheduledMigrations(host);\n         List<VMInstanceVO> vms = _haMgr.findTakenMigrationWork();\n         for (VMInstanceVO vm : vms) {\n-            if (vm.getHostId() != null && vm.getHostId() == hostId) {\n+            if (vm != null && vm.getHostId() != null && vm.getHostId() == hostId) {\n                 s_logger.info(\"Unable to cancel migration because the vm is being migrated: \" + vm);\n                 return false;\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/98b416b7f07220cc765be14e30382feb25dd3e75/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "430a51664d3c6e1cd131b489a904e21c426a7a4b",
                "status": "modified"
            }
        ],
        "message": "fixed NPE\n\n(cherry picked from commit c78f14cbc2fd45fc587f4a238c0a0bfc1d753be8)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/bf17f640c679bab1bd740d4eb068deb1bc2eb3af",
        "repo": "cloudstack",
        "unit_tests": [
            "ResourceManagerImplTest.java"
        ]
    },
    "cloudstack_9961e1c": {
        "bug_id": "cloudstack_9961e1c",
        "commit": "https://github.com/apache/cloudstack/commit/9961e1ca2a2e0e678871b8ef8a526e15fa5be755",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/9961e1ca2a2e0e678871b8ef8a526e15fa5be755/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=9961e1ca2a2e0e678871b8ef8a526e15fa5be755",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1319,12 +1319,12 @@ public boolean isVirtualMachineUpgradable(UserVm vm, ServiceOffering offering) {\n         T rebootedVm = null;\n \n         DataCenter dc = _configMgr.getZone(vm.getDataCenterId());\n-        HostPodVO pod = _configMgr.getPod(vm.getPodId());\n         Host host = _hostDao.findById(vm.getHostId());\n         Cluster cluster = null;\n         if (host != null) {\n             cluster = _configMgr.getCluster(host.getClusterId());\n         }\n+        HostPodVO pod = _configMgr.getPod(host.getPodId());\n         DeployDestination dest = new DeployDestination(dc, pod, cluster, host);\n \n         try {",
                "raw_url": "https://github.com/apache/cloudstack/raw/9961e1ca2a2e0e678871b8ef8a526e15fa5be755/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "3f582ed5264fce7bded7d6529c2d9c64ada2088a",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when reboot vm\nvm.podId has different meaning than you think",
        "parent": "https://github.com/apache/cloudstack/commit/d9b61f26da2ae8407917ba910c163b12e58b45d6",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_99ca81a": {
        "bug_id": "cloudstack_99ca81a",
        "commit": "https://github.com/apache/cloudstack/commit/99ca81a676006cc5d351bd94e32e284256d00b4a",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/99ca81a676006cc5d351bd94e32e284256d00b4a/engine/storage/configdrive/src/org/apache/cloudstack/storage/configdrive/ConfigDriveBuilder.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/configdrive/src/org/apache/cloudstack/storage/configdrive/ConfigDriveBuilder.java?ref=99ca81a676006cc5d351bd94e32e284256d00b4a",
                "deletions": 1,
                "filename": "engine/storage/configdrive/src/org/apache/cloudstack/storage/configdrive/ConfigDriveBuilder.java",
                "patch": "@@ -286,7 +286,7 @@ private static void buildOpenStackMetaData(JsonObject metaData, String dataType,\n         if (!NetworkModel.METATDATA_DIR.equals(dataType)) {\n             return;\n         }\n-        if (StringUtils.isNotBlank(content)) {\n+        if (StringUtils.isEmpty(content)) {\n             return;\n         }\n         //keys are a special case in OpenStack format",
                "raw_url": "https://github.com/apache/cloudstack/raw/99ca81a676006cc5d351bd94e32e284256d00b4a/engine/storage/configdrive/src/org/apache/cloudstack/storage/configdrive/ConfigDriveBuilder.java",
                "sha": "55e7979a772f3a67161eec4e3b84b7748c187220",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/99ca81a676006cc5d351bd94e32e284256d00b4a/ui/scripts/configuration.js",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/configuration.js?ref=99ca81a676006cc5d351bd94e32e284256d00b4a",
                "deletions": 4,
                "filename": "ui/scripts/configuration.js",
                "patch": "@@ -2412,14 +2412,17 @@\n                                             if ($useVpcCb.is(':checked')) { //if useVpc is checked,\n                                                 $useVpcCb.removeAttr(\"checked\"); //remove \"checked\" attribute in useVpc\n                                             }\n+                                            $conservemode.css('display', 'inline-block');\n                                         } else if ($guestTypeField.val() == 'Isolated') { //Isolated network offering\n                                             $useVpc.css('display', 'inline-block');\n                                             $supportedServices.css('display', 'inline-block');\n                                             $userDataL2.hide();\n+                                            $conservemode.css('display', 'inline-block');\n                                         } else if ($guestTypeField.val() == 'L2') {\n                                             $useVpc.hide();\n                                             $supportedServices.hide();\n                                             $userDataL2.css('display', 'inline-block');\n+                                            $conservemode.hide();\n                                         }\n                                         var $providers = $useVpcCb.closest('form').find('.dynamic-input select[name!=\"service.Connectivity.provider\"]');\n                                         var $optionsOfProviders = $providers.find('option');\n@@ -3403,6 +3406,9 @@\n                                     } else {\n                                         delete inputData.serviceProviderList;\n                                     }\n+\n+                                    //Conserve mode is irrelevant on L2 network offerings as there are no resources to conserve, do not pass it, true by default on server side\n+                                    delete inputData.conservemode;\n                                 }\n \n                                 if (inputData['forvpc'] == 'on') {\n@@ -3411,10 +3417,12 @@\n                                     delete inputData.forvpc; //if forVpc checkbox is unchecked, do not pass forVpc parameter to API call since we need to keep API call's size as small as possible (p.s. forVpc is defaulted as false at server-side)\n                                 }\n \n-                                if (inputData['conservemode'] == 'on') {\n-                                    delete inputData.conservemode; //if ConserveMode checkbox is checked, do not pass conservemode parameter to API call since we need to keep API call's size as small as possible (p.s. conservemode is defaulted as true at server-side)\n-                                } else {\n-                                    inputData['conservemode'] = false;\n+                                if (inputData['guestIpType'] == \"Shared\" || inputData['guestIpType'] == \"Isolated\") {\n+                                    if (inputData['conservemode'] == 'on') {\n+                                        delete inputData.conservemode; //if ConserveMode checkbox is checked, do not pass conservemode parameter to API call since we need to keep API call's size as small as possible (p.s. conservemode is defaulted as true at server-side)\n+                                    } else {\n+                                        inputData['conservemode'] = false;\n+                                    }\n                                 }\n \n                                 // Make service provider map",
                "raw_url": "https://github.com/apache/cloudstack/raw/99ca81a676006cc5d351bd94e32e284256d00b4a/ui/scripts/configuration.js",
                "sha": "f229d24b19e67173b21f5e9826b7017988f1b6af",
                "status": "modified"
            }
        ],
        "message": "ui: do not send conserve mode on L2 network offering creation from the UI (#2694)\n\nDo not send conserve mode param on L2 network offering creation from the UI. Fix config drive NPE issue on L2 network.",
        "parent": "https://github.com/apache/cloudstack/commit/3af54ec1a8313c51c0faf98bf41e99450a3d0079",
        "repo": "cloudstack",
        "unit_tests": [
            "ConfigDriveBuilderTest.java"
        ]
    },
    "cloudstack_9b64008": {
        "bug_id": "cloudstack_9b64008",
        "commit": "https://github.com/apache/cloudstack/commit/9b640085ab19b42e1d062634f244bf10b8cc37b1",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/9b640085ab19b42e1d062634f244bf10b8cc37b1/server/src/com/cloud/server/StatsCollector.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=9b640085ab19b42e1d062634f244bf10b8cc37b1",
                "deletions": 9,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -267,16 +267,17 @@ public void run() {\n \t            }\n \t\t\t\t\r\n                 List<HostVO> hosts = _hostDao.listSecondaryStorageHosts();\n-                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\n-                \r\n-                for (HostVO host : hosts) {\r\n+                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\r\n+                for (HostVO host : hosts) {\n+                    if ( host.getStorageUrl() == null ) {\n+                        continue;\n+                    }\r\n                     GetStorageStatsCommand command = new GetStorageStatsCommand(host.getStorageUrl());\n-        \t\t\tHostVO ssAhost = _agentMgr.getSSAgent(host);\n-        \t\t\tif( ssAhost == null ) {\n-        \t\t\t\ts_logger.warn(\"There is no secondary storage VM for secondary storage host \" + host.getName());\n-        \t\t\t\tcontinue;\n-        \t\t\t}\n-        \t\t\t\n+                    HostVO ssAhost = _agentMgr.getSSAgent(host);\n+                    if (ssAhost == null) {\n+                        s_logger.warn(\"There is no secondary storage VM for secondary storage host \" + host.getName());\n+                        continue;\n+                    }\n                     long hostId = host.getId();\r\n                     Answer answer = _agentMgr.easySend(ssAhost.getId(), command);\r\n                     if (answer != null && answer.getResult()) {\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/9b640085ab19b42e1d062634f244bf10b8cc37b1/server/src/com/cloud/server/StatsCollector.java",
                "sha": "95243cb47a87fc34fc982f846268fb27c6ac7053",
                "status": "modified"
            }
        ],
        "message": "bug 10618: fixed NPE\n\nstatus 10618: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/9f13b46d61c483a8f9caf6d9677abc86212ee599",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_9ca379f": {
        "bug_id": "cloudstack_9ca379f",
        "commit": "https://github.com/apache/cloudstack/commit/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01/api/src/com/cloud/api/response/PhysicalNetworkResponse.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/api/response/PhysicalNetworkResponse.java?ref=9ca379fc61e3e9370806cbba4c8ac17afbcd6c01",
                "deletions": 0,
                "filename": "api/src/com/cloud/api/response/PhysicalNetworkResponse.java",
                "patch": "@@ -25,6 +25,7 @@\n import com.cloud.serializer.Param;\n import com.google.gson.annotations.SerializedName;\n \n+@SuppressWarnings(\"unused\")\n public class PhysicalNetworkResponse extends BaseResponse{\n     \n     @SerializedName(ApiConstants.ID) @Param(description=\"the uuid of the physical network\")",
                "raw_url": "https://github.com/apache/cloudstack/raw/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01/api/src/com/cloud/api/response/PhysicalNetworkResponse.java",
                "sha": "be37d9606756e80cd770cca2bbe0aa42935e338b",
                "status": "modified"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/cloudstack/blob/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01/server/src/com/cloud/network/NetworkManagerImpl.java",
                "changes": 61,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManagerImpl.java?ref=9ca379fc61e3e9370806cbba4c8ac17afbcd6c01",
                "deletions": 28,
                "filename": "server/src/com/cloud/network/NetworkManagerImpl.java",
                "patch": "@@ -2610,7 +2610,7 @@ public boolean restartNetwork(RestartNetworkCmd cmd, boolean cleanup) throws Con\n \n         _accountMgr.checkAccess(callerAccount, null, network);\n \n-        boolean success = restartNetwork(networkId, callerAccount, callerUser, null, cleanup);\n+        boolean success = restartNetwork(networkId, callerAccount, callerUser, cleanup);\n \n         if (success) {\n             s_logger.debug(\"Network id=\" + networkId + \" is restarted successfully.\");\n@@ -2641,7 +2641,7 @@ public boolean startNetwork(long networkId, DeployDestination dest, ReservationC\n         }\n     }\n \n-    private boolean restartNetwork(long networkId, Account callerAccount, User callerUser, Long newNetworkOfferingId, boolean cleanup) throws ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n+    private boolean restartNetwork(long networkId, Account callerAccount, User callerUser, boolean cleanup) throws ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n \n         NetworkVO network = _networksDao.findById(networkId);\n \n@@ -2656,13 +2656,6 @@ private boolean restartNetwork(long networkId, Account callerAccount, User calle\n             return false;\n         }\n         \n-        //Only after network was shutdown properly, change the network offering\n-        if (newNetworkOfferingId != null) {\n-            s_logger.debug(\"Updating network \" + network + \" with the new network offering id=\" + newNetworkOfferingId + \" as a part of network restart\");\n-            network.setNetworkOfferingId(newNetworkOfferingId);\n-            _networksDao.update(networkId, network, finalizeServicesAndProvidersForNetwork(_configMgr.getNetworkOffering(newNetworkOfferingId), network.getPhysicalNetworkId()));\n-        }\n-        \n         //implement the network elements and rules again\n         DeployDestination dest = new DeployDestination(_dcDao.findById(network.getDataCenterId()), null, null, null);\n         \n@@ -3332,31 +3325,43 @@ public Network updateNetwork(long networkId, String name, String displayText, Ac\n             //have to restart the network\n             restartNetwork = true;\n         }\n+        \n+        //1) Shutdown all the elements and cleanup all the rules\n+        ReservationContext context = new ReservationContextImpl(null, null, callerUser, callerAccount);\n+        if (restartNetwork) {\n+            s_logger.debug(\"Shutting down elements and resources for network id=\" + networkId + \" as a part of network update\");\n             \n-        _networksDao.update(networkId, network); \n-\n-        boolean success = true;\n-        if (restartNetwork && (network.getState() == Network.State.Implemented || network.getState() == Network.State.Setup)) {\n-        \t//network offering id will be updated in the restartNetowrk call aftet the network elements are shutdown properly\n-            s_logger.info(\"Restarting network \" + network + \" as a part of update network call\");\n-\n-            try {\n-                success = restartNetwork(networkId, callerAccount, callerUser, networkOfferingId, true);\n-            } catch (Exception e) {\n-                success = false;\n+            if (!shutdownNetworkElementsAndResources(context, true, network)) {\n+                s_logger.warn(\"Failed to shutdown the network elements and resources as a part of network restart: \" + network.getState());\n+                throw new CloudRuntimeException(\"Failed to shutdown the network elements and resources as a part of network restart: \" + network.getState());\n             }\n-\n-            if (success) {\n-                s_logger.debug(\"Successully restarted the network \" + network + \" as a part of updateNetwork call\");\n-            } else {\n-                s_logger.warn(\"Failed to restart the network \" + network + \" as a part of updateNetwork call\");\n-            }\n-        } else if (networkOfferingId != null) {\n+        }\n+        \n+        //2) Only after all the elements and rules are shutdown properly, update the network VO\n+        if (networkOfferingId != null) {\n         \tnetwork.setNetworkOfferingId(networkOfferingId);\n         \t_networksDao.update(networkId, network, finalizeServicesAndProvidersForNetwork(_configMgr.getNetworkOffering(networkOfferingId), network.getPhysicalNetworkId()));\n+        } else {\n+            _networksDao.update(networkId, network); \n         }\n         \n-        return network;\n+        //get updated network\n+        network = _networksDao.findById(networkId);\n+        \n+        //3) Implement the elements and rules again\n+        if (restartNetwork) {\n+        \t DeployDestination dest = new DeployDestination(_dcDao.findById(network.getDataCenterId()), null, null, null);\n+             \n+             s_logger.debug(\"Implementing the network \" + network + \" elements and resources as a part of network update\");        \n+             try {\n+                 implementNetworkElementsAndResources(dest, context, network, _networkOfferingDao.findById(network.getNetworkOfferingId()));\n+             } catch (Exception ex) {\n+                 s_logger.warn(\"Failed to implement network \" + network + \" elements and resources as a part of network update due to \", ex);\n+                 throw new CloudRuntimeException(\"Failed to implement network \" + network + \" elements and resources as a part of network update\");\n+             }\n+        }\n+        \n+        return getNetwork(network.getId());\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01/server/src/com/cloud/network/NetworkManagerImpl.java",
                "sha": "fb3f282e4673350fe48ebf4425458e2e2853462c",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=9ca379fc61e3e9370806cbba4c8ac17afbcd6c01",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1156,8 +1156,8 @@ private HypervisorType getAClusterToStartDomainRouterForOvm(long podId) {\n         if (publicNetwork) {\n             routers = _routerDao.listByNetworkAndRole(guestNetwork.getId(), Role.VIRTUAL_ROUTER);\n         } else {\n-            Long podId = dest.getPod().getId();\n             if (isPodBased) {\n+            \tLong podId = dest.getPod().getId();\n                 routers = _routerDao.listByNetworkAndPodAndRole(guestNetwork.getId(), podId, Role.VIRTUAL_ROUTER);\n                 plan = new DataCenterDeployment(dcId, podId, null, null, null, null);\n             } else {",
                "raw_url": "https://github.com/apache/cloudstack/raw/9ca379fc61e3e9370806cbba4c8ac17afbcd6c01/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "6231038f9c82b870d1fd1fda5b50cb5c235b47df",
                "status": "modified"
            }
        ],
        "message": "Changes to updateNetwork command:\n\n* update network with new networkOfferingId only after the network is shutdown\n* fixed NPE happenining when updateNetwork with the networkOffering w/o soucrceNat service in Advance zone",
        "parent": "https://github.com/apache/cloudstack/commit/cdfac9a5e16633cf9ad219c359ffdcfd6695b331",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_9cb37ec": {
        "bug_id": "cloudstack_9cb37ec",
        "commit": "https://github.com/apache/cloudstack/commit/9cb37ec349a6740a2f012ef4e6ac58a6c3b13907",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/9cb37ec349a6740a2f012ef4e6ac58a6c3b13907/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=9cb37ec349a6740a2f012ef4e6ac58a6c3b13907",
                "deletions": 7,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -71,6 +71,7 @@\n import org.apache.cloudstack.engine.subsystem.api.storage.TemplateDataFactory;\n import org.apache.cloudstack.engine.subsystem.api.storage.TemplateInfo;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService.VolumeApiResult;\n import org.apache.cloudstack.framework.async.AsyncCallFuture;\n@@ -4737,14 +4738,17 @@ public UserVm restoreVMInternal(Account caller, UserVmVO vm, Long newTemplateId)\n         _volsDao.detachVolume(root.getId());\n         volumeMgr.destroyVolume(root);\n \n-        // For VMware hypervisor since the old root volume is replaced by the new root volume in storage, force expunge old root volume\n+        // For VMware hypervisor since the old root volume is replaced by the new root volume, force expunge old root volume if it has been created in storage\n         if (vm.getHypervisorType() == HypervisorType.VMware) {\n-            s_logger.info(\"Expunging volume \" + root.getId() + \" from primary data store\");\n-            AsyncCallFuture<VolumeApiResult> future = _volService.expungeVolumeAsync(volFactory.getVolume(root.getId()));\n-            try {\n-                future.get();\n-            } catch (Exception e) {\n-                s_logger.debug(\"Failed to expunge volume:\" + root.getId(), e);\n+            VolumeInfo volumeInStorage = volFactory.getVolume(root.getId());\n+            if (volumeInStorage != null) {\n+                s_logger.info(\"Expunging volume \" + root.getId() + \" from primary data store\");\n+                AsyncCallFuture<VolumeApiResult> future = _volService.expungeVolumeAsync(volFactory.getVolume(root.getId()));\n+                try {\n+                    future.get();\n+                } catch (Exception e) {\n+                    s_logger.debug(\"Failed to expunge volume:\" + root.getId(), e);\n+                }\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/9cb37ec349a6740a2f012ef4e6ac58a6c3b13907/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "82b9bfbda47ebb8970effa7730f15c40fefd2d9c",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6007. Restore VM command fails with NPE.\nIf a VM instance is deployed with startVm=false, then calling restoreVm on the instance fails with NPE\nbecause CS tries to expunge a volume that has not been created in primary store.",
        "parent": "https://github.com/apache/cloudstack/commit/9cb2458a5871307efa6f18143c241b32a9e79540",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_9ddebcf": {
        "bug_id": "cloudstack_9ddebcf",
        "commit": "https://github.com/apache/cloudstack/commit/9ddebcfa166547839f07664226b46de603a6b6a5",
        "file": [
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/cloudstack/blob/9ddebcfa166547839f07664226b46de603a6b6a5/server/src/com/cloud/server/StatsCollector.java",
                "changes": 54,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=9ddebcfa166547839f07664226b46de603a6b6a5",
                "deletions": 26,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -339,32 +339,34 @@ public void run() {\n \t\t\t\t}\r\n \t\t\t\tConcurrentHashMap<Long, VolumeStats> volumeStats = new ConcurrentHashMap<Long, VolumeStats>();\r\n \t\t\t\tfor (Iterator<Long> iter = commandsByPool.keySet().iterator(); iter.hasNext();) {\r\n-\t\t\t\t\tLong poolId = iter.next();\r\n-\t\t\t\t\tList<VolumeCommand> commandsList = commandsByPool.get(poolId);\r\n-\t\t\t\t\t\r\n-\t\t\t\t\tlong[] volumeIdArray = new long[commandsList.size()];\r\n-\t\t\t\t\tCommands commands = new Commands(OnError.Continue);\r\n-\t\t\t\t\tfor (int i = 0; i < commandsList.size(); i++) {\r\n-\t\t\t\t\t\tVolumeCommand vCommand = commandsList.get(i);\r\n-\t\t\t\t\t\tvolumeIdArray[i] = vCommand.volumeId;\r\n-\t\t\t\t\t\tcommands.addCommand(vCommand.command);\r\n-\t\t\t\t\t}\n-\t\t\t\t\t\n-\t\t            List<StoragePoolHostVO> poolhosts = _storagePoolHostDao.listByPoolId(poolId);\n-\t\t            for(StoragePoolHostVO poolhost : poolhosts) {\n-    \t\t\t\t\tAnswer[] answers = _agentMgr.send(poolhost.getHostId(), commands);\r\n-    \t\t\t\t\tif (answers != null) {\r\n-    \t\t\t\t\t    long totalBytes = 0L;\r\n-    \t\t\t\t\t\tfor (int i = 0; i < answers.length; i++) {\r\n-    \t\t\t\t\t\t\tif (answers[i].getResult()) {\r\n-    \t\t\t\t\t\t\t    VolumeStats vStats = (VolumeStats)answers[i];\r\n-    \t\t\t\t\t\t\t\tvolumeStats.put(volumeIdArray[i], vStats);\r\n-    \t\t\t\t\t\t\t\ttotalBytes += vStats.getBytesUsed();\r\n-    \t\t\t\t\t\t\t}\r\n-    \t\t\t\t\t\t}\n-    \t\t\t\t\t\tbreak;\n-                        }\n-\t\t            }\r\n+\t\t\t\t\tLong poolId = iter.next();\n+\t\t\t\t\tif(poolId != null) {\r\n+\t\t\t\t\t\tList<VolumeCommand> commandsList = commandsByPool.get(poolId);\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tlong[] volumeIdArray = new long[commandsList.size()];\r\n+\t\t\t\t\t\tCommands commands = new Commands(OnError.Continue);\r\n+\t\t\t\t\t\tfor (int i = 0; i < commandsList.size(); i++) {\r\n+\t\t\t\t\t\t\tVolumeCommand vCommand = commandsList.get(i);\r\n+\t\t\t\t\t\t\tvolumeIdArray[i] = vCommand.volumeId;\r\n+\t\t\t\t\t\t\tcommands.addCommand(vCommand.command);\r\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\t\n+\t\t\t            List<StoragePoolHostVO> poolhosts = _storagePoolHostDao.listByPoolId(poolId);\n+\t\t\t            for(StoragePoolHostVO poolhost : poolhosts) {\n+\t    \t\t\t\t\tAnswer[] answers = _agentMgr.send(poolhost.getHostId(), commands);\r\n+\t    \t\t\t\t\tif (answers != null) {\r\n+\t    \t\t\t\t\t    long totalBytes = 0L;\r\n+\t    \t\t\t\t\t\tfor (int i = 0; i < answers.length; i++) {\r\n+\t    \t\t\t\t\t\t\tif (answers[i].getResult()) {\r\n+\t    \t\t\t\t\t\t\t    VolumeStats vStats = (VolumeStats)answers[i];\r\n+\t    \t\t\t\t\t\t\t\tvolumeStats.put(volumeIdArray[i], vStats);\r\n+\t    \t\t\t\t\t\t\t\ttotalBytes += vStats.getBytesUsed();\r\n+\t    \t\t\t\t\t\t\t}\r\n+\t    \t\t\t\t\t\t}\n+\t    \t\t\t\t\t\tbreak;\n+\t                        }\n+\t\t\t            }\n+\t\t\t\t\t}\r\n \t\t\t\t}\r\n \r\n \t\t\t\t// We replace the existing volumeStats so that it does not grow with no bounds\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/9ddebcfa166547839f07664226b46de603a6b6a5/server/src/com/cloud/server/StatsCollector.java",
                "sha": "cb2ce49a1cdacfc8bcf75a0e6cab3240ef4cccea",
                "status": "modified"
            }
        ],
        "message": "Fix the annoying NPE in StatsCollector",
        "parent": "https://github.com/apache/cloudstack/commit/dae72c26b0aee7ba0289c2a0bb0d9c5c3a9af9cb",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_9eef604": {
        "bug_id": "cloudstack_9eef604",
        "commit": "https://github.com/apache/cloudstack/commit/9eef604f2bc1564427691faf002ae00a4b26eff1",
        "file": [
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/9eef604f2bc1564427691faf002ae00a4b26eff1/utils/src/com/cloud/utils/db/DbUtil.java",
                "changes": 60,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/db/DbUtil.java?ref=9eef604f2bc1564427691faf002ae00a4b26eff1",
                "deletions": 33,
                "filename": "utils/src/com/cloud/utils/db/DbUtil.java",
                "patch": "@@ -49,39 +49,33 @@\n     private static Map<String, Connection> s_connectionForGlobalLocks = new HashMap<String, Connection>();\n     \n     public static Connection getConnectionForGlobalLocks(String name, boolean forLock) {\n-    \twhile(true) {\n-\t    \tsynchronized(s_connectionForGlobalLocks) {\n-\t    \t\tif(forLock) {\n-\t    \t\t\tif(s_connectionForGlobalLocks.get(name) != null) {\n-\t    \t\t\t\ts_logger.error(\"Sanity check failed, global lock name \" + name + \" is in already in use\");\n-\t    \t\t\t}\n-\t    \t\t\t\n-\t    \t\t\tConnection connection = Transaction.getStandaloneConnection();\n-\t    \t\t\tif(connection != null) {\n-\t    \t\t\t\ttry {\n-\t\t\t\t\t\t\tconnection.setAutoCommit(true);\n-\t\t\t\t\t\t} catch (SQLException e) {\n-\t\t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\t\tconnection.close();\n-\t\t\t\t\t\t\t} catch(SQLException sqlException) {\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\treturn null;\n+    \tsynchronized(s_connectionForGlobalLocks) {\n+    \t\tif(forLock) {\n+    \t\t\tif(s_connectionForGlobalLocks.get(name) != null) {\n+    \t\t\t\ts_logger.error(\"Sanity check failed, global lock name \" + name + \" is already in use\");\n+    \t\t\t\tassert(false);\n+    \t\t\t}\n+    \t\t\t\n+    \t\t\tConnection connection = Transaction.getStandaloneConnection();\n+    \t\t\tif(connection != null) {\n+    \t\t\t\ttry {\n+\t\t\t\t\t\tconnection.setAutoCommit(true);\n+\t\t\t\t\t} catch (SQLException e) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tconnection.close();\n+\t\t\t\t\t\t} catch(SQLException sqlException) {\n \t\t\t\t\t\t}\n-\t\t\t\t\t\ts_connectionForGlobalLocks.put(name, connection);\n-\t\t\t\t\t\treturn connection;\n-\t    \t\t\t}\n-\t    \t\t} else {\n-\t    \t\t\tConnection connection = s_connectionForGlobalLocks.get(name);\n-\t    \t\t\ts_connectionForGlobalLocks.remove(name);\n-\t    \t\t\treturn connection;\n-\t    \t\t}\n-\t    \t}\n-\t    \t\n-\t\t\ts_logger.warn(\"Unable to acquire dabase connection for global lock \" + name + \", waiting for someone to release and retrying...\");\n-\t    \ttry {\n-\t\t\t\tThread.sleep(1000);\n-\t\t\t} catch (InterruptedException e) {\n-\t\t\t}\n+\t\t\t\t\t\treturn null;\n+\t\t\t\t\t}\n+\t\t\t\t\ts_connectionForGlobalLocks.put(name, connection);\n+\t\t\t\t\treturn connection;\n+    \t\t\t}\n+    \t    \treturn null;\n+    \t\t} else {\n+    \t\t\tConnection connection = s_connectionForGlobalLocks.get(name);\n+    \t\t\ts_connectionForGlobalLocks.remove(name);\n+    \t\t\treturn connection;\n+    \t\t}\n     \t}\n     }\n     \n@@ -237,7 +231,7 @@ public static boolean getGlobalLock(String name, int timeoutSeconds) {\n         \tif (pstmt != null) {\n         \t\ttry {\n         \t\t\tpstmt.close();\n-        \t\t} catch (SQLException e) {\n+        \t\t} catch (Throwable e) {\n         \t\t\ts_logger.error(\"What the heck? \", e);\n         \t\t}\n         \t}",
                "raw_url": "https://github.com/apache/cloudstack/raw/9eef604f2bc1564427691faf002ae00a4b26eff1/utils/src/com/cloud/utils/db/DbUtil.java",
                "sha": "a7dc8f4c5409ecbe3387925f403c89183caf3b7b",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/9eef604f2bc1564427691faf002ae00a4b26eff1/utils/src/com/cloud/utils/db/GlobalLock.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/db/GlobalLock.java?ref=9eef604f2bc1564427691faf002ae00a4b26eff1",
                "deletions": 16,
                "filename": "utils/src/com/cloud/utils/db/GlobalLock.java",
                "patch": "@@ -45,9 +45,9 @@\n     protected final static Logger s_logger = Logger.getLogger(GlobalLock.class);\r\n \r\n \tprivate String name;\r\n-\tprivate volatile int lockCount = 0;\r\n+\tprivate int lockCount = 0;\r\n \tprivate Thread ownerThread = null;\r\n-\t\r\n+\t\n \tprivate int referenceCount = 0;\r\n \tprivate long holdingStartTick = 0;\r\n \t\r\n@@ -65,21 +65,21 @@ public int addRef() {\n \t}\r\n \t\r\n \tpublic int releaseRef() {\r\n-\t\tboolean releaseInternLock = false;\r\n-\t\tint refCount;\r\n-\t\tsynchronized(this) {\r\n-\t\t\treferenceCount--;\r\n-\t\t\trefCount = referenceCount;\r\n-\t\t\t\r\n-\t\t\tif(referenceCount < 0)\r\n-\t\t\t\ts_logger.warn(\"Unmatched Global lock \" + name + \" reference usage detected, check your code!\");\r\n-\t\t\t\r\n-\t\t\tif(referenceCount == 0)\r\n-\t\t\t\treleaseInternLock = true;\r\n+\t\tint refCount;\n+\t\t\n+\t\tsynchronized(s_lockMap) {\t// // lock in sequence to prevent deadlock\r\n+\t\t\tsynchronized(this) {\r\n+\t\t\t\treferenceCount--;\r\n+\t\t\t\trefCount = referenceCount;\r\n+\t\t\t\t\r\n+\t\t\t\tif(referenceCount < 0)\r\n+\t\t\t\t\ts_logger.warn(\"Unmatched Global lock \" + name + \" reference usage detected, check your code!\");\r\n+\t\t\t\t\r\n+\t\t\t\tif(referenceCount == 0)\r\n+\t\t\t\t\treleaseInternLock(name);\n+\t\t\t}\n \t\t}\r\n \t\t\r\n-\t\tif(releaseInternLock)\r\n-\t\t\treleaseInternLock(name);\r\n \t\treturn refCount;\r\n \t}\r\n \n@@ -137,9 +137,9 @@ public boolean lock(int timeoutSeconds) {\n \t\t\t\t\t\tcontinue;\r\n \t\t\t\t\t} else {\r\n \t\t\t\t\t\t// we will discount the time that has been spent in previous waiting\r\n+\t\t\t\t\t\townerThread = Thread.currentThread();\n \t\t\t\t\t\tif(DbUtil.getGlobalLock(name, remainingMilliSeconds / 1000)) {\r\n \t\t\t\t\t\t\tlockCount++;\r\n-\t\t\t\t\t\t\townerThread = Thread.currentThread();\r\n \t\t\t\t\t\t\tholdingStartTick = System.currentTimeMillis();\r\n \t\t\t\t\t\t\t\r\n \t\t\t\t\t\t\t// keep the lock in the intern map when we got the lock from database\r\n@@ -148,6 +148,8 @@ public boolean lock(int timeoutSeconds) {\n \t\t\t\t\t\t\tif(s_logger.isTraceEnabled())\r\n \t\t\t\t\t\t\t\ts_logger.trace(\"lock \" + name + \" is acquired, lock count :\" + lockCount);\r\n \t\t\t\t\t\t\treturn true;\r\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\townerThread = null;\n \t\t\t\t\t\t}\r\n \t\t\t\t\t\treturn false;\r\n \t\t\t\t\t}\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/9eef604f2bc1564427691faf002ae00a4b26eff1/utils/src/com/cloud/utils/db/GlobalLock.java",
                "sha": "789da2deb252d37701a57043f4a9259a1c2ae6aa",
                "status": "modified"
            }
        ],
        "message": "bug 7685: a race condition caused DB connection from the pool to be left alone which can trigger mysql driver NPE exception",
        "parent": "https://github.com/apache/cloudstack/commit/49281a27dcd58b4899059364ae38f6507ed8a8e3",
        "repo": "cloudstack",
        "unit_tests": [
            "DbUtilTest.java",
            "GlobalLockTest.java"
        ]
    },
    "cloudstack_9f13b46": {
        "bug_id": "cloudstack_9f13b46",
        "commit": "https://github.com/apache/cloudstack/commit/9f13b46d61c483a8f9caf6d9677abc86212ee599",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/9f13b46d61c483a8f9caf6d9677abc86212ee599/server/src/com/cloud/server/StatsCollector.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=9f13b46d61c483a8f9caf6d9677abc86212ee599",
                "deletions": 7,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -262,21 +262,26 @@ public VmStats getVmStats(long id) {\n \t\t@Override\n         public void run() {\r\n \t\t\ttry {\n-\t\t\t\ts_logger.debug(\"StorageCollector is running...\");\n+\t            if (s_logger.isDebugEnabled()) {\n+\t            \ts_logger.debug(\"StorageCollector is running...\");\n+\t            }\n \t\t\t\t\r\n                 List<HostVO> hosts = _hostDao.listSecondaryStorageHosts();\n-                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\r\n+                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\n+                \r\n                 for (HostVO host : hosts) {\r\n                     GetStorageStatsCommand command = new GetStorageStatsCommand(host.getStorageUrl());\n-                    HostVO ssAhost = _agentMgr.getSSAgent(host);\n-                    if (ssAhost == null) {\n-                        return;\n-                    }\n+        \t\t\tHostVO ssAhost = _agentMgr.getSSAgent(host);\n+        \t\t\tif( ssAhost == null ) {\n+        \t\t\t\ts_logger.warn(\"There is no secondary storage VM for secondary storage host \" + host.getName());\n+        \t\t\t\tcontinue;\n+        \t\t\t}\n+        \t\t\t\n                     long hostId = host.getId();\r\n                     Answer answer = _agentMgr.easySend(ssAhost.getId(), command);\r\n                     if (answer != null && answer.getResult()) {\r\n                         storageStats.put(hostId, (StorageStats)answer);\n-                        s_logger.debug(\"HostId: \"+hostId+ \" Used: \" + ((StorageStats)answer).getByteUsed() + \" Total Available: \" + ((StorageStats)answer).getCapacityBytes());\n+                        s_logger.trace(\"HostId: \"+hostId+ \" Used: \" + ((StorageStats)answer).getByteUsed() + \" Total Available: \" + ((StorageStats)answer).getCapacityBytes());\n                         //Seems like we have dynamically updated the sec. storage as prev. size and the current do not match\n                         if (_storageStats.get(hostId)!=null &&\n                         \t\t_storageStats.get(hostId).getCapacityBytes() != ((StorageStats)answer).getCapacityBytes()){",
                "raw_url": "https://github.com/apache/cloudstack/raw/9f13b46d61c483a8f9caf6d9677abc86212ee599/server/src/com/cloud/server/StatsCollector.java",
                "sha": "7da47e3a51e3fb3e69b7bb52c778be477c3f06ac",
                "status": "modified"
            }
        ],
        "message": "bug 10602: Fix NPE in StatsCollector - ssvm might not be up so check for that.\nstatus 10602: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/6b7279598e926472c371ba2eb6c75db393f6dd62",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_9f94a17": {
        "bug_id": "cloudstack_9f94a17",
        "commit": "https://github.com/apache/cloudstack/commit/9f94a178d6663eb1451bf632de5e92c46884f874",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/9f94a178d6663eb1451bf632de5e92c46884f874/utils/src/com/cloud/utils/db/GlobalLock.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/db/GlobalLock.java?ref=9f94a178d6663eb1451bf632de5e92c46884f874",
                "deletions": 4,
                "filename": "utils/src/com/cloud/utils/db/GlobalLock.java",
                "patch": "@@ -103,10 +103,12 @@ public static GlobalLock getInternLock(String name) {\n \tprivate static void releaseInternLock(String name) {\r\n \t\tsynchronized(s_lockMap) {\n \t\t\tGlobalLock lock = s_lockMap.get(name);\n-\t\t\tassert(lock != null);\n-\t\t\t\n-\t\t\tif(lock.referenceCount == 0)\n-\t\t\t\ts_lockMap.remove(name);\n+\t\t\tif(lock != null) {\n+\t\t\t\tif(lock.referenceCount == 0)\n+\t\t\t\t\ts_lockMap.remove(name);\n+\t\t\t} else {\n+\t\t\t\ts_logger.warn(\"Releasing \" + name + \", but it is already released.\");\n+\t\t\t}\n \t\t}\r\n \t}\r\n \t\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/9f94a178d6663eb1451bf632de5e92c46884f874/utils/src/com/cloud/utils/db/GlobalLock.java",
                "sha": "067ad57de3067b298706c05c2299877985ce02fb",
                "status": "modified"
            }
        ],
        "message": "bug 10976: NPE fix to avoid blocking shutdown process",
        "parent": "https://github.com/apache/cloudstack/commit/797263265eb3f8e775f40b295c2a96f6467e677d",
        "repo": "cloudstack",
        "unit_tests": [
            "GlobalLockTest.java"
        ]
    },
    "cloudstack_a07497b": {
        "bug_id": "cloudstack_a07497b",
        "commit": "https://github.com/apache/cloudstack/commit/a07497b3731372bf902aae9569e6d579abaec3f8",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/a07497b3731372bf902aae9569e6d579abaec3f8/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=a07497b3731372bf902aae9569e6d579abaec3f8",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -1650,12 +1650,12 @@ private Volume orchestrateDetachVolumeFromVM(long vmId, long volumeId) {\n         }\n \n         HostVO host = null;\n-        StoragePoolVO volumePool = _storagePoolDao.findById(volume.getPoolId());\n+        StoragePoolVO volumePool = _storagePoolDao.findByIdIncludingRemoved(volume.getPoolId());\n \n         if (hostId != null) {\n             host = _hostDao.findById(hostId);\n \n-            if (host != null && host.getHypervisorType() == HypervisorType.XenServer && volumePool.isManaged()) {\n+            if (host != null && host.getHypervisorType() == HypervisorType.XenServer && volumePool != null && volumePool.isManaged()) {\n                 sendCommand = true;\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/a07497b3731372bf902aae9569e6d579abaec3f8/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "dbae1946a367d7d51e56b298db5e74ed0b5e6a06",
                "status": "modified"
            }
        ],
        "message": "server: fix NPE case in VolumeApiServiceImpl\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit df934c954106a618f8b0aca7e7dfbac890d78244)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/48ef7e5f280b8eecfa59537cbb1b3d887517b8dc",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_a0762bc": {
        "bug_id": "cloudstack_a0762bc",
        "commit": "https://github.com/apache/cloudstack/commit/a0762bc4a7771b47c004f523c8d3d636d5b3a11e",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/a0762bc4a7771b47c004f523c8d3d636d5b3a11e/server/src/com/cloud/network/NetworkModelImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkModelImpl.java?ref=a0762bc4a7771b47c004f523c8d3d636d5b3a11e",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/NetworkModelImpl.java",
                "patch": "@@ -568,6 +568,9 @@ public boolean isIP6AddressAvailableInNetwork(long networkId) {\n     @Override\n     public boolean isIP6AddressAvailableInVlan(long vlanId) {\n     \tVlanVO vlan = _vlanDao.findById(vlanId);\n+    \tif (vlan.getIp6Range() == null) {\n+    \t\treturn false;\n+    \t}\n     \tlong existedCount = _ipv6Dao.countExistedIpsInVlan(vlanId);\n     \tBigInteger existedInt = BigInteger.valueOf(existedCount);\n     \tBigInteger rangeInt = NetUtils.countIp6InRange(vlan.getIp6Range());",
                "raw_url": "https://github.com/apache/cloudstack/raw/a0762bc4a7771b47c004f523c8d3d636d5b3a11e/server/src/com/cloud/network/NetworkModelImpl.java",
                "sha": "7b3717a161f76466de865785007a5a0d1ea177bc",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/a0762bc4a7771b47c004f523c8d3d636d5b3a11e/utils/src/com/cloud/utils/net/NetUtils.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/net/NetUtils.java?ref=a0762bc4a7771b47c004f523c8d3d636d5b3a11e",
                "deletions": 0,
                "filename": "utils/src/com/cloud/utils/net/NetUtils.java",
                "patch": "@@ -1192,6 +1192,9 @@ private static BigInteger convertIPv6AddressToBigInteger(IPv6Address addr) {\n \t\n \t// Can cover 127 bits\n \tpublic static BigInteger countIp6InRange(String ip6Range) {\n+\t\tif (ip6Range == null) {\n+\t\t\treturn null;\n+\t\t}\n     \tString[] ips = ip6Range.split(\"-\");\n     \tString startIp = ips[0];\n     \tString endIp = ips[0];\n@@ -1214,6 +1217,9 @@ public static BigInteger countIp6InRange(String ip6Range) {\n \t}\n \n \tpublic static boolean isIp6InRange(String ip6, String ip6Range) {\n+\t\tif (ip6Range == null) {\n+\t\t\treturn false;\n+\t\t}\n     \tString[] ips = ip6Range.split(\"-\");\n     \tString startIp = ips[0];\n     \tString endIp = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/a0762bc4a7771b47c004f523c8d3d636d5b3a11e/utils/src/com/cloud/utils/net/NetUtils.java",
                "sha": "dd40a33934d33de67dba205b8c54b9365437b39b",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/a0762bc4a7771b47c004f523c8d3d636d5b3a11e/utils/test/com/cloud/utils/net/NetUtilsTest.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/test/com/cloud/utils/net/NetUtilsTest.java?ref=a0762bc4a7771b47c004f523c8d3d636d5b3a11e",
                "deletions": 0,
                "filename": "utils/test/com/cloud/utils/net/NetUtilsTest.java",
                "patch": "@@ -122,5 +122,10 @@ public void testIpv6() {\n     \tassertTrue(NetUtils.isIp6InNetwork(\"1234:5678::1\", \"1234:5678::/64\"));\n     \tassertTrue(NetUtils.isIp6InNetwork(\"1234:5678::ffff:ffff:ffff:ffff\", \"1234:5678::/64\"));\n     \tassertTrue(NetUtils.isIp6InNetwork(\"1234:5678::\", \"1234:5678::/64\"));\n+    \t//Test isIp6InRange\n+    \tassertTrue(NetUtils.isIp6InRange(\"1234:5678:abcd::1\", \"1234:5678:abcd::1-1234:5678:abcd::1\"));\n+    \tassertFalse(NetUtils.isIp6InRange(\"1234:5678:abcd::1\", \"1234:5678:abcd::2-1234:5678:abcd::1\"));\n+    \tassertFalse(NetUtils.isIp6InRange(\"1234:5678:abcd::1\", null));\n+    \tassertTrue(NetUtils.isIp6InRange(\"1234:5678:abcd::1\", \"1234:5678::1-1234:5679::1\"));\n     }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/a0762bc4a7771b47c004f523c8d3d636d5b3a11e/utils/test/com/cloud/utils/net/NetUtilsTest.java",
                "sha": "28bd71f18d774911efd900d2746700361110a9b2",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-1303: Fix NPE when extend vlan with ipv4 only",
        "parent": "https://github.com/apache/cloudstack/commit/6823adb3ac195e1c5fa76a898b5a0c8b011e7a88",
        "repo": "cloudstack",
        "unit_tests": [
            "NetUtilsTest.java"
        ]
    },
    "cloudstack_a216046": {
        "bug_id": "cloudstack_a216046",
        "commit": "https://github.com/apache/cloudstack/commit/a2160461911bec0365c5a6a2eaff84cc396661ad",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/a2160461911bec0365c5a6a2eaff84cc396661ad/server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/dispatch/ParamProcessWorker.java?ref=a2160461911bec0365c5a6a2eaff84cc396661ad",
                "deletions": 4,
                "filename": "server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "patch": "@@ -33,7 +33,6 @@\n \n import javax.inject.Inject;\n \n-\n import org.apache.log4j.Logger;\n \n import org.apache.cloudstack.acl.ControlledEntity;\n@@ -220,16 +219,17 @@ public void processParameters(final BaseCmd cmd, final Map params) {\n \n     private void doAccessChecks(BaseCmd cmd, Map<Object, AccessType> entitiesToAccess) {\n         Account caller = CallContext.current().getCallingAccount();\n-        Account owner = _accountMgr.getActiveAccountById(cmd.getEntityOwnerId());\n+        // due to deleteAccount design flaw CLOUDSTACK-6588, we should still include those removed account as well to clean up leftover resources from that account\n+        Account owner = _accountMgr.getAccount(cmd.getEntityOwnerId());\n \n         if (cmd instanceof BaseAsyncCreateCmd) {\n             // check that caller can access the owner account.\n-            _accountMgr.checkAccess(caller, null, true, owner);\n+            _accountMgr.checkAccess(caller, null, false, owner);\n         }\n \n         if (!entitiesToAccess.isEmpty()) {\n             // check that caller can access the owner account.\n-            _accountMgr.checkAccess(caller, null, true, owner);\n+            _accountMgr.checkAccess(caller, null, false, owner);\n             for (Map.Entry<Object,AccessType>entry : entitiesToAccess.entrySet()) {\n                 Object entity = entry.getKey();\n                 if (entity instanceof ControlledEntity) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/a2160461911bec0365c5a6a2eaff84cc396661ad/server/src/com/cloud/api/dispatch/ParamProcessWorker.java",
                "sha": "ad90812c6c586154c291c33507fe1927105bcd29",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7165:[Automation] NPE observed during restart and expunge VM.",
        "parent": "https://github.com/apache/cloudstack/commit/f4757a198a95e71dc3b5f8d42ac2c88e0b74d590",
        "repo": "cloudstack",
        "unit_tests": [
            "ParamProcessWorkerTest.java"
        ]
    },
    "cloudstack_a3b8657": {
        "bug_id": "cloudstack_a3b8657",
        "commit": "https://github.com/apache/cloudstack/commit/a3b86573b921ee470ac60b3e801a6d18f7939658",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/a3b86573b921ee470ac60b3e801a6d18f7939658/server/src/com/cloud/network/NetworkManagerImpl.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManagerImpl.java?ref=a3b86573b921ee470ac60b3e801a6d18f7939658",
                "deletions": 7,
                "filename": "server/src/com/cloud/network/NetworkManagerImpl.java",
                "patch": "@@ -2236,33 +2236,32 @@ public void release(VirtualMachineProfile vmProfile, boolean forced) throws\n             ConcurrentOperationException, ResourceUnavailableException {\n         List<NicVO> nics = _nicDao.listByVmId(vmProfile.getId());\n         for (NicVO nic : nics) {\n-            releaseNic(vmProfile, nic);\n+            releaseNic(vmProfile, nic.getId());\n         }\n     }\n \n-\n+    \n     @Override\n     @DB\n     public void releaseNic(VirtualMachineProfile vmProfile, Nic nic)\n             throws ConcurrentOperationException, ResourceUnavailableException {\n-        NicVO nicVO = _nicDao.findById(nic.getId());\n-        releaseNic(vmProfile, nicVO);\n+        releaseNic(vmProfile, nic.getId());\n     }\n \n     @DB\n-    protected void releaseNic(VirtualMachineProfile vmProfile, NicVO nicVO)\n+    protected void releaseNic(VirtualMachineProfile vmProfile, long nicId)\n             throws ConcurrentOperationException, ResourceUnavailableException {\n         //lock the nic\n         Transaction txn = Transaction.currentTxn();\n         txn.start();\n \n-        NicVO nic = _nicDao.lockRow(nicVO.getId(), true);\n+        NicVO nic = _nicDao.lockRow(nicId, true);\n         if (nic == null) {\n             throw new ConcurrentOperationException(\"Unable to acquire lock on nic \" + nic);\n         }\n \n         Nic.State originalState = nic.getState();\n-        NetworkVO network = _networksDao.findById(nicVO.getNetworkId());\n+        NetworkVO network = _networksDao.findById(nic.getNetworkId());\n \n         if (originalState == Nic.State.Reserved || originalState == Nic.State.Reserving) {\n             if (nic.getReservationStrategy() == Nic.ReservationStrategy.Start) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/a3b86573b921ee470ac60b3e801a6d18f7939658/server/src/com/cloud/network/NetworkManagerImpl.java",
                "sha": "ea3d552ca80b13f14a85ab66f4d7b728b7d9f3d3",
                "status": "modified"
            },
            {
                "additions": 55,
                "blob_url": "https://github.com/apache/cloudstack/blob/a3b86573b921ee470ac60b3e801a6d18f7939658/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 84,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=a3b86573b921ee470ac60b3e801a6d18f7939658",
                "deletions": 29,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -2953,6 +2953,7 @@ public boolean removeNicFromVm(VirtualMachine vm, NicVO nic) throws ConcurrentOp\n     }\n \n     @Override\n+    @DB\n     public boolean removeVmFromNetwork(VirtualMachine vm, Network network, URI broadcastUri) throws ConcurrentOperationException, ResourceUnavailableException {\n         VMInstanceVO vmVO = _vmDao.findById(vm.getId());\n         ReservationContext context = new ReservationContextImpl(null, null, _accountMgr.getActiveUser(User.UID_SYSTEM),\n@@ -2968,53 +2969,78 @@ public boolean removeVmFromNetwork(VirtualMachine vm, Network network, URI broad\n         VirtualMachineTO vmTO = hvGuru.implement(vmProfile);\n \n         Nic nic = null;\n-\n         if (broadcastUri != null) {\n             nic = _nicsDao.findByNetworkIdInstanceIdAndBroadcastUri(network.getId(), vm.getId(), broadcastUri.toString());\n         } else {\n             nic = _networkModel.getNicInNetwork(vm.getId(), network.getId());\n         }\n-\n-        if (nic == null) {\n+        \n+        if (nic == null){\n             s_logger.warn(\"Could not get a nic with \" + network);\n             return false;\n         }\n-\n+        \n         // don't delete default NIC on a user VM\n         if (nic.isDefaultNic() && vm.getType() == VirtualMachine.Type.User) {\n             s_logger.warn(\"Failed to remove nic from \" + vm + \" in \" + network + \", nic is default.\");\n             throw new CloudRuntimeException(\"Failed to remove nic from \" + vm + \" in \" + network + \", nic is default.\");\n         }\n \n-        NicProfile nicProfile = new NicProfile(nic, network, nic.getBroadcastUri(), nic.getIsolationUri(),\n-                _networkModel.getNetworkRate(network.getId(), vm.getId()),\n-                _networkModel.isSecurityGroupSupportedInNetwork(network),\n-                _networkModel.getNetworkTag(vmProfile.getVirtualMachine().getHypervisorType(), network));\n-\n-        //1) Unplug the nic\n-        if (vm.getState() == State.Running) {\n-            NicTO nicTO = toNicTO(nicProfile, vmProfile.getVirtualMachine().getHypervisorType());\n-            s_logger.debug(\"Un-plugging nic for vm \" + vm + \" from network \" + network);\n-            boolean result = unplugNic(network, nicTO, vmTO, context, dest);\n-            if (result) {\n-                s_logger.debug(\"Nic is unplugged successfully for vm \" + vm + \" in network \" + network);\n-            } else {\n-                s_logger.warn(\"Failed to unplug nic for the vm \" + vm + \" from network \" + network);\n-                return false;\n+        //Lock on nic is needed here\n+        Nic lock = _nicsDao.acquireInLockTable(nic.getId());\n+        if (lock == null) {\n+            //check if nic is still there. Return if it was released already\n+            if (_nicsDao.findById(nic.getId()) == null) {\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Not need to remove the vm \" + vm + \" from network \" + network + \" as the vm doesn't have nic in this network\");\n+                }\n+                return true;\n             }\n-        } else if (vm.getState() != State.Stopped) {\n-            s_logger.warn(\"Unable to remove vm \" + vm + \" from network  \" + network);\n-            throw new ResourceUnavailableException(\"Unable to remove vm \" + vm + \" from network, is not in the right state\",\n-                    DataCenter.class, vm.getDataCenterId());\n+            throw new ConcurrentOperationException(\"Unable to lock nic \" + nic.getId());\n+        }\n+        \n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Lock is acquired for nic id \" + lock.getId() + \" as a part of remove vm \" + vm + \" from network \" + network);\n         }\n+        \n+        try {\n+            NicProfile nicProfile = new NicProfile(nic, network, nic.getBroadcastUri(), nic.getIsolationUri(),\n+                    _networkModel.getNetworkRate(network.getId(), vm.getId()),\n+                    _networkModel.isSecurityGroupSupportedInNetwork(network),\n+                    _networkModel.getNetworkTag(vmProfile.getVirtualMachine().getHypervisorType(), network));\n+\n+            //1) Unplug the nic\n+            if (vm.getState() == State.Running) {\n+                NicTO nicTO = toNicTO(nicProfile, vmProfile.getVirtualMachine().getHypervisorType());\n+                s_logger.debug(\"Un-plugging nic for vm \" + vm + \" from network \" + network);\n+                boolean result = unplugNic(network, nicTO, vmTO, context, dest);\n+                if (result) {\n+                    s_logger.debug(\"Nic is unplugged successfully for vm \" + vm + \" in network \" + network );\n+                } else {\n+                    s_logger.warn(\"Failed to unplug nic for the vm \" + vm + \" from network \" + network);\n+                    return false;\n+                }\n+            } else if (vm.getState() != State.Stopped) {\n+                s_logger.warn(\"Unable to remove vm \" + vm + \" from network  \" + network);\n+                throw new ResourceUnavailableException(\"Unable to remove vm \" + vm + \" from network, is not in the right state\",\n+                        DataCenter.class, vm.getDataCenterId());\n+            }\n \n-        //2) Release the nic\n-        _networkMgr.releaseNic(vmProfile, nic);\n-        s_logger.debug(\"Successfully released nic \" + nic + \"for vm \" + vm);\n+            //2) Release the nic\n+            _networkMgr.releaseNic(vmProfile, nic);\n+            s_logger.debug(\"Successfully released nic \" + nic +  \"for vm \" + vm);\n \n-        //3) Remove the nic\n-        _networkMgr.removeNic(vmProfile, nic);\n-        return true;\n+            //3) Remove the nic\n+            _networkMgr.removeNic(vmProfile, nic);\n+            return true;\n+        } finally {\n+            if (lock != null) {\n+                _nicsDao.releaseFromLockTable(lock.getId());\n+                if (s_logger.isDebugEnabled()) {\n+                    s_logger.debug(\"Lock is released for nic id \" + lock.getId() + \" as a part of remove vm \" + vm + \" from network \" + network);\n+                }\n+            }\n+        }\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/a3b86573b921ee470ac60b3e801a6d18f7939658/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "08bca43e733cf26eb0af9a7a73184a511d211c61",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4020: lock nic entry in releaseNic method. Otherwise multiple threads can try to release the same nic at the same time, and it will lead to NPEs and backend failures\n\nConflicts:\n\tserver/src/com/cloud/network/NetworkManagerImpl.java\n\tserver/src/com/cloud/vm/VirtualMachineManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/3587127df6eac5429dd4f10609a2d09a17e1a5fa",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_a4e6784": {
        "bug_id": "cloudstack_a4e6784",
        "commit": "https://github.com/apache/cloudstack/commit/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/plugins/storage/image/default/src/org/apache/cloudstack/storage/datastore/driver/CloudStackImageStoreDriverImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/image/default/src/org/apache/cloudstack/storage/datastore/driver/CloudStackImageStoreDriverImpl.java?ref=a4e6784e0b5bbef8135271a0c1c5f990ed2115b3",
                "deletions": 2,
                "filename": "plugins/storage/image/default/src/org/apache/cloudstack/storage/datastore/driver/CloudStackImageStoreDriverImpl.java",
                "patch": "@@ -276,8 +276,9 @@ private void deleteTemplate(DataObject data, AsyncCompletionCallback<CommandResu\n         // TODO: need to understand why we need to mark destroyed in\n         // template_store_ref table here instead of in callback.\n         // Currently I did that in callback, so I removed previous code to mark template_host_ref\n-\n-        UsageEventUtils.publishUsageEvent(eventType, account.getId(), sZoneId, templateId, null, null, null);\n+        if ( sZoneId != null ){\n+            UsageEventUtils.publishUsageEvent(eventType, account.getId(), sZoneId, templateId, null, null, null);\n+        }\n \n         // get installpath of this template on image store\n         TemplateDataStoreVO tmplStore = _templateStoreDao.findByStoreTemplate(storeId, templateId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/plugins/storage/image/default/src/org/apache/cloudstack/storage/datastore/driver/CloudStackImageStoreDriverImpl.java",
                "sha": "71afc13e13cdacbf4e1bc9365eef4074659e0cd7",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/plugins/storage/image/s3/src/org/apache/cloudstack/storage/datastore/driver/S3ImageStoreDriverImpl.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/image/s3/src/org/apache/cloudstack/storage/datastore/driver/S3ImageStoreDriverImpl.java?ref=a4e6784e0b5bbef8135271a0c1c5f990ed2115b3",
                "deletions": 5,
                "filename": "plugins/storage/image/s3/src/org/apache/cloudstack/storage/datastore/driver/S3ImageStoreDriverImpl.java",
                "patch": "@@ -286,11 +286,10 @@ private void deleteTemplate(DataObject data, AsyncCompletionCallback<CommandResu\n             eventType = EventTypes.EVENT_TEMPLATE_DELETE;\n         }\n \n-        // TODO: need to understand why we need to mark destroyed in\n-        // template_store_ref table here instead of in callback.\n-        // Currently I did that in callback, so I removed previous code to mark template_host_ref\n-\n-        UsageEventUtils.publishUsageEvent(eventType, account.getId(), sZoneId, templateId, null, null, null);\n+        if ( sZoneId != null ){\n+            //TODO: how to handle region wide usage data where sZoneId == null\n+            UsageEventUtils.publishUsageEvent(eventType, account.getId(), sZoneId, templateId, null, null, null);\n+        }\n \n         List<UserVmJoinVO> userVmUsingIso = _userVmJoinDao.listActiveByIsoId(templateId);\n         // check if there is any VM using this ISO.",
                "raw_url": "https://github.com/apache/cloudstack/raw/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/plugins/storage/image/s3/src/org/apache/cloudstack/storage/datastore/driver/S3ImageStoreDriverImpl.java",
                "sha": "1c6e17e8e1bb619deb9fada4eb3eb5d6e850856a",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/plugins/storage/image/swift/src/org/apache/cloudstack/storage/datastore/driver/SwiftImageStoreDriverImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/image/swift/src/org/apache/cloudstack/storage/datastore/driver/SwiftImageStoreDriverImpl.java?ref=a4e6784e0b5bbef8135271a0c1c5f990ed2115b3",
                "deletions": 2,
                "filename": "plugins/storage/image/swift/src/org/apache/cloudstack/storage/datastore/driver/SwiftImageStoreDriverImpl.java",
                "patch": "@@ -281,8 +281,9 @@ private void deleteTemplate(DataObject data, AsyncCompletionCallback<CommandResu\n         // TODO: need to understand why we need to mark destroyed in\n         // template_store_ref table here instead of in callback.\n         // Currently I did that in callback, so I removed previous code to mark template_host_ref\n-\n-        UsageEventUtils.publishUsageEvent(eventType, account.getId(), sZoneId, templateId, null, null, null);\n+        if (sZoneId != null){\n+            UsageEventUtils.publishUsageEvent(eventType, account.getId(), sZoneId, templateId, null, null, null);\n+        }\n \n         List<UserVmJoinVO> userVmUsingIso = _userVmJoinDao.listActiveByIsoId(templateId);\n         // check if there is any VM using this ISO.",
                "raw_url": "https://github.com/apache/cloudstack/raw/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/plugins/storage/image/swift/src/org/apache/cloudstack/storage/datastore/driver/SwiftImageStoreDriverImpl.java",
                "sha": "590b653bdff4e456a08e2d0752666ff9cc948876",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/services/secondary-storage/src/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/services/secondary-storage/src/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java?ref=a4e6784e0b5bbef8135271a0c1c5f990ed2115b3",
                "deletions": 1,
                "filename": "services/secondary-storage/src/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java",
                "patch": "@@ -1535,7 +1535,7 @@ protected Answer execute(final DeleteTemplateCommand cmd) {\n             final String bucket = s3.getBucketName();\n             try {\n                 S3Utils.deleteDirectory(s3, bucket, path);\n-                return new Answer(cmd, true, String.format(\"Deleted template %1%s from bucket %2$s.\", path, bucket));\n+                return new Answer(cmd, true, String.format(\"Deleted template %1$s from bucket %2$s.\", path, bucket));\n             } catch (Exception e) {\n                 final String errorMessage = String.format(\"Failed to delete template %1$s from bucket %2$s due to the following error: %3$s\", path,\n                         bucket, e.getMessage());",
                "raw_url": "https://github.com/apache/cloudstack/raw/a4e6784e0b5bbef8135271a0c1c5f990ed2115b3/services/secondary-storage/src/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java",
                "sha": "6fbb06b3f2cfb66f42b58a5e1bf54967618d67ac",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-2578: NPE in deleting template from S3.",
        "parent": "https://github.com/apache/cloudstack/commit/cb0659ab33fcb0b0b0b8daeadd0fd41576d11db4",
        "repo": "cloudstack",
        "unit_tests": [
            "NfsSecondaryStorageResourceTest.java"
        ]
    },
    "cloudstack_a5004e3": {
        "bug_id": "cloudstack_a5004e3",
        "commit": "https://github.com/apache/cloudstack/commit/a5004e37ad4609b98e5d5a78452e6fb8858f6504",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/a5004e37ad4609b98e5d5a78452e6fb8858f6504/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=a5004e37ad4609b98e5d5a78452e6fb8858f6504",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -343,8 +343,11 @@ public VolumeVO doInTransaction(TransactionStatus status) {\n                 volume.setDomainId((owner == null) ? Domain.ROOT_DOMAIN : owner.getDomainId());\n \n                 if (diskOfferingId == null) {\n-                    long defaultDiskOfferingId = _diskOfferingDao.findByUniqueName(\"Cloud.com-Custom\").getId();\n-                    volume.setDiskOfferingId(defaultDiskOfferingId);\n+                    DiskOfferingVO diskOfferingVO = _diskOfferingDao.findByUniqueName(\"Cloud.com-Custom\");\n+                    if (diskOfferingVO != null) {\n+                        long defaultDiskOfferingId = diskOfferingVO.getId();\n+                        volume.setDiskOfferingId(defaultDiskOfferingId);\n+                    }\n                 } else {\n                     volume.setDiskOfferingId(diskOfferingId);\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/a5004e37ad4609b98e5d5a78452e6fb8858f6504/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "cf18555bfcac7694822d1f88e6600bd6555c7583",
                "status": "modified"
            }
        ],
        "message": "CID-1233084: Fix NPE in persisting volume in VolumeApiServiceImpl\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/bdee5e37343f6f4e5be2acd6cbc6e172e0d1fe36",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_a5a65c7": {
        "bug_id": "cloudstack_a5a65c7",
        "commit": "https://github.com/apache/cloudstack/commit/a5a65c7b551ee5cc32588997937267b716eff681",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/a5a65c7b551ee5cc32588997937267b716eff681/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java?ref=a5a65c7b551ee5cc32588997937267b716eff681",
                "deletions": 2,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "patch": "@@ -937,10 +937,10 @@ public Volume migrateVolume(Volume volume, StoragePool destPool) throws StorageU\n             return result.getVolume();\n         } catch (InterruptedException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         } catch (ExecutionException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/a5a65c7b551ee5cc32588997937267b716eff681/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "sha": "1b87ccf44900af0389b059cabde8d333610b48ee",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/a5a65c7b551ee5cc32588997937267b716eff681/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=a5a65c7b551ee5cc32588997937267b716eff681",
                "deletions": 10,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -1795,6 +1795,8 @@ public Volume migrateVolume(MigrateVolumeCmd cmd) {\n                 if (jobResult != null) {\n                     if (jobResult instanceof ConcurrentOperationException)\n                         throw (ConcurrentOperationException)jobResult;\n+                    else if (jobResult instanceof RuntimeException)\n+                        throw (RuntimeException)jobResult;\n                     else if (jobResult instanceof Throwable)\n                         throw new RuntimeException(\"Unexpected exception\", (Throwable)jobResult);\n                 }\n@@ -1817,35 +1819,39 @@ private Volume orchestrateMigrateVolume(long volumeId, long destPoolId, boolean\n         assert (destPool != null);\n \n         Volume newVol = null;\n-        if (liveMigrateVolume) {\n-            newVol = liveMigrateVolume(vol, destPool);\n-        } else {\n-            try {\n+        try {\n+            if (liveMigrateVolume) {\n+                newVol = liveMigrateVolume(vol, destPool);\n+            } else {\n                 newVol = _volumeMgr.migrateVolume(vol, destPool);\n-            } catch (StorageUnavailableException e) {\n-                s_logger.debug(\"Failed to migrate volume\", e);\n             }\n+        } catch (StorageUnavailableException e) {\n+            s_logger.debug(\"Failed to migrate volume\", e);\n+            throw new CloudRuntimeException(e.getMessage());\n+        }  catch (Exception e) {\n+            s_logger.debug(\"Failed to migrate volume\", e);\n+            throw new CloudRuntimeException(e.getMessage());\n         }\n         return newVol;\n     }\n \n     @DB\n-    protected Volume liveMigrateVolume(Volume volume, StoragePool destPool) {\n+    protected Volume liveMigrateVolume(Volume volume, StoragePool destPool) throws StorageUnavailableException {\n         VolumeInfo vol = volFactory.getVolume(volume.getId());\n         AsyncCallFuture<VolumeApiResult> future = volService.migrateVolume(vol, (DataStore)destPool);\n         try {\n             VolumeApiResult result = future.get();\n             if (result.isFailed()) {\n                 s_logger.debug(\"migrate volume failed:\" + result.getResult());\n-                return null;\n+                throw new StorageUnavailableException(\"Migrate volume failed: \" + result.getResult(), destPool.getId());\n             }\n             return result.getVolume();\n         } catch (InterruptedException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         } catch (ExecutionException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/a5a65c7b551ee5cc32588997937267b716eff681/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "7fa600a8f36f9654cc8030c590b8a26e94892180",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8122. Handle NPE thrown during migration failures.\nWhen migration fails instead of returning NULL, throw the exception.",
        "parent": "https://github.com/apache/cloudstack/commit/ac491c96075d65e35157380fe7d28fdd917c0e90",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_a6a774f": {
        "bug_id": "cloudstack_a6a774f",
        "commit": "https://github.com/apache/cloudstack/commit/a6a774f6c05f98a862ef81ab309dc9b274afc278",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/a6a774f6c05f98a862ef81ab309dc9b274afc278/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=a6a774f6c05f98a862ef81ab309dc9b274afc278",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -5196,7 +5196,7 @@ public Long extractVolume(ExtractVolumeCmd cmd) throws URISyntaxException {\n         }\n         \n         VMTemplateVO template = ApiDBUtils.findTemplateById(volume.getTemplateId());    \t\n-    \tboolean isExtractable = template != null && template.isExtractable() && !(template.getTemplateType()== Storage.TemplateType.SYSTEM || template.getTemplateType()== Storage.TemplateType.BUILTIN);\n+    \tboolean isExtractable = template != null && template.isExtractable() && template.getTemplateType() != Storage.TemplateType.SYSTEM;\n         if( !isExtractable && account!=null && account.getType() != Account.ACCOUNT_TYPE_ADMIN){ // Global admins are allowed to extract\n         \tthrow new PermissionDeniedException(\"The volume:\" +volumeId+ \" is not allowed to be extracted\");\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/a6a774f6c05f98a862ef81ab309dc9b274afc278/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "31df6ab1c933bc3ab5205b8c6ebfd8c3920abd41",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/a6a774f6c05f98a862ef81ab309dc9b274afc278/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=a6a774f6c05f98a862ef81ab309dc9b274afc278",
                "deletions": 8,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -2487,7 +2487,7 @@ public VMTemplateVO createPrivateTemplateRecord(CreateTemplateCmd cmd) throws In\n     \tLong nextTemplateId = _templateDao.getNextInSequence(Long.class, \"id\");\n     \tString description = cmd.getDisplayText();\n     \tVMTemplateVO template = ApiDBUtils.findTemplateById(volume.getTemplateId());    \t\n-    \tboolean isExtractable = template != null && template.isExtractable() && !(template.getTemplateType()== Storage.TemplateType.SYSTEM || template.getTemplateType()== Storage.TemplateType.BUILTIN);\n+    \tboolean isExtractable = template != null && template.isExtractable() && template.getTemplateType() != Storage.TemplateType.SYSTEM ;\n \n         privateTemplate = new VMTemplateVO(nextTemplateId,\n                                            uniqueName,\n@@ -2591,13 +2591,14 @@ public VMTemplateVO createPrivateTemplate(CreateTemplateCmd command) throws Clou\n             if( volume == null ) {\n                 throw new CloudRuntimeException(\"Unable to find volume for Id \" + volumeId);\n             }\n-            long instanceId = volume.getInstanceId();\n-            VMInstanceVO vm = _vmDao.findById(instanceId);\n-            State vmState = vm.getState();\n-            if( !vmState.equals(State.Stopped) && !vmState.equals(State.Destroyed)) {\n-                throw new CloudRuntimeException(\"Please put VM \" + vm.getHostName() + \" into Stopped state first\");\n-            }\n-                           \n+            Long instanceId = volume.getInstanceId();\n+            if (instanceId != null){\n+            \tVMInstanceVO vm = _vmDao.findById(instanceId);\n+            \tState vmState = vm.getState();\n+            \tif( !vmState.equals(State.Stopped) && !vmState.equals(State.Destroyed)) {\n+            \t\tthrow new CloudRuntimeException(\"Please put VM \" + vm.getHostName() + \" into Stopped state first\");\n+            \t}\n+            }           \n             cmd = new CreatePrivateTemplateFromVolumeCommand(secondaryStorageURL, templateId, volume.getAccountId(),\n                     command.getTemplateName(), uniqueName, volume.getPath(), vmName);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/a6a774f6c05f98a862ef81ab309dc9b274afc278/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "af6470c4100e06f8364577bc52f347dd74483150",
                "status": "modified"
            }
        ],
        "message": "bug 7369 : Resolving NPE while creating a private template from detached volume. The instance id is null when it is detached which was the culprit here.\nstatus 7369: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/b2ba0521df3d12ac72e38fc976748ca32cc919c8",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_a785373": {
        "bug_id": "cloudstack_a785373",
        "commit": "https://github.com/apache/cloudstack/commit/a78537398cca223f657f89994c9ef5a32180e86e",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/a78537398cca223f657f89994c9ef5a32180e86e/api/src/com/cloud/capacity/Capacity.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/capacity/Capacity.java?ref=a78537398cca223f657f89994c9ef5a32180e86e",
                "deletions": 1,
                "filename": "api/src/com/cloud/capacity/Capacity.java",
                "patch": "@@ -37,7 +37,7 @@\n \n     public Long getHostOrPoolId();\n \n-    public long getDataCenterId();\n+    public Long getDataCenterId();\n \n     public Long getPodId();\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/a78537398cca223f657f89994c9ef5a32180e86e/api/src/com/cloud/capacity/Capacity.java",
                "sha": "16d67fc122d639e5865610089d159e66d4850580",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/a78537398cca223f657f89994c9ef5a32180e86e/core/src/com/cloud/capacity/CapacityVO.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/capacity/CapacityVO.java?ref=a78537398cca223f657f89994c9ef5a32180e86e",
                "deletions": 5,
                "filename": "core/src/com/cloud/capacity/CapacityVO.java",
                "patch": "@@ -44,7 +44,7 @@\n     private Long hostOrPoolId;\r\n \r\n     @Column(name=\"data_center_id\")\r\n-    private long dataCenterId;\r\n+    private Long dataCenterId;\r\n \r\n     @Column(name=\"pod_id\")\r\n     private Long podId;\r\n@@ -79,7 +79,7 @@\n     \r\n     public CapacityVO() {}\r\n \r\n-    public CapacityVO(Long hostId, long dataCenterId, Long podId, Long clusterId, long usedCapacity, long totalCapacity, short capacityType) {\r\n+    public CapacityVO(Long hostId, Long dataCenterId, Long podId, Long clusterId, long usedCapacity, long totalCapacity, short capacityType) {\r\n         this.hostOrPoolId = hostId;\r\n         this.dataCenterId = dataCenterId;\r\n         this.podId = podId;\n@@ -90,7 +90,7 @@ public CapacityVO(Long hostId, long dataCenterId, Long podId, Long clusterId, lo\n         this.updateTime = new Date();\r\n     }\n     \n-    public CapacityVO(long dataCenterId, Long podId, Long clusterId, short capacityType, float usedPercentage) {        \n+    public CapacityVO(Long dataCenterId, Long podId, Long clusterId, short capacityType, float usedPercentage) {        \n         this.dataCenterId = dataCenterId;\n         this.podId = podId;\n         this.clusterId = clusterId;\n@@ -112,10 +112,10 @@ public void setHostId(Long hostId) {\n         this.hostOrPoolId = hostId;\r\n     }\r\n     @Override\n-    public long getDataCenterId() {\r\n+    public Long getDataCenterId() {\r\n         return dataCenterId;\r\n     }\r\n-    public void setDataCenterId(long dataCenterId) {\r\n+    public void setDataCenterId(Long dataCenterId) {\r\n         this.dataCenterId = dataCenterId;\r\n     }\r\n     \r",
                "raw_url": "https://github.com/apache/cloudstack/raw/a78537398cca223f657f89994c9ef5a32180e86e/core/src/com/cloud/capacity/CapacityVO.java",
                "sha": "5c2d43861fa2d1bb87b3b515cb3e5941b9f5afb7",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/a78537398cca223f657f89994c9ef5a32180e86e/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=a78537398cca223f657f89994c9ef5a32180e86e",
                "deletions": 0,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -2121,6 +2121,11 @@ public int compare(SummedCapacity arg0, SummedCapacity arg1) {\n         } else if (zoneId != null) {\n             dcList.add(ApiDBUtils.findZoneById(zoneId));\n         } else {\n+        \tif (clusterId != null){\n+        \t\tzoneId = ApiDBUtils.findClusterById(clusterId).getDataCenterId();\n+        \t}else{\n+        \t\tzoneId = ApiDBUtils.findPodById(podId).getDataCenterId();\n+        \t}\n             if (capacityType == null || capacityType == Capacity.CAPACITY_TYPE_STORAGE) {\n                 capacities.add(_storageMgr.getStoragePoolUsedStats(null, clusterId, podId, zoneId));\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/a78537398cca223f657f89994c9ef5a32180e86e/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "ae0c8dc0ef005312ebceb57f35a9526577930ce2",
                "status": "modified"
            }
        ],
        "message": "Bug 14490: Fix NPE in ListCapacity",
        "parent": "https://github.com/apache/cloudstack/commit/a5a7be4c7e30edaf8db3f241ec03524755ba69d2",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_a7953c1": {
        "bug_id": "cloudstack_a7953c1",
        "commit": "https://github.com/apache/cloudstack/commit/a7953c1e7a837a4dd75b23dc28e9a2f51997b5d2",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/a7953c1e7a837a4dd75b23dc28e9a2f51997b5d2/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=a7953c1e7a837a4dd75b23dc28e9a2f51997b5d2",
                "deletions": 1,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -941,7 +941,7 @@ public boolean delete(long userId, long templateId, Long zoneId) {\n \t\t\t}\n \t\t}\n \t\t\n-\t\tAccount account = _accountDao.findById(template.getAccountId());\n+\t\tAccount account = _accountDao.findByIdIncludingRemoved(template.getAccountId());\n \t\tString eventType = \"\";\n \t\t\n \t\tif (template.getFormat().equals(ImageFormat.ISO)){",
                "raw_url": "https://github.com/apache/cloudstack/raw/a7953c1e7a837a4dd75b23dc28e9a2f51997b5d2/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "5408358aadf4479ab3da0a874d93d0d21d110270",
                "status": "modified"
            }
        ],
        "message": "bug 9205: resolved fixed\nstatus 9205: fix NPE in usageEvent",
        "parent": "https://github.com/apache/cloudstack/commit/6bd978abfe4e68fa62b708fd5eb4b8eb2b5c19f8",
        "repo": "cloudstack",
        "unit_tests": [
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_a8360e4": {
        "bug_id": "cloudstack_a8360e4",
        "commit": "https://github.com/apache/cloudstack/commit/a8360e41c0c99793b1f6b0a4e0cb10dbc3d00a9c",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/a8360e41c0c99793b1f6b0a4e0cb10dbc3d00a9c/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=a8360e41c0c99793b1f6b0a4e0cb10dbc3d00a9c",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -403,14 +403,24 @@ public boolean isLocalStorageActiveOnHost(Long hostId) {\n     @Override\n     public StoragePool findStoragePool(DiskProfile dskCh, final DataCenterVO dc, Pod pod, Long clusterId, Long hostId, VMInstanceVO vm,\n             final Set<StoragePool> avoid) {\n+        Long podId = null;\n+        if (pod != null) {\n+            podId = pod.getId();\n+        } else if (clusterId != null) {\n+            ClusterVO cluster = _clusterDao.findById(clusterId);\n+            if (cluster != null) {\n+                podId = cluster.getPodId();\n+            }\n+        }\n+\n         VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n         for (StoragePoolAllocator allocator : _storagePoolAllocators) {\n \n             ExcludeList avoidList = new ExcludeList();\n             for (StoragePool pool : avoid) {\n                 avoidList.addPool(pool.getId());\n             }\n-            DataCenterDeployment plan = new DataCenterDeployment(dc.getId(), pod.getId(), clusterId, hostId, null, null);\n+            DataCenterDeployment plan = new DataCenterDeployment(dc.getId(), podId, clusterId, hostId, null, null);\n \n             final List<StoragePool> poolList = allocator.allocateToPool(dskCh, profile, plan, avoidList, 1);\n             if (poolList != null && !poolList.isEmpty()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/a8360e41c0c99793b1f6b0a4e0cb10dbc3d00a9c/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "25ef70ba95d30be5eddc9ca47ef10a7edf010dd7",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3942 NPE from findStoragePool method\n\nChanges:\n- Added null checks for podId\n\nConflicts:\n\n\tserver/src/com/cloud/storage/StorageManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/c2192808aa5f7a391a79fb6c84592819c032fa45",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_aca0f79": {
        "bug_id": "cloudstack_aca0f79",
        "commit": "https://github.com/apache/cloudstack/commit/aca0f7959274d4cc3d6a8a727c65977952d66dce",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/aca0f7959274d4cc3d6a8a727c65977952d66dce/server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java?ref=aca0f7959274d4cc3d6a8a727c65977952d66dce",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java",
                "patch": "@@ -612,13 +612,14 @@ public boolean revokeNetworkACLItem(long ruleId) {\n \n             Vpc vpc = _entityMgr.findById(Vpc.class, acl.getVpcId());\n \n+            if((aclItem.getAclId() == NetworkACL.DEFAULT_ALLOW) || (aclItem.getAclId() == NetworkACL.DEFAULT_DENY)){\n+                throw new InvalidParameterValueException(\"ACL Items in default ACL cannot be deleted\");\n+            }\n+\n             Account caller = CallContext.current().getCallingAccount();\n \n             _accountMgr.checkAccess(caller, null, true, vpc);\n \n-            if((aclItem.getAclId() == NetworkACL.DEFAULT_ALLOW) || (aclItem.getAclId() == NetworkACL.DEFAULT_DENY)){\n-                throw new InvalidParameterValueException(\"ACL Items in default ACL cannot be deleted\");\n-            }\n         }\n         return _networkAclMgr.revokeNetworkACLItem(ruleId);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/aca0f7959274d4cc3d6a8a727c65977952d66dce/server/src/com/cloud/network/vpc/NetworkACLServiceImpl.java",
                "sha": "bee4018145d28f58d16b77d5cf2d12cf3e704db2",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8072: Fixed NPE in deleting default ACL items in default ACL",
        "parent": "https://github.com/apache/cloudstack/commit/6321a29e4336de9ffe96e27968f896ec5a8bf37d",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkACLServiceImplTest.java"
        ]
    },
    "cloudstack_b10f560": {
        "bug_id": "cloudstack_b10f560",
        "commit": "https://github.com/apache/cloudstack/commit/b10f560be52c4dc448a484917caf8c553b67b77c",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/b10f560be52c4dc448a484917caf8c553b67b77c/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=b10f560be52c4dc448a484917caf8c553b67b77c",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -63,6 +63,7 @@\n import com.cloud.vm.UserVmManager;\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachineProfile;\n+import com.cloud.vm.VirtualMachine.State;\n import com.cloud.vm.dao.DomainRouterDao;\n import com.cloud.vm.dao.UserVmDao;\n \n@@ -153,17 +154,22 @@ public boolean restart(Network network, ReservationContext context) throws Concu\n         }\n \n         /* Get the host_id in order to find the cluster */\n-        long host_id = 0;\n+        Long host_id = new Long(0);\n         for (DomainRouterVO router : routers) {\n-            host_id = router.getHostId();\n+            if (host_id == null || host_id == 0) {\n+                host_id = (router.getHostId() != null ? router.getHostId() : router.getLastHostId());\n+            }\n             /* FIXME it's not completely safe to ignore these failure, but we would try to push on now */\n-            if (_routerMgr.stopRouter(router.getId(), false) == null) {\n+            if (router.getState() != State.Stopped || _routerMgr.stopRouter(router.getId(), false) == null) {\n                 s_logger.warn(\"Failed to stop virtual router element \" + router + \" as a part of network \" + network + \" restart\");\n             }\n             if (!_routerMgr.destroyRouter(router.getId())) {\n                 s_logger.warn(\"Failed to destroy virtual router element \" + router + \" as a part of network \" + network + \" restart\");\n             }\n         }\n+        if (host_id == null || host_id == 0) {\n+            throw new ResourceUnavailableException(\"Fail to locate virtual router element in network \" + network.getId(), this.getClass(), 0);\n+        }\n         \n         /* The cluster here is only used to determine hypervisor type, not the real deployment */\n         Cluster cluster = _configMgr.getCluster(_hostDao.findById(host_id).getClusterId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/b10f560be52c4dc448a484917caf8c553b67b77c/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "4cfc3fccbaaf1e71e4816446c7b13ab5a8a7f3c5",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/b10f560be52c4dc448a484917caf8c553b67b77c/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=b10f560be52c4dc448a484917caf8c553b67b77c",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1066,7 +1066,9 @@ private DomainRouterVO startVirtualRouter(DomainRouterVO router, User user, Acco\n                 if (state != State.Running) {\n                     router = startVirtualRouter(router, _accountService.getSystemUser(), _accountService.getSystemAccount(), params);\n                 }\n-                runningRouters.add(router);\n+                if (router != null) {\n+                    runningRouters.add(router);\n+                }\n             }\n         }\n         return runningRouters;",
                "raw_url": "https://github.com/apache/cloudstack/raw/b10f560be52c4dc448a484917caf8c553b67b77c/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "8a72e400eda5372b6bbe38ae02fe1c50b215dc34",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when a router is fail to start\n\nAlso enforce the check for restartNetworkCommand",
        "parent": "https://github.com/apache/cloudstack/commit/356728ae19063e04273b12ced0baa44b7e6e9599",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRouterElementTest.java",
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_b294257": {
        "bug_id": "cloudstack_b294257",
        "commit": "https://github.com/apache/cloudstack/commit/b2942572e7a07812c5338c723db54a405383b6dd",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/b2942572e7a07812c5338c723db54a405383b6dd/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=b2942572e7a07812c5338c723db54a405383b6dd",
                "deletions": 7,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -685,11 +685,7 @@ public static boolean isAdmin(short accountType) {\n     }\n     \n     @DB\n-    protected DomainRouterVO findOrCreateVirtualRouter(Network guestNetwork, DataCenterDeployment plan, HypervisorType type, Account owner) throws ConcurrentOperationException, InsufficientCapacityException {\n-        DomainRouterVO router = _routerDao.findByNetwork(guestNetwork.getId());\n-        if (router != null) {\n-            return router;\n-        }\n+    protected DomainRouterVO createVirtualRouter(Network guestNetwork, DataCenterDeployment plan, HypervisorType type, Account owner) throws ConcurrentOperationException, InsufficientCapacityException {\n \n         /* Before starting router, already know the hypervisor type */\n         VMTemplateVO template = _templateDao.findRoutingTemplate(type);\n@@ -708,6 +704,7 @@ protected DomainRouterVO findOrCreateVirtualRouter(Network guestNetwork, DataCen\n             throw new ConcurrentOperationException(\"Unable to acquire lock on \" + guestNetwork.getId());\n         }\n         \n+        DomainRouterVO router = null;\n         try {\n             txn.start();\n             \n@@ -780,8 +777,11 @@ public DomainRouterVO deployVirtualRouter(Network guestNetwork, DeployDestinatio\n         assert guestNetwork.getTrafficType() == TrafficType.Guest;\n \n         DataCenterDeployment plan = new DataCenterDeployment(dcId);\n-\n-        DomainRouterVO router = findOrCreateVirtualRouter(guestNetwork, plan, dest.getCluster().getHypervisorType(), owner);\n+        \n+        DomainRouterVO router = _routerDao.findByNetwork(guestNetwork.getId());\n+        if (router == null) {\n+            router = createVirtualRouter(guestNetwork, plan, dest.getCluster().getHypervisorType(), owner);\n+        }\n         \n         State state = router.getState();\n         if (state != State.Running) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b2942572e7a07812c5338c723db54a405383b6dd/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "7f705664b19cf2fcc5e4040d1baf7275bccf7095",
                "status": "modified"
            }
        ],
        "message": "bug 10453: fixed NPE in startRouter command - used to happen when domR start was called for existing domR as a part of networkImplement\nstatus 10453: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/ae665d4b113487926358803e3ca9b0cd87d45856",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_b31b842": {
        "bug_id": "cloudstack_b31b842",
        "commit": "https://github.com/apache/cloudstack/commit/b31b8425df9b442a572aec7a2d462b80881fea0f",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/b31b8425df9b442a572aec7a2d462b80881fea0f/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java?ref=b31b8425df9b442a572aec7a2d462b80881fea0f",
                "deletions": 2,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "patch": "@@ -178,8 +178,10 @@ public boolean  stateTransit(Volume.Event event) {\n         boolean result = false;\n         try {\n             volumeVO = volumeDao.findById(volumeVO.getId());\n-            result = _volStateMachine.transitTo(volumeVO, event, null, volumeDao);\n-            volumeVO = volumeDao.findById(volumeVO.getId());\n+            if(volumeVO != null) {\n+                result = _volStateMachine.transitTo(volumeVO, event, null, volumeDao);\n+                volumeVO = volumeDao.findById(volumeVO.getId());\n+            }\n         } catch (NoTransitionException e) {\n             String errorMessage = \"Failed to transit volume: \" + getVolumeId() + \", due to: \" + e.toString();\n             s_logger.debug(errorMessage);",
                "raw_url": "https://github.com/apache/cloudstack/raw/b31b8425df9b442a572aec7a2d462b80881fea0f/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "sha": "e8518704d9efadf868c3394af5e099a05ea70bc0",
                "status": "modified"
            },
            {
                "additions": 77,
                "blob_url": "https://github.com/apache/cloudstack/blob/b31b8425df9b442a572aec7a2d462b80881fea0f/engine/storage/volume/test/org/apache/cloudstack/storage/volume/VolumeObjectTest.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/test/org/apache/cloudstack/storage/volume/VolumeObjectTest.java?ref=b31b8425df9b442a572aec7a2d462b80881fea0f",
                "deletions": 0,
                "filename": "engine/storage/volume/test/org/apache/cloudstack/storage/volume/VolumeObjectTest.java",
                "patch": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.cloudstack.storage.volume;\n+\n+import org.apache.cloudstack.engine.subsystem.api.storage.DataStore;\n+import org.apache.cloudstack.storage.datastore.ObjectInDataStoreManager;\n+import org.apache.cloudstack.storage.datastore.db.VolumeDataStoreDao;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import com.cloud.storage.Storage;\n+import com.cloud.storage.Volume;\n+import com.cloud.storage.VolumeVO;\n+import com.cloud.storage.dao.DiskOfferingDao;\n+import com.cloud.storage.dao.VolumeDao;\n+import com.cloud.vm.dao.VMInstanceDao;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class VolumeObjectTest {\n+\n+    @Mock\n+    VolumeDao volumeDao;\n+\n+    @Mock\n+    VolumeDataStoreDao volumeStoreDao;\n+\n+    @Mock\n+    ObjectInDataStoreManager objectInStoreMgr;\n+\n+    @Mock\n+    VMInstanceDao vmInstanceDao;\n+\n+    @Mock\n+    DiskOfferingDao diskOfferingDao;\n+\n+    @InjectMocks\n+    VolumeObject volumeObject;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        volumeObject.configure(Mockito.mock(DataStore.class), new VolumeVO(\"name\", 1l, 1l, 1l, 1l, 1l, \"folder\", \"path\", Storage.ProvisioningType.THIN, 1l, Volume.Type.DATADISK));\n+    }\n+\n+    /**\n+     * Tests the following scenario:\n+     * If the volume gets deleted by another thread (cleanup) and the cleanup is attempted again, the volume isnt found in DB and hence NPE occurs\n+     * during transition\n+     */\n+    @Test\n+    public void testStateTransit() {\n+        boolean result = volumeObject.stateTransit(Volume.Event.OperationFailed);\n+        Assert.assertFalse(\"since the volume doesnt exist in the db, the operation should fail but, should not throw any exception\", result);\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/b31b8425df9b442a572aec7a2d462b80881fea0f/engine/storage/volume/test/org/apache/cloudstack/storage/volume/VolumeObjectTest.java",
                "sha": "81180137bc3b5ede0156bb8b2b8dc401ac2db8d7",
                "status": "added"
            }
        ],
        "message": "CLOUDSTACK-8525: NPE while updating the state of the volume after deletion\n\nThe volume is already deleted (may be by the cleanup thread) and hence\nthe NPE. Added a not null check for the volumevo and returning false\nfrom the state transition\n\nThis closes #321",
        "parent": "https://github.com/apache/cloudstack/commit/bec44bffb3ed415315793cf83603ce13bf865ff0",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeObjectTest.java"
        ]
    },
    "cloudstack_b363fd4": {
        "bug_id": "cloudstack_b363fd4",
        "commit": "https://github.com/apache/cloudstack/commit/b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/com/cloud/hypervisor/HypervisorGuru.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/main/java/com/cloud/hypervisor/HypervisorGuru.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "api/src/main/java/com/cloud/hypervisor/HypervisorGuru.java",
                "patch": "@@ -19,6 +19,7 @@\n import java.util.List;\n import java.util.Map;\n \n+import com.cloud.storage.StoragePool;\n import org.apache.cloudstack.framework.config.ConfigKey;\n \n import com.cloud.agent.api.Command;\n@@ -32,7 +33,7 @@\n import com.cloud.vm.VirtualMachineProfile;\n \n public interface HypervisorGuru extends Adapter {\n-    static final ConfigKey<Boolean> VmwareFullClone = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"vmware.create.full.clone\", \"true\",\n+    ConfigKey<Boolean> VmwareFullClone = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"vmware.create.full.clone\", \"true\",\n             \"If set to true, creates guest VMs as full clones on ESX\", false);\n     HypervisorType getHypervisorType();\n \n@@ -84,4 +85,13 @@\n     List<Command> finalizeExpungeVolumes(VirtualMachine vm);\n \n     Map<String, String> getClusterSettings(long vmId);\n+\n+    /**\n+     * Will generate commands to migrate a vm to a pool. For now this will only work for stopped VMs on Vmware.\n+     *\n+     * @param vm the stopped vm to migrate\n+     * @param destination the primary storage pool to migrate to\n+     * @return a list of commands to perform for a successful migration\n+     */\n+    List<Command> finalizeMigrate(VirtualMachine vm, StoragePool destination);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/com/cloud/hypervisor/HypervisorGuru.java",
                "sha": "da2c7d04eb335cbbd94490685838709415570c2e",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/com/cloud/storage/VolumeApiService.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/main/java/com/cloud/storage/VolumeApiService.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "api/src/main/java/com/cloud/storage/VolumeApiService.java",
                "patch": "@@ -29,11 +29,21 @@\n import org.apache.cloudstack.api.command.user.volume.ResizeVolumeCmd;\n import org.apache.cloudstack.api.command.user.volume.UploadVolumeCmd;\n import org.apache.cloudstack.api.response.GetUploadParamsResponse;\n+import org.apache.cloudstack.framework.config.ConfigKey;\n \n import com.cloud.exception.ResourceAllocationException;\n import com.cloud.user.Account;\n \n public interface VolumeApiService {\n+\n+    ConfigKey<Long> ConcurrentMigrationsThresholdPerDatastore = new ConfigKey<Long>(\"Advanced\"\n+            , Long.class\n+            , \"concurrent.migrations.per.target.datastore\"\n+            , \"0\"\n+            , \"Limits number of migrations that can be handled per datastore concurrently; default is 0 - unlimited\"\n+            , true // not sure if this is to be dynamic\n+            , ConfigKey.Scope.Global);\n+\n     /**\n      * Creates the database object for a volume based on the given criteria\n      *",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/com/cloud/storage/VolumeApiService.java",
                "sha": "7b38a6b1af101f941b73071b916b5a9fee0e79af",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/BaseAsyncCmd.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/main/java/org/apache/cloudstack/api/BaseAsyncCmd.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "api/src/main/java/org/apache/cloudstack/api/BaseAsyncCmd.java",
                "patch": "@@ -27,6 +27,7 @@\n     public static final String ipAddressSyncObject = \"ipaddress\";\n     public static final String networkSyncObject = \"network\";\n     public static final String vpcSyncObject = \"vpc\";\n+    public static final String migrationSyncObject = \"migration\";\n     public static final String snapshotHostSyncObject = \"snapshothost\";\n     public static final String gslbSyncObject = \"globalserverloadbalancer\";\n     private static final Logger s_logger = Logger.getLogger(BaseAsyncCmd.class.getName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/BaseAsyncCmd.java",
                "sha": "1c3822c1057c0c8ab2d3702bed13c36bcd2f7c6a",
                "status": "modified"
            },
            {
                "additions": 43,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java",
                "changes": 71,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 28,
                "filename": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java",
                "patch": "@@ -43,10 +43,10 @@\n import com.cloud.vm.VirtualMachine;\n \n @APICommand(name = \"migrateVirtualMachine\",\n-            description = \"Attempts Migration of a VM to a different host or Root volume of the vm to a different storage pool\",\n+        description = \"Attempts Migration of a VM to a different host or Root volume of the vm to a different storage pool\",\n         responseObject = UserVmResponse.class, entityType = {VirtualMachine.class},\n-            requestHasSensitiveInfo = false,\n-            responseHasSensitiveInfo = true)\n+        requestHasSensitiveInfo = false,\n+        responseHasSensitiveInfo = true)\n public class MigrateVMCmd extends BaseAsyncCmd {\n     public static final Logger s_logger = Logger.getLogger(MigrateVMCmd.class.getName());\n \n@@ -57,24 +57,24 @@\n     /////////////////////////////////////////////////////\n \n     @Parameter(name = ApiConstants.HOST_ID,\n-               type = CommandType.UUID,\n-               entityType = HostResponse.class,\n-               required = false,\n-               description = \"Destination Host ID to migrate VM to. Required for live migrating a VM from host to host\")\n+            type = CommandType.UUID,\n+            entityType = HostResponse.class,\n+            required = false,\n+            description = \"Destination Host ID to migrate VM to. Required for live migrating a VM from host to host\")\n     private Long hostId;\n \n     @Parameter(name = ApiConstants.VIRTUAL_MACHINE_ID,\n-               type = CommandType.UUID,\n-               entityType = UserVmResponse.class,\n-               required = true,\n-               description = \"the ID of the virtual machine\")\n+            type = CommandType.UUID,\n+            entityType = UserVmResponse.class,\n+            required = true,\n+            description = \"the ID of the virtual machine\")\n     private Long virtualMachineId;\n \n     @Parameter(name = ApiConstants.STORAGE_ID,\n-               type = CommandType.UUID,\n-               entityType = StoragePoolResponse.class,\n-               required = false,\n-               description = \"Destination storage pool ID to migrate VM volumes to. Required for migrating the root disk volume\")\n+            type = CommandType.UUID,\n+            entityType = StoragePoolResponse.class,\n+            required = false,\n+            description = \"Destination storage pool ID to migrate VM volumes to. Required for migrating the root disk volume\")\n     private Long storageId;\n \n     /////////////////////////////////////////////////////\n@@ -119,13 +119,15 @@ public String getEventType() {\n \n     @Override\n     public String getEventDescription() {\n+        String eventDescription;\n         if (getHostId() != null) {\n-            return \"Attempting to migrate VM Id: \" + this._uuidMgr.getUuid(VirtualMachine.class, getVirtualMachineId()) + \" to host Id: \" + this._uuidMgr.getUuid(Host.class, getHostId());\n+            eventDescription = String.format(\"Attempting to migrate VM id: %s to host Id: %s\", getVirtualMachineId(), getHostId());\n         } else if (getStoragePoolId() != null) {\n-            return \"Attempting to migrate VM Id: \" + this._uuidMgr.getUuid(VirtualMachine.class, getVirtualMachineId()) + \" to storage pool Id: \" + this._uuidMgr.getUuid(StoragePool.class, getStoragePoolId());\n+            eventDescription = String.format(\"Attempting to migrate VM id: %s to storage pool Id: %s\", getVirtualMachineId(), getStoragePoolId());\n         } else {\n-            return \"Attempting to migrate VM Id: \" + this._uuidMgr.getUuid(VirtualMachine.class, getVirtualMachineId());\n+            eventDescription = String.format(\"Attempting to migrate VM id: %s\", getVirtualMachineId());\n         }\n+        return eventDescription;\n     }\n \n     @Override\n@@ -152,16 +154,17 @@ public void execute() {\n             if (destinationHost.getType() != Host.Type.Routing) {\n                 throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n             }\n-            CallContext.current().setEventDetails(\"VM Id: \" + this._uuidMgr.getUuid(VirtualMachine.class, getVirtualMachineId()) + ((getHostId() != null) ?  \" to host Id: \" + this._uuidMgr.getUuid(Host.class, getHostId()) : \"\" ));\n+            CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n         }\n \n+        // OfflineMigration performed when this parameter is specified\n         StoragePool destStoragePool = null;\n         if (getStoragePoolId() != null) {\n             destStoragePool = _storageService.getStoragePool(getStoragePoolId());\n             if (destStoragePool == null) {\n                 throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n             }\n-            CallContext.current().setEventDetails(\"VM Id: \" + this._uuidMgr.getUuid(VirtualMachine.class, getVirtualMachineId()) + \" to storage pool Id: \" + this._uuidMgr.getUuid(StoragePool.class, getStoragePoolId()));\n+            CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStoragePoolId());\n         }\n \n         try {\n@@ -172,7 +175,7 @@ public void execute() {\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n             }\n             if (migratedVm != null) {\n-                UserVmResponse response = _responseGenerator.createUserVmResponse(ResponseView.Full, \"virtualmachine\", (UserVm)migratedVm).get(0);\n+                UserVmResponse response = _responseGenerator.createUserVmResponse(ResponseView.Full, \"virtualmachine\", (UserVm) migratedVm).get(0);\n                 response.setResponseName(getCommandName());\n                 setResponseObject(response);\n             } else {\n@@ -181,15 +184,27 @@ public void execute() {\n         } catch (ResourceUnavailableException ex) {\n             s_logger.warn(\"Exception: \", ex);\n             throw new ServerApiException(ApiErrorCode.RESOURCE_UNAVAILABLE_ERROR, ex.getMessage());\n-        } catch (ConcurrentOperationException e) {\n-            s_logger.warn(\"Exception: \", e);\n-            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, e.getMessage());\n-        } catch (ManagementServerException e) {\n-            s_logger.warn(\"Exception: \", e);\n-            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, e.getMessage());\n-        } catch (VirtualMachineMigrationException e) {\n+        } catch (VirtualMachineMigrationException | ConcurrentOperationException | ManagementServerException e) {\n             s_logger.warn(\"Exception: \", e);\n             throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, e.getMessage());\n         }\n     }\n+\n+    @Override\n+    public String getSyncObjType() {\n+        return (getSyncObjId() != null) ? BaseAsyncCmd.migrationSyncObject : null;\n+    }\n+\n+    @Override\n+    public Long getSyncObjId() {\n+        if (getStoragePoolId() != null) {\n+            return getStoragePoolId();\n+        }\n+        // OfflineVmwareMigrations: undocumented feature;\n+        // OfflineVmwareMigrations: on implementing a maximum queue size for per storage migrations it seems counter intuitive for the user to not enforce it for hosts as well.\n+        if (getHostId() != null) {\n+            return getHostId();\n+        }\n+        return null;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java",
                "sha": "9f73ae586a0835a79c71263cff68db714bf3c324",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVirtualMachineWithVolumeCmd.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVirtualMachineWithVolumeCmd.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 8,
                "filename": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVirtualMachineWithVolumeCmd.java",
                "patch": "@@ -46,7 +46,7 @@\n \n @APICommand(name = \"migrateVirtualMachineWithVolume\",\n             description = \"Attempts Migration of a VM with its volumes to a different host\",\n-        responseObject = UserVmResponse.class, entityType = {VirtualMachine.class},\n+            responseObject = UserVmResponse.class, entityType = {VirtualMachine.class},\n             requestHasSensitiveInfo = false,\n             responseHasSensitiveInfo = true)\n public class MigrateVirtualMachineWithVolumeCmd extends BaseAsyncCmd {\n@@ -147,6 +147,7 @@ public void execute() {\n         }\n \n         Host destinationHost = _resourceService.getHost(getHostId());\n+        // OfflineVmwareMigration: destination host would have to not be a required parameter for stopped VMs\n         if (destinationHost == null) {\n             throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id =\" + getHostId());\n         }\n@@ -163,13 +164,7 @@ public void execute() {\n         } catch (ResourceUnavailableException ex) {\n             s_logger.warn(\"Exception: \", ex);\n             throw new ServerApiException(ApiErrorCode.RESOURCE_UNAVAILABLE_ERROR, ex.getMessage());\n-        } catch (ConcurrentOperationException e) {\n-            s_logger.warn(\"Exception: \", e);\n-            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, e.getMessage());\n-        } catch (ManagementServerException e) {\n-            s_logger.warn(\"Exception: \", e);\n-            throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, e.getMessage());\n-        } catch (VirtualMachineMigrationException e) {\n+        } catch (ConcurrentOperationException | ManagementServerException | VirtualMachineMigrationException e) {\n             s_logger.warn(\"Exception: \", e);\n             throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR, e.getMessage());\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVirtualMachineWithVolumeCmd.java",
                "sha": "65d71cc1300a90d71224066c28a1c28065e25787",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/command/user/volume/MigrateVolumeCmd.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/main/java/org/apache/cloudstack/api/command/user/volume/MigrateVolumeCmd.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "api/src/main/java/org/apache/cloudstack/api/command/user/volume/MigrateVolumeCmd.java",
                "patch": "@@ -120,4 +120,16 @@ public void execute() {\n         }\n     }\n \n+    @Override\n+    public String getSyncObjType() {\n+        return (getSyncObjId() != null) ? BaseAsyncCmd.migrationSyncObject : null;\n+    }\n+\n+    @Override\n+    public Long getSyncObjId() {\n+        if (getStoragePoolId() != null) {\n+            return getStoragePoolId();\n+        }\n+        return null;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/main/java/org/apache/cloudstack/api/command/user/volume/MigrateVolumeCmd.java",
                "sha": "f5d5e8c86ee95b8a88e712d3cdc25b6f0d7a0a34",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/test/java/org/apache/cloudstack/api/command/test/UpdateRoleCmdTest.java",
                "changes": 0,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/test/java/org/apache/cloudstack/api/command/test/UpdateRoleCmdTest.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "api/src/test/java/org/apache/cloudstack/api/command/test/UpdateRoleCmdTest.java",
                "previous_filename": "api/test/org/apache/cloudstack/api/command/test/UpdateRoleCmdTest.java",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/api/src/test/java/org/apache/cloudstack/api/command/test/UpdateRoleCmdTest.java",
                "sha": "c0bd390c1963d15bd77307f9ac457fb990e878e5",
                "status": "renamed"
            },
            {
                "additions": 43,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/MigrateVmToPoolAnswer.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/main/java/com/cloud/agent/api/MigrateVmToPoolAnswer.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "core/src/main/java/com/cloud/agent/api/MigrateVmToPoolAnswer.java",
                "patch": "@@ -0,0 +1,43 @@\n+//\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+//\n+\n+package com.cloud.agent.api;\n+\n+import org.apache.cloudstack.storage.to.VolumeObjectTO;\n+\n+import java.util.List;\n+\n+public class MigrateVmToPoolAnswer extends Answer {\n+\n+    List<VolumeObjectTO> volumeTos;\n+\n+    public MigrateVmToPoolAnswer(MigrateVmToPoolCommand cmd, Exception ex) {\n+        super(cmd, ex);\n+        volumeTos = null;\n+    }\n+\n+    public MigrateVmToPoolAnswer(MigrateVmToPoolCommand cmd, List<VolumeObjectTO> volumeTos) {\n+        super(cmd, true, null);\n+        this.volumeTos = volumeTos;\n+    }\n+\n+    public List<VolumeObjectTO> getVolumeTos() {\n+        return volumeTos;\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/MigrateVmToPoolAnswer.java",
                "sha": "bc9ae6fd08257af32d6ca7de2f292ed6b68d73e4",
                "status": "added"
            },
            {
                "additions": 70,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/MigrateVmToPoolCommand.java",
                "changes": 70,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/main/java/com/cloud/agent/api/MigrateVmToPoolCommand.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "core/src/main/java/com/cloud/agent/api/MigrateVmToPoolCommand.java",
                "patch": "@@ -0,0 +1,70 @@\n+//\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+//\n+package com.cloud.agent.api;\n+\n+import com.cloud.agent.api.to.VolumeTO;\n+\n+import java.util.Collection;\n+\n+/**\n+ * used to tell the agent to migrate a vm to a different primary storage pool.\n+ * It is for now only implemented on Vmware and is supposed to work irrespective of whether the VM is started or not.\n+ *\n+ */\n+public class MigrateVmToPoolCommand extends Command {\n+    private Collection<VolumeTO> volumes;\n+    private String vmName;\n+    private String destinationPool;\n+    private boolean executeInSequence = false;\n+\n+    protected MigrateVmToPoolCommand() {\n+    }\n+\n+    /**\n+     *\n+     * @param vmName the name of the VM to migrate\n+     * @param volumes used to supply feedback on vmware generated names\n+     * @param destinationPool the primary storage pool to migrate the VM to\n+     * @param executeInSequence\n+     */\n+    public MigrateVmToPoolCommand(String vmName, Collection<VolumeTO> volumes, String destinationPool, boolean executeInSequence) {\n+        this.vmName = vmName;\n+        this.volumes = volumes;\n+        this.destinationPool = destinationPool;\n+        this.executeInSequence = executeInSequence;\n+    }\n+\n+    public Collection<VolumeTO> getVolumes() {\n+        return volumes;\n+    }\n+\n+    public String getDestinationPool() {\n+        return destinationPool;\n+    }\n+\n+    public String getVmName() {\n+        return vmName;\n+    }\n+\n+    @Override\n+    public boolean executeInSequence() {\n+        return executeInSequence;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/MigrateVmToPoolCommand.java",
                "sha": "91a911d7c18170d73ef50bc2934453c2101f5d94",
                "status": "added"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/UnregisterVMCommand.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/main/java/com/cloud/agent/api/UnregisterVMCommand.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "core/src/main/java/com/cloud/agent/api/UnregisterVMCommand.java",
                "patch": "@@ -22,14 +22,19 @@\n public class UnregisterVMCommand extends Command {\n     String vmName;\n     boolean cleanupVmFiles = false;\n+    boolean executeInSequence;\n \n     public UnregisterVMCommand(String vmName) {\n+        this(vmName, false);\n+    }\n+    public UnregisterVMCommand(String vmName, boolean executeInSequence) {\n         this.vmName = vmName;\n+        this.executeInSequence = executeInSequence;\n     }\n \n     @Override\n     public boolean executeInSequence() {\n-        return false;\n+        return executeInSequence;\n     }\n \n     public String getVmName() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/UnregisterVMCommand.java",
                "sha": "4c5f138a63c73f08ab638af65b6482a4d809788e",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/storage/MigrateVolumeCommand.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/main/java/com/cloud/agent/api/storage/MigrateVolumeCommand.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 3,
                "filename": "core/src/main/java/com/cloud/agent/api/storage/MigrateVolumeCommand.java",
                "patch": "@@ -31,6 +31,7 @@\n     long volumeId;\n     String volumePath;\n     StorageFilerTO pool;\n+    StorageFilerTO sourcePool;\n     String attachedVmName;\n     Volume.Type volumeType;\n \n@@ -47,14 +48,17 @@ public MigrateVolumeCommand(long volumeId, String volumePath, StoragePool pool,\n     }\n \n     public MigrateVolumeCommand(long volumeId, String volumePath, StoragePool pool, String attachedVmName, Volume.Type volumeType, int timeout) {\n-        this.volumeId = volumeId;\n-        this.volumePath = volumePath;\n-        this.pool = new StorageFilerTO(pool);\n+        this(volumeId,volumePath,pool,timeout);\n         this.attachedVmName = attachedVmName;\n         this.volumeType = volumeType;\n         this.setWait(timeout);\n     }\n \n+    public MigrateVolumeCommand(long volumeId, String volumePath, StoragePool sourcePool, StoragePool targetPool) {\n+        this(volumeId,volumePath,targetPool, null, Volume.Type.UNKNOWN, -1);\n+        this.sourcePool = new StorageFilerTO(sourcePool);\n+    }\n+\n     public MigrateVolumeCommand(DataTO srcData, DataTO destData, Map<String, String> srcDetails, Map<String, String> destDetails, int timeout) {\n         this.srcData = srcData;\n         this.destData = destData;\n@@ -81,6 +85,14 @@ public StorageFilerTO getPool() {\n         return pool;\n     }\n \n+    public StorageFilerTO getSourcePool() {\n+        return sourcePool;\n+    }\n+\n+    public StorageFilerTO getTargetPool() {\n+        return pool;\n+    }\n+\n     public String getAttachedVmName() {\n         return attachedVmName;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/core/src/main/java/com/cloud/agent/api/storage/MigrateVolumeCommand.java",
                "sha": "9902a86fb8938f8de61fd65f3af9e28f7e0ba5b4",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/api/src/main/java/org/apache/cloudstack/engine/subsystem/api/storage/DataMotionStrategy.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/api/src/main/java/org/apache/cloudstack/engine/subsystem/api/storage/DataMotionStrategy.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "engine/api/src/main/java/org/apache/cloudstack/engine/subsystem/api/storage/DataMotionStrategy.java",
                "patch": "@@ -25,11 +25,28 @@\n import com.cloud.agent.api.to.VirtualMachineTO;\n import com.cloud.host.Host;\n \n+/**\n+ * Interface to query how to move data around and to commision the moving\n+ */\n public interface DataMotionStrategy {\n+    /**\n+     * Reports whether this instance can do a move from source to destination\n+     * @param srcData object to move\n+     * @param destData location to move it to\n+     * @return the expertise level with which this instance knows how to handle the move\n+     */\n     StrategyPriority canHandle(DataObject srcData, DataObject destData);\n \n     StrategyPriority canHandle(Map<VolumeInfo, DataStore> volumeMap, Host srcHost, Host destHost);\n \n+    /**\n+     * Copy the source volume to its destination (on a host if not null)\n+     *\n+     * @param srcData volume to move\n+     * @param destData volume description as intended after the move\n+     * @param destHost if not null destData should be reachable from here\n+     * @param callback where to report completion or failure to\n+     */\n     void copyAsync(DataObject srcData, DataObject destData, Host destHost, AsyncCompletionCallback<CopyCommandResult> callback);\n \n     void copyAsync(Map<VolumeInfo, DataStore> volumeMap, VirtualMachineTO vmTo, Host srcHost, Host destHost, AsyncCompletionCallback<CopyCommandResult> callback);",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/api/src/main/java/org/apache/cloudstack/engine/subsystem/api/storage/DataMotionStrategy.java",
                "sha": "2afece483c65b4f3c0d852200c4d5e143b2a8539",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/components-api/src/main/java/com/cloud/storage/StorageManager.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/components-api/src/main/java/com/cloud/storage/StorageManager.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "engine/components-api/src/main/java/com/cloud/storage/StorageManager.java",
                "patch": "@@ -106,7 +106,14 @@\n      * @param poolId\n      * @return comma separated list of tags\n      */\n-    public String getStoragePoolTags(long poolId);\n+    String getStoragePoolTags(long poolId);\n+\n+    /**\n+     * Returns a list of Strings with tags for the specified storage pool\n+     * @param poolId\n+     * @return comma separated list of tags\n+     */\n+    List<String> getStoragePoolTagList(long poolId);\n \n     Answer sendToPool(long poolId, Command cmd) throws StorageUnavailableException;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/components-api/src/main/java/com/cloud/storage/StorageManager.java",
                "sha": "c9c24d8ad730d4b08f1731bc2dd868c5673fe34a",
                "status": "modified"
            },
            {
                "additions": 247,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 334,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 87,
                "filename": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -41,6 +41,9 @@\n \n import org.apache.cloudstack.api.ApiConstants;\n import org.apache.cloudstack.affinity.dao.AffinityGroupVMMapDao;\n+import org.apache.cloudstack.api.command.admin.vm.MigrateVMCmd;\n+import org.apache.cloudstack.api.command.admin.volume.MigrateVolumeCmdByAdmin;\n+import org.apache.cloudstack.api.command.user.volume.MigrateVolumeCmd;\n import org.apache.cloudstack.ca.CAManager;\n import org.apache.cloudstack.context.CallContext;\n import org.apache.cloudstack.engine.orchestration.service.NetworkOrchestrationService;\n@@ -86,6 +89,7 @@\n import com.cloud.agent.api.ClusterVMMetaDataSyncCommand;\n import com.cloud.agent.api.Command;\n import com.cloud.agent.api.MigrateCommand;\n+import com.cloud.agent.api.MigrateVmToPoolAnswer;\n import com.cloud.agent.api.ModifyTargetsCommand;\n import com.cloud.agent.api.PingRoutingCommand;\n import com.cloud.agent.api.PlugNicAnswer;\n@@ -138,10 +142,8 @@\n import com.cloud.exception.AgentUnavailableException;\n import com.cloud.exception.ConcurrentOperationException;\n import com.cloud.exception.ConnectionException;\n-import com.cloud.exception.InsufficientAddressCapacityException;\n import com.cloud.exception.InsufficientCapacityException;\n import com.cloud.exception.InsufficientServerCapacityException;\n-import com.cloud.exception.InsufficientVirtualNetworkCapacityException;\n import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.exception.OperationTimedoutException;\n import com.cloud.exception.ResourceUnavailableException;\n@@ -171,10 +173,12 @@\n import com.cloud.storage.DiskOfferingVO;\n import com.cloud.storage.ScopeType;\n import com.cloud.storage.Storage.ImageFormat;\n+import com.cloud.storage.StorageManager;\n import com.cloud.storage.StoragePool;\n import com.cloud.storage.VMTemplateVO;\n import com.cloud.storage.Volume;\n import com.cloud.storage.Volume.Type;\n+import com.cloud.storage.VolumeApiService;\n import com.cloud.storage.VolumeVO;\n import com.cloud.storage.dao.DiskOfferingDao;\n import com.cloud.storage.dao.GuestOSCategoryDao;\n@@ -314,6 +318,8 @@\n     private VmWorkJobDao _workJobDao;\n     @Inject\n     private AsyncJobManager _jobMgr;\n+    @Inject\n+    private StorageManager storageMgr;\n \n     VmWorkJobHandlerProxy _jobHandlerProxy = new VmWorkJobHandlerProxy(this);\n \n@@ -1820,14 +1826,6 @@ private void setStateMachine() {\n     protected boolean stateTransitTo(final VMInstanceVO vm, final VirtualMachine.Event e, final Long hostId, final String reservationId) throws NoTransitionException {\n         // if there are active vm snapshots task, state change is not allowed\n \n-        // Disable this hacking thing, VM snapshot task need to be managed by its orchestartion flow istelf instead of\n-        // hacking it here at general VM manager\n-        /*\n-                if (_vmSnapshotMgr.hasActiveVMSnapshotTasks(vm.getId())) {\n-                    s_logger.error(\"State transit with event: \" + e + \" failed due to: \" + vm.getInstanceName() + \" has active VM snapshots tasks\");\n-                    return false;\n-                }\n-         */\n         vm.setReservationId(reservationId);\n         return _stateMachine.transitTo(vm, e, new Pair<Long, Long>(vm.getHostId(), hostId), _vmDao);\n     }\n@@ -1836,15 +1834,6 @@ protected boolean stateTransitTo(final VMInstanceVO vm, final VirtualMachine.Eve\n     public boolean stateTransitTo(final VirtualMachine vm1, final VirtualMachine.Event e, final Long hostId) throws NoTransitionException {\n         final VMInstanceVO vm = (VMInstanceVO)vm1;\n \n-        /*\n-         *  Remove the hacking logic here.\n-                // if there are active vm snapshots task, state change is not allowed\n-                if (_vmSnapshotMgr.hasActiveVMSnapshotTasks(vm.getId())) {\n-                    s_logger.error(\"State transit with event: \" + e + \" failed due to: \" + vm.getInstanceName() + \" has active VM snapshots tasks\");\n-                    return false;\n-                }\n-         */\n-\n         final State oldState = vm.getState();\n         if (oldState == State.Starting) {\n             if (e == Event.OperationSucceeded) {\n@@ -1988,92 +1977,246 @@ public void storageMigration(final String vmUuid, final StoragePool destPool) {\n     private void orchestrateStorageMigration(final String vmUuid, final StoragePool destPool) {\n         final VMInstanceVO vm = _vmDao.findByUuid(vmUuid);\n \n-        if (destPool == null) {\n-            throw new CloudRuntimeException(\"Unable to migrate vm: missing destination storage pool\");\n-        }\n+        preStorageMigrationStateCheck(destPool, vm);\n \n         try {\n-            stateTransitTo(vm, VirtualMachine.Event.StorageMigrationRequested, null);\n-        } catch (final NoTransitionException e) {\n-            s_logger.debug(\"Unable to migrate vm: \" + e.toString());\n-            throw new CloudRuntimeException(\"Unable to migrate vm: \" + e.toString());\n+            if(s_logger.isDebugEnabled()) {\n+                s_logger.debug(String.format(\"Offline migration of %s vm %s with volumes\",\n+                                vm.getHypervisorType().toString(),\n+                                vm.getInstanceName()));\n+            }\n+\n+            migrateThroughHypervisorOrStorage(destPool, vm);\n+\n+        } catch (ConcurrentOperationException\n+                | InsufficientCapacityException // possibly InsufficientVirtualNetworkCapacityException or InsufficientAddressCapacityException\n+                | StorageUnavailableException e) {\n+            String msg = String.format(\"Failed to migrate VM: %s\", vmUuid);\n+            s_logger.debug(msg);\n+            throw new CloudRuntimeException(msg, e);\n+        } finally {\n+            try {\n+                stateTransitTo(vm, Event.AgentReportStopped, null);\n+            } catch (final NoTransitionException e) {\n+                String anotherMEssage = String.format(\"failed to change vm state of VM: %s\", vmUuid);\n+                s_logger.debug(anotherMEssage);\n+                throw new CloudRuntimeException(anotherMEssage, e);\n+            }\n         }\n+    }\n \n+    private Answer[] attemptHypervisorMigration(StoragePool destPool, VMInstanceVO vm) {\n+        final HypervisorGuru hvGuru = _hvGuruMgr.getGuru(vm.getHypervisorType());\n+        // OfflineVmwareMigration: in case of vmware call vcenter to do it for us.\n+        // OfflineVmwareMigration: should we check the proximity of source and destination\n+        // OfflineVmwareMigration: if we are in the same cluster/datacentre/pool or whatever?\n+        // OfflineVmwareMigration: we are checking on success to optionally delete an old vm if we are not\n+        List<Command> commandsToSend = hvGuru.finalizeMigrate(vm, destPool);\n+\n+        Long hostId = vm.getHostId();\n+        // OfflineVmwareMigration: probably this is null when vm is stopped\n+        if(hostId == null) {\n+            hostId = vm.getLastHostId();\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(String.format(\"host id is null, using last host id %d\", hostId) );\n+            }\n+        }\n+\n+        if(CollectionUtils.isNotEmpty(commandsToSend)) {\n+            Commands commandsContainer = new Commands(Command.OnError.Stop);\n+            commandsContainer.addCommands(commandsToSend);\n+            try {\n+                // OfflineVmwareMigration: change to the call back variety?\n+                // OfflineVmwareMigration: getting a Long seq to be filled with _agentMgr.send(hostId, commandsContainer, this)\n+                return  _agentMgr.send(hostId, commandsContainer);\n+            } catch (AgentUnavailableException | OperationTimedoutException e) {\n+                throw new CloudRuntimeException(String.format(\"Failed to migrate VM: %s\", vm.getUuid()),e);\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private void afterHypervisorMigrationCleanup(StoragePool destPool, VMInstanceVO vm, HostVO srcHost, Long srcClusterId, Answer[] hypervisorMigrationResults) throws InsufficientCapacityException {\n+        boolean isDebugEnabled = s_logger.isDebugEnabled();\n+        if(isDebugEnabled) {\n+            String msg = String.format(\"cleaning up after hypervisor pool migration volumes for VM %s(%s) to pool %s(%s)\", vm.getInstanceName(), vm.getUuid(), destPool.getName(), destPool.getUuid());\n+            s_logger.debug(msg);\n+        }\n+        setDestinationPoolAndReallocateNetwork(destPool, vm);\n+        // OfflineVmwareMigration: don't set this to null or have another way to address the command; twice migrating will lead to an NPE\n+        Long destPodId = destPool.getPodId();\n+        Long vmPodId = vm.getPodIdToDeployIn();\n+        if (destPodId == null || ! destPodId.equals(vmPodId)) {\n+            if(isDebugEnabled) {\n+                String msg = String.format(\"resetting lasHost for VM %s(%s) as pod (%s) is no good.\", vm.getInstanceName(), vm.getUuid(), destPodId);\n+                s_logger.debug(msg);\n+            }\n+\n+            vm.setLastHostId(null);\n+            vm.setPodIdToDeployIn(destPodId);\n+            // OfflineVmwareMigration: a consecutive migration will fail probably (no host not pod)\n+        }// else keep last host set for this vm\n+        markVolumesInPool(vm,destPool, hypervisorMigrationResults);\n+        // OfflineVmwareMigration: deal with answers, if (hypervisorMigrationResults.length > 0)\n+        // OfflineVmwareMigration: iterate over the volumes for data updates\n+    }\n+\n+    private void markVolumesInPool(VMInstanceVO vm, StoragePool destPool, Answer[] hypervisorMigrationResults) {\n+        MigrateVmToPoolAnswer relevantAnswer = null;\n+        for (Answer answer : hypervisorMigrationResults) {\n+            if (s_logger.isTraceEnabled()) {\n+                s_logger.trace(String.format(\"received an %s: %s\", answer.getClass().getSimpleName(), answer));\n+            }\n+            if (answer instanceof MigrateVmToPoolAnswer) {\n+                relevantAnswer = (MigrateVmToPoolAnswer) answer;\n+            }\n+        }\n+        if (relevantAnswer == null) {\n+            throw new CloudRuntimeException(\"no relevant migration results found\");\n+        }\n+        List<VolumeVO> volumes = _volsDao.findUsableVolumesForInstance(vm.getId());\n+        if(s_logger.isDebugEnabled()) {\n+            String msg = String.format(\"found %d volumes for VM %s(uuid:%s, id:%d)\", volumes.size(), vm.getInstanceName(), vm.getUuid(), vm.getId());\n+            s_logger.debug(msg);\n+        }\n+        for (VolumeObjectTO result : relevantAnswer.getVolumeTos() ) {\n+            if(s_logger.isDebugEnabled()) {\n+                s_logger.debug(String.format(\"updating volume (%d) with path '%s' on pool '%d'\", result.getId(), result.getPath(), destPool.getId()));\n+            }\n+            VolumeVO volume = _volsDao.findById(result.getId());\n+            volume.setPath(result.getPath());\n+            volume.setPoolId(destPool.getId());\n+            _volsDao.update(volume.getId(), volume);\n+        }\n+    }\n+\n+    private void migrateThroughHypervisorOrStorage(StoragePool destPool, VMInstanceVO vm) throws StorageUnavailableException, InsufficientCapacityException {\n         final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+        final Long srchostId = vm.getHostId() != null ? vm.getHostId() : vm.getLastHostId();\n+        final HostVO srcHost = _hostDao.findById(srchostId);\n+        final Long srcClusterId = srcHost.getClusterId();\n+        Answer[] hypervisorMigrationResults = attemptHypervisorMigration(destPool, vm);\n         boolean migrationResult = false;\n-        try {\n+        if (hypervisorMigrationResults == null) {\n+            // OfflineVmwareMigration: if the HypervisorGuru can't do it, let the volume manager take care of it.\n             migrationResult = volumeMgr.storageMigration(profile, destPool);\n-\n             if (migrationResult) {\n-                //if the vm is migrated to different pod in basic mode, need to reallocate ip\n+                afterStorageMigrationCleanup(destPool, vm, srcHost, srcClusterId);\n+            } else {\n+                s_logger.debug(\"Storage migration failed\");\n+            }\n+        } else {\n+            afterHypervisorMigrationCleanup(destPool, vm, srcHost, srcClusterId, hypervisorMigrationResults);\n+        }\n+    }\n \n-                if (destPool.getPodId() != null && !destPool.getPodId().equals(vm.getPodIdToDeployIn())) {\n-                    final DataCenterDeployment plan = new DataCenterDeployment(vm.getDataCenterId(), destPool.getPodId(), null, null, null, null);\n-                    final VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vm, null, null, null, null);\n-                    _networkMgr.reallocate(vmProfile, plan);\n-                }\n+    private void preStorageMigrationStateCheck(StoragePool destPool, VMInstanceVO vm) {\n+        if (destPool == null) {\n+            throw new CloudRuntimeException(\"Unable to migrate vm: missing destination storage pool\");\n+        }\n \n-                //when start the vm next time, don;'t look at last_host_id, only choose the host based on volume/storage pool\n-                vm.setLastHostId(null);\n-                vm.setPodIdToDeployIn(destPool.getPodId());\n-\n-                // If VM was cold migrated between clusters belonging to two different VMware DCs,\n-                // unregister the VM from the source host and cleanup the associated VM files.\n-                if (vm.getHypervisorType().equals(HypervisorType.VMware)) {\n-                    Long srcClusterId = null;\n-                    Long srcHostId = vm.getHostId() != null ? vm.getHostId() : vm.getLastHostId();\n-                    if (srcHostId != null) {\n-                        HostVO srcHost = _hostDao.findById(srcHostId);\n-                        srcClusterId = srcHost.getClusterId();\n-                    }\n+        checkDestinationForTags(destPool, vm);\n+        try {\n+            stateTransitTo(vm, Event.StorageMigrationRequested, null);\n+        } catch (final NoTransitionException e) {\n+            String msg = String.format(\"Unable to migrate vm: %s\", vm.getUuid());\n+            s_logger.debug(msg);\n+            throw new CloudRuntimeException(msg, e);\n+        }\n+    }\n \n-                    final Long destClusterId = destPool.getClusterId();\n-                    if (srcClusterId != null && destClusterId != null && ! srcClusterId.equals(destClusterId)) {\n-                        final String srcDcName = _clusterDetailsDao.getVmwareDcName(srcClusterId);\n-                        final String destDcName = _clusterDetailsDao.getVmwareDcName(destClusterId);\n-                        if (srcDcName != null && destDcName != null && !srcDcName.equals(destDcName)) {\n-                            s_logger.debug(\"Since VM's storage was successfully migrated across VMware Datacenters, unregistering VM: \" + vm.getInstanceName() +\n-                                    \" from source host: \" + srcHostId);\n-                            final UnregisterVMCommand uvc = new UnregisterVMCommand(vm.getInstanceName());\n-                            uvc.setCleanupVmFiles(true);\n-                            try {\n-                                _agentMgr.send(srcHostId, uvc);\n-                            } catch (final AgentUnavailableException | OperationTimedoutException e) {\n-                                throw new CloudRuntimeException(\"Failed to unregister VM: \" + vm.getInstanceName() + \" from source host: \" + srcHostId +\n-                                        \" after successfully migrating VM's storage across VMware Datacenters\");\n-                            }\n-                        }\n-                    }\n+    private void checkDestinationForTags(StoragePool destPool, VMInstanceVO vm) {\n+        List<VolumeVO> vols = _volsDao.findUsableVolumesForInstance(vm.getId());\n+        // OfflineVmwareMigration: iterate over volumes\n+        // OfflineVmwareMigration: get disk offering\n+        List<String> storageTags = storageMgr.getStoragePoolTagList(destPool.getId());\n+        for(Volume vol : vols) {\n+            DiskOfferingVO diskOffering = _diskOfferingDao.findById(vol.getDiskOfferingId());\n+            List<String> volumeTags = StringUtils.csvTagsToList(diskOffering.getTags());\n+            if(! matches(volumeTags, storageTags)) {\n+                String msg = String.format(\"destination pool '%s' with tags '%s', does not support the volume diskoffering for volume '%s' (tags: '%s') \",\n+                        destPool.getName(),\n+                        StringUtils.listToCsvTags(storageTags),\n+                        vol.getName(),\n+                        StringUtils.listToCsvTags(volumeTags)\n+                );\n+                throw new CloudRuntimeException(msg);\n+            }\n+        }\n+    }\n+\n+    static boolean matches(List<String> volumeTags, List<String> storagePoolTags) {\n+        // OfflineVmwareMigration: commons collections 4 allows for Collections.containsAll(volumeTags,storagePoolTags);\n+        boolean result = true;\n+        if (volumeTags != null) {\n+            for (String tag : volumeTags) {\n+                // there is a volume tags so\n+                if (storagePoolTags == null || !storagePoolTags.contains(tag)) {\n+                    result = false;\n+                    break;\n                 }\n+            }\n+        }\n+        return result;\n+    }\n \n-            } else {\n-                s_logger.debug(\"Storage migration failed\");\n+\n+    private void afterStorageMigrationCleanup(StoragePool destPool, VMInstanceVO vm, HostVO srcHost, Long srcClusterId) throws InsufficientCapacityException {\n+        setDestinationPoolAndReallocateNetwork(destPool, vm);\n+\n+        //when start the vm next time, don;'t look at last_host_id, only choose the host based on volume/storage pool\n+        vm.setLastHostId(null);\n+        vm.setPodIdToDeployIn(destPool.getPodId());\n+\n+        // If VM was cold migrated between clusters belonging to two different VMware DCs,\n+        // unregister the VM from the source host and cleanup the associated VM files.\n+        if (vm.getHypervisorType().equals(HypervisorType.VMware)) {\n+            afterStorageMigrationVmwareVMcleanup(destPool, vm, srcHost, srcClusterId);\n+        }\n+    }\n+\n+    private void setDestinationPoolAndReallocateNetwork(StoragePool destPool, VMInstanceVO vm) throws InsufficientCapacityException {\n+        //if the vm is migrated to different pod in basic mode, need to reallocate ip\n+\n+        if (destPool.getPodId() != null && !destPool.getPodId().equals(vm.getPodIdToDeployIn())) {\n+            if (s_logger.isDebugEnabled()) {\n+                String msg = String.format(\"as the pod for vm %s has changed we are reallocating its network\", vm.getInstanceName());\n+                s_logger.debug(msg);\n             }\n-        } catch (final ConcurrentOperationException e) {\n-            s_logger.debug(\"Failed to migration: \" + e.toString());\n-            throw new CloudRuntimeException(\"Failed to migration: \" + e.toString());\n-        } catch (final InsufficientVirtualNetworkCapacityException e) {\n-            s_logger.debug(\"Failed to migration: \" + e.toString());\n-            throw new CloudRuntimeException(\"Failed to migration: \" + e.toString());\n-        } catch (final InsufficientAddressCapacityException e) {\n-            s_logger.debug(\"Failed to migration: \" + e.toString());\n-            throw new CloudRuntimeException(\"Failed to migration: \" + e.toString());\n-        } catch (final InsufficientCapacityException e) {\n-            s_logger.debug(\"Failed to migration: \" + e.toString());\n-            throw new CloudRuntimeException(\"Failed to migration: \" + e.toString());\n-        } catch (final StorageUnavailableException e) {\n-            s_logger.debug(\"Failed to migration: \" + e.toString());\n-            throw new CloudRuntimeException(\"Failed to migration: \" + e.toString());\n-        } finally {\n-            try {\n-                stateTransitTo(vm, VirtualMachine.Event.AgentReportStopped, null);\n-            } catch (final NoTransitionException e) {\n-                s_logger.debug(\"Failed to change vm state: \" + e.toString());\n-                throw new CloudRuntimeException(\"Failed to change vm state: \" + e.toString());\n+            final DataCenterDeployment plan = new DataCenterDeployment(vm.getDataCenterId(), destPool.getPodId(), null, null, null, null);\n+            final VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vm, null, null, null, null);\n+            _networkMgr.reallocate(vmProfile, plan);\n+        }\n+    }\n+\n+    private void afterStorageMigrationVmwareVMcleanup(StoragePool destPool, VMInstanceVO vm, HostVO srcHost, Long srcClusterId) {\n+        // OfflineVmwareMigration: this should only happen on storage migration, else the guru would already have issued the command\n+        final Long destClusterId = destPool.getClusterId();\n+        if (srcClusterId != null && destClusterId != null && ! srcClusterId.equals(destClusterId)) {\n+            final String srcDcName = _clusterDetailsDao.getVmwareDcName(srcClusterId);\n+            final String destDcName = _clusterDetailsDao.getVmwareDcName(destClusterId);\n+            if (srcDcName != null && destDcName != null && !srcDcName.equals(destDcName)) {\n+                removeStaleVmFromSource(vm, srcHost);\n             }\n         }\n     }\n \n+    // OfflineVmwareMigration: on port forward refator this to be done in two\n+    // OfflineVmwareMigration: command creation in the guru.migrat method\n+    // OfflineVmwareMigration: sending up in the attemptHypevisorMigration with execute in sequence (responsibility of the guru)\n+    private void removeStaleVmFromSource(VMInstanceVO vm, HostVO srcHost) {\n+        s_logger.debug(\"Since VM's storage was successfully migrated across VMware Datacenters, unregistering VM: \" + vm.getInstanceName() +\n+                \" from source host: \" + srcHost.getId());\n+        final UnregisterVMCommand uvc = new UnregisterVMCommand(vm.getInstanceName());\n+        uvc.setCleanupVmFiles(true);\n+        try {\n+            _agentMgr.send(srcHost.getId(), uvc);\n+        } catch (final Exception e) {\n+            throw new CloudRuntimeException(\"Failed to unregister VM: \" + vm.getInstanceName() + \" from source host: \" + srcHost.getId() +\n+                    \" after successfully migrating VM's storage across VMware Datacenters\");\n+        }\n+    }\n+\n     @Override\n     public void migrate(final String vmUuid, final long srcHostId, final DeployDestination dest)\n             throws ResourceUnavailableException, ConcurrentOperationException {\n@@ -4577,6 +4720,13 @@ protected VirtualMachine retrieve() {\n         final User user = context.getCallingUser();\n         final Account account = context.getCallingAccount();\n \n+        Map<Volume, StoragePool> volumeStorageMap = dest.getStorageForDisks();\n+        if (volumeStorageMap != null) {\n+            for (Volume vol : volumeStorageMap.keySet()) {\n+                checkConcurrentJobsPerDatastoreThreshhold(volumeStorageMap.get(vol));\n+            }\n+        }\n+\n         final VMInstanceVO vm = _vmDao.findByUuid(vmUuid);\n \n         final List<VmWorkJobVO> pendingWorkJobs = _workJobDao.listPendingWorkJobs(\n@@ -4738,6 +4888,16 @@ protected VirtualMachine retrieve() {\n         return new VmJobVirtualMachineOutcome(workJob, vm.getId());\n     }\n \n+    private void checkConcurrentJobsPerDatastoreThreshhold(final StoragePool destPool) {\n+        final Long threshold = VolumeApiService.ConcurrentMigrationsThresholdPerDatastore.value();\n+        if (threshold != null && threshold > 0) {\n+            long count = _jobMgr.countPendingJobs(\"\\\"storageid\\\":\\\"\" + destPool.getUuid() + \"\\\"\", MigrateVMCmd.class.getName(), MigrateVolumeCmd.class.getName(), MigrateVolumeCmdByAdmin.class.getName());\n+            if (count > threshold) {\n+                throw new CloudRuntimeException(\"Number of concurrent migration jobs per datastore exceeded the threshold: \" + threshold.toString() + \". Please try again after some time.\");\n+            }\n+        }\n+    }\n+\n     public Outcome<VirtualMachine> migrateVmStorageThroughJobQueue(\n             final String vmUuid, final StoragePool destPool) {\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "7d218e226d50a4ea8ad6d0dfaf12d69bdb6d85fc",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "patch": "@@ -30,6 +30,10 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+import com.cloud.storage.VolumeApiService;\n+import org.apache.cloudstack.api.command.admin.vm.MigrateVMCmd;\n+import org.apache.cloudstack.api.command.admin.volume.MigrateVolumeCmdByAdmin;\n+import org.apache.cloudstack.api.command.user.volume.MigrateVolumeCmd;\n import org.apache.cloudstack.engine.orchestration.service.VolumeOrchestrationService;\n import org.apache.cloudstack.engine.subsystem.api.storage.ChapInfo;\n import org.apache.cloudstack.engine.subsystem.api.storage.DataObject;\n@@ -953,10 +957,29 @@ public void revokeAccess(long vmId, long hostId) {\n         }\n     }\n \n+    private void checkConcurrentJobsPerDatastoreThreshhold(final StoragePool destPool) {\n+        final Long threshold = VolumeApiService.ConcurrentMigrationsThresholdPerDatastore.value();\n+        if (threshold != null && threshold > 0) {\n+            long count = _jobMgr.countPendingJobs(\"\\\"storageid\\\":\\\"\" + destPool.getUuid() + \"\\\"\", MigrateVMCmd.class.getName(), MigrateVolumeCmd.class.getName(), MigrateVolumeCmdByAdmin.class.getName());\n+            if (count > threshold) {\n+                throw new CloudRuntimeException(\"Number of concurrent migration jobs per datastore exceeded the threshold: \" + threshold.toString() + \". Please try again after some time.\");\n+            }\n+        }\n+    }\n+\n+\n     @Override\n     @DB\n     public Volume migrateVolume(Volume volume, StoragePool destPool) throws StorageUnavailableException {\n         VolumeInfo vol = volFactory.getVolume(volume.getId());\n+        if (vol == null){\n+            throw new CloudRuntimeException(\"Migrate volume failed because volume object of volume \" + volume.getName()+ \"is null\");\n+        }\n+        if (destPool == null) {\n+            throw new CloudRuntimeException(\"Migrate volume failed because destination storage pool is not available!!\");\n+        }\n+\n+        checkConcurrentJobsPerDatastoreThreshhold(destPool);\n \n         DataStore dataStoreTarget = dataStoreMgr.getDataStore(destPool.getId(), DataStoreRole.Primary);\n         AsyncCallFuture<VolumeApiResult> future = volService.copyVolume(vol, dataStoreTarget);\n@@ -1062,6 +1085,10 @@ public boolean storageMigration(VirtualMachineProfile vm, StoragePool destPool)\n             return true;\n         }\n \n+        // OfflineVmwareMigration: in case we can (vmware?) don't itterate over volumes but tell the hypervisor to do the thing\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(\"Offline vm migration was not done up the stack in VirtualMachineManager so trying here.\");\n+        }\n         for (Volume vol : volumesNeedToMigrate) {\n             Volume result = migrateVolume(vol, destPool);\n             if (result == null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "sha": "6e71864c4473741d0ff7842e7133a348fd76cb29",
                "status": "modified"
            },
            {
                "additions": 44,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/orchestration/src/test/java/com/cloud/vm/VirtualMachineManagerImplTest.java",
                "changes": 52,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/test/java/com/cloud/vm/VirtualMachineManagerImplTest.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 8,
                "filename": "engine/orchestration/src/test/java/com/cloud/vm/VirtualMachineManagerImplTest.java",
                "patch": "@@ -17,6 +17,7 @@\n \n package com.cloud.vm;\n \n+import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertTrue;\n import static org.mockito.Matchers.any;\n import static org.mockito.Matchers.anyLong;\n@@ -25,6 +26,7 @@\n import static org.mockito.Mockito.when;\n \n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n@@ -178,7 +180,7 @@ public void testSendStopWithFailAnswer() throws Exception {\n \n         boolean actual = virtualMachineManagerImpl.sendStop(guru, profile, false, false);\n \n-        Assert.assertFalse(actual);\n+        assertFalse(actual);\n     }\n \n     @Test\n@@ -192,7 +194,7 @@ public void testSendStopWithNullAnswer() throws Exception {\n \n         boolean actual = virtualMachineManagerImpl.sendStop(guru, profile, false, false);\n \n-        Assert.assertFalse(actual);\n+        assertFalse(actual);\n     }\n \n     @Test\n@@ -242,7 +244,7 @@ public void isStorageCrossClusterMigrationTestStorageSameCluster() {\n \n         boolean returnedValue = virtualMachineManagerImpl.isStorageCrossClusterMigration(hostMock, storagePoolVoMock);\n \n-        Assert.assertFalse(returnedValue);\n+        assertFalse(returnedValue);\n     }\n \n     @Test\n@@ -253,7 +255,7 @@ public void isStorageCrossClusterMigrationTestStorageTypeEqualsZone() {\n \n         boolean returnedValue = virtualMachineManagerImpl.isStorageCrossClusterMigration(hostMock, storagePoolVoMock);\n \n-        Assert.assertFalse(returnedValue);\n+        assertFalse(returnedValue);\n     }\n \n     @Test\n@@ -317,7 +319,7 @@ public void buildMapUsingUserInformationTestTargetHostHasAccessToPool() {\n \n         Map<Volume, StoragePool> volumeToPoolObjectMap = virtualMachineManagerImpl.buildMapUsingUserInformation(virtualMachineProfileMock, hostMock, userDefinedVolumeToStoragePoolMap);\n \n-        Assert.assertFalse(volumeToPoolObjectMap.isEmpty());\n+        assertFalse(volumeToPoolObjectMap.isEmpty());\n         Assert.assertEquals(storagePoolVoMock, volumeToPoolObjectMap.get(volumeVoMock));\n \n         Mockito.verify(userDefinedVolumeToStoragePoolMap, times(1)).keySet();\n@@ -501,7 +503,7 @@ public void createVolumeToStoragePoolMappingIfPossibleTestTargetHostDoesNotAcces\n         HashMap<Volume, StoragePool> volumeToPoolObjectMap = new HashMap<>();\n         virtualMachineManagerImpl.createVolumeToStoragePoolMappingIfPossible(virtualMachineProfileMock, hostMock, volumeToPoolObjectMap, volumeVoMock, storagePoolVoMock);\n \n-        Assert.assertFalse(volumeToPoolObjectMap.isEmpty());\n+        assertFalse(volumeToPoolObjectMap.isEmpty());\n         Assert.assertEquals(storagePoolMockOther, volumeToPoolObjectMap.get(volumeVoMock));\n     }\n \n@@ -558,7 +560,7 @@ public void createStoragePoolMappingsForVolumesTestNotCrossCluterMigrationWithCl\n \n         virtualMachineManagerImpl.createStoragePoolMappingsForVolumes(virtualMachineProfileMock, hostMock, volumeToPoolObjectMap, allVolumes);\n \n-        Assert.assertFalse(volumeToPoolObjectMap.isEmpty());\n+        assertFalse(volumeToPoolObjectMap.isEmpty());\n         Assert.assertEquals(storagePoolVoMock, volumeToPoolObjectMap.get(volumeVoMock));\n \n         Mockito.verify(virtualMachineManagerImpl).executeManagedStorageChecksWhenTargetStoragePoolNotProvided(hostMock, storagePoolVoMock, volumeVoMock);\n@@ -587,4 +589,38 @@ public void createMappingVolumeAndStoragePoolTest() {\n         inOrder.verify(virtualMachineManagerImpl).findVolumesThatWereNotMappedByTheUser(virtualMachineProfileMock, volumeToPoolObjectMap);\n         inOrder.verify(virtualMachineManagerImpl).createStoragePoolMappingsForVolumes(virtualMachineProfileMock, hostMock, volumeToPoolObjectMap, volumesNotMapped);\n     }\n-}\n\\ No newline at end of file\n+\n+    @Test\n+    public void matchesOfSorts() {\n+        List<String> nothing = null;\n+        List<String> empty = new ArrayList<>();\n+        List<String> tag = Arrays.asList(\"bla\");\n+        List<String> tags = Arrays.asList(\"bla\", \"blob\");\n+        List<String> others = Arrays.asList(\"bla\", \"blieb\");\n+        List<String> three = Arrays.asList(\"bla\", \"blob\", \"blieb\");\n+\n+        // single match\n+        assertTrue(VirtualMachineManagerImpl.matches(tag,tags));\n+        assertTrue(VirtualMachineManagerImpl.matches(tag,others));\n+\n+        // no requirements\n+        assertTrue(VirtualMachineManagerImpl.matches(nothing,tags));\n+        assertTrue(VirtualMachineManagerImpl.matches(empty,tag));\n+\n+        // mis(sing)match\n+        assertFalse(VirtualMachineManagerImpl.matches(tags,tag));\n+        assertFalse(VirtualMachineManagerImpl.matches(tag,nothing));\n+        assertFalse(VirtualMachineManagerImpl.matches(tag,empty));\n+\n+        // disjunct sets\n+        assertFalse(VirtualMachineManagerImpl.matches(tags,others));\n+        assertFalse(VirtualMachineManagerImpl.matches(others,tags));\n+\n+        // everything matches the larger set\n+        assertTrue(VirtualMachineManagerImpl.matches(nothing,three));\n+        assertTrue(VirtualMachineManagerImpl.matches(empty,three));\n+        assertTrue(VirtualMachineManagerImpl.matches(tag,three));\n+        assertTrue(VirtualMachineManagerImpl.matches(tags,three));\n+        assertTrue(VirtualMachineManagerImpl.matches(others,three));\n+    }\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/orchestration/src/test/java/com/cloud/vm/VirtualMachineManagerImplTest.java",
                "sha": "0e7579ea5fd3782c101e59841b92df8987dddde4",
                "status": "modified"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/DataMotionServiceImpl.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/DataMotionServiceImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 2,
                "filename": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/DataMotionServiceImpl.java",
                "patch": "@@ -18,12 +18,17 @@\n  */\n package org.apache.cloudstack.storage.motion;\n \n+import java.util.Date;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n \n import javax.inject.Inject;\n \n+import com.cloud.storage.Volume;\n+import com.cloud.storage.VolumeVO;\n+import com.cloud.storage.dao.VolumeDao;\n+import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n import org.apache.cloudstack.engine.subsystem.api.storage.CopyCommandResult;\n@@ -40,10 +45,15 @@\n import com.cloud.utils.StringUtils;\n import com.cloud.utils.exception.CloudRuntimeException;\n \n+\n @Component\n public class DataMotionServiceImpl implements DataMotionService {\n+    private static final Logger LOGGER = Logger.getLogger(DataMotionServiceImpl.class);\n+\n     @Inject\n     StorageStrategyFactory storageStrategyFactory;\n+    @Inject\n+    VolumeDao volDao;\n \n     @Override\n     public void copyAsync(DataObject srcData, DataObject destData, Host destHost, AsyncCompletionCallback<CopyCommandResult> callback) {\n@@ -61,13 +71,33 @@ public void copyAsync(DataObject srcData, DataObject destData, Host destHost, As\n \n         DataMotionStrategy strategy = storageStrategyFactory.getDataMotionStrategy(srcData, destData);\n         if (strategy == null) {\n+            // OfflineVmware volume migration\n+            // Cleanup volumes from target and reset the state of volume at source\n+            cleanUpVolumesForFailedMigrations(srcData, destData);\n             throw new CloudRuntimeException(\"Can't find strategy to move data. \" + \"Source: \" + srcData.getType().name() + \" '\" + srcData.getUuid() + \", Destination: \" +\n-                destData.getType().name() + \" '\" + destData.getUuid() + \"'\");\n+                    destData.getType().name() + \" '\" + destData.getUuid() + \"'\");\n         }\n \n         strategy.copyAsync(srcData, destData, destHost, callback);\n     }\n \n+    /**\n+     * Offline Vmware volume migration\n+     * Cleanup volumes after failed migrations and reset state of source volume\n+     *\n+     * @param srcData\n+     * @param destData\n+     */\n+    private void cleanUpVolumesForFailedMigrations(DataObject srcData, DataObject destData) {\n+        VolumeVO destinationVO = volDao.findById(destData.getId());\n+        VolumeVO sourceVO = volDao.findById(srcData.getId());\n+        sourceVO.setState(Volume.State.Ready);\n+        volDao.update(sourceVO.getId(), sourceVO);\n+        destinationVO.setState(Volume.State.Expunged);\n+        destinationVO.setRemoved(new Date());\n+        volDao.update(destinationVO.getId(), destinationVO);\n+    }\n+\n     @Override\n     public void copyAsync(DataObject srcData, DataObject destData, AsyncCompletionCallback<CopyCommandResult> callback) {\n         copyAsync(srcData, destData, null, callback);\n@@ -84,7 +114,7 @@ public void copyAsync(Map<VolumeInfo, DataStore> volumeMap, VirtualMachineTO vmT\n             }\n \n             throw new CloudRuntimeException(\"Can't find strategy to move data. \" + \"Source Host: \" + srcHost.getName() + \", Destination Host: \" + destHost.getName() +\n-                \", Volume UUIDs: \" + StringUtils.join(volumeIds, \",\"));\n+                    \", Volume UUIDs: \" + StringUtils.join(volumeIds, \",\"));\n         }\n \n         strategy.copyAsync(volumeMap, vmTo, srcHost, destHost, callback);",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/DataMotionServiceImpl.java",
                "sha": "c2724e648241283368a698707b07a993d9b85065",
                "status": "modified"
            },
            {
                "additions": 36,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/storage/volume/src/main/java/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "changes": 56,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/main/java/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 20,
                "filename": "engine/storage/volume/src/main/java/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "patch": "@@ -1408,6 +1408,19 @@ protected Void copyVolumeFromPrimaryToImageCallback(AsyncCallbackDispatcher<Volu\n \n     @Override\n     public AsyncCallFuture<VolumeApiResult> copyVolume(VolumeInfo srcVolume, DataStore destStore) {\n+        if (s_logger.isDebugEnabled()) {\n+            DataStore srcStore = srcVolume.getDataStore();\n+            String srcRole = (srcStore != null && srcStore.getRole() != null ? srcVolume.getDataStore().getRole().toString() : \"<unknown role>\");\n+\n+            String msg = String.format(\"copying %s(id=%d, role=%s) to %s (id=%d, role=%s)\"\n+                    , srcVolume.getName()\n+                    , srcVolume.getId()\n+                    , srcRole\n+                    , destStore.getName()\n+                    , destStore.getId()\n+                    , destStore.getRole());\n+            s_logger.debug(msg);\n+        }\n \n         if (srcVolume.getState() == Volume.State.Uploaded) {\n             return copyVolumeFromImageToPrimary(srcVolume, destStore);\n@@ -1417,6 +1430,8 @@ protected Void copyVolumeFromPrimaryToImageCallback(AsyncCallbackDispatcher<Volu\n             return copyVolumeFromPrimaryToImage(srcVolume, destStore);\n         }\n \n+        // OfflineVmwareMigration: aren't we missing secondary to secondary in this logic?\n+\n         AsyncCallFuture<VolumeApiResult> future = new AsyncCallFuture<VolumeApiResult>();\n         VolumeApiResult res = new VolumeApiResult(srcVolume);\n         try {\n@@ -1438,7 +1453,10 @@ protected Void copyVolumeFromPrimaryToImageCallback(AsyncCallbackDispatcher<Volu\n             caller.setCallback(caller.getTarget().copyVolumeCallBack(null, null)).setContext(context);\n             motionSrv.copyAsync(srcVolume, destVolume, caller);\n         } catch (Exception e) {\n-            s_logger.debug(\"Failed to copy volume\" + e);\n+            s_logger.error(\"Failed to copy volume:\" + e);\n+            if(s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"Failed to copy volume.\", e);\n+            }\n             res.setResult(e.toString());\n             future.complete(res);\n         }\n@@ -1461,27 +1479,25 @@ protected Void copyVolumeCallBack(AsyncCallbackDispatcher<VolumeServiceImpl, Cop\n                 AsyncCallFuture<VolumeApiResult> destroyFuture = expungeVolumeAsync(destVolume);\n                 destroyFuture.get();\n                 future.complete(res);\n-                return null;\n-            }\n-            srcVolume.processEvent(Event.OperationSuccessed);\n-            destVolume.processEvent(Event.MigrationCopySucceeded, result.getAnswer());\n-            volDao.updateUuid(srcVolume.getId(), destVolume.getId());\n-            _volumeStoreDao.updateVolumeId(srcVolume.getId(), destVolume.getId());\n-            try {\n-                destroyVolume(srcVolume.getId());\n-                srcVolume = volFactory.getVolume(srcVolume.getId());\n-                AsyncCallFuture<VolumeApiResult> destroyFuture = expungeVolumeAsync(srcVolume);\n-                // If volume destroy fails, this could be because of vdi is still in use state, so wait and retry.\n-                if (destroyFuture.get().isFailed()) {\n-                    Thread.sleep(5 * 1000);\n-                    destroyFuture = expungeVolumeAsync(srcVolume);\n-                    destroyFuture.get();\n+            } else {\n+                srcVolume.processEvent(Event.OperationSuccessed);\n+                destVolume.processEvent(Event.MigrationCopySucceeded, result.getAnswer());\n+                volDao.updateUuid(srcVolume.getId(), destVolume.getId());\n+                try {\n+                    destroyVolume(srcVolume.getId());\n+                    srcVolume = volFactory.getVolume(srcVolume.getId());\n+                    AsyncCallFuture<VolumeApiResult> destroyFuture = expungeVolumeAsync(srcVolume);\n+                    // If volume destroy fails, this could be because of vdi is still in use state, so wait and retry.\n+                    if (destroyFuture.get().isFailed()) {\n+                        Thread.sleep(5 * 1000);\n+                        destroyFuture = expungeVolumeAsync(srcVolume);\n+                        destroyFuture.get();\n+                    }\n+                    future.complete(res);\n+                } catch (Exception e) {\n+                    s_logger.debug(\"failed to clean up volume on storage\", e);\n                 }\n-                future.complete(res);\n-            } catch (Exception e) {\n-                s_logger.debug(\"failed to clean up volume on storage\", e);\n             }\n-            return null;\n         } catch (Exception e) {\n             s_logger.debug(\"Failed to process copy volume callback\", e);\n             res.setResult(e.toString());",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/engine/storage/volume/src/main/java/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "sha": "8ff0bd20815b233e26f4ad74ec3c3f57a0030f9f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/AsyncJobManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/AsyncJobManager.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/AsyncJobManager.java",
                "patch": "@@ -131,4 +131,6 @@ void joinJob(long jobId, long joinJobId, String wakeupHandler, String wakupDispa\n     Object unmarshallResultObject(AsyncJob job);\n \n     List<AsyncJobVO> findFailureAsyncJobs(String... cmds);\n+\n+    long countPendingJobs(String havingInfo, String... cmds);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/AsyncJobManager.java",
                "sha": "8542407524b1184e0f8c16a85df83a8eaa35aa5f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDao.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDao.java",
                "patch": "@@ -44,4 +44,6 @@\n     List<AsyncJobVO> getResetJobs(long msid);\n \n     List<AsyncJobVO> getFailureJobsSinceLastMsStart(long msId, String... cmds);\n+\n+    long countPendingJobs(String havingInfo, String... cmds);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDao.java",
                "sha": "2696e105cce440933e48ed6fbe2bc927abc4f1c8",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDaoImpl.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDaoImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDaoImpl.java",
                "patch": "@@ -30,6 +30,7 @@\n import com.cloud.utils.db.DB;\n import com.cloud.utils.db.Filter;\n import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.GenericSearchBuilder;\n import com.cloud.utils.db.SearchBuilder;\n import com.cloud.utils.db.SearchCriteria;\n import com.cloud.utils.db.SearchCriteria.Op;\n@@ -46,6 +47,7 @@\n     private final SearchBuilder<AsyncJobVO> expiringUnfinishedAsyncJobSearch;\n     private final SearchBuilder<AsyncJobVO> expiringCompletedAsyncJobSearch;\n     private final SearchBuilder<AsyncJobVO> failureMsidAsyncJobSearch;\n+    private final GenericSearchBuilder<AsyncJobVO, Long> asyncJobTypeSearch;\n \n     public AsyncJobDaoImpl() {\n         pendingAsyncJobSearch = createSearchBuilder();\n@@ -94,6 +96,13 @@ public AsyncJobDaoImpl() {\n         failureMsidAsyncJobSearch.and(\"job_cmd\", failureMsidAsyncJobSearch.entity().getCmd(), Op.IN);\n         failureMsidAsyncJobSearch.done();\n \n+        asyncJobTypeSearch = createSearchBuilder(Long.class);\n+        asyncJobTypeSearch.select(null, SearchCriteria.Func.COUNT, asyncJobTypeSearch.entity().getId());\n+        asyncJobTypeSearch.and(\"job_info\", asyncJobTypeSearch.entity().getCmdInfo(),Op.LIKE);\n+        asyncJobTypeSearch.and(\"job_cmd\", asyncJobTypeSearch.entity().getCmd(), Op.IN);\n+        asyncJobTypeSearch.and(\"status\", asyncJobTypeSearch.entity().getStatus(), SearchCriteria.Op.EQ);\n+        asyncJobTypeSearch.done();\n+\n     }\n \n     @Override\n@@ -227,4 +236,14 @@ public void resetJobProcess(long msid, int jobResultCode, String jobResultMessag\n         sc.setParameters(\"job_cmd\", (Object[])cmds);\n         return listBy(sc);\n     }\n+\n+    @Override\n+    public long countPendingJobs(String havingInfo, String... cmds) {\n+        SearchCriteria<Long> sc = asyncJobTypeSearch.create();\n+        sc.setParameters(\"status\", JobInfo.Status.IN_PROGRESS);\n+        sc.setParameters(\"job_cmd\", (Object[])cmds);\n+        sc.setParameters(\"job_info\", \"%\" + havingInfo + \"%\");\n+        List<Long> results = customSearch(sc, null);\n+        return results.get(0);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/dao/AsyncJobDaoImpl.java",
                "sha": "6ca698b7589a953bd392c7717cc197cc61a1e791",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java",
                "patch": "@@ -1122,4 +1122,9 @@ private void publishOnEventBus(AsyncJob job, String jobEvent) {\n     public List<AsyncJobVO> findFailureAsyncJobs(String... cmds) {\n         return _jobDao.getFailureJobsSinceLastMsStart(getMsid(), cmds);\n     }\n+\n+    @Override\n+    public long countPendingJobs(String havingInfo, String... cmds) {\n+        return _jobDao.countPendingJobs(havingInfo, cmds);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/framework/jobs/src/main/java/org/apache/cloudstack/framework/jobs/impl/AsyncJobManagerImpl.java",
                "sha": "1be3eedaf23d9101f8a2bf166c9d84d46d3f8cb6",
                "status": "modified"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/guru/VMwareGuru.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/guru/VMwareGuru.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/guru/VMwareGuru.java",
                "patch": "@@ -26,6 +26,11 @@\n \n import javax.inject.Inject;\n \n+import com.cloud.agent.api.MigrateVmToPoolCommand;\n+import com.cloud.agent.api.UnregisterVMCommand;\n+import com.cloud.agent.api.to.VolumeTO;\n+import com.cloud.dc.ClusterDetailsDao;\n+import com.cloud.storage.StoragePool;\n import org.apache.cloudstack.engine.subsystem.api.storage.PrimaryDataStore;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n@@ -115,12 +120,14 @@\n     @Inject\n     private GuestOSDao _guestOsDao;\n     @Inject\n-    GuestOSHypervisorDao _guestOsHypervisorDao;\n+    private GuestOSHypervisorDao _guestOsHypervisorDao;\n     @Inject\n     private HostDao _hostDao;\n     @Inject\n     private HostDetailsDao _hostDetailsDao;\n     @Inject\n+    private ClusterDetailsDao _clusterDetailsDao;\n+    @Inject\n     private CommandExecLogDao _cmdExecLogDao;\n     @Inject\n     private VmwareManager _vmwareMgr;\n@@ -640,4 +647,35 @@ public String getConfigComponentName() {\n         details.put(VmwareReserveMemory.key(), VmwareReserveMemory.valueIn(clusterId).toString());\n         return details;\n     }\n+\n+    @Override\n+    public List<Command> finalizeMigrate(VirtualMachine vm, StoragePool destination) {\n+        List<Command> commands = new ArrayList<Command>();\n+\n+        // OfflineVmwareMigration: specialised migration command\n+        List<VolumeVO> volumes = _volumeDao.findByInstance(vm.getId());\n+        List<VolumeTO> vols = new ArrayList<>();\n+        for (Volume volume : volumes) {\n+            VolumeTO vol = new VolumeTO(volume,destination);\n+            vols.add(vol);\n+        }\n+        MigrateVmToPoolCommand migrateVmToPoolCommand = new MigrateVmToPoolCommand(vm.getInstanceName(), vols, destination.getUuid(), true);\n+        commands.add(migrateVmToPoolCommand);\n+\n+        // OfflineVmwareMigration: cleanup if needed\n+        final Long destClusterId = destination.getClusterId();\n+        final Long srcClusterId = getClusterId(vm.getId());\n+\n+        if (srcClusterId != null && destClusterId != null && ! srcClusterId.equals(destClusterId)) {\n+            final String srcDcName = _clusterDetailsDao.getVmwareDcName(srcClusterId);\n+            final String destDcName = _clusterDetailsDao.getVmwareDcName(destClusterId);\n+            if (srcDcName != null && destDcName != null && !srcDcName.equals(destDcName)) {\n+                final UnregisterVMCommand unregisterVMCommand = new UnregisterVMCommand(vm.getInstanceName(), true);\n+                unregisterVMCommand.setCleanupVmFiles(true);\n+\n+                commands.add(unregisterVMCommand);\n+            }\n+        }\n+        return commands;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/guru/VMwareGuru.java",
                "sha": "10c3feb2609eea89da41442b1d87e5da793b6c92",
                "status": "modified"
            },
            {
                "additions": 327,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "changes": 340,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 13,
                "filename": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "patch": "@@ -43,8 +43,8 @@\n \n import javax.naming.ConfigurationException;\n \n-import org.apache.commons.lang.StringUtils;\n import org.apache.commons.lang.math.NumberUtils;\n+import org.apache.commons.lang.StringUtils;\n import org.apache.log4j.Logger;\n import org.apache.log4j.NDC;\n import org.joda.time.Duration;\n@@ -163,6 +163,8 @@\n import com.cloud.agent.api.ManageSnapshotCommand;\n import com.cloud.agent.api.MigrateAnswer;\n import com.cloud.agent.api.MigrateCommand;\n+import com.cloud.agent.api.MigrateVmToPoolAnswer;\n+import com.cloud.agent.api.MigrateVmToPoolCommand;\n import com.cloud.agent.api.MigrateWithStorageAnswer;\n import com.cloud.agent.api.MigrateWithStorageCommand;\n import com.cloud.agent.api.ModifySshKeysCommand;\n@@ -311,6 +313,7 @@\n \n public class VmwareResource implements StoragePoolResource, ServerResource, VmwareHostService, VirtualRouterDeployer {\n     private static final Logger s_logger = Logger.getLogger(VmwareResource.class);\n+    public static final String VMDK_EXTENSION = \".vmdk\";\n \n     private static final Random RANDOM = new Random(System.nanoTime());\n \n@@ -442,6 +445,8 @@ public Answer executeRequest(Command cmd) {\n                 answer = execute((PrepareForMigrationCommand)cmd);\n             } else if (clz == MigrateCommand.class) {\n                 answer = execute((MigrateCommand)cmd);\n+            } else if (clz == MigrateVmToPoolCommand.class) {\n+                answer = execute((MigrateVmToPoolCommand)cmd);\n             } else if (clz == MigrateWithStorageCommand.class) {\n                 answer = execute((MigrateWithStorageCommand)cmd);\n             } else if (clz == MigrateVolumeCommand.class) {\n@@ -699,30 +704,38 @@ private Answer execute(ResizeVolumeCommand cmd) {\n             }\n \n             if (vmName.equalsIgnoreCase(\"none\")) {\n+                // OfflineVmwareMigration: we need to refactor the worker vm creation out for use in migration methods as well as here\n+                // OfflineVmwareMigration: this method is 100 lines and needs refactorring anyway\n                 // we need to spawn a worker VM to attach the volume to and resize the volume.\n                 useWorkerVm = true;\n                 vmName = getWorkerName(getServiceContext(), cmd, 0);\n \n                 String poolId = cmd.getPoolUuid();\n \n+                // OfflineVmwareMigration: refactor for re-use\n+                // OfflineVmwareMigration: 1. find data(store)\n                 ManagedObjectReference morDS = HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost, poolId);\n                 DatastoreMO dsMo = new DatastoreMO(hyperHost.getContext(), morDS);\n \n                 s_logger.info(\"Create worker VM \" + vmName);\n \n+                // OfflineVmwareMigration: 2. create the worker with access to the data(store)\n                 vmMo = HypervisorHostHelper.createWorkerVM(hyperHost, dsMo, vmName);\n \n                 if (vmMo == null) {\n+                    // OfflineVmwareMigration: don't throw a general Exception but think of a specific one\n                     throw new Exception(\"Unable to create a worker VM for volume resize\");\n                 }\n \n                 synchronized (this) {\n-                    vmdkDataStorePath = VmwareStorageLayoutHelper.getLegacyDatastorePathFromVmdkFileName(dsMo, path + \".vmdk\");\n+                    // OfflineVmwareMigration: 3. attach the disk to the worker\n+                    vmdkDataStorePath = VmwareStorageLayoutHelper.getLegacyDatastorePathFromVmdkFileName(dsMo, path + VMDK_EXTENSION);\n \n                     vmMo.attachDisk(new String[] { vmdkDataStorePath }, morDS);\n                 }\n             }\n \n+            // OfflineVmwareMigration: 4. find the (worker-) VM\n             // find VM through datacenter (VM is not at the target host yet)\n             vmMo = hyperHost.findVmOnPeerHyperHost(vmName);\n \n@@ -734,6 +747,7 @@ private Answer execute(ResizeVolumeCommand cmd) {\n                 throw new Exception(msg);\n             }\n \n+            // OfflineVmwareMigration: 5. ignore/replace the rest of the try-block; It is the functional bit\n             Pair<VirtualDisk, String> vdisk = vmMo.getDiskDevice(path);\n \n             if (vdisk == null) {\n@@ -813,6 +827,7 @@ private Answer execute(ResizeVolumeCommand cmd) {\n \n             return new ResizeVolumeAnswer(cmd, false, error);\n         } finally {\n+            // OfflineVmwareMigration: 6. check if a worker was used and destroy it if needed\n             try {\n                 if (useWorkerVm) {\n                     s_logger.info(\"Destroy worker VM after volume resize\");\n@@ -2313,7 +2328,7 @@ private String appendFileType(String path, String fileType) {\n     }\n \n     private void resizeRootDiskOnVMStart(VirtualMachineMO vmMo, DiskTO rootDiskTO, VmwareHypervisorHost hyperHost, VmwareContext context) throws Exception {\n-        final Pair<VirtualDisk, String> vdisk = getVirtualDiskInfo(vmMo, appendFileType(rootDiskTO.getPath(), \".vmdk\"));\n+        final Pair<VirtualDisk, String> vdisk = getVirtualDiskInfo(vmMo, appendFileType(rootDiskTO.getPath(), VMDK_EXTENSION));\n         assert(vdisk != null);\n \n         Long reqSize = 0L;\n@@ -2536,7 +2551,7 @@ int getReservedCpuMHZ(VirtualMachineTO vmSpec) {\n                     vmdkPath = dsMo.getName();\n                 }\n \n-                datastoreDiskPath = dsMo.getDatastorePath(vmdkPath + \".vmdk\");\n+                datastoreDiskPath = dsMo.getDatastorePath(vmdkPath + VMDK_EXTENSION);\n             }\n         } else {\n             datastoreDiskPath = VmwareStorageLayoutHelper.syncVolumeToVmDefaultFolder(dcMo, vmMo.getName(), dsMo, volumeTO.getPath(), VmwareManager.s_vmwareSearchExcludeFolder.value());\n@@ -3061,7 +3076,7 @@ public int compare(DiskTO arg0, DiskTO arg1) {\n      * Ex. \"[-iqn.2010-01.com.solidfire:4nhe.vol-1.27-0] i-2-18-VM/ROOT-18.vmdk\" should return \"i-2-18-VM/ROOT-18\"\n      */\n     public String getVmdkPath(String path) {\n-        if (!com.cloud.utils.StringUtils.isNotBlank(path)) {\n+        if (!StringUtils.isNotBlank(path)) {\n             return null;\n         }\n \n@@ -3075,7 +3090,7 @@ public String getVmdkPath(String path) {\n \n         path = path.substring(startIndex + search.length());\n \n-        final String search2 = \".vmdk\";\n+        final String search2 = VMDK_EXTENSION;\n \n         int endIndex = path.indexOf(search2);\n \n@@ -3128,10 +3143,10 @@ public String getVmdkPath(String path) {\n                             final String datastoreVolumePath;\n \n                             if (vmdkPath != null) {\n-                                datastoreVolumePath = dsMo.getDatastorePath(vmdkPath + \".vmdk\");\n+                                datastoreVolumePath = dsMo.getDatastorePath(vmdkPath + VMDK_EXTENSION);\n                             }\n                             else {\n-                                datastoreVolumePath = dsMo.getDatastorePath(dsMo.getName() + \".vmdk\");\n+                                datastoreVolumePath = dsMo.getDatastorePath(dsMo.getName() + VMDK_EXTENSION);\n                             }\n \n                             volumeTO.setPath(datastoreVolumePath);\n@@ -3780,12 +3795,172 @@ protected Answer execute(PrepareForMigrationCommand cmd) {\n                 invalidateServiceContext();\n             }\n \n-            String msg = \"Unexcpeted exception \" + VmwareHelper.getExceptionMessage(e);\n+            String msg = \"Unexpected exception \" + VmwareHelper.getExceptionMessage(e);\n             s_logger.error(msg, e);\n             return new PrepareForMigrationAnswer(cmd, msg);\n         }\n     }\n \n+    protected Answer execute(MigrateVmToPoolCommand cmd) {\n+        if (s_logger.isInfoEnabled()) {\n+            s_logger.info(String.format(\"excuting MigrateVmToPoolCommand %s -> %s\", cmd.getVmName(), cmd.getDestinationPool()));\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"MigrateVmToPoolCommand: \" + _gson.toJson(cmd));\n+            }\n+        }\n+\n+        final String vmName = cmd.getVmName();\n+\n+        VmwareHypervisorHost hyperHost = getHyperHost(getServiceContext());\n+        try {\n+            VirtualMachineMO vmMo = getVirtualMachineMO(vmName, hyperHost);\n+            if (vmMo == null) {\n+                String msg = \"VM \" + vmName + \" does not exist in VMware datacenter\";\n+                s_logger.error(msg);\n+                throw new CloudRuntimeException(msg);\n+            }\n+\n+            String poolUuid = cmd.getDestinationPool();\n+            return migrateAndAnswer(vmMo, poolUuid, hyperHost, cmd);\n+        } catch (Throwable e) { // hopefully only CloudRuntimeException :/\n+            if (e instanceof Exception) {\n+                return new Answer(cmd, (Exception) e);\n+            }\n+            if (s_logger.isDebugEnabled()) {\n+                s_logger.debug(\"problem\" , e);\n+            }\n+            s_logger.error(e.getLocalizedMessage());\n+            return new Answer(cmd, false, \"unknown problem: \" + e.getLocalizedMessage());\n+        }\n+    }\n+\n+    private Answer migrateAndAnswer(VirtualMachineMO vmMo, String poolUuid, VmwareHypervisorHost hyperHost, Command cmd) throws Exception {\n+        ManagedObjectReference morDs = getTargetDatastoreMOReference(poolUuid, hyperHost);\n+\n+        try {\n+            // OfflineVmwareMigration: getVolumesFromCommand(cmd);\n+            Map<Integer, Long> volumeDeviceKey = getVolumesFromCommand(vmMo, cmd);\n+            if (s_logger.isTraceEnabled()) {\n+                for (Integer diskId: volumeDeviceKey.keySet()) {\n+                    s_logger.trace(String.format(\"disk to migrate has disk id %d and volumeId %d\", diskId, volumeDeviceKey.get(diskId)));\n+                }\n+            }\n+            if (vmMo.changeDatastore(morDs)) {\n+                // OfflineVmwareMigration: create target specification to include in answer\n+                // Consolidate VM disks after successful VM migration\n+                // In case of a linked clone VM, if VM's disks are not consolidated, further VM operations such as volume snapshot, VM snapshot etc. will result in DB inconsistencies.\n+                if (!vmMo.consolidateVmDisks()) {\n+                    s_logger.warn(\"VM disk consolidation failed after storage migration. Yet proceeding with VM migration.\");\n+                } else {\n+                    s_logger.debug(\"Successfully consolidated disks of VM \" + vmMo.getVmName() + \".\");\n+                }\n+                return createAnswerForCmd(vmMo, poolUuid, cmd, volumeDeviceKey);\n+            } else {\n+                return new Answer(cmd, false, \"failed to changes data store for VM\" + vmMo.getVmName());\n+            }\n+        } catch (Exception e) {\n+            String msg = \"change data store for VM \" + vmMo.getVmName() + \" failed\";\n+            s_logger.error(msg + \": \" + e.getLocalizedMessage());\n+            throw new CloudRuntimeException(msg,e);\n+        }\n+    }\n+\n+    Answer createAnswerForCmd(VirtualMachineMO vmMo, String poolUuid, Command cmd, Map<Integer, Long> volumeDeviceKey) throws Exception {\n+        List<VolumeObjectTO> volumeToList =  new ArrayList<>();\n+        VirtualMachineDiskInfoBuilder diskInfoBuilder = vmMo.getDiskInfoBuilder();\n+        VirtualDisk[] disks = vmMo.getAllDiskDevice();\n+        Answer answer;\n+        if (s_logger.isTraceEnabled()) {\n+            s_logger.trace(String.format(\"creating answer for %s\", cmd.getClass().getSimpleName()));\n+        }\n+        if (cmd instanceof MigrateVolumeCommand) {\n+            if (disks.length == 1) {\n+                String volumePath = vmMo.getVmdkFileBaseName(disks[0]);\n+                return new MigrateVolumeAnswer(cmd, true, null, volumePath);\n+            }\n+            throw new CloudRuntimeException(\"not expecting more then  one disk after migrate volume command\");\n+        } else if (cmd instanceof MigrateVmToPoolCommand) {\n+            for (VirtualDisk disk : disks) {\n+                VolumeObjectTO newVol = new VolumeObjectTO();\n+                String newPath = vmMo.getVmdkFileBaseName(disk);\n+                VirtualMachineDiskInfo diskInfo = diskInfoBuilder.getDiskInfoByBackingFileBaseName(newPath, poolUuid);\n+                newVol.setId(volumeDeviceKey.get(disk.getKey()));\n+                newVol.setPath(newPath);\n+                newVol.setChainInfo(_gson.toJson(diskInfo));\n+                volumeToList.add(newVol);\n+            }\n+            return new MigrateVmToPoolAnswer((MigrateVmToPoolCommand)cmd, volumeToList);\n+        }\n+        return new Answer(cmd, false, null);\n+    }\n+\n+    private Map<Integer, Long> getVolumesFromCommand(VirtualMachineMO vmMo, Command cmd) throws Exception {\n+        Map<Integer, Long> volumeDeviceKey = new HashMap<Integer, Long>();\n+        if (cmd instanceof MigrateVmToPoolCommand) {\n+            MigrateVmToPoolCommand mcmd = (MigrateVmToPoolCommand)cmd;\n+            for (VolumeTO volume : mcmd.getVolumes()) {\n+                addVolumeDiskmapping(vmMo, volumeDeviceKey, volume.getPath(), volume.getId());\n+            }\n+        } else if (cmd instanceof MigrateVolumeCommand) {\n+            MigrateVolumeCommand mcmd = (MigrateVolumeCommand)cmd;\n+            addVolumeDiskmapping(vmMo, volumeDeviceKey, mcmd.getVolumePath(), mcmd.getVolumeId());\n+        }\n+        return volumeDeviceKey;\n+    }\n+\n+    private void addVolumeDiskmapping(VirtualMachineMO vmMo, Map<Integer, Long> volumeDeviceKey, String volumePath, long volumeId) throws Exception {\n+        if (s_logger.isDebugEnabled()) {\n+            s_logger.debug(String.format(\"locating disk for volume (%d) using path %s\", volumeId, volumePath));\n+        }\n+        Pair<VirtualDisk, String> diskInfo = getVirtualDiskInfo(vmMo, volumePath + VMDK_EXTENSION);\n+        String vmdkAbsFile = getAbsoluteVmdkFile(diskInfo.first());\n+        if (vmdkAbsFile != null && !vmdkAbsFile.isEmpty()) {\n+            vmMo.updateAdapterTypeIfRequired(vmdkAbsFile);\n+        }\n+        int diskId = diskInfo.first().getKey();\n+        volumeDeviceKey.put(diskId, volumeId);\n+    }\n+\n+    private ManagedObjectReference getTargetDatastoreMOReference(String destinationPool, VmwareHypervisorHost hyperHost) {\n+        ManagedObjectReference morDs;\n+        try {\n+            if(s_logger.isDebugEnabled()) {\n+                s_logger.debug(String.format(\"finding datastore %s\", destinationPool));\n+            }\n+            morDs = HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost, destinationPool);\n+        } catch (Exception e) {\n+            String msg = \"exception while finding data store  \" + destinationPool;\n+            s_logger.error(msg);\n+            throw new CloudRuntimeException(msg + \": \" + e.getLocalizedMessage());\n+        }\n+        return morDs;\n+    }\n+\n+    private ManagedObjectReference getDataCenterMOReference(String vmName, VmwareHypervisorHost hyperHost) {\n+        ManagedObjectReference morDc;\n+        try {\n+            morDc = hyperHost.getHyperHostDatacenter();\n+        } catch (Exception e) {\n+            String msg = \"exception while finding VMware datacenter to search for VM \" + vmName;\n+            s_logger.error(msg);\n+            throw new CloudRuntimeException(msg + \": \" + e.getLocalizedMessage());\n+        }\n+        return morDc;\n+    }\n+\n+    private VirtualMachineMO getVirtualMachineMO(String vmName, VmwareHypervisorHost hyperHost) {\n+        VirtualMachineMO vmMo = null;\n+        try {\n+            // find VM through datacenter (VM is not at the target host yet)\n+            vmMo = hyperHost.findVmOnPeerHyperHost(vmName);\n+        } catch (Exception e) {\n+            String msg = \"exception while searching for VM \" + vmName + \" in VMware datacenter\";\n+            s_logger.error(msg);\n+            throw new CloudRuntimeException(msg + \": \" + e.getLocalizedMessage());\n+        }\n+        return vmMo;\n+    }\n+\n     protected Answer execute(MigrateCommand cmd) {\n         if (s_logger.isInfoEnabled()) {\n             s_logger.info(\"Executing resource MigrateCommand: \" + _gson.toJson(cmd));\n@@ -3946,7 +4121,7 @@ protected Answer execute(MigrateWithStorageCommand cmd) {\n                 }\n                 diskLocator = new VirtualMachineRelocateSpecDiskLocator();\n                 diskLocator.setDatastore(morDsAtSource);\n-                Pair<VirtualDisk, String> diskInfo = getVirtualDiskInfo(vmMo, appendFileType(volume.getPath(), \".vmdk\"));\n+                Pair<VirtualDisk, String> diskInfo = getVirtualDiskInfo(vmMo, appendFileType(volume.getPath(), VMDK_EXTENSION));\n                 String vmdkAbsFile = getAbsoluteVmdkFile(diskInfo.first());\n                 if (vmdkAbsFile != null && !vmdkAbsFile.isEmpty()) {\n                     vmMo.updateAdapterTypeIfRequired(vmdkAbsFile);\n@@ -4074,6 +4249,141 @@ protected Answer execute(MigrateWithStorageCommand cmd) {\n         }\n     }\n \n+    private Answer migrateVolume(MigrateVolumeCommand cmd) {\n+        Answer answer = null;\n+        String path = cmd.getVolumePath();\n+\n+        VmwareHypervisorHost hyperHost = getHyperHost(getServiceContext());\n+        VirtualMachineMO vmMo = null;\n+        DatastoreMO dsMo = null;\n+        ManagedObjectReference morSourceDS = null;\n+        String vmdkDataStorePath = null;\n+\n+        String vmName = null;\n+        try {\n+            // OfflineVmwareMigration: we need to refactor the worker vm creation out for use in migration methods as well as here\n+            // OfflineVmwareMigration: this method is 100 lines and needs refactorring anyway\n+            // we need to spawn a worker VM to attach the volume to and move it\n+            vmName = getWorkerName(getServiceContext(), cmd, 0);\n+\n+                // OfflineVmwareMigration: refactor for re-use\n+                // OfflineVmwareMigration: 1. find data(store)\n+            // OfflineVmwareMigration: more robust would be to find the store given the volume as it might have been moved out of band or due to error\n+// example:            DatastoreMO existingVmDsMo = new DatastoreMO(dcMo.getContext(), dcMo.findDatastore(fileInDatastore.getDatastoreName()));\n+\n+            morSourceDS = HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost, cmd.getSourcePool().getUuid());\n+            dsMo = new DatastoreMO(hyperHost.getContext(), morSourceDS);\n+            s_logger.info(\"Create worker VM \" + vmName);\n+                // OfflineVmwareMigration: 2. create the worker with access to the data(store)\n+            vmMo = HypervisorHostHelper.createWorkerVM(hyperHost, dsMo, vmName);\n+            if (vmMo == null) {\n+                // OfflineVmwareMigration: don't throw a general Exception but think of a specific one\n+                throw new CloudRuntimeException(\"Unable to create a worker VM for volume operation\");\n+            }\n+\n+            synchronized (this) {\n+                // OfflineVmwareMigration: 3. attach the disk to the worker\n+                String vmdkFileName = path + VMDK_EXTENSION;\n+                vmdkDataStorePath = VmwareStorageLayoutHelper.getLegacyDatastorePathFromVmdkFileName(dsMo, vmdkFileName);\n+                if (!dsMo.fileExists(vmdkDataStorePath)) {\n+                    if(s_logger.isDebugEnabled()) {\n+                        s_logger.debug(String.format(\"path not found (%s), trying under '%s'\", vmdkFileName, path));\n+                    }\n+                    vmdkDataStorePath = VmwareStorageLayoutHelper.getVmwareDatastorePathFromVmdkFileName(dsMo, path, vmdkFileName);\n+                }\n+                if (!dsMo.fileExists(vmdkDataStorePath)) {\n+                    if(s_logger.isDebugEnabled()) {\n+                        s_logger.debug(String.format(\"path not found (%s), trying under '%s'\", vmdkFileName, vmName));\n+                    }\n+                    vmdkDataStorePath = VmwareStorageLayoutHelper.getVmwareDatastorePathFromVmdkFileName(dsMo, vmName, vmdkFileName);\n+                }\n+                if(s_logger.isDebugEnabled()) {\n+                    s_logger.debug(String.format(\"attaching %s to %s for migration\", vmdkDataStorePath, vmMo.getVmName()));\n+                }\n+                vmMo.attachDisk(new String[] { vmdkDataStorePath }, morSourceDS);\n+            }\n+\n+            // OfflineVmwareMigration: 4. find the (worker-) VM\n+            // find VM through datacenter (VM is not at the target host yet)\n+            vmMo = hyperHost.findVmOnPeerHyperHost(vmName);\n+            if (vmMo == null) {\n+                String msg = \"VM \" + vmName + \" does not exist in VMware datacenter\";\n+                s_logger.error(msg);\n+                throw new Exception(msg);\n+            }\n+\n+            if (s_logger.isTraceEnabled()) {\n+                VirtualDisk[] disks = vmMo.getAllDiskDevice();\n+                String format = \"disk %d is attached as %s\";\n+                for (VirtualDisk disk : disks) {\n+                    s_logger.trace(String.format(format,disk.getKey(),vmMo.getVmdkFileBaseName(disk)));\n+                }\n+            }\n+\n+            // OfflineVmwareMigration: 5. create a relocate spec and perform\n+            Pair<VirtualDisk, String> vdisk = vmMo.getDiskDevice(path);\n+            if (vdisk == null) {\n+                if (s_logger.isTraceEnabled())\n+                    s_logger.trace(\"migrate volume done (failed)\");\n+                throw new CloudRuntimeException(\"No such disk device: \" + path);\n+            }\n+\n+            VirtualDisk disk = vdisk.first();\n+            String vmdkAbsFile = getAbsoluteVmdkFile(disk);\n+            if (vmdkAbsFile != null && !vmdkAbsFile.isEmpty()) {\n+                vmMo.updateAdapterTypeIfRequired(vmdkAbsFile);\n+            }\n+\n+            // OfflineVmwareMigration: this may have to be disected and executed in separate steps\n+            answer = migrateAndAnswer(vmMo, cmd.getTargetPool().getUuid(), hyperHost, cmd);\n+        } catch (Exception e) {\n+            String msg = String.format(\"Migration of volume '%s' failed due to %s\", cmd.getVolumePath(), e.getLocalizedMessage());\n+            s_logger.error(msg, e);\n+            answer = new Answer(cmd, false, msg);\n+        } finally {\n+            try {\n+                // OfflineVmwareMigration: worker *may* have been renamed\n+                vmName = vmMo.getVmName();\n+                morSourceDS = HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost, cmd.getTargetPool().getUuid());\n+                dsMo = new DatastoreMO(hyperHost.getContext(), morSourceDS);\n+                s_logger.info(\"Dettaching disks before destroying worker VM '\" + vmName + \"' after volume migration\");\n+                VirtualDisk[] disks = vmMo.getAllDiskDevice();\n+                String format = \"disk %d was migrated to %s\";\n+                for (VirtualDisk disk : disks) {\n+                    if (s_logger.isTraceEnabled()) {\n+                        s_logger.trace(String.format(format, disk.getKey(), vmMo.getVmdkFileBaseName(disk)));\n+                    }\n+                    vmdkDataStorePath = VmwareStorageLayoutHelper.getLegacyDatastorePathFromVmdkFileName(dsMo, vmMo.getVmdkFileBaseName(disk) + VMDK_EXTENSION);\n+                    vmMo.detachDisk(vmdkDataStorePath, false);\n+                }\n+                s_logger.info(\"Destroy worker VM '\" + vmName + \"' after volume migration\");\n+                vmMo.destroy();\n+            } catch (Throwable e) {\n+                s_logger.info(\"Failed to destroy worker VM: \" + vmName);\n+            }\n+        }\n+        if (answer instanceof MigrateVolumeAnswer) {\n+            String newPath = ((MigrateVolumeAnswer)answer).getVolumePath();\n+            String vmdkFileName = newPath + VMDK_EXTENSION;\n+            try {\n+                VmwareStorageLayoutHelper.syncVolumeToRootFolder(dsMo.getOwnerDatacenter().first(), dsMo, newPath, vmName);\n+                vmdkDataStorePath = VmwareStorageLayoutHelper.getLegacyDatastorePathFromVmdkFileName(dsMo, vmdkFileName);\n+\n+                if (!dsMo.fileExists(vmdkDataStorePath)) {\n+                    String msg = String.format(\"Migration of volume '%s' failed; file (%s) not found as path '%s'\", cmd.getVolumePath(), vmdkFileName, vmdkDataStorePath);\n+                    s_logger.error(msg);\n+                    answer = new Answer(cmd, false, msg);\n+                }\n+            } catch (Exception e) {\n+                String msg = String.format(\"Migration of volume '%s' failed due to %s\", cmd.getVolumePath(), e.getLocalizedMessage());\n+                s_logger.error(msg, e);\n+                answer = new Answer(cmd, false, msg);\n+            }\n+        }\n+        return answer;\n+    }\n+\n+    // OfflineVmwareMigration: refactor to be able to handle a detached volume\n     private Answer execute(MigrateVolumeCommand cmd) {\n         String volumePath = cmd.getVolumePath();\n         StorageFilerTO poolTo = cmd.getPool();\n@@ -4087,6 +4397,10 @@ private Answer execute(MigrateVolumeCommand cmd) {\n         VirtualMachineMO vmMo = null;\n         VmwareHypervisorHost srcHyperHost = null;\n \n+        // OfflineVmwareMigration: ifhost is null ???\n+        if (org.apache.commons.lang.StringUtils.isBlank(cmd.getAttachedVmName())) {\n+            return migrateVolume(cmd);\n+        }\n         ManagedObjectReference morDs = null;\n         ManagedObjectReference morDc = null;\n         VirtualMachineRelocateSpec relocateSpec = new VirtualMachineRelocateSpec();\n@@ -4107,7 +4421,7 @@ private Answer execute(MigrateVolumeCommand cmd) {\n             if (vmMo == null) {\n                 String msg = \"VM \" + vmName + \" does not exist in VMware datacenter \" + morDc.getValue();\n                 s_logger.error(msg);\n-                throw new Exception(msg);\n+                throw new CloudRuntimeException(msg);\n             }\n             vmName = vmMo.getName();\n             morDs = HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(srcHyperHost, tgtDsName);\n@@ -4119,8 +4433,8 @@ private Answer execute(MigrateVolumeCommand cmd) {\n             }\n \n             DatastoreMO targetDsMo = new DatastoreMO(srcHyperHost.getContext(), morDs);\n-            String fullVolumePath = VmwareStorageLayoutHelper.getVmwareDatastorePathFromVmdkFileName(targetDsMo, vmName, volumePath + \".vmdk\");\n-            Pair<VirtualDisk, String> diskInfo = getVirtualDiskInfo(vmMo, appendFileType(volumePath, \".vmdk\"));\n+            String fullVolumePath = VmwareStorageLayoutHelper.getVmwareDatastorePathFromVmdkFileName(targetDsMo, vmName, volumePath + VMDK_EXTENSION);\n+            Pair<VirtualDisk, String> diskInfo = getVirtualDiskInfo(vmMo, appendFileType(volumePath, VMDK_EXTENSION));\n             String vmdkAbsFile = getAbsoluteVmdkFile(diskInfo.first());\n             if (vmdkAbsFile != null && !vmdkAbsFile.isEmpty()) {\n                 vmMo.updateAdapterTypeIfRequired(vmdkAbsFile);",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "sha": "37d27c855bc4c44ff95888b430fded00311990ba",
                "status": "modified"
            },
            {
                "additions": 180,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/main/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategy.java",
                "changes": 199,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/main/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategy.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 19,
                "filename": "plugins/hypervisors/vmware/src/main/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategy.java",
                "patch": "@@ -20,42 +20,51 @@\n package org.apache.cloudstack.storage.motion;\n \n import java.util.ArrayList;\n+import java.util.Date;\n import java.util.List;\n import java.util.Map;\n \n import javax.inject.Inject;\n \n-import org.apache.cloudstack.engine.subsystem.api.storage.CopyCommandResult;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataMotionStrategy;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataObject;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataStore;\n-import org.apache.cloudstack.engine.subsystem.api.storage.StrategyPriority;\n-import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n-import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n-import org.apache.cloudstack.framework.async.AsyncCompletionCallback;\n-import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n-import org.apache.cloudstack.storage.to.VolumeObjectTO;\n-import org.apache.log4j.Logger;\n-import org.springframework.stereotype.Component;\n-\n import com.cloud.agent.AgentManager;\n import com.cloud.agent.api.Answer;\n import com.cloud.agent.api.MigrateWithStorageAnswer;\n import com.cloud.agent.api.MigrateWithStorageCommand;\n+import com.cloud.agent.api.storage.MigrateVolumeAnswer;\n+import com.cloud.agent.api.storage.MigrateVolumeCommand;\n+import com.cloud.agent.api.to.DataObjectType;\n import com.cloud.agent.api.to.StorageFilerTO;\n import com.cloud.agent.api.to.VirtualMachineTO;\n import com.cloud.agent.api.to.VolumeTO;\n import com.cloud.exception.AgentUnavailableException;\n import com.cloud.exception.OperationTimedoutException;\n import com.cloud.host.Host;\n+import com.cloud.host.HostVO;\n+import com.cloud.host.Status;\n+import com.cloud.host.dao.HostDao;\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.storage.DataStoreRole;\n+import com.cloud.storage.ScopeType;\n import com.cloud.storage.StoragePool;\n+import com.cloud.storage.Volume;\n import com.cloud.storage.VolumeVO;\n import com.cloud.storage.dao.VolumeDao;\n import com.cloud.utils.Pair;\n import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.vm.VMInstanceVO;\n import com.cloud.vm.dao.VMInstanceDao;\n+import org.apache.cloudstack.engine.subsystem.api.storage.CopyCommandResult;\n+import org.apache.cloudstack.engine.subsystem.api.storage.DataMotionStrategy;\n+import org.apache.cloudstack.engine.subsystem.api.storage.DataObject;\n+import org.apache.cloudstack.engine.subsystem.api.storage.DataStore;\n+import org.apache.cloudstack.engine.subsystem.api.storage.StrategyPriority;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n+import org.apache.cloudstack.framework.async.AsyncCompletionCallback;\n+import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n+import org.apache.cloudstack.storage.to.VolumeObjectTO;\n+import org.apache.log4j.Logger;\n+import org.springframework.stereotype.Component;\n \n @Component\n public class VmwareStorageMotionStrategy implements DataMotionStrategy {\n@@ -70,12 +79,77 @@\n     PrimaryDataStoreDao storagePoolDao;\n     @Inject\n     VMInstanceDao instanceDao;\n+    @Inject\n+    private HostDao hostDao;\n \n     @Override\n     public StrategyPriority canHandle(DataObject srcData, DataObject destData) {\n+        // OfflineVmwareMigration: return StrategyPriority.HYPERVISOR when destData is in a storage pool in the same vmware-cluster and both are volumes\n+        if (isOnVmware(srcData, destData)\n+                && isOnPrimary(srcData, destData)\n+                && isVolumesOnly(srcData, destData)\n+                && isDettached(srcData)\n+                && isIntraCluster(srcData, destData)\n+                && isStoreScopeEqual(srcData, destData)) {\n+            if (s_logger.isDebugEnabled()) {\n+                String msg = String.format(\"%s can handle the request because %d(%s) and %d(%s) share the VMware cluster %s (== %s)\"\n+                        , this.getClass()\n+                        , srcData.getId()\n+                        , srcData.getUuid()\n+                        , destData.getId()\n+                        , destData.getUuid()\n+                        , storagePoolDao.findById(srcData.getDataStore().getId()).getClusterId()\n+                        , storagePoolDao.findById(destData.getDataStore().getId()).getClusterId());\n+                s_logger.debug(msg);\n+            }\n+            return StrategyPriority.HYPERVISOR;\n+        }\n         return StrategyPriority.CANT_HANDLE;\n     }\n \n+    private boolean isDettached(DataObject srcData) {\n+        VolumeVO volume = volDao.findById(srcData.getId());\n+        return volume.getInstanceId() == null;\n+    }\n+\n+    private boolean isVolumesOnly(DataObject srcData, DataObject destData) {\n+        return DataObjectType.VOLUME.equals(srcData.getType())\n+                && DataObjectType.VOLUME.equals(destData.getType());\n+    }\n+\n+    private boolean isOnPrimary(DataObject srcData, DataObject destData) {\n+        return DataStoreRole.Primary.equals(srcData.getDataStore().getRole())\n+                && DataStoreRole.Primary.equals(destData.getDataStore().getRole());\n+    }\n+\n+    private boolean isOnVmware(DataObject srcData, DataObject destData) {\n+        return HypervisorType.VMware.equals(srcData.getTO().getHypervisorType())\n+                && HypervisorType.VMware.equals(destData.getTO().getHypervisorType());\n+    }\n+\n+    private boolean isIntraCluster(DataObject srcData, DataObject destData) {\n+        DataStore srcStore = srcData.getDataStore();\n+        StoragePool srcPool = storagePoolDao.findById(srcStore.getId());\n+        DataStore destStore = destData.getDataStore();\n+        StoragePool destPool = storagePoolDao.findById(destStore.getId());\n+        return srcPool.getClusterId().equals(destPool.getClusterId());\n+    }\n+\n+    /**\n+     * Ensure that the scope of source and destination storage pools match\n+     *\n+     * @param srcData\n+     * @param destData\n+     * @return\n+     */\n+    private boolean isStoreScopeEqual(DataObject srcData, DataObject destData) {\n+        DataStore srcStore = srcData.getDataStore();\n+        DataStore destStore = destData.getDataStore();\n+        String msg = String.format(\"Storage scope of source pool is %s and of destination pool is %s\", srcStore.getScope().toString(), destStore.getScope().toString());\n+        s_logger.debug(msg);\n+        return srcStore.getScope().getScopeType() == (destStore.getScope().getScopeType());\n+    }\n+\n     @Override\n     public StrategyPriority canHandle(Map<VolumeInfo, DataStore> volumeMap, Host srcHost, Host destHost) {\n         if (srcHost.getHypervisorType() == HypervisorType.VMware && destHost.getHypervisorType() == HypervisorType.VMware) {\n@@ -85,9 +159,96 @@ public StrategyPriority canHandle(Map<VolumeInfo, DataStore> volumeMap, Host src\n         return StrategyPriority.CANT_HANDLE;\n     }\n \n+    /**\n+     * the Vmware storageMotion strategy allows to copy to a destination pool but not to a destination host\n+     *\n+     * @param srcData  volume to move\n+     * @param destData volume description as intended after the move\n+     * @param destHost null or else\n+     * @param callback where to report completion or failure to\n+     */\n     @Override\n     public void copyAsync(DataObject srcData, DataObject destData, Host destHost, AsyncCompletionCallback<CopyCommandResult> callback) {\n-        throw new UnsupportedOperationException();\n+        if (destHost != null) {\n+            String format = \"%s cannot target a host in moving an object from {%s}\\n to {%s}\";\n+            String msg = String.format(format\n+                    , this.getClass().getName()\n+                    , srcData.toString()\n+                    , destData.toString()\n+            );\n+            s_logger.error(msg);\n+            throw new CloudRuntimeException(msg);\n+        }\n+        // OfflineVmwareMigration: extract the destination pool from destData and construct a migrateVolume command\n+        if (!isOnPrimary(srcData, destData)) {\n+            // OfflineVmwareMigration: we shouldn't be here as we would have refused in the canHandle call\n+            throw new UnsupportedOperationException();\n+        }\n+        StoragePool sourcePool = (StoragePool) srcData.getDataStore();\n+        StoragePool targetPool = (StoragePool) destData.getDataStore();\n+        MigrateVolumeCommand cmd = new MigrateVolumeCommand(srcData.getId()\n+                , srcData.getTO().getPath()\n+                , sourcePool\n+                , targetPool);\n+        // OfflineVmwareMigration: should be ((StoragePool)srcData.getDataStore()).getHypervisor() but that is NULL, so hardcoding\n+        Answer answer;\n+        ScopeType scopeType = srcData.getDataStore().getScope().getScopeType();\n+        if (ScopeType.CLUSTER == scopeType) {\n+            // Find Volume source cluster and select any Vmware hypervisor host to attach worker VM\n+            Long hostId = findSuitableHostIdForWorkerVmPlacement(sourcePool.getClusterId());\n+            if (hostId == null) {\n+                throw new CloudRuntimeException(\"Offline Migration failed, unable to find suitable host for worker VM placement in cluster: \" + sourcePool.getName());\n+            }\n+            answer = agentMgr.easySend(hostId, cmd);\n+        } else {\n+            answer = agentMgr.sendTo(sourcePool.getDataCenterId(), HypervisorType.VMware, cmd);\n+        }\n+        updateVolumeAfterMigration(answer, srcData, destData);\n+        CopyCommandResult result = new CopyCommandResult(null, answer);\n+        callback.complete(result);\n+    }\n+\n+    /**\n+     * Selects a host from the cluster housing the source storage pool\n+     * Assumption is that Primary Storage is cluster-wide\n+     * <p>\n+     * returns any host ID within the cluster if storage-pool is cluster-wide, and exception is thrown otherwise\n+     *\n+     * @param clusterId\n+     * @return\n+     */\n+    private Long findSuitableHostIdForWorkerVmPlacement(Long clusterId) {\n+        List<HostVO> hostLists = hostDao.findByClusterId(clusterId);\n+        Long hostId = null;\n+        for (HostVO hostVO : hostLists) {\n+            if (hostVO.getHypervisorType().equals(HypervisorType.VMware) && hostVO.getStatus() == Status.Up) {\n+                hostId = hostVO.getId();\n+                break;\n+            }\n+        }\n+        return hostId;\n+    }\n+\n+    private void updateVolumeAfterMigration(Answer answer, DataObject srcData, DataObject destData) {\n+        VolumeVO destinationVO = volDao.findById(destData.getId());\n+        if (!(answer instanceof MigrateVolumeAnswer)) {\n+            // OfflineVmwareMigration: reset states and such\n+            VolumeVO sourceVO = volDao.findById(srcData.getId());\n+            sourceVO.setState(Volume.State.Ready);\n+            volDao.update(sourceVO.getId(), sourceVO);\n+            destinationVO.setState(Volume.State.Expunged);\n+            destinationVO.setRemoved(new Date());\n+            volDao.update(destinationVO.getId(), destinationVO);\n+            throw new CloudRuntimeException(\"unexpected answer from hypervisor agent: \" + answer.getDetails());\n+        }\n+        MigrateVolumeAnswer ans = (MigrateVolumeAnswer) answer;\n+        if (s_logger.isDebugEnabled()) {\n+            String format = \"retrieved '%s' as new path for volume(%d)\";\n+            s_logger.debug(String.format(format, ans.getVolumePath(), destData.getId()));\n+        }\n+        // OfflineVmwareMigration: update the volume with new pool/volume path\n+        destinationVO.setPath(ans.getVolumePath());\n+        volDao.update(destinationVO.getId(), destinationVO);\n     }\n \n     @Override\n@@ -124,7 +285,7 @@ private Answer migrateVmWithVolumesAcrossCluster(VMInstanceVO vm, VirtualMachine\n             for (Map.Entry<VolumeInfo, DataStore> entry : volumeToPool.entrySet()) {\n                 VolumeInfo volume = entry.getKey();\n                 VolumeTO volumeTo = new VolumeTO(volume, storagePoolDao.findById(volume.getPoolId()));\n-                StorageFilerTO filerTo = new StorageFilerTO((StoragePool)entry.getValue());\n+                StorageFilerTO filerTo = new StorageFilerTO((StoragePool) entry.getValue());\n                 volumeToFilerto.add(new Pair<VolumeTO, StorageFilerTO>(volumeTo, filerTo));\n             }\n \n@@ -133,7 +294,7 @@ private Answer migrateVmWithVolumesAcrossCluster(VMInstanceVO vm, VirtualMachine\n             //      Run validations against target!!\n             // 2. Complete the process. Update the volume details.\n             MigrateWithStorageCommand migrateWithStorageCmd = new MigrateWithStorageCommand(to, volumeToFilerto, destHost.getGuid());\n-            MigrateWithStorageAnswer migrateWithStorageAnswer = (MigrateWithStorageAnswer)agentMgr.send(srcHost.getId(), migrateWithStorageCmd);\n+            MigrateWithStorageAnswer migrateWithStorageAnswer = (MigrateWithStorageAnswer) agentMgr.send(srcHost.getId(), migrateWithStorageCmd);\n             if (migrateWithStorageAnswer == null) {\n                 s_logger.error(\"Migration with storage of vm \" + vm + \" to host \" + destHost + \" failed.\");\n                 throw new CloudRuntimeException(\"Error while migrating the vm \" + vm + \" to host \" + destHost);\n@@ -162,12 +323,12 @@ private Answer migrateVmWithVolumesWithinCluster(VMInstanceVO vm, VirtualMachine\n             for (Map.Entry<VolumeInfo, DataStore> entry : volumeToPool.entrySet()) {\n                 VolumeInfo volume = entry.getKey();\n                 VolumeTO volumeTo = new VolumeTO(volume, storagePoolDao.findById(volume.getPoolId()));\n-                StorageFilerTO filerTo = new StorageFilerTO((StoragePool)entry.getValue());\n+                StorageFilerTO filerTo = new StorageFilerTO((StoragePool) entry.getValue());\n                 volumeToFilerto.add(new Pair<VolumeTO, StorageFilerTO>(volumeTo, filerTo));\n             }\n \n             MigrateWithStorageCommand command = new MigrateWithStorageCommand(to, volumeToFilerto, destHost.getGuid());\n-            MigrateWithStorageAnswer answer = (MigrateWithStorageAnswer)agentMgr.send(srcHost.getId(), command);\n+            MigrateWithStorageAnswer answer = (MigrateWithStorageAnswer) agentMgr.send(srcHost.getId(), command);\n             if (answer == null) {\n                 s_logger.error(\"Migration with storage of vm \" + vm + \" failed.\");\n                 throw new CloudRuntimeException(\"Error while migrating the vm \" + vm + \" to host \" + destHost);\n@@ -190,7 +351,7 @@ private void updateVolumesAfterMigration(Map<VolumeInfo, DataStore> volumeToPool\n         for (Map.Entry<VolumeInfo, DataStore> entry : volumeToPool.entrySet()) {\n             boolean updated = false;\n             VolumeInfo volume = entry.getKey();\n-            StoragePool pool = (StoragePool)entry.getValue();\n+            StoragePool pool = (StoragePool) entry.getValue();\n             for (VolumeObjectTO volumeTo : volumeTos) {\n                 if (volume.getId() == volumeTo.getId()) {\n                     VolumeVO volumeVO = volDao.findById(volume.getId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/main/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategy.java",
                "sha": "2463e75c01d3da48cb2a91ea96c391d7b7640f68",
                "status": "modified"
            },
            {
                "additions": 36,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/test/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategyTest.java",
                "changes": 66,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/test/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategyTest.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 30,
                "filename": "plugins/hypervisors/vmware/src/test/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategyTest.java",
                "patch": "@@ -16,20 +16,36 @@\n // under the License.\n package org.apache.cloudstack.storage.motion;\n \n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertTrue;\n-import static org.mockito.Matchers.anyLong;\n-import static org.mockito.Matchers.isA;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.when;\n-\n import java.io.IOException;\n import java.util.HashMap;\n import java.util.Map;\n \n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+import com.cloud.agent.AgentManager;\n+import com.cloud.agent.api.MigrateWithStorageAnswer;\n+import com.cloud.agent.api.MigrateWithStorageCommand;\n+import com.cloud.agent.api.to.VirtualMachineTO;\n+import com.cloud.host.Host;\n+import com.cloud.host.dao.HostDao;\n+import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.storage.dao.VolumeDao;\n+import com.cloud.utils.component.ComponentContext;\n+import com.cloud.vm.VMInstanceVO;\n+import com.cloud.vm.dao.VMInstanceDao;\n+import org.apache.cloudstack.engine.subsystem.api.storage.CopyCommandResult;\n+import org.apache.cloudstack.engine.subsystem.api.storage.DataStore;\n+import org.apache.cloudstack.engine.subsystem.api.storage.StrategyPriority;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n+import org.apache.cloudstack.framework.async.AsyncCallFuture;\n+import org.apache.cloudstack.framework.async.AsyncCallbackDispatcher;\n+import org.apache.cloudstack.framework.async.AsyncCompletionCallback;\n+import org.apache.cloudstack.framework.async.AsyncRpcContext;\n+import org.apache.cloudstack.storage.command.CommandResult;\n+import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n+import org.apache.cloudstack.test.utils.SpringUtils;\n import org.junit.Before;\n import org.junit.BeforeClass;\n import org.junit.Test;\n@@ -47,29 +63,12 @@\n import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n import org.springframework.test.context.support.AnnotationConfigContextLoader;\n \n-import org.apache.cloudstack.engine.subsystem.api.storage.CopyCommandResult;\n-import org.apache.cloudstack.engine.subsystem.api.storage.DataStore;\n-import org.apache.cloudstack.engine.subsystem.api.storage.StrategyPriority;\n-import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n-import org.apache.cloudstack.engine.subsystem.api.storage.VolumeInfo;\n-import org.apache.cloudstack.framework.async.AsyncCallFuture;\n-import org.apache.cloudstack.framework.async.AsyncCallbackDispatcher;\n-import org.apache.cloudstack.framework.async.AsyncCompletionCallback;\n-import org.apache.cloudstack.framework.async.AsyncRpcContext;\n-import org.apache.cloudstack.storage.command.CommandResult;\n-import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n-import org.apache.cloudstack.test.utils.SpringUtils;\n-\n-import com.cloud.agent.AgentManager;\n-import com.cloud.agent.api.MigrateWithStorageAnswer;\n-import com.cloud.agent.api.MigrateWithStorageCommand;\n-import com.cloud.agent.api.to.VirtualMachineTO;\n-import com.cloud.host.Host;\n-import com.cloud.hypervisor.Hypervisor.HypervisorType;\n-import com.cloud.storage.dao.VolumeDao;\n-import com.cloud.utils.component.ComponentContext;\n-import com.cloud.vm.VMInstanceVO;\n-import com.cloud.vm.dao.VMInstanceDao;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.anyLong;\n+import static org.mockito.Matchers.isA;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n @RunWith(SpringJUnit4ClassRunner.class)\n @ContextConfiguration(loader = AnnotationConfigContextLoader.class)\n@@ -87,6 +86,8 @@\n     PrimaryDataStoreDao storagePoolDao;\n     @Inject\n     VMInstanceDao instanceDao;\n+    @Inject\n+    private HostDao hostDao;\n \n     CopyCommandResult result;\n \n@@ -262,6 +263,11 @@ public AgentManager agentManager() {\n             return Mockito.mock(AgentManager.class);\n         }\n \n+        @Bean\n+        public HostDao hostDao() {\n+            return Mockito.mock(HostDao.class);\n+        }\n+\n         public static class Library implements TypeFilter {\n             @Override\n             public boolean match(MetadataReader mdr, MetadataReaderFactory arg1) throws IOException {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/plugins/hypervisors/vmware/src/test/java/org/apache/cloudstack/storage/motion/VmwareStorageMotionStrategyTest.java",
                "sha": "4cc3a77baaaf6de8e385c6ff670928447a3998b5",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/api/ApiDispatcher.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/api/ApiDispatcher.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 2,
                "filename": "server/src/main/java/com/cloud/api/ApiDispatcher.java",
                "patch": "@@ -49,6 +49,7 @@\n     private static final Logger s_logger = Logger.getLogger(ApiDispatcher.class.getName());\n \n     Long _createSnapshotQueueSizeLimit;\n+    Long migrateQueueSizeLimit;\n \n     @Inject\n     AsyncJobManager _asyncMgr;\n@@ -79,6 +80,9 @@ public void setCreateSnapshotQueueSizeLimit(final Long snapshotLimit) {\n         _createSnapshotQueueSizeLimit = snapshotLimit;\n     }\n \n+    public void setMigrateQueueSizeLimit(final Long migrateLimit) {\n+        migrateQueueSizeLimit = migrateLimit;\n+    }\n \n     public void dispatchCreateCmd(final BaseAsyncCreateCmd cmd, final Map<String, String> params) throws Exception {\n         asyncCreationDispatchChain.dispatch(new DispatchTask(cmd, params));\n@@ -123,7 +127,9 @@ public void dispatch(final BaseCmd cmd, final Map<String, String> params, final\n             if (asyncCmd.getJob() != null && asyncCmd.getSyncObjId() != null && asyncCmd.getSyncObjType() != null) {\n                 Long queueSizeLimit = null;\n                 if (asyncCmd.getSyncObjType() != null && asyncCmd.getSyncObjType().equalsIgnoreCase(BaseAsyncCmd.snapshotHostSyncObject)) {\n-                    queueSizeLimit = _createSnapshotQueueSizeLimit;\n+                        queueSizeLimit = _createSnapshotQueueSizeLimit;\n+                } else if (asyncCmd.getSyncObjType() != null && asyncCmd.getSyncObjType().equalsIgnoreCase(BaseAsyncCmd.migrationSyncObject)) {\n+                        queueSizeLimit = migrateQueueSizeLimit;\n                 } else {\n                     queueSizeLimit = 1L;\n                 }\n@@ -148,6 +154,6 @@ public void dispatch(final BaseCmd cmd, final Map<String, String> params, final\n         }\n \n         cmd.execute();\n-                            }\n+    }\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/api/ApiDispatcher.java",
                "sha": "11615ea3f54b7601408c447e1b61ad1cfa46ade2",
                "status": "modified"
            },
            {
                "additions": 81,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/api/ApiServer.java",
                "changes": 125,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/api/ApiServer.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 44,
                "filename": "server/src/main/java/com/cloud/api/ApiServer.java",
                "patch": "@@ -19,7 +19,6 @@\n import com.cloud.api.dispatch.DispatchChainFactory;\n import com.cloud.api.dispatch.DispatchTask;\n import com.cloud.api.response.ApiResponseSerializer;\n-import com.cloud.configuration.Config;\n import com.cloud.domain.Domain;\n import com.cloud.domain.DomainVO;\n import com.cloud.domain.dao.DomainDao;\n@@ -35,6 +34,7 @@\n import com.cloud.exception.ResourceAllocationException;\n import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.exception.UnavailableCommandException;\n+import com.cloud.storage.VolumeApiService;\n import com.cloud.user.Account;\n import com.cloud.user.AccountManager;\n import com.cloud.user.DomainManager;\n@@ -44,7 +44,6 @@\n import com.cloud.utils.ConstantTimeComparator;\n import com.cloud.utils.DateUtil;\n import com.cloud.utils.HttpUtils;\n-import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.Pair;\n import com.cloud.utils.ReflectUtil;\n import com.cloud.utils.StringUtils;\n@@ -54,7 +53,6 @@\n import com.cloud.utils.component.PluggableService;\n import com.cloud.utils.concurrency.NamedThreadFactory;\n import com.cloud.utils.db.EntityManager;\n-import com.cloud.utils.db.SearchCriteria;\n import com.cloud.utils.db.TransactionLegacy;\n import com.cloud.utils.db.UUIDManager;\n import com.cloud.utils.exception.CloudRuntimeException;\n@@ -100,8 +98,6 @@\n import org.apache.cloudstack.context.CallContext;\n import org.apache.cloudstack.framework.config.ConfigKey;\n import org.apache.cloudstack.framework.config.Configurable;\n-import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n-import org.apache.cloudstack.framework.config.impl.ConfigurationVO;\n import org.apache.cloudstack.framework.events.EventBus;\n import org.apache.cloudstack.framework.events.EventBusException;\n import org.apache.cloudstack.framework.jobs.AsyncJob;\n@@ -209,8 +205,6 @@\n     @Inject\n     private AsyncJobManager asyncMgr;\n     @Inject\n-    private ConfigurationDao configDao;\n-    @Inject\n     private EntityManager entityMgr;\n     @Inject\n     private APIAuthenticationManager authManager;\n@@ -228,14 +222,60 @@\n     private static ExecutorService s_executor = new ThreadPoolExecutor(10, 150, 60, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>(), new NamedThreadFactory(\n             \"ApiServer\"));\n \n-    static final ConfigKey<Boolean> EnableSecureSessionCookie = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"enable.secure.session.cookie\", \"false\",\n-            \"Session cookie is marked as secure if this is enabled. Secure cookies only work when HTTPS is used.\", false);\n-\n-    static final ConfigKey<String> JSONcontentType = new ConfigKey<String>(String.class, \"json.content.type\", \"Advanced\", \"application/json; charset=UTF-8\",\n-            \"Http response content type for .js files (default is text/javascript)\", false, ConfigKey.Scope.Global, null);\n     @Inject\n     private MessageBus messageBus;\n \n+    private static final ConfigKey<Integer> IntegrationAPIPort = new ConfigKey<Integer>(\"Advanced\"\n+            , Integer.class\n+            , \"integration.api.port\"\n+            , \"8096\"\n+            , \"Default API port\"\n+            , false\n+            , ConfigKey.Scope.Global);\n+    private static final ConfigKey<Long> ConcurrentSnapshotsThresholdPerHost = new ConfigKey<Long>(\"Advanced\"\n+            , Long.class\n+            , \"concurrent.snapshots.threshold.perhost\"\n+            , null\n+            , \"Limits number of snapshots that can be handled by the host concurrently; default is NULL - unlimited\"\n+            , true // not sure if this is to be dynamic\n+            , ConfigKey.Scope.Global);\n+    private static final ConfigKey<Boolean> EncodeApiResponse = new ConfigKey<Boolean>(\"Advanced\"\n+            , Boolean.class\n+            , \"encode.api.response\"\n+            , \"false\"\n+            , \"Do URL encoding for the api response, false by default\"\n+            , false\n+            , ConfigKey.Scope.Global);\n+    static final ConfigKey<String> JSONcontentType = new ConfigKey<String>( \"Advanced\"\n+            , String.class\n+            , \"json.content.type\"\n+            , \"application/json; charset=UTF-8\"\n+            , \"Http response content type for .js files (default is text/javascript)\"\n+            , false\n+            , ConfigKey.Scope.Global);\n+    static final ConfigKey<Boolean> EnableSecureSessionCookie = new ConfigKey<Boolean>(\"Advanced\"\n+            , Boolean.class\n+            , \"enable.secure.session.cookie\"\n+            , \"false\"\n+            , \"Session cookie is marked as secure if this is enabled. Secure cookies only work when HTTPS is used.\"\n+            , false\n+            , ConfigKey.Scope.Global);\n+    private static final ConfigKey<String> JSONDefaultContentType = new ConfigKey<String> (\"Advanced\"\n+            , String.class\n+            , \"json.content.type\"\n+            , \"application/json; charset=UTF-8\"\n+            , \"Http response content type for JSON\"\n+            , false\n+            , ConfigKey.Scope.Global);\n+\n+    private static final ConfigKey<Boolean> UseEventAccountInfo = new ConfigKey<Boolean>( \"advanced\"\n+            , Boolean.class\n+            , \"event.accountinfo\"\n+            , \"false\"\n+            , \"use account info in event logging\"\n+            , true\n+            , ConfigKey.Scope.Global);\n+\n     @Override\n     public boolean configure(final String name, final Map<String, Object> params) throws ConfigurationException {\n         messageBus.subscribe(AsyncJob.Topics.JOB_EVENT_PUBLISH, MessageDispatcher.getDispatcher(this));\n@@ -305,8 +345,7 @@ public void handleAsyncJobPublishEvent(String subject, String senderAddress, Obj\n         eventDescription.put(\"cmdInfo\", job.getCmdInfo());\n         eventDescription.put(\"status\", \"\" + job.getStatus() );\n         // If the event.accountinfo boolean value is set, get the human readable value for the username / domainname\n-        Map<String, String> configs = configDao.getConfiguration(\"management-server\", new HashMap<String, String>());\n-        if (Boolean.valueOf(configs.get(\"event.accountinfo\"))) {\n+        if (UseEventAccountInfo.value()) {\n             DomainVO domain = domainDao.findById(jobOwner.getDomainId());\n             eventDescription.put(\"username\", userJobOwner.getUsername());\n             eventDescription.put(\"accountname\", jobOwner.getAccountName());\n@@ -325,27 +364,20 @@ public void handleAsyncJobPublishEvent(String subject, String senderAddress, Obj\n     @Override\n     public boolean start() {\n         Security.addProvider(new BouncyCastleProvider());\n-        Integer apiPort = null; // api port, null by default\n-        final SearchCriteria<ConfigurationVO> sc = configDao.createSearchCriteria();\n-        sc.addAnd(\"name\", SearchCriteria.Op.EQ, Config.IntegrationAPIPort.key());\n-        final List<ConfigurationVO> values = configDao.search(sc, null);\n-        if ((values != null) && (values.size() > 0)) {\n-            final ConfigurationVO apiPortConfig = values.get(0);\n-            if (apiPortConfig.getValue() != null) {\n-                apiPort = Integer.parseInt(apiPortConfig.getValue());\n-                apiPort = (apiPort <= 0) ? null : apiPort;\n-            }\n+        Integer apiPort = IntegrationAPIPort.value(); // api port, null by default\n+\n+        final Long snapshotLimit = ConcurrentSnapshotsThresholdPerHost.value();\n+        if (snapshotLimit == null || snapshotLimit.longValue() <= 0) {\n+            s_logger.debug(\"Global concurrent snapshot config parameter \" + ConcurrentSnapshotsThresholdPerHost.value() + \" is less or equal 0; defaulting to unlimited\");\n+        } else {\n+            dispatcher.setCreateSnapshotQueueSizeLimit(snapshotLimit);\n         }\n \n-        final Map<String, String> configs = configDao.getConfiguration();\n-        final String strSnapshotLimit = configs.get(Config.ConcurrentSnapshotsThresholdPerHost.key());\n-        if (strSnapshotLimit != null) {\n-            final Long snapshotLimit = NumbersUtil.parseLong(strSnapshotLimit, 1L);\n-            if (snapshotLimit.longValue() <= 0) {\n-                s_logger.debug(\"Global config parameter \" + Config.ConcurrentSnapshotsThresholdPerHost.toString() + \" is less or equal 0; defaulting to unlimited\");\n-            } else {\n-                dispatcher.setCreateSnapshotQueueSizeLimit(snapshotLimit);\n-            }\n+        final Long migrationLimit = VolumeApiService.ConcurrentMigrationsThresholdPerDatastore.value();\n+        if (migrationLimit == null || migrationLimit.longValue() <= 0) {\n+            s_logger.debug(\"Global concurrent migration config parameter \" + VolumeApiService.ConcurrentMigrationsThresholdPerDatastore.value() + \" is less or equal 0; defaulting to unlimited\");\n+        } else {\n+            dispatcher.setMigrateQueueSizeLimit(migrationLimit);\n         }\n \n         final Set<Class<?>> cmdClasses = new HashSet<Class<?>>();\n@@ -372,7 +404,7 @@ public boolean start() {\n \n         }\n \n-        setEncodeApiResponse(Boolean.valueOf(configDao.getValue(Config.EncodeApiResponse.key())));\n+        setEncodeApiResponse(EncodeApiResponse.value());\n \n         if (apiPort != null) {\n             final ListenerThread listenerThread = new ListenerThread(this, apiPort);\n@@ -1200,16 +1232,6 @@ private void writeResponse(final HttpResponse resp, final String responseText, f\n         }\n     }\n \n-    @Override\n-    public String getConfigComponentName() {\n-        return ApiServer.class.getSimpleName();\n-    }\n-\n-    @Override\n-    public ConfigKey<?>[] getConfigKeys() {\n-        return new ConfigKey<?>[] { EnableSecureSessionCookie, JSONcontentType };\n-    }\n-\n     // FIXME: the following two threads are copied from\n     // http://svn.apache.org/repos/asf/httpcomponents/httpcore/trunk/httpcore/src/examples/org/apache/http/examples/ElementalHttpServer.java\n     // we have to cite a license if we are using this code directly, so we need to add the appropriate citation or\n@@ -1413,4 +1435,19 @@ private static void setEncodeApiResponse(final boolean encodeApiResponse) {\n         ApiServer.encodeApiResponse = encodeApiResponse;\n     }\n \n+    @Override\n+    public String getConfigComponentName() {\n+        return ApiServer.class.getSimpleName();\n+    }\n+\n+    @Override\n+    public ConfigKey<?>[] getConfigKeys() {\n+        return new ConfigKey<?>[] {\n+                IntegrationAPIPort,\n+                ConcurrentSnapshotsThresholdPerHost,\n+                EncodeApiResponse,\n+                EnableSecureSessionCookie,\n+                JSONDefaultContentType\n+        };\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/api/ApiServer.java",
                "sha": "a8ab7b095c67a9f0c1f455b73185375668eb41e9",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/configuration/Config.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/configuration/Config.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 10,
                "filename": "server/src/main/java/com/cloud/configuration/Config.java",
                "patch": "@@ -566,7 +566,6 @@\n             \"The interval (in milliseconds) when host stats are retrieved from agents.\",\n             null),\n     HostRetry(\"Advanced\", AgentManager.class, Integer.class, \"host.retry\", \"2\", \"Number of times to retry hosts for creating a volume\", null),\n-    IntegrationAPIPort(\"Advanced\", ManagementServer.class, Integer.class, \"integration.api.port\", null, \"Default API port. To disable set it to 0 or negative.\", null),\n     InvestigateRetryInterval(\n             \"Advanced\",\n             HighAvailabilityManager.class,\n@@ -1439,7 +1438,6 @@\n             \"true\",\n             \"Allow subdomains to use networks dedicated to their parent domain(s)\",\n             null),\n-    EncodeApiResponse(\"Advanced\", ManagementServer.class, Boolean.class, \"encode.api.response\", \"false\", \"Do URL encoding for the api response, false by default\", null),\n     DnsBasicZoneUpdates(\n             \"Advanced\",\n             NetworkOrchestrationService.class,\n@@ -1693,14 +1691,6 @@\n             null),\n     VpcMaxNetworks(\"Advanced\", ManagementServer.class, Integer.class, \"vpc.max.networks\", \"3\", \"Maximum number of networks per vpc\", null),\n     DetailBatchQuerySize(\"Advanced\", ManagementServer.class, Integer.class, \"detail.batch.query.size\", \"2000\", \"Default entity detail batch query size for listing\", null),\n-    ConcurrentSnapshotsThresholdPerHost(\n-            \"Advanced\",\n-            ManagementServer.class,\n-            Long.class,\n-            \"concurrent.snapshots.threshold.perhost\",\n-            null,\n-            \"Limits number of snapshots that can be handled by the host concurrently; default is NULL - unlimited\",\n-            null),\n     NetworkIPv6SearchRetryMax(\n             \"Network\",\n             ManagementServer.class,",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/configuration/Config.java",
                "sha": "eda34e5970478656a65e61e4bdffce459a3e2f31",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/deploy/DeploymentPlanningManagerImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "server/src/main/java/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "patch": "@@ -1342,7 +1342,8 @@ protected boolean hostCanAccessSPool(Host host, StoragePool pool) {\n \n         // There should be atleast the ROOT volume of the VM in usable state\n         if (volumesTobeCreated.isEmpty()) {\n-            throw new CloudRuntimeException(\"Unable to create deployment, no usable volumes found for the VM\");\n+            // OfflineVmwareMigration: find out what is wrong with the id of the vm we try to start\n+            throw new CloudRuntimeException(\"Unable to create deployment, no usable volumes found for the VM: \" + vmProfile.getId());\n         }\n \n         // don't allow to start vm that doesn't have a root volume",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "sha": "a95f4ef2d694002612e1f1bc3067c366f0f18102",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/hypervisor/HypervisorGuruBase.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/hypervisor/HypervisorGuruBase.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "server/src/main/java/com/cloud/hypervisor/HypervisorGuruBase.java",
                "patch": "@@ -40,6 +40,7 @@\n import com.cloud.service.ServiceOfferingDetailsVO;\n import com.cloud.service.dao.ServiceOfferingDao;\n import com.cloud.service.dao.ServiceOfferingDetailsDao;\n+import com.cloud.storage.StoragePool;\n import com.cloud.utils.Pair;\n import com.cloud.utils.component.AdapterBase;\n import com.cloud.vm.NicProfile;\n@@ -225,4 +226,8 @@ protected VirtualMachineTO toVirtualMachineTO(VirtualMachineProfile vmProfile) {\n         return null;\n     }\n \n+    @Override\n+    public List<Command> finalizeMigrate(VirtualMachine vm, StoragePool destination) {\n+        return null;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/hypervisor/HypervisorGuruBase.java",
                "sha": "445997a6d065877ce8313a64d0562272d23201a5",
                "status": "modified"
            },
            {
                "additions": 30,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/server/ManagementServerImpl.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/server/ManagementServerImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "server/src/main/java/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -37,6 +37,7 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n+import com.cloud.storage.ScopeType;\n import org.apache.cloudstack.acl.ControlledEntity;\n import org.apache.cloudstack.affinity.AffinityGroupProcessor;\n import org.apache.cloudstack.affinity.dao.AffinityGroupVMMapDao;\n@@ -1103,6 +1104,32 @@ public boolean deleteEvents(final DeleteEventsCmd cmd) {\n         return new Pair<List<? extends Cluster>, Integer>(result.first(), result.second());\n     }\n \n+    private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumePool, VirtualMachineProfile profile) {\n+        HypervisorType type = null;\n+        if (vm == null) {\n+            StoragePoolVO poolVo = _poolDao.findById(srcVolumePool.getId());\n+            if (ScopeType.CLUSTER.equals(poolVo.getScope())) {\n+                Long clusterId = poolVo.getClusterId();\n+                if (clusterId != null) {\n+                    ClusterVO cluster = _clusterDao.findById(clusterId);\n+                    type = cluster.getHypervisorType();\n+                }\n+            } else if (ScopeType.ZONE.equals(poolVo.getScope())) {\n+                Long zoneId = poolVo.getDataCenterId();\n+                if (zoneId != null) {\n+                    DataCenterVO dc = _dcDao.findById(zoneId);\n+                }\n+            }\n+\n+            if (null == type) {\n+                type = srcVolumePool.getHypervisor();\n+            }\n+        } else {\n+            type = profile.getHypervisorType();\n+        }\n+        return type;\n+    }\n+\n     @Override\n     public Pair<List<? extends Host>, Integer> searchForServers(final ListHostsCmd cmd) {\n \n@@ -1433,10 +1460,12 @@ private boolean hasSuitablePoolsForVolume(final VolumeVO volume, final Host host\n \n         DataCenterDeployment plan = new DataCenterDeployment(volume.getDataCenterId(), srcVolumePool.getPodId(), srcVolumePool.getClusterId(), null, null, null);\n         VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+        // OfflineVmwareMigration: vm might be null here; deal!\n+        HypervisorType type = getHypervisorType(vm, srcVolumePool, profile);\n \n         DiskOfferingVO diskOffering = _diskOfferingDao.findById(volume.getDiskOfferingId());\n         //This is an override mechanism so we can list the possible local storage pools that a volume in a shared pool might be able to be migrated to\n-        DiskProfile diskProfile = new DiskProfile(volume, diskOffering, profile.getHypervisorType());\n+        DiskProfile diskProfile = new DiskProfile(volume, diskOffering, type);\n         diskProfile.setUseLocalStorage(true);\n \n         for (StoragePoolAllocator allocator : _storagePoolAllocators) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/server/ManagementServerImpl.java",
                "sha": "d54e84fd6d201929a13818d1ecbf7c0d81bd43fb",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/storage/StorageManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/storage/StorageManagerImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 1,
                "filename": "server/src/main/java/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -522,7 +522,12 @@ public boolean configure(String name, Map<String, Object> params) {\n \n     @Override\n     public String getStoragePoolTags(long poolId) {\n-        return com.cloud.utils.StringUtils.listToCsvTags(_storagePoolDao.searchForStoragePoolTags(poolId));\n+        return StringUtils.listToCsvTags(getStoragePoolTagList(poolId));\n+    }\n+\n+    @Override\n+    public List<String> getStoragePoolTagList(long poolId) {\n+        return _storagePoolDao.searchForStoragePoolTags(poolId);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/storage/StorageManagerImpl.java",
                "sha": "1f704eb8aec0abf05bef86ab868b23c39b02a422",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 5,
                "filename": "server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -56,6 +56,7 @@\n import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService.VolumeApiResult;\n import org.apache.cloudstack.framework.async.AsyncCallFuture;\n import org.apache.cloudstack.framework.config.ConfigKey;\n+import org.apache.cloudstack.framework.config.Configurable;\n import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n import org.apache.cloudstack.framework.jobs.AsyncJob;\n import org.apache.cloudstack.framework.jobs.AsyncJobExecutionContext;\n@@ -178,7 +179,7 @@\n import com.google.gson.GsonBuilder;\n import com.google.gson.JsonParseException;\n \n-public class VolumeApiServiceImpl extends ManagerBase implements VolumeApiService, VmWorkJobHandler {\n+public class VolumeApiServiceImpl extends ManagerBase implements VolumeApiService, VmWorkJobHandler, Configurable {\n     private final static Logger s_logger = Logger.getLogger(VolumeApiServiceImpl.class);\n     public static final String VM_WORK_JOB_HANDLER = VolumeApiServiceImpl.class.getSimpleName();\n \n@@ -2028,10 +2029,12 @@ public Volume migrateVolume(MigrateVolumeCmd cmd) {\n         }\n \n         // Check that Vm to which this volume is attached does not have VM Snapshots\n+        // OfflineVmwareMigration: considder if this is needed and desirable\n         if (vm != null && _vmSnapshotDao.findByVm(vm.getId()).size() > 0) {\n             throw new InvalidParameterValueException(\"Volume cannot be migrated, please remove all VM snapshots for VM to which this volume is attached\");\n         }\n \n+        // OfflineVmwareMigration: extract this block as method and check if it is subject to regression\n         if (vm != null && vm.getState() == State.Running) {\n             // Check if the VM is GPU enabled.\n             if (_serviceOfferingDetailsDao.findDetail(vm.getServiceOfferingId(), GPU.Keys.pciDevice.toString()) != null) {\n@@ -2073,6 +2076,16 @@ public Volume migrateVolume(MigrateVolumeCmd cmd) {\n             throw new CloudRuntimeException(\"Storage pool \" + destPool.getName() + \" does not have enough space to migrate volume \" + vol.getName());\n         }\n \n+        // OfflineVmwareMigration: check storage tags on disk(offering)s in comparison to destination storage pool\n+        // OfflineVmwareMigration: if no match return a proper error now\n+        DiskOfferingVO diskOffering = _diskOfferingDao.findById(vol.getDiskOfferingId());\n+        if(diskOffering.equals(null)) {\n+            throw new CloudRuntimeException(\"volume '\" + vol.getUuid() +\"', has no diskoffering. Migration target cannot be checked.\");\n+        }\n+        if(! doesTargetStorageSupportDiskOffering(destPool, diskOffering)) {\n+            throw new CloudRuntimeException(\"Migration target has no matching tags for volume '\" +vol.getName() + \"(\" + vol.getUuid() + \")'\");\n+        }\n+\n         if (liveMigrateVolume && destPool.getClusterId() != null && srcClusterId != null) {\n             if (!srcClusterId.equals(destPool.getClusterId())) {\n                 throw new InvalidParameterValueException(\"Cannot migrate a volume of a virtual machine to a storage pool in a different cluster\");\n@@ -2191,7 +2204,7 @@ protected void validateConditionsToReplaceDiskOfferingOfVolume(VolumeVO volume,\n         if ((destPool.isShared() && newDiskOffering.isUseLocalStorage()) || destPool.isLocal() && newDiskOffering.isShared()) {\n             throw new InvalidParameterValueException(\"You cannot move the volume to a shared storage and assing a disk offering for local storage and vice versa.\");\n         }\n-        if (!doesTargetStorageSupportNewDiskOffering(destPool, newDiskOffering)) {\n+        if (!doesTargetStorageSupportDiskOffering(destPool, newDiskOffering)) {\n             throw new InvalidParameterValueException(String.format(\"Target Storage [id=%s] tags [%s] does not match new disk offering [id=%s] tags [%s].\", destPool.getUuid(),\n                     getStoragePoolTags(destPool), newDiskOffering.getUuid(), newDiskOffering.getTags()));\n         }\n@@ -2236,9 +2249,9 @@ protected void validateConditionsToReplaceDiskOfferingOfVolume(VolumeVO volume,\n      *      </body>\n      *   </table>\n      */\n-    protected boolean doesTargetStorageSupportNewDiskOffering(StoragePool destPool, DiskOfferingVO newDiskOffering) {\n-        String newDiskOfferingTags = newDiskOffering.getTags();\n-        return doesTargetStorageSupportDiskOffering(destPool, newDiskOfferingTags);\n+    protected boolean doesTargetStorageSupportDiskOffering(StoragePool destPool, DiskOfferingVO diskOffering) {\n+        String targetStoreTags = diskOffering.getTags();\n+        return doesTargetStorageSupportDiskOffering(destPool, targetStoreTags);\n     }\n \n     @Override\n@@ -3350,4 +3363,13 @@ private VmWorkJobVO createPlaceHolderWork(long instanceId) {\n         return workJob;\n     }\n \n+    @Override\n+    public String getConfigComponentName() {\n+        return VolumeApiService.class.getSimpleName();\n+    }\n+\n+    @Override\n+    public ConfigKey<?>[] getConfigKeys() {\n+        return new ConfigKey<?>[] {ConcurrentMigrationsThresholdPerDatastore};\n+    }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "23b56e98da389ad1e9beb7e87976f0c2649574a3",
                "status": "modified"
            },
            {
                "additions": 31,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 8,
                "filename": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -5065,19 +5065,33 @@ public VirtualMachine vmStorageMigration(Long vmId, StoragePool destPool) {\n         }\n \n         if (vm.getType() != VirtualMachine.Type.User) {\n+            // OffLineVmwareMigration: *WHY* ?\n             throw new InvalidParameterValueException(\"can only do storage migration on user vm\");\n         }\n \n         List<VolumeVO> vols = _volsDao.findByInstance(vm.getId());\n         if (vols.size() > 1) {\n-            throw new InvalidParameterValueException(\"Data disks attached to the vm, can not migrate. Need to detach data disks first\");\n+            // OffLineVmwareMigration: data disks are not permitted, here!\n+            if (vols.size() > 1 &&\n+                    // OffLineVmwareMigration: allow multiple disks for vmware\n+                    !HypervisorType.VMware.equals(vm.getHypervisorType())) {\n+                throw new InvalidParameterValueException(\"Data disks attached to the vm, can not migrate. Need to detach data disks first\");\n+            }\n         }\n \n         // Check that Vm does not have VM Snapshots\n         if (_vmSnapshotDao.findByVm(vmId).size() > 0) {\n             throw new InvalidParameterValueException(\"VM's disk cannot be migrated, please remove all the VM Snapshots for this VM\");\n         }\n \n+        checkDestinationHypervisorType(destPool, vm);\n+\n+        _itMgr.storageMigration(vm.getUuid(), destPool);\n+        return _vmDao.findById(vm.getId());\n+\n+    }\n+\n+    private void checkDestinationHypervisorType(StoragePool destPool, VMInstanceVO vm) {\n         HypervisorType destHypervisorType = destPool.getHypervisor();\n         if (destHypervisorType == null) {\n             destHypervisorType = _clusterDao.findById(\n@@ -5087,8 +5101,6 @@ public VirtualMachine vmStorageMigration(Long vmId, StoragePool destPool) {\n         if (vm.getHypervisorType() != destHypervisorType && destHypervisorType != HypervisorType.Any) {\n             throw new InvalidParameterValueException(\"hypervisor is not compatible: dest: \" + destHypervisorType.toString() + \", vm: \" + vm.getHypervisorType().toString());\n         }\n-        _itMgr.storageMigration(vm.getUuid(), destPool);\n-        return _vmDao.findById(vm.getId());\n \n     }\n \n@@ -5144,12 +5156,9 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Live Migration of GPU enabled VM is not supported\");\n         }\n \n-        if (!vm.getHypervisorType().equals(HypervisorType.XenServer) && !vm.getHypervisorType().equals(HypervisorType.VMware) && !vm.getHypervisorType().equals(HypervisorType.KVM)\n-                && !vm.getHypervisorType().equals(HypervisorType.Ovm) && !vm.getHypervisorType().equals(HypervisorType.Hyperv)\n-                && !vm.getHypervisorType().equals(HypervisorType.LXC) && !vm.getHypervisorType().equals(HypervisorType.Simulator)\n-                && !vm.getHypervisorType().equals(HypervisorType.Ovm3)) {\n+        if (!isOnSupportedHypevisorForMigration(vm)) {\n             if (s_logger.isDebugEnabled()) {\n-                s_logger.debug(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM.\");\n+                s_logger.debug(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n             }\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n@@ -5227,6 +5236,17 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n         }\n     }\n \n+    private boolean isOnSupportedHypevisorForMigration(VMInstanceVO vm) {\n+        return (vm.getHypervisorType().equals(HypervisorType.XenServer) ||\n+                vm.getHypervisorType().equals(HypervisorType.VMware) ||\n+                vm.getHypervisorType().equals(HypervisorType.KVM) ||\n+                vm.getHypervisorType().equals(HypervisorType.Ovm) ||\n+                vm.getHypervisorType().equals(HypervisorType.Hyperv) ||\n+                vm.getHypervisorType().equals(HypervisorType.LXC) ||\n+                vm.getHypervisorType().equals(HypervisorType.Simulator) ||\n+                vm.getHypervisorType().equals(HypervisorType.Ovm3));\n+    }\n+\n     private boolean checkIfHostIsDedicated(HostVO host) {\n         long hostId = host.getId();\n         DedicatedResourceVO dedicatedHost = _dedicatedDao.findByHostId(hostId);\n@@ -5469,7 +5489,9 @@ public VirtualMachine migrateVirtualMachineWithVolume(Long vmId, Host destinatio\n             throw new InvalidParameterValueException(\"Unable to find the vm by id \" + vmId);\n         }\n \n+        // OfflineVmwareMigration: this would be it ;) if multiple paths exist: unify\n         if (vm.getState() != State.Running) {\n+            // OfflineVmwareMigration: and not vmware\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"VM is not Running, unable to migrate the vm \" + vm);\n             }\n@@ -5482,6 +5504,7 @@ public VirtualMachine migrateVirtualMachineWithVolume(Long vmId, Host destinatio\n             throw new InvalidParameterValueException(\"Live Migration of GPU enabled VM is not supported\");\n         }\n \n+        // OfflineVmwareMigration: this condition is to complicated. (already a method somewhere)\n         if (!vm.getHypervisorType().equals(HypervisorType.XenServer) && !vm.getHypervisorType().equals(HypervisorType.VMware) && !vm.getHypervisorType().equals(HypervisorType.KVM)\n                 && !vm.getHypervisorType().equals(HypervisorType.Ovm) && !vm.getHypervisorType().equals(HypervisorType.Hyperv)\n                 && !vm.getHypervisorType().equals(HypervisorType.Simulator)) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "68b45e1af7c3b5c442bc0dc09dec1aeb5256a58d",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/test/java/com/cloud/storage/VolumeApiServiceImplTest.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/test/java/com/cloud/storage/VolumeApiServiceImplTest.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 7,
                "filename": "server/src/test/java/com/cloud/storage/VolumeApiServiceImplTest.java",
                "patch": "@@ -1004,7 +1004,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingMoreTagsThanStor\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"A\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertFalse(result);\n     }\n@@ -1017,7 +1017,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingTagsIsSubSetOfSt\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"A,B,C,D,X,Y\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertTrue(result);\n     }\n@@ -1030,7 +1030,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingTagsEmptyAndStor\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"A,B,C,D,X,Y\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertTrue(result);\n     }\n@@ -1043,7 +1043,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingTagsNotEmptyAndS\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertFalse(result);\n     }\n@@ -1056,7 +1056,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingTagsEmptyAndStor\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertTrue(result);\n     }\n@@ -1069,7 +1069,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingTagsDifferentFro\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"C,D\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertFalse(result);\n     }\n@@ -1082,7 +1082,7 @@ public void doesTargetStorageSupportDiskOfferingTestDiskOfferingTagsEqualsStorag\n         StoragePool storagePoolMock = Mockito.mock(StoragePool.class);\n         Mockito.doReturn(\"A\").when(volumeApiServiceImpl).getStoragePoolTags(storagePoolMock);\n \n-        boolean result = volumeApiServiceImpl.doesTargetStorageSupportNewDiskOffering(storagePoolMock, diskOfferingVoMock);\n+        boolean result = volumeApiServiceImpl.doesTargetStorageSupportDiskOffering(storagePoolMock, diskOfferingVoMock);\n \n         Assert.assertTrue(result);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/server/src/test/java/com/cloud/storage/VolumeApiServiceImplTest.java",
                "sha": "693b437079ba479f47d2d14ed4e2611ffdd883c0",
                "status": "modified"
            },
            {
                "additions": 177,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/test/integration/smoke/test_primary_storage.py",
                "changes": 363,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_primary_storage.py?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 186,
                "filename": "test/integration/smoke/test_primary_storage.py",
                "patch": "@@ -16,21 +16,19 @@\n # under the License.\n \"\"\" BVT tests for Primary Storage\n \"\"\"\n-#Import Local Modules\n-import marvin\n+\n+# Import System modules\n+# Import Local Modules\n from marvin.cloudstackTestCase import *\n-from marvin.cloudstackAPI import *\n-from marvin.lib.utils import *\n from marvin.lib.base import *\n from marvin.lib.common import *\n-from nose.plugins.attrib import attr\n-import logging\n from marvin.lib.decoratorGenerators import skipTestIf\n+from marvin.lib.utils import *\n+from nose.plugins.attrib import attr\n \n-#Import System modules\n-import time\n _multiprocess_shared_ = True\n \n+\n class TestPrimaryStorageServices(cloudstackTestCase):\n \n     def setUp(self):\n@@ -49,54 +47,51 @@ def setUp(self):\n \n     def tearDown(self):\n         try:\n-            #Clean up, terminate the created templates\n+            # Clean up, terminate the created templates\n             cleanup_resources(self.apiclient, self.cleanup)\n \n         except Exception as e:\n             raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n         return\n \n-    @attr(tags = [\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_01_primary_storage_nfs(self):\n         \"\"\"Test primary storage pools - XEN, KVM, VMWare. Not Supported for hyperv\n         \"\"\"\n \n         if self.hypervisor.lower() in [\"hyperv\"]:\n             raise self.skipTest(\"NFS primary storage not supported for Hyper-V\")\n \n-\n         # Validate the following:\n         # 1. List Clusters\n         # 2. verify that the cluster is in 'Enabled' allocation state\n         # 3. verify that the host is added successfully and\n         #    in Up state with listHosts api response\n \n-        #Create NFS storage pools with on XEN/KVM/VMWare clusters\n-\n+        # Create NFS storage pools with on XEN/KVM/VMWare clusters\n \n         clusters = list_clusters(\n             self.apiclient,\n             zoneid=self.zone.id\n         )\n-        assert isinstance(clusters,list) and len(clusters)>0\n+        assert isinstance(clusters, list) and len(clusters) > 0\n         for cluster in clusters:\n-\n-            #Host should be present before adding primary storage\n+            # Host should be present before adding primary storage\n             list_hosts_response = list_hosts(\n-                                             self.apiclient,\n-                                             clusterid=cluster.id\n-                                             )\n+                self.apiclient,\n+                clusterid=cluster.id\n+            )\n             self.assertEqual(\n-                            isinstance(list_hosts_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+                isinstance(list_hosts_response, list),\n+                True,\n+                \"Check list response returns a valid list\"\n+            )\n \n             self.assertNotEqual(\n-                        len(list_hosts_response),\n-                        0,\n-                        \"Check list Hosts in the cluster: \" + cluster.name\n-                        )\n+                len(list_hosts_response),\n+                0,\n+                \"Check list Hosts in the cluster: \" + cluster.name\n+            )\n \n             storage = StoragePool.create(self.apiclient,\n                                          self.services[\"nfs\"],\n@@ -112,53 +107,52 @@ def test_01_primary_storage_nfs(self):\n                 storage.state,\n                 'Up',\n                 \"Check primary storage state \"\n-                )\n+            )\n \n             self.assertEqual(\n                 storage.type,\n                 'NetworkFilesystem',\n                 \"Check storage pool type \"\n-                )\n+            )\n \n-            #Verify List Storage pool Response has newly added storage pool\n+            # Verify List Storage pool Response has newly added storage pool\n             storage_pools_response = list_storage_pools(\n-                                                        self.apiclient,\n-                                                        id=storage.id,\n-                                                        )\n+                self.apiclient,\n+                id=storage.id,\n+            )\n             self.assertEqual(\n-                            isinstance(storage_pools_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+                isinstance(storage_pools_response, list),\n+                True,\n+                \"Check list response returns a valid list\"\n+            )\n             self.assertNotEqual(\n-                            len(storage_pools_response),\n-                            0,\n-                            \"Check list Hosts response\"\n-                        )\n+                len(storage_pools_response),\n+                0,\n+                \"Check list Hosts response\"\n+            )\n \n             storage_response = storage_pools_response[0]\n             self.assertEqual(\n-                    storage_response.id,\n-                    storage.id,\n-                    \"Check storage pool ID\"\n-                    )\n+                storage_response.id,\n+                storage.id,\n+                \"Check storage pool ID\"\n+            )\n             self.assertEqual(\n-                    storage.type,\n-                    storage_response.type,\n-                    \"Check storage pool type \"\n-                )\n+                storage.type,\n+                storage_response.type,\n+                \"Check storage pool type \"\n+            )\n             # Call cleanup for reusing primary storage\n             cleanup_resources(self.apiclient, self.cleanup)\n             self.cleanup = []\n             return\n \n-\n-    @attr(tags = [\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"true\")\n+    @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"true\")\n     def test_01_primary_storage_iscsi(self):\n         \"\"\"Test primary storage pools - XEN. Not Supported for kvm,hyperv,vmware\n         \"\"\"\n \n-        if self.hypervisor.lower() in [\"kvm\",\"hyperv\", \"vmware\", \"lxc\"]:\n+        if self.hypervisor.lower() in [\"kvm\", \"hyperv\", \"vmware\", \"lxc\"]:\n             raise self.skipTest(\"iscsi primary storage not supported on kvm, VMWare, Hyper-V, or LXC\")\n \n         if not self.services[\"configurableData\"][\"iscsi\"][\"url\"]:\n@@ -175,26 +169,24 @@ def test_01_primary_storage_iscsi(self):\n             self.apiclient,\n             zoneid=self.zone.id\n         )\n-        assert isinstance(clusters,list) and len(clusters)>0\n+        assert isinstance(clusters, list) and len(clusters) > 0\n         for cluster in clusters:\n-\n-            #Host should be present before adding primary storage\n+            # Host should be present before adding primary storage\n             list_hosts_response = list_hosts(\n-                                             self.apiclient,\n-                                             clusterid=cluster.id\n-                                             )\n+                self.apiclient,\n+                clusterid=cluster.id\n+            )\n             self.assertEqual(\n-                            isinstance(list_hosts_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+                isinstance(list_hosts_response, list),\n+                True,\n+                \"Check list response returns a valid list\"\n+            )\n \n             self.assertNotEqual(\n-                        len(list_hosts_response),\n-                        0,\n-                        \"Check list Hosts in the cluster: \" + cluster.name\n-                        )\n-\n+                len(list_hosts_response),\n+                0,\n+                \"Check list Hosts in the cluster: \" + cluster.name\n+            )\n \n             storage = StoragePool.create(self.apiclient,\n                                          self.services[\"configurableData\"][\"iscsi\"],\n@@ -210,99 +202,97 @@ def test_01_primary_storage_iscsi(self):\n                 storage.state,\n                 'Up',\n                 \"Check primary storage state \"\n-                )\n+            )\n \n             self.assertEqual(\n                 storage.type,\n                 'IscsiLUN',\n                 \"Check storage pool type \"\n-                )\n+            )\n \n-            #Verify List Storage pool Response has newly added storage pool\n+            # Verify List Storage pool Response has newly added storage pool\n             storage_pools_response = list_storage_pools(\n-                                                        self.apiclient,\n-                                                        id=storage.id,\n-                                                        )\n+                self.apiclient,\n+                id=storage.id,\n+            )\n             self.assertEqual(\n-                            isinstance(storage_pools_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+                isinstance(storage_pools_response, list),\n+                True,\n+                \"Check list response returns a valid list\"\n+            )\n             self.assertNotEqual(\n-                            len(storage_pools_response),\n-                            0,\n-                            \"Check list Hosts response\"\n-                        )\n+                len(storage_pools_response),\n+                0,\n+                \"Check list Hosts response\"\n+            )\n \n             storage_response = storage_pools_response[0]\n             self.assertEqual(\n-                    storage_response.id,\n-                    storage.id,\n-                    \"Check storage pool ID\"\n-                    )\n+                storage_response.id,\n+                storage.id,\n+                \"Check storage pool ID\"\n+            )\n             self.assertEqual(\n-                    storage.type,\n-                    storage_response.type,\n-                    \"Check storage pool type \"\n-                )\n+                storage.type,\n+                storage_response.type,\n+                \"Check storage pool type \"\n+            )\n             # Call cleanup for reusing primary storage\n             cleanup_resources(self.apiclient, self.cleanup)\n             self.cleanup = []\n \n         return\n \n-    @attr(tags = [\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_01_add_primary_storage_disabled_host(self):\n         \"\"\"Test add primary storage pool with disabled host\n         \"\"\"\n \n-        #Disable a host\n+        # Disable a host\n         clusters = list_clusters(\n             self.apiclient,\n             zoneid=self.zone.id\n         )\n-        assert isinstance(clusters,list) and len(clusters)>0\n+        assert isinstance(clusters, list) and len(clusters) > 0\n         for cluster in clusters:\n \n             list_hosts_response = list_hosts(\n                 self.apiclient,\n                 clusterid=cluster.id,\n                 type=\"Routing\"\n             )\n-            assert isinstance(list_hosts_response,list)\n+            assert isinstance(list_hosts_response, list)\n             if len(list_hosts_response) < 2:\n                 continue\n             selected_cluster = cluster\n             selected_host = list_hosts_response[0]\n             Host.update(self.apiclient, id=selected_host.id, allocationstate=\"Disable\")\n \n-\n-            #create a pool\n+            # create a pool\n             storage_pool_2 = StoragePool.create(\n                 self.apiclient,\n                 self.services[\"nfs2\"],\n                 clusterid=selected_cluster.id,\n                 zoneid=self.zone.id,\n                 podid=self.pod.id\n             )\n-            #self.cleanup.append(storage_pool_2)\n+            # self.cleanup.append(storage_pool_2)\n \n-            #Enable host and disable others\n+            # Enable host and disable others\n             Host.update(self.apiclient, id=selected_host.id, allocationstate=\"Enable\")\n-            for host in list_hosts_response :\n-                if(host.id == selected_host.id) :\n+            for host in list_hosts_response:\n+                if (host.id == selected_host.id):\n                     continue\n                 Host.update(self.apiclient, id=host.id, allocationstate=\"Disable\")\n \n-\n-            #put other pools in maintenance\n-            storage_pool_list = StoragePool.list(self.apiclient, zoneid = self.zone.id)\n-            for pool in storage_pool_list :\n-                if(pool.id == storage_pool_2.id) :\n+            # put other pools in maintenance\n+            storage_pool_list = StoragePool.list(self.apiclient, zoneid=self.zone.id)\n+            for pool in storage_pool_list:\n+                if (pool.id == storage_pool_2.id):\n                     continue\n-                StoragePool.update(self.apiclient,id=pool.id, enabled=False)\n+                StoragePool.update(self.apiclient, id=pool.id, enabled=False)\n \n-            #deployvm\n+            # deployvm\n             try:\n                 # Create Account\n                 account = Account.create(\n@@ -329,20 +319,20 @@ def test_01_add_primary_storage_disabled_host(self):\n                 self.cleanup.append(self.virtual_machine)\n                 self.cleanup.append(account)\n             finally:\n-                #cancel maintenance\n-                for pool in storage_pool_list :\n-                    if(pool.id == storage_pool_2.id) :\n+                # cancel maintenance\n+                for pool in storage_pool_list:\n+                    if (pool.id == storage_pool_2.id):\n                         continue\n-                    StoragePool.update(self.apiclient,id=pool.id, enabled=True)\n-                #Enable all hosts\n-                for host in list_hosts_response :\n-                    if(host.id == selected_host.id) :\n+                    StoragePool.update(self.apiclient, id=pool.id, enabled=True)\n+                # Enable all hosts\n+                for host in list_hosts_response:\n+                    if (host.id == selected_host.id):\n                         continue\n                     Host.update(self.apiclient, id=host.id, allocationstate=\"Enable\")\n \n                 cleanup_resources(self.apiclient, self.cleanup)\n                 self.cleanup = []\n-                StoragePool.enableMaintenance(self.apiclient,storage_pool_2.id)\n+                StoragePool.enableMaintenance(self.apiclient, storage_pool_2.id)\n                 time.sleep(30);\n                 cmd = deleteStoragePool.deleteStoragePoolCmd()\n                 cmd.id = storage_pool_2.id\n@@ -355,21 +345,23 @@ def test_01_add_primary_storage_disabled_host(self):\n class StorageTagsServices:\n     \"\"\"Test Storage Tags Data Class.\n     \"\"\"\n+\n     def __init__(self):\n         self.storage_tags = {\n-            \"a\" : \"NFS-A\",\n-            \"b\" : \"NFS-B\"\n+            \"a\": \"NFS-A\",\n+            \"b\": \"NFS-B\"\n         }\n-    \n+\n+\n class TestStorageTags(cloudstackTestCase):\n-    \n+\n     @classmethod\n     def setUpClass(cls):\n         cls.logger = logging.getLogger('TestStorageTags')\n         cls.stream_handler = logging.StreamHandler()\n         cls.logger.setLevel(logging.DEBUG)\n         cls.logger.addHandler(cls.stream_handler)\n-        \n+\n         test_case = super(TestStorageTags, cls)\n         testClient = test_case.getClsTestClient()\n         cls.config = test_case.getClsConfig()\n@@ -383,36 +375,35 @@ def setUpClass(cls):\n         cls.services[\"virtual_machine\"][\"zoneid\"] = cls.zone.id\n         cls.services[\"virtual_machine\"][\"template\"] = cls.template.id\n         cls.services[\"storage_tags\"] = StorageTagsServices().storage_tags\n-        \n+\n         cls.hypervisorNotSupported = False\n         if cls.hypervisor.lower() in [\"hyperv\"]:\n             cls.hypervisorNotSupported = True\n         cls._cleanup = []\n-        \n+\n         if not cls.hypervisorNotSupported:\n-            \n             cls.clusters = list_clusters(\n                 cls.apiclient,\n                 zoneid=cls.zone.id\n             )\n             assert isinstance(cls.clusters, list) and len(cls.clusters) > 0\n-    \n+\n             # Create PS with Storage Tag\n             cls.storage_pool_1 = StoragePool.create(cls.apiclient,\n-                                         cls.services[\"nfs\"],\n-                                         clusterid=cls.clusters[0].id,\n-                                         zoneid=cls.zone.id,\n-                                         podid=cls.pod.id,\n-                                         tags=cls.services[\"storage_tags\"][\"a\"]\n-            )\n-            #PS not appended to _cleanup, it is removed on tearDownClass before cleaning up resources\n+                                                    cls.services[\"nfs\"],\n+                                                    clusterid=cls.clusters[0].id,\n+                                                    zoneid=cls.zone.id,\n+                                                    podid=cls.pod.id,\n+                                                    tags=cls.services[\"storage_tags\"][\"a\"]\n+                                                    )\n+            # PS not appended to _cleanup, it is removed on tearDownClass before cleaning up resources\n             assert cls.storage_pool_1.state == 'Up'\n             storage_pools_response = list_storage_pools(cls.apiclient,\n                                                         id=cls.storage_pool_1.id)\n             assert isinstance(storage_pools_response, list) and len(storage_pools_response) > 0\n             storage_response = storage_pools_response[0]\n             assert storage_response.id == cls.storage_pool_1.id and storage_response.type == cls.storage_pool_1.type\n-            \n+\n             # Create Service Offerings with different Storage Tags\n             cls.service_offering_1 = ServiceOffering.create(\n                 cls.apiclient,\n@@ -426,7 +417,7 @@ def setUpClass(cls):\n                 tags=cls.services[\"storage_tags\"][\"b\"]\n             )\n             cls._cleanup.append(cls.service_offering_2)\n-            \n+\n             # Create Disk Offerings with different Storage Tags\n             cls.disk_offering_1 = DiskOffering.create(\n                 cls.apiclient,\n@@ -440,15 +431,15 @@ def setUpClass(cls):\n                 tags=cls.services[\"storage_tags\"][\"b\"]\n             )\n             cls._cleanup.append(cls.disk_offering_2)\n-            \n+\n             # Create Account\n             cls.account = Account.create(\n                 cls.apiclient,\n                 cls.services[\"account\"],\n                 domainid=cls.domain.id\n             )\n             cls._cleanup.append(cls.account)\n-            \n+\n             # Create VM-1 with using Service Offering 1\n             cls.virtual_machine_1 = VirtualMachine.create(\n                 cls.apiclient,\n@@ -461,9 +452,9 @@ def setUpClass(cls):\n                 mode=cls.zone.networktype\n             )\n             # VM-1 not appended to _cleanup, it is expunged on tearDownClass before cleaning up resources\n-            \n+\n         return\n-    \n+\n     @classmethod\n     def tearDownClass(cls):\n         try:\n@@ -484,7 +475,7 @@ def tearDownClass(cls):\n             cleanup_resources(cls.apiclient, cls._cleanup)\n         except Exception as e:\n             raise Exception(\"Cleanup failed with %s\" % e)\n-    \n+\n     def setUp(self):\n         self.dbclient = self.testClient.getDbConnection()\n         self.cleanup = []\n@@ -495,16 +486,16 @@ def tearDown(self):\n             cleanup_resources(self.apiclient, self.cleanup)\n         except Exception as e:\n             raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n-    \n+\n     @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     @skipTestIf(\"hypervisorNotSupported\")\n     def test_01_deploy_vms_storage_tags(self):\n         \"\"\"Test Deploy VMS using different Service Offerings with Storage Tags\n         \"\"\"\n-        \n+\n         # Save cleanup size before trying to deploy VM-2\n         cleanup_size = len(self.cleanup)\n-        \n+\n         # Try deploying VM-2 using CO-2 -> Should fail to find storage and fail deployment\n         try:\n             self.virtual_machine_2 = VirtualMachine.create(\n@@ -519,32 +510,32 @@ def test_01_deploy_vms_storage_tags(self):\n             self.cleanup.append(self.virtual_machine_2)\n         except Exception as e:\n             self.debug(\"Expected exception %s: \" % e)\n-        \n+\n         self.debug(\"Asssert that vm2 was not deployed, so it couldn't be appended to cleanup\")\n         self.assertEquals(cleanup_size, len(self.cleanup))\n-        \n+\n         # Create V-1 using DO-1\n         self.volume_1 = Volume.create(\n-           self.apiclient,\n-           self.services,\n-           zoneid=self.zone.id,\n-           account=self.account.name,\n-           domainid=self.account.domainid,\n-           diskofferingid=self.disk_offering_1.id\n+            self.apiclient,\n+            self.services,\n+            zoneid=self.zone.id,\n+            account=self.account.name,\n+            domainid=self.account.domainid,\n+            diskofferingid=self.disk_offering_1.id\n         )\n         self.cleanup.append(self.volume_1)\n-        \n+\n         # Create V-2 using DO-2\n         self.volume_2 = Volume.create(\n-           self.apiclient,\n-           self.services,\n-           zoneid=self.zone.id,\n-           account=self.account.name,\n-           domainid=self.account.domainid,\n-           diskofferingid=self.disk_offering_2.id\n+            self.apiclient,\n+            self.services,\n+            zoneid=self.zone.id,\n+            account=self.account.name,\n+            domainid=self.account.domainid,\n+            diskofferingid=self.disk_offering_2.id\n         )\n         self.cleanup.append(self.volume_2)\n-        \n+\n         # Try attaching V-2 to VM-1 -> Should fail finding storage and fail attachment\n         try:\n             self.virtual_machine_1.attach_volume(\n@@ -553,7 +544,7 @@ def test_01_deploy_vms_storage_tags(self):\n             )\n         except Exception as e:\n             self.debug(\"Expected exception %s: \" % e)\n-        \n+\n         vm_1_volumes = Volume.list(\n             self.apiclient,\n             virtualmachineid=self.virtual_machine_1.id,\n@@ -562,9 +553,9 @@ def test_01_deploy_vms_storage_tags(self):\n         )\n         self.debug(\"VM-1 Volumes: %s\" % vm_1_volumes)\n         self.assertEquals(None, vm_1_volumes, \"Check that volume V-2 has not been attached to VM-1\")\n-        \n+\n         # Attach V_1 to VM_1\n-        self.virtual_machine_1.attach_volume(self.apiclient,self.volume_1)\n+        self.virtual_machine_1.attach_volume(self.apiclient, self.volume_1)\n         vm_1_volumes = Volume.list(\n             self.apiclient,\n             virtualmachineid=self.virtual_machine_1.id,\n@@ -574,74 +565,74 @@ def test_01_deploy_vms_storage_tags(self):\n         self.debug(\"VM-1 Volumes: %s\" % vm_1_volumes)\n         self.assertEquals(vm_1_volumes[0].id, self.volume_1.id, \"Check that volume V-1 has been attached to VM-1\")\n         self.virtual_machine_1.detach_volume(self.apiclient, self.volume_1)\n-        \n+\n         return\n-    \n+\n     def check_storage_pool_tag(self, poolid, tag):\n         cmd = listStorageTags.listStorageTagsCmd()\n         storage_tags_response = self.apiclient.listStorageTags(cmd)\n         pool_tags = filter(lambda x: x.poolid == poolid, storage_tags_response)\n         self.assertEquals(1, len(pool_tags), \"Check storage tags size\")\n         self.assertEquals(tag, pool_tags[0].name, \"Check storage tag on storage pool\")\n-    \n+\n     @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     @skipTestIf(\"hypervisorNotSupported\")\n     def test_02_edit_primary_storage_tags(self):\n         \"\"\" Test Edit Storage Tags\n         \"\"\"\n-        \n+\n         qresultset = self.dbclient.execute(\n             \"select id from storage_pool where uuid = '%s';\"\n             % str(self.storage_pool_1.id)\n         )\n         self.assertEquals(1, len(qresultset), \"Check DB Query result set\")\n         qresult = qresultset[0]\n         storage_pool_db_id = qresult[0]\n-        \n+\n         self.check_storage_pool_tag(storage_pool_db_id, self.services[\"storage_tags\"][\"a\"])\n-        \n+\n         # Update Storage Tag\n         StoragePool.update(\n             self.apiclient,\n             id=self.storage_pool_1.id,\n             tags=self.services[\"storage_tags\"][\"b\"]\n         )\n-        \n+\n         self.check_storage_pool_tag(storage_pool_db_id, self.services[\"storage_tags\"][\"b\"])\n-        \n+\n         # Revert Storage Tag\n         StoragePool.update(\n             self.apiclient,\n             id=self.storage_pool_1.id,\n             tags=self.services[\"storage_tags\"][\"a\"]\n         )\n-        \n+\n         self.check_storage_pool_tag(storage_pool_db_id, self.services[\"storage_tags\"][\"a\"])\n-        \n+\n         return\n-    \n+\n     @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     @skipTestIf(\"hypervisorNotSupported\")\n     def test_03_migration_options_storage_tags(self):\n         \"\"\" Test Volume migration options for Storage Pools with different Storage Tags\n         \"\"\"\n-        \n+\n         # Create PS-2 using Storage Tag\n         storage_pool_2 = StoragePool.create(self.apiclient,\n-                                             self.services[\"nfs2\"],\n-                                             clusterid=self.clusters[0].id,\n-                                             zoneid=self.zone.id,\n-                                             podid=self.pod.id,\n-                                             tags=self.services[\"storage_tags\"][\"a\"]\n-        )\n+                                            self.services[\"nfs2\"],\n+                                            clusterid=self.clusters[0].id,\n+                                            zoneid=self.zone.id,\n+                                            podid=self.pod.id,\n+                                            tags=self.services[\"storage_tags\"][\"a\"]\n+                                            )\n         self.cleanup.append(storage_pool_2)\n         assert storage_pool_2.state == 'Up'\n         storage_pools_response = list_storage_pools(self.apiclient,\n                                                     id=storage_pool_2.id)\n         assert isinstance(storage_pools_response, list) and len(storage_pools_response) > 0\n         storage_response = storage_pools_response[0]\n         assert storage_response.id == storage_pool_2.id and storage_response.type == storage_pool_2.type\n-        \n+\n         vm_1_volumes = Volume.list(\n             self.apiclient,\n             virtualmachineid=self.virtual_machine_1.id,\n@@ -667,27 +658,27 @@ def test_03_migration_options_storage_tags(self):\n             self.apiclient,\n             id=vol.id\n         )\n-        pools_suitable = filter(lambda p : p.suitableformigration, pools_response)\n-        \n+        pools_suitable = filter(lambda p: p.suitableformigration, pools_response)\n+\n         self.debug(\"Suitable storage pools found: %s\" % len(pools_suitable))\n         self.assertEquals(1, len(pools_suitable), \"Check that there is only one item on the list\")\n         self.assertEquals(pools_suitable[0].id, storage_pool_2.id, \"Check that PS-2 is the migration option for volume\")\n-        \n+\n         # Update PS-2 Storage Tags\n         StoragePool.update(\n             self.apiclient,\n             id=storage_pool_2.id,\n             tags=self.services[\"storage_tags\"][\"b\"]\n         )\n-        \n+\n         # Check migration options for volume after updating PS-2 Storage Tags\n         pools_response = StoragePool.listForMigration(\n             self.apiclient,\n             id=vol.id\n         )\n-        pools_suitable = filter(lambda p : p.suitableformigration, pools_response)\n-        \n+        pools_suitable = filter(lambda p: p.suitableformigration, pools_response)\n+\n         self.debug(\"Suitable storage pools found: %s\" % len(pools_suitable))\n         self.assertEquals(0, len(pools_suitable), \"Check that there is no migration option for volume\")\n-        \n-        return\n\\ No newline at end of file\n+\n+        return",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/test/integration/smoke/test_primary_storage.py",
                "sha": "d397c773b12ba5417428d8fb5e9f1e08a1053d31",
                "status": "modified"
            },
            {
                "additions": 473,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/test/integration/smoke/test_vm_life_cycle.py",
                "changes": 732,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_vm_life_cycle.py?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 259,
                "filename": "test/integration/smoke/test_vm_life_cycle.py",
                "patch": "@@ -16,36 +16,40 @@\n # under the License.\n \"\"\" BVT tests for Virtual Machine Life Cycle\n \"\"\"\n-#Import Local Modules\n+# Import Local Modules\n from marvin.cloudstackTestCase import cloudstackTestCase\n from marvin.cloudstackAPI import (recoverVirtualMachine,\n                                   destroyVirtualMachine,\n                                   attachIso,\n                                   detachIso,\n                                   provisionCertificate,\n-                                  updateConfiguration)\n-from marvin.lib.utils import *\n-\n+                                  updateConfiguration,\n+                                  migrateVirtualMachine)\n+from marvin.lib.utils import (cleanup_resources,\n+                              validateList,\n+                              SshClient)\n from marvin.lib.base import (Account,\n                              ServiceOffering,\n                              VirtualMachine,\n                              Host,\n                              Iso,\n                              Router,\n                              Configurations,\n+                             StoragePool,\n                              Volume,\n                              DiskOffering)\n from marvin.lib.common import (get_domain,\n-                                get_zone,\n-                                get_template,\n+                               get_zone,\n+                               get_template,\n                                list_hosts)\n from marvin.codes import FAILED, PASS\n from nose.plugins.attrib import attr\n-#Import System modules\n+# Import System modules\n import time\n-import re\n \n _multiprocess_shared_ = True\n+\n+\n class TestDeployVM(cloudstackTestCase):\n \n     @classmethod\n@@ -59,8 +63,8 @@ def setUpClass(cls):\n         cls.zone = get_zone(cls.apiclient, testClient.getZoneForTests())\n         cls.services['mode'] = cls.zone.networktype\n \n-        #If local storage is enabled, alter the offerings to use localstorage\n-        #this step is needed for devcloud\n+        # If local storage is enabled, alter the offerings to use localstorage\n+        # this step is needed for devcloud\n         if cls.zone.localstorageenabled == True:\n             cls.services[\"service_offerings\"][\"tiny\"][\"storagetype\"] = 'local'\n             cls.services[\"service_offerings\"][\"small\"][\"storagetype\"] = 'local'\n@@ -118,56 +122,54 @@ def setUp(self):\n         self.dbclient = self.testClient.getDbConnection()\n         self.cleanup = []\n \n-\n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_deploy_vm(self):\n         \"\"\"Test Deploy Virtual Machine\n         \"\"\"\n         # Validate the following:\n         # 1. Virtual Machine is accessible via SSH\n         # 2. listVirtualMachines returns accurate information\n         list_vm_response = VirtualMachine.list(\n-                                                 self.apiclient,\n-                                                 id=self.virtual_machine.id\n-                                                 )\n+            self.apiclient,\n+            id=self.virtual_machine.id\n+        )\n \n         self.debug(\n-                \"Verify listVirtualMachines response for virtual machine: %s\" \\\n-                % self.virtual_machine.id\n-            )\n+            \"Verify listVirtualMachines response for virtual machine: %s\" \\\n+            % self.virtual_machine.id\n+        )\n         self.assertEqual(\n-                            isinstance(list_vm_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(list_vm_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n         self.assertNotEqual(\n-                            len(list_vm_response),\n-                            0,\n-                            \"Check VM available in List Virtual Machines\"\n-                        )\n+            len(list_vm_response),\n+            0,\n+            \"Check VM available in List Virtual Machines\"\n+        )\n         vm_response = list_vm_response[0]\n         self.assertEqual(\n \n-                            vm_response.id,\n-                            self.virtual_machine.id,\n-                            \"Check virtual machine id in listVirtualMachines\"\n-                        )\n+            vm_response.id,\n+            self.virtual_machine.id,\n+            \"Check virtual machine id in listVirtualMachines\"\n+        )\n         self.assertEqual(\n-                    vm_response.name,\n-                    self.virtual_machine.name,\n-                    \"Check virtual machine name in listVirtualMachines\"\n-                    )\n+            vm_response.name,\n+            self.virtual_machine.name,\n+            \"Check virtual machine name in listVirtualMachines\"\n+        )\n         self.assertEqual(\n             vm_response.state,\n             'Running',\n-             msg=\"VM is not in Running state\"\n+            msg=\"VM is not in Running state\"\n         )\n         return\n \n-\n-    @attr(tags = [\"advanced\"], required_hardware=\"false\")\n+    @attr(tags=[\"advanced\"], required_hardware=\"false\")\n     def test_advZoneVirtualRouter(self):\n-        #TODO: SIMENH: duplicate test, remove it\n+        # TODO: SIMENH: duplicate test, remove it\n         \"\"\"\n         Test advanced zone virtual router\n         1. Is Running\n@@ -176,35 +178,34 @@ def test_advZoneVirtualRouter(self):\n         @return:\n         \"\"\"\n         routers = Router.list(self.apiclient, account=self.account.name)\n-        self.assertTrue(len(routers) > 0, msg = \"No virtual router found\")\n+        self.assertTrue(len(routers) > 0, msg=\"No virtual router found\")\n         router = routers[0]\n \n         self.assertEqual(router.state, 'Running', msg=\"Router is not in running state\")\n         self.assertEqual(router.account, self.account.name, msg=\"Router does not belong to the account\")\n \n-        #Has linklocal, public and guest ips\n+        # Has linklocal, public and guest ips\n         self.assertIsNotNone(router.linklocalip, msg=\"Router has no linklocal ip\")\n         self.assertIsNotNone(router.publicip, msg=\"Router has no public ip\")\n         self.assertIsNotNone(router.guestipaddress, msg=\"Router has no guest ip\")\n \n-\n-    @attr(mode = [\"basic\"], required_hardware=\"false\")\n+    @attr(mode=[\"basic\"], required_hardware=\"false\")\n     def test_basicZoneVirtualRouter(self):\n-        #TODO: SIMENH: duplicate test, remove it\n+        # TODO: SIMENH: duplicate test, remove it\n         \"\"\"\n         Tests for basic zone virtual router\n         1. Is Running\n         2. is in the account the VM was deployed in\n         @return:\n         \"\"\"\n         routers = Router.list(self.apiclient, account=self.account.name)\n-        self.assertTrue(len(routers) > 0, msg = \"No virtual router found\")\n+        self.assertTrue(len(routers) > 0, msg=\"No virtual router found\")\n         router = routers[0]\n \n         self.assertEqual(router.state, 'Running', msg=\"Router is not in running state\")\n         self.assertEqual(router.account, self.account.name, msg=\"Router does not belong to the account\")\n \n-    @attr(tags = ['advanced','basic','sg'], required_hardware=\"false\")\n+    @attr(tags=['advanced', 'basic', 'sg'], required_hardware=\"false\")\n     def test_deploy_vm_multiple(self):\n         \"\"\"Test Multiple Deploy Virtual Machine\n \n@@ -236,7 +237,8 @@ def test_deploy_vm_multiple(self):\n \n         list_vms = VirtualMachine.list(self.apiclient, ids=[virtual_machine1.id, virtual_machine2.id], listAll=True)\n         self.debug(\n-            \"Verify listVirtualMachines response for virtual machines: %s, %s\" % (virtual_machine1.id, virtual_machine2.id)\n+            \"Verify listVirtualMachines response for virtual machines: %s, %s\" % (\n+                virtual_machine1.id, virtual_machine2.id)\n         )\n         self.assertEqual(\n             isinstance(list_vms, list),\n@@ -271,18 +273,18 @@ def setUpClass(cls):\n         cls.zone = get_zone(cls.apiclient, cls.testClient.getZoneForTests())\n         cls.services['mode'] = cls.zone.networktype\n \n-        #if local storage is enabled, alter the offerings to use localstorage\n-        #this step is needed for devcloud\n+        # if local storage is enabled, alter the offerings to use localstorage\n+        # this step is needed for devcloud\n         if cls.zone.localstorageenabled == True:\n             cls.services[\"service_offerings\"][\"tiny\"][\"storagetype\"] = 'local'\n             cls.services[\"service_offerings\"][\"small\"][\"storagetype\"] = 'local'\n             cls.services[\"service_offerings\"][\"medium\"][\"storagetype\"] = 'local'\n \n         template = get_template(\n-                            cls.apiclient,\n-                            cls.zone.id,\n-                            cls.services[\"ostype\"]\n-                            )\n+            cls.apiclient,\n+            cls.zone.id,\n+            cls.services[\"ostype\"]\n+        )\n         if template == FAILED:\n             assert False, \"get_template() failed to return template with description %s\" % cls.services[\"ostype\"]\n \n@@ -294,50 +296,50 @@ def setUpClass(cls):\n \n         # Create VMs, NAT Rules etc\n         cls.account = Account.create(\n-                            cls.apiclient,\n-                            cls.services[\"account\"],\n-                            domainid=domain.id\n-                            )\n+            cls.apiclient,\n+            cls.services[\"account\"],\n+            domainid=domain.id\n+        )\n \n         cls.small_offering = ServiceOffering.create(\n-                                    cls.apiclient,\n-                                    cls.services[\"service_offerings\"][\"small\"]\n-                                    )\n+            cls.apiclient,\n+            cls.services[\"service_offerings\"][\"small\"]\n+        )\n \n         cls.medium_offering = ServiceOffering.create(\n-                                    cls.apiclient,\n-                                    cls.services[\"service_offerings\"][\"medium\"]\n-                                    )\n-        #create small and large virtual machines\n+            cls.apiclient,\n+            cls.services[\"service_offerings\"][\"medium\"]\n+        )\n+        # create small and large virtual machines\n         cls.small_virtual_machine = VirtualMachine.create(\n-                                        cls.apiclient,\n-                                        cls.services[\"small\"],\n-                                        accountid=cls.account.name,\n-                                        domainid=cls.account.domainid,\n-                                        serviceofferingid=cls.small_offering.id,\n-                                        mode=cls.services[\"mode\"]\n-                                        )\n+            cls.apiclient,\n+            cls.services[\"small\"],\n+            accountid=cls.account.name,\n+            domainid=cls.account.domainid,\n+            serviceofferingid=cls.small_offering.id,\n+            mode=cls.services[\"mode\"]\n+        )\n         cls.medium_virtual_machine = VirtualMachine.create(\n-                                       cls.apiclient,\n-                                       cls.services[\"small\"],\n-                                       accountid=cls.account.name,\n-                                       domainid=cls.account.domainid,\n-                                       serviceofferingid=cls.medium_offering.id,\n-                                       mode=cls.services[\"mode\"]\n-                                    )\n+            cls.apiclient,\n+            cls.services[\"small\"],\n+            accountid=cls.account.name,\n+            domainid=cls.account.domainid,\n+            serviceofferingid=cls.medium_offering.id,\n+            mode=cls.services[\"mode\"]\n+        )\n         cls.virtual_machine = VirtualMachine.create(\n-                                        cls.apiclient,\n-                                        cls.services[\"small\"],\n-                                        accountid=cls.account.name,\n-                                        domainid=cls.account.domainid,\n-                                        serviceofferingid=cls.small_offering.id,\n-                                        mode=cls.services[\"mode\"]\n-                                        )\n+            cls.apiclient,\n+            cls.services[\"small\"],\n+            accountid=cls.account.name,\n+            domainid=cls.account.domainid,\n+            serviceofferingid=cls.small_offering.id,\n+            mode=cls.services[\"mode\"]\n+        )\n         cls._cleanup = [\n-                        cls.small_offering,\n-                        cls.medium_offering,\n-                        cls.account\n-                        ]\n+            cls.small_offering,\n+            cls.medium_offering,\n+            cls.account\n+        ]\n \n     @classmethod\n     def tearDownClass(cls):\n@@ -355,14 +357,13 @@ def setUp(self):\n \n     def tearDown(self):\n         try:\n-            #Clean up, terminate the created ISOs\n+            # Clean up, terminate the created ISOs\n             cleanup_resources(self.apiclient, self.cleanup)\n         except Exception as e:\n             raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n         return\n \n-\n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_01_stop_vm(self):\n         \"\"\"Test Stop Virtual Machine\n         \"\"\"\n@@ -377,8 +378,7 @@ def test_01_stop_vm(self):\n             self.fail(\"Failed to stop VM: %s\" % e)\n         return\n \n-\n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_01_stop_vm_forced(self):\n         \"\"\"Test Force Stop Virtual Machine\n         \"\"\"\n@@ -388,30 +388,29 @@ def test_01_stop_vm_forced(self):\n             self.fail(\"Failed to stop VM: %s\" % e)\n \n         list_vm_response = VirtualMachine.list(\n-                                            self.apiclient,\n-                                            id=self.small_virtual_machine.id\n-                                            )\n+            self.apiclient,\n+            id=self.small_virtual_machine.id\n+        )\n         self.assertEqual(\n-                            isinstance(list_vm_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(list_vm_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n \n         self.assertNotEqual(\n-                            len(list_vm_response),\n-                            0,\n-                            \"Check VM avaliable in List Virtual Machines\"\n-                        )\n+            len(list_vm_response),\n+            0,\n+            \"Check VM avaliable in List Virtual Machines\"\n+        )\n \n         self.assertEqual(\n-                            list_vm_response[0].state,\n-                            \"Stopped\",\n-                            \"Check virtual machine is in stopped state\"\n-                        )\n+            list_vm_response[0].state,\n+            \"Stopped\",\n+            \"Check virtual machine is in stopped state\"\n+        )\n         return\n \n-\n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_02_start_vm(self):\n         \"\"\"Test Start Virtual Machine\n         \"\"\"\n@@ -423,33 +422,33 @@ def test_02_start_vm(self):\n         self.small_virtual_machine.start(self.apiclient)\n \n         list_vm_response = VirtualMachine.list(\n-                                            self.apiclient,\n-                                            id=self.small_virtual_machine.id\n-                                            )\n+            self.apiclient,\n+            id=self.small_virtual_machine.id\n+        )\n         self.assertEqual(\n-                            isinstance(list_vm_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(list_vm_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n \n         self.assertNotEqual(\n-                            len(list_vm_response),\n-                            0,\n-                            \"Check VM avaliable in List Virtual Machines\"\n-                        )\n+            len(list_vm_response),\n+            0,\n+            \"Check VM avaliable in List Virtual Machines\"\n+        )\n \n         self.debug(\n-                \"Verify listVirtualMachines response for virtual machine: %s\" \\\n-                % self.small_virtual_machine.id\n-                )\n+            \"Verify listVirtualMachines response for virtual machine: %s\" \\\n+            % self.small_virtual_machine.id\n+        )\n         self.assertEqual(\n-                            list_vm_response[0].state,\n-                            \"Running\",\n-                            \"Check virtual machine is in running state\"\n-                        )\n+            list_vm_response[0].state,\n+            \"Running\",\n+            \"Check virtual machine is in running state\"\n+        )\n         return\n \n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_03_reboot_vm(self):\n         \"\"\"Test Reboot Virtual Machine\n         \"\"\"\n@@ -463,30 +462,29 @@ def test_03_reboot_vm(self):\n         self.small_virtual_machine.reboot(self.apiclient)\n \n         list_vm_response = VirtualMachine.list(\n-                                            self.apiclient,\n-                                            id=self.small_virtual_machine.id\n-                                            )\n+            self.apiclient,\n+            id=self.small_virtual_machine.id\n+        )\n         self.assertEqual(\n-                            isinstance(list_vm_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(list_vm_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n \n         self.assertNotEqual(\n-                            len(list_vm_response),\n-                            0,\n-                            \"Check VM avaliable in List Virtual Machines\"\n-                        )\n+            len(list_vm_response),\n+            0,\n+            \"Check VM available in List Virtual Machines\"\n+        )\n \n         self.assertEqual(\n-                            list_vm_response[0].state,\n-                            \"Running\",\n-                            \"Check virtual machine is in running state\"\n-                        )\n+            list_vm_response[0].state,\n+            \"Running\",\n+            \"Check virtual machine is in running state\"\n+        )\n         return\n \n-\n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_06_destroy_vm(self):\n         \"\"\"Test destroy Virtual Machine\n         \"\"\"\n@@ -500,31 +498,31 @@ def test_06_destroy_vm(self):\n         self.small_virtual_machine.delete(self.apiclient, expunge=False)\n \n         list_vm_response = VirtualMachine.list(\n-                                            self.apiclient,\n-                                            id=self.small_virtual_machine.id\n-                                            )\n+            self.apiclient,\n+            id=self.small_virtual_machine.id\n+        )\n         self.assertEqual(\n-                            isinstance(list_vm_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(list_vm_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n \n         self.assertNotEqual(\n-                            len(list_vm_response),\n-                            0,\n-                            \"Check VM avaliable in List Virtual Machines\"\n-                        )\n+            len(list_vm_response),\n+            0,\n+            \"Check VM avaliable in List Virtual Machines\"\n+        )\n \n         self.assertEqual(\n-                            list_vm_response[0].state,\n-                            \"Destroyed\",\n-                            \"Check virtual machine is in destroyed state\"\n-                        )\n+            list_vm_response[0].state,\n+            \"Destroyed\",\n+            \"Check virtual machine is in destroyed state\"\n+        )\n         return\n \n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_07_restore_vm(self):\n-        #TODO: SIMENH: add another test the data on the restored VM.\n+        # TODO: SIMENH: add another test the data on the restored VM.\n         \"\"\"Test recover Virtual Machine\n         \"\"\"\n \n@@ -540,30 +538,30 @@ def test_07_restore_vm(self):\n         self.apiclient.recoverVirtualMachine(cmd)\n \n         list_vm_response = VirtualMachine.list(\n-                                            self.apiclient,\n-                                            id=self.small_virtual_machine.id\n-                                            )\n+            self.apiclient,\n+            id=self.small_virtual_machine.id\n+        )\n         self.assertEqual(\n-                            isinstance(list_vm_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(list_vm_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n \n         self.assertNotEqual(\n-                            len(list_vm_response),\n-                            0,\n-                            \"Check VM avaliable in List Virtual Machines\"\n-                        )\n+            len(list_vm_response),\n+            0,\n+            \"Check VM avaliable in List Virtual Machines\"\n+        )\n \n         self.assertEqual(\n-                            list_vm_response[0].state,\n-                            \"Stopped\",\n-                            \"Check virtual machine is in Stopped state\"\n-                        )\n+            list_vm_response[0].state,\n+            \"Stopped\",\n+            \"Check virtual machine is in Stopped state\"\n+        )\n \n         return\n \n-    @attr(tags = [\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\", \"multihost\"], required_hardware=\"false\")\n+    @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\", \"multihost\"], required_hardware=\"false\")\n     def test_08_migrate_vm(self):\n         \"\"\"Test migrate VM\n         \"\"\"\n@@ -591,10 +589,10 @@ def test_08_migrate_vm(self):\n         # For XenServer and VMware, migration is possible between hosts belonging to different clusters\n         # with the help of XenMotion and Vmotion respectively.\n \n-        if self.hypervisor.lower() in [\"kvm\",\"simulator\"]:\n-            #identify suitable host\n+        if self.hypervisor.lower() in [\"kvm\", \"simulator\"]:\n+            # identify suitable host\n             clusters = [h.clusterid for h in hosts]\n-            #find hosts withe same clusterid\n+            # find hosts withe same clusterid\n             clusters = [cluster for index, cluster in enumerate(clusters) if clusters.count(cluster) > 1]\n \n             if len(clusters) <= 1:\n@@ -607,8 +605,8 @@ def test_08_migrate_vm(self):\n         target_host = suitable_hosts[0]\n         migrate_host = suitable_hosts[1]\n \n-        #deploy VM on target host\n-        self.vm_to_migrate = VirtualMachine.create(\n+        # deploy VM on target host\n+        vm_to_migrate = VirtualMachine.create(\n             self.apiclient,\n             self.services[\"small\"],\n             accountid=self.account.name,\n@@ -618,30 +616,30 @@ def test_08_migrate_vm(self):\n             hostid=target_host.id\n         )\n         self.debug(\"Migrating VM-ID: %s to Host: %s\" % (\n-                                        self.vm_to_migrate.id,\n-                                        migrate_host.id\n-                                        ))\n+            vm_to_migrate.id,\n+            migrate_host.id\n+        ))\n \n-        self.vm_to_migrate.migrate(self.apiclient, migrate_host.id)\n+        vm_to_migrate.migrate(self.apiclient, migrate_host.id)\n \n         retries_cnt = 3\n-        while retries_cnt >=0:\n+        while retries_cnt >= 0:\n             list_vm_response = VirtualMachine.list(self.apiclient,\n-                                                   id=self.vm_to_migrate.id)\n+                                                   id=vm_to_migrate.id)\n             self.assertNotEqual(\n-                                list_vm_response,\n-                                None,\n-                                \"Check virtual machine is listed\"\n-                               )\n+                list_vm_response,\n+                None,\n+                \"Check virtual machine is listed\"\n+            )\n             vm_response = list_vm_response[0]\n-            self.assertEqual(vm_response.id,self.vm_to_migrate.id,\"Check virtual machine ID of migrated VM\")\n-            self.assertEqual(vm_response.hostid,migrate_host.id,\"Check destination hostID of migrated VM\")\n+            self.assertEqual(vm_response.id, vm_to_migrate.id, \"Check virtual machine ID of migrated VM\")\n+            self.assertEqual(vm_response.hostid, migrate_host.id, \"Check destination hostID of migrated VM\")\n             retries_cnt = retries_cnt - 1\n         return\n \n-    @attr(configuration = \"expunge.interval\")\n-    @attr(configuration = \"expunge.delay\")\n-    @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n+    @attr(configuration=\"expunge.interval\")\n+    @attr(configuration=\"expunge.delay\")\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n     def test_09_expunge_vm(self):\n         \"\"\"Test destroy(expunge) Virtual Machine\n         \"\"\"\n@@ -655,26 +653,26 @@ def test_09_expunge_vm(self):\n         self.apiclient.destroyVirtualMachine(cmd)\n \n         config = Configurations.list(\n-                                     self.apiclient,\n-                                     name='expunge.delay'\n-                                     )\n+            self.apiclient,\n+            name='expunge.delay'\n+        )\n \n         expunge_delay = int(config[0].value)\n         time.sleep(expunge_delay * 2)\n \n-        #VM should be destroyed unless expunge thread hasn't run\n-        #Wait for two cycles of the expunge thread\n+        # VM should be destroyed unless expunge thread hasn't run\n+        # Wait for two cycles of the expunge thread\n         config = Configurations.list(\n-                                     self.apiclient,\n-                                     name='expunge.interval'\n-                                     )\n+            self.apiclient,\n+            name='expunge.interval'\n+        )\n         expunge_cycle = int(config[0].value)\n         wait_time = expunge_cycle * 4\n         while wait_time >= 0:\n             list_vm_response = VirtualMachine.list(\n-                                                self.apiclient,\n-                                                id=self.small_virtual_machine.id\n-                                                )\n+                self.apiclient,\n+                id=self.small_virtual_machine.id\n+            )\n             if not list_vm_response:\n                 break\n             self.debug(\"Waiting for VM to expunge\")\n@@ -683,10 +681,10 @@ def test_09_expunge_vm(self):\n \n         self.debug(\"listVirtualMachines response: %s\" % list_vm_response)\n \n-        self.assertEqual(list_vm_response,None,\"Check Expunged virtual machine is in listVirtualMachines response\")\n+        self.assertEqual(list_vm_response, None, \"Check Expunged virtual machine is in listVirtualMachines response\")\n         return\n \n-    @attr(tags = [\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"true\")\n+    @attr(tags=[\"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"true\")\n     def test_10_attachAndDetach_iso(self):\n         \"\"\"Test for attach and detach ISO to virtual machine\"\"\"\n \n@@ -702,24 +700,24 @@ def test_10_attachAndDetach_iso(self):\n             self.skipTest(\"ISOs are not supported on LXC\")\n \n         iso = Iso.create(\n-                         self.apiclient,\n-                         self.services[\"iso1\"],\n-                         account=self.account.name,\n-                         domainid=self.account.domainid\n-                         )\n+            self.apiclient,\n+            self.services[\"iso1\"],\n+            account=self.account.name,\n+            domainid=self.account.domainid\n+        )\n \n         self.debug(\"Successfully created ISO with ID: %s\" % iso.id)\n         try:\n             iso.download(self.apiclient)\n         except Exception as e:\n-            self.fail(\"Exception while downloading ISO %s: %s\"\\\n+            self.fail(\"Exception while downloading ISO %s: %s\" \\\n                       % (iso.id, e))\n \n         self.debug(\"Attach ISO with ID: %s to VM ID: %s\" % (\n-                                                    iso.id,\n-                                                    self.virtual_machine.id\n-                                                    ))\n-        #Attach ISO to virtual machine\n+            iso.id,\n+            self.virtual_machine.id\n+        ))\n+        # Attach ISO to virtual machine\n         cmd = attachIso.attachIsoCmd()\n         cmd.id = iso.id\n         cmd.virtualmachineid = self.virtual_machine.id\n@@ -729,7 +727,7 @@ def test_10_attachAndDetach_iso(self):\n             ssh_client = self.virtual_machine.get_ssh_client()\n         except Exception as e:\n             self.fail(\"SSH failed for virtual machine: %s - %s\" %\n-                                (self.virtual_machine.ipaddress, e))\n+                      (self.virtual_machine.ipaddress, e))\n \n         mount_dir = \"/mnt/tmp\"\n         cmds = \"mkdir -p %s\" % mount_dir\n@@ -750,24 +748,24 @@ def test_10_attachAndDetach_iso(self):\n \n         # Get ISO size\n         iso_response = Iso.list(\n-                                 self.apiclient,\n-                                 id=iso.id\n-                                 )\n+            self.apiclient,\n+            id=iso.id\n+        )\n         self.assertEqual(\n-                            isinstance(iso_response, list),\n-                            True,\n-                            \"Check list response returns a valid list\"\n-                        )\n+            isinstance(iso_response, list),\n+            True,\n+            \"Check list response returns a valid list\"\n+        )\n \n         try:\n-            #Unmount ISO\n+            # Unmount ISO\n             command = \"umount %s\" % mount_dir\n             ssh_client.execute(command)\n         except Exception as e:\n             self.fail(\"SSH failed for virtual machine: %s - %s\" %\n-                                (self.virtual_machine.ipaddress, e))\n+                      (self.virtual_machine.ipaddress, e))\n \n-        #Detach from VM\n+        # Detach from VM\n         cmd = detachIso.detachIsoCmd()\n         cmd.virtualmachineid = self.virtual_machine.id\n         self.apiclient.detachIso(cmd)\n@@ -776,16 +774,16 @@ def test_10_attachAndDetach_iso(self):\n             res = ssh_client.execute(c)\n         except Exception as e:\n             self.fail(\"SSH failed for virtual machine: %s - %s\" %\n-                                (self.virtual_machine.ipaddress, e))\n+                      (self.virtual_machine.ipaddress, e))\n \n         # Check if ISO is properly detached from VM (using fdisk)\n         result = self.services[\"mount\"] in str(res)\n \n         self.assertEqual(\n-                         result,\n-                         False,\n-                         \"Check if ISO is detached from virtual machine\"\n-                         )\n+            result,\n+            False,\n+            \"Check if ISO is detached from virtual machine\"\n+        )\n         return\n \n     @attr(tags = [\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\"], required_hardware=\"false\")\n@@ -825,6 +823,7 @@ def test_11_destroy_vm_and_volumes(self):\n \n         self.assertEqual(Volume.list(self.apiclient, id=vol1.id), None, \"List response contains records when it should not\")\n \n+\n class TestSecuredVmMigration(cloudstackTestCase):\n \n     @classmethod\n@@ -842,14 +841,15 @@ def setUpClass(cls):\n         domain = get_domain(cls.apiclient)\n         cls.zone = get_zone(cls.apiclient, cls.testClient.getZoneForTests())\n         cls.services['mode'] = cls.zone.networktype\n-        cls.hostConfig = cls.config.__dict__[\"zones\"][0].__dict__[\"pods\"][0].__dict__[\"clusters\"][0].__dict__[\"hosts\"][0].__dict__\n+        cls.hostConfig = cls.config.__dict__[\"zones\"][0].__dict__[\"pods\"][0].__dict__[\"clusters\"][0].__dict__[\"hosts\"][\n+            0].__dict__\n         cls.management_ip = cls.config.__dict__[\"mgtSvr\"][0].__dict__[\"mgtSvrIp\"]\n \n         template = get_template(\n-                            cls.apiclient,\n-                            cls.zone.id,\n-                            cls.services[\"ostype\"]\n-                            )\n+            cls.apiclient,\n+            cls.zone.id,\n+            cls.services[\"ostype\"]\n+        )\n         if template == FAILED:\n             assert False, \"get_template() failed to return template with description %s\" % cls.services[\"ostype\"]\n \n@@ -861,20 +861,20 @@ def setUpClass(cls):\n \n         # Create VMs, NAT Rules etc\n         cls.account = Account.create(\n-                            cls.apiclient,\n-                            cls.services[\"account\"],\n-                            domainid=domain.id\n-                            )\n+            cls.apiclient,\n+            cls.services[\"account\"],\n+            domainid=domain.id\n+        )\n \n         cls.small_offering = ServiceOffering.create(\n-                                    cls.apiclient,\n-                                    cls.services[\"service_offerings\"][\"small\"]\n-                                    )\n+            cls.apiclient,\n+            cls.services[\"service_offerings\"][\"small\"]\n+        )\n \n         cls._cleanup = [\n-                        cls.small_offering,\n-                        cls.account\n-                        ]\n+            cls.small_offering,\n+            cls.account\n+        ]\n \n     @classmethod\n     def tearDownClass(cls):\n@@ -916,19 +916,20 @@ def get_target_host(self, secured, virtualmachineid):\n         target_hosts = Host.listForMigration(self.apiclient,\n                                              virtualmachineid=virtualmachineid)\n         for host in target_hosts:\n-            h = list_hosts(self.apiclient,type='Routing', id=host.id)[0]\n+            h = list_hosts(self.apiclient, type='Routing', id=host.id)[0]\n             if h.details.secured == secured:\n                 return h\n \n         cloudstackTestCase.skipTest(self, \"No target hosts available, skipping test.\")\n \n     def check_migration_protocol(self, protocol, host):\n-        resp = SshClient(host.ipaddress, port=22, user=self.hostConfig[\"username\"],passwd=self.hostConfig[\"password\"])\\\n+        resp = SshClient(host.ipaddress, port=22, user=self.hostConfig[\"username\"], passwd=self.hostConfig[\"password\"]) \\\n             .execute(\"grep -a listen_%s=1 /etc/libvirt/libvirtd.conf | tail -1\" % protocol)\n \n         if protocol not in resp[0]:\n             cloudstackTestCase.fail(self, \"Libvirt listen protocol expected: '\" + protocol + \"\\n\"\n-                                    \"does not match actual: \" + resp[0])\n+                                                                                             \"does not match actual: \" +\n+                                    resp[0])\n \n     def migrate_and_check(self, vm, src_host, dest_host, proto='tls'):\n         \"\"\"\n@@ -940,7 +941,7 @@ def migrate_and_check(self, vm, src_host, dest_host, proto='tls'):\n         self.assertEqual(vm_response.hostid, dest_host.id, \"Check destination host ID of migrated VM\")\n \n     def unsecure_host(self, host):\n-        SshClient(host.ipaddress, port=22, user=self.hostConfig[\"username\"], passwd=self.hostConfig[\"password\"])\\\n+        SshClient(host.ipaddress, port=22, user=self.hostConfig[\"username\"], passwd=self.hostConfig[\"password\"]) \\\n             .execute(\"rm -f /etc/cloudstack/agent/cloud* && \\\n                       sed -i 's/listen_tls.*/listen_tls=0/g' /etc/libvirt/libvirtd.conf && \\\n                       sed -i 's/listen_tcp.*/listen_tcp=1/g' /etc/libvirt/libvirtd.conf && \\\n@@ -1051,7 +1052,8 @@ def test_03_secured_to_nonsecured_vm_migration(self):\n             self.migrate_and_check(vm, secure_host, unsecure_host, proto='tls')\n         except Exception:\n             pass\n-        else: self.fail(\"Migration succeeded, instead it should fail\")\n+        else:\n+            self.fail(\"Migration succeeded, instead it should fail\")\n \n     @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\", \"security\"], required_hardware=\"false\")\n     def test_04_nonsecured_to_secured_vm_migration(self):\n@@ -1072,5 +1074,217 @@ def test_04_nonsecured_to_secured_vm_migration(self):\n             self.migrate_and_check(vm, unsecure_host, secure_host, proto='tcp')\n         except Exception:\n             pass\n-        else: self.fail(\"Migration succeeded, instead it should fail\")\n+        else:\n+            self.fail(\"Migration succeeded, instead it should fail\")\n+\n+\n+class TestMigrateVMwithVolume(cloudstackTestCase):\n+\n+    @classmethod\n+    def setUpClass(cls):\n+        testClient = super(TestMigrateVMwithVolume, cls).getClsTestClient()\n+        cls.apiclient = testClient.getApiClient()\n+        cls.services = testClient.getParsedTestDataConfig()\n+        cls.hypervisor = testClient.getHypervisorInfo()\n+        cls._cleanup = []\n+\n+        # Get Zone, Domain and templates\n+        domain = get_domain(cls.apiclient)\n+        cls.zone = get_zone(cls.apiclient, cls.testClient.getZoneForTests())\n+        cls.services['mode'] = cls.zone.networktype\n+        cls.hostConfig = cls.config.__dict__[\"zones\"][0].__dict__[\"pods\"][0].__dict__[\"clusters\"][0].__dict__[\"hosts\"][\n+            0].__dict__\n+        cls.management_ip = cls.config.__dict__[\"mgtSvr\"][0].__dict__[\"mgtSvrIp\"]\n+\n+        template = get_template(\n+            cls.apiclient,\n+            cls.zone.id,\n+            cls.services[\"ostype\"]\n+        )\n+        if template == FAILED:\n+            assert False, \"get_template() failed to return template with description %s\" % cls.services[\"ostype\"]\n+\n+        # Set Zones and disk offerings\n+        cls.services[\"small\"][\"zoneid\"] = cls.zone.id\n+        cls.services[\"small\"][\"template\"] = template.id\n+\n+        cls.services[\"iso1\"][\"zoneid\"] = cls.zone.id\n+\n+        # Create VMs, NAT Rules etc\n+        cls.account = Account.create(\n+            cls.apiclient,\n+            cls.services[\"account\"],\n+            domainid=domain.id\n+        )\n+\n+        cls.small_offering = ServiceOffering.create(\n+            cls.apiclient,\n+            cls.services[\"service_offerings\"][\"small\"]\n+        )\n+\n+        cls._cleanup = [\n+            cls.small_offering,\n+            cls.account\n+        ]\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        cls.apiclient = super(TestMigrateVMwithVolume, cls).getClsTestClient().getApiClient()\n+        try:\n+            cleanup_resources(cls.apiclient, cls._cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+\n+    def setUp(self):\n+        self.apiclient = self.testClient.getApiClient()\n+        self.dbclient = self.testClient.getDbConnection()\n+        self.cleanup = []\n+\n+        if self.hypervisor.lower() not in [\"vmware\"]:\n+            self.skipTest(\"VM Migration with Volumes is not supported on other than VMware\")\n+\n+            self.hosts = Host.list(\n+                self.apiclient,\n+                zoneid=self.zone.id,\n+                type='Routing',\n+                hypervisor='KVM')\n+\n+            if len(self.hosts) < 2:\n+                self.skipTest(\"Requires at least two hosts for performing migration related tests\")\n+\n+    def tearDown(self):\n+        try:\n+            cleanup_resources(self.apiclient, self.cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+\n+    def get_target_host(self, virtualmachineid):\n+        target_hosts = Host.listForMigration(self.apiclient,\n+                                             virtualmachineid=virtualmachineid)[0]\n+        if len(target_hosts) < 1:\n+            self.skipTest(\"No target hosts found\")\n+\n+        return target_hosts[0]\n+\n+    def get_target_pool(self, volid):\n+        target_pools = StoragePool.listForMigration(self.apiclient, id=volid)\n+\n+        if len(target_pools) < 1:\n+            self.skipTest(\"Not enough storage pools found\")\n+\n+        return target_pools[0]\n+\n+    def get_vm_volumes(self, id):\n+        return Volume.list(self.apiclient, virtualmachineid=id, listall=True)\n+\n+    def deploy_vm(self):\n+        return VirtualMachine.create(\n+            self.apiclient,\n+            self.services[\"small\"],\n+            accountid=self.account.name,\n+            domainid=self.account.domainid,\n+            serviceofferingid=self.small_offering.id,\n+            mode=self.services[\"mode\"])\n+\n+    def migrate_vm_with_pools(self, target_pool, id):\n+        cmd = migrateVirtualMachine.migrateVirtualMachineCmd()\n+\n+        cmd.storageid = target_pool.id\n+        cmd.virtualmachineid = id\n+\n+        return self.apiclient.migrateVirtualMachine(cmd)\n+\n+    def create_volume(self):\n+        small_disk_offering = DiskOffering.list(self.apiclient, name='Small')[0]\n+\n+        return Volume.create(\n+            self.apiclient,\n+            self.services,\n+            account=self.account.name,\n+            diskofferingid=small_disk_offering.id,\n+            domainid=self.account.domainid,\n+            zoneid=self.zone.id\n+        )\n+\n+    \"\"\"\n+    BVT for Vmware Offline VM and Volume Migration\n+    \"\"\"\n+\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\", \"security\"], required_hardware=\"false\")\n+    def test_01_migrate_VM_and_root_volume(self):\n+        \"\"\"Test VM will be migrated with it's root volume\"\"\"\n+        # Validate the following\n+        # 1. Deploys a VM\n+        # 2. Finds suitable host for migration\n+        # 3. Finds suitable storage pool for root volume\n+        # 4. Migrate the VM to new host and storage pool and assert migration successful\n+\n+        vm = self.deploy_vm()\n+\n+        root_volume = self.get_vm_volumes(vm.id)[0]\n+\n+        target_pool = self.get_target_pool(root_volume.id)\n+\n+        vm.stop(self.apiclient)\n+\n+        self.migrate_vm_with_pools(target_pool, vm.id)\n+\n+        root_volume = self.get_vm_volumes(vm.id)[0]\n+        self.assertEqual(root_volume.storageid, target_pool.id, \"Pool ID was not as expected\")\n+\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\", \"security\"], required_hardware=\"false\")\n+    def test_02_migrate_VM_with_two_data_disks(self):\n+        \"\"\"Test VM will be migrated with it's root volume\"\"\"\n+        # Validate the following\n+        # 1. Deploys a VM and attaches 2 data disks\n+        # 2. Finds suitable host for migration\n+        # 3. Finds suitable storage pool for volumes\n+        # 4. Migrate the VM to new host and storage pool and assert migration successful\n+\n+        vm = self.deploy_vm()\n+\n+        volume1 = self.create_volume()\n+        volume2 = self.create_volume()\n+\n+        vm.attach_volume(self.apiclient, volume1)\n+        vm.attach_volume(self.apiclient, volume2)\n+\n+        root_volume = self.get_vm_volumes(vm.id)[0]\n+\n+        target_pool = self.get_target_pool(root_volume.id)\n+\n+        vm.stop(self.apiclient)\n+\n+        self.migrate_vm_with_pools(target_pool, vm.id)\n+\n+        volume1 = Volume.list(self.apiclient, id=volume1.id)[0]\n+        volume2 = Volume.list(self.apiclient, id=volume2.id)[0]\n+        root_volume = self.get_vm_volumes(vm.id)[0]\n+\n+        self.assertEqual(root_volume.storageid, target_pool.id, \"Pool ID was not as expected\")\n+        self.assertEqual(volume1.storageid, target_pool.id, \"Pool ID was not as expected\")\n+        self.assertEqual(volume2.storageid, target_pool.id, \"Pool ID was not as expected\")\n+\n+    @attr(tags=[\"devcloud\", \"advanced\", \"advancedns\", \"smoke\", \"basic\", \"sg\", \"security\"], required_hardware=\"false\")\n+    def test_03_migrate_detached_volume(self):\n+        \"\"\"Test VM will be migrated with it's root volume\"\"\"\n+        # Validate the following\n+        # 1. Deploys a VM and attaches 1 data disk\n+        # 2. Detaches the Disk\n+        # 3. Finds suitable storage pool for the Disk\n+        # 4. Migrate the storage pool and assert migration successful\n+\n+        vm = self.deploy_vm()\n+\n+        volume1 = self.create_volume()\n+\n+        vm.attach_volume(self.apiclient, volume1)\n+        vm.detach_volume(self.apiclient, volume1)\n+\n+        target_pool = self.get_target_pool(volume1.id)\n+\n+        Volume.migrate(self.apiclient, storageid=target_pool.id, volumeid=volume1.id)\n+\n+        vol = Volume.list(self.apiclient, volume=volume1.id)[0]\n \n+        self.assertEqual(vol.storageid, target_pool.id, \"Storage pool was not the same as expected\")",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/test/integration/smoke/test_vm_life_cycle.py",
                "sha": "32e917444c02c4eebf45044456f95900f8359611",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/utils/src/main/java/com/cloud/utils/StringUtils.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/main/java/com/cloud/utils/StringUtils.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "utils/src/main/java/com/cloud/utils/StringUtils.java",
                "patch": "@@ -73,6 +73,14 @@ public static String join(final Iterable<? extends Object> iterable, final Strin\n     public static String join(final String delimiter, final Object... components) {\n         return org.apache.commons.lang.StringUtils.join(components, delimiter);\n     }\n+    /**\n+     * @deprecated\n+     * Please use org.apache.commons.lang.StringUtils.isBlank() as a replacement\n+     */\n+    @Deprecated\n+    public static boolean isBlank(String str) {\n+        return org.apache.commons.lang.StringUtils.isBlank(str);\n+    }\n \n     /**\n      * @deprecated",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/utils/src/main/java/com/cloud/utils/StringUtils.java",
                "sha": "e858bee74a02d3d654f9972e7644c3df25b94f55",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java?ref=b363fd49f70ac2092ebe6226a72a3d911dc99e1f",
                "deletions": 0,
                "filename": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "patch": "@@ -447,6 +447,23 @@ public boolean changeHost(VirtualMachineRelocateSpec relocateSpec) throws Except\n         return false;\n     }\n \n+    public boolean changeDatastore(ManagedObjectReference morDataStore) throws Exception {\n+        VirtualMachineRelocateSpec relocateSpec = new VirtualMachineRelocateSpec();\n+        relocateSpec.setDatastore(morDataStore);\n+\n+        ManagedObjectReference morTask = _context.getService().relocateVMTask(_mor, relocateSpec, null);\n+\n+        boolean result = _context.getVimClient().waitForTask(morTask);\n+        if (result) {\n+            _context.waitForTaskProgressDone(morTask);\n+            return true;\n+        } else {\n+            s_logger.error(\"VMware change datastore relocateVM_Task failed due to \" + TaskMO.getTaskFailureInfo(_context, morTask));\n+        }\n+\n+        return false;\n+    }\n+\n     public boolean relocate(ManagedObjectReference morTargetHost) throws Exception {\n         VirtualMachineRelocateSpec relocateSpec = new VirtualMachineRelocateSpec();\n         relocateSpec.setHost(morTargetHost);",
                "raw_url": "https://github.com/apache/cloudstack/raw/b363fd49f70ac2092ebe6226a72a3d911dc99e1f/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "sha": "52ead5c8535e50ecb2f323ec70dbb64f53a3e3e3",
                "status": "modified"
            }
        ],
        "message": "Vmware offline migration (#2848)\n\n* - Offline VM and Volume migration on Vmware hypervisor hosts\r\n- Also add VM disk consolidation call on successful VM migrations\r\n\r\n* Fix indentation of marvin test file and reformat against PEP8\r\n\r\n* * Fix few comment typos\r\n* Refactor debug messages to use String.format() when debug log level is enabled.\r\n\r\n* Send list of commands returned by hypervisor Guru instead of explicitly selecting the first one\r\n\r\n* Fix unhandled NPE during VM migration\r\n\r\n* Revert back to distinct event descriptions for VM to host or storage pool migration\r\n\r\n* Reformat test_primary_storage file against PEP-8 and Remove unused imports\r\n\r\n* Revert back the deprecation messages in the custom StringUtils class to favour the use of the ApacheUtils",
        "parent": "https://github.com/apache/cloudstack/commit/d68712eb7b0a53f6426f3bff157b14eee40c368e",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java",
            "AsyncJobManagerTest.java",
            "VMwareGuruTest.java",
            "VmwareResourceTest.java",
            "VmwareStorageMotionStrategyTest.java",
            "ConfigTest.java",
            "DeploymentPlanningManagerImplTest.java",
            "ManagementServerImplTest.java",
            "StorageManagerImplTest.java",
            "VolumeApiServiceImplTest.java",
            "UserVmManagerImplTest.java",
            "StringUtilsTest.java",
            "VirtualMachineMOTest.java"
        ]
    },
    "cloudstack_b3b56e2": {
        "bug_id": "cloudstack_b3b56e2",
        "commit": "https://github.com/apache/cloudstack/commit/b3b56e2cd84a7d716735c4b684f271247192dff3",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b3b56e2cd84a7d716735c4b684f271247192dff3/engine/schema/src/com/cloud/upgrade/dao/Upgrade442to450.java",
                "changes": 151,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/upgrade/dao/Upgrade442to450.java?ref=b3b56e2cd84a7d716735c4b684f271247192dff3",
                "deletions": 150,
                "filename": "engine/schema/src/com/cloud/upgrade/dao/Upgrade442to450.java",
                "patch": "@@ -25,16 +25,12 @@\n import java.sql.SQLException;\n import java.util.ArrayList;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n-\n-import com.cloud.hypervisor.Hypervisor;\n-import com.cloud.utils.crypt.DBEncryptionUtil;\n \n import org.apache.log4j.Logger;\n \n+import com.cloud.utils.crypt.DBEncryptionUtil;\n import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.utils.script.Script;\n \n@@ -68,7 +64,6 @@ public boolean supportsRollingUpgrade() {\n \n     @Override\n     public void performDataMigration(Connection conn) {\n-        updateSystemVmTemplates(conn);\n         dropInvalidKeyFromStoragePoolTable(conn);\n         dropDuplicatedForeignKeyFromAsyncJobTable(conn);\n         updateMaxRouterSizeConfig(conn);\n@@ -152,150 +147,6 @@ private void upgradeMemoryOfInternalLoadBalancervmOffering(Connection conn) {\n         return new File[] {new File(script)};\n     }\n \n-    private void updateSystemVmTemplates(Connection conn) {\n-        s_logger.debug(\"Updating System Vm template IDs\");\n-        //Get all hypervisors in use\n-        Set<Hypervisor.HypervisorType> hypervisorsListInUse = new HashSet<Hypervisor.HypervisorType>();\n-        try (PreparedStatement pstmt = conn.prepareStatement(\"select distinct(hypervisor_type) from `cloud`.`cluster` where removed is null\");\n-             ResultSet rs = pstmt.executeQuery()\n-           ) {\n-            while(rs.next()){\n-                switch (Hypervisor.HypervisorType.getType(rs.getString(1))) {\n-                case XenServer: hypervisorsListInUse.add(Hypervisor.HypervisorType.XenServer);\n-                    break;\n-                case KVM:       hypervisorsListInUse.add(Hypervisor.HypervisorType.KVM);\n-                    break;\n-                case VMware:    hypervisorsListInUse.add(Hypervisor.HypervisorType.VMware);\n-                    break;\n-                case Hyperv:    hypervisorsListInUse.add(Hypervisor.HypervisorType.Hyperv);\n-                    break;\n-                case LXC:       hypervisorsListInUse.add(Hypervisor.HypervisorType.LXC);\n-                    break;\n-                default:  // no action on cases Any, BareMetal, None, Ovm, Parralels, Simulator and VirtualBox:\n-                    break;\n-                }\n-            }\n-        } catch (SQLException e) {\n-            s_logger.error(\"updateSystemVmTemplates:Exception while getting hypervisor types from clusters: \"+e.getMessage());\n-            throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while getting hypervisor types from clusters\", e);\n-        }\n-\n-        Map<Hypervisor.HypervisorType, String> NewTemplateNameList = new HashMap<Hypervisor.HypervisorType, String>() {\n-            {\n-                put(Hypervisor.HypervisorType.XenServer, \"systemvm-xenserver-4.5\");\n-                put(Hypervisor.HypervisorType.VMware, \"systemvm-vmware-4.5\");\n-                put(Hypervisor.HypervisorType.KVM, \"systemvm-kvm-4.5\");\n-                put(Hypervisor.HypervisorType.LXC, \"systemvm-lxc-4.5\");\n-                put(Hypervisor.HypervisorType.Hyperv, \"systemvm-hyperv-4.5\");\n-            }\n-        };\n-\n-        Map<Hypervisor.HypervisorType, String> routerTemplateConfigurationNames = new HashMap<Hypervisor.HypervisorType, String>() {\n-            {\n-                put(Hypervisor.HypervisorType.XenServer, \"router.template.xen\");\n-                put(Hypervisor.HypervisorType.VMware, \"router.template.vmware\");\n-                put(Hypervisor.HypervisorType.KVM, \"router.template.kvm\");\n-                put(Hypervisor.HypervisorType.LXC, \"router.template.lxc\");\n-                put(Hypervisor.HypervisorType.Hyperv, \"router.template.hyperv\");\n-            }\n-        };\n-\n-        Map<Hypervisor.HypervisorType, String> newTemplateUrl = new HashMap<Hypervisor.HypervisorType, String>() {\n-            {\n-                put(Hypervisor.HypervisorType.XenServer, \"http://download.cloud.com/templates/4.5/systemvm64template-4.5-xen.vhd.bz2\");\n-                put(Hypervisor.HypervisorType.VMware, \"http://download.cloud.com/templates/4.5/systemvm64template-4.5-vmware.ova\");\n-                put(Hypervisor.HypervisorType.KVM, \"http://download.cloud.com/templates/4.5/systemvm64template-4.5-kvm.qcow2.bz2\");\n-                put(Hypervisor.HypervisorType.LXC, \"http://download.cloud.com/templates/4.5/systemvm64template-4.5-kvm.qcow2.bz2\");\n-                put(Hypervisor.HypervisorType.Hyperv, \"http://download.cloud.com/templates/4.5/systemvm64template-4.5-hyperv.vhd.zip\");\n-            }\n-        };\n-\n-        Map<Hypervisor.HypervisorType, String> newTemplateChecksum = new HashMap<Hypervisor.HypervisorType, String>() {\n-            {\n-                put(Hypervisor.HypervisorType.XenServer, \"2b15ab4401c2d655264732d3fc600241\");\n-                put(Hypervisor.HypervisorType.VMware, \"3106a79a4ce66cd7f6a7c50e93f2db57\");\n-                put(Hypervisor.HypervisorType.KVM, \"aa9f501fecd3de1daeb9e2f357f6f002\");\n-                put(Hypervisor.HypervisorType.LXC, \"aa9f501fecd3de1daeb9e2f357f6f002\");\n-                put(Hypervisor.HypervisorType.Hyperv, \"70bd30ea02ee9ed67d2c6b85c179cee9\");\n-            }\n-        };\n-\n-        for (Map.Entry<Hypervisor.HypervisorType, String> hypervisorAndTemplateName : NewTemplateNameList.entrySet()) {\n-            s_logger.debug(\"Updating \" + hypervisorAndTemplateName.getKey() + \" System Vms\");\n-            try  (PreparedStatement pstmt = conn.prepareStatement(\"select id from `cloud`.`vm_template` where name = ? and removed is null order by id desc limit 1\")) {\n-                //Get 4.5.0 system Vm template Id for corresponding hypervisor\n-                long templateId = -1;\n-                pstmt.setString(1, hypervisorAndTemplateName.getValue());\n-                try (ResultSet rs = pstmt.executeQuery()) {\n-                    if(rs.next()){\n-                        templateId = rs.getLong(1);\n-                    }\n-                } catch (SQLException e)\n-                {\n-                    s_logger.error(\"updateSystemVmTemplates:Exception while getting ids of templates: \"+e.getMessage());\n-                    throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while getting ids of templates\", e);\n-                }\n-\n-                // change template type to SYSTEM\n-                if (templateId != -1) {\n-                    try(PreparedStatement templ_type_pstmt = conn.prepareStatement(\"update `cloud`.`vm_template` set type='SYSTEM' where id = ?\");)\n-                    {\n-                        templ_type_pstmt.setLong(1, templateId);\n-                        templ_type_pstmt.executeUpdate();\n-                    }\n-                    catch (SQLException e)\n-                    {\n-                        s_logger.error(\"updateSystemVmTemplates:Exception while updating template with id \" + templateId + \" to be marked as 'system': \"+e.getMessage());\n-                        throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while updating template with id \" + templateId + \" to be marked as 'system'\", e);\n-                    }\n-                    // update template ID of system Vms\n-                    try(PreparedStatement update_templ_id_pstmt = conn.prepareStatement(\"update `cloud`.`vm_instance` set vm_template_id = ? where type <> 'User' and hypervisor_type = ?\");)\n-                    {\n-                        update_templ_id_pstmt.setLong(1, templateId);\n-                        update_templ_id_pstmt.setString(2, hypervisorAndTemplateName.getKey().toString());\n-                        update_templ_id_pstmt.executeUpdate();\n-                    }catch (Exception e)\n-                    {\n-                        s_logger.error(\"updateSystemVmTemplates:Exception while setting template for \" + hypervisorAndTemplateName.getKey().toString() + \" to \" + templateId + \": \"+e.getMessage());\n-                        throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while setting template for \" + hypervisorAndTemplateName.getKey().toString() + \" to \" + templateId, e);\n-                    }\n-                    // Change value of global configuration parameter router.template.* for the corresponding hypervisor\n-                    try(PreparedStatement update_pstmt = conn.prepareStatement(\"UPDATE `cloud`.`configuration` SET value = ? WHERE name = ?\");) {\n-                        update_pstmt.setString(1, hypervisorAndTemplateName.getValue());\n-                        update_pstmt.setString(2, routerTemplateConfigurationNames.get(hypervisorAndTemplateName.getKey()));\n-                        update_pstmt.executeUpdate();\n-                    }catch (SQLException e)\n-                    {\n-                        s_logger.error(\"updateSystemVmTemplates:Exception while setting \" + routerTemplateConfigurationNames.get(hypervisorAndTemplateName.getKey()) + \" to \" + hypervisorAndTemplateName.getValue() + \": \"+e.getMessage());\n-                        throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while setting \" + routerTemplateConfigurationNames.get(hypervisorAndTemplateName.getKey()) + \" to \" + hypervisorAndTemplateName.getValue(), e);\n-                    }\n-                } else {\n-                    if (hypervisorsListInUse.contains(hypervisorAndTemplateName.getKey())){\n-                        throw new CloudRuntimeException(\"4.5.0 \" + hypervisorAndTemplateName.getKey() + \" SystemVm template not found. Cannot upgrade system Vms\");\n-                    } else {\n-                        s_logger.warn(\"4.5.0 \" + hypervisorAndTemplateName.getKey() + \" SystemVm template not found. \" + hypervisorAndTemplateName.getKey() + \" hypervisor is not used, so not failing upgrade\");\n-                        // Update the latest template URLs for corresponding hypervisor\n-                        try(PreparedStatement update_templ_url_pstmt = conn.prepareStatement(\"UPDATE `cloud`.`vm_template` SET url = ? , checksum = ? WHERE hypervisor_type = ? AND type = 'SYSTEM' AND removed is null order by id desc limit 1\");) {\n-                            update_templ_url_pstmt.setString(1, newTemplateUrl.get(hypervisorAndTemplateName.getKey()));\n-                            update_templ_url_pstmt.setString(2, newTemplateChecksum.get(hypervisorAndTemplateName.getKey()));\n-                            update_templ_url_pstmt.setString(3, hypervisorAndTemplateName.getKey().toString());\n-                            update_templ_url_pstmt.executeUpdate();\n-                        }catch (SQLException e)\n-                        {\n-                            s_logger.error(\"updateSystemVmTemplates:Exception while updating 'url' and 'checksum' for hypervisor type \" + hypervisorAndTemplateName.getKey().toString() + \": \"+e.getMessage());\n-                            throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while updating 'url' and 'checksum' for hypervisor type \" + hypervisorAndTemplateName.getKey().toString(), e);\n-                        }\n-                    }\n-                }\n-            } catch (SQLException e) {\n-                s_logger.error(\"updateSystemVmTemplates:Exception while getting ids of templates: \"+e.getMessage());\n-                throw new CloudRuntimeException(\"updateSystemVmTemplates:Exception while getting ids of templates\", e);\n-            }\n-        }\n-        s_logger.debug(\"Updating System Vm Template IDs Complete\");\n-    }\n-\n-\n     private void dropInvalidKeyFromStoragePoolTable(Connection conn) {\n         HashMap<String, List<String>> uniqueKeys = new HashMap<String, List<String>>();\n         List<String> keys = new ArrayList<String>();",
                "raw_url": "https://github.com/apache/cloudstack/raw/b3b56e2cd84a7d716735c4b684f271247192dff3/engine/schema/src/com/cloud/upgrade/dao/Upgrade442to450.java",
                "sha": "a9fb08905be2d9b9a34a62bae1dfe75a4cda49a2",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b3b56e2cd84a7d716735c4b684f271247192dff3/pom.xml",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/pom.xml?ref=b3b56e2cd84a7d716735c4b684f271247192dff3",
                "deletions": 1,
                "filename": "pom.xml",
                "patch": "@@ -60,7 +60,7 @@\n     <cs.pool.version>1.6</cs.pool.version>\n     <cs.codec.version>1.10</cs.codec.version>\n     <cs.configuration.version>1.10</cs.configuration.version>\n-    <cs.collections.version>3.2.1</cs.collections.version>\n+    <cs.collections.version>3.2.2</cs.collections.version>\n     <cs.logging.version>1.1.1</cs.logging.version>\n     <cs.discovery.version>0.5</cs.discovery.version>\n     <cs.ejb.version>3.0</cs.ejb.version>",
                "raw_url": "https://github.com/apache/cloudstack/raw/b3b56e2cd84a7d716735c4b684f271247192dff3/pom.xml",
                "sha": "5ded8b4f70f99a326020f5649d3885c712e9620c",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/b3b56e2cd84a7d716735c4b684f271247192dff3/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java?ref=b3b56e2cd84a7d716735c4b684f271247192dff3",
                "deletions": 4,
                "filename": "server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -1013,10 +1013,12 @@ protected void updateRoutersRedundantState(final List<DomainRouterVO> routers) {\n                         s_logger.warn(\"Unable to update router \" + router.getHostName() + \"'s status\");\n                     }\n                     RedundantState state = RedundantState.UNKNOWN;\n-                    if (answer != null && answer.getResult()) {\n-                        state = answer.getState();\n-                    } else {\n-                        s_logger.info(\"Agent response doesn't seem to be correct ==> \" + answer.getResult());\n+                    if (answer != null) {\n+                        if (answer.getResult()) {\n+                            state = answer.getState();\n+                        } else {\n+                            s_logger.info(\"Agent response doesn't seem to be correct ==> \" + answer.getResult());\n+                        }\n                     }\n                     router.setRedundantState(state);\n                     updated = true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/b3b56e2cd84a7d716735c4b684f271247192dff3/server/src/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java",
                "sha": "ca1f67dbb69b7b98ae38a851e54398cd05075875",
                "status": "modified"
            }
        ],
        "message": "Merge release branch 4.6 to master\n\n* 4.6:\n  CLOUDSTACK-9053 security upgrade as per COLLECTIONS-580\n  CLOUDSTACK-9055: fix NPE in updating Redundant State of VPC networks\n  CLOUDSTACK-9057 remove old system vm upgrade code",
        "parent": "https://github.com/apache/cloudstack/commit/76f430cfc3e525d3442b036739442e7abe084b1d",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualNetworkApplianceManagerImplTest.java"
        ]
    },
    "cloudstack_b41a78c": {
        "bug_id": "cloudstack_b41a78c",
        "commit": "https://github.com/apache/cloudstack/commit/b41a78ce0f9cbc2981f6038e3e020ebab564ba0b",
        "file": [
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/cloudstack/blob/b41a78ce0f9cbc2981f6038e3e020ebab564ba0b/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "changes": 60,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java?ref=b41a78ce0f9cbc2981f6038e3e020ebab564ba0b",
                "deletions": 28,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "patch": "@@ -1056,25 +1056,27 @@ public void attachDisk(String[] vmdkDatastorePathChain, ManagedObjectReference m\n             s_logger.trace(\"vCenter API trace - attachDisk(). target MOR: \" + _mor.getValue() + \", vmdkDatastorePath: \" + new Gson().toJson(vmdkDatastorePathChain) +\n                     \", datastore: \" + morDs.getValue());\n \n-        VirtualDevice newDisk = VmwareHelper.prepareDiskDevice(this, null, getScsiDeviceControllerKey(), vmdkDatastorePathChain, morDs, -1, 1);\n-        VirtualMachineConfigSpec reConfigSpec = new VirtualMachineConfigSpec();\n-        VirtualDeviceConfigSpec deviceConfigSpec = new VirtualDeviceConfigSpec();\n+        synchronized (_mor.getValue().intern()) {\n+            VirtualDevice newDisk = VmwareHelper.prepareDiskDevice(this, null, getScsiDeviceControllerKey(), vmdkDatastorePathChain, morDs, -1, 1);\n+            VirtualMachineConfigSpec reConfigSpec = new VirtualMachineConfigSpec();\n+            VirtualDeviceConfigSpec deviceConfigSpec = new VirtualDeviceConfigSpec();\n \n-        deviceConfigSpec.setDevice(newDisk);\n-        deviceConfigSpec.setOperation(VirtualDeviceConfigSpecOperation.ADD);\n+            deviceConfigSpec.setDevice(newDisk);\n+            deviceConfigSpec.setOperation(VirtualDeviceConfigSpecOperation.ADD);\n \n-        reConfigSpec.getDeviceChange().add(deviceConfigSpec);\n+            reConfigSpec.getDeviceChange().add(deviceConfigSpec);\n \n-        ManagedObjectReference morTask = _context.getService().reconfigVMTask(_mor, reConfigSpec);\n-        boolean result = _context.getVimClient().waitForTask(morTask);\n+            ManagedObjectReference morTask = _context.getService().reconfigVMTask(_mor, reConfigSpec);\n+            boolean result = _context.getVimClient().waitForTask(morTask);\n \n-        if (!result) {\n-            if (s_logger.isTraceEnabled())\n-                s_logger.trace(\"vCenter API trace - attachDisk() done(failed)\");\n-            throw new Exception(\"Failed to attach disk due to \" + TaskMO.getTaskFailureInfo(_context, morTask));\n-        }\n+            if (!result) {\n+                if (s_logger.isTraceEnabled())\n+                    s_logger.trace(\"vCenter API trace - attachDisk() done(failed)\");\n+                throw new Exception(\"Failed to attach disk due to \" + TaskMO.getTaskFailureInfo(_context, morTask));\n+            }\n \n-        _context.waitForTaskProgressDone(morTask);\n+            _context.waitForTaskProgressDone(morTask);\n+        }\n \n         if (s_logger.isTraceEnabled())\n             s_logger.trace(\"vCenter API trace - attachDisk() done(successfully)\");\n@@ -1085,25 +1087,27 @@ public void attachDisk(Pair<String, ManagedObjectReference>[] vmdkDatastorePathC\n         if (s_logger.isTraceEnabled())\n             s_logger.trace(\"vCenter API trace - attachDisk(). target MOR: \" + _mor.getValue() + \", vmdkDatastorePath: \" + new Gson().toJson(vmdkDatastorePathChain));\n \n-        VirtualDevice newDisk = VmwareHelper.prepareDiskDevice(this, controllerKey, vmdkDatastorePathChain, -1, 1);\n-        VirtualMachineConfigSpec reConfigSpec = new VirtualMachineConfigSpec();\n-        VirtualDeviceConfigSpec deviceConfigSpec = new VirtualDeviceConfigSpec();\n+        synchronized (_mor.getValue().intern()) {\n+            VirtualDevice newDisk = VmwareHelper.prepareDiskDevice(this, controllerKey, vmdkDatastorePathChain, -1, 1);\n+            VirtualMachineConfigSpec reConfigSpec = new VirtualMachineConfigSpec();\n+            VirtualDeviceConfigSpec deviceConfigSpec = new VirtualDeviceConfigSpec();\n \n-        deviceConfigSpec.setDevice(newDisk);\n-        deviceConfigSpec.setOperation(VirtualDeviceConfigSpecOperation.ADD);\n+            deviceConfigSpec.setDevice(newDisk);\n+            deviceConfigSpec.setOperation(VirtualDeviceConfigSpecOperation.ADD);\n \n-        reConfigSpec.getDeviceChange().add(deviceConfigSpec);\n+            reConfigSpec.getDeviceChange().add(deviceConfigSpec);\n \n-        ManagedObjectReference morTask = _context.getService().reconfigVMTask(_mor, reConfigSpec);\n-        boolean result = _context.getVimClient().waitForTask(morTask);\n+            ManagedObjectReference morTask = _context.getService().reconfigVMTask(_mor, reConfigSpec);\n+            boolean result = _context.getVimClient().waitForTask(morTask);\n \n-        if (!result) {\n-            if (s_logger.isTraceEnabled())\n-                s_logger.trace(\"vCenter API trace - attachDisk() done(failed)\");\n-            throw new Exception(\"Failed to attach disk due to \" + TaskMO.getTaskFailureInfo(_context, morTask));\n-        }\n+            if (!result) {\n+                if (s_logger.isTraceEnabled())\n+                    s_logger.trace(\"vCenter API trace - attachDisk() done(failed)\");\n+                throw new Exception(\"Failed to attach disk due to \" + TaskMO.getTaskFailureInfo(_context, morTask));\n+            }\n \n-        _context.waitForTaskProgressDone(morTask);\n+            _context.waitForTaskProgressDone(morTask);\n+        }\n \n         if (s_logger.isTraceEnabled())\n             s_logger.trace(\"vCenter API trace - attachDisk() done(successfully)\");",
                "raw_url": "https://github.com/apache/cloudstack/raw/b41a78ce0f9cbc2981f6038e3e020ebab564ba0b/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "sha": "c2e9d7f8ee7e5631d8e4b97271e7705f3324b365",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7248. [VMware] Extract volume fails with an NPE.\nSynchronize attach disk to VM on the VM object value instead of using a DB lock.",
        "parent": "https://github.com/apache/cloudstack/commit/bb7fc5994761cb56b142d418deb9080d59b3a3c3",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineMOTest.java"
        ]
    },
    "cloudstack_b4ef066": {
        "bug_id": "cloudstack_b4ef066",
        "commit": "https://github.com/apache/cloudstack/commit/b4ef066846b6eb9d94204fb421ae9eccdbf914b8",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b4ef066846b6eb9d94204fb421ae9eccdbf914b8/core/src/com/cloud/user/dao/AccountDaoImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/user/dao/AccountDaoImpl.java?ref=b4ef066846b6eb9d94204fb421ae9eccdbf914b8",
                "deletions": 1,
                "filename": "core/src/com/cloud/user/dao/AccountDaoImpl.java",
                "patch": "@@ -174,7 +174,7 @@ public Account findActiveAccountByName(String accountName) {\n \t\n \t@Override\n \tpublic void markForCleanup(long accountId) {\n-\t\tAccountVO account = findById(accountId);\n+\t\tAccountVO account = findByIdIncludingRemoved(accountId);\n \t\tif (!account.getNeedsCleanup()) {\n \t\t\taccount.setNeedsCleanup(true);\n         \tupdate(accountId, account);",
                "raw_url": "https://github.com/apache/cloudstack/raw/b4ef066846b6eb9d94204fb421ae9eccdbf914b8/core/src/com/cloud/user/dao/AccountDaoImpl.java",
                "sha": "5715ac585155a8f69b74e339eb6f2a5c807e6eef",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b4ef066846b6eb9d94204fb421ae9eccdbf914b8/utils/src/com/cloud/utils/db/GenericDaoBase.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/db/GenericDaoBase.java?ref=b4ef066846b6eb9d94204fb421ae9eccdbf914b8",
                "deletions": 1,
                "filename": "utils/src/com/cloud/utils/db/GenericDaoBase.java",
                "patch": "@@ -1137,7 +1137,7 @@ public T persist(final T entity) {\n             }\n         }\n         \n-        return _idField != null ? findById(id) : null;\n+        return _idField != null ? findByIdIncludingRemoved(id) : null;\n     }\n \n     @DB(txn=false)",
                "raw_url": "https://github.com/apache/cloudstack/raw/b4ef066846b6eb9d94204fb421ae9eccdbf914b8/utils/src/com/cloud/utils/db/GenericDaoBase.java",
                "sha": "236d49980bb507b71fd3fdf2045162859c36d5b3",
                "status": "modified"
            }
        ],
        "message": "bug 6782:  fix NPEs associated with looking up the account after it's been deleted.  When cleaning up the account, we delete the accountVO first, then stop/destroy VMs, routers, etc.  During this cleanup, there are times when the account needs to be retrieved, and since it's been removed it has to be found by id 'including removed' in order to find it.\n\nstatus 6782: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/50c175d6c1d66b6d74dc6126d9e9f98ff36fe87b",
        "repo": "cloudstack",
        "unit_tests": [
            "GenericDaoBaseTest.java"
        ]
    },
    "cloudstack_b576972": {
        "bug_id": "cloudstack_b576972",
        "commit": "https://github.com/apache/cloudstack/commit/b576972f7104688cb945a4f8b6f6b36f50f790fb",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/b576972f7104688cb945a4f8b6f6b36f50f790fb/engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/CephSnapshotStrategy.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/CephSnapshotStrategy.java?ref=b576972f7104688cb945a4f8b6f6b36f50f790fb",
                "deletions": 3,
                "filename": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/CephSnapshotStrategy.java",
                "patch": "@@ -78,8 +78,10 @@ public boolean revertSnapshot(SnapshotInfo snapshotInfo) {\n \n     protected boolean isSnapshotStoredOnRbdStoragePool(Snapshot snapshot) {\n         SnapshotDataStoreVO snapshotStore = snapshotStoreDao.findBySnapshot(snapshot.getId(), DataStoreRole.Primary);\n-        long snapshotStoragePoolId = snapshotStore.getDataStoreId();\n-        StoragePoolVO storagePoolVO = primaryDataStoreDao.findById(snapshotStoragePoolId);\n-        return storagePoolVO.getPoolType() == StoragePoolType.RBD;\n+        if (snapshotStore == null) {\n+            return false;\n+        }\n+        StoragePoolVO storagePoolVO = primaryDataStoreDao.findById(snapshotStore.getDataStoreId());\n+        return storagePoolVO != null && storagePoolVO.getPoolType() == StoragePoolType.RBD;\n     }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/b576972f7104688cb945a4f8b6f6b36f50f790fb/engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/CephSnapshotStrategy.java",
                "sha": "59ce3eca741faf72004c37006f910022bd698143",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b576972f7104688cb945a4f8b6f6b36f50f790fb/server/src/main/java/com/cloud/network/router/CommandSetupHelper.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/network/router/CommandSetupHelper.java?ref=b576972f7104688cb945a4f8b6f6b36f50f790fb",
                "deletions": 1,
                "filename": "server/src/main/java/com/cloud/network/router/CommandSetupHelper.java",
                "patch": "@@ -1062,7 +1062,7 @@ private NicVO findDefaultDnsIp(final long userVmId) {\n         final NicVO defaultNic = _nicDao.findDefaultNicForVM(userVmId);\n \n         // check if DNS provider is the domR\n-        if (!_networkModel.isProviderSupportServiceInNetwork(defaultNic.getNetworkId(), Service.Dns, Provider.VirtualRouter)) {\n+        if (defaultNic == null || !_networkModel.isProviderSupportServiceInNetwork(defaultNic.getNetworkId(), Service.Dns, Provider.VirtualRouter)) {\n             return null;\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b576972f7104688cb945a4f8b6f6b36f50f790fb/server/src/main/java/com/cloud/network/router/CommandSetupHelper.java",
                "sha": "f9ffeb99d67c0d08c7bc278b7315e6902fa95631",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/b576972f7104688cb945a4f8b6f6b36f50f790fb/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java?ref=b576972f7104688cb945a4f8b6f6b36f50f790fb",
                "deletions": 2,
                "filename": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1476,7 +1476,7 @@ public UserVm updateDefaultNicForVirtualMachine(UpdateDefaultNicForVMCmd cmd) th\n             UsageEventUtils.publishUsageEvent(EventTypes.EVENT_NETWORK_OFFERING_ASSIGN, vmInstance.getAccountId(), vmInstance.getDataCenterId(), vmInstance.getId(),\n                     oldNicIdString, oldNetworkOfferingId, null, 0L, VirtualMachine.class.getName(), vmInstance.getUuid(), vmInstance.isDisplay());\n \n-            if (vmInstance.getState() != State.Stopped) {\n+            if (vmInstance.getState() == State.Running) {\n                 try {\n                     VirtualMachineProfile vmProfile = new VirtualMachineProfileImpl(vmInstance);\n                     User callerUser = _accountMgr.getActiveUser(CallContext.current().getCallingUserId());\n@@ -4806,7 +4806,11 @@ public void collectVmDiskStatistics(final UserVm userVm) {\n         if (!(userVm.getHypervisorType().equals(HypervisorType.KVM) || userVm.getHypervisorType().equals(HypervisorType.VMware))) {\n             return;\n         }\n-        s_logger.debug(\"Collect vm disk statistics from host before stopping Vm\");\n+        s_logger.debug(\"Collect vm disk statistics from host before stopping VM\");\n+        if (userVm.getHostId() == null) {\n+            s_logger.error(\"Unable to collect vm disk statistics for VM as the host is null, skipping VM disk statistics collection\");\n+            return;\n+        }\n         long hostId = userVm.getHostId();\n         List<String> vmNames = new ArrayList<String>();\n         vmNames.add(userVm.getInstanceName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/b576972f7104688cb945a4f8b6f6b36f50f790fb/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "4cb409245ac897c60c867d5d3672140b0b34d492",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/b576972f7104688cb945a4f8b6f6b36f50f790fb/systemvm/debian/opt/cloud/bin/merge.py",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/merge.py?ref=b576972f7104688cb945a4f8b6f6b36f50f790fb",
                "deletions": 2,
                "filename": "systemvm/debian/opt/cloud/bin/merge.py",
                "patch": "@@ -56,8 +56,8 @@ def load(self):\n             with open(self.fpath, 'r') as _fh:\n                 logging.debug(\"Loading data bag type %s\", self.key)\n                 data = json.load(_fh)\n-        except IOError:\n-            logging.debug(\"Creating data bag type %s\", self.key)\n+        except (IOError, ValueError):\n+            logging.debug(\"Caught load error, creating empty data bag type %s\", self.key)\n             data.update({\"id\": self.key})\n         finally:\n             self.dbag = data",
                "raw_url": "https://github.com/apache/cloudstack/raw/b576972f7104688cb945a4f8b6f6b36f50f790fb/systemvm/debian/opt/cloud/bin/merge.py",
                "sha": "54d86c5e8bb2b644d8ca7948546206306b4a832f",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/b576972f7104688cb945a4f8b6f6b36f50f790fb/systemvm/debian/opt/cloud/bin/setup/bootstrap.sh",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/setup/bootstrap.sh?ref=b576972f7104688cb945a4f8b6f6b36f50f790fb",
                "deletions": 0,
                "filename": "systemvm/debian/opt/cloud/bin/setup/bootstrap.sh",
                "patch": "@@ -68,6 +68,7 @@ config_guest() {\n      xen-pv|xen-domU)\n           systemctl stop ntpd\n           systemctl disable ntpd\n+          systemctl enable xe-daemon\n           systemctl start xe-daemon\n \n           cat /proc/cmdline > $CMDLINE\n@@ -76,6 +77,7 @@ config_guest() {\n      xen-hvm)\n           systemctl stop ntpd\n           systemctl disable ntpd\n+          systemctl enable xe-daemon\n           systemctl start xe-daemon\n \n           if [ ! -f /usr/bin/xenstore-read ]; then\n@@ -114,12 +116,14 @@ config_guest() {\n           # system time sync'd with host via vmware tools\n           systemctl stop ntpd\n           systemctl disable ntpd\n+          systemctl enable open-vm-tools\n           systemctl start open-vm-tools\n \n           vmtoolsd --cmd 'machine.id.get' > $CMDLINE\n           ;;\n      virtualpc|hyperv)\n           # Hyper-V is recognized as virtualpc hypervisor type. Boot args are passed using KVP Daemon\n+          systemctl enable hyperv-daemons.hv-fcopy-daemon.service hyperv-daemons.hv-kvp-daemon.service hyperv-daemons.hv-vss-daemon.service\n           systemctl start hyperv-daemons.hv-fcopy-daemon.service hyperv-daemons.hv-kvp-daemon.service hyperv-daemons.hv-vss-daemon.service\n           sleep 5\n           cp -f /var/opt/hyperv/.kvp_pool_0 $CMDLINE",
                "raw_url": "https://github.com/apache/cloudstack/raw/b576972f7104688cb945a4f8b6f6b36f50f790fb/systemvm/debian/opt/cloud/bin/setup/bootstrap.sh",
                "sha": "0fb317b32035843d3ffe1963800b5711d27d8c12",
                "status": "modified"
            }
        ],
        "message": "test: stabilize 4.13/master (#3547)\n\nFix failing smoketests, fix NPEs. \r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/3c2af55d81dbfaf17a3bf0b6247ecd830df12996",
        "repo": "cloudstack",
        "unit_tests": [
            "CephSnapshotStrategyTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_b5db68e": {
        "bug_id": "cloudstack_b5db68e",
        "commit": "https://github.com/apache/cloudstack/commit/b5db68e2d1aa8e44b01a4298ffd2696987606afd",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b5db68e2d1aa8e44b01a4298ffd2696987606afd/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java?ref=b5db68e2d1aa8e44b01a4298ffd2696987606afd",
                "deletions": 14,
                "filename": "plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "patch": "@@ -80,7 +80,6 @@\n     private static final Logger s_logger = Logger.getLogger(CloudStackPrimaryDataStoreLifeCycleImpl.class);\n     @Inject\n     protected ResourceManager _resourceMgr;\n-    protected List<StoragePoolDiscoverer> _discoverers;\n     @Inject\n     PrimaryDataStoreDao primaryDataStoreDao;\n     @Inject\n@@ -260,19 +259,7 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n                 parameters.setPort(port);\n                 parameters.setPath(hostPath);\n             } else {\n-                for (StoragePoolDiscoverer discoverer : _discoverers) {\n-                    Map<? extends StoragePool, Map<String, String>> pools;\n-                    try {\n-                        pools = discoverer.find(zoneId, podId, uri, details);\n-                    } catch (DiscoveryException e) {\n-                        throw new IllegalArgumentException(\"Not enough information for discovery \" + uri, e);\n-                    }\n-                    if (pools != null) {\n-                        Map.Entry<? extends StoragePool, Map<String, String>> entry = pools.entrySet().iterator().next();\n-                        details = entry.getValue();\n-                        break;\n-                    }\n-                }\n+                throw new IllegalArgumentException(\"iSCSI needs to have LUN number\");\n             }\n         } else if (scheme.equalsIgnoreCase(\"iso\")) {\n             if (port == -1) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/b5db68e2d1aa8e44b01a4298ffd2696987606afd/plugins/storage/volume/default/src/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java",
                "sha": "ca60bc17b7e5446d45baf3b9f9a7052fbe7931d4",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7226: in case lun number is not provided, addprimarystorage cmd should report error instead of NPE",
        "parent": "https://github.com/apache/cloudstack/commit/685a58a8433f914f788d5bbdbabd41662d3dd2f4",
        "repo": "cloudstack",
        "unit_tests": [
            "CloudStackPrimaryDataStoreLifeCycleImplTest.java"
        ]
    },
    "cloudstack_b666a1f": {
        "bug_id": "cloudstack_b666a1f",
        "commit": "https://github.com/apache/cloudstack/commit/b666a1f3a5bcd17663af1675e82759c3ff8cbeb9",
        "file": [
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/b666a1f3a5bcd17663af1675e82759c3ff8cbeb9/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 49,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=b666a1f3a5bcd17663af1675e82759c3ff8cbeb9",
                "deletions": 22,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -773,8 +773,9 @@ public void advanceStart(String vmUuid, Map<VirtualMachineProfile.Param, Object>\n             try {\n                 orchestrateStart(vmUuid, params, planToDeploy, planner);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = startVmThroughJobQueue(vmUuid, params, planToDeploy, planner);\n@@ -1350,8 +1351,9 @@ public void advanceStop(String vmUuid, boolean cleanUpEvenIfUnableToStop)\n             try {\n                 orchestrateStop(vmUuid, cleanUpEvenIfUnableToStop);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n \n         } else {\n@@ -1449,7 +1451,7 @@ private void advanceStop(VMInstanceVO vm, boolean cleanUpEvenIfUnableToStop) thr\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Unable to transition the state but we're moving on because it's forced stop\");\n             }\n-            if (state == State.Starting || state == State.Migrating) {\n+            if ((state == State.Starting) || (state == State.Migrating) || (state == State.Stopping)) {\n                 if (work != null) {\n                     doCleanup = true;\n                 } else {\n@@ -1458,8 +1460,6 @@ private void advanceStop(VMInstanceVO vm, boolean cleanUpEvenIfUnableToStop) thr\n                     }\n                     throw new CloudRuntimeException(\"Work item not found, We cannot stop \" + vm + \" when it is in state \" + vm.getState());\n                 }\n-            } else if (state == State.Stopping) {\n-                doCleanup = true;\n             }\n \n             if (doCleanup) {\n@@ -1679,8 +1679,9 @@ public void storageMigration(String vmUuid, StoragePool destPool) {\n             try {\n                 orchestrateStorageMigration(vmUuid, destPool);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = migrateVmStorageThroughJobQueue(vmUuid, destPool);\n@@ -1773,8 +1774,9 @@ public void migrate(String vmUuid, long srcHostId, DeployDestination dest)\n             try {\n                 orchestrateMigrate(vmUuid, srcHostId, dest);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = migrateVmThroughJobQueue(vmUuid, srcHostId, dest);\n@@ -2071,8 +2073,9 @@ public void migrateWithStorage(String vmUuid, long srcHostId, long destHostId, M\n             try {\n                 orchestrateMigrateWithStorage(vmUuid, srcHostId, destHostId, volumeToPool);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n \n         } else {\n@@ -2417,8 +2420,9 @@ public void advanceReboot(String vmUuid, Map<VirtualMachineProfile.Param, Object\n             try {\n                 orchestrateReboot(vmUuid, params);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = rebootVmThroughJobQueue(vmUuid, params);\n@@ -3230,12 +3234,11 @@ protected void runInContext() {\n         public String hostUuid;\n         public VMInstanceVO vm;\n \n-        @SuppressWarnings(\"unchecked\")\n         public AgentVmInfo(String name, VMInstanceVO vm, State state, String host) {\n-            name = name;\n-            state = state;\n-            vm = vm;\n-            hostUuid = host;\n+            this.name = name;\n+            this.state = state;\n+            this.vm = vm;\n+            this.hostUuid = host;\n         }\n \n         public AgentVmInfo(String name, VMInstanceVO vm, State state) {\n@@ -3340,8 +3343,9 @@ public NicProfile addVmToNetwork(VirtualMachine vm, Network network, NicProfile\n             try {\n                 return orchestrateAddVmToNetwork(vm, network, requested);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = addVmToNetworkThroughJobQueue(vm, network, requested);\n@@ -3351,7 +3355,7 @@ public NicProfile addVmToNetwork(VirtualMachine vm, Network network, NicProfile\n             } catch (InterruptedException e) {\n                 throw new RuntimeException(\"Operation is interrupted\", e);\n             } catch (java.util.concurrent.ExecutionException e) {\n-                throw new RuntimeException(\"Execution excetion\", e);\n+                throw new RuntimeException(\"Execution exception\", e);\n             }\n \n             Object jobException = _jobMgr.unmarshallResultObject(outcome.getJob());\n@@ -3454,8 +3458,9 @@ public boolean removeNicFromVm(VirtualMachine vm, Nic nic)\n             try {\n                 return orchestrateRemoveNicFromVm(vm, nic);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n \n         } else {\n@@ -3706,8 +3711,9 @@ public void migrateForScale(String vmUuid, long srcHostId, DeployDestination des\n             try {\n                 orchestrateMigrateForScale(vmUuid, srcHostId, dest, oldSvcOfferingId);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = migrateVmForScaleThroughJobQueue(vmUuid, srcHostId, dest, oldSvcOfferingId);\n@@ -3970,8 +3976,9 @@ public VMInstanceVO reConfigureVm(String vmUuid, ServiceOffering oldServiceOffer\n             try {\n                 return orchestrateReConfigureVm(vmUuid, oldServiceOffering, reconfiguringOnExistingHost);\n             } finally {\n-                if (VmJobEnabled.value())\n+                if (placeHolder != null) {\n                     _workJobDao.expunge(placeHolder.getId());\n+                }\n             }\n         } else {\n             Outcome<VirtualMachine> outcome = reconfigureVmThroughJobQueue(vmUuid, oldServiceOffering, reconfiguringOnExistingHost);\n@@ -4023,7 +4030,7 @@ private VMInstanceVO orchestrateReConfigureVm(String vmUuid, ServiceOffering old\n         work.setStep(Step.Prepare);\n         work.setResourceType(ItWorkVO.ResourceType.Host);\n         work.setResourceId(vm.getHostId());\n-        work = _workDao.persist(work);\n+        _workDao.persist(work);\n         boolean success = false;\n         try {\n             if (reconfiguringOnExistingHost) {\n@@ -4045,8 +4052,6 @@ private VMInstanceVO orchestrateReConfigureVm(String vmUuid, ServiceOffering old\n         } catch (AgentUnavailableException e) {\n             throw e;\n         } finally {\n-            // work.setStep(Step.Done);\n-            //_workDao.update(work.getId(), work);\n             if (!success) {\n                 _capacityMgr.releaseVmCapacity(vm, false, false, vm.getHostId()); // release the new capacity\n                 vm.setServiceOfferingId(oldServiceOffering.getId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/b666a1f3a5bcd17663af1675e82759c3ff8cbeb9/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "4aa5fc80d9660d2f985db98124c33465bd99767f",
                "status": "modified"
            }
        ],
        "message": "Fixed issues reported by coverity NPEs, unwritten field access and self assignment\n\nSigned-off-by: Koushik Das <koushik@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/a5902f1db4b14012ecd1d5660257655e9dfe4354",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_b727001": {
        "bug_id": "cloudstack_b727001",
        "commit": "https://github.com/apache/cloudstack/commit/b727001f483012012c061e8c352c1ebfe7d3fecd",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=b727001f483012012c061e8c352c1ebfe7d3fecd",
                "deletions": 20,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -28,10 +28,10 @@\n import org.apache.cloudstack.api.command.admin.router.ConfigureVirtualRouterElementCmd;\n import org.apache.cloudstack.api.command.admin.router.CreateVirtualRouterElementCmd;\n import org.apache.cloudstack.api.command.admin.router.ListVirtualRouterElementsCmd;\n+import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n \n import org.apache.log4j.Logger;\n \n-import com.cloud.agent.api.PvlanSetupCommand;\n import com.cloud.agent.api.to.LoadBalancerTO;\n import com.cloud.configuration.ConfigurationManager;\n import com.cloud.dc.DataCenter;\n@@ -50,7 +50,6 @@\n import com.cloud.network.NetworkMigrationResponder;\n import com.cloud.network.NetworkModel;\n import com.cloud.network.Networks;\n-import com.cloud.network.Networks.BroadcastDomainType;\n import com.cloud.network.Networks.TrafficType;\n import com.cloud.network.PhysicalNetworkServiceProvider;\n import com.cloud.network.PublicIpAddress;\n@@ -87,7 +86,6 @@\n import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.vm.DomainRouterVO;\n import com.cloud.vm.NicProfile;\n-import com.cloud.vm.NicVO;\n import com.cloud.vm.ReservationContext;\n import com.cloud.vm.UserVmManager;\n import com.cloud.vm.UserVmVO;\n@@ -100,22 +98,6 @@\n \n import com.google.gson.Gson;\n \n-import org.apache.cloudstack.api.command.admin.router.ConfigureVirtualRouterElementCmd;\n-import org.apache.cloudstack.api.command.admin.router.CreateVirtualRouterElementCmd;\n-import org.apache.cloudstack.api.command.admin.router.ListVirtualRouterElementsCmd;\n-import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n-\n-import org.apache.log4j.Logger;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Set;\n-\n @Local(value = {NetworkElement.class, FirewallServiceProvider.class, \n \t\t        DhcpServiceProvider.class, UserDataServiceProvider.class, \n \t\t        StaticNatServiceProvider.class, LoadBalancingServiceProvider.class,\n@@ -390,7 +372,7 @@ public boolean applyLBRules(Network network, List<LoadBalancingRule> rules) thro\n             \n             List<DomainRouterVO> routers = _routerDao.listByNetworkAndRole(network.getId(), Role.VIRTUAL_ROUTER);\n             if (routers == null || routers.isEmpty()) {\n-                s_logger.debug(\"Virtual router elemnt doesn't need to apply firewall rules on the backend; virtual \" +\n+                s_logger.debug(\"Virtual router elemnt doesn't need to apply lb rules on the backend; virtual \" +\n                 \t\t\"router doesn't exist in the network \" + network.getId());\n                 return true;\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "3607284dbe4f3b102109a8d146afad31b1bcf529",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VpcVirtualRouterElement.java?ref=b727001f483012012c061e8c352c1ebfe7d3fecd",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "patch": "@@ -464,7 +464,6 @@ public boolean applyACLItemsToPrivateGw(PrivateGateway gateway,List<? extends Ne\n         } else {\n             return true;\n         }\n-\n     }\n \n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "sha": "b45d1c1dc9e0b189932a7ef82482d4e47642ab31",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java?ref=b727001f483012012c061e8c352c1ebfe7d3fecd",
                "deletions": 15,
                "filename": "server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -287,23 +287,27 @@ public boolean removeVpcRouterFromGuestNetwork(VirtualRouter router, Network net\n             return false;\n         }\n         \n-        //Check if router is a part of the Guest network\n-        if (!_networkModel.isVmPartOfNetwork(router.getId(), network.getId())) {\n-            s_logger.debug(\"Router \" + router + \" is not a part of the Guest network \" + network);\n-            return true;\n-        }\n-        \n-        boolean result = setupVpcGuestNetwork(network, router, false, _networkModel.getNicProfile(router, network.getId(), null));\n-        if (!result) {\n-            s_logger.warn(\"Failed to destroy guest network config \" + network + \" on router \" + router);\n-            return false;\n-        }\n-        \n-        result = result && _itMgr.removeVmFromNetwork(router, network, null);\n-        \n-        if (result) {\n+        boolean result = true;\n+        try {\n+            //Check if router is a part of the Guest network\n+            if (!_networkModel.isVmPartOfNetwork(router.getId(), network.getId())) {\n+                s_logger.debug(\"Router \" + router + \" is not a part of the Guest network \" + network);\n+                return result;\n+            }\n+            \n+            result = setupVpcGuestNetwork(network, router, false, _networkModel.getNicProfile(router, network.getId(), null));\n+            if (!result) {\n+                s_logger.warn(\"Failed to destroy guest network config \" + network + \" on router \" + router);\n+                return false;\n+            }\n+            \n+            result = result && _itMgr.removeVmFromNetwork(router, network, null);\n+        } finally {\n+            if (result) {\n                 _routerDao.removeRouterFromGuestNetwork(router.getId(), network.getId());\n             }\n+        }\n+        \n         return result;\n     }\n     ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "sha": "95b92aa9806352d392a55f0c5d8daa0d4b54f061",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=b727001f483012012c061e8c352c1ebfe7d3fecd",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -2799,7 +2799,9 @@ public NicProfile addVmToNetwork(VirtualMachine vm, Network network, NicProfile\n                     return null;\n                 }\n             } finally {\n-                if (!result) {\n+                if (!result){\n+                    s_logger.debug(\"Removing nic \" + nic + \" from vm \" + vmProfile.getVirtualMachine()\n+                            + \" as nic plug failed on the backend\");\n                     _networkMgr.removeNic(vmProfile, _nicsDao.findById(nic.getId()));\n                 }\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b727001f483012012c061e8c352c1ebfe7d3fecd/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "7c19c28f990cec71bcc95b25ef217938f9531400",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4315: VPC - when fail to add nic to the VR, a) remove the nic b) remove the reference to nic from router_network_ref table. Before the fix b) was missing, and it caused NPEs when tried to apply the rules on the routers not having nic in the network\n\nConflicts:\n\tserver/src/com/cloud/network/element/VirtualRouterElement.java\n\tserver/src/com/cloud/vm/VirtualMachineManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/bea095fa477bb2780da5c741f8b1d23ebcfdc477",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRouterElementTest.java",
            "VpcVirtualRouterElementTest.java",
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_b7470bc": {
        "bug_id": "cloudstack_b7470bc",
        "commit": "https://github.com/apache/cloudstack/commit/b7470bc51c7d74be301f5fa12d7090e8b646e6bb",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/b7470bc51c7d74be301f5fa12d7090e8b646e6bb/server/src/main/java/com/cloud/server/ManagementServerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/main/java/com/cloud/server/ManagementServerImpl.java?ref=b7470bc51c7d74be301f5fa12d7090e8b646e6bb",
                "deletions": 3,
                "filename": "server/src/main/java/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -37,8 +37,6 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n-import com.cloud.storage.ScopeType;\n-import com.cloud.hypervisor.kvm.dpdk.DpdkHelper;\n import org.apache.cloudstack.acl.ControlledEntity;\n import org.apache.cloudstack.affinity.AffinityGroupProcessor;\n import org.apache.cloudstack.affinity.dao.AffinityGroupVMMapDao;\n@@ -613,6 +611,7 @@\n import com.cloud.hypervisor.HypervisorCapabilities;\n import com.cloud.hypervisor.HypervisorCapabilitiesVO;\n import com.cloud.hypervisor.dao.HypervisorCapabilitiesDao;\n+import com.cloud.hypervisor.kvm.dpdk.DpdkHelper;\n import com.cloud.info.ConsoleProxyInfo;\n import com.cloud.network.IpAddress;\n import com.cloud.network.dao.IPAddressDao;\n@@ -639,6 +638,7 @@\n import com.cloud.storage.GuestOSHypervisorVO;\n import com.cloud.storage.GuestOSVO;\n import com.cloud.storage.GuestOsCategory;\n+import com.cloud.storage.ScopeType;\n import com.cloud.storage.StorageManager;\n import com.cloud.storage.StoragePool;\n import com.cloud.storage.Volume;\n@@ -1442,7 +1442,11 @@ private boolean hasSuitablePoolsForVolume(final VolumeVO volume, final Host host\n         StoragePool srcVolumePool = _poolDao.findById(volume.getPoolId());\n         allPools = getAllStoragePoolCompatileWithVolumeSourceStoragePool(srcVolumePool);\n         allPools.remove(srcVolumePool);\n-        suitablePools = findAllSuitableStoragePoolsForVm(volume, vm, srcVolumePool);\n+        if (vm != null) {\n+            suitablePools = findAllSuitableStoragePoolsForVm(volume, vm, srcVolumePool);\n+        } else {\n+            suitablePools = allPools;\n+        }\n \n         return new Pair<List<? extends StoragePool>, List<? extends StoragePool>>(allPools, suitablePools);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/b7470bc51c7d74be301f5fa12d7090e8b646e6bb/server/src/main/java/com/cloud/server/ManagementServerImpl.java",
                "sha": "6cb457471064abe30116e52f28131eda96e9671c",
                "status": "modified"
            }
        ],
        "message": "server: fix NPE for the case where volume is not attached to a VM (#3566)\n\nFixes NPE when trying to find suitable storage pools for a volume\r\nwhen the volume is not attached to a VM.\r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/77f9ab27277cd1a5569b41b5acd425ecc46693e3",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_b8adb96": {
        "bug_id": "cloudstack_b8adb96",
        "commit": "https://github.com/apache/cloudstack/commit/b8adb96ae1d1ce0066ce8c937fa0e15434c4acc4",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/b8adb96ae1d1ce0066ce8c937fa0e15434c4acc4/engine/schema/src/com/cloud/service/ServiceOfferingVO.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/service/ServiceOfferingVO.java?ref=b8adb96ae1d1ce0066ce8c937fa0e15434c4acc4",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/service/ServiceOfferingVO.java",
                "patch": "@@ -176,7 +176,7 @@ public ServiceOfferingVO(ServiceOfferingVO offering) {\n             offering.getUseLocalStorage(),\n             offering.getSystemUse(),\n             true,\n-            offering.isCustomizedIops(),\n+            offering.isCustomizedIops()== null ? false:offering.isCustomizedIops(),\n             offering.getDomainId());\n         cpu = offering.getCpu();\n         ramSize = offering.getRamSize();",
                "raw_url": "https://github.com/apache/cloudstack/raw/b8adb96ae1d1ce0066ce8c937fa0e15434c4acc4/engine/schema/src/com/cloud/service/ServiceOfferingVO.java",
                "sha": "df68fb8ed04906f144c487fe8bb35e1e08b2e5ef",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6575: Deploy VM failed with NPE while using custom compute offering",
        "parent": "https://github.com/apache/cloudstack/commit/b7b89b1297c0cf5e8599f28d54f28003502d80b5",
        "repo": "cloudstack",
        "unit_tests": [
            "ServiceOfferingVOTest.java"
        ]
    },
    "cloudstack_b9932a0": {
        "bug_id": "cloudstack_b9932a0",
        "commit": "https://github.com/apache/cloudstack/commit/b9932a0129c565db185e8f5ee03d68dbc7bce107",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/b9932a0129c565db185e8f5ee03d68dbc7bce107/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java?ref=b9932a0129c565db185e8f5ee03d68dbc7bce107",
                "deletions": 2,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "patch": "@@ -934,10 +934,10 @@ public Volume migrateVolume(Volume volume, StoragePool destPool) throws StorageU\n             return result.getVolume();\n         } catch (InterruptedException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         } catch (ExecutionException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b9932a0129c565db185e8f5ee03d68dbc7bce107/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/VolumeOrchestrator.java",
                "sha": "e439b33b2bf38e715963c18be6d445a2489923f9",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/b9932a0129c565db185e8f5ee03d68dbc7bce107/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=b9932a0129c565db185e8f5ee03d68dbc7bce107",
                "deletions": 10,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -1817,6 +1817,8 @@ public Volume migrateVolume(MigrateVolumeCmd cmd) {\n                 if (jobResult != null) {\n                     if (jobResult instanceof ConcurrentOperationException)\n                         throw (ConcurrentOperationException)jobResult;\n+                    else if (jobResult instanceof RuntimeException)\n+                        throw (RuntimeException)jobResult;\n                     else if (jobResult instanceof Throwable)\n                         throw new RuntimeException(\"Unexpected exception\", (Throwable)jobResult);\n                 }\n@@ -1839,35 +1841,39 @@ private Volume orchestrateMigrateVolume(long volumeId, long destPoolId, boolean\n         assert (destPool != null);\n \n         Volume newVol = null;\n-        if (liveMigrateVolume) {\n-            newVol = liveMigrateVolume(vol, destPool);\n-        } else {\n-            try {\n+        try {\n+            if (liveMigrateVolume) {\n+                newVol = liveMigrateVolume(vol, destPool);\n+            } else {\n                 newVol = _volumeMgr.migrateVolume(vol, destPool);\n-            } catch (StorageUnavailableException e) {\n-                s_logger.debug(\"Failed to migrate volume\", e);\n             }\n+        } catch (StorageUnavailableException e) {\n+            s_logger.debug(\"Failed to migrate volume\", e);\n+            throw new CloudRuntimeException(e.getMessage());\n+        }  catch (Exception e) {\n+            s_logger.debug(\"Failed to migrate volume\", e);\n+            throw new CloudRuntimeException(e.getMessage());\n         }\n         return newVol;\n     }\n \n     @DB\n-    protected Volume liveMigrateVolume(Volume volume, StoragePool destPool) {\n+    protected Volume liveMigrateVolume(Volume volume, StoragePool destPool) throws StorageUnavailableException {\n         VolumeInfo vol = volFactory.getVolume(volume.getId());\n         AsyncCallFuture<VolumeApiResult> future = volService.migrateVolume(vol, (DataStore)destPool);\n         try {\n             VolumeApiResult result = future.get();\n             if (result.isFailed()) {\n                 s_logger.debug(\"migrate volume failed:\" + result.getResult());\n-                return null;\n+                throw new StorageUnavailableException(\"Migrate volume failed: \" + result.getResult(), destPool.getId());\n             }\n             return result.getVolume();\n         } catch (InterruptedException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         } catch (ExecutionException e) {\n             s_logger.debug(\"migrate volume failed\", e);\n-            return null;\n+            throw new CloudRuntimeException(e.getMessage());\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/b9932a0129c565db185e8f5ee03d68dbc7bce107/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "6d74fa43eb7cabeea0fdde7faa72a8902886c4e5",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8122. Handle NPE thrown during migration failures.\nWhen migration fails instead of returning NULL, throw the exception.\n\n(cherry picked from commit a5a65c7b551ee5cc32588997937267b716eff681)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/bcbfe3bdeefedf4f53e1b5bade4e220fb8d23a57",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_bb1f000": {
        "bug_id": "cloudstack_bb1f000",
        "commit": "https://github.com/apache/cloudstack/commit/bb1f00041479d8a13c7c0e2300521575d57a0bd7",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/bb1f00041479d8a13c7c0e2300521575d57a0bd7/api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java?ref=bb1f00041479d8a13c7c0e2300521575d57a0bd7",
                "deletions": 0,
                "filename": "api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java",
                "patch": "@@ -24,6 +24,7 @@\n import com.cloud.api.BaseCmd;\n import com.cloud.api.Implementation;\n import com.cloud.api.Parameter;\n+import com.cloud.api.BaseCmd.CommandType;\n import com.cloud.api.response.SSHKeyPairResponse;\n import com.cloud.user.Account;\n import com.cloud.user.SSHKeyPair;\n@@ -45,6 +46,12 @@\n     @Parameter(name=\"publickey\", type=CommandType.STRING, required=true, description=\"Public key material of the keypair\") \n     private String publicKey;\n \n+    //Owner information\n+    @Parameter(name=ApiConstants.ACCOUNT, type=CommandType.STRING, description=\"an optional account for the ssh key. Must be used with domainId.\")\n+    private String accountName;\n+    \n+    @Parameter(name=ApiConstants.DOMAIN_ID, type=CommandType.LONG, description=\"an optional domainId for the ssh key. If the account parameter is used, domainId must also be used.\")\n+    private Long domainId;\n     \n     /////////////////////////////////////////////////////\n     /////////////////// Accessors ///////////////////////\n@@ -58,6 +65,13 @@ public String getPublicKey() {\n \t\treturn publicKey;\n \t}\n \n+\tpublic String getAccountName() {\n+\t    return accountName;\n+\t}\n+\t    \n+    public Long getDomainId() {\n+        return domainId;\n+    }\n     \n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////",
                "raw_url": "https://github.com/apache/cloudstack/raw/bb1f00041479d8a13c7c0e2300521575d57a0bd7/api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java",
                "sha": "243df8b54c15fa6db06e693e1f16dc9e0621f524",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/bb1f00041479d8a13c7c0e2300521575d57a0bd7/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=bb1f00041479d8a13c7c0e2300521575d57a0bd7",
                "deletions": 10,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -4613,7 +4613,7 @@ public SSHKeyPair createSSHKeyPair(CreateSSHKeyPairCmd cmd) {\n         String fingerprint = keys.getPublicKeyFingerPrint();\n         String privateKey = keys.getPrivateKey();\n \n-        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, privateKey);\n+        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, privateKey, owner);\n     }\n \n     @Override\n@@ -4685,29 +4685,32 @@ public boolean deleteSSHKeyPair(DeleteSSHKeyPairCmd cmd) {\n \n     @Override\n     public SSHKeyPair registerSSHKeyPair(RegisterSSHKeyPairCmd cmd) {\n-        Account account = UserContext.current().getCaller();\n-        SSHKeyPairVO s = _sshKeyPairDao.findByName(account.getAccountId(), account.getDomainId(), cmd.getName());\n+        Account caller = UserContext.current().getCaller();\n+        \n+        Account owner = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId());\n+        \n+        SSHKeyPairVO s = _sshKeyPairDao.findByName(owner.getAccountId(), owner.getDomainId(), cmd.getName());\n         if (s != null) {\n             throw new InvalidParameterValueException(\"A key pair with name '\" + cmd.getName() + \"' already exists.\");\n         }\n \n         String name = cmd.getName();\n         String publicKey = SSHKeysHelper.getPublicKeyFromKeyMaterial(cmd.getPublicKey());\n-        String fingerprint = SSHKeysHelper.getPublicKeyFingerprint(publicKey);\n-\n+        \n         if (publicKey == null) {\n             throw new InvalidParameterValueException(\"Public key is invalid\");\n         }\n+        \n+        String fingerprint = SSHKeysHelper.getPublicKeyFingerprint(publicKey);\n \n-        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, null);\n+        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, null, owner);\n     }\n \n-    private SSHKeyPair createAndSaveSSHKeyPair(String name, String fingerprint, String publicKey, String privateKey) {\n-        Account account = UserContext.current().getCaller();\n+    private SSHKeyPair createAndSaveSSHKeyPair(String name, String fingerprint, String publicKey, String privateKey, Account owner) {\n         SSHKeyPairVO newPair = new SSHKeyPairVO();\n \n-        newPair.setAccountId(account.getAccountId());\n-        newPair.setDomainId(account.getDomainId());\n+        newPair.setAccountId(owner.getAccountId());\n+        newPair.setDomainId(owner.getDomainId());\n         newPair.setName(name);\n         newPair.setFingerprint(fingerprint);\n         newPair.setPublicKey(publicKey);",
                "raw_url": "https://github.com/apache/cloudstack/raw/bb1f00041479d8a13c7c0e2300521575d57a0bd7/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "54115ec898904a7b2e5dbecb05831bdff4aeaf27",
                "status": "modified"
            }
        ],
        "message": "createSshKeys command - fixed the case when admin couldn't create a key for another user via 8096 port.\nregisterSshKeys command - added ability for admin to register key for another user\n\nFixed NPE in registerUserKeys command - used to happen in failure case, when invalid publicKey was specified",
        "parent": "https://github.com/apache/cloudstack/commit/6137a6582da1ec1444d9dda0a093416053b5b20f",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_bb790b4": {
        "bug_id": "cloudstack_bb790b4",
        "commit": "https://github.com/apache/cloudstack/commit/bb790b41f7fa8c8efd5e1beead15819c9f126bac",
        "file": [
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/cloudstack/blob/bb790b41f7fa8c8efd5e1beead15819c9f126bac/core/src/com/cloud/agent/resource/virtualnetwork/VirtualRoutingResource.java",
                "changes": 61,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/agent/resource/virtualnetwork/VirtualRoutingResource.java?ref=bb790b41f7fa8c8efd5e1beead15819c9f126bac",
                "deletions": 13,
                "filename": "core/src/com/cloud/agent/resource/virtualnetwork/VirtualRoutingResource.java",
                "patch": "@@ -447,19 +447,54 @@ public void cleanupPrivateNetwork(String privNwName, String privBrName){\n     }\n     \n     protected Answer execute(final SetFirewallRuleCommand cmd) {\n-        final String result = setFirewallRules(cmd.isEnable(),\n-        \t\t\t\t\t\t\t\t cmd.getRouterName(),\n-                                         cmd.getRouterIpAddress(),\n-                                         cmd.getProtocol().toLowerCase(),\n-                                         cmd.getPublicIpAddress(),\n-                                         cmd.getPublicPort(),\n-                                         cmd.getPrivateIpAddress(),\n-                                         cmd.getPrivatePort(),\n-                                         cmd.getOldPrivateIP(),\n-                                         cmd.getOldPrivatePort(),\n-                                         cmd.getVlanNetmask());\n-                                         \n-        return new Answer(cmd, result == null, result);\n+    \tString args;\n+\n+    \tif(cmd.isNat()){\n+    \t\t//1:1 NAT needs instanceip;publicip;domrip;op\n+    \t\tif(cmd.isCreate())\n+    \t\t\targs = \"-A\";\n+    \t\telse\n+    \t\t\targs = \"-D\";\n+\n+    \t\targs += \" -l \" + cmd.getPublicIpAddress();\n+    \t\targs += \" -i \" + cmd.getRouterIpAddress();\n+    \t\targs += \" -r \" + cmd.getPrivateIpAddress();\n+    \t\targs += \" -G \" + cmd.getProtocol();\n+    \t}else{\n+    \t\tif (cmd.isEnable()) {\n+    \t\t\targs = \"-A\";\n+    \t\t} else {\n+    \t\t\targs = \"-D\";\n+    \t\t}\n+\n+    \t\targs += \" -P \" + cmd.getProtocol().toLowerCase();\n+    \t\targs += \" -l \" + cmd.getPublicIpAddress();\n+    \t\targs += \" -p \" + cmd.getPublicPort();\n+    \t\targs += \" -n \" + cmd.getRouterName();\n+    \t\targs += \" -i \" + cmd.getRouterIpAddress();\n+    \t\targs += \" -r \" + cmd.getPrivateIpAddress();\n+    \t\targs += \" -d \" + cmd.getPrivatePort();\n+    \t\targs += \" -N \" + cmd.getVlanNetmask();\n+\n+    \t\tString oldPrivateIP = cmd.getOldPrivateIP();\n+    \t\tString oldPrivatePort = cmd.getOldPrivatePort();\n+\n+    \t\tif (oldPrivateIP != null) {\n+    \t\t\targs += \" -w \" + oldPrivateIP;\n+    \t\t}\n+\n+    \t\tif (oldPrivatePort != null) {\n+    \t\t\targs += \" -x \" + oldPrivatePort;\n+    \t\t}\n+    \t}\n+\n+    \tfinal Script command = new Script(_firewallPath, _timeout, s_logger);\n+    \tString [] argsArray = args.split(\" \");\n+    \tfor (String param : argsArray) {\n+    \t\tcommand.add(param);\n+    \t}\n+    \tString result = command.execute();\n+    \treturn new Answer(cmd, result == null, result);\n     }\n     \n     protected String getDefaultScriptsDir() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/bb790b41f7fa8c8efd5e1beead15819c9f126bac/core/src/com/cloud/agent/resource/virtualnetwork/VirtualRoutingResource.java",
                "sha": "8463db98a099f96b9d987a5e6c233aab07385822",
                "status": "modified"
            }
        ],
        "message": "bug 7322: fix NPE when setting firewall rule for 1:1 NAT on kvm\nstatus 7322: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/1ce538b6a9560b96843714e70b60ccbd21f606e2",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRoutingResourceTest.java"
        ]
    },
    "cloudstack_bbc5bdd": {
        "bug_id": "cloudstack_bbc5bdd",
        "commit": "https://github.com/apache/cloudstack/commit/bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb/server/src/com/cloud/configuration/ConfigurationManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/ConfigurationManager.java?ref=bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb",
                "deletions": 1,
                "filename": "server/src/com/cloud/configuration/ConfigurationManager.java",
                "patch": "@@ -82,7 +82,7 @@\n \t * @param isCustomized\n \t * @return newly created disk offering\n \t */\n-\tDiskOfferingVO createDiskOffering(long domainId, String name, String description, Long numGibibytes, String tags, boolean isCustomized);\n+\tDiskOfferingVO createDiskOffering(Long domainId, String name, String description, Long numGibibytes, String tags, boolean isCustomized);\n     \n \t/**\n \t * Creates a new pod",
                "raw_url": "https://github.com/apache/cloudstack/raw/bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb/server/src/com/cloud/configuration/ConfigurationManager.java",
                "sha": "a7e625900aceb946ac81764f2d50244568073a43",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb/server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/configuration/ConfigurationManagerImpl.java?ref=bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb",
                "deletions": 1,
                "filename": "server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "patch": "@@ -1415,7 +1415,7 @@ public ServiceOffering updateServiceOffering(UpdateServiceOfferingCmd cmd) {\n     }\n \n     @Override\n-    public DiskOfferingVO createDiskOffering(long domainId, String name, String description, Long numGibibytes, String tags, boolean isCustomized) throws InvalidParameterValueException {\n+    public DiskOfferingVO createDiskOffering(Long domainId, String name, String description, Long numGibibytes, String tags, boolean isCustomized) throws InvalidParameterValueException {\n         long diskSize = 0;//special case for custom disk offerings\n     \tif (numGibibytes != null && (numGibibytes <= 0)) {\n             throw new InvalidParameterValueException(\"Please specify a disk size of at least 1 Gb.\");",
                "raw_url": "https://github.com/apache/cloudstack/raw/bbc5bdd83bf3f0e368337aa5ed71e3df09911bbb/server/src/com/cloud/configuration/ConfigurationManagerImpl.java",
                "sha": "1baf9579aeb199ef8e46d2f987993237242a7aa2",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in diskOffering creation",
        "parent": "https://github.com/apache/cloudstack/commit/1a12b3a3de9a35a55adab3e91c49d8d55b34ceb0",
        "repo": "cloudstack",
        "unit_tests": [
            "ConfigurationManagerTest.java"
        ]
    },
    "cloudstack_bd034e0": {
        "bug_id": "cloudstack_bd034e0",
        "commit": "https://github.com/apache/cloudstack/commit/bd034e0b9f471ca1d0c3a18e135926380dc76e1c",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/bd034e0b9f471ca1d0c3a18e135926380dc76e1c/server/src/com/cloud/user/AccountManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/user/AccountManagerImpl.java?ref=bd034e0b9f471ca1d0c3a18e135926380dc76e1c",
                "deletions": 1,
                "filename": "server/src/com/cloud/user/AccountManagerImpl.java",
                "patch": "@@ -218,7 +218,7 @@\n     private IPAddressDao _ipAddressDao;\n     @Inject\n     private RegionManager _regionMgr;\n-    \n+    @Inject\n     private VpcManager _vpcMgr;\n     @Inject\n     private DomainRouterDao _routerDao;",
                "raw_url": "https://github.com/apache/cloudstack/raw/bd034e0b9f471ca1d0c3a18e135926380dc76e1c/server/src/com/cloud/user/AccountManagerImpl.java",
                "sha": "a3f9505c3df39eb07c1ec63bc0e5c48b4a1320d2",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-1243: Add @Inject to fix NPE in AccountManagerImpl\n\nSigned-off-by: Rohit Yadav <bhaisaab@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/c809d057efd42bf01d585326e09e51e0c0ff1cee",
        "repo": "cloudstack",
        "unit_tests": [
            "AccountManagerImplTest.java"
        ]
    },
    "cloudstack_bdee5e3": {
        "bug_id": "cloudstack_bdee5e3",
        "commit": "https://github.com/apache/cloudstack/commit/bdee5e37343f6f4e5be2acd6cbc6e172e0d1fe36",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/bdee5e37343f6f4e5be2acd6cbc6e172e0d1fe36/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=bdee5e37343f6f4e5be2acd6cbc6e172e0d1fe36",
                "deletions": 2,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -2544,7 +2544,9 @@ public UserVm createAdvancedVirtualMachine(DataCenter zone, ServiceOffering serv\n                     s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId() + \" as a part of deployVM process\");\n                     Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName() + \"-network\",\n                             null, null, null, null, owner, null, physicalNetwork, zone.getId(), ACLType.Account, null, null, null, null, true, null);\n-                    defaultNetwork = _networkDao.findById(newNetwork.getId());\n+                    if (newNetwork != null) {\n+                        defaultNetwork = _networkDao.findById(newNetwork.getId());\n+                    }\n                 } else if (virtualNetworks.size() > 1) {\n                     throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found for account \" + owner + \"; please specify networkIds\");\n                 } else {\n@@ -2554,7 +2556,9 @@ public UserVm createAdvancedVirtualMachine(DataCenter zone, ServiceOffering serv\n                 throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n             }\n \n-            networkList.add(defaultNetwork);\n+            if (defaultNetwork != null) {\n+                networkList.add(defaultNetwork);\n+            }\n \n         } else {\n             for (Long networkId : networkIdList) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/bdee5e37343f6f4e5be2acd6cbc6e172e0d1fe36/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "2636096d03d7cfa097605ac066b8bd66b24972b7",
                "status": "modified"
            }
        ],
        "message": "CID-1233086: Fix potential NPE blowup in UserVmManagerImpl\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/65608e99495007183bb8e4043b0f1efe527a7e85",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_be20178": {
        "bug_id": "cloudstack_be20178",
        "commit": "https://github.com/apache/cloudstack/commit/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/api/src/com/cloud/projects/ProjectService.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/projects/ProjectService.java?ref=be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
                "deletions": 0,
                "filename": "api/src/com/cloud/projects/ProjectService.java",
                "patch": "@@ -93,4 +93,6 @@\n     Project enableProject(long projectId);\n \n     boolean deleteProjectInvitation(long invitationId);\n+    \n+    Project findByProjectAccountIdIncludingRemoved(long projectAccountId);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/api/src/com/cloud/projects/ProjectService.java",
                "sha": "5834f1ce712f429660fe39169c8d91bed460925a",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/api/ApiDBUtils.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiDBUtils.java?ref=be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
                "deletions": 0,
                "filename": "server/src/com/cloud/api/ApiDBUtils.java",
                "patch": "@@ -733,6 +733,10 @@ public static Project findProjectByProjectAccountId(long projectAccountId) {\n         return _projectMgr.findByProjectAccountId(projectAccountId);\n     }\n     \n+    public static Project findProjectByProjectAccountIdIncludingRemoved(long projectAccountId) {\n+        return _projectMgr.findByProjectAccountIdIncludingRemoved(projectAccountId);\n+    }\n+    \n     public static Project findProjectById(long projectId) {\n         return _projectMgr.getProject(projectId);\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/api/ApiDBUtils.java",
                "sha": "3fac7a74a7db134f5ba282c8e8d3e42e202bddb1",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
                "deletions": 4,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -2746,7 +2746,7 @@ public TemplatePermissionsResponse createTemplatePermissionsResponse(List<String\n                 regularAccounts.add(accountName);\n             } else {\n                 // convert account to projectIds\n-                Project project = ApiDBUtils.findProjectByProjectAccountId(account.getId());\n+                Project project = ApiDBUtils.findProjectByProjectAccountIdIncludingRemoved(account.getId());\n \n                 if (project.getUuid() != null && !project.getUuid().isEmpty())\n                     projectIds.add(project.getUuid());\n@@ -3343,7 +3343,7 @@ private void populateOwner(ControlledEntityResponse response, ControlledEntity o\n \n         if (account.getType() == Account.ACCOUNT_TYPE_PROJECT) {\n             // find the project\n-            Project project = ApiDBUtils.findProjectByProjectAccountId(account.getId());\n+            Project project = ApiDBUtils.findProjectByProjectAccountIdIncludingRemoved(account.getId());\n             response.setProjectId(project.getId());\n             response.setProjectName(project.getName());\n         } else {\n@@ -3359,7 +3359,7 @@ private void populateAccount(ControlledEntityResponse response, long accountId)\n         Account account = ApiDBUtils.findAccountByIdIncludingRemoved(accountId);\n         if (account.getType() == Account.ACCOUNT_TYPE_PROJECT) {\n             // find the project\n-            Project project = ApiDBUtils.findProjectByProjectAccountId(account.getId());\n+            Project project = ApiDBUtils.findProjectByProjectAccountIdIncludingRemoved(account.getId());\n             response.setProjectId(project.getId());\n             response.setProjectName(project.getName());\n         } else {\n@@ -3670,7 +3670,7 @@ public ResourceTagResponse createResourceTagResponse(ResourceTag resourceTag, bo\n \n             if (account.getType() == Account.ACCOUNT_TYPE_PROJECT) {\n                 // find the project\n-                Project project = ApiDBUtils.findProjectByProjectAccountId(account.getId());\n+                Project project = ApiDBUtils.findProjectByProjectAccountIdIncludingRemoved(account.getId());\n                 response.setProjectId(project.getId());\n                 response.setProjectName(project.getName());\n             } else {",
                "raw_url": "https://github.com/apache/cloudstack/raw/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "2b6a31b4cca71b7358e832a5cf383ad5e5f38e38",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/projects/ProjectManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/projects/ProjectManagerImpl.java?ref=be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
                "deletions": 0,
                "filename": "server/src/com/cloud/projects/ProjectManagerImpl.java",
                "patch": "@@ -515,6 +515,11 @@ public ProjectVO findByProjectAccountId(long projectAccountId) {\n         return _projectDao.findByProjectAccountId(projectAccountId);\n     }\n     \n+    @Override\n+    public ProjectVO findByProjectAccountIdIncludingRemoved(long projectAccountId) {\n+        return _projectDao.findByProjectAccountIdIncludingRemoved(projectAccountId);\n+    }\n+    \n     @Override\n     public Project findByNameAndDomainId(String name, long domainId) {\n         return _projectDao.findByNameAndDomain(name, domainId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/projects/ProjectManagerImpl.java",
                "sha": "77b778eb244aed09d02edda7a009949a588b8b8d",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/projects/dao/ProjectDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/projects/dao/ProjectDao.java?ref=be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
                "deletions": 0,
                "filename": "server/src/com/cloud/projects/dao/ProjectDao.java",
                "patch": "@@ -31,5 +31,7 @@\n     ProjectVO findByProjectAccountId(long projectAccountId);\n \n     List<ProjectVO> listByState(Project.State state);\n+    \n+    ProjectVO findByProjectAccountIdIncludingRemoved(long projectAccountId);\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/projects/dao/ProjectDao.java",
                "sha": "e741f2444b3592cc01ccb41723c24a8b4551a2fb",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/projects/dao/ProjectDaoImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/projects/dao/ProjectDaoImpl.java?ref=be2017849a0303aaf66d4f4bf136f0b2ae4f7a32",
                "deletions": 0,
                "filename": "server/src/com/cloud/projects/dao/ProjectDaoImpl.java",
                "patch": "@@ -108,4 +108,12 @@ public ProjectVO findByProjectAccountId(long projectAccountId) {\n         sc.setParameters(\"state\", state);\n         return listBy(sc);\n     }\n+    \n+    @Override\n+    public ProjectVO findByProjectAccountIdIncludingRemoved(long projectAccountId) {\n+        SearchCriteria<ProjectVO> sc = AllFieldsSearch.create();\n+        sc.setParameters(\"projectAccountId\", projectAccountId);\n+\n+        return findOneIncludingRemovedBy(sc);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/be2017849a0303aaf66d4f4bf136f0b2ae4f7a32/server/src/com/cloud/projects/dao/ProjectDaoImpl.java",
                "sha": "81e170a1822bf63528cac70d6df58d2d9615d4bd",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-84: fixed NPE that used to happen on API layer when list resource of the project was called when project was going through removal process.",
        "parent": "https://github.com/apache/cloudstack/commit/f6ab8b4344fa1cdce47091dc2d0baef906a5a8ed",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_be3a39e": {
        "bug_id": "cloudstack_be3a39e",
        "commit": "https://github.com/apache/cloudstack/commit/be3a39ea4fcb1f758d72c4e4abc43f428845c4d1",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/be3a39ea4fcb1f758d72c4e4abc43f428845c4d1/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java?ref=be3a39ea4fcb1f758d72c4e4abc43f428845c4d1",
                "deletions": 1,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "patch": "@@ -3478,7 +3478,9 @@ public boolean addNetworkRules(final String vmName, final String vmId, final Str\n         cmd.add(\"--vmname\", vmName);\n         cmd.add(\"--vmid\", vmId);\n         cmd.add(\"--vmip\", guestIP);\n-        cmd.add(\"--vmip6\", guestIP6);\n+        if (StringUtils.isNotBlank(guestIP6)) {\n+            cmd.add(\"--vmip6\", guestIP6);\n+        }\n         cmd.add(\"--sig\", sig);\n         cmd.add(\"--seq\", seq);\n         cmd.add(\"--vmmac\", mac);",
                "raw_url": "https://github.com/apache/cloudstack/raw/be3a39ea4fcb1f758d72c4e4abc43f428845c4d1/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "sha": "952fe9e7cc9e1e37a51c238fa6f17e94f413c76d",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-10177: Only pass IPv6 address to Security Group Python script if present (#2355)\n\nOtherwise we send down a 'null' to a ProcessBuilder in Java instead of a String and this\r\ncauses a NPE.\r\n\r\nWe should check first if the Instance has a IPv6 address before sending it there.\r\n\r\nSigned-off-by: Wido den Hollander <wido@widodh.nl>",
        "parent": "https://github.com/apache/cloudstack/commit/637d9a62c54a7b6eac939d7569fcafc0d2a075bd",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_bf987c5": {
        "bug_id": "cloudstack_bf987c5",
        "commit": "https://github.com/apache/cloudstack/commit/bf987c57d9c3b14c189e52a1e2f284d008a37d33",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/bf987c57d9c3b14c189e52a1e2f284d008a37d33/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=bf987c57d9c3b14c189e52a1e2f284d008a37d33",
                "deletions": 0,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -2658,6 +2658,11 @@ protected DiskProfile toDiskProfile(VolumeVO vol, DiskOfferingVO offering) {\n             vol.setInstanceId(vm.getId());\n         }\n         \n+        if(type.equals(VolumeType.ROOT))\n+        \tvol.setDeviceId(0l);\n+        else\n+        \tvol.setDeviceId(1l);\n+        \n         vol = _volsDao.persist(vol);\n         \n         return toDiskProfile(vol, offering);\n@@ -2684,6 +2689,11 @@ protected DiskProfile toDiskProfile(VolumeVO vol, DiskOfferingVO offering) {\n         }\n         vol.setTemplateId(template.getId());\n         \n+        if(type.equals(VolumeType.ROOT))\n+        \tvol.setDeviceId(0l);\n+        else\n+        \tvol.setDeviceId(1l);\n+        \n         vol = _volsDao.persist(vol);\n         \n         return toDiskProfile(vol, offering);",
                "raw_url": "https://github.com/apache/cloudstack/raw/bf987c57d9c3b14c189e52a1e2f284d008a37d33/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "a991c0eab1cfcb1e1c3b5ce1e7951ce0114d522c",
                "status": "modified"
            }
        ],
        "message": "bug 6838: during vm creation, the volume's device id wasn't set leading to npe during attaching a new vol to the vm (it checks for device ids)\nstatus 6838: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/01b4af30068b7d08f86ce2fd09557cf349888637",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_c08d151": {
        "bug_id": "cloudstack_c08d151",
        "commit": "https://github.com/apache/cloudstack/commit/c08d151e0572ce105b71658ea40978b66c5c0f69",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/c08d151e0572ce105b71658ea40978b66c5c0f69/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ConfigurationServerImpl.java?ref=c08d151e0572ce105b71658ea40978b66c5c0f69",
                "deletions": 2,
                "filename": "server/src/com/cloud/server/ConfigurationServerImpl.java",
                "patch": "@@ -341,8 +341,8 @@ protected void saveUser() {\n         }\n \n         // now insert the user\n-        insertSql = \"INSERT INTO `cloud`.`user` (id, uuid, username, account_id, firstname, lastname, created, state) \" +\n-                \"VALUES (\" + id + \", UUID(), '\" + username + \"', 2, '\" + firstname + \"','\" + lastname + \"',now(), 'disabled')\";\n+        insertSql = \"INSERT INTO `cloud`.`user` (id, username, password, account_id, firstname, lastname, created, state) \" +\n+                \"VALUES (\" + id + \",'\" + username + \"', RAND(), 2, '\" + firstname + \"','\" + lastname + \"',now(), 'disabled')\";\n \n         txn = Transaction.currentTxn();\n         try {",
                "raw_url": "https://github.com/apache/cloudstack/raw/c08d151e0572ce105b71658ea40978b66c5c0f69/server/src/com/cloud/server/ConfigurationServerImpl.java",
                "sha": "74fba8967531e5d0f5566708803aab23a1fbe23d",
                "status": "modified"
            }
        ],
        "message": "https://issues.apache.org/jira/browse/CLOUDSTACK-993\n\nChanges:\n- Introduction of maven skipped the java code that inserts the admin user. This causes the NPE in management server while trying to find the user and also, admin user cannot login as expected.\n- Fixing the insertion of the admin user as part of startup.",
        "parent": "https://github.com/apache/cloudstack/commit/975021dda1aeee24c8729407e323a5e884e9ad31",
        "repo": "cloudstack",
        "unit_tests": [
            "ConfigurationServerImplTest.java"
        ]
    },
    "cloudstack_c27dd62": {
        "bug_id": "cloudstack_c27dd62",
        "commit": "https://github.com/apache/cloudstack/commit/c27dd6293e6600e4253aa09b00d515a55ee533c1",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/c27dd6293e6600e4253aa09b00d515a55ee533c1/server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/VpcManagerImpl.java?ref=c27dd6293e6600e4253aa09b00d515a55ee533c1",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "patch": "@@ -1421,7 +1421,9 @@ public void doInTransactionWithoutResult(TransactionStatus status) {\n \n     @Override\n     public List<? extends Vpc> getVpcsForAccount(long accountId) {\n-        return _vpcDao.listByAccountId(accountId);\n+        List<Vpc> vpcs = new ArrayList<Vpc>();\n+        vpcs.addAll(_vpcDao.listByAccountId(accountId));\n+        return vpcs;\n     }\n \n     public boolean cleanupVpcResources(long vpcId, Account caller, long callerUserId) throws ResourceUnavailableException, ConcurrentOperationException {",
                "raw_url": "https://github.com/apache/cloudstack/raw/c27dd6293e6600e4253aa09b00d515a55ee533c1/server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "sha": "c49da15d024f3cffe6fbfdc957957254a63b259d",
                "status": "modified"
            }
        ],
        "message": "CID-1233085: Fix potential NPE in AccountManagerImpl from VpcManagerImpl\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/33a6640c04137ccdfc6d9b8bfbcd70c6ddeb369d",
        "repo": "cloudstack",
        "unit_tests": [
            "VpcManagerImplTest.java"
        ]
    },
    "cloudstack_c2da4ea": {
        "bug_id": "cloudstack_c2da4ea",
        "commit": "https://github.com/apache/cloudstack/commit/c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/client/tomcatconf/applicationContext.xml.in",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/applicationContext.xml.in?ref=c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
                "deletions": 1,
                "filename": "client/tomcatconf/applicationContext.xml.in",
                "patch": "@@ -317,7 +317,6 @@\n   <bean id=\"site2SiteCustomerGatewayDaoImpl\" class=\"com.cloud.network.dao.Site2SiteCustomerGatewayDaoImpl\" />\n   <bean id=\"site2SiteVpnConnectionDaoImpl\" class=\"com.cloud.network.dao.Site2SiteVpnConnectionDaoImpl\" />\n   <bean id=\"site2SiteVpnGatewayDaoImpl\" class=\"com.cloud.network.dao.Site2SiteVpnGatewayDaoImpl\" />\n-  <bean id=\"snapshotDao2Impl\" class=\"org.apache.cloudstack.storage.snapshot.db.SnapshotDao2Impl\" />\n   <bean id=\"snapshotDaoImpl\" class=\"com.cloud.storage.dao.SnapshotDaoImpl\" />\n   <bean id=\"snapshotPolicyDaoImpl\" class=\"com.cloud.storage.dao.SnapshotPolicyDaoImpl\" />\n   <bean id=\"snapshotScheduleDaoImpl\" class=\"com.cloud.storage.dao.SnapshotScheduleDaoImpl\" />",
                "raw_url": "https://github.com/apache/cloudstack/raw/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/client/tomcatconf/applicationContext.xml.in",
                "sha": "2a746a9cd053d1c1bd7ddc4e826c5da178dc8023",
                "status": "modified"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/cloudstack/blob/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "changes": 50,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java?ref=c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
                "deletions": 25,
                "filename": "engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "patch": "@@ -44,8 +44,8 @@\n import com.cloud.storage.Storage.ImageFormat;\n import com.cloud.storage.Storage.TemplateType;\n import com.cloud.storage.VMTemplateStoragePoolVO;\n-import com.cloud.storage.VMTemplateVO;\n import com.cloud.storage.VMTemplateStorageResourceAssoc.Status;\n+import com.cloud.storage.VMTemplateVO;\n import com.cloud.storage.dao.VMTemplateDao;\n import com.cloud.storage.dao.VMTemplatePoolDao;\n import com.cloud.utils.component.ComponentContext;\n@@ -122,12 +122,12 @@ public Long getSize() {\n         }\n \n         /*\n-         *\n+         * \n          * // If the template that was passed into this allocator is not\n          * installed in the storage pool, // add 3 * (template size on secondary\n          * storage) to the running total VMTemplateHostVO templateHostVO =\n          * _storageMgr.findVmTemplateHost(templateForVmCreation.getId(), null);\n-         *\n+         * \n          * if (templateHostVO == null) { VMTemplateSwiftVO templateSwiftVO =\n          * _swiftMgr.findByTmpltId(templateForVmCreation.getId()); if\n          * (templateSwiftVO != null) { long templateSize =\n@@ -152,12 +152,14 @@ public ImageFormat getFormat() {\n         return this.imageVO.getFormat();\n     }\n \n-//    public boolean stateTransit(TemplateEvent e) throws NoTransitionException {\n-//        this.imageVO = imageDao.findById(this.imageVO.getId());\n-//        boolean result = imageMgr.getStateMachine().transitTo(this.imageVO, e, null, imageDao);\n-//        this.imageVO = imageDao.findById(this.imageVO.getId());\n-//        return result;\n-//    }\n+    // public boolean stateTransit(TemplateEvent e) throws NoTransitionException\n+    // {\n+    // this.imageVO = imageDao.findById(this.imageVO.getId());\n+    // boolean result = imageMgr.getStateMachine().transitTo(this.imageVO, e,\n+    // null, imageDao);\n+    // this.imageVO = imageDao.findById(this.imageVO.getId());\n+    // return result;\n+    // }\n \n     @Override\n     public void processEvent(Event event) {\n@@ -175,9 +177,10 @@ public void processEvent(Event event) {\n                     templEvent = TemplateEvent.OperationFailed;\n                 }\n \n-//                if (templEvent != null && this.getDataStore().getRole() == DataStoreRole.Image) {\n-//                    this.stateTransit(templEvent);\n-//                }\n+                // if (templEvent != null && this.getDataStore().getRole() ==\n+                // DataStoreRole.Image) {\n+                // this.stateTransit(templEvent);\n+                // }\n             }\n \n             objectInStoreMgr.update(this, event);\n@@ -238,9 +241,10 @@ public void processEvent(ObjectInDataStoreStateMachine.Event event, Answer answe\n                     templEvent = TemplateEvent.OperationFailed;\n                 }\n \n-//                if (templEvent != null && this.getDataStore().getRole() == DataStoreRole.Image) {\n-//                    this.stateTransit(templEvent);\n-//                }\n+                // if (templEvent != null && this.getDataStore().getRole() ==\n+                // DataStoreRole.Image) {\n+                // this.stateTransit(templEvent);\n+                // }\n             }\n             objectInStoreMgr.update(this, event);\n         } catch (NoTransitionException e) {\n@@ -264,9 +268,8 @@ public void incRefCount() {\n             return;\n         }\n \n-        if (this.dataStore.getRole() == DataStoreRole.Image ||\n-                this.dataStore.getRole() == DataStoreRole.ImageCache) {\n-            TemplateDataStoreVO store = templateStoreDao.findById(this.dataStore.getId());\n+        if (this.dataStore.getRole() == DataStoreRole.Image || this.dataStore.getRole() == DataStoreRole.ImageCache) {\n+            TemplateDataStoreVO store = templateStoreDao.findByStoreTemplate(dataStore.getId(), this.getId());\n             store.incrRefCnt();\n             store.setLastUpdated(new Date());\n             templateStoreDao.update(store.getId(), store);\n@@ -278,9 +281,8 @@ public void decRefCount() {\n         if (this.dataStore == null) {\n             return;\n         }\n-        if (this.dataStore.getRole() == DataStoreRole.Image ||\n-                this.dataStore.getRole() == DataStoreRole.ImageCache) {\n-            TemplateDataStoreVO store = templateStoreDao.findById(this.dataStore.getId());\n+        if (this.dataStore.getRole() == DataStoreRole.Image || this.dataStore.getRole() == DataStoreRole.ImageCache) {\n+            TemplateDataStoreVO store = templateStoreDao.findByStoreTemplate(dataStore.getId(), this.getId());\n             store.decrRefCnt();\n             store.setLastUpdated(new Date());\n             templateStoreDao.update(store.getId(), store);\n@@ -292,9 +294,8 @@ public Long getRefCount() {\n         if (this.dataStore == null) {\n             return null;\n         }\n-        if (this.dataStore.getRole() == DataStoreRole.Image ||\n-                this.dataStore.getRole() == DataStoreRole.ImageCache) {\n-            TemplateDataStoreVO store = templateStoreDao.findById(this.dataStore.getId());\n+        if (this.dataStore.getRole() == DataStoreRole.Image || this.dataStore.getRole() == DataStoreRole.ImageCache) {\n+            TemplateDataStoreVO store = templateStoreDao.findByStoreTemplate(dataStore.getId(), this.getId());\n             return store.getRefCnt();\n         }\n         return null;\n@@ -442,5 +443,4 @@ public boolean delete() {\n         return true;\n     }\n \n-\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/engine/storage/image/src/org/apache/cloudstack/storage/image/store/TemplateObject.java",
                "sha": "74a7d43e00b9be365fcbb3b05b718def3c37ba77",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/engine/storage/snapshot/src/org/apache/cloudstack/storage/snapshot/SnapshotObject.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/snapshot/src/org/apache/cloudstack/storage/snapshot/SnapshotObject.java?ref=c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
                "deletions": 10,
                "filename": "engine/storage/snapshot/src/org/apache/cloudstack/storage/snapshot/SnapshotObject.java",
                "patch": "@@ -22,7 +22,6 @@\n \n import javax.inject.Inject;\n \n-import com.cloud.storage.DataStoreRole;\n import org.apache.cloudstack.engine.subsystem.api.storage.DataStore;\n import org.apache.cloudstack.engine.subsystem.api.storage.ObjectInDataStoreStateMachine;\n import org.apache.cloudstack.engine.subsystem.api.storage.SnapshotDataFactory;\n@@ -41,6 +40,7 @@\n import com.cloud.agent.api.to.DataObjectType;\n import com.cloud.agent.api.to.DataTO;\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n+import com.cloud.storage.DataStoreRole;\n import com.cloud.storage.Snapshot;\n import com.cloud.storage.SnapshotVO;\n import com.cloud.storage.dao.SnapshotDao;\n@@ -279,9 +279,9 @@ public void incRefCount() {\n             return;\n         }\n \n-        if (this.store.getRole() == DataStoreRole.Image ||\n-                this.store.getRole() == DataStoreRole.ImageCache) {\n-            SnapshotDataStoreVO store = snapshotStoreDao.findById(this.store.getId());\n+        if (this.store.getRole() == DataStoreRole.Image || this.store.getRole() == DataStoreRole.ImageCache) {\n+            SnapshotDataStoreVO store = snapshotStoreDao.findByStoreSnapshot(this.store.getRole(), this.store.getId(),\n+                    this.getId());\n             store.incrRefCnt();\n             store.setLastUpdated(new Date());\n             snapshotStoreDao.update(store.getId(), store);\n@@ -293,9 +293,9 @@ public void decRefCount() {\n         if (this.store == null) {\n             return;\n         }\n-        if (this.store.getRole() == DataStoreRole.Image ||\n-                this.store.getRole() == DataStoreRole.ImageCache) {\n-            SnapshotDataStoreVO store = snapshotStoreDao.findById(this.store.getId());\n+        if (this.store.getRole() == DataStoreRole.Image || this.store.getRole() == DataStoreRole.ImageCache) {\n+            SnapshotDataStoreVO store = snapshotStoreDao.findByStoreSnapshot(this.store.getRole(), this.store.getId(),\n+                    this.getId());\n             store.decrRefCnt();\n             store.setLastUpdated(new Date());\n             snapshotStoreDao.update(store.getId(), store);\n@@ -307,9 +307,9 @@ public Long getRefCount() {\n         if (this.store == null) {\n             return null;\n         }\n-        if (this.store.getRole() == DataStoreRole.Image ||\n-                this.store.getRole() == DataStoreRole.ImageCache) {\n-            SnapshotDataStoreVO store = snapshotStoreDao.findById(this.store.getId());\n+        if (this.store.getRole() == DataStoreRole.Image || this.store.getRole() == DataStoreRole.ImageCache) {\n+            SnapshotDataStoreVO store = snapshotStoreDao.findByStoreSnapshot(this.store.getRole(), this.store.getId(),\n+                    this.getId());\n             return store.getRefCnt();\n         }\n         return null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/engine/storage/snapshot/src/org/apache/cloudstack/storage/snapshot/SnapshotObject.java",
                "sha": "1cba96efd40a948402128b210c15eeb4611a98ea",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java?ref=c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
                "deletions": 10,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "patch": "@@ -252,7 +252,6 @@ public void processEventOnly(ObjectInDataStoreStateMachine.Event event) {\n         }\n     }\n \n-\n     @Override\n     public String getName() {\n         return this.volumeVO.getName();\n@@ -456,9 +455,8 @@ public void incRefCount() {\n             return;\n         }\n \n-        if (this.dataStore.getRole() == DataStoreRole.Image ||\n-                this.dataStore.getRole() == DataStoreRole.ImageCache) {\n-            VolumeDataStoreVO store = volumeStoreDao.findById(this.dataStore.getId());\n+        if (this.dataStore.getRole() == DataStoreRole.Image || this.dataStore.getRole() == DataStoreRole.ImageCache) {\n+            VolumeDataStoreVO store = volumeStoreDao.findByStoreVolume(this.dataStore.getId(), this.getId());\n             store.incrRefCnt();\n             store.setLastUpdated(new Date());\n             volumeStoreDao.update(store.getId(), store);\n@@ -470,9 +468,8 @@ public void decRefCount() {\n         if (this.dataStore == null) {\n             return;\n         }\n-        if (this.dataStore.getRole() == DataStoreRole.Image ||\n-                this.dataStore.getRole() == DataStoreRole.ImageCache) {\n-            VolumeDataStoreVO store = volumeStoreDao.findById(this.dataStore.getId());\n+        if (this.dataStore.getRole() == DataStoreRole.Image || this.dataStore.getRole() == DataStoreRole.ImageCache) {\n+            VolumeDataStoreVO store = volumeStoreDao.findByStoreVolume(this.dataStore.getId(), this.getId());\n             store.decrRefCnt();\n             store.setLastUpdated(new Date());\n             volumeStoreDao.update(store.getId(), store);\n@@ -484,9 +481,8 @@ public Long getRefCount() {\n         if (this.dataStore == null) {\n             return null;\n         }\n-        if (this.dataStore.getRole() == DataStoreRole.Image ||\n-                this.dataStore.getRole() == DataStoreRole.ImageCache) {\n-            VolumeDataStoreVO store = volumeStoreDao.findById(this.dataStore.getId());\n+        if (this.dataStore.getRole() == DataStoreRole.Image || this.dataStore.getRole() == DataStoreRole.ImageCache) {\n+            VolumeDataStoreVO store = volumeStoreDao.findByStoreVolume(this.dataStore.getId(), this.getId());\n             return store.getRefCnt();\n         }\n         return null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "sha": "d689195957c3adf0c36588f9514b12da55baa381",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java?ref=c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
                "deletions": 2,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java",
                "patch": "@@ -699,8 +699,6 @@ public Answer attachVolume(AttachCommand cmd) {\n             s_logger.debug(\"Failed to attach volume: \" + vol.getPath() + \", due to \" + e.toString());\n             return new AttachAnswer(e.toString());\n         }\n-\n-        \n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java",
                "sha": "f0f916a411c47bd17aa2399cf8467e654e739deb",
                "status": "modified"
            },
            {
                "additions": 56,
                "blob_url": "https://github.com/apache/cloudstack/blob/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/server/src/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java",
                "changes": 97,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java?ref=c2da4eac89d932ce1bf15440c4ae2095e123d8b8",
                "deletions": 41,
                "filename": "server/src/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java",
                "patch": "@@ -23,7 +23,6 @@\n import java.util.Map;\n import java.util.UUID;\n \n-import javax.ejb.Local;\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n@@ -62,20 +61,26 @@\n import com.cloud.resource.UnableDeleteHostException;\n import com.cloud.utils.ssh.SSHCmdHelper;\n \n-public abstract class LibvirtServerDiscoverer extends DiscovererBase implements Discoverer,\n-Listener, ResourceStateAdapter {\n+public abstract class LibvirtServerDiscoverer extends DiscovererBase implements Discoverer, Listener,\n+        ResourceStateAdapter {\n     private static final Logger s_logger = Logger.getLogger(LibvirtServerDiscoverer.class);\n     private String _hostIp;\n-    private final int _waitTime = 5; /*wait for 5 minutes*/\n+    private final int _waitTime = 5; /* wait for 5 minutes */\n     private String _kvmPrivateNic;\n     private String _kvmPublicNic;\n     private String _kvmGuestNic;\n-    @Inject HostDao _hostDao = null;\n-    @Inject ClusterDao _clusterDao;\n-    @Inject ResourceManager _resourceMgr;\n-    @Inject AgentManager _agentMgr;\n-    @Inject ConfigurationDao _configDao;\n-    @Inject NetworkModel _networkMgr;\n+    @Inject\n+    HostDao _hostDao = null;\n+    @Inject\n+    ClusterDao _clusterDao;\n+    @Inject\n+    ResourceManager _resourceMgr;\n+    @Inject\n+    AgentManager _agentMgr;\n+    @Inject\n+    ConfigurationDao _configDao;\n+    @Inject\n+    NetworkModel _networkMgr;\n \n     public abstract Hypervisor.HypervisorType getHypervisorType();\n \n@@ -92,8 +97,7 @@ public boolean processCommands(long agentId, long seq, Command[] commands) {\n     }\n \n     @Override\n-    public AgentControlAnswer processControlCommand(long agentId,\n-            AgentControlCommand cmd) {\n+    public AgentControlAnswer processControlCommand(long agentId, AgentControlCommand cmd) {\n         // TODO Auto-generated method stub\n         return null;\n     }\n@@ -127,14 +131,13 @@ public boolean processTimeout(long agentId, long seq) {\n     }\n \n     @Override\n-    public Map<? extends ServerResource, Map<String, String>> find(long dcId,\n-            Long podId, Long clusterId, URI uri, String username,\n-            String password, List<String> hostTags) throws DiscoveryException {\n+    public Map<? extends ServerResource, Map<String, String>> find(long dcId, Long podId, Long clusterId, URI uri,\n+            String username, String password, List<String> hostTags) throws DiscoveryException {\n \n         ClusterVO cluster = _clusterDao.findById(clusterId);\n-        if(cluster == null || cluster.getHypervisorType() != getHypervisorType()) {\n-            if(s_logger.isInfoEnabled())\n-                s_logger.info(\"invalid cluster id or cluster is not for \" + getHypervisorType() + \" hypervisors\"); \n+        if (cluster == null || cluster.getHypervisorType() != getHypervisorType()) {\n+            if (s_logger.isInfoEnabled())\n+                s_logger.info(\"invalid cluster id or cluster is not for \" + getHypervisorType() + \" hypervisors\");\n             return null;\n         }\n \n@@ -153,11 +156,16 @@ public boolean processTimeout(long agentId, long seq) {\n             InetAddress ia = InetAddress.getByName(hostname);\n             agentIp = ia.getHostAddress();\n             String guid = UUID.nameUUIDFromBytes(agentIp.getBytes()).toString();\n-            String guidWithTail = guid + \"-LibvirtComputingResource\";/*tail added by agent.java*/\n+            String guidWithTail = guid + \"-LibvirtComputingResource\";/*\n+                                                                      * tail\n+                                                                      * added by\n+                                                                      * agent\n+                                                                      * .java\n+                                                                      */\n             if (_resourceMgr.findHostByGuid(guidWithTail) != null) {\n                 s_logger.debug(\"Skipping \" + agentIp + \" because \" + guidWithTail + \" is already in the database.\");\n                 return null;\n-            }       \n+            }\n \n             sshConnection = new com.trilead.ssh2.Connection(agentIp, 22);\n \n@@ -172,7 +180,7 @@ public boolean processTimeout(long agentId, long seq) {\n                 return null;\n             }\n \n-            List <PhysicalNetworkSetupInfo> netInfos = _networkMgr.getPhysicalNetworkInfo(dcId, getHypervisorType());\n+            List<PhysicalNetworkSetupInfo> netInfos = _networkMgr.getPhysicalNetworkInfo(dcId, getHypervisorType());\n             String kvmPrivateNic = null;\n             String kvmPublicNic = null;\n             String kvmGuestNic = null;\n@@ -193,7 +201,7 @@ public boolean processTimeout(long agentId, long seq) {\n                 kvmPrivateNic = _kvmPrivateNic;\n                 kvmPublicNic = _kvmPublicNic;\n                 kvmGuestNic = _kvmGuestNic;\n-            } \n+            }\n \n             if (kvmPublicNic == null) {\n                 kvmPublicNic = (kvmGuestNic != null) ? kvmGuestNic : kvmPrivateNic;\n@@ -207,7 +215,8 @@ public boolean processTimeout(long agentId, long seq) {\n                 kvmGuestNic = (kvmPublicNic != null) ? kvmPublicNic : kvmPrivateNic;\n             }\n \n-            String parameters = \" -m \" + _hostIp + \" -z \" + dcId + \" -p \" + podId + \" -c \" + clusterId + \" -g \" + guid + \" -a\";\n+            String parameters = \" -m \" + _hostIp + \" -z \" + dcId + \" -p \" + podId + \" -c \" + clusterId + \" -g \" + guid\n+                    + \" -a\";\n \n             parameters += \" --pubNic=\" + kvmPublicNic;\n             parameters += \" --prvNic=\" + kvmPrivateNic;\n@@ -220,8 +229,8 @@ public boolean processTimeout(long agentId, long seq) {\n \n             params.put(\"zone\", Long.toString(dcId));\n             params.put(\"pod\", Long.toString(podId));\n-            params.put(\"cluster\",  Long.toString(clusterId));\n-            params.put(\"guid\", guid); \n+            params.put(\"cluster\", Long.toString(clusterId));\n+            params.put(\"guid\", guid);\n             params.put(\"agentIp\", agentIp);\n             kvmResource.configure(\"kvm agent\", params);\n             resources.put(kvmResource, details);\n@@ -238,16 +247,16 @@ public boolean processTimeout(long agentId, long seq) {\n                 _clusterDao.update(clusterId, cluster);\n             }\n \n-            //save user name and password\n+            // save user name and password\n             _hostDao.loadDetails(connectedHost);\n             Map<String, String> hostDetails = connectedHost.getDetails();\n             hostDetails.put(\"password\", password);\n             hostDetails.put(\"username\", username);\n             _hostDao.saveDetails(connectedHost);\n             return resources;\n-        } catch (DiscoveredWithErrorException e){ \n+        } catch (DiscoveredWithErrorException e) {\n             throw e;\n-        }catch (Exception e) {\n+        } catch (Exception e) {\n             String msg = \" can't setup agent, due to \" + e.toString() + \" - \" + e.getMessage();\n             s_logger.warn(msg);\n         } finally {\n@@ -259,7 +268,7 @@ public boolean processTimeout(long agentId, long seq) {\n     }\n \n     private HostVO waitForHostConnect(long dcId, long podId, long clusterId, String guid) {\n-        for (int i = 0; i < _waitTime *2; i++) {\n+        for (int i = 0; i < _waitTime * 2; i++) {\n             List<HostVO> hosts = _resourceMgr.listAllUpAndEnabledHosts(Host.Type.Routing, clusterId, podId, dcId);\n             for (HostVO host : hosts) {\n                 if (host.getGuid().equalsIgnoreCase(guid)) {\n@@ -283,7 +292,8 @@ private HostVO waitForHostConnect(long dcId, long podId, long clusterId, String\n \n     @Override\n     public boolean configure(String name, Map<String, Object> params) throws ConfigurationException {\n-//        _setupAgentPath = Script.findScript(getPatchPath(), \"setup_agent.sh\");\n+        // _setupAgentPath = Script.findScript(getPatchPath(),\n+        // \"setup_agent.sh\");\n         _kvmPrivateNic = _configDao.getValue(Config.KvmPrivateNetwork.key());\n         if (_kvmPrivateNic == null) {\n             _kvmPrivateNic = \"cloudbr0\";\n@@ -312,15 +322,14 @@ protected String getPatchPath() {\n     }\n \n     @Override\n-    public void postDiscovery(List<HostVO> hosts, long msId)\n-            throws DiscoveryException {\n+    public void postDiscovery(List<HostVO> hosts, long msId) throws DiscoveryException {\n         // TODO Auto-generated method stub\n     }\n \n     @Override\n     public boolean matchHypervisor(String hypervisor) {\n         // for backwards compatibility, if not supplied, always let to try it\n-        if(hypervisor == null)\n+        if (hypervisor == null)\n             return true;\n \n         return getHypervisorType().toString().equalsIgnoreCase(hypervisor);\n@@ -340,15 +349,21 @@ public HostVO createHostVOForConnectedAgent(HostVO host, StartupCommand[] cmd) {\n \n         /* KVM requires host are the same in cluster */\n         ClusterVO clusterVO = _clusterDao.findById(host.getClusterId());\n+        if (clusterVO == null) {\n+            s_logger.debug(\"cannot find cluster: \" + host.getClusterId());\n+            throw new IllegalArgumentException(\"cannot add host, due to can't find cluster: \" + host.getClusterId());\n+        }\n+\n         List<HostVO> hostsInCluster = _resourceMgr.listAllHostsInCluster(clusterVO.getId());\n         if (!hostsInCluster.isEmpty()) {\n             HostVO oneHost = hostsInCluster.get(0);\n             _hostDao.loadDetails(oneHost);\n             String hostOsInCluster = oneHost.getDetail(\"Host.OS\");\n             String hostOs = ssCmd.getHostDetails().get(\"Host.OS\");\n             if (!hostOsInCluster.equalsIgnoreCase(hostOs)) {\n-                throw new IllegalArgumentException(\"Can't add host: \" + firstCmd.getPrivateIpAddress() + \" with hostOS: \" + hostOs + \" into a cluster,\"\n-                        + \"in which there are \" + hostOsInCluster + \" hosts added\");\n+                throw new IllegalArgumentException(\"Can't add host: \" + firstCmd.getPrivateIpAddress()\n+                        + \" with hostOS: \" + hostOs + \" into a cluster,\" + \"in which there are \" + hostOsInCluster\n+                        + \" hosts added\");\n             }\n         }\n \n@@ -358,17 +373,17 @@ public HostVO createHostVOForConnectedAgent(HostVO host, StartupCommand[] cmd) {\n     }\n \n     @Override\n-    public HostVO createHostVOForDirectConnectAgent(HostVO host, StartupCommand[] startup, ServerResource resource, Map<String, String> details,\n-            List<String> hostTags) {\n+    public HostVO createHostVOForDirectConnectAgent(HostVO host, StartupCommand[] startup, ServerResource resource,\n+            Map<String, String> details, List<String> hostTags) {\n         // TODO Auto-generated method stub\n         return null;\n     }\n \n     @Override\n-    public DeleteHostAnswer deleteHost(HostVO host, boolean isForced, boolean isForceDeleteStorage) throws UnableDeleteHostException {\n-        if (host.getType() != Host.Type.Routing || \n-            (host.getHypervisorType() != HypervisorType.KVM &&\n-             host.getHypervisorType() != HypervisorType.LXC)) {\n+    public DeleteHostAnswer deleteHost(HostVO host, boolean isForced, boolean isForceDeleteStorage)\n+            throws UnableDeleteHostException {\n+        if (host.getType() != Host.Type.Routing\n+                || (host.getHypervisorType() != HypervisorType.KVM && host.getHypervisorType() != HypervisorType.LXC)) {\n             return null;\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/c2da4eac89d932ce1bf15440c4ae2095e123d8b8/server/src/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java",
                "sha": "f59bdf370aaf217c3ab48f5a6131fbd3ffdc3f1b",
                "status": "modified"
            }
        ],
        "message": "fix NPE for cache ref cnt",
        "parent": "https://github.com/apache/cloudstack/commit/a715eb8121b3e9b6bb61fe3db150580b22e4b3aa",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeObjectTest.java",
            "KVMStorageProcessorTest.java"
        ]
    },
    "cloudstack_c31605d": {
        "bug_id": "cloudstack_c31605d",
        "commit": "https://github.com/apache/cloudstack/commit/c31605d51fad79c05469e663e5fb8606ef613d56",
        "file": [
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/cloudstack/blob/c31605d51fad79c05469e663e5fb8606ef613d56/api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java?ref=c31605d51fad79c05469e663e5fb8606ef613d56",
                "deletions": 0,
                "filename": "api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java",
                "patch": "@@ -24,6 +24,7 @@\n import com.cloud.api.BaseCmd;\n import com.cloud.api.Implementation;\n import com.cloud.api.Parameter;\n+import com.cloud.api.BaseCmd.CommandType;\n import com.cloud.api.response.SSHKeyPairResponse;\n import com.cloud.user.Account;\n import com.cloud.user.SSHKeyPair;\n@@ -45,6 +46,12 @@\n     @Parameter(name=\"publickey\", type=CommandType.STRING, required=true, description=\"Public key material of the keypair\") \n     private String publicKey;\n \n+    //Owner information\n+    @Parameter(name=ApiConstants.ACCOUNT, type=CommandType.STRING, description=\"an optional account for the ssh key. Must be used with domainId.\")\n+    private String accountName;\n+    \n+    @Parameter(name=ApiConstants.DOMAIN_ID, type=CommandType.LONG, description=\"an optional domainId for the ssh key. If the account parameter is used, domainId must also be used.\")\n+    private Long domainId;\n     \n     /////////////////////////////////////////////////////\n     /////////////////// Accessors ///////////////////////\n@@ -58,6 +65,13 @@ public String getPublicKey() {\n \t\treturn publicKey;\n \t}\n \n+\tpublic String getAccountName() {\n+\t    return accountName;\n+\t}\n+\t    \n+    public Long getDomainId() {\n+        return domainId;\n+    }\n     \n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////",
                "raw_url": "https://github.com/apache/cloudstack/raw/c31605d51fad79c05469e663e5fb8606ef613d56/api/src/com/cloud/api/commands/RegisterSSHKeyPairCmd.java",
                "sha": "243df8b54c15fa6db06e693e1f16dc9e0621f524",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/c31605d51fad79c05469e663e5fb8606ef613d56/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=c31605d51fad79c05469e663e5fb8606ef613d56",
                "deletions": 10,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -4598,7 +4598,7 @@ public SSHKeyPair createSSHKeyPair(CreateSSHKeyPairCmd cmd) {\n         String fingerprint = keys.getPublicKeyFingerPrint();\n         String privateKey = keys.getPrivateKey();\n \n-        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, privateKey);\n+        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, privateKey, owner);\n     }\n \n     @Override\n@@ -4670,29 +4670,32 @@ public boolean deleteSSHKeyPair(DeleteSSHKeyPairCmd cmd) {\n \n     @Override\n     public SSHKeyPair registerSSHKeyPair(RegisterSSHKeyPairCmd cmd) {\n-        Account account = UserContext.current().getCaller();\n-        SSHKeyPairVO s = _sshKeyPairDao.findByName(account.getAccountId(), account.getDomainId(), cmd.getName());\n+        Account caller = UserContext.current().getCaller();\n+        \n+        Account owner = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId());\n+        \n+        SSHKeyPairVO s = _sshKeyPairDao.findByName(owner.getAccountId(), owner.getDomainId(), cmd.getName());\n         if (s != null) {\n             throw new InvalidParameterValueException(\"A key pair with name '\" + cmd.getName() + \"' already exists.\");\n         }\n \n         String name = cmd.getName();\n         String publicKey = SSHKeysHelper.getPublicKeyFromKeyMaterial(cmd.getPublicKey());\n-        String fingerprint = SSHKeysHelper.getPublicKeyFingerprint(publicKey);\n-\n+        \n         if (publicKey == null) {\n             throw new InvalidParameterValueException(\"Public key is invalid\");\n         }\n+        \n+        String fingerprint = SSHKeysHelper.getPublicKeyFingerprint(publicKey);\n \n-        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, null);\n+        return createAndSaveSSHKeyPair(name, fingerprint, publicKey, null, owner);\n     }\n \n-    private SSHKeyPair createAndSaveSSHKeyPair(String name, String fingerprint, String publicKey, String privateKey) {\n-        Account account = UserContext.current().getCaller();\n+    private SSHKeyPair createAndSaveSSHKeyPair(String name, String fingerprint, String publicKey, String privateKey, Account owner) {\n         SSHKeyPairVO newPair = new SSHKeyPairVO();\n \n-        newPair.setAccountId(account.getAccountId());\n-        newPair.setDomainId(account.getDomainId());\n+        newPair.setAccountId(owner.getAccountId());\n+        newPair.setDomainId(owner.getDomainId());\n         newPair.setName(name);\n         newPair.setFingerprint(fingerprint);\n         newPair.setPublicKey(publicKey);",
                "raw_url": "https://github.com/apache/cloudstack/raw/c31605d51fad79c05469e663e5fb8606ef613d56/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "78aa072f1086b068962797979fb366be53540291",
                "status": "modified"
            }
        ],
        "message": "createSshKeys command - fixed the case when admin couldn't create a key for another user via 8096 port.\nregisterSshKeys command - added ability for admin to register key for another user\n\nFixed NPE in registerUserKeys command - used to happen in failure case, when invalid publicKey was specified",
        "parent": "https://github.com/apache/cloudstack/commit/857f8ca0f9a0c6edf6429e4c5ae60e2d45458e88",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_c377763": {
        "bug_id": "cloudstack_c377763",
        "commit": "https://github.com/apache/cloudstack/commit/c3777632c5817cc1e635ee59eb18d6cb4f210e29",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/c3777632c5817cc1e635ee59eb18d6cb4f210e29/server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java?ref=c3777632c5817cc1e635ee59eb18d6cb4f210e29",
                "deletions": 4,
                "filename": "server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java",
                "patch": "@@ -83,22 +83,28 @@ public VolumeResponse newVolumeResponse(ResponseView view, VolumeJoinVO volume)\n         volResponse.setZoneId(volume.getDataCenterUuid());\n         volResponse.setZoneName(volume.getDataCenterName());\n \n-        volResponse.setVolumeType(volume.getVolumeType().toString());\n+        if (volume.getVolumeType() != null) {\n+            volResponse.setVolumeType(volume.getVolumeType().toString());\n+        }\n         volResponse.setDeviceId(volume.getDeviceId());\n \n         long instanceId = volume.getVmId();\n         if (instanceId > 0 && volume.getState() != Volume.State.Destroy) {\n             volResponse.setVirtualMachineId(volume.getVmUuid());\n             volResponse.setVirtualMachineName(volume.getVmName());\n-            volResponse.setVirtualMachineState(volume.getVmState().toString());\n+            if (volume.getVmState() != null) {\n+                volResponse.setVirtualMachineState(volume.getVmState().toString());\n+            }\n             if (volume.getVmDisplayName() != null) {\n                 volResponse.setVirtualMachineDisplayName(volume.getVmDisplayName());\n             } else {\n                 volResponse.setVirtualMachineDisplayName(volume.getVmName());\n             }\n         }\n \n-        volResponse.setProvisioningType(volume.getProvisioningType().toString());\n+        if (volume.getProvisioningType() != null) {\n+            volResponse.setProvisioningType(volume.getProvisioningType().toString());\n+        }\n \n         // Show the virtual size of the volume\n         volResponse.setSize(volume.getSize());\n@@ -107,7 +113,9 @@ public VolumeResponse newVolumeResponse(ResponseView view, VolumeJoinVO volume)\n         volResponse.setMaxIops(volume.getMaxIops());\n \n         volResponse.setCreated(volume.getCreated());\n-        volResponse.setState(volume.getState().toString());\n+        if (volume.getState() != null) {\n+            volResponse.setState(volume.getState().toString());\n+        }\n         if (volume.getState() == Volume.State.UploadOp) {\n             // com.cloud.storage.VolumeHostVO volumeHostRef =\n             // ApiDBUtils.findVolumeHostRef(volume.getId(),",
                "raw_url": "https://github.com/apache/cloudstack/raw/c3777632c5817cc1e635ee59eb18d6cb4f210e29/server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java",
                "sha": "7540d247a43629fb3639fd6e95f691332b2c1d42",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8858: listVolumes API fails for a particular domain with NPE.\n\nSummary: listVolumes API fails when volume associated vm instance has NULL or invalid state. Fix the code to guard this situation since this should not block volume listing.",
        "parent": "https://github.com/apache/cloudstack/commit/06cefaf493423c953a95ee92482a2d0a20a21095",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeJoinDaoImplTest.java"
        ]
    },
    "cloudstack_c3c8baf": {
        "bug_id": "cloudstack_c3c8baf",
        "commit": "https://github.com/apache/cloudstack/commit/c3c8baf259ab3aa695e7a425b33fe9d44d8549dd",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/c3c8baf259ab3aa695e7a425b33fe9d44d8549dd/api/src/org/apache/cloudstack/api/command/admin/host/UpdateHostPasswordCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/host/UpdateHostPasswordCmd.java?ref=c3c8baf259ab3aa695e7a425b33fe9d44d8549dd",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/host/UpdateHostPasswordCmd.java",
                "patch": "@@ -67,7 +67,7 @@ public Long getClusterId() {\n     }\n \n     public Boolean getUpdatePasswdOnHost() {\n-        return updatePasswdOnHost;\n+        return updatePasswdOnHost == null ? false : true;\n     }\n \n     public String getPassword() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/c3c8baf259ab3aa695e7a425b33fe9d44d8549dd/api/src/org/apache/cloudstack/api/command/admin/host/UpdateHostPasswordCmd.java",
                "sha": "5a884cf72ab7eb9adbc8c759ef5acd26240bbf6a",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8641 - When calling \"update hostpassword\" API it throws NPE if the update_passwd_on_host if not informed\n\n   - On getUpdatePasswdOnHost() method, if updatePasswdOnHost is null then return false.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/b29d8e72801173e7a3d868c7badaefe8872e4736",
        "repo": "cloudstack",
        "unit_tests": [
            "UpdateHostPasswordCmdTest.java"
        ]
    },
    "cloudstack_c614c6a": {
        "bug_id": "cloudstack_c614c6a",
        "commit": "https://github.com/apache/cloudstack/commit/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java?ref=c614c6a424f33f582e6ce4a0e7bf4d72f5606bda",
                "deletions": 3,
                "filename": "engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java",
                "patch": "@@ -87,6 +87,7 @@\n import com.cloud.storage.download.DownloadMonitor;\n import com.cloud.storage.template.TemplateConstants;\n import com.cloud.storage.template.TemplateProp;\n+import com.cloud.template.TemplateManager;\n import com.cloud.user.AccountManager;\n import com.cloud.user.ResourceLimitService;\n import com.cloud.utils.UriUtils;\n@@ -138,6 +139,8 @@\n     EndPointSelector _epSelector;\n     @Inject\n     ImageDataManager imageMgr;\n+    @Inject\n+    TemplateManager _tmpltMgr;\n \n \n     class TemplateOpContext<T> extends AsyncRpcConext<T> {\n@@ -430,9 +433,7 @@ public void handleTemplateSync(DataStore store) {\n \n        for (String uniqueName : templateInfos.keySet()) {\n             TemplateProp tInfo = templateInfos.get(uniqueName);\n-            List<UserVmJoinVO> userVmUsingIso = _userVmJoinDao.listActiveByIsoId(tInfo.getId());\n-            //check if there is any Vm using this ISO.\n-            if (userVmUsingIso == null || userVmUsingIso.isEmpty()) {\n+            if (_tmpltMgr.templateIsDeleteable(tInfo.getId())) {\n                 //TODO: we cannot directly call deleteTemplateSync here to reuse delete logic since in this case, our db does not have this template at all.\n                 VMTemplateVO template = _templateDao.findById(tInfo.getId());\n                 DeleteTemplateCommand dtCommand = new DeleteTemplateCommand(store.getTO(), tInfo.getInstallPath(), null, null);",
                "raw_url": "https://github.com/apache/cloudstack/raw/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/engine/storage/image/src/org/apache/cloudstack/storage/image/TemplateServiceImpl.java",
                "sha": "fd349710193ae5bdf4597ebad482009ff7133e17",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=c614c6a424f33f582e6ce4a0e7bf4d72f5606bda",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1133,7 +1133,7 @@ public void cleanupSecondaryStorage(boolean recurring) {\n                     s_logger.debug(\"Secondary storage garbage collector found \" + destroyedTemplateStoreVOs.size()\n                             + \" templates to cleanup on secondary storage host: \" + store.getName());\n                     for (TemplateDataStoreVO destroyedTemplateStoreVO : destroyedTemplateStoreVOs) {\n-                        if (!_tmpltMgr.templateIsDeleteable(destroyedTemplateStoreVO)) {\n+                        if (!_tmpltMgr.templateIsDeleteable(destroyedTemplateStoreVO.getTemplateId())) {\n                             if (s_logger.isDebugEnabled()) {\n                                 s_logger.debug(\"Not deleting template at: \" + destroyedTemplateStoreVO);\n                             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "cbbbe94abe79c5d433d0593fb14dd33d56ff7290",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/server/src/com/cloud/template/TemplateManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManager.java?ref=c614c6a424f33f582e6ce4a0e7bf4d72f5606bda",
                "deletions": 1,
                "filename": "server/src/com/cloud/template/TemplateManager.java",
                "patch": "@@ -92,7 +92,7 @@\n \n     boolean templateIsDeleteable(VMTemplateHostVO templateHostRef);\n \n-    boolean templateIsDeleteable(TemplateDataStoreVO templateStoreRef);\n+    boolean templateIsDeleteable(long templateId);\n \n     Pair<String, String> getAbsoluteIsoPath(long templateId, long dataCenterId);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/server/src/com/cloud/template/TemplateManager.java",
                "sha": "af71d30d9e9cc3fb23a7dd1cd5b0dd7d1978e579",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=c614c6a424f33f582e6ce4a0e7bf4d72f5606bda",
                "deletions": 28,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -945,35 +945,15 @@ public boolean templateIsDeleteable(VMTemplateHostVO templateHostRef) {\n \t}\n \n     @Override\n-    public boolean templateIsDeleteable(TemplateDataStoreVO templateStoreRef) {\n-        VMTemplateVO template = _tmpltDao.findByIdIncludingRemoved(templateStoreRef.getTemplateId());\n-        long templateId = template.getId();\n-        ImageStoreVO imageStore = _imageStoreDao.findById(templateStoreRef.getDataStoreId());\n-        long zoneId = imageStore.getDataCenterId();\n-        DataCenterVO zone = _dcDao.findById(zoneId);\n-\n-        // Check if there are VMs running in the template host ref's zone that use the template\n-        List<VMInstanceVO> nonExpungedVms = _vmInstanceDao.listNonExpungedByZoneAndTemplate(zoneId, templateId);\n-\n-        if (!nonExpungedVms.isEmpty()) {\n-            s_logger.debug(\"Template \" + template.getName() + \" in zone \" + zone.getName() + \" is not deleteable because there are non-expunged VMs deployed from this template.\");\n-            return false;\n-        }\n-        List<UserVmVO> userVmUsingIso = _userVmDao.listByIsoId(templateId);\n-        //check if there is any VM using this ISO.\n+    public boolean templateIsDeleteable(long templateId) {\n+        List<UserVmJoinVO> userVmUsingIso = _userVmJoinDao.listActiveByIsoId(templateId);\n+        //check if there is any Vm using this ISO. We only need to check the case where templateId is an ISO since\n+        // VM can be launched from ISO in secondary storage, while template will always be copied to\n+        // primary storage before deploying VM.\n         if (!userVmUsingIso.isEmpty()) {\n-            s_logger.debug(\"ISO \" + template.getName() + \" in zone \" + zone.getName() + \" is not deleteable because it is attached to \" + userVmUsingIso.size() + \" VMs\");\n+            s_logger.debug(\"ISO \" + templateId + \" is not deleteable because it is attached to \" + userVmUsingIso.size() + \" VMs\");\n             return false;\n         }\n-        // Check if there are any snapshots for the template in the template host ref's zone\n-        List<VolumeVO> volumes = _volumeDao.findByTemplateAndZone(templateId, zoneId);\n-        for (VolumeVO volume : volumes) {\n-            List<SnapshotVO> snapshots = _snapshotDao.listByVolumeIdVersion(volume.getId(), \"2.1\");\n-            if (!snapshots.isEmpty()) {\n-                s_logger.debug(\"Template \" + template.getName() + \" in zone \" + zone.getName() + \" is not deleteable because there are 2.1 snapshots using this template.\");\n-                return false;\n-            }\n-        }\n \n         return true;\n     }\n@@ -1153,9 +1133,8 @@ public boolean deleteIso(DeleteIsoCmd cmd) {\n     \t\tthrow new InvalidParameterValueException(\"Please specify a valid iso.\");\n     \t}\n \n-    \t List<UserVmJoinVO> userVmUsingIso = _userVmJoinDao.listActiveByIsoId(templateId);\n          // check if there is any VM using this ISO.\n-         if (userVmUsingIso != null && !userVmUsingIso.isEmpty()) {\n+         if (!templateIsDeleteable(templateId)) {\n         \t throw new InvalidParameterValueException(\"Unable to delete iso, as it's used by other vms\");\n          }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/c614c6a424f33f582e6ce4a0e7bf4d72f5606bda/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "c828773bff4082e02c78aad93301750fd5c8d589",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-2674: Secondary Storage garbage collector failed with NPE in\ncase of S3 storage provider.",
        "parent": "https://github.com/apache/cloudstack/commit/3c7fb2f790bcef6f86ccb735e25f9ef27f1e039a",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java",
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_c618caf": {
        "bug_id": "cloudstack_c618caf",
        "commit": "https://github.com/apache/cloudstack/commit/c618caf102de5df5d2224e70643a22863a72658a",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/c618caf102de5df5d2224e70643a22863a72658a/client/tomcatconf/nonossComponentContext.xml.in",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/client/tomcatconf/nonossComponentContext.xml.in?ref=c618caf102de5df5d2224e70643a22863a72658a",
                "deletions": 0,
                "filename": "client/tomcatconf/nonossComponentContext.xml.in",
                "patch": "@@ -212,6 +212,7 @@\n         <ref bean=\"cloudStackPrimaryDataStoreProviderImpl\"/>\n         <ref bean=\"cloudStackImageStoreProviderImpl\"/>\n         <ref bean=\"s3ImageStoreProviderImpl\"/>\n+        <ref local=\"swiftImageStoreProviderImpl\"/>\n         <ref bean=\"solidFireDataStoreProvider\"/>\n       </list>\n     </property>",
                "raw_url": "https://github.com/apache/cloudstack/raw/c618caf102de5df5d2224e70643a22863a72658a/client/tomcatconf/nonossComponentContext.xml.in",
                "sha": "6fd51ef0f0a6377b076c756cd64494472162cdf0",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/c618caf102de5df5d2224e70643a22863a72658a/engine/storage/src/org/apache/cloudstack/storage/LocalHostEndpoint.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/src/org/apache/cloudstack/storage/LocalHostEndpoint.java?ref=c618caf102de5df5d2224e70643a22863a72658a",
                "deletions": 0,
                "filename": "engine/storage/src/org/apache/cloudstack/storage/LocalHostEndpoint.java",
                "patch": "@@ -45,6 +45,10 @@\n     ConfigurationDao configDao;\n \n     public LocalHostEndpoint() {\n+\n+    }\n+\n+    private void configure() {\n         // get mount parent folder configured in global setting, if set, this will overwrite _parent in NfsSecondaryStorageResource to work\n         // around permission issue for default /mnt folder\n         String mountParent = configDao.getValue(Config.MountParent.key());\n@@ -59,6 +63,7 @@ public LocalHostEndpoint() {\n \n     public static EndPoint getEndpoint() {\n         LocalHostEndpoint endpoint = ComponentContext.inject(LocalHostEndpoint.class);\n+        endpoint.configure();\n         return endpoint;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/c618caf102de5df5d2224e70643a22863a72658a/engine/storage/src/org/apache/cloudstack/storage/LocalHostEndpoint.java",
                "sha": "68faa47541bfd39e96821356be00d03e3e0e0635",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/c618caf102de5df5d2224e70643a22863a72658a/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java?ref=c618caf102de5df5d2224e70643a22863a72658a",
                "deletions": 1,
                "filename": "plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "patch": "@@ -3940,7 +3940,7 @@ boolean swiftDelete(Connection conn, SwiftTO swift, String rfilename) {\n         return false;\n     }\n \n-    public void swiftBackupSnapshot(Connection conn, SwiftTO swift, String srUuid, String snapshotUuid, String container, Boolean isISCSI, int wait)  {\n+    public String swiftBackupSnapshot(Connection conn, SwiftTO swift, String srUuid, String snapshotUuid, String container, Boolean isISCSI, int wait)  {\n         String lfilename;\n         String ldir;\n         if ( isISCSI ) {\n@@ -3951,6 +3951,7 @@ public void swiftBackupSnapshot(Connection conn, SwiftTO swift, String srUuid, S\n             lfilename = snapshotUuid + \".vhd\";\n         }\n         swiftUpload(conn, swift, container, ldir, lfilename, isISCSI, wait);\n+        return lfilename;\n     }\n \n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/c618caf102de5df5d2224e70643a22863a72658a/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/CitrixResourceBase.java",
                "sha": "f80d4b62940ad824553575d6e4c81180ce8b7ce1",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/cloudstack/blob/c618caf102de5df5d2224e70643a22863a72658a/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServerStorageProcessor.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServerStorageProcessor.java?ref=c618caf102de5df5d2224e70643a22863a72658a",
                "deletions": 12,
                "filename": "plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServerStorageProcessor.java",
                "patch": "@@ -1051,7 +1051,7 @@ protected String deleteSnapshotBackup(Connection conn, String path, String secon\n         return result;\n     }\n \n-    public void swiftBackupSnapshot(Connection conn, SwiftTO swift, String srUuid, String snapshotUuid, String container, Boolean isISCSI, int wait)  {\n+    public String swiftBackupSnapshot(Connection conn, SwiftTO swift, String srUuid, String snapshotUuid, String container, Boolean isISCSI, int wait)  {\n         String lfilename;\n         String ldir;\n         if ( isISCSI ) {\n@@ -1062,6 +1062,7 @@ public void swiftBackupSnapshot(Connection conn, SwiftTO swift, String srUuid, S\n             lfilename = snapshotUuid + \".vhd\";\n         }\n         swiftUpload(conn, swift, container, ldir, lfilename, isISCSI, wait);\n+        return lfilename;\n     }\n \n     private static List<String> serializeProperties(final Object object,\n@@ -1280,6 +1281,7 @@ public Answer backupSnapshot(CopyCommand cmd) {\n             String secondaryStorageMountPath = uri.getHost() + \":\" + uri.getPath();\n             DataStoreTO destStore = destData.getDataStore();\n             String folder = destPath;\n+            String finalPath = null;\n             if (fullbackup) {\n                 // the first snapshot is always a full snapshot\n \n@@ -1297,18 +1299,24 @@ public Answer backupSnapshot(CopyCommand cmd) {\n \n                     if( destStore instanceof SwiftTO) {\n                         try {\n-                            hypervisorResource.swiftBackupSnapshot(conn, (SwiftTO)destStore, snapshotSr.getUuid(conn), snapshotBackupUuid, \"S-\" + snapshotTO.getVolume().getVolumeId().toString(), false, wait);\n-                            snapshotBackupUuid = snapshotBackupUuid + \".vhd\";\n+                            String container = \"S-\" + snapshotTO.getVolume().getVolumeId().toString();\n+                            snapshotBackupUuid = swiftBackupSnapshot(conn, (SwiftTO)destStore, snapshotSr.getUuid(conn), snapshotBackupUuid, container, false, wait);\n+                            String swiftPath = container + File.separator + snapshotBackupUuid;\n+                            finalPath = container + File.separator + swiftPath;\n                         } finally {\n                             deleteSnapshotBackup(conn, folder, secondaryStorageMountPath, snapshotBackupUuid);\n                         }\n+\n                     } else if (destStore instanceof S3TO) {\n                         try {\n                             backupSnapshotToS3(conn, (S3TO)destStore, snapshotSr.getUuid(conn), snapshotBackupUuid, isISCSI, wait);\n                             snapshotBackupUuid = snapshotBackupUuid + \".vhd\";\n                         } finally {\n                             deleteSnapshotBackup(conn, folder, secondaryStorageMountPath, snapshotBackupUuid);\n                         }\n+                        finalPath = folder + File.separator + snapshotBackupUuid;\n+                    } else {\n+                        finalPath = folder + File.separator + snapshotBackupUuid;\n                     }\n \n                 } finally {\n@@ -1319,26 +1327,23 @@ public Answer backupSnapshot(CopyCommand cmd) {\n             } else {\n                 String primaryStorageSRUuid = primaryStorageSR.getUuid(conn);\n                 if( destStore instanceof SwiftTO ) {\n-                    swiftBackupSnapshot(conn, (SwiftTO)destStore, primaryStorageSRUuid, snapshotPaUuid, \"S-\" + snapshotTO.getVolume().getVolumeId().toString(), isISCSI, wait);\n-                    if ( isISCSI ) {\n-                        snapshotBackupUuid = \"VHD-\" + snapshotPaUuid;\n-                    } else {\n-                        snapshotBackupUuid = snapshotPaUuid + \".vhd\";\n-                    }\n-\n+                    String container = \"S-\" + snapshotTO.getVolume().getVolumeId().toString();\n+                    snapshotBackupUuid = swiftBackupSnapshot(conn, (SwiftTO)destStore, primaryStorageSRUuid, snapshotPaUuid, \"S-\" + snapshotTO.getVolume().getVolumeId().toString(), isISCSI, wait);\n+                    finalPath = container + File.separator + snapshotBackupUuid;\n                 } else if (destStore instanceof S3TO ) {\n                     backupSnapshotToS3(conn, (S3TO)destStore, primaryStorageSRUuid, snapshotPaUuid, isISCSI, wait);\n+                    finalPath = folder + File.separator + snapshotPaUuid;\n                 } else {\n                     snapshotBackupUuid = backupSnapshot(conn, primaryStorageSRUuid, folder + File.separator + UUID.nameUUIDFromBytes(secondaryStorageMountPath.getBytes())\n                              , secondaryStorageMountPath, snapshotUuid, prevBackupUuid, isISCSI, wait);\n-\n+                    finalPath = folder + File.separator + snapshotBackupUuid;\n                 }\n             }\n             String volumeUuid = snapshotTO.getVolume().getPath();\n             destroySnapshotOnPrimaryStorageExceptThis(conn, volumeUuid, snapshotUuid);\n \n             SnapshotObjectTO newSnapshot = new SnapshotObjectTO();\n-            newSnapshot.setPath(folder + File.separator + snapshotBackupUuid);\n+            newSnapshot.setPath(finalPath);\n             if (fullbackup) {\n                 newSnapshot.setParentSnapshotPath(null);\n             } else {",
                "raw_url": "https://github.com/apache/cloudstack/raw/c618caf102de5df5d2224e70643a22863a72658a/plugins/hypervisors/xen/src/com/cloud/hypervisor/xen/resource/XenServerStorageProcessor.java",
                "sha": "f13225defa4fdfe947e1a56f9d9a2e4d76f93cb7",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/c618caf102de5df5d2224e70643a22863a72658a/tools/marvin/marvin/deployDataCenter.py",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/tools/marvin/marvin/deployDataCenter.py?ref=c618caf102de5df5d2224e70643a22863a72658a",
                "deletions": 1,
                "filename": "tools/marvin/marvin/deployDataCenter.py",
                "patch": "@@ -440,8 +440,9 @@ def createZones(self, zones):\n                 networkId = networkcmdresponse.id\n                 self.createpods(zone.pods, zoneId, networkId)\n \n-            self.createSecondaryStorages(zone.secondaryStorages, zoneId)\n+            '''Note: Swift needs cache storage first'''\n             self.createCacheStorages(zone.cacheStorages, zoneId)\n+            self.createSecondaryStorages(zone.secondaryStorages, zoneId)\n \n             enabled = getattr(zone, 'enabled', 'True')\n             if enabled == 'True' or enabled is None:",
                "raw_url": "https://github.com/apache/cloudstack/raw/c618caf102de5df5d2224e70643a22863a72658a/tools/marvin/marvin/deployDataCenter.py",
                "sha": "2472b2039b3907074596e44a74d6584c490a3484",
                "status": "modified"
            }
        ],
        "message": "fix localendpoint npe",
        "parent": "https://github.com/apache/cloudstack/commit/cb5ab3791675e3f0355eb2d9927e56547a39c3fe",
        "repo": "cloudstack",
        "unit_tests": [
            "CitrixResourceBaseTest.java",
            "XenServerStorageProcessorTest.java"
        ]
    },
    "cloudstack_c78f14c": {
        "bug_id": "cloudstack_c78f14c",
        "commit": "https://github.com/apache/cloudstack/commit/c78f14cbc2fd45fc587f4a238c0a0bfc1d753be8",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/c78f14cbc2fd45fc587f4a238c0a0bfc1d753be8/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=c78f14cbc2fd45fc587f4a238c0a0bfc1d753be8",
                "deletions": 1,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -2101,7 +2101,7 @@ private boolean doCancelMaintenance(long hostId) {\n         _haMgr.cancelScheduledMigrations(host);\n         List<VMInstanceVO> vms = _haMgr.findTakenMigrationWork();\n         for (VMInstanceVO vm : vms) {\n-            if (vm.getHostId() != null && vm.getHostId() == hostId) {\n+            if (vm != null && vm.getHostId() != null && vm.getHostId() == hostId) {\n                 s_logger.info(\"Unable to cancel migration because the vm is being migrated: \" + vm);\n                 return false;\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/c78f14cbc2fd45fc587f4a238c0a0bfc1d753be8/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "a3413eb3b1c56ffdc074acf134a0cdd783aa9a92",
                "status": "modified"
            }
        ],
        "message": "fixed NPE",
        "parent": "https://github.com/apache/cloudstack/commit/9d5b7b73a21c307a6514f90f8674a4ff231c0bbc",
        "repo": "cloudstack",
        "unit_tests": [
            "ResourceManagerImplTest.java"
        ]
    },
    "cloudstack_c8cf17f": {
        "bug_id": "cloudstack_c8cf17f",
        "commit": "https://github.com/apache/cloudstack/commit/c8cf17f6da186d565244d372fcc0285d0818f195",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/c8cf17f6da186d565244d372fcc0285d0818f195/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=c8cf17f6da186d565244d372fcc0285d0818f195",
                "deletions": 8,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -822,14 +822,12 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            if (vm != null) {\n-                volResponse.setVirtualMachineId(vm.getId());\n-                volResponse.setVirtualMachineName(vm.getHostName());\n-                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-                if (userVm != null) {\n-                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                    volResponse.setVirtualMachineState(vm.getState().toString());\n-                }\n+            volResponse.setVirtualMachineId(vm.getId());\n+            volResponse.setVirtualMachineName(vm.getHostName());\n+            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+            if (userVm != null) {\n+                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                volResponse.setVirtualMachineState(vm.getState().toString());\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/c8cf17f6da186d565244d372fcc0285d0818f195/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "37e794ddcd55402292b23a9d97bceae283ea8b89",
                "status": "modified"
            }
        ],
        "message": "Revert \"fix NPE when listvolume if vm got destroyed\"\n\nThis reverts commit 9bdaa9d967a6390cc1655ce7344d5af474890e4c.",
        "parent": "https://github.com/apache/cloudstack/commit/d8a9612ef718a72d5ab2c73bf1fe9bfd3842172f",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_ca99603": {
        "bug_id": "cloudstack_ca99603",
        "commit": "https://github.com/apache/cloudstack/commit/ca9960332183f3b13e16e432f0e14f3156efc39f",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/ca9960332183f3b13e16e432f0e14f3156efc39f/server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java?ref=ca9960332183f3b13e16e432f0e14f3156efc39f",
                "deletions": 1,
                "filename": "server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "patch": "@@ -1215,7 +1215,7 @@ protected boolean hostCanAccessSPool(Host host, StoragePool pool) {\n             // volume is ready and the pool should be reused.\n             // In this case, also check if rest of the volumes are ready and can\n             // be reused.\n-            if (plan.getPoolId() != null) {\n+            if (plan.getPoolId() != null || (toBeCreated.getVolumeType() == Volume.Type.DATADISK && toBeCreated.getPoolId() != null && toBeCreated.getState() == Volume.State.Ready)) {\n                 s_logger.debug(\"Volume has pool already allocated, checking if pool can be reused, poolId: \" + toBeCreated.getPoolId());\n                 List<StoragePool> suitablePools = new ArrayList<StoragePool>();\n                 StoragePool pool = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/ca9960332183f3b13e16e432f0e14f3156efc39f/server/src/com/cloud/deploy/DeploymentPlanningManagerImpl.java",
                "sha": "7345c2a99f142d7e2010da1a3294104c39530861",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/ca9960332183f3b13e16e432f0e14f3156efc39f/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java?ref=ca9960332183f3b13e16e432f0e14f3156efc39f",
                "deletions": 1,
                "filename": "server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -638,6 +638,9 @@ public Long migrate(final HaWorkVO work) {\n             _haDao.update(work.getId(), work);\n \n             VMInstanceVO vm = _instanceDao.findById(vmId);\n+            if (vm == null) {\n+                return null;\n+            }\n             // First try starting the vm with its original planner, if it doesn't succeed send HAPlanner as its an emergency.\n             _itMgr.migrateAway(vm.getUuid(), srcHostId);\n             return null;\n@@ -757,7 +760,10 @@ public void cancelScheduledMigrations(final HostVO host) {\n         List<HaWorkVO> works = _haDao.findTakenWorkItems(WorkType.Migration);\n         List<VMInstanceVO> vms = new ArrayList<VMInstanceVO>(works.size());\n         for (HaWorkVO work : works) {\n-            vms.add(_instanceDao.findById(work.getInstanceId()));\n+            VMInstanceVO vm = _instanceDao.findById(work.getInstanceId());\n+            if (vm != null) {\n+                vms.add(vm);\n+            }\n         }\n         return vms;\n     }\n@@ -917,6 +923,7 @@ private void runWithContext() {\n                     } else {\n                         s_logger.info(\"Rescheduling \" + work + \" to try again at \" + new Date(nextTime << 10));\n                         work.setTimeToTry(nextTime);\n+                        work.setTimesTried(work.getTimesTried() + 1);\n                         work.setServerId(null);\n                         work.setDateTaken(null);\n                     }\n@@ -927,6 +934,7 @@ private void runWithContext() {\n \n                     s_logger.info(\"Rescheduling \" + work + \" to try again at \" + new Date(nextTime << 10));\n                     work.setTimeToTry(nextTime);\n+                    work.setTimesTried(work.getTimesTried() + 1);\n                     work.setServerId(null);\n                     work.setDateTaken(null);\n \n@@ -935,6 +943,10 @@ private void runWithContext() {\n                     VMInstanceVO vm = _instanceDao.findById(work.getInstanceId());\n                     work.setUpdateTime(vm.getUpdated());\n                     work.setPreviousState(vm.getState());\n+                    if (!Step.Done.equals(work.getStep()) && work.getTimesTried() >= _maxRetries) {\n+                        s_logger.warn(\"Giving up, retries max times for work: \" + work);\n+                        work.setStep(Step.Done);\n+                    }\n                 }\n                 _haDao.update(work.getId(), work);\n             } catch (final Throwable th) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/ca9960332183f3b13e16e432f0e14f3156efc39f/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "sha": "1ecdfcdc17c0a25a4b4be30099f97ee61cbcb28b",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/cloudstack/blob/ca9960332183f3b13e16e432f0e14f3156efc39f/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=ca9960332183f3b13e16e432f0e14f3156efc39f",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -1016,6 +1016,9 @@ public UserVm addNicToVirtualMachine(AddNicToVMCmd cmd) throws InvalidParameterV\n \n         NicProfile profile = new NicProfile(null, null);\n         if (ipAddress != null) {\n+            if (!(NetUtils.isValidIp(ipAddress) || NetUtils.isValidIpv6(ipAddress))) {\n+                throw new InvalidParameterValueException(\"Invalid format for IP address parameter: \" + ipAddress);\n+            }\n             profile = new NicProfile(ipAddress, null);\n         }\n \n@@ -2892,6 +2895,19 @@ protected UserVm createVirtualMachine(DataCenter zone, ServiceOffering serviceOf\n                 }\n \n                 profile.setDefaultNic(true);\n+                if (!_networkModel.areServicesSupportedInNetwork(network.getId(), new Service[]{Service.UserData})) {\n+                    if ((userData != null) && (!userData.isEmpty())) {\n+                        throw new InvalidParameterValueException(\"Unable to deploy VM as UserData is provided while deploying the VM, but there is no support for \" + Network.Service.UserData.getName() + \" service in the default network \" + network.getId());\n+                    }\n+\n+                    if ((sshPublicKey != null) && (!sshPublicKey.isEmpty())) {\n+                        throw new InvalidParameterValueException(\"Unable to deploy VM as SSH keypair is provided while deploying the VM, but there is no support for \" + Network.Service.UserData.getName() + \" service in the default network \" + network.getId());\n+                    }\n+\n+                    if (template.getEnablePassword()) {\n+                        throw new InvalidParameterValueException(\"Unable to deploy VM as template \" + template.getId() + \" is password enabled, but there is no support for \" + Network.Service.UserData.getName() + \" service in the default network \" + network.getId());\n+                    }\n+                }\n             }\n \n             networks.add(new Pair<NetworkVO, NicProfile>(network, profile));",
                "raw_url": "https://github.com/apache/cloudstack/raw/ca9960332183f3b13e16e432f0e14f3156efc39f/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "38ca3903ac5a1ac5a3c92d33be1e2abf5ac60999",
                "status": "modified"
            }
        ],
        "message": "server: NPE checks and improved case checking\n\n- pool allocation checks for both root and data disks\n- NPE checks to not add null object in collection or try to migrate null VM\n- HA work tries need to increment and be given up when max retries are crossed\n- VM creation should check IP address format for IPv4 and IPv6\n- If userdata is not supported by a network, then fail early if userdata, ssh key,\n  or password enabled template is passed/used\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit 24435dd6bc2424da18277ca00229d1d3bb0ec284)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/06e353e5c75a39799dbb1d79790baaeb3678b947",
        "repo": "cloudstack",
        "unit_tests": [
            "DeploymentPlanningManagerImplTest.java",
            "HighAvailabilityManagerImplTest.java",
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_cc18ca7": {
        "bug_id": "cloudstack_cc18ca7",
        "commit": "https://github.com/apache/cloudstack/commit/cc18ca79fc6d58fb639ffbb455791caeb021589a",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/cc18ca79fc6d58fb639ffbb455791caeb021589a/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java?ref=cc18ca79fc6d58fb639ffbb455791caeb021589a",
                "deletions": 1,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "patch": "@@ -2205,7 +2205,8 @@ public int getCoresPerSocket() throws Exception {\n         if (apiVersion.compareTo(\"5.0\") < 0) {\n             return 1;\n         }\n-        return (Integer)_context.getVimClient().getDynamicProperty(_mor, \"config.hardware.numCoresPerSocket\");\n+        Integer coresPerSocket = (Integer) _context.getVimClient().getDynamicProperty(_mor, \"config.hardware.numCoresPerSocket\");\n+        return coresPerSocket != null? coresPerSocket : 1;\n     }\n \n     public int getVirtualHardwareVersion() throws Exception {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cc18ca79fc6d58fb639ffbb455791caeb021589a/vmware-base/src/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java",
                "sha": "e8cbe8f03d1e87693f2de885fd4bf285841311a1",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3851 [VMWare] VM start fails with NPE while trying to retrieve cores per socket\n\nIf VMware host version is ESXi 4.1 and vCenter version is 5.0 or later, number of cores per socket of a VM running on ESXi 4.1 host would be undefined as it's not supported for versions prior to 5.0.\nHence expecting undefined/null value for that and handling it.\n\nSigned-off-by: Sateesh Chodapuneedi <sateesh@apache.org>",
        "parent": "https://github.com/apache/cloudstack/commit/a5ada3f363276f575122402feb6d8ab16964e7ae",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineMOTest.java"
        ]
    },
    "cloudstack_cc4b612": {
        "bug_id": "cloudstack_cc4b612",
        "commit": "https://github.com/apache/cloudstack/commit/cc4b612bf604addb1ad903ef8adc504c569abe55",
        "file": [
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/cloudstack/blob/cc4b612bf604addb1ad903ef8adc504c569abe55/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=cc4b612bf604addb1ad903ef8adc504c569abe55",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -73,6 +73,10 @@\n import org.apache.cloudstack.framework.config.dao.ConfigurationDao;\n import org.apache.cloudstack.framework.jobs.AsyncJobManager;\n import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeDataFactory;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService;\n+import org.apache.cloudstack.engine.subsystem.api.storage.VolumeService.VolumeApiResult;\n+import org.apache.cloudstack.framework.async.AsyncCallFuture;\n import org.apache.cloudstack.storage.datastore.db.PrimaryDataStoreDao;\n import org.apache.cloudstack.storage.datastore.db.StoragePoolVO;\n import org.apache.cloudstack.storage.to.TemplateObjectTO;\n@@ -437,6 +441,10 @@\n     PlannerHostReservationDao _plannerHostReservationDao;\n     @Inject\n     private ServiceOfferingDetailsDao serviceOfferingDetailsDao;\n+    @Inject\n+    VolumeService _volService;\n+    @Inject\n+    VolumeDataFactory volFactory;\n \n     protected ScheduledExecutorService _executor = null;\n     protected int _expungeInterval;\n@@ -4914,6 +4922,17 @@ public UserVm restoreVMInternal(Account caller, UserVmVO vm, Long newTemplateId)\n         _volsDao.detachVolume(root.getId());\n         volumeMgr.destroyVolume(root);\n \n+        // For VMware hypervisor since the old root volume is replaced by the new root volume in storage, force expunge old root volume\n+        if (vm.getHypervisorType() == HypervisorType.VMware) {\n+            s_logger.info(\"Expunging volume \" + root.getId() + \" from primary data store\");\n+            AsyncCallFuture<VolumeApiResult> future = _volService.expungeVolumeAsync(volFactory.getVolume(root.getId()));\n+            try {\n+                future.get();\n+            } catch (Exception e) {\n+                s_logger.debug(\"Failed to expunge volume:\" + root.getId(), e);\n+            }\n+        }\n+\n         if (template.getEnablePassword()) {\n             String password = generateRandomPassword();\n             boolean result = resetVMPasswordInternal(vmId, password);",
                "raw_url": "https://github.com/apache/cloudstack/raw/cc4b612bf604addb1ad903ef8adc504c569abe55/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "f20278498ac80fe04359483d521b23f171ef4abe",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4985. NPE while deleting old root volumes of a restored VM during storage garbage collection.\nIn case of VMware, once the state of the old root volume has been updated to destroyed force expunge it from primary storage to avoid the garbage collector from trying to delete the new root volume",
        "parent": "https://github.com/apache/cloudstack/commit/6be228a438e5ce3fba831be8130c73603cb0457b",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_ce9014d": {
        "bug_id": "cloudstack_ce9014d",
        "commit": "https://github.com/apache/cloudstack/commit/ce9014d2ec8e7111ae8080b7d08cc167363acccb",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/ce9014d2ec8e7111ae8080b7d08cc167363acccb/plugins/hypervisors/kvm/resources/META-INF/cloudstack/kvm-compute/spring-kvm-compute-context.xml",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/resources/META-INF/cloudstack/kvm-compute/spring-kvm-compute-context.xml?ref=ce9014d2ec8e7111ae8080b7d08cc167363acccb",
                "deletions": 3,
                "filename": "plugins/hypervisors/kvm/resources/META-INF/cloudstack/kvm-compute/spring-kvm-compute-context.xml",
                "patch": "@@ -31,7 +31,4 @@\n         <property name=\"name\" value=\"KVMInvestigator\" />\n     </bean>\n     \n-    <bean id=\"libvirtUtilitiesHelper\"\n-        class=\"com.cloud.hypervisor.kvm.resource.wrapper.LibvirtUtilitiesHelper\" />\n-    \n </beans>",
                "raw_url": "https://github.com/apache/cloudstack/raw/ce9014d2ec8e7111ae8080b7d08cc167363acccb/plugins/hypervisors/kvm/resources/META-INF/cloudstack/kvm-compute/spring-kvm-compute-context.xml",
                "sha": "ce596f22bbf118da9118016208f35d43de4226bd",
                "status": "modified"
            },
            {
                "additions": 46,
                "blob_url": "https://github.com/apache/cloudstack/blob/ce9014d2ec8e7111ae8080b7d08cc167363acccb/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "changes": 92,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java?ref=ce9014d2ec8e7111ae8080b7d08cc167363acccb",
                "deletions": 46,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "patch": "@@ -16,6 +16,51 @@\n // under the License.\n package com.cloud.hypervisor.kvm.resource;\n \n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.net.InetAddress;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Calendar;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import javax.ejb.Local;\n+import javax.naming.ConfigurationException;\n+\n+import org.apache.cloudstack.storage.to.PrimaryDataStoreTO;\n+import org.apache.cloudstack.storage.to.VolumeObjectTO;\n+import org.apache.cloudstack.utils.linux.CPUStat;\n+import org.apache.cloudstack.utils.linux.MemStat;\n+import org.apache.cloudstack.utils.qemu.QemuImg.PhysicalDiskFormat;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.IOUtils;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.DomainBlockStats;\n+import org.libvirt.DomainInfo;\n+import org.libvirt.DomainInfo.DomainState;\n+import org.libvirt.DomainInterfaceStats;\n+import org.libvirt.LibvirtException;\n+import org.libvirt.NodeInfo;\n+\n import com.cloud.agent.api.Answer;\n import com.cloud.agent.api.Command;\n import com.cloud.agent.api.HostVmStateReportEntry;\n@@ -95,50 +140,6 @@\n import com.cloud.utils.ssh.SshHelper;\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachine.PowerState;\n-import org.apache.cloudstack.storage.to.PrimaryDataStoreTO;\n-import org.apache.cloudstack.storage.to.VolumeObjectTO;\n-import org.apache.cloudstack.utils.linux.CPUStat;\n-import org.apache.cloudstack.utils.linux.MemStat;\n-import org.apache.cloudstack.utils.qemu.QemuImg.PhysicalDiskFormat;\n-import org.apache.commons.io.FileUtils;\n-import org.apache.commons.io.IOUtils;\n-import org.apache.log4j.Logger;\n-import org.libvirt.Connect;\n-import org.libvirt.Domain;\n-import org.libvirt.DomainBlockStats;\n-import org.libvirt.DomainInfo;\n-import org.libvirt.DomainInfo.DomainState;\n-import org.libvirt.DomainInterfaceStats;\n-import org.libvirt.LibvirtException;\n-import org.libvirt.NodeInfo;\n-\n-import javax.ejb.Local;\n-import javax.inject.Inject;\n-import javax.naming.ConfigurationException;\n-import java.io.BufferedReader;\n-import java.io.File;\n-import java.io.FileNotFoundException;\n-import java.io.FileReader;\n-import java.io.IOException;\n-import java.io.Reader;\n-import java.net.InetAddress;\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Calendar;\n-import java.util.Collections;\n-import java.util.Comparator;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Properties;\n-import java.util.Set;\n-import java.util.UUID;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n \n /**\n  * LibvirtComputingResource execute requests on the computing/routing host using\n@@ -264,8 +265,7 @@\n     protected CPUStat _cpuStat = new CPUStat();\n     protected MemStat _memStat = new MemStat();\n \n-    @Inject\n-    private LibvirtUtilitiesHelper libvirtUtilitiesHelper;\n+    private final LibvirtUtilitiesHelper libvirtUtilitiesHelper = new LibvirtUtilitiesHelper();\n \n     @Override\n     public ExecutionResult executeInVR(final String routerIp, final String script, final String args) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/ce9014d2ec8e7111ae8080b7d08cc167363acccb/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "sha": "7bd02d09c9a851d5e88b93995b3ad25998b097b3",
                "status": "modified"
            }
        ],
        "message": "Fix the NPE tht was being caught by the executeRequest() method. - The LibvirtUtilitiesHelper should have been injected, but it did not work on the Agent side. Due to that, when sending a StartCommand we were experiencing NPE, which made impossible to get SSVM/CPVM started. - The LibvirtUtilitiesHelper class is now being instantiated withing the LibvirtComputingResource\n\nSigned-off-by: Daan Hoogland <daan.hoogland@gmail.com>\n\nThis closes #318",
        "parent": "https://github.com/apache/cloudstack/commit/a7ab79405228e4894b1b2f68e2105b8d0cb5d34a",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_cf72aa3": {
        "bug_id": "cloudstack_cf72aa3",
        "commit": "https://github.com/apache/cloudstack/commit/cf72aa32747a44ef876b9566d5c85db2f189b84e",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/NetworkModel.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/NetworkModel.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "api/src/com/cloud/network/NetworkModel.java",
                "patch": "@@ -261,4 +261,6 @@\n \tString getStartIpv6Address(long id);\n \n     Nic getPlaceholderNic(Network network, Long podId);\n+\n+    boolean isProviderEnabledInZone(long zoneId, String provider);\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/NetworkModel.java",
                "sha": "c1f1674bad76b1ba8d705aa82dd192aad8b7533b",
                "status": "modified"
            },
            {
                "additions": 37,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/Vpc.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/vpc/Vpc.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 6,
                "filename": "api/src/com/cloud/network/vpc/Vpc.java",
                "patch": "@@ -20,32 +20,63 @@\n import org.apache.cloudstack.api.Identity;\n import org.apache.cloudstack.api.InternalIdentity;\n \n-import com.cloud.network.Network;\n-\n public interface Vpc extends ControlledEntity, Identity, InternalIdentity {\n+    \n     public enum State {\n         Enabled,\n         Inactive\n     }\n \n-   public static final String _supportedProviders = Network.Provider.VPCVirtualRouter.getName();\n-\n-   boolean readyToUse();\n-\n+    /**\n+     * \n+     * @return VPC name\n+     */\n    String getName();\n \n+   \n+   /**\n+    * @return the id of the zone the VPC belongs to\n+    */\n    long getZoneId();\n \n+   \n+   /**\n+    * @return super CIDR of the VPC. All the networks participating in VPC, should have CIDRs that are the part of the super cidr\n+    */\n    String getCidr();\n \n+   /**\n+    * \n+    * @return VPC state\n+    */\n    State getState();\n \n+   \n+   /**\n+    * \n+    * @return VPC offering id - the offering that VPC is created from\n+    */\n    long getVpcOfferingId();\n \n+   \n+   /**\n+    * \n+    * @return VPC display text\n+    */\n    String getDisplayText();\n \n+   \n+   /**\n+    * \n+    * @return VPC network domain. All networks participating in the VPC, become the part of the same network domain\n+    */\n    String getNetworkDomain();\n \n+   \n+   /**\n+    * \n+    * @return true if restart is required for the VPC; false otherwise\n+    */\n    boolean isRestartRequired();\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/Vpc.java",
                "sha": "249e80f1affe728f62fc7fa5fb5daf4694763daa",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/VpcOffering.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/vpc/VpcOffering.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 3,
                "filename": "api/src/com/cloud/network/vpc/VpcOffering.java",
                "patch": "@@ -27,18 +27,33 @@\n \n     public static final String defaultVPCOfferingName = \"Default VPC offering\";\n \n+    /**\n+     * \n+     * @return VPC offering name\n+     */\n     String getName();\n \n-    String getUniqueName();\n-\n+    \n+    /**\n+     * @return VPC offering display text\n+     */\n     String getDisplayText();\n+    \n \n+    /**\n+     * \n+     * @return VPC offering state\n+     */\n     State getState();\n \n+    /**\n+     * \n+     * @return true if offering is default - came with the cloudStack fresh install; false otherwise\n+     */\n     boolean isDefault();\n \n     /**\n-     * @return\n+     * @return service offering id used by VPC virutal router\n      */\n     Long getServiceOfferingId();\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/VpcOffering.java",
                "sha": "3961d0aaba7a11641ed62ee5a06db78960de428d",
                "status": "modified"
            },
            {
                "additions": 46,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/VpcProvisioningService.java",
                "changes": 46,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/vpc/VpcProvisioningService.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "api/src/com/cloud/network/vpc/VpcProvisioningService.java",
                "patch": "@@ -0,0 +1,46 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.network.vpc;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+public interface VpcProvisioningService {\n+    \n+    public VpcOffering getVpcOffering(long vpcOfferingId);\n+    \n+    public VpcOffering createVpcOffering(String name, String displayText, List<String> supportedServices, Map<String, List<String>> serviceProviders);\n+    \n+    List<? extends VpcOffering> listVpcOfferings(Long id, String name, String displayText, List<String> supportedServicesStr,\n+            Boolean isDefault, String keyword, String state, Long startIndex, Long pageSizeVal);\n+    \n+    /**\n+     * @param offId\n+     * @return\n+     */\n+    public boolean deleteVpcOffering(long offId);\n+    \n+    /**\n+     * @param vpcOffId\n+     * @param vpcOfferingName\n+     * @param displayText\n+     * @param state\n+     * @return\n+     */\n+    public VpcOffering updateVpcOffering(long vpcOffId, String vpcOfferingName, String displayText, String state);\n+\n+}",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/VpcProvisioningService.java",
                "sha": "70676ce07abdef01d72bb6612f99510ab6404020",
                "status": "added"
            },
            {
                "additions": 65,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/VpcService.java",
                "changes": 95,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/com/cloud/network/vpc/VpcService.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 30,
                "filename": "api/src/com/cloud/network/vpc/VpcService.java",
                "patch": "@@ -18,7 +18,6 @@\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n \n import org.apache.cloudstack.api.command.user.vpc.ListPrivateGatewaysCmd;\n import org.apache.cloudstack.api.command.user.vpc.ListStaticRoutesCmd;\n@@ -31,45 +30,29 @@\n import com.cloud.exception.ResourceUnavailableException;\n import com.cloud.network.IpAddress;\n import com.cloud.network.Network;\n-import com.cloud.network.Network.Provider;\n-import com.cloud.network.Network.Service;\n-import com.cloud.user.Account;\n-import com.cloud.user.User;\n import com.cloud.utils.Pair;\n \n public interface VpcService {\n \n-    public VpcOffering getVpcOffering(long vpcOfferingId);\n-\n-    public VpcOffering createVpcOffering(String name, String displayText, List<String> supportedServices, Map<String, List<String>> serviceProviders);\n-\n-    public Vpc getVpc(long vpcId);\n-\n-    public Vpc getActiveVpc(long vpcId);\n-\n-    public List<? extends Network> getVpcNetworks(long vpcId);\n-\n-    Map<Service, Set<Provider>> getVpcOffSvcProvidersMap(long vpcOffId);\n-\n-    List<? extends VpcOffering> listVpcOfferings(Long id, String name, String displayText, List<String> supportedServicesStr,\n-            Boolean isDefault, String keyword, String state, Long startIndex, Long pageSizeVal);\n-\n-    /**\n-     * @param offId\n+    /**Returns existing VPC found by id\n+     * \n+     * @param vpcId\n      * @return\n      */\n-    public boolean deleteVpcOffering(long offId);\n+    public Vpc getVpc(long vpcId);\n \n+    \n     /**\n-     * @param vpcOffId\n-     * @param vpcOfferingName\n-     * @param displayText\n-     * @param state\n+     * Returns all the Guest networks that are part of VPC\n+     * \n+     * @param vpcId\n      * @return\n      */\n-    public VpcOffering updateVpcOffering(long vpcOffId, String vpcOfferingName, String displayText, String state);\n+    public List<? extends Network> getVpcNetworks(long vpcId);\n \n     /**\n+     * Persists VPC record in the database\n+     * \n      * @param zoneId\n      * @param vpcOffId\n      * @param vpcOwnerId\n@@ -83,7 +66,10 @@\n     public Vpc createVpc(long zoneId, long vpcOffId, long vpcOwnerId, String vpcName, String displayText, String cidr,\n             String networkDomain) throws ResourceAllocationException;\n \n+    \n     /**\n+     * Deletes a VPC\n+     * \n      * @param vpcId\n      * @return\n      * @throws InsufficientCapacityException\n@@ -92,15 +78,21 @@ public Vpc createVpc(long zoneId, long vpcOffId, long vpcOwnerId, String vpcName\n      */\n     public boolean deleteVpc(long vpcId) throws ConcurrentOperationException, ResourceUnavailableException;\n \n+    \n     /**\n+     * Updates VPC with new name/displayText\n+     * \n      * @param vpcId\n      * @param vpcName\n      * @param displayText\n      * @return\n      */\n     public Vpc updateVpc(long vpcId, String vpcName, String displayText);\n \n+    \n     /**\n+     * Lists VPC(s) based on the parameters passed to the method call\n+     * \n      * @param id\n      * @param vpcName\n      * @param displayText\n@@ -127,6 +119,8 @@ public Vpc createVpc(long zoneId, long vpcOffId, long vpcOwnerId, String vpcName\n             Boolean restartRequired, Map<String, String> tags, Long projectId);\n \n     /**\n+     * Starts VPC which includes starting VPC provider and applying all the neworking rules on the backend\n+     * \n      * @param vpcId\n      * @param destroyOnFailure TODO\n      * @return\n@@ -138,23 +132,37 @@ boolean startVpc(long vpcId, boolean destroyOnFailure) throws ConcurrentOperatio\n                                                         ResourceUnavailableException, InsufficientCapacityException;\n \n     /**\n+     * Shuts down the VPC which includes shutting down all VPC provider and rules cleanup on the backend\n+     * \n      * @param vpcId\n      * @return\n      * @throws ConcurrentOperationException\n      * @throws ResourceUnavailableException\n      */\n     boolean shutdownVpc(long vpcId) throws ConcurrentOperationException, ResourceUnavailableException;\n \n+    \n     /**\n+     * Restarts the VPC. VPC gets shutdown and started as a part of it\n+     * \n      * @param id\n      * @return\n      * @throws InsufficientCapacityException\n      */\n     boolean restartVpc(long id) throws ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException;\n \n+    /**\n+     * Returns a Private gateway found in the VPC by id\n+     * \n+     * @param id\n+     * @return\n+     */\n     PrivateGateway getVpcPrivateGateway(long id);\n \n+    \n     /**\n+     * Persists VPC private gateway in the Database.\n+     * \n      * @param vpcId TODO\n      * @param physicalNetworkId\n      * @param vlan\n@@ -172,6 +180,8 @@ public PrivateGateway createVpcPrivateGateway(long vpcId, Long physicalNetworkId\n             ConcurrentOperationException, InsufficientCapacityException;\n \n     /**\n+     * Applies VPC private gateway on the backend, so it becomes functional\n+     * \n      * @param gatewayId\n      * @param destroyOnFailure TODO\n      * @return\n@@ -180,60 +190,87 @@ public PrivateGateway createVpcPrivateGateway(long vpcId, Long physicalNetworkId\n      */\n     public PrivateGateway applyVpcPrivateGateway(long gatewayId, boolean destroyOnFailure) throws ConcurrentOperationException, ResourceUnavailableException;\n \n+    \n     /**\n+     * Deletes VPC private gateway\n+     * \n      * @param id\n      * @return\n      * @throws ResourceUnavailableException\n      * @throws ConcurrentOperationException\n      */\n     boolean deleteVpcPrivateGateway(long gatewayId) throws ConcurrentOperationException, ResourceUnavailableException;\n \n+    \n     /**\n+     * Returns the list of Private gateways existing in the VPC\n+     * \n      * @param listPrivateGatewaysCmd\n      * @return\n      */\n     public Pair<List<PrivateGateway>, Integer> listPrivateGateway(ListPrivateGatewaysCmd listPrivateGatewaysCmd);\n \n+    \n     /**\n+     * Returns Static Route found by Id\n+     * \n      * @param routeId\n      * @return\n      */\n     StaticRoute getStaticRoute(long routeId);\n \n+    \n     /**\n+     * Applies existing Static Routes to the VPC elements\n+     * \n      * @param vpcId\n      * @return\n      * @throws ResourceUnavailableException\n      */\n     public boolean applyStaticRoutes(long vpcId) throws ResourceUnavailableException;\n \n+    \n     /**\n+     * Deletes static route from the backend and the database\n+     * \n      * @param routeId\n      * @return TODO\n      * @throws ResourceUnavailableException\n      */\n     public boolean revokeStaticRoute(long routeId) throws ResourceUnavailableException;\n \n+    \n     /**\n+     * Persists static route entry in the Database\n+     * \n      * @param gatewayId\n      * @param cidr\n      * @return\n      */\n     public StaticRoute createStaticRoute(long gatewayId, String cidr) throws NetworkRuleConflictException;\n \n+    \n     /**\n+     * Lists static routes based on parameters passed to the call\n+     * \n      * @param listStaticRoutesCmd\n      * @return\n      */\n     public Pair<List<? extends StaticRoute>, Integer> listStaticRoutes(ListStaticRoutesCmd cmd);\n \n+    \n     /**\n+     * Returns gateway (VPN or Public) existign in the VPC \n+     * \n      * @param id\n      * @return\n      */\n     VpcGateway getVpcGateway(long id);\n \n+    \n     /**\n+     * Associates IP address from the Public network, to the VPC\n+     * \n      * @param ipId\n      * @param vpcId\n      * @return\n@@ -245,6 +282,4 @@ public PrivateGateway createVpcPrivateGateway(long vpcId, Long physicalNetworkId\n     IpAddress associateIPToVpc(long ipId, long vpcId) throws ResourceAllocationException, ResourceUnavailableException,\n         InsufficientAddressCapacityException, ConcurrentOperationException;\n \n-    public Network updateVpcGuestNetwork(long networkId, String name, String displayText, Account callerAccount,\n-            User callerUser, String domainSuffix, Long ntwkOffId, Boolean changeCidr, String guestVmCidr);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/com/cloud/network/vpc/VpcService.java",
                "sha": "07ce89b0a3f38dca61ceef0b0a1d2e3fac6c7d3e",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/BaseCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/BaseCmd.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/BaseCmd.java",
                "patch": "@@ -52,6 +52,7 @@\n import com.cloud.network.lb.LoadBalancingRulesService;\n import com.cloud.network.rules.RulesService;\n import com.cloud.network.security.SecurityGroupService;\n+import com.cloud.network.vpc.VpcProvisioningService;\n import com.cloud.network.vpc.VpcService;\n import com.cloud.network.vpn.RemoteAccessVpnService;\n import com.cloud.network.vpn.Site2SiteVpnService;\n@@ -132,6 +133,7 @@\n     @Inject public NetworkUsageService _networkUsageService;\n     @Inject public VMSnapshotService _vmSnapshotService;\n     @Inject public DataStoreProviderApiService dataStoreProviderApiService;\n+    @Inject public VpcProvisioningService _vpcProvSvc;\n \n     public abstract void execute() throws ResourceUnavailableException, InsufficientCapacityException, ServerApiException, ConcurrentOperationException, ResourceAllocationException, NetworkRuleConflictException;\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/BaseCmd.java",
                "sha": "78a2af36aa2059a838cfda1725e802ebcee9cf68",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/admin/vpc/CreateVPCOfferingCmd.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/vpc/CreateVPCOfferingCmd.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 2,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/vpc/CreateVPCOfferingCmd.java",
                "patch": "@@ -98,7 +98,7 @@ public String getDisplayText() {\n \n     @Override\n     public void create() throws ResourceAllocationException {\n-        VpcOffering vpcOff = _vpcService.createVpcOffering(getVpcOfferingName(), getDisplayText(), getSupportedServices(), getServiceProviders());\n+        VpcOffering vpcOff = _vpcProvSvc.createVpcOffering(getVpcOfferingName(), getDisplayText(), getSupportedServices(), getServiceProviders());\n         if (vpcOff != null) {\n             this.setEntityId(vpcOff.getId());\n             this.setEntityUuid(vpcOff.getUuid());\n@@ -109,7 +109,7 @@ public void create() throws ResourceAllocationException {\n \n     @Override\n     public void execute() {\n-        VpcOffering vpc = _vpcService.getVpcOffering(this.getEntityId());\n+        VpcOffering vpc = _vpcProvSvc.getVpcOffering(this.getEntityId());\n         if (vpc != null) {\n             VpcOfferingResponse response = _responseGenerator.createVpcOfferingResponse(vpc);\n             response.setResponseName(getCommandName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/admin/vpc/CreateVPCOfferingCmd.java",
                "sha": "4a3a92a211cf1ad96022e68ce209f3c1f2ad5838",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/admin/vpc/DeleteVPCOfferingCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/vpc/DeleteVPCOfferingCmd.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/vpc/DeleteVPCOfferingCmd.java",
                "patch": "@@ -66,7 +66,7 @@ public long getEntityOwnerId() {\n \n     @Override\n     public void execute(){\n-        boolean result = _vpcService.deleteVpcOffering(getId());\n+        boolean result = _vpcProvSvc.deleteVpcOffering(getId());\n         if (result) {\n             SuccessResponse response = new SuccessResponse(getCommandName());\n             this.setResponseObject(response);",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/admin/vpc/DeleteVPCOfferingCmd.java",
                "sha": "4b16fa5fcb917b16d452f05777cfe4b32ecc3a5c",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/admin/vpc/UpdateVPCOfferingCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/admin/vpc/UpdateVPCOfferingCmd.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/admin/vpc/UpdateVPCOfferingCmd.java",
                "patch": "@@ -88,7 +88,7 @@ public long getEntityOwnerId() {\n \n     @Override\n     public void execute(){\n-        VpcOffering result = _vpcService.updateVpcOffering(getId(), getVpcOfferingName(), getDisplayText(), getState());\n+        VpcOffering result = _vpcProvSvc.updateVpcOffering(getId(), getVpcOfferingName(), getDisplayText(), getState());\n         if (result != null) {\n             VpcOfferingResponse response = _responseGenerator.createVpcOfferingResponse(result);\n             response.setResponseName(getCommandName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/admin/vpc/UpdateVPCOfferingCmd.java",
                "sha": "9bbae064376cba476259bb2f64826f44d38fc242",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/user/network/UpdateNetworkCmd.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/network/UpdateNetworkCmd.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 7,
                "filename": "api/src/org/apache/cloudstack/api/command/user/network/UpdateNetworkCmd.java",
                "patch": "@@ -129,14 +129,9 @@ public void execute() throws InsufficientCapacityException, ConcurrentOperationE\n             throw new InvalidParameterValueException(\"Couldn't find network by id\");\n         }\n \n-        Network result = null;\n-        if (network.getVpcId() != null) {\n-            result = _vpcService.updateVpcGuestNetwork(getId(), getNetworkName(), getDisplayText(), callerAccount,\n+        Network result = _networkService.updateGuestNetwork(getId(), getNetworkName(), getDisplayText(), callerAccount,\n                     callerUser, getNetworkDomain(), getNetworkOfferingId(), getChangeCidr(), getGuestVmCidr());\n-        } else {\n-            result = _networkService.updateGuestNetwork(getId(), getNetworkName(), getDisplayText(), callerAccount,\n-                    callerUser, getNetworkDomain(), getNetworkOfferingId(), getChangeCidr(), getGuestVmCidr());\n-        }\n+        \n \n         if (result != null) {\n             NetworkResponse response = _responseGenerator.createNetworkResponse(result);",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/user/network/UpdateNetworkCmd.java",
                "sha": "a61474e69d0b8962bdf392dba74dd28014d9dd28",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/user/vpc/ListVPCOfferingsCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/command/user/vpc/ListVPCOfferingsCmd.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 1,
                "filename": "api/src/org/apache/cloudstack/api/command/user/vpc/ListVPCOfferingsCmd.java",
                "patch": "@@ -92,7 +92,7 @@ public String getState() {\n \n     @Override\n     public void execute(){\n-        List<? extends VpcOffering> offerings = _vpcService.listVpcOfferings(getId(), getVpcOffName(), getDisplayText(),\n+        List<? extends VpcOffering> offerings = _vpcProvSvc.listVpcOfferings(getId(), getVpcOffName(), getDisplayText(),\n                 getSupportedServices(), isDefault, this.getKeyword(), getState(), this.getStartIndex(), this.getPageSizeVal());\n         ListResponse<VpcOfferingResponse> response = new ListResponse<VpcOfferingResponse>();\n         List<VpcOfferingResponse> offeringResponses = new ArrayList<VpcOfferingResponse>();",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/api/src/org/apache/cloudstack/api/command/user/vpc/ListVPCOfferingsCmd.java",
                "sha": "ddae79987844d8ecc8ef35e56a42d39a4c0d1db8",
                "status": "modified"
            },
            {
                "additions": 67,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/api/ApiDBUtils.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiDBUtils.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 10,
                "filename": "server/src/com/cloud/api/ApiDBUtils.java",
                "patch": "@@ -95,8 +95,20 @@\n import com.cloud.configuration.ConfigurationService;\n import com.cloud.configuration.Resource.ResourceType;\n import com.cloud.configuration.dao.ConfigurationDao;\n-import com.cloud.dc.*;\n-import com.cloud.dc.dao.*;\n+import com.cloud.dc.AccountVlanMapVO;\n+import com.cloud.dc.ClusterDetailsDao;\n+import com.cloud.dc.ClusterDetailsVO;\n+import com.cloud.dc.ClusterVO;\n+import com.cloud.dc.DataCenter;\n+import com.cloud.dc.DataCenterVO;\n+import com.cloud.dc.HostPodVO;\n+import com.cloud.dc.Vlan;\n+import com.cloud.dc.VlanVO;\n+import com.cloud.dc.dao.AccountVlanMapDao;\n+import com.cloud.dc.dao.ClusterDao;\n+import com.cloud.dc.dao.DataCenterDao;\n+import com.cloud.dc.dao.HostPodDao;\n+import com.cloud.dc.dao.VlanDao;\n import com.cloud.domain.DomainVO;\n import com.cloud.domain.dao.DomainDao;\n import com.cloud.event.Event;\n@@ -162,7 +174,12 @@\n import com.cloud.network.security.SecurityGroupManager;\n import com.cloud.network.security.SecurityGroupVO;\n import com.cloud.network.security.dao.SecurityGroupDao;\n-import com.cloud.network.vpc.*;\n+import com.cloud.network.vpc.StaticRouteVO;\n+import com.cloud.network.vpc.VpcGatewayVO;\n+import com.cloud.network.vpc.VpcManager;\n+import com.cloud.network.vpc.VpcOffering;\n+import com.cloud.network.vpc.VpcProvisioningService;\n+import com.cloud.network.vpc.VpcVO;\n import com.cloud.network.vpc.dao.StaticRouteDao;\n import com.cloud.network.vpc.dao.VpcDao;\n import com.cloud.network.vpc.dao.VpcGatewayDao;\n@@ -177,19 +194,57 @@\n import com.cloud.projects.ProjectInvitation;\n import com.cloud.projects.ProjectService;\n import com.cloud.resource.ResourceManager;\n-import com.cloud.server.*;\n+import com.cloud.server.Criteria;\n+import com.cloud.server.ManagementServer;\n+import com.cloud.server.ResourceTag;\n import com.cloud.server.ResourceTag.TaggedResourceType;\n+import com.cloud.server.StatsCollector;\n+import com.cloud.server.TaggedResourceService;\n import com.cloud.service.ServiceOfferingVO;\n import com.cloud.service.dao.ServiceOfferingDao;\n-import com.cloud.storage.*;\n+import com.cloud.storage.DiskOfferingVO;\n+import com.cloud.storage.GuestOS;\n+import com.cloud.storage.GuestOSCategoryVO;\n+import com.cloud.storage.Snapshot;\n+import com.cloud.storage.SnapshotVO;\n import com.cloud.storage.Storage.ImageFormat;\n-\n+import com.cloud.storage.StorageManager;\n+import com.cloud.storage.StoragePool;\n+import com.cloud.storage.StorageStats;\n+import com.cloud.storage.UploadVO;\n+import com.cloud.storage.VMTemplateHostVO;\n+import com.cloud.storage.VMTemplateS3VO;\n+import com.cloud.storage.VMTemplateSwiftVO;\n+import com.cloud.storage.VMTemplateVO;\n+import com.cloud.storage.Volume;\n import com.cloud.storage.Volume.Type;\n-import com.cloud.storage.dao.*;\n+import com.cloud.storage.VolumeHostVO;\n+import com.cloud.storage.VolumeManager;\n+import com.cloud.storage.VolumeVO;\n+import com.cloud.storage.dao.DiskOfferingDao;\n+import com.cloud.storage.dao.GuestOSCategoryDao;\n+import com.cloud.storage.dao.GuestOSDao;\n+import com.cloud.storage.dao.SnapshotDao;\n+import com.cloud.storage.dao.SnapshotPolicyDao;\n+import com.cloud.storage.dao.UploadDao;\n+import com.cloud.storage.dao.VMTemplateDao;\n+import com.cloud.storage.dao.VMTemplateDetailsDao;\n+import com.cloud.storage.dao.VMTemplateHostDao;\n+import com.cloud.storage.dao.VMTemplateS3Dao;\n+import com.cloud.storage.dao.VMTemplateSwiftDao;\n+import com.cloud.storage.dao.VolumeDao;\n+import com.cloud.storage.dao.VolumeHostDao;\n import com.cloud.storage.snapshot.SnapshotPolicy;\n import com.cloud.template.TemplateManager;\n-import com.cloud.user.*;\n-\n+import com.cloud.user.Account;\n+import com.cloud.user.AccountDetailsDao;\n+import com.cloud.user.AccountVO;\n+import com.cloud.user.ResourceLimitService;\n+import com.cloud.user.SSHKeyPairVO;\n+import com.cloud.user.User;\n+import com.cloud.user.UserAccount;\n+import com.cloud.user.UserStatisticsVO;\n+import com.cloud.user.UserVO;\n import com.cloud.user.dao.AccountDao;\n import com.cloud.user.dao.SSHKeyPairDao;\n import com.cloud.user.dao.UserDao;\n@@ -202,7 +257,6 @@\n import com.cloud.vm.InstanceGroup;\n import com.cloud.vm.InstanceGroupVO;\n import com.cloud.vm.NicProfile;\n-import com.cloud.vm.NicSecondaryIp;\n import com.cloud.vm.UserVmDetailVO;\n import com.cloud.vm.UserVmManager;\n import com.cloud.vm.UserVmVO;\n@@ -324,6 +378,7 @@\n     static VMSnapshotDao _vmSnapshotDao;\n     static ClusterDetailsDao _clusterDetailsDao;\n     static NicSecondaryIpDao _nicSecondaryIpDao;\n+    static VpcProvisioningService _vpcProvSvc;\n \n     @Inject private ManagementServer ms;\n     @Inject public AsyncJobManager asyncMgr;\n@@ -427,6 +482,7 @@\n     @Inject private ClusterDetailsDao clusterDetailsDao;\n     @Inject private VMSnapshotDao vmSnapshotDao;\n     @Inject private NicSecondaryIpDao nicSecondaryIpDao;\n+    @Inject private VpcProvisioningService vpcProvSvc;\n     @PostConstruct\n     void init() {\n         _ms = ms;\n@@ -528,6 +584,7 @@ void init() {\n         _clusterDetailsDao = clusterDetailsDao;\n         _vmSnapshotDao = vmSnapshotDao;\n         _nicSecondaryIpDao = nicSecondaryIpDao;\n+        _vpcProvSvc = vpcProvSvc;\n         // Note: stats collector should already have been initialized by this time, otherwise a null instance is returned\n         _statsCollector = StatsCollector.getInstance();\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/api/ApiDBUtils.java",
                "sha": "7b441901d5e526ba33d9322d736ebf2ffc945540",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManager.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 3,
                "filename": "server/src/com/cloud/network/NetworkManager.java",
                "patch": "@@ -20,8 +20,8 @@\n import java.util.Map;\n \n import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n+\n import com.cloud.dc.DataCenter;\n-import com.cloud.dc.DataCenterVO;\n import com.cloud.dc.Pod;\n import com.cloud.dc.Vlan.VlanType;\n import com.cloud.deploy.DataCenterDeployment;\n@@ -51,13 +51,11 @@\n import com.cloud.utils.Pair;\n import com.cloud.vm.Nic;\n import com.cloud.vm.NicProfile;\n-import com.cloud.vm.NicSecondaryIp;\n import com.cloud.vm.NicVO;\n import com.cloud.vm.ReservationContext;\n import com.cloud.vm.VMInstanceVO;\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.VirtualMachineProfile;\n-import com.cloud.vm.VirtualMachineProfileImpl;\n \n /**\n  * NetworkManager manages the network for the different end users.",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkManager.java",
                "sha": "851f7f545497ffa7d15133bb10f7eaa9937b7cea",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkManagerImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/NetworkManagerImpl.java",
                "patch": "@@ -1528,7 +1528,6 @@ public void implementNetworkElementsAndResources(DeployDestination dest, Reserva\n         // associate a source NAT IP (if one isn't already associated with the network)\n \n         boolean sharedSourceNat = offering.getSharedSourceNat();\n-        DataCenter zone = _dcDao.findById(network.getDataCenterId());\n         if (network.getGuestType() == Network.GuestType.Isolated\n                && _networkModel.areServicesSupportedInNetwork(network.getId(), Service.SourceNat)\n                && !sharedSourceNat) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkManagerImpl.java",
                "sha": "c0685ba20337b2d253eb6d0263c0d81e9b8ef8e5",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkModelImpl.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkModelImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/NetworkModelImpl.java",
                "patch": "@@ -1212,6 +1212,19 @@ public boolean isProviderEnabledInPhysicalNetwork(long physicalNetowrkId, String\n         }\n         return isProviderEnabled(ntwkSvcProvider);\n     }\n+    \n+    @Override\n+    public boolean isProviderEnabledInZone(long zoneId, String provider)\n+    {\n+        //the provider has to be enabled at least in one network in the zone\n+        for (PhysicalNetwork pNtwk : _physicalNetworkDao.listByZone(zoneId)) {\n+            if (isProviderEnabledInPhysicalNetwork(pNtwk.getId(), provider)) {\n+                return true;\n+            }\n+        }\n+        \n+        return false;\n+    }\n \n     @Override\n     public String getNetworkTag(HypervisorType hType, Network network) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkModelImpl.java",
                "sha": "d967f3346bfb9aa424da33896f623fa4493167ab",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkServiceImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/NetworkServiceImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/NetworkServiceImpl.java",
                "patch": "@@ -94,6 +94,7 @@\n import com.cloud.network.rules.PortForwardingRuleVO;\n import com.cloud.network.rules.RulesManager;\n import com.cloud.network.vpc.PrivateIpVO;\n+import com.cloud.network.vpc.Vpc;\n import com.cloud.network.vpc.VpcManager;\n import com.cloud.network.vpc.dao.PrivateIpDao;\n import com.cloud.offering.NetworkOffering;\n@@ -1715,6 +1716,12 @@ public Network updateGuestNetwork(long networkId, String name, String displayTex\n             ex.addProxyObject(\"networks\", networkId, \"networkId\");\n             throw ex;\n         }\n+        \n+        //perform below validation if the network is vpc network\n+        if (network.getVpcId() != null && networkOfferingId != null) {\n+            Vpc vpc = _vpcMgr.getVpc(network.getVpcId());\n+            _vpcMgr.validateNtwkOffForNtwkInVpc(networkId, networkOfferingId, null, null, vpc, null, _accountMgr.getAccount(network.getAccountId()));\n+        }\n \n         // don't allow to update network in Destroy state\n         if (network.getState() == Network.State.Destroy) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/NetworkServiceImpl.java",
                "sha": "d5034597f4f42168a6e0f03b42973fb9ed3c83a0",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VpcVirtualRouterElement.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 11,
                "filename": "server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "patch": "@@ -37,6 +37,7 @@\n import com.cloud.network.Network.Capability;\n import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n+import com.cloud.network.NetworkModel;\n import com.cloud.network.PublicIpAddress;\n import com.cloud.network.Site2SiteVpnConnection;\n import com.cloud.network.Site2SiteVpnGateway;\n@@ -76,6 +77,8 @@\n     Site2SiteVpnGatewayDao _vpnGatewayDao;\n     @Inject\n     IPAddressDao _ipAddressDao;\n+    @Inject\n+    NetworkModel _ntwkModel;\n \n     private static final Map<Service, Map<Capability, String>> capabilities = setCapabilities();\n \n@@ -322,7 +325,7 @@ public boolean createPrivateGateway(PrivateGateway gateway) throws ConcurrentOpe\n             return false;\n         }\n \n-        List<DomainRouterVO> routers = _vpcMgr.getVpcRouters(gateway.getVpcId());\n+        List<DomainRouterVO> routers = _vpcRouterMgr.getVpcRouters(gateway.getVpcId());\n         if (routers == null || routers.isEmpty()) {\n             s_logger.debug(this.getName() + \" element doesn't need to create Private gateway on the backend; VPC virtual \" +\n                     \"router doesn't exist in the vpc id=\" + gateway.getVpcId());\n@@ -345,7 +348,7 @@ public boolean deletePrivateGateway(PrivateGateway gateway) throws ConcurrentOpe\n             return false;\n         }\n \n-        List<DomainRouterVO> routers = _vpcMgr.getVpcRouters(gateway.getVpcId());\n+        List<DomainRouterVO> routers = _vpcRouterMgr.getVpcRouters(gateway.getVpcId());\n         if (routers == null || routers.isEmpty()) {\n             s_logger.debug(this.getName() + \" element doesn't need to delete Private gateway on the backend; VPC virtual \" +\n                     \"router doesn't exist in the vpc id=\" + gateway.getVpcId());\n@@ -361,10 +364,6 @@ public boolean deletePrivateGateway(PrivateGateway gateway) throws ConcurrentOpe\n         return _vpcRouterMgr.destroyPrivateGateway(gateway, router);\n     }\n \n-    @Override\n-    protected List<DomainRouterVO> getRouters(Network network, DeployDestination dest) {\n-        return  _vpcMgr.getVpcRouters(network.getVpcId());\n-    }\n \n     @Override\n     public boolean applyIps(Network network, List<? extends PublicIpAddress> ipAddress, Set<Service> services) \n@@ -377,7 +376,7 @@ public boolean applyIps(Network network, List<? extends PublicIpAddress> ipAddre\n             }\n         }\n         if (canHandle) {\n-            List<DomainRouterVO> routers = getRouters(network, null);\n+            List<DomainRouterVO> routers = _routerDao.listByNetworkAndRole(network.getId(), Role.VIRTUAL_ROUTER);\n             if (routers == null || routers.isEmpty()) {\n                 s_logger.debug(this.getName() + \" element doesn't need to associate ip addresses on the backend; VPC virtual \" +\n                         \"router doesn't exist in the network \" + network.getId());\n@@ -446,12 +445,12 @@ public boolean startSite2SiteVpn(Site2SiteVpnConnection conn) throws ResourceUna\n         Long vpcId = ip.getVpcId();\n         Vpc vpc = _vpcMgr.getVpc(vpcId);\n \n-        if (!_vpcMgr.vpcProviderEnabledInZone(vpc.getZoneId(), Provider.VPCVirtualRouter.getName())) {\n+        if (!_ntwkModel.isProviderEnabledInZone(vpc.getZoneId(), Provider.VPCVirtualRouter.getName())) {\n             throw new ResourceUnavailableException(\"VPC provider is not enabled in zone \" + vpc.getZoneId(),\n                     DataCenter.class, vpc.getZoneId());\n         }\n \n-        List<DomainRouterVO> routers = _vpcMgr.getVpcRouters(ip.getVpcId());\n+        List<DomainRouterVO> routers = _vpcRouterMgr.getVpcRouters(ip.getVpcId());\n         if (routers == null || routers.size() != 1) {\n             throw new ResourceUnavailableException(\"Cannot enable site-to-site VPN on the backend; virtual router doesn't exist in the vpc \" + ip.getVpcId(),\n                     DataCenter.class, vpc.getZoneId());\n@@ -474,12 +473,12 @@ public boolean stopSite2SiteVpn(Site2SiteVpnConnection conn) throws ResourceUnav\n         Long vpcId = ip.getVpcId();\n         Vpc vpc = _vpcMgr.getVpc(vpcId);\n \n-        if (!_vpcMgr.vpcProviderEnabledInZone(vpc.getZoneId(), Provider.VPCVirtualRouter.getName())) {\n+        if (!_ntwkModel.isProviderEnabledInZone(vpc.getZoneId(), Provider.VPCVirtualRouter.getName())) {\n             throw new ResourceUnavailableException(\"VPC provider is not enabled in zone \" + vpc.getZoneId(),\n                     DataCenter.class, vpc.getZoneId());\n         }\n \n-        List<DomainRouterVO> routers = _vpcMgr.getVpcRouters(ip.getVpcId());\n+        List<DomainRouterVO> routers = _vpcRouterMgr.getVpcRouters(ip.getVpcId());\n         if (routers == null || routers.size() != 1) {\n             throw new ResourceUnavailableException(\"Cannot enable site-to-site VPN on the backend; virtual router doesn't exist in the vpc \" + ip.getVpcId(),\n                     DataCenter.class, vpc.getZoneId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/element/VpcVirtualRouterElement.java",
                "sha": "08443698ea0b0e5897cf2b2a65b97e9837a50ca2",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManager.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManager.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManager.java",
                "patch": "@@ -101,4 +101,10 @@ boolean applyNetworkACLs(Network network, List<? extends FirewallRule> rules, Li\n      * @throws ResourceUnavailableException\n      */\n     boolean stopSite2SiteVpn(Site2SiteVpnConnection conn, VirtualRouter router) throws ResourceUnavailableException;\n+    \n+    /**\n+     * @param vpcId\n+     * @return\n+     */\n+    List<DomainRouterVO> getVpcRouters(long vpcId);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManager.java",
                "sha": "76c8aa891734b4aa6b2cc6e3735f0b01c583356b",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 5,
                "filename": "server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "patch": "@@ -234,7 +234,7 @@\n         long dcId = dest.getDataCenter().getId();\n         \n         DeploymentPlan plan = new DataCenterDeployment(dcId);\n-        List<DomainRouterVO> routers = _routerDao.listByVpcId(vpcId);\n+        List<DomainRouterVO> routers = getVpcRouters(vpcId);\n         \n         return new Pair<DeploymentPlan, List<DomainRouterVO>>(plan, routers);\n     }\n@@ -1212,7 +1212,7 @@ private void createVpcAssociatePrivateIPCommands(final VirtualRouter router, fin\n         networks = super.createRouterNetworks(owner, isRedundant, plan, null, sourceNatIp);\n \n         //2) allocate nic for private gateway if needed\n-        VpcGateway privateGateway = _vpcMgr.getPrivateGatewayForVpc(vpcId);\n+        PrivateGateway privateGateway = _vpcMgr.getVpcPrivateGateway(vpcId);\n         if (privateGateway != null) {\n             NicProfile privateNic = createPrivateNicProfileForGateway(privateGateway);\n             Network privateNetwork = _networkModel.getNetwork(privateGateway.getNetworkId());\n@@ -1233,7 +1233,7 @@ private void createVpcAssociatePrivateIPCommands(final VirtualRouter router, fin\n         for (IPAddressVO ip : ips) {\n             PublicIp publicIp = PublicIp.createFromAddrAndVlan(ip, _vlanDao.findById(ip.getVlanId()));\n             if ((ip.getState() == IpAddress.State.Allocated || ip.getState() == IpAddress.State.Allocating) \n-                    && _vpcMgr.ipUsedInVpc(ip)&& !publicVlans.contains(publicIp.getVlanTag())) {\n+                    && _vpcMgr.isIpAllocatedToVpc(ip)&& !publicVlans.contains(publicIp.getVlanTag())) {\n                 s_logger.debug(\"Allocating nic for router in vlan \" + publicIp.getVlanTag());\n                 NicProfile publicNic = new NicProfile();\n                 publicNic.setDefaultNic(false);\n@@ -1314,7 +1314,7 @@ protected NicProfile createGuestNicProfileForVpcRouter(Network guestNetwork) {\n             long publicNtwkId = ip.getNetworkId();\n             \n             //if ip is not associated to any network, and there are no firewall rules, release it on the backend\n-            if (!_vpcMgr.ipUsedInVpc(ip)) {\n+            if (!_vpcMgr.isIpAllocatedToVpc(ip)) {\n                 ip.setState(IpAddress.State.Releasing);\n             }\n                          \n@@ -1334,7 +1334,7 @@ protected NicProfile createGuestNicProfileForVpcRouter(Network guestNetwork) {\n             long publicNtwkId = ip.getNetworkId();\n             \n             //if ip is not associated to any network, and there are no firewall rules, release it on the backend\n-            if (!_vpcMgr.ipUsedInVpc(ip)) {\n+            if (!_vpcMgr.isIpAllocatedToVpc(ip)) {\n                 ip.setState(IpAddress.State.Releasing);\n             }\n                          \n@@ -1376,4 +1376,9 @@ public void finalizeStop(VirtualMachineProfile<DomainRouterVO> profile, StopAnsw\n         }\n     }\n     \n+    @Override\n+    public List<DomainRouterVO> getVpcRouters(long vpcId) {\n+        return _routerDao.listByVpcId(vpcId);\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/router/VpcVirtualNetworkApplianceManagerImpl.java",
                "sha": "bdfac060798c0406083c2cf149859c4c5cfc02a5",
                "status": "modified"
            },
            {
                "additions": 50,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcManager.java",
                "changes": 84,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/VpcManager.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 34,
                "filename": "server/src/com/cloud/network/vpc/VpcManager.java",
                "patch": "@@ -17,8 +17,11 @@\n package com.cloud.network.vpc;\n \n import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n \n import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n+\n import com.cloud.exception.ConcurrentOperationException;\n import com.cloud.exception.InsufficientAddressCapacityException;\n import com.cloud.exception.InsufficientCapacityException;\n@@ -27,33 +30,27 @@\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n import com.cloud.network.IpAddress;\n import com.cloud.network.Network;\n+import com.cloud.network.Network.Provider;\n import com.cloud.network.Network.Service;\n import com.cloud.network.PhysicalNetwork;\n import com.cloud.network.addr.PublicIp;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.user.Account;\n-import com.cloud.vm.DomainRouterVO;\n \n \n public interface VpcManager extends VpcService{\n \n     /**\n-     * @param ntwkOffId\n-     * @param cidr\n-     * @param networkDomain\n-     * @param networkOwner\n-     * @param vpc TODO\n-     * @param networkId TODO\n-     * @param gateway TODO\n+     * Returns all existing VPCs for a given account\n+     * @param accountId\n      * @return\n      */\n-    void validateNtkwOffForVpc(long ntwkOffId, String cidr, String networkDomain, Account networkOwner, \n-            Vpc vpc, Long networkId, String gateway);\n-\n-    \n     List<? extends Vpc> getVpcsForAccount(long accountId);\n \n+    \n     /**\n+     * Destroys the VPC\n+     * \n      * @param vpc\n      * @param caller TODO\n      * @param callerUserId TODO\n@@ -63,41 +60,28 @@ void validateNtkwOffForVpc(long ntwkOffId, String cidr, String networkDomain, Ac\n      */\n     boolean destroyVpc(Vpc vpc, Account caller, Long callerUserId) throws ConcurrentOperationException, ResourceUnavailableException;\n \n-    /**\n-     * @param vpcId\n-     * @return\n-     */\n-    List<DomainRouterVO> getVpcRouters(long vpcId);\n-\n-    /**\n-     * @param zoneId\n-     * @param provider\n-     * @return\n-     */\n-    boolean vpcProviderEnabledInZone(long zoneId, String provider);\n-\n-    /**\n-     * @param vpcId\n-     * @return\n-     */\n-    VpcGateway getPrivateGatewayForVpc(long vpcId);\n-\n \n     /**\n+     * Returns true if the IP is allocated to the VPC; false otherwise\n+     * \n      * @param ip\n      * @return\n      */\n-    boolean ipUsedInVpc(IpAddress ip);\n+    boolean isIpAllocatedToVpc(IpAddress ip);\n \n \n     /**\n+     * Disassociates the public IP address from VPC\n+     * \n      * @param ipId\n      * @param networkId\n      */\n     void unassignIPFromVpcNetwork(long ipId, long networkId);\n \n \n     /**\n+     * Creates guest network in the VPC\n+     * \n      * @param ntwkOffId\n      * @param name\n      * @param displayText\n@@ -125,25 +109,57 @@ Network createVpcGuestNetwork(long ntwkOffId, String name, String displayText, S\n \n \n     /**\n+     * Assigns source nat public IP address to VPC\n+     * \n      * @param owner\n      * @param vpc\n-     * @return\n+     * @return public IP address object\n      * @throws InsufficientAddressCapacityException\n      * @throws ConcurrentOperationException\n      */\n     PublicIp assignSourceNatIpAddressToVpc(Account owner, Vpc vpc) throws InsufficientAddressCapacityException, ConcurrentOperationException;\n \n \n     /**\n+     * Validates network offering to find if it can be used for network creation in VPC\n+     * \n      * @param guestNtwkOff\n      * @param supportedSvcs TODO\n      */\n     void validateNtwkOffForVpc(NetworkOffering guestNtwkOff, List<Service> supportedSvcs);\n \n \n     /**\n-     * @return\n+     * @return list of hypervisors that are supported by VPC\n      */\n     List<HypervisorType> getSupportedVpcHypervisors();\n+    \n+    \n+    /**\n+     * Lists all the services and providers that the current VPC suppots\n+     * @param vpcOffId\n+     * @return map of Service to Provider(s) map \n+     */\n+    Map<Service, Set<Provider>> getVpcOffSvcProvidersMap(long vpcOffId);\n+    \n+    \n+    /**\n+     * Returns VPC that is ready to be used\n+     * @param vpcId\n+     * @return VPC object\n+     */\n+    public Vpc getActiveVpc(long vpcId);\n \n+\n+    /**\n+     * Performs network offering validation to determine if it can be used for network upgrade inside the VPC \n+     * @param networkId\n+     * @param newNtwkOffId\n+     * @param newCidr\n+     * @param newNetworkDomain\n+     * @param vpc\n+     * @param gateway\n+     * @param networkOwner TODO\n+     */\n+    void validateNtwkOffForNtwkInVpc(Long networkId, long newNtwkOffId, String newCidr, String newNetworkDomain, Vpc vpc, String gateway, Account networkOwner);\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcManager.java",
                "sha": "84ab8ef5dd7cb95f2d116bfd951be531c61785f8",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/VpcManagerImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 59,
                "filename": "server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "patch": "@@ -31,13 +31,12 @@\n import javax.inject.Inject;\n import javax.naming.ConfigurationException;\n \n-import com.cloud.network.element.StaticNatServiceProvider;\n+import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n+import org.apache.cloudstack.api.command.user.vpc.ListPrivateGatewaysCmd;\n import org.apache.cloudstack.api.command.user.vpc.ListStaticRoutesCmd;\n import org.apache.log4j.Logger;\n import org.springframework.stereotype.Component;\n \n-import org.apache.cloudstack.acl.ControlledEntity.ACLType;\n-import org.apache.cloudstack.api.command.user.vpc.ListPrivateGatewaysCmd;\n import com.cloud.configuration.Config;\n import com.cloud.configuration.ConfigurationManager;\n import com.cloud.configuration.Resource.ResourceType;\n@@ -77,6 +76,7 @@\n import com.cloud.network.dao.NetworkVO;\n import com.cloud.network.dao.PhysicalNetworkDao;\n import com.cloud.network.dao.Site2SiteVpnGatewayDao;\n+import com.cloud.network.element.StaticNatServiceProvider;\n import com.cloud.network.element.VpcProvider;\n import com.cloud.network.vpc.VpcOffering.State;\n import com.cloud.network.vpc.dao.PrivateIpDao;\n@@ -103,8 +103,6 @@\n import com.cloud.utils.NumbersUtil;\n import com.cloud.utils.Pair;\n import com.cloud.utils.Ternary;\n-\n-import com.cloud.utils.component.Manager;\n import com.cloud.utils.component.ManagerBase;\n import com.cloud.utils.concurrency.NamedThreadFactory;\n import com.cloud.utils.db.DB;\n@@ -124,8 +122,8 @@\n \n \n @Component\n-@Local(value = { VpcManager.class, VpcService.class })\n-public class VpcManagerImpl extends ManagerBase implements VpcManager{\n+@Local(value = { VpcManager.class, VpcService.class, VpcProvisioningService.class })\n+public class VpcManagerImpl extends ManagerBase implements VpcManager, VpcProvisioningService{\n     private static final Logger s_logger = Logger.getLogger(VpcManagerImpl.class);\n     @Inject\n     VpcOfferingDao _vpcOffDao;\n@@ -584,19 +582,6 @@ public Vpc createVpc(long zoneId, long vpcOffId, long vpcOwnerId, String vpcName\n         \n         return createVpc(zoneId, vpcOffId, owner, vpcName, displayText, cidr, networkDomain);\n     }\n-    \n-    @Override\n-    public boolean vpcProviderEnabledInZone(long zoneId, String provider)\n-    {\n-        //the provider has to be enabled at least in one network in the zone\n-        for (PhysicalNetwork pNtwk : _pNtwkDao.listByZone(zoneId)) {\n-            if (_ntwkModel.isProviderEnabledInPhysicalNetwork(pNtwk.getId(), provider)) {\n-                return true;\n-            }\n-        }\n-        \n-        return false;\n-    }\n \n     \n     @DB\n@@ -656,7 +641,7 @@ protected Vpc createVpc(long zoneId, long vpcOffId, Account vpcOwner, String vpc\n             }\n \n \n-            if (!vpcProviderEnabledInZone(zoneId, provider)) {\n+            if (!_ntwkModel.isProviderEnabledInZone(zoneId, provider)) {\n                 throw new InvalidParameterValueException(\"Provider \" + provider +\n                         \" should be enabled in at least one physical network of the zone specified\");\n             }\n@@ -1015,20 +1000,20 @@ public boolean shutdownVpc(long vpcId) throws ConcurrentOperationException, Reso\n         return success;\n     }\n     \n-    @Override\n     @DB\n-    public void validateNtkwOffForVpc(long ntwkOffId, String cidr, String networkDomain, \n-            Account networkOwner, Vpc vpc, Long networkId, String gateway) {\n+    @Override\n+    public void validateNtwkOffForNtwkInVpc(Long networkId, long newNtwkOffId, String newCidr, \n+            String newNetworkDomain, Vpc vpc, String gateway, Account networkOwner) {\n         \n-        NetworkOffering guestNtwkOff = _configMgr.getNetworkOffering(ntwkOffId);\n+        NetworkOffering guestNtwkOff = _configMgr.getNetworkOffering(newNtwkOffId);\n         \n         if (guestNtwkOff == null) {\n             throw new InvalidParameterValueException(\"Can't find network offering by id specified\");\n         }\n-\n+        \n         if (networkId == null) {\n             //1) Validate attributes that has to be passed in when create new guest network\n-            validateNewVpcGuestNetwork(cidr, gateway, networkOwner, vpc, networkDomain); \n+            validateNewVpcGuestNetwork(newCidr, gateway, networkOwner, vpc, newNetworkDomain); \n         }\n \n         //2) validate network offering attributes\n@@ -1213,7 +1198,7 @@ public boolean cleanupVpcResources(long vpcId, Account caller, long callerUserId\n         }\n \n         //4) Delete private gateway\n-        VpcGateway gateway = getPrivateGatewayForVpc(vpcId);\n+        PrivateGateway gateway = getVpcPrivateGateway(vpcId);\n         if (gateway != null) {\n             s_logger.debug(\"Deleting private gateway \" + gateway + \" as a part of vpc \" + vpcId + \" resources cleanup\");\n             if (!deleteVpcPrivateGateway(gateway.getId())) {\n@@ -1270,11 +1255,7 @@ public boolean restartVpc(long vpcId) throws ConcurrentOperationException, Resou\n         }  \n     }\n     \n-    @Override\n-    public List<DomainRouterVO> getVpcRouters(long vpcId) {\n-        return _routerDao.listByVpcId(vpcId);\n-    }\n-\n+    \n     @Override\n     public PrivateGateway getVpcPrivateGateway(long id) {\n         VpcGateway gateway = _vpcGatewayDao.findById(id);\n@@ -1835,11 +1816,6 @@ public void run() {\n             }\n         }\n     }\n-    \n-    @Override\n-    public VpcGateway getPrivateGatewayForVpc(long vpcId) {\n-        return _vpcGatewayDao.getPrivateGatewayForVpc(vpcId);\n-    }\n \n     \n     @DB\n@@ -1895,7 +1871,7 @@ public IpAddress associateIPToVpc(long ipId, long vpcId) throws ResourceAllocati\n     @Override\n     public void unassignIPFromVpcNetwork(long ipId, long networkId) {\n         IPAddressVO ip = _ipAddressDao.findById(ipId);\n-        if (ipUsedInVpc(ip)) {\n+        if (isIpAllocatedToVpc(ip)) {\n             return;\n         }\n \n@@ -1927,7 +1903,7 @@ public void unassignIPFromVpcNetwork(long ipId, long networkId) {\n     }\n     \n     @Override\n-    public boolean ipUsedInVpc(IpAddress ip) {\n+    public boolean isIpAllocatedToVpc(IpAddress ip) {\n         return (ip != null && ip.getVpcId() != null && \n                 (ip.isOneToOneNat() || !_firewallDao.listByIp(ip.getId()).isEmpty()));\n     }\n@@ -1957,7 +1933,7 @@ public Network createVpcGuestNetwork(long ntwkOffId, String name, String display\n         }\n         \n         //1) Validate if network can be created for VPC\n-        validateNtkwOffForVpc(ntwkOffId, cidr, networkDomain, owner, vpc, null, gateway);\n+        validateNtwkOffForNtwkInVpc(null, ntwkOffId, cidr, networkDomain, vpc, gateway, owner);\n \n         //2) Create network\n         Network guestNetwork = _ntwkMgr.createGuestNetwork(ntwkOffId, name, displayText, gateway, cidr, vlanId, \n@@ -2020,24 +1996,7 @@ public PublicIp assignSourceNatIpAddressToVpc(Account owner, Vpc vpc) throws Ins\n \n         return ipToReturn;\n     }\n-\n-\n-    @Override\n-    public Network updateVpcGuestNetwork(long networkId, String name, String displayText, Account callerAccount, \n-            User callerUser, String domainSuffix, Long ntwkOffId, Boolean changeCidr, String guestVmCidr) {\n-        NetworkVO network = _ntwkDao.findById(networkId);\n-        if (network == null) {\n-            throw new InvalidParameterValueException(\"Couldn't find network by id\");\n-        }\n-        //perform below validation if the network is vpc network\n-        if (network.getVpcId() != null && ntwkOffId != null) {\n-            Vpc vpc = getVpc(network.getVpcId());\n-            validateNtkwOffForVpc(ntwkOffId, null, null, null, vpc, networkId, null);\n-        }\n-        \n-        return _ntwkSvc.updateGuestNetwork(networkId, name, displayText, callerAccount, callerUser, domainSuffix,\n-                ntwkOffId, changeCidr, guestVmCidr);\n-    }\n+    \n \n     @Override\n     public List<HypervisorType> getSupportedVpcHypervisors() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcManagerImpl.java",
                "sha": "3948f2ecf73aa0983d67dfa01a9b28e46e4aa1c2",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcOfferingVO.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/VpcOfferingVO.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/vpc/VpcOfferingVO.java",
                "patch": "@@ -102,7 +102,6 @@ public String getName() {\n         return name;\n     }\n \n-    @Override\n     public String getUniqueName() {\n         return uniqueName;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcOfferingVO.java",
                "sha": "9d5becf233368fe49e5f98e44bfa31ace9f64521",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcVO.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/vpc/VpcVO.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 7,
                "filename": "server/src/com/cloud/network/vpc/VpcVO.java",
                "patch": "@@ -26,9 +26,7 @@\n import javax.persistence.Id;\n import javax.persistence.Table;\n \n-import org.apache.cloudstack.api.Identity;\n import com.cloud.utils.db.GenericDao;\n-import org.apache.cloudstack.api.InternalIdentity;\n \n @Entity\n @Table(name=\"vpc\")\n@@ -94,11 +92,6 @@ public VpcVO(long zoneId, String name, String displayText, long accountId, long\n         this.networkDomain = networkDomain;\n         this.vpcOfferingId = vpcOffId;\n     }\n-    \n-    @Override\n-    public boolean readyToUse() {\n-        return state == State.Enabled;\n-    }\n \n     @Override\n     public long getId() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/src/com/cloud/network/vpc/VpcVO.java",
                "sha": "7b784eb6458b6bf9f6c5be22a5b2fd45baf3740d",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/network/MockNetworkModelImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/network/MockNetworkModelImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "server/test/com/cloud/network/MockNetworkModelImpl.java",
                "patch": "@@ -844,4 +844,10 @@ public Nic getPlaceholderNic(Network network, Long podId) {\n         // TODO Auto-generated method stub\n         return null;\n     }\n+\n+    @Override\n+    public boolean isProviderEnabledInZone(long zoneId, String provider) {\n+        // TODO Auto-generated method stub\n+        return false;\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/network/MockNetworkModelImpl.java",
                "sha": "c5789659008a96d89073f47b2604dd68c78cf8bd",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/MockNetworkModelImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockNetworkModelImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "server/test/com/cloud/vpc/MockNetworkModelImpl.java",
                "patch": "@@ -857,4 +857,10 @@ public Nic getPlaceholderNic(Network network, Long podId) {\n         return null;\n     }\n \n+    @Override\n+    public boolean isProviderEnabledInZone(long zoneId, String provider) {\n+        // TODO Auto-generated method stub\n+        return false;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/MockNetworkModelImpl.java",
                "sha": "e1534cbf62aebd5bbac6be17af66c5e90cc1b59e",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/MockVpcManagerImpl.java",
                "changes": 106,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockVpcManagerImpl.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 94,
                "filename": "server/test/com/cloud/vpc/MockVpcManagerImpl.java",
                "patch": "@@ -47,35 +47,18 @@\n import com.cloud.network.vpc.Vpc;\n import com.cloud.network.vpc.VpcGateway;\n import com.cloud.network.vpc.VpcManager;\n-import com.cloud.network.vpc.VpcOffering;\n import com.cloud.network.vpc.VpcService;\n import com.cloud.offering.NetworkOffering;\n import com.cloud.user.Account;\n-import com.cloud.user.User;\n import com.cloud.utils.Pair;\n-import com.cloud.utils.component.Manager;\n import com.cloud.utils.component.ManagerBase;\n-import com.cloud.vm.DomainRouterVO;\n import com.cloud.vpc.dao.MockVpcDaoImpl;\n \n @Component\n @Local(value = { VpcManager.class, VpcService.class })\n public class MockVpcManagerImpl extends ManagerBase implements VpcManager {\n     @Inject MockVpcDaoImpl _vpcDao;\n \n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcService#getVpcOffering(long)\n-     */\n-    @Override\n-    public VpcOffering getVpcOffering(long vpcOfferingId) {\n-        // TODO Auto-generated method stub\n-        return null;\n-    }\n-\n-    @Override\n-    public VpcOffering createVpcOffering(String name, String displayText, List<String> supportedServices, Map<String, List<String>> serviceProviders) {\n-        return null;\n-    }\n \n     /* (non-Javadoc)\n      * @see com.cloud.network.vpc.VpcService#getVpc(long)\n@@ -104,42 +87,6 @@ public Vpc getActiveVpc(long vpcId) {\n         return null;\n     }\n \n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcService#getVpcOffSvcProvidersMap(long)\n-     */\n-    @Override\n-    public Map<Service, Set<Provider>> getVpcOffSvcProvidersMap(long vpcOffId) {\n-        // TODO Auto-generated method stub\n-        return null;\n-    }\n-\n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcService#listVpcOfferings(java.lang.Long, java.lang.String, java.lang.String, java.util.List, java.lang.Boolean, java.lang.String, java.lang.String, java.lang.Long, java.lang.Long)\n-     */\n-    @Override\n-    public List<? extends VpcOffering> listVpcOfferings(Long id, String name, String displayText, List<String> supportedServicesStr, Boolean isDefault, String keyword, String state, Long startIndex, Long pageSizeVal) {\n-        // TODO Auto-generated method stub\n-        return null;\n-    }\n-\n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcService#deleteVpcOffering(long)\n-     */\n-    @Override\n-    public boolean deleteVpcOffering(long offId) {\n-        // TODO Auto-generated method stub\n-        return false;\n-    }\n-\n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcService#updateVpcOffering(long, java.lang.String, java.lang.String, java.lang.String)\n-     */\n-    @Override\n-    public VpcOffering updateVpcOffering(long vpcOffId, String vpcOfferingName, String displayText, String state) {\n-        // TODO Auto-generated method stub\n-        return null;\n-    }\n-\n     /* (non-Javadoc)\n      * @see com.cloud.network.vpc.VpcService#createVpc(long, long, long, java.lang.String, java.lang.String, java.lang.String, java.lang.String)\n      */\n@@ -313,19 +260,6 @@ public IpAddress associateIPToVpc(long ipId, long vpcId) throws ResourceAllocati\n         return null;\n     }\n \n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcService#updateVpcGuestNetwork(long, java.lang.String, java.lang.String, com.cloud.user.Account, com.cloud.user.User, java.lang.String, java.lang.Long, java.lang.Boolean)\n-     */\n-\n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcManager#validateNtkwOffForVpc(long, java.lang.String, java.lang.String, com.cloud.user.Account, com.cloud.network.vpc.Vpc, java.lang.Long, java.lang.String)\n-     */\n-    @Override\n-    public void validateNtkwOffForVpc(long ntwkOffId, String cidr, String networkDomain, Account networkOwner, Vpc vpc, Long networkId, String gateway) {\n-        // TODO Auto-generated method stub\n-\n-    }\n-\n     /* (non-Javadoc)\n      * @see com.cloud.network.vpc.VpcManager#getVpcsForAccount(long)\n      */\n@@ -344,34 +278,13 @@ public boolean destroyVpc(Vpc vpc, Account caller, Long callerUserId) throws Con\n         return false;\n     }\n \n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcManager#getVpcRouters(long)\n-     */\n-    @Override\n-    public List<DomainRouterVO> getVpcRouters(long vpcId) {\n-        // TODO Auto-generated method stub\n-        return null;\n-    }\n \n-    @Override\n-    public boolean vpcProviderEnabledInZone(long zoneId, String provider) {\n-        return false;\n-    }\n-\n-    /* (non-Javadoc)\n-     * @see com.cloud.network.vpc.VpcManager#getPrivateGatewayForVpc(long)\n-     */\n-    @Override\n-    public VpcGateway getPrivateGatewayForVpc(long vpcId) {\n-        // TODO Auto-generated method stub\n-        return null;\n-    }\n \n     /* (non-Javadoc)\n      * @see com.cloud.network.vpc.VpcManager#ipUsedInVpc(com.cloud.network.IpAddress)\n      */\n     @Override\n-    public boolean ipUsedInVpc(IpAddress ip) {\n+    public boolean isIpAllocatedToVpc(IpAddress ip) {\n         // TODO Auto-generated method stub\n         return false;\n     }\n@@ -458,11 +371,16 @@ public void validateNtwkOffForVpc(NetworkOffering guestNtwkOff, List<Service> su\n         return null;\n     }\n \n-\t@Override\n-\tpublic Network updateVpcGuestNetwork(long networkId, String name,  String displayText, Account callerAccount, User callerUser,\n-\t\t\tString domainSuffix, Long ntwkOffId, Boolean changeCidr,\tString guestVmCidr) {\n-\t\t// TODO Auto-generated method stub\n-\t\treturn null;\n-\t}\n+    @Override\n+    public Map<Service, Set<Provider>> getVpcOffSvcProvidersMap(long vpcOffId) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n+    @Override\n+    public void validateNtwkOffForNtwkInVpc(Long networkId, long newNtwkOffId, String newCidr, String newNetworkDomain, Vpc vpc, String gateway, Account networkOwner) {\n+        // TODO Auto-generated method stub\n+        \n+    }\n \n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/MockVpcManagerImpl.java",
                "sha": "0f26928412721c9635820e9235aa8d958df6e7af",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 0,
                "filename": "server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java",
                "patch": "@@ -396,4 +396,10 @@ public boolean stopSite2SiteVpn(Site2SiteVpnConnection conn, VirtualRouter route\n         return false;\n     }\n \n+    @Override\n+    public List<DomainRouterVO> getVpcRouters(long vpcId) {\n+        // TODO Auto-generated method stub\n+        return null;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/MockVpcVirtualNetworkApplianceManager.java",
                "sha": "ef5478bb1f86bd2cdb92bf2ff33ce72320cc37e5",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/VpcApiUnitTest.java",
                "changes": 37,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/test/com/cloud/vpc/VpcApiUnitTest.java?ref=cf72aa32747a44ef876b9566d5c85db2f189b84e",
                "deletions": 31,
                "filename": "server/test/com/cloud/vpc/VpcApiUnitTest.java",
                "patch": "@@ -30,38 +30,13 @@\n import org.springframework.test.context.ContextConfiguration;\n import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n \n-import com.cloud.configuration.dao.ConfigurationDaoImpl;\n-import com.cloud.configuration.dao.ResourceCountDaoImpl;\n-import com.cloud.dc.dao.VlanDaoImpl;\n import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.network.Network.Service;\n-import com.cloud.network.dao.FirewallRulesDaoImpl;\n-import com.cloud.network.dao.IPAddressDaoImpl;\n-import com.cloud.network.dao.PhysicalNetworkDaoImpl;\n-import com.cloud.network.dao.Site2SiteVpnGatewayDaoImpl;\n import com.cloud.network.vpc.Vpc;\n-import com.cloud.network.vpc.VpcManager;\n import com.cloud.network.vpc.VpcManagerImpl;\n-import com.cloud.network.vpc.dao.PrivateIpDaoImpl;\n-import com.cloud.network.vpc.dao.StaticRouteDaoImpl;\n-import com.cloud.network.vpc.dao.VpcGatewayDaoImpl;\n-import com.cloud.network.vpc.dao.VpcOfferingDaoImpl;\n-import com.cloud.server.ManagementService;\n-import com.cloud.tags.dao.ResourceTagsDaoImpl;\n import com.cloud.user.AccountVO;\n-import com.cloud.user.MockAccountManagerImpl;\n-import com.cloud.user.dao.AccountDaoImpl;\n import com.cloud.utils.component.ComponentContext;\n \n-import com.cloud.vm.dao.DomainRouterDaoImpl;\n-import com.cloud.vpc.dao.MockNetworkDaoImpl;\n-import com.cloud.vpc.dao.MockNetworkOfferingDaoImpl;\n-import com.cloud.vpc.dao.MockNetworkOfferingServiceMapDaoImpl;\n-import com.cloud.vpc.dao.MockNetworkServiceMapDaoImpl;\n-import com.cloud.vpc.dao.MockVpcDaoImpl;\n-import com.cloud.vpc.dao.MockVpcOfferingDaoImpl;\n-import com.cloud.vpc.dao.MockVpcOfferingServiceMapDaoImpl;\n-\n @RunWith(SpringJUnit4ClassRunner.class)\n @ContextConfiguration(locations = \"classpath:/VpcTestContext.xml\")\n public class VpcApiUnitTest extends TestCase{\n@@ -180,7 +155,7 @@ protected void validateNtwkOffForVpc() {\n         //1) correct network offering\n         boolean result = false;\n         try {\n-            _vpcService.validateNtkwOffForVpc(1, \"0.0.0.0\", \"111-\", new AccountVO(), _vpcService.getVpc(1), 2L, \"10.1.1.1\");\n+            _vpcService.validateNtwkOffForNtwkInVpc(2L, 1, \"0.0.0.0\", \"111-\", _vpcService.getVpc(1), \"10.1.1.1\", new AccountVO());\n             result = true;\n             s_logger.debug(\"Validate network offering: Test passed: the offering is valid for vpc creation\");\n         } catch (Exception ex) {\n@@ -191,7 +166,7 @@ protected void validateNtwkOffForVpc() {\n         result = false;\n         String msg = null;\n         try {\n-            _vpcService.validateNtkwOffForVpc(2, \"0.0.0.0\", \"111-\", new AccountVO(), _vpcService.getVpc(1), 2L, \"10.1.1.1\");\n+            _vpcService.validateNtwkOffForNtwkInVpc(2L, 2, \"0.0.0.0\", \"111-\", _vpcService.getVpc(1), \"10.1.1.1\", new AccountVO());\n             result = true;\n         } catch (InvalidParameterValueException ex) {\n             msg = ex.getMessage();\n@@ -207,7 +182,7 @@ protected void validateNtwkOffForVpc() {\n         result = false;\n         msg = null;\n         try {\n-            _vpcService.validateNtkwOffForVpc(3, \"0.0.0.0\", \"111-\", new AccountVO(), _vpcService.getVpc(1), 2L, \"10.1.1.1\");\n+            _vpcService.validateNtwkOffForNtwkInVpc(2L, 3, \"0.0.0.0\", \"111-\", _vpcService.getVpc(1), \"10.1.1.1\", new AccountVO());\n             result = true;\n         } catch (InvalidParameterValueException ex) {\n             msg = ex.getMessage();\n@@ -222,7 +197,7 @@ protected void validateNtwkOffForVpc() {\n         //4) invalid offering - guest type shared\n         result = false;\n         try {\n-            _vpcService.validateNtkwOffForVpc(4, \"0.0.0.0\", \"111-\", new AccountVO(), _vpcService.getVpc(1), 2L, \"10.1.1.1\");\n+            _vpcService.validateNtwkOffForNtwkInVpc(2L, 4, \"0.0.0.0\", \"111-\", _vpcService.getVpc(1), \"10.1.1.1\", new AccountVO());\n             result = true;\n         } catch (InvalidParameterValueException ex) {\n             msg = ex.getMessage();\n@@ -237,7 +212,7 @@ protected void validateNtwkOffForVpc() {\n         //5) Invalid offering - no redundant router support\n         result = false;\n         try {\n-            _vpcService.validateNtkwOffForVpc(5, \"0.0.0.0\", \"111-\", new AccountVO(), _vpcService.getVpc(1), 2L, \"10.1.1.1\");\n+            _vpcService.validateNtwkOffForNtwkInVpc(2L, 5, \"0.0.0.0\", \"111-\", _vpcService.getVpc(1), \"10.1.1.1\", new AccountVO());\n             result = true;\n         } catch (InvalidParameterValueException ex) {\n             msg = ex.getMessage();\n@@ -252,7 +227,7 @@ protected void validateNtwkOffForVpc() {\n         //6) Only one network in the VPC can support LB service - negative scenario\n         result = false;\n         try {\n-            _vpcService.validateNtkwOffForVpc(6, \"0.0.0.0\", \"111-\", new AccountVO(), _vpcService.getVpc(1), 2L, \"10.1.1.1\");\n+            _vpcService.validateNtwkOffForNtwkInVpc(2L, 6, \"0.0.0.0\", \"111-\", _vpcService.getVpc(1), \"10.1.1.1\", new AccountVO());\n             result = true;\n             s_logger.debug(\"Validate network offering: Test passed: the offering is valid for vpc creation\");\n         } catch (InvalidParameterValueException ex) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/cf72aa32747a44ef876b9566d5c85db2f189b84e/server/test/com/cloud/vpc/VpcApiUnitTest.java",
                "sha": "d4d5b29812d00c4b8e12d19356d168fb1a4c153f",
                "status": "modified"
            }
        ],
        "message": "Fixes/improvements for VPC feature:\n\n1) Added comments to VPC/VPCService/VPCManager interfaces\n2) Moved VPC offering related methods from VpcService to the new interface - VpcProvisioningService\n3) Fixed static nat creation in the VPC - used to result in NPE due to invalid method referencing while obtaining VPC VR information",
        "parent": "https://github.com/apache/cloudstack/commit/f8471e545f41dd3c57fd65f9be9c2b3f25dba4ab",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkModelTest.java",
            "BaseCmdTest.java",
            "CreateVPCOfferingCmdTest.java",
            "VpcVirtualRouterElementTest.java",
            "VpcManagerImplTest.java"
        ]
    },
    "cloudstack_d1a14fb": {
        "bug_id": "cloudstack_d1a14fb",
        "commit": "https://github.com/apache/cloudstack/commit/d1a14fbf9549aa6c25526729fc32c6a5fb20b364",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/d1a14fbf9549aa6c25526729fc32c6a5fb20b364/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=d1a14fbf9549aa6c25526729fc32c6a5fb20b364",
                "deletions": 1,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -757,7 +757,7 @@ public VolumeVO resizeVolume(ResizeVolumeCmd cmd) throws ResourceAllocationExcep\n             }\n \n             if (diskOffering.getTags() != null) {\n-                if (!newDiskOffering.getTags().equals(diskOffering.getTags())) {\n+                if (newDiskOffering.getTags() == null || !newDiskOffering.getTags().equals(diskOffering.getTags())) {\n                     throw new InvalidParameterValueException(\"Tags on new and old disk offerings must match\");\n                 }\n             } else if (newDiskOffering.getTags() != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/d1a14fbf9549aa6c25526729fc32c6a5fb20b364/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "16eecd60bc318b1fbe67316083901aa518e863cc",
                "status": "modified"
            }
        ],
        "message": "  disk resize NPE, if the new disk offering doesn't have tags, then NPE",
        "parent": "https://github.com/apache/cloudstack/commit/0eb3944fc8108b3a8bf161bad692f6f58fb5835b",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_d1d722f": {
        "bug_id": "cloudstack_d1d722f",
        "commit": "https://github.com/apache/cloudstack/commit/d1d722f9bde91ce36f494142f4651a22c6795d6b",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/d1d722f9bde91ce36f494142f4651a22c6795d6b/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java?ref=d1d722f9bde91ce36f494142f4651a22c6795d6b",
                "deletions": 2,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "patch": "@@ -314,8 +314,11 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n         to.setOs(guestOS.getDisplayName());\n         to.setHostName(vm.getHostName());\n         HostVO host = _hostDao.findById(vm.getVirtualMachine().getHostId());\n-        GuestOSHypervisorVO guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n-        if (guestOsMapping == null) {\n+        GuestOSHypervisorVO guestOsMapping = null;\n+        if (host != null) {\n+            guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n+        }\n+        if (guestOsMapping == null || host == null) {\n             to.setPlatformEmulator(null);\n         } else {\n             to.setPlatformEmulator(guestOsMapping.getGuestOsName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/d1d722f9bde91ce36f494142f4651a22c6795d6b/plugins/hypervisors/vmware/src/com/cloud/hypervisor/guru/VMwareGuru.java",
                "sha": "abc7cdba5096b466bfb4db08042d8c313bb14d7c",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/d1d722f9bde91ce36f494142f4651a22c6795d6b/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/XenServerGuru.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/XenServerGuru.java?ref=d1d722f9bde91ce36f494142f4651a22c6795d6b",
                "deletions": 2,
                "filename": "plugins/hypervisors/xenserver/src/com/cloud/hypervisor/XenServerGuru.java",
                "patch": "@@ -92,8 +92,11 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n         GuestOSVO guestOS = _guestOsDao.findById(vm.getVirtualMachine().getGuestOSId());\n         to.setOs(guestOS.getDisplayName());\n         HostVO host = hostDao.findById(vm.getVirtualMachine().getHostId());\n-        GuestOSHypervisorVO guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n-        if (guestOsMapping == null) {\n+        GuestOSHypervisorVO guestOsMapping = null;\n+        if (host != null) {\n+            guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n+        }\n+        if (guestOsMapping == null || host == null) {\n             to.setPlatformEmulator(null);\n         } else {\n             to.setPlatformEmulator(guestOsMapping.getGuestOsName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/d1d722f9bde91ce36f494142f4651a22c6795d6b/plugins/hypervisors/xenserver/src/com/cloud/hypervisor/XenServerGuru.java",
                "sha": "c1de8bbb9768369fd48f5351bf47c1c21e9300a3",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/d1d722f9bde91ce36f494142f4651a22c6795d6b/server/src/com/cloud/hypervisor/KVMGuru.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/KVMGuru.java?ref=d1d722f9bde91ce36f494142f4651a22c6795d6b",
                "deletions": 2,
                "filename": "server/src/com/cloud/hypervisor/KVMGuru.java",
                "patch": "@@ -60,8 +60,11 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n         GuestOSVO guestOS = _guestOsDao.findById(vm.getVirtualMachine().getGuestOSId());\n         to.setOs(guestOS.getDisplayName());\n         HostVO host = _hostDao.findById(vm.getVirtualMachine().getHostId());\n-        GuestOSHypervisorVO guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n-        if (guestOsMapping == null) {\n+        GuestOSHypervisorVO guestOsMapping = null;\n+        if (host != null) {\n+            guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n+        }\n+        if (guestOsMapping == null || host == null) {\n             to.setPlatformEmulator(\"Other\");\n         } else {\n             to.setPlatformEmulator(guestOsMapping.getGuestOsName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/d1d722f9bde91ce36f494142f4651a22c6795d6b/server/src/com/cloud/hypervisor/KVMGuru.java",
                "sha": "492342c46a80d6bb4718b2b3208bf0e396ea2a83",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/d1d722f9bde91ce36f494142f4651a22c6795d6b/server/src/com/cloud/hypervisor/LXCGuru.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/hypervisor/LXCGuru.java?ref=d1d722f9bde91ce36f494142f4651a22c6795d6b",
                "deletions": 2,
                "filename": "server/src/com/cloud/hypervisor/LXCGuru.java",
                "patch": "@@ -56,8 +56,11 @@ public VirtualMachineTO implement(VirtualMachineProfile vm) {\n         to.setOs(guestOS.getDisplayName());\n \n         HostVO host = _hostDao.findById(vm.getVirtualMachine().getHostId());\n-        GuestOSHypervisorVO guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n-        if (guestOsMapping == null) {\n+        GuestOSHypervisorVO guestOsMapping = null;\n+        if (host != null) {\n+            guestOsMapping = _guestOsHypervisorDao.findByOsIdAndHypervisor(guestOS.getId(), getHypervisorType().toString(), host.getHypervisorVersion());\n+        }\n+        if (guestOsMapping == null || host == null) {\n             to.setPlatformEmulator(\"Other\");\n         } else {\n             to.setPlatformEmulator(guestOsMapping.getGuestOsName());",
                "raw_url": "https://github.com/apache/cloudstack/raw/d1d722f9bde91ce36f494142f4651a22c6795d6b/server/src/com/cloud/hypervisor/LXCGuru.java",
                "sha": "46989d9f561810c07e716732fcbb6943afda2423",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7295: VMs is Stopped state have no host ID, resulting in NPE",
        "parent": "https://github.com/apache/cloudstack/commit/97efbc56e4e24563d1a68db9da500054867683c6",
        "repo": "cloudstack",
        "unit_tests": [
            "VMwareGuruTest.java",
            "XenServerGuruTest.java",
            "KVMGuruTest.java"
        ]
    },
    "cloudstack_d367350": {
        "bug_id": "cloudstack_d367350",
        "commit": "https://github.com/apache/cloudstack/commit/d3673506cf3aec8ef9f4f8e0a172f6ebec448505",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/d3673506cf3aec8ef9f4f8e0a172f6ebec448505/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=d3673506cf3aec8ef9f4f8e0a172f6ebec448505",
                "deletions": 5,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1602,13 +1602,10 @@ public Commands fullHostSync(final long hostId, StartupRoutingCommand startup) {\n             VMInstanceVO castedVm = null;\n             if (info == null) {\n                 info = new AgentVmInfo(vm.getInstanceName(), getVmGuru(vm), vm, State.Stopped);\n-                castedVm = info.guru.findById(vm.getId());\n-            } else {\n-                castedVm = info.vm;\n-            }\n+            } \n+            castedVm = info.guru.findById(vm.getId());\n \n             HypervisorGuru hvGuru = _hvGuruMgr.getGuru(castedVm.getHypervisorType());\n-\n             Command command = compareState(hostId, castedVm, info, true, hvGuru.trackVmHostChange());\n             if (command != null) {\n                 commands.addCommand(command);",
                "raw_url": "https://github.com/apache/cloudstack/raw/d3673506cf3aec8ef9f4f8e0a172f6ebec448505/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "650ced468b4e24ffa241b0a7016608056ff18b16",
                "status": "modified"
            }
        ],
        "message": "bug 14216: rightly initializing to avoid NPE",
        "parent": "https://github.com/apache/cloudstack/commit/99000f5d6e3a137c69039988ae0d5a4d488e2b4c",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_d42e3df": {
        "bug_id": "cloudstack_d42e3df",
        "commit": "https://github.com/apache/cloudstack/commit/d42e3df9cf43b0ad46d406c6ab5b1d8c811d0239",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/d42e3df9cf43b0ad46d406c6ab5b1d8c811d0239/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=d42e3df9cf43b0ad46d406c6ab5b1d8c811d0239",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1247,7 +1247,8 @@ protected boolean sendStop(VirtualMachineGuru guru, VirtualMachineProfile profil\n                     _resourceMgr.updateGPUDetails(vm.getHostId(), gpuDevice.getGroupDetails());\n                 }\n                 if (answer == null || !answer.getResult()) {\n-                    s_logger.debug(\"Unable to stop VM due to \" + answer.getDetails());\n+                    String details = (answer != null) ? answer.getDetails() : \"null answer returned\";\n+                    s_logger.debug(\"Unable to stop VM due to \" + details);\n                     return false;\n                 }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/d42e3df9cf43b0ad46d406c6ab5b1d8c811d0239/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "83779064f493a13bfc89061fc179be5310e999de",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7563: Fix potential NPE in checking answer\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/4c21172f3b3b9dd26a66fa03e246da7a4e4b9e8a",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_d4d4957": {
        "bug_id": "cloudstack_d4d4957",
        "commit": "https://github.com/apache/cloudstack/commit/d4d49578dc2dfc03aa7247811ba571da20c82cd5",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/VmwareServerDiscoverer.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/VmwareServerDiscoverer.java?ref=d4d49578dc2dfc03aa7247811ba571da20c82cd5",
                "deletions": 6,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/VmwareServerDiscoverer.java",
                "patch": "@@ -42,14 +42,12 @@\n import com.cloud.dc.ClusterVO;\n import com.cloud.dc.DataCenter.NetworkType;\n import com.cloud.dc.DataCenterVO;\n-import com.cloud.dc.dao.ClusterDao;\n import com.cloud.dc.dao.DataCenterDao;\n import com.cloud.exception.DiscoveredWithErrorException;\n import com.cloud.exception.DiscoveryException;\n import com.cloud.exception.InvalidParameterValueException;\n import com.cloud.exception.ResourceInUseException;\n import com.cloud.host.HostVO;\n-import com.cloud.host.dao.HostDao;\n import com.cloud.hypervisor.Hypervisor;\n import com.cloud.hypervisor.Hypervisor.HypervisorType;\n import com.cloud.hypervisor.dao.HypervisorCapabilitiesDao;\n@@ -87,8 +85,6 @@\n public class VmwareServerDiscoverer extends DiscovererBase implements Discoverer, ResourceStateAdapter {\n     private static final Logger s_logger = Logger.getLogger(VmwareServerDiscoverer.class);\n \n-    @Inject\n-    ClusterDao _clusterDao;\n     @Inject\n     VmwareManager _vmwareMgr;\n     @Inject\n@@ -98,8 +94,6 @@\n     @Inject\n     ClusterDetailsDao _clusterDetailsDao;\n     @Inject\n-    HostDao _hostDao;\n-    @Inject\n     DataCenterDao _dcDao;\n     @Inject\n     ResourceManager _resourceMgr;",
                "raw_url": "https://github.com/apache/cloudstack/raw/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/VmwareServerDiscoverer.java",
                "sha": "5ab5af0e041f906cc677d46ea9bfd14b86d61b71",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java?ref=d4d49578dc2dfc03aa7247811ba571da20c82cd5",
                "deletions": 3,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java",
                "patch": "@@ -382,10 +382,10 @@ private void prepareHost(HostMO hostMo, String privateTrafficLabel) throws Excep\n     @Override\n     public List<ManagedObjectReference> addHostToPodCluster(VmwareContext serviceContext, long dcId, Long podId, Long clusterId, String hostInventoryPath)\n             throws Exception {\n-        ManagedObjectReference mor = null;\n-        if (serviceContext != null) {\n-            mor = serviceContext.getHostMorByPath(hostInventoryPath);\n+        if (serviceContext == null) {\n+            throw new CloudRuntimeException(\"Invalid serviceContext\");\n         }\n+        ManagedObjectReference mor = serviceContext.getHostMorByPath(hostInventoryPath);\n         String privateTrafficLabel = null;\n         privateTrafficLabel = serviceContext.getStockObject(\"privateTrafficLabel\");\n         if (privateTrafficLabel == null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareManagerImpl.java",
                "sha": "67d3963cdc5d792cef626cc5772c46829a08372d",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java?ref=d4d49578dc2dfc03aa7247811ba571da20c82cd5",
                "deletions": 12,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "patch": "@@ -663,8 +663,6 @@ protected NetworkUsageAnswer VPCNetworkUsage(NetworkUsageCommand cmd) {\n     public ExecutionResult createFileInVR(String routerIp, String filePath, String fileName, String content) {\n         VmwareManager mgr = getServiceContext().getStockObject(VmwareManager.CONTEXT_STOCK_NAME);\n         File keyFile = mgr.getSystemVMKeyFile();\n-        boolean result = true;\n-\n         try {\n             SshHelper.scpTo(routerIp, 3922, \"root\", keyFile, null, filePath, content.getBytes(), fileName, null);\n         } catch (Exception e) {\n@@ -1065,9 +1063,6 @@ private int allocPublicNicIndex(VirtualMachineMO vmMo) throws Exception {\n     }\n \n     private ExecutionResult prepareNetworkElementCommand(IpAssocCommand cmd) {\n-        int i = 0;\n-        String[] results = new String[cmd.getIpAddresses().length];\n-\n         VmwareContext context = getServiceContext();\n         try {\n             VmwareHypervisorHost hyperHost = getHyperHost(context);\n@@ -1142,15 +1137,13 @@ private ExecutionResult prepareNetworkElementCommand(IpAssocCommand cmd) {\n     }\n \n     private ExecutionResult NetworkElementCommandnup(IpAssocCommand cmd) {\n-        String[] results = new String[cmd.getIpAddresses().length];\n-\n         VmwareContext context = getServiceContext();\n         try {\n             VmwareHypervisorHost hyperHost = getHyperHost(context);\n \n             IpAddressTO[] ips = cmd.getIpAddresses();\n             String routerName = cmd.getAccessDetail(NetworkElementCommand.ROUTER_NAME);\n-            String controlIp = VmwareResource.getRouterSshControlIp(cmd);\n+            VmwareResource.getRouterSshControlIp(cmd);\n \n             VirtualMachineMO vmMo = hyperHost.findVmOnHyperHost(routerName);\n \n@@ -4477,10 +4470,13 @@ public CreateAnswer execute(CreateCommand cmd) {\n                                         null);\n                         return new CreateAnswer(cmd, vol);\n                     } finally {\n-                        vmMo.detachAllDisks();\n \n                         s_logger.info(\"Destroy dummy VM after volume creation\");\n-                        vmMo.destroy();\n+                        if (vmMo != null) {\n+                            s_logger.warn(\"Unable to destroy a null VM ManagedObjectReference\");\n+                            vmMo.detachAllDisks();\n+                            vmMo.destroy();\n+                        }\n                     }\n                 } else {\n                     VirtualMachineMO vmTemplate = VmwareHelper.pickOneVmOnRunningHost(dcMo.findVmByNameAndLabel(cmd.getTemplateUrl()), true);\n@@ -4537,8 +4533,11 @@ public CreateAnswer execute(CreateCommand cmd) {\n                     return new CreateAnswer(cmd, vol);\n                 } finally {\n                     s_logger.info(\"Destroy dummy VM after volume creation\");\n-                    vmMo.detachAllDisks();\n-                    vmMo.destroy();\n+                    if (vmMo != null) {\n+                        s_logger.warn(\"Unable to destroy a null VM ManagedObjectReference\");\n+                        vmMo.detachAllDisks();\n+                        vmMo.destroy();\n+                    }\n                 }\n             }\n         } catch (Throwable e) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "sha": "182fe9f3b51ce6ff5e0f201d2e6e55a410ac8c37",
                "status": "modified"
            },
            {
                "additions": 37,
                "blob_url": "https://github.com/apache/cloudstack/blob/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java",
                "changes": 72,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java?ref=d4d49578dc2dfc03aa7247811ba571da20c82cd5",
                "deletions": 35,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java",
                "patch": "@@ -123,17 +123,17 @@ private String getOVFFilePath(String srcOVAFileName) {\n     }\n \n     private void copyTemplateFromSecondaryToPrimary(VmwareHypervisorHost hyperHost, DatastoreMO datastoreMo, String secondaryStorageUrl,\n-        String templatePathAtSecondaryStorage, String templateName, String templateUuid) throws Exception {\n+            String templatePathAtSecondaryStorage, String templateName, String templateUuid) throws Exception {\n \n         s_logger.info(\"Executing copyTemplateFromSecondaryToPrimary. secondaryStorage: \" + secondaryStorageUrl + \", templatePathAtSecondaryStorage: \" +\n-            templatePathAtSecondaryStorage + \", templateName: \" + templateName);\n+                templatePathAtSecondaryStorage + \", templateName: \" + templateName);\n \n         String secondaryMountPoint = mountService.getMountPoint(secondaryStorageUrl);\n         s_logger.info(\"Secondary storage mount point: \" + secondaryMountPoint);\n \n         String srcOVAFileName =\n-            VmwareStorageLayoutHelper.getTemplateOnSecStorageFilePath(secondaryMountPoint, templatePathAtSecondaryStorage, templateName,\n-                ImageFormat.OVA.getFileExtension());\n+                VmwareStorageLayoutHelper.getTemplateOnSecStorageFilePath(secondaryMountPoint, templatePathAtSecondaryStorage, templateName,\n+                        ImageFormat.OVA.getFileExtension());\n \n         String srcFileName = getOVFFilePath(srcOVAFileName);\n         if (srcFileName == null) {\n@@ -163,7 +163,7 @@ private void copyTemplateFromSecondaryToPrimary(VmwareHypervisorHost hyperHost,\n         VirtualMachineMO vmMo = hyperHost.findVmOnHyperHost(vmName);\n         if (vmMo == null) {\n             String msg =\n-                \"Failed to import OVA template. secondaryStorage: \" + secondaryStorageUrl + \", templatePathAtSecondaryStorage: \" + templatePathAtSecondaryStorage +\n+                    \"Failed to import OVA template. secondaryStorage: \" + secondaryStorageUrl + \", templatePathAtSecondaryStorage: \" + templatePathAtSecondaryStorage +\n                     \", templateName: \" + templateName + \", templateUuid: \" + templateUuid;\n             s_logger.error(msg);\n             throw new Exception(msg);\n@@ -218,7 +218,7 @@ public Answer copyTemplateToPrimaryStorage(CopyCommand cmd) {\n                 DatastoreMO primaryStorageDatastoreMo = new DatastoreMO(context, morDs);\n \n                 copyTemplateFromSecondaryToPrimary(hyperHost, primaryStorageDatastoreMo, secondaryStorageUrl, templateInfo.first(), templateInfo.second(),\n-                    templateUuidName);\n+                        templateUuidName);\n             } else {\n                 s_logger.info(\"Template \" + templateInfo.second() + \" has already been setup, skip the template setup process in primary storage\");\n             }\n@@ -238,7 +238,7 @@ public Answer copyTemplateToPrimaryStorage(CopyCommand cmd) {\n     }\n \n     private boolean createVMLinkedClone(VirtualMachineMO vmTemplate, DatacenterMO dcMo, DatastoreMO dsMo, String vmdkName, ManagedObjectReference morDatastore,\n-        ManagedObjectReference morPool) throws Exception {\n+            ManagedObjectReference morPool) throws Exception {\n \n         ManagedObjectReference morBaseSnapshot = vmTemplate.getSnapshotMor(\"cloud.template.base\");\n         if (morBaseSnapshot == null) {\n@@ -257,7 +257,7 @@ private boolean createVMLinkedClone(VirtualMachineMO vmTemplate, DatacenterMO dc\n     }\n \n     private boolean createVMFullClone(VirtualMachineMO vmTemplate, DatacenterMO dcMo, DatastoreMO dsMo, String vmdkName, ManagedObjectReference morDatastore,\n-        ManagedObjectReference morPool) throws Exception {\n+            ManagedObjectReference morPool) throws Exception {\n \n         s_logger.info(\"creating full clone from template\");\n         if (!vmTemplate.createFullClone(vmdkName, dcMo.getVmFolder(), morPool, morDatastore)) {\n@@ -293,7 +293,7 @@ public Answer cloneVolumeFromBaseTemplate(CopyCommand cmd) {\n             String vmdkFileBaseName = null;\n             if (srcStore == null) {\n                 // create a root volume for blank VM (created from ISO)\n-                String dummyVmName = this.hostService.getWorkerName(context, cmd, 0);\n+                String dummyVmName = hostService.getWorkerName(context, cmd, 0);\n \n                 try {\n                     vmMo = HypervisorHostHelper.createWorkerVM(hyperHost, dsMo, dummyVmName);\n@@ -312,10 +312,12 @@ public Answer cloneVolumeFromBaseTemplate(CopyCommand cmd) {\n                         vmMo.detachDisk(volumeDatastorePath, false);\n                     }\n                 } finally {\n-                    vmMo.detachAllDisks();\n-\n                     s_logger.info(\"Destroy dummy VM after volume creation\");\n-                    vmMo.destroy();\n+                    if (vmMo != null) {\n+                        s_logger.warn(\"Unable to destroy a null VM ManagedObjectReference\");\n+                        vmMo.detachAllDisks();\n+                        vmMo.destroy();\n+                    }\n                 }\n             } else {\n                 String templatePath = template.getPath();\n@@ -459,7 +461,7 @@ private String getVolumePathInDatastore(DatastoreMO dsMo, String volumeFileName)\n     }\n \n     private Pair<String, String> copyVolumeToSecStorage(VmwareHostService hostService, VmwareHypervisorHost hyperHost, CopyCommand cmd, String vmName, String poolId,\n-        String volumePath, String destVolumePath, String secStorageUrl, String workerVmName) throws Exception {\n+            String volumePath, String destVolumePath, String secStorageUrl, String workerVmName) throws Exception {\n         VirtualMachineMO workerVm = null;\n         VirtualMachineMO vmMo = null;\n         String exportName = UUID.randomUUID().toString().replace(\"-\", \"\");\n@@ -521,8 +523,8 @@ public Answer copyVolumeFromPrimaryToSecondary(CopyCommand cmd) {\n             Pair<String, String> result;\n \n             result =\n-                copyVolumeToSecStorage(hostService, hyperHost, cmd, vmName, primaryStorage.getUuid(), srcVolume.getPath(), destVolume.getPath(), destStore.getUrl(),\n-                    hostService.getWorkerName(context, cmd, 0));\n+                    copyVolumeToSecStorage(hostService, hyperHost, cmd, vmName, primaryStorage.getUuid(), srcVolume.getPath(), destVolume.getPath(), destStore.getUrl(),\n+                            hostService.getWorkerName(context, cmd, 0));\n             VolumeObjectTO newVolume = new VolumeObjectTO();\n             newVolume.setPath(result.first() + File.separator + result.second());\n             return new CopyCmdAnswer(newVolume);\n@@ -577,7 +579,7 @@ private void postCreatePrivateTemplate(String installFullPath, long templateId,\n     }\n \n     private Ternary<String, Long, Long> createTemplateFromVolume(VirtualMachineMO vmMo, String installPath, long templateId, String templateUniqueName,\n-        String secStorageUrl, String volumePath, String workerVmName) throws Exception {\n+            String secStorageUrl, String volumePath, String workerVmName) throws Exception {\n \n         String secondaryMountPoint = mountService.getMountPoint(secStorageUrl);\n         String installFullPath = secondaryMountPoint + \"/\" + installPath;\n@@ -611,7 +613,7 @@ private void postCreatePrivateTemplate(String installFullPath, long templateId,\n \n             // 4 MB is the minimum requirement for VM memory in VMware\n             Pair<VirtualMachineMO, String[]> cloneResult =\n-                vmMo.cloneFromCurrentSnapshot(workerVmName, 0, 4, volumeDeviceInfo.second(), VmwareHelper.getDiskDeviceDatastore(volumeDeviceInfo.first()));\n+                    vmMo.cloneFromCurrentSnapshot(workerVmName, 0, 4, volumeDeviceInfo.second(), VmwareHelper.getDiskDeviceDatastore(volumeDeviceInfo.first()));\n             clonedVm = cloneResult.first();\n \n             clonedVm.exportVm(secondaryMountPoint + \"/\" + installPath, templateUniqueName, false, false);\n@@ -674,7 +676,7 @@ public Answer createTemplateFromVolume(CopyCommand cmd) {\n             if (vmMo == null) {\n                 if (s_logger.isDebugEnabled()) {\n                     s_logger.debug(\"Unable to find the owner VM for CreatePrivateTemplateFromVolumeCommand on host \" + hyperHost.getHyperHostName() +\n-                        \", try within datacenter\");\n+                            \", try within datacenter\");\n                 }\n                 vmMo = hyperHost.findVmOnPeerHyperHost(volume.getVmName());\n \n@@ -694,8 +696,8 @@ public Answer createTemplateFromVolume(CopyCommand cmd) {\n             }\n \n             Ternary<String, Long, Long> result =\n-                createTemplateFromVolume(vmMo, template.getPath(), template.getId(), template.getName(), secondaryStoragePoolURL, volumePath,\n-                    hostService.getWorkerName(context, cmd, 0));\n+                    createTemplateFromVolume(vmMo, template.getPath(), template.getId(), template.getName(), secondaryStoragePoolURL, volumePath,\n+                            hostService.getWorkerName(context, cmd, 0));\n \n             TemplateObjectTO newTemplate = new TemplateObjectTO();\n             newTemplate.setPath(result.first());\n@@ -742,7 +744,7 @@ private void writeMetaOvaForTemplate(String installFullPath, String ovfFilename,\n     }\n \n     private Ternary<String, Long, Long> createTemplateFromSnapshot(String installPath, String templateUniqueName, String secStorageUrl, String snapshotPath,\n-        Long templateId) throws Exception {\n+            Long templateId) throws Exception {\n         //Snapshot path is decoded in this form: /snapshots/account/volumeId/uuid/uuid\n         String backupSSUuid;\n         String snapshotFolder;\n@@ -751,7 +753,7 @@ private void writeMetaOvaForTemplate(String installFullPath, String ovfFilename,\n             backupSSUuid = snapshotPath.substring(index + 1).replace(\".ova\", \"\");\n             snapshotFolder = snapshotPath.substring(0, index);\n         } else {\n-            String[] tokens = snapshotPath.split(File.separator);\n+            String[] tokens = snapshotPath.split(File.separatorChar == '\\\\' ? \"\\\\\\\\\" : File.separator);\n             backupSSUuid = tokens[tokens.length - 1];\n             snapshotFolder = StringUtils.join(tokens, File.separator, 0, tokens.length - 1);\n         }\n@@ -909,7 +911,7 @@ public Answer createTemplateFromSnapshot(CopyCommand cmd) {\n \n     // return Pair<String(divice bus name), String[](disk chain)>\n     private Pair<String, String[]> exportVolumeToSecondaryStroage(VirtualMachineMO vmMo, String volumePath, String secStorageUrl, String secStorageDir,\n-        String exportName, String workerVmName) throws Exception {\n+            String exportName, String workerVmName) throws Exception {\n \n         String secondaryMountPoint = mountService.getMountPoint(secStorageUrl);\n         String exportPath = secondaryMountPoint + \"/\" + secStorageDir + \"/\" + exportName;\n@@ -937,7 +939,7 @@ public Answer createTemplateFromSnapshot(CopyCommand cmd) {\n \n             // 4 MB is the minimum requirement for VM memory in VMware\n             Pair<VirtualMachineMO, String[]> cloneResult =\n-                vmMo.cloneFromCurrentSnapshot(workerVmName, 0, 4, volumeDeviceInfo.second(), VmwareHelper.getDiskDeviceDatastore(volumeDeviceInfo.first()));\n+                    vmMo.cloneFromCurrentSnapshot(workerVmName, 0, 4, volumeDeviceInfo.second(), VmwareHelper.getDiskDeviceDatastore(volumeDeviceInfo.first()));\n             clonedVm = cloneResult.first();\n             String disks[] = cloneResult.second();\n \n@@ -953,7 +955,7 @@ public Answer createTemplateFromSnapshot(CopyCommand cmd) {\n \n     // Ternary<String(backup uuid in secondary storage), String(device bus name), String[](original disk chain in the snapshot)>\n     private Ternary<String, String, String[]> backupSnapshotToSecondaryStorage(VirtualMachineMO vmMo, String installPath, String volumePath, String snapshotUuid,\n-        String secStorageUrl, String prevSnapshotUuid, String prevBackupUuid, String workerVmName) throws Exception {\n+            String secStorageUrl, String prevSnapshotUuid, String prevBackupUuid, String workerVmName) throws Exception {\n \n         String backupUuid = UUID.randomUUID().toString();\n         Pair<String, String[]> snapshotInfo = exportVolumeToSecondaryStroage(vmMo, volumePath, secStorageUrl, installPath, backupUuid, workerVmName);\n@@ -1030,8 +1032,8 @@ public Answer backupSnapshot(CopyCommand cmd) {\n                 }\n \n                 backupResult =\n-                    backupSnapshotToSecondaryStorage(vmMo, destSnapshot.getPath(), srcSnapshot.getVolume().getPath(), snapshotUuid, secondaryStorageUrl,\n-                        prevSnapshotUuid, prevBackupUuid, hostService.getWorkerName(context, cmd, 1));\n+                        backupSnapshotToSecondaryStorage(vmMo, destSnapshot.getPath(), srcSnapshot.getVolume().getPath(), snapshotUuid, secondaryStorageUrl,\n+                                prevSnapshotUuid, prevBackupUuid, hostService.getWorkerName(context, cmd, 1));\n                 snapshotBackupUuid = backupResult.first();\n \n                 success = (snapshotBackupUuid != null);\n@@ -1173,9 +1175,9 @@ private Answer attachVolume(Command cmd, DiskTO disk, boolean isAttach, boolean\n                 Map<String, String> details = disk.getDetails();\n \n                 morDs = hostService.prepareManagedStorage(hyperHost, iScsiName, storageHost, storagePort,\n-                            details.get(DiskTO.CHAP_INITIATOR_USERNAME), details.get(DiskTO.CHAP_INITIATOR_SECRET),\n-                            details.get(DiskTO.CHAP_TARGET_USERNAME), details.get(DiskTO.CHAP_TARGET_SECRET),\n-                            volumeTO.getSize(), cmd);\n+                        details.get(DiskTO.CHAP_INITIATOR_USERNAME), details.get(DiskTO.CHAP_INITIATOR_SECRET),\n+                        details.get(DiskTO.CHAP_TARGET_USERNAME), details.get(DiskTO.CHAP_TARGET_SECRET),\n+                        volumeTO.getSize(), cmd);\n             }\n             else {\n                 morDs = HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost, isManaged ? VmwareResource.getDatastoreName(iScsiName) : primaryStore.getUuid());\n@@ -1187,7 +1189,7 @@ private Answer attachVolume(Command cmd, DiskTO disk, boolean isAttach, boolean\n                 throw new Exception(msg);\n             }\n \n-            DatastoreMO dsMo = new DatastoreMO(this.hostService.getServiceContext(null), morDs);\n+            DatastoreMO dsMo = new DatastoreMO(hostService.getServiceContext(null), morDs);\n             String datastoreVolumePath;\n \n             if (isAttach) {\n@@ -1219,7 +1221,7 @@ private Answer attachVolume(Command cmd, DiskTO disk, boolean isAttach, boolean\n                 vmMo.detachDisk(datastoreVolumePath, false);\n \n                 if (isManaged) {\n-                    this.hostService.handleDatastoreAndVmdkDetach(iScsiName, storageHost, storagePort);\n+                    hostService.handleDatastoreAndVmdkDetach(iScsiName, storageHost, storagePort);\n                 } else {\n                     VmwareStorageLayoutHelper.syncVolumeToRootFolder(dsMo.getOwnerDatacenter().first(), dsMo, volumeTO.getPath());\n                 }\n@@ -1369,7 +1371,7 @@ public Answer createVolume(CreateObjectCommand cmd) {\n             String volumeUuid = UUID.randomUUID().toString().replace(\"-\", \"\");\n \n             String volumeDatastorePath = dsMo.getDatastorePath(volumeUuid + \".vmdk\");\n-            String dummyVmName = this.hostService.getWorkerName(context, cmd, 0);\n+            String dummyVmName = hostService.getWorkerName(context, cmd, 0);\n             try {\n                 s_logger.info(\"Create worker VM \" + dummyVmName);\n                 vmMo = HypervisorHostHelper.createWorkerVM(hyperHost, dsMo, dummyVmName);\n@@ -1485,7 +1487,7 @@ public Answer deleteVolume(DeleteCommand cmd) {\n \n                         // this.hostService.handleDatastoreAndVmdkDetach(iScsiName, storageHost, storagePort);\n                         if (managedIqns != null && !managedIqns.isEmpty()) {\n-                            this.hostService.removeManagedTargetsFromCluster(managedIqns);\n+                            hostService.removeManagedTargetsFromCluster(managedIqns);\n                         }\n \n                         for (NetworkDetails netDetails : networks) {\n@@ -1573,7 +1575,7 @@ public Answer deleteVolume(DeleteCommand cmd) {\n     }\n \n     private Long restoreVolumeFromSecStorage(VmwareHypervisorHost hyperHost, DatastoreMO primaryDsMo, String newVolumeName, String secStorageUrl, String secStorageDir,\n-        String backupName) throws Exception {\n+            String backupName) throws Exception {\n \n         String secondaryMountPoint = mountService.getMountPoint(secStorageUrl);\n         String srcOVAFileName = null;",
                "raw_url": "https://github.com/apache/cloudstack/raw/d4d49578dc2dfc03aa7247811ba571da20c82cd5/plugins/hypervisors/vmware/src/com/cloud/storage/resource/VmwareStorageProcessor.java",
                "sha": "9d86b16d6a4f9068928e8ea61538eb4c5da39445",
                "status": "modified"
            }
        ],
        "message": "Findbugs : Fix a number of potential NPEs and minor findings",
        "parent": "https://github.com/apache/cloudstack/commit/e0a4b7c891b1bf84c8f5be8b085a3f41948d12f0",
        "repo": "cloudstack",
        "unit_tests": [
            "VmwareManagerImplTest.java",
            "VmwareResourceTest.java"
        ]
    },
    "cloudstack_d6b41d9": {
        "bug_id": "cloudstack_d6b41d9",
        "commit": "https://github.com/apache/cloudstack/commit/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/schema/src/com/cloud/storage/dao/VolumeDao.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/storage/dao/VolumeDao.java?ref=d6b41d9ac21a9740494bfcfd58ea51d712e52f4e",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/storage/dao/VolumeDao.java",
                "patch": "@@ -80,7 +80,7 @@\n \n     List<VolumeVO> listVolumesToBeDestroyed();\n \n-    List<VolumeVO> listVolumesToBeDestroyed(Date date);\n+    List<VolumeVO> listNonRootVolumesToBeDestroyed(Date date);\n \n     ImageFormat getImageFormat(Long volumeId);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/schema/src/com/cloud/storage/dao/VolumeDao.java",
                "sha": "f2d5fc735207a0c267a05d3e5e2d147c6f06cc1f",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java?ref=d6b41d9ac21a9740494bfcfd58ea51d712e52f4e",
                "deletions": 1,
                "filename": "engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java",
                "patch": "@@ -325,6 +325,7 @@ public VolumeDaoImpl() {\n         AllFieldsSearch.and(\"deviceId\", AllFieldsSearch.entity().getDeviceId(), Op.EQ);\n         AllFieldsSearch.and(\"poolId\", AllFieldsSearch.entity().getPoolId(), Op.EQ);\n         AllFieldsSearch.and(\"vType\", AllFieldsSearch.entity().getVolumeType(), Op.EQ);\n+        AllFieldsSearch.and(\"notVolumeType\", AllFieldsSearch.entity().getVolumeType(), Op.NEQ);\n         AllFieldsSearch.and(\"id\", AllFieldsSearch.entity().getId(), Op.EQ);\n         AllFieldsSearch.and(\"destroyed\", AllFieldsSearch.entity().getState(), Op.EQ);\n         AllFieldsSearch.and(\"notDestroyed\", AllFieldsSearch.entity().getState(), Op.NEQ);\n@@ -481,9 +482,10 @@ public SumCount() {\n     }\n \n     @Override\n-    public List<VolumeVO> listVolumesToBeDestroyed(Date date) {\n+    public List<VolumeVO> listNonRootVolumesToBeDestroyed(Date date) {\n         SearchCriteria<VolumeVO> sc = AllFieldsSearch.create();\n         sc.setParameters(\"state\", Volume.State.Destroy);\n+        sc.setParameters(\"notVolumeType\", Volume.Type.ROOT.toString());\n         sc.setParameters(\"updateTime\", date);\n \n         return listBy(sc);",
                "raw_url": "https://github.com/apache/cloudstack/raw/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/schema/src/com/cloud/storage/dao/VolumeDaoImpl.java",
                "sha": "4f5b613ddd156049079df8f22fd1d62e6d5ce35d",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java?ref=d6b41d9ac21a9740494bfcfd58ea51d712e52f4e",
                "deletions": 3,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "patch": "@@ -174,11 +174,11 @@ public long getVolumeId() {\n     }\n \n     @Override\n-    public boolean  stateTransit(Volume.Event event) {\n+    public boolean stateTransit(Volume.Event event) {\n         boolean result = false;\n         try {\n             volumeVO = volumeDao.findById(volumeVO.getId());\n-            if(volumeVO != null) {\n+            if (volumeVO != null) {\n                 result = _volStateMachine.transitTo(volumeVO, event, null, volumeDao);\n                 volumeVO = volumeDao.findById(volumeVO.getId());\n             }\n@@ -332,8 +332,9 @@ public void processEvent(ObjectInDataStoreStateMachine.Event event) {\n             throw new CloudRuntimeException(\"Failed to update state:\" + e.toString());\n         } finally {\n             // in case of OperationFailed, expunge the entry\n+            // state transit call reloads the volume from DB and so check for null as well\n             if (event == ObjectInDataStoreStateMachine.Event.OperationFailed &&\n-                (volumeVO.getState() != Volume.State.Copying && volumeVO.getState() != Volume.State.Uploaded && volumeVO.getState() != Volume.State.UploadError)) {\n+                (volumeVO != null && volumeVO.getState() != Volume.State.Copying && volumeVO.getState() != Volume.State.Uploaded && volumeVO.getState() != Volume.State.UploadError)) {\n                 objectInStoreMgr.deleteIfNotReady(this);\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeObject.java",
                "sha": "b7f459227aaa6843124912d204385957bbe77cff",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java?ref=d6b41d9ac21a9740494bfcfd58ea51d712e52f4e",
                "deletions": 0,
                "filename": "engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "patch": "@@ -316,6 +316,11 @@ private boolean canVolumeBeRemoved(long volumeId) {\n         }\n \n         VolumeVO vol = volDao.findById(volume.getId());\n+        if (vol == null) {\n+            s_logger.debug(\"Volume \" + volume.getId() + \" is not found\");\n+            future.complete(result);\n+            return future;\n+        }\n \n         String volumePath = vol.getPath();\n         Long poolId = vol.getPoolId();",
                "raw_url": "https://github.com/apache/cloudstack/raw/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/engine/storage/volume/src/org/apache/cloudstack/storage/volume/VolumeServiceImpl.java",
                "sha": "0b58bf2fecb323c27425dd1dac28b8bd94b517ab",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=d6b41d9ac21a9740494bfcfd58ea51d712e52f4e",
                "deletions": 3,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1113,8 +1113,8 @@ public void cleanupStorage(boolean recurring) {\n \n                     cleanupSecondaryStorage(recurring);\n \n-                    List<VolumeVO> vols = _volsDao.listVolumesToBeDestroyed(new Date(System.currentTimeMillis() - ((long) StorageCleanupDelay.value() << 10)));\n-\n+                    // ROOT volumes will be destroyed as part of VM cleanup\n+                    List<VolumeVO> vols = _volsDao.listNonRootVolumesToBeDestroyed(new Date(System.currentTimeMillis() - ((long) StorageCleanupDelay.value() << 10)));\n                     for (VolumeVO vol : vols) {\n                         try {\n                             // If this fails, just log a warning. It's ideal if we clean up the host-side clustered file\n@@ -1125,7 +1125,12 @@ public void cleanupStorage(boolean recurring) {\n                         }\n \n                         try {\n-                            volService.expungeVolumeAsync(volFactory.getVolume(vol.getId()));\n+                            VolumeInfo volumeInfo = volFactory.getVolume(vol.getId());\n+                            if (volumeInfo != null) {\n+                                volService.expungeVolumeAsync(volumeInfo);\n+                            } else {\n+                                s_logger.debug(\"Volume \" + vol.getUuid() + \" is already destroyed\");\n+                            }\n                         } catch (Exception e) {\n                             s_logger.warn(\"Unable to destroy volume \" + vol.getUuid(), e);\n                         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/d6b41d9ac21a9740494bfcfd58ea51d712e52f4e/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "3dc62b648267ca5f62d5213a7d812911a44e3311",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9660: NPE while destroying volumes during 1000 VMs deploy and destroy tests\nNPE is seen as VM destroy and storage cleanup threads try to remove the same root volume. Fix is to handle\nonly non-root volumes in storage cleanup thread, root volumes will be handled as part of VM destroy.",
        "parent": "https://github.com/apache/cloudstack/commit/f2798403b58c26ef26227a26485e9266e7ef84c5",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeObjectTest.java",
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_d7d9a25": {
        "bug_id": "cloudstack_d7d9a25",
        "commit": "https://github.com/apache/cloudstack/commit/d7d9a251be46020597cffc7878a06c1dfacaf951",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/d7d9a251be46020597cffc7878a06c1dfacaf951/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=d7d9a251be46020597cffc7878a06c1dfacaf951",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -2623,14 +2623,14 @@ public void prepare(VirtualMachineProfile<? extends VirtualMachine> vm, DeployDe\n             }\n             Pair<VolumeTO, StoragePool> created = createVolume(newVol, _diskOfferingDao.findById(newVol.getDiskOfferingId()), vm, vols, dest);\n             if (created == null) {\n-                long poolId = newVol.getPoolId();\n+                Long poolId = newVol.getPoolId();\n                 newVol.setPoolId(null);\n                 try {\n                     _volsDao.update(newVol, Volume.Event.OperationFailed);\n                 } catch (ConcurrentOperationException e) {\n                     throw new CloudRuntimeException(\"Unable to update the failure on a volume: \" + newVol, e);\n                 }\n-                throw new StorageUnavailableException(\"Unable to create \" + newVol, poolId);\n+                throw new StorageUnavailableException(\"Unable to create \" + newVol, poolId==null?-1L:poolId);\n             }\n             created.first().setDeviceId(newVol.getDeviceId().intValue());\n             newVol.setStatus(AsyncInstanceCreateStatus.Created);",
                "raw_url": "https://github.com/apache/cloudstack/raw/d7d9a251be46020597cffc7878a06c1dfacaf951/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "4bd229a82cd750b72312a25201e1252e231bd1d2",
                "status": "modified"
            }
        ],
        "message": "bug 7993: fix npe\nstatus 7993: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/389e77fc465bac8fea4ffad7fd5e49a5e9eac7e8",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_d9ce49b": {
        "bug_id": "cloudstack_d9ce49b",
        "commit": "https://github.com/apache/cloudstack/commit/d9ce49b1f18c14a7acfb7a81316d4f6555717851",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/d9ce49b1f18c14a7acfb7a81316d4f6555717851/engine/storage/src/org/apache/cloudstack/storage/allocator/AbstractStoragePoolAllocator.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/src/org/apache/cloudstack/storage/allocator/AbstractStoragePoolAllocator.java?ref=d9ce49b1f18c14a7acfb7a81316d4f6555717851",
                "deletions": 0,
                "filename": "engine/storage/src/org/apache/cloudstack/storage/allocator/AbstractStoragePoolAllocator.java",
                "patch": "@@ -145,6 +145,9 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n \n     protected List<StoragePool> reOrder(List<StoragePool> pools,\n             VirtualMachineProfile<? extends VirtualMachine> vmProfile, DeploymentPlan plan) {\n+        if (pools == null) {\n+            return null;\n+        }\n         Account account = null;\n         if (vmProfile.getVirtualMachine() != null) {\n             account = vmProfile.getOwner();",
                "raw_url": "https://github.com/apache/cloudstack/raw/d9ce49b1f18c14a7acfb7a81316d4f6555717851/engine/storage/src/org/apache/cloudstack/storage/allocator/AbstractStoragePoolAllocator.java",
                "sha": "89e09748ea3029dd525f4a1e6339b60fd8ebbf69",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/d9ce49b1f18c14a7acfb7a81316d4f6555717851/engine/storage/src/org/apache/cloudstack/storage/allocator/ClusterScopeStoragePoolAllocator.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/src/org/apache/cloudstack/storage/allocator/ClusterScopeStoragePoolAllocator.java?ref=d9ce49b1f18c14a7acfb7a81316d4f6555717851",
                "deletions": 0,
                "filename": "engine/storage/src/org/apache/cloudstack/storage/allocator/ClusterScopeStoragePoolAllocator.java",
                "patch": "@@ -59,6 +59,9 @@\n         Long podId = plan.getPodId();\n         Long clusterId = plan.getClusterId();\n \n+\t\tif (clusterId == null) {\n+\t\t\treturn null;\n+\t\t}\n         if (dskCh.getTags() != null && dskCh.getTags().length != 0) {\n             s_logger.debug(\"Looking for pools in dc: \" + dcId + \"  pod:\" + podId + \"  cluster:\" + clusterId\n                     + \" having tags:\" + Arrays.toString(dskCh.getTags()));",
                "raw_url": "https://github.com/apache/cloudstack/raw/d9ce49b1f18c14a7acfb7a81316d4f6555717851/engine/storage/src/org/apache/cloudstack/storage/allocator/ClusterScopeStoragePoolAllocator.java",
                "sha": "41afa837b52cdb2cebeb5919227fc3e99e9ba6cb",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/d9ce49b1f18c14a7acfb7a81316d4f6555717851/engine/storage/src/org/apache/cloudstack/storage/allocator/LocalStoragePoolAllocator.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/storage/src/org/apache/cloudstack/storage/allocator/LocalStoragePoolAllocator.java?ref=d9ce49b1f18c14a7acfb7a81316d4f6555717851",
                "deletions": 0,
                "filename": "engine/storage/src/org/apache/cloudstack/storage/allocator/LocalStoragePoolAllocator.java",
                "patch": "@@ -96,6 +96,9 @@\n                 }\n             }\n         } else {\n+            if (plan.getClusterId() == null) {\n+                return null;\n+            }\n             List<StoragePoolVO> availablePools = _storagePoolDao.findLocalStoragePoolsByTags(plan.getDataCenterId(),\n                     plan.getPodId(), plan.getClusterId(), dskCh.getTags());\n             for (StoragePoolVO pool : availablePools) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/d9ce49b1f18c14a7acfb7a81316d4f6555717851/engine/storage/src/org/apache/cloudstack/storage/allocator/LocalStoragePoolAllocator.java",
                "sha": "4056fe756a1a0fa100bd3e3419dc5d7c30865003",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/d9ce49b1f18c14a7acfb7a81316d4f6555717851/plugins/storage-allocators/random/src/org/apache/cloudstack/storage/allocator/RandomStoragePoolAllocator.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/storage-allocators/random/src/org/apache/cloudstack/storage/allocator/RandomStoragePoolAllocator.java?ref=d9ce49b1f18c14a7acfb7a81316d4f6555717851",
                "deletions": 0,
                "filename": "plugins/storage-allocators/random/src/org/apache/cloudstack/storage/allocator/RandomStoragePoolAllocator.java",
                "patch": "@@ -46,6 +46,11 @@\n         long dcId = plan.getDataCenterId();\n         Long podId = plan.getPodId();\n         Long clusterId = plan.getClusterId();\n+\n+\t\tif (clusterId == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n         s_logger.debug(\"Looking for pools in dc: \" + dcId + \"  pod:\" + podId + \"  cluster:\" + clusterId);\n         List<StoragePoolVO> pools = _storagePoolDao.listBy(dcId, podId, clusterId, ScopeType.CLUSTER);\n         if (pools.size() == 0) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/d9ce49b1f18c14a7acfb7a81316d4f6555717851/plugins/storage-allocators/random/src/org/apache/cloudstack/storage/allocator/RandomStoragePoolAllocator.java",
                "sha": "fda787f479d8ca571761b60df03fd925818b2bd2",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/d9ce49b1f18c14a7acfb7a81316d4f6555717851/server/src/com/cloud/server/ManagementServerImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/ManagementServerImpl.java?ref=d9ce49b1f18c14a7acfb7a81316d4f6555717851",
                "deletions": 2,
                "filename": "server/src/com/cloud/server/ManagementServerImpl.java",
                "patch": "@@ -1258,8 +1258,14 @@ private Date massageDate(Date date, int hourOfDay, int minute, int second) {\n \n             // Get all the pools available. Only shared pools are considered because only a volume on a shared pools\n             // can be live migrated while the virtual machine stays on the same host.\n-            List<StoragePoolVO> storagePools = _poolDao.findPoolsByTags(volume.getDataCenterId(),\n-                    volume.getPodId(), srcVolumePool.getClusterId(), null);\n+            List<StoragePoolVO> storagePools = null;\n+\n+            if (srcVolumePool.getClusterId() == null) {\n+                storagePools = _poolDao.findZoneWideStoragePoolsByTags(volume.getDataCenterId(), null);\n+            } else {\n+                storagePools = _poolDao.findPoolsByTags(volume.getDataCenterId(), volume.getPodId(), srcVolumePool.getClusterId(), null);\n+            }\n+\n             storagePools.remove(srcVolumePool);\n             for (StoragePoolVO pool : storagePools) {\n                 if (pool.isShared()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/d9ce49b1f18c14a7acfb7a81316d4f6555717851/server/src/com/cloud/server/ManagementServerImpl.java",
                "sha": "58e4b44ac8bd8a01c2dbe1935a2681c2125871e4",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3264: [ZWPS]NPE while finding storage pools for migration\n\nDescription:\n\n    Filter primary storage pools based on zonewide/clusterwide configuration\n    when considering pools to list for storage migration of volumes.",
        "parent": "https://github.com/apache/cloudstack/commit/505ab2eebe7292cd275be17401dde51b1e43ced8",
        "repo": "cloudstack",
        "unit_tests": [
            "ManagementServerImplTest.java"
        ]
    },
    "cloudstack_db5afa4": {
        "bug_id": "cloudstack_db5afa4",
        "commit": "https://github.com/apache/cloudstack/commit/db5afa4994cbe4795238d40df075977bd7ad6f4f",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/db5afa4994cbe4795238d40df075977bd7ad6f4f/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java?ref=db5afa4994cbe4795238d40df075977bd7ad6f4f",
                "deletions": 3,
                "filename": "server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -261,9 +261,11 @@ protected void wakeupWorkers() {\n \n     @Override\n     public boolean scheduleMigration(final VMInstanceVO vm) {\n-        final HaWorkVO work = new HaWorkVO(vm.getId(), vm.getType(), WorkType.Migration, Step.Scheduled, vm.getHostId(), vm.getState(), 0, vm.getUpdated());\n-        _haDao.persist(work);\n-        wakeupWorkers();\n+        if (vm.getHostId() != null) {\n+            final HaWorkVO work = new HaWorkVO(vm.getId(), vm.getType(), WorkType.Migration, Step.Scheduled, vm.getHostId(), vm.getState(), 0, vm.getUpdated());\n+            _haDao.persist(work);\n+            wakeupWorkers();\n+        }\n         return true;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/db5afa4994cbe4795238d40df075977bd7ad6f4f/server/src/com/cloud/ha/HighAvailabilityManagerImpl.java",
                "sha": "cf0bd0bcba5cb8ef0add75faf229851927e07638",
                "status": "modified"
            }
        ],
        "message": "fix migration npe when recovering",
        "parent": "https://github.com/apache/cloudstack/commit/e8f317243f3b1d51a71c73119935400539e11e30",
        "repo": "cloudstack",
        "unit_tests": [
            "HighAvailabilityManagerImplTest.java"
        ]
    },
    "cloudstack_db6aa76": {
        "bug_id": "cloudstack_db6aa76",
        "commit": "https://github.com/apache/cloudstack/commit/db6aa765a39341ca2d5be7d8e555dfd7ec2af7e1",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/db6aa765a39341ca2d5be7d8e555dfd7ec2af7e1/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=db6aa765a39341ca2d5be7d8e555dfd7ec2af7e1",
                "deletions": 5,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -298,7 +298,7 @@\n     protected int _pingInterval = 60; // seconds\n     protected int _hostRetry;\n     protected float _overProvisioningFactor = 1;\n-    private int _maxVolumeSizeInGb;\n+    private long _maxVolumeSizeInGb;\n     private long _serverId;\n \n     private int _snapshotTimeout;\n@@ -851,7 +851,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         }\n \n         String maxVolumeSizeInGbString = configDao.getValue(\"storage.max.volume.size\");\n-        _maxVolumeSizeInGb = NumbersUtil.parseInt(maxVolumeSizeInGbString, 2000);\n+        _maxVolumeSizeInGb = NumbersUtil.parseLong(maxVolumeSizeInGbString, 2000);\n \n         HostTemplateStatesSearch = _vmTemplateHostDao.createSearchBuilder();\n         HostTemplateStatesSearch.and(\"id\", HostTemplateStatesSearch.entity().getTemplateId(), SearchCriteria.Op.EQ);\n@@ -1611,7 +1611,14 @@ public VolumeVO allocVolume(CreateVolumeCmd cmd) throws ResourceAllocationExcept\n             }\n \n             diskOfferingId = cmd.getDiskOfferingId();\n-            size = cmd.getSize() * 1024 * 1024 * 1024; // user specify size in GB\n+            size = cmd.getSize();\n+            if ( size != null ) {\n+                if ( size > 0 ) {\n+                    size = size * 1024 * 1024 * 1024; // user specify size in GB\n+                } else {\n+                    throw new InvalidParameterValueException(\"Disk size must be larger than 0\");\n+                }\n+            }\n             if (diskOfferingId == null) {\n                 throw new InvalidParameterValueException(\"Missing parameter(s),either a positive volume size or a valid disk offering id must be specified.\");\n             }\n@@ -2439,8 +2446,8 @@ public boolean deleteVolume(DeleteVolumeCmd cmd) throws ConcurrentOperationExcep\n     private boolean validateVolumeSizeRange(long size) {\n         if (size < 0 || (size > 0 && size < (1024 * 1024 * 1024))) {\n             throw new InvalidParameterValueException(\"Please specify a size of at least 1 Gb.\");\n-        } else if (size > _maxVolumeSizeInGb) {\n-            throw new InvalidParameterValueException(\"The maximum size allowed is \" + _maxVolumeSizeInGb + \" Gb.\");\n+        } else if (size > (_maxVolumeSizeInGb * 1024 * 1024 * 1024) ) {\n+            throw new InvalidParameterValueException(\"volume size \" + size + \", but the maximum size allowed is \" + _maxVolumeSizeInGb + \" Gb.\");\n         }\n \n         return true;",
                "raw_url": "https://github.com/apache/cloudstack/raw/db6aa765a39341ca2d5be7d8e555dfd7ec2af7e1/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "a336db369f4a23e853b2b5bf0888bbe70b33c1da",
                "status": "modified"
            }
        ],
        "message": "bug 10146 : fixed NPE\n\nstatus 10146 : resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/94b389054278e64ef05808eb1799cdd4a47e6372",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_db97bb8": {
        "bug_id": "cloudstack_db97bb8",
        "commit": "https://github.com/apache/cloudstack/commit/db97bb8e8905feb8e1444fb5136ba893e304670c",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/db97bb8e8905feb8e1444fb5136ba893e304670c/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=db97bb8e8905feb8e1444fb5136ba893e304670c",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -2450,7 +2450,12 @@ protected UserVm createVirtualMachine(DataCenter zone, ServiceOffering serviceOf\n \n         // check if account/domain is with in resource limits to create a new vm\n         boolean isIso = Storage.ImageFormat.ISO == template.getFormat();\n-        long size = _templateDao.findById(template.getId()).getSize();\n+        // For baremetal, size can be null\n+        Long tmp = _templateDao.findById(template.getId()).getSize();\n+        long size = 0;\n+        if (tmp != null) {\n+        \tsize = tmp;\n+        }\n         if (diskOfferingId != null) {\n             size += _diskOfferingDao.findById(diskOfferingId).getDiskSize();\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/db97bb8e8905feb8e1444fb5136ba893e304670c/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "7b3b1bc975820101812189d369fa3f2b04973261",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when using baremetal template\n\nTemplate size is NULL for baremetal, which caused NPE when unboxing",
        "parent": "https://github.com/apache/cloudstack/commit/64c5266ec5ab197ffa81de4476d47ce508cde63d",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_dd6972e": {
        "bug_id": "cloudstack_dd6972e",
        "commit": "https://github.com/apache/cloudstack/commit/dd6972ee07763b4d16b572a025027c13545742ee",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/dd6972ee07763b4d16b572a025027c13545742ee/server/src/com/cloud/server/StatsCollector.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=dd6972ee07763b4d16b572a025027c13545742ee",
                "deletions": 9,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -264,16 +264,17 @@ public void run() {\n \t            }\n \t\t\t\t\r\n                 List<HostVO> hosts = _hostDao.listSecondaryStorageHosts();\n-                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\n-                \r\n-                for (HostVO host : hosts) {\r\n+                ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\r\n+                for (HostVO host : hosts) {\n+                    if ( host.getStorageUrl() == null ) {\n+                        continue;\n+                    }\r\n                     GetStorageStatsCommand command = new GetStorageStatsCommand(host.getStorageUrl());\n-        \t\t\tHostVO ssAhost = _agentMgr.getSSAgent(host);\n-        \t\t\tif( ssAhost == null ) {\n-        \t\t\t\ts_logger.warn(\"There is no secondary storage VM for secondary storage host \" + host.getName());\n-        \t\t\t\tcontinue;\n-        \t\t\t}\n-        \t\t\t\n+                    HostVO ssAhost = _agentMgr.getSSAgent(host);\n+                    if (ssAhost == null) {\n+                        s_logger.warn(\"There is no secondary storage VM for secondary storage host \" + host.getName());\n+                        continue;\n+                    }\n                     long hostId = host.getId();\r\n                     Answer answer = _agentMgr.easySend(ssAhost.getId(), command);\r\n                     if (answer != null && answer.getResult()) {\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/dd6972ee07763b4d16b572a025027c13545742ee/server/src/com/cloud/server/StatsCollector.java",
                "sha": "59091bf9c80995a0f00e6b093483a53749f9ea47",
                "status": "modified"
            }
        ],
        "message": "bug 10618: fixed NPE\n\nstatus 10618: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/17e4e7014fed8bd010c7858e5bd086c4f479ba1f",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_dd7ff1d": {
        "bug_id": "cloudstack_dd7ff1d",
        "commit": "https://github.com/apache/cloudstack/commit/dd7ff1d8db3a374b1a1569bd2e8ba0338ae7505e",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/dd7ff1d8db3a374b1a1569bd2e8ba0338ae7505e/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=dd7ff1d8db3a374b1a1569bd2e8ba0338ae7505e",
                "deletions": 0,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -706,6 +706,12 @@ private boolean doDeleteHost(long hostId, boolean isForced, boolean isForceDelet\n         List<StoragePoolHostVO> pools = _storagePoolHostDao.listByHostIdIncludingRemoved(hostId);\n         \n         ResourceStateAdapter.DeleteHostAnswer answer = (ResourceStateAdapter.DeleteHostAnswer) dispatchToStateAdapters(ResourceStateAdapter.Event.DELETE_HOST, false, host, new Boolean(isForced), new Boolean(isForceDeleteStorage));\n+        \n+        if (answer == null) {\n+            s_logger.warn(\"Unable to delete host: \" + hostId);\n+            return false;\n+        }\n+        \n         if (answer.getIsException()) {\n             return false;\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/dd7ff1d8db3a374b1a1569bd2e8ba0338ae7505e/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "31b689768932d17828d9ad98e3c53b932e5445d3",
                "status": "modified"
            }
        ],
        "message": "bug 12404: Fix NPE when delete host\n\nBut it's not enough. This happened because delete host logic is missing for Xen. Frank would add it.",
        "parent": "https://github.com/apache/cloudstack/commit/b3f861bf8f8cc068a2126e7b9ccf510d2e156e4d",
        "repo": "cloudstack",
        "unit_tests": [
            "ResourceManagerImplTest.java"
        ]
    },
    "cloudstack_df934c9": {
        "bug_id": "cloudstack_df934c9",
        "commit": "https://github.com/apache/cloudstack/commit/df934c954106a618f8b0aca7e7dfbac890d78244",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/df934c954106a618f8b0aca7e7dfbac890d78244/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=df934c954106a618f8b0aca7e7dfbac890d78244",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -1636,12 +1636,12 @@ private Volume orchestrateDetachVolumeFromVM(long vmId, long volumeId) {\n         }\n \n         HostVO host = null;\n-        StoragePoolVO volumePool = _storagePoolDao.findById(volume.getPoolId());\n+        StoragePoolVO volumePool = _storagePoolDao.findByIdIncludingRemoved(volume.getPoolId());\n \n         if (hostId != null) {\n             host = _hostDao.findById(hostId);\n \n-            if (host != null && host.getHypervisorType() == HypervisorType.XenServer && volumePool.isManaged()) {\n+            if (host != null && host.getHypervisorType() == HypervisorType.XenServer && volumePool != null && volumePool.isManaged()) {\n                 sendCommand = true;\n             }\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/df934c954106a618f8b0aca7e7dfbac890d78244/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "0f17a57ad4b27bbb0712c8565ca5ab7f55697636",
                "status": "modified"
            }
        ],
        "message": "server: fix NPE case in VolumeApiServiceImpl\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/d2471df0be35c9af928c682c961ac0544b347159",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_dfbe113": {
        "bug_id": "cloudstack_dfbe113",
        "commit": "https://github.com/apache/cloudstack/commit/dfbe11355c40a5dbe022f022426c100c53428901",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/dfbe11355c40a5dbe022f022426c100c53428901/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/element/VirtualRouterElement.java?ref=dfbe11355c40a5dbe022f022426c100c53428901",
                "deletions": 1,
                "filename": "server/src/com/cloud/network/element/VirtualRouterElement.java",
                "patch": "@@ -876,8 +876,8 @@ public boolean addPasswordAndUserdata(Network network, NicProfile nic, VirtualMa\n         if (publicNetwork) {\n             routers = _routerDao.listByNetworkAndRole(network.getId(), Role.VIRTUAL_ROUTER);\n         } else {\n-            Long podId = dest.getPod().getId();\n             if (isPodBased) {\n+                Long podId = dest.getPod().getId();\n                 routers = _routerDao.listByNetworkAndPodAndRole(network.getId(), podId, Role.VIRTUAL_ROUTER);\n             } else {\n                 routers = _routerDao.listByNetworkAndRole(network.getId(), Role.VIRTUAL_ROUTER);",
                "raw_url": "https://github.com/apache/cloudstack/raw/dfbe11355c40a5dbe022f022426c100c53428901/server/src/com/cloud/network/element/VirtualRouterElement.java",
                "sha": "f601f4fa2e494d20a90e1ea7628fea2fae777771",
                "status": "modified"
            }
        ],
        "message": "fix CLOUDSTACK-2061 Hitting java NPE in addNicToVirtualMachine api when trying to add a shared network to a VM",
        "parent": "https://github.com/apache/cloudstack/commit/985b2aa88d4d02db98a2e9be7ac081e4efbff879",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualRouterElementTest.java"
        ]
    },
    "cloudstack_e0aef28": {
        "bug_id": "cloudstack_e0aef28",
        "commit": "https://github.com/apache/cloudstack/commit/e0aef28910eb9d8a8ba4e21f30138b241ca00349",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/e0aef28910eb9d8a8ba4e21f30138b241ca00349/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=e0aef28910eb9d8a8ba4e21f30138b241ca00349",
                "deletions": 0,
                "filename": "server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -594,6 +594,7 @@ protected boolean checkWorkItems(VMInstanceVO vm, State state) throws Concurrent\n                 cmds.addCommand(new StartCommand(vmTO));\n                 \n                 vmGuru.finalizeDeployment(cmds, vmProfile, dest, ctx);\n+                vm.setPodId(dest.getPod().getId());\n                 try {\n                     Answer[] answers = _agentMgr.send(dest.getHost().getId(), cmds);\n                     if (getStartAnswer(answers).getResult() && vmGuru.finalizeStart(cmds, vmProfile, dest, ctx)) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/e0aef28910eb9d8a8ba4e21f30138b241ca00349/server/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "aed78db60469b4ddaf8181306860c42d79b7c472",
                "status": "modified"
            }
        ],
        "message": "bug 7975: we were missing the podid for a user vm, and this is used during vol attach. Adding the same, this fixes the NPE\nstatus 7975: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/55f28c3a2b42f7c99aefec03bcfce1a479baddaf",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_e168760": {
        "bug_id": "cloudstack_e168760",
        "commit": "https://github.com/apache/cloudstack/commit/e168760295c1488befbaf254897a4c3671e8d32f",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/e168760295c1488befbaf254897a4c3671e8d32f/server/src/com/cloud/agent/manager/DirectAgentAttache.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/agent/manager/DirectAgentAttache.java?ref=e168760295c1488befbaf254897a4c3671e8d32f",
                "deletions": 5,
                "filename": "server/src/com/cloud/agent/manager/DirectAgentAttache.java",
                "patch": "@@ -125,11 +125,11 @@ public synchronized void run() {\n \t        try {\n \t            ServerResource resource = _resource;\n \t            \n-\t            if (resource.IsRemoteAgent()) {\n-\t            \treturn;\n-\t            }\n-\t            \n-\t            if (resource != null) {\n+                if (resource != null) {\n+                    if (resource.IsRemoteAgent()) {\n+                        return;\n+                    }\n+\n         \t        PingCommand cmd = resource.getCurrentStatus(_id);\n         \t        if (cmd == null) {\n         \t            s_logger.warn(\"Unable to get current status on \" + _id);",
                "raw_url": "https://github.com/apache/cloudstack/raw/e168760295c1488befbaf254897a4c3671e8d32f/server/src/com/cloud/agent/manager/DirectAgentAttache.java",
                "sha": "cb7fcfbc1477f9b4d9acbb46296134e3e06ac8eb",
                "status": "modified"
            }
        ],
        "message": "The code implies resource could be null, and yet de-references resource before the null check.  As I was experiencing a NPE because if this exact scenario, put the remote agent check inside the check for null to avoid problems.  If resource is null we log that we were unable to send ping due to agent disconnected...",
        "parent": "https://github.com/apache/cloudstack/commit/2185adc08694485df901909d5491c2b32bca075f",
        "repo": "cloudstack",
        "unit_tests": [
            "DirectAgentAttacheTest.java"
        ]
    },
    "cloudstack_e1c5d4e": {
        "bug_id": "cloudstack_e1c5d4e",
        "commit": "https://github.com/apache/cloudstack/commit/e1c5d4ef55f3b55c7b9c1baf34823c7943b1ee88",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/e1c5d4ef55f3b55c7b9c1baf34823c7943b1ee88/server/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java?ref=e1c5d4ef55f3b55c7b9c1baf34823c7943b1ee88",
                "deletions": 2,
                "filename": "server/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java",
                "patch": "@@ -163,8 +163,7 @@ public long deployLoadBalancerVM(Long networkId, Long accountId) {  /* ELB_TODO\n \n             s_logger.debug(\"ELB  vm = \" + elbVm);\n             if (elbVm == null) {\n-                throw new InvalidParameterValueException(\"No VM with id '\"\n-                        + elbVm + \"' found.\");\n+                throw new InvalidParameterValueException(\"Could not deploy or find existing ELB VM\");\n             }\n             DomainRouterVO elbRouterVm = _routerDao.findById(elbVm.getId());\n             String publicIp = elbRouterVm.getGuestIpAddress();",
                "raw_url": "https://github.com/apache/cloudstack/raw/e1c5d4ef55f3b55c7b9c1baf34823c7943b1ee88/server/src/com/cloud/network/lb/ElasticLoadBalancerManagerImpl.java",
                "sha": "33047ad3219c1e95e09a6cef075197d02e79047b",
                "status": "modified"
            }
        ],
        "message": "fix npe",
        "parent": "https://github.com/apache/cloudstack/commit/2447830c554a59a3c4265091585950c4f60314be",
        "repo": "cloudstack",
        "unit_tests": [
            "ElasticLoadBalancerManagerImplTest.java"
        ]
    },
    "cloudstack_e4a1d49": {
        "bug_id": "cloudstack_e4a1d49",
        "commit": "https://github.com/apache/cloudstack/commit/e4a1d491c1982f966c2bfc64edcf0ea692e6521f",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/e4a1d491c1982f966c2bfc64edcf0ea692e6521f/utils/src/com/cloud/utils/db/GlobalLock.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/utils/src/com/cloud/utils/db/GlobalLock.java?ref=e4a1d491c1982f966c2bfc64edcf0ea692e6521f",
                "deletions": 4,
                "filename": "utils/src/com/cloud/utils/db/GlobalLock.java",
                "patch": "@@ -103,10 +103,12 @@ public static GlobalLock getInternLock(String name) {\n \tprivate static void releaseInternLock(String name) {\r\n \t\tsynchronized(s_lockMap) {\n \t\t\tGlobalLock lock = s_lockMap.get(name);\n-\t\t\tassert(lock != null);\n-\t\t\t\n-\t\t\tif(lock.referenceCount == 0)\n-\t\t\t\ts_lockMap.remove(name);\n+\t\t\tif(lock != null) {\n+\t\t\t\tif(lock.referenceCount == 0)\n+\t\t\t\t\ts_lockMap.remove(name);\n+\t\t\t} else {\n+\t\t\t\ts_logger.warn(\"Releasing \" + name + \", but it is already released.\");\n+\t\t\t}\n \t\t}\r\n \t}\r\n \t\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/e4a1d491c1982f966c2bfc64edcf0ea692e6521f/utils/src/com/cloud/utils/db/GlobalLock.java",
                "sha": "067ad57de3067b298706c05c2299877985ce02fb",
                "status": "modified"
            }
        ],
        "message": "bug 10976: NPE fix to avoid blocking shutdown process",
        "parent": "https://github.com/apache/cloudstack/commit/6eacc112221265bdbc5acbbd092f9be2ee872daf",
        "repo": "cloudstack",
        "unit_tests": [
            "GlobalLockTest.java"
        ]
    },
    "cloudstack_e59dac2": {
        "bug_id": "cloudstack_e59dac2",
        "commit": "https://github.com/apache/cloudstack/commit/e59dac201dc66ac80728632d7218b9a787142243",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/e59dac201dc66ac80728632d7218b9a787142243/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=e59dac201dc66ac80728632d7218b9a787142243",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1576,8 +1576,8 @@ public boolean storagePoolHasEnoughSpace(List<Volume> volumes, StoragePool pool)\n         long totalAskingSize = 0;\n         for (Volume volume : volumes) {\n             if (volume.getTemplateId() != null) {\n-                VMTemplateVO tmpl = _templateDao.findById(volume.getTemplateId());\n-                if (tmpl.getFormat() != ImageFormat.ISO) {\n+                VMTemplateVO tmpl = _templateDao.findByIdIncludingRemoved(volume.getTemplateId());\n+                if (tmpl != null && tmpl.getFormat() != ImageFormat.ISO) {\n                     allocatedSizeWithtemplate = _capacityMgr.getAllocatedPoolCapacity(poolVO, tmpl);\n                 }\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/e59dac201dc66ac80728632d7218b9a787142243/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "1feea016202999f706ff345319f28acaf4077e53",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8014: Fix NPE searching including removed templates\n\nSteps to reproduce if you have this issue:\n- Create a VM's volume snapshot\n- Remove VM's template and mark the template as removed with timestamp in DB\n- Restart mgmt server and create a volume out of snapshot you should get NPE\n\nFix: In `storagePoolHasEnoughSpace`, we're only searching for a VM's volume's\nsnapshot's template by Id and not including removed templates. This is a corner\ncase and NPE hits when template has been marked removed for a VM's volume's\ntemplate so we should search including removed templates.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit f189c105d8dde5491697b171b969e757f8f15858)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/40f26142b38bda5b10b01b2a2aad77d1b0b5f36e",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_e72a69a": {
        "bug_id": "cloudstack_e72a69a",
        "commit": "https://github.com/apache/cloudstack/commit/e72a69a8a2f0514ece93fc9b05698aa08afa5539",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/e72a69a8a2f0514ece93fc9b05698aa08afa5539/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java?ref=e72a69a8a2f0514ece93fc9b05698aa08afa5539",
                "deletions": 0,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "patch": "@@ -153,6 +153,7 @@ public void checkAndSendQuotaAlertEmails() {\n             BigDecimal thresholdBalance = quotaAccount.getQuotaMinBalance();\n             if (accountBalance != null) {\n                 AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                if (account == null) continue; // the account is removed\n                 if (s_logger.isDebugEnabled()) {\n                     s_logger.debug(\"checkAndSendQuotaAlertEmails: Check id=\" + account.getId() + \" bal=\" + accountBalance + \", alertDate=\" + alertDate + \", lockable=\" + lockable);\n                 }",
                "raw_url": "https://github.com/apache/cloudstack/raw/e72a69a8a2f0514ece93fc9b05698aa08afa5539/framework/quota/src/org/apache/cloudstack/quota/QuotaAlertManagerImpl.java",
                "sha": "a25ed04282507ba78c43df9dbf2f6075ae7a22d8",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/e72a69a8a2f0514ece93fc9b05698aa08afa5539/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java?ref=e72a69a8a2f0514ece93fc9b05698aa08afa5539",
                "deletions": 3,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "patch": "@@ -360,10 +360,11 @@ public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal a\n         BigDecimal rawusage;\n         // get service offering details\n         ServiceOfferingVO serviceoffering = _serviceOfferingDao.findServiceOffering(usageRecord.getVmInstanceId(), usageRecord.getOfferingId());\n+        if (serviceoffering == null) return quotalist;\n         rawusage = new BigDecimal(usageRecord.getRawUsage());\n \n         QuotaTariffVO tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.CPU_NUMBER, usageRecord.getEndDate());\n-        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0 && serviceoffering.getCpu() != null) {\n             BigDecimal cpu = new BigDecimal(serviceoffering.getCpu());\n             onehourcostpercpu = tariff.getCurrencyValue().multiply(aggregationRatio);\n             cpuquotausgage = rawusage.multiply(onehourcostpercpu).multiply(cpu);\n@@ -373,7 +374,7 @@ public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal a\n             quotalist.add(quota_usage);\n         }\n         tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.CPU_CLOCK_RATE, usageRecord.getEndDate());\n-        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0 && serviceoffering.getSpeed() != null) {\n             BigDecimal speed = new BigDecimal(serviceoffering.getSpeed() / 100.00);\n             onehourcostper100mhz = tariff.getCurrencyValue().multiply(aggregationRatio);\n             speedquotausage = rawusage.multiply(onehourcostper100mhz).multiply(speed);\n@@ -383,7 +384,7 @@ public QuotaUsageVO updateQuotaDiskUsage(UsageVO usageRecord, final BigDecimal a\n             quotalist.add(quota_usage);\n         }\n         tariff = _quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.MEMORY, usageRecord.getEndDate());\n-        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {\n+        if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0 && serviceoffering.getRamSize() != null) {\n             BigDecimal memory = new BigDecimal(serviceoffering.getRamSize());\n             onehourcostper1mb = tariff.getCurrencyValue().multiply(aggregationRatio);\n             memoryquotausage = rawusage.multiply(onehourcostper1mb).multiply(memory);",
                "raw_url": "https://github.com/apache/cloudstack/raw/e72a69a8a2f0514ece93fc9b05698aa08afa5539/framework/quota/src/org/apache/cloudstack/quota/QuotaManagerImpl.java",
                "sha": "0a59fa20fd3e7ab9f6e663b7e783a666072faf3b",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/e72a69a8a2f0514ece93fc9b05698aa08afa5539/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java?ref=e72a69a8a2f0514ece93fc9b05698aa08afa5539",
                "deletions": 8,
                "filename": "framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "patch": "@@ -122,15 +122,17 @@ public void sendStatement() {\n             Date lastStatementDate = quotaAccount.getLastStatementDate();\n             if (interval != null) {\n                 AccountVO account = _accountDao.findById(quotaAccount.getId());\n-                if (lastStatementDate == null || getDifferenceDays(lastStatementDate, new Date()) >= s_LAST_STATEMENT_SENT_DAYS + 1) {\n-                    BigDecimal quotaUsage = _quotaUsage.findTotalQuotaUsage(account.getAccountId(), account.getDomainId(), null, interval[0].getTime(), interval[1].getTime());\n-                    s_logger.info(\"For account=\" + quotaAccount.getId() + \", quota used = \" + quotaUsage);\n-                    // send statement\n-                    deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, quotaUsage, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_STATEMENT));\n-                } else {\n-                    if (s_logger.isDebugEnabled()) {\n-                        s_logger.debug(\"For \" + quotaAccount.getId() + \" the statement has been sent recently\");\n+                if (account != null) {\n+                    if (lastStatementDate == null || getDifferenceDays(lastStatementDate, new Date()) >= s_LAST_STATEMENT_SENT_DAYS + 1) {\n+                        BigDecimal quotaUsage = _quotaUsage.findTotalQuotaUsage(account.getAccountId(), account.getDomainId(), null, interval[0].getTime(), interval[1].getTime());\n+                        s_logger.info(\"For account=\" + quotaAccount.getId() + \", quota used = \" + quotaUsage);\n+                        // send statement\n+                        deferredQuotaEmailList.add(new DeferredQuotaEmail(account, quotaAccount, quotaUsage, QuotaConfig.QuotaEmailTemplateTypes.QUOTA_STATEMENT));\n+                    } else {\n+                        if (s_logger.isDebugEnabled()) {\n+                            s_logger.debug(\"For \" + quotaAccount.getId() + \" the statement has been sent recently\");\n \n+                        }\n                     }\n                 }\n             } else if (lastStatementDate != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/e72a69a8a2f0514ece93fc9b05698aa08afa5539/framework/quota/src/org/apache/cloudstack/quota/QuotaStatementImpl.java",
                "sha": "5c12ae6e75d7110acf6b4c43b711e4e22074ac34",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/e72a69a8a2f0514ece93fc9b05698aa08afa5539/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java?ref=e72a69a8a2f0514ece93fc9b05698aa08afa5539",
                "deletions": 1,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "patch": "@@ -59,7 +59,7 @@ public QuotaSummaryCmd() {\n     public void execute() {\n         Account caller = CallContext.current().getCallingAccount();\n         List<QuotaSummaryResponse> responses;\n-        if (caller.getAccountId() <= 2) { //non root admin or system\n+        if (caller.getType() == Account.ACCOUNT_TYPE_ADMIN) { //admin account\n             if (getAccountName() != null && getDomainId() != null)\n                 responses = _responseBuilder.createQuotaSummaryResponse(caller.getAccountName(), caller.getDomainId());\n             else",
                "raw_url": "https://github.com/apache/cloudstack/raw/e72a69a8a2f0514ece93fc9b05698aa08afa5539/plugins/database/quota/src/org/apache/cloudstack/api/command/QuotaSummaryCmd.java",
                "sha": "88466e08c6b93aa6af16e246aee51e48f47e0c83",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/e72a69a8a2f0514ece93fc9b05698aa08afa5539/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java?ref=e72a69a8a2f0514ece93fc9b05698aa08afa5539",
                "deletions": 1,
                "filename": "plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "patch": "@@ -138,6 +138,7 @@ public QuotaTariffResponse createQuotaTariffResponse(QuotaTariffVO tariff) {\n         } else {\n             for (final QuotaAccountVO quotaAccount : _quotaAccountDao.listAllQuotaAccount()) {\n                 AccountVO account = _accountDao.findById(quotaAccount.getId());\n+                if (account == null) continue;\n                 QuotaSummaryResponse qr = getQuotaSummaryResponse(account);\n                 result.add(qr);\n             }\n@@ -167,7 +168,7 @@ private QuotaSummaryResponse getQuotaSummaryResponse(final Account account) {\n             qr.setObjectName(\"summary\");\n             return qr;\n         } else {\n-            throw new InvalidParameterValueException(\"Quota summary response for an account requires a valid account.\");\n+            return new QuotaSummaryResponse();\n         }\n     }\n \n@@ -398,6 +399,9 @@ public QuotaCreditsResponse addQuotaCredits(Long accountId, Long domainId, Doubl\n         QuotaCreditsVO result = _quotaCreditsDao.saveCredits(credits);\n \n         final AccountVO account = _accountDao.findById(accountId);\n+        if (account == null) {\n+            throw new InvalidParameterValueException(\"Account does not exist with account id \" + accountId);\n+        }\n         final boolean lockAccountEnforcement = \"true\".equalsIgnoreCase(QuotaConfig.QuotaEnableEnforcement.value());\n         final BigDecimal currentAccountBalance = _quotaBalanceDao.lastQuotaBalance(accountId, domainId, startOfNextDay(new Date(despositedOn.getTime())));\n         if (s_logger.isDebugEnabled()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/e72a69a8a2f0514ece93fc9b05698aa08afa5539/plugins/database/quota/src/org/apache/cloudstack/api/response/QuotaResponseBuilderImpl.java",
                "sha": "162d2a98de46150ee6cce6e1e58d64d872ed1072",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/e72a69a8a2f0514ece93fc9b05698aa08afa5539/ui/plugins/quota/quota.js",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/plugins/quota/quota.js?ref=e72a69a8a2f0514ece93fc9b05698aa08afa5539",
                "deletions": 7,
                "filename": "ui/plugins/quota/quota.js",
                "patch": "@@ -328,13 +328,6 @@\n                           });\n                       },\n                       detailView: {\n-                          viewAll: [{\n-                              path: 'quota.quotastatement',\n-                              label: 'label.quota.statement.quota'\n-                          },{\n-                              path: 'quota.balancestatement',\n-                              label: 'label.quota.statement.balance'\n-                          }],\n                           actions: {\n                              add: {\n                                 label: 'label.quota.add.credits',",
                "raw_url": "https://github.com/apache/cloudstack/raw/e72a69a8a2f0514ece93fc9b05698aa08afa5539/ui/plugins/quota/quota.js",
                "sha": "4780d716977644345a828fad76a97425089f66f9",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1254 from shapeblue/master-9174\n\nCLOUDSTACK-9174: A deleted account results in NPEWhen an account is deleted from cloudstack for which quota is still\nbeing calculated and if the quota reaches minimum threshold then\nquota service will try to alert the user. This results in NPE and is\nfixed by excluding such accounts from alerting and other quota related\nmechanisms.\n\n* pr/1254:\n  CLOUDSTACK-9174: A deleted account results in NPE\n\nSigned-off-by: Will Stevens <williamstevens@gmail.com>",
        "parent": "https://github.com/apache/cloudstack/commit/bb48d7f0e5a50d9a480e6f66a25200353d81a6d8",
        "repo": "cloudstack",
        "unit_tests": [
            "QuotaAlertManagerImplTest.java",
            "QuotaManagerImplTest.java",
            "QuotaResponseBuilderImplTest.java"
        ]
    },
    "cloudstack_e7f4bfe": {
        "bug_id": "cloudstack_e7f4bfe",
        "commit": "https://github.com/apache/cloudstack/commit/e7f4bfe1b8277f33e663c31744bc9f30d150fdbf",
        "file": [
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/cloudstack/blob/e7f4bfe1b8277f33e663c31744bc9f30d150fdbf/server/src/com/cloud/deploy/FirstFitPlanner.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/deploy/FirstFitPlanner.java?ref=e7f4bfe1b8277f33e663c31744bc9f30d150fdbf",
                "deletions": 17,
                "filename": "server/src/com/cloud/deploy/FirstFitPlanner.java",
                "patch": "@@ -731,37 +731,43 @@ protected boolean hostCanAccessSPool(Host host, StoragePool pool){\n             //If the plan specifies a poolId, it means that this VM's ROOT volume is ready and the pool should be reused.\n             //In this case, also check if rest of the volumes are ready and can be reused.\n             if(plan.getPoolId() != null){\n-                s_logger.debug(\"Volume has pool already allocated, checking if pool can be reused, poolId: \"+toBeCreated.getPoolId());\n+                s_logger.debug(\"Volume has pool(\" + plan.getPoolId() + \") already allocated, checking if pool can be reused, poolId: \"+toBeCreated.getPoolId());\n                 List<StoragePool> suitablePools = new ArrayList<StoragePool>();\n                 StoragePool pool = null;\n                 if(toBeCreated.getPoolId() != null){\n+                    s_logger.debug(\"finding pool by id '\" + toBeCreated.getPoolId() + \"'\");\n                     pool = (StoragePool)this.dataStoreMgr.getPrimaryDataStore(toBeCreated.getPoolId());\n                 }else{\n+                    s_logger.debug(\"finding pool by id '\" + plan.getPoolId() + \"'\");\n                     pool = (StoragePool)this.dataStoreMgr.getPrimaryDataStore(plan.getPoolId());\n                 }\n \n-                if(!pool.isInMaintenance()){\n-                    if(!avoid.shouldAvoid(pool)){\n-                        long exstPoolDcId = pool.getDataCenterId();\n-\n-                        long exstPoolPodId = pool.getPodId() != null ? pool.getPodId() : -1;\n-                        long exstPoolClusterId = pool.getClusterId() != null ? pool.getClusterId() : -1;\n-                        if(plan.getDataCenterId() == exstPoolDcId && plan.getPodId() == exstPoolPodId && plan.getClusterId() == exstPoolClusterId){\n-                            s_logger.debug(\"Planner need not allocate a pool for this volume since its READY\");\n-                            suitablePools.add(pool);\n-                            suitableVolumeStoragePools.put(toBeCreated, suitablePools);\n-                            if (!(toBeCreated.getState() == Volume.State.Allocated || toBeCreated.getState() == Volume.State.Creating)) {\n-                                readyAndReusedVolumes.add(toBeCreated);\n+                if(pool != null){\n+                    if(!pool.isInMaintenance()){\n+                        if(!avoid.shouldAvoid(pool)){\n+                            long exstPoolDcId = pool.getDataCenterId();\n+\n+                            long exstPoolPodId = pool.getPodId() != null ? pool.getPodId() : -1;\n+                            long exstPoolClusterId = pool.getClusterId() != null ? pool.getClusterId() : -1;\n+                            if(plan.getDataCenterId() == exstPoolDcId && plan.getPodId() == exstPoolPodId && plan.getClusterId() == exstPoolClusterId){\n+                                s_logger.debug(\"Planner need not allocate a pool for this volume since its READY\");\n+                                suitablePools.add(pool);\n+                                suitableVolumeStoragePools.put(toBeCreated, suitablePools);\n+                                if (!(toBeCreated.getState() == Volume.State.Allocated || toBeCreated.getState() == Volume.State.Creating)) {\n+                                    readyAndReusedVolumes.add(toBeCreated);\n+                                }\n+                                continue;\n+                            }else{\n+                                s_logger.debug(\"Pool of the volume does not fit the specified plan, need to reallocate a pool for this volume\");\n                             }\n-                            continue;\n                         }else{\n-                            s_logger.debug(\"Pool of the volume does not fit the specified plan, need to reallocate a pool for this volume\");\n+                            s_logger.debug(\"Pool of the volume is in avoid set, need to reallocate a pool for this volume\");\n                         }\n                     }else{\n-                        s_logger.debug(\"Pool of the volume is in avoid set, need to reallocate a pool for this volume\");\n+                        s_logger.debug(\"Pool of the volume is in maintenance, need to reallocate a pool for this volume\");\n                     }\n                 }else{\n-                    s_logger.debug(\"Pool of the volume is in maintenance, need to reallocate a pool for this volume\");\n+                    s_logger.debug(\"Unable to find pool by provided id\");\n                 }\n             }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/e7f4bfe1b8277f33e663c31744bc9f30d150fdbf/server/src/com/cloud/deploy/FirstFitPlanner.java",
                "sha": "e8504a991c1906f3ccef97dc01a99714df5323e7",
                "status": "modified"
            }
        ],
        "message": "Fix NPE in the planner, in the case that pool ID cannot be looked up in database\nwhen deploying a VM\n\nBUG-ID: CLOUdSTACK-2281\nBugfix-for: 4.2\nReviewed-by: Prachi Damle\nSigned-off-by: Marcus Sorensen <marcus@betterservers.com> 1367280909 -0600",
        "parent": "https://github.com/apache/cloudstack/commit/d44e25efba72b03b114b5662c60d94ddcc3264f8",
        "repo": "cloudstack",
        "unit_tests": [
            "FirstFitPlannerTest.java"
        ]
    },
    "cloudstack_e7fa3a2": {
        "bug_id": "cloudstack_e7fa3a2",
        "commit": "https://github.com/apache/cloudstack/commit/e7fa3a29594eb748b201865dac3a85f8da024075",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/e7fa3a29594eb748b201865dac3a85f8da024075/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=e7fa3a29594eb748b201865dac3a85f8da024075",
                "deletions": 5,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1871,7 +1871,8 @@ protected void migrate(VMInstanceVO vm, long srcHostId, DeployDestination dest)\n         try {\n             pfma = _agentMgr.send(dstHostId, pfmc);\n             if (pfma == null || !pfma.getResult()) {\n-                String msg = \"Unable to prepare for migration due to \" + pfma.getDetails();\n+                String details = (pfma != null) ? pfma.getDetails() : \"null answer returned\";\n+                String msg = \"Unable to prepare for migration due to \" + details;\n                 pfma = null;\n                 throw new AgentUnavailableException(msg, dstHostId);\n             }\n@@ -1907,7 +1908,8 @@ protected void migrate(VMInstanceVO vm, long srcHostId, DeployDestination dest)\n             try {\n                 Answer ma = _agentMgr.send(vm.getLastHostId(), mc);\n                 if (ma == null || !ma.getResult()) {\n-                    throw new CloudRuntimeException(\"Unable to migrate due to \" + ma.getDetails());\n+                    String details = (ma != null) ? ma.getDetails() : \"null answer returned\";\n+                    throw new CloudRuntimeException(\"Unable to migrate due to \" + details);\n                 }\n             } catch (OperationTimedoutException e) {\n                 if (e.isActive()) {\n@@ -3261,7 +3263,8 @@ private void orchestrateMigrateForScale(String vmUuid, long srcHostId, DeployDes\n         try {\n             pfma = _agentMgr.send(dstHostId, pfmc);\n             if (pfma == null || !pfma.getResult()) {\n-                String msg = \"Unable to prepare for migration due to \" + pfma.getDetails();\n+                String details = (pfma != null) ? pfma.getDetails() : \"null answer returned\";\n+                String msg = \"Unable to prepare for migration due to \" + details;\n                 pfma = null;\n                 throw new AgentUnavailableException(msg, dstHostId);\n             }\n@@ -3294,8 +3297,10 @@ private void orchestrateMigrateForScale(String vmUuid, long srcHostId, DeployDes\n             try {\n                 Answer ma = _agentMgr.send(vm.getLastHostId(), mc);\n                 if (ma == null || !ma.getResult()) {\n-                    s_logger.error(\"Unable to migrate due to \" + ma.getDetails());\n-                    throw new CloudRuntimeException(\"Unable to migrate due to \" + ma.getDetails());\n+                    String details = (ma != null) ? ma.getDetails() : \"null answer returned\";\n+                    String msg = \"Unable to migrate due to \" + details;\n+                    s_logger.error(msg);\n+                    throw new CloudRuntimeException(msg);\n                 }\n             } catch (OperationTimedoutException e) {\n                 if (e.isActive()) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/e7fa3a29594eb748b201865dac3a85f8da024075/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "0eafe1374450d60d59593b626ce1eb062a4a4656",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7563: Fix potential NPE from FingBugs.",
        "parent": "https://github.com/apache/cloudstack/commit/176e0d47bb86fcc4ab0cdb33f95f73d751f2d814",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_e8ea6b1": {
        "bug_id": "cloudstack_e8ea6b1",
        "commit": "https://github.com/apache/cloudstack/commit/e8ea6b1abdb78e8f789571d562cd2d37f03f336a",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/e8ea6b1abdb78e8f789571d562cd2d37f03f336a/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareStorageManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareStorageManagerImpl.java?ref=e8ea6b1abdb78e8f789571d562cd2d37f03f336a",
                "deletions": 0,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareStorageManagerImpl.java",
                "patch": "@@ -74,6 +74,7 @@\n import com.cloud.utils.StringUtils;\n import com.cloud.utils.Ternary;\n import com.cloud.utils.script.Script;\n+import com.cloud.utils.exception.CloudRuntimeException;\n import com.cloud.vm.VirtualMachine;\n import com.cloud.vm.snapshot.VMSnapshot;\n import com.vmware.vim25.ManagedObjectReference;\n@@ -1090,6 +1091,9 @@ private String deleteSnapshotOnSecondaryStorge(long accountId, long volumeId, St\n     private String getVolumePathInDatastore(DatastoreMO dsMo, String volumeFileName) throws Exception {\n         String datastoreVolumePath = dsMo.searchFileInSubFolders(volumeFileName, true);\n         assert (datastoreVolumePath != null) : \"Virtual disk file missing from datastore.\";\n+        if (datastoreVolumePath == null) {\n+            throw new CloudRuntimeException(\"Unable to find file \" + volumeFileName + \" in datastore \" + dsMo.getName());\n+        }\n         return datastoreVolumePath;\n     }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/e8ea6b1abdb78e8f789571d562cd2d37f03f336a/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/manager/VmwareStorageManagerImpl.java",
                "sha": "fee3e0afc711d7c83e74968d8bb5de3b8635b01f",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/e8ea6b1abdb78e8f789571d562cd2d37f03f336a/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java?ref=e8ea6b1abdb78e8f789571d562cd2d37f03f336a",
                "deletions": 1,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "patch": "@@ -3984,7 +3984,9 @@ protected Answer execute(AttachVolumeCommand cmd) {\n             DatastoreMO dsMo = new DatastoreMO(getServiceContext(), morDs);\n             String datastoreVolumePath = dsMo.searchFileInSubFolders(cmd.getVolumePath() + \".vmdk\", true);\n             assert (datastoreVolumePath != null) : \"Virtual disk file must exist in specified datastore for attach/detach operations.\";\n-\n+            if (datastoreVolumePath == null) {\n+                throw new CloudRuntimeException(\"Unable to find file \" + cmd.getVolumePath() + \".vmdk in datastore \" + dsMo.getName());\n+            }\n             AttachVolumeAnswer answer = new AttachVolumeAnswer(cmd, cmd.getDeviceId(), datastoreVolumePath);\n             if (cmd.getAttach()) {\n                 vmMo.attachDisk(new String[] { datastoreVolumePath }, morDs);",
                "raw_url": "https://github.com/apache/cloudstack/raw/e8ea6b1abdb78e8f789571d562cd2d37f03f336a/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "sha": "968e095bde1ccda33aa403f16bb86c6b7a6190ea",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/e8ea6b1abdb78e8f789571d562cd2d37f03f336a/vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java?ref=e8ea6b1abdb78e8f789571d562cd2d37f03f336a",
                "deletions": 1,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java",
                "patch": "@@ -335,7 +335,7 @@ public String searchFileInSubFolders(String fileName, boolean caseInsensitive) t\n \n         HostDatastoreBrowserMO browserMo = getHostDatastoreBrowserMO();\n         ArrayList<HostDatastoreBrowserSearchResults> results = browserMo.searchDatastoreSubFolders(\"[\" + getName() + \"]\", fileName, caseInsensitive);\n-        if (results.size() > 1) {\n+        if (results != null && results.size() > 1) {\n             s_logger.warn(\"Multiple files with name \" + fileName + \" exists in datastore \" + datastorePath + \". Trying to choose first file found in search attempt.\");\n         }\n         for (HostDatastoreBrowserSearchResults result : results) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/e8ea6b1abdb78e8f789571d562cd2d37f03f336a/vmware-base/src/com/cloud/hypervisor/vmware/mo/DatastoreMO.java",
                "sha": "a1f2506ca1f3ac9f786267286781a5ecdeea91d9",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-3260\nFixing NPE.",
        "parent": "https://github.com/apache/cloudstack/commit/15a6844784142141af22224489a57d7d748c6687",
        "repo": "cloudstack",
        "unit_tests": [
            "VmwareResourceTest.java",
            "DatastoreMOTest.java"
        ]
    },
    "cloudstack_ec978f0": {
        "bug_id": "cloudstack_ec978f0",
        "commit": "https://github.com/apache/cloudstack/commit/ec978f0716bf6f21de38513a6f368b9b84e197aa",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/ec978f0716bf6f21de38513a6f368b9b84e197aa/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=ec978f0716bf6f21de38513a6f368b9b84e197aa",
                "deletions": 6,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -822,12 +822,14 @@ public VolumeResponse createVolumeResponse(Volume volume) {\n         Long instanceId = volume.getInstanceId();\n         if (instanceId != null && volume.getState() != Volume.State.Destroy) {\n             VMInstanceVO vm = ApiDBUtils.findVMInstanceById(instanceId);\n-            volResponse.setVirtualMachineId(vm.getId());\n-            volResponse.setVirtualMachineName(vm.getHostName());\n-            UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n-            if (userVm != null) {\n-                volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n-                volResponse.setVirtualMachineState(vm.getState().toString());\n+            if (vm != null) {\n+                volResponse.setVirtualMachineId(vm.getId());\n+                volResponse.setVirtualMachineName(vm.getHostName());\n+                UserVm userVm = ApiDBUtils.findUserVmById(vm.getId());\n+                if (userVm != null) {\n+                    volResponse.setVirtualMachineDisplayName(userVm.getDisplayName());\n+                    volResponse.setVirtualMachineState(vm.getState().toString());\n+                }\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/ec978f0716bf6f21de38513a6f368b9b84e197aa/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "f0b232b3d88c90013dece8a1de8729684fd91219",
                "status": "modified"
            }
        ],
        "message": "fix NPE when listvolume if vm got destroyed",
        "parent": "https://github.com/apache/cloudstack/commit/891f02f4d459980aea31071e6fd894880f6bf891",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_ee3d6f5": {
        "bug_id": "cloudstack_ee3d6f5",
        "commit": "https://github.com/apache/cloudstack/commit/ee3d6f5ceaa058c4675f93f5a753ee00ffd9e408",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/ee3d6f5ceaa058c4675f93f5a753ee00ffd9e408/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=ee3d6f5ceaa058c4675f93f5a753ee00ffd9e408",
                "deletions": 1,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -941,7 +941,7 @@ public boolean delete(long userId, long templateId, Long zoneId) {\n \t\t\t}\n \t\t}\n \t\t\n-\t\tAccount account = _accountDao.findById(template.getAccountId());\n+\t\tAccount account = _accountDao.findByIdIncludingRemoved(template.getAccountId());\n \t\tString eventType = \"\";\n \t\t\n \t\tif (template.getFormat().equals(ImageFormat.ISO)){",
                "raw_url": "https://github.com/apache/cloudstack/raw/ee3d6f5ceaa058c4675f93f5a753ee00ffd9e408/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "5408358aadf4479ab3da0a874d93d0d21d110270",
                "status": "modified"
            }
        ],
        "message": "bug 9205: resolved fixed\nstatus 9205: fix NPE in usageEvent",
        "parent": "https://github.com/apache/cloudstack/commit/6ff40b7e887813483ffa8eb0f5eeb65cf64c5067",
        "repo": "cloudstack",
        "unit_tests": [
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_f02e402": {
        "bug_id": "cloudstack_f02e402",
        "commit": "https://github.com/apache/cloudstack/commit/f02e402ebb86d9ab5b6f34c04e57460ed53b7827",
        "file": [
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/cloudstack/blob/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/core/src/com/cloud/resource/RequestWrapper.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/core/src/com/cloud/resource/RequestWrapper.java?ref=f02e402ebb86d9ab5b6f34c04e57460ed53b7827",
                "deletions": 8,
                "filename": "core/src/com/cloud/resource/RequestWrapper.java",
                "patch": "@@ -29,6 +29,15 @@\n import com.cloud.agent.api.Command;\n \n public abstract class RequestWrapper {\n+    static public class CommandNotSupported extends NullPointerException {\n+        public CommandNotSupported(String msg) {\n+            super(msg);\n+        }\n+        public CommandNotSupported(String msg, Throwable cause) {\n+            super(msg);\n+            initCause(cause);\n+        }\n+    }\n \n     private static final Logger s_logger = Logger.getLogger(RequestWrapper.class);\n \n@@ -52,7 +61,7 @@\n \n                 keepResourceClass = keepResourceClass2;\n             } catch (final ClassCastException e) {\n-                throw new NullPointerException(\"No key found for '\" + command.getClass() + \"' in the Map!\");\n+                throw new CommandNotSupported(\"No key found for '\" + command.getClass() + \"' in the Map!\");\n             }\n         }\n         return resource;\n@@ -69,14 +78,14 @@\n                 final Class<? extends Command> commandClass2 = (Class<? extends Command>) keepCommandClass.getSuperclass();\n \n                 if (commandClass2 == null) {\n-                    throw new NullPointerException(\"All the COMMAND hierarchy tree has been visited but no compliant key has been found for '\" + commandClass + \"'.\");\n+                    throw new CommandNotSupported(\"All the COMMAND hierarchy tree has been visited but no compliant key has been found for '\" + commandClass + \"'.\");\n                 }\n \n                 commandWrapper = resourceCommands.get(commandClass2);\n \n                 keepCommandClass = commandClass2;\n             } catch (final ClassCastException e) {\n-                throw new NullPointerException(\"No key found for '\" + keepCommandClass.getClass() + \"' in the Map!\");\n+                throw new CommandNotSupported(\"No key found for '\" + keepCommandClass.getClass() + \"' in the Map!\");\n             } catch (final NullPointerException e) {\n                 // Will now traverse all the resource hierarchy. Returning null\n                 // is not a problem.\n@@ -102,18 +111,16 @@\n                 final Class<? extends ServerResource> resourceClass2 = (Class<? extends ServerResource>) keepResourceClass.getSuperclass();\n \n                 if (resourceClass2 == null) {\n-                    throw new NullPointerException(\"All the SERVER-RESOURCE hierarchy tree has been visited but no compliant key has been found for '\" + command.getClass() + \"'.\");\n+                    throw new CommandNotSupported(\"All the SERVER-RESOURCE hierarchy tree has been visited but no compliant key has been found for '\" + command.getClass() + \"'.\");\n                 }\n \n                 final Hashtable<Class<? extends Command>, CommandWrapper> resourceCommands2 = retrieveResource(command,\n                         (Class<? extends ServerResource>) keepResourceClass.getSuperclass());\n                 keepResourceClass = resourceClass2;\n \n                 commandWrapper = retrieveCommands(command.getClass(), resourceCommands2);\n-            } catch (final ClassCastException e) {\n-                throw new NullPointerException(\"No key found for '\" + command.getClass() + \"' in the Map!\");\n-            } catch (final NullPointerException e) {\n-                throw e;\n+            } catch (final ClassCastException | NullPointerException e) {\n+                throw new CommandNotSupported(\"No key found for '\" + command.getClass() + \"' in the Map!\", e);\n             }\n         }\n         return commandWrapper;",
                "raw_url": "https://github.com/apache/cloudstack/raw/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/core/src/com/cloud/resource/RequestWrapper.java",
                "sha": "d1a3c1f18cc11c338cb3cace3063bba0e45e92b4",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/cloudstack/blob/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java?ref=f02e402ebb86d9ab5b6f34c04e57460ed53b7827",
                "deletions": 1,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "patch": "@@ -47,6 +47,7 @@\n import javax.xml.parsers.DocumentBuilderFactory;\n import javax.xml.parsers.ParserConfigurationException;\n \n+import com.cloud.resource.RequestWrapper;\n import org.apache.cloudstack.storage.to.PrimaryDataStoreTO;\n import org.apache.cloudstack.storage.to.VolumeObjectTO;\n import org.apache.cloudstack.utils.hypervisor.HypervisorUtils;\n@@ -1432,13 +1433,21 @@ public boolean stop() {\n         return true;\n     }\n \n+    /**\n+     * This finds a command wrapper to handle the command and executes it.\n+     * If no wrapper is found an {@see UnsupportedAnswer} is sent back.\n+     * Any other exceptions are to be caught and wrapped in an generic {@see Answer}, marked as failed.\n+     *\n+     * @param cmd the instance of a {@see Command} to execute.\n+     * @return the for the {@see Command} appropriate {@see Answer} or {@see UnsupportedAnswer}\n+     */\n     @Override\n     public Answer executeRequest(final Command cmd) {\n \n         final LibvirtRequestWrapper wrapper = LibvirtRequestWrapper.getInstance();\n         try {\n             return wrapper.execute(cmd, this);\n-        } catch (final Exception e) {\n+        } catch (final RequestWrapper.CommandNotSupported cmde) {\n             return Answer.createUnsupportedCommandAnswer(cmd);\n         }\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "sha": "8a94b05865585ce13b271e42d45cd29782cec699",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtRequestWrapper.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtRequestWrapper.java?ref=f02e402ebb86d9ab5b6f34c04e57460ed53b7827",
                "deletions": 0,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtRequestWrapper.java",
                "patch": "@@ -72,6 +72,9 @@ public Answer execute(final Command command, final ServerResource serverResource\n             commandWrapper = retryWhenAllFails(command, resourceClass, resourceCommands);\n         }\n \n+        if (commandWrapper == null) {\n+            throw new CommandNotSupported(\"No way to handle \" + command.getClass());\n+        }\n         return commandWrapper.execute(command, serverResource);\n     }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/cloudstack/raw/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtRequestWrapper.java",
                "sha": "436a13083168fe9a1e0c82ac3e8a3ed29484b4ea",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/cloudstack/blob/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/plugins/hypervisors/kvm/test/com/cloud/hypervisor/kvm/resource/LibvirtComputingResourceTest.java",
                "changes": 27,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/test/com/cloud/hypervisor/kvm/resource/LibvirtComputingResourceTest.java?ref=f02e402ebb86d9ab5b6f34c04e57460ed53b7827",
                "deletions": 0,
                "filename": "plugins/hypervisors/kvm/test/com/cloud/hypervisor/kvm/resource/LibvirtComputingResourceTest.java",
                "patch": "@@ -38,6 +38,8 @@\n import javax.xml.xpath.XPathExpressionException;\n import javax.xml.xpath.XPathFactory;\n \n+import com.cloud.agent.api.Command;\n+import com.cloud.agent.api.UnsupportedAnswer;\n import com.cloud.hypervisor.kvm.resource.LibvirtVMDef.CpuTuneDef;\n import org.apache.commons.lang.SystemUtils;\n import org.joda.time.Duration;\n@@ -5191,4 +5193,29 @@ public void testSetQuotaAndPeriodMinQuota() {\n         Assert.assertEquals(CpuTuneDef.MIN_QUOTA, cpuTuneDef.getQuota());\n         Assert.assertEquals((int) (CpuTuneDef.MIN_QUOTA / pct), cpuTuneDef.getPeriod());\n     }\n+\n+    @Test\n+    public void testUnknownCommand() {\n+        libvirtComputingResource = new LibvirtComputingResource();\n+        Command cmd = new Command() {\n+            @Override public boolean executeInSequence() {\n+                return false;\n+            }\n+        };\n+        Answer ans = libvirtComputingResource.executeRequest(cmd);\n+        assertTrue(ans instanceof UnsupportedAnswer);\n+    }\n+\n+    @Test\n+    public void testKnownCommand() {\n+        libvirtComputingResource = new LibvirtComputingResource();\n+        Command cmd = new PingTestCommand() {\n+            @Override public boolean executeInSequence() {\n+                throw new NullPointerException(\"test succeeded\");\n+            }\n+        };\n+        Answer ans = libvirtComputingResource.executeRequest(cmd);\n+        assertFalse(ans instanceof UnsupportedAnswer);\n+        assertTrue(ans instanceof Answer);\n+    }\n }",
                "raw_url": "https://github.com/apache/cloudstack/raw/f02e402ebb86d9ab5b6f34c04e57460ed53b7827/plugins/hypervisors/kvm/test/com/cloud/hypervisor/kvm/resource/LibvirtComputingResourceTest.java",
                "sha": "be191f5e9a53a37b3d22295ad27a7d09aeaba2f8",
                "status": "modified"
            }
        ],
        "message": "kvm: send unsupported answer only when applicable (#2714)\n\nThrow specific NPE child when command is known not to be known. Add unit tests.",
        "parent": "https://github.com/apache/cloudstack/commit/d4e302dcc67ca740242f09ef43ca97a72696c204",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java"
        ]
    },
    "cloudstack_f1bee86": {
        "bug_id": "cloudstack_f1bee86",
        "commit": "https://github.com/apache/cloudstack/commit/f1bee862638e79678f7fb47f63db17bb8974ab7a",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/f1bee862638e79678f7fb47f63db17bb8974ab7a/server/src/com/cloud/server/StatsCollector.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/server/StatsCollector.java?ref=f1bee862638e79678f7fb47f63db17bb8974ab7a",
                "deletions": 1,
                "filename": "server/src/com/cloud/server/StatsCollector.java",
                "patch": "@@ -268,7 +268,10 @@ public void run() {\n                 ConcurrentHashMap<Long, StorageStats> storageStats = new ConcurrentHashMap<Long, StorageStats>();\r\n                 for (HostVO host : hosts) {\r\n                     GetStorageStatsCommand command = new GetStorageStatsCommand(host.getStorageUrl());\n-        \t\t\tHostVO ssAhost = _agentMgr.getSSAgent(host);\n+                    HostVO ssAhost = _agentMgr.getSSAgent(host);\n+                    if (ssAhost == null) {\n+                        return;\n+                    }\n                     long hostId = host.getId();\r\n                     Answer answer = _agentMgr.easySend(ssAhost.getId(), command);\r\n                     if (answer != null && answer.getResult()) {\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/f1bee862638e79678f7fb47f63db17bb8974ab7a/server/src/com/cloud/server/StatsCollector.java",
                "sha": "7ba30a65a2aef1b2a1b5d48f9763743fd2aedadd",
                "status": "modified"
            }
        ],
        "message": "fixed a NPE",
        "parent": "https://github.com/apache/cloudstack/commit/90cb2dea6af064d5527554db8f8358dba96c6cb8",
        "repo": "cloudstack",
        "unit_tests": [
            "StatsCollectorTest.java"
        ]
    },
    "cloudstack_f1c63df": {
        "bug_id": "cloudstack_f1c63df",
        "commit": "https://github.com/apache/cloudstack/commit/f1c63df6657e6ae697e4e586f1fbc5497a5e46fb",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/cloudstack/blob/f1c63df6657e6ae697e4e586f1fbc5497a5e46fb/engine/schema/src/com/cloud/vm/dao/VMInstanceDaoImpl.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/vm/dao/VMInstanceDaoImpl.java?ref=f1c63df6657e6ae697e4e586f1fbc5497a5e46fb",
                "deletions": 15,
                "filename": "engine/schema/src/com/cloud/vm/dao/VMInstanceDaoImpl.java",
                "patch": "@@ -228,6 +228,19 @@ protected void init() {\n \n         _updateTimeAttr = _allAttributes.get(\"updateTime\");\n         assert _updateTimeAttr != null : \"Couldn't get this updateTime attribute\";\n+        \n+        SearchBuilder<NicVO> nicSearch = _nicDao.createSearchBuilder();\n+        nicSearch.and(\"networkId\", nicSearch.entity().getNetworkId(), SearchCriteria.Op.EQ);\n+\n+        DistinctHostNameSearch = createSearchBuilder(String.class);\n+        DistinctHostNameSearch.selectField(DistinctHostNameSearch.entity().getHostName());\n+\n+        DistinctHostNameSearch.and(\"types\", DistinctHostNameSearch.entity().getType(), SearchCriteria.Op.IN);\n+        DistinctHostNameSearch.and(\"removed\", DistinctHostNameSearch.entity().getRemoved(), SearchCriteria.Op.NULL);\n+        DistinctHostNameSearch.join(\"nicSearch\", nicSearch, DistinctHostNameSearch.entity().getId(),\n+                nicSearch.entity().getInstanceId(), JoinBuilder.JoinType.INNER);\n+        DistinctHostNameSearch.done();\n+        \n     }\n \n     @Override\n@@ -629,21 +642,6 @@ public Long countRunningByAccount(long accountId){\n \n     @Override\n     public List<String> listDistinctHostNames(long networkId, VirtualMachine.Type... types) {\n-        if (DistinctHostNameSearch == null) {\n-\n-            SearchBuilder<NicVO> nicSearch = _nicDao.createSearchBuilder();\n-            nicSearch.and(\"networkId\", nicSearch.entity().getNetworkId(), SearchCriteria.Op.EQ);\n-\n-            DistinctHostNameSearch = createSearchBuilder(String.class);\n-            DistinctHostNameSearch.selectField(DistinctHostNameSearch.entity().getHostName());\n-\n-            DistinctHostNameSearch.and(\"types\", DistinctHostNameSearch.entity().getType(), SearchCriteria.Op.IN);\n-            DistinctHostNameSearch.and(\"removed\", DistinctHostNameSearch.entity().getRemoved(), SearchCriteria.Op.NULL);\n-            DistinctHostNameSearch.join(\"nicSearch\", nicSearch, DistinctHostNameSearch.entity().getId(),\n-                    nicSearch.entity().getInstanceId(), JoinBuilder.JoinType.INNER);\n-            DistinctHostNameSearch.done();\n-        }\n-\n         SearchCriteria<String> sc = DistinctHostNameSearch.create();\n         if (types != null && types.length != 0) {\n             sc.setParameters(\"types\", (Object[]) types);",
                "raw_url": "https://github.com/apache/cloudstack/raw/f1c63df6657e6ae697e4e586f1fbc5497a5e46fb/engine/schema/src/com/cloud/vm/dao/VMInstanceDaoImpl.java",
                "sha": "3a7dde78a6d2bfca9bc0d530f0542955cf18678b",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-4403: vmInstanceDao - initialize the SearchBuilder in init() method instead of the search dao method which wasn't thread safe, and could cause NPEs during search builder initializing.",
        "parent": "https://github.com/apache/cloudstack/commit/17b6f1c5708001f48fd12e2553b9d8dfdc60152b",
        "repo": "cloudstack",
        "unit_tests": [
            "VMInstanceDaoImplTest.java"
        ]
    },
    "cloudstack_f280bbe": {
        "bug_id": "cloudstack_f280bbe",
        "commit": "https://github.com/apache/cloudstack/commit/f280bbe9e4cd8bdcc59f73e32885fa8f7616e342",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/f280bbe9e4cd8bdcc59f73e32885fa8f7616e342/server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java?ref=f280bbe9e4cd8bdcc59f73e32885fa8f7616e342",
                "deletions": 4,
                "filename": "server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java",
                "patch": "@@ -81,22 +81,28 @@ public VolumeResponse newVolumeResponse(ResponseView view, VolumeJoinVO volume)\n         volResponse.setZoneId(volume.getDataCenterUuid());\n         volResponse.setZoneName(volume.getDataCenterName());\n \n-        volResponse.setVolumeType(volume.getVolumeType().toString());\n+        if (volume.getVolumeType() != null) {\n+            volResponse.setVolumeType(volume.getVolumeType().toString());\n+        }\n         volResponse.setDeviceId(volume.getDeviceId());\n \n         long instanceId = volume.getVmId();\n         if (instanceId > 0 && volume.getState() != Volume.State.Destroy) {\n             volResponse.setVirtualMachineId(volume.getVmUuid());\n             volResponse.setVirtualMachineName(volume.getVmName());\n-            volResponse.setVirtualMachineState(volume.getVmState().toString());\n+            if (volume.getVmState() != null) {\n+                volResponse.setVirtualMachineState(volume.getVmState().toString());\n+            }\n             if (volume.getVmDisplayName() != null) {\n                 volResponse.setVirtualMachineDisplayName(volume.getVmDisplayName());\n             } else {\n                 volResponse.setVirtualMachineDisplayName(volume.getVmName());\n             }\n         }\n \n-        volResponse.setProvisioningType(volume.getProvisioningType().toString());\n+        if (volume.getProvisioningType() != null) {\n+            volResponse.setProvisioningType(volume.getProvisioningType().toString());\n+        }\n \n         // Show the virtual size of the volume\n         volResponse.setSize(volume.getSize());\n@@ -105,7 +111,9 @@ public VolumeResponse newVolumeResponse(ResponseView view, VolumeJoinVO volume)\n         volResponse.setMaxIops(volume.getMaxIops());\n \n         volResponse.setCreated(volume.getCreated());\n-        volResponse.setState(volume.getState().toString());\n+        if (volume.getState() != null) {\n+            volResponse.setState(volume.getState().toString());\n+        }\n         if (volume.getState() == Volume.State.UploadOp) {\n             // com.cloud.storage.VolumeHostVO volumeHostRef =\n             // ApiDBUtils.findVolumeHostRef(volume.getId(),",
                "raw_url": "https://github.com/apache/cloudstack/raw/f280bbe9e4cd8bdcc59f73e32885fa8f7616e342/server/src/com/cloud/api/query/dao/VolumeJoinDaoImpl.java",
                "sha": "54d1ca164e29fcb4dd44d49ba1af285888238821",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #830 from sureshanaparti/CLOUDSTACK-8858\n\nCLOUDSTACK-8858: listVolumes API fails for a particular domain with NPE.CLOUDSTACK-8858: listVolumes API fails for a particular domain with NPE.\n\nSummary: listVolumes API fails when volume associated vm instance has NULL or invalid state. Fix the code to guard this situation since this should not block volume listing.\n\n* pr/830:\n  CLOUDSTACK-8858: listVolumes API fails for a particular domain with NPE.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/c07c850dff913c38b72ca35b34b1b0fc9fc423cb",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeJoinDaoImplTest.java"
        ]
    },
    "cloudstack_f2951d9": {
        "bug_id": "cloudstack_f2951d9",
        "commit": "https://github.com/apache/cloudstack/commit/f2951d9560cadd3e5420f206ca69e309abd4b8fd",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/f2951d9560cadd3e5420f206ca69e309abd4b8fd/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=f2951d9560cadd3e5420f206ca69e309abd4b8fd",
                "deletions": 4,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -744,14 +744,17 @@ protected boolean checkWorkItems(final VMInstanceVO vm, final State state) throw\n \n     protected <T extends VMInstanceVO> boolean changeState(final T vm, final Event event, final Long hostId, final ItWorkVO work, final Step step) throws NoTransitionException {\n         // FIXME: We should do this better.\n-        final Step previousStep = work.getStep();\n-        _workDao.updateStep(work, step);\n+        Step previousStep = null;\n+        if (work != null) {\n+            previousStep = work.getStep();\n+            _workDao.updateStep(work, step);\n+        }\n         boolean result = false;\n         try {\n             result = stateTransitTo(vm, event, hostId);\n             return result;\n         } finally {\n-            if (!result) {\n+            if (!result && work != null) {\n                 _workDao.updateStep(work, previousStep);\n             }\n         }\n@@ -1507,12 +1510,13 @@ private void advanceStop(final VMInstanceVO vm, final boolean cleanUpEvenIfUnabl\n             if (doCleanup) {\n                 if (cleanup(vmGuru, new VirtualMachineProfileImpl(vm), work, Event.StopRequested, cleanUpEvenIfUnableToStop)) {\n                     try {\n-                        if (s_logger.isDebugEnabled()) {\n+                        if (s_logger.isDebugEnabled() && work != null) {\n                             s_logger.debug(\"Updating work item to Done, id:\" + work.getId());\n                         }\n                         if (!changeState(vm, Event.AgentReportStopped, null, work, Step.Done)) {\n                             throw new CloudRuntimeException(\"Unable to stop \" + vm);\n                         }\n+\n                     } catch (final NoTransitionException e) {\n                         s_logger.warn(\"Unable to cleanup \" + vm);\n                         throw new CloudRuntimeException(\"Unable to stop \" + vm, e);",
                "raw_url": "https://github.com/apache/cloudstack/raw/f2951d9560cadd3e5420f206ca69e309abd4b8fd/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "03a37987752f51590c78c40fa7a65f5052aa7fa1",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1956 from myENA/bug/49npe_vmimpl\n\nCLOUDSTACK-9796 - Fix NPE in VirtualMachineManagerImpl.java",
        "parent": "https://github.com/apache/cloudstack/commit/5fcf648e7e6ed352a5d95d6c81db2c95ff824c5e",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_f40e31e": {
        "bug_id": "cloudstack_f40e31e",
        "commit": "https://github.com/apache/cloudstack/commit/f40e31e061a6e10c67fc3c4db997138e071f9fa2",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/f40e31e061a6e10c67fc3c4db997138e071f9fa2/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=f40e31e061a6e10c67fc3c4db997138e071f9fa2",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1254,7 +1254,8 @@ protected boolean sendStop(VirtualMachineGuru guru, VirtualMachineProfile profil\n                     _resourceMgr.updateGPUDetails(vm.getHostId(), gpuDevice.getGroupDetails());\n                 }\n                 if (answer == null || !answer.getResult()) {\n-                    s_logger.debug(\"Unable to stop VM due to \" + answer.getDetails());\n+                    String details = (answer != null) ? answer.getDetails() : \"null answer returned\";\n+                    s_logger.debug(\"Unable to stop VM due to \" + details);\n                     return false;\n                 }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/f40e31e061a6e10c67fc3c4db997138e071f9fa2/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "d772848779bcca53dad2eaf1413d591c24eab122",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7563: Fix potential NPE in checking answer\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit d42e3df9cf43b0ad46d406c6ab5b1d8c811d0239)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/0407fb334f3a79f570217f35636b47076b06d500",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_f47cfc6": {
        "bug_id": "cloudstack_f47cfc6",
        "commit": "https://github.com/apache/cloudstack/commit/f47cfc6eb16bf0fa5830327207a2d3fdf24ab700",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/f47cfc6eb16bf0fa5830327207a2d3fdf24ab700/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java?ref=f47cfc6eb16bf0fa5830327207a2d3fdf24ab700",
                "deletions": 14,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "patch": "@@ -925,7 +925,7 @@ protected NicTO toNicTO(NicVO nic, NicProfile profile, NetworkVO config) {\n \n     boolean isNetworkImplemented(NetworkVO network) {\n         Network.State state = network.getState();\n-        if (state == Network.State.Implemented) {\n+        if (state == Network.State.Implemented || state == Network.State.Implementing) {\n             return true;\n         } else if (state == Network.State.Setup) {\n             DataCenterVO zone = _dcDao.findById(network.getDataCenterId());\n@@ -1277,19 +1277,7 @@ public int compare(NicVO nic1, NicVO nic2) {\n         });\n \n         for (NicVO nic : nics) {\n-            Pair<NetworkGuru, NetworkVO> implemented = null;\n-            if (vmProfile.getVirtualMachine().getType() != Type.DomainRouter) {\n-                implemented = implementNetwork(nic.getNetworkId(), dest, context);\n-            } else {\n-                // At the time of implementing network (using implementNetwork() method), if the VR needs to be deployed then\n-                // it follows the same path of regular VM deployment. This leads to a nested call to implementNetwork() while\n-                // preparing VR nics. This flow creates issues in dealing with network state transitions. The original call\n-                // puts network in \"Implementing\" state and then the nested call again tries to put it into same state resulting\n-                // in issues. In order to avoid it, implementNetwork() call for VR is replaced with below code.\n-                NetworkVO network = _networksDao.findById(nic.getNetworkId());\n-                NetworkGuru guru = AdapterBase.getAdapterByName(networkGurus, network.getGuruName());\n-                implemented = new Pair<NetworkGuru, NetworkVO>(guru, network);\n-            }\n+            Pair<NetworkGuru, NetworkVO> implemented = implementNetwork(nic.getNetworkId(), dest, context);\n             if (implemented == null || implemented.first() == null) {\n                 s_logger.warn(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part of preparing nic id=\" + nic.getId());\n                 throw new CloudRuntimeException(\"Failed to implement network id=\" + nic.getNetworkId() + \" as a part preparing nic id=\" + nic.getId());",
                "raw_url": "https://github.com/apache/cloudstack/raw/f47cfc6eb16bf0fa5830327207a2d3fdf24ab700/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "sha": "64a1f3a49946cfdff4f8d23003a5e94ba7a12980",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-7186: Revert \"CLOUDSTACK-7182: NPE while trying to deploy VMs in parallel in isolated network\"\n\nThis reverts commit 47d6a64b319ab064c4b855346f2bfdb250fb9ad8, which broke VPC\ncompletely.",
        "parent": "https://github.com/apache/cloudstack/commit/45c9f03e14ec956a6ccb952b6d98189adcb3c8ae",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkOrchestratorTest.java"
        ]
    },
    "cloudstack_f4a96d4": {
        "bug_id": "cloudstack_f4a96d4",
        "commit": "https://github.com/apache/cloudstack/commit/f4a96d4c853bd4f60539b9b9e9218b42640652a9",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/f4a96d4c853bd4f60539b9b9e9218b42640652a9/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=f4a96d4c853bd4f60539b9b9e9218b42640652a9",
                "deletions": 5,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -1382,6 +1382,11 @@ public Volume detachVolumeFromVM(DetachVolumeCmd cmmd) {\n             volume = _volsDao.findByInstanceAndDeviceId(cmmd.getVirtualMachineId(), cmmd.getDeviceId()).get(0);\n         }\n \n+        // Check that the volume ID is valid\n+        if (volume == null) {\n+            throw new InvalidParameterValueException(\"Unable to find volume with ID: \" + volumeId);\n+        }\n+\n         Long vmId = null;\n \n         if (cmmd.getVirtualMachineId() == null) {\n@@ -1390,11 +1395,6 @@ public Volume detachVolumeFromVM(DetachVolumeCmd cmmd) {\n             vmId = cmmd.getVirtualMachineId();\n         }\n \n-        // Check that the volume ID is valid\n-        if (volume == null) {\n-            throw new InvalidParameterValueException(\"Unable to find volume with ID: \" + volumeId);\n-        }\n-\n         // Permissions check\n         _accountMgr.checkAccess(caller, null, true, volume);\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/f4a96d4c853bd4f60539b9b9e9218b42640652a9/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "69558250da3336a909ea45c78ac91bc8579fd04f",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6011 . When detach is called on a deleted volume, avoid the NPE and throw an appropriate exception instead",
        "parent": "https://github.com/apache/cloudstack/commit/9cb37ec349a6740a2f012ef4e6ac58a6c3b13907",
        "repo": "cloudstack",
        "unit_tests": [
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_f4f00cb": {
        "bug_id": "cloudstack_f4f00cb",
        "commit": "https://github.com/apache/cloudstack/commit/f4f00cbe2dd240ff7604b3c1743a817c660346a5",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/f4f00cbe2dd240ff7604b3c1743a817c660346a5/server/src/com/cloud/api/ApiServer.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiServer.java?ref=f4f00cbe2dd240ff7604b3c1743a817c660346a5",
                "deletions": 18,
                "filename": "server/src/com/cloud/api/ApiServer.java",
                "patch": "@@ -436,7 +436,7 @@ private void buildAuditTrail(StringBuffer auditTrailSb, String command, String r\n         */\r\n     }\r\n     \r\n-    public boolean verifyRequest(Map<String, Object[]> requestParameters, String userId) {\n+    public boolean verifyRequest(Map<String, Object[]> requestParameters, Long userId) {\n         try {\r\n             String apiKey = null;\r\n             String secretKey = null;\r\n@@ -453,7 +453,7 @@ public boolean verifyRequest(Map<String, Object[]> requestParameters, String use\n             \r\n             //if userId not null, that mean that user is logged in\r\n             if (userId != null) {\r\n-            \tLong accountId = ApiDBUtils.findUserById(Long.valueOf(userId)).getAccountId();\r\n+            \tLong accountId = ApiDBUtils.findUserById(userId).getAccountId();\r\n             \tAccount userAccount = _ms.findAccountById(accountId);\r\n             \tshort accountType = userAccount.getType();\r\n             \t\r\n@@ -519,22 +519,7 @@ public boolean verifyRequest(Map<String, Object[]> requestParameters, String use\n                 return false;\r\n             }\r\n \r\n-            if (account.getType() == Account.ACCOUNT_TYPE_NORMAL) {\r\n-                UserContext.updateContext(user.getId(), account, account.getAccountName(), account.getId(), account.getDomainId(), null);\r\n-\r\n-                /*\r\n-    \t\t\trequestParameters.put(BaseCmd.Properties.USER_ID.getName(), new String[] { user.getId().toString() });\r\n-                requestParameters.put(BaseCmd.Properties.ACCOUNT.getName(), new String[] { account.getAccountName() });\r\n-                requestParameters.put(BaseCmd.Properties.DOMAIN_ID.getName(), new String[] { Long.toString(account.getDomainId()) });\r\n-        \t\trequestParameters.put(BaseCmd.Properties.ACCOUNT_OBJ.getName(), new Object[] { account });\r\n-        \t\t*/\r\n-    \t\t} else {\r\n-                UserContext.updateContext(user.getId(), account, null, null, null, null);\r\n-                /*\r\n-    \t\t\trequestParameters.put(BaseCmd.Properties.USER_ID.getName(), new String[] { user.getId().toString() });\r\n-    \t\t\trequestParameters.put(BaseCmd.Properties.ACCOUNT_OBJ.getName(), new Object[] { account });\r\n-    \t\t\t*/\r\n-    \t\t}\r\n+            UserContext.updateContext(user.getId(), account, account.getAccountName(), account.getId(), account.getDomainId(), null);\r\n \r\n             if (!isCommandAvailable(account.getType(), commandName)) {\r\n         \t\treturn false;\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/f4f00cbe2dd240ff7604b3c1743a817c660346a5/server/src/com/cloud/api/ApiServer.java",
                "sha": "aca838d980e57200fb5e74f36a772532798ff67c",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f4f00cbe2dd240ff7604b3c1743a817c660346a5/server/src/com/cloud/api/ApiServlet.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiServlet.java?ref=f4f00cbe2dd240ff7604b3c1743a817c660346a5",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiServlet.java",
                "patch": "@@ -209,7 +209,7 @@ private void processRequest(HttpServletRequest req, HttpServletResponse resp) {\n                 }\r\n             }\r\n \n-            if (_apiServer.verifyRequest(params, userId.toString())) {\n+            if (_apiServer.verifyRequest(params, userId)) {\n                 /*\n             \tif (accountObj != null) {\r\n             \t\tAccount userAccount = (Account)accountObj;\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/f4f00cbe2dd240ff7604b3c1743a817c660346a5/server/src/com/cloud/api/ApiServlet.java",
                "sha": "f72ae272c92bd5fef825c7b8e786bf903626dea3",
                "status": "modified"
            }
        ],
        "message": "bug 6655:  when verifying request signature for API requests that use keys, pass the userId of the requester as a Long to avoid NPEs when converting it to a string.  Also set up the UserContext for both normal users and admins.\n\nstatus 6655: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/408822e3582c01c0d7a8733e445c8e908e092c4b",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiServletTest.java"
        ]
    },
    "cloudstack_f5279e7": {
        "bug_id": "cloudstack_f5279e7",
        "commit": "https://github.com/apache/cloudstack/commit/f5279e74a6d0165d63d33845533092f178ebde9a",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/f5279e74a6d0165d63d33845533092f178ebde9a/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=f5279e74a6d0165d63d33845533092f178ebde9a",
                "deletions": 3,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -1948,8 +1948,7 @@ public EventResponse createEventResponse(Event event) {\n     }\n     \n     @Override\n-    public ListResponse<TemplateResponse> createIsoResponse(List<? extends VirtualMachineTemplate> isos, Long zoneId, boolean onlyReady, boolean isAdmin, Account account)  {\n-        Map<Long, List<VMTemplateHostVO>> isoHostsMap = new HashMap<Long, List<VMTemplateHostVO>>();\n+    public ListResponse<TemplateResponse> createIsoResponse(List<? extends VirtualMachineTemplate> isos, Long zoneId, boolean onlyReady, boolean isAdmin, Account account)  {        \n \n         ListResponse<TemplateResponse> response = new ListResponse<TemplateResponse>();\n         List<TemplateResponse> isoResponses = new ArrayList<TemplateResponse>();\n@@ -1971,7 +1970,7 @@ public EventResponse createEventResponse(Event event) {\n                 continue;\n             }\n            \n-            List<VMTemplateHostVO> isoHosts = isoHostsMap.get(iso.getId());\n+            List<VMTemplateHostVO> isoHosts = ApiDBUtils.listTemplateHostBy(iso.getId(), zoneId);\n             for (VMTemplateHostVO isoHost : isoHosts) {\n                 if (onlyReady && isoHost.getDownloadState() != Status.DOWNLOADED) {\n                     continue;",
                "raw_url": "https://github.com/apache/cloudstack/raw/f5279e74a6d0165d63d33845533092f178ebde9a/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "8219165c0836c1dfcb5bb3fcd24be9c004c28092",
                "status": "modified"
            }
        ],
        "message": "bug 7403 : Correct NPE for ListIso command.\nstatus 7403: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/ad571eef3609546b3c62194d6355c575cdfd15d4",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_f5c8e38": {
        "bug_id": "cloudstack_f5c8e38",
        "commit": "https://github.com/apache/cloudstack/commit/f5c8e386e5881c1d7aad1f85922752621bb96c1a",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/f5c8e386e5881c1d7aad1f85922752621bb96c1a/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/vm/UserVmManagerImpl.java?ref=f5c8e386e5881c1d7aad1f85922752621bb96c1a",
                "deletions": 1,
                "filename": "server/src/com/cloud/vm/UserVmManagerImpl.java",
                "patch": "@@ -3228,7 +3228,6 @@ public UserVm destroyVm(long vmId) throws ResourceUnavailableException,\n         if (vm == null || vm.getRemoved() != null) {\n             InvalidParameterValueException ex = new InvalidParameterValueException(\n                     \"Unable to find a virtual machine with specified vmId\");\n-            ex.addProxyObject(vm, vmId, \"vmId\");\n             throw ex;\n         }\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/f5c8e386e5881c1d7aad1f85922752621bb96c1a/server/src/com/cloud/vm/UserVmManagerImpl.java",
                "sha": "86150a2ab9cc805c46627dd22e43b2b1a6c2614b",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/f5c8e386e5881c1d7aad1f85922752621bb96c1a/test/integration/smoke/test_deploy_vm_with_userdata.py",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_deploy_vm_with_userdata.py?ref=f5c8e386e5881c1d7aad1f85922752621bb96c1a",
                "deletions": 4,
                "filename": "test/integration/smoke/test_deploy_vm_with_userdata.py",
                "patch": "@@ -105,13 +105,13 @@ def test_deployvm_userdata_post(self):\n         vms = list_virtual_machines(\n             self.apiClient,\n             account=self.account.name,\n-            domainid=self.account.domainid\n+            domainid=self.account.domainid,\n+            id=deployVmResponse.id\n         )\n         self.assert_(len(vms) > 0, \"There are no Vms deployed in the account %s\" % self.account.name)\n         vm = vms[0]\n         self.assert_(vm.id == str(deployVmResponse.id), \"Vm deployed is different from the test\")\n         self.assert_(vm.state == \"Running\", \"VM is not in Running state\")\n-        self.cleanup.append(deployVmResponse)\n \n     @attr(tags=[\"simulator\", \"devcloud\", \"basic\", \"advanced\"])\n     def test_deployvm_userdata(self):\n@@ -129,13 +129,13 @@ def test_deployvm_userdata(self):\n         vms = list_virtual_machines(\n             self.apiClient,\n             account=self.account.name,\n-            domainid=self.account.domainid\n+            domainid=self.account.domainid,\n+            id=deployVmResponse.id\n         )\n         self.assert_(len(vms) > 0, \"There are no Vms deployed in the account %s\" % self.account.name)\n         vm = vms[0]\n         self.assert_(vm.id == str(deployVmResponse.id), \"Vm deployed is different from the test\")\n         self.assert_(vm.state == \"Running\", \"VM is not in Running state\")\n-        self.cleanup.append(deployVmResponse)\n \n     @classmethod\n     def tearDownClass(cls):",
                "raw_url": "https://github.com/apache/cloudstack/raw/f5c8e386e5881c1d7aad1f85922752621bb96c1a/test/integration/smoke/test_deploy_vm_with_userdata.py",
                "sha": "260106cbb0f53babe5a279c550c21e106678aa04",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-2379: Fix for issue destroy vm causing NPE. Made the following changes.\n1. Made a fix to make sure a null object is added to the exception.\n2. Also fixed the marvin test cases for the feature. Account cleanup will remove the vms deployed for the account. There is no need to explicitly delete the vms for the account.\n3. Fixed the assertion checks for the vm created for an account. If there are multiple vms for an account, the test script needs to compare the ids with the correct instance.",
        "parent": "https://github.com/apache/cloudstack/commit/612afbd17941ee840b1bba3e5951f89cafeea243",
        "repo": "cloudstack",
        "unit_tests": [
            "UserVmManagerImplTest.java"
        ]
    },
    "cloudstack_f60f3ce": {
        "bug_id": "cloudstack_f60f3ce",
        "commit": "https://github.com/apache/cloudstack/commit/f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 1,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -501,7 +501,7 @@ public SnapshotResponse createSnapshotResponse(Snapshot snapshot) {\n                 snapshotResponse.setZoneId(zone.getUuid());\n             }\n \n-            if (volume.getVolumeType() == Volume.Type.ROOT) {\n+            if (volume.getVolumeType() == Volume.Type.ROOT && volume.getInstanceId() != null) {\n                 //TODO combine lines and 489 into a join in the volume dao\n                 VMInstanceVO instance = ApiDBUtils.findVMInstanceById(volume.getInstanceId());\n                 if (instance != null) {",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "c10e2598386255191f9f4fc091cec31a215ae358",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cloud-nic.sh",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/cloud-nic.sh?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 1,
                "filename": "systemvm/debian/opt/cloud/bin/cloud-nic.sh",
                "patch": "@@ -69,7 +69,7 @@ unplug_nic() {\n \n action=$1\n dev=$2\n-tableNo=${dev:3}\n+tableNo=$((100+${dev:3}))\n tableName=\"Table_$dev\"\n \n if [ $action == 'add' ]",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cloud-nic.sh",
                "sha": "7d8bda83d2962f542b87ca7b1b77de5ccb8a213d",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cs/CsNetfilter.py",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/cs/CsNetfilter.py?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 1,
                "filename": "systemvm/debian/opt/cloud/bin/cs/CsNetfilter.py",
                "patch": "@@ -189,7 +189,8 @@ def compare(self, list):\n     def add_chain(self, rule):\n         \"\"\" Add the given chain if it is not already present \"\"\"\n         if not self.has_chain(rule.get_table(), rule.get_chain()):\n-            CsHelper.execute(\"iptables -t %s -N %s\" % (rule.get_table(), rule.get_chain()))\n+            if rule.get_chain():\n+                CsHelper.execute(\"iptables -t %s -N %s\" % (rule.get_table(), rule.get_chain()))\n             self.chain.add(rule.get_table(), rule.get_chain())\n \n     def del_standard(self):",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cs/CsNetfilter.py",
                "sha": "01dfa7cac39917f8dceb6630105b56ab93c8672a",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cs/CsRoute.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/cs/CsRoute.py?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 1,
                "filename": "systemvm/debian/opt/cloud/bin/cs/CsRoute.py",
                "patch": "@@ -30,7 +30,7 @@ def get_tablename(self, name):\n         return self.table_prefix + name\n \n     def add_table(self, devicename):\n-        tablenumber = devicename[3:]\n+        tablenumber = 100 + int(devicename[3:])\n         tablename = self.get_tablename(devicename)\n         str = \"%s %s\" % (tablenumber, tablename)\n         filename = \"/etc/iproute2/rt_tables\"",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cs/CsRoute.py",
                "sha": "47d3d2a91af532679c009db744e5520b94bea226",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cs/CsRule.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/cs/CsRule.py?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 1,
                "filename": "systemvm/debian/opt/cloud/bin/cs/CsRule.py",
                "patch": "@@ -27,7 +27,7 @@ class CsRule:\n \n     def __init__(self, dev):\n         self.dev = dev\n-        self.tableNo = int(dev[3:])\n+        self.tableNo = 100 + int(dev[3:])\n         self.table = \"Table_%s\" % (dev)\n \n     def addRule(self, rule):",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/cs/CsRule.py",
                "sha": "f1caa298904902e193d1a96225bbd99fd1e942e5",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/ipassoc.sh",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/ipassoc.sh?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 2,
                "filename": "systemvm/debian/opt/cloud/bin/ipassoc.sh",
                "patch": "@@ -103,7 +103,7 @@ remove_routing() {\n   logger -t cloud \"$(basename $0):Remove routing $pubIp on interface $ethDev\"\n   local ipNoMask=$(echo $pubIp | awk -F'/' '{print $1}')\n   local mask=$(echo $pubIp | awk -F'/' '{print $2}')\n-  local tableNo=$(echo $ethDev | awk -F'eth' '{print $2}')\n+  local tableNo=$((100+$(echo $ethDev | awk -F'eth' '{print $2}')))\n \n   local tableName=\"Table_$ethDev\"\n   local remainip=`ip addr show $ethDev | grep \"inet \"`\n@@ -149,7 +149,7 @@ add_routing() {\n \n   local tableName=\"Table_$ethDev\"\n   local tablePresent=$(grep $tableName /etc/iproute2/rt_tables)\n-  local tableNo=$(echo $ethDev | awk -F'eth' '{print $2}')\n+  local tableNo=$((100+$(echo $ethDev | awk -F'eth' '{print $2}')))\n   if [ \"$tablePresent\" == \"\" ]\n   then\n      if [ \"$tableNo\" == \"\" ]",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/ipassoc.sh",
                "sha": "9bcb13279d76e9b57bc69d172ad50ae4553a3550",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/update_config.py",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/systemvm/debian/opt/cloud/bin/update_config.py?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 9,
                "filename": "systemvm/debian/opt/cloud/bin/update_config.py",
                "patch": "@@ -30,7 +30,7 @@\n \n # first commandline argument should be the file to process\n if (len(sys.argv) != 2):\n-    print \"[ERROR]: Invalid usage\"\n+    logging.error(\"Invalid usage, args passed: %s\" % sys.argv)\n     sys.exit(1)\n \n # FIXME we should get this location from a configuration class\n@@ -47,7 +47,7 @@ def finish_config():\n \n \n def process_file():\n-    print \"[INFO] Processing JSON file %s\" % sys.argv[1]\n+    logging.info(\"Processing JSON file %s\" % sys.argv[1])\n     qf = QueueFile()\n     qf.setFile(sys.argv[1])\n     qf.load(None)\n@@ -70,7 +70,7 @@ def is_guestnet_configured(guestnet_dict, keys):\n         '''\n         It seems all the interfaces have been removed. Let's allow a new configuration to come in.\n         '''\n-        print \"[WARN] update_config.py :: Reconfiguring guest network...\"\n+        logging.warn(\"update_config.py :: Reconfiguring guest network...\")\n         return False\n \n     file = open(jsonConfigFile)\n@@ -80,7 +80,7 @@ def is_guestnet_configured(guestnet_dict, keys):\n         '''\n         Guest network has to be removed.\n         '''\n-        print \"[INFO] update_config.py :: Removing guest network...\"\n+        logging.info(\"update_config.py :: Removing guest network...\")\n         return False\n \n     '''\n@@ -121,7 +121,10 @@ def is_guestnet_configured(guestnet_dict, keys):\n     qf.load(None)\n \n if not (os.path.isfile(jsonConfigFile) and os.access(jsonConfigFile, os.R_OK)):\n-    print \"[ERROR] update_config.py :: Unable to read and access %s to process it\" % jsonConfigFile\n+    # Ignore if file is already processed\n+    if os.path.isfile(jsonPath % (\"processed/\" + jsonFilename + \".gz\")):\n+        sys.exit(0)\n+    logging.error(\"update_config.py :: Unable to read and access %s to process it\" % jsonConfigFile)\n     sys.exit(1)\n \n # If the guest network is already configured and have the same IP, do not try to configure it again otherwise it will break\n@@ -131,14 +134,14 @@ def is_guestnet_configured(guestnet_dict, keys):\n         guestnet_dict = json.load(file)\n \n         if not is_guestnet_configured(guestnet_dict, ['eth1', 'eth2', 'eth3', 'eth4', 'eth5', 'eth6', 'eth7', 'eth8', 'eth9']):\n-            print \"[INFO] update_config.py :: Processing Guest Network.\"\n+            logging.info(\"update_config.py :: Processing Guest Network.\")\n             process_file()\n         else:\n-            print \"[INFO] update_config.py :: No need to process Guest Network.\"\n+            logging.info(\"update_config.py :: No need to process Guest Network.\")\n             finish_config()\n     else:\n-        print \"[INFO] update_config.py :: No GuestNetwork configured yet. Configuring first one now.\"\n+        logging.info(\"update_config.py :: No GuestNetwork configured yet. Configuring first one now.\")\n         process_file()\n else:\n-    print \"[INFO] update_config.py :: Processing incoming file => %s\" % sys.argv[1]\n+    logging.info(\"update_config.py :: Processing incoming file => %s\" % sys.argv[1])\n     process_file()",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/systemvm/debian/opt/cloud/bin/update_config.py",
                "sha": "02161b662e52688cd31c6ff104c81b22b27beb1c",
                "status": "modified"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/test/integration/smoke/test_deploy_virtio_scsi_vm.py",
                "changes": 78,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_deploy_virtio_scsi_vm.py?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 43,
                "filename": "test/integration/smoke/test_deploy_virtio_scsi_vm.py",
                "patch": "@@ -25,35 +25,30 @@\n # base - contains all resources as entities and defines create, delete,\n # list operations on them\n from marvin.lib.base import (Account,\n-                            VirtualMachine,\n-                            ServiceOffering,\n-                            NetworkOffering,\n-                            Network,\n-                            Template,\n-                            DiskOffering,\n-                            StoragePool,\n-                            Volume,\n-                            Host,\n-                            GuestOs)\n-\n-\n+                             VirtualMachine,\n+                             ServiceOffering,\n+                             Template,\n+                             DiskOffering,\n+                             Volume,\n+                             Host,\n+                             GuestOs)\n \n # utils - utility classes for common cleanup, external library wrappers etc\n from marvin.lib.utils import cleanup_resources, get_hypervisor_type, validateList\n \n # common - commonly used methods for all tests are listed here\n-from marvin.lib.common import get_zone, get_domain, get_template, list_hosts, get_pod\n+from marvin.lib.common import get_zone, get_domain, get_pod\n \n from marvin.sshClient import SshClient\n \n-from marvin.codes import FAILED, PASS\n+from marvin.codes import FAILED\n \n from nose.plugins.attrib import attr\n \n import xml.etree.ElementTree as ET\n-import code\n import logging\n \n+\n class Templates:\n     \"\"\"Test data for templates\n     \"\"\"\n@@ -75,11 +70,12 @@ def __init__(self):\n             }\n         }\n \n-class TestDeployVirtioSCSIVM(cloudstackTestCase):\n \n+class TestDeployVirtioSCSIVM(cloudstackTestCase):\n     \"\"\"\n     Test deploy a kvm virtio scsi template\n     \"\"\"\n+\n     @classmethod\n     def setUpClass(cls):\n         cls.logger = logging.getLogger('TestDeployVirtioSCSIVM')\n@@ -100,7 +96,6 @@ def setUpClass(cls):\n         cls.zone = get_zone(cls.apiclient, testClient.getZoneForTests())\n         cls.pod = get_pod(cls.apiclient, cls.zone.id)\n         cls.services['mode'] = cls.zone.networktype\n-        cls._cleanup = []\n         if cls.hypervisor.lower() not in ['kvm']:\n             cls.hypervisorNotSupported = True\n             return\n@@ -153,41 +148,38 @@ def setUpClass(cls):\n \n         cls.vmhost = hosts[0]\n \n-\n+        # Stop VM to reset password\n+        cls.virtual_machine.stop(cls.apiclient)\n \n         password = cls.virtual_machine.resetPassword(cls.apiclient)\n         cls.virtual_machine.username = \"ubuntu\"\n         cls.virtual_machine.password = password\n-        cls._cleanup = [\n+\n+        # Start VM after password reset\n+        cls.virtual_machine.start(cls.apiclient)\n+\n+        cls.cleanup = [\n             cls.template,\n             cls.service_offering,\n             cls.sparse_disk_offering,\n             cls.account\n         ]\n \n-\n     @classmethod\n     def tearDownClass(cls):\n         try:\n+            cls.apiclient = super(\n+                TestDeployVirtioSCSIVM,\n+                cls\n+            ).getClsTestClient().getApiClient()\n             # Cleanup resources used\n-            cleanup_resources(cls.apiclient, cls._cleanup)\n+            cleanup_resources(cls.apiclient, cls.cleanup)\n         except Exception as e:\n             raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n-        return\n \n     def setUp(self):\n         self.apiclient = self.testClient.getApiClient()\n         self.dbclient = self.testClient.getDbConnection()\n-        self.cleanup = []\n-        return\n-\n-    def tearDown(self):\n-        try:\n-            # Clean up, terminate the created instance, volumes and snapshots\n-            cleanup_resources(self.apiclient, self.cleanup)\n-        except Exception as e:\n-            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n-        return\n \n     def verifyVirshState(self, diskcount):\n         host = self.vmhost.ipaddress\n@@ -212,14 +204,14 @@ def verifyVirshState(self, diskcount):\n             for child in disk:\n                 if child.tag.lower() == \"target\":\n                     dev = child.get(\"dev\")\n-                    self.assert_(dev != None and dev.startswith(\"sd\"), \"disk dev is invalid\")\n+                    self.assert_(dev is not None and dev.startswith(\"sd\"), \"disk dev is invalid\")\n                 elif child.tag.lower() == \"address\":\n                     con = child.get(\"controller\")\n                     self.assertEqual(con, scsiindex, \"disk controller not equal to SCSI \" \\\n-                                     \"controller index\")\n+                                                     \"controller index\")\n                 elif child.tag.lower() == \"driver\":\n                     discard = child.get(\"discard\")\n-                    if discard: # may not be defined by older qemu/libvirt\n+                    if discard:  # may not be defined by older qemu/libvirt\n                         self.assertEqual(discard, \"unmap\", \"discard settings not unmap\")\n \n     def verifyGuestState(self, diskcount):\n@@ -234,21 +226,21 @@ def verifyGuestState(self, diskcount):\n                          \"Could not find appropriate number of scsi disks in guest\")\n \n     def getVirshXML(self, host, instancename):\n-        if host == None:\n+        if host is None:\n             self.logger.debug(\"getVirshXML: host is none\")\n             return \"\"\n         else:\n             self.logger.debug(\"host is: \" + host)\n-        if instancename == None:\n+        if instancename is None:\n             self.logger.debug(\"getVirshXML: instancename is none\")\n             return \"\"\n         else:\n             self.logger.debug(\"instancename is: \" + instancename)\n         sshc = SshClient(\n-                host=host,\n-                port=self.services['configurableData']['host'][\"publicport\"],\n-                user=self.hostConfig['username'],\n-                passwd=self.hostConfig['password'])\n+            host=host,\n+            port=self.services['configurableData']['host'][\"publicport\"],\n+            user=self.hostConfig['username'],\n+            passwd=self.hostConfig['password'])\n \n         ssh = sshc.ssh\n \n@@ -354,9 +346,8 @@ def test_05_change_vm_ostype_restart(self):\n         self.assertIsNotNone(ostypeid,\n                              \"Could not find ostypeid for Ubuntu 16.0.4 (64-bit) mapped to kvm\")\n \n-\n         self.virtual_machine.update(self.apiclient, ostypeid=ostypeid,\n-                                    details=[{\"rootDiskController\":\"scsi\"}])\n+                                    details=[{\"rootDiskController\": \"scsi\"}])\n \n         self.virtual_machine.start(self.apiclient)\n \n@@ -371,6 +362,7 @@ def test_06_verify_guest_lspci_again(self):\n \n         self.verifyGuestState(3)\n \n+\n class CommandNonzeroException(Exception):\n     def __init__(self, code, stderr):\n         self.code = code",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/test/integration/smoke/test_deploy_virtio_scsi_vm.py",
                "sha": "df54c4307a9cb7756474564c91c9cdc6f9cd1f59",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/test/integration/smoke/test_vm_life_cycle.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_vm_life_cycle.py?ref=f60f3cec34d0f2471d08cf07b936f7511b5e7eec",
                "deletions": 1,
                "filename": "test/integration/smoke/test_vm_life_cycle.py",
                "patch": "@@ -918,7 +918,7 @@ def secure_all_hosts(self):\n             cmd = provisionCertificate.provisionCertificateCmd()\n             cmd.hostid = host.id\n             cmd.reconnect = True\n-            self.apiclient.updateConfiguration(cmd)\n+            self.apiclient.provisionCertificate(cmd)\n \n         for host in self.hosts:\n             self.check_connection(secured='true', host=host)",
                "raw_url": "https://github.com/apache/cloudstack/raw/f60f3cec34d0f2471d08cf07b936f7511b5e7eec/test/integration/smoke/test_vm_life_cycle.py",
                "sha": "5906a94869ccb9abb78de17edf29f24c6850f749",
                "status": "modified"
            }
        ],
        "message": "router: Fixes #2789 fix proper mark based packet routing across interfaces (#2791)\n\nPreviously, the ethernet device index was used as rt_table index and\r\npacket marking id/integer. With eth0 that is sometimes used as link-local\r\ninterface, the rt_table index `0` would fail as `0` is already defined\r\nas a catchall (unspecified). The fwmarking on packets on eth0 with 0x0\r\nwould also fail. This fixes the routing issues, by adding 100 to the\r\nethernet device index so the value is a non-zero, for example then the\r\nrelationship between rt_table index and ethernet would be like:\r\n\r\n100 -> Table_eth0 -> eth0 -> fwmark 100 or 0x64\r\n101 -> Table_eth1 -> eth1 -> fwmark 101 or 0x65\r\n102 -> Table_eth2 -> eth2 -> fwmark 102 or 0x66\r\n\r\nThis would maintain the legacy design of routing based on packet mark\r\nand appropriate routing table rules per table/ids. This also fixes a\r\nminor NPE issue around listing of snapshots.\r\n\r\nThis also backports fixes to smoketests from master.\r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/33a6ea0c8788d5daf559eb817eacd18c0e863679",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_f661b63": {
        "bug_id": "cloudstack_f661b63",
        "commit": "https://github.com/apache/cloudstack/commit/f661b631a13ba7f0c501eb5d1915eab3d097a37e",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/f661b631a13ba7f0c501eb5d1915eab3d097a37e/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java?ref=f661b631a13ba7f0c501eb5d1915eab3d097a37e",
                "deletions": 0,
                "filename": "engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "patch": "@@ -1523,6 +1523,8 @@ public NicProfile prepareNic(final VirtualMachineProfile vmProfile, final Deploy\n             nic.setIPv4Address(profile.getIPv4Address());\n             nic.setAddressFormat(profile.getFormat());\n             nic.setIPv6Address(profile.getIPv6Address());\n+            nic.setIPv6Cidr(profile.getIPv6Cidr());\n+            nic.setIPv6Gateway(profile.getIPv6Gateway());\n             nic.setMacAddress(profile.getMacAddress());\n             nic.setIsolationUri(profile.getIsolationUri());\n             nic.setBroadcastUri(profile.getBroadCastUri());",
                "raw_url": "https://github.com/apache/cloudstack/raw/f661b631a13ba7f0c501eb5d1915eab3d097a37e/engine/orchestration/src/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java",
                "sha": "a2505fbe638e95ca16fabbeb1e09488b9514b973",
                "status": "modified"
            }
        ],
        "message": "ipv6: Set IPv6 CIDR and Gateway in 'nic' profile\n\nWithout this information a NPE might be triggered when starting a VR, SSVM or CP\nas this information is read from the 'nics' table and causes a NPE.\n\nDuring deployment we should set the IPv6 Gateway and CIDR for the NIC object so that\nit is persisted to the database.\n\nSigned-off-by: Wido den Hollander <wido@widodh.nl>",
        "parent": "https://github.com/apache/cloudstack/commit/17787a194a54f218aacbd443909313041d7a69c3",
        "repo": "cloudstack",
        "unit_tests": [
            "NetworkOrchestratorTest.java"
        ]
    },
    "cloudstack_f68b6e8": {
        "bug_id": "cloudstack_f68b6e8",
        "commit": "https://github.com/apache/cloudstack/commit/f68b6e831221a892f312fac380b39c8b18bc57d5",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f68b6e831221a892f312fac380b39c8b18bc57d5/server/src/com/cloud/template/TemplateManagerImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/TemplateManagerImpl.java?ref=f68b6e831221a892f312fac380b39c8b18bc57d5",
                "deletions": 1,
                "filename": "server/src/com/cloud/template/TemplateManagerImpl.java",
                "patch": "@@ -1740,7 +1740,7 @@ public VMTemplateVO createPrivateTemplateRecord(CreateTemplateCmd cmd, Account t\n \n             if (sourceTemplateId != null) {\n                 VMTemplateVO sourceTemplate = _tmpltDao.findById(sourceTemplateId);\n-                if(sourceTemplate != null){\n+                if (sourceTemplate != null && sourceTemplate.getDetails() != null) {\n                     details.putAll(sourceTemplate.getDetails());\n                 }\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/f68b6e831221a892f312fac380b39c8b18bc57d5/server/src/com/cloud/template/TemplateManagerImpl.java",
                "sha": "7130042bc5c8153324989d7a956fb46ce8a3bfe0",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1846 from shapeblue/49smoketest-fixes\n\nCLOUDSTACK-9688: Fix failing smoke testsFixes failing smoke tests due to enviroment issues or corner cases:\n- Fixes NPE in Template Manager\n\n@blueorangutan package\n\n* pr/1846:\n  CLOUDSTACK-9688: Fix failing smoke tests\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/5e19e64f2f24d90d8f15d30b82d2a066061425a7",
        "repo": "cloudstack",
        "unit_tests": [
            "TemplateManagerImplTest.java"
        ]
    },
    "cloudstack_f803100": {
        "bug_id": "cloudstack_f803100",
        "commit": "https://github.com/apache/cloudstack/commit/f8031008139978abb6831a1d7cb240c993fbf8f5",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/f8031008139978abb6831a1d7cb240c993fbf8f5/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java?ref=f8031008139978abb6831a1d7cb240c993fbf8f5",
                "deletions": 1,
                "filename": "plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "patch": "@@ -1899,7 +1899,7 @@ public Answer execute(ResizeVolumeCommand cmd) {\n             s_logger.debug(\"after resize, size reports as \" + finalSize + \", requested \" + newSize);\n             return new ResizeVolumeAnswer(cmd, true, \"success\", finalSize);\n         } catch (CloudRuntimeException e) {\n-            String error = \"failed to resize volume: \" + e;\n+            String error = \"Failed to resize volume: \" + e.getMessage();\n             s_logger.debug(error);\n             return new ResizeVolumeAnswer(cmd, false, error);\n         }",
                "raw_url": "https://github.com/apache/cloudstack/raw/f8031008139978abb6831a1d7cb240c993fbf8f5/plugins/hypervisors/kvm/src/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java",
                "sha": "f6fe75cd5911e9c5576c622eb2743a264249c05d",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/f8031008139978abb6831a1d7cb240c993fbf8f5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java?ref=f8031008139978abb6831a1d7cb240c993fbf8f5",
                "deletions": 2,
                "filename": "plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "patch": "@@ -564,7 +564,8 @@ private Answer execute(ResizeVolumeCommand cmd) {\n             VirtualDisk disk = vdisk.first();\n             long oldSize = disk.getCapacityInKB();\n             if (newSize < oldSize) {\n-                throw new Exception(\"VMware doesn't support shrinking volume from larger size: \" + oldSize + \" MB to a smaller size: \" + newSize + \" MB\");\n+                throw new Exception(\"VMware doesn't support shrinking volume from larger size: \" + oldSize/(1024*1024) + \" GB to a smaller size: \"\n+                        + newSize/(1024*1024) + \" GB\");\n             } else if (newSize == oldSize) {\n                 return new ResizeVolumeAnswer(cmd, true, \"success\", newSize * 1024);\n             }\n@@ -582,7 +583,7 @@ private Answer execute(ResizeVolumeCommand cmd) {\n             return new ResizeVolumeAnswer(cmd, true, \"success\", newSize * 1024);\n         } catch (Exception e) {\n             s_logger.error(\"Unable to resize volume\", e);\n-            String error = \"failed to resize volume:\" + e;\n+            String error = \"Failed to resize volume: \" + e.getMessage();\n             return new ResizeVolumeAnswer(cmd, false, error);\n         }\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/f8031008139978abb6831a1d7cb240c993fbf8f5/plugins/hypervisors/vmware/src/com/cloud/hypervisor/vmware/resource/VmwareResource.java",
                "sha": "8a2488dd3f88601b646f76420c8f19af3c8593ef",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/cloudstack/blob/f8031008139978abb6831a1d7cb240c993fbf8f5/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/VolumeApiServiceImpl.java?ref=f8031008139978abb6831a1d7cb240c993fbf8f5",
                "deletions": 6,
                "filename": "server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "patch": "@@ -925,6 +925,9 @@ public VolumeVO resizeVolume(ResizeVolumeCmd cmd) throws ResourceAllocationExcep\n                     if (jobResult instanceof ConcurrentOperationException) {\n                         throw (ConcurrentOperationException)jobResult;\n                     }\n+                    else if (jobResult instanceof RuntimeException) {\n+                        throw (RuntimeException)jobResult;\n+                    }\n                     else if (jobResult instanceof Throwable) {\n                         throw new RuntimeException(\"Unexpected exception\", (Throwable)jobResult);\n                     }\n@@ -1000,7 +1003,11 @@ private VolumeVO orchestrateResizeVolume(long volumeId, long currentSize, long n\n             VolumeApiResult result = future.get();\n             if (result.isFailed()) {\n                 s_logger.warn(\"Failed to resize the volume \" + volume);\n-                return null;\n+                String details = \"\";\n+                if (result.getResult() != null && !result.getResult().isEmpty()) {\n+                    details = result.getResult();\n+                }\n+                throw new CloudRuntimeException(details);\n             }\n \n             volume = _volsDao.findById(volume.getId());\n@@ -1029,16 +1036,12 @@ private VolumeVO orchestrateResizeVolume(long volumeId, long currentSize, long n\n             } else {\n                 _resourceLimitMgr.decrementResourceCount(volume.getAccountId(), ResourceType.primary_storage, volume.isDisplayVolume(), new Long(currentSize - newSize));\n             }\n-            return volume;\n         } catch (InterruptedException e) {\n             s_logger.warn(\"failed get resize volume result\", e);\n         } catch (ExecutionException e) {\n             s_logger.warn(\"failed get resize volume result\", e);\n-        } catch (Exception e) {\n-            s_logger.warn(\"failed get resize volume result\", e);\n         }\n-\n-        return null;\n+        return volume;\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/cloudstack/raw/f8031008139978abb6831a1d7cb240c993fbf8f5/server/src/com/cloud/storage/VolumeApiServiceImpl.java",
                "sha": "5a83ac9d0550fedf26f1b64c6b8ee9545a4e9d9a",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-6969. Data Volume Shrink operation failing with \"Unexpected Exception\".\nFor ResizeVolume API command -\n1. If hypervisor resource throws an exception, handle the NPE thrown by the job framework.\n2. Improve user error message in case of RuntimeException by throwing the exception instead of 'Unexpected Exception'.",
        "parent": "https://github.com/apache/cloudstack/commit/fca41bf527372018dc2faaae03b9d37eb564b66a",
        "repo": "cloudstack",
        "unit_tests": [
            "LibvirtComputingResourceTest.java",
            "VmwareResourceTest.java",
            "VolumeApiServiceImplTest.java"
        ]
    },
    "cloudstack_f8e40ad": {
        "bug_id": "cloudstack_f8e40ad",
        "commit": "https://github.com/apache/cloudstack/commit/f8e40ad43ffd6ead9cf764426c1684bf3b679367",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/f8e40ad43ffd6ead9cf764426c1684bf3b679367/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java?ref=f8e40ad43ffd6ead9cf764426c1684bf3b679367",
                "deletions": 1,
                "filename": "engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "patch": "@@ -1748,6 +1748,10 @@ private void orchestrateStorageMigration(final String vmUuid, final StoragePool\n         final HostVO srcHost = _hostDao.findById(srchostId);\n         final Long srcClusterId = srcHost.getClusterId();\n \n+        if (destPool == null) {\n+            throw new CloudRuntimeException(\"Unable to migrate vm: missing destination storage pool\");\n+        }\n+\n         try {\n             stateTransitTo(vm, VirtualMachine.Event.StorageMigrationRequested, null);\n         } catch (final NoTransitionException e) {\n@@ -1763,7 +1767,7 @@ private void orchestrateStorageMigration(final String vmUuid, final StoragePool\n             if (migrationResult) {\n                 //if the vm is migrated to different pod in basic mode, need to reallocate ip\n \n-                if (!vm.getPodIdToDeployIn().equals(destPool.getPodId())) {\n+                if (destPool.getPodId() != null && !destPool.getPodId().equals(vm.getPodIdToDeployIn())) {\n                     final DataCenterDeployment plan = new DataCenterDeployment(vm.getDataCenterId(), destPool.getPodId(), null, null, null, null);\n                     final VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vm, null, null, null, null);\n                     _networkMgr.reallocate(vmProfile, plan);",
                "raw_url": "https://github.com/apache/cloudstack/raw/f8e40ad43ffd6ead9cf764426c1684bf3b679367/engine/orchestration/src/com/cloud/vm/VirtualMachineManagerImpl.java",
                "sha": "f972539fc7dd430bfd448200a5daac51f4a393dc",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #918 from ustcweizhou/NPE-storage-migration\n\nCLOUDSTACK-8941: fix NPE when migrate vm to other zone-wide pools the second timeThis is because the pod_id is set to NULL at the first time when I migrate the instance to a zone-wide pool (not cluster-wide).\n\n* pr/918:\n  CLOUDSTACK-8941: fix NPE when migrate vm to other zone-wide pools the second time\n\nSigned-off-by: Remi Bergsma <github@remi.nl>",
        "parent": "https://github.com/apache/cloudstack/commit/d538e438e77d4514cf452b453dcbc72ebdfe0dc4",
        "repo": "cloudstack",
        "unit_tests": [
            "VirtualMachineManagerImplTest.java"
        ]
    },
    "cloudstack_fa499da": {
        "bug_id": "cloudstack_fa499da",
        "commit": "https://github.com/apache/cloudstack/commit/fa499dadbcaf5db6718668c41073a06d5986f4ac",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa499dadbcaf5db6718668c41073a06d5986f4ac/server/src/com/cloud/storage/snapshot/SnapshotManager.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/snapshot/SnapshotManager.java?ref=fa499dadbcaf5db6718668c41073a06d5986f4ac",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/snapshot/SnapshotManager.java",
                "patch": "@@ -90,7 +90,7 @@\n      * @param policyIds  The list of policyIds to which this snapshot belongs to\n      * @param backedUp   If true, the snapshot has been successfully created.\n      */\n-    void postCreateSnapshot(long volumeId, long snapshotId, long policyId, boolean backedUp);\n+    void postCreateSnapshot(Long volumeId, Long snapshotId, Long policyId, boolean backedUp);\n     \n     /**\n      * Destroys the specified snapshot from secondary storage\n@@ -115,7 +115,7 @@\n     /**\n      * Deletes snapshot scheduling policy. Delete will fail if this policy is assigned to one or more volumes\n      */\n-    boolean deletePolicy(long userId, long policyId);\n+    boolean deletePolicy(long userId, Long policyId);\n     \n     /**\n      * Lists all snapshots for the volume which are created using schedule of the specified policy",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa499dadbcaf5db6718668c41073a06d5986f4ac/server/src/com/cloud/storage/snapshot/SnapshotManager.java",
                "sha": "7f8a7b6750096173d3abdea2d45daa8d27e39837",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa499dadbcaf5db6718668c41073a06d5986f4ac/server/src/com/cloud/storage/snapshot/SnapshotManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/snapshot/SnapshotManagerImpl.java?ref=fa499dadbcaf5db6718668c41073a06d5986f4ac",
                "deletions": 3,
                "filename": "server/src/com/cloud/storage/snapshot/SnapshotManagerImpl.java",
                "patch": "@@ -528,7 +528,7 @@ private Long getSnapshotUserId(){\n     \n     @Override\n     @DB\n-    public void postCreateSnapshot(long volumeId, long snapshotId, long policyId, boolean backedUp) {\n+    public void postCreateSnapshot(Long volumeId, Long snapshotId, Long policyId, boolean backedUp) {\n         Long userId = getSnapshotUserId();\n         // Update the snapshot_policy_ref table with the created snapshot\n         // Get the list of policies for this snapshot\n@@ -918,7 +918,7 @@ public SnapshotPolicyVO createPolicy(CreateSnapshotPolicyCmd cmd) throws Invalid\n     }\n \n     @Override\n-    public boolean deletePolicy(long userId, long policyId) {\n+    public boolean deletePolicy(long userId, Long policyId) {\n         SnapshotPolicyVO snapshotPolicy = _snapshotPolicyDao.findById(policyId);\n         VolumeVO volume = _volsDao.findById(snapshotPolicy.getVolumeId());\n         _snapSchedMgr.removeSchedule(snapshotPolicy.getVolumeId(), snapshotPolicy.getId());\n@@ -1122,7 +1122,7 @@ public boolean deleteSnapshotPolicies(DeleteSnapshotPoliciesCmd cmd) throws Inva\n \t\t    throw new InvalidParameterValueException(\"Invalid Policy id given: \" + Snapshot.MANUAL_POLICY_ID);\n \t\t}\n \t\t\n-\t\tfor (long pId : policyIds) {\n+\t\tfor (Long pId : policyIds) {\n \t\t\tif (!deletePolicy(userId, pId)) {\n \t\t\t\tsuccess = false;\n \t\t\t\ts_logger.warn(\"Failed to delete snapshot policy with Id: \" + policyId);",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa499dadbcaf5db6718668c41073a06d5986f4ac/server/src/com/cloud/storage/snapshot/SnapshotManagerImpl.java",
                "sha": "3eed1ee74013b54f4c19bf2ae9e35cc90bccef92",
                "status": "modified"
            }
        ],
        "message": "bug 7220: the parameter type transfer may cause NPE\n\nstatus 7220: resolved fixed",
        "parent": "https://github.com/apache/cloudstack/commit/a5dfaaf31b07f7b856381d4536a26e808a58967b",
        "repo": "cloudstack",
        "unit_tests": [
            "SnapshotManagerTest.java"
        ]
    },
    "cloudstack_fa7c1e2": {
        "bug_id": "cloudstack_fa7c1e2",
        "commit": "https://github.com/apache/cloudstack/commit/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/api/src/org/apache/cloudstack/api/response/HostHAResponse.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/api/src/org/apache/cloudstack/api/response/HostHAResponse.java?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 0,
                "filename": "api/src/org/apache/cloudstack/api/response/HostHAResponse.java",
                "patch": "@@ -84,6 +84,9 @@ public void setEnabled(Boolean enabled) {\n \n     public void setHaState(HAConfig.HAState haState) {\n         this.haState = haState;\n+        if (haState == null) {\n+            this.haState = HAConfig.HAState.Disabled;\n+        }\n     }\n \n     public String getProvider() {",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/api/src/org/apache/cloudstack/api/response/HostHAResponse.java",
                "sha": "a8b44bd5649667e4f5f126aa55335717bdcea194",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/engine/schema/src/com/cloud/upgrade/dao/Upgrade41000to41100.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/engine/schema/src/com/cloud/upgrade/dao/Upgrade41000to41100.java?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 8,
                "filename": "engine/schema/src/com/cloud/upgrade/dao/Upgrade41000to41100.java",
                "patch": "@@ -167,7 +167,6 @@ private void updateSystemVmTemplates(final Connection conn) {\n \n         final Map<Hypervisor.HypervisorType, String> newTemplateUrl = new HashMap<Hypervisor.HypervisorType, String>() {\n             {\n-                // FIXME: upload templates\n                 put(Hypervisor.HypervisorType.KVM, \"https://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.0-kvm.qcow2.bz2\");\n                 put(Hypervisor.HypervisorType.VMware, \"https://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.0-vmware.ova\");\n                 put(Hypervisor.HypervisorType.XenServer, \"https://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.0-xen.vhd.bz2\");\n@@ -179,13 +178,12 @@ private void updateSystemVmTemplates(final Connection conn) {\n \n         final Map<Hypervisor.HypervisorType, String> newTemplateChecksum = new HashMap<Hypervisor.HypervisorType, String>() {\n             {\n-                // FIXME: update checksums?\n-                put(Hypervisor.HypervisorType.KVM, \"bc2eac46f16a2ece6c19d4b89db41de3\");\n-                put(Hypervisor.HypervisorType.XenServer, \"908c28a8d4c232f960e0f84af7f86c80\");\n-                put(Hypervisor.HypervisorType.VMware, \"970bfb070a80bd74820881d8149643c1\");\n-                put(Hypervisor.HypervisorType.Hyperv, \"0adb35bd9f92e80d3fc63fcdd9bb55e5\");\n-                put(Hypervisor.HypervisorType.LXC, \"bc2eac46f16a2ece6c19d4b89db41de3\");\n-                put(Hypervisor.HypervisorType.Ovm3, \"94a41f0a5361933813bb34a51df56f56\");\n+                put(Hypervisor.HypervisorType.KVM, \"2d8d1e4eacc976814b97f02849481433\");\n+                put(Hypervisor.HypervisorType.XenServer, \"a5ecf7ed485e2da5ec1993069aa60553\");\n+                put(Hypervisor.HypervisorType.VMware, \"84dab5d1e8267b5dc85eb4eaa21a1efe\");\n+                put(Hypervisor.HypervisorType.Hyperv, \"d592ab6a2271303fe75b6a27f8e6bd53\");\n+                put(Hypervisor.HypervisorType.LXC, \"2d8d1e4eacc976814b97f02849481433\");\n+                put(Hypervisor.HypervisorType.Ovm3, \"60fe2227b89a8980ee09f89dc7b19582\");\n             }\n         };\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/engine/schema/src/com/cloud/upgrade/dao/Upgrade41000to41100.java",
                "sha": "53c2340665f387260aaac338a8e6fff8934e11bc",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/packaging/centos63/cloud.spec",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/packaging/centos63/cloud.spec?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 2,
                "filename": "packaging/centos63/cloud.spec",
                "patch": "@@ -130,8 +130,6 @@ Requires: perl\n Requires: libvirt-python\n Requires: qemu-img\n Requires: qemu-kvm\n-Requires: epel-release\n-Requires: aria2\n Provides: cloud-agent\n Obsoletes: cloud-agent < 4.1.0\n Obsoletes: cloud-agent-libs < 4.1.0",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/packaging/centos63/cloud.spec",
                "sha": "898118fa96df23b4e48ff37539a27f38d2bb05bf",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/packaging/centos7/cloud.spec",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/packaging/centos7/cloud.spec?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 2,
                "filename": "packaging/centos7/cloud.spec",
                "patch": "@@ -111,8 +111,6 @@ Requires: perl\n Requires: libvirt-python\n Requires: qemu-img\n Requires: qemu-kvm\n-Requires: epel-release\n-Requires: aria2\n Provides: cloud-agent\n Group: System Environment/Libraries\n %description agent",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/packaging/centos7/cloud.spec",
                "sha": "f16858a4a8f15a28d7736b08f448d3dd6e06ae60",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/server/src/com/cloud/template/HypervisorTemplateAdapter.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/template/HypervisorTemplateAdapter.java?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 5,
                "filename": "server/src/com/cloud/template/HypervisorTemplateAdapter.java",
                "patch": "@@ -451,6 +451,7 @@ public boolean delete(TemplateProfile profile) {\n \n         if (imageStores == null || imageStores.size() == 0) {\n             // already destroyed on image stores\n+            success = true;\n             s_logger.info(\"Unable to find image store still having template: \" + template.getName() + \", so just mark the template removed\");\n         } else {\n             // Make sure the template is downloaded to all found image stores\n@@ -536,10 +537,7 @@ public boolean delete(TemplateProfile profile) {\n                                 templateZoneDao.remove(templateZone.getId());\n                             }\n                         }\n-                    } catch (InterruptedException e) {\n-                        s_logger.debug(\"Delete template Failed\", e);\n-                        throw new CloudRuntimeException(\"Delete template Failed\", e);\n-                    } catch (ExecutionException e) {\n+                    } catch (InterruptedException|ExecutionException e) {\n                         s_logger.debug(\"Delete template Failed\", e);\n                         throw new CloudRuntimeException(\"Delete template Failed\", e);\n                     }\n@@ -551,7 +549,7 @@ public boolean delete(TemplateProfile profile) {\n \n         }\n         if (success) {\n-            if ((imageStores.size() > 1) && (profile.getZoneIdList() != null)) {\n+            if ((imageStores != null && imageStores.size() > 1) && (profile.getZoneIdList() != null)) {\n                 //if template is stored in more than one image stores, and the zone id is not null, then don't delete other templates.\n                 return success;\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/server/src/com/cloud/template/HypervisorTemplateAdapter.java",
                "sha": "bfa73af6bcd3812f732fab28a19528a4b65c946c",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/server/src/org/apache/cloudstack/ha/HAManagerImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/org/apache/cloudstack/ha/HAManagerImpl.java?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 1,
                "filename": "server/src/org/apache/cloudstack/ha/HAManagerImpl.java",
                "patch": "@@ -199,13 +199,16 @@ private boolean checkHAOwnership(final HAConfig haConfig) {\n \n     private HAResource validateAndFindHAResource(final HAConfig haConfig) {\n         HAResource resource = null;\n+        if (haConfig == null) {\n+            return null;\n+        }\n         if (haConfig.getResourceType() == HAResource.ResourceType.Host) {\n             final Host host = hostDao.findById(haConfig.getResourceId());\n             if (host != null && host.getRemoved() != null) {\n                 return null;\n             }\n             resource = host;\n-            if (resource == null && haConfig.getState() != HAConfig.HAState.Disabled) {\n+            if (haConfig.getState() == null || (resource == null && haConfig.getState() != HAConfig.HAState.Disabled)) {\n                 disableHA(haConfig.getResourceId(), haConfig.getResourceType());\n                 return null;\n             }\n@@ -224,6 +227,9 @@ private HAResource validateAndFindHAResource(final HAConfig haConfig) {\n     }\n \n     private HAProvider<HAResource> validateAndFindHAProvider(final HAConfig haConfig, final HAResource resource) {\n+        if (haConfig == null) {\n+            return null;\n+        }\n         final HAProvider<HAResource> haProvider = haProviderMap.get(haConfig.getHaProvider());\n         if (haProvider != null && !haProvider.isEligible(resource)) {\n             if (haConfig.getState() != HAConfig.HAState.Ineligible) {\n@@ -639,6 +645,10 @@ protected void runInContext() {\n                 }\n                 final List<HAConfig> haConfigList = new ArrayList<HAConfig>(haConfigDao.listAll());\n                 for (final HAConfig haConfig : haConfigList) {\n+                    if (haConfig == null) {\n+                        continue;\n+                    }\n+\n                     if (!checkHAOwnership(haConfig)) {\n                         continue;\n                     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/server/src/org/apache/cloudstack/ha/HAManagerImpl.java",
                "sha": "86ac0376de430b9f815ea1fcc700d6ee7a21e7a3",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_hostha_simulator.py",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_hostha_simulator.py?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 0,
                "filename": "test/integration/smoke/test_hostha_simulator.py",
                "patch": "@@ -352,6 +352,7 @@ def test_ha_configure_enabledisable_across_clusterzones(self):\n             Zone > Cluster > Host\n         \"\"\"\n         host = self.getHost()\n+        self.configureAndDisableHostHa(host.id)\n         self.configureAndEnableHostHa()\n \n         self.checkSyncToState('Available')",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_hostha_simulator.py",
                "sha": "4dfb9e9ba6c095b6f0946772c326876b161a1113",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_public_ip_range.py",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_public_ip_range.py?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 8,
                "filename": "test/integration/smoke/test_public_ip_range.py",
                "patch": "@@ -218,7 +218,7 @@ def checkSystemVMUp():\n                     return True, response[0].id\n             return False, None\n \n-        res, systemvmId = wait_until(3, 100, checkSystemVMUp)\n+        res, systemvmId = wait_until(3, 200, checkSystemVMUp)\n         if not res:\n             raise Exception(\"Failed to wait for systemvm to be running\")\n         return systemvmId\n@@ -336,13 +336,13 @@ def exists_public_ip_range_for_system_vms(self, zoneid):\n         return False\n \n     @attr(tags = [\"advanced\", \"publiciprange\", \"dedicate\", \"release\"], required_hardware=\"false\")\n-    def test_dedicate_public_ip_range_for_system_vms_cpvm(self):\n-        \"\"\"Test CPVM Public IP\n+    def test_dedicate_public_ip_range_for_system_vms_01_ssvm(self):\n+        \"\"\"Test SSVM Public IP\n         \"\"\"\n         self.debug(\"Precondition: No public IP range dedicated for system vms in the environment\")\n         if self.exists_public_ip_range_for_system_vms(self.services[\"zoneid\"]):\n             self.skipTest(\"An existing IP range defined for system vms, aborting test\")\n-        \n+\n         services = {\n             \"gateway\":\"192.168.100.1\",\n             \"netmask\":\"255.255.255.0\",\n@@ -355,13 +355,13 @@ def test_dedicate_public_ip_range_for_system_vms_cpvm(self):\n \n         self.base_system_vm(\n             services,\n-            'consoleproxy'\n+            'secondarystoragevm'\n         )\n         return\n \n     @attr(tags = [\"advanced\", \"publiciprange\", \"dedicate\", \"release\"], required_hardware=\"false\")\n-    def test_dedicate_public_ip_range_for_system_vms_ssvm(self):\n-        \"\"\"Test SSVM Public IP\n+    def test_dedicate_public_ip_range_for_system_vms_02_cpvm(self):\n+        \"\"\"Test CPVM Public IP\n         \"\"\"\n         self.debug(\"Precondition: No public IP range dedicated for system vms in the environment\")\n         if self.exists_public_ip_range_for_system_vms(self.services[\"zoneid\"]):\n@@ -379,6 +379,6 @@ def test_dedicate_public_ip_range_for_system_vms_ssvm(self):\n \n         self.base_system_vm(\n             services,\n-            'secondarystoragevm'\n+            'consoleproxy'\n         )\n         return",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_public_ip_range.py",
                "sha": "92b35ad3fa4ffc69f04d56909805ee86ef35f04a",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_ssvm.py",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_ssvm.py?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 8,
                "filename": "test/integration/smoke/test_ssvm.py",
                "patch": "@@ -198,7 +198,6 @@ def test_01_list_sec_storage_vm(self):\n                 True,\n                 \"Check list response returns a valid list\"\n             )\n-            iprange = ipranges_response[0]\n \n             # Fetch corresponding Physical Network of SSVM's Zone\n             listphyntwk = PhysicalNetwork.list(\n@@ -213,9 +212,14 @@ def test_01_list_sec_storage_vm(self):\n                         self.apiclient,\n                         physicalnetworkid=listphyntwk[0].id),\n                     list) is True):\n-                self.assertEqual(\n-                    ssvm.gateway,\n-                    iprange.gateway,\n+                gatewayFound = False\n+                for iprange in ipranges_response:\n+                    if ssvm.gateway == iprange.gateway:\n+                        gatewayFound = True\n+                        break\n+\n+                self.assertTrue(\n+                    gatewayFound,\n                     \"Check gateway with that of corresponding ip range\"\n                 )\n \n@@ -333,7 +337,6 @@ def test_02_list_cpvm_vm(self):\n                 True,\n                 \"Check list response returns a valid list\"\n             )\n-            iprange = ipranges_response[0]\n \n             # Fetch corresponding Physical Network of SSVM's Zone\n             listphyntwk = PhysicalNetwork.list(\n@@ -348,13 +351,13 @@ def test_02_list_cpvm_vm(self):\n                         self.apiclient,\n                         physicalnetworkid=listphyntwk[0].id),\n                     list) is True):\n-                cpvmValidGateway = False\n+                gatewayFound = False\n                 for iprange in ipranges_response:\n                     if iprange.gateway == cpvm.gateway:\n-                        cpvmValidGateway = True\n+                        gatewayFound = True\n                         break\n                 self.assertTrue(\n-                    cpvmValidGateway,\n+                    gatewayFound,\n                     \"Check gateway with that of corresponding ip range\"\n                 )\n ",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_ssvm.py",
                "sha": "ad5c4ab344b73ac5373169430e7fb8f2e3b2fdbe",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_templates.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_templates.py?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 1,
                "filename": "test/integration/smoke/test_templates.py",
                "patch": "@@ -540,7 +540,6 @@ def setUpClass(cls):\n         cls.services[\"template\"][\"ostypeid\"] = template.ostypeid\n         cls.services[\"template_2\"][\"ostypeid\"] = template.ostypeid\n         cls.services[\"ostypeid\"] = template.ostypeid\n-        cls.services[\"isdynamicallyscalable\"] = template.isdynamicallyscalable\n         cls.account = Account.create(\n                             cls.apiclient,\n                             cls.services[\"account\"],\n@@ -590,6 +589,7 @@ def setUpClass(cls):\n                                          account=cls.account.name,\n                                          domainid=cls.account.domainid\n                                          )\n+        cls.services[\"isdynamicallyscalable\"] = cls.template_1.isdynamicallyscalable\n         cls.template_2 = Template.create(\n                                          cls.apiclient,\n                                          cls.services[\"template_2\"],",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_templates.py",
                "sha": "7057abe3342d94ace912fe8f604fb65afacc945f",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_volumes.py",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/test/integration/smoke/test_volumes.py?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 2,
                "filename": "test/integration/smoke/test_volumes.py",
                "patch": "@@ -246,8 +246,6 @@ def test_01_create_volume(self):\n                 ret = checkVolumeSize(ssh_handle=ssh,volume_name=volume_name,size_to_verify=vol_sz)\n             elif list_volume_response[0].hypervisor.lower() == \"hyperv\":\n                 ret = checkVolumeSize(ssh_handle=ssh,volume_name=\"/dev/sdb\",size_to_verify=vol_sz)\n-            elif list_volume_response[0].hypervisor.lower() == \"vmware\":\n-                ret = checkVolumeSize(ssh_handle=ssh,volume_name=\"/dev/sdb\",size_to_verify=vol_sz)\n             else:\n                 ret = checkVolumeSize(ssh_handle=ssh,size_to_verify=vol_sz)\n             self.debug(\" Volume Size Expected %s  Actual :%s\" %(vol_sz,ret[1]))",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/test/integration/smoke/test_volumes.py",
                "sha": "d40c0fd065f6022a142430d3c256686bef1c6340",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/ui/scripts/templates.js",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/templates.js?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 2,
                "filename": "ui/scripts/templates.js",
                "patch": "@@ -258,16 +258,19 @@\n                                                     $form.find('.form-item[rel=rootDiskControllerTypeKVM]').hide();\n                                                     $form.find('.form-item[rel=directdownload]').hide();\n \n-                                                    if (isAdmin())\n+                                                    if (isAdmin()) {\n                                                         $form.find('.form-item[rel=xenserverToolsVersion61plus]').css('display', 'inline-block');\n+                                                    }\n                                                 } else if ($(this).val() == \"KVM\") {\n                                                     $form.find('.form-item[rel=rootDiskControllerType]').hide();\n                                                     $form.find('.form-item[rel=nicAdapterType]').hide();\n                                                     $form.find('.form-item[rel=keyboardType]').hide();\n                                                     $form.find('.form-item[rel=xenserverToolsVersion61plus]').hide();\n                                                     $form.find('.form-item[rel=rootDiskControllerTypeKVM]').css('display', 'inline-block');\n                                                     $form.find('.form-item[rel=xenserverToolsVersion61plus]').css('display', 'inline-block');\n-                                                    $form.find('.form-item[rel=directdownload]').css('display', 'inline-block');\n+                                                    if (isAdmin()) {\n+                                                      $form.find('.form-item[rel=directdownload]').css('display', 'inline-block');\n+                                                    }\n                                                 } else {\n                                                     $form.find('.form-item[rel=rootDiskControllerType]').hide();\n                                                     $form.find('.form-item[rel=nicAdapterType]').hide();",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/ui/scripts/templates.js",
                "sha": "d9d3af0deb076fb406abb012cf14a5130dc26621",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/cloudstack/blob/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/vmware-base/src/com/cloud/hypervisor/vmware/mo/HostMO.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/vmware-base/src/com/cloud/hypervisor/vmware/mo/HostMO.java?ref=fa7c1e2e654281fac0bcaebcb1e841f030cbd56e",
                "deletions": 1,
                "filename": "vmware-base/src/com/cloud/hypervisor/vmware/mo/HostMO.java",
                "patch": "@@ -1039,7 +1039,7 @@ public ComputeResourceSummary getHyperHostHardwareSummary() throws Exception {\n     @Override\n     public boolean isHyperHostConnected() throws Exception {\n         HostRuntimeInfo runtimeInfo = (HostRuntimeInfo)_context.getVimClient().getDynamicProperty(_mor, \"runtime\");\n-        return runtimeInfo.getConnectionState() == HostSystemConnectionState.CONNECTED;\n+        return runtimeInfo != null && runtimeInfo.getConnectionState() == HostSystemConnectionState.CONNECTED;\n     }\n \n     public boolean revertToSnapshot(ManagedObjectReference morSnapshot) throws Exception {",
                "raw_url": "https://github.com/apache/cloudstack/raw/fa7c1e2e654281fac0bcaebcb1e841f030cbd56e/vmware-base/src/com/cloud/hypervisor/vmware/mo/HostMO.java",
                "sha": "22bfafc2badef7273b6045fedb9588615abc55c3",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-10227: Stabilization fixes for 4.11.0.0 (#2403)\n\nThis fixes regression failures seen in Trillian, fixes NPEs that cause Travis related failures.\r\nThis also removes the aria2 dependency from rpms that require users to enable/install epel-release.\r\nThis finally updates the checksums for 4.11 systemvmtemplates in db upgrade path.\r\n\r\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/a30a31c9b7f9b5fe246a02285bf820e7fe9ce16e",
        "repo": "cloudstack",
        "unit_tests": [
            "HypervisorTemplateAdapterTest.java"
        ]
    },
    "cloudstack_fae4fda": {
        "bug_id": "cloudstack_fae4fda",
        "commit": "https://github.com/apache/cloudstack/commit/fae4fdae5386a517bf417da1f06c5bf11499364b",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/fae4fdae5386a517bf417da1f06c5bf11499364b/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=fae4fdae5386a517bf417da1f06c5bf11499364b",
                "deletions": 2,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -548,8 +548,10 @@ public VMSnapshotResponse createVMSnapshotResponse(VMSnapshot vmSnapshot) {\n         }\n         if (vmSnapshot.getParent() != null) {\n             VMSnapshot vmSnapshotParent = ApiDBUtils.getVMSnapshotById(vmSnapshot.getParent());\n-            vmSnapshotResponse.setParent(vmSnapshotParent.getUuid());\n-            vmSnapshotResponse.setParentName(vmSnapshotParent.getDisplayName());\n+            if (vmSnapshotParent != null) {\n+                vmSnapshotResponse.setParent(vmSnapshotParent.getUuid());\n+                vmSnapshotResponse.setParentName(vmSnapshotParent.getDisplayName());\n+            }\n         }\n         vmSnapshotResponse.setCurrent(vmSnapshot.getCurrent());\n         vmSnapshotResponse.setType(vmSnapshot.getType().toString());",
                "raw_url": "https://github.com/apache/cloudstack/raw/fae4fdae5386a517bf417da1f06c5bf11499364b/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "f7059ef39939109878a560f406b151219bb236b7",
                "status": "modified"
            }
        ],
        "message": "ApiResponseHelper: fix NPE when parent of snapshot is null\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/7c41a1184cb4566a6337b8e50978c1e550b601c6",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_fc2b95d": {
        "bug_id": "cloudstack_fc2b95d",
        "commit": "https://github.com/apache/cloudstack/commit/fc2b95d9c3ecfd3819703ebb77993ad27ecd42bc",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/cloudstack/blob/fc2b95d9c3ecfd3819703ebb77993ad27ecd42bc/server/src/com/cloud/api/ApiResponseHelper.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/api/ApiResponseHelper.java?ref=fc2b95d9c3ecfd3819703ebb77993ad27ecd42bc",
                "deletions": 4,
                "filename": "server/src/com/cloud/api/ApiResponseHelper.java",
                "patch": "@@ -2015,11 +2015,13 @@ public TemplateResponse createIsoResponse(VirtualMachineTemplate result) {\n             isoResponse.setOsTypeName(\"\");\r\n         }\r\n         \r\n-        populateOwner(isoResponse, iso);\r\n+        Account account = ApiDBUtils.findAccountByIdIncludingRemoved(iso.getAccountId());\r\n+        populateAccount(isoResponse, account.getId());\r\n+        populateDomain(isoResponse, account.getDomainId());\r\n \r\n-        Account account = UserContext.current().getCaller();\r\n+        Account caller = UserContext.current().getCaller();\r\n         boolean isAdmin = false;\r\n-        if ((account == null) || BaseCmd.isAdmin(account.getType())) {\r\n+        if ((caller == null) || BaseCmd.isAdmin(caller.getType())) {\r\n             isAdmin = true;\r\n         }\r\n         // Add the zone ID\r\n@@ -2028,7 +2030,7 @@ public TemplateResponse createIsoResponse(VirtualMachineTemplate result) {\n         isoResponse.setZoneName(datacenter.getName());\r\n \r\n         // If the user is an admin, add the template download status\r\n-        if (isAdmin || account.getId() == iso.getAccountId()) {\r\n+        if (isAdmin || caller.getId() == iso.getAccountId()) {\r\n             // add download status\r\n             if (isoHost.getDownloadState() != Status.DOWNLOADED) {\r\n                 String isoStatus = \"Processing\";\r",
                "raw_url": "https://github.com/apache/cloudstack/raw/fc2b95d9c3ecfd3819703ebb77993ad27ecd42bc/server/src/com/cloud/api/ApiResponseHelper.java",
                "sha": "7d791b9a3e8d51625b92e859fe7efc25af6ab227",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in listIso API",
        "parent": "https://github.com/apache/cloudstack/commit/655a9805f3be0ab55e6c6f3ffea2a6526f032cf9",
        "repo": "cloudstack",
        "unit_tests": [
            "ApiResponseHelperTest.java"
        ]
    },
    "cloudstack_fdb782f": {
        "bug_id": "cloudstack_fdb782f",
        "commit": "https://github.com/apache/cloudstack/commit/fdb782ffcbd612cc1b44f827087267eb43e8687a",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/fdb782ffcbd612cc1b44f827087267eb43e8687a/server/src/com/cloud/storage/StorageManagerImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/storage/StorageManagerImpl.java?ref=fdb782ffcbd612cc1b44f827087267eb43e8687a",
                "deletions": 2,
                "filename": "server/src/com/cloud/storage/StorageManagerImpl.java",
                "patch": "@@ -1576,8 +1576,8 @@ public boolean storagePoolHasEnoughSpace(List<Volume> volumes, StoragePool pool)\n         long totalAskingSize = 0;\n         for (Volume volume : volumes) {\n             if (volume.getTemplateId() != null) {\n-                VMTemplateVO tmpl = _templateDao.findById(volume.getTemplateId());\n-                if (tmpl.getFormat() != ImageFormat.ISO) {\n+                VMTemplateVO tmpl = _templateDao.findByIdIncludingRemoved(volume.getTemplateId());\n+                if (tmpl != null && tmpl.getFormat() != ImageFormat.ISO) {\n                     allocatedSizeWithtemplate = _capacityMgr.getAllocatedPoolCapacity(poolVO, tmpl);\n                 }\n             }",
                "raw_url": "https://github.com/apache/cloudstack/raw/fdb782ffcbd612cc1b44f827087267eb43e8687a/server/src/com/cloud/storage/StorageManagerImpl.java",
                "sha": "c603c4d70eb2aee22b37d3c8477c09f77d4797ca",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-8014: Fix NPE searching including removed templates\n\nSteps to reproduce if you have this issue:\n- Create a VM's volume snapshot\n- Remove VM's template and mark the template as removed with timestamp in DB\n- Restart mgmt server and create a volume out of snapshot you should get NPE\n\nFix: In `storagePoolHasEnoughSpace`, we're only searching for a VM's volume's\nsnapshot's template by Id and not including removed templates. This is a corner\ncase and NPE hits when template has been marked removed for a VM's volume's\ntemplate so we should search including removed templates.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>\n(cherry picked from commit f189c105d8dde5491697b171b969e757f8f15858)\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>",
        "parent": "https://github.com/apache/cloudstack/commit/ec478c49a69ce7db9dc6598d8c05973d2def67bf",
        "repo": "cloudstack",
        "unit_tests": [
            "StorageManagerImplTest.java"
        ]
    },
    "cloudstack_ffe72ca": {
        "bug_id": "cloudstack_ffe72ca",
        "commit": "https://github.com/apache/cloudstack/commit/ffe72ca227a518907bca396603a2641e10c5d02d",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/cloudstack/blob/ffe72ca227a518907bca396603a2641e10c5d02d/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/server/src/com/cloud/resource/ResourceManagerImpl.java?ref=ffe72ca227a518907bca396603a2641e10c5d02d",
                "deletions": 2,
                "filename": "server/src/com/cloud/resource/ResourceManagerImpl.java",
                "patch": "@@ -847,7 +847,7 @@ protected boolean doDeleteHost(final long hostId, final boolean isForced, final\n             return true;\n         }\n \n-        long clusterId = host.getClusterId();\n+        Long clusterId = host.getClusterId();\n \n         _agentMgr.notifyMonitorsOfHostAboutToBeRemoved(host.getId());\n \n@@ -927,7 +927,9 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n             }\n         });\n \n-        _agentMgr.notifyMonitorsOfRemovedHost(host.getId(), clusterId);\n+        if (clusterId != null) {\n+            _agentMgr.notifyMonitorsOfRemovedHost(host.getId(), clusterId);\n+        }\n \n         return true;\n     }",
                "raw_url": "https://github.com/apache/cloudstack/raw/ffe72ca227a518907bca396603a2641e10c5d02d/server/src/com/cloud/resource/ResourceManagerImpl.java",
                "sha": "2bb1596ed1c7eb5b15e90ae37b7b1012f5ba8b5c",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/cloudstack/blob/ffe72ca227a518907bca396603a2641e10c5d02d/ui/scripts/system.js",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/cloudstack/contents/ui/scripts/system.js?ref=ffe72ca227a518907bca396603a2641e10c5d02d",
                "deletions": 2,
                "filename": "ui/scripts/system.js",
                "patch": "@@ -13256,7 +13256,7 @@\n                             dataType: \"json\",\n                             async: false,\n                             success: function(json) {\n-                                var items = json.listnuagevspdeviceresponse.nuagevspdevice;\n+                                var items = json.listnuagevspdevicesresponse.nuagevspdevice;\n                                 args.response.success({\n                                     data: items\n                                 });\n@@ -13325,7 +13325,7 @@\n                                         dataType: \"json\",\n                                         async: true,\n                                         success: function(json) {\n-                                            var item = json.listnuagevspdeviceresponse.nuagevspdevice[0];\n+                                            var item = json.listnuagevspdevicesresponse.nuagevspdevice[0];\n                                             args.response.success({\n                                                 data: item\n                                             });",
                "raw_url": "https://github.com/apache/cloudstack/raw/ffe72ca227a518907bca396603a2641e10c5d02d/ui/scripts/system.js",
                "sha": "2eef6b1908daa5f63d1e653ab06ce7d352809084",
                "status": "modified"
            }
        ],
        "message": "CLOUDSTACK-9399 : NPE during deletion of host when clusterId is null",
        "parent": "https://github.com/apache/cloudstack/commit/971c8a74e487e1048dd85338b80baa15902858d4",
        "repo": "cloudstack",
        "unit_tests": [
            "ResourceManagerImplTest.java"
        ]
    }
}