[
    {
        "repo": "olingo-odata4",
        "commit": "https://github.com/apache/olingo-odata4/commit/824c174d75bb28a29d177bc48376225c093439e8",
        "bug_id": "olingo-odata4_824c174",
        "message": "[OLINGO-931] Replace NPE with correct exception",
        "parent": "https://github.com/apache/olingo-odata4/commit/3baa3993ea532b980cc2a4b0200abf2c53d59dca",
        "patched_files": [
            "ODataJsonSerializer.java",
            "server-core-exceptions-i18n.properties",
            "SerializerException.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 2,
                "raw_url": "https://github.com/apache/olingo-odata4/raw/824c174d75bb28a29d177bc48376225c093439e8/lib/server-api/src/main/java/org/apache/olingo/server/api/serializer/SerializerException.java",
                "contents_url": "https://api.github.com/repos/apache/olingo-odata4/contents/lib/server-api/src/main/java/org/apache/olingo/server/api/serializer/SerializerException.java?ref=824c174d75bb28a29d177bc48376225c093439e8",
                "filename": "lib/server-api/src/main/java/org/apache/olingo/server/api/serializer/SerializerException.java",
                "deletions": 0,
                "sha": "be3416b5f88e022c5c565767d90ba7f1518a784d",
                "blob_url": "https://github.com/apache/olingo-odata4/blob/824c174d75bb28a29d177bc48376225c093439e8/lib/server-api/src/main/java/org/apache/olingo/server/api/serializer/SerializerException.java",
                "patch": "@@ -41,6 +41,8 @@\n     INCONSISTENT_PROPERTY_TYPE,\n     /** parameter: property name */\n     MISSING_PROPERTY,\n+    /** parameter: - */\n+    MISSING_ID,\n     /** parameters: property name, property value */\n     WRONG_PROPERTY_VALUE,\n     /** parameters: primitive-type name, value */",
                "changes": 2
            },
            {
                "status": "modified",
                "additions": 17,
                "raw_url": "https://github.com/apache/olingo-odata4/raw/824c174d75bb28a29d177bc48376225c093439e8/lib/server-core/src/main/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializer.java",
                "contents_url": "https://api.github.com/repos/apache/olingo-odata4/contents/lib/server-core/src/main/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializer.java?ref=824c174d75bb28a29d177bc48376225c093439e8",
                "filename": "lib/server-core/src/main/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializer.java",
                "deletions": 3,
                "sha": "396261fe55ecfac5ba0aab920af3384a37904f71",
                "blob_url": "https://github.com/apache/olingo-odata4/blob/824c174d75bb28a29d177bc48376225c093439e8/lib/server-core/src/main/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializer.java",
                "patch": "@@ -267,7 +267,7 @@ protected void writeEntitySet(final ServiceMetadata metadata, final EdmEntityTyp\n     for (final Entity entity : entitySet) {\n       if (onlyReference) {\n         json.writeStartObject();\n-        json.writeStringField(Constants.JSON_ID, entity.getId().toASCIIString());\n+        json.writeStringField(Constants.JSON_ID, getEntityId(entity));\n         json.writeEndObject();\n       } else {\n         writeEntity(metadata, entityType, entity, null, expand, select, false, json);\n@@ -276,6 +276,20 @@ protected void writeEntitySet(final ServiceMetadata metadata, final EdmEntityTyp\n     json.writeEndArray();\n   }\n \n+  /**\n+   * Get the ascii representation of the entity id\n+   * or thrown an {@link SerializerException} if id is <code>null</code>.\n+   *\n+   * @param entity the entity\n+   * @return ascii representation of the entity id\n+   */\n+  private String getEntityId(Entity entity) throws SerializerException {\n+    if(entity.getId() == null) {\n+      throw new SerializerException(\"Entity id is null.\", SerializerException.MessageKeys.MISSING_ID);\n+    }\n+    return entity.getId().toASCIIString();\n+  }\n+\n   private boolean areKeyPredicateNamesSelected(SelectOption select, EdmEntityType type) {\n     if (select == null || ExpandSelectHelper.isAll(select)) {\n       return true;\n@@ -319,14 +333,14 @@ public void writeEntity(final ServiceMetadata metadata, final EdmEntityType enti\n       }\n     }\n     if (onlyReference) {\n-      json.writeStringField(Constants.JSON_ID, entity.getId().toASCIIString());\n+      json.writeStringField(Constants.JSON_ID, getEntityId(entity));\n     } else {\n       final EdmEntityType resolvedType = resolveEntityType(metadata, entityType, entity.getType());\n       if (!isODataMetadataNone && !resolvedType.equals(entityType)) {\n         json.writeStringField(Constants.JSON_TYPE, \"#\" + entity.getType());\n       }\n       if (!isODataMetadataNone && !areKeyPredicateNamesSelected(select, resolvedType)) {\n-        json.writeStringField(Constants.JSON_ID, entity.getId().toASCIIString());\n+        json.writeStringField(Constants.JSON_ID, getEntityId(entity));\n       }\n       writeProperties(metadata, resolvedType, entity.getProperties(), select, json);\n       writeNavigationProperties(metadata, resolvedType, entity, expand, json);",
                "changes": 20
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/olingo-odata4/raw/824c174d75bb28a29d177bc48376225c093439e8/lib/server-core/src/main/resources/server-core-exceptions-i18n.properties",
                "contents_url": "https://api.github.com/repos/apache/olingo-odata4/contents/lib/server-core/src/main/resources/server-core-exceptions-i18n.properties?ref=824c174d75bb28a29d177bc48376225c093439e8",
                "filename": "lib/server-core/src/main/resources/server-core-exceptions-i18n.properties",
                "deletions": 0,
                "sha": "3b63c1b5b8b3af504c3278edd3b7d877473f54e8",
                "blob_url": "https://github.com/apache/olingo-odata4/blob/824c174d75bb28a29d177bc48376225c093439e8/lib/server-core/src/main/resources/server-core-exceptions-i18n.properties",
                "patch": "@@ -107,6 +107,7 @@ SerializerException.NO_CONTEXT_URL=No context URL has been provided.\n SerializerException.UNSUPPORTED_PROPERTY_TYPE=The type of the property '%1$s' is not yet supported.\n SerializerException.INCONSISTENT_PROPERTY_TYPE=An inconsistency has been detected in the type definition of property '%1$s'.\n SerializerException.MISSING_PROPERTY=The non-nullable property '%1$s' is missing.\n+SerializerException.MISSING_ID=The entity id value is missing.\n SerializerException.WRONG_PROPERTY_VALUE=The value '%2$s' is not valid for property '%1$s'.\n SerializerException.WRONG_PRIMITIVE_VALUE=The value '%2$s' is not valid for the primitive type '%1$s' and the given facets.\n SerializerException.UNKNOWN_TYPE=Type '%1s' not found in metadata.",
                "changes": 1
            },
            {
                "status": "modified",
                "additions": 27,
                "raw_url": "https://github.com/apache/olingo-odata4/raw/824c174d75bb28a29d177bc48376225c093439e8/lib/server-test/src/test/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializerTest.java",
                "contents_url": "https://api.github.com/repos/apache/olingo-odata4/contents/lib/server-test/src/test/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializerTest.java?ref=824c174d75bb28a29d177bc48376225c093439e8",
                "filename": "lib/server-test/src/test/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializerTest.java",
                "deletions": 0,
                "sha": "e4f62c21ae3fd317b685a5ef7747ad802c7327e0",
                "blob_url": "https://github.com/apache/olingo-odata4/blob/824c174d75bb28a29d177bc48376225c093439e8/lib/server-test/src/test/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializerTest.java",
                "patch": "@@ -719,6 +719,33 @@ public void selectComplexTwice() throws Exception {\n         resultString);\n   }\n \n+\n+  @Test(expected = SerializerException.class)\n+  public void selectMissingId() throws Exception {\n+    final EdmEntitySet edmEntitySet = entityContainer.getEntitySet(\"ESAllPrim\");\n+    final EdmEntityType entityType = edmEntitySet.getEntityType();\n+    final Entity entity = data.readAll(edmEntitySet).getEntities().get(0);\n+    entity.setId(null);\n+    final SelectItem selectItem1 = ExpandSelectMock.mockSelectItem(edmEntitySet, \"PropertyDate\");\n+    final SelectItem selectItem2 = ExpandSelectMock.mockSelectItem(edmEntitySet, \"PropertyBoolean\");\n+    final SelectOption select = ExpandSelectMock.mockSelectOption(Arrays.asList(\n+        selectItem1, selectItem2, selectItem2));\n+\n+    try {\n+    serializer.entity(metadata, entityType, entity,\n+            EntitySerializerOptions.with()\n+                .contextURL(ContextURL.with().entitySet(edmEntitySet)\n+                    .selectList(helper.buildContextURLSelectList(entityType, null, select))\n+                    .suffix(Suffix.ENTITY).build())\n+                .select(select)\n+                .build()).getContent();\n+      Assert.fail(\"Expected exception not thrown!\");\n+    } catch (final SerializerException e) {\n+      Assert.assertEquals(SerializerException.MessageKeys.MISSING_ID, e.getMessageKey());\n+      throw e;\n+    }\n+  }\n+\n   @Test\n   public void expand() throws Exception {\n     final EdmEntitySet edmEntitySet = entityContainer.getEntitySet(\"ESTwoPrim\");",
                "changes": 27
            }
        ],
        "unit_tests": [
            "ODataJsonSerializerTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "lib/server-test/src/test/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializerTest.java",
        "buggy_files": [
            "lib/server-core/src/main/java/org/apache/olingo/server/core/serializer/json/ODataJsonSerializer.java",
            "lib/server-core/src/main/resources/server-core-exceptions-i18n.properties",
            "lib/server-api/src/main/java/org/apache/olingo/server/api/serializer/SerializerException.java"
        ],
        "fixed": true
    }
]