[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/157bf5548ac23a22822ad38fff87a969114f7b43",
        "bug_id": "jackrabbit-oak_157bf55",
        "message": "OAK-4894: Potential NPE in Commit.apply()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1763465 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/dcdae91c976a111315ee0e9a373c4e6556e49065",
        "patched_files": [
            "Commit.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 6,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java?ref=157bf5548ac23a22822ad38fff87a969114f7b43",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java",
                "deletions": 3,
                "sha": "97ed2c6cd6895ceee8f907be7c7ca28d9cd69c03",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java",
                "patch": "@@ -179,9 +179,12 @@ void apply() throws DocumentStoreException {\n                 success = true;\n             } finally {\n                 if (!success) {\n-                    b.removeCommit(rev.asBranchRevision());\n-                    if (!b.hasCommits()) {\n-                        nodeStore.getBranches().remove(b);\n+                    Branch branch = getBranch();\n+                    if (branch != null) {\n+                        branch.removeCommit(rev.asBranchRevision());\n+                        if (!branch.hasCommits()) {\n+                            nodeStore.getBranches().remove(branch);\n+                        }\n                     }\n                 }\n             }",
                "changes": 9
            },
            {
                "status": "modified",
                "additions": 24,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java?ref=157bf5548ac23a22822ad38fff87a969114f7b43",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
                "deletions": 0,
                "sha": "4250ba299a0677319a21bdfd4878476679941749",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
                "patch": "@@ -25,6 +25,7 @@\n import org.junit.Rule;\n import org.junit.Test;\n \n+import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.EMPTY_NODE;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n@@ -109,4 +110,27 @@ public void mergeExceptionMessage() throws Exception {\n             ns.canceled(c);\n         }\n     }\n+\n+    // OAK-4894\n+    @Test\n+    public void branchCommitFails() throws Exception {\n+        // prepare node store\n+        DocumentNodeStore ns = builderProvider.newBuilder().getNodeStore();\n+\n+        // this branch commit must fail with a DocumentStoreException\n+        Commit c = ns.newCommit(ns.getHeadRevision().asBranchRevision(ns.getClusterId()), null);\n+        try {\n+            c.removeNode(\"/foo\", EMPTY_NODE);\n+            try {\n+                c.apply();\n+                fail(\"commit must fail\");\n+            } catch (DocumentStoreException e) {\n+                // expected\n+                assertTrue(\"Unexpected exception message: \" + e.getMessage(),\n+                        e.getMessage().contains(\"does not exist\"));\n+            }\n+        } finally {\n+            ns.canceled(c);\n+        }\n+    }\n }",
                "changes": 24
            }
        ],
        "unit_tests": [
            "CommitTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
        "buggy_files": [
            "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java"
        ],
        "fixed": true
    }
]