[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/a65b925e661e0cbf22e2844f85e68c6b6aaeae55",
        "bug_id": "jackrabbit-oak_a65b925",
        "message": "OAK-8212 : ImporterImpl.importProperties prone to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1857242 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/002c7d9e31ac0160e52213bf2e0d18558b467187",
        "patched_files": [
            "ImporterImpl.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 3,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java?ref=a65b925e661e0cbf22e2844f85e68c6b6aaeae55",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java",
                "deletions": 0,
                "sha": "2e126b5d8fa9287f4058f053492cfe7141002264",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java",
                "patch": "@@ -272,6 +272,9 @@ private void importProperties(@NotNull Tree tree,\n             //TODO find better heuristics?\n             EffectiveNodeType ent = effectiveNodeTypeProvider.getEffectiveNodeType(tree);\n             PropertyDefinition def = ent.getPropertyDefinition(pi.getName(), pi.getType(), pi.isUnknownMultiple());\n+            if (def == null) {\n+                throw new ConstraintViolationException(\"No matching property definition found for \" + pi.getName());\n+            }\n             if (def.isProtected()) {\n                 // skip protected property\n                 log.debug(\"Protected property {}\", pi.getName());",
                "changes": 3
            },
            {
                "status": "modified",
                "additions": 22,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java?ref=a65b925e661e0cbf22e2844f85e68c6b6aaeae55",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
                "deletions": 0,
                "sha": "d3afb1659e1772975449ec20686c2003e1635d8b",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
                "patch": "@@ -29,6 +29,9 @@\n \n import org.apache.jackrabbit.test.AbstractJCRTest;\n \n+import static org.apache.jackrabbit.JcrConstants.JCR_DATA;\n+import static org.apache.jackrabbit.JcrConstants.JCR_PRIMARYTYPE;\n+\n public class ImportTest extends AbstractJCRTest {\n \n     private String uuid;\n@@ -226,4 +229,23 @@ public void testTransientThrow() throws Exception {\n             // success\n         }\n     }\n+\n+    /**\n+     * @see <a href=\"https://issues.apache.org/jira/browse/OAK-8212\">OAK-8212</a>\n+     */\n+    public void testNoMatchingPropertyDefinition() throws Exception {\n+        // jcr:data must be BINARY not BOOLEAN -> should fail\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\" +\n+                \"<sv:node sv:name=\\\"resourceName\\\" xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\" xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\" xmlns:fn_old=\\\"http://www.w3.org/2004/10/xpath-functions\\\" xmlns:fn=\\\"http://www.w3.org/2005/xpath-functions\\\" xmlns:xs=\\\"http://www.w3.org/2001/XMLSchema\\\" xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\" xmlns:rep=\\\"internal\\\" xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\">\" +\n+                    \"<sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\"><sv:value>oak:Resource</sv:value></sv:property>\" +\n+                    \"<sv:property sv:name=\\\"jcr:data\\\" sv:type=\\\"Boolean\\\"><sv:value>true</sv:value></sv:property>\" +\n+                \"</sv:node>\";\n+        try {\n+            superuser.importXML(path, new ByteArrayInputStream(xml.getBytes()), ImportUUIDBehavior.IMPORT_UUID_CREATE_NEW);\n+            fail(\"ConstraintViolationException expected\");\n+        } catch (ConstraintViolationException e) {\n+            // success\n+            assertEquals(\"No matching property definition found for jcr:data\", e.getMessage());\n+        }\n+    }\n }\n\\ No newline at end of file",
                "changes": 22
            }
        ],
        "unit_tests": [
            "ImportTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
        "buggy_files": [
            "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java"
        ],
        "fixed": true
    }
]