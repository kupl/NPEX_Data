[
    {
        "repo": "calcite",
        "commit": "https://github.com/apache/calcite/commit/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc",
        "bug_id": "calcite_b8d24a6",
        "message": "[CALCITE-3292] SqlToRelConverter#substituteSubQuery fails with NullPointerException when converting SqlUpdate (Jin Xing)",
        "parent": "https://github.com/apache/calcite/commit/72680df93ef089abd0a7c0ac8cdc6253619c2ebe",
        "patched_files": [
            "SqlToRelConverter.java",
            "SqlToRelConverterTest.xml"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 10,
                "raw_url": "https://github.com/apache/calcite/raw/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc/core/src/main/java/org/apache/calcite/sql2rel/SqlToRelConverter.java",
                "contents_url": "https://api.github.com/repos/apache/calcite/contents/core/src/main/java/org/apache/calcite/sql2rel/SqlToRelConverter.java?ref=b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc",
                "filename": "core/src/main/java/org/apache/calcite/sql2rel/SqlToRelConverter.java",
                "deletions": 0,
                "sha": "9da2c3544626950bad1fade176c1c5d91dfa91c0",
                "blob_url": "https://github.com/apache/calcite/blob/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc/core/src/main/java/org/apache/calcite/sql2rel/SqlToRelConverter.java",
                "patch": "@@ -1102,6 +1102,16 @@ private void substituteSubQuery(Blackboard bb, SubQuery subQuery) {\n       //   where emp.deptno <> null\n       //         and q.indicator <> TRUE\"\n       //\n+      // Note:\n+      // Subquery can be used as SqlUpdate#condition like below:\n+      // \"update emp\n+      //  set empno = 1 where emp.empno in (\n+      //   select emp.empno from emp where emp.empno=2)\"\n+      // In such case, when converting SqlUpdate#condition, bb.root is null\n+      // and it makes no sense to do the subquery substituion.\n+      if (bb.root == null) {\n+        return;\n+      }\n       final RelDataType targetRowType =\n           SqlTypeUtil.promoteToRowType(typeFactory,\n               validator.getValidatedNodeType(leftKeyNode), null);",
                "changes": 10
            },
            {
                "status": "modified",
                "additions": 12,
                "raw_url": "https://github.com/apache/calcite/raw/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc/core/src/test/java/org/apache/calcite/test/SqlToRelConverterTest.java",
                "contents_url": "https://api.github.com/repos/apache/calcite/contents/core/src/test/java/org/apache/calcite/test/SqlToRelConverterTest.java?ref=b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc",
                "filename": "core/src/test/java/org/apache/calcite/test/SqlToRelConverterTest.java",
                "deletions": 0,
                "sha": "98f491786daa1ac245d7999d365d9834c76e3dce",
                "blob_url": "https://github.com/apache/calcite/blob/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc/core/src/test/java/org/apache/calcite/test/SqlToRelConverterTest.java",
                "patch": "@@ -2202,6 +2202,18 @@ public void testJoinUsingDynamicTable() {\n     sql(sql).ok();\n   }\n \n+  /**\n+   * Test case for\n+   * <a href=\"https://issues.apache.org/jira/browse/CALCITE-3292\">[CALCITE-3292]\n+   * NPE for UPDATE with IN query</a>.\n+   */\n+  @Test public void testUpdateSubQueryWithIn1() {\n+    final String sql = \"update emp\\n\"\n+            + \"set empno = 1 where emp.empno in (\\n\"\n+            + \"  select emp.empno from emp where emp.empno=2)\";\n+    sql(sql).ok();\n+  }\n+\n   /** Similar to {@link #testUpdateSubQueryWithIn()} but with not in instead of in. */\n   @Test public void testUpdateSubQueryWithNotIn() {\n     final String sql = \"update emp\\n\"",
                "changes": 12
            },
            {
                "status": "modified",
                "additions": 19,
                "raw_url": "https://github.com/apache/calcite/raw/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc/core/src/test/resources/org/apache/calcite/test/SqlToRelConverterTest.xml",
                "contents_url": "https://api.github.com/repos/apache/calcite/contents/core/src/test/resources/org/apache/calcite/test/SqlToRelConverterTest.xml?ref=b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc",
                "filename": "core/src/test/resources/org/apache/calcite/test/SqlToRelConverterTest.xml",
                "deletions": 0,
                "sha": "220b951949f5814710baa03bdd51a43cfc101714",
                "blob_url": "https://github.com/apache/calcite/blob/b8d24a6f7f2b4c7cb8093eea158f1fa00dbc6ffc/core/src/test/resources/org/apache/calcite/test/SqlToRelConverterTest.xml",
                "patch": "@@ -4762,6 +4762,25 @@ LogicalTableModify(table=[[CATALOG, SALES, EMP]], operation=[UPDATE], updateColu\n           LogicalProject(EMPNO=[$0], $f1=[true])\n             LogicalFilter(condition=[=($0, 2)])\n               LogicalTableScan(table=[[CATALOG, SALES, EMP]])\n+]]>\n+        </Resource>\n+    </TestCase>\n+    <TestCase name=\"testUpdateSubQueryWithIn1\">\n+        <Resource name=\"sql\">\n+            <![CDATA[update emp\n+set empno = 1 where empno in (\n+  select empno from emp where empno=2)]]>\n+        </Resource>\n+        <Resource name=\"plan\">\n+            <![CDATA[\n+LogicalTableModify(table=[[CATALOG, SALES, EMP]], operation=[UPDATE], updateColumnList=[[EMPNO]], sourceExpressionList=[[1]], flattened=[true])\n+  LogicalProject(EMPNO=[$0], ENAME=[$1], JOB=[$2], MGR=[$3], HIREDATE=[$4], SAL=[$5], COMM=[$6], DEPTNO=[$7], SLACKER=[$8], EXPR$0=[1])\n+    LogicalJoin(condition=[=($0, $9)], joinType=[inner])\n+      LogicalTableScan(table=[[CATALOG, SALES, EMP]])\n+      LogicalAggregate(group=[{0}])\n+        LogicalProject(EMPNO=[$0])\n+          LogicalFilter(condition=[=($0, 2)])\n+            LogicalTableScan(table=[[CATALOG, SALES, EMP]])\n ]]>\n         </Resource>\n     </TestCase>",
                "changes": 19
            }
        ],
        "unit_tests": [
            "SqlToRelConverterTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "core/src/test/java/org/apache/calcite/test/SqlToRelConverterTest.java",
        "buggy_files": [
            "core/src/main/java/org/apache/calcite/sql2rel/SqlToRelConverter.java",
            "core/src/test/resources/org/apache/calcite/test/SqlToRelConverterTest.xml"
        ],
        "fixed": true
    }
]