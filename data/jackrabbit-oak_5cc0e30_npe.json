[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5cc0e30fad5b798514e98dce1727672aa74dacb0",
        "bug_id": "jackrabbit-oak_5cc0e30",
        "message": "OAK-4986: RDBDocumentStore: potential NPE in document read\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766554 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/00ab785367a8b9c191165811cb1371d8491a4bd0",
        "patched_files": [
            "RDBDocumentSerializer.java",
            "RDBDocumentStoreJDBC.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 5,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java?ref=5cc0e30fad5b798514e98dce1727672aa74dacb0",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
                "deletions": 1,
                "sha": "c5b584e573ed67a25a57a4d814796468caf8216e",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
                "patch": "@@ -16,6 +16,7 @@\n  */\n package org.apache.jackrabbit.oak.plugins.document.rdb;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n import static org.apache.jackrabbit.oak.plugins.document.rdb.RDBJSONSupport.appendJsonMember;\n import static org.apache.jackrabbit.oak.plugins.document.rdb.RDBJSONSupport.appendJsonString;\n import static org.apache.jackrabbit.oak.plugins.document.rdb.RDBJSONSupport.appendJsonValue;\n@@ -144,6 +145,10 @@ public String asString(UpdateOp update) {\n      */\n     @Nonnull\n     public <T extends Document> T fromRow(@Nonnull Collection<T> collection, @Nonnull RDBRow row) throws DocumentStoreException {\n+\n+        final String charData = row.getData();\n+        checkNotNull(charData, \"RDBRow.getData() is null for collection \" + collection + \", id: \" + row.getId());\n+\n         T doc = collection.newDocument(store);\n         doc.put(ID, row.getId());\n         if (row.getModified() != RDBRow.LONG_UNSET) {\n@@ -181,7 +186,6 @@ public String asString(UpdateOp update) {\n             throw new DocumentStoreException(ex);\n         }\n \n-        String charData = row.getData();\n         json = new JsopTokenizer(charData);\n \n         // start processing the VARCHAR data",
                "changes": 6
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java?ref=5cc0e30fad5b798514e98dce1727672aa74dacb0",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "deletions": 1,
                "sha": "51e1342fc765c5e577e4b276280d48577a635396",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "patch": "@@ -631,7 +631,7 @@ public long determineServerTimeDifferenceMillis(Connection connection) {\n     @CheckForNull\n     public RDBRow read(Connection connection, RDBTableMetaData tmd, String id, long lastmodcount, long lastmodified) throws SQLException {\n \n-        boolean useCaseStatement = lastmodcount != -1 && this.dbInfo.allowsCaseInSelect();\n+        boolean useCaseStatement = lastmodcount != -1 && lastmodified >= 1 && this.dbInfo.allowsCaseInSelect();\n         StringBuffer sql = new StringBuffer();\n         sql.append(\"select MODIFIED, MODCOUNT, CMODCOUNT, HASBINARY, DELETEDONCE, \");\n         if (useCaseStatement) {",
                "changes": 2
            }
        ],
        "unit_tests": [
            "RDBDocumentSerializerTest.java",
            "RDBDocumentStoreJDBCTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializerTest.java",
        "buggy_files": [
            "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
            "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java"
        ],
        "fixed": true
    }
]