[
    {
        "repo": "jackrabbit",
        "commit": "https://github.com/apache/jackrabbit/commit/a9501efa46f9833e96e1c7cb0f83f467649ac4b7",
        "bug_id": "jackrabbit_a9501ef",
        "message": "JCR-3337 Negated descendant node query with no results throws NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1357591 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/e60384f3420a4edecdd76472664527ccd61d07c2",
        "patched_files": [
            "NotQuery.java",
            "ChildAxisQuery.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 6,
                "raw_url": "https://github.com/apache/jackrabbit/raw/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java?ref=a9501efa46f9833e96e1c7cb0f83f467649ac4b7",
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "deletions": 8,
                "sha": "c91fd3a651af7e09c517ed12595d3f89bea978cd",
                "blob_url": "https://github.com/apache/jackrabbit/blob/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "patch": "@@ -139,6 +139,12 @@ public void normalize(float norm) {\n         public Scorer scorer(IndexReader reader, boolean scoreDocsInOrder,\n                 boolean topScorer) throws IOException {\n             contextScorer = context.weight(searcher).scorer(reader, scoreDocsInOrder, topScorer);\n+            if (contextScorer == null) {\n+                // context query does not match any node\n+                // the inverse is to match all nodes\n+                return new MatchAllDocsQuery().createWeight(searcher).scorer(\n+                        reader, scoreDocsInOrder, topScorer);\n+            }\n             return new NotQueryScorer(reader);\n         }\n \n@@ -185,10 +191,6 @@ public int nextDoc() throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n-            if (contextScorer == null) {\n-                docNo = NO_MORE_DOCS;\n-                return docNo;\n-            }\n \n             if (docNo == -1) {\n                 // get first doc of context scorer\n@@ -229,10 +231,6 @@ public int advance(int target) throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n-            if (contextScorer == null) {\n-                docNo = NO_MORE_DOCS;\n-                return docNo;\n-            }\n \n             // optimize in the case of an advance to finish.\n             // see https://issues.apache.org/jira/browse/JCR-3091",
                "changes": 14
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/jackrabbit/raw/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java?ref=a9501efa46f9833e96e1c7cb0f83f467649ac4b7",
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "deletions": 1,
                "sha": "4ab3af55e4cbf43c063468a521bfd863adbb096b",
                "blob_url": "https://github.com/apache/jackrabbit/blob/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "patch": "@@ -253,6 +253,6 @@ public void testNotIsDescendantNodeQuery() throws Exception {\n                 + testRootNode.getPath()\n                 + \"') and not isdescendantnode(a,'\"\n                 + foo.getPath() + \"')\";\n-        executeSQL2Query(sql, new Node[] {});\n+        executeSQL2Query(sql, new Node[] {foo});\n     }\n }",
                "changes": 2
            }
        ],
        "unit_tests": [
            "ChildAxisQueryTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
        "buggy_files": [
            "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
            "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/ChildAxisQuery.java"
        ],
        "fixed": true
    }
]