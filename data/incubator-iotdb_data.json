[{"commit": "https://github.com/apache/incubator-iotdb/commit/4baa36eb3f143f79e12e7754e38b6acb918bb7ae", "parent": "https://github.com/apache/incubator-iotdb/commit/8cd144f3121398ddda6e70bd31e69e24de6345d7", "message": "fix an NPE when closing mergeLogger", "bug_id": "incubator-iotdb_1", "file": [{"additions": 3, "raw_url": "https://github.com/apache/incubator-iotdb/raw/4baa36eb3f143f79e12e7754e38b6acb918bb7ae/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeTask.java", "blob_url": "https://github.com/apache/incubator-iotdb/blob/4baa36eb3f143f79e12e7754e38b6acb918bb7ae/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeTask.java", "sha": "efaf53497f1672191c830dec6ca3e87cdcd368a4", "changes": 4, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/incubator-iotdb/contents/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeTask.java?ref=4baa36eb3f143f79e12e7754e38b6acb918bb7ae", "patch": "@@ -127,7 +127,9 @@ void cleanUp(boolean executeCallback) throws IOException {\n     unmergedChunkCnt.clear();\n     unmergedChunkStartTimes.clear();\n \n-    mergeLogger.close();\n+    if (mergeLogger != null) {\n+      mergeLogger.close();\n+    }\n \n     for (TsFileResource seqFile : resource.getSeqFiles()) {\n       File mergeFile = new File(seqFile.getFile().getPath() + MERGE_SUFFIX);", "filename": "iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeTask.java"}], "repo": "incubator-iotdb"}, {"commit": "https://github.com/apache/incubator-iotdb/commit/e24236d2a1f3585d6c92e24c3e11c0245514682b", "parent": "https://github.com/apache/incubator-iotdb/commit/c6362f15d77823ceccf5c6849785b678ee38a90d", "message": "fix an NPE in SGP during recovery", "bug_id": "incubator-iotdb_2", "file": [{"additions": 8, "raw_url": "https://github.com/apache/incubator-iotdb/raw/e24236d2a1f3585d6c92e24c3e11c0245514682b/iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "blob_url": "https://github.com/apache/incubator-iotdb/blob/e24236d2a1f3585d6c92e24c3e11c0245514682b/iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "sha": "f9841e4662f31d498a35c8e78e9ef3262a2087ce", "changes": 12, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/incubator-iotdb/contents/iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java?ref=e24236d2a1f3585d6c92e24c3e11c0245514682b", "patch": "@@ -780,20 +780,24 @@ private void mergeEndAction(List<TsFileResource> seqFiles, List<TsFileResource>\n         try {\n           // remove old modifications and write modifications generated during merge\n           seqFile.removeModFile();\n-          for (Modification modification : mergingModification.getModifications()) {\n-            seqFile.getModFile().write(modification);\n+          if (mergingModification != null) {\n+            for (Modification modification : mergingModification.getModifications()) {\n+              seqFile.getModFile().write(modification);\n+            }\n           }\n         } catch (IOException e) {\n           logger.error(\"{} cannot clean the ModificationFile of {} after merge\", storageGroupName,\n               seqFile.getFile(), e);\n         }\n         if (i == seqFiles.size() - 1) {\n           try {\n-            mergingModification.remove();\n+            if (mergingModification != null) {\n+              mergingModification.remove();\n+              mergingModification = null;\n+            }\n           } catch (IOException e) {\n             logger.error(\"{} cannot remove merging modification \", storageGroupName, e);\n           }\n-          mergingModification = null;\n           isMerging = false;\n         }\n       } finally {", "filename": "iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java"}], "repo": "incubator-iotdb"}, {"commit": "https://github.com/apache/incubator-iotdb/commit/9e6b1d6d903d6ccfbd89de820df77f686c430401", "parent": "https://github.com/apache/incubator-iotdb/commit/49132a6b804ae0d8b3ad22e92d1e4da8facca374", "message": "flip string equals to avoid NPE", "bug_id": "incubator-iotdb_3", "file": [{"additions": 5, "raw_url": "https://github.com/apache/incubator-iotdb/raw/9e6b1d6d903d6ccfbd89de820df77f686c430401/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/recover/LogAnalyzer.java", "blob_url": "https://github.com/apache/incubator-iotdb/blob/9e6b1d6d903d6ccfbd89de820df77f686c430401/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/recover/LogAnalyzer.java", "sha": "a541598dfbcb60449c856a4c0dcb78aee5fca165", "changes": 10, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/incubator-iotdb/contents/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/recover/LogAnalyzer.java?ref=9e6b1d6d903d6ccfbd89de820df77f686c430401", "patch": "@@ -75,13 +75,13 @@ public Status analyze() throws IOException {\n         new BufferedReader(new FileReader(logFile))) {\n       currLine = bufferedReader.readLine();\n       if (currLine != null) {\n-        if (currLine.equals(MergeLogger.STR_SEQ_FILES)) {\n+        if (MergeLogger.STR_SEQ_FILES.equals(currLine)) {\n           analyzeSeqFiles(bufferedReader);\n         }\n-        if (currLine.equals(MergeLogger.STR_UNSEQ_FILES)) {\n+        if (MergeLogger.STR_UNSEQ_FILES.equals(currLine)) {\n           analyzeUnseqFiles(bufferedReader);\n         }\n-        if (currLine.equals(MergeLogger.STR_MERGE_START)) {\n+        if (MergeLogger.STR_MERGE_START.equals(currLine)) {\n           status = Status.FILES_LOGGED;\n           for (TsFileResource seqFile : resource.getSeqFiles()) {\n             File mergeFile = new File(seqFile.getFile().getPath() + MergeTask.MERGE_SUFFIX);\n@@ -90,12 +90,12 @@ public Status analyze() throws IOException {\n           unmergedPaths = MergeUtils.collectPaths(resource);\n           analyzeMergedSeries(bufferedReader, unmergedPaths);\n         }\n-        if (currLine.equals(MergeLogger.STR_ALL_TS_END)) {\n+        if (MergeLogger.STR_ALL_TS_END.equals(currLine)) {\n           status = Status.ALL_TS_MERGED;\n           unmergedFiles = resource.getSeqFiles();\n           analyzeMergedFiles(bufferedReader);\n         }\n-        if (currLine.equals(MergeLogger.STR_MERGE_END)) {\n+        if (MergeLogger.STR_MERGE_END.equals(currLine)) {\n           status = Status.MERGE_END;\n         }\n       }", "filename": "iotdb/src/main/java/org/apache/iotdb/db/engine/merge/recover/LogAnalyzer.java"}], "repo": "incubator-iotdb"}, {"commit": "https://github.com/apache/incubator-iotdb/commit/bec56b7bbe6da764275a6ba287618fa06e8f50c2", "parent": "https://github.com/apache/incubator-iotdb/commit/33c605614e61667185bc43fb0cf5bc62fe2f232e", "message": "fix a NPE in merge recovery", "bug_id": "incubator-iotdb_4", "file": [{"additions": 4, "raw_url": "https://github.com/apache/incubator-iotdb/raw/bec56b7bbe6da764275a6ba287618fa06e8f50c2/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/RecoverMergeTask.java", "blob_url": "https://github.com/apache/incubator-iotdb/blob/bec56b7bbe6da764275a6ba287618fa06e8f50c2/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/RecoverMergeTask.java", "sha": "6c92d3c1c2390554481ff1ea314de54f2360882f", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/incubator-iotdb/contents/iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/RecoverMergeTask.java?ref=bec56b7bbe6da764275a6ba287618fa06e8f50c2", "patch": "@@ -47,9 +47,11 @@\n \n   private LogAnalyzer analyzer;\n \n-  public RecoverMergeTask(String storageGroupDir, MergeCallback callback, String taskName,\n+  public RecoverMergeTask(List<TsFileResource> seqFiles,\n+      List<TsFileResource> unseqFiles, String storageGroupDir,\n+      MergeCallback callback, String taskName,\n       boolean fullMerge) throws IOException {\n-    super(null, null, storageGroupDir, callback, taskName, fullMerge);\n+    super(seqFiles, unseqFiles, storageGroupDir, callback, taskName, fullMerge);\n   }\n \n   public void recoverMerge(boolean continueMerge) throws IOException {", "filename": "iotdb/src/main/java/org/apache/iotdb/db/engine/merge/task/RecoverMergeTask.java"}, {"additions": 3, "raw_url": "https://github.com/apache/incubator-iotdb/raw/bec56b7bbe6da764275a6ba287618fa06e8f50c2/iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "blob_url": "https://github.com/apache/incubator-iotdb/blob/bec56b7bbe6da764275a6ba287618fa06e8f50c2/iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "sha": "29c1146787e300358ab0e3acf66cd50585794aa3", "changes": 5, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/incubator-iotdb/contents/iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java?ref=bec56b7bbe6da764275a6ba287618fa06e8f50c2", "patch": "@@ -201,8 +201,9 @@ private void recover() throws ProcessorException {\n       if (mergingMods.exists()) {\n         mergingModification = new ModificationFile(storageGroupSysDir + File.separator + MERGING_MODIFICAITON_FILE_NAME);\n       }\n-      RecoverMergeTask recoverMergeTask = new RecoverMergeTask(storageGroupSysDir.getPath(),\n-          this::mergeEndAction, taskName, IoTDBDescriptor.getInstance().getConfig().isForceFullMerge());\n+      RecoverMergeTask recoverMergeTask = new RecoverMergeTask(seqTsFiles, unseqTsFiles,\n+          storageGroupSysDir.getPath(), this::mergeEndAction, taskName,\n+          IoTDBDescriptor.getInstance().getConfig().isForceFullMerge());\n       logger.info(\"{} a RecoverMergeTask {} starts...\", storageGroupName, taskName);\n       recoverMergeTask.recoverMerge(IoTDBDescriptor.getInstance().getConfig().isContinueMergeAfterReboot());\n       if (!IoTDBDescriptor.getInstance().getConfig().isContinueMergeAfterReboot()) {", "filename": "iotdb/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java"}], "repo": "incubator-iotdb"}, {"commit": "https://github.com/apache/incubator-iotdb/commit/26578c87163f77eefdfbf2fcb52f119ffd389345", "parent": "https://github.com/apache/incubator-iotdb/commit/d88cd8361f0e72ac4118f54e9014fedc2805c175", "message": "fix an NPE in updating device min time", "bug_id": "incubator-iotdb_5", "file": [{"additions": 4, "raw_url": "https://github.com/apache/incubator-iotdb/raw/26578c87163f77eefdfbf2fcb52f119ffd389345/server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java", "blob_url": "https://github.com/apache/incubator-iotdb/blob/26578c87163f77eefdfbf2fcb52f119ffd389345/server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java", "sha": "d19eed351221c25db6ef5939bba7ed0600f64140", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/incubator-iotdb/contents/server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java?ref=26578c87163f77eefdfbf2fcb52f119ffd389345", "patch": "@@ -182,8 +182,10 @@ private void pathsMergeOneFile(int seqFileIdx, List<IPointReader> unseqReader)\n     mergeFileWriter.startChunkGroup(deviceId);\n     boolean dataWritten = false;\n     for (int pathIdx : unskippedPathIndices) {\n-      currDeviceMinTime = currDeviceMinTime > currTimeValuePairs[pathIdx].getTimestamp() ?\n-          currTimeValuePairs[pathIdx].getTimestamp() : currDeviceMinTime;\n+      if (currTimeValuePairs[pathIdx] != null) {\n+        currDeviceMinTime = currDeviceMinTime > currTimeValuePairs[pathIdx].getTimestamp() ?\n+            currTimeValuePairs[pathIdx].getTimestamp() : currDeviceMinTime;\n+      }\n       dataWritten = mergeChunks(seqChunkMeta[pathIdx], isLastFile,\n           fileSequenceReader, unseqReader.get(pathIdx), mergeFileWriter, currTsFile, pathIdx)\n           || dataWritten;", "filename": "server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java"}], "repo": "incubator-iotdb"}]
