{
    "bookkeeper_1387b2b": {
        "bug_id": "bookkeeper_1387b2b",
        "commit": "https://github.com/apache/bookkeeper/commit/1387b2be44686abfe78bf4efee4ad52d2d699e12",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1387b2be44686abfe78bf4efee4ad52d2d699e12/CHANGES.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=1387b2be44686abfe78bf4efee4ad52d2d699e12",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -38,6 +38,8 @@ Trunk (unreleased changes)\n \n       BOOKKEEPER-846: TestLedgerChecker times out (rakeshr via sijie)\n \n+      BOOKKEEPER-854: NPE on InterleavedLedgerStorage.onRotateEntryLog (sijie)\n+\n     IMPROVEMENTS:\n \n       BOOKKEEPER-800: Expose whether a ledger is closed or not (ivank)",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1387b2be44686abfe78bf4efee4ad52d2d699e12/CHANGES.txt",
                "sha": "4415a2e112e26df1980df535ae24c9077ad2fbb8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1387b2be44686abfe78bf4efee4ad52d2d699e12/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/SortedLedgerStorage.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/SortedLedgerStorage.java?ref=1387b2be44686abfe78bf4efee4ad52d2d699e12",
                "deletions": 1,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/SortedLedgerStorage.java",
                "patch": "@@ -46,7 +46,7 @@ public SortedLedgerStorage(ServerConfiguration conf, LedgerManager ledgerManager\n                                LedgerDirsManager ledgerDirsManager, LedgerDirsManager indexDirsManager,\n                                final CheckpointSource checkpointSource, StatsLogger statsLogger)\n                                        throws IOException {\n-        super(conf, ledgerManager, ledgerDirsManager, indexDirsManager, null, statsLogger);\n+        super(conf, ledgerManager, ledgerDirsManager, indexDirsManager, checkpointSource, statsLogger);\n         this.memTable = new EntryMemTable(conf, checkpointSource, statsLogger);\n         this.scheduler = Executors.newSingleThreadScheduledExecutor(\n                 new ThreadFactoryBuilder()",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1387b2be44686abfe78bf4efee4ad52d2d699e12/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/SortedLedgerStorage.java",
                "sha": "da14885820987121e7293d5dd41a6569d2af5063",
                "status": "modified"
            }
        ],
        "message": "BOOKKEEPER-854: NPE on InterleavedLedgerStorage.onRotateEntryLog (sijie)",
        "parent": "https://github.com/apache/bookkeeper/commit/5bd2edbf82bd0c8bd9ea9e507b07d23cb856f934",
        "repo": "bookkeeper",
        "unit_tests": [
            "SortedLedgerStorageTest.java"
        ]
    },
    "bookkeeper_1d4cc71": {
        "bug_id": "bookkeeper_1d4cc71",
        "commit": "https://github.com/apache/bookkeeper/commit/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9",
                "deletions": 15,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "patch": "@@ -85,6 +85,7 @@\n import org.apache.bookkeeper.tools.cli.commands.bookie.LedgerCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListFilesOnDiscCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListLedgersCommand;\n+import org.apache.bookkeeper.tools.cli.commands.bookie.LocalConsistencyCheckCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadJournalCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLedgerCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLogCommand;\n@@ -961,21 +962,9 @@ Options getOptions() {\n \n         @Override\n         public int runCmd(CommandLine cmdLine) throws Exception {\n-            LOG.info(\"=== Performing local consistency check ===\");\n-            ServerConfiguration conf = new ServerConfiguration(bkConf);\n-            LedgerStorage ledgerStorage = Bookie.mountLedgerStorageOffline(conf, null);\n-            List <LedgerStorage.DetectedInconsistency> errors = ledgerStorage.localConsistencyCheck(\n-                    java.util.Optional.empty());\n-            if (errors.size() > 0) {\n-                LOG.info(\"=== Check returned errors: ===\");\n-                for (LedgerStorage.DetectedInconsistency error : errors) {\n-                    LOG.error(\"Ledger {}, entry {}: \", error.getLedgerId(), error.getEntryId(), error.getException());\n-                }\n-                return 1;\n-            } else {\n-                LOG.info(\"=== Check passed ===\");\n-                return 0;\n-            }\n+            LocalConsistencyCheckCommand cmd = new LocalConsistencyCheckCommand();\n+            boolean result = cmd.apply(bkConf, new CliFlags());\n+            return (result) ? 0 : 1;\n         }\n \n         @Override",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "sha": "9d2bba6f59189bae00ea8835722df06fe1956f46",
                "status": "modified"
            },
            {
                "additions": 77,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommand.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommand.java?ref=1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommand.java",
                "patch": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.bookie;\n+\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import java.io.IOException;\n+import java.util.List;\n+import org.apache.bookkeeper.bookie.Bookie;\n+import org.apache.bookkeeper.bookie.LedgerStorage;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommand;\n+import org.apache.bookkeeper.tools.framework.CliFlags;\n+import org.apache.bookkeeper.tools.framework.CliSpec;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Command to check local storage for inconsistencies.\n+ */\n+public class LocalConsistencyCheckCommand extends BookieCommand<CliFlags> {\n+\n+    static final Logger LOG = LoggerFactory.getLogger(LocalConsistencyCheckCommand.class);\n+\n+    private static final String NAME = \"localconsistencycheck\";\n+    private static final String DESC = \"Validate Ledger Storage internal metadata\";\n+\n+    public LocalConsistencyCheckCommand() {\n+        super(CliSpec.newBuilder()\n+                     .withName(NAME)\n+                     .withDescription(DESC)\n+                     .withFlags(new CliFlags())\n+                     .build());\n+    }\n+\n+    @Override\n+    public boolean apply(ServerConfiguration conf, CliFlags cmdFlags) {\n+        try {\n+            return check(conf);\n+        } catch (IOException e) {\n+            throw new UncheckedExecutionException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean check(ServerConfiguration conf) throws IOException {\n+        LOG.info(\"=== Performing local consistency check ===\");\n+        ServerConfiguration serverConfiguration = new ServerConfiguration(conf);\n+        LedgerStorage ledgerStorage = Bookie.mountLedgerStorageOffline(serverConfiguration, null);\n+        List<LedgerStorage.DetectedInconsistency> errors = ledgerStorage.localConsistencyCheck(\n+            java.util.Optional.empty());\n+        if (errors.size() > 0) {\n+            LOG.info(\"=== Check returned errors: ===\");\n+            for (LedgerStorage.DetectedInconsistency error : errors) {\n+                LOG.error(\"Ledger {}, entry {}: \", error.getLedgerId(), error.getEntryId(), error.getException());\n+            }\n+            return false;\n+        } else {\n+            LOG.info(\"=== Check passed ===\");\n+            return true;\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommand.java",
                "sha": "60a94bcf03bc763fd0cfbdfe4585002bcbca3e03",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java?ref=1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9",
                "deletions": 0,
                "filename": "tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java",
                "patch": "@@ -29,6 +29,7 @@\n import org.apache.bookkeeper.tools.cli.commands.bookie.LedgerCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListFilesOnDiscCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListLedgersCommand;\n+import org.apache.bookkeeper.tools.cli.commands.bookie.LocalConsistencyCheckCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadJournalCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLedgerCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLogCommand;\n@@ -64,6 +65,7 @@\n         .addCommand(new ReadLedgerCommand())\n         .addCommand(new ReadLogCommand())\n         .addCommand(new ReadLogMetadataCommand())\n+        .addCommand(new LocalConsistencyCheckCommand())\n         .build();\n \n     public BookieCommandGroup() {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java",
                "sha": "95cd459af11a8f612e0ef981ebb963995d1e504b",
                "status": "modified"
            },
            {
                "additions": 77,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommandTest.java",
                "changes": 77,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommandTest.java?ref=1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9",
                "deletions": 0,
                "filename": "tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommandTest.java",
                "patch": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.bookie;\n+\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.powermock.api.mockito.PowerMockito.verifyNew;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.bookkeeper.bookie.Bookie;\n+import org.apache.bookkeeper.bookie.LedgerStorage;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommandTestBase;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.powermock.api.mockito.PowerMockito;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+/**\n+ * Unit test for {@link LocalConsistencyCheckCommand}.\n+ */\n+@RunWith(PowerMockRunner.class)\n+@PrepareForTest({ LocalConsistencyCheckCommand.class, Bookie.class })\n+public class LocalConsistencyCheckCommandTest extends BookieCommandTestBase {\n+\n+    @Mock\n+    private ServerConfiguration serverConfiguration;\n+\n+    @Mock\n+    private LedgerStorage ledgerStorage;\n+\n+    public LocalConsistencyCheckCommandTest() {\n+        super(3, 0);\n+    }\n+\n+    @Override\n+    public void setup() throws Exception {\n+        super.setup();\n+\n+        PowerMockito.whenNew(ServerConfiguration.class).withNoArguments().thenReturn(conf);\n+        PowerMockito.whenNew(ServerConfiguration.class).withArguments(eq(conf)).thenReturn(serverConfiguration);\n+        PowerMockito.mockStatic(Bookie.class);\n+        PowerMockito.when(Bookie.mountLedgerStorageOffline(eq(serverConfiguration), eq(null)))\n+                    .thenReturn(ledgerStorage);\n+        List<LedgerStorage.DetectedInconsistency> errors = new ArrayList<>();\n+        PowerMockito.when(ledgerStorage.localConsistencyCheck(eq(java.util.Optional.empty()))).thenReturn(errors);\n+    }\n+\n+    @Test\n+    public void testCommand() throws Exception {\n+        LocalConsistencyCheckCommand cmd = new LocalConsistencyCheckCommand();\n+        Assert.assertTrue(cmd.apply(bkFlags, new String[] {}));\n+        verifyNew(ServerConfiguration.class, times(1)).withArguments(eq(conf));\n+        verify(ledgerStorage, times(1)).localConsistencyCheck(eq(java.util.Optional.empty()));\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1d4cc71fd77ab803a3ebec5a8e7f1b8f51de92c9/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/LocalConsistencyCheckCommandTest.java",
                "sha": "3d32f9b017e788cd5ad93ab90674bb4f808d2592",
                "status": "added"
            }
        ],
        "message": "Migrate command `localconsistencycheck`\n\nDescriptions of the changes in this PR:\r\n\r\n#2042 \r\n\r\nUsing bkctl run command localconsistencycheck\r\n\r\n```\r\nValidate Ledger Storage internal metadata\r\nUsage:  bkctl bookie localconsistencycheck [flags]\r\nFlags:\r\n\r\n    -h, --help\r\n        Display help information\r\n```\n\nReviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>\n\nThis closes #2043 from zymap/command-localconsistencycheck and squashes the following commits:\n\nc31f07a00 [Sijie Guo] Merge branch 'master' into command-localconsistencycheck\nc391fe58d [Yong Zhang] Migrate command `readlogmetadata`\n120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`\nbf66235e5 [Yong Zhang] Migrate command `deleteledger`\nc9bb4a42c [Yong Zhang] Migrate command `localconsistencycheck`\n751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time\n138a7ae85 [Yong Zhang] Migrate command `metadataformat`\nb043d1694 [Yong Zhang] Migrate command `listledgers`\n4573285db [Ivan Kelly] Docker autobuild hook\ne3d807a32 [Like] Fix IDE complain as there are multi choices for error code\n9524a9f4a [Yong Zhang] Migrate command `readjournal`\n6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed\ne35a108c7 [Like] Fix error message for unrecognized number-of-bookies\n5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null\n6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2\n1448d12aa [Yong Zhang] Migrate command `listfilesondisk`\n4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`\n468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty\nf26a4cae0 [Ivan Kelly] Release notes for v4.8.2\nec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`\n8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`\nfa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl",
        "parent": "https://github.com/apache/bookkeeper/commit/67f83620eb8ed93bf73322293deb1a1bde8d09c7",
        "repo": "bookkeeper",
        "unit_tests": [
            "BookieShellTest.java",
            "LocalConsistencyCheckCommandTest.java"
        ]
    },
    "bookkeeper_1d6b550": {
        "bug_id": "bookkeeper_1d6b550",
        "commit": "https://github.com/apache/bookkeeper/commit/1d6b5506599accca30129348d52048b25766d1fa",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1d6b5506599accca30129348d52048b25766d1fa/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/ReadEntryProcessor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/ReadEntryProcessor.java?ref=1d6b5506599accca30129348d52048b25766d1fa",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/ReadEntryProcessor.java",
                "patch": "@@ -129,6 +129,10 @@ protected void processPacket() {\n         } catch (BookieException e) {\n             LOG.error(\"Unauthorized access to ledger \" + read.getLedgerId(), e);\n             errorCode = BookieProtocol.EUA;\n+        } catch (Throwable t) {\n+            LOG.error(\"Unexpected exception reading at {}:{} : {}\", read.getLedgerId(), read.getEntryId(),\n+                    t.getMessage(), t);\n+            errorCode = BookieProtocol.EBADREQ;\n         }\n \n         if (LOG.isTraceEnabled()) {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1d6b5506599accca30129348d52048b25766d1fa/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/ReadEntryProcessor.java",
                "sha": "7849ca81afe25befb478cc5f2c5351b589fccc90",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/bookkeeper/blob/1d6b5506599accca30129348d52048b25766d1fa/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/WriteEntryProcessor.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/WriteEntryProcessor.java?ref=1d6b5506599accca30129348d52048b25766d1fa",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/WriteEntryProcessor.java",
                "patch": "@@ -87,6 +87,10 @@ protected void processPacket() {\n         } catch (BookieException e) {\n             LOG.error(\"Unauthorized access to ledger \" + add.getLedgerId(), e);\n             rc = BookieProtocol.EUA;\n+        } catch (Throwable t) {\n+            LOG.error(\"Unexpected exception while writing {}@{} : {}\", add.ledgerId, add.entryId, t.getMessage(), t);\n+            // some bad request which cause unexpected exception\n+            rc = BookieProtocol.EBADREQ;\n         } finally {\n             addData.release();\n         }",
                "raw_url": "https://github.com/apache/bookkeeper/raw/1d6b5506599accca30129348d52048b25766d1fa/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/WriteEntryProcessor.java",
                "sha": "87df2d2ff9063c8da8ae31229fd192d2bff6e965",
                "status": "modified"
            }
        ],
        "message": "Handle unexpected throwable in Bookie V2 request processors\n\nMerging from https://github.com/yahoo/bookkeeper/commit/c54eafbe\n\nWhen getting any exception, the request processor for V2 protocol must make sure to get some response back to client. In the specific case, it was some NPE that was thrown and not handled properly.\n\nAuthor: Matteo Merli <mmerli@apache.org>\n\nReviewers: Ivan Kelly <ivank@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>\n\nThis closes #813 from merlimat/handle-throwable",
        "parent": "https://github.com/apache/bookkeeper/commit/b8dee21a253f4d6f449e53afa5596cc6c54b189c",
        "repo": "bookkeeper",
        "unit_tests": [
            "ReadEntryProcessorTest.java",
            "WriteEntryProcessorTest.java"
        ]
    },
    "bookkeeper_24dc8ac": {
        "bug_id": "bookkeeper_24dc8ac",
        "commit": "https://github.com/apache/bookkeeper/commit/24dc8ac30c97620cf4dbef48deff2bb957932eb8",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/24dc8ac30c97620cf4dbef48deff2bb957932eb8/CHANGES.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=24dc8ac30c97620cf4dbef48deff2bb957932eb8",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -112,6 +112,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-673: Ledger length can be inaccurate in failure case (sijie via ivank)\n \n+        BOOKKEEPER-688: NPE exception in PerChannelBookieClient (ivank via sijie)\n+\n       hedwig-server:\n \n         BOOKKEEPER-601: readahead cache size isn't updated correctly (sijie via fpj)",
                "raw_url": "https://github.com/apache/bookkeeper/raw/24dc8ac30c97620cf4dbef48deff2bb957932eb8/CHANGES.txt",
                "sha": "bc3f0f0908bfa78dd6be5a286617f9eee6226e9e",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/bookkeeper/blob/24dc8ac30c97620cf4dbef48deff2bb957932eb8/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java?ref=24dc8ac30c97620cf4dbef48deff2bb957932eb8",
                "deletions": 6,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "patch": "@@ -238,15 +238,20 @@ void addEntry(final long ledgerId, byte[] masterKey, final long entryId, Channel\n         final int entrySize = toSend.readableBytes();\n         final CompletionKey completionKey = new CompletionKey(ledgerId, entryId);\n         addCompletions.put(completionKey, new AddCompletion(cb, entrySize, ctx));\n+        final Channel c = channel;\n+        if (c == null) {\n+            errorOutAddKey(completionKey);\n+            return;\n+        }\n         try {\n-            ChannelFuture future = channel.write(r);\n+            ChannelFuture future = c.write(r);\n             future.addListener(new ChannelFutureListener() {\n                 @Override\n                 public void operationComplete(ChannelFuture future) throws Exception {\n                     if (future.isSuccess()) {\n                         if (LOG.isDebugEnabled()) {\n                             LOG.debug(\"Successfully wrote request for adding entry: \" + entryId + \" ledger-id: \" + ledgerId\n-                                                            + \" bookie: \" + channel.getRemoteAddress() + \" entry length: \" + entrySize);\n+                                                            + \" bookie: \" + c.getRemoteAddress() + \" entry length: \" + entrySize);\n                         }\n                         // totalBytesOutstanding.addAndGet(entrySize);\n                     } else {\n@@ -270,15 +275,21 @@ public void readEntryAndFenceLedger(final long ledgerId, byte[] masterKey,\n                 BookieProtocol.CURRENT_PROTOCOL_VERSION, ledgerId, entryId,\n                 BookieProtocol.FLAG_DO_FENCING, masterKey);\n \n+        final Channel c = channel;\n+        if (c == null) {\n+            errorOutReadKey(key);\n+            return;\n+        }\n+\n         try {\n-            ChannelFuture future = channel.write(r);\n+            ChannelFuture future = c.write(r);\n             future.addListener(new ChannelFutureListener() {\n                     @Override\n                     public void operationComplete(ChannelFuture future) throws Exception {\n                         if (future.isSuccess()) {\n                             if (LOG.isDebugEnabled()) {\n                                 LOG.debug(\"Successfully wrote request {} to {}\",\n-                                          r, channel.getRemoteAddress());\n+                                          r, c.getRemoteAddress());\n                             }\n                         } else {\n                             errorOutReadKey(key);\n@@ -299,15 +310,21 @@ public void readEntry(final long ledgerId, final long entryId, ReadEntryCallback\n                 BookieProtocol.CURRENT_PROTOCOL_VERSION, ledgerId, entryId,\n                 BookieProtocol.FLAG_NONE);\n \n+        final Channel c = channel;\n+        if (c == null) {\n+            errorOutReadKey(key);\n+            return;\n+        }\n+\n         try{\n-            ChannelFuture future = channel.write(r);\n+            ChannelFuture future = c.write(r);\n             future.addListener(new ChannelFutureListener() {\n                 @Override\n                 public void operationComplete(ChannelFuture future) throws Exception {\n                     if (future.isSuccess()) {\n                         if (LOG.isDebugEnabled()) {\n                             LOG.debug(\"Successfully wrote request {} to {}\",\n-                                      r, channel.getRemoteAddress());\n+                                      r, c.getRemoteAddress());\n                         }\n                     } else {\n                         errorOutReadKey(key);",
                "raw_url": "https://github.com/apache/bookkeeper/raw/24dc8ac30c97620cf4dbef48deff2bb957932eb8/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "sha": "eb7d3b394117f74f2202c4821ace636a313f9aec",
                "status": "modified"
            }
        ],
        "message": "BOOKKEEPER-688: NPE exception in PerChannelBookieClient (ivank via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1534498 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/bookkeeper/commit/33ea58027b0a3ba160f7ac19d20568709f453f4d",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestPerChannelBookieClient.java"
        ]
    },
    "bookkeeper_335c2ab": {
        "bug_id": "bookkeeper_335c2ab",
        "commit": "https://github.com/apache/bookkeeper/commit/335c2aba9bfd24eff224f1afae393026c17a2d5a",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/bookkeeper/blob/335c2aba9bfd24eff224f1afae393026c17a2d5a/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java?ref=335c2aba9bfd24eff224f1afae393026c17a2d5a",
                "deletions": 1,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java",
                "patch": "@@ -133,8 +133,17 @@ public static void asyncDeleteFullPathOptimistic(final ZooKeeper zk, final Strin\n             public void processResult(int rc, String path, Object ctx) {\n                 if (rc == Code.OK.intValue()) {\n                     String parent = new File(originalPath).getParent().replace(\"\\\\\", \"/\");\n-                    asyncDeleteFullPathOptimistic(zk, parent, -1, callback, leafNodePath);\n+                    zk.getData(parent, false, (dRc, dPath, dCtx, data, stat) -> {\n+                        if (Code.OK.intValue() == dRc && (stat != null && stat.getNumChildren() == 0)) {\n+                            asyncDeleteFullPathOptimistic(zk, parent, -1, callback, leafNodePath);\n+                        } else {\n+                            // parent node is not empty so, complete the\n+                            // callback\n+                            callback.processResult(Code.OK.intValue(), path, leafNodePath);\n+                        }\n+                    }, null);\n                 } else {\n+                    // parent node deletion fails.. so, complete the callback\n                     if (path.equals(leafNodePath)) {\n                         callback.processResult(rc, path, leafNodePath);\n                     } else {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/335c2aba9bfd24eff224f1afae393026c17a2d5a/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/ZkUtils.java",
                "sha": "9d6ba1ab9b06d0ac865e1778da5af4e74215db97",
                "status": "modified"
            }
        ],
        "message": "[BK-CLIENT] Check empty ledger-parent node while deleting ledger\n\n### Motivation\r\n\r\nAs discussed at [#4276](https://github.com/apache/pulsar/issues/4276), while deleting ledger, bk-client should check parent node is empty before issuing delete request for parent znode.\r\n\r\n\n\nReviewers: Enrico Olivelli <eolivelli@gmail.com>, Charan Reddy Guttapalem <reddycharan18@gmail.com>, Matteo Merli <mmerli@apache.org>\n\nThis closes #2097 from rdhabalia/led_del and squashes the following commits:\n\nf5c0ca36c [rdhabalia] return callback with ok\nede5e9403 [rdhabalia] [Bk-Client] Check empty ledger-parent node while deleting ledger\nd35aa22ad [Charan Reddy Guttapalem] Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.\nb4ca4537b [Charan Reddy Guttapalem] Move common placementpolicy components to TopologyAwareEnsemblePlacementPolicy.\naa84c7fdd [Charan Reddy Guttapalem] GetListOfEntriesOfLedger implementation\n10859afb7 [Matteo Merli] Added HTTP handler to expose bookie state\n707ae5c85 [karanmehta93] ISSUE #2075: Bookieshell lastmark command isn't functional, always returning 0-0\n41b39c6ef [Charan Reddy Guttapalem] ISSUE #1967: make ledger creation and removal robust to zk connectionloss\n973d2ab0d [Matteo Merli] Use pure python implementation of MurmurHash\n9bb7e4b82 [Venkateswararao Jujjuri (JV)] Explicit error message if extent is not present on ZK (#2066)\nbd699e61d [mtang01] ISSUE #2067: reduce byte[] allocation in add entry\n7c62e1232 [karanmehta93] ISSUE #2073: ReadOnlyBookieTest#testBookieContinueWritingIfMulti\u2026\n42e77802c [Ivan Kelly] DLog Namespace#openLog should declare LogNotFoundException\n86bce12b5 [Yong Zhang] Migrate command `ledgermetadata`\n407cb35e5 [Charan Reddy Guttapalem] ISSUE #1967: make ledger creation and removal robust to zk connectionloss\neaa601404 [Like] Support asynchronous fence request for V2 ReadEntryProcessor\nd23b45ec8 [Ivan Kelly] Fix typo in overview page for 4.8.2\n44ee320b6 [Ivan Kelly] k\n316b71923 [Ivan Kelly] Wait for LAC update even if ledger fenced\n066621507 [Yong Zhang] Migrate command `updatecookie`\n6f3396801 [Yong Zhang] Migrate command `triggeraudit`\n60d993edf [Yong Zhang] Migrate command `autorecovery`\ned008f278 [Yong Zhang] Migrate command `whoisauditor`\n5b8e0971a [Yong Zhang] Migrate command `Whatisinstanceid`\n90c79444d [Yong Zhang] Migrate command `rebuild-db-ledger-locations-index`\n848f8527f [Nicolas Michael] ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation\n06f2b6f50 [Yong Zhang] Migrate command `updateledgers`\n7ad5849b1 [Yong Zhang] Migrate command `regenerate-interleaved-storage-index-file`\nd4dbb6bfb [Dongfa,Huang] Avoid useless verify if LedgerEntryRequest completed\n5c150f283 [Enrico Olivelli] Release notes for 4.9.1\n1246826ba [Yong Zhang] Migrate command `recover`\n1d4cc71fd [Yong Zhang] Migrate command `localconsistencycheck`\n67f83620e [Yong Zhang] Migrate command `readledger`\nbfbd6b023 [Yong Zhang] Migrate command `decommission`\nd40b8b69f [Yong Zhang] Migrate command `readlog`\n95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`\ne2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`\n0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool\n6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`\nc391fe58d [Yong Zhang] Migrate command `readlogmetadata`\n120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`\nbf66235e5 [Yong Zhang] Migrate command `deleteledger`\n751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time\n138a7ae85 [Yong Zhang] Migrate command `metadataformat`\nb043d1694 [Yong Zhang] Migrate command `listledgers`\n4573285db [Ivan Kelly] Docker autobuild hook\ne3d807a32 [Like] Fix IDE complain as there are multi choices for error code\n9524a9f4a [Yong Zhang] Migrate command `readjournal`\n6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed\ne35a108c7 [Like] Fix error message for unrecognized number-of-bookies\n5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null\n6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2\n1448d12aa [Yong Zhang] Migrate command `listfilesondisk`\n4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`\n468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty\nf26a4cae0 [Ivan Kelly] Release notes for v4.8.2\nec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`\n8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`\nfa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl",
        "parent": "https://github.com/apache/bookkeeper/commit/2ff26d69e400d16f533f424c6e95f2f30189e183",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestZkUtils.java"
        ]
    },
    "bookkeeper_5902ee2": {
        "bug_id": "bookkeeper_5902ee2",
        "commit": "https://github.com/apache/bookkeeper/commit/5902ee27be2fb7eeade53f5e8e4afd3fe573ad5c",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/5902ee27be2fb7eeade53f5e8e4afd3fe573ad5c/stream/distributedlog/core/src/main/java/org/apache/distributedlog/impl/logsegment/BKLogSegmentEntryReader.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/stream/distributedlog/core/src/main/java/org/apache/distributedlog/impl/logsegment/BKLogSegmentEntryReader.java?ref=5902ee27be2fb7eeade53f5e8e4afd3fe573ad5c",
                "deletions": 1,
                "filename": "stream/distributedlog/core/src/main/java/org/apache/distributedlog/impl/logsegment/BKLogSegmentEntryReader.java",
                "patch": "@@ -21,6 +21,7 @@\n \n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.Lists;\n+import io.netty.util.ReferenceCountUtil;\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Enumeration;\n@@ -800,7 +801,7 @@ private void readEntriesFromReadAheadCache(PendingReadRequest nextRequest) {\n                         return;\n                     }\n                 } finally {\n-                    removedEntry.release();\n+                    ReferenceCountUtil.safeRelease(removedEntry);\n                 }\n             } else if (skipBrokenEntries && BKException.Code.DigestMatchException == entry.getRc()) {\n                 // skip this entry and move forward",
                "raw_url": "https://github.com/apache/bookkeeper/raw/5902ee27be2fb7eeade53f5e8e4afd3fe573ad5c/stream/distributedlog/core/src/main/java/org/apache/distributedlog/impl/logsegment/BKLogSegmentEntryReader.java",
                "sha": "f414bf4555521862126e49d8ba83ec33db90ff1a",
                "status": "modified"
            }
        ],
        "message": "fix potential NPE when releasing entry that is null\n\nDescriptions of the changes in this PR:\r\n\r\n### Motivation\r\nA interrupt exception can occur during the poll operation of the blocking and cause a NPE to be thrown\r\n\r\n### Changes\r\nCheck if entry is null before trying to release it\r\n\n\nReviewers: Ivan Kelly <ivank@apache.org>, Sijie Guo <sijie@apache.org>, Matteo Merli <mmerli@apache.org>\n\nThis closes #1998 from jerrypeng/fix_NPE",
        "parent": "https://github.com/apache/bookkeeper/commit/6aa73ce050feb247f491a489a42f6e3db09961cf",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestBKLogSegmentEntryReader.java"
        ]
    },
    "bookkeeper_60d993e": {
        "bug_id": "bookkeeper_60d993e",
        "commit": "https://github.com/apache/bookkeeper/commit/60d993edf50417ace9777d2f40cc2bbc97510125",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/bookkeeper/blob/60d993edf50417ace9777d2f40cc2bbc97510125/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=60d993edf50417ace9777d2f40cc2bbc97510125",
                "deletions": 40,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "patch": "@@ -55,11 +55,10 @@\n import org.apache.bookkeeper.conf.ServerConfiguration;\n import org.apache.bookkeeper.meta.LedgerManager;\n import org.apache.bookkeeper.meta.LedgerMetadataSerDe;\n-import org.apache.bookkeeper.meta.LedgerUnderreplicationManager;\n import org.apache.bookkeeper.net.BookieSocketAddress;\n-import org.apache.bookkeeper.replication.ReplicationException;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.ListUnderReplicatedCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.LostBookieRecoveryDelayCommand;\n+import org.apache.bookkeeper.tools.cli.commands.autorecovery.ToggleCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.WhoIsAuditorCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ConvertToDBStorageCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ConvertToInterleavedStorageCommand;\n@@ -114,7 +113,6 @@\n import org.apache.commons.io.FileUtils;\n import org.apache.commons.lang.StringUtils;\n import org.apache.commons.lang3.ArrayUtils;\n-import org.apache.zookeeper.KeeperException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -1290,43 +1288,10 @@ int runCmd(CommandLine cmdLine) throws Exception {\n             boolean disable = cmdLine.hasOption(\"d\");\n             boolean enable = cmdLine.hasOption(\"e\");\n \n-            if (enable && disable) {\n-                LOG.error(\"Only one of -enable and -disable can be specified\");\n-                printUsage();\n-                return 1;\n-            }\n-\n-            runFunctionWithLedgerManagerFactory(bkConf, mFactory -> {\n-                try {\n-                    try (LedgerUnderreplicationManager underreplicationManager =\n-                             mFactory.newLedgerUnderreplicationManager()) {\n-                        if (!enable && !disable) {\n-                            boolean enabled = underreplicationManager.isLedgerReplicationEnabled();\n-                            System.out.println(\"Autorecovery is \" + (enabled ? \"enabled.\" : \"disabled.\"));\n-                        } else if (enable) {\n-                            if (underreplicationManager.isLedgerReplicationEnabled()) {\n-                                LOG.warn(\"Autorecovery already enabled. Doing nothing\");\n-                            } else {\n-                                LOG.info(\"Enabling autorecovery\");\n-                                underreplicationManager.enableLedgerReplication();\n-                            }\n-                        } else {\n-                            if (!underreplicationManager.isLedgerReplicationEnabled()) {\n-                                LOG.warn(\"Autorecovery already disabled. Doing nothing\");\n-                            } else {\n-                                LOG.info(\"Disabling autorecovery\");\n-                                underreplicationManager.disableLedgerReplication();\n-                            }\n-                        }\n-                    }\n-                } catch (InterruptedException e) {\n-                    Thread.currentThread().interrupt();\n-                    throw new UncheckedExecutionException(e);\n-                } catch (KeeperException | ReplicationException e) {\n-                    throw new UncheckedExecutionException(e);\n-                }\n-                return null;\n-            });\n+            ToggleCommand.AutoRecoveryFlags flags = new ToggleCommand.AutoRecoveryFlags()\n+                .enable(enable).status(!disable && !enable);\n+            ToggleCommand cmd = new ToggleCommand();\n+            cmd.apply(bkConf, flags);\n \n             return 0;\n         }",
                "raw_url": "https://github.com/apache/bookkeeper/raw/60d993edf50417ace9777d2f40cc2bbc97510125/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "sha": "eff70edd3ee12f259531ce5c799d0672bbd8c613",
                "status": "modified"
            },
            {
                "additions": 121,
                "blob_url": "https://github.com/apache/bookkeeper/blob/60d993edf50417ace9777d2f40cc2bbc97510125/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/ToggleCommand.java",
                "changes": 121,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/ToggleCommand.java?ref=60d993edf50417ace9777d2f40cc2bbc97510125",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/ToggleCommand.java",
                "patch": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.autorecovery;\n+\n+import com.beust.jcommander.Parameter;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import java.util.concurrent.ExecutionException;\n+import lombok.Setter;\n+import lombok.experimental.Accessors;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.meta.LedgerUnderreplicationManager;\n+import org.apache.bookkeeper.meta.MetadataDrivers;\n+import org.apache.bookkeeper.meta.exceptions.MetadataException;\n+import org.apache.bookkeeper.replication.ReplicationException;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommand;\n+import org.apache.bookkeeper.tools.framework.CliFlags;\n+import org.apache.bookkeeper.tools.framework.CliSpec;\n+import org.apache.zookeeper.KeeperException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Command to enable or disable auto recovery in the cluster.\n+ */\n+public class ToggleCommand extends BookieCommand<ToggleCommand.AutoRecoveryFlags> {\n+\n+    static final Logger LOG = LoggerFactory.getLogger(ToggleCommand.class);\n+\n+    private static final String NAME = \"toggle\";\n+    private static final String DESC = \"Enable or disable auto recovery in the cluster. Default is disable.\";\n+\n+    public ToggleCommand() {\n+        this(new AutoRecoveryFlags());\n+    }\n+\n+    private ToggleCommand(AutoRecoveryFlags flags) {\n+        super(CliSpec.<ToggleCommand.AutoRecoveryFlags>newBuilder()\n+            .withName(NAME).withDescription(DESC)\n+            .withFlags(flags).build());\n+    }\n+\n+    /**\n+     * Flags for auto recovery command.\n+     */\n+    @Accessors(fluent = true)\n+    @Setter\n+    public static class AutoRecoveryFlags extends CliFlags {\n+\n+        @Parameter(names = { \"-e\", \"--enable\" }, description = \"Enable or disable auto recovery of under replicated \"\n+                                                               + \"ledgers.\")\n+        private boolean enable;\n+\n+        @Parameter(names = {\"-s\", \"--status\"}, description = \"Check the auto recovery status.\")\n+        private boolean status;\n+\n+    }\n+\n+    @Override\n+    public boolean apply(ServerConfiguration conf, AutoRecoveryFlags cmdFlags) {\n+        try {\n+            return handler(conf, cmdFlags);\n+        } catch (MetadataException | ExecutionException e) {\n+            throw new UncheckedExecutionException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean handler(ServerConfiguration conf, AutoRecoveryFlags flags)\n+        throws MetadataException, ExecutionException {\n+        MetadataDrivers.runFunctionWithLedgerManagerFactory(conf, mFactory -> {\n+            try {\n+                try (LedgerUnderreplicationManager underreplicationManager = mFactory\n+                         .newLedgerUnderreplicationManager()) {\n+                    if (flags.status) {\n+                        System.out.println(\"Autorecovery is \" + (underreplicationManager.isLedgerReplicationEnabled()\n+                                                                     ? \"enabled.\" : \"disabled.\"));\n+                        return null;\n+                    }\n+                    if (flags.enable) {\n+                        if (underreplicationManager.isLedgerReplicationEnabled()) {\n+                            LOG.warn(\"Autorecovery already enabled. Doing nothing\");\n+                        } else {\n+                            LOG.info(\"Enabling autorecovery\");\n+                            underreplicationManager.enableLedgerReplication();\n+                        }\n+                    } else {\n+                        if (!underreplicationManager.isLedgerReplicationEnabled()) {\n+                            LOG.warn(\"Autorecovery already disabled. Doing nothing\");\n+                        } else {\n+                            LOG.info(\"Disabling autorecovery\");\n+                            underreplicationManager.disableLedgerReplication();\n+                        }\n+                    }\n+                }\n+            } catch (InterruptedException e) {\n+                Thread.currentThread().interrupt();\n+                throw new UncheckedExecutionException(e);\n+            } catch (KeeperException | ReplicationException e) {\n+                throw new UncheckedExecutionException(e);\n+            }\n+            return null;\n+        });\n+        return true;\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/60d993edf50417ace9777d2f40cc2bbc97510125/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/ToggleCommand.java",
                "sha": "c1457153c71389d6eac3be5beb9d85eaa6cfc6de",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/60d993edf50417ace9777d2f40cc2bbc97510125/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java?ref=60d993edf50417ace9777d2f40cc2bbc97510125",
                "deletions": 0,
                "filename": "tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java",
                "patch": "@@ -20,6 +20,7 @@\n \n import static org.apache.bookkeeper.tools.common.BKCommandCategories.CATEGORY_INFRA_SERVICE;\n \n+import org.apache.bookkeeper.tools.cli.commands.autorecovery.ToggleCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.WhoIsAuditorCommand;\n import org.apache.bookkeeper.tools.common.BKFlags;\n import org.apache.bookkeeper.tools.framework.CliCommandGroup;\n@@ -38,6 +39,7 @@\n         .withDescription(DESC)\n         .withCategory(CATEGORY_INFRA_SERVICE)\n         .addCommand(new WhoIsAuditorCommand())\n+        .addCommand(new ToggleCommand())\n         .build();\n \n     public AutoRecoveryCommandGroup() {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/60d993edf50417ace9777d2f40cc2bbc97510125/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java",
                "sha": "aa4d7f4a8a5c060118d74c5ef0e825f3ba75d238",
                "status": "modified"
            },
            {
                "additions": 123,
                "blob_url": "https://github.com/apache/bookkeeper/blob/60d993edf50417ace9777d2f40cc2bbc97510125/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/AutoRecoveryCommandTest.java",
                "changes": 123,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/AutoRecoveryCommandTest.java?ref=60d993edf50417ace9777d2f40cc2bbc97510125",
                "deletions": 0,
                "filename": "tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/AutoRecoveryCommandTest.java",
                "patch": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.autorecovery;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.powermock.api.mockito.PowerMockito.mock;\n+import static org.powermock.api.mockito.PowerMockito.when;\n+\n+import java.util.function.Function;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.meta.LedgerManagerFactory;\n+import org.apache.bookkeeper.meta.LedgerUnderreplicationManager;\n+import org.apache.bookkeeper.meta.MetadataDrivers;\n+import org.apache.bookkeeper.replication.ReplicationException;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommandTestBase;\n+import org.apache.zookeeper.KeeperException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.powermock.api.mockito.PowerMockito;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+\n+/**\n+ * Unit test for {@link ToggleCommand}.\n+ */\n+@RunWith(PowerMockRunner.class)\n+@PrepareForTest({ ToggleCommand.class, MetadataDrivers.class })\n+public class AutoRecoveryCommandTest extends BookieCommandTestBase {\n+\n+    private LedgerManagerFactory ledgerManagerFactory;\n+    private LedgerUnderreplicationManager ledgerUnderreplicationManager;\n+\n+    public AutoRecoveryCommandTest() {\n+        super(3, 0);\n+    }\n+\n+    @Override\n+    public void setup() throws Exception {\n+        super.setup();\n+\n+        PowerMockito.whenNew(ServerConfiguration.class).withNoArguments().thenReturn(conf);\n+\n+        ledgerManagerFactory = mock(LedgerManagerFactory.class);\n+\n+        PowerMockito.mockStatic(MetadataDrivers.class);\n+        PowerMockito.doAnswer(invocationOnMock -> {\n+            Function<LedgerManagerFactory, ?> function = invocationOnMock.getArgument(1);\n+            function.apply(ledgerManagerFactory);\n+            return true;\n+        }).when(MetadataDrivers.class, \"runFunctionWithLedgerManagerFactory\", any(ServerConfiguration.class),\n+                any(Function.class));\n+\n+        ledgerUnderreplicationManager = mock(LedgerUnderreplicationManager.class);\n+        when(ledgerManagerFactory.newLedgerUnderreplicationManager()).thenReturn(ledgerUnderreplicationManager);\n+    }\n+\n+    @Test\n+    public void testWithEnable()\n+        throws InterruptedException, ReplicationException.CompatibilityException, KeeperException,\n+               ReplicationException.UnavailableException {\n+        testCommand(\"-e\");\n+        verify(ledgerManagerFactory, times(1)).newLedgerUnderreplicationManager();\n+        verify(ledgerUnderreplicationManager, times(1)).isLedgerReplicationEnabled();\n+    }\n+\n+    @Test\n+    public void testWithEnableLongArgs() throws ReplicationException.UnavailableException {\n+        when(ledgerUnderreplicationManager.isLedgerReplicationEnabled()).thenReturn(false);\n+        testCommand(\"--enable\");\n+        verify(ledgerUnderreplicationManager, times(1)).enableLedgerReplication();\n+    }\n+\n+    @Test\n+    public void testWithLook()\n+        throws InterruptedException, ReplicationException.CompatibilityException, KeeperException,\n+               ReplicationException.UnavailableException {\n+        testCommand(\"s\");\n+        verify(ledgerManagerFactory, times(1)).newLedgerUnderreplicationManager();\n+        verify(ledgerUnderreplicationManager, times(1)).isLedgerReplicationEnabled();\n+    }\n+\n+    @Test\n+    public void testWithNoArgs()\n+        throws InterruptedException, ReplicationException.CompatibilityException, KeeperException,\n+               ReplicationException.UnavailableException {\n+        testCommand(\"\");\n+        verify(ledgerManagerFactory, times(1)).newLedgerUnderreplicationManager();\n+        verify(ledgerUnderreplicationManager, times(1)).isLedgerReplicationEnabled();\n+    }\n+\n+    @Test\n+    public void testWithNoArgsDisable() throws ReplicationException.UnavailableException {\n+        when(ledgerUnderreplicationManager.isLedgerReplicationEnabled()).thenReturn(true);\n+        testCommand(\"\");\n+        verify(ledgerUnderreplicationManager, times(1)).isLedgerReplicationEnabled();\n+        verify(ledgerUnderreplicationManager, times(1)).disableLedgerReplication();\n+    }\n+\n+    private void testCommand(String... args) {\n+        ToggleCommand cmd = new ToggleCommand();\n+        Assert.assertTrue(cmd.apply(bkFlags, args));\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/60d993edf50417ace9777d2f40cc2bbc97510125/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/AutoRecoveryCommandTest.java",
                "sha": "50c68d7e78d44bafeb17422c13ad38fed6ab0867",
                "status": "added"
            }
        ],
        "message": "Migrate command `autorecovery`\n\nDescriptions of the changes in this PR:\r\n\r\n- Using `bkctl` run command `autorecovery`\r\n\r\n### Motivation\r\n\r\n#2009 \n\nReviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>\n\nThis closes #2010 from zymap/command-autorecovery and squashes the following commits:\n\n6fcd96904 [Yong Zhang] Fix validation\ncd383f372 [Yong Zhang] Rename package\nefb573221 [Yong Zhang] Rename command\n89da2852e [Yong Zhang] Fix error in bookieshell\na037501ee [Yong Zhang] Rename args\n4bb36b0b3 [Yong Zhang] Fix imports postion\ne41a742d3 [Yong Zhang] Add unit test for command `autorecovery`\nb0c91f704 [Yong Zhang] Rename file\ncb06f66de [Yong Zhang] Migrate command `autorecovery`\ned008f278 [Yong Zhang] Migrate command `whoisauditor`\n5b8e0971a [Yong Zhang] Migrate command `Whatisinstanceid`\n90c79444d [Yong Zhang] Migrate command `rebuild-db-ledger-locations-index`\n848f8527f [Nicolas Michael] ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation\n06f2b6f50 [Yong Zhang] Migrate command `updateledgers`\n7ad5849b1 [Yong Zhang] Migrate command `regenerate-interleaved-storage-index-file`\nd4dbb6bfb [Dongfa,Huang] Avoid useless verify if LedgerEntryRequest completed\n5c150f283 [Enrico Olivelli] Release notes for 4.9.1\n1246826ba [Yong Zhang] Migrate command `recover`\n1d4cc71fd [Yong Zhang] Migrate command `localconsistencycheck`\n67f83620e [Yong Zhang] Migrate command `readledger`\nbfbd6b023 [Yong Zhang] Migrate command `decommission`\nd40b8b69f [Yong Zhang] Migrate command `readlog`\n95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`\ne2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`\n0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool\n6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`\nc391fe58d [Yong Zhang] Migrate command `readlogmetadata`\n120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`\nbf66235e5 [Yong Zhang] Migrate command `deleteledger`\n751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time\n138a7ae85 [Yong Zhang] Migrate command `metadataformat`\nb043d1694 [Yong Zhang] Migrate command `listledgers`\n4573285db [Ivan Kelly] Docker autobuild hook\ne3d807a32 [Like] Fix IDE complain as there are multi choices for error code\n9524a9f4a [Yong Zhang] Migrate command `readjournal`\n6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed\ne35a108c7 [Like] Fix error message for unrecognized number-of-bookies\n5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null\n6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2\n1448d12aa [Yong Zhang] Migrate command `listfilesondisk`\n4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`\n468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty\nf26a4cae0 [Ivan Kelly] Release notes for v4.8.2\nec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`\n8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`\nfa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl",
        "parent": "https://github.com/apache/bookkeeper/commit/ed008f27807a75ba384246fc7fae6ca3a5a6971f",
        "repo": "bookkeeper",
        "unit_tests": [
            "BookieShellTest.java"
        ]
    },
    "bookkeeper_67f8362": {
        "bug_id": "bookkeeper_67f8362",
        "commit": "https://github.com/apache/bookkeeper/commit/67f83620eb8ed93bf73322293deb1a1bde8d09c7",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/bookkeeper/blob/67f83620eb8ed93bf73322293deb1a1bde8d09c7/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "changes": 104,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=67f83620eb8ed93bf73322293deb1a1bde8d09c7",
                "deletions": 91,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "patch": "@@ -27,11 +27,6 @@\n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.Lists;\n import com.google.common.util.concurrent.UncheckedExecutionException;\n-import io.netty.buffer.ByteBufUtil;\n-import io.netty.buffer.UnpooledByteBufAllocator;\n-import io.netty.channel.EventLoopGroup;\n-import io.netty.channel.nio.NioEventLoopGroup;\n-import io.netty.util.concurrent.DefaultThreadFactory;\n import java.io.File;\n import java.io.IOException;\n import java.io.Serializable;\n@@ -50,21 +45,15 @@\n import java.util.Comparator;\n import java.util.HashMap;\n import java.util.HashSet;\n-import java.util.Iterator;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n import java.util.Set;\n import java.util.SortedMap;\n import java.util.TreeMap;\n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.TimeUnit;\n import java.util.stream.Collectors;\n-import java.util.stream.LongStream;\n-\n import org.apache.bookkeeper.bookie.BookieException.CookieNotFoundException;\n import org.apache.bookkeeper.bookie.BookieException.InvalidCookieException;\n import org.apache.bookkeeper.bookie.storage.ldb.LocationsIndexRebuildOp;\n@@ -73,11 +62,9 @@\n import org.apache.bookkeeper.client.BookKeeper;\n import org.apache.bookkeeper.client.BookKeeperAdmin;\n import org.apache.bookkeeper.client.LedgerEntry;\n-import org.apache.bookkeeper.client.LedgerHandle;\n import org.apache.bookkeeper.client.UpdateLedgerOp;\n import org.apache.bookkeeper.client.api.LedgerMetadata;\n import org.apache.bookkeeper.common.annotation.InterfaceAudience.Private;\n-import org.apache.bookkeeper.common.util.OrderedExecutor;\n import org.apache.bookkeeper.conf.ClientConfiguration;\n import org.apache.bookkeeper.conf.ServerConfiguration;\n import org.apache.bookkeeper.discover.RegistrationManager;\n@@ -86,12 +73,8 @@\n import org.apache.bookkeeper.meta.LedgerUnderreplicationManager;\n import org.apache.bookkeeper.meta.zk.ZKMetadataDriverBase;\n import org.apache.bookkeeper.net.BookieSocketAddress;\n-import org.apache.bookkeeper.proto.BookieClient;\n-import org.apache.bookkeeper.proto.BookieClientImpl;\n-import org.apache.bookkeeper.proto.BookieProtocol;\n import org.apache.bookkeeper.replication.AuditorElector;\n import org.apache.bookkeeper.replication.ReplicationException;\n-import org.apache.bookkeeper.stats.NullStatsLogger;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.ListUnderReplicatedCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.LostBookieRecoveryDelayCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ConvertToDBStorageCommand;\n@@ -103,6 +86,7 @@\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListFilesOnDiscCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListLedgersCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadJournalCommand;\n+import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLedgerCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLogCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLogMetadataCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.SanityTestCommand;\n@@ -772,91 +756,29 @@ String getUsage() {\n         @Override\n         int runCmd(CommandLine cmdLine) throws Exception {\n             final long ledgerId = getOptionLedgerIdValue(cmdLine, \"ledgerid\", -1);\n-            if (ledgerId == -1) {\n-                System.err.println(\"Must specify a ledger id\");\n-                return -1;\n-            }\n-\n             final long firstEntry = getOptionLongValue(cmdLine, \"firstentryid\", 0);\n             long lastEntry = getOptionLongValue(cmdLine, \"lastentryid\", -1);\n \n             boolean printMsg = cmdLine.hasOption(\"m\");\n             boolean forceRecovery = cmdLine.hasOption(\"r\");\n             final BookieSocketAddress bookie;\n+            String bookieAddress;\n             if (cmdLine.hasOption(\"b\")) {\n                 // A particular bookie was specified\n-                bookie = new BookieSocketAddress(cmdLine.getOptionValue(\"b\"));\n+                bookieAddress = cmdLine.getOptionValue(\"b\");\n             } else {\n-                bookie = null;\n-            }\n-\n-            ClientConfiguration conf = new ClientConfiguration();\n-            conf.addConfiguration(bkConf);\n-\n-            try (BookKeeperAdmin bk = new BookKeeperAdmin(conf)) {\n-                if (forceRecovery) {\n-                    // Force the opening of the ledger to trigger recovery\n-                    try (LedgerHandle lh = bk.openLedger(ledgerId)) {\n-                        if (lastEntry == -1 || lastEntry > lh.getLastAddConfirmed()) {\n-                            lastEntry = lh.getLastAddConfirmed();\n-                        }\n-                    }\n-                }\n-\n-                if (bookie == null) {\n-                    // No bookie was specified, use normal bk client\n-                    Iterator<LedgerEntry> entries = bk.readEntries(ledgerId, firstEntry, lastEntry).iterator();\n-                    while (entries.hasNext()) {\n-                        LedgerEntry entry = entries.next();\n-                        formatEntry(entry, printMsg);\n-                    }\n-                } else {\n-                    // Use BookieClient to target a specific bookie\n-                    EventLoopGroup eventLoopGroup = new NioEventLoopGroup();\n-                    OrderedExecutor executor = OrderedExecutor.newBuilder()\n-                        .numThreads(1)\n-                        .name(\"BookieClientScheduler\")\n-                        .build();\n-\n-                    ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor(\n-                        new DefaultThreadFactory(\"BookKeeperClientSchedulerPool\"));\n-\n-                    BookieClient bookieClient = new BookieClientImpl(conf, eventLoopGroup,\n-                            UnpooledByteBufAllocator.DEFAULT, executor, scheduler, NullStatsLogger.INSTANCE);\n-\n-                    LongStream.range(firstEntry, lastEntry).forEach(entryId -> {\n-                        CompletableFuture<Void> future = new CompletableFuture<>();\n-\n-                        bookieClient.readEntry(bookie, ledgerId, entryId,\n-                            (rc, ledgerId1, entryId1, buffer, ctx) -> {\n-                                if (rc != BKException.Code.OK) {\n-                                    LOG.error(\"Failed to read entry {} -- {}\", entryId1, BKException.getMessage(rc));\n-                                    future.completeExceptionally(BKException.create(rc));\n-                                    return;\n-                                }\n-\n-                                System.out.println(\"--------- Lid=\" + ledgerIdFormatter.formatLedgerId(ledgerId)\n-                                    + \", Eid=\" + entryId + \" ---------\");\n-                                if (printMsg) {\n-                                    System.out.println(\"Data: \" + ByteBufUtil.prettyHexDump(buffer));\n-                                }\n-\n-                                future.complete(null);\n-                                }, null, BookieProtocol.FLAG_NONE);\n-\n-                        try {\n-                            future.get();\n-                        } catch (Exception e) {\n-                            LOG.error(\"Error future.get while reading entries from ledger {}\", ledgerId, e);\n-                        }\n-                    });\n-\n-                    eventLoopGroup.shutdownGracefully();\n-                    executor.shutdown();\n-                    bookieClient.close();\n-                }\n+                bookieAddress = null;\n             }\n \n+            ReadLedgerCommand cmd = new ReadLedgerCommand(entryFormatter, ledgerIdFormatter);\n+            ReadLedgerCommand.ReadLedgerFlags flags = new ReadLedgerCommand.ReadLedgerFlags();\n+            flags.bookieAddresss(bookieAddress);\n+            flags.firstEntryId(firstEntry);\n+            flags.forceRecovery(forceRecovery);\n+            flags.lastEntryId(lastEntry);\n+            flags.ledgerId(ledgerId);\n+            flags.msg(printMsg);\n+            cmd.apply(bkConf, flags);\n             return 0;\n         }\n ",
                "raw_url": "https://github.com/apache/bookkeeper/raw/67f83620eb8ed93bf73322293deb1a1bde8d09c7/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "sha": "98f276c75dcce61ebdd1f4acfa9ba3e1199adf57",
                "status": "modified"
            },
            {
                "additions": 244,
                "blob_url": "https://github.com/apache/bookkeeper/blob/67f83620eb8ed93bf73322293deb1a1bde8d09c7/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommand.java",
                "changes": 244,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommand.java?ref=67f83620eb8ed93bf73322293deb1a1bde8d09c7",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommand.java",
                "patch": "@@ -0,0 +1,244 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.bookie;\n+\n+import com.beust.jcommander.Parameter;\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import io.netty.buffer.ByteBufUtil;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.channel.EventLoopGroup;\n+import io.netty.channel.nio.NioEventLoopGroup;\n+import io.netty.util.concurrent.DefaultThreadFactory;\n+import java.io.IOException;\n+import java.util.Iterator;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.stream.LongStream;\n+import lombok.Setter;\n+import lombok.experimental.Accessors;\n+import org.apache.bookkeeper.client.BKException;\n+import org.apache.bookkeeper.client.BookKeeperAdmin;\n+import org.apache.bookkeeper.client.LedgerEntry;\n+import org.apache.bookkeeper.client.LedgerHandle;\n+import org.apache.bookkeeper.common.util.OrderedExecutor;\n+import org.apache.bookkeeper.conf.ClientConfiguration;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.net.BookieSocketAddress;\n+import org.apache.bookkeeper.proto.BookieClient;\n+import org.apache.bookkeeper.proto.BookieClientImpl;\n+import org.apache.bookkeeper.proto.BookieProtocol;\n+import org.apache.bookkeeper.stats.NullStatsLogger;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommand;\n+import org.apache.bookkeeper.tools.framework.CliFlags;\n+import org.apache.bookkeeper.tools.framework.CliSpec;\n+import org.apache.bookkeeper.util.EntryFormatter;\n+import org.apache.bookkeeper.util.LedgerIdFormatter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Command to read ledger entries.\n+ */\n+public class ReadLedgerCommand extends BookieCommand<ReadLedgerCommand.ReadLedgerFlags> {\n+\n+    static final Logger LOG = LoggerFactory.getLogger(ReadLedgerCommand.class);\n+\n+    private static final String NAME = \"readledger\";\n+    private static final String DESC = \"Read a range of entries from a ledger.\";\n+\n+    EntryFormatter entryFormatter;\n+    LedgerIdFormatter ledgerIdFormatter;\n+\n+    public ReadLedgerCommand() {\n+        this(new ReadLedgerFlags());\n+    }\n+\n+    public ReadLedgerCommand(EntryFormatter entryFormatter, LedgerIdFormatter ledgerIdFormatter) {\n+        this(new ReadLedgerFlags());\n+        this.ledgerIdFormatter = ledgerIdFormatter;\n+        this.entryFormatter = entryFormatter;\n+    }\n+\n+    private ReadLedgerCommand(ReadLedgerFlags flags) {\n+        super(CliSpec.<ReadLedgerFlags>newBuilder()\n+                  .withName(NAME)\n+                  .withDescription(DESC)\n+                  .withFlags(flags)\n+                  .build());\n+    }\n+\n+    /**\n+     * Flags for read ledger command.\n+     */\n+    @Accessors(fluent = true)\n+    @Setter\n+    public static class ReadLedgerFlags extends CliFlags {\n+\n+        @Parameter(names = { \"-m\", \"--msg\" }, description = \"Print message body\")\n+        private boolean msg;\n+\n+        @Parameter(names = { \"-l\", \"--ledgerid\" }, description = \"Ledger ID\")\n+        private long ledgerId = -1;\n+\n+        @Parameter(names = { \"-fe\", \"--firstentryid\" }, description = \"First Entry ID\")\n+        private long firstEntryId = -1;\n+\n+        @Parameter(names = { \"-le\", \"--lastentryid\" }, description = \"Last Entry ID\")\n+        private long lastEntryId = -1;\n+\n+        @Parameter(names = { \"-r\", \"--force-recovery\" },\n+            description = \"Ensure the ledger is properly closed before reading\")\n+        private boolean forceRecovery;\n+\n+        @Parameter(names = { \"-b\", \"--bookie\" }, description = \"Only read from a specific bookie\")\n+        private String bookieAddresss;\n+\n+        @Parameter(names = { \"-lf\", \"--ledgeridformatter\" }, description = \"Set ledger id formatter\")\n+        private String ledgerIdFormatter;\n+\n+        @Parameter(names = { \"-ef\", \"--entryformatter\" }, description = \"Set entry formatter\")\n+        private String entryFormatter;\n+    }\n+\n+    @Override\n+    public boolean apply(ServerConfiguration conf, ReadLedgerFlags cmdFlags) {\n+        if (cmdFlags.ledgerIdFormatter != null && ledgerIdFormatter == null) {\n+            this.ledgerIdFormatter = LedgerIdFormatter.newLedgerIdFormatter(cmdFlags.ledgerIdFormatter, conf);\n+        } else if (ledgerIdFormatter == null) {\n+            this.ledgerIdFormatter = LedgerIdFormatter.newLedgerIdFormatter(conf);\n+        }\n+\n+        if (cmdFlags.entryFormatter != null && entryFormatter == null) {\n+            this.entryFormatter = EntryFormatter.newEntryFormatter(cmdFlags.entryFormatter, conf);\n+        } else if (entryFormatter == null) {\n+            this.entryFormatter = EntryFormatter.newEntryFormatter(conf);\n+        }\n+\n+        try {\n+            return readledger(conf, cmdFlags);\n+        } catch (Exception e) {\n+            throw new UncheckedExecutionException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean readledger(ServerConfiguration serverConf, ReadLedgerFlags flags)\n+        throws InterruptedException, BKException, IOException {\n+\n+        long lastEntry = flags.lastEntryId;\n+\n+        final BookieSocketAddress bookie;\n+        if (flags.bookieAddresss != null) {\n+            // A particular bookie was specified\n+            bookie = new BookieSocketAddress(flags.bookieAddresss);\n+        } else {\n+            bookie = null;\n+        }\n+\n+        ClientConfiguration conf = new ClientConfiguration();\n+        conf.addConfiguration(serverConf);\n+\n+        try (BookKeeperAdmin bk = new BookKeeperAdmin(conf)) {\n+            if (flags.forceRecovery) {\n+                // Force the opening of the ledger to trigger recovery\n+                try (LedgerHandle lh = bk.openLedger(flags.ledgerId)) {\n+                    if (lastEntry == -1 || lastEntry > lh.getLastAddConfirmed()) {\n+                        lastEntry = lh.getLastAddConfirmed();\n+                    }\n+                }\n+            }\n+\n+            if (bookie == null) {\n+                // No bookie was specified, use normal bk client\n+                Iterator<LedgerEntry> entries = bk.readEntries(flags.ledgerId, flags.firstEntryId, lastEntry)\n+                                                  .iterator();\n+                while (entries.hasNext()) {\n+                    LedgerEntry entry = entries.next();\n+                    formatEntry(entry, flags.msg);\n+                }\n+            } else {\n+                // Use BookieClient to target a specific bookie\n+                EventLoopGroup eventLoopGroup = new NioEventLoopGroup();\n+                OrderedExecutor executor = OrderedExecutor.newBuilder()\n+                                                          .numThreads(1)\n+                                                          .name(\"BookieClientScheduler\")\n+                                                          .build();\n+\n+                ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor(\n+                    new DefaultThreadFactory(\"BookKeeperClientSchedulerPool\"));\n+\n+                BookieClient bookieClient = new BookieClientImpl(conf, eventLoopGroup, UnpooledByteBufAllocator.DEFAULT,\n+                                                                 executor, scheduler, NullStatsLogger.INSTANCE);\n+\n+                LongStream.range(flags.firstEntryId, lastEntry).forEach(entryId -> {\n+                    CompletableFuture<Void> future = new CompletableFuture<>();\n+\n+                    bookieClient.readEntry(bookie, flags.ledgerId, entryId,\n+                                           (rc, ledgerId1, entryId1, buffer, ctx) -> {\n+                                               if (rc != BKException.Code.OK) {\n+                                                   LOG.error(\"Failed to read entry {} -- {}\", entryId1,\n+                                                             BKException.getMessage(rc));\n+                                                   future.completeExceptionally(BKException.create(rc));\n+                                                   return;\n+                                               }\n+\n+                                               System.out.println(\n+                                                   \"--------- Lid=\" + ledgerIdFormatter.formatLedgerId(flags.ledgerId)\n+                                                   + \", Eid=\" + entryId + \" ---------\");\n+                                               if (flags.msg) {\n+                                                   System.out.println(\"Data: \" + ByteBufUtil.prettyHexDump(buffer));\n+                                               }\n+\n+                                               future.complete(null);\n+                                           }, null, BookieProtocol.FLAG_NONE);\n+\n+                    try {\n+                        future.get();\n+                    } catch (Exception e) {\n+                        LOG.error(\"Error future.get while reading entries from ledger {}\", flags.ledgerId, e);\n+                    }\n+                });\n+\n+                eventLoopGroup.shutdownGracefully();\n+                executor.shutdown();\n+                bookieClient.close();\n+            }\n+        }\n+        return true;\n+    }\n+\n+    /**\n+     * Format the entry into a readable format.\n+     *\n+     * @param entry\n+     *          ledgerentry to print\n+     * @param printMsg\n+     *          Whether printing the message body\n+     */\n+    private void formatEntry(LedgerEntry entry, boolean printMsg) {\n+        long ledgerId = entry.getLedgerId();\n+        long entryId = entry.getEntryId();\n+        long entrySize = entry.getLength();\n+        System.out.println(\"--------- Lid=\" + ledgerIdFormatter.formatLedgerId(ledgerId) + \", Eid=\" + entryId\n+                           + \", EntrySize=\" + entrySize + \" ---------\");\n+        if (printMsg) {\n+            entryFormatter.formatEntry(entry.getEntry());\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/67f83620eb8ed93bf73322293deb1a1bde8d09c7/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommand.java",
                "sha": "98c1b11cf111bb5223ed22648f77c5aad7cf8e22",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/67f83620eb8ed93bf73322293deb1a1bde8d09c7/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java?ref=67f83620eb8ed93bf73322293deb1a1bde8d09c7",
                "deletions": 0,
                "filename": "tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java",
                "patch": "@@ -30,6 +30,7 @@\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListFilesOnDiscCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ListLedgersCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadJournalCommand;\n+import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLedgerCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLogCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ReadLogMetadataCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.SanityTestCommand;\n@@ -60,6 +61,7 @@\n         .addCommand(new ListLedgersCommand())\n         .addCommand(new ConvertToInterleavedStorageCommand())\n         .addCommand(new ReadJournalCommand())\n+        .addCommand(new ReadLedgerCommand())\n         .addCommand(new ReadLogCommand())\n         .addCommand(new ReadLogMetadataCommand())\n         .build();",
                "raw_url": "https://github.com/apache/bookkeeper/raw/67f83620eb8ed93bf73322293deb1a1bde8d09c7/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/BookieCommandGroup.java",
                "sha": "51e579f027c71c09dd6a3e0217738fd94ebbc4a7",
                "status": "modified"
            },
            {
                "additions": 169,
                "blob_url": "https://github.com/apache/bookkeeper/blob/67f83620eb8ed93bf73322293deb1a1bde8d09c7/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommandTest.java",
                "changes": 169,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommandTest.java?ref=67f83620eb8ed93bf73322293deb1a1bde8d09c7",
                "deletions": 0,
                "filename": "tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommandTest.java",
                "patch": "@@ -0,0 +1,169 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.bookie;\n+\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.powermock.api.mockito.PowerMockito.mock;\n+import static org.powermock.api.mockito.PowerMockito.verifyNew;\n+import static org.powermock.api.mockito.PowerMockito.when;\n+\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.channel.nio.NioEventLoopGroup;\n+import io.netty.util.concurrent.DefaultThreadFactory;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import org.apache.bookkeeper.client.BookKeeperAdmin;\n+import org.apache.bookkeeper.client.LedgerEntry;\n+import org.apache.bookkeeper.client.LedgerHandle;\n+import org.apache.bookkeeper.common.util.OrderedExecutor;\n+import org.apache.bookkeeper.conf.ClientConfiguration;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.net.BookieSocketAddress;\n+import org.apache.bookkeeper.proto.BookieClientImpl;\n+import org.apache.bookkeeper.stats.NullStatsLogger;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommandTestBase;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.powermock.api.mockito.PowerMockito;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+/**\n+ * Unit test for {@link ReadLedgerCommand}.\n+ */\n+@RunWith(PowerMockRunner.class)\n+@PrepareForTest({ ReadLedgerCommand.class, BookKeeperAdmin.class, BookieSocketAddress.class, ClientConfiguration.class,\n+    LedgerHandle.class, LedgerEntry.class, OrderedExecutor.class })\n+public class ReadLedgerCommandTest extends BookieCommandTestBase {\n+\n+    @Mock\n+    private BookieSocketAddress bookieSocketAddress;\n+\n+    @Mock\n+    private ClientConfiguration clientConfiguration;\n+\n+    @Mock\n+    private BookKeeperAdmin bookKeeperAdmin;\n+\n+    @Mock\n+    private LedgerHandle ledgerHandle;\n+\n+    @Mock\n+    private LedgerEntry entry;\n+\n+    @Mock\n+    private NioEventLoopGroup nioEventLoopGroup;\n+\n+    @Mock\n+    private OrderedExecutor orderedExecutor;\n+\n+    @Mock\n+    private ScheduledExecutorService scheduledExecutorService;\n+\n+    @Mock\n+    private DefaultThreadFactory defaultThreadFactory;\n+\n+    @Mock\n+    private BookieClientImpl bookieClient;\n+\n+    public ReadLedgerCommandTest() {\n+        super(3, 0);\n+    }\n+\n+    @Override\n+    public void setup() throws Exception {\n+        super.setup();\n+\n+        PowerMockito.whenNew(ServerConfiguration.class).withNoArguments().thenReturn(conf);\n+        PowerMockito.whenNew(BookieSocketAddress.class).withArguments(anyString()).thenReturn(bookieSocketAddress);\n+        PowerMockito.whenNew(ClientConfiguration.class).withNoArguments().thenReturn(clientConfiguration);\n+        PowerMockito.whenNew(BookKeeperAdmin.class).withParameterTypes(ClientConfiguration.class)\n+                    .withArguments(eq(clientConfiguration)).thenReturn(bookKeeperAdmin);\n+\n+        when(bookKeeperAdmin.openLedger(anyLong())).thenReturn(ledgerHandle);\n+        when(ledgerHandle.getLastAddConfirmed()).thenReturn(1L);\n+\n+        List<LedgerEntry> entries = new LinkedList<>();\n+        entries.add(entry);\n+        when(entry.getLedgerId()).thenReturn(1L);\n+        when(entry.getEntryId()).thenReturn(1L);\n+        when(entry.getLength()).thenReturn(1L);\n+\n+        when(bookKeeperAdmin.readEntries(anyLong(), anyLong(), anyLong())).thenReturn(entries);\n+\n+        PowerMockito.whenNew(NioEventLoopGroup.class).withNoArguments().thenReturn(nioEventLoopGroup);\n+\n+        PowerMockito.mockStatic(OrderedExecutor.class);\n+        OrderedExecutor.Builder builder = mock(OrderedExecutor.Builder.class);\n+        when(OrderedExecutor.newBuilder()).thenReturn(builder);\n+        when(builder.numThreads(anyInt())).thenCallRealMethod();\n+        when(builder.name(anyString())).thenCallRealMethod();\n+        when(builder.build()).thenReturn(orderedExecutor);\n+\n+        PowerMockito.mockStatic(Executors.class);\n+        PowerMockito.whenNew(DefaultThreadFactory.class).withArguments(anyString()).thenReturn(defaultThreadFactory);\n+        when(Executors.newSingleThreadScheduledExecutor(eq(defaultThreadFactory))).thenReturn(scheduledExecutorService);\n+\n+        PowerMockito.whenNew(BookieClientImpl.class)\n+                    .withArguments(eq(clientConfiguration), eq(nioEventLoopGroup), eq(UnpooledByteBufAllocator.DEFAULT),\n+                                   eq(orderedExecutor), eq(scheduledExecutorService), eq(NullStatsLogger.INSTANCE))\n+                    .thenReturn(bookieClient);\n+\n+\n+    }\n+\n+    @Test\n+    public void testWithoutBookieAddress() throws Exception {\n+        ReadLedgerCommand cmd = new ReadLedgerCommand();\n+        Assert.assertTrue(cmd.apply(bkFlags, new String[] { \"-r\" }));\n+        verifyNew(ClientConfiguration.class, times(1)).withNoArguments();\n+        verify(clientConfiguration, times(1)).addConfiguration(eq(conf));\n+        verifyNew(BookKeeperAdmin.class, times(1)).withArguments(eq(clientConfiguration));\n+        verify(bookKeeperAdmin, times(1)).openLedger(anyLong());\n+        verify(ledgerHandle, times(1)).getLastAddConfirmed();\n+        verify(bookKeeperAdmin, times(1)).readEntries(anyLong(), anyLong(), anyLong());\n+        verify(entry, times(1)).getLedgerId();\n+        verify(entry, times(1)).getEntryId();\n+        verify(entry, times(1)).getLength();\n+    }\n+\n+    @Test\n+    public void testWithBookieAddress() throws Exception {\n+        ReadLedgerCommand cmd = new ReadLedgerCommand();\n+        Assert.assertTrue(cmd.apply(bkFlags, new String[] { \"-b\", \"localhost:9000\" }));\n+        verifyNew(NioEventLoopGroup.class, times(1)).withNoArguments();\n+        verifyNew(DefaultThreadFactory.class, times(1)).withArguments(anyString());\n+        verifyNew(BookieClientImpl.class, times(1))\n+            .withArguments(eq(clientConfiguration), eq(nioEventLoopGroup), eq(UnpooledByteBufAllocator.DEFAULT),\n+                           eq(orderedExecutor), eq(scheduledExecutorService), eq(NullStatsLogger.INSTANCE));\n+        verify(nioEventLoopGroup, times(1)).shutdownGracefully();\n+        verify(orderedExecutor, times(1)).shutdown();\n+        verify(bookieClient, times(1)).close();\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/67f83620eb8ed93bf73322293deb1a1bde8d09c7/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/bookie/ReadLedgerCommandTest.java",
                "sha": "7eb651d0472095ea23d4938b3f7ffb98cf4e940b",
                "status": "added"
            }
        ],
        "message": "Migrate command `readledger`\n\nDescriptions of the changes in this PR:\r\n\r\n#2040 \r\n\r\n- Using `bkctl` run `readledger`\r\n\r\n```\r\nRead a range of entries from a ledger.\r\n\r\nUsage:  bkctl bookie readledger [flags]\r\n\r\nFlags:\r\n\r\n    -b, --bookie\r\n        Only read from a specific bookie\r\n\r\n    -ef, --entryformatter\r\n        Set entry formatter\r\n\r\n    -fe, --firstentryid\r\n        First Entry ID\r\n\r\n    -r, --force-recovery\r\n        Ensure the ledger is properly closed before reading\r\n\r\n    -le, --lastentryid\r\n        Last Entry ID\r\n\r\n    -l, --ledgerid\r\n        Ledger ID\r\n\r\n    -lf, --ledgeridformatter\r\n        Set ledger id formatter\r\n\r\n    -m, --msg\r\n        Print message body\r\n\r\n\r\n    -h, --help\r\n        Display help information\r\n```\r\n\n\nReviewers: Jia Zhai <zhaijia@apache.org>, Sijie Guo <sijie@apache.org>\n\nThis closes #2041 from zymap/command-readledger and squashes the following commits:\n\n56b0a4581 [Yong Zhang] Remove unused import\n30dafa85f [Yong Zhang] Merge branch 'master' into command-readledger\nbfbd6b023 [Yong Zhang] Migrate command `decommission`\nd40b8b69f [Yong Zhang] Migrate command `readlog`\n95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`\ne2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`\nc465c4761 [Yong Zhang] Remove unused import\n0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool\n6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`\n931df8c2c [Sijie Guo] Merge branch 'master' into command-readledger\nc391fe58d [Yong Zhang] Migrate command `readlogmetadata`\n120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`\nbf66235e5 [Yong Zhang] Migrate command `deleteledger`\n87e6644f2 [Yong Zhang] Fix some conflict\n5ae05f0d2 [Yong Zhang] Migrate command `readledger`\n751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time\n138a7ae85 [Yong Zhang] Migrate command `metadataformat`\nb043d1694 [Yong Zhang] Migrate command `listledgers`\n4573285db [Ivan Kelly] Docker autobuild hook\ne3d807a32 [Like] Fix IDE complain as there are multi choices for error code\n9524a9f4a [Yong Zhang] Migrate command `readjournal`\n6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed\ne35a108c7 [Like] Fix error message for unrecognized number-of-bookies\n5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null\n6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2\n1448d12aa [Yong Zhang] Migrate command `listfilesondisk`\n4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`\n468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty\nf26a4cae0 [Ivan Kelly] Release notes for v4.8.2\nec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`\n8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`\nfa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl",
        "parent": "https://github.com/apache/bookkeeper/commit/bfbd6b023b68ca0c23bf976274279ac8338181f5",
        "repo": "bookkeeper",
        "unit_tests": [
            "BookieShellTest.java",
            "ReadLedgerCommandTest.java"
        ]
    },
    "bookkeeper_6bb5bd0": {
        "bug_id": "bookkeeper_6bb5bd0",
        "commit": "https://github.com/apache/bookkeeper/commit/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java?ref=6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
                "deletions": 2,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java",
                "patch": "@@ -1288,10 +1288,15 @@ public ServerConfiguration setNumLongPollWorkerThreads(int numThreads) {\n \n     /**\n      * Get the number of threads that should handle long poll requests.\n-     * @return\n+     *\n+     * <p>If the number of threads is zero or negative, bookie will fallback to\n+     * use read threads. If there is no read threads used, it will create a thread pool\n+     * with {@link Runtime#availableProcessors()} threads.\n+     *\n+     * @return the number of threads that should handle long poll requests, default value is 0.\n      */\n     public int getNumLongPollWorkerThreads() {\n-        return getInt(NUM_LONG_POLL_WORKER_THREADS, 10);\n+        return getInt(NUM_LONG_POLL_WORKER_THREADS, 0);\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java",
                "sha": "e9950fd1c9cd3257d00bedceb7677b3eeb9c4176",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/main/java/org/apache/bookkeeper/processor/RequestProcessor.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/processor/RequestProcessor.java?ref=6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
                "deletions": 1,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/processor/RequestProcessor.java",
                "patch": "@@ -25,7 +25,7 @@\n /**\n  * A request processor that is used for processing requests at bookie side.\n  */\n-public interface RequestProcessor {\n+public interface RequestProcessor extends AutoCloseable {\n \n     /**\n      * Close the request processor.",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/main/java/org/apache/bookkeeper/processor/RequestProcessor.java",
                "sha": "2c8cf7af36d362e4ad2f86524d78faafa48e9d8a",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieRequestProcessor.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieRequestProcessor.java?ref=6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
                "deletions": 4,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieRequestProcessor.java",
                "patch": "@@ -56,6 +56,8 @@\n import java.util.concurrent.RejectedExecutionException;\n import java.util.concurrent.TimeUnit;\n \n+import lombok.AccessLevel;\n+import lombok.Getter;\n import org.apache.bookkeeper.auth.AuthProviderFactoryFactory;\n import org.apache.bookkeeper.auth.AuthToken;\n import org.apache.bookkeeper.bookie.Bookie;\n@@ -92,6 +94,7 @@\n     /**\n      * The threadpool used to execute all read entry requests issued to this server.\n      */\n+    @Getter(AccessLevel.PACKAGE)\n     private final OrderedExecutor readThreadPool;\n \n     /**\n@@ -108,6 +111,7 @@\n      * The threadpool used to execute all long poll requests issued to this server\n      * after they are done waiting.\n      */\n+    @Getter(AccessLevel.PACKAGE)\n     private final OrderedExecutor longPollThreadPool;\n \n     /**\n@@ -158,10 +162,18 @@ public BookieRequestProcessor(ServerConfiguration serverCfg, Bookie bookie,\n                 \"BookieWriteThreadPool\",\n                 serverCfg.getMaxPendingAddRequestPerThread(),\n                 statsLogger);\n-        this.longPollThreadPool = createExecutor(\n-                this.serverCfg.getNumLongPollWorkerThreads(),\n+        if (serverCfg.getNumLongPollWorkerThreads() <= 0 && readThreadPool != null) {\n+            this.longPollThreadPool = this.readThreadPool;\n+        } else {\n+            int numThreads = this.serverCfg.getNumLongPollWorkerThreads();\n+            if (numThreads <= 0) {\n+                numThreads = Runtime.getRuntime().availableProcessors();\n+            }\n+            this.longPollThreadPool = createExecutor(\n+                numThreads,\n                 \"BookieLongPollThread-\" + serverCfg.getBookiePort(),\n                 OrderedExecutor.NO_TASK_LIMIT, statsLogger);\n+        }\n         this.highPriorityThreadPool = createExecutor(\n                 this.serverCfg.getNumHighPriorityWorkerThreads(),\n                 \"BookieHighPriorityThread-\" + serverCfg.getBookiePort(),\n@@ -203,7 +215,9 @@ public BookieRequestProcessor(ServerConfiguration serverCfg, Bookie bookie,\n     public void close() {\n         shutdownExecutor(writeThreadPool);\n         shutdownExecutor(readThreadPool);\n-        shutdownExecutor(longPollThreadPool);\n+        if (serverCfg.getNumLongPollWorkerThreads() > 0 || readThreadPool == null) {\n+            shutdownExecutor(longPollThreadPool);\n+        }\n         shutdownExecutor(highPriorityThreadPool);\n     }\n \n@@ -362,7 +376,7 @@ private void processReadRequestV3(final BookkeeperProtocol.Request r, final Chan\n         final ReadEntryProcessorV3 read;\n         final OrderedExecutor threadPool;\n         if (RequestUtils.isLongPollReadRequest(r.getReadRequest())) {\n-            ExecutorService lpThread = null == longPollThreadPool ? null : longPollThreadPool.chooseThread(c);\n+            ExecutorService lpThread = longPollThreadPool.chooseThread(c);\n \n             read = new LongPollReadEntryProcessorV3(r, c, this, fenceThread,\n                                                     lpThread, requestTimer);",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieRequestProcessor.java",
                "sha": "4102e75c80c7a60ed998b8ec36fb01a90fc5744b",
                "status": "modified"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/test/java/org/apache/bookkeeper/proto/TestBookieRequestProcessor.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/proto/TestBookieRequestProcessor.java?ref=6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
                "deletions": 0,
                "filename": "bookkeeper-server/src/test/java/org/apache/bookkeeper/proto/TestBookieRequestProcessor.java",
                "patch": "@@ -21,17 +21,56 @@\n package org.apache.bookkeeper.proto;\n \n import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNotSame;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertSame;\n import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n \n import com.google.protobuf.ByteString;\n+import org.apache.bookkeeper.bookie.Bookie;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n import org.apache.bookkeeper.proto.BookkeeperProtocol.AddRequest;\n import org.apache.bookkeeper.proto.BookkeeperProtocol.ReadRequest;\n+import org.apache.bookkeeper.stats.NullStatsLogger;\n import org.junit.Test;\n \n /**\n  * Test utility methods from bookie request processor.\n  */\n public class TestBookieRequestProcessor {\n+\n+    @Test\n+    public void testConstructLongPollThreads() throws Exception {\n+        // long poll threads == read threads\n+        ServerConfiguration conf = new ServerConfiguration();\n+        try (BookieRequestProcessor processor = new BookieRequestProcessor(\n+            conf, mock(Bookie.class), NullStatsLogger.INSTANCE, null)) {\n+            assertSame(processor.getReadThreadPool(), processor.getLongPollThreadPool());\n+        }\n+\n+        // force create long poll threads if there is no read threads\n+        conf = new ServerConfiguration();\n+        conf.setNumReadWorkerThreads(0);\n+        try (BookieRequestProcessor processor = new BookieRequestProcessor(\n+            conf, mock(Bookie.class), NullStatsLogger.INSTANCE, null)) {\n+            assertNull(processor.getReadThreadPool());\n+            assertNotNull(processor.getLongPollThreadPool());\n+        }\n+\n+        // long poll threads and no read threads\n+        conf = new ServerConfiguration();\n+        conf.setNumReadWorkerThreads(2);\n+        conf.setNumLongPollWorkerThreads(2);\n+        try (BookieRequestProcessor processor = new BookieRequestProcessor(\n+            conf, mock(Bookie.class), NullStatsLogger.INSTANCE, null)) {\n+            assertNotNull(processor.getReadThreadPool());\n+            assertNotNull(processor.getLongPollThreadPool());\n+            assertNotSame(processor.getReadThreadPool(), processor.getLongPollThreadPool());\n+        }\n+    }\n+\n     @Test\n     public void testFlagsV3() {\n         ReadRequest read = ReadRequest.newBuilder()",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/bookkeeper-server/src/test/java/org/apache/bookkeeper/proto/TestBookieRequestProcessor.java",
                "sha": "b212e49e45bbaaefb5ecab85bd3f9abc8ea3033b",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/conf/bk_server.conf",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/conf/bk_server.conf?ref=6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
                "deletions": 1,
                "filename": "conf/bk_server.conf",
                "patch": "@@ -107,7 +107,7 @@ bookiePort=3181\n # numReadWorkerThreads=8\n \n # The number of threads that should handle long poll requests.\n-# numLongPollWorkerThreads=10\n+# numLongPollWorkerThreads=0\n \n # The number of threads used for handling journal callback. If a zero or negative number is provided,\n # the callbacks are executed directly at force write threads.",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/conf/bk_server.conf",
                "sha": "8016a7867f2906e131db97971e525e9a4b4cbe2b",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/site/_data/config/bk_server.yaml",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/site/_data/config/bk_server.yaml?ref=6bb5bd09ab75b66c71827d07eb94c47ab8867c0f",
                "deletions": 1,
                "filename": "site/_data/config/bk_server.yaml",
                "patch": "@@ -55,7 +55,7 @@ groups:\n     default: 8\n   - param: numLongPollWorkerThreads\n     description: The number of threads that handle long poll requests. If zero, long poll requests are handled by [Netty threads](//netty.io/wiki/thread-model.html) directly.\n-    default: 10\n+    default: 0\n   - param: numJournalCallbackThreads\n     description: The number of threads that handle journal callbacks. If zero, journal callbacks are executed directly on force write threads.\n     default: 1",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6bb5bd09ab75b66c71827d07eb94c47ab8867c0f/site/_data/config/bk_server.yaml",
                "sha": "ce45f202803237568e9b342ac1346072968054d7",
                "status": "modified"
            }
        ],
        "message": "longPollThreadPool can not be null\n\nDescriptions of the changes in this PR:\n\n*Problem*\n\nThe long polling logic is built with the assumption that there is a thread pool for scheduling deferred reads.\nSo if people happens to set `numLongPollWorkerThreads` to zero or negative, a null value is passed into long poll requests which causes NPE.\n\n*Solution*\n\nIf `numLongPollWorkerThreads` is set to zero or negative, fall back to use read thread pool. If there is no read thread pool, create a thread pool\naligned with num processors.\n\nWith this change, turn the default value of `long poll threads` to zero. so no additional threads are needed if long poll feature is not used (e.g. at pulsar).\n\nAuthor: Sijie Guo <sijie@apache.org>\n\nReviewers: Enrico Olivelli <eolivelli@gmail.com>, Yiming Zang <yzang2016@gmail.com>, Matteo Merli <mmerli@apache.org>\n\nThis closes #1308 from sijie/validate_number_long_poll_threads",
        "parent": "https://github.com/apache/bookkeeper/commit/15d583cb6162cf6beb10591ad3d0b6f436c81ea0",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestServerConfiguration.java",
            "TestBookieRequestProcessor.java"
        ]
    },
    "bookkeeper_6f33968": {
        "bug_id": "bookkeeper_6f33968",
        "commit": "https://github.com/apache/bookkeeper/commit/6f33968019c3452cefc2d78e0258bb3206d78e8a",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6f33968019c3452cefc2d78e0258bb3206d78e8a/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=6f33968019c3452cefc2d78e0258bb3206d78e8a",
                "deletions": 11,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "patch": "@@ -47,18 +47,17 @@\n import java.util.stream.Collectors;\n import org.apache.bookkeeper.bookie.BookieException.CookieNotFoundException;\n import org.apache.bookkeeper.bookie.BookieException.InvalidCookieException;\n-import org.apache.bookkeeper.client.BookKeeperAdmin;\n import org.apache.bookkeeper.client.LedgerEntry;\n import org.apache.bookkeeper.client.api.LedgerMetadata;\n import org.apache.bookkeeper.common.annotation.InterfaceAudience.Private;\n-import org.apache.bookkeeper.conf.ClientConfiguration;\n import org.apache.bookkeeper.conf.ServerConfiguration;\n import org.apache.bookkeeper.meta.LedgerManager;\n import org.apache.bookkeeper.meta.LedgerMetadataSerDe;\n import org.apache.bookkeeper.net.BookieSocketAddress;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.ListUnderReplicatedCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.LostBookieRecoveryDelayCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.ToggleCommand;\n+import org.apache.bookkeeper.tools.cli.commands.autorecovery.TriggerAuditCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.WhoIsAuditorCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ConvertToDBStorageCommand;\n import org.apache.bookkeeper.tools.cli.commands.bookie.ConvertToInterleavedStorageCommand;\n@@ -1861,15 +1860,8 @@ Options getOptions() {\n \n         @Override\n         public int runCmd(CommandLine cmdLine) throws Exception {\n-            ClientConfiguration adminConf = new ClientConfiguration(bkConf);\n-            BookKeeperAdmin admin = new BookKeeperAdmin(adminConf);\n-            try {\n-                admin.triggerAudit();\n-            } finally {\n-                if (admin != null) {\n-                    admin.close();\n-                }\n-            }\n+            TriggerAuditCommand cmd = new TriggerAuditCommand();\n+            cmd.apply(bkConf, new CliFlags());\n             return 0;\n         }\n     }",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6f33968019c3452cefc2d78e0258bb3206d78e8a/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "sha": "700ce114ea51696ff621ae13c6099261b6bbac3f",
                "status": "modified"
            },
            {
                "additions": 68,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6f33968019c3452cefc2d78e0258bb3206d78e8a/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommand.java",
                "changes": 68,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommand.java?ref=6f33968019c3452cefc2d78e0258bb3206d78e8a",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommand.java",
                "patch": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.autorecovery;\n+\n+import com.google.common.util.concurrent.UncheckedExecutionException;\n+import org.apache.bookkeeper.client.BookKeeperAdmin;\n+import org.apache.bookkeeper.conf.ClientConfiguration;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommand;\n+import org.apache.bookkeeper.tools.framework.CliFlags;\n+import org.apache.bookkeeper.tools.framework.CliSpec;\n+\n+/**\n+ * Command to trigger AuditTask by resetting lostBookieRecoveryDelay to its current value.\n+ */\n+public class TriggerAuditCommand extends BookieCommand<CliFlags> {\n+\n+    private static final String NAME = \"triggeraudit\";\n+    private static final String DESC = \"Force trigger the Audit by resetting the lostBookieRecoveryDelay.\";\n+\n+    public TriggerAuditCommand() {\n+        super(CliSpec.newBuilder()\n+                     .withName(NAME)\n+                     .withDescription(DESC)\n+                     .withFlags(new CliFlags())\n+                     .build());\n+    }\n+\n+    @Override\n+    public boolean apply(ServerConfiguration conf, CliFlags cmdFlags) {\n+        try {\n+            return handler(conf);\n+        } catch (Exception e) {\n+            throw new UncheckedExecutionException(e.getMessage(), e);\n+        }\n+    }\n+\n+    public boolean handler(ServerConfiguration configuration) throws Exception {\n+        ClientConfiguration adminConf = new ClientConfiguration(configuration);\n+        BookKeeperAdmin admin = new BookKeeperAdmin(adminConf);\n+\n+        try {\n+            admin.triggerAudit();\n+        } finally {\n+            if (admin != null) {\n+                admin.close();\n+            }\n+        }\n+\n+        return true;\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6f33968019c3452cefc2d78e0258bb3206d78e8a/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommand.java",
                "sha": "c645a5c99720b817752c35b15d72f144980ada45",
                "status": "added"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6f33968019c3452cefc2d78e0258bb3206d78e8a/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/package-info.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/package-info.java?ref=6f33968019c3452cefc2d78e0258bb3206d78e8a",
                "deletions": 12,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/package-info.java",
                "patch": "@@ -1,4 +1,4 @@\n-/*\n+/**\n  * Licensed to the Apache Software Foundation (ASF) under one\n  * or more contributor license agreements.  See the NOTICE file\n  * distributed with this work for additional information\n@@ -7,17 +7,12 @@\n  * \"License\"); you may not use this file except in compliance\n  * with the License.  You may obtain a copy of the License at\n  *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n  *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-/**\n- * This package provides all autorecovery commands.\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n  */\n package org.apache.bookkeeper.tools.cli.commands.autorecovery;\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6f33968019c3452cefc2d78e0258bb3206d78e8a/bookkeeper-server/src/main/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/package-info.java",
                "sha": "acfe982e304f8fc082610a09360b1a841d9a8aea",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6f33968019c3452cefc2d78e0258bb3206d78e8a/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java?ref=6f33968019c3452cefc2d78e0258bb3206d78e8a",
                "deletions": 0,
                "filename": "tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java",
                "patch": "@@ -20,7 +20,10 @@\n \n import static org.apache.bookkeeper.tools.common.BKCommandCategories.CATEGORY_INFRA_SERVICE;\n \n+import org.apache.bookkeeper.tools.cli.commands.autorecovery.ListUnderReplicatedCommand;\n+import org.apache.bookkeeper.tools.cli.commands.autorecovery.LostBookieRecoveryDelayCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.ToggleCommand;\n+import org.apache.bookkeeper.tools.cli.commands.autorecovery.TriggerAuditCommand;\n import org.apache.bookkeeper.tools.cli.commands.autorecovery.WhoIsAuditorCommand;\n import org.apache.bookkeeper.tools.common.BKFlags;\n import org.apache.bookkeeper.tools.framework.CliCommandGroup;\n@@ -39,7 +42,11 @@\n         .withDescription(DESC)\n         .withCategory(CATEGORY_INFRA_SERVICE)\n         .addCommand(new WhoIsAuditorCommand())\n+        .addCommand(new TriggerAuditCommand())\n         .addCommand(new ToggleCommand())\n+        .addCommand(new TriggerAuditCommand())\n+        .addCommand(new ListUnderReplicatedCommand())\n+        .addCommand(new LostBookieRecoveryDelayCommand())\n         .build();\n \n     public AutoRecoveryCommandGroup() {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6f33968019c3452cefc2d78e0258bb3206d78e8a/tools/ledger/src/main/java/org/apache/bookkeeper/tools/cli/commands/AutoRecoveryCommandGroup.java",
                "sha": "7cc88ea7dfda273bd92f0fd2435ece7f0fb9c775",
                "status": "modified"
            },
            {
                "additions": 81,
                "blob_url": "https://github.com/apache/bookkeeper/blob/6f33968019c3452cefc2d78e0258bb3206d78e8a/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommandTest.java",
                "changes": 81,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommandTest.java?ref=6f33968019c3452cefc2d78e0258bb3206d78e8a",
                "deletions": 0,
                "filename": "tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommandTest.java",
                "patch": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.tools.cli.commands.autorecovery;\n+\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.powermock.api.mockito.PowerMockito.doNothing;\n+import static org.powermock.api.mockito.PowerMockito.mock;\n+import static org.powermock.api.mockito.PowerMockito.verifyNew;\n+\n+import org.apache.bookkeeper.client.BookKeeperAdmin;\n+import org.apache.bookkeeper.conf.AbstractConfiguration;\n+import org.apache.bookkeeper.conf.ClientConfiguration;\n+import org.apache.bookkeeper.conf.ServerConfiguration;\n+import org.apache.bookkeeper.tools.cli.helpers.BookieCommandTestBase;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.powermock.api.mockito.PowerMockito;\n+import org.powermock.core.classloader.annotations.PrepareForTest;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+/**\n+ * Unit test for {@link TriggerAuditCommand}.\n+ */\n+@RunWith(PowerMockRunner.class)\n+@PrepareForTest({TriggerAuditCommand.class})\n+public class TriggerAuditCommandTest extends BookieCommandTestBase {\n+\n+    private ClientConfiguration clientConfiguration;\n+    private BookKeeperAdmin admin;\n+\n+    public TriggerAuditCommandTest() {\n+        super(3, 0);\n+    }\n+\n+    @Override\n+    public void setup() throws Exception {\n+        super.setup();\n+\n+        PowerMockito.whenNew(ServerConfiguration.class).withNoArguments().thenReturn(conf);\n+\n+        clientConfiguration = mock(ClientConfiguration.class);\n+        PowerMockito.whenNew(ClientConfiguration.class).withParameterTypes(AbstractConfiguration.class)\n+                    .withArguments(eq(conf)).thenReturn(clientConfiguration);\n+\n+        admin = mock(BookKeeperAdmin.class);\n+        PowerMockito.whenNew(BookKeeperAdmin.class).withParameterTypes(ClientConfiguration.class)\n+                    .withArguments(eq(clientConfiguration)).thenReturn(admin);\n+\n+        doNothing().when(admin).triggerAudit();\n+    }\n+\n+    @Test\n+    public void testCommand() throws Exception {\n+        TriggerAuditCommand cmd = new TriggerAuditCommand();\n+        Assert.assertTrue(cmd.apply(bkFlags, new String[] { \"\" }));\n+\n+        verifyNew(ClientConfiguration.class, times(1)).withArguments(conf);\n+        verifyNew(BookKeeperAdmin.class, times(1)).withArguments(clientConfiguration);\n+\n+        verify(admin, times(1)).triggerAudit();\n+    }\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/6f33968019c3452cefc2d78e0258bb3206d78e8a/tools/ledger/src/test/java/org/apache/bookkeeper/tools/cli/commands/autorecovery/TriggerAuditCommandTest.java",
                "sha": "b60eaf67ffc39f018375e511845ba372f20f6cac",
                "status": "added"
            }
        ],
        "message": "Migrate command `triggeraudit`\n\nDescriptions of the changes in this PR:\r\n\r\n- Using `bkctl` run command `triggeraudit`\r\n\r\n### Motivation\r\n\r\n#2011 \n\nReviewers: Sijie Guo <sijie@apache.org>, Jia Zhai <zhaijia@apache.org>\n\nThis closes #2012 from zymap/command-triggeraudit and squashes the following commits:\n\n5a4b496ec [Yong Zhang] Fix conflict ---\n236b7d6e5 [Yong Zhang] Fix validation\nb039b637e [Yong Zhang] Rename file\n8bea52522 [Yong Zhang] Remove unused imports\nd39d1e886 [Yong Zhang] Migrate command `triggeraudit`\n60d993edf [Yong Zhang] Migrate command `autorecovery`\ned008f278 [Yong Zhang] Migrate command `whoisauditor`\n5b8e0971a [Yong Zhang] Migrate command `Whatisinstanceid`\n90c79444d [Yong Zhang] Migrate command `rebuild-db-ledger-locations-index`\n848f8527f [Nicolas Michael] ISSUE #2053: Bugfix for Percentile Calculation in FastCodahale Timer Implementation\n06f2b6f50 [Yong Zhang] Migrate command `updateledgers`\n7ad5849b1 [Yong Zhang] Migrate command `regenerate-interleaved-storage-index-file`\nd4dbb6bfb [Dongfa,Huang] Avoid useless verify if LedgerEntryRequest completed\n5c150f283 [Enrico Olivelli] Release notes for 4.9.1\n1246826ba [Yong Zhang] Migrate command `recover`\n1d4cc71fd [Yong Zhang] Migrate command `localconsistencycheck`\n67f83620e [Yong Zhang] Migrate command `readledger`\nbfbd6b023 [Yong Zhang] Migrate command `decommission`\nd40b8b69f [Yong Zhang] Migrate command `readlog`\n95d145a15 [Yong Zhang] Migrate command `nukeexistingcluster`\ne2b1dc7f3 [Yong Zhang] Migrate command `listunderreplicated`\n0988e12c7 [bd2019us] ISSUE #2023: change cached thread pool to fixed thread pool\n6a6d7bbd9 [Yong Zhang] Migrate command `initnewcluster`\nc391fe58d [Yong Zhang] Migrate command `readlogmetadata`\n120d67737 [Yong Zhang] Migrate command `lostbookierecoverydelay`\nbf66235e5 [Yong Zhang] Migrate command `deleteledger`\n751e55fa4 [Arvin] ISSUE #2020: close db properly to avoid open RocksDB failure at the second time\n138a7ae85 [Yong Zhang] Migrate command `metadataformat`\nb043d1694 [Yong Zhang] Migrate command `listledgers`\n4573285db [Ivan Kelly] Docker autobuild hook\ne3d807a32 [Like] Fix IDE complain as there are multi choices for error code\n9524a9f4a [Yong Zhang] Migrate command `readjournal`\n6c3f33f55 [Yong Zhang] Fix when met unexpect entry id crashed\ne35a108c7 [Like] Fix error message for unrecognized number-of-bookies\n5902ee27b [Boyang Jerry Peng] fix potential NPE when releasing entry that is null\n6aa73ce05 [Ivan Kelly] [RELEASE] Update website to include documentation for 4.8.2\n1448d12aa [Yong Zhang] Migrate command `listfilesondisk`\n4de598379 [Yong Zhang] Issue #1987: Migrate command `convert-to-interleaved-storage`\n468743e7e [Matteo Merli] In DbLedgerStorage use default values when config key is present but empty\nf26a4cae0 [Ivan Kelly] Release notes for v4.8.2\nec2636cd2 [Yong Zhang] Issue #1985: Migrate command `convert-to-db-storage`\n8cc7239ac [Yong Zhang] Issue #1982: Migrate command `bookiesanity`\nfa90f0185 [Yong Zhang] Issue #1980: Migrate command `ledger` from shell to bkctl",
        "parent": "https://github.com/apache/bookkeeper/commit/60d993edf50417ace9777d2f40cc2bbc97510125",
        "repo": "bookkeeper",
        "unit_tests": [
            "BookieShellTest.java",
            "TriggerAuditCommandTest.java"
        ]
    },
    "bookkeeper_70d7153": {
        "bug_id": "bookkeeper_70d7153",
        "commit": "https://github.com/apache/bookkeeper/commit/70d7153a3cbe1aaa03c3f2a2f3946ee1964b9f47",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/70d7153a3cbe1aaa03c3f2a2f3946ee1964b9f47/clients/java/base/src/main/java/org/apache/distributedlog/clients/impl/internal/LocationClientImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/clients/java/base/src/main/java/org/apache/distributedlog/clients/impl/internal/LocationClientImpl.java?ref=70d7153a3cbe1aaa03c3f2a2f3946ee1964b9f47",
                "deletions": 1,
                "filename": "clients/java/base/src/main/java/org/apache/distributedlog/clients/impl/internal/LocationClientImpl.java",
                "patch": "@@ -130,7 +130,8 @@ private static boolean shouldRetryOnException(Throwable cause) {\n       () -> fromListenableFuture(\n         locationService.getStorageContainerEndpoint(request),\n         GetStorageContainerEndpointsFunction),\n-      scheduler);\n+      scheduler,\n+      request);\n   }\n \n   @Override",
                "raw_url": "https://github.com/apache/bookkeeper/raw/70d7153a3cbe1aaa03c3f2a2f3946ee1964b9f47/clients/java/base/src/main/java/org/apache/distributedlog/clients/impl/internal/LocationClientImpl.java",
                "sha": "e745cfbc1a8f54f0f23b97229d03dbbe5e0114c8",
                "status": "modified"
            }
        ],
        "message": "Fix NPE on LocalClientImpl",
        "parent": "https://github.com/apache/bookkeeper/commit/039084947d1af19d4d1e01e8ac94bf10ba007ace",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestLocationClientImpl.java"
        ]
    },
    "bookkeeper_9366322": {
        "bug_id": "bookkeeper_9366322",
        "commit": "https://github.com/apache/bookkeeper/commit/9366322bfe3461a44a8b0444e66cd774ea1ac7d8",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/9366322bfe3461a44a8b0444e66cd774ea1ac7d8/CHANGES.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=9366322bfe3461a44a8b0444e66cd774ea1ac7d8",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -46,6 +46,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-177: Index file is lost or some index pages aren't flushed. (sijie via ivank)\n \n+        BOOKKEEPER-113: NPE In BookKeeper test (fpj via ivank)\n+\n       hedwig-server/\n       \n         BOOKKEEPER-140: Hub server doesn't subscribe remote region correctly when a region is down. (Sijie Gou via ivank)",
                "raw_url": "https://github.com/apache/bookkeeper/raw/9366322bfe3461a44a8b0444e66cd774ea1ac7d8/CHANGES.txt",
                "sha": "ce6184a3cf16fc29e5be1b1ae59878306b3ff375",
                "status": "modified"
            },
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/bookkeeper/blob/9366322bfe3461a44a8b0444e66cd774ea1ac7d8/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "changes": 92,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java?ref=9366322bfe3461a44a8b0444e66cd774ea1ac7d8",
                "deletions": 44,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "patch": "@@ -225,11 +225,6 @@ void addEntry(final long ledgerId, byte[] masterKey, final long entryId, Channel\n                   Object ctx, final int options) {\n         final int entrySize = toSend.readableBytes();\n \n-        // if (totalBytesOutstanding.get() > maxMemory) {\n-        // // TODO: how to throttle, throw an exception, or call the callback?\n-        // // Maybe this should be done at the layer above?\n-        // }\n-\n         final CompletionKey completionKey = new CompletionKey(ledgerId, entryId);\n \n         addCompletions.put(completionKey, new AddCompletion(cb, entrySize, ctx));\n@@ -238,30 +233,35 @@ void addEntry(final long ledgerId, byte[] masterKey, final long entryId, Channel\n                               + 4 // for the type of request\n                               + masterKey.length; // for the master key\n \n-        ChannelBuffer header = channel.getConfig().getBufferFactory().getBuffer(totalHeaderSize);\n-        header.writeInt(totalHeaderSize - 4 + entrySize);\n-        header.writeInt(new PacketHeader(BookieProtocol.CURRENT_PROTOCOL_VERSION, \n-                                         BookieProtocol.ADDENTRY, (short)options).toInt());\n-        header.writeBytes(masterKey);\n+        try{\n+            ChannelBuffer header = channel.getConfig().getBufferFactory().getBuffer(totalHeaderSize);\n \n-        ChannelBuffer wrappedBuffer = ChannelBuffers.wrappedBuffer(header, toSend);\n+            header.writeInt(totalHeaderSize - 4 + entrySize);\n+            header.writeInt(new PacketHeader(BookieProtocol.CURRENT_PROTOCOL_VERSION,\n+                                             BookieProtocol.ADDENTRY, (short)options).toInt());\n+            header.writeBytes(masterKey);\n \n-        ChannelFuture future = channel.write(wrappedBuffer);\n-        future.addListener(new ChannelFutureListener() {\n-            @Override\n-            public void operationComplete(ChannelFuture future) throws Exception {\n-                if (future.isSuccess()) {\n-                    if (LOG.isDebugEnabled()) {\n-                        LOG.debug(\"Successfully wrote request for adding entry: \" + entryId + \" ledger-id: \" + ledgerId\n-                                  + \" bookie: \" + channel.getRemoteAddress() + \" entry length: \" + entrySize);\n+            ChannelBuffer wrappedBuffer = ChannelBuffers.wrappedBuffer(header, toSend);\n+\n+            ChannelFuture future = channel.write(wrappedBuffer);\n+            future.addListener(new ChannelFutureListener() {\n+                @Override\n+                public void operationComplete(ChannelFuture future) throws Exception {\n+                    if (future.isSuccess()) {\n+                        if (LOG.isDebugEnabled()) {\n+                            LOG.debug(\"Successfully wrote request for adding entry: \" + entryId + \" ledger-id: \" + ledgerId\n+                                                            + \" bookie: \" + channel.getRemoteAddress() + \" entry length: \" + entrySize);\n+                        }\n+                        // totalBytesOutstanding.addAndGet(entrySize);\n+                    } else {\n+                        errorOutAddKey(completionKey);\n                     }\n-                    // totalBytesOutstanding.addAndGet(entrySize);\n-                } else {\n-                    errorOutAddKey(completionKey);\n                 }\n-            }\n-        });\n-\n+            });\n+        } catch (Throwable e) {\n+            LOG.warn(\"Read entry operation failed\", e);\n+            errorOutReadKey(completionKey);\n+        }\n     }\n \n     public void readEntry(final long ledgerId, final long entryId, ReadEntryCallback cb, Object ctx, final int options) {\n@@ -273,29 +273,33 @@ public void readEntry(final long ledgerId, final long entryId, ReadEntryCallback\n                               + 8 // for ledgerId\n                               + 8; // for entryId\n \n-        ChannelBuffer tmpEntry = channel.getConfig().getBufferFactory().getBuffer(totalHeaderSize);\n-        tmpEntry.writeInt(totalHeaderSize - 4);\n+        try{\n+            ChannelBuffer tmpEntry = channel.getConfig().getBufferFactory().getBuffer(totalHeaderSize);\n+            tmpEntry.writeInt(totalHeaderSize - 4);\n \n-        tmpEntry.writeInt(new PacketHeader(BookieProtocol.CURRENT_PROTOCOL_VERSION, \n-                                           BookieProtocol.READENTRY, (short)options).toInt());\n-        tmpEntry.writeLong(ledgerId);\n-        tmpEntry.writeLong(entryId);\n+            tmpEntry.writeInt(new PacketHeader(BookieProtocol.CURRENT_PROTOCOL_VERSION,\n+                                               BookieProtocol.READENTRY, (short)options).toInt());\n+            tmpEntry.writeLong(ledgerId);\n+            tmpEntry.writeLong(entryId);\n \n-        ChannelFuture future = channel.write(tmpEntry);\n-        future.addListener(new ChannelFutureListener() {\n-            @Override\n-            public void operationComplete(ChannelFuture future) throws Exception {\n-                if (future.isSuccess()) {\n-                    if (LOG.isDebugEnabled()) {\n-                        LOG.debug(\"Successfully wrote request for reading entry: \" + entryId + \" ledger-id: \"\n-                                  + ledgerId + \" bookie: \" + channel.getRemoteAddress());\n+            ChannelFuture future = channel.write(tmpEntry);\n+            future.addListener(new ChannelFutureListener() {\n+                @Override\n+                public void operationComplete(ChannelFuture future) throws Exception {\n+                    if (future.isSuccess()) {\n+                        if (LOG.isDebugEnabled()) {\n+                            LOG.debug(\"Successfully wrote request for reading entry: \" + entryId + \" ledger-id: \"\n+                                                            + ledgerId + \" bookie: \" + channel.getRemoteAddress());\n+                        }\n+                    } else {\n+                        errorOutReadKey(key);\n                     }\n-                } else {\n-                    errorOutReadKey(key);\n                 }\n-            }\n-        });\n-\n+            });\n+        } catch(Throwable e) {\n+            LOG.warn(\"Read entry operation failed\", e);\n+            errorOutReadKey(key);\n+        }\n     }\n \n     public void close() {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/9366322bfe3461a44a8b0444e66cd774ea1ac7d8/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "sha": "75a8e8cdbba384a84a4549daa53270f0fd8bf840",
                "status": "modified"
            }
        ],
        "message": "BOOKKEEPER-113: NPE In BookKeeper test (fpj via ivank)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1293383 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/bookkeeper/commit/2ec70d4dbf2266b17bdb99975f974f30afa65593",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestPerChannelBookieClient.java"
        ]
    },
    "bookkeeper_9bade92": {
        "bug_id": "bookkeeper_9bade92",
        "commit": "https://github.com/apache/bookkeeper/commit/9bade929dd87829a8903e402f6c3e3be366a854a",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/9bade929dd87829a8903e402f6c3e3be366a854a/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=9bade929dd87829a8903e402f6c3e3be366a854a",
                "deletions": 1,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "patch": "@@ -2301,7 +2301,7 @@ public void process(int journalVersion, long offset, ByteBuffer entry) throws IO\n      * Print last log mark\n      */\n     protected void printLastLogMark() throws IOException {\n-        for (Journal journal : journals) {\n+        for (Journal journal : getJournals()) {\n             LogMark lastLogMark = journal.getLastLogMark().getCurMark();\n             System.out.println(\"LastLogMark: Journal Id - \" + lastLogMark.getLogFileId() + \"(\"\n                     + Long.toHexString(lastLogMark.getLogFileId()) + \".txn), Pos - \"",
                "raw_url": "https://github.com/apache/bookkeeper/raw/9bade929dd87829a8903e402f6c3e3be366a854a/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java",
                "sha": "8f9e63fedbdbf0217741e4567e9da8ee77b30912",
                "status": "modified"
            }
        ],
        "message": "BOOKKEEPER-1079: shell lastMark throws NPE\n\nAuthor: Enrico Olivelli <eolivelli@apache.org>\n\nReviewers: Sijie Guo\n\nCloses #167 from eolivelli/BOOKKEEPER-1079",
        "parent": "https://github.com/apache/bookkeeper/commit/fd3331a2769a29c379ed63e21ed2dc3c0f85ba25",
        "repo": "bookkeeper",
        "unit_tests": [
            "BookieShellTest.java"
        ]
    },
    "bookkeeper_c3e96a7": {
        "bug_id": "bookkeeper_c3e96a7",
        "commit": "https://github.com/apache/bookkeeper/commit/c3e96a76be35a0adb6f700491dd0a8786d5b2957",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/bookkeeper/blob/c3e96a76be35a0adb6f700491dd0a8786d5b2957/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/zk/ZKMetadataDriverBase.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/zk/ZKMetadataDriverBase.java?ref=c3e96a76be35a0adb6f700491dd0a8786d5b2957",
                "deletions": 2,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/zk/ZKMetadataDriverBase.java",
                "patch": "@@ -64,19 +64,21 @@ public static String getZKServersFromServiceUri(URI uri) {\n         return uri.getAuthority().replace(\";\", \",\");\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n     public static String resolveZkServers(AbstractConfiguration<?> conf) {\n         String metadataServiceUriStr = conf.getMetadataServiceUriUnchecked();\n         if (null == metadataServiceUriStr) {\n-            return null;\n+            return conf.getZkServers();\n         }\n         URI metadataServiceUri = URI.create(metadataServiceUriStr);\n         return getZKServersFromServiceUri(metadataServiceUri);\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n     public static String resolveZkLedgersRootPath(AbstractConfiguration<?> conf) {\n         String metadataServiceUriStr = conf.getMetadataServiceUriUnchecked();\n         if (null == metadataServiceUriStr) {\n-            return null;\n+            return conf.getZkLedgersRootPath();\n         }\n         URI metadataServiceUri = URI.create(metadataServiceUriStr);\n         return metadataServiceUri.getPath();",
                "raw_url": "https://github.com/apache/bookkeeper/raw/c3e96a76be35a0adb6f700491dd0a8786d5b2957/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/zk/ZKMetadataDriverBase.java",
                "sha": "a9e1a13966de1ccd78ac249d336b29846b3b8a84",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/c3e96a76be35a0adb6f700491dd0a8786d5b2957/stream/distributedlog/pom.xml",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/stream/distributedlog/pom.xml?ref=c3e96a76be35a0adb6f700491dd0a8786d5b2957",
                "deletions": 0,
                "filename": "stream/distributedlog/pom.xml",
                "patch": "@@ -110,3 +110,4 @@\n     </profile>\n   </profiles>\n </project>\n+",
                "raw_url": "https://github.com/apache/bookkeeper/raw/c3e96a76be35a0adb6f700491dd0a8786d5b2957/stream/distributedlog/pom.xml",
                "sha": "44a245f8b713a53f8f318188742bbcf6ef6cb216",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/bookkeeper/blob/c3e96a76be35a0adb6f700491dd0a8786d5b2957/stream/pom.xml",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/stream/pom.xml?ref=c3e96a76be35a0adb6f700491dd0a8786d5b2957",
                "deletions": 0,
                "filename": "stream/pom.xml",
                "patch": "@@ -89,3 +89,4 @@\n   </profiles>\n \n </project>\n+",
                "raw_url": "https://github.com/apache/bookkeeper/raw/c3e96a76be35a0adb6f700491dd0a8786d5b2957/stream/pom.xml",
                "sha": "208e6d0a1cce39d24bb14413fa2866c63f422423",
                "status": "modified"
            }
        ],
        "message": "Fallback to use `getZkServers` and `getZkLedgersPath` when resolving from metadata service uri\n\nDescriptions of the changes in this PR:\n\n*Problme*\n\nDlog tests are failing because dlog is using an external zookeeper client, where both `zkServers` and `metadataServiceUri`\nare not set on client configuration. It will throw NPE when trying to resolve `zkServers` and `zkLedgersRootPath` from metadata service uri.\n\n*Solution*\n\nFallback to use deprecated `getZkServers` and `getZkLedgersPath` when metadata service uri is null\n\nRelated Issues: #1336\n\nAuthor: Sijie Guo <sijie@apache.org>\n\nReviewers: Enrico Olivelli <eolivelli@gmail.com>, Jia Zhai <None>\n\nThis closes #1338 from sijie/fix_dlog_tests",
        "parent": "https://github.com/apache/bookkeeper/commit/3d39435d316bc05e64c4247aeb8455bcd2a96989",
        "repo": "bookkeeper",
        "unit_tests": [
            "ZKMetadataDriverBaseTest.java"
        ]
    },
    "bookkeeper_cdf138e": {
        "bug_id": "bookkeeper_cdf138e",
        "commit": "https://github.com/apache/bookkeeper/commit/cdf138e24b76f934721eb1e82a226d0be296b838",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/cdf138e24b76f934721eb1e82a226d0be296b838/CHANGES.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=cdf138e24b76f934721eb1e82a226d0be296b838",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -42,6 +42,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-559: Fix occasional failure in AuditorBookieTest (ivank via umamahesh)\n \n+        BOOKKEEPER-599: NPE in PerChannelBookieClient (jiannan via sijie)\n+\n     IMPROVEMENTS:\n \n       BOOKKEEPER-555: Make BookieServer use Netty rather than a custom IO server (ivank)",
                "raw_url": "https://github.com/apache/bookkeeper/raw/cdf138e24b76f934721eb1e82a226d0be296b838/CHANGES.txt",
                "sha": "14c1136ba1fc6ec22f6bd3ad563fcdd74f40da70",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/bookkeeper/blob/cdf138e24b76f934721eb1e82a226d0be296b838/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java?ref=cdf138e24b76f934721eb1e82a226d0be296b838",
                "deletions": 2,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "patch": "@@ -569,8 +569,8 @@ void handleAddResponse(BookieProtocol.AddResponse a) {\n \n     void handleReadResponse(BookieProtocol.ReadResponse rr) {\n         if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Got response for read request {} entry length: {}\",\n-                      rr, rr.getData().readableBytes());\n+            LOG.debug(\"Got response for read request {} entry length: {}\", rr,\n+                    rr.getData() != null ? rr.getData().readableBytes() : -1);\n         }\n \n         // convert to BKException code because thats what the uppper",
                "raw_url": "https://github.com/apache/bookkeeper/raw/cdf138e24b76f934721eb1e82a226d0be296b838/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "sha": "4c348b074e68a3cda48f38446c431ac05aae663f",
                "status": "modified"
            }
        ],
        "message": "BOOKKEEPER-599: NPE in PerChannelBookieClient (jiannan via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1465437 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/bookkeeper/commit/b118823702e946ccdeb14843e2691fdd760a59e4",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestPerChannelBookieClient.java"
        ]
    },
    "bookkeeper_f0757e9": {
        "bug_id": "bookkeeper_f0757e9",
        "commit": "https://github.com/apache/bookkeeper/commit/f0757e9ac643d6f36a11be4065d163437180cb7e",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/bookkeeper/blob/f0757e9ac643d6f36a11be4065d163437180cb7e/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java?ref=f0757e9ac643d6f36a11be4065d163437180cb7e",
                "deletions": 10,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "patch": "@@ -876,17 +876,18 @@ private void writeAndFlush(final Channel channel,\n         try {\n             final long startTime = MathUtils.nowInNano();\n             ChannelFuture future = channel.writeAndFlush(request);\n-            future.addListener(new ChannelFutureListener() {\n-                @Override\n-                public void operationComplete(ChannelFuture future) throws Exception {\n-                    if (future.isSuccess()) {\n-                        nettyOpLogger.registerSuccessfulEvent(MathUtils.elapsedNanos(startTime),\n-                                TimeUnit.NANOSECONDS);\n-                        completionObjects.get(key).setOutstanding();\n-                    } else {\n-                        nettyOpLogger.registerFailedEvent(MathUtils.elapsedNanos(startTime),\n-                                TimeUnit.NANOSECONDS);\n+            future.addListener(future1 -> {\n+                if (future1.isSuccess()) {\n+                    nettyOpLogger.registerSuccessfulEvent(MathUtils.elapsedNanos(startTime),\n+                            TimeUnit.NANOSECONDS);\n+                    CompletionValue completion = completionObjects.get(key);\n+                    if (completion != null) {\n+                        completion.setOutstanding();\n                     }\n+\n+                } else {\n+                    nettyOpLogger.registerFailedEvent(MathUtils.elapsedNanos(startTime),\n+                            TimeUnit.NANOSECONDS);\n                 }\n             });\n         } catch (Throwable e) {",
                "raw_url": "https://github.com/apache/bookkeeper/raw/f0757e9ac643d6f36a11be4065d163437180cb7e/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java",
                "sha": "440239f1913dcf63affecaea80779f6c403b72df",
                "status": "modified"
            }
        ],
        "message": "Issue #1241: Fixed NPE in PerChannelBookieClient\n\nThe `CompletionValue` object from the map can be null in some cases and we need to protect for it.\n\nFixes #1241\n\nAuthor: Matteo Merli <mmerli@apache.org>\n\nReviewers: Sijie Guo <sijie@apache.org>\n\nThis closes #1242 from merlimat/fix-npe, closes #1241",
        "parent": "https://github.com/apache/bookkeeper/commit/e3d47ae14a0140b10a6303ecfddbcba66ce90933",
        "repo": "bookkeeper",
        "unit_tests": [
            "TestPerChannelBookieClient.java"
        ]
    },
    "bookkeeper_fbc06ef": {
        "bug_id": "bookkeeper_fbc06ef",
        "commit": "https://github.com/apache/bookkeeper/commit/fbc06ef3139ca857c60a2edbc209c8b088e979df",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/bookkeeper/blob/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeper.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeper.java?ref=fbc06ef3139ca857c60a2edbc209c8b088e979df",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeper.java",
                "patch": "@@ -573,6 +573,10 @@ public BookKeeper(ClientConfiguration conf, ZooKeeper zk, EventLoopGroup eventLo\n         addEntryQuorumTimeoutNanos = 0;\n     }\n \n+    long getAddEntryQuorumTimeoutNanos() {\n+        return addEntryQuorumTimeoutNanos;\n+    }\n+\n \n     public int getExplicitLacInterval() {\n         return explicitLacInterval;",
                "raw_url": "https://github.com/apache/bookkeeper/raw/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeper.java",
                "sha": "b65714763ebe62465d0fcbddec5ab258c9811c27",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/bookkeeper/blob/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java?ref=fbc06ef3139ca857c60a2edbc209c8b088e979df",
                "deletions": 0,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java",
                "patch": "@@ -223,6 +223,10 @@ public void safeRun() {\n         }\n     }\n \n+    BookKeeper getBk() {\n+        return bk;\n+    }\n+\n     protected void initializeExplicitLacFlushPolicy() {\n         if (!metadata.isClosed() && !(this instanceof ReadOnlyLedgerHandle) && bk.getExplicitLacInterval() > 0) {\n             explicitLacFlushPolicy = new ExplicitLacFlushPolicy.ExplicitLacFlushPolicyImpl(this);",
                "raw_url": "https://github.com/apache/bookkeeper/raw/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java",
                "sha": "eebe43ce9c840106f015fa9597a71be67ab8ed43",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/bookkeeper/blob/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/PendingAddOp.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/PendingAddOp.java?ref=fbc06ef3139ca857c60a2edbc209c8b088e979df",
                "deletions": 5,
                "filename": "bookkeeper-server/src/main/java/org/apache/bookkeeper/client/PendingAddOp.java",
                "patch": "@@ -92,10 +92,10 @@ static PendingAddOp create(LedgerHandle lh, ByteBuf payload, AddCallbackWithLate\n         op.entryLength = payload.readableBytes();\n \n         op.completed = false;\n-        op.ackSet = lh.distributionSchedule.getAckSet();\n-        op.addOpLogger = lh.bk.getAddOpLogger();\n-        op.addOpUrCounter = lh.bk.getAddOpUrCounter();\n-        op.timeoutNanos = lh.bk.addEntryQuorumTimeoutNanos;\n+        op.ackSet = lh.getDistributionSchedule().getAckSet();\n+        op.addOpLogger = lh.getBk().getAddOpLogger();\n+        op.addOpUrCounter = lh.getBk().getAddOpUrCounter();\n+        op.timeoutNanos = lh.getBk().getAddEntryQuorumTimeoutNanos();\n         op.pendingWriteRequests = 0;\n         op.callbackTriggered = false;\n         op.hasRun = false;\n@@ -422,7 +422,8 @@ private void maybeRecycle() {\n             ReferenceCountUtil.release(toSend);\n             toSend = null;\n         }\n-        if (toSend == null && pendingWriteRequests == 0) {\n+        // only recycle a pending add op after it has been run.\n+        if (hasRun && toSend == null && pendingWriteRequests == 0) {\n             recyclePendAddOpObject();\n         }\n     }",
                "raw_url": "https://github.com/apache/bookkeeper/raw/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/PendingAddOp.java",
                "sha": "dd5058ef091ef6a287103f9d7be9a13f84bdecf7",
                "status": "modified"
            },
            {
                "additions": 80,
                "blob_url": "https://github.com/apache/bookkeeper/blob/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/PendingAddOpTest.java",
                "changes": 80,
                "contents_url": "https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/PendingAddOpTest.java?ref=fbc06ef3139ca857c60a2edbc209c8b088e979df",
                "deletions": 0,
                "filename": "bookkeeper-server/src/test/java/org/apache/bookkeeper/client/PendingAddOpTest.java",
                "patch": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.bookkeeper.client;\n+\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertSame;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.Unpooled;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.apache.bookkeeper.client.BKException.Code;\n+import org.apache.bookkeeper.stats.NullStatsLogger;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Unit test of {@link PendingAddOp}.\n+ */\n+public class PendingAddOpTest {\n+\n+    private BookKeeper bk;\n+    private LedgerHandle lh;\n+    private ByteBuf payload;\n+\n+    @Before\n+    public void setup() {\n+        bk = mock(BookKeeper.class);\n+        when(bk.getAddEntryQuorumTimeoutNanos()).thenReturn(1000L);\n+        when(bk.getAddOpLogger()).thenReturn(NullStatsLogger.INSTANCE.getOpStatsLogger(\"test\"));\n+        when(bk.getAddOpUrCounter()).thenReturn(NullStatsLogger.INSTANCE.getCounter(\"test\"));\n+        lh = mock(LedgerHandle.class);\n+        when(lh.getBk()).thenReturn(bk);\n+        when(lh.getDistributionSchedule())\n+            .thenReturn(new RoundRobinDistributionSchedule(3, 3, 2));\n+        byte[] data = \"test-pending-add-op\".getBytes(UTF_8);\n+        payload = Unpooled.wrappedBuffer(data);\n+        payload.writerIndex(data.length);\n+    }\n+\n+    @Test\n+    public void testExecuteAfterCancelled() {\n+        AtomicInteger rcHolder = new AtomicInteger(-0xdead);\n+        PendingAddOp op = PendingAddOp.create(\n+            lh, payload, (rc, handle, entryId, qwcLatency, ctx) -> {\n+                rcHolder.set(rc);\n+            }, null);\n+        assertSame(lh, op.lh);\n+\n+        // cancel the op.\n+        op.submitCallback(Code.NotEnoughBookiesException);\n+        // if a op is cancelled, it is not recycled until it has been run.\n+        assertSame(lh, op.lh);\n+        assertEquals(Code.NotEnoughBookiesException, rcHolder.get());\n+\n+        op.run();\n+        // after the op is run, the object is recycled.\n+        assertNull(op.lh);\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/bookkeeper/raw/fbc06ef3139ca857c60a2edbc209c8b088e979df/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/PendingAddOpTest.java",
                "sha": "e9af76ee5311ea51e6af639fb8bbfa7a14ae4883",
                "status": "added"
            }
        ],
        "message": "ISSUE #1229: PendingAddOp can get recycled before it gets executed\n\nDescriptions of the changes in this PR:\n*Problem*\n\nThe PendingAddOp can be recycled when it is cancelled before it is executed. so it will hit NPE when it is actually executed. This is a bug introduced by #1091\n\n*Solution*\n\nOnly recycle PendingAddOp after it has been run.\n\nMaster Issue: #1229\n\nAuthor: Sijie Guo <sijie@apache.org>\n\nReviewers: Andrey Yegorov <None>, Matteo Merli <mmerli@apache.org>, Venkateswararao Jujjuri (JV) <None>\n\nThis closes #1230 from sijie/fix_npe, closes #1229",
        "parent": "https://github.com/apache/bookkeeper/commit/3e51b8116c363604f93bdd0c6b6b71ef3387c8a8",
        "repo": "bookkeeper",
        "unit_tests": [
            "BookKeeperTest.java",
            "PendingAddOpTest.java"
        ]
    }
}