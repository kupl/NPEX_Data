{
    "eagle_44259ae": {
        "bug_id": "eagle_44259ae",
        "commit": "https://github.com/apache/eagle/commit/44259aeca48554b9ee60d127cbc4d39649067943",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/eagle/blob/44259aeca48554b9ee60d127cbc4d39649067943/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/publisher/impl/AlertKafkaPublisher.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/publisher/impl/AlertKafkaPublisher.java?ref=44259aeca48554b9ee60d127cbc4d39649067943",
                "deletions": 1,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/publisher/impl/AlertKafkaPublisher.java",
                "patch": "@@ -75,7 +75,9 @@ public void update(String dedupIntervalMin, Map<String, String> pluginProperties\n         String newBrokerList = pluginProperties.get(PublishConstants.BROKER_LIST).trim();\n         String newTopic = pluginProperties.get(PublishConstants.TOPIC).trim();\n         if (!newBrokerList.equals(this.brokerList)) {\n-            producer.close();\n+            if (producer != null) {\n+                producer.close();\n+            }\n             brokerList = newBrokerList;\n             KafkaProducer newProducer = null;\n             try {",
                "raw_url": "https://github.com/apache/eagle/raw/44259aeca48554b9ee60d127cbc4d39649067943/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/publisher/impl/AlertKafkaPublisher.java",
                "sha": "e9c0c7074b7e40aa6fb76e578989989fa264f2fd",
                "status": "modified"
            }
        ],
        "message": "EAGLE-641: Publishment reload may introduce NPE\n\nThe publishment initialization may have problem which will cause reload NPE.\n\nAuthor: Li, Garrett\nReviewer: ralphsu\n\nThis closes #534",
        "parent": "https://github.com/apache/eagle/commit/c45ac6d57a29cecde179476b93ca53fd2ef89cc1",
        "repo": "eagle",
        "unit_tests": [
            "AlertKafkaPublisherTest.java"
        ]
    },
    "eagle_4dfb528": {
        "bug_id": "eagle_4dfb528",
        "commit": "https://github.com/apache/eagle/commit/4dfb528c4bf2d8935bac78b10a82b6bc15f0be59",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/eagle/blob/4dfb528c4bf2d8935bac78b10a82b6bc15f0be59/eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/engine/coordinator/PolicyDefinition.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/engine/coordinator/PolicyDefinition.java?ref=4dfb528c4bf2d8935bac78b10a82b6bc15f0be59",
                "deletions": 1,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/engine/coordinator/PolicyDefinition.java",
                "patch": "@@ -139,15 +139,18 @@ public boolean equals(Object that) {\n         if (that == this) {\n             return true;\n         }\n+\n         if (!(that instanceof PolicyDefinition)) {\n             return false;\n         }\n+\n         PolicyDefinition another = (PolicyDefinition) that;\n+\n         if (Objects.equals(another.name, this.name)\n             && Objects.equals(another.description, this.description)\n             && CollectionUtils.isEqualCollection(another.inputStreams, this.inputStreams)\n             && CollectionUtils.isEqualCollection(another.outputStreams, this.outputStreams)\n-            && another.definition.equals(this.definition)\n+            && (another.definition != null && another.definition.equals(this.definition))\n             && Objects.equals(this.definition, another.definition)\n             && CollectionUtils.isEqualCollection(another.partitionSpec, this.partitionSpec)\n             // && another.parallelismHint == this.parallelismHint",
                "raw_url": "https://github.com/apache/eagle/raw/4dfb528c4bf2d8935bac78b10a82b6bc15f0be59/eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/engine/coordinator/PolicyDefinition.java",
                "sha": "6df682a6a78048a2f6493875c027a5c8febb921f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/eagle/blob/4dfb528c4bf2d8935bac78b10a82b6bc15f0be59/eagle-core/eagle-alert-parent/eagle-alert/alert-coordinator/src/main/java/org/apache/eagle/alert/coordinator/trigger/DynamicPolicyLoader.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-coordinator/src/main/java/org/apache/eagle/alert/coordinator/trigger/DynamicPolicyLoader.java?ref=4dfb528c4bf2d8935bac78b10a82b6bc15f0be59",
                "deletions": 1,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-coordinator/src/main/java/org/apache/eagle/alert/coordinator/trigger/DynamicPolicyLoader.java",
                "patch": "@@ -66,7 +66,8 @@ public void run() {\n \n             List<String> reallyModifiedPolicies = new ArrayList<>();\n             for (String updatedPolicy : potentiallyModifiedPolicies) {\n-                if (!currPolicies.get(updatedPolicy).equals(cachedPolicies.get(updatedPolicy))) {\n+                if (currPolicies.get(updatedPolicy) != null\n+                        && !currPolicies.get(updatedPolicy).equals(cachedPolicies.get(updatedPolicy))) {\n                     reallyModifiedPolicies.add(updatedPolicy);\n                 }\n             }",
                "raw_url": "https://github.com/apache/eagle/raw/4dfb528c4bf2d8935bac78b10a82b6bc15f0be59/eagle-core/eagle-alert-parent/eagle-alert/alert-coordinator/src/main/java/org/apache/eagle/alert/coordinator/trigger/DynamicPolicyLoader.java",
                "sha": "07ae9660c9fa20fcd722ba9019c98d7029033ff8",
                "status": "modified"
            }
        ],
        "message": "[EAGLE-614]: NPE in DynamicPolicyLoader\n\nAuthor: Zeng, Bryant\nReviewer: ralphsu\n\nThis closes #498",
        "parent": "https://github.com/apache/eagle/commit/74c3cbb5b1653974870e805b717987eb75e5113d",
        "repo": "eagle",
        "unit_tests": [
            "DynamicPolicyLoaderTest.java"
        ]
    },
    "eagle_994a1e5": {
        "bug_id": "eagle_994a1e5",
        "commit": "https://github.com/apache/eagle/commit/994a1e584432e8bef5463be57faf955553bd4d01",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/utils/StreamIdConversion.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/utils/StreamIdConversion.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 2,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/utils/StreamIdConversion.java",
                "patch": "@@ -17,8 +17,8 @@\n  * limitations under the License.\n  */\n public class StreamIdConversion {\n-    private final static String STREAM_ID_TEMPLATE = \"stream_%s_to_%s\";\n-    private final static String STREAM_ID_NUM_TEMPLATE = \"stream_%s\";\n+    public final static String STREAM_ID_TEMPLATE = \"stream_%s_to_%s\";\n+    public final static String STREAM_ID_NUM_TEMPLATE = \"stream_%s\";\n     public static String generateStreamIdBetween(String sourceId, String targetId){\n         return String.format(STREAM_ID_TEMPLATE,sourceId,targetId);\n     }",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-common/src/main/java/org/apache/eagle/alert/utils/StreamIdConversion.java",
                "sha": "88661d1682158e34101c1db5da80fec54d7ccf06",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/PolicyHandlerContext.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/PolicyHandlerContext.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 5,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/PolicyHandlerContext.java",
                "patch": "@@ -22,7 +22,7 @@\n  */\n public class PolicyHandlerContext {\n     private PolicyDefinition policyDefinition;\n-    private PolicyGroupEvaluator parentEvaluator;\n+    private PolicyGroupEvaluator policyEvaluator;\n     private MultiCountMetric policyCounter;\n     private String policyEvaluatorId;\n \n@@ -34,12 +34,12 @@ public void setPolicyDefinition(PolicyDefinition policyDefinition) {\n         this.policyDefinition = policyDefinition;\n     }\n \n-    public PolicyGroupEvaluator getParentEvaluator() {\n-        return parentEvaluator;\n+    public PolicyGroupEvaluator getPolicyEvaluator() {\n+        return policyEvaluator;\n     }\n \n-    public void setParentEvaluator(PolicyGroupEvaluator parentEvaluator) {\n-        this.parentEvaluator = parentEvaluator;\n+    public void setPolicyEvaluator(PolicyGroupEvaluator policyEvaluator) {\n+        this.policyEvaluator = policyEvaluator;\n     }\n \n     public void setPolicyCounter(MultiCountMetric metric) {",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/PolicyHandlerContext.java",
                "sha": "285ca139b924e30242913b231093e7b575573991",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/PolicyGroupEvaluatorImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/PolicyGroupEvaluatorImpl.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 5,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/PolicyGroupEvaluatorImpl.java",
                "patch": "@@ -16,10 +16,6 @@\n  */\n package org.apache.eagle.alert.engine.evaluator.impl;\n \n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-\n import org.apache.eagle.alert.engine.AlertStreamCollector;\n import org.apache.eagle.alert.engine.StreamContext;\n import org.apache.eagle.alert.engine.coordinator.PolicyDefinition;\n@@ -32,6 +28,10 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n public class PolicyGroupEvaluatorImpl implements PolicyGroupEvaluator {\n     private static final long serialVersionUID = -5499413193675985288L;\n \n@@ -141,7 +141,7 @@ private void inplaceAdd(Map<String, PolicyDefinition> policies, Map<String, Poli\n                 PolicyHandlerContext context = new PolicyHandlerContext();\n                 context.setPolicyCounter(this.context.counter());\n                 context.setPolicyDefinition(policy);\n-                context.setParentEvaluator(this);\n+                context.setPolicyEvaluator(this);\n                 context.setPolicyEvaluatorId(policyEvaluatorId);\n                 handler.prepare(collector, context);\n                 handlers.put(policy.getName(), handler);",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/PolicyGroupEvaluatorImpl.java",
                "sha": "228b7fb66335121ed78fa487749970f0be995c4b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/SiddhiPolicyHandler.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/SiddhiPolicyHandler.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 2,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/SiddhiPolicyHandler.java",
                "patch": "@@ -85,8 +85,8 @@ public void receive(Event[] events) {\n                 event.setData(e.getData());\n                 event.setStreamId(outputStream);\n                 event.setPolicy(context.getPolicyDefinition());\n-                if (this.context.getParentEvaluator() != null) {\n-                    event.setCreatedBy(context.getParentEvaluator().getName());\n+                if (this.context.getPolicyEvaluator() != null) {\n+                    event.setCreatedBy(context.getPolicyEvaluator().getName());\n                 }\n                 event.setCreatedTime(System.currentTimeMillis());\n                 event.setSchema(definition);",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/impl/SiddhiPolicyHandler.java",
                "sha": "b9d1eb2a9d040704edb1aac1ead56672c067d857",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/nodata/NoDataPolicyHandler.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/nodata/NoDataPolicyHandler.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 2,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/nodata/NoDataPolicyHandler.java",
                "patch": "@@ -191,8 +191,8 @@ private AlertStreamEvent createAlertEvent(long timestamp, Object[] triggerEvent)\n         event.setData(triggerEvent);\n         event.setStreamId(policyDef.getOutputStreams().get(0));\n         event.setPolicy(context.getPolicyDefinition());\n-        if (this.context.getParentEvaluator() != null) {\n-            event.setCreatedBy(context.getParentEvaluator().getName());\n+        if (this.context.getPolicyEvaluator() != null) {\n+            event.setCreatedBy(context.getPolicyEvaluator().getName());\n         }\n         event.setCreatedTime(System.currentTimeMillis());\n         event.setSchema(sd);",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/evaluator/nodata/NoDataPolicyHandler.java",
                "sha": "9ad7529351004f31dc34245d84675c9a680d42dc",
                "status": "modified"
            },
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AbstractStreamBolt.java",
                "changes": 51,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AbstractStreamBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 3,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AbstractStreamBolt.java",
                "patch": "@@ -16,10 +16,21 @@\n  */\n package org.apache.eagle.alert.engine.runner;\n \n+import java.io.IOException;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n+import backtype.storm.metric.api.MultiCountMetric;\n+import org.apache.eagle.alert.engine.StreamContext;\n+import org.apache.eagle.alert.engine.StreamContextImpl;\n import org.apache.eagle.alert.engine.coordinator.IMetadataChangeNotifyService;\n+import org.apache.eagle.alert.engine.coordinator.StreamDefinition;\n+import org.apache.eagle.alert.engine.coordinator.StreamDefinitionNotFoundException;\n+import org.apache.eagle.alert.engine.model.PartitionedEvent;\n+import org.apache.eagle.alert.engine.serialization.PartitionedEventSerializer;\n+import org.apache.eagle.alert.engine.serialization.SerializationMetadataProvider;\n+import org.apache.eagle.alert.engine.serialization.Serializers;\n import org.apache.eagle.alert.utils.AlertConstants;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -34,15 +45,22 @@\n import com.typesafe.config.Config;\n \n @SuppressWarnings({\"rawtypes\", \"serial\"})\n-public abstract class AbstractStreamBolt extends BaseRichBolt {\n+public abstract class AbstractStreamBolt extends BaseRichBolt implements SerializationMetadataProvider {\n     private static final Logger LOG = LoggerFactory.getLogger(AbstractStreamBolt.class);\n     private IMetadataChangeNotifyService changeNotifyService;\n     private Config config;\n     private List<String> outputStreamIds;\n     protected OutputCollector collector;\n     protected Map stormConf;\n \n-    public AbstractStreamBolt(IMetadataChangeNotifyService changeNotifyService, Config config){\n+    private String boltId;\n+    protected PartitionedEventSerializer serializer;\n+    protected volatile Map<String, StreamDefinition> sdf  = new HashMap<String, StreamDefinition>();\n+    protected volatile String specVersion = \"Not Initialized\";\n+    protected StreamContext streamContext;\n+\n+    public AbstractStreamBolt(String boltId, IMetadataChangeNotifyService changeNotifyService, Config config) {\n+        this.boltId = boltId;\n         this.changeNotifyService = changeNotifyService;\n         this.config = config;\n     }\n@@ -57,15 +75,29 @@ public void declareOutputStreams(List<String> outputStreamIds){\n \n     @Override\n     public void prepare(Map stormConf, TopologyContext context, OutputCollector collector) {\n-        this.stormConf = stormConf;\n         Preconditions.checkNotNull(this.changeNotifyService, \"IMetadataChangeNotifyService is not set yet\");\n+        this.stormConf = stormConf;\n         this.collector = collector;\n+        this.serializer = Serializers.newPartitionedEventSerializer(this);\n         internalPrepare(collector,this.changeNotifyService,this.config,context);\n     }\n \n+\n+    protected PartitionedEvent deserialize(Object object) throws IOException {\n+        // byte[] in higher priority\n+        if(object instanceof byte[]) {\n+            return serializer.deserialize((byte[]) object);\n+        } else if (object instanceof PartitionedEvent){\n+            return (PartitionedEvent) object;\n+        } else {\n+            throw new IllegalStateException(String.format(\"Unsupported event class '%s', expect byte array or PartitionedEvent!\", object == null ? null : object.getClass().getCanonicalName()));\n+        }\n+    }\n+\n     /**\n      * subclass should implement more initialization for example\n      * 1) register metadata change\n+     * 2) init stream context\n      * @param collector\n      * @param metadataManager\n      * @param config\n@@ -92,4 +124,17 @@ public void declareOutputFields(OutputFieldsDeclarer declarer) {\n             declarer.declare(new Fields(AlertConstants.FIELD_0));\n         }\n     }\n+\n+    @Override\n+    public StreamDefinition getStreamDefinition(String streamId) throws StreamDefinitionNotFoundException {\n+        if (sdf.containsKey(streamId)) {\n+            return sdf.get(streamId);\n+        } else {\n+            throw new StreamDefinitionNotFoundException(streamId, specVersion);\n+        }\n+    }\n+\n+    public String getBoltId() {\n+        return boltId;\n+    }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AbstractStreamBolt.java",
                "sha": "fe896d17e9550ea363ca6b5e55c330c7a000ee0d",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertBolt.java",
                "changes": 36,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 31,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertBolt.java",
                "patch": "@@ -31,6 +31,7 @@\n import org.apache.eagle.alert.engine.coordinator.*;\n import org.apache.eagle.alert.engine.evaluator.PolicyGroupEvaluator;\n import org.apache.eagle.alert.engine.evaluator.impl.AlertBoltOutputCollectorWrapper;\n+import org.apache.eagle.alert.engine.evaluator.impl.PolicyGroupEvaluatorImpl;\n import org.apache.eagle.alert.engine.model.PartitionedEvent;\n import org.apache.eagle.alert.engine.router.AlertBoltSpecListener;\n import org.apache.eagle.alert.engine.serialization.PartitionedEventSerializer;\n@@ -61,26 +62,12 @@\n     // mapping from policy name to PolicyDefinition\n     private volatile Map<String, PolicyDefinition> cachedPolicies = new HashMap<>(); // for one streamGroup, there are multiple policies\n \n-    private StreamContext streamContext;\n-    private volatile Map<String, StreamDefinition> sdf  = new HashMap<String, StreamDefinition>();\n-    private PartitionedEventSerializer serializer;\n-    private volatile String specVersion = \"Not Initialized\";\n \n-    public AlertBolt(String boltId, PolicyGroupEvaluator policyGroupEvaluator, Config config, IMetadataChangeNotifyService changeNotifyService){\n-        super(changeNotifyService, config);\n+    public AlertBolt(String boltId, Config config, IMetadataChangeNotifyService changeNotifyService){\n+        super(boltId, changeNotifyService, config);\n         this.boltId = boltId;\n-        this.policyGroupEvaluator = policyGroupEvaluator;\n-    }\n-\n-    PartitionedEvent deserialize(Object object) throws IOException {\n-        // byte[] in higher priority\n-        if(object instanceof byte[]) {\n-            return serializer.deserialize((byte[]) object);\n-        } else if (object instanceof PartitionedEvent){\n-            return (PartitionedEvent) object;\n-        } else {\n-            throw new IllegalStateException(String.format(\"Unsupported event class '%s', expect byte array or PartitionedEvent!\", object == null ? null : object.getClass().getCanonicalName()));\n-        }\n+        this.policyGroupEvaluator = new PolicyGroupEvaluatorImpl(boltId + \"-evaluator_stage1\"); // use bolt id as evaluatorId.\n+        // TODO next stage evaluator\n     }\n \n     @Override\n@@ -108,7 +95,6 @@ public void internalPrepare(OutputCollector collector, IMetadataChangeNotifyServ\n         // instantiate output lock object\n         outputLock = new Object();\n         streamContext = new StreamContextImpl(config,context.registerMetric(\"eagle.evaluator\",new MultiCountMetric(),60),context);\n-        serializer = Serializers.newPartitionedEventSerializer(this);\n         alertOutputCollector = new AlertBoltOutputCollectorWrapper(collector, outputLock,streamContext);\n         policyGroupEvaluator.init(streamContext, alertOutputCollector);\n         metadataChangeNotifyService.registerListener(this);\n@@ -149,16 +135,4 @@ public synchronized void onAlertBoltSpecChange(AlertBoltSpec spec, Map<String, S\n         specVersion = spec.getVersion();\n     }\n \n-    @Override\n-    public StreamDefinition getStreamDefinition(String streamId) throws StreamDefinitionNotFoundException {\n-        if (sdf.containsKey(streamId)) {\n-            return sdf.get(streamId);\n-        } else {\n-            throw new StreamDefinitionNotFoundException(streamId, specVersion);\n-        }\n-    }\n-\n-    public String getBoltId() {\n-        return boltId;\n-    }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertBolt.java",
                "sha": "683e571f15c5d789692a96a8a7b7d9da3b61dedd",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertPublisherBolt.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertPublisherBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 17,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertPublisherBolt.java",
                "patch": "@@ -16,11 +16,13 @@\n  */\n package org.apache.eagle.alert.engine.runner;\n \n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-\n+import backtype.storm.metric.api.MultiCountMetric;\n+import backtype.storm.task.OutputCollector;\n+import backtype.storm.task.TopologyContext;\n+import backtype.storm.topology.OutputFieldsDeclarer;\n+import backtype.storm.tuple.Fields;\n+import backtype.storm.tuple.Tuple;\n+import com.typesafe.config.Config;\n import org.apache.eagle.alert.coordination.model.PublishSpec;\n import org.apache.eagle.alert.engine.StreamContextImpl;\n import org.apache.eagle.alert.engine.coordinator.IMetadataChangeNotifyService;\n@@ -30,29 +32,25 @@\n import org.apache.eagle.alert.engine.model.AlertStreamEvent;\n import org.apache.eagle.alert.engine.publisher.AlertPublishSpecListener;\n import org.apache.eagle.alert.engine.publisher.AlertPublisher;\n+import org.apache.eagle.alert.engine.publisher.impl.AlertPublisherImpl;\n import org.apache.eagle.alert.utils.AlertConstants;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import backtype.storm.metric.api.MultiCountMetric;\n-import backtype.storm.task.OutputCollector;\n-import backtype.storm.task.TopologyContext;\n-import backtype.storm.topology.OutputFieldsDeclarer;\n-import backtype.storm.tuple.Fields;\n-import backtype.storm.tuple.Tuple;\n-\n-import com.typesafe.config.Config;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n \n @SuppressWarnings(\"serial\")\n public class AlertPublisherBolt extends AbstractStreamBolt implements AlertPublishSpecListener {\n     private final static Logger LOG = LoggerFactory.getLogger(AlertPublisherBolt.class);\n     private final AlertPublisher alertPublisher;\n     private volatile Map<String, Publishment> cachedPublishments = new HashMap<>();\n-    private StreamContextImpl streamContext;\n \n-    public AlertPublisherBolt(AlertPublisher alertPublisher, Config config, IMetadataChangeNotifyService coordinatorService){\n-        super(coordinatorService, config);\n-        this.alertPublisher = alertPublisher;\n+    public AlertPublisherBolt(String alertPublisherName, Config config, IMetadataChangeNotifyService coordinatorService){\n+        super(alertPublisherName, coordinatorService, config);\n+        this.alertPublisher = new AlertPublisherImpl(alertPublisherName);\n     }\n \n     @Override\n@@ -109,5 +107,6 @@ public void onAlertPublishSpecChange(PublishSpec pubSpec, Map<String, StreamDefi\n \n         // switch\n         cachedPublishments = newPublishmentsMap;\n+        specVersion = pubSpec.getVersion();\n     }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/AlertPublisherBolt.java",
                "sha": "5f58536b709fe10d47e563dd48c3232107ffb42e",
                "status": "modified"
            },
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/StreamRouterBolt.java",
                "changes": 60,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/StreamRouterBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 44,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/StreamRouterBolt.java",
                "patch": "@@ -16,43 +16,27 @@\n  */\n package org.apache.eagle.alert.engine.runner;\n \n-import java.io.IOException;\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Set;\n-\n+import backtype.storm.metric.api.MultiCountMetric;\n+import backtype.storm.task.OutputCollector;\n+import backtype.storm.task.TopologyContext;\n+import backtype.storm.tuple.Tuple;\n+import com.typesafe.config.Config;\n import org.apache.commons.collections.CollectionUtils;\n import org.apache.eagle.alert.coordination.model.PolicyWorkerQueue;\n import org.apache.eagle.alert.coordination.model.RouterSpec;\n import org.apache.eagle.alert.coordination.model.StreamRouterSpec;\n-import org.apache.eagle.alert.engine.StreamContext;\n import org.apache.eagle.alert.engine.StreamContextImpl;\n-import org.apache.eagle.alert.engine.coordinator.IMetadataChangeNotifyService;\n-import org.apache.eagle.alert.engine.coordinator.MetadataType;\n-import org.apache.eagle.alert.engine.coordinator.StreamDefinition;\n-import org.apache.eagle.alert.engine.coordinator.StreamPartition;\n-import org.apache.eagle.alert.engine.coordinator.StreamSortSpec;\n-import org.apache.eagle.alert.engine.model.PartitionedEvent;\n+import org.apache.eagle.alert.engine.coordinator.*;\n import org.apache.eagle.alert.engine.router.StreamRouter;\n import org.apache.eagle.alert.engine.router.StreamRouterBoltSpecListener;\n import org.apache.eagle.alert.engine.router.impl.StreamRouterBoltOutputCollector;\n-import org.apache.eagle.alert.engine.serialization.PartitionedEventSerializer;\n+import org.apache.eagle.alert.engine.router.impl.StreamRouterImpl;\n import org.apache.eagle.alert.engine.serialization.SerializationMetadataProvider;\n-import org.apache.eagle.alert.engine.serialization.Serializers;\n import org.apache.eagle.alert.utils.AlertConstants;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import backtype.storm.metric.api.MultiCountMetric;\n-import backtype.storm.task.OutputCollector;\n-import backtype.storm.task.TopologyContext;\n-import backtype.storm.tuple.Tuple;\n-\n-import com.typesafe.config.Config;\n+import java.util.*;\n \n public class StreamRouterBolt extends AbstractStreamBolt implements StreamRouterBoltSpecListener, SerializationMetadataProvider{\n     private final static Logger LOG = LoggerFactory.getLogger(StreamRouterBolt.class);\n@@ -63,35 +47,22 @@\n     private volatile Map<StreamPartition, StreamSortSpec> cachedSSS = new HashMap<>();\n     // mapping from StreamPartition(streamId, groupbyspec) to StreamRouterSpec\n     private volatile Map<StreamPartition, StreamRouterSpec> cachedSRS = new HashMap<>();\n-    private volatile Map<String,StreamDefinition> sdf = new HashMap<>();\n-    private PartitionedEventSerializer serializer;\n \n-    public StreamRouterBolt(StreamRouter router, Config config, IMetadataChangeNotifyService changeNotifyService) {\n-        super(changeNotifyService, config);\n-        this.router = router;\n+    public StreamRouterBolt(String boltId, Config config, IMetadataChangeNotifyService changeNotifyService) {\n+        super(boltId, changeNotifyService, config);\n+        this.router = new StreamRouterImpl(boltId + \"-router\");\n     }\n \n-    private StreamContext streamContext;\n \n     @Override\n     public void internalPrepare(OutputCollector collector, IMetadataChangeNotifyService changeNotifyService, Config config, TopologyContext context) {\n         streamContext = new StreamContextImpl(config,context.registerMetric(\"eagle.router\",new MultiCountMetric(),60),context);\n-        serializer= Serializers.newPartitionedEventSerializer(this);\n-        routeCollector = new StreamRouterBoltOutputCollector(this.router.getName(),collector,this.getOutputStreamIds(),streamContext,serializer);\n+        routeCollector = new StreamRouterBoltOutputCollector(getBoltId(),collector,this.getOutputStreamIds(),streamContext,serializer);\n         router.prepare(streamContext, routeCollector);\n         changeNotifyService.registerListener(this);\n         changeNotifyService.init(config, MetadataType.STREAM_ROUTER_BOLT);\n     }\n \n-    PartitionedEvent deserialize(Object object) throws IOException {\n-        // byte[] in higher priority\n-        if(object instanceof byte[]) {\n-            return serializer.deserialize((byte[]) object);\n-        } else {\n-            return (PartitionedEvent) object;\n-        }\n-    }\n-\n     @Override\n     public void execute(Tuple input) {\n         try {\n@@ -184,6 +155,7 @@ public void onStreamRouteBoltSpecChange(RouterSpec spec, Map<String, StreamDefin\n         // switch cache\n         cachedSRS = newSRS;\n         sdf = sds;\n+        specVersion = spec.getVersion();\n     }\n \n     /**\n@@ -206,8 +178,8 @@ private void sanityCheck(RouterSpec spec){\n         }\n     }\n \n-    @Override\n-    public StreamDefinition getStreamDefinition(String streamId) {\n-        return this.sdf.get(streamId);\n+    public StreamRouter getStreamRouter() {\n+        return router;\n     }\n+\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/StreamRouterBolt.java",
                "sha": "0c1d12ccd09f2c86490bed13d1997765b828471e",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/UnitTopologyRunner.java",
                "changes": 37,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/UnitTopologyRunner.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 24,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/UnitTopologyRunner.java",
                "patch": "@@ -19,30 +19,25 @@\n \n package org.apache.eagle.alert.engine.runner;\n \n-import java.util.ArrayList;\n-import java.util.List;\n-\n-import org.apache.eagle.alert.engine.coordinator.IMetadataChangeNotifyService;\n-import org.apache.eagle.alert.engine.coordinator.impl.ZKMetadataChangeNotifyService;\n-import org.apache.eagle.alert.engine.evaluator.impl.PolicyGroupEvaluatorImpl;\n-import org.apache.eagle.alert.engine.publisher.impl.AlertPublisherImpl;\n-import org.apache.eagle.alert.engine.router.impl.StreamRouterImpl;\n-import org.apache.eagle.alert.engine.spout.CorrelationSpout;\n-import org.apache.eagle.alert.utils.AlertConstants;\n-import org.apache.eagle.alert.utils.StreamIdConversion;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n import backtype.storm.LocalCluster;\n import backtype.storm.StormSubmitter;\n import backtype.storm.generated.StormTopology;\n import backtype.storm.topology.BoltDeclarer;\n import backtype.storm.topology.TopologyBuilder;\n import backtype.storm.tuple.Fields;\n import backtype.storm.utils.Utils;\n-\n import com.typesafe.config.Config;\n import com.typesafe.config.ConfigRenderOptions;\n+import org.apache.eagle.alert.engine.coordinator.IMetadataChangeNotifyService;\n+import org.apache.eagle.alert.engine.coordinator.impl.ZKMetadataChangeNotifyService;\n+import org.apache.eagle.alert.engine.spout.CorrelationSpout;\n+import org.apache.eagle.alert.utils.AlertConstants;\n+import org.apache.eagle.alert.utils.StreamIdConversion;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n /**\n  * By default\n@@ -86,11 +81,8 @@ public StormTopology buildTopology(String topologyId,\n                               int numOfPublishTasks,\n                               Config config) {\n \n-        StreamRouterImpl[] routers = new StreamRouterImpl[numOfRouterBolts];\n         StreamRouterBolt[] routerBolts = new StreamRouterBolt[numOfRouterBolts];\n-        PolicyGroupEvaluatorImpl[] evaluators = new PolicyGroupEvaluatorImpl[numOfAlertBolts];\n         AlertBolt[] alertBolts = new AlertBolt[numOfAlertBolts];\n-        AlertPublisherImpl publisher;\n         AlertPublisherBolt publisherBolt;\n \n         TopologyBuilder builder = new TopologyBuilder();\n@@ -102,19 +94,16 @@ public StormTopology buildTopology(String topologyId,\n \n         // construct StreamRouterBolt objects\n         for(int i=0; i<numOfRouterBolts; i++){\n-            routers[i] = new StreamRouterImpl(streamRouterBoltNamePrefix + i);\n-            routerBolts[i] = new StreamRouterBolt(routers[i], config, getMetadataChangeNotifyService());\n+            routerBolts[i] = new StreamRouterBolt(streamRouterBoltNamePrefix + i, config, getMetadataChangeNotifyService());\n         }\n \n         // construct AlertBolt objects\n         for(int i=0; i<numOfAlertBolts; i++){\n-            evaluators[i] = new PolicyGroupEvaluatorImpl(alertBoltNamePrefix + i);\n-            alertBolts[i] = new AlertBolt(alertBoltNamePrefix+i, evaluators[i], config, getMetadataChangeNotifyService());\n+            alertBolts[i] = new AlertBolt(alertBoltNamePrefix+i, config, getMetadataChangeNotifyService());\n         }\n \n         // construct AlertPublishBolt object\n-        publisher = new AlertPublisherImpl(alertPublishBoltName);\n-        publisherBolt = new AlertPublisherBolt(publisher, config, getMetadataChangeNotifyService());\n+        publisherBolt = new AlertPublisherBolt(alertPublishBoltName, config, getMetadataChangeNotifyService());\n \n         // connect spout and router bolt, also define output streams for downstreaming alert bolt\n         for(int i=0; i<numOfRouterBolts; i++){",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/main/java/org/apache/eagle/alert/engine/runner/UnitTopologyRunner.java",
                "sha": "87faf821e4020f2c380f53c4204d5b6ad4a0270b",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertBolt.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 1,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertBolt.java",
                "patch": "@@ -167,7 +167,7 @@ private AlertBolt createAlertBolt(OutputCollector collector) {\n         Config config = ConfigFactory.load();\n         PolicyGroupEvaluator policyGroupEvaluator = new PolicyGroupEvaluatorImpl(\"testPolicyGroupEvaluatorImpl\");\n         TestStreamRouterBolt.MockChangeService mockChangeService = new TestStreamRouterBolt.MockChangeService();\n-        AlertBolt bolt = new AlertBolt(\"alertBolt1\", policyGroupEvaluator, config, mockChangeService);\n+        AlertBolt bolt = new AlertBolt(\"alertBolt1\", config, mockChangeService);\n         Map stormConf = new HashMap<>();\n         TopologyContext topologyContext = mock(TopologyContext.class);\n         when(topologyContext.registerMetric(any(String.class), any(MultiCountMetric.class), any(int.class))).thenReturn(new MultiCountMetric());",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertBolt.java",
                "sha": "7dea16757e067bb90d6afd62c895ea7a8fe9fe20",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertPublisherBolt.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertPublisherBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 2,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertPublisherBolt.java",
                "patch": "@@ -87,8 +87,7 @@ public void testMapComparator() {\n         comparator.compare();\n         Assert.assertTrue(comparator.getModified().size() == 1);\n \n-        AlertPublisher alertPublisher = new AlertPublisherImpl(\"alert-publisher-test\");\n-        AlertPublisherBolt publisherBolt = new AlertPublisherBolt(alertPublisher, null, null);\n+        AlertPublisherBolt publisherBolt = new AlertPublisherBolt(\"alert-publisher-test\", null, null);\n         publisherBolt.onAlertPublishSpecChange(spec1, null);\n         publisherBolt.onAlertPublishSpecChange(spec2, null);\n     }",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/router/TestAlertPublisherBolt.java",
                "sha": "01f6de7ca43f1f130eeddb4d7136815f2ee82fa4",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/runner/TestStreamRouterBolt.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/runner/TestStreamRouterBolt.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 14,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/runner/TestStreamRouterBolt.java",
                "patch": "@@ -42,6 +42,7 @@\n import org.apache.eagle.alert.engine.model.StreamEvent;\n import org.apache.eagle.alert.engine.router.impl.StreamRouterImpl;\n import org.apache.eagle.alert.utils.DateTimeUtil;\n+import org.apache.eagle.alert.utils.StreamIdConversion;\n import org.joda.time.Period;\n import org.junit.Assert;\n import org.junit.Test;\n@@ -77,9 +78,8 @@\n     @Test\n     public void testRouterWithSortAndRouteSpec() throws Exception{\n         Config config = ConfigFactory.load();\n-        StreamRouterImpl routerImpl = new StreamRouterImpl(\"testStreamRouterImpl\");\n         MockChangeService mockChangeService = new MockChangeService();\n-        StreamRouterBolt bolt = new StreamRouterBolt(routerImpl, config, mockChangeService);\n+        StreamRouterBolt routerBolt = new StreamRouterBolt(\"routerBolt1\", config, mockChangeService);\n \n         final Map<String,List<PartitionedEvent>> streamCollected = new HashMap<>();\n         final List<PartitionedEvent> orderCollected = new ArrayList<>();\n@@ -90,7 +90,7 @@ public void testRouterWithSortAndRouteSpec() throws Exception{\n             public List<Integer> emit(String streamId, Collection<Tuple> anchors, List<Object> tuple) {\n                 PartitionedEvent event;\n                 try {\n-                    event = bolt.deserialize(tuple.get(0));\n+                    event = routerBolt.deserialize(tuple.get(0));\n                 } catch (IOException e) {\n                     throw new RuntimeException(e);\n                 }\n@@ -120,7 +120,7 @@ public void reportError(Throwable error) {            }\n         Map stormConf = new HashMap<>();\n         TopologyContext topologyContext = mock(TopologyContext.class);\n         when(topologyContext.registerMetric(any(String.class), any(MultiCountMetric.class), any(int.class))).thenReturn(new MultiCountMetric());\n-        bolt.prepare(stormConf, topologyContext, collector);\n+        routerBolt.prepare(stormConf, topologyContext, collector);\n \n         String streamId = \"cpuUsageStream\";\n         // StreamPartition, groupby col1 for stream cpuUsageStream\n@@ -147,6 +147,7 @@ public void reportError(Throwable error) {            }\n         queue.setWorkers(Arrays.asList(new WorkSlot(\"testTopology\",\"alertBolt1\"), new WorkSlot(\"testTopology\",\"alertBolt2\")));\n         routerSpec.setTargetQueue(Collections.singletonList(queue));\n         boltSpec.addRouterSpec(routerSpec);\n+        boltSpec.setVersion(\"version1\");\n \n         // construct StreamDefinition\n         StreamDefinition schema = new StreamDefinition();\n@@ -158,8 +159,8 @@ public void reportError(Throwable error) {            }\n         Map<String, StreamDefinition> sds = new HashMap<>();\n         sds.put(schema.getStreamId(), schema);\n \n-        bolt.declareOutputStreams(Arrays.asList(\"alertBolt1\", \"alertBolt2\"));\n-        bolt.onStreamRouteBoltSpecChange(boltSpec, sds);\n+        routerBolt.declareOutputStreams(Arrays.asList(\"alertBolt1\", \"alertBolt2\"));\n+        routerBolt.onStreamRouteBoltSpecChange(boltSpec, sds);\n         GeneralTopologyContext context = mock(GeneralTopologyContext.class);\n         int taskId = 1;\n         when(context.getComponentId(taskId)).thenReturn(\"comp1\");\n@@ -185,7 +186,7 @@ public void reportError(Throwable error) {            }\n         pEvent.setEvent(event);\n         pEvent.setPartition(sp);\n         Tuple input = new TupleImpl(context, Collections.singletonList(pEvent), taskId, \"default\");\n-        bolt.execute(input);\n+        routerBolt.execute(input);\n \n         // construct another event with \"value2\"\n         event = new StreamEvent();\n@@ -197,7 +198,7 @@ public void reportError(Throwable error) {            }\n         pEvent.setPartition(sp);\n         pEvent.setEvent(event);\n         input = new TupleImpl(context, Collections.singletonList(pEvent), taskId, \"default\");\n-        bolt.execute(input);\n+        routerBolt.execute(input);\n \n         // construct another event with \"value3\"\n         event = new StreamEvent();\n@@ -209,7 +210,7 @@ public void reportError(Throwable error) {            }\n         pEvent.setPartition(sp);\n         pEvent.setEvent(event);\n         input = new TupleImpl(context, Collections.singletonList(pEvent), taskId, \"default\");\n-        bolt.execute(input);\n+        routerBolt.execute(input);\n \n         // construct another event with \"value4\"\n         event = new StreamEvent();\n@@ -221,7 +222,7 @@ public void reportError(Throwable error) {            }\n         pEvent.setPartition(sp);\n         pEvent.setEvent(event);\n         input = new TupleImpl(context, Collections.singletonList(pEvent), taskId, \"default\");\n-        bolt.execute(input);\n+        routerBolt.execute(input);\n \n         // construct another event with \"value5\", which will be thrown because two late\n         event = new StreamEvent();\n@@ -233,18 +234,20 @@ public void reportError(Throwable error) {            }\n         pEvent.setPartition(sp);\n         pEvent.setEvent(event);\n         input = new TupleImpl(context, Collections.singletonList(pEvent), taskId, \"default\");\n-        bolt.execute(input);\n+        routerBolt.execute(input);\n \n         Assert.assertEquals(\"Should finally collect two streams\",2,streamCollected.size());\n-        Assert.assertTrue(\"Should collect stream stream_testStreamRouterImpl_to_alertBolt1\",streamCollected.keySet().contains(\"stream_testStreamRouterImpl_to_alertBolt1\"));\n-        Assert.assertTrue(\"Should collect stream stream_testStreamRouterImpl_to_alertBolt2\",streamCollected.keySet().contains(\"stream_testStreamRouterImpl_to_alertBolt2\"));\n+        Assert.assertTrue(\"Should collect stream stream_routerBolt_to_alertBolt1\",streamCollected.keySet().contains(\n+                String.format(StreamIdConversion.generateStreamIdBetween(routerBolt.getBoltId(), \"alertBolt1\"))));\n+        Assert.assertTrue(\"Should collect stream stream_routerBolt_to_alertBolt2\",streamCollected.keySet().contains(\n+                String.format(StreamIdConversion.generateStreamIdBetween(routerBolt.getBoltId(), \"alertBolt2\"))));\n \n         Assert.assertEquals(\"Should finally collect 3 events\",3,orderCollected.size());\n         Assert.assertArrayEquals(\"Should sort 3 events in ASC order\",new String[]{\"value2\",\"value1\",\"value3\"},orderCollected.stream().map((d)->d.getData()[0]).toArray());\n \n         // The first 3 events are ticked automatically by window\n \n-        bolt.cleanup();\n+        routerBolt.cleanup();\n \n         // Close will flush all events in memory, so will receive the last event which is still in memory as window is not expired according to clock\n         // The 5th event will be thrown because too late and out of margin",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-engine/src/test/java/org/apache/eagle/alert/engine/runner/TestStreamRouterBolt.java",
                "sha": "13550e16fc977a1b946b4adf9195aa195cad1afb",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/eagle/blob/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-metadata-parent/alert-metadata-service/src/main/java/org/apache/eagle/service/metadata/resource/MetadataResource.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-core/eagle-alert-parent/eagle-alert/alert-metadata-parent/alert-metadata-service/src/main/java/org/apache/eagle/service/metadata/resource/MetadataResource.java?ref=994a1e584432e8bef5463be57faf955553bd4d01",
                "deletions": 0,
                "filename": "eagle-core/eagle-alert-parent/eagle-alert/alert-metadata-parent/alert-metadata-service/src/main/java/org/apache/eagle/service/metadata/resource/MetadataResource.java",
                "patch": "@@ -54,6 +54,10 @@\n //    private IMetadataDao dao = MetadataDaoFactory.getInstance().getMetadataDao();\n     private final IMetadataDao dao;\n \n+    public MetadataResource(){\n+        this.dao = MetadataDaoFactory.getInstance().getMetadataDao();;\n+    }\n+\n     @Inject\n     public MetadataResource(IMetadataDao dao){\n         this.dao = dao;",
                "raw_url": "https://github.com/apache/eagle/raw/994a1e584432e8bef5463be57faf955553bd4d01/eagle-core/eagle-alert-parent/eagle-alert/alert-metadata-parent/alert-metadata-service/src/main/java/org/apache/eagle/service/metadata/resource/MetadataResource.java",
                "sha": "1799fa8eebb09c27ef52f3f9014c2d0e81514c49",
                "status": "modified"
            }
        ],
        "message": "EAGLE-401: StreamRouterBolt and PublishBolt also have NPE\n\nmake all stream bolts avoid NPE exception, instead throw stream not found exception for easy troublesooting\n\nAuthor: ralphsu\nReviewer: ralphsu\n\nCloses #284",
        "parent": "https://github.com/apache/eagle/commit/7e9dfaf3d5a51b52539ba5b298fbeb9d559ddd07",
        "repo": "eagle",
        "unit_tests": [
            "TestMetadataResource.java"
        ]
    },
    "eagle_ac57767": {
        "bug_id": "eagle_ac57767",
        "commit": "https://github.com/apache/eagle/commit/ac577675017a6ef437b8a774aa2c0e43cc973502",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/eagle/blob/ac577675017a6ef437b8a774aa2c0e43cc973502/eagle-jpm/eagle-jpm-util/src/main/java/org/apache/eagle/jpm/util/resourcefetch/RMResourceFetcher.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/eagle/contents/eagle-jpm/eagle-jpm-util/src/main/java/org/apache/eagle/jpm/util/resourcefetch/RMResourceFetcher.java?ref=ac577675017a6ef437b8a774aa2c0e43cc973502",
                "deletions": 6,
                "filename": "eagle-jpm/eagle-jpm-util/src/main/java/org/apache/eagle/jpm/util/resourcefetch/RMResourceFetcher.java",
                "patch": "@@ -38,6 +38,7 @@\n \n import java.io.IOException;\n import java.io.InputStream;\n+import java.util.ArrayList;\n import java.util.List;\n \n public class RMResourceFetcher implements ResourceFetcher<AppInfo> {\n@@ -66,7 +67,7 @@ private void checkUrl() throws IOException {\n     }\n \n     private List<AppInfo> doFetchFinishApplicationsList(String urlString, Constants.CompressionType compressionType) throws Exception {\n-        List<AppInfo> result;\n+        List<AppInfo> result = new ArrayList<>(0);\n         InputStream is = null;\n         try {\n             checkUrl();\n@@ -76,9 +77,8 @@ private void checkUrl() throws IOException {\n             if (appWrapper != null && appWrapper.getApps() != null\n                 && appWrapper.getApps().getApp() != null) {\n                 result = appWrapper.getApps().getApp();\n-                return result;\n             }\n-            return null;\n+            return result;\n         } finally {\n             if (is != null) {\n                 try {\n@@ -113,7 +113,7 @@ private String getMRFinishedJobURL(String lastFinishedTime) {\n     }\n \n     private List<AppInfo> doFetchRunningApplicationsList(String urlString, Constants.CompressionType compressionType) throws Exception {\n-        List<AppInfo> result;\n+        List<AppInfo> result = new ArrayList<>(0);\n         InputStream is = null;\n         try {\n             checkUrl();\n@@ -122,9 +122,8 @@ private String getMRFinishedJobURL(String lastFinishedTime) {\n             final AppsWrapper appWrapper = OBJ_MAPPER.readValue(is, AppsWrapper.class);\n             if (appWrapper != null && appWrapper.getApps() != null && appWrapper.getApps().getApp() != null) {\n                 result = appWrapper.getApps().getApp();\n-                return result;\n             }\n-            return null;\n+            return result;\n         } finally {\n             if (is != null) {\n                 try {",
                "raw_url": "https://github.com/apache/eagle/raw/ac577675017a6ef437b8a774aa2c0e43cc973502/eagle-jpm/eagle-jpm-util/src/main/java/org/apache/eagle/jpm/util/resourcefetch/RMResourceFetcher.java",
                "sha": "225ede95203d31e399714c5792a5f84edf92a811",
                "status": "modified"
            }
        ],
        "message": "[EAGLE-892] fixng NPE on ResourceFetcher\n\nMRRunningJobFetchSpout uses these functions which if returned Null, the follow up log line will throw NPE. ( as shown below )\n```\napps = resourceFetcher.getResource(Constants.ResourceType.RUNNING_MR_JOB);\nLOG.info(\"get {} apps from resource manager\", apps.size());\n```\n\nAuthor: Jay <jhsonline@gmail.com>\n\nCloses #800 from jhsenjaliya/EAGLE-892.",
        "parent": "https://github.com/apache/eagle/commit/1cfff2b9a9ade5dd7c9fd1b9c5e8f5928963da85",
        "repo": "eagle",
        "unit_tests": [
            "RMResourceFetcherTest.java"
        ]
    }
}