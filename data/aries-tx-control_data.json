[{"commit": "https://github.com/apache/aries-tx-control/commit/2d64bd67626a5b311dcd2d326532085313ff59dc", "parent": "https://github.com/apache/aries-tx-control/commit/9d241cd324299a255441672c077402c3b0dd1907", "message": "Tx Control spec compliance - avoid NPEs when null Maps are passed, throw thw correct exception from joinTransaction", "bug_id": "aries-tx-control_1", "file": [{"additions": 4, "raw_url": "https://github.com/apache/aries-tx-control/raw/2d64bd67626a5b311dcd2d326532085313ff59dc/tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/JPADataSourceHelper.java", "blob_url": "https://github.com/apache/aries-tx-control/blob/2d64bd67626a5b311dcd2d326532085313ff59dc/tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/JPADataSourceHelper.java", "sha": "779e4ab63fa68e2d7afcfea6a290b4e5e5b186b6", "changes": 5, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/aries-tx-control/contents/tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/JPADataSourceHelper.java?ref=2d64bd67626a5b311dcd2d326532085313ff59dc", "patch": "@@ -38,7 +38,10 @@ public static DataSource poolIfNecessary(Map<String, Object> resourceProviderPro\n \t\t\thcfg.setIdleTimeout(toLong(resourceProviderProperties, IDLE_TIMEOUT, TimeUnit.MINUTES.toMillis(3)));\n \t\t\thcfg.setMaxLifetime(toLong(resourceProviderProperties, CONNECTION_LIFETIME, HOURS.toMillis(3)));\n \t\n-\t\t\thcfg.setConnectionTestQuery((String)resourceProviderProperties.get(CONNECTION_TEST_QUERY));\n+\t\t\tofNullable(resourceProviderProperties)\n+\t\t\t\t.map(m -> m.get(CONNECTION_TEST_QUERY))\n+\t\t\t\t.map(String::valueOf)\n+\t\t\t\t.ifPresent(q -> hcfg.setConnectionTestQuery(q));\n \t\t\t\n \t\t\ttoUse = new HikariDataSource(hcfg);\n ", "filename": "tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/JPADataSourceHelper.java"}, {"additions": 3, "raw_url": "https://github.com/apache/aries-tx-control/raw/2d64bd67626a5b311dcd2d326532085313ff59dc/tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/ScopedEntityManagerWrapper.java", "blob_url": "https://github.com/apache/aries-tx-control/blob/2d64bd67626a5b311dcd2d326532085313ff59dc/tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/ScopedEntityManagerWrapper.java", "sha": "c89fa643f0f86fa3ff8930a95a242b69a4a7ac2d", "changes": 5, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/aries-tx-control/contents/tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/ScopedEntityManagerWrapper.java?ref=2d64bd67626a5b311dcd2d326532085313ff59dc", "patch": "@@ -19,7 +19,8 @@\n package org.apache.aries.tx.control.jpa.common.impl;\n \n import javax.persistence.EntityManager;\n-import javax.persistence.TransactionRequiredException;\n+\n+import org.osgi.service.transaction.control.TransactionException;\n \n public class ScopedEntityManagerWrapper extends EntityManagerWrapper {\n \n@@ -41,7 +42,7 @@ public void close() {\n \n \t@Override\n \tpublic void joinTransaction() {\n-\t\tthrow new TransactionRequiredException(\"This EntityManager is being used in the No Transaction scope. There is no transaction to join.\");\n+\t\tthrow new TransactionException(\"This EntityManager is being used in the No Transaction scope. There is no transaction to join.\");\n \t}\n \n \t@Override", "filename": "tx-control-providers/jpa/tx-control-provider-jpa-common/src/main/java/org/apache/aries/tx/control/jpa/common/impl/ScopedEntityManagerWrapper.java"}, {"additions": 3, "raw_url": "https://github.com/apache/aries-tx-control/raw/2d64bd67626a5b311dcd2d326532085313ff59dc/tx-control-providers/jpa/tx-control-provider-jpa-xa/src/main/java/org/apache/aries/tx/control/jpa/xa/impl/JPAEntityManagerProviderFactoryImpl.java", "blob_url": "https://github.com/apache/aries-tx-control/blob/2d64bd67626a5b311dcd2d326532085313ff59dc/tx-control-providers/jpa/tx-control-provider-jpa-xa/src/main/java/org/apache/aries/tx/control/jpa/xa/impl/JPAEntityManagerProviderFactoryImpl.java", "sha": "fec6bb870932d4a36de2bf6ed8a4c53d579ce345", "changes": 5, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/aries-tx-control/contents/tx-control-providers/jpa/tx-control-provider-jpa-xa/src/main/java/org/apache/aries/tx/control/jpa/xa/impl/JPAEntityManagerProviderFactoryImpl.java?ref=2d64bd67626a5b311dcd2d326532085313ff59dc", "patch": "@@ -84,11 +84,12 @@ public JPAEntityManagerProviderFactoryImpl(BundleContext context) {\n \tpublic AbstractJPAEntityManagerProvider getProviderFor(EntityManagerFactoryBuilder emfb, Map<String, Object> jpaProperties,\n \t\t\tMap<String, Object> resourceProviderProperties) {\n \t\t\n-\t\tMap<String, Object> jpaPropsToUse = new HashMap<>(jpaProperties);\n+\t\tMap<String, Object> jpaPropsToUse = jpaProperties == null ? new HashMap<>() :\n+\t\t\tnew HashMap<>(jpaProperties);\n \t\tjpaPropsToUse.put(TRANSACTION_TYPE, JTA.name());\n \t\t\n \t\tFunction<ThreadLocal<TransactionControl>, AbstractJPAEntityManagerProvider> create;\n-\t\tif(jpaProperties.containsKey(\"osgi.jdbc.provider\")) {\n+\t\tif(jpaPropsToUse.containsKey(\"osgi.jdbc.provider\")) {\n \t\t\tcreate = handleJDBCResourceProvider(emfb, resourceProviderProperties, jpaPropsToUse);\t\t\t\n \t\t} else if(toBoolean(jpaPropsToUse, PRE_ENLISTED_DB_CONNECTION, false)) {\n \t\t\tcreate = handlePreEnlistedConnection(emfb, resourceProviderProperties, jpaPropsToUse);", "filename": "tx-control-providers/jpa/tx-control-provider-jpa-xa/src/main/java/org/apache/aries/tx/control/jpa/xa/impl/JPAEntityManagerProviderFactoryImpl.java"}], "repo": "aries-tx-control"}]
