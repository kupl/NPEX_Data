[
    {
        "repo": "maven-scm",
        "commit": "https://github.com/apache/maven-scm/commit/a834c41f40fa23fcd064502ac8cfb24eba64b0ed",
        "bug_id": "maven-scm_a834c41",
        "message": "[SCM-338] Fix NPE when using vssDirectory system property\nSubmitted by : Allan Lang\n\ngit-svn-id: https://svn.apache.org/repos/asf/maven/scm/trunk@656802 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/maven-scm/commit/418fc6a78b19e0f440c277da5ddda48396150a03",
        "patched_files": [
            "VssCommandLineUtils.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 17,
                "raw_url": "https://github.com/apache/maven-scm/raw/a834c41f40fa23fcd064502ac8cfb24eba64b0ed/maven-scm-providers/maven-scm-provider-vss/src/main/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtils.java",
                "contents_url": "https://api.github.com/repos/apache/maven-scm/contents/maven-scm-providers/maven-scm-provider-vss/src/main/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtils.java?ref=a834c41f40fa23fcd064502ac8cfb24eba64b0ed",
                "filename": "maven-scm-providers/maven-scm-provider-vss/src/main/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtils.java",
                "deletions": 2,
                "sha": "5f99e6553fedc9167f3fdf7f9ec28883953ea4dc",
                "blob_url": "https://github.com/apache/maven-scm/blob/a834c41f40fa23fcd064502ac8cfb24eba64b0ed/maven-scm-providers/maven-scm-provider-vss/src/main/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtils.java",
                "patch": "@@ -45,6 +45,8 @@\n public class VssCommandLineUtils\n     implements VssConstants  // FIXME extend CommandLineUtils\n {\n+    private static File scmConfDir = new File( System.getProperty( \"user.home\" ), \".scm\" );\n+\n     public static void addFiles( Commandline cl, ScmFileSet fileSet )\n     {\n         Iterator it = fileSet.getFileList().iterator();\n@@ -107,8 +109,7 @@ public static int executeCommandline( Commandline cl, StreamConsumer consumer,\n     public static final Settings getSettings()\n     {\n         Settings settings = null;\n-        File scmUserHome = new File( System.getProperty( \"user.home\" ), \".scm\" );\n-        File settingsFile = new File( scmUserHome, \"vss-settings.xml\" );\n+        File settingsFile = new File( scmConfDir, \"vss-settings.xml\" );\n         if ( settingsFile.exists() )\n         {\n             VssXpp3Reader reader = new VssXpp3Reader();\n@@ -134,11 +135,25 @@ public static final Settings getSettings()\n         String vssDirectory = System.getProperty( \"vssDirectory\" );\n         if ( StringUtils.isNotEmpty( vssDirectory ) )\n         {\n+            if ( settings == null )\n+            {\n+                settings = new Settings();\n+            }\n             settings.setVssDirectory( vssDirectory );\n         }\n         return settings;\n     }\n \n+    protected static final File getScmConfDir()\n+    {\n+        return scmConfDir;\n+    }\n+\n+    protected static final void setScmConfDir( File directory )\n+    {\n+        scmConfDir = directory;\n+    }\n+\n     public static final String getSsDir()\n     {\n         String ssDir = \"\";",
                "changes": 19
            },
            {
                "status": "added",
                "additions": 162,
                "raw_url": "https://github.com/apache/maven-scm/raw/a834c41f40fa23fcd064502ac8cfb24eba64b0ed/maven-scm-providers/maven-scm-provider-vss/src/test/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtilsTest.java",
                "contents_url": "https://api.github.com/repos/apache/maven-scm/contents/maven-scm-providers/maven-scm-provider-vss/src/test/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtilsTest.java?ref=a834c41f40fa23fcd064502ac8cfb24eba64b0ed",
                "filename": "maven-scm-providers/maven-scm-provider-vss/src/test/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtilsTest.java",
                "deletions": 0,
                "sha": "2ed458cd43508fe51a86c53a09b893b6e06950d2",
                "blob_url": "https://github.com/apache/maven-scm/blob/a834c41f40fa23fcd064502ac8cfb24eba64b0ed/maven-scm-providers/maven-scm-provider-vss/src/test/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtilsTest.java",
                "patch": "@@ -0,0 +1,162 @@\n+package org.apache.maven.scm.provider.vss.commands;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import org.apache.maven.scm.ScmTestCase;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+\n+/**\n+ * @author Allan Lang\n+ * @version $Id$\n+ */\n+public class VssCommandLineUtilsTest\n+    extends ScmTestCase\n+{\n+\n+    private static final String VSS_DIRECTORY_PROPERTY = \"vssDirectory\";\n+\n+    //private ScmManager scmManager;\n+\n+    public void setUp()\n+        throws Exception\n+    {\n+        super.setUp();\n+\n+        //scmManager = getScmManager();\n+    }\n+\n+    public void testGetSettings()\n+        throws IOException\n+    {\n+        /*\n+         * If we have a genuine settings file, take a copy of this first Create\n+         * the test settings file Check getSettings from file Delete the test\n+         * settings file Check getSettings without file Check getSettings with\n+         * system property Re-instate original settings file, if existing\n+         *\n+         */\n+\n+        final String vssInstallPath = \"c:\\\\wherever\";\n+        final String vssInstallPathAlt = \"c:\\\\somewhere\";\n+        final String settingsXml =\n+            \"<vss-settings><Settings><vssDirectory>\" + vssInstallPath + \"</vssDirectory></Settings></vss-settings>\";\n+        final String settingsFilename = \"vss-settings.xml\";\n+        final String backupFilename = settingsFilename + \".backup\";\n+        boolean preExistingScmFolder = false;\n+        boolean preExistingSettings = false;\n+\n+        /*\n+         * Create a backup of the current settings file, if one exists\n+         */\n+        File scmUserHome = new File( getTestFile( \"target/vssdir\" ), \".scm\" );\n+        if ( scmUserHome.exists() )\n+        {\n+            preExistingScmFolder = true;\n+            File settingsFile = new File( scmUserHome, settingsFilename );\n+            if ( settingsFile.exists() )\n+            {\n+                preExistingSettings = true;\n+                settingsFile.renameTo( new File( scmUserHome, backupFilename ) );\n+            }\n+        }\n+        else\n+        {\n+            scmUserHome.mkdirs();\n+        }\n+\n+        /*\n+         * Create the test settings file\n+         */\n+        File testSettings = new File( scmUserHome, settingsFilename );\n+        FileOutputStream fos = new FileOutputStream( testSettings );\n+        fos.write( settingsXml.getBytes() );\n+        fos.flush();\n+        fos.close();\n+        fos = null;\n+\n+        /*\n+         * Validate that setting from settings file is returned correctly\n+         */\n+        VssCommandLineUtils.setScmConfDir( scmUserHome );\n+        assertEquals( vssInstallPath, VssCommandLineUtils.getSettings().getVssDirectory() );\n+\n+        /*\n+         * Validate that setting is overridden by system property\n+         */\n+        System.setProperty( VSS_DIRECTORY_PROPERTY, vssInstallPathAlt );\n+        assertEquals( vssInstallPathAlt, VssCommandLineUtils.getSettings().getVssDirectory() );\n+\n+        /*\n+         * Delete the test settings file\n+         */\n+        testSettings.delete();\n+\n+        /*\n+         * Validate that setting is still equal to system property\n+         */\n+        assertEquals( vssInstallPathAlt, VssCommandLineUtils.getSettings().getVssDirectory() );\n+\n+        /*\n+         * Re-instate the original settings file, if one existed\n+         */\n+        if ( preExistingSettings )\n+        {\n+            File backup = new File( scmUserHome, backupFilename );\n+            backup.renameTo( new File( scmUserHome, settingsFilename ) );\n+        }\n+\n+        if ( !preExistingScmFolder )\n+        {\n+            scmUserHome.delete();\n+        }\n+\n+    }\n+\n+    public void testGetSsDir()\n+    {\n+        final String vssInstallPathWindowsStyle = \"c:\\\\vss\\\\bin\";\n+        final String vssInstallPathUnixStyle = \"c:/vss/bin\";\n+        final String targetValue = \"c:/vss/bin/\";\n+\n+        // Windows style test\n+        System.setProperty( VSS_DIRECTORY_PROPERTY, vssInstallPathWindowsStyle );\n+        assertEquals( targetValue, VssCommandLineUtils.getSsDir() );\n+\n+        // Unix style test\n+        System.setProperty( VSS_DIRECTORY_PROPERTY, vssInstallPathUnixStyle );\n+        assertEquals( targetValue, VssCommandLineUtils.getSsDir() );\n+\n+        // Windows style with folder indicator\n+        System.setProperty( VSS_DIRECTORY_PROPERTY, vssInstallPathWindowsStyle + \"\\\\\" );\n+        assertEquals( targetValue, VssCommandLineUtils.getSsDir() );\n+\n+        // Unix style with folder indicator\n+        System.setProperty( VSS_DIRECTORY_PROPERTY, vssInstallPathUnixStyle + \"/\" );\n+        assertEquals( targetValue, VssCommandLineUtils.getSsDir() );\n+\n+        // Unix style with Windows style folder indicator\n+        System.setProperty( VSS_DIRECTORY_PROPERTY, vssInstallPathUnixStyle + \"\\\\\" );\n+        assertEquals( targetValue, VssCommandLineUtils.getSsDir() );\n+\n+    }\n+}",
                "changes": 162
            }
        ],
        "unit_tests": [
            "VssCommandLineUtilsTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "maven-scm-providers/maven-scm-provider-vss/src/test/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtilsTest.java",
        "buggy_files": [
            "maven-scm-providers/maven-scm-provider-vss/src/main/java/org/apache/maven/scm/provider/vss/commands/VssCommandLineUtils.java"
        ],
        "fixed": true
    }
]