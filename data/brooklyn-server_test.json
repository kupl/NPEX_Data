{
    "brooklyn-server_022be36": {
        "bug_id": "brooklyn-server_022be36",
        "commit": "https://github.com/apache/brooklyn-server/commit/022be36878051990d751e82b630fbaecde9142e6",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/022be36878051990d751e82b630fbaecde9142e6/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java?ref=022be36878051990d751e82b630fbaecde9142e6",
                "deletions": 4,
                "filename": "core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "patch": "@@ -89,15 +89,15 @@ public static Sanitizer newInstance(){\n     }\n \n     public static Map<String, Object> sanitize(ConfigBag input) {\n-        return sanitize(input.getAllConfig());\n+        return (input == null) ? null : sanitize(input.getAllConfig());\n     }\n \n     public static <K> Map<K, Object> sanitize(Map<K, ?> input) {\n-        return sanitize(input, Sets.newHashSet());\n+        return (input == null) ? null : sanitize(input, Sets.newHashSet());\n     }\n \n     static <K> Map<K, Object> sanitize(Map<K, ?> input, Set<Object> visited) {\n-        return newInstance().apply(input, visited);\n+        return (input == null) ? null : newInstance().apply(input, visited);\n     }\n     \n     private Predicate<Object> predicate;\n@@ -107,7 +107,7 @@ private Sanitizer(Predicate<Object> sanitizingNeededCheck) {\n     }\n \n     public <K> Map<K, Object> apply(Map<K, ?> input) {\n-        return apply(input, Sets.newHashSet());\n+        return (input == null) ? null : apply(input, Sets.newHashSet());\n     }\n \n     private <K> Map<K, Object> apply(Map<K, ?> input, Set<Object> visited) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/022be36878051990d751e82b630fbaecde9142e6/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "sha": "35eb26e0e7ee8c9aebcafad3ab2ac0f7cd8af044",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/022be36878051990d751e82b630fbaecde9142e6/core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java?ref=022be36878051990d751e82b630fbaecde9142e6",
                "deletions": 1,
                "filename": "core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java",
                "patch": "@@ -22,7 +22,6 @@\n \n import java.util.Map;\n \n-import org.apache.brooklyn.core.config.Sanitizer;\n import org.apache.brooklyn.util.collections.MutableMap;\n import org.apache.brooklyn.util.core.config.ConfigBag;\n import org.testng.annotations.Test;\n@@ -64,4 +63,11 @@ public void testSanitizeWithNullKey() throws Exception {\n         Map<?, ?> sanitized = Sanitizer.sanitize(map);\n         assertEquals(sanitized, map);\n     }\n+    \n+    @Test\n+    public void testSanitizeWithNull() throws Exception {\n+        assertEquals(Sanitizer.sanitize((ConfigBag)null), null);\n+        assertEquals(Sanitizer.sanitize((Map<?,?>)null), null);\n+        assertEquals(Sanitizer.newInstance().apply((Map<?,?>)null), null);\n+    }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/022be36878051990d751e82b630fbaecde9142e6/core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java",
                "sha": "2ca4883bcfc66d38e48cd0fa8d7ae70ef2fc8e75",
                "status": "modified"
            }
        ],
        "message": "Closes #618\n\nSanitizer: avoid NPE on `sanitize(null)`",
        "parent": "https://github.com/apache/brooklyn-server/commit/1599d7aaadc1e72161fb44ba23572c337513739b",
        "patched_files": [
            "Sanitizer.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "SanitizerTest.java"
        ]
    },
    "brooklyn-server_025077e": {
        "bug_id": "brooklyn-server_025077e",
        "commit": "https://github.com/apache/brooklyn-server/commit/025077ed601067335272512fd819a2237f9773cb",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/025077ed601067335272512fd819a2237f9773cb/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java?ref=025077ed601067335272512fd819a2237f9773cb",
                "deletions": 1,
                "filename": "usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "patch": "@@ -453,7 +453,7 @@ private String checkFileExists(String path, String name) {\n     public synchronized void stop() throws Exception {\n         if (server==null) return;\n         String root = getRootUrl();\n-        Threads.removeShutdownHook(shutdownHook);\n+        if (shutdownHook != null) Threads.removeShutdownHook(shutdownHook);\n         if (log.isDebugEnabled())\n             log.debug(\"Stopping Brooklyn web console at \"+root+ \" (\" + war + (wars != null ? \" and \" + wars.values() : \"\") + \")\");\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/025077ed601067335272512fd819a2237f9773cb/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "sha": "f4bfacb07265dfe35012c6d0388ef873e0e5315e",
                "status": "modified"
            }
        ],
        "message": "Avoid NPE in BrooklynWebServer.stop",
        "parent": "https://github.com/apache/brooklyn-server/commit/58c0392d7d1a9d1fac21c4892b3a77125269b940",
        "patched_files": [
            "BrooklynWebServer.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BrooklynWebServerTest.java"
        ]
    },
    "brooklyn-server_0357930": {
        "bug_id": "brooklyn-server_0357930",
        "commit": "https://github.com/apache/brooklyn-server/commit/035793087c20914622adbb9f8875af3c6700f8f6",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/035793087c20914622adbb9f8875af3c6700f8f6/core/src/main/java/brooklyn/util/NetworkUtils.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/NetworkUtils.java?ref=035793087c20914622adbb9f8875af3c6700f8f6",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/util/NetworkUtils.java",
                "patch": "@@ -67,7 +67,9 @@ public static void checkPortsValid(Map ports) {\n         for (Object ppo : ports.entrySet()) {\n             Map.Entry<?,?> pp = (Map.Entry<?,?>)ppo;\n             Object val = pp.getValue();\n-            if (!(val instanceof Integer)) {\n+            if(val == null){\n+                throw new IllegalArgumentException(\"port for \"+pp.getKey()+\" is null\");\n+            }else if (!(val instanceof Integer)) {\n                 throw new IllegalArgumentException(\"port \"+val+\" for \"+pp.getKey()+\" is not an integer (\"+val.getClass()+\")\");\n             }\n             checkPortValid((Integer)val, \"\"+pp.getKey());",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/035793087c20914622adbb9f8875af3c6700f8f6/core/src/main/java/brooklyn/util/NetworkUtils.java",
                "sha": "6190edffef567534bf63a509aa3030ae73b35a71",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #120 from pveentjer/fix-networkutils\n\nnetworkutils fix; npe on when a port is null",
        "parent": "https://github.com/apache/brooklyn-server/commit/088152864c09420d39386c1c16b61261d6e2e8ce",
        "patched_files": [
            "NetworkUtils.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "NetworkUtilsTest.java"
        ]
    },
    "brooklyn-server_067c208": {
        "bug_id": "brooklyn-server_067c208",
        "commit": "https://github.com/apache/brooklyn-server/commit/067c208fc3e23658dc757dcc5c203c6dab928482",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/067c208fc3e23658dc757dcc5c203c6dab928482/rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java?ref=067c208fc3e23658dc757dcc5c203c6dab928482",
                "deletions": 2,
                "filename": "rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java",
                "patch": "@@ -25,9 +25,10 @@\n \n import javax.annotation.Nullable;\n \n+import org.apache.brooklyn.util.collections.MutableMap;\n+\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n-import com.google.common.collect.ImmutableMap;\n \n // FIXME change name, due to confusion with LocationSpec <- no need, as we can kill the class instead soon!\n /** @deprecated since 0.7.0 location spec objects will not be used from the client, instead pass yaml location spec strings */\n@@ -53,7 +54,7 @@ public LocationSpec(\n             @JsonProperty(\"config\") @Nullable Map<String, ?> config) {\n         this.name = name;\n         this.spec = spec;\n-        this.config = (config == null) ? Collections.<String, String> emptyMap() : ImmutableMap.copyOf(config);\n+        this.config = (config == null) ? Collections.<String, String> emptyMap() : MutableMap.copyOf(config);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/067c208fc3e23658dc757dcc5c203c6dab928482/rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java",
                "sha": "70980bc343afa87be2b0360a6d22a14f2c0af2b7",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/067c208fc3e23658dc757dcc5c203c6dab928482/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java?ref=067c208fc3e23658dc757dcc5c203c6dab928482",
                "deletions": 1,
                "filename": "rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java",
                "patch": "@@ -121,7 +121,7 @@ public static LocationSummary newInstance(ManagementContext mgmt, LocationDefini\n     }\n \n     private static Map<String, ?> copyConfig(Map<String,?> entries, LocationDetailLevel level) {\n-        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+        MutableMap.Builder<String, Object> builder = MutableMap.builder();\n         if (level!=LocationDetailLevel.NONE) {\n             for (Map.Entry<String,?> entry : entries.entrySet()) {\n                 if (level==LocationDetailLevel.FULL_INCLUDING_SECRET || !Sanitizer.IS_SECRET_PREDICATE.apply(entry.getKey())) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/067c208fc3e23658dc757dcc5c203c6dab928482/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java",
                "sha": "3777901191b173a77766a219013359916b7e4d76",
                "status": "modified"
            }
        ],
        "message": "Rest API location transformers use mutable map\n\nLocationConfig contains null values which Guava's ImmutableMap rejects\nwith a NullPointerException",
        "parent": "https://github.com/apache/brooklyn-server/commit/36a29180def4b504fdd3da97f215f27eab3e226d",
        "patched_files": [
            "LocationSpec.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "LocationSpecTest.java"
        ]
    },
    "brooklyn-server_12323b5": {
        "bug_id": "brooklyn-server_12323b5",
        "commit": "https://github.com/apache/brooklyn-server/commit/12323b58df2dbc5e25874e4f2d516fd3cbe2887a",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/12323b58df2dbc5e25874e4f2d516fd3cbe2887a/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java?ref=12323b58df2dbc5e25874e4f2d516fd3cbe2887a",
                "deletions": 4,
                "filename": "core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "patch": "@@ -89,15 +89,15 @@ public static Sanitizer newInstance(){\n     }\n \n     public static Map<String, Object> sanitize(ConfigBag input) {\n-        return sanitize(input.getAllConfig());\n+        return (input == null) ? null : sanitize(input.getAllConfig());\n     }\n \n     public static <K> Map<K, Object> sanitize(Map<K, ?> input) {\n-        return sanitize(input, Sets.newHashSet());\n+        return (input == null) ? null : sanitize(input, Sets.newHashSet());\n     }\n \n     static <K> Map<K, Object> sanitize(Map<K, ?> input, Set<Object> visited) {\n-        return newInstance().apply(input, visited);\n+        return (input == null) ? null : newInstance().apply(input, visited);\n     }\n     \n     private Predicate<Object> predicate;\n@@ -107,7 +107,7 @@ private Sanitizer(Predicate<Object> sanitizingNeededCheck) {\n     }\n \n     public <K> Map<K, Object> apply(Map<K, ?> input) {\n-        return apply(input, Sets.newHashSet());\n+        return (input == null) ? null : apply(input, Sets.newHashSet());\n     }\n \n     private <K> Map<K, Object> apply(Map<K, ?> input, Set<Object> visited) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/12323b58df2dbc5e25874e4f2d516fd3cbe2887a/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "sha": "35eb26e0e7ee8c9aebcafad3ab2ac0f7cd8af044",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/12323b58df2dbc5e25874e4f2d516fd3cbe2887a/core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java?ref=12323b58df2dbc5e25874e4f2d516fd3cbe2887a",
                "deletions": 1,
                "filename": "core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java",
                "patch": "@@ -22,7 +22,6 @@\n \n import java.util.Map;\n \n-import org.apache.brooklyn.core.config.Sanitizer;\n import org.apache.brooklyn.util.collections.MutableMap;\n import org.apache.brooklyn.util.core.config.ConfigBag;\n import org.testng.annotations.Test;\n@@ -64,4 +63,11 @@ public void testSanitizeWithNullKey() throws Exception {\n         Map<?, ?> sanitized = Sanitizer.sanitize(map);\n         assertEquals(sanitized, map);\n     }\n+    \n+    @Test\n+    public void testSanitizeWithNull() throws Exception {\n+        assertEquals(Sanitizer.sanitize((ConfigBag)null), null);\n+        assertEquals(Sanitizer.sanitize((Map<?,?>)null), null);\n+        assertEquals(Sanitizer.newInstance().apply((Map<?,?>)null), null);\n+    }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/12323b58df2dbc5e25874e4f2d516fd3cbe2887a/core/src/test/java/org/apache/brooklyn/core/config/SanitizerTest.java",
                "sha": "2ca4883bcfc66d38e48cd0fa8d7ae70ef2fc8e75",
                "status": "modified"
            }
        ],
        "message": "Sanitizer: avoid NPE on `sanitize(null)`",
        "parent": "https://github.com/apache/brooklyn-server/commit/1599d7aaadc1e72161fb44ba23572c337513739b",
        "patched_files": [
            "Sanitizer.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "SanitizerTest.java"
        ]
    },
    "brooklyn-server_1754fe3": {
        "bug_id": "brooklyn-server_1754fe3",
        "commit": "https://github.com/apache/brooklyn-server/commit/1754fe33c85d0e1dd351281c4e83e8eb4277f9f0",
        "file": [
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1754fe33c85d0e1dd351281c4e83e8eb4277f9f0/core/src/main/java/brooklyn/location/basic/FixedListMachineProvisioningLocation.java",
                "changes": 25,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/FixedListMachineProvisioningLocation.java?ref=1754fe33c85d0e1dd351281c4e83e8eb4277f9f0",
                "deletions": 6,
                "filename": "core/src/main/java/brooklyn/location/basic/FixedListMachineProvisioningLocation.java",
                "patch": "@@ -28,13 +28,17 @@\n import java.util.Map;\n import java.util.Set;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import brooklyn.location.Location;\n import brooklyn.location.LocationSpec;\n import brooklyn.location.MachineLocation;\n import brooklyn.location.MachineProvisioningLocation;\n import brooklyn.location.NoMachinesAvailableException;\n import brooklyn.management.LocationManager;\n import brooklyn.util.collections.MutableMap;\n+import brooklyn.util.collections.MutableSet;\n import brooklyn.util.flags.SetFromFlag;\n import brooklyn.util.stream.Streams;\n import brooklyn.util.text.WildcardGlobs;\n@@ -63,6 +67,8 @@\n     // and getMachines() returns the real sets risking \n     // ConcurrentModificationException in the caller if it iterates over them etc.\n     \n+    private static final Logger log = LoggerFactory.getLogger(FixedListMachineProvisioningLocation.class);\n+    \n     private final Object lock = new Object();\n     \n     @SetFromFlag\n@@ -89,14 +95,21 @@ public FixedListMachineProvisioningLocation(Map properties) {\n     public void init() {\n         super.init();\n         \n-        for (MachineLocation location: machines) {\n-            // FIXME Bad casting\n-            Location machine = (Location) location;\n-            Location parent = machine.getParent();\n-            if (parent == null) {\n-                addChild(machine);\n+        Set<T> machinesCopy = MutableSet.of();\n+        for (T location: machines) {\n+            if (location==null) {\n+                log.warn(\"\"+this+\" initialized with null location, removing (may be due to rebind with reference to an unmanaged location)\");\n+            } else {\n+                Location parent = location.getParent();\n+                if (parent == null) {\n+                    addChild(location);\n+                }\n+                machinesCopy.add(location);\n             }\n         }\n+        if (!machinesCopy.equals(machines)) {\n+            machines = machinesCopy;\n+        }\n     }\n     \n     @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1754fe33c85d0e1dd351281c4e83e8eb4277f9f0/core/src/main/java/brooklyn/location/basic/FixedListMachineProvisioningLocation.java",
                "sha": "595ab8a7285a03872d2e5ba275240ba6d11e5f75",
                "status": "modified"
            }
        ],
        "message": "avoid NPE on rebind when locations have been unmanaged",
        "parent": "https://github.com/apache/brooklyn-server/commit/a18ae6f129c8d2615c896121325d35a67008316f",
        "patched_files": [
            "FixedListMachineProvisioningLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "FixedListMachineProvisioningLocationTest.java"
        ]
    },
    "brooklyn-server_17c21d0": {
        "bug_id": "brooklyn-server_17c21d0",
        "commit": "https://github.com/apache/brooklyn-server/commit/17c21d05c3a2fc4d696c90d26a145ffb66302556",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/17c21d05c3a2fc4d696c90d26a145ffb66302556/rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java?ref=17c21d05c3a2fc4d696c90d26a145ffb66302556",
                "deletions": 2,
                "filename": "rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java",
                "patch": "@@ -25,9 +25,10 @@\n \n import javax.annotation.Nullable;\n \n+import org.apache.brooklyn.util.collections.MutableMap;\n+\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n-import com.google.common.collect.ImmutableMap;\n \n // FIXME change name, due to confusion with LocationSpec <- no need, as we can kill the class instead soon!\n /** @deprecated since 0.7.0 location spec objects will not be used from the client, instead pass yaml location spec strings */\n@@ -53,7 +54,7 @@ public LocationSpec(\n             @JsonProperty(\"config\") @Nullable Map<String, ?> config) {\n         this.name = name;\n         this.spec = spec;\n-        this.config = (config == null) ? Collections.<String, String> emptyMap() : ImmutableMap.copyOf(config);\n+        this.config = (config == null) ? Collections.<String, String> emptyMap() : MutableMap.copyOf(config);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/17c21d05c3a2fc4d696c90d26a145ffb66302556/rest/rest-api/src/main/java/org/apache/brooklyn/rest/domain/LocationSpec.java",
                "sha": "70980bc343afa87be2b0360a6d22a14f2c0af2b7",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/17c21d05c3a2fc4d696c90d26a145ffb66302556/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java?ref=17c21d05c3a2fc4d696c90d26a145ffb66302556",
                "deletions": 1,
                "filename": "rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java",
                "patch": "@@ -121,7 +121,7 @@ public static LocationSummary newInstance(ManagementContext mgmt, LocationDefini\n     }\n \n     private static Map<String, ?> copyConfig(Map<String,?> entries, LocationDetailLevel level) {\n-        ImmutableMap.Builder<String, Object> builder = ImmutableMap.builder();\n+        MutableMap.Builder<String, Object> builder = MutableMap.builder();\n         if (level!=LocationDetailLevel.NONE) {\n             for (Map.Entry<String,?> entry : entries.entrySet()) {\n                 if (level==LocationDetailLevel.FULL_INCLUDING_SECRET || !Sanitizer.IS_SECRET_PREDICATE.apply(entry.getKey())) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/17c21d05c3a2fc4d696c90d26a145ffb66302556/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/transform/LocationTransformer.java",
                "sha": "3777901191b173a77766a219013359916b7e4d76",
                "status": "modified"
            }
        ],
        "message": "Closes #99\n\nRest API location transformers use mutable map\n\nLocationConfig contains null values which Guava's ImmutableMap rejects with a NullPointerException.\n\nThis fixes an error observed when deploying the \"Template 1: Server\" sample to localhost then running `br application <id>` with the CLI. The output from the CLI was \"500 Server Error\". The server logs contained:\n\n```\njava.lang.NullPointerException: null value in entry: byon.machineSpecs=null\n\tat com.google.common.collect.CollectPreconditions.checkEntryNotNull(CollectPreconditions.java:33) ~[com.google.guava-guava-16.0.1.jar:na]\n\tat com.google.common.collect.ImmutableMap.entryOf(ImmutableMap.java:135) ~[com.google.guava-guava-16.0.1.jar:na]\n\tat com.google.common.collect.ImmutableMap$Builder.put(ImmutableMap.java:206) ~[com.google.guava-guava-16.0.1.jar:na]\n\tat org.apache.brooklyn.rest.transform.LocationTransformer.copyConfig(LocationTransformer.java:128) ~[org.apache.brooklyn-brooklyn-rest-resources-0.10.0-SNAPSHOT.jar:0.10.0-SNAPSHOT]\n\tat org.apache.brooklyn.rest.transform.LocationTransformer.newInstance(LocationTransformer.java:189) ~[org.apache.brooklyn-brooklyn-rest-resources-0.10.0-SNAPSHOT.jar:0.10.0-SNAPSHOT]\n\tat org.apache.brooklyn.rest.resources.LocationResource.get(LocationResource.java:139) ~[org.apache.brooklyn-brooklyn-rest-resources-0.10.0-SNAPSHOT.jar:0.10.0-SNAPSHOT]\n\tat org.apache.brooklyn.rest.resources.LocationResource.get(LocationResource.java:132) ~[org.apache.brooklyn-brooklyn-rest-resources-0.10.0-SNAPSHOT.jar:0.10.0-SNAPSHOT]\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_05]\n\n```",
        "parent": "https://github.com/apache/brooklyn-server/commit/423bb58a27c2b074dfb5946d8587507c56319d0e",
        "patched_files": [
            "LocationSpec.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "LocationSpecTest.java"
        ]
    },
    "brooklyn-server_1903230": {
        "bug_id": "brooklyn-server_1903230",
        "commit": "https://github.com/apache/brooklyn-server/commit/1903230dc242d42db12889284150f80660f6dd73",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/config/ConfigUtils.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/config/ConfigUtils.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 5,
                "filename": "core/src/main/java/brooklyn/config/ConfigUtils.java",
                "patch": "@@ -92,19 +92,19 @@ public static BrooklynProperties filterForPrefixAndStrip(Map<String,?> propertie\n     @SuppressWarnings(\"rawtypes\")\n     public static Set<HasConfigKey<?>> getStaticKeysOnClass(Class<?> type) {\n         Set<HasConfigKey<?>> result = new LinkedHashSet<ConfigKey.HasConfigKey<?>>();\n-        try {\n-            for (Field f: type.getFields()) {\n+        for (Field f: type.getFields()) {\n+            try {\n                 if ((f.getModifiers() & Modifier.STATIC)==0)\n                     continue;\n                 if (ConfigKey.class.isAssignableFrom(f.getType()))\n                     result.add(new WrappedConfigKey((ConfigKey<?>) f.get(null)));\n                 else if (HasConfigKey.class.isAssignableFrom(f.getType()))\n                     result.add((HasConfigKey<?>) f.get(null));\n+            } catch (Exception e) {\n+                log.error(\"Error retrieving config key for field \"+f+\" on class \"+type+\"; rethrowing\", e);\n+                throw Exceptions.propagate(e);\n             }\n-        } catch (Exception e) {\n-            throw Exceptions.propagate(e);\n         }\n         return Collections.unmodifiableSet(result);\n     }\n-\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/config/ConfigUtils.java",
                "sha": "08a1963a6674263072102842296a80a1b35e3cdc",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/entity/basic/Attributes.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/Attributes.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/entity/basic/Attributes.java",
                "patch": "@@ -28,7 +28,7 @@\n     /**\n      * Application information sensors.\n      * \n-     * @deprecated since 0.5; see {@link ConfigKeys#SUGGESTED_VERSION}\n+     * @deprecated since 0.5; see {@link BrooklynConfigKeys#SUGGESTED_VERSION}\n      */\n     @Deprecated\n     AttributeSensor<String> VERSION = Sensors.newStringSensor( \"version\", \"Version information\");",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/entity/basic/Attributes.java",
                "sha": "6af95be92773598e35274f57ae13a63d05a65c51",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/entity/basic/ConfigKeys.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/ConfigKeys.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 40,
                "filename": "core/src/main/java/brooklyn/entity/basic/ConfigKeys.java",
                "patch": "@@ -136,44 +136,4 @@\n     public static ConfigKey<Boolean> newBooleanConfigKey(String name, String description, Boolean defaultValue) {\n         return newConfigKey(Boolean.class, name, description, defaultValue);\n     }\n-\n-    /* Key definitions were deprecated here in 0.6.0 because they introduce nasty circular dependencies on the\n-     * methods in this class, causing some final fields to be null when they are accessed. \n-     */\n-\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> BROOKLYN_DATA_DIR = BrooklynConfigKeys.BROOKLYN_DATA_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SUGGESTED_VERSION = BrooklynConfigKeys.SUGGESTED_VERSION;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SUGGESTED_INSTALL_DIR = BrooklynConfigKeys.SUGGESTED_INSTALL_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SUGGESTED_RUN_DIR = BrooklynConfigKeys.SUGGESTED_RUN_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> START_LATCH = BrooklynConfigKeys.START_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> INSTALL_LATCH = BrooklynConfigKeys.INSTALL_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> CUSTOMIZE_LATCH = BrooklynConfigKeys.CUSTOMIZE_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> LAUNCH_LATCH = BrooklynConfigKeys.LAUNCH_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Integer> START_TIMEOUT = BrooklynConfigKeys.START_TIMEOUT;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_TOOL_CLASS = BrooklynConfigKeys.SSH_TOOL_CLASS;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_HOST = BrooklynConfigKeys.SSH_CONFIG_HOST;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Integer> SSH_CONFIG_PORT = BrooklynConfigKeys.SSH_CONFIG_PORT;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_USER = BrooklynConfigKeys.SSH_CONFIG_USER;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_PASSWORD = BrooklynConfigKeys.SSH_CONFIG_PASSWORD;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_SCRIPT_DIR = BrooklynConfigKeys.SSH_CONFIG_SCRIPT_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_SCRIPT_HEADER = BrooklynConfigKeys.SSH_CONFIG_SCRIPT_HEADER;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_DIRECT_HEADER = BrooklynConfigKeys.SSH_CONFIG_DIRECT_HEADER;\n-\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/entity/basic/ConfigKeys.java",
                "sha": "f4a27a7a4921369b651e823e92de197bffa63c64",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java",
                "patch": "@@ -13,7 +13,7 @@\n \n import brooklyn.entity.Entity;\n import brooklyn.entity.basic.Attributes;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.drivers.EntityDriver;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadRequirement;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadTargets;\n@@ -92,14 +92,14 @@ public static String substitute(DownloadRequirement req, String basevalue) {\n         Entity entity = driver.getEntity();\n         String type = entity.getEntityType().getName();\n         String simpleType = type.substring(type.lastIndexOf(\".\")+1);\n-        String version = entity.getConfig(ConfigKeys.SUGGESTED_VERSION);\n+        String version = entity.getConfig(BrooklynConfigKeys.SUGGESTED_VERSION);\n         \n         String v2 = entity.getAttribute(Attributes.VERSION);\n         if (v2!=null && !v2.equals(version)) {\n             // Attributes.VERSION was deprecated in 0.5.0 but was preferred here without warning in 0.6.0\n             // now warn on use of deprecated key when it is different\n             LOG.warn(\"Using deprecated key \"+Attributes.VERSION+\", value \"+v2+\", which differs from the \" +\n-            \t\t\"preferred key \"+ConfigKeys.SUGGESTED_VERSION+\", value \"+version+\"; old key will be retired shortly!\");\n+            \t\t\"preferred key \"+BrooklynConfigKeys.SUGGESTED_VERSION+\", value \"+version+\"; old key will be retired shortly!\");\n             version = v2;\n         }\n         ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java",
                "sha": "40c20b919763cabf2551d035a31e69d6d8a09424",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 2,
                "filename": "core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java",
                "patch": "@@ -13,7 +13,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.LocationRegistry;\n import brooklyn.location.LocationResolver;\n import brooklyn.location.LocationSpec;\n@@ -135,7 +135,7 @@ public void init(ManagementContext managementContext) {\n         if (user != null) flags.put(\"user\", user);\n         if (name != null) flags.put(\"name\", name);\n         if (registry != null) {\n-            String brooklynDataDir = (String) registry.getProperties().get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+            String brooklynDataDir = (String) registry.getProperties().get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n             if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n                 flags.put(\"localTempDir\", new File(brooklynDataDir));\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java",
                "sha": "1b8df65dae914ddd952b818d255127373af6e718",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/location/basic/LocalhostResolver.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/LocalhostResolver.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 5,
                "filename": "core/src/main/java/brooklyn/location/basic/LocalhostResolver.java",
                "patch": "@@ -12,9 +12,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import brooklyn.config.ConfigKey;\n-import brooklyn.config.ConfigUtils;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.Location;\n import brooklyn.location.LocationRegistry;\n import brooklyn.location.LocationResolver;\n@@ -24,7 +22,6 @@\n import brooklyn.util.text.KeyValueParser;\n \n import com.google.common.collect.ImmutableSet;\n-import com.google.common.collect.Maps;\n import com.google.common.collect.Sets;\n \n /**\n@@ -96,7 +93,7 @@ protected Location newLocationFromString(String spec, brooklyn.location.Location\n             flags.put(\"name\", namePart);\n         }\n         if (registry != null) {\n-            String brooklynDataDir = (String) registry.getProperties().get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+            String brooklynDataDir = (String) registry.getProperties().get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n             if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n                 flags.put(\"localTempDir\", new File(brooklynDataDir));\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/main/java/brooklyn/location/basic/LocalhostResolver.java",
                "sha": "ebd0d7636ae686baa7aec6400bba64af49bb322b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 2,
                "filename": "core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java",
                "patch": "@@ -10,7 +10,7 @@\n import brooklyn.config.BrooklynProperties;\n import brooklyn.entity.basic.ApplicationBuilder;\n import brooklyn.entity.basic.Attributes;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.basic.Entities;\n import brooklyn.entity.proxying.EntitySpec;\n import brooklyn.location.Location;\n@@ -89,7 +89,7 @@ public void testReturnsLocalRepoThenOverrideThenAttributeValThenCloudsoftUrlThen\n         brooklynProperties.put(\"brooklyn.downloads.all.url\", \"http://fromprops/${version}.allprimary\");\n         brooklynProperties.put(\"brooklyn.downloads.all.fallbackurl\", \"http://fromfallback/${version}.allfallback\");\n         entity.setAttribute(Attributes.DOWNLOAD_URL, \"http://fromattrib/${version}.default\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         String expectedFilename = \"myversion.allprimary\";\n \n         String expectedLocalRepo = String.format(\"file://$HOME/.brooklyn/repository/%s/%s/%s\", \"TestEntity\", \"myversion\", expectedFilename);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java",
                "sha": "e4d13d8fe85a0da239ea512ca9d6ca3f4b460bb2",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 4,
                "filename": "core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java",
                "patch": "@@ -10,7 +10,7 @@\n \n import brooklyn.config.BrooklynProperties;\n import brooklyn.entity.basic.ApplicationBuilder;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.basic.Entities;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadRequirement;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadTargets;\n@@ -79,7 +79,7 @@ public void testReturnsGlobalFallbackUrl() throws Exception {\n     @Test\n     public void testSubstitutionsAppliedToFallbackUrl() throws Exception {\n         brooklynProperties.put(\"brooklyn.downloads.all.fallbackurl\", \"version=${version}\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         assertResolves(ImmutableList.<String>of(), ImmutableList.of(\"version=myversion\"));\n     }\n \n@@ -93,15 +93,15 @@ public void testReturnsGlobalFallbackUrlAsLast() throws Exception {\n     @Test\n     public void testReturnsGlobalUrlWithEntitySubstituions() throws Exception {\n         brooklynProperties.put(\"brooklyn.downloads.all.url\", \"version=${version}\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         assertResolves(\"version=myversion\");\n     }\n     \n     @Test\n     public void testEntitySpecificUrlOverridesGlobalUrl() throws Exception {\n         brooklynProperties.put(\"brooklyn.downloads.all.url\", \"version=${version}\");\n         brooklynProperties.put(\"brooklyn.downloads.entity.TestEntity.url\", \"overridden,version=${version}\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         assertResolves(\"overridden,version=myversion\", \"version=myversion\");\n     }\n     ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java",
                "sha": "f169bee621189aa2186d80cd49946c45e34503ce",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java",
                "patch": "@@ -12,7 +12,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.LocationRegistry;\n import brooklyn.location.LocationResolver;\n import brooklyn.location.LocationSpec;\n@@ -147,7 +147,7 @@ public void init(ManagementContext managementContext) {\n         if (user != null) flags.put(\"user\", user);\n         if (name != null) flags.put(\"name\", name);\n         if (registry != null) {\n-            String brooklynDataDir = (String) registry.getProperties().get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+            String brooklynDataDir = (String) registry.getProperties().get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n             if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n                 flags.put(\"localTempDir\", new File(brooklynDataDir));\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java",
                "sha": "e9ac5b600cbd96274ed6a9a4f27a727e4874b6b4",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "patch": "@@ -7,7 +7,7 @@\n import org.slf4j.LoggerFactory;\n \n import brooklyn.config.ConfigUtils;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.basic.DeprecatedKeysMappingBuilder;\n import brooklyn.location.basic.LocationPropertiesFromBrooklynProperties;\n \n@@ -74,7 +74,7 @@\n         jcloudsProperties.putAll(transformDeprecated(getProviderOrApiJcloudsProperties(providerOrApi, properties)));\n         jcloudsProperties.putAll(transformDeprecated(getRegionJcloudsProperties(providerOrApi, regionName, properties)));\n         if (!Strings.isNullOrEmpty(namedLocation)) jcloudsProperties.putAll(transformDeprecated(getNamedJcloudsProperties(namedLocation, properties)));\n-        String brooklynDataDir = (String) properties.get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+        String brooklynDataDir = (String) properties.get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n         if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n             jcloudsProperties.put(\"localTempDir\", new File(brooklynDataDir));\n         }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "sha": "a3cef2ce3ffe8ec88bb3be62b4c8c370cbaa21ab",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 5,
                "filename": "software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java",
                "patch": "@@ -56,17 +56,17 @@ public void rebind() {\n \t@Override\n \tpublic void start() {\n \t    DynamicTasks.queue(\"install\", new Runnable() { public void run() {\n-            waitForConfigKey(ConfigKeys.INSTALL_LATCH);\n+            waitForConfigKey(BrooklynConfigKeys.INSTALL_LATCH);\n             install();\n         }});\n         \n \t    DynamicTasks.queue(\"customize\", new Runnable() { public void run() {\n-            waitForConfigKey(ConfigKeys.CUSTOMIZE_LATCH);\n+            waitForConfigKey(BrooklynConfigKeys.CUSTOMIZE_LATCH);\n             customize();\n         }});\n         \n \t    DynamicTasks.queue(\"launch\", new Runnable() { public void run() {\n-            waitForConfigKey(ConfigKeys.LAUNCH_LATCH);\n+            waitForConfigKey(BrooklynConfigKeys.LAUNCH_LATCH);\n             launch();\n         }});\n         \n@@ -113,9 +113,11 @@ public void restart() {\n         }});\n \t}\n \t\n-\tpublic EntityLocal getEntity() { return entity; } \n+\t@Override\n+    public EntityLocal getEntity() { return entity; } \n \n-\tpublic Location getLocation() { return location; } \n+\t@Override\n+    public Location getLocation() { return location; } \n     \n     public InputStream getResource(String url) {\n         return new ResourceUtils(entity).getResourceFromUrl(url);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java",
                "sha": "1adc1ee0948935095c2056ec67f77797f7c71083",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 1,
                "filename": "software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java",
                "patch": "@@ -5,6 +5,7 @@\n import java.util.Map;\n \n import brooklyn.config.ConfigKey;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.basic.ConfigKeys;\n import brooklyn.entity.basic.SoftwareProcess;\n import brooklyn.entity.java.UsesJava;\n@@ -31,7 +32,7 @@\n             Map.class, \"brooklynnode.copytorundir\", \"URLs of resources to be copied across to the server, giving the path they are to be copied to\", MutableMap.of());\n     \n     @SetFromFlag(\"version\")\n-    public static final ConfigKey<String> SUGGESTED_VERSION = ConfigKeys.newConfigKeyWithDefault(ConfigKeys.SUGGESTED_VERSION, \"0.6.0-SNAPSHOT\"); // BROOKLYN_VERSION\n+    public static final ConfigKey<String> SUGGESTED_VERSION = ConfigKeys.newConfigKeyWithDefault(BrooklynConfigKeys.SUGGESTED_VERSION, \"0.6.0-SNAPSHOT\"); // BROOKLYN_VERSION\n \n     // Takes presidence over downloadUrl, if non-null\n     @SetFromFlag(\"distroUploadUrl\")",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java",
                "sha": "b41bcad9694a57a5a38b1fe0917255d6bf0684bb",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 5,
                "filename": "software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy",
                "patch": "@@ -12,8 +12,7 @@ import org.testng.annotations.BeforeMethod\n import org.testng.annotations.Test\n \n import brooklyn.entity.basic.AbstractSoftwareProcessSshDriver\n-import brooklyn.entity.basic.ConfigKeys\n-import brooklyn.entity.basic.Entities;\n+import brooklyn.entity.basic.BrooklynConfigKeys\n import brooklyn.location.basic.SshMachineLocation\n import brooklyn.test.entity.TestApplication\n import brooklyn.test.entity.TestApplicationImpl\n@@ -22,7 +21,7 @@ import brooklyn.test.entity.TestEntityImpl\n import brooklyn.util.internal.ssh.SshTool\n import brooklyn.util.internal.ssh.cli.SshCliTool\n import brooklyn.util.internal.ssh.sshj.SshjTool\n-import brooklyn.util.stream.StreamGobbler;\n+import brooklyn.util.stream.StreamGobbler\n \n class StartStopSshDriverTest {\n \n@@ -69,7 +68,7 @@ class StartStopSshDriverTest {\n \n     @Test(groups = [ \"Integration\" ])\n     public void testSshScriptHeaderUsedWhenSpecified() {\n-        entity.setConfig(ConfigKeys.SSH_CONFIG_SCRIPT_HEADER, \"#!/bin/bash -e\\necho hello world\");\n+        entity.setConfig(BrooklynConfigKeys.SSH_CONFIG_SCRIPT_HEADER, \"#!/bin/bash -e\\necho hello world\");\n         ByteArrayOutputStream out = new ByteArrayOutputStream();\n         driver.execute(out: out, Arrays.asList(\"echo goodbye\"), \"test\");\n         String s = out.toString();\n@@ -81,7 +80,7 @@ class StartStopSshDriverTest {\n \n     @Test(groups = [ \"Integration\" ])\n     public void testSshCliPickedUpWhenSpecified() {\n-        entity.setConfig(ConfigKeys.SSH_TOOL_CLASS, SshCliTool.class.getName());\n+        entity.setConfig(BrooklynConfigKeys.SSH_TOOL_CLASS, SshCliTool.class.getName());\n         driver.execute(Arrays.asList(\"echo hi\"), \"test\");\n         assertTrue(sshMachineLocation.lastTool instanceof SshCliTool, \"expect CLI tool, got \"+\n                         (sshMachineLocation.lastTool!=null ? \"\"+sshMachineLocation.lastTool.getClass()+\":\" : \"\") + sshMachineLocation.lastTool);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy",
                "sha": "84fdd44175812bd176981070400146c8c0830db6",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/1903230dc242d42db12889284150f80660f6dd73/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java?ref=1903230dc242d42db12889284150f80660f6dd73",
                "deletions": 2,
                "filename": "usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "patch": "@@ -30,7 +30,7 @@\n import brooklyn.BrooklynVersion;\n import brooklyn.config.BrooklynServiceAttributes;\n import brooklyn.config.ConfigKey;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.launcher.config.CustomResourceLocator;\n import brooklyn.location.PortRange;\n import brooklyn.location.basic.LocalhostMachineProvisioningLocation;\n@@ -147,7 +147,7 @@ public BrooklynWebServer(Map flags, ManagementContext managementContext) {\n         if (!leftovers.isEmpty())\n             log.warn(\"Ignoring unknown flags \" + leftovers);\n         \n-        String brooklynDataDir = checkNotNull(managementContext.getConfig().getConfig(ConfigKeys.BROOKLYN_DATA_DIR));\n+        String brooklynDataDir = checkNotNull(managementContext.getConfig().getConfig(BrooklynConfigKeys.BROOKLYN_DATA_DIR));\n         this.webappTempDir = new File(brooklynDataDir, \"jetty\");\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/1903230dc242d42db12889284150f80660f6dd73/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "sha": "12d43ef9ba9ae8b384bb3130d0319a0057c4f865",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #930 from aledsage/fix/NPE-from-ConfigKeys-fields-strike2\n\nFix: NPE from ConfigKeys fields",
        "parent": "https://github.com/apache/brooklyn-server/commit/8e130a5ea93a08b1b37d9695cd2f27af9bbafd7f",
        "patched_files": [
            "BrooklynNode.java",
            "JcloudsByonLocationResolver.java",
            "LocalhostResolver.java",
            "ConfigKeys.java",
            "Attributes.java",
            "StartStopSshDriverTest.groovy",
            "AbstractSoftwareProcessDriver.java",
            "DownloadSubstituters.java",
            "BrooklynWebServer.java",
            "DownloadProducerFromProperties.java",
            "JcloudsPropertiesFromBrooklynProperties.java",
            "ConfigUtils.java",
            "ByonLocationResolver.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "ConfigUtilsTest.java",
            "JcloudsPropertiesFromBrooklynPropertiesTest.java",
            "BrooklynWebServerTest.java",
            "BasicDownloadsRegistryTest.java",
            "ByonLocationResolverTest.java",
            "DownloadProducerFromPropertiesTest.java",
            "DownloadSubstitutersTest.java",
            "BrooklynNodeTest.java",
            "JcloudsByonLocationResolverTest.java",
            "ConfigKeysTest.java"
        ]
    },
    "brooklyn-server_28acb75": {
        "bug_id": "brooklyn-server_28acb75",
        "commit": "https://github.com/apache/brooklyn-server/commit/28acb753c869b98ca1a71c09d978a1d211531f69",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/28acb753c869b98ca1a71c09d978a1d211531f69/core/src/main/java/brooklyn/location/basic/AbstractLocation.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/AbstractLocation.java?ref=28acb753c869b98ca1a71c09d978a1d211531f69",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/location/basic/AbstractLocation.java",
                "patch": "@@ -167,7 +167,7 @@ public void setManagementContext(ManagementContextInternal managementContext) {\n         Location oldParent = parent.get();\n         Set<Location> oldChildren = children;\n         Map<String, Object> oldConfig = configBag.getAllConfig();\n-        long oldCreationTimeUtc = creationTimeUtc.get();\n+        Long oldCreationTimeUtc = creationTimeUtc.get();\n         String oldDisplayName = name.get();\n         HostGeoInfo oldHostGeoInfo = hostGeoInfo.get();\n         ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/28acb753c869b98ca1a71c09d978a1d211531f69/core/src/main/java/brooklyn/location/basic/AbstractLocation.java",
                "sha": "808653f53ed4670023e6b36c80730ee4692696da",
                "status": "modified"
            }
        ],
        "message": "avoid NPE in AbstractLocation if creationTimeUtc null\n\n- happens if you unmanaged and then remanage an entity.\n- the old creationTimeUtc will have been deleted from storage so will\n  be null, so doing `long l = createTimeUtc.get()` NPEs",
        "parent": "https://github.com/apache/brooklyn-server/commit/e13d809383f534d2ce0323662bb2c62b5c4b94d2",
        "patched_files": [
            "AbstractLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "AbstractLocationTest.java"
        ]
    },
    "brooklyn-server_2dadb24": {
        "bug_id": "brooklyn-server_2dadb24",
        "commit": "https://github.com/apache/brooklyn-server/commit/2dadb24b9b8e458d4dc1ebe4429d070913036679",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/2dadb24b9b8e458d4dc1ebe4429d070913036679/core/src/main/java/org/apache/brooklyn/core/mgmt/persist/XmlMementoSerializer.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/mgmt/persist/XmlMementoSerializer.java?ref=2dadb24b9b8e458d4dc1ebe4429d070913036679",
                "deletions": 1,
                "filename": "core/src/main/java/org/apache/brooklyn/core/mgmt/persist/XmlMementoSerializer.java",
                "patch": "@@ -315,7 +315,10 @@ public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingC\n             if (source == null) return;\n             if (((Task<?>)source).isDone() && !((Task<?>)source).isError()) {\n                 try {\n-                    context.convertAnother(((Task<?>)source).get());\n+                    Object nextItem = ((Task<?>)source).get();\n+                    if (nextItem != null) {\n+                        context.convertAnother(nextItem);\n+                    }\n                 } catch (InterruptedException e) {\n                     throw Exceptions.propagate(e);\n                 } catch (ExecutionException e) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/2dadb24b9b8e458d4dc1ebe4429d070913036679/core/src/main/java/org/apache/brooklyn/core/mgmt/persist/XmlMementoSerializer.java",
                "sha": "e9085dc52d51cc6b962ac1e36a7fb23a861163dc",
                "status": "modified"
            }
        ],
        "message": "Task serializer: avoid NPE if task result is null",
        "parent": "https://github.com/apache/brooklyn-server/commit/f0b1bf8cb832f4c000f3c9a7c43327ec5aabd82f",
        "patched_files": [
            "XmlMementoSerializer.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "XmlMementoSerializerTest.java"
        ]
    },
    "brooklyn-server_30292c9": {
        "bug_id": "brooklyn-server_30292c9",
        "commit": "https://github.com/apache/brooklyn-server/commit/30292c967b3368b2b58d2b00de965ab32ea456d6",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/30292c967b3368b2b58d2b00de965ab32ea456d6/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java?ref=30292c967b3368b2b58d2b00de965ab32ea456d6",
                "deletions": 1,
                "filename": "rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java",
                "patch": "@@ -171,7 +171,7 @@ public String getMessage() {\n         public static BundleInstallationRestResult of(OsgiBundleInstallationResult in, ManagementContext mgmt, BrooklynRestResourceUtils brooklynU, UriInfo ui) {\n             BundleInstallationRestResult result = new BundleInstallationRestResult();\n             result.message = in.getMessage();\n-            result.bundle = in.getMetadata().getVersionedName().toString();\n+            result.bundle = in.getVersionedName() != null ? in.getVersionedName().toString() : \"\";\n             result.code = in.getCode();\n             if (in.getCatalogItemsInstalled()!=null) {\n                 result.types = MutableMap.of();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/30292c967b3368b2b58d2b00de965ab32ea456d6/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java",
                "sha": "2d7487d481152cdb8c8946b7390df09452520a3f",
                "status": "modified"
            }
        ],
        "message": "Closes #719\n\nCheck versionedName to avoid NPE.\n\nFixes break from https://github.com/apache/brooklyn-server/pull/672,\nI merged without re-running unit tests :-(",
        "parent": "https://github.com/apache/brooklyn-server/commit/57b9d7270ba87486f311020bf62b37105d4ca0e4",
        "patched_files": [
            "CatalogResource.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "CatalogResourceTest.java"
        ]
    },
    "brooklyn-server_3228572": {
        "bug_id": "brooklyn-server_3228572",
        "commit": "https://github.com/apache/brooklyn-server/commit/32285720a098eef1769c202cadd12390d4ef1a7c",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/32285720a098eef1769c202cadd12390d4ef1a7c/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java?ref=32285720a098eef1769c202cadd12390d4ef1a7c",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java",
                "patch": "@@ -374,8 +374,8 @@ public String getSubnetIp() {\n         if (privateAddress.isPresent()) {\n             return privateAddress.get();\n         }\n-        if (groovyTruth(node.getPublicAddresses())) {\n-            return node.getPublicAddresses().iterator().next();\n+        if (groovyTruth(getPublicAddresses())) {\n+            return getPublicAddresses().iterator().next();\n         }\n         return null;\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/32285720a098eef1769c202cadd12390d4ef1a7c/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java",
                "sha": "43bddd263e8c7f7b5fbb1f73d3d72fbb560396e7",
                "status": "modified"
            },
            {
                "additions": 100,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/32285720a098eef1769c202cadd12390d4ef1a7c/locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java",
                "changes": 100,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java?ref=32285720a098eef1769c202cadd12390d4ef1a7c",
                "deletions": 0,
                "filename": "locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java",
                "patch": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.brooklyn.location.jclouds;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.brooklyn.location.jclouds.StubbedComputeServiceRegistry.AbstractNodeCreator;\n+import org.apache.brooklyn.location.jclouds.StubbedComputeServiceRegistry.NodeCreator;\n+import org.jclouds.compute.domain.NodeMetadata;\n+import org.jclouds.compute.domain.NodeMetadata.Status;\n+import org.jclouds.compute.domain.NodeMetadataBuilder;\n+import org.jclouds.compute.domain.Template;\n+import org.jclouds.domain.LoginCredentials;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import com.google.common.base.Optional;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+\n+public class JcloudsSshMachineLocationStubbedLiveTest extends AbstractJcloudsStubbedLiveTest {\n+\n+    @SuppressWarnings(\"unused\")\n+    private static final Logger log = LoggerFactory.getLogger(JcloudsImageChoiceStubbedLiveTest.class);\n+    \n+    private List<String> privateAddresses;\n+    private List<String> publicAddresses;\n+\n+    @BeforeMethod(alwaysRun=true)\n+    public void setUp() throws Exception {\n+        privateAddresses = ImmutableList.of(\"172.168.10.11\");\n+        publicAddresses = ImmutableList.of(\"173.194.32.123\");\n+        super.setUp();\n+    }\n+    \n+    @Override\n+    protected NodeCreator newNodeCreator() {\n+        return new AbstractNodeCreator() {\n+            @Override protected NodeMetadata newNode(String group, Template template) {\n+                NodeMetadata result = new NodeMetadataBuilder()\n+                        .id(\"myid\")\n+                        .credentials(LoginCredentials.builder().identity(\"myuser\").credential(\"mypassword\").build())\n+                        .loginPort(22)\n+                        .status(Status.RUNNING)\n+                        .publicAddresses(publicAddresses)\n+                        .privateAddresses(privateAddresses)\n+                        .build();\n+                return result;\n+            }\n+        };\n+    }\n+\n+    protected Map<Object, Object> jcloudsLocationConfig(Map<Object, Object> defaults) {\n+        return ImmutableMap.<Object, Object>builder()\n+                .putAll(defaults)\n+                .put(JcloudsLocationConfig.IMAGE_ID, \"CENTOS_5_64\")\n+                .build();\n+    }\n+\n+    @Test(groups={\"Live\", \"Live-sanity\"})\n+    public void testWithNoPrivateAddress() throws Exception {\n+        privateAddresses = ImmutableList.of();\n+        JcloudsSshMachineLocation machine = obtainMachine();\n+        assertEquals(machine.getPrivateAddresses(), ImmutableSet.of());\n+        assertEquals(machine.getPrivateAddress(), Optional.absent());\n+        assertEquals(machine.getSubnetIp(), publicAddresses.get(0));\n+        assertEquals(machine.getSubnetHostname(), publicAddresses.get(0));\n+    }\n+    \n+    @Test(groups={\"Live\", \"Live-sanity\"})\n+    public void testWithPrivateAddress() throws Exception {\n+        JcloudsSshMachineLocation machine = obtainMachine();\n+        assertEquals(machine.getPrivateAddresses(), privateAddresses);\n+        assertEquals(machine.getPrivateAddress(), Optional.of(privateAddresses.get(0)));\n+        assertEquals(machine.getSubnetIp(), privateAddresses.get(0));\n+        assertEquals(machine.getSubnetHostname(), privateAddresses.get(0));\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/32285720a098eef1769c202cadd12390d4ef1a7c/locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java",
                "sha": "ca89d12c698966e79a8c1f9e8213f0526b19486a",
                "status": "added"
            }
        ],
        "message": "Fix JcloudsSshMachineLocation.getSubnetIp\n\nPreviously would throw NPE if privateAddresses was empty.",
        "parent": "https://github.com/apache/brooklyn-server/commit/5c5061ede95e4c863abab9259ce79ecf52d8b668",
        "patched_files": [
            "JcloudsSshMachineLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsSshMachineLocationStubbedLiveTest.java"
        ]
    },
    "brooklyn-server_3396123": {
        "bug_id": "brooklyn-server_3396123",
        "commit": "https://github.com/apache/brooklyn-server/commit/3396123ac08dcd3cf36baec29102b698f9efa4e2",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/core/src/main/java/brooklyn/event/feed/http/HttpValueFunctions.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/event/feed/http/HttpValueFunctions.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 12,
                "filename": "core/src/main/java/brooklyn/event/feed/http/HttpValueFunctions.java",
                "patch": "@@ -2,8 +2,7 @@\n \n import java.util.List;\n \n-import javax.annotation.Nullable;\n-\n+import brooklyn.util.guava.Functionals;\n import brooklyn.util.http.HttpToolResponse;\n \n import com.google.common.base.Function;\n@@ -64,19 +63,19 @@ public Long apply(HttpToolResponse input) {\n         };\n     }\n     \n+    /** @deprecated since 0.7.0 use {@link Functionals#chain(Function, Function)} */ @Deprecated\n     public static <A,B,C> Function<A,C> chain(final Function<A,? extends B> f1, final Function<B,C> f2) {\n-        return new Function<A,C>() {\n-            @Override public C apply(@Nullable A input) {\n-                return f2.apply(f1.apply(input));\n-            }\n-        };\n+        return Functionals.chain(f1, f2);\n     }\n     \n+    /** @deprecated since 0.7.0 use {@link Functionals#chain(Function, Function, Function)} */ @Deprecated\n     public static <A,B,C,D> Function<A,D> chain(final Function<A,? extends B> f1, final Function<B,? extends C> f2, final Function<C,D> f3) {\n-        return new Function<A,D>() {\n-            @Override public D apply(@Nullable A input) {\n-                return f3.apply(f2.apply(f1.apply(input)));\n-            }\n-        };\n+        return Functionals.chain(f1, f2, f3);\n+    }\n+\n+    /** @deprecated since 0.7.0 use {@link Functionals#chain(Function, Function, Function, Function)} */ @Deprecated\n+    public static <A,B,C,D,E> Function<A,E> chain(final Function<A,? extends B> f1, final Function<B,? extends C> f2, final Function<C,? extends D> f3, final Function<D,E> f4) {\n+        return Functionals.chain(f1, f2, f3, f4);\n     }\n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/core/src/main/java/brooklyn/event/feed/http/HttpValueFunctions.java",
                "sha": "b1d0ca44290481d70576ab6911ac2c6288d4ede6",
                "status": "modified"
            },
            {
                "additions": 90,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/core/src/main/java/brooklyn/event/feed/http/JsonFunctions.java",
                "changes": 98,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/event/feed/http/JsonFunctions.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 8,
                "filename": "core/src/main/java/brooklyn/event/feed/http/JsonFunctions.java",
                "patch": "@@ -7,6 +7,12 @@\n import java.util.List;\n import java.util.NoSuchElementException;\n \n+import javax.annotation.Nullable;\n+\n+import brooklyn.util.guava.Functionals;\n+import brooklyn.util.guava.Maybe;\n+import brooklyn.util.guava.MaybeFunctions;\n+\n import com.google.common.base.Function;\n import com.google.common.base.Splitter;\n import com.google.common.collect.Lists;\n@@ -40,31 +46,92 @@ private JsonFunctions() {} // instead use static utility methods\n         };\n     }\n \n-    public static Function<JsonElement, JsonElement> walk(String elements) {\n-        Iterable<String> iterable = Splitter.on('.').split(elements);\n-        return walk(iterable);\n+    \n+    /** as {@link #walkM(Iterable)} taking a single string consisting of a dot separated path */\n+    public static Function<JsonElement, JsonElement> walk(String elementOrDotSeparatedElements) {\n+        return walk( Splitter.on('.').split(elementOrDotSeparatedElements) );\n     }\n \n-    public static Function<JsonElement, JsonElement> walk(Iterable<String> elements) {\n-        String[] array = Lists.newArrayList(elements).toArray(new String[0]);\n-        return walk(array);\n+    /** as {@link #walkM(Iterable)} taking a series of strings (dot separators not respected here) */\n+    public static Function<JsonElement, JsonElement> walk(final String... elements) {\n+        return walk(Arrays.asList(elements));\n     }\n \n-    public static Function<JsonElement, JsonElement> walk(final String... elements) {\n+    /** returns a function which traverses the supplied path of entries in a json object (maps of maps of maps...), \n+     * @throws NoSuchElementException if any path is not present as a key in that map */\n+    public static Function<JsonElement, JsonElement> walk(final Iterable<String> elements) {\n+        // could do this instead, pointing at Maybe for this, and for walkN, but it's slightly less efficient\n+//      return Functionals.chain(MaybeFunctions.<JsonElement>wrap(), walkM(elements), MaybeFunctions.<JsonElement>get());\n+        \n         return new Function<JsonElement, JsonElement>() {\n             @Override public JsonElement apply(JsonElement input) {\n                 JsonElement curr = input;\n                 for (String element : elements) {\n                     JsonObject jo = curr.getAsJsonObject();\n                     curr = jo.get(element);\n                     if (curr==null) \n-                        throw new NoSuchElementException(\"No element '\"+element+\" in JSON, when walking \"+Arrays.asList(elements));\n+                        throw new NoSuchElementException(\"No element '\"+element+\" in JSON, when walking \"+elements);\n                 }\n                 return curr;\n             }\n         };\n     }\n+\n     \n+    /** as {@link #walk(String)} but if any element is not found it simply returns null */\n+    public static Function<JsonElement, JsonElement> walkN(@Nullable String elements) {\n+        return walkN( Splitter.on('.').split(elements) );\n+    }\n+\n+    /** as {@link #walk(String...))} but if any element is not found it simply returns null */\n+    public static Function<JsonElement, JsonElement> walkN(final String... elements) {\n+        return walkN(Arrays.asList(elements));\n+    }\n+\n+    /** as {@link #walk(Iterable))} but if any element is not found it simply returns null */\n+    public static Function<JsonElement, JsonElement> walkN(final Iterable<String> elements) {\n+        return new Function<JsonElement, JsonElement>() {\n+            @Override public JsonElement apply(JsonElement input) {\n+                JsonElement curr = input;\n+                for (String element : elements) {\n+                    if (curr==null) return null;\n+                    JsonObject jo = curr.getAsJsonObject();\n+                    curr = jo.get(element);\n+                }\n+                return curr;\n+            }\n+        };\n+    }\n+\n+    /** as {@link #walk(String))} and {@link #walk(Iterable)} */\n+    public static Function<Maybe<JsonElement>, Maybe<JsonElement>> walkM(@Nullable String elements) {\n+        return walkM( Splitter.on('.').split(elements) );\n+    }\n+\n+    /** as {@link #walk(String...))} and {@link #walk(Iterable)} */\n+    public static Function<Maybe<JsonElement>, Maybe<JsonElement>> walkM(final String... elements) {\n+        return walkM(Arrays.asList(elements));\n+    }\n+\n+    /** as {@link #walk(Iterable))} but working with objects which {@link Maybe} contain {@link JsonElement},\n+     * simply preserving a {@link Maybe#absent()} object if additional walks are requested upon it\n+     * (cf jquery) */\n+    public static Function<Maybe<JsonElement>, Maybe<JsonElement>> walkM(final Iterable<String> elements) {\n+        return new Function<Maybe<JsonElement>, Maybe<JsonElement>>() {\n+            @Override public Maybe<JsonElement> apply(Maybe<JsonElement> input) {\n+                Maybe<JsonElement> curr = input;\n+                for (String element : elements) {\n+                    if (curr.isAbsent()) return curr;\n+                    JsonObject jo = curr.get().getAsJsonObject();\n+                    JsonElement currO = jo.get(element);\n+                    if (currO==null) return Maybe.absent(\"No element '\"+element+\" in JSON, when walking \"+elements);\n+                    curr = Maybe.of(currO);\n+                }\n+                return curr;\n+            }\n+        };\n+    }\n+\n     @SuppressWarnings(\"unchecked\")\n     public static <T> Function<JsonElement, T> cast(final Class<T> expected) {\n         return new Function<JsonElement, T>() {\n@@ -120,4 +187,19 @@ private JsonFunctions() {} // instead use static utility methods\n             }\n         };\n     }\n+    \n+    public static <T> Function<Maybe<JsonElement>, T> castM(final Class<T> expected) {\n+        return Functionals.chain(MaybeFunctions.<JsonElement>get(), cast(expected));\n+    }\n+    \n+    public static <T> Function<Maybe<JsonElement>, T> castM(final Class<T> expected, final T defaultValue) {\n+        return new Function<Maybe<JsonElement>, T>() {\n+            @Override\n+            public T apply(Maybe<JsonElement> input) {\n+                if (input.isAbsent()) return defaultValue;\n+                return cast(expected).apply(input.get());\n+            }\n+        };\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/core/src/main/java/brooklyn/event/feed/http/JsonFunctions.java",
                "sha": "46b4635f04ebeeead220f9df7f83942fe920e792",
                "status": "modified"
            },
            {
                "additions": 88,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/core/src/test/java/brooklyn/event/feed/http/JsonFunctionsTest.java",
                "changes": 88,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/event/feed/http/JsonFunctionsTest.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 0,
                "filename": "core/src/test/java/brooklyn/event/feed/http/JsonFunctionsTest.java",
                "patch": "@@ -0,0 +1,88 @@\n+package brooklyn.event.feed.http;\n+\n+import java.util.NoSuchElementException;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import brooklyn.util.collections.Jsonya;\n+import brooklyn.util.collections.Jsonya.Navigator;\n+import brooklyn.util.collections.MutableMap;\n+import brooklyn.util.guava.Functionals;\n+import brooklyn.util.guava.Maybe;\n+\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+\n+public class JsonFunctionsTest {\n+\n+    public static JsonElement europeMap() {\n+        Navigator<MutableMap<Object, Object>> europe = Jsonya.newInstance().at(\"europe\", \"uk\", \"edinburgh\")\n+                .put(\"population\", 500*1000)\n+                .put(\"weather\", \"wet\", \"lighting\", \"dark\")\n+                .root().at(\"europe\").at(\"france\").put(\"population\", 80*1000*1000)\n+                .root();\n+        return new JsonParser().parse( europe.toString() );\n+    }\n+\n+    @Test\n+    public void testWalk1() {\n+        JsonElement pop = JsonFunctions.walk(\"europe\", \"france\", \"population\").apply(europeMap());\n+        Assert.assertEquals( (int)JsonFunctions.cast(Integer.class).apply(pop), 80*1000*1000 );\n+    }\n+\n+    @Test\n+    public void testWalk2() {\n+        String weather = Functionals.chain(\n+            JsonFunctions.walk(\"europe.uk.edinburgh.weather\"),\n+            JsonFunctions.cast(String.class) ).apply(europeMap());\n+        Assert.assertEquals(weather, \"wet\");\n+    }\n+\n+    @Test(expectedExceptions=NoSuchElementException.class)\n+    public void testWalkWrong() {\n+        Functionals.chain(\n+            JsonFunctions.walk(\"europe\", \"spain\", \"barcelona\"),\n+            JsonFunctions.cast(String.class) ).apply(europeMap());\n+    }\n+\n+\n+    @Test\n+    public void testWalkM() {\n+        Maybe<JsonElement> pop = JsonFunctions.walkM(\"europe\", \"france\", \"population\").apply( Maybe.of(europeMap()) );\n+        Assert.assertEquals( (int)JsonFunctions.castM(Integer.class).apply(pop), 80*1000*1000 );\n+    }\n+\n+    @Test\n+    public void testWalkMWrong1() {\n+        Maybe<JsonElement> m = JsonFunctions.walkM(\"europe\", \"spain\", \"barcelona\").apply( Maybe.of( europeMap()) );\n+        Assert.assertTrue(m.isAbsent());\n+    }\n+\n+    @Test(expectedExceptions=Exception.class)\n+    public void testWalkMWrong2() {\n+        Maybe<JsonElement> m = JsonFunctions.walkM(\"europe\", \"spain\", \"barcelona\").apply( Maybe.of( europeMap()) );\n+        JsonFunctions.castM(String.class).apply(m);\n+    }\n+\n+    \n+    @Test\n+    public void testWalkN() {\n+        JsonElement pop = JsonFunctions.walkN(\"europe\", \"france\", \"population\").apply( europeMap() );\n+        Assert.assertEquals( (int)JsonFunctions.cast(Integer.class).apply(pop), 80*1000*1000 );\n+    }\n+\n+    @Test\n+    public void testWalkNWrong1() {\n+        JsonElement m = JsonFunctions.walkN(\"europe\", \"spain\", \"barcelona\").apply( europeMap() );\n+        Assert.assertNull(m);\n+    }\n+\n+    public void testWalkNWrong2() {\n+        JsonElement m = JsonFunctions.walkN(\"europe\", \"spain\", \"barcelona\").apply( europeMap() );\n+        String n = JsonFunctions.cast(String.class).apply(m);\n+        Assert.assertNull(n);\n+    }\n+\n+\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/core/src/test/java/brooklyn/event/feed/http/JsonFunctionsTest.java",
                "sha": "d555b3722369d6652017ceee731db750ccf185a3",
                "status": "added"
            },
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/collections/Jsonya.java",
                "changes": 49,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/collections/Jsonya.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 4,
                "filename": "utils/common/src/main/java/brooklyn/util/collections/Jsonya.java",
                "patch": "@@ -7,7 +7,11 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.Stack;\n \n+import javax.annotation.Nonnull;\n+\n+import brooklyn.util.guava.Maybe;\n import brooklyn.util.text.StringEscapes.JavaStringEscapes;\n \n import com.google.common.annotations.Beta;\n@@ -94,6 +98,7 @@ public static boolean isJsonPrimitiveCompatible(Object x) {\n         protected final Object root;\n         protected final Class<? extends Map> mapType;\n         protected Object focus;\n+        protected Stack<Object> focusStack = new Stack<Object>();\n         protected Function<Object,Void> creationInPreviousFocus;\n         protected Function<Object,Object> translator;\n \n@@ -109,15 +114,33 @@ public Navigator(Object backingStore, Class<? extends Map> mapType) {\n         public Object get() {\n             return focus;\n         }\n+\n+        /** as {@link #get()} but always wrapped in a {@link Maybe}, absent if null */\n+        public @Nonnull Maybe<Object> getMaybe() {\n+            return Maybe.fromNullable(focus);\n+        }\n         \n-        /** returns the object at the focus, casted to the given type, null if none */\n+        /** returns the object at the focus, casted to the given type, null if none\n+         * @throws ClassCastException if object exists here but of the wrong type  */\n         public <V> V get(Class<V> type) {\n             return (V)focus;\n         }\n-        \n+\n+        /** as {@link #get(Class)} but always wrapped in a {@link Maybe}, absent if null\n+         * @throws ClassCastException if object exists here but of the wrong type  */\n+        public @Nonnull <V> Maybe<V> getMaybe(Class<V> type) {\n+            return Maybe.fromNullable(get(type));\n+        }\n+\n+        /** gets the object at the indicated path from the current focus\n+         * (without changing the path to that focus; use {@link #at(Object, Object...)} to change focus) */\n+        // Jun 2014, semantics changed so that focus does not change, which is more natural\n         public Object get(Object pathSegment, Object ...furtherPathSegments) {\n+            push();\n             at(pathSegment, furtherPathSegments);\n-            return get();\n+            Object result = get();\n+            pop();\n+            return result;\n         }\n         \n         public Navigator<T> root() {\n@@ -141,6 +164,12 @@ public T getFocusMap() {\n             map();\n             return (T)focus;\n         }\n+        \n+        /** as {@link #getFocusMap()} but always wrapped in a {@link Maybe}, absent if null\n+         * @throws ClassCastException if object exists here but of the wrong type  */\n+        public @Nonnull Maybe<T> getFocusMapMaybe() {\n+            return Maybe.fromNullable(getFocusMap());\n+        }\n \n         /** specifies a translator function to use when new data is added;\n          * by default everything is added as a literal (ie {@link Functions#identity()}), \n@@ -168,7 +197,19 @@ protected Object translateKey(Object x) {\n \n         // ------------- navigation (map mainly)\n \n-        /** returns the navigator focussed at the indicated key sequence in the given map */\n+        /** pushes the current focus to a stack, so that this location will be restored on the corresponding {@link #pop()} */\n+        public Navigator<T> push() {\n+            focusStack.push(focus);\n+            return this;\n+        }\n+        \n+        /** pops the most recently pushed focus, so that it returns to the last location {@link #push()}ed */\n+        public Navigator<T> pop() {\n+            focus = focusStack.pop();\n+            return this;\n+        }\n+        \n+        /** returns the navigator moved to focus at the indicated key sequence in the given map */\n         public Navigator<T> at(Object pathSegment, Object ...furtherPathSegments) {\n             down(pathSegment);\n             return atArray(furtherPathSegments);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/collections/Jsonya.java",
                "sha": "ef3916520cda23d8b4be4b018447aabec36cb0c8",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/guava/Functionals.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/guava/Functionals.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 0,
                "filename": "utils/common/src/main/java/brooklyn/util/guava/Functionals.java",
                "patch": "@@ -0,0 +1,23 @@\n+package brooklyn.util.guava;\n+\n+import com.google.common.base.Function;\n+import com.google.common.base.Functions;\n+\n+public class Functionals {\n+\n+    /** applies f1 to the input, then the result of that is passed to f2 (note opposite semantics to {@link Functions#compose(Function, Function)} */ \n+    public static <A,B,C> Function<A,C> chain(final Function<A,? extends B> f1, final Function<B,C> f2) {\n+        return Functions.compose(f2, f1);\n+    }\n+    \n+    /** applies f1 to the input, then f2 to that result, then f3 to that result */\n+    public static <A,B,C,D> Function<A,D> chain(final Function<A,? extends B> f1, final Function<B,? extends C> f2, final Function<C,D> f3) {\n+        return chain(f1, chain(f2, f3));\n+    }\n+    \n+    /** applies f1 to the input, then f2 to that result, then f3 to that result, then f4 to that result */\n+    public static <A,B,C,D,E> Function<A,E> chain(final Function<A,? extends B> f1, final Function<B,? extends C> f2, final Function<C,? extends D> f3, final Function<D,E> f4) {\n+        return chain(f1, chain(f2, chain(f3, f4)));\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/guava/Functionals.java",
                "sha": "d026710b3037232d961e9585291c1ffda9757ed9",
                "status": "added"
            },
            {
                "additions": 34,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/guava/MaybeFunctions.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/guava/MaybeFunctions.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 0,
                "filename": "utils/common/src/main/java/brooklyn/util/guava/MaybeFunctions.java",
                "patch": "@@ -0,0 +1,34 @@\n+package brooklyn.util.guava;\n+\n+import com.google.common.base.Function;\n+\n+public class MaybeFunctions {\n+\n+    public static <T> Function<T, Maybe<T>> wrap() {\n+        return new Function<T, Maybe<T>>() {\n+            @Override\n+            public Maybe<T> apply(T input) {\n+                return Maybe.fromNullable(input);\n+            }\n+        };\n+    }\n+\n+    public static <T> Function<Maybe<T>, T> get() {\n+        return new Function<Maybe<T>, T>() {\n+            @Override\n+            public T apply(Maybe<T> input) {\n+                return input.get();\n+            }\n+        };\n+    }\n+\n+    public static <T> Function<Maybe<T>, T> or(final T value) {\n+        return new Function<Maybe<T>, T>() {\n+            @Override\n+            public T apply(Maybe<T> input) {\n+                return input.or(value);\n+            }\n+        };\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/guava/MaybeFunctions.java",
                "sha": "8836e73638eed565b851770d5fe1948dd0a05d71",
                "status": "added"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/guava/TypeTokens.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/guava/TypeTokens.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 0,
                "filename": "utils/common/src/main/java/brooklyn/util/guava/TypeTokens.java",
                "patch": "@@ -44,4 +44,11 @@\n         throw new IllegalStateException(\"Both indicators of type are null\");\n     }\n \n+    /** gets the Class<T> object from a token; normal methods return Class<? super T> which may technically be correct \n+     * with generics but this sloppily but handily gives you Class<T> which is usually what you have anyway */\n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    public static <T> Class<T> getRawRawType(TypeToken<T> token) {\n+        return (Class)token.getRawType();\n+    }\n+    \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/main/java/brooklyn/util/guava/TypeTokens.java",
                "sha": "26105f433bb98efbdbebe23603d7ecfa5df2898e",
                "status": "modified"
            },
            {
                "additions": 38,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/test/java/brooklyn/util/collections/JsonyaTest.java",
                "changes": 41,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/test/java/brooklyn/util/collections/JsonyaTest.java?ref=3396123ac08dcd3cf36baec29102b698f9efa4e2",
                "deletions": 3,
                "filename": "utils/common/src/test/java/brooklyn/util/collections/JsonyaTest.java",
                "patch": "@@ -13,7 +13,7 @@\n \n public class JsonyaTest {\n     \n-    protected Navigator<MutableMap<Object,Object>> europeMap() {\n+    public static Navigator<MutableMap<Object,Object>> europeMap() {\n         return Jsonya.newInstance().at(\"europe\", \"uk\", \"edinburgh\")\n                 .put(\"population\", 500*1000)\n                 .put(\"weather\", \"wet\", \"lighting\", \"dark\")\n@@ -50,10 +50,10 @@ public void testJsonyaWithList() {\n         n.at(\"europe\", \"uk\", \"neighbours\").list().add(\"ireland\")\n             .root().at(\"europe\", \"france\", \"neighbours\").list().add(\"spain\", \"germany\").add(\"switzerland\")\n             .root().at(\"europe\", \"france\", \"neighbours\").add(\"lux\");\n-        Object l = n.root().get(\"europe\", \"france\", \"neighbours\");\n+        Object l = n.root().at(\"europe\", \"france\", \"neighbours\").get();\n         Assert.assertTrue(l instanceof List);\n         Assert.assertEquals(((List)l).size(), 4);\n-        // currently remembers last position; not sure that behaviour will continue however...\n+        // this wants a map, so it creates a map in the list\n         n.put(\"east\", \"germany\", \"south\", \"spain\");\n         Assert.assertEquals(((List)l).size(), 5);\n         Map nd = (Map) ((List)l).get(4);\n@@ -135,4 +135,39 @@ public void testPrimitivedAndLiteralledMap() {\n         Assert.assertEquals(MutableMap.copyOf(mapP).add('C', null), MutableMap.copyOf(map).add('C', null));\n     }\n \n+    @Test\n+    public void testJsonyaBadPathNull() {\n+        Navigator<MutableMap<Object, Object>> m = europeMap();\n+        // does not create (but if we 'pushed' it would)\n+        Assert.assertNull( m.at(\"europe\",  \"spain\", \"barcelona\").get() );\n+        Assert.assertNull( m.root().at(\"europe\").at(\"spain\").at(\"barcelona\").get() );\n+    }\n+    @Test\n+    public void testJsonyaMaybe() {\n+        Navigator<MutableMap<Object, Object>> m = europeMap();\n+        Assert.assertEquals( m.at(\"europe\",  \"spain\", \"barcelona\").getMaybe().or(\"norealabc\"), \"norealabc\" );\n+        Assert.assertEquals(m.root().at(\"europe\").getFocusMap().keySet(), MutableSet.of(\"uk\", \"france\"));\n+    }\n+    \n+    @Test\n+    public void testJsonyaPushPop() {\n+        Navigator<MutableMap<Object, Object>> m = europeMap();\n+        Assert.assertTrue(m.getFocusMap().containsKey(\"europe\"));\n+        Assert.assertFalse(m.getFocusMap().containsKey(\"edinburgh\"));\n+        m.push();\n+        \n+        m.at(\"europe\", \"uk\");\n+        Assert.assertTrue(m.getFocusMap().containsKey(\"edinburgh\"));\n+        Assert.assertFalse(m.getFocusMap().containsKey(\"europe\"));\n+        \n+        m.pop();\n+        Assert.assertTrue(m.getFocusMap().containsKey(\"europe\"));\n+        Assert.assertFalse(m.getFocusMap().containsKey(\"edinburgh\"));\n+\n+        // also check 'get' does not change focus\n+        m.get(\"europe\", \"uk\");\n+        Assert.assertTrue(m.getFocusMap().containsKey(\"europe\"));\n+        Assert.assertFalse(m.getFocusMap().containsKey(\"edinburgh\"));\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3396123ac08dcd3cf36baec29102b698f9efa4e2/utils/common/src/test/java/brooklyn/util/collections/JsonyaTest.java",
                "sha": "1650c9c82f098c1da0da1baf558179e2972f9c4b",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #1474 from ahgittin/couchbase\n\nCouchbase code tidy, nicer way to define sensors, and prevent NPE's, using new `Functionals`",
        "parent": "https://github.com/apache/brooklyn-server/commit/c2671e71591aa7dcbf74d3ec179e126824061f18",
        "patched_files": [
            "JsonFunctions.java",
            "HttpValueFunctions.java",
            "TypeTokens.java",
            "Functionals.java",
            "MaybeFunctions.java",
            "Jsonya.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JsonyaTest.java",
            "JsonFunctionsTest.java"
        ]
    },
    "brooklyn-server_33df067": {
        "bug_id": "brooklyn-server_33df067",
        "commit": "https://github.com/apache/brooklyn-server/commit/33df0677c32650d668c0b4a41f03df106a9462ef",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/33df0677c32650d668c0b4a41f03df106a9462ef/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsLocation.java?ref=33df0677c32650d668c0b4a41f03df106a9462ef",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -2515,8 +2515,16 @@ protected LoginCredentials waitForSshable(final ComputeService computeService, f\n         LoginCredentials nodeCreds = node.getCredentials();\n         String nodeUser = nodeCreds.getUser();\n         String loginUserOverride = setup.get(LOGIN_USER);\n-        Set<String> users = MutableSet.<String>builder().add(nodeUser).add(loginUserOverride).build();\n-        \n+        Set<String> users = MutableSet.of();\n+\n+        if (Strings.isNonBlank(nodeUser)) {\n+            users.add(nodeUser);\n+        }\n+\n+        if (Strings.isNonBlank(loginUserOverride)) {\n+            users.add(loginUserOverride);\n+        }\n+\n         // See https://issues.apache.org/jira/browse/BROOKLYN-186\n         // Handle where jclouds gives us the wrong login user (!) and both a password + ssh key.\n         // Try all the permutations to find the one that works.",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/33df0677c32650d668c0b4a41f03df106a9462ef/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "4c3297d92f9808e0f59390afd7955ff0afb81055",
                "status": "modified"
            }
        ],
        "message": "Fix NPE if loginUser is not present and useJcloudsSshInit is false",
        "parent": "https://github.com/apache/brooklyn-server/commit/998ee50761efe238785c3dceca0f780abc22af16",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_3a477f9": {
        "bug_id": "brooklyn-server_3a477f9",
        "commit": "https://github.com/apache/brooklyn-server/commit/3a477f9db657fb7c89704ef2e4913e3ce3927c2b",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/3a477f9db657fb7c89704ef2e4913e3ce3927c2b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=3a477f9db657fb7c89704ef2e4913e3ce3927c2b",
                "deletions": 3,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -1135,7 +1135,8 @@ protected SshMachineLocation createTemporarySshMachineLocation(HostAndPort hostA\n      * Create the user immediately - executing ssh commands as required.\n      */\n     protected LoginCredentials createUser(ComputeService computeService, NodeMetadata node, Optional<HostAndPort> hostAndPortOverride, ConfigBag config) {\n-        UserCreation userCreation = createUserStatements(computeService.getImage(node.getImageId()), config);\n+        Image image = (node.getImageId() != null) ? computeService.getImage(node.getImageId()) : null;\n+        UserCreation userCreation = createUserStatements(image, config);\n         \n         if (!userCreation.statements.isEmpty()) {\n             org.jclouds.compute.domain.OsFamily osFamily = node.getOperatingSystem().getFamily();\n@@ -1260,15 +1261,15 @@ public UserCreation(LoginCredentials creds, List<Statement> statements) {\n      * @param config Configuration for creating the VM\n      * @return       The commands required to create the user, along with the expected login credentials.\n      */\n-    protected UserCreation createUserStatements(Image image, ConfigBag config) {\n+    protected UserCreation createUserStatements(@Nullable Image image, ConfigBag config) {\n         //NB: we ignore private key here because, by default we probably should not be installing it remotely;\n         //also, it may not be valid for first login (it is created before login e.g. on amazon, so valid there;\n         //but not elsewhere, e.g. on rackspace).\n         \n         LoginCredentials loginCreds = null;\n         String user = getUser(config);\n         String explicitLoginUser = config.get(LOGIN_USER);\n-        String loginUser = groovyTruth(explicitLoginUser) ? explicitLoginUser : (image.getDefaultCredentials() != null) ? image.getDefaultCredentials().identity : null;\n+        String loginUser = groovyTruth(explicitLoginUser) ? explicitLoginUser : (image != null && image.getDefaultCredentials() != null) ? image.getDefaultCredentials().identity : null;\n         Boolean dontCreateUser = config.get(DONT_CREATE_USER);\n         Boolean grantUserSudo = config.get(GRANT_USER_SUDO);\n         String publicKeyData = LocationConfigUtils.getPublicKeyData(config);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/3a477f9db657fb7c89704ef2e4913e3ce3927c2b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "da5f5dd953b27ade3950c2cce01f1fc35ce7fa13",
                "status": "modified"
            }
        ],
        "message": "JcloudsLocation: avoid NPE if node.getImageId null",
        "parent": "https://github.com/apache/brooklyn-server/commit/e0c405a85f068451003f9634141f31229e9fdafe",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_46bf6b5": {
        "bug_id": "brooklyn-server_46bf6b5",
        "commit": "https://github.com/apache/brooklyn-server/commit/46bf6b54365a0bdb0f80580a95a815a6ee85b8b8",
        "file": [
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/46bf6b54365a0bdb0f80580a95a815a6ee85b8b8/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java?ref=46bf6b54365a0bdb0f80580a95a815a6ee85b8b8",
                "deletions": 10,
                "filename": "core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java",
                "patch": "@@ -457,10 +457,13 @@ protected void addSshPoolCacheCleanupTask() {\n                     .displayName(\"ssh-location cache cleaner\").body(new Callable<Void>() {\n                     @Override public Void call() {\n                         try {\n-                            if (sshPoolCacheOrNull != null) sshPoolCacheOrNull.cleanUp();\n+                            LoadingCache<Map<String, ?>, Pool<SshTool>> sshPoolCacheOrNullRef = sshPoolCacheOrNull;\n+                            Task<?> cleanupTaskRef = cleanupTask;\n+                            \n+                            if (sshPoolCacheOrNullRef != null) sshPoolCacheOrNullRef.cleanUp();\n                             if (!SshMachineLocation.this.isManaged()) {\n-                                if (sshPoolCacheOrNull != null) sshPoolCacheOrNull.invalidateAll();\n-                                cleanupTask.cancel(false);\n+                                if (sshPoolCacheOrNullRef != null) sshPoolCacheOrNullRef.invalidateAll();\n+                                if (cleanupTaskRef != null) cleanupTaskRef.cancel(false);\n                                 sshPoolCacheOrNull = null;\n                             }\n                             return null;\n@@ -486,17 +489,20 @@ protected void addSshPoolCacheCleanupTask() {\n     // we should probably expose a mechanism such as that in Entity (or re-use Entity for locations!)\n     @Override\n     public void close() throws IOException {\n-        if (sshPoolCacheOrNull != null) {\n+        LoadingCache<Map<String, ?>, Pool<SshTool>> sshPoolCacheOrNullRef = sshPoolCacheOrNull;\n+        Task<?> cleanupTaskRef = cleanupTask;\n+        \n+        if (sshPoolCacheOrNullRef != null) {\n             if (LOG.isDebugEnabled()) {\n-                LOG.debug(\"{} invalidating all entries in ssh pool cache. Final stats: {}\", this, sshPoolCacheOrNull.stats());\n+                LOG.debug(\"{} invalidating all entries in ssh pool cache. Final stats: {}\", this, sshPoolCacheOrNullRef.stats());\n             }\n-            sshPoolCacheOrNull.invalidateAll();\n+            sshPoolCacheOrNullRef.invalidateAll();\n         }\n-        if (cleanupTask != null) {\n-            cleanupTask.cancel(false);\n-            cleanupTask = null;\n-            sshPoolCacheOrNull = null;\n+        if (cleanupTaskRef != null) {\n+            cleanupTaskRef.cancel(false);\n         }\n+        cleanupTask = null;\n+        sshPoolCacheOrNull = null;\n     }\n \n     // should not be necessary, and causes objects to be kept around a lot longer than desired",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/46bf6b54365a0bdb0f80580a95a815a6ee85b8b8/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java",
                "sha": "2ff94914f38d314264269c0d5a4d1cad99f842fb",
                "status": "modified"
            }
        ],
        "message": "BROOKLYN-225: avoid NPE in SshMachineLocation cleanup",
        "parent": "https://github.com/apache/brooklyn-server/commit/495b1d335ab01d832978e01956b81a34434f24af",
        "patched_files": [
            "SshMachineLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "SshMachineLocationTest.java"
        ]
    },
    "brooklyn-server_5115a4a": {
        "bug_id": "brooklyn-server_5115a4a",
        "commit": "https://github.com/apache/brooklyn-server/commit/5115a4a3f1f0ed78252a23ef0d302c7af3e29126",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5115a4a3f1f0ed78252a23ef0d302c7af3e29126/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java?ref=5115a4a3f1f0ed78252a23ef0d302c7af3e29126",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java",
                "patch": "@@ -374,8 +374,8 @@ public String getSubnetIp() {\n         if (privateAddress.isPresent()) {\n             return privateAddress.get();\n         }\n-        if (groovyTruth(node.getPublicAddresses())) {\n-            return node.getPublicAddresses().iterator().next();\n+        if (groovyTruth(getPublicAddresses())) {\n+            return getPublicAddresses().iterator().next();\n         }\n         return null;\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5115a4a3f1f0ed78252a23ef0d302c7af3e29126/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocation.java",
                "sha": "51a476fd92dadf4acaa1335736a383dc1cb56476",
                "status": "modified"
            },
            {
                "additions": 100,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5115a4a3f1f0ed78252a23ef0d302c7af3e29126/locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java",
                "changes": 100,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java?ref=5115a4a3f1f0ed78252a23ef0d302c7af3e29126",
                "deletions": 0,
                "filename": "locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java",
                "patch": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.brooklyn.location.jclouds;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.brooklyn.location.jclouds.StubbedComputeServiceRegistry.AbstractNodeCreator;\n+import org.apache.brooklyn.location.jclouds.StubbedComputeServiceRegistry.NodeCreator;\n+import org.jclouds.compute.domain.NodeMetadata;\n+import org.jclouds.compute.domain.NodeMetadata.Status;\n+import org.jclouds.compute.domain.NodeMetadataBuilder;\n+import org.jclouds.compute.domain.Template;\n+import org.jclouds.domain.LoginCredentials;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import com.google.common.base.Optional;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+\n+public class JcloudsSshMachineLocationStubbedLiveTest extends AbstractJcloudsStubbedLiveTest {\n+\n+    @SuppressWarnings(\"unused\")\n+    private static final Logger log = LoggerFactory.getLogger(JcloudsImageChoiceStubbedLiveTest.class);\n+    \n+    private List<String> privateAddresses;\n+    private List<String> publicAddresses;\n+\n+    @BeforeMethod(alwaysRun=true)\n+    public void setUp() throws Exception {\n+        privateAddresses = ImmutableList.of(\"172.168.10.11\");\n+        publicAddresses = ImmutableList.of(\"173.194.32.123\");\n+        super.setUp();\n+    }\n+    \n+    @Override\n+    protected NodeCreator newNodeCreator() {\n+        return new AbstractNodeCreator() {\n+            @Override protected NodeMetadata newNode(String group, Template template) {\n+                NodeMetadata result = new NodeMetadataBuilder()\n+                        .id(\"myid\")\n+                        .credentials(LoginCredentials.builder().identity(\"myuser\").credential(\"mypassword\").build())\n+                        .loginPort(22)\n+                        .status(Status.RUNNING)\n+                        .publicAddresses(publicAddresses)\n+                        .privateAddresses(privateAddresses)\n+                        .build();\n+                return result;\n+            }\n+        };\n+    }\n+\n+    protected Map<Object, Object> jcloudsLocationConfig(Map<Object, Object> defaults) {\n+        return ImmutableMap.<Object, Object>builder()\n+                .putAll(defaults)\n+                .put(JcloudsLocationConfig.IMAGE_ID, \"CENTOS_5_64\")\n+                .build();\n+    }\n+\n+    @Test(groups={\"Live\", \"Live-sanity\"})\n+    public void testWithNoPrivateAddress() throws Exception {\n+        privateAddresses = ImmutableList.of();\n+        JcloudsSshMachineLocation machine = obtainMachine();\n+        assertEquals(machine.getPrivateAddresses(), ImmutableSet.of());\n+        assertEquals(machine.getPrivateAddress(), Optional.absent());\n+        assertEquals(machine.getSubnetIp(), publicAddresses.get(0));\n+        assertEquals(machine.getSubnetHostname(), publicAddresses.get(0));\n+    }\n+    \n+    @Test(groups={\"Live\", \"Live-sanity\"})\n+    public void testWithPrivateAddress() throws Exception {\n+        JcloudsSshMachineLocation machine = obtainMachine();\n+        assertEquals(machine.getPrivateAddresses(), privateAddresses);\n+        assertEquals(machine.getPrivateAddress(), Optional.of(privateAddresses.get(0)));\n+        assertEquals(machine.getSubnetIp(), privateAddresses.get(0));\n+        assertEquals(machine.getSubnetHostname(), privateAddresses.get(0));\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5115a4a3f1f0ed78252a23ef0d302c7af3e29126/locations/jclouds/src/test/java/org/apache/brooklyn/location/jclouds/JcloudsSshMachineLocationStubbedLiveTest.java",
                "sha": "ca89d12c698966e79a8c1f9e8213f0526b19486a",
                "status": "added"
            }
        ],
        "message": "Closes #197\n\nFix JcloudsSshMachineLocation.getSubnetIp\n\nPreviously would throw NPE if privateAddresses was empty.",
        "parent": "https://github.com/apache/brooklyn-server/commit/ac1b9080225cdfe82aa48b2dee59a71f029b57a8",
        "patched_files": [
            "JcloudsSshMachineLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsSshMachineLocationStubbedLiveTest.java"
        ]
    },
    "brooklyn-server_5130576": {
        "bug_id": "brooklyn-server_5130576",
        "commit": "https://github.com/apache/brooklyn-server/commit/513057694816b45a054c4ff6d2a426ef5bb919f8",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/api/src/main/java/brooklyn/entity/rebind/ChangeListener.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/api/src/main/java/brooklyn/entity/rebind/ChangeListener.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "api/src/main/java/brooklyn/entity/rebind/ChangeListener.java",
                "patch": "@@ -6,6 +6,16 @@\n \n public interface ChangeListener {\n \n+    public static final ChangeListener NOOP = new ChangeListener() {\n+        @Override public void onManaged(Entity entity) {}\n+        @Override public void onUnmanaged(Entity entity) {}\n+        @Override public void onChanged(Entity entity) {}\n+        @Override public void onManaged(Location location) {}\n+        @Override public void onUnmanaged(Location location) {}\n+        @Override public void onChanged(Location location) {}\n+        @Override public void onChanged(Policy policy) {}\n+    };\n+    \n     void onManaged(Entity entity);\n     \n     void onUnmanaged(Entity entity);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/api/src/main/java/brooklyn/entity/rebind/ChangeListener.java",
                "sha": "d3acef7ef8a9b208a0f22f3406f2726c4209b9f1",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/api/src/main/java/brooklyn/entity/rebind/RebindManager.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/api/src/main/java/brooklyn/entity/rebind/RebindManager.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "api/src/main/java/brooklyn/entity/rebind/RebindManager.java",
                "patch": "@@ -6,6 +6,8 @@\n import brooklyn.mementos.BrooklynMemento;\n import brooklyn.mementos.BrooklynMementoPersister;\n \n+import com.google.common.annotations.VisibleForTesting;\n+\n public interface RebindManager {\n     \n     // FIXME Should we be calling managementContext.getRebindManager().rebind, using a\n@@ -24,4 +26,7 @@\n     public ChangeListener getChangeListener();\n \n     public void stop();\n+\n+    @VisibleForTesting\n+    public void waitForPendingComplete() throws InterruptedException;\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/api/src/main/java/brooklyn/entity/rebind/RebindManager.java",
                "sha": "2b78b1a09526e3ef83576385a2fac83e5d90d5ad",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/api/src/main/java/brooklyn/mementos/BrooklynMementoPersister.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/api/src/main/java/brooklyn/mementos/BrooklynMementoPersister.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "api/src/main/java/brooklyn/mementos/BrooklynMementoPersister.java",
                "patch": "@@ -3,6 +3,8 @@\n import java.io.IOException;\n import java.util.Collection;\n \n+import com.google.common.annotations.VisibleForTesting;\n+\n public interface BrooklynMementoPersister {\n \n     BrooklynMemento loadMemento() throws IOException;\n@@ -13,6 +15,9 @@\n \n     void stop();\n \n+    @VisibleForTesting\n+    void waitForWritesCompleted() throws InterruptedException;\n+\n     public interface Delta {\n         Collection<LocationMemento> locations();\n         Collection<EntityMemento> entities();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/api/src/main/java/brooklyn/mementos/BrooklynMementoPersister.java",
                "sha": "7a03c7bb90f3a75346811a536442ced29857e15d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/basic/AbstractEntity.groovy",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/AbstractEntity.groovy?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/entity/basic/AbstractEntity.groovy",
                "patch": "@@ -832,7 +832,7 @@ public abstract class AbstractEntity extends GroovyObjectSupport implements Enti\n         // TODO move this to EntityMangementSupport,\n         // when hierarchy fields can also be moved there\n         this.@owner?.invalidate();\n-        this.@application.invalidate();\n+        this.@application?.invalidate();\n         this.@ownedChildren.invalidate();\n         this.@groups.invalidate();\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/basic/AbstractEntity.groovy",
                "sha": "5af8b22da77eaac631ffc76b08058ade6d379156",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/BasicLocationRebindSupport.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/BasicLocationRebindSupport.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/entity/rebind/BasicLocationRebindSupport.java",
                "patch": "@@ -60,7 +60,7 @@ public void reconstruct(RebindContext rebindContext, LocationMemento memento) {\n             Class<?> fieldType = field.getType();\n             Object transformedValue = memento.getFlags().get(flagName);\n             Object restoredValue = MementoTransformer.transformIdsToLocations(rebindContext, transformedValue, fieldType, true);\n-            FlagUtils.setFieldsFromFlags(ImmutableMap.of(flagName, restoredValue), location);\n+            FlagUtils.setFieldFromFlag(flagName, restoredValue, location);\n         }\n \n         setParent(rebindContext, memento);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/BasicLocationRebindSupport.java",
                "sha": "fc40988d39fbcf8cd6e9b3f0f62e5a1928f2106e",
                "status": "modified"
            },
            {
                "additions": 110,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/ImmediateDeltaChangeListener.java",
                "changes": 110,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/ImmediateDeltaChangeListener.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/entity/rebind/ImmediateDeltaChangeListener.java",
                "patch": "@@ -0,0 +1,110 @@\n+package brooklyn.entity.rebind;\n+\n+import java.util.Map;\n+\n+import brooklyn.entity.Entity;\n+import brooklyn.location.Location;\n+import brooklyn.mementos.BrooklynMementoPersister;\n+import brooklyn.mementos.LocationMemento;\n+import brooklyn.policy.Policy;\n+\n+import com.google.common.collect.Maps;\n+\n+/**\n+ * Persists changes immediately. This can cause massive CPU load if entities etc are changing frequently\n+ * (for any serializing / file-based persister implementation).\n+ * \n+ * @author aled\n+ */\n+public class ImmediateDeltaChangeListener implements ChangeListener {\n+\n+    private final BrooklynMementoPersister persister;\n+    \n+    private volatile boolean running = true;\n+\n+    public ImmediateDeltaChangeListener(BrooklynMementoPersister persister) {\n+        this.persister = persister;\n+    }\n+    \n+    @Override\n+    public void onManaged(Entity entity) {\n+        if (running && persister != null) {\n+            onChanged(entity);\n+        }\n+    }\n+\n+    @Override\n+    public void onManaged(Location location) {\n+        if (running && persister != null) {\n+            onChanged(location);\n+        }\n+    }\n+    \n+    @Override\n+    public void onChanged(Entity entity) {\n+        if (running && persister != null) {\n+            PersisterDeltaImpl delta = new PersisterDeltaImpl();\n+            delta.entities.add(entity.getRebindSupport().getMemento());\n+\n+            // FIXME How to let the policy/location tell us about changes?\n+            // Don't do this every time!\n+            Map<String, LocationMemento> locations = Maps.newLinkedHashMap();\n+            for (Location location : entity.getLocations()) {\n+                if (!locations.containsKey(location.getId())) {\n+                    for (Location locationInHierarchy : TreeUtils.findLocationsInHierarchy(location)) {\n+                        locations.put(locationInHierarchy.getId(), locationInHierarchy.getRebindSupport().getMemento());\n+                    }\n+                }\n+            }\n+            delta.locations = locations.values();\n+\n+            // FIXME Not including policies, because lots of places regiser anonymous inner class policies\n+            // (e.g. AbstractController registering a AbstractMembershipTrackingPolicy)\n+            // Also, the entity constructor often re-creates the policy.\n+            // Also see MementosGenerator.newEntityMementoBuilder()\n+//            List<PolicyMemento> policies = Lists.newArrayList();\n+//            for (Policy policy : entity.getPolicies()) {\n+//                policies.add(policy.getRebindSupport().getMemento());\n+//            }\n+//            delta.policies = policies;\n+\n+            persister.delta(delta);\n+        }\n+    }\n+    \n+    @Override\n+    public void onUnmanaged(Entity entity) {\n+        if (running && persister != null) {\n+            PersisterDeltaImpl delta = new PersisterDeltaImpl();\n+            delta.removedEntityIds.add(entity.getId());\n+            persister.delta(delta);\n+        }\n+    }\n+\n+    @Override\n+    public void onUnmanaged(Location location) {\n+        if (running && persister != null) {\n+            PersisterDeltaImpl delta = new PersisterDeltaImpl();\n+            delta.removedLocationIds.add(location.getId());\n+            persister.delta(delta);\n+        }\n+    }\n+\n+    @Override\n+    public void onChanged(Location location) {\n+        if (running && persister != null) {\n+            PersisterDeltaImpl delta = new PersisterDeltaImpl();\n+            delta.locations.add(location.getRebindSupport().getMemento());\n+            persister.delta(delta);\n+        }\n+    }\n+    \n+    @Override\n+    public void onChanged(Policy policy) {\n+        if (running && persister != null) {\n+            PersisterDeltaImpl delta = new PersisterDeltaImpl();\n+            delta.policies.add(policy.getRebindSupport().getMemento());\n+            persister.delta(delta);\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/ImmediateDeltaChangeListener.java",
                "sha": "5a2d22344461a6f1487b0b2e3e0ec884aae5eb2f",
                "status": "added"
            },
            {
                "additions": 206,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/PeriodicDeltaChangeListener.java",
                "changes": 206,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/PeriodicDeltaChangeListener.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/entity/rebind/PeriodicDeltaChangeListener.java",
                "patch": "@@ -0,0 +1,206 @@\n+package brooklyn.entity.rebind;\n+\n+import java.util.Set;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import brooklyn.entity.Entity;\n+import brooklyn.location.Location;\n+import brooklyn.management.ExecutionManager;\n+import brooklyn.management.Task;\n+import brooklyn.mementos.BrooklynMementoPersister;\n+import brooklyn.policy.Policy;\n+import brooklyn.util.task.BasicTask;\n+import brooklyn.util.task.ScheduledTask;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.collect.Sets;\n+\n+/**\n+ * A \"simple\" implementation that periodically persists all entities/locations/policies that have changed\n+ * since the last periodic persistence.\n+ * \n+ * TODO A better implementation would look at a per-entity basis. When the entity was modified, then  \n+ * schedule a write for that entity in X milliseconds time (if not already scheduled). That would\n+ * prevent hammering the persister when a bunch of entity attributes change (e.g. when the entity\n+ * has just polled over JMX/http/etc). Such a scheduled-write approach would be similar to the \n+ * Nagle buffering algorithm in TCP (see tcp_nodelay).\n+ * \n+ * @author aled\n+ *\n+ */\n+public class PeriodicDeltaChangeListener implements ChangeListener {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(PeriodicDeltaChangeListener.class);\n+\n+    private static class DeltaCollector {\n+        Set<Location> locations = Sets.newLinkedHashSet();\n+        Set<Entity> entities = Sets.newLinkedHashSet();\n+        Set<Policy> policies = Sets.newLinkedHashSet();\n+        Set<String> removedLocationIds = Sets.newLinkedHashSet();\n+        Set<String> removedEntityIds = Sets.newLinkedHashSet();\n+        Set<String> removedPolicyIds = Sets.newLinkedHashSet();\n+        \n+        public boolean isEmpty() {\n+            return locations.isEmpty() && entities.isEmpty() && policies.isEmpty() && \n+                    removedEntityIds.isEmpty() && removedLocationIds.isEmpty() && removedPolicyIds.isEmpty();\n+        }\n+    }\n+    \n+    private final BrooklynMementoPersister persister;\n+\n+    private final AtomicLong writeCount = new AtomicLong();\n+    \n+    private DeltaCollector deltaCollector = new DeltaCollector();\n+\n+    private volatile boolean running = true;\n+\n+    public PeriodicDeltaChangeListener(ExecutionManager executionManager, BrooklynMementoPersister persister, long periodMillis) {\n+        this.persister = persister;\n+        \n+        Callable<Task> taskFactory = new Callable<Task>() {\n+            @Override public Task<Void> call() {\n+                return new BasicTask<Void>(new Callable<Void>() {\n+                    public Void call() {\n+                        try {\n+                            persistNow();\n+                            return null;\n+                        } catch (Throwable t) {\n+                            LOG.warn(\"Problem persisting change-delta (rethrowing)\", t);\n+                            throw Throwables.propagate(t);\n+                        }\n+                    }});\n+            }\n+        };\n+        ScheduledTask scheduledTask = new ScheduledTask(taskFactory).period(periodMillis);\n+        executionManager.submit(scheduledTask);\n+    }\n+    \n+    void stop() {\n+        running = false;\n+    }\n+    \n+    /**\n+     * This method must only be used for testing. If required in production, then revisit implementation!\n+     */\n+    @VisibleForTesting\n+    public void waitForPendingComplete() throws InterruptedException {\n+        long mods = writeCount.get();\n+        while (true) {\n+            if (!isActive()) {\n+                return; // no pending activity;\n+            } else if (writeCount.get() > mods) {\n+                return;\n+            }\n+            Thread.sleep(1);\n+        }\n+    }\n+\n+    private boolean isActive() {\n+        return running && persister != null;\n+    }\n+    \n+    private void persistNow() {\n+        if (isActive()) {\n+            // Atomically switch the delta, so subsequent modifications will be done in the\n+            // next scheduled persist\n+            DeltaCollector prevDeltaCollector;\n+            synchronized (this) {\n+                prevDeltaCollector = deltaCollector;\n+                deltaCollector = new DeltaCollector();\n+            }\n+            \n+            // Generate mementos for everything that has changed in this time period\n+            if (prevDeltaCollector.isEmpty()) {\n+                if (LOG.isTraceEnabled()) LOG.trace(\"No changes to persist since last delta\");\n+            } else {\n+                PersisterDeltaImpl persisterDelta = new PersisterDeltaImpl();\n+                for (Location location : prevDeltaCollector.locations) {\n+                    persisterDelta.locations.add(location.getRebindSupport().getMemento());\n+                }\n+                for (Entity entity : prevDeltaCollector.entities) {\n+                    persisterDelta.entities.add(entity.getRebindSupport().getMemento());\n+                }\n+                for (Policy policy : prevDeltaCollector.policies) {\n+                    persisterDelta.policies.add(policy.getRebindSupport().getMemento());\n+                }\n+                persisterDelta.removedLocationIds = prevDeltaCollector.removedLocationIds;\n+                persisterDelta.removedEntityIds = prevDeltaCollector.removedEntityIds;\n+                persisterDelta.removedPolicyIds = prevDeltaCollector.removedPolicyIds;\n+                \n+                // Tell the persister to persist it\n+                persister.delta(persisterDelta);\n+            }\n+            \n+            writeCount.incrementAndGet();\n+        }\n+    }\n+    \n+    @Override\n+    public synchronized void onManaged(Entity entity) {\n+        if (isActive()) {\n+            onChanged(entity);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void onManaged(Location location) {\n+        if (isActive()) {\n+            onChanged(location);\n+        }\n+    }\n+    \n+    @Override\n+    public synchronized void onChanged(Entity entity) {\n+        if (isActive()) {\n+            deltaCollector.entities.add(entity);\n+\n+            // FIXME How to let the policy/location tell us about changes? Don't do this every time!\n+            for (Location location : entity.getLocations()) {\n+                deltaCollector.locations.addAll(TreeUtils.findLocationsInHierarchy(location));\n+            }\n+\n+            // FIXME Not including policies, because lots of places regiser anonymous inner class policies\n+            // (e.g. AbstractController registering a AbstractMembershipTrackingPolicy)\n+            // Also, the entity constructor often re-creates the policy.\n+            // Also see MementosGenerator.newEntityMementoBuilder()\n+//            for (Policy policy : entity.getPolicies()) {\n+//                delta.policies.add(policy);\n+//            }\n+        }\n+    }\n+    \n+    @Override\n+    public synchronized void onUnmanaged(Entity entity) {\n+        if (isActive()) {\n+            deltaCollector.removedEntityIds.add(entity.getId());\n+            deltaCollector.entities.remove(entity);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void onUnmanaged(Location location) {\n+        if (isActive()) {\n+            deltaCollector.removedLocationIds.add(location.getId());\n+            deltaCollector.locations.remove(location);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void onChanged(Location location) {\n+        if (isActive()) {\n+            deltaCollector.locations.add(location);\n+        }\n+    }\n+    \n+    @Override\n+    public synchronized void onChanged(Policy policy) {\n+        if (isActive()) {\n+            deltaCollector.policies.add(policy);\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/PeriodicDeltaChangeListener.java",
                "sha": "8a87d769e96c4f3d516aced102487c3b7590ea0b",
                "status": "added"
            },
            {
                "additions": 49,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/PersisterDeltaImpl.java",
                "changes": 49,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/PersisterDeltaImpl.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/entity/rebind/PersisterDeltaImpl.java",
                "patch": "@@ -0,0 +1,49 @@\n+package brooklyn.entity.rebind;\n+\n+import java.util.Collection;\n+\n+import brooklyn.mementos.BrooklynMementoPersister.Delta;\n+import brooklyn.mementos.EntityMemento;\n+import brooklyn.mementos.LocationMemento;\n+import brooklyn.mementos.PolicyMemento;\n+\n+import com.google.common.collect.Sets;\n+\n+class PersisterDeltaImpl implements Delta {\n+    Collection<LocationMemento> locations = Sets.newLinkedHashSet();\n+    Collection<EntityMemento> entities = Sets.newLinkedHashSet();\n+    Collection<PolicyMemento> policies = Sets.newLinkedHashSet();\n+    Collection <String> removedLocationIds = Sets.newLinkedHashSet();\n+    Collection <String> removedEntityIds = Sets.newLinkedHashSet();\n+    Collection <String> removedPolicyIds = Sets.newLinkedHashSet();\n+    \n+    @Override\n+    public Collection<LocationMemento> locations() {\n+        return locations;\n+    }\n+\n+    @Override\n+    public Collection<EntityMemento> entities() {\n+        return entities;\n+    }\n+\n+    @Override\n+    public Collection<PolicyMemento> policies() {\n+        return policies;\n+    }\n+\n+    @Override\n+    public Collection<String> removedLocationIds() {\n+        return removedLocationIds;\n+    }\n+\n+    @Override\n+    public Collection<String> removedEntityIds() {\n+        return removedEntityIds;\n+    }\n+    \n+    @Override\n+    public Collection<String> removedPolicyIds() {\n+        return removedPolicyIds;\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/PersisterDeltaImpl.java",
                "sha": "b3a3d7fcf0a8f2aa786b4d48b3452025e3dca225",
                "status": "added"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/RebindManagerImpl.java",
                "changes": 130,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/RebindManagerImpl.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 95,
                "filename": "core/src/main/java/brooklyn/entity/rebind/RebindManagerImpl.java",
                "patch": "@@ -26,33 +26,53 @@\n import brooklyn.util.MutableMap;\n import brooklyn.util.javalang.Reflections;\n \n-import com.google.common.collect.ImmutableList;\n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.Lists;\n import com.google.common.collect.Maps;\n \n public class RebindManagerImpl implements RebindManager {\n \n+    // TODO Use ImmediateDeltaChangeListener if the period is set to 0?\n+    // But for MultiFile persister, that is still async\n+    \n     public static final Logger LOG = LoggerFactory.getLogger(RebindManagerImpl.class);\n \n+    // FIXME Make configurable\n+    private volatile long periodicPersistPeriod = 1000;\n+    \n+    private volatile boolean running = true;\n+    \n     private final ManagementContext managementContext;\n \n-    private final ChangeListener changeListener;\n+    private volatile PeriodicDeltaChangeListener realChangeListener;\n+    private volatile ChangeListener changeListener;\n     \n     private volatile BrooklynMementoPersister persister;\n \n-    private volatile boolean running = true;\n-    \n     public RebindManagerImpl(ManagementContext managementContext) {\n         this.managementContext = managementContext;\n-        this.changeListener = new SafeChangeListener(new PersistingChangeListener());\n+        this.changeListener = ChangeListener.NOOP;\n     }\n-    \n+\n+    /**\n+     * Must be called before setPerister()\n+     */\n+    @VisibleForTesting\n+    public void setPeriodicPersistPeriod(long periodMillis) {\n+        this.periodicPersistPeriod = periodMillis;\n+    }\n+\n     @Override\n     public void setPersister(BrooklynMementoPersister val) {\n         if (persister != null && persister != val) {\n             throw new IllegalStateException(\"Dynamically changing persister is not supported: old=\"+persister+\"; new=\"+val);\n         }\n         this.persister = checkNotNull(val, \"persister\");\n+        \n+        if (running) {\n+            this.realChangeListener = new PeriodicDeltaChangeListener(managementContext.getExecutionManager(), persister, periodicPersistPeriod);\n+            this.changeListener = new SafeChangeListener(realChangeListener);\n+        }\n     }\n \n     @Override\n@@ -63,7 +83,15 @@ public BrooklynMementoPersister getPersister() {\n     @Override\n     public void stop() {\n         running = false;\n-        persister.stop();\n+        if (realChangeListener != null) realChangeListener.stop();\n+        if (persister != null) persister.stop();\n+    }\n+    \n+    @Override\n+    @VisibleForTesting\n+    public void waitForPendingComplete() throws InterruptedException {\n+        realChangeListener.waitForPendingComplete();\n+        if (persister != null) persister.waitForWritesCompleted();\n     }\n     \n     @Override\n@@ -259,94 +287,6 @@ private Policy newPolicy(PolicyMemento memento, Reflections reflections) {\n         }\n     }\n     \n-    private class PersistingChangeListener implements ChangeListener {\n-\n-        @Override\n-        public void onManaged(Entity entity) {\n-            if (running && persister != null) {\n-                // TODO Currently, we get an onManaged call for every entity (rather than just the root of a sub-tree)\n-                // Also, we'll be told about an entity before its children are officially managed.\n-                // So it's really the same as \"changed\".\n-                onChanged(entity);\n-            }\n-        }\n-\n-        @Override\n-        public void onManaged(Location location) {\n-            if (running && persister != null) {\n-                onChanged(location);\n-            }\n-        }\n-        \n-        @Override\n-        public void onChanged(Entity entity) {\n-            if (running && persister != null) {\n-                DeltaImpl delta = new DeltaImpl();\n-                delta.entities = ImmutableList.of(entity.getRebindSupport().getMemento());\n-\n-                // FIXME How to let the policy/location tell us about changes?\n-                // Don't do this every time!\n-                Map<String, LocationMemento> locations = Maps.newLinkedHashMap();\n-                for (Location location : entity.getLocations()) {\n-                    if (!locations.containsKey(location.getId())) {\n-                        for (Location locationInHierarchy : TreeUtils.findLocationsInHierarchy(location)) {\n-                            locations.put(locationInHierarchy.getId(), locationInHierarchy.getRebindSupport().getMemento());\n-                        }\n-                    }\n-                }\n-                delta.locations = locations.values();\n-\n-                // FIXME Not including policies, because lots of places regiser anonymous inner class policies\n-                // (e.g. AbstractController registering a AbstractMembershipTrackingPolicy)\n-                // Also, the entity constructor often re-creates the policy.\n-                // Also see MementosGenerator.newEntityMementoBuilder()\n-//                List<PolicyMemento> policies = Lists.newArrayList();\n-//                for (Policy policy : entity.getPolicies()) {\n-//                    policies.add(policy.getRebindSupport().getMemento());\n-//                }\n-//                delta.policies = policies;\n-\n-                persister.delta(delta);\n-            }\n-        }\n-        \n-        @Override\n-        public void onUnmanaged(Entity entity) {\n-            if (running && persister != null) {\n-                DeltaImpl delta = new DeltaImpl();\n-                delta.removedEntityIds = ImmutableList.of(entity.getId());\n-                persister.delta(delta);\n-            }\n-        }\n-\n-        @Override\n-        public void onUnmanaged(Location location) {\n-            if (running && persister != null) {\n-                DeltaImpl delta = new DeltaImpl();\n-                delta.removedLocationIds = ImmutableList.of(location.getId());\n-                persister.delta(delta);\n-            }\n-        }\n-\n-        @Override\n-        public void onChanged(Location location) {\n-            if (running && persister != null) {\n-                DeltaImpl delta = new DeltaImpl();\n-                delta.locations = ImmutableList.of(location.getRebindSupport().getMemento());\n-                persister.delta(delta);\n-            }\n-        }\n-        \n-        @Override\n-        public void onChanged(Policy policy) {\n-            if (running && persister != null) {\n-                DeltaImpl delta = new DeltaImpl();\n-                delta.policies = ImmutableList.of(policy.getRebindSupport().getMemento());\n-                persister.delta(delta);\n-            }\n-        }\n-    }\n-    \n     /**\n      * Wraps a ChangeListener, to log and never propagate any exceptions that it throws.\n      * ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/RebindManagerImpl.java",
                "sha": "fa7be8b8dfa662844fbf4b55beea262104c2f231",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterInMemory.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterInMemory.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterInMemory.java",
                "patch": "@@ -7,26 +7,41 @@\n import brooklyn.mementos.BrooklynMemento;\n import brooklyn.util.Serializers;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Throwables;\n \n public class BrooklynMementoPersisterInMemory extends AbstractBrooklynMementoPersister {\n \n     private final ClassLoader classLoader;\n+    private final boolean checkPersistable;\n     \n-    BrooklynMementoPersisterInMemory(ClassLoader classLoader) {\n+    public BrooklynMementoPersisterInMemory(ClassLoader classLoader) {\n+        this(classLoader, true);\n+    }\n+    \n+    public BrooklynMementoPersisterInMemory(ClassLoader classLoader, boolean checkPersistable) {\n         this.classLoader = checkNotNull(classLoader, \"classLoader\");\n+        this.checkPersistable = checkPersistable;\n     }\n     \n+    @VisibleForTesting\n+    @Override\n+    public void waitForWritesCompleted() throws InterruptedException {\n+        // TODO Could wait for concurrent checkpoint/delta, but don't need to for tests\n+        // because first waits for checkpoint/delta to have been called by RebindManagerImpl.\n+        return;\n+    }\n+\n     @Override\n     public void checkpoint(BrooklynMemento newMemento) {\n         super.checkpoint(newMemento);\n-        reserializeMemento();\n+        if (checkPersistable) reserializeMemento();\n     }\n \n     @Override\n     public void delta(Delta delta) {\n         super.delta(delta);\n-        reserializeMemento();\n+        if (checkPersistable) reserializeMemento();\n     }\n     \n     private void reserializeMemento() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterInMemory.java",
                "sha": "be167cff9a2ea68cd55f0f690bcb18b05a3d65a5",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToFile.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToFile.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToFile.java",
                "patch": "@@ -21,6 +21,7 @@\n import brooklyn.event.basic.BasicConfigKey;\n import brooklyn.mementos.BrooklynMemento;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Charsets;\n import com.google.common.base.Joiner;\n import com.google.common.base.Stopwatch;\n@@ -49,6 +50,14 @@ public BrooklynMementoPersisterToFile(File file, ClassLoader classLoader) {\n //        this.serializer = new JsonMementoSerializer(classLoader);\n     }\n     \n+    @VisibleForTesting\n+    @Override\n+    public void waitForWritesCompleted() throws InterruptedException {\n+        // TODO Could wait for concurrent checkpoint/delta, but don't need to for tests\n+        // because first waits for checkpoint/delta to have been called by RebindManagerImpl.\n+        return;\n+    }\n+\n     @Override\n     public BrooklynMemento loadMemento() {\n         try {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToFile.java",
                "sha": "fb2e20310439294242e202cb3c4282a0c5130d47",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToMultiFile.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToMultiFile.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToMultiFile.java",
                "patch": "@@ -20,6 +20,7 @@\n import brooklyn.mementos.LocationMemento;\n import brooklyn.mementos.PolicyMemento;\n \n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Charsets;\n import com.google.common.base.Joiner;\n import com.google.common.io.Files;\n@@ -139,8 +140,8 @@ public void delta(Delta delta) {\n         }\n         if (LOG.isDebugEnabled()) LOG.debug(\"Checkpointed delta of memento; updating {} entities, {} locations and {} policies; \" +\n         \t\t\"removing {} entities, {} locations and {} policies\", \n-                new Object[] {delta.entities().size(), delta.locations().size(), delta.policies().size(),\n-                delta.removedEntityIds().size(), delta.removedLocationIds().size(), delta.removedPolicyIds().size()});\n+                new Object[] {delta.entities(), delta.locations(), delta.policies(),\n+                delta.removedEntityIds(), delta.removedLocationIds(), delta.removedPolicyIds()});\n         \n         for (EntityMemento entity : delta.entities()) {\n             persist(entity);\n@@ -161,7 +162,9 @@ public void delta(Delta delta) {\n             deletePolicy(id);\n         }\n     }\n-    \n+\n+    @Override\n+    @VisibleForTesting\n     public void waitForWritesCompleted() throws InterruptedException {\n         for (MementoFileWriter<?> writer : entityWriters.values()) {\n             writer.waitForWriteCompleted();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/BrooklynMementoPersisterToMultiFile.java",
                "sha": "c98e913f1dada648f848c7cd09a4095fb82f3c66",
                "status": "modified"
            },
            {
                "additions": 37,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/MementoFileWriter.java",
                "changes": 58,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/persister/MementoFileWriter.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 21,
                "filename": "core/src/main/java/brooklyn/entity/rebind/persister/MementoFileWriter.java",
                "patch": "@@ -14,6 +14,7 @@\n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Charsets;\n import com.google.common.base.Stopwatch;\n+import com.google.common.base.Throwables;\n import com.google.common.io.Files;\n import com.google.common.util.concurrent.ListenableFuture;\n import com.google.common.util.concurrent.ListeningExecutorService;\n@@ -103,18 +104,28 @@ public void waitForWriteCompleted() throws InterruptedException {\n     private void deleteAsync() {\n         ListenableFuture<Void> future = executor.submit(new Callable<Void>() {\n             @Override public Void call() throws IOException {\n-                deleteNow();\n-                return null;\n+                try {\n+                    deleteNow();\n+                    return null;\n+                } catch (Throwable t) {\n+                    LOG.error(\"Error deleting \"+file, t);\n+                    throw Throwables.propagate(t);\n+                }\n             }});\n         addPostExecListener(future);\n     }\n     \n     private void writeAsync() {\n         ListenableFuture<Void> future = executor.submit(new Callable<Void>() {\n             @Override public Void call() throws IOException {\n-                writeNow();\n-                return null;\n-            }});\n+                try {\n+                    writeNow();\n+                    return null;\n+                } catch (Throwable t) {\n+                    LOG.error(\"Error writing to \"+file, t);\n+                    throw Throwables.propagate(t);\n+                }\n+             }});\n         addPostExecListener(future);\n     }\n     \n@@ -123,24 +134,29 @@ private void addPostExecListener(ListenableFuture<?> future) {\n                 new Runnable() {\n                     @Override public void run() {\n                         if (LOG.isTraceEnabled()) LOG.trace(\"Write complete for {}\", file);\n-                        executing.set(false);\n-                        if (requireDelete.get()) {\n-                            if (executing.compareAndSet(false, true)) {\n-                                if (LOG.isTraceEnabled()) LOG.trace(\"Submitting delete-task for {} (in post-exec) due to recorded delete-requirement\", file);\n-                                deleteAsync();\n-                            } else {\n-                                if (LOG.isTraceEnabled()) LOG.trace(\"Delete-requirement for {} (in post-exec) handled by other thread; returning\", file);\n-                            }\n-                            \n-                        } else if (requireWrite.get() != null) {\n-                            if (executing.compareAndSet(false, true)) {\n-                                if (LOG.isTraceEnabled()) LOG.trace(\"Submitting write task for {} (in post-exec) due to recorded write-requirement\", file);\n-                                writeAsync();\n+                        try {\n+                            executing.set(false);\n+                            if (requireDelete.get()) {\n+                                if (executing.compareAndSet(false, true)) {\n+                                    if (LOG.isTraceEnabled()) LOG.trace(\"Submitting delete-task for {} (in post-exec) due to recorded delete-requirement\", file);\n+                                    deleteAsync();\n+                                } else {\n+                                    if (LOG.isTraceEnabled()) LOG.trace(\"Delete-requirement for {} (in post-exec) handled by other thread; returning\", file);\n+                                }\n+                                \n+                            } else if (requireWrite.get() != null) {\n+                                if (executing.compareAndSet(false, true)) {\n+                                    if (LOG.isTraceEnabled()) LOG.trace(\"Submitting write task for {} (in post-exec) due to recorded write-requirement\", file);\n+                                    writeAsync();\n+                                } else {\n+                                    if (LOG.isTraceEnabled()) LOG.trace(\"Write-requirement for {} (in post-exec) handled by other thread; returning\", file);\n+                                }\n                             } else {\n-                                if (LOG.isTraceEnabled()) LOG.trace(\"Write-requirement for {} (in post-exec) handled by other thread; returning\", file);\n+                                if (LOG.isTraceEnabled()) LOG.trace(\"No pending exec-requirements for {}\", file);\n                             }\n-                        } else {\n-                            if (LOG.isTraceEnabled()) LOG.trace(\"No pending exec-requirements for {}\", file);\n+                        } catch (Throwable t) {\n+                            LOG.error(\"Error in post-exec for \"+file, t);\n+                            throw Throwables.propagate(t);\n                         }\n                     }\n                 }, ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/MementoFileWriter.java",
                "sha": "326d6c403349234279bd2869baa4ea99e1ce0147",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/RetryingMementoSerializer.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/persister/RetryingMementoSerializer.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/entity/rebind/persister/RetryingMementoSerializer.java",
                "patch": "@@ -26,7 +26,8 @@ public String toString(T memento) {\n             try {\n                 return delegate.toString(memento);\n             } catch (RuntimeException e) {\n-                LOG.warn(\"Error serializing memento (attempt \"+attempt+\" of \"+maxAttempts+\") for \"+memento, e);\n+                LOG.warn(\"Error serializing memento (attempt \"+attempt+\" of \"+maxAttempts+\") for \"+memento+\n+                        \"; expected sometimes if attribute value modified\", e);\n                 lastException = e;\n             }\n         } while (attempt < maxAttempts);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/entity/rebind/persister/RetryingMementoSerializer.java",
                "sha": "7cddd80772d88ac8d3bafc2bdd377e823d1152c0",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/management/internal/EntityManagementSupport.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/EntityManagementSupport.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 2,
                "filename": "core/src/main/java/brooklyn/management/internal/EntityManagementSupport.java",
                "patch": "@@ -77,6 +77,8 @@ public void onManagementStarting(ManagementTransitionInfo info) {\n             nonDeploymentManagementContext.getSubscriptionManager().startDelegatingForSubscribing();\n \n             managementContextUsable = true;\n+            currentlyDeployed = true;\n+            everDeployed = true;\n             \n             entityChangeListener = new EntityChangeListener() {\n                 @Override\n@@ -147,8 +149,6 @@ public void onManagementStarted(ManagementTransitionInfo info) {\n         \n         synchronized (this) {\n             nonDeploymentManagementContext = null;\n-            currentlyDeployed = true;\n-            everDeployed = true;\n         }\n     }\n     ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/management/internal/EntityManagementSupport.java",
                "sha": "20e0ca1ca9a9001d96e0e8fad3b4f9a2b5644532",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/util/flags/FlagUtils.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/flags/FlagUtils.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/util/flags/FlagUtils.java",
                "patch": "@@ -1,5 +1,7 @@\n package brooklyn.util.flags;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n import static brooklyn.util.GroovyJavaMethods.elvis;\n import static brooklyn.util.GroovyJavaMethods.truth;\n import groovy.lang.Closure;\n@@ -52,6 +54,17 @@ private FlagUtils() {}\n         return setFieldsFromFlagsInternal(flags, o, getAllFields(o.getClass()));\n     }\n \t\n+    /**\n+     * Sets the field with the given flag (if it exists) to the given value.\n+     * Will attempt to coerce the value to the required type.\n+     * Will respect \"nullable\" on the SetFromFlag annotation.\n+     * \n+     * @throws IllegalArgumentException If fieldVal is null and the SetFromFlag annotation set nullable=false\n+     */\n+    public static void setFieldFromFlag(String flagName, Object fieldVal, Object o) {\n+        setFieldFromFlagInternal(checkNotNull(flagName, \"flagName\"), fieldVal, o, getAllFields(o.getClass()));\n+    }\n+    \n     /** get all fields (including private and static) on the given object and all supertypes, \n      * that are annotated with SetFromFlags. \n      */\n@@ -165,6 +178,16 @@ private static Field findFieldForFlagInternal(String flagName, Object o, Collect\n         throw new NoSuchElementException(\"Field with flag \"+flagName+\" not found on \"+o+\" of type \"+(o != null ? o.getClass() : null));\n     }\n \n+    private static void setFieldFromFlagInternal(String flagName, Object fieldVal, Object o, Collection<Field> fields) {\n+        for (Field f: fields) {\n+            SetFromFlag cf = f.getAnnotation(SetFromFlag.class);\n+            if (cf != null && flagName.equals(elvis(cf.value(), f.getName()))) {\n+                setField(o, f, fieldVal, cf);\n+                break;\n+            }\n+        }\n+    }\n+\n     private static Map<String, ? extends Object> setFieldsFromFlagsInternal(Map<String,? extends Object> flags, Object o, Collection<Field> fields) {\n         Map<String, Object> remaining = Maps.newLinkedHashMap();\n \t\tif (truth(flags)) remaining.putAll(flags);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/util/flags/FlagUtils.java",
                "sha": "4c7ded3ff3993ce68762f085d36b45336321259d",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/util/task/ScheduledTask.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/task/ScheduledTask.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/util/task/ScheduledTask.java",
                "patch": "@@ -14,14 +14,19 @@\n import brooklyn.management.Task;\n import brooklyn.util.JavaGroovyEquivalents;\n import brooklyn.util.MutableMap;\n+import brooklyn.util.internal.TimeExtras;\n \n import com.google.common.base.Throwables;\n \n public class ScheduledTask extends BasicTask {\n \n-    // TODO See BasicExecutionManager.submitNewScheduledTask for where these fields are actually set.\n-    // Would be nice if the scheduledTask was more self-contained, rather than its fields being\n-    // modified by a different class in a non-obvious way...\n+    // TODO It looks like now groovy callers construct ScheduledTask with these values in the map constructor.\n+    // How does that work in pure-java!?\n+    // Adding builder-like-setters so can be used in Java. But would be much nicer if this was immutable.\n+    // Previous (out-of-date?) todo was:\n+    //     See BasicExecutionManager.submitNewScheduledTask for where these fields are actually set.\n+    //     Would be nice if the scheduledTask was more self-contained, rather than its fields being\n+    //     modified by a different class in a non-obvious way...\n     \n \tfinal Callable<Task> taskFactory;\n \t/** initial delay before running, set as flag in constructor; defaults to 0 */\n@@ -50,6 +55,21 @@ public ScheduledTask(Map flags, Callable<Task> taskFactory) {\n \t\tperiod = JavaGroovyEquivalents.toTimeDuration(elvis(flags.remove(\"period\"), null));\n \t\tmaxIterations = elvis(flags.remove(\"maxIterations\"), null);\n \t}\n+\t\n+\tpublic ScheduledTask delay(long val) {\n+\t    this.delay = JavaGroovyEquivalents.toTimeDuration(val);\n+\t    return this;\n+\t}\n+\n+\tpublic ScheduledTask period(long val) {\n+        this.period = JavaGroovyEquivalents.toTimeDuration(val);\n+        return this;\n+\t}\n+\n+    public ScheduledTask maxIterations(int val) {\n+        this.maxIterations = val;\n+        return this;\n+    }\n \n     public Callable<Task> getTaskFactory() {\n         return taskFactory;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/main/java/brooklyn/util/task/ScheduledTask.java",
                "sha": "08d66f19075deef5d7660d513a4d07d4ada32519",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/CheckpointEntityTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/rebind/CheckpointEntityTest.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 1,
                "filename": "core/src/test/java/brooklyn/entity/rebind/CheckpointEntityTest.java",
                "patch": "@@ -39,7 +39,7 @@\n     @BeforeMethod\n     public void setUp() throws Exception {\n         mementoDir = Files.createTempDir();\n-        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader);\n+        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader, 1);\n         origApp = new MyApplication();\n         origE = new MyEntity(MutableMap.of(\"myconfig\", \"myval\"), origApp);\n         managementContext.manage(origApp);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/CheckpointEntityTest.java",
                "sha": "de6a4d233b75428edc90fe52932f509df4fbda2f",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindDynamicGroupTest.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/rebind/RebindDynamicGroupTest.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 2,
                "filename": "core/src/test/java/brooklyn/entity/rebind/RebindDynamicGroupTest.java",
                "patch": "@@ -32,7 +32,7 @@\n     @BeforeMethod\n     public void setUp() throws Exception {\n         mementoDir = Files.createTempDir();\n-        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader);\n+        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader, 1);\n         origApp = new TestApplication();\n     }\n \n@@ -47,7 +47,7 @@ public void testRestoresDynamicGroup() throws Exception {\n         DynamicGroup origG = new DynamicGroup(origApp, Predicates.instanceOf(MyEntity.class));\n         managementContext.manage(origApp);\n         \n-        TestApplication newApp = (TestApplication) RebindTestUtils.rebind(mementoDir, getClass().getClassLoader());\n+        TestApplication newApp = rebind();\n         ManagementContext newManagementContext = newApp.getManagementSupport().getManagementContext(false);\n         final DynamicGroup newG = (DynamicGroup) Iterables.find(newApp.getOwnedChildren(), Predicates.instanceOf(DynamicGroup.class));\n         final MyEntity newE = (MyEntity) Iterables.find(newApp.getOwnedChildren(), Predicates.instanceOf(MyEntity.class));\n@@ -69,4 +69,9 @@ private void assertGroupMemebers(DynamicGroup group, Collection<? extends Entity\n         assertEquals(Sets.newHashSet(group.getMembers()), ImmutableSet.copyOf(expected));\n         assertEquals(group.getMembers().size(), expected.size(), \"members=\"+group.getMembers());\n     }\n+    \n+    private TestApplication rebind() throws Exception {\n+        RebindTestUtils.waitForPersisted(origApp);\n+        return (TestApplication) RebindTestUtils.rebind(mementoDir, getClass().getClassLoader());\n+    }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindDynamicGroupTest.java",
                "sha": "eaa4f227e1addb76ef5765ccaa942c5f1d83f0f4",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindEntityTest.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/rebind/RebindEntityTest.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 3,
                "filename": "core/src/test/java/brooklyn/entity/rebind/RebindEntityTest.java",
                "patch": "@@ -29,7 +29,7 @@\n import brooklyn.event.basic.BasicAttributeSensor;\n import brooklyn.event.basic.BasicConfigKey;\n import brooklyn.location.Location;\n-import brooklyn.management.ManagementContext;\n+import brooklyn.management.internal.LocalManagementContext;\n import brooklyn.mementos.EntityMemento;\n import brooklyn.test.TestUtils;\n import brooklyn.test.entity.TestEntity;\n@@ -49,19 +49,20 @@\n     // FIXME Add test about dependent configuration serialization?!\n     \n     private ClassLoader classLoader = getClass().getClassLoader();\n-    private ManagementContext managementContext;\n+    private LocalManagementContext managementContext;\n     private MyApplication origApp;\n     private File mementoDir;\n     \n     @BeforeMethod\n     public void setUp() throws Exception {\n         mementoDir = Files.createTempDir();\n-        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader);\n+        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader, 1);\n         origApp = new MyApplication();\n     }\n \n     @AfterMethod\n     public void tearDown() throws Exception {\n+        managementContext.terminate();\n         if (mementoDir != null) RebindTestUtils.deleteMementoDir(mementoDir);\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindEntityTest.java",
                "sha": "a6c7e0c8bc910038285d8e38829b50614451e3da",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindLocationTest.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/rebind/RebindLocationTest.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 2,
                "filename": "core/src/test/java/brooklyn/entity/rebind/RebindLocationTest.java",
                "patch": "@@ -6,6 +6,7 @@\n import java.io.File;\n import java.util.List;\n import java.util.Map;\n+import java.util.concurrent.atomic.AtomicLong;\n \n import org.testng.annotations.AfterMethod;\n import org.testng.annotations.BeforeMethod;\n@@ -37,7 +38,7 @@\n     @BeforeMethod\n     public void setUp() throws Exception {\n         mementoDir = Files.createTempDir();\n-        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader);\n+        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader, 1);\n         origApp = new MyApplication();\n         origE = new MyEntity(origApp);\n         managementContext.manage(origApp);\n@@ -100,6 +101,21 @@ public void testRestoresFieldsWithSetFromFlag() throws Exception {\n         assertEquals(newLoc.myfield, \"myval\");\n     }\n     \n+    @Test\n+    public void testRestoresAtomicLongWithSetFromFlag() throws Exception {\n+        MyLocation origLoc = new MyLocation(MutableMap.of(\"myAtomicLong\", \"123\"));\n+        origApp.start(ImmutableList.of(origLoc));\n+\n+        origLoc.myAtomicLong.incrementAndGet();\n+        assertEquals(origLoc.myAtomicLong.get(), 124L);\n+        origApp.getManagementSupport().getManagementContext(false).getRebindManager().getChangeListener().onChanged(origLoc);\n+        \n+        MyApplication newApp = (MyApplication) rebind();\n+        MyLocation newLoc = (MyLocation) Iterables.get(newApp.getLocations(), 0);\n+        \n+        assertEquals(newLoc.myAtomicLong.get(), 124L);\n+    }\n+    \n     @Test\n     public void testIgnoresTransientFields() throws Exception {\n     \tMyLocation origLoc = new MyLocation(MutableMap.of(\"myTransientField\", \"myval\"));\n@@ -127,7 +143,7 @@ public void testIgnoresStaticFields() throws Exception {\n     @Test\n     public void testHandlesFieldReferencingOtherLocations() throws Exception {\n     \tMyLocation origOtherLoc = new MyLocation();\n-    \tMyLocationReffingOthers origLoc = new MyLocationReffingOthers(MutableMap.of(\"otherLocs\", ImmutableList.of(origOtherLoc)));\n+    \tMyLocationReffingOthers origLoc = new MyLocationReffingOthers(MutableMap.of(\"otherLocs\", ImmutableList.of(origOtherLoc), \"myfield\", \"myval\"));\n     \torigOtherLoc.setParentLocation(origLoc);\n     \t\n         origApp.start(ImmutableList.of(origLoc));\n@@ -138,6 +154,9 @@ public void testHandlesFieldReferencingOtherLocations() throws Exception {\n         assertEquals(newLoc.getChildLocations().size(), 1);\n         assertTrue(Iterables.get(newLoc.getChildLocations(), 0) instanceof MyLocation, \"children=\"+newLoc.getChildLocations());\n         assertEquals(newLoc.otherLocs, ImmutableList.copyOf(newLoc.getChildLocations()));\n+        \n+        // Confirm this didn't override other values (e.g. setting other fields back to their defaults, as was once the case!)\n+        assertEquals(newLoc.myfield, \"myval\");\n     }\n \n     private MyApplication rebind() throws Exception {\n@@ -151,6 +170,9 @@ private MyApplication rebind() throws Exception {\n         @SetFromFlag\n         String myfield;\n \n+        @SetFromFlag(defaultVal=\"1\")\n+        AtomicLong myAtomicLong;\n+\n         private final Object dummy = new Object(); // so not serializable\n         \n         @SetFromFlag\n@@ -170,6 +192,9 @@ public MyLocation(Map flags) {\n     public static class MyLocationReffingOthers extends AbstractLocation {\n         private static final long serialVersionUID = 1L;\n         \n+        @SetFromFlag(defaultVal=\"a\")\n+        String myfield;\n+\n         @SetFromFlag\n         List<Location> otherLocs;\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindLocationTest.java",
                "sha": "abd4a5301c049fc9bd3213817aab18885bda5695",
                "status": "modified"
            },
            {
                "additions": 59,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindSshMachineLocationTest.java",
                "changes": 59,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/rebind/RebindSshMachineLocationTest.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "core/src/test/java/brooklyn/entity/rebind/RebindSshMachineLocationTest.java",
                "patch": "@@ -0,0 +1,59 @@\n+package brooklyn.entity.rebind;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import java.io.File;\n+import java.util.Collections;\n+\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import brooklyn.entity.rebind.RebindEntityTest.MyApplication;\n+import brooklyn.location.basic.SshMachineLocation;\n+import brooklyn.management.ManagementContext;\n+import brooklyn.util.MutableMap;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import com.google.common.io.Files;\n+\n+public class RebindSshMachineLocationTest {\n+\n+    private ClassLoader classLoader = getClass().getClassLoader();\n+    private ManagementContext managementContext;\n+    private MyApplication origApp;\n+    private SshMachineLocation origLoc;\n+    private File mementoDir;\n+    \n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+        mementoDir = Files.createTempDir();\n+        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader, 1);\n+        origApp = new MyApplication();\n+        origLoc = new SshMachineLocation(MutableMap.of(\"address\", \"localhost\"));\n+        managementContext.manage(origApp);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+        if (mementoDir != null) RebindTestUtils.deleteMementoDir(mementoDir);\n+    }\n+    \n+    @Test\n+    public void testMachineUsableAfterRebind() throws Exception {\n+        origApp.start(ImmutableList.of(origLoc));\n+\n+        assertEquals(origLoc.execScript(Collections.<String,Object>emptyMap(), \"mysummary\", ImmutableList.of(\"true\")), 0);\n+\n+        MyApplication newApp = (MyApplication) rebind();\n+        SshMachineLocation newLoc = (SshMachineLocation) Iterables.getOnlyElement(newApp.getLocations(), 0);\n+        \n+        assertEquals(newLoc.execScript(Collections.<String,Object>emptyMap(), \"mysummary\", ImmutableList.of(\"true\")), 0);\n+    }\n+    \n+    private MyApplication rebind() throws Exception {\n+        RebindTestUtils.waitForPersisted(origApp);\n+        return (MyApplication) RebindTestUtils.rebind(mementoDir, getClass().getClassLoader());\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindSshMachineLocationTest.java",
                "sha": "39c818387736dbcf5f928ecc188a27e290e2e345",
                "status": "added"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindTestUtils.java",
                "changes": 29,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/rebind/RebindTestUtils.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 16,
                "filename": "core/src/test/java/brooklyn/entity/rebind/RebindTestUtils.java",
                "patch": "@@ -1,5 +1,7 @@\n package brooklyn.entity.rebind;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+\n import java.io.File;\n import java.util.List;\n \n@@ -8,7 +10,6 @@\n \n import brooklyn.entity.Application;\n import brooklyn.entity.rebind.dto.MementosGenerators;\n-import brooklyn.entity.rebind.persister.BrooklynMementoPersisterInMemory;\n import brooklyn.entity.rebind.persister.BrooklynMementoPersisterToMultiFile;\n import brooklyn.management.internal.LocalManagementContext;\n import brooklyn.mementos.BrooklynMemento;\n@@ -62,13 +63,22 @@ public static void checkMementoSerializable(Application app) throws Exception {\n         BrooklynMemento memento = MementosGenerators.newBrooklynMemento(app.getManagementContext());\n         serializeAndDeserialize(memento);\n     }\n-    \n+\n     public static LocalManagementContext newPersistingManagementContext(File mementoDir, ClassLoader classLoader) {\n         LocalManagementContext result = new LocalManagementContext();\n         BrooklynMementoPersisterToMultiFile newPersister = new BrooklynMementoPersisterToMultiFile(mementoDir, classLoader);\n         result.getRebindManager().setPersister(newPersister);\n         return result;\n     }\n+    \n+    public static LocalManagementContext newPersistingManagementContext(File mementoDir, ClassLoader classLoader, long persistPeriodMillis) {\n+        checkArgument(persistPeriodMillis > 0, \"persistPeriodMillis must be greater than 0; was \"+persistPeriodMillis);\n+        LocalManagementContext result = new LocalManagementContext();\n+        BrooklynMementoPersisterToMultiFile newPersister = new BrooklynMementoPersisterToMultiFile(mementoDir, classLoader);\n+        ((RebindManagerImpl)result.getRebindManager()).setPeriodicPersistPeriod(persistPeriodMillis);\n+        result.getRebindManager().setPersister(newPersister);\n+        return result;\n+    }\n \n     public static Application rebind(File mementoDir, ClassLoader classLoader) throws Exception {\n         LOG.info(\"Rebinding app, using directory \"+mementoDir);\n@@ -80,20 +90,7 @@ public static Application rebind(File mementoDir, ClassLoader classLoader) throw\n     }\n \n     public static void waitForPersisted(Application origApp) throws InterruptedException {\n-        BrooklynMementoPersister persister = origApp.getManagementContext().getRebindManager().getPersister();\n-        if (persister == null) {\n-            throw new IllegalStateException(\"No persister set for \"+origApp);\n-            \n-        } else if (persister instanceof BrooklynMementoPersisterInMemory) {\n-            // ops are blocking; nothing to wait for\n-            \n-        } else if (persister instanceof BrooklynMementoPersisterToMultiFile) {\n-            BrooklynMementoPersisterToMultiFile p = (BrooklynMementoPersisterToMultiFile) persister;\n-            p.waitForWritesCompleted();\n-            \n-        } else {\n-            throw new IllegalStateException(\"Unhandled persister type: \"+persister.getClass()+\"; \"+persister); \n-        }\n+        origApp.getManagementContext().getRebindManager().waitForPendingComplete();\n     }\n     \n     public static void checkCurrentMementoSerializable(Application app) throws Exception {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/core/src/test/java/brooklyn/entity/rebind/RebindTestUtils.java",
                "sha": "f91ad675e951dd5f0da858ba34def3822775bc41",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/software/base/src/main/java/brooklyn/entity/basic/SoftwareProcessEntity.groovy",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/basic/SoftwareProcessEntity.groovy?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 6,
                "filename": "software/base/src/main/java/brooklyn/entity/basic/SoftwareProcessEntity.groovy",
                "patch": "@@ -78,9 +78,11 @@ public abstract class SoftwareProcessEntity extends AbstractEntity implements St\n \tpublic static final AttributeSensor<String> HOSTNAME = Attributes.HOSTNAME\n \tpublic static final AttributeSensor<String> ADDRESS = Attributes.ADDRESS\n \n+    public static final AttributeSensor<MachineProvisioningLocation> PROVISIONING_LOCATION = new BasicAttributeSensor<MachineProvisioningLocation>(\n+            MachineProvisioningLocation.class, \"softwareservice.provisioningLocation\", \"Location used to provision a machine where this is running\");\n+        \n \tpublic static final BasicAttributeSensor<Lifecycle> SERVICE_STATE = Attributes.SERVICE_STATE\n \t\n-\tprivate MachineProvisioningLocation provisioningLoc\n \tprivate SoftwareProcessDriver driver\n \tprotected transient SensorRegistry sensorRegistry\n \n@@ -96,12 +98,12 @@ public abstract class SoftwareProcessEntity extends AbstractEntity implements St\n     }\n \n     protected void setProvisioningLocation(MachineProvisioningLocation val) {\n-        if (provisioningLoc) throw new IllegalStateException(\"Cannot change provisioning location: existing=\"+provisioningLoc+\"; new=\"+val)\n-        provisioningLoc = val\n+        if (getAttribute(PROVISIONING_LOCATION) != null) throw new IllegalStateException(\"Cannot change provisioning location: existing=\"+getAttribute(PROVISIONING_LOCATION)+\"; new=\"+val)\n+        setAttribute(PROVISIONING_LOCATION, val);\n     }\n     \n     protected MachineProvisioningLocation getProvisioningLocation() {\n-        return provisioningLoc\n+        return getAttribute(PROVISIONING_LOCATION);\n     }\n     \n \tpublic SoftwareProcessDriver getDriver() { driver }\n@@ -255,7 +257,7 @@ public abstract class SoftwareProcessEntity extends AbstractEntity implements St\n \t\tMap<String,Object> flags = obtainProvisioningFlags(location);\n         if (!(location in LocalhostMachineProvisioningLocation))\n             LOG.info(\"Starting {}, obtaining a new location instance in {} with ports {}\", this, location, flags.inboundPorts)\n-\t\tprovisioningLoc = location;\n+\t\tsetAttribute(PROVISIONING_LOCATION, location);\n         SshMachineLocation machine;\n         Tasks.withBlockingDetails(\"Provisioning machine in \"+location) {\n             machine = location.obtain(flags);\n@@ -403,7 +405,7 @@ public abstract class SoftwareProcessEntity extends AbstractEntity implements St\n \t\tif (driver) driver.stop()\n \n \t\t// Only release this machine if we ourselves provisioned it (e.g. it might be running other services)\n-\t\tprovisioningLoc?.release(machine)\n+\t\tgetAttribute(PROVISIONING_LOCATION)?.release(machine)\n \n \t\tdriver = null;\n \t}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/software/base/src/main/java/brooklyn/entity/basic/SoftwareProcessEntity.groovy",
                "sha": "01534d2c70e53c7869db8ce62c59878a2fed14d9",
                "status": "modified"
            },
            {
                "additions": 100,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityRebindTest.java",
                "changes": 100,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityRebindTest.java?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 0,
                "filename": "software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityRebindTest.java",
                "patch": "@@ -0,0 +1,100 @@\n+package brooklyn.entity.basic;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+import java.io.File;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Test;\n+\n+import brooklyn.entity.basic.SoftwareProcessEntityTest.MyService;\n+import brooklyn.entity.rebind.RebindEntityTest.MyApplication;\n+import brooklyn.entity.rebind.RebindTestUtils;\n+import brooklyn.location.MachineProvisioningLocation;\n+import brooklyn.location.NoMachinesAvailableException;\n+import brooklyn.location.basic.AbstractLocation;\n+import brooklyn.location.basic.SshMachineLocation;\n+import brooklyn.management.ManagementContext;\n+import brooklyn.util.MutableMap;\n+import brooklyn.util.flags.SetFromFlag;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import com.google.common.io.Files;\n+\n+public class SoftwareProcessEntityRebindTest {\n+\n+    private ClassLoader classLoader = getClass().getClassLoader();\n+    private ManagementContext managementContext;\n+    private MyApplication origApp;\n+    private MyService origE;\n+    private File mementoDir;\n+    \n+    @BeforeMethod\n+    public void setUp() throws Exception {\n+        mementoDir = Files.createTempDir();\n+        managementContext = RebindTestUtils.newPersistingManagementContext(mementoDir, classLoader);\n+        origApp = new MyApplication();\n+        managementContext.manage(origApp);\n+    }\n+\n+    @AfterMethod\n+    public void tearDown() throws Exception {\n+        if (mementoDir != null) RebindTestUtils.deleteMementoDir(mementoDir);\n+    }\n+    \n+    // FIXME Use SoftwareProcessEntity; so move test to software/base or webapps\n+    @Test\n+    public void testReleasesLocationOnStopAfterRebinding() throws Exception {\n+        origE = new MyService(MutableMap.of(), origApp);\n+        managementContext.manage(origE);\n+        \n+        MyProvisioningLocation origLoc = new MyProvisioningLocation(MutableMap.of(\"name\", \"mylocname\"));\n+        origApp.start(ImmutableList.of(origLoc));\n+        assertEquals(origLoc.inUseCount.get(), 1);\n+        \n+        MyApplication newApp = (MyApplication) rebind();\n+        MyProvisioningLocation newLoc = (MyProvisioningLocation) Iterables.getOnlyElement(newApp.getLocations());\n+        assertEquals(newLoc.inUseCount.get(), 1);\n+        \n+        newApp.stop();\n+        assertEquals(newLoc.inUseCount.get(), 0);\n+    }\n+\n+    private MyApplication rebind() throws Exception {\n+        RebindTestUtils.waitForPersisted(origApp);\n+        return (MyApplication) RebindTestUtils.rebind(mementoDir, getClass().getClassLoader());\n+    }\n+    \n+    public static class MyProvisioningLocation extends AbstractLocation implements MachineProvisioningLocation<SshMachineLocation> {\n+        private static final long serialVersionUID = 1L;\n+        \n+        @SetFromFlag(defaultVal=\"0\")\n+        AtomicInteger inUseCount;\n+\n+        public MyProvisioningLocation(Map flags) {\n+            super(flags);\n+        }\n+\n+        @Override\n+        public SshMachineLocation obtain(Map flags) throws NoMachinesAvailableException {\n+            inUseCount.incrementAndGet();\n+            return new SshMachineLocation(MutableMap.of(\"address\",\"localhost\"));\n+        }\n+\n+        @Override\n+        public void release(SshMachineLocation machine) {\n+            inUseCount.decrementAndGet();\n+        }\n+\n+        @Override\n+        public Map getProvisioningFlags(Collection tags) {\n+            return Collections.emptyMap();\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityRebindTest.java",
                "sha": "45ef0ee92aacf6a0eff8bcd92873e38555f4c290",
                "status": "added"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/513057694816b45a054c4ff6d2a426ef5bb919f8/software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityTest.groovy",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityTest.groovy?ref=513057694816b45a054c4ff6d2a426ef5bb919f8",
                "deletions": 3,
                "filename": "software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityTest.groovy",
                "patch": "@@ -1,12 +1,12 @@\n package brooklyn.entity.basic;\n \n-import groovy.transform.InheritConstructors;\n+import groovy.transform.InheritConstructors\n \n import org.testng.Assert\n import org.testng.annotations.Test\n \n import brooklyn.config.ConfigKey\n-import brooklyn.entity.Application\n+import brooklyn.entity.Entity\n import brooklyn.location.MachineLocation\n import brooklyn.location.basic.FixedListMachineProvisioningLocation\n import brooklyn.location.basic.SshMachineLocation\n@@ -46,7 +46,13 @@ public class SoftwareProcessEntityTest {\n     }\n     \n     @InheritConstructors\n-    private static class MyService extends SoftwareProcessEntity {\n+    public static class MyService extends SoftwareProcessEntity {\n+        public MyService(Entity owner) {\n+            super(owner);\n+        }\n+        public MyService(Map flags, Entity owner) {\n+            super(flags, owner);\n+        }\n         @Override\n         public <T> T getConfig(ConfigKey<T> key, T defaultValue=null) {\n             return super.getConfig(key, defaultValue)",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/513057694816b45a054c4ff6d2a426ef5bb919f8/software/base/src/test/java/brooklyn/entity/basic/SoftwareProcessEntityTest.groovy",
                "sha": "95f90cdab0aa2ffa314ba215a873d75b172c895b",
                "status": "modified"
            }
        ],
        "message": "Supports periodic persist for RebindManager\n\n- Avoids hammering the CPU too much, by continually serializing\n  mementos and persisting them.\n- Fixes NPE in AbstractEntity.invalidate\n- Fixes location rebind, where was overwriting all fields\n  with their default values!\n- In EntityManagementSupport, sets currentlyDeployed before\n  calling onManagementStarting.\n- ScheduledTask: make it useable from java\n- Fixes SoftwareProcessEntity rebind (so provisioningLocation is\n  restored, and stop can subsequently release the machine)",
        "parent": "https://github.com/apache/brooklyn-server/commit/592f4d672646651023c1aebc0d07f1e040499c82",
        "patched_files": [
            "PeriodicDeltaChangeListener.java",
            "RebindManager.java",
            "ChangeListener.java",
            "RebindTestUtils.java",
            "ImmediateDeltaChangeListener.java",
            "BrooklynMementoPersisterToFile.java",
            "AbstractEntity.groovy",
            "BrooklynMementoPersister.java",
            "PersisterDeltaImpl.java",
            "RetryingMementoSerializer.java",
            "FlagUtils.java",
            "MementoFileWriter.java",
            "RebindManagerImpl.java",
            "SoftwareProcessEntityTest.groovy",
            "BrooklynMementoPersisterToMultiFile.java",
            "BasicLocationRebindSupport.java",
            "ScheduledTask.java",
            "EntityManagementSupport.java",
            "SoftwareProcessEntity.groovy",
            "BrooklynMementoPersisterInMemory.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "RebindSshMachineLocationTest.java",
            "SoftwareProcessEntityRebindTest.java",
            "RebindEntityTest.java",
            "CheckpointEntityTest.java",
            "RebindDynamicGroupTest.java",
            "RebindLocationTest.java"
        ]
    },
    "brooklyn-server_54d4633": {
        "bug_id": "brooklyn-server_54d4633",
        "commit": "https://github.com/apache/brooklyn-server/commit/54d4633dfaaa2ac7682667f6a02e22073ee8c18c",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/api/src/main/java/org/apache/brooklyn/api/typereg/RegisteredType.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/api/src/main/java/org/apache/brooklyn/api/typereg/RegisteredType.java?ref=54d4633dfaaa2ac7682667f6a02e22073ee8c18c",
                "deletions": 1,
                "filename": "api/src/main/java/org/apache/brooklyn/api/typereg/RegisteredType.java",
                "patch": "@@ -21,6 +21,8 @@\n import java.util.Collection;\n import java.util.Set;\n \n+import javax.annotation.Nullable;\n+\n import org.apache.brooklyn.api.entity.Entity;\n import org.apache.brooklyn.api.entity.EntitySpec;\n import org.apache.brooklyn.api.objs.BrooklynObject;\n@@ -112,9 +114,10 @@\n          * this may be null if the relevant transformer was not declared when created,\n          * but in general we should look to determine the kind as early as possible \n          * and use that to retrieve the appropriate such transformer */\n+        @Nullable \n         String getPlanFormat();\n         /** data for the implementation; may be more specific */\n-        Object getPlanData();\n+        Object getPlanData(); // TODO unclear if this is allowed to return null; most (?) usages do a null check\n         \n         @Override boolean equals(Object obj);\n         @Override int hashCode();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/api/src/main/java/org/apache/brooklyn/api/typereg/RegisteredType.java",
                "sha": "fddcde3400f845d0bdbe45823aa91120724f5a88",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/core/src/main/java/org/apache/brooklyn/core/typereg/BasicBrooklynTypeRegistry.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/typereg/BasicBrooklynTypeRegistry.java?ref=54d4633dfaaa2ac7682667f6a02e22073ee8c18c",
                "deletions": 10,
                "filename": "core/src/main/java/org/apache/brooklyn/core/typereg/BasicBrooklynTypeRegistry.java",
                "patch": "@@ -193,13 +193,13 @@ public RegisteredType get(String symbolicNameWithOptionalVersion) {\n     }\n \n     @Override\n-    public <SpecT extends AbstractBrooklynObjectSpec<?,?>> SpecT createSpec(RegisteredType type, @Nullable RegisteredTypeLoadingContext constraint, Class<SpecT> specSuperType) {\n+    public <SpecT extends AbstractBrooklynObjectSpec<?,?>> SpecT createSpec(RegisteredType type, @Nullable RegisteredTypeLoadingContext constraint, @Nullable Class<SpecT> specSuperType) {\n         Preconditions.checkNotNull(type, \"type\");\n         if (type.getKind()==RegisteredTypeKind.SPEC) {\n             return createSpec(type, type.getPlan(), type.getSymbolicName(), type.getVersion(), type.getSuperTypes(), constraint, specSuperType);\n             \n         } else if (type.getKind()==RegisteredTypeKind.UNRESOLVED) {\n-            if (constraint.getAlreadyEncounteredTypes().contains(type.getSymbolicName())) {\n+            if (constraint != null && constraint.getAlreadyEncounteredTypes().contains(type.getSymbolicName())) {\n                 throw new UnsupportedTypePlanException(\"Cannot create spec from type \"+type+\" (kind \"+type.getKind()+\"), recursive reference following \"+constraint.getAlreadyEncounteredTypes());\n                 \n             } else {\n@@ -225,13 +225,13 @@ public RegisteredType get(String symbolicNameWithOptionalVersion) {\n             RegisteredType type,\n             TypeImplementationPlan plan,\n             @Nullable String symbolicName, @Nullable String version, Set<Object> superTypes,\n-            @Nullable RegisteredTypeLoadingContext constraint, Class<SpecT> specSuperType) {\n+            @Nullable RegisteredTypeLoadingContext constraint, @Nullable Class<SpecT> specSuperType) {\n         // TODO type is only used to call to \"transform\"; we should perhaps change transform so it doesn't need the type?\n         if (constraint!=null) {\n             if (constraint.getExpectedKind()!=null && constraint.getExpectedKind()!=RegisteredTypeKind.SPEC) {\n                 throw new IllegalStateException(\"Cannot create spec with constraint \"+constraint);\n             }\n-            if (constraint.getAlreadyEncounteredTypes().contains(symbolicName)) {\n+            if (symbolicName != null && constraint.getAlreadyEncounteredTypes().contains(symbolicName)) {\n                 // avoid recursive cycle\n                 // TODO implement using java if permitted\n             }\n@@ -254,7 +254,7 @@ public RegisteredType get(String symbolicNameWithOptionalVersion) {\n             }\n             item = CatalogItemBuilder.newItem(ciType, \n                     symbolicName!=null ? symbolicName : Identifiers.makeRandomId(8), \n-                        version!=null ? version : BasicBrooklynCatalog.DEFAULT_VERSION)\n+                    version!=null ? version : BasicBrooklynCatalog.DEFAULT_VERSION)\n                 .plan((String)plan.getPlanData())\n                 .build();\n         }\n@@ -284,13 +284,13 @@ public RegisteredType get(String symbolicNameWithOptionalVersion) {\n     }\n \n     @Override\n-    public <SpecT extends AbstractBrooklynObjectSpec<?, ?>> SpecT createSpecFromPlan(String planFormat, Object planData, RegisteredTypeLoadingContext optionalConstraint, Class<SpecT> optionalSpecSuperType) {\n+    public <SpecT extends AbstractBrooklynObjectSpec<?, ?>> SpecT createSpecFromPlan(@Nullable String planFormat, Object planData, @Nullable RegisteredTypeLoadingContext optionalConstraint, @Nullable Class<SpecT> optionalSpecSuperType) {\n         return createSpec(RegisteredTypes.anonymousRegisteredType(RegisteredTypeKind.SPEC, new BasicTypeImplementationPlan(planFormat, planData)),\n             optionalConstraint, optionalSpecSuperType);\n     }\n \n     @Override\n-    public <T> T createBean(RegisteredType type, RegisteredTypeLoadingContext constraint, Class<T> optionalResultSuperType) {\n+    public <T> T createBean(RegisteredType type, @Nullable RegisteredTypeLoadingContext constraint, @Nullable Class<T> optionalResultSuperType) {\n         Preconditions.checkNotNull(type, \"type\");\n         if (type.getKind()!=RegisteredTypeKind.BEAN) { \n             if (type.getKind()==RegisteredTypeKind.UNRESOLVED) throw new ReferencedUnresolvedTypeException(type);\n@@ -314,13 +314,13 @@ public RegisteredType get(String symbolicNameWithOptionalVersion) {\n     }\n \n     @Override\n-    public <T> T createBeanFromPlan(String planFormat, Object planData, RegisteredTypeLoadingContext optionalConstraint, Class<T> optionalSuperType) {\n+    public <T> T createBeanFromPlan(String planFormat, Object planData, @Nullable RegisteredTypeLoadingContext optionalConstraint, @Nullable Class<T> optionalSuperType) {\n         return createBean(RegisteredTypes.anonymousRegisteredType(RegisteredTypeKind.BEAN, new BasicTypeImplementationPlan(planFormat, planData)),\n             optionalConstraint, optionalSuperType);\n     }\n     \n     @Override\n-    public <T> T create(RegisteredType type, RegisteredTypeLoadingContext constraint, Class<T> optionalResultSuperType) {\n+    public <T> T create(RegisteredType type, @Nullable RegisteredTypeLoadingContext constraint, @Nullable Class<T> optionalResultSuperType) {\n         Preconditions.checkNotNull(type, \"type\");\n         return new RegisteredTypeKindVisitor<T>() { \n             @Override protected T visitBean() { return createBean(type, constraint, optionalResultSuperType); }\n@@ -349,7 +349,7 @@ public RegisteredType get(String symbolicNameWithOptionalVersion) {\n     }\n \n     @Override\n-    public <T> T createFromPlan(Class<T> requiredSuperTypeHint, String planFormat, Object planData, RegisteredTypeLoadingContext optionalConstraint) {\n+    public <T> T createFromPlan(Class<T> requiredSuperTypeHint, @Nullable String planFormat, Object planData, @Nullable RegisteredTypeLoadingContext optionalConstraint) {\n         if (AbstractBrooklynObjectSpec.class.isAssignableFrom(requiredSuperTypeHint)) {\n             @SuppressWarnings({ \"unchecked\", \"rawtypes\" })\n             T result = (T) createSpecFromPlan(planFormat, planData, optionalConstraint, (Class)requiredSuperTypeHint);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/core/src/main/java/org/apache/brooklyn/core/typereg/BasicBrooklynTypeRegistry.java",
                "sha": "565e3f03ae394c631ba649d6fabac6558e26aa26",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/core/src/main/java/org/apache/brooklyn/core/typereg/BasicTypeImplementationPlan.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/typereg/BasicTypeImplementationPlan.java?ref=54d4633dfaaa2ac7682667f6a02e22073ee8c18c",
                "deletions": 1,
                "filename": "core/src/main/java/org/apache/brooklyn/core/typereg/BasicTypeImplementationPlan.java",
                "patch": "@@ -18,6 +18,8 @@\n  */\n package org.apache.brooklyn.core.typereg;\n \n+import javax.annotation.Nullable;\n+\n import org.apache.brooklyn.api.typereg.RegisteredType.TypeImplementationPlan;\n \n import com.google.common.base.Objects;\n@@ -26,7 +28,7 @@\n     final String format;\n     final Object data;\n     \n-    public BasicTypeImplementationPlan(String format, Object data) {\n+    public BasicTypeImplementationPlan(@Nullable String format, Object data) {\n         this.format = format;\n         this.data = data;\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/core/src/main/java/org/apache/brooklyn/core/typereg/BasicTypeImplementationPlan.java",
                "sha": "43276bcae28b5782da59beff154a3be57c15631a",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/core/src/main/java/org/apache/brooklyn/core/typereg/RegisteredTypeLoadingContexts.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/typereg/RegisteredTypeLoadingContexts.java?ref=54d4633dfaaa2ac7682667f6a02e22073ee8c18c",
                "deletions": 2,
                "filename": "core/src/main/java/org/apache/brooklyn/core/typereg/RegisteredTypeLoadingContexts.java",
                "patch": "@@ -175,8 +175,10 @@ public static RegisteredTypeLoadingContext spec(Class<? extends BrooklynObject>\n     }\n         \n     /** given a spec, returns the class of the item it targets, for instance returns {@link Entity} given {@link EntitySpec};\n-     * see also {@link #lookupSpecTypeForTarget(Class)} */\n-    static <T extends AbstractBrooklynObjectSpec<?,?>> Class<? extends BrooklynObject> lookupTargetTypeForSpec(Class<T> specSuperType) {\n+     * see also {@link #lookupSpecTypeForTarget(Class)},\n+     * If given null, returns {@link BrooklynObject}\n+     */\n+    static <T extends AbstractBrooklynObjectSpec<?,?>> Class<? extends BrooklynObject> lookupTargetTypeForSpec(@Nullable Class<T> specSuperType) {\n         if (specSuperType==null) return BrooklynObject.class;\n         BrooklynObjectType best = null;\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/54d4633dfaaa2ac7682667f6a02e22073ee8c18c/core/src/main/java/org/apache/brooklyn/core/typereg/RegisteredTypeLoadingContexts.java",
                "sha": "7eab62696e2a43775988042482172811e5577ff0",
                "status": "modified"
            }
        ],
        "message": "BROOKLYN-537: fix NPE listing catalog items",
        "parent": "https://github.com/apache/brooklyn-server/commit/2a63d8e5762f790592eecfecb5b0d9e6da1199f3",
        "patched_files": [
            "BasicBrooklynTypeRegistry.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BasicBrooklynTypeRegistryTest.java"
        ]
    },
    "brooklyn-server_5aaeaea": {
        "bug_id": "brooklyn-server_5aaeaea",
        "commit": "https://github.com/apache/brooklyn-server/commit/5aaeaea07d573ed1431042a55c6069eb5d3895dd",
        "file": [
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "changes": 43,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 20,
                "filename": "core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "patch": "@@ -1,6 +1,7 @@\n package brooklyn.location.basic;\n \n import static brooklyn.util.GroovyJavaMethods.truth;\n+import groovy.lang.Closure;\n \n import java.io.Closeable;\n import java.io.File;\n@@ -22,29 +23,12 @@\n import java.util.Set;\n import java.util.concurrent.Callable;\n import java.util.concurrent.TimeUnit;\n+\n import javax.annotation.Nullable;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.base.Function;\n-import com.google.common.base.Objects;\n-import com.google.common.base.Preconditions;\n-import com.google.common.base.Predicate;\n-import com.google.common.base.Supplier;\n-import com.google.common.base.Throwables;\n-import com.google.common.cache.CacheBuilder;\n-import com.google.common.cache.CacheLoader;\n-import com.google.common.cache.LoadingCache;\n-import com.google.common.cache.RemovalListener;\n-import com.google.common.cache.RemovalNotification;\n-import com.google.common.collect.ImmutableList;\n-import com.google.common.collect.ImmutableMap;\n-import com.google.common.collect.ImmutableSet;\n-import com.google.common.collect.Iterables;\n-import com.google.common.collect.Sets;\n-import com.google.common.net.HostAndPort;\n-\n import brooklyn.config.BrooklynLogging;\n import brooklyn.config.ConfigKey;\n import brooklyn.config.ConfigKey.HasConfigKey;\n@@ -88,7 +72,24 @@\n import brooklyn.util.task.system.internal.ExecWithLoggingHelpers.ExecRunner;\n import brooklyn.util.text.Strings;\n import brooklyn.util.time.Duration;\n-import groovy.lang.Closure;\n+\n+import com.google.common.base.Function;\n+import com.google.common.base.Objects;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Predicate;\n+import com.google.common.base.Supplier;\n+import com.google.common.base.Throwables;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.google.common.cache.RemovalListener;\n+import com.google.common.cache.RemovalNotification;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Sets;\n+import com.google.common.net.HostAndPort;\n \n /**\n  * Operations on a machine that is accessible via ssh.\n@@ -667,6 +668,7 @@ public int installTo(ResourceUtils loader, String url, String destPath) {\n      *\n      * TODO allow s3://bucket/file URIs for AWS S3 resources\n      * TODO use PAX-URL style URIs for maven artifacts\n+     * TODO use subtasks here for greater visibility?; deprecate in favour of SshTasks.installFromUrl?\n      *\n      * @param utils A {@link ResourceUtils} that can resolve the source URLs\n      * @param url The source URL to be installed\n@@ -687,7 +689,8 @@ public int installTo(ResourceUtils utils, Map<String,?> props, String url, Strin\n             Map<String, ?> sshProps = MutableMap.<String, Object>builder().putAll(props).put(\"out\", outO).put(\"err\", outE).build();\n             int result = execScript(sshProps, \"copying remote resource \"+url+\" to server\",  ImmutableList.of(\n                     BashCommands.INSTALL_CURL, // TODO should hold the 'installing' mutex\n-                    \"curl \"+url+\" -L --silent --insecure --show-error --fail --connect-timeout 60 --max-time 600 --retry 5 -o \"+destPath));\n+                    \"mkdir -p `dirname '\"+destPath+\"'`\",\n+                    \"curl \"+url+\" -L --silent --insecure --show-error --fail --connect-timeout 60 --max-time 600 --retry 5 -o '\"+destPath+\"'\"));\n             sgsO.close();\n             sgsE.close();\n             if (result != 0) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "sha": "4adee00ae4d3beb9f6f0724eea7b2e977824bee8",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/config/ConfigBag.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/config/ConfigBag.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/util/config/ConfigBag.java",
                "patch": "@@ -174,6 +174,8 @@ public ConfigBag putAsStringKeyIfAbsent(Object key, Object value) {\n     }\n \n     public ConfigBag putIfAbsent(Map<?, ?> propertiesToSet) {\n+        if (propertiesToSet==null)\n+            return this;\n         for (Map.Entry<?, ?> entry: propertiesToSet.entrySet()) {\n             Object key = entry.getKey();\n             if (key instanceof HasConfigKey<?>)",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/config/ConfigBag.java",
                "sha": "6a01bc430d8f15b2eef5049831fc6cd1c22400f6",
                "status": "modified"
            },
            {
                "additions": 34,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/file/ArchiveTasks.java",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/file/ArchiveTasks.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/util/file/ArchiveTasks.java",
                "patch": "@@ -0,0 +1,34 @@\n+package brooklyn.util.file;\n+\n+import java.util.Map;\n+\n+import brooklyn.location.basic.SshMachineLocation;\n+import brooklyn.management.TaskAdaptable;\n+import brooklyn.management.TaskFactory;\n+import brooklyn.util.ResourceUtils;\n+import brooklyn.util.net.Urls;\n+import brooklyn.util.task.Tasks;\n+\n+public class ArchiveTasks {\n+\n+    /** as {@link #deploy(ResourceUtils, Map, String, SshMachineLocation, String, String, String)} with the most common parameters */\n+    public static TaskFactory<?> deploy(final ResourceUtils optionalResolver, final String archiveUrl, final SshMachineLocation machine, final String destDir) {\n+        return deploy(optionalResolver, null, archiveUrl, machine, destDir, false, null, null);\n+    }\n+    \n+    /** returns a task which installs and unpacks the given archive, as per {@link ArchiveUtils#deploy(ResourceUtils, Map, String, SshMachineLocation, String, String, String)} */\n+    public static TaskFactory<?> deploy(final ResourceUtils resolver, final Map<String, ?> props, final String archiveUrl, final SshMachineLocation machine, final String destDir, final boolean keepArchiveAfterDeploy, final String tmpDir, final String destFile) {\n+        return new TaskFactory<TaskAdaptable<?>>() {\n+            @Override\n+            public TaskAdaptable<?> newTask() {\n+                return Tasks.<Void>builder().name(\"deploying \"+Urls.getFilename(archiveUrl)).description(\"installing \"+archiveUrl+\" and unpacking to \"+destDir).body(new Runnable() {\n+                    @Override\n+                    public void run() {\n+                        ArchiveUtils.deploy(resolver, props, archiveUrl, machine, destDir, keepArchiveAfterDeploy, tmpDir, destFile);\n+                    }\n+                }).build();\n+            }\n+        };\n+    }\n+    \n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/file/ArchiveTasks.java",
                "sha": "5d64aab07c30a95d05d53084a21e8985ed5ade78",
                "status": "added"
            },
            {
                "additions": 41,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/file/ArchiveUtils.java",
                "changes": 48,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/file/ArchiveUtils.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 7,
                "filename": "core/src/main/java/brooklyn/util/file/ArchiveUtils.java",
                "patch": "@@ -29,16 +29,21 @@\n import org.slf4j.LoggerFactory;\n \n import brooklyn.location.basic.SshMachineLocation;\n+import brooklyn.util.ResourceUtils;\n+import brooklyn.util.collections.MutableList;\n import brooklyn.util.collections.MutableMap;\n import brooklyn.util.exceptions.Exceptions;\n import brooklyn.util.javalang.StackTraceSimplifier;\n import brooklyn.util.net.Urls;\n import brooklyn.util.os.Os;\n import brooklyn.util.ssh.BashCommands;\n+import brooklyn.util.task.DynamicTasks;\n import brooklyn.util.task.Tasks;\n import brooklyn.util.task.ssh.SshTasks;\n+import brooklyn.util.text.Strings;\n \n import com.google.common.base.Charsets;\n+import com.google.common.base.Preconditions;\n import com.google.common.io.Files;\n \n public class ArchiveUtils {\n@@ -126,6 +131,11 @@ public String toString() {\n      * @see #extractCommands(String, String)\n      */\n     public static List<String> extractCommands(String fileName, String sourceDir, String targetDir, boolean extractJar) {\n+        return extractCommands(fileName, sourceDir, targetDir, extractJar, true);\n+    }\n+    \n+    /** as {@link #extractCommands(String, String, String, boolean)}, but also with option to keep the original */\n+    public static List<String> extractCommands(String fileName, String sourceDir, String targetDir, boolean extractJar, boolean keepOriginal) {\n         List<String> commands = new LinkedList<String>();\n         commands.add(\"cd \" + targetDir);\n         String sourcePath = Os.mergePathsUnix(sourceDir, fileName);\n@@ -150,9 +160,12 @@ public String toString() {\n                     break;\n                 }\n             case UNKNOWN:\n-                commands.add(\"cp \" + sourcePath + \" \" + targetDir);\n+                if (!sourcePath.equals(Urls.mergePaths(targetDir, fileName)))\n+                    commands.add(\"cp \" + sourcePath + \" \" + targetDir);\n                 break;\n         }\n+        if (!keepOriginal && !commands.isEmpty())\n+            commands.add(\"rm \"+sourcePath);\n         return commands;\n     }\n \n@@ -212,7 +225,10 @@ public static void deploy(String archiveUrl, SshMachineLocation machine, String\n     public static void deploy(Map<String, ?> props, String archiveUrl, SshMachineLocation machine, String destDir, String destFile) {\n         deploy(props, archiveUrl, machine, destDir, destDir, destFile);\n     }\n-\n+    public static void deploy(Map<String, ?> props, String archiveUrl, SshMachineLocation machine, String tmpDir, String destDir, String destFile) {\n+        deploy(null, props, archiveUrl, machine, destDir, true, tmpDir, destFile);\n+    }\n+    \n     /**\n      * Deploys an archive file to a remote machine and extracts the contents.\n      * <p>\n@@ -224,17 +240,30 @@ public static void deploy(Map<String, ?> props, String archiveUrl, SshMachineLoc\n      * @see #deploy(Map, String, SshMachineLocation, String, String, String)\n      * @see #install(SshMachineLocation, String, String, int)\n      */\n-    public static void deploy(Map<String, ?> props, String archiveUrl, SshMachineLocation machine, String tmpDir, String destDir, String destFile) {\n-        String destPath = Os.mergePaths(tmpDir, destFile);\n+    public static void deploy(ResourceUtils resolver, Map<String, ?> props, String archiveUrl, SshMachineLocation machine, String destDir, boolean keepArchiveAfterUnpacking, String optionalTmpDir, String optionalDestFile) {\n+        if (optionalDestFile==null) optionalDestFile = Urls.getFilename(Preconditions.checkNotNull(archiveUrl, \"archiveUrl\"));\n+        if (Strings.isBlank(optionalDestFile)) \n+            throw new IllegalStateException(\"Not given filename and cannot infer archive type from '\"+archiveUrl+\"'\");\n+        if (optionalTmpDir==null) optionalTmpDir=Preconditions.checkNotNull(destDir, \"destDir\");\n+        if (props==null) props = MutableMap.of();\n+        String destPath = Os.mergePaths(optionalTmpDir, optionalDestFile);\n \n         // Use the location mutex to prevent package manager locking issues\n         try {\n             machine.acquireMutex(\"installing\", \"installing archive\");\n-            int result = install(props, machine, archiveUrl, destPath, NUM_RETRIES_FOR_COPYING);\n+            int result = install(resolver, props, machine, archiveUrl, destPath, NUM_RETRIES_FOR_COPYING);\n             if (result != 0) {\n                 throw new IllegalStateException(format(\"Unable to install archive %s to %s\", archiveUrl, machine));\n             }\n-            result = machine.execCommands(props, \"extracting content\", extractCommands(destFile, tmpDir, destDir, false));\n+            \n+            // extract, now using task if available\n+            MutableList<String> commands = MutableList.copyOf(installCommands(optionalDestFile))\n+                .appendAll(extractCommands(optionalDestFile, optionalTmpDir, destDir, false, keepArchiveAfterUnpacking));\n+            if (DynamicTasks.getTaskQueuingContext()!=null) {\n+                result = DynamicTasks.queue(SshTasks.newSshExecTaskFactory(machine, commands.toArray(new String[0])).summary(\"extracting archive\").requiringExitCodeZero()).get();\n+            } else {\n+                result = machine.execCommands(props, \"extracting content\", commands);\n+            }\n             if (result != 0) {\n                 throw new IllegalStateException(format(\"Failed to expand archive %s on %s\", archiveUrl, machine));\n             }\n@@ -261,6 +290,11 @@ public static int install(SshMachineLocation machine, String urlToInstall, Strin\n      * @see SshMachineLocation#installTo(Map, String, String)\n      */\n     public static int install(Map<String, ?> props, SshMachineLocation machine, String urlToInstall, String target, int numAttempts) {\n+        return install(null, props, machine, urlToInstall, target, numAttempts);\n+    }\n+    \n+    public static int install(ResourceUtils resolver, Map<String, ?> props, SshMachineLocation machine, String urlToInstall, String target, int numAttempts) {\n+        if (resolver==null) resolver = ResourceUtils.create(machine);\n         Exception lastError = null;\n         int retriesRemaining = numAttempts;\n         int attemptNum = 0;\n@@ -269,7 +303,7 @@ public static int install(Map<String, ?> props, SshMachineLocation machine, Stri\n             try {\n                 Tasks.setBlockingDetails(\"Installing \"+urlToInstall+\" at \"+machine);\n                 // TODO would be nice to have this in a task (and the things within it!)\n-                return machine.installTo(props, urlToInstall, target);\n+                return machine.installTo(resolver, props, urlToInstall, target);\n             } catch (Exception e) {\n                 Exceptions.propagateIfFatal(e);\n                 lastError = e;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/file/ArchiveUtils.java",
                "sha": "9f7b7ecdfe535f4b10db04800a3b731116dc61e1",
                "status": "modified"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/task/ssh/SshTasks.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/task/ssh/SshTasks.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/util/task/ssh/SshTasks.java",
                "patch": "@@ -18,8 +18,12 @@\n import brooklyn.location.basic.SshMachineLocation;\n import brooklyn.management.ManagementContext;\n import brooklyn.management.Task;\n+import brooklyn.management.TaskAdaptable;\n+import brooklyn.management.TaskFactory;\n+import brooklyn.util.ResourceUtils;\n import brooklyn.util.config.ConfigBag;\n import brooklyn.util.internal.ssh.SshTool;\n+import brooklyn.util.net.Urls;\n import brooklyn.util.ssh.BashCommands;\n import brooklyn.util.stream.Streams;\n import brooklyn.util.task.Tasks;\n@@ -31,6 +35,7 @@\n \n import com.google.common.annotations.Beta;\n import com.google.common.base.Function;\n+import com.google.common.collect.ImmutableMap;\n import com.google.common.collect.Maps;\n \n /**\n@@ -147,4 +152,25 @@ public String apply(@Nullable ProcessTaskWrapper<?> input) {\n         };\n     }\n \n+    /** task to install a file given a url, where the url is resolved remotely first then locally */\n+    public static TaskFactory<?> installFromUrl(final SshMachineLocation location, final String url, final String destPath) {\n+        return installFromUrl(ResourceUtils.create(SshTasks.class), ImmutableMap.<String,Object>of(), location, url, destPath);\n+    }\n+    /** task to install a file given a url, where the url is resolved remotely first then locally */\n+    public static TaskFactory<?> installFromUrl(final ResourceUtils utils, final Map<String, ?> props, final SshMachineLocation location, final String url, final String destPath) {\n+        return new TaskFactory<TaskAdaptable<?>>() {\n+            @Override\n+            public TaskAdaptable<?> newTask() {\n+                return Tasks.<Void>builder().name(\"installing \"+Urls.getFilename(url)).description(\"installing \"+url+\" to \"+destPath).body(new Runnable() {\n+                    @Override\n+                    public void run() {\n+                        int result = location.installTo(utils, props, url, destPath);\n+                        if (result!=0) \n+                            throw new IllegalStateException(\"Failed to install '\"+url+\"' to '\"+destPath+\"' at \"+location+\": exit code \"+result);\n+                    }\n+                }).build();\n+            }\n+        };\n+    }\n+    \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/core/src/main/java/brooklyn/util/task/ssh/SshTasks.java",
                "sha": "d0b92a5601b020d265bc5f2f8fe293796555cba5",
                "status": "modified"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefBashCommands.java",
                "changes": 100,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefBashCommands.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 49,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefBashCommands.java",
                "patch": "@@ -5,17 +5,9 @@\n import static brooklyn.util.ssh.BashCommands.INSTALL_UNZIP;\n import static brooklyn.util.ssh.BashCommands.downloadToStdout;\n import static brooklyn.util.ssh.BashCommands.sudo;\n-\n-import javax.annotation.Nullable;\n-\n-import org.apache.commons.io.FilenameUtils;\n-\n import brooklyn.util.ssh.BashCommands;\n-import brooklyn.util.text.Identifiers;\n-import brooklyn.util.text.Strings;\n \n import com.google.common.annotations.Beta;\n-import com.google.common.io.Files;\n \n /** BASH commands useful for setting up Chef */\n @Beta\n@@ -28,46 +20,56 @@\n                     INSTALL_UNZIP,\n                     \"( \"+downloadToStdout(\"https://www.opscode.com/chef/install.sh\") + \" | \" + sudo(\"bash\")+\" )\");\n \n-    /** this assumes the download is an archive containing a single directory on the root which will be renamed to \"cookbookName\";\n-     * if that directory already has the correct name cookbookName can be null,\n-     * but if e.g. taking from a github tarball it will typically be of the form cookbookName-master/ \n-     * hence the renaming */\n-    // TODO support installing from classpath, and using the repository (tie in with those methods)\n-    public static final String downloadAndExpandCookbook(String source, @Nullable String cookbookName, boolean force) {\n-        String dl = downloadAndExpandCookbook(source);\n-        if (cookbookName==null) return dl;\n-        String tmpName = \"tmp-\"+Strings.makeValidFilename(cookbookName)+\"-\"+Identifiers.makeRandomId(4);\n-        String installCmd = BashCommands.chain(\"mkdir \"+tmpName, \"cd \"+tmpName, dl, \n-                BashCommands.requireTest(\"`ls | wc -w` -eq 1\", \n-                        \"The downloaded archive must contain exactly one directory; contained\"),\n-        \t\t\"COOKBOOK_EXPANDED_DIR=`ls`\",\n-        \t\t\"mv $COOKBOOK_EXPANDED_DIR '../\"+cookbookName+\"'\",\n-        \t\t\"cd ..\",\n-        \t\t\"rm -rf \"+tmpName);\n-        if (!force) return BashCommands.alternatives(\"ls \"+cookbookName, installCmd);\n-        else return BashCommands.alternatives(\"rm -rf \"+cookbookName, installCmd);\n-    }\n-    \n-    /** as {@link #downloadAndExpandCookbook(String, String)} with no cookbook name */\n-    public static final String downloadAndExpandCookbook(String source) {\n-//        curl -f -L  https://github.com/opscode-cookbooks/postgresql/archive/master.tar.gz | tar xvz\n-        String ext = Files.getFileExtension(source);\n-        if (\"tar\".equalsIgnoreCase(ext))\n-            return downloadToStdout(source) + \" | tar xv\";\n-        if (\"tgz\".equalsIgnoreCase(ext) || source.toLowerCase().endsWith(\".tar.gz\"))\n-            return downloadToStdout(source) + \" | tar xvz\";\n-        \n-        String target = FilenameUtils.getName(source);\n-        if (target==null) target = \"\"; else target = target.trim();\n-        target += \"_\"+Strings.makeRandomId(4);\n-        \n-        if (\"zip\".equalsIgnoreCase(ext) || \"tar.gz\".equalsIgnoreCase(ext))\n-            return BashCommands.chain(\n-                BashCommands.commandToDownloadUrlAs(source, target), \n-                \"unzip \"+target,\n-        \t\t\"rm \"+target);\n-        \n-        throw new UnsupportedOperationException(\"No way to expand \"+source+\" (yet)\");\n-    }\n+    // TODO replaced by tasks\n     \n+//    /** this assumes the download is an archive containing a single directory on the root which will be renamed to \"cookbookName\";\n+//     * if that directory already has the correct name cookbookName can be null,\n+//     * but if e.g. taking from a github tarball it will typically be of the form cookbookName-master/ \n+//     * hence the renaming */\n+//    // TODO support installing from classpath, and using the repository (tie in with those methods)\n+//    public static final String downloadAndExpandCookbook(String cookbookArchiveUrl, @Nullable String cookbookName, boolean force) {\n+//        String dl = downloadAndExpandCookbook(cookbookArchiveUrl);\n+//        if (cookbookName==null) return dl;\n+//        XXX;\n+//        String privateTmpDirContainingUnpackedCookbook = \"tmp-\"+Strings.makeValidFilename(cookbookName)+\"-\"+Identifiers.makeRandomId(4);\n+//        String installCmd = BashCommands.chain(\"mkdir \"+privateTmpDirContainingUnpackedCookbook, \"cd \"+privateTmpDirContainingUnpackedCookbook, dl, \n+//                BashCommands.requireTest(\"`ls | wc -w` -eq 1\", \n+//                        \"The downloaded archive must contain exactly one directory; contained\"),\n+//        \t\t\"COOKBOOK_EXPANDED_DIR=`ls`\",\n+//        \t\t\"mv $COOKBOOK_EXPANDED_DIR '../\"+cookbookName+\"'\",\n+//        \t\t\"cd ..\",\n+//        \t\t\"rm -rf \"+privateTmpDirContainingUnpackedCookbook);\n+//        if (!force) return BashCommands.alternatives(\"ls \"+cookbookName, installCmd);\n+//        else return BashCommands.alternatives(\"rm -rf \"+cookbookName, installCmd);\n+//    }\n+//    \n+//    /** as {@link #downloadAndExpandCookbook(String, String)} with no cookbook name */\n+//    // TODO deprecate\n+//    public static final String downloadAndExpandCookbook(String cookbookArchiveUrl) {\n+////        curl -f -L  https://github.com/opscode-cookbooks/postgresql/archive/master.tar.gz | tar xvz\n+//        String ext = Files.getFileExtension(cookbookArchiveUrl);\n+//        if (\"tar\".equalsIgnoreCase(ext))\n+//            return downloadToStdout(cookbookArchiveUrl) + \" | tar xv\";\n+//        if (\"tgz\".equalsIgnoreCase(ext) || cookbookArchiveUrl.toLowerCase().endsWith(\".tar.gz\"))\n+//            return downloadToStdout(cookbookArchiveUrl) + \" | tar xvz\";\n+//        \n+//        String target = FilenameUtils.getName(cookbookArchiveUrl);\n+//        if (target==null) target = \"\"; else target = target.trim();\n+//        target += \"_\"+Strings.makeRandomId(4);\n+//        \n+//        if (\"zip\".equalsIgnoreCase(ext) || \"tar.gz\".equalsIgnoreCase(ext))\n+//            return BashCommands.chain(\n+//                BashCommands.commandToDownloadUrlAs(cookbookArchiveUrl, target), \n+//                \"unzip \"+target,\n+//        \t\t\"rm \"+target);\n+//\n+//        // TODO if it's a local dir, automatically pack it\n+//        throw new UnsupportedOperationException(\"No way to install cookbooks in format \"+cookbookArchiveUrl+\" (yet) -- use tgz, tar, or zip\");\n+//    }\n+//\n+//    public static String renameDownloadedCookbook(String privateTmpDirContainingUnpackedCookbook, String cookbook, boolean force) {\n+//        XXX;\n+//        return null;\n+//    }\n+//    \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefBashCommands.java",
                "sha": "40b0f184a68c4e6463ed4238da7d921a8fefb023",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefConfig.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefConfig.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefConfig.java",
                "patch": "@@ -32,6 +32,7 @@\n     /** typically set from spec, to customize the launch part of the start effector */\n     public static final SetConfigKey<String> CHEF_LAUNCH_RUN_LIST = new SetConfigKey<String>(String.class, \"brooklyn.chef.launch.runList\");\n     /** typically set from spec, to customize the launch part of the start effector */\n+    @SetFromFlag(\"launch_attributes\")\n     public static final MapConfigKey<Object> CHEF_LAUNCH_ATTRIBUTES = new MapConfigKey<Object>(Object.class, \"brooklyn.chef.launch.attributes\");\n     \n     public static enum ChefModes {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefConfig.java",
                "sha": "c0ba0aa26216f0e90bbcb1231de877f40b8fa729",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefEntity.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefEntity.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 1,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefEntity.java",
                "patch": "@@ -4,5 +4,5 @@\n import brooklyn.entity.proxying.ImplementedBy;\n \n @ImplementedBy(ChefEntityImpl.class)\n-public interface ChefEntity extends SoftwareProcess {\n+public interface ChefEntity extends SoftwareProcess, ChefConfig {\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefEntity.java",
                "sha": "4f8e53255d91f259dcce7c0fcfd4f79fcc8c1910",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefEntityImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefEntityImpl.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefEntityImpl.java",
                "patch": "@@ -1,12 +1,18 @@\n package brooklyn.entity.chef;\n \n import brooklyn.entity.basic.EffectorStartableImpl;\n+import brooklyn.util.text.Strings;\n \n public class ChefEntityImpl extends EffectorStartableImpl implements ChefEntity {\n \n     public void init() {\n+        String primaryName = getConfig(CHEF_COOKBOOK_PRIMARY_NAME);\n+        if (!Strings.isBlank(primaryName)) setDefaultDisplayName(primaryName+\" (chef)\");\n+        \n         super.init();\n         new ChefLifecycleEffectorTasks().attachLifecycleEffectors(this);\n     }\n     \n+    \n+    \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefEntityImpl.java",
                "sha": "b204e733635f14e071a6812326fb52e95faea54e",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefLifecycleEffectorTasks.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefLifecycleEffectorTasks.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefLifecycleEffectorTasks.java",
                "patch": "@@ -9,6 +9,7 @@\n import brooklyn.entity.Entity;\n import brooklyn.entity.basic.Attributes;\n import brooklyn.entity.basic.Lifecycle;\n+import brooklyn.entity.basic.SoftwareProcess;\n import brooklyn.entity.software.MachineLifecycleEffectorTasks;\n import brooklyn.entity.software.SshEffectorTasks;\n import brooklyn.location.MachineLocation;\n@@ -206,6 +207,7 @@ protected void postStartCustom() {\n         if (!result) {\n             log.warn(\"No way to check whether \"+entity()+\" is running; assuming yes\");\n         }\n+        entity().setAttribute(SoftwareProcess.SERVICE_UP, true);\n     }\n     \n     protected boolean tryCheckStartPid() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefLifecycleEffectorTasks.java",
                "sha": "eecd2bad8e9a183ce2718b6eecd1eca404381e4d",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefSoloTasks.java",
                "changes": 48,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefSoloTasks.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 44,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefSoloTasks.java",
                "patch": "@@ -2,20 +2,11 @@\n \n import java.util.Map;\n \n-import brooklyn.entity.Entity;\n-import brooklyn.entity.effector.EffectorTasks;\n import brooklyn.entity.software.SshEffectorTasks;\n import brooklyn.management.TaskFactory;\n-import brooklyn.util.collections.MutableMap;\n-import brooklyn.util.net.Urls;\n import brooklyn.util.ssh.BashCommands;\n-import brooklyn.util.task.DynamicTasks;\n-import brooklyn.util.task.Tasks;\n \n import com.google.common.annotations.Beta;\n-import com.google.common.collect.ImmutableList;\n-import com.google.gson.Gson;\n-import com.google.gson.GsonBuilder;\n \n @Beta\n public class ChefSoloTasks {\n@@ -28,23 +19,11 @@\n     }\n \n     public static TaskFactory<?> installCookbooks(final String chefDirectory, final Map<String,String> cookbooksAndUrls, final boolean force) {\n-        return Tasks.<Void>builder().name(\"install cookbooks\").body(\n-                new Runnable() {\n-                    public void run() {\n-                        Entity e = EffectorTasks.findEntity();\n-                        if (cookbooksAndUrls==null)\n-                            throw new IllegalStateException(\"No cookbooks defined to install at \"+e);\n-                        for (String cookbook: cookbooksAndUrls.keySet())\n-                            DynamicTasks.queue(installCookbook(chefDirectory, cookbook, cookbooksAndUrls.get(cookbook), force));\n-                    }\n-                }).buildFactory();\n+        return ChefTasks.installCookbooks(chefDirectory, cookbooksAndUrls, force);\n     }\n \n-    public static TaskFactory<?> installCookbook(String chefDirectory, String cookbook, String url, boolean force) {\n-        // TODO if it's server, try knife first\n-        // TODO support downloads from classpath / local server\n-        return SshEffectorTasks.ssh(cdAndRun(chefDirectory, ChefBashCommands.downloadAndExpandCookbook(url, cookbook, force))).\n-                summary(\"install cookbook \"+cookbook).requiringExitCodeZero();\n+    public static TaskFactory<?> installCookbook(String chefDirectory, String cookbookName, String cookbookArchiveUrl, boolean force) {\n+        return ChefTasks.installCookbook(chefDirectory, cookbookName, cookbookArchiveUrl, force);\n     }\n \n     protected static String cdAndRun(String targetDirectory, String command) {\n@@ -55,26 +34,7 @@ protected static String cdAndRun(String targetDirectory, String command) {\n \n     public static TaskFactory<?> buildChefFile(String runDirectory, String chefDirectory, String phase, Iterable<? extends String> runList,\n             Map<String, Object> optionalAttributes) {\n-        // TODO if it's server, try knife first\n-        // TODO configure add'l properties\n-        String phaseRb = \n-                \"root = File.absolute_path(File.dirname(__FILE__))\\n\"+\n-                \"\\n\"+\n-                \"file_cache_path root\\n\"+\n-//                \"cookbook_path root + '/cookbooks'\\n\";\n-                \"cookbook_path '\"+chefDirectory+\"'\\n\";\n-\n-        Map<String,Object> phaseJsonMap = MutableMap.of();\n-        if (optionalAttributes!=null)\n-            phaseJsonMap.putAll(optionalAttributes);\n-        if (runList!=null)\n-            phaseJsonMap.put(\"run_list\", ImmutableList.copyOf(runList));\n-        Gson json = new GsonBuilder().create();\n-        String phaseJson = json.toJson(phaseJsonMap);\n-\n-        return Tasks.sequential(\"build chef files for \"+phase,\n-                    SshEffectorTasks.put(Urls.mergePaths(runDirectory)+\"/\"+phase+\".rb\").contents(phaseRb).createDirectory(),\n-                    SshEffectorTasks.put(Urls.mergePaths(runDirectory)+\"/\"+phase+\".json\").contents(phaseJson));\n+        return ChefTasks.buildChefFile(runDirectory, chefDirectory, phase, runList, optionalAttributes);\n     }\n \n     public static TaskFactory<?> runChef(String runDir, String phase) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefSoloTasks.java",
                "sha": "5239d68796f5efe2990b81f97774db04ebc6b42f",
                "status": "modified"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefTasks.java",
                "changes": 64,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/chef/ChefTasks.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 13,
                "filename": "software/base/src/main/java/brooklyn/entity/chef/ChefTasks.java",
                "patch": "@@ -5,12 +5,17 @@\n import brooklyn.entity.Entity;\n import brooklyn.entity.effector.EffectorTasks;\n import brooklyn.entity.software.SshEffectorTasks;\n+import brooklyn.management.TaskAdaptable;\n import brooklyn.management.TaskFactory;\n import brooklyn.util.collections.MutableMap;\n+import brooklyn.util.file.ArchiveTasks;\n import brooklyn.util.net.Urls;\n import brooklyn.util.ssh.BashCommands;\n import brooklyn.util.task.DynamicTasks;\n+import brooklyn.util.task.TaskBuilder;\n import brooklyn.util.task.Tasks;\n+import brooklyn.util.text.Identifiers;\n+import brooklyn.util.text.Strings;\n \n import com.google.common.annotations.Beta;\n import com.google.common.collect.ImmutableList;\n@@ -28,7 +33,7 @@\n     }\n \n     public static TaskFactory<?> installCookbooks(final String chefDirectory, final Map<String,String> cookbooksAndUrls, final boolean force) {\n-        return Tasks.<Void>builder().name(\"install cookbooks\").body(\n+        return Tasks.<Void>builder().name(\"install \"+(cookbooksAndUrls==null ? \"0\" : cookbooksAndUrls.size())+\" cookbook\"+Strings.s(cookbooksAndUrls)).body(\n                 new Runnable() {\n                     public void run() {\n                         Entity e = EffectorTasks.findEntity();\n@@ -40,16 +45,46 @@ public void run() {\n                 }).buildFactory();\n     }\n \n-    public static TaskFactory<?> installCookbook(String chefDirectory, String cookbook, String url, boolean force) {\n-        // TODO if it's server, try knife first\n-        // TODO support downloads from classpath / local server\n-        return SshEffectorTasks.ssh(cdAndRun(chefDirectory, ChefBashCommands.downloadAndExpandCookbook(url, cookbook, force))).\n-                summary(\"install cookbook \"+cookbook).requiringExitCodeZero();\n+    public static TaskFactory<?> installCookbook(final String chefDirectory, final String cookbookName, final String cookbookArchiveUrl, final boolean force) {\n+        return new TaskFactory<TaskAdaptable<?>>() {\n+            @Override\n+            public TaskAdaptable<?> newTask() {\n+                TaskBuilder<Void> tb = Tasks.<Void>builder().name(\"install cookbook \"+cookbookName);\n+                \n+                String cookbookDir = Urls.mergePaths(chefDirectory, cookbookName);\n+                String privateTmpDirContainingUnpackedCookbook = \n+                    Urls.mergePaths(chefDirectory, \"tmp-\"+Strings.makeValidFilename(cookbookName)+\"-\"+Identifiers.makeRandomId(4));\n+\n+                // TODO - skip the install earlier if it exists and isn't forced\n+//                if (!force) {\n+//                    // in builder.body, check \n+//                    // \"ls \"+cookbookDir\n+//                    // and stop if it's zero\n+//                    // remove reference to 'force' below\n+//                }\n+                \n+                tb.add(ArchiveTasks.deploy(null, cookbookArchiveUrl, EffectorTasks.findSshMachine(), privateTmpDirContainingUnpackedCookbook).newTask());\n+                \n+                String installCmd = BashCommands.chain(\n+                    \"cd \"+privateTmpDirContainingUnpackedCookbook,  \n+                    \"COOKBOOK_EXPANDED_DIR=`ls`\",\n+                    BashCommands.requireTest(\"`ls | wc -w` -eq 1\", \n+                            \"The deployed archive \"+cookbookArchiveUrl+\" must contain exactly one directory\"),\n+                    \"mv $COOKBOOK_EXPANDED_DIR '../\"+cookbookName+\"'\",\n+                    \"cd ..\",\n+                    \"rm -rf '\"+privateTmpDirContainingUnpackedCookbook+\"'\");\n+                \n+                installCmd = force ? BashCommands.alternatives(\"rm -rf \"+cookbookDir, installCmd) : BashCommands.alternatives(\"ls \"+cookbookDir+\" > /dev/null 2> /dev/null\", installCmd);\n+                tb.add(SshEffectorTasks.ssh(installCmd).summary(\"renaming cookbook dir\").requiringExitCodeZero().newTask());\n+                \n+                return tb.build();\n+            }\n+        };\n     }\n \n     protected static String cdAndRun(String targetDirectory, String command) {\n-        return BashCommands.chain(\"mkdir -p \"+targetDirectory,\n-                \"cd \"+targetDirectory,\n+        return BashCommands.chain(\"mkdir -p '\"+targetDirectory+\"'\",\n+                \"cd '\"+targetDirectory+\"'\",\n                 command);\n     }\n \n@@ -58,11 +93,14 @@ protected static String cdAndRun(String targetDirectory, String command) {\n         // TODO if it's server, try knife first\n         // TODO configure add'l properties\n         String phaseRb = \n-                \"root = File.absolute_path(File.dirname(__FILE__))\\n\"+\n-                \"\\n\"+\n-                \"file_cache_path root\\n\"+\n-//                \"cookbook_path root + '/cookbooks'\\n\";\n-                \"cookbook_path '\"+chefDirectory+\"'\\n\";\n+            \"root = \"\n+            + \"'\"+runDirectory+\"'\" \n+            // recommended alternate to runDir is the following, but it is not available in some rubies\n+            //+ File.absolute_path(File.dirname(__FILE__))\"+\n+            + \"\\n\"+\n+            \"file_cache_path root\\n\"+\n+//            \"cookbook_path root + '/cookbooks'\\n\";\n+            \"cookbook_path '\"+chefDirectory+\"'\\n\";\n \n         Map<String,Object> phaseJsonMap = MutableMap.of();\n         if (optionalAttributes!=null)",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/software/base/src/main/java/brooklyn/entity/chef/ChefTasks.java",
                "sha": "4f2efc137a9b9373d1fe549cf819ae18d7fcadd2",
                "status": "modified"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/usage/camp/src/test/resources/mysql-chef.yaml",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/camp/src/test/resources/mysql-chef.yaml?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "usage/camp/src/test/resources/mysql-chef.yaml",
                "patch": "@@ -0,0 +1,26 @@\n+name: chef-mysql-sample\n+services:\n+- type: chef:mysql\n+  \n+  cookbook_urls:\n+    # the standard cookbooks should be packaged as tarballs, unless you have knife installed\n+    mysql: file:///tmp/brooklyn-chef/cookbooks/mysql.tgz\n+    openssl: file:///tmp/brooklyn-chef/cookbooks/openssl.tgz\n+    \n+  launch_attributes:\n+    mysql:\n+      # these attrs are required by the mysql cookbook under node['mysql']\n+      # (many others are supported and can also be passed here)\n+      server_debian_password: p4ssw0rd\n+      server_root_password: p4ssw0rd\n+      server_repl_password: p4ssw0rd\n+      \n+  # how to determine if the process is running and how to kill it\n+  # (supported options are `service_name` and `pid_file`; typically pick one)\n+  service_name: mysqld\n+  #pid_file: /var/run/mysqld/mysqld.pid\n+\n+location:\n+  byon:\n+    hosts: 192.168.33.12\n+    user: vagrant",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/usage/camp/src/test/resources/mysql-chef.yaml",
                "sha": "cec45fb9c4c3dd6fc7d54b49c8f209bdc6d14993",
                "status": "added"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/main/java/brooklyn/util/collections/MutableList.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/collections/MutableList.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 3,
                "filename": "utils/common/src/main/java/brooklyn/util/collections/MutableList.java",
                "patch": "@@ -162,14 +162,22 @@ public Builder() {}\n             for (V item: items) add(item);\n         return this;\n     }\n+    /** as {@link List#addAll(Collection)} but fluent style\u00a0*/\n+    public MutableList<V> appendAll(Iterator<? extends V> items) {\n+        addAll(items);\n+        return this;\n+    }\n \n     public boolean addAll(Iterable<? extends V> setToAdd) {\n         // copy of parent, but accepting Iterable and null\n+        if (setToAdd==null) return false;\n+        return addAll(setToAdd.iterator());\n+    }\n+    public boolean addAll(Iterator<? extends V> setToAdd) {\n         if (setToAdd==null) return false;\n         boolean modified = false;\n-        Iterator<? extends V> e = setToAdd.iterator();\n-        while (e.hasNext()) {\n-            if (add(e.next()))\n+        while (setToAdd.hasNext()) {\n+            if (add(setToAdd.next()))\n                 modified = true;\n         }\n         return modified;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/main/java/brooklyn/util/collections/MutableList.java",
                "sha": "8cffc53a741a78fcedca5083f3568200e059ac6c",
                "status": "modified"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/main/java/brooklyn/util/net/Urls.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/net/Urls.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "utils/common/src/main/java/brooklyn/util/net/Urls.java",
                "patch": "@@ -9,6 +9,8 @@\n \n import javax.annotation.Nullable;\n \n+import brooklyn.util.text.Strings;\n+\n import com.google.common.base.Function;\n import com.google.common.base.Throwables;\n \n@@ -143,6 +145,18 @@ else if (c==':') {\n         }\n     }\n \n+    /** return the last segment of the given url before any '?', typically its name */\n+    public static String getFilename(String url) {\n+        if (url==null) return null;\n+        if (getProtocol(url)!=null) {\n+            int firstQ = url.indexOf('?');\n+            if (firstQ>=0)\n+                url = url.substring(0, firstQ);\n+        }\n+        url = Strings.removeAllFromEnd(url, \"/\");\n+        return url.substring(url.lastIndexOf('/')+1);\n+    }\n+\n     public static boolean isDirectory(String fileUrl) {\n         File file;\n         if (isUrlWithProtocol(fileUrl)) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/main/java/brooklyn/util/net/Urls.java",
                "sha": "74d6f167327ba9c04f724dbca0fd4a41c70c60ce",
                "status": "modified"
            },
            {
                "additions": 20,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/main/java/brooklyn/util/text/Strings.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/text/Strings.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 1,
                "filename": "utils/common/src/main/java/brooklyn/util/text/Strings.java",
                "patch": "@@ -7,6 +7,7 @@\n import java.text.NumberFormat;\n import java.util.Arrays;\n import java.util.Collections;\n+import java.util.Iterator;\n import java.util.Map;\n import java.util.StringTokenizer;\n \n@@ -664,6 +665,24 @@ public static FormattedString format(String pattern, Object... args) {\n     public static String s(int count) {\n         return count==1 ? \"\" : \"s\";\n     }\n+    /** as {@link #s(int)} based on size of argument */\n+    public static String s(@Nullable Map<?,?> map) {\n+        if (map==null) return \"s\";\n+        return s(map.size());\n+    }\n+    /** as {@link #s(int)} based on size of argument */\n+    public static String s(Iterable<?> iter) {\n+        if (iter==null) return \"s\";\n+        return s(iter.iterator());\n+    }\n+    /** as {@link #s(int)} based on size of argument */\n+    public static String s(Iterator<?> iter) {\n+        if (iter==null) return \"s\";\n+        if (!iter.hasNext()) return \"s\";\n+        iter.next();\n+        if (!iter.hasNext()) return \"\";\n+        return \"s\";\n+    }\n \n     /** converts a map of any objects to a map of strings, preserving nulls and invoking toString where needed */\n     public static Map<String, String> toStringMap(Map<?,?> map) {\n@@ -721,5 +740,5 @@ public static int getWordCount(String phrase, boolean respectQuotes) {\n         else\n             return Collections.list(new StringTokenizer(phrase)).size();\n     }\n-    \n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/main/java/brooklyn/util/text/Strings.java",
                "sha": "24285463bb483f21e7fed4f09b030f6ba9c3c0bd",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/test/java/brooklyn/util/net/UrlsTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/test/java/brooklyn/util/net/UrlsTest.java?ref=5aaeaea07d573ed1431042a55c6069eb5d3895dd",
                "deletions": 0,
                "filename": "utils/common/src/test/java/brooklyn/util/net/UrlsTest.java",
                "patch": "@@ -33,5 +33,15 @@ public void testIsUrlWithProtocol() {\n         Assert.assertFalse(Urls.isUrlWithProtocol(\"1:/\"));\n         Assert.assertFalse(Urls.isUrlWithProtocol(null));\n     }\n+\n+    @Test\n+    public void testGetFilename() {\n+        assertEquals(Urls.getFilename(\"http://somewhere.com/path/to/file.txt\"), \"file.txt\");\n+        assertEquals(Urls.getFilename(\"http://somewhere.com/path/to/dir/\"), \"dir\");\n+        assertEquals(Urls.getFilename(\"http://somewhere.com/path/to/file.txt?with/optional/suffice\"), \"file.txt\");\n+        assertEquals(Urls.getFilename(\"filewith?.txt\"), \"filewith?.txt\");\n+        assertEquals(Urls.getFilename(\"\"), \"\");\n+        assertEquals(Urls.getFilename(null), null);\n+    }\n     \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/5aaeaea07d573ed1431042a55c6069eb5d3895dd/utils/common/src/test/java/brooklyn/util/net/UrlsTest.java",
                "sha": "6630e4051d8e7fb32f38724ce918bff878f71033",
                "status": "modified"
            }
        ],
        "message": "many minor usability enhancements for chef, as shown by new simple example mysql-chef.yaml\n\n- catch occasional NPE\n- don't use ruby `absolute_path` as it is not in some common (older) versions\n- better messages on errors\n- respond to more flags in simple yaml\n- install recipes from local machine (using classpath or file:/// URL's)\n- misc tweaks to deploy/archive/install (cc @grkvlt) to run as tasks for traceability",
        "parent": "https://github.com/apache/brooklyn-server/commit/3b25b91ac51b3059f7f2a18257a26354355c07bc",
        "patched_files": [
            "ChefEntity.java",
            "SshMachineLocation.java",
            "ChefTasks.java",
            "SshTasks.java",
            "ConfigBag.java",
            "Urls.java",
            "ChefConfig.java",
            "ChefEntityImpl.java",
            "ArchiveUtils.java",
            "ChefLifecycleEffectorTasks.java",
            "ChefBashCommands.java",
            "Strings.java",
            "MutableList.java",
            "mysql-chef.yaml",
            "ArchiveTasks.java",
            "ChefSoloTasks.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "UrlsTest.java",
            "MutableListTest.java",
            "SshMachineLocationTest.java",
            "SshTasksTest.java",
            "StringsTest.java"
        ]
    },
    "brooklyn-server_666a729": {
        "bug_id": "brooklyn-server_666a729",
        "commit": "https://github.com/apache/brooklyn-server/commit/666a7295090702e2d00b494fcad7331f4b623ee0",
        "file": [
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/666a7295090702e2d00b494fcad7331f4b623ee0/brooklyn-server/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/brooklyn-server/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java?ref=666a7295090702e2d00b494fcad7331f4b623ee0",
                "deletions": 2,
                "filename": "brooklyn-server/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java",
                "patch": "@@ -89,6 +89,7 @@\n import org.apache.brooklyn.util.exceptions.Exceptions;\n import org.apache.brooklyn.util.exceptions.RuntimeInterruptedException;\n import org.apache.brooklyn.util.guava.KeyTransformingLoadingCache.KeyTransformingSameTypeLoadingCache;\n+import org.apache.brooklyn.util.guava.Maybe;\n import org.apache.brooklyn.util.pool.BasicPool;\n import org.apache.brooklyn.util.pool.Pool;\n import org.apache.brooklyn.util.ssh.BashCommands;\n@@ -389,7 +390,7 @@ public void onRemoval(RemovalNotification<Map<String, ?>, Pool<SshTool>> notific\n     private BasicPool<SshTool> buildPool(final Map<String, ?> properties) {\n         return BasicPool.<SshTool>builder()\n                 .name(getDisplayName()+\"@\"+address+\":\"+getPort()+\n-                        (config().getRaw(SSH_HOST).isPresent() ? \"(\"+getConfig(SSH_HOST)+\":\"+getConfig(SSH_PORT)+\")\" : \"\")+\n+                        (config().getRaw(SSH_HOST).isPresent() ? \"(\"+getConfig(SSH_HOST)+\":\"+getPort()+\")\" : \"\")+\n                         \":hash\"+System.identityHashCode(this))\n                 .supplier(new Supplier<SshTool>() {\n                         @Override public SshTool get() {\n@@ -550,7 +551,21 @@ public String getUser() {\n \n     /** port for SSHing */\n     public int getPort() {\n-        return getConfig(SshTool.PROP_PORT);\n+        // Prefer PROP_PORT (i.e. \"port\"). However if that is explicitly null or is not set, then see if\n+        // SSH_PORT (i.e. \"brooklyn.ssh.config.port\") has been set and use that.\n+        // If neither is set (or is explicitly set to null), then use the default PROP_PORT value.\n+        //\n+        // Note we don't just rely on config().get(PROP_PORT) returning the default, because we hit a rebind\n+        // error where the location's port configuration had been explicitly set to null.\n+        // See https://issues.apache.org/jira/browse/BROOKLYN-215\n+        \n+        Maybe<Object> raw = config().getRaw(SshTool.PROP_PORT);\n+        if (raw.orNull() == null && config().getRaw(SSH_PORT).orNull() != null) {\n+            return config().get(SSH_PORT);\n+        } else {\n+            Integer result = config().get(SshTool.PROP_PORT);\n+            return (result != null) ? result : SshTool.PROP_PORT.getDefaultValue();\n+        }\n     }\n \n     protected <T> T execSsh(final Map<String, ?> props, final Function<ShellTool, T> task) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/666a7295090702e2d00b494fcad7331f4b623ee0/brooklyn-server/core/src/main/java/org/apache/brooklyn/location/ssh/SshMachineLocation.java",
                "sha": "b059858cbe986e73f940ddeb6b46c8e6dc950511",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/666a7295090702e2d00b494fcad7331f4b623ee0/brooklyn-server/core/src/test/java/org/apache/brooklyn/core/mgmt/rebind/RebindSshMachineLocationTest.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/brooklyn-server/core/src/test/java/org/apache/brooklyn/core/mgmt/rebind/RebindSshMachineLocationTest.java?ref=666a7295090702e2d00b494fcad7331f4b623ee0",
                "deletions": 1,
                "filename": "brooklyn-server/core/src/test/java/org/apache/brooklyn/core/mgmt/rebind/RebindSshMachineLocationTest.java",
                "patch": "@@ -80,5 +80,23 @@ public void testMachineUsableAfterRebind() throws Exception {\n         \n         assertEquals(newChildLoc.execScript(Collections.<String,Object>emptyMap(), \"mysummary\", ImmutableList.of(\"true\")), 0);\n     }\n-    \n+\n+    // See https://issues.apache.org/jira/browse/BROOKLYN-215\n+    @Test(groups=\"Integration\")\n+    public void testRebindWhenPortNull() throws Exception {\n+        SshMachineLocation machine = origManagementContext.getLocationManager().createLocation(LocationSpec.create(SshMachineLocation.class)\n+                .configure(\"address\", \"localhost\")\n+                .configure(\"port\", null));\n+        FixedListMachineProvisioningLocation<?> byon = origManagementContext.getLocationManager().createLocation(LocationSpec.create(FixedListMachineProvisioningLocation.class)\n+                .configure(\"machines\", ImmutableList.of(machine)));\n+        origApp.start(ImmutableList.of(byon));\n+        LOG.info(\"Before rebind, machine=\"+machine.toString());\n+\n+        newApp = (TestApplication) rebind();\n+        \n+        FixedListMachineProvisioningLocation<?> newByon = (FixedListMachineProvisioningLocation<?>) Iterables.getOnlyElement(newApp.getLocations(), 0);\n+        SshMachineLocation newMachine = (SshMachineLocation) Iterables.get(newByon.getChildren(), 0);\n+        \n+        LOG.info(\"After rebind, machine=\"+newMachine.toString());\n+    }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/666a7295090702e2d00b494fcad7331f4b623ee0/brooklyn-server/core/src/test/java/org/apache/brooklyn/core/mgmt/rebind/RebindSshMachineLocationTest.java",
                "sha": "ec8cacba0971e76d1ce7d34b3a9de49616b50224",
                "status": "modified"
            }
        ],
        "message": "BROOKLYN-215: fix NPE when SshMachineLocation.port==null",
        "parent": "https://github.com/apache/brooklyn-server/commit/ec31d292f3d12d9a6042e2e887c44a554c3fbffb",
        "patched_files": [
            "SshMachineLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "RebindSshMachineLocationTest.java",
            "SshMachineLocationTest.java"
        ]
    },
    "brooklyn-server_675dec1": {
        "bug_id": "brooklyn-server_675dec1",
        "commit": "https://github.com/apache/brooklyn-server/commit/675dec10cf017fb55eaec40702b7cecfe041f666",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/675dec10cf017fb55eaec40702b7cecfe041f666/core/src/main/java/brooklyn/location/basic/Locations.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/Locations.java?ref=675dec10cf017fb55eaec40702b7cecfe041f666",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/location/basic/Locations.java",
                "patch": "@@ -111,6 +111,8 @@ public static void manage(Location loc, ManagementContext managementContext) {\n     }\n \n     public static Location coerce(ManagementContext mgmt, Object rawO) {\n+        if (rawO==null)\n+            return null;\n         if (rawO instanceof Location)\n             return (Location)rawO;\n         ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/675dec10cf017fb55eaec40702b7cecfe041f666/core/src/main/java/brooklyn/location/basic/Locations.java",
                "sha": "09cef7cc98c74098f0eca6dc1996852c70611805",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/675dec10cf017fb55eaec40702b7cecfe041f666/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=675dec10cf017fb55eaec40702b7cecfe041f666",
                "deletions": 0,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -888,6 +888,9 @@ public void apply(TemplateOptions t, ConfigBag props, Object v) {\n                         if (t instanceof EC2TemplateOptions) {\n                             if (v==null) return;\n                             ((EC2TemplateOptions)t).userData(v.toString().getBytes());\n+                            // TODO avail in next jclouds thanks to @andreaturli\n+//                          } else if (t instanceof SoftLayerTemplateOptions) {\n+//                              ((SoftLayerTemplateOptions)t).userData(Strings.toString(v));\n                         } else {\n                             LOG.info(\"ignoring userDataString({}) in VM creation because not supported for cloud/type ({})\", v, t.getClass());\n                         }\n@@ -897,6 +900,9 @@ public void apply(TemplateOptions t, ConfigBag props, Object v) {\n                         if (t instanceof EC2TemplateOptions) {\n                             byte[] bytes = toByteArray(v);\n                             ((EC2TemplateOptions)t).userData(bytes);\n+                          // TODO avail in next jclouds thanks to @andreaturli\n+//                        } else if (t instanceof SoftLayerTemplateOptions) {\n+//                            ((SoftLayerTemplateOptions)t).userData(Strings.toString(v));\n                         } else {\n                             LOG.info(\"ignoring userData({}) in VM creation because not supported for cloud/type ({})\", v, t.getClass());\n                         }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/675dec10cf017fb55eaec40702b7cecfe041f666/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "c58d9bebed5fc9fabd560f36285b2345c863506b",
                "status": "modified"
            }
        ],
        "message": "don't cause NPE inside location list coercions (alt fix for recent fix for NPE from where this is invoked in MachineLifecycleTasks), and some notes on jclouds location for softlayer",
        "parent": "https://github.com/apache/brooklyn-server/commit/ffc86359bf0689cc10785c3ed25c3d80885e38c8",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_67f5a0d": {
        "bug_id": "brooklyn-server_67f5a0d",
        "commit": "https://github.com/apache/brooklyn-server/commit/67f5a0d1ea84e47785d4b22056730da1a5f82047",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/67f5a0d1ea84e47785d4b22056730da1a5f82047/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=67f5a0d1ea84e47785d4b22056730da1a5f82047",
                "deletions": 4,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -401,10 +401,12 @@ public JcloudsSshMachineLocation obtain(Map<?,?> flags) throws NoMachinesAvailab\n             if (!(waitForSshable!=null && \"false\".equalsIgnoreCase(waitForSshable))) {\n                String setupScript = setup.get(JcloudsLocationConfig.CUSTOM_MACHINE_SETUP_SCRIPT_URL);\n                 if(Strings.isNonBlank(setupScript)) {\n-                   String setupVarsString = setup.get(JcloudsLocationConfig.CUSTOM_MACHINE_SETUP_SCRIPT_VARS);\n-                   Map<String, String> substitutions = Splitter.on(\",\").withKeyValueSeparator(\":\").split(setupVarsString);\n-                   String script = TemplateProcessor.processTemplate(setupScript, substitutions);\n-                   sshMachineLocation.execCommands(\"Customizing node \" + this, ImmutableList.of(script));\n+                    String setupVarsString = setup.get(JcloudsLocationConfig.CUSTOM_MACHINE_SETUP_SCRIPT_VARS);\n+                    Map<String, String> substitutions = (setupVarsString != null)\n+                            ? Splitter.on(\",\").withKeyValueSeparator(\":\").split(setupVarsString)\n+                            : Maps.<String, String>newHashMap();\n+                    String script = TemplateProcessor.processTemplate(setupScript, substitutions);\n+                    sshMachineLocation.execCommands(\"Customizing node \" + this, ImmutableList.of(script));\n                 }\n                 \n                 if (setup.get(JcloudsLocationConfig.MAP_DEV_RANDOM_TO_DEV_URANDOM))",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/67f5a0d1ea84e47785d4b22056730da1a5f82047/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "ff6c596759fc01bbc473d4339e7509ec337d8b7b",
                "status": "modified"
            }
        ],
        "message": "JcloudsLocation: No NPE if setup.script is given but not setup.script.vars",
        "parent": "https://github.com/apache/brooklyn-server/commit/47352d9c7d3ef7356610a508d96c1e6eccfe1b36",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_6a5d519": {
        "bug_id": "brooklyn-server_6a5d519",
        "commit": "https://github.com/apache/brooklyn-server/commit/6a5d519e2d203d611a4a5be966bf42777cbd44b0",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6a5d519e2d203d611a4a5be966bf42777cbd44b0/software/base/src/main/java/brooklyn/entity/java/JmxSupport.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/java/JmxSupport.java?ref=6a5d519e2d203d611a4a5be966bf42777cbd44b0",
                "deletions": 1,
                "filename": "software/base/src/main/java/brooklyn/entity/java/JmxSupport.java",
                "patch": "@@ -273,7 +273,8 @@ public String getJmxAgentJarUrl() {\n     public void applyJmxJavaSystemProperties(MutableMap.Builder<String,Object> result) {\n         if (!isJmx()) return ;\n \n-        HostAndPort jmx = BrooklynAccessUtils.getBrooklynAccessibleAddress(entity, entity.getAttribute(JMX_PORT));\n+        Integer jmxPort = Preconditions.checkNotNull(entity.getAttribute(JMX_PORT), \"jmx port must not be null for %s\", entity);\n+        HostAndPort jmx = BrooklynAccessUtils.getBrooklynAccessibleAddress(entity, jmxPort);\n         Integer jmxRemotePort = getEntity().getAttribute(JMX_PORT);\n         String hostName = jmx.getHostText();\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6a5d519e2d203d611a4a5be966bf42777cbd44b0/software/base/src/main/java/brooklyn/entity/java/JmxSupport.java",
                "sha": "f10cf8d591eb14eeb2df85f4b0c4fbfedb43dd71",
                "status": "modified"
            }
        ],
        "message": "JmxSupport: improve NPE message when jmxPort null\n\nWas previously throwing NPE converting the null attribute value to\nan `int`.",
        "parent": "https://github.com/apache/brooklyn-server/commit/6f506fc355b1050d164fbf6ef2e363e06122c02d",
        "patched_files": [
            "JmxSupport.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JmxSupportTest.java"
        ]
    },
    "brooklyn-server_6e7a4ee": {
        "bug_id": "brooklyn-server_6e7a4ee",
        "commit": "https://github.com/apache/brooklyn-server/commit/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d/core/src/main/java/brooklyn/location/geo/GeoBytesHostGeoLookup.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/geo/GeoBytesHostGeoLookup.java?ref=6e7a4ee5fef8b5455695f7a930947c3b9a77f11d",
                "deletions": 4,
                "filename": "core/src/main/java/brooklyn/location/geo/GeoBytesHostGeoLookup.java",
                "patch": "@@ -29,6 +29,8 @@\n \n import brooklyn.util.net.Networking;\n \n+/** @deprecated Mar 2015 - the API has changed; GetLocation now discouraged for free access, and valuepairs.txt not supported */\n+@Deprecated\n public class GeoBytesHostGeoLookup implements HostGeoLookup {\n \n     public static final Logger log = LoggerFactory.getLogger(GeoBytesHostGeoLookup.class);\n@@ -84,7 +86,12 @@ public HostGeoInfo getHostGeoInfo(InetAddress address) throws MalformedURLExcept\n         Properties props = new Properties();\n         try {\n             props.load( new URL(url).openStream() );\n+            HostGeoInfo geo = new HostGeoInfo(address.getHostName(), props.getProperty(\"city\")+\" (\"+props.getProperty(\"iso2\")+\")\", \n+                Double.parseDouble(props.getProperty(\"latitude\")), Double.parseDouble(props.getProperty(\"longitude\")));\n+            log.info(\"Geo info lookup for \"+address+\" returned: \"+geo);\n+            return geo;\n         } catch (Exception e) {\n+            // may be web not available, or gateway giving us funny crap\n             if (log.isDebugEnabled())\n                 log.debug(\"Geo info lookup for \"+address+\" failed: \"+e);\n             if (!LOGGED_GEO_LOOKUP_UNAVAILABLE) {\n@@ -93,10 +100,6 @@ public HostGeoInfo getHostGeoInfo(InetAddress address) throws MalformedURLExcept\n             }\n             return null;\n         }\n-        HostGeoInfo geo = new HostGeoInfo(address.getHostName(), props.getProperty(\"city\")+\" (\"+props.getProperty(\"iso2\")+\")\", \n-                Double.parseDouble(props.getProperty(\"latitude\")), Double.parseDouble(props.getProperty(\"longitude\")));\n-        log.info(\"Geo info lookup for \"+address+\" returned: \"+geo);\n-        return geo;\n     }\n     \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d/core/src/main/java/brooklyn/location/geo/GeoBytesHostGeoLookup.java",
                "sha": "1c68000b49861a7e9f8ea0f96ebfc92b2a5187d2",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d/core/src/main/java/brooklyn/location/geo/UtraceHostGeoLookup.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/geo/UtraceHostGeoLookup.java?ref=6e7a4ee5fef8b5455695f7a930947c3b9a77f11d",
                "deletions": 2,
                "filename": "core/src/main/java/brooklyn/location/geo/UtraceHostGeoLookup.java",
                "patch": "@@ -27,6 +27,9 @@\n import java.net.MalformedURLException;\n import java.util.concurrent.atomic.AtomicReference;\n \n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -189,9 +192,17 @@ public HostGeoInfo retrieveHostGeoInfo(InetAddress address) throws MalformedURLE\n         }\n     }\n     \n+    @Nullable\n+    private static Node getFirstChild(Node xml, String field) {\n+        if (xml==null) return null;\n+        NodeList nl = (NodeList)xml.get(field);\n+        if (nl==null || nl.isEmpty()) return null;\n+        return (Node)nl.get(0);\n+    }\n+    @Nonnull\n     private static String getXmlResultsField(Node xml, String field) {\n-        Node r1 = ((Node)((NodeList)xml.get(\"result\")).get(0));\n-        Node f1 = ((Node)((NodeList)r1.get(field)).get(0));\n+        Node f1 = getFirstChild(getFirstChild(xml, \"result\"), field);\n+        if (f1==null) return \"\";\n         return f1.text();\n     }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d/core/src/main/java/brooklyn/location/geo/UtraceHostGeoLookup.java",
                "sha": "37ed9f72f6efc32ae9c29d23cb0b0a417b9e320e",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d/core/src/test/java/brooklyn/location/geo/HostGeoLookupIntegrationTest.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/location/geo/HostGeoLookupIntegrationTest.java?ref=6e7a4ee5fef8b5455695f7a930947c3b9a77f11d",
                "deletions": 3,
                "filename": "core/src/test/java/brooklyn/location/geo/HostGeoLookupIntegrationTest.java",
                "patch": "@@ -36,16 +36,21 @@\n     \n     @Test(groups = \"Integration\")\n     public void testLocalhostGetsLocation() throws Exception {\n-        SshMachineLocation l = new LocalhostMachineProvisioningLocation().obtain();\n+        LocalhostMachineProvisioningLocation ll = new LocalhostMachineProvisioningLocation();\n+        SshMachineLocation l = ll.obtain();\n         HostGeoInfo geo = HostGeoInfo.fromLocation(l);\n+        Assert.assertNotNull(geo, \"host lookup unavailable - is the maxmind database installed? or else network unavailable or too slow?\");\n         log.info(\"localhost is in \"+geo);\n         Assert.assertNotNull(geo, \"couldn't load data; must have a valid HostGeoLookup impl (e.g. MaxMind installed, or online and with Utrace credit)\");\n         Assert.assertTrue(-90 <= geo.latitude && geo.latitude <= 90); \n+        ll.close();\n     }\n \n-    @Test(groups = \"Integration\")\n+    @Deprecated // see GeoBytesHostGeoLookup - their API changed\n+    @Test(groups = \"Integration\", enabled=false)\n     public void testGeobytesLookup() throws Exception {\n         HostGeoInfo geo = new GeoBytesHostGeoLookup().getHostGeoInfo(InetAddress.getByName(\"geobytes.com\"));\n+        Assert.assertNotNull(geo, \"host lookup unavailable\");\n         Assert.assertEquals(geo.displayName, \"Baltimore (US)\");\n         Assert.assertEquals(geo.latitude, 39.2894, 0.1);\n         Assert.assertEquals(geo.longitude, -76.6384, 0.1);\n@@ -54,14 +59,16 @@ public void testGeobytesLookup() throws Exception {\n     @Test(groups = \"Integration\")\n     public void testUtraceLookup() throws Exception {\n         HostGeoInfo geo = new UtraceHostGeoLookup().getHostGeoInfo(InetAddress.getByName(\"utrace.de\"));\n+        Assert.assertNotNull(geo, \"host lookup unavailable - maybe network not available \");\n         Assert.assertTrue(geo.displayName.contains(\"(DE)\"));\n         Assert.assertEquals(geo.latitude, 51, 2);\n         Assert.assertEquals(geo.longitude, 9, 5);\n     }\n \n-    @Test(groups = \"Integration\")\n+    @Test(groups = \"Integration\")  // only works if maxmind database is installed to ~/.brooklyn/\n     public void testMaxmindLookup() throws Exception {\n         HostGeoInfo geo = new MaxMind2HostGeoLookup().getHostGeoInfo(InetAddress.getByName(\"maxmind.com\"));\n+        Assert.assertNotNull(geo, \"host lookup unavailable - is the maxmind database installed?\");\n         log.info(\"maxmind.com at \"+geo);\n         \n         // used to be Washington; now Dallas - in case this changes again, we will accept either!",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6e7a4ee5fef8b5455695f7a930947c3b9a77f11d/core/src/test/java/brooklyn/location/geo/HostGeoLookupIntegrationTest.java",
                "sha": "85acb6d69e79afe85fc174ad0d83e9028cd4c3ff",
                "status": "modified"
            }
        ],
        "message": "minor geo-lookup fixes\n\noccasional NPE in utrace lookup, deprecate geobytes lookup whose api has changed, better messages in integration test",
        "parent": "https://github.com/apache/brooklyn-server/commit/01eb041e13e39ab5c88adbf9c8099a7dd6fa751d",
        "patched_files": [
            "UtraceHostGeoLookup.java",
            "GeoBytesHostGeoLookup.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "HostGeoLookupIntegrationTest.java"
        ]
    },
    "brooklyn-server_6f7eed1": {
        "bug_id": "brooklyn-server_6f7eed1",
        "commit": "https://github.com/apache/brooklyn-server/commit/6f7eed11b173274f4087a9e12dd314339fa36177",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/entity/basic/EntityTransientCopyInternal.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/EntityTransientCopyInternal.java?ref=6f7eed11b173274f4087a9e12dd314339fa36177",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/entity/basic/EntityTransientCopyInternal.java",
                "patch": "@@ -37,6 +37,7 @@\n import brooklyn.entity.rebind.RebindSupport;\n import brooklyn.event.AttributeSensor;\n import brooklyn.location.Location;\n+import brooklyn.management.ExecutionContext;\n import brooklyn.management.ManagementContext;\n import brooklyn.management.internal.EntityManagementSupport;\n import brooklyn.mementos.EntityMemento;\n@@ -102,5 +103,7 @@\n     Effector<?> getEffector(String effectorName);\n     FeedSupport getFeedSupport();\n     RebindSupport<EntityMemento> getRebindSupport();\n+    // for REST calls on read-only entities which want to resolve values\n+    ExecutionContext getExecutionContext();\n     \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/entity/basic/EntityTransientCopyInternal.java",
                "sha": "3ca2d544f27be373b78031ad3754d0d51ee133ca",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/location/basic/LocalhostMachineProvisioningLocation.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/LocalhostMachineProvisioningLocation.java?ref=6f7eed11b173274f4087a9e12dd314339fa36177",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/location/basic/LocalhostMachineProvisioningLocation.java",
                "patch": "@@ -256,6 +256,11 @@ public LocalhostMachine(Map properties) {\n             super(MutableMap.builder().putAll(properties).put(\"mutexSupport\", mutexSupport).build());\n         }\n         \n+        @Override\n+        protected WithMutexes getMutexSupport() {\n+            return mutexSupport;\n+        }\n+        \n         public boolean obtainSpecificPort(int portNumber) {\n             if (!isSudoAllowed() && portNumber <= 1024)\n                 return false;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/location/basic/LocalhostMachineProvisioningLocation.java",
                "sha": "113fb67e84bf0683ecf407367cc4a0db487630e5",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java?ref=6f7eed11b173274f4087a9e12dd314339fa36177",
                "deletions": 9,
                "filename": "core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "patch": "@@ -140,8 +140,11 @@\n     @SetFromFlag(nullable = false)\n     protected InetAddress address;\n \n+    // TODO should not allow this to be set from flag; it is not persisted so that will be lost\n+    // (mainly used for localhost currently so not a big problem)\n+    @Nullable  // lazily initialized; use getMutexSupport()\n     @SetFromFlag\n-    protected transient WithMutexes mutexSupport;\n+    private transient WithMutexes mutexSupport;\n \n     @SetFromFlag\n     private Set<Integer> usedPorts;\n@@ -336,10 +339,6 @@ public SshMachineLocation configure(Map properties) {\n         // TODO Note that check for addresss!=null is done automatically in super-constructor, in FlagUtils.checkRequiredFields\n         // Yikes, dangerous code for accessing fields of sub-class in super-class' constructor! But getting away with it so far!\n \n-        if (mutexSupport == null) {\n-            mutexSupport = new MutexSupport();\n-        }\n-\n         boolean deferConstructionChecks = (properties.containsKey(\"deferConstructionChecks\") && TypeCoercions.coerce(properties.get(\"deferConstructionChecks\"), Boolean.class));\n         if (!deferConstructionChecks) {\n             if (getDisplayName() == null) {\n@@ -349,6 +348,17 @@ public SshMachineLocation configure(Map properties) {\n         return this;\n     }\n     \n+    private transient final Object mutexSupportCreationLock = new Object();\n+    protected WithMutexes getMutexSupport() {\n+        synchronized (mutexSupportCreationLock) {\n+            // create on demand so that it is not null after serialization\n+            if (mutexSupport == null) {\n+                mutexSupport = new MutexSupport();\n+            }\n+            return mutexSupport;\n+        }\n+    }\n+    \n     protected void addSshPoolCacheCleanupTask() {\n         if (cleanupTask!=null && !cleanupTask.isDone()) {\n             return;\n@@ -895,25 +905,25 @@ protected MachineDetails inferMachineDetails() {\n     @Override\n     public void acquireMutex(String mutexId, String description) throws RuntimeInterruptedException {\n         try {\n-            mutexSupport.acquireMutex(mutexId, description);\n+            getMutexSupport().acquireMutex(mutexId, description);\n         } catch (InterruptedException ie) {\n             throw new RuntimeInterruptedException(\"Interrupted waiting for mutex: \" + mutexId, ie);\n         }\n     }\n \n     @Override\n     public boolean tryAcquireMutex(String mutexId, String description) {\n-        return mutexSupport.tryAcquireMutex(mutexId, description);\n+        return getMutexSupport().tryAcquireMutex(mutexId, description);\n     }\n \n     @Override\n     public void releaseMutex(String mutexId) {\n-        mutexSupport.releaseMutex(mutexId);\n+        getMutexSupport().releaseMutex(mutexId);\n     }\n \n     @Override\n     public boolean hasMutex(String mutexId) {\n-        return mutexSupport.hasMutex(mutexId);\n+        return getMutexSupport().hasMutex(mutexId);\n     }\n \n     //We want the SshMachineLocation to be serializable and therefore the pool needs to be dealt with correctly.",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "sha": "2bf81f967c41aca4fb9428e9b98727707f030109",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/management/internal/LocalLocationManager.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/LocalLocationManager.java?ref=6f7eed11b173274f4087a9e12dd314339fa36177",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/management/internal/LocalLocationManager.java",
                "patch": "@@ -376,7 +376,7 @@ private synchronized void unmanageNonRecursiveOnlyClearItsFields(Location loc, M\n             // if not destroying, don't change the parent's children list\n             ((AbstractLocation)loc).setParent(null, false);\n         }\n-        // clear config to help with GC\n+        // clear config to help with GC; i know you're not supposed to, but this seems to help, else config bag is littered with refs to entities etc\n         ((AbstractLocation)loc).getLocalConfigBag().clear();\n     }\n     ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6f7eed11b173274f4087a9e12dd314339fa36177/core/src/main/java/brooklyn/management/internal/LocalLocationManager.java",
                "sha": "f1da1142c0d0ac3b38b9fc5608a1d3863a4fa44c",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/6f7eed11b173274f4087a9e12dd314339fa36177/usage/rest-server/src/main/java/brooklyn/rest/resources/ApplicationResource.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-server/src/main/java/brooklyn/rest/resources/ApplicationResource.java?ref=6f7eed11b173274f4087a9e12dd314339fa36177",
                "deletions": 2,
                "filename": "usage/rest-server/src/main/java/brooklyn/rest/resources/ApplicationResource.java",
                "patch": "@@ -47,6 +47,7 @@\n import brooklyn.entity.Application;\n import brooklyn.entity.Entity;\n import brooklyn.entity.Group;\n+import brooklyn.entity.basic.AbstractGroup;\n import brooklyn.entity.basic.Attributes;\n import brooklyn.entity.basic.Lifecycle;\n import brooklyn.entity.trait.Startable;\n@@ -144,8 +145,12 @@ private JsonNode fromEntity(Entity entity) {\n         if (!entity.getChildren().isEmpty())\n             aRoot.put(\"children\", entitiesIdAndNameAsArray(entity.getChildren()));\n \n-        if ((entity instanceof Group) && !((Group) entity).getMembers().isEmpty())\n-            aRoot.put(\"members\", entitiesIdAndNameAsArray(((Group) entity).getMembers()));\n+        if (entity instanceof Group) {\n+            // use attribute instead of method in case it is read-only\n+            Collection<Entity> members = entity.getAttribute(AbstractGroup.GROUP_MEMBERS);\n+            if (members!=null && !members.isEmpty())\n+                aRoot.put(\"members\", entitiesIdAndNameAsArray(members));\n+        }\n \n         return aRoot;\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/6f7eed11b173274f4087a9e12dd314339fa36177/usage/rest-server/src/main/java/brooklyn/rest/resources/ApplicationResource.java",
                "sha": "6b9be050698f67898fd2cfc1afce7a72faabce22",
                "status": "modified"
            }
        ],
        "message": "fix misc errors during hot standby (access to unavailable methods, clearing more things on location unmanagement) and after rebind (NPE in SshMachineLocation), and fix sensor logic bug in tomcat",
        "parent": "https://github.com/apache/brooklyn-server/commit/d542630d30559845b7247a67c1e75e148b4107d4",
        "patched_files": [
            "SshMachineLocation.java",
            "ApplicationResource.java",
            "LocalhostMachineProvisioningLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "LocalhostMachineProvisioningLocationTest.java",
            "SshMachineLocationTest.java",
            "ApplicationResourceTest.java"
        ]
    },
    "brooklyn-server_7a602e8": {
        "bug_id": "brooklyn-server_7a602e8",
        "commit": "https://github.com/apache/brooklyn-server/commit/7a602e883bc7bca24da8ea288f483dca949d7546",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/7a602e883bc7bca24da8ea288f483dca949d7546/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=7a602e883bc7bca24da8ea288f483dca949d7546",
                "deletions": 3,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -1290,11 +1290,13 @@ public Template buildTemplate(ComputeService computeService, ConfigBag config) {\n \n         // Finally try to build the template\n         Template template;\n+        Image image;\n         try {\n             template = templateBuilder.build();\n             if (template==null) throw new NullPointerException(\"No template found (templateBuilder.build returned null)\");\n-            LOG.debug(\"jclouds found template \"+template+\" (image \"+template.getImage()+\") for provisioning in \"+this+\" for \"+config.getDescription());\n-            if (template.getImage()==null) throw new NullPointerException(\"Template does not contain an image (templateBuilder.build returned invalid template)\");\n+            image = template.getImage();\n+            LOG.debug(\"jclouds found template \"+template+\" (image \"+image+\") for provisioning in \"+this+\" for \"+config.getDescription());\n+            if (image==null) throw new NullPointerException(\"Template does not contain an image (templateBuilder.build returned invalid template)\");\n         } catch (AuthorizationException e) {\n             LOG.warn(\"Error resolving template: not authorized (rethrowing: \"+e+\")\");\n             throw new IllegalStateException(\"Not authorized to access cloud \"+this+\" to resolve \"+templateBuilder, e);\n@@ -1319,7 +1321,8 @@ public Template buildTemplate(ComputeService computeService, ConfigBag config) {\n         }\n         TemplateOptions options = template.getOptions();\n \n-        if (template.getImage().getOperatingSystem().getFamily().equals(OsFamily.WINDOWS)) {\n+        OsFamily osFamily = (image.getOperatingSystem() != null) ? image.getOperatingSystem().getFamily() : null;\n+        if (OsFamily.WINDOWS == osFamily) {\n             if (!(config.containsKey(JcloudsLocationConfig.USER_METADATA_STRING) || config.containsKey(JcloudsLocationConfig.USER_METADATA_MAP))) {\n                 config.put(JcloudsLocationConfig.USER_METADATA_STRING, WinRmMachineLocation.getDefaultUserMetadataString());\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/7a602e883bc7bca24da8ea288f483dca949d7546/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "23b79eda356903266026e7d71d493c5206300616",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when jclouds image does not have OsFamily",
        "parent": "https://github.com/apache/brooklyn-server/commit/5f6b47cf2f39f06697fbc31017d02d226f0b9dd1",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_7b809ed": {
        "bug_id": "brooklyn-server_7b809ed",
        "commit": "https://github.com/apache/brooklyn-server/commit/7b809ed557c280775278bd642f49e7e8ac626fa8",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/7b809ed557c280775278bd642f49e7e8ac626fa8/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=7b809ed557c280775278bd642f49e7e8ac626fa8",
                "deletions": 4,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -1242,10 +1242,15 @@ protected LoginCredentials createUser(ComputeService computeService, NodeMetadat\n         UserCreation userCreation = createUserStatements(image, config);\n         \n         if (!userCreation.statements.isEmpty()) {\n-            org.jclouds.compute.domain.OsFamily osFamily = node.getOperatingSystem().getFamily();\n-            org.jclouds.scriptbuilder.domain.OsFamily scriptOsFamily = (osFamily == org.jclouds.compute.domain.OsFamily.WINDOWS) \n-                    ? org.jclouds.scriptbuilder.domain.OsFamily.WINDOWS\n-                    : org.jclouds.scriptbuilder.domain.OsFamily.UNIX;\n+            // If unsure of OS family, default to unix for rendering statements.\n+            org.jclouds.scriptbuilder.domain.OsFamily scriptOsFamily;\n+            if (node.getOperatingSystem() == null) {\n+                scriptOsFamily = org.jclouds.scriptbuilder.domain.OsFamily.UNIX;\n+            } else {\n+                scriptOsFamily = (node.getOperatingSystem().getFamily() == org.jclouds.compute.domain.OsFamily.WINDOWS) \n+                        ? org.jclouds.scriptbuilder.domain.OsFamily.WINDOWS\n+                        : org.jclouds.scriptbuilder.domain.OsFamily.UNIX;\n+            }\n             \n             List<String> commands = Lists.newArrayList();\n             for (Statement statement : userCreation.statements) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/7b809ed557c280775278bd642f49e7e8ac626fa8/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "cafe1c7c54a9f7d12809c8d68f2864bf1fb78044",
                "status": "modified"
            }
        ],
        "message": "JcloudsLocation: avoid NPE on user-creation\n\nIf jclouds node doesn\u2019t know its operatingSystem, then was\ngetting NPE. Guard against that, and default to unix.",
        "parent": "https://github.com/apache/brooklyn-server/commit/145e800b6fbfc78b1916f73246b39ee3da827874",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_7d2bed5": {
        "bug_id": "brooklyn-server_7d2bed5",
        "commit": "https://github.com/apache/brooklyn-server/commit/7d2bed5ceddc5a7a22214d9890b250fe548f49b2",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/7d2bed5ceddc5a7a22214d9890b250fe548f49b2/utils/common/src/main/java/brooklyn/util/text/Strings.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/text/Strings.java?ref=7d2bed5ceddc5a7a22214d9890b250fe548f49b2",
                "deletions": 0,
                "filename": "utils/common/src/main/java/brooklyn/util/text/Strings.java",
                "patch": "@@ -181,6 +181,7 @@ public static String removeAllFromStart(String string, String ...prefixes) {\n \n     /** convenience for {@link com.google.common.base.Joiner} */\n     public static String join(Iterable<? extends Object> list, String seperator) {\n+        if (list==null) return null;\n         boolean app = false;\n         StringBuilder out = new StringBuilder();\n         for (Object s: list) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/7d2bed5ceddc5a7a22214d9890b250fe548f49b2/utils/common/src/main/java/brooklyn/util/text/Strings.java",
                "sha": "c619565c38c9dce58704e179d0a81271808c8240",
                "status": "modified"
            }
        ],
        "message": "strings.join does not throw NPE\n\nuseful when using the joiner enricher if the inputted list is null",
        "parent": "https://github.com/apache/brooklyn-server/commit/c489122bb4678860d7715cf25871c20760006ee0",
        "patched_files": [
            "Strings.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "StringsTest.java"
        ]
    },
    "brooklyn-server_7f32d2a": {
        "bug_id": "brooklyn-server_7f32d2a",
        "commit": "https://github.com/apache/brooklyn-server/commit/7f32d2a4d8e6420d2e133a7d7ff5b95eb5caf8b3",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/7f32d2a4d8e6420d2e133a7d7ff5b95eb5caf8b3/core/src/main/java/brooklyn/entity/basic/Entities.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/Entities.java?ref=7f32d2a4d8e6420d2e133a7d7ff5b95eb5caf8b3",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/entity/basic/Entities.java",
                "patch": "@@ -1022,7 +1022,7 @@ public static void waitForServiceUp(final Entity entity, Duration timeout) {\n                     .rethrowException().backoffTo(Duration.ONE_SECOND)\n                     .until(new Callable<Boolean>() {\n                         public Boolean call() {\n-                            return entity.getAttribute(Startable.SERVICE_UP);\n+                            return Boolean.TRUE.equals(entity.getAttribute(Startable.SERVICE_UP));\n                         }})\n                     .run()) {\n                 throw new IllegalStateException(\"Timeout waiting for SERVICE_UP from \"+entity);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/7f32d2a4d8e6420d2e133a7d7ff5b95eb5caf8b3/core/src/main/java/brooklyn/entity/basic/Entities.java",
                "sha": "51f86f67075c10f8489008ac25105e27364a8f67",
                "status": "modified"
            }
        ],
        "message": "Fix Entities.waitForServiceUp to avoid NPE\n\n- Never return null for repeater\u2019s `until`; always return TRUE or FALSE.\n  Otherwise it will NPE.",
        "parent": "https://github.com/apache/brooklyn-server/commit/445906abcb7ba34aabfa49f57c5d7e859868ace1",
        "patched_files": [
            "Entities.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "EntitiesTest.java"
        ]
    },
    "brooklyn-server_7fc4c7e": {
        "bug_id": "brooklyn-server_7fc4c7e",
        "commit": "https://github.com/apache/brooklyn-server/commit/7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java?ref=7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4",
                "deletions": 1,
                "filename": "core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "patch": "@@ -50,6 +50,7 @@\n     private static class IsSecretPredicate implements Predicate<Object> {\n         @Override\n         public boolean apply(Object name) {\n+            if (name == null) return false;\n             String lowerName = name.toString().toLowerCase();\n             for (String secretName : SECRET_NAMES) {\n                 if (lowerName.contains(secretName))\n@@ -69,6 +70,7 @@ public boolean apply(Object name) {\n     private static final Predicate<Object> IS_SECRET_PREDICATE_DEPRECATED = new Predicate<Object>() {\n         @Override\n         public boolean apply(Object name) {\n+            if (name == null) return false;\n             String lowerName = name.toString().toLowerCase();\n             for (String secretName : SECRET_NAMES) {\n                 if (lowerName.contains(secretName))\n@@ -111,7 +113,7 @@ private Sanitizer(Predicate<Object> sanitizingNeededCheck) {\n     private <K> Map<K, Object> apply(Map<K, ?> input, Set<Object> visited) {\n         Map<K, Object> result = Maps.newLinkedHashMap();\n         for (Map.Entry<K, ?> e : input.entrySet()) {\n-            if (predicate.apply(e.getKey())){\n+            if (e.getKey() != null && predicate.apply(e.getKey())){\n                 result.put(e.getKey(), \"xxxxxxxx\");\n                 continue;\n             } ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4/core/src/main/java/org/apache/brooklyn/core/config/Sanitizer.java",
                "sha": "99cba902c08f3f51982872bae7abbdc61842feb7",
                "status": "modified"
            },
            {
                "additions": 31,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4/core/src/test/java/org/apache/brooklyn/core/entity/SanitizerTest.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/org/apache/brooklyn/core/entity/SanitizerTest.java?ref=7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4",
                "deletions": 2,
                "filename": "core/src/test/java/org/apache/brooklyn/core/entity/SanitizerTest.java",
                "patch": "@@ -23,16 +23,45 @@\n import java.util.Map;\n \n import org.apache.brooklyn.core.config.Sanitizer;\n+import org.apache.brooklyn.util.collections.MutableMap;\n import org.apache.brooklyn.util.core.config.ConfigBag;\n import org.testng.annotations.Test;\n \n+import com.google.common.base.Functions;\n import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n \n public class SanitizerTest {\n \n     @Test\n     public void testSanitize() throws Exception {\n-        Map<String, Object> sanitized = Sanitizer.sanitize(ConfigBag.newInstance(ImmutableMap.of(\"password\", \"pa55w0rd\", \"mykey\", \"myval\")));\n-        assertEquals(sanitized, ImmutableMap.of(\"password\", \"xxxxxxxx\", \"mykey\", \"myval\"));\n+        Map<String, Object> map = ImmutableMap.<String, Object>builder()\n+                .put(\"PREFIX_password_SUFFIX\", \"pa55w0rd\")\n+                .put(\"PREFIX_PASSWORD_SUFFIX\", \"pa55w0rd\")\n+                .put(\"PREFIX_passwd_SUFFIX\", \"pa55w0rd\")\n+                .put(\"PREFIX_credential_SUFFIX\", \"pa55w0rd\")\n+                .put(\"PREFIX_secret_SUFFIX\", \"pa55w0rd\")\n+                .put(\"PREFIX_private_SUFFIX\", \"pa55w0rd\")\n+                .put(\"PREFIX_access.cert_SUFFIX\", \"myval\")\n+                .put(\"PREFIX_access.key_SUFFIX\", \"myval\")\n+                .put(\"mykey\", \"myval\")\n+                .build();\n+        Map<String, Object> expected = MutableMap.<String, Object>builder()\n+                .putAll(Maps.transformValues(map, Functions.constant(\"xxxxxxxx\")))\n+                .put(\"mykey\", \"myval\")\n+                .build();\n+        \n+        Map<String, Object> sanitized = Sanitizer.sanitize(ConfigBag.newInstance(map));\n+        assertEquals(sanitized, expected);\n+        \n+        Map<String, Object> sanitized2 = Sanitizer.sanitize(map);\n+        assertEquals(sanitized2, expected);\n+    }\n+    \n+    @Test\n+    public void testSanitizeWithNullKey() throws Exception {\n+        MutableMap<?, ?> map = MutableMap.of(null, null);\n+        Map<?, ?> sanitized = Sanitizer.sanitize(map);\n+        assertEquals(sanitized, map);\n     }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/7fc4c7e64b56d7d1d4af8a88f69044352bfa4de4/core/src/test/java/org/apache/brooklyn/core/entity/SanitizerTest.java",
                "sha": "f63b40d23e6f86286b8d024a0536c44dcd8bdfbe",
                "status": "modified"
            }
        ],
        "message": "Sanitizer: avoid NPE if sanitize null key",
        "parent": "https://github.com/apache/brooklyn-server/commit/42249632cf37bd8bcb4d68a70432f9003396bd0c",
        "patched_files": [
            "Sanitizer.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "SanitizerTest.java"
        ]
    },
    "brooklyn-server_86b4fe4": {
        "bug_id": "brooklyn-server_86b4fe4",
        "commit": "https://github.com/apache/brooklyn-server/commit/86b4fe4440d46431476618bcbda2c1c219f4db2e",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/86b4fe4440d46431476618bcbda2c1c219f4db2e/core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java?ref=86b4fe4440d46431476618bcbda2c1c219f4db2e",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java",
                "patch": "@@ -275,15 +275,22 @@ public T call() {\n \n     protected abstract <T> Task<T> runAtEntity(final Entity entity, final Effector<T> eff, @SuppressWarnings(\"rawtypes\") final Map parameters);\n \n+    @Override\n     public abstract void addEntitySetListener(CollectionChangeListener<Entity> listener);\n \n+    @Override\n     public abstract void removeEntitySetListener(CollectionChangeListener<Entity> listener);\n     \n     @Override\n     public StringConfigMap getConfig() {\n         return configMap;\n     }\n \n+    @Override\n+    public BrooklynProperties getBrooklynProperties() {\n+        return configMap;\n+    }\n+\n     @Override\n     public synchronized LocationRegistry getLocationRegistry() {\n         if (locationRegistry==null) locationRegistry = new BasicLocationRegistry(this);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/86b4fe4440d46431476618bcbda2c1c219f4db2e/core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java",
                "sha": "d5d353fba9804d284eef2177a3a8bc3d906d21dd",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/86b4fe4440d46431476618bcbda2c1c219f4db2e/core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java?ref=86b4fe4440d46431476618bcbda2c1c219f4db2e",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java",
                "patch": "@@ -4,6 +4,7 @@\n import java.util.Map;\n import java.util.concurrent.ExecutionException;\n \n+import brooklyn.config.BrooklynProperties;\n import brooklyn.config.ConfigKey;\n import brooklyn.entity.Effector;\n import brooklyn.entity.Entity;\n@@ -41,4 +42,6 @@\n     <T> Task<T> invokeEffector(final Entity entity, final Effector<T> eff, @SuppressWarnings(\"rawtypes\") final Map parameters);\n \n     BrooklynStorage getStorage();\n+    \n+    BrooklynProperties getBrooklynProperties();\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/86b4fe4440d46431476618bcbda2c1c219f4db2e/core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java",
                "sha": "57139e3bdab9edee45c896b93b7045ed93ed61e3",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/86b4fe4440d46431476618bcbda2c1c219f4db2e/core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java?ref=86b4fe4440d46431476618bcbda2c1c219f4db2e",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java",
                "patch": "@@ -13,6 +13,7 @@\n import java.util.concurrent.TimeoutException;\n \n import brooklyn.catalog.BrooklynCatalog;\n+import brooklyn.config.BrooklynProperties;\n import brooklyn.config.StringConfigMap;\n import brooklyn.entity.Application;\n import brooklyn.entity.Effector;\n@@ -154,6 +155,12 @@ public StringConfigMap getConfig() {\n         return initialManagementContext.getConfig();\n     }\n \n+    @Override\n+    public BrooklynProperties getBrooklynProperties() {\n+        checkInitialManagementContextReal();\n+        return initialManagementContext.getBrooklynProperties();\n+    }\n+\n     @Override\n     public BrooklynStorage getStorage() {\n         checkInitialManagementContextReal();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/86b4fe4440d46431476618bcbda2c1c219f4db2e/core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java",
                "sha": "a4ef9b798647a2ae906645253f025f7a4ebffa57",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/86b4fe4440d46431476618bcbda2c1c219f4db2e/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java?ref=86b4fe4440d46431476618bcbda2c1c219f4db2e",
                "deletions": 0,
                "filename": "usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "patch": "@@ -331,7 +331,10 @@ protected BrooklynLauncher doLaunch() {\n                 brooklynProperties = builder.build();\n             }\n             managementContext = new LocalManagementContext(brooklynProperties);\n+        } else if (brooklynProperties == null) {\n+            brooklynProperties = ((ManagementContextInternal)managementContext).getBrooklynProperties();\n         }\n+        \n         for (Map.Entry<String, Object> entry : brooklynAdditionalProperties.entrySet()) {\n             brooklynProperties.put(entry.getKey(), entry.getValue());\n         }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/86b4fe4440d46431476618bcbda2c1c219f4db2e/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "sha": "20425ed86bae779fc9d849ff5416e9e5f4bf55a6",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #920 from aledsage/fix/BrooklynLauncher-supplying-ManagementContext\n\nFix NPE when BrooklynLauncher given ManagementContext",
        "parent": "https://github.com/apache/brooklyn-server/commit/4f9a75304670074c3b7fb111c9918994a170510d",
        "patched_files": [
            "BrooklynLauncher.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BrooklynLauncherTest.java"
        ]
    },
    "brooklyn-server_88cc87c": {
        "bug_id": "brooklyn-server_88cc87c",
        "commit": "https://github.com/apache/brooklyn-server/commit/88cc87c5dfbe248556a616277143d5879cf32519",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/88cc87c5dfbe248556a616277143d5879cf32519/core/src/main/java/brooklyn/entity/basic/EntityDynamicType.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/EntityDynamicType.java?ref=88cc87c5dfbe248556a616277143d5879cf32519",
                "deletions": 5,
                "filename": "core/src/main/java/brooklyn/entity/basic/EntityDynamicType.java",
                "patch": "@@ -24,10 +24,10 @@\n import brooklyn.entity.EntityType;\n import brooklyn.entity.effector.EffectorAndBody;\n import brooklyn.entity.effector.EffectorBody;\n-import brooklyn.entity.effector.EffectorWithBody;\n-import brooklyn.entity.effector.Effectors;\n import brooklyn.entity.effector.EffectorTasks.EffectorBodyTaskFactory;\n import brooklyn.entity.effector.EffectorTasks.EffectorTaskFactory;\n+import brooklyn.entity.effector.EffectorWithBody;\n+import brooklyn.entity.effector.Effectors;\n import brooklyn.event.Sensor;\n import brooklyn.event.basic.BasicConfigKey.BasicConfigKeyOverwriting;\n import brooklyn.util.flags.FlagUtils;\n@@ -87,15 +87,15 @@ private EntityDynamicType(Class<? extends Entity> clazz, AbstractEntity entity)\n         setName((clazz.getCanonicalName() == null) ? clazz.getName() : clazz.getCanonicalName());\n         String id = entity==null ? clazz.getName() : entity.getId();\n         \n-        effectors.putAll(findEffectors(clazz, entity));\n+        effectors.putAll(findEffectors(clazz, null));\n         if (LOG.isTraceEnabled())\n             LOG.trace(\"Entity {} effectors: {}\", id, Joiner.on(\", \").join(effectors.keySet()));\n         \n-        sensors.putAll(findSensors(clazz, entity));\n+        sensors.putAll(findSensors(clazz, null));\n         if (LOG.isTraceEnabled())\n             LOG.trace(\"Entity {} sensors: {}\", id, Joiner.on(\", \").join(sensors.keySet()));\n         \n-        buildConfigKeys(clazz, entity, configKeys);\n+        buildConfigKeys(clazz, null, configKeys);\n         if (LOG.isTraceEnabled())\n             LOG.trace(\"Entity {} config keys: {}\", id, Joiner.on(\", \").join(configKeys.keySet()));\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/88cc87c5dfbe248556a616277143d5879cf32519/core/src/main/java/brooklyn/entity/basic/EntityDynamicType.java",
                "sha": "69615fdfa39f66981dd9081f2f6318ee53c1f20f",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/88cc87c5dfbe248556a616277143d5879cf32519/core/src/test/java/brooklyn/entity/basic/EntityTypeTest.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/basic/EntityTypeTest.java?ref=88cc87c5dfbe248556a616277143d5879cf32519",
                "deletions": 3,
                "filename": "core/src/test/java/brooklyn/entity/basic/EntityTypeTest.java",
                "patch": "@@ -1,12 +1,12 @@\n package brooklyn.entity.basic;\n \n+import static brooklyn.entity.basic.AbstractEntity.EFFECTOR_ADDED;\n+import static brooklyn.entity.basic.AbstractEntity.EFFECTOR_CHANGED;\n+import static brooklyn.entity.basic.AbstractEntity.EFFECTOR_REMOVED;\n import static brooklyn.entity.basic.AbstractEntity.POLICY_ADDED;\n import static brooklyn.entity.basic.AbstractEntity.POLICY_REMOVED;\n import static brooklyn.entity.basic.AbstractEntity.SENSOR_ADDED;\n import static brooklyn.entity.basic.AbstractEntity.SENSOR_REMOVED;\n-import static brooklyn.entity.basic.AbstractEntity.EFFECTOR_ADDED;\n-import static brooklyn.entity.basic.AbstractEntity.EFFECTOR_REMOVED;\n-import static brooklyn.entity.basic.AbstractEntity.EFFECTOR_CHANGED;\n import static org.testng.Assert.assertEquals;\n import static org.testng.Assert.assertFalse;\n import static org.testng.Assert.assertNotNull;\n@@ -31,6 +31,7 @@\n import brooklyn.test.TestUtils;\n import brooklyn.test.entity.TestApplication;\n import brooklyn.test.entity.TestEntity;\n+import brooklyn.test.entity.TestEntityImpl;\n import brooklyn.util.collections.CollectionFunctionals;\n import brooklyn.util.collections.MutableSet;\n \n@@ -221,4 +222,28 @@ public void testHasSensor() throws Exception {\n         assertTrue(entity.getEntityType().hasSensor(\"entity.sensor.added\"));\n         assertFalse(entity.getEntityType().hasSensor(\"does.not.exist\"));\n     }\n+    \n+    // Previously EntityDynamicType's constructor when passed `entity` during the entity's construction (!)\n+    // would pass this to EntityDynamicType.findEffectors, which would do log.warn in some cirumstances,\n+    // with entity.toString as part of the log message. But if the toString called getConfig() this would \n+    // fail because we were still in the middle of constructing the entity.entityType!\n+    @Test\n+    public void testEntityDynamicTypeDoesNotCallToStringDuringConstruction() throws Exception {\n+        entity = app.createAndManageChild(EntitySpec.create(TestEntity.class).impl(EntityWithToStringAccessingConfig.class));\n+        entity.toString();\n+    }\n+    \n+    public static class EntityWithToStringAccessingConfig extends TestEntityImpl {\n+        \n+        // to cause warning to be logged: non-static constant\n+        public final MethodEffector<Void> NON_STATIC_EFFECTOR = new MethodEffector<Void>(EntityWithToStringAccessingConfig.class, \"nonStaticEffector\");\n+\n+        public void nonStaticEffector() {\n+        }\n+        \n+        @Override\n+        public String toString() {\n+            return super.toString() + getConfig(CONF_NAME);\n+        }\n+    }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/88cc87c5dfbe248556a616277143d5879cf32519/core/src/test/java/brooklyn/entity/basic/EntityTypeTest.java",
                "sha": "9f62dca25504e983b4025da632a70c63f1205b08",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/88cc87c5dfbe248556a616277143d5879cf32519/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=88cc87c5dfbe248556a616277143d5879cf32519",
                "deletions": 6,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -88,6 +88,7 @@\n import com.google.common.base.Function;\n import com.google.common.base.Objects;\n import com.google.common.base.Splitter;\n+import com.google.common.base.Stopwatch;\n import com.google.common.base.Throwables;\n import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableMap;\n@@ -1150,11 +1151,10 @@ protected void waitForReachable(final ComputeService computeService, NodeMetadat\n             delayMs = Time.parseTimeString(WAIT_FOR_SSHABLE.getDefaultValue());\n         \n         String user = expectedCredentialsRef.getUser();\n-        LOG.info(\"Started VM in {}; waiting {} for it to be sshable on {}@{}{}\",\n-                new Object[] {\n-                        setup.getDescription(),Time.makeTimeString(delayMs),\n-                        user, vmIp, Objects.equal(user, getUser(setup)) ? \"\" : \" (setup user is different: \"+getUser(setup)+\")\"\n-                });\n+        LOG.info(\"Started VM {}; waiting {} for it to be sshable on {}@{}{}\", new Object[] {\n+                setup.getDescription(), Time.makeTimeStringRounded(delayMs),\n+                user, vmIp, Objects.equal(user, getUser(setup)) ? \"\" : \" (setup user is different: \"+getUser(setup)+\")\"});\n+        Stopwatch stopwatch = new Stopwatch().start();\n         \n         boolean reachable = new Repeater()\n             .repeat()\n@@ -1173,8 +1173,12 @@ public Boolean call() {\n         if (!reachable) {\n             throw new IllegalStateException(\"SSH failed for \"+\n                     user+\"@\"+vmIp+\" (\"+setup.getDescription()+\") after waiting \"+\n-                    Time.makeTimeString(delayMs));\n+                    Time.makeTimeStringRounded(delayMs));\n         }\n+        \n+        LOG.info(\"VM {}; is sshable after {} on {}@{}\",new Object[] {\n+                setup.getDescription(), Time.makeTimeStringRounded(stopwatch),\n+                user, vmIp});\n     }\n     \n     // -------------------- hostnames ------------------------",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/88cc87c5dfbe248556a616277143d5879cf32519/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "818b50e91019f9b0da6f2941898f425a6b0515ba",
                "status": "modified"
            }
        ],
        "message": "Merge pull request #951 from aledsage/fix/NPE-EntityDynamicType-constructor-calling-entity.toString\n\nFix NPE when EntityDynamicType constructor calling entity.toString",
        "parent": "https://github.com/apache/brooklyn-server/commit/6c2624d948361f4a144df965ade963094b0d0253",
        "patched_files": [
            "JcloudsLocation.java",
            "EntityType.java",
            "EntityDynamicType.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java",
            "EntityTypeTest.java"
        ]
    },
    "brooklyn-server_8fe4140": {
        "bug_id": "brooklyn-server_8fe4140",
        "commit": "https://github.com/apache/brooklyn-server/commit/8fe4140936792581b311cff39510b84f06ee22a0",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/8fe4140936792581b311cff39510b84f06ee22a0/camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java?ref=8fe4140936792581b311cff39510b84f06ee22a0",
                "deletions": 2,
                "filename": "camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java",
                "patch": "@@ -32,14 +32,17 @@\n @Test\n public class EmptyWindowsProcessYamlTest extends AbstractYamlTest {\n \n-    @Test(groups=\"Integration\")\n+    // takes couple of seconds unfortunately (why?!), but our only unit-test coverage of \n+    // EmptyWindowsProcess so including in unit tests anyway.\n+    @Test\n     public void testNoWinrm() throws Exception {\n         Entity app = createAndStartApplication(\n                 \"location: byon:(hosts=\\\"1.2.3.4\\\",osFamily=windows)\",\n                 \"services:\",\n                 \"- type: \"+EmptyWindowsProcess.class.getName(),\n                 \"  brooklyn.config:\",\n-                \"    winrmMonitoring.enabled: false\");\n+                \"    winrmMonitoring.enabled: false\",\n+                \"    onbox.base.dir.skipResolution: true\");\n         waitForApplicationTasks(app);\n \n         EmptyWindowsProcess entity = Iterables.getOnlyElement(Entities.descendants(app, EmptyWindowsProcess.class));",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/8fe4140936792581b311cff39510b84f06ee22a0/camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java",
                "sha": "3eaa963589dd01e58f9495669bd90f36d71f14c2",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/8fe4140936792581b311cff39510b84f06ee22a0/software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java?ref=8fe4140936792581b311cff39510b84f06ee22a0",
                "deletions": 1,
                "filename": "software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java",
                "patch": "@@ -28,6 +28,8 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.google.common.base.Optional;\n+\n public class EmptyWindowsProcessWinRmDriver extends AbstractSoftwareProcessWinRmDriver implements VanillaWindowsProcessDriver {\n     @SuppressWarnings(\"unused\")\n     private static final Logger LOG = LoggerFactory.getLogger(EmptyWindowsProcessWinRmDriver.class);\n@@ -41,7 +43,8 @@ public EmptyWindowsProcessWinRmDriver(EmptyWindowsProcessImpl entity, WinRmMachi\n     @Override\n     public void start() {\n         WinRmMachineLocation machine = (WinRmMachineLocation) location;\n-        UserAndHostAndPort winrmAddress = UserAndHostAndPort.fromParts(machine.getUser(), machine.getAddress().getHostName(), entity.getConfig(WinRmTool.PROP_PORT));\n+        Integer port = entity.getConfig(WinRmTool.PROP_PORT);\n+        UserAndHostAndPort winrmAddress = UserAndHostAndPort.fromParts(machine.getUser(), machine.getAddress().getHostName(), Optional.fromNullable(port));\n         getEntity().sensors().set(Attributes.WINRM_ADDRESS, winrmAddress);\n \n         super.start();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/8fe4140936792581b311cff39510b84f06ee22a0/software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java",
                "sha": "c7842bae8c992a47b42cd6ae6b841b0911bd3a75",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/8fe4140936792581b311cff39510b84f06ee22a0/utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java?ref=8fe4140936792581b311cff39510b84f06ee22a0",
                "deletions": 0,
                "filename": "utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java",
                "patch": "@@ -21,6 +21,7 @@\n import java.io.Serializable;\n \n import com.google.common.base.Objects;\n+import com.google.common.base.Optional;\n import com.google.common.net.HostAndPort;\n \n public class UserAndHostAndPort implements Serializable {\n@@ -31,6 +32,14 @@ public static UserAndHostAndPort fromParts(String user, String host, int port) {\n         return new UserAndHostAndPort(user, HostAndPort.fromParts(host, port));\n     }\n \n+    public static UserAndHostAndPort fromParts(String user, String host, Optional<Integer> port) {\n+        HostAndPort hostAndPort = port.isPresent() ? HostAndPort.fromParts(host, port.get()) : HostAndPort.fromString(host);\n+        if (!port.isPresent() && hostAndPort.hasPort()) {\n+            throw new IllegalArgumentException(\"optional port absent, but host '\"+host+\"' parsed as containing port\");\n+        }\n+        return new UserAndHostAndPort(user, hostAndPort);\n+    }\n+\n     public static UserAndHostAndPort fromParts(String user, HostAndPort hostAndPort) {\n         return new UserAndHostAndPort(user, hostAndPort);\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/8fe4140936792581b311cff39510b84f06ee22a0/utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java",
                "sha": "558af0cb1a03a1372fa26148b73e0daa548259ae",
                "status": "modified"
            }
        ],
        "message": "BROOKLYN-303: Fix EmptyWindowsProcess\n\nPreviously gave NPE in driver",
        "parent": "https://github.com/apache/brooklyn-server/commit/82511c3b1602225f070258944935196174e8cd8b",
        "patched_files": [
            "EmptyWindowsProcessWinRmDriver.java",
            "UserAndHostAndPort.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "UserAndHostAndPortTest.java",
            "EmptyWindowsProcessYamlTest.java"
        ]
    },
    "brooklyn-server_961ad11": {
        "bug_id": "brooklyn-server_961ad11",
        "commit": "https://github.com/apache/brooklyn-server/commit/961ad11f9ed5e883b0c63c515775ac8981d4f063",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/AccessSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/AccessSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/AccessSummary.java",
                "patch": "@@ -38,7 +38,7 @@ public AccessSummary(\n             @JsonProperty(\"links\") Map<String, URI> links\n     ) {\n         this.locationProvisioningAllowed = locationProvisioningAllowed;\n-        this.links = links == null ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n+        this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n       }\n \n     public boolean isLocationProvisioningAllowed() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/AccessSummary.java",
                "sha": "68cc1b8f36e4fe55f6b466cc24f8518791789695",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/ApplicationSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/ApplicationSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/ApplicationSummary.java",
                "patch": "@@ -53,7 +53,7 @@ public ApplicationSummary(\n         this.id = id;\n         this.spec = checkNotNull(spec, \"spec\");\n         this.status = checkNotNull(status, \"status\");\n-        this.links = links == null ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n+        this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n     }\n \n     @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/ApplicationSummary.java",
                "sha": "fa06b82cd6a8ee0488be5d367aa3652332271449",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogItemSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogItemSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogItemSummary.java",
                "patch": "@@ -68,7 +68,7 @@ public CatalogItemSummary(\n         this.planYaml = planYaml;\n         this.description = description;\n         this.iconUrl = iconUrl;\n-        this.links = ImmutableMap.copyOf(links);\n+        this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n     }\n     \n     @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogItemSummary.java",
                "sha": "61e54a8b719074089d659230d3baef42f66e9f73",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogPolicySummary.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogPolicySummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogPolicySummary.java",
                "patch": "@@ -24,6 +24,8 @@\n \n import org.codehaus.jackson.annotate.JsonProperty;\n \n+import com.google.common.collect.ImmutableSet;\n+\n public class CatalogPolicySummary extends CatalogItemSummary {\n \n     private final Set<PolicyConfigSummary> config;\n@@ -40,7 +42,7 @@ public CatalogPolicySummary(\n         ) {\n         super(id, name, type, type, type, planYaml, description, iconUrl, links);\n         // TODO expose config from policies\n-        this.config = config;\n+        this.config = (config == null) ? ImmutableSet.<PolicyConfigSummary>of() : config;\n     }\n     \n     public Set<PolicyConfigSummary> getConfig() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/CatalogPolicySummary.java",
                "sha": "1625095ce119de8c4341a15b1cc8ee3f786b07f9",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/EntityConfigSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/EntityConfigSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/EntityConfigSummary.java",
                "patch": "@@ -45,7 +45,7 @@ public EntityConfigSummary(\n       @JsonProperty(\"links\") Map<String, URI> links\n   ) {\n     super(name, type, description, defaultValue, reconfigurable, label, priority, possibleValues);\n-    this.links = links!=null ? ImmutableMap.copyOf(links) : null;\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n   }\n \n   public EntityConfigSummary(ConfigKey<?> config, String label, Double priority, Map<String, URI> links) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/EntityConfigSummary.java",
                "sha": "4911d9ac484d7ea68841a810bd3151162d48ec3c",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/EntitySummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/EntitySummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/EntitySummary.java",
                "patch": "@@ -40,7 +40,7 @@ public EntitySummary(\n     this.type = type;\n     this.id = id;\n     this.name = name;\n-    this.links = links == null ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n   }\n \n   public String getType() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/EntitySummary.java",
                "sha": "6ec84e584f7f69667407fd1d7f0fde83b17d29b3",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/HighAvailabilitySummary.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/HighAvailabilitySummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 4,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/HighAvailabilitySummary.java",
                "patch": "@@ -23,6 +23,7 @@\n \n import org.codehaus.jackson.annotate.JsonProperty;\n \n+import com.google.common.base.Objects;\n import com.google.common.collect.ImmutableMap;\n \n public class HighAvailabilitySummary {\n@@ -70,12 +71,12 @@ public Long getRemoteTimestamp() {\n             \n             @Override\n             public boolean equals(Object o) {\n-              return (o instanceof HaNodeSummary) && nodeId.equals(((HaNodeSummary)o).getNodeId());\n+              return (o instanceof HaNodeSummary) && Objects.equal(nodeId, ((HaNodeSummary)o).getNodeId());\n             }\n \n             @Override\n             public int hashCode() {\n-              return nodeId != null ? nodeId.hashCode() : 0;\n+              return Objects.hashCode(nodeId);\n             }\n \n             @Override\n@@ -100,8 +101,8 @@ public HighAvailabilitySummary(\n     ) {\n       this.ownId = ownId;\n       this.masterId = masterId;\n-      this.nodes = nodes;\n-      this.links = links == null ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n+      this.nodes = (nodes == null) ? ImmutableMap.<String, HaNodeSummary>of() : nodes;\n+      this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n     }\n \n     public String getOwnId() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/HighAvailabilitySummary.java",
                "sha": "33c6f3ee225052e41365a72997441ed1016b2a78",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/LinkWithMetadata.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/LinkWithMetadata.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/LinkWithMetadata.java",
                "patch": "@@ -39,7 +39,7 @@ public LinkWithMetadata(\n             @JsonProperty(\"link\") String link, \n             @Nullable @JsonProperty(\"metadata\") Map<String,?> metadata) {\n         this.link = link;\n-        this.metadata = metadata==null ? ImmutableMap.<String,Object>of() : ImmutableMap.<String,Object>copyOf(metadata);\n+        this.metadata = (metadata == null) ? ImmutableMap.<String,Object>of() : ImmutableMap.<String,Object>copyOf(metadata);\n     }\n     \n     public String getLink() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/LinkWithMetadata.java",
                "sha": "cf828b80a3cc333761bbe10e091d19baa19cf25d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/LocationSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/LocationSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/LocationSummary.java",
                "patch": "@@ -52,7 +52,7 @@ public LocationSummary(\n     super(name, spec, config);\n     this.id = checkNotNull(id);\n     this.type = type;\n-    this.links = ImmutableMap.copyOf(links);\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n   }\n \n   @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/LocationSummary.java",
                "sha": "935ad01fea2a21e503cbdc93317722ae44d03be8",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/PolicyConfigSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/PolicyConfigSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/PolicyConfigSummary.java",
                "patch": "@@ -41,7 +41,7 @@ public PolicyConfigSummary(\n       @JsonProperty(\"links\") Map<String, URI> links\n   ) {\n     super(name, type, description, defaultValue, reconfigurable, null, null, null);\n-    this.links = links!=null ? ImmutableMap.copyOf(links) : null;\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n   }\n   \n   @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/PolicyConfigSummary.java",
                "sha": "0088d9f30c963c8c0f22fb0a6bcc1f8a741733f5",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/PolicySummary.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/PolicySummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/PolicySummary.java",
                "patch": "@@ -19,6 +19,7 @@\n package brooklyn.rest.domain;\n \n import com.google.common.collect.ImmutableMap;\n+\n import org.codehaus.jackson.annotate.JsonProperty;\n \n import java.net.URI;\n@@ -40,7 +41,7 @@ public PolicySummary(\n     this.id = id;\n     this.name = name;\n     this.state = state;\n-    this.links = ImmutableMap.copyOf(links);\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n   }\n \n   @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/PolicySummary.java",
                "sha": "42c670e3926edab81ae463011930d41172a0e089",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/SensorSummary.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/SensorSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/SensorSummary.java",
                "patch": "@@ -45,7 +45,7 @@ public SensorSummary(\n     this.name = name;\n     this.type = type;\n     this.description = description;\n-    this.links = links != null ? ImmutableMap.copyOf(links) : null;\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n   }\n \n   @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/SensorSummary.java",
                "sha": "a6cdb4d779996ab211b31bd9911479c07780355c",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/TaskSummary.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/TaskSummary.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 2,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/TaskSummary.java",
                "patch": "@@ -94,7 +94,7 @@ public TaskSummary(\n     this.description = description;\n     this.entityId = entityId;\n     this.entityDisplayName = entityDisplayName;\n-    this.tags = ImmutableList.<Object>copyOf(tags);\n+    this.tags = (tags == null) ? ImmutableList.of() : ImmutableList.<Object>copyOf(tags);\n     this.submitTimeUtc = submitTimeUtc;\n     this.startTimeUtc = startTimeUtc;\n     this.endTimeUtc = endTimeUtc;\n@@ -108,7 +108,7 @@ public TaskSummary(\n     this.submittedByTask = submittedByTask;\n     this.detailedStatus = detailedStatus;\n     this.streams = streams;\n-    this.links = ImmutableMap.copyOf(links);\n+    this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n }\n \n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/TaskSummary.java",
                "sha": "a69aa5642d68b2539c1d78e03348f001e19d3249",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistic.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistic.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistic.java",
                "patch": "@@ -21,7 +21,9 @@\n import org.codehaus.jackson.annotate.JsonProperty;\n \n import com.google.common.base.Objects;\n+import com.google.common.collect.ImmutableMap;\n \n+import java.net.URI;\n import java.util.Map;\n \n import static com.google.common.base.Preconditions.checkNotNull;\n@@ -48,7 +50,7 @@ public UsageStatistic(@JsonProperty(\"status\") Status status, @JsonProperty(\"id\")\n         this.start = start;\n         this.end = end;\n         this.duration = duration;\n-        this.metadata = checkNotNull(metadata, \"metadata\");\n+        this.metadata = (metadata == null) ? ImmutableMap.<String, String>of() : metadata;\n     }\n \n     public Status getStatus() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistic.java",
                "sha": "64dfe97655561841548cd9095f387e19815d570a",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistics.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistics.java?ref=961ad11f9ed5e883b0c63c515775ac8981d4f063",
                "deletions": 1,
                "filename": "usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistics.java",
                "patch": "@@ -43,7 +43,7 @@ public UsageStatistics(\n             @JsonProperty(\"links\") Map<String, URI> links\n     ) {\n         this.statistics = statistics == null ? ImmutableList.<UsageStatistic>of() : ImmutableList.copyOf(statistics);\n-        this.links = links == null ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n+        this.links = (links == null) ? ImmutableMap.<String, URI>of() : ImmutableMap.copyOf(links);\n       }\n \n     public List<UsageStatistic> getStatistics() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/961ad11f9ed5e883b0c63c515775ac8981d4f063/usage/rest-api/src/main/java/brooklyn/rest/domain/UsageStatistics.java",
                "sha": "c26a987401d9c7d461e7158b0158fa4ffc7b0374",
                "status": "modified"
            }
        ],
        "message": "Avoid NPE in REST api deserialisation\n\n- motivated by NPE in TaskSummary<init> for tags",
        "parent": "https://github.com/apache/brooklyn-server/commit/120726759f7c5f04aa1ee7f489a21ba6f514f834",
        "patched_files": [
            "EntitySummary.java",
            "SensorSummary.java",
            "LocationSummary.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "LocationSummaryTest.java",
            "EntitySummaryTest.java",
            "SensorSummaryTest.java"
        ]
    },
    "brooklyn-server_a281d36": {
        "bug_id": "brooklyn-server_a281d36",
        "commit": "https://github.com/apache/brooklyn-server/commit/a281d36c86cc5bcfc0355c70c9eff963efb0e768",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/a281d36c86cc5bcfc0355c70c9eff963efb0e768/core/src/main/java/brooklyn/util/NetworkUtils.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/util/NetworkUtils.java?ref=a281d36c86cc5bcfc0355c70c9eff963efb0e768",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/util/NetworkUtils.java",
                "patch": "@@ -67,7 +67,9 @@ public static void checkPortsValid(Map ports) {\n         for (Object ppo : ports.entrySet()) {\n             Map.Entry<?,?> pp = (Map.Entry<?,?>)ppo;\n             Object val = pp.getValue();\n-            if (!(val instanceof Integer)) {\n+            if(val == null){\n+                throw new IllegalArgumentException(\"port for \"+pp.getKey()+\" is null\");\n+            }else if (!(val instanceof Integer)) {\n                 throw new IllegalArgumentException(\"port \"+val+\" for \"+pp.getKey()+\" is not an integer (\"+val.getClass()+\")\");\n             }\n             checkPortValid((Integer)val, \"\"+pp.getKey());",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/a281d36c86cc5bcfc0355c70c9eff963efb0e768/core/src/main/java/brooklyn/util/NetworkUtils.java",
                "sha": "6190edffef567534bf63a509aa3030ae73b35a71",
                "status": "modified"
            }
        ],
        "message": "networkutils fix; npe on when a port is null",
        "parent": "https://github.com/apache/brooklyn-server/commit/af033745d17bcf7a872d21d4bf00bfd1108884a9",
        "patched_files": [
            "NetworkUtils.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "NetworkUtilsTest.java"
        ]
    },
    "brooklyn-server_a78b98c": {
        "bug_id": "brooklyn-server_a78b98c",
        "commit": "https://github.com/apache/brooklyn-server/commit/a78b98c9761b5e0c644da4aa0835d133402dfd91",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/a78b98c9761b5e0c644da4aa0835d133402dfd91/core/src/main/java/org/apache/brooklyn/core/mgmt/ha/HighAvailabilityManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/mgmt/ha/HighAvailabilityManagerImpl.java?ref=a78b98c9761b5e0c644da4aa0835d133402dfd91",
                "deletions": 3,
                "filename": "core/src/main/java/org/apache/brooklyn/core/mgmt/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -129,7 +129,7 @@\n     private static final Logger LOG = LoggerFactory.getLogger(HighAvailabilityManagerImpl.class);\n \n     private final ManagementContextInternal managementContext;\n-    private volatile String ownNodeId;\n+    private final String ownNodeId;\n     private volatile ManagementPlaneSyncRecordPersister persister;\n     private volatile PromotionListener promotionListener;\n     private volatile MasterChooser masterChooser = new AlphabeticMasterChooser();\n@@ -163,6 +163,7 @@ public long read() {\n \n     public HighAvailabilityManagerImpl(ManagementContextInternal managementContext) {\n         this.managementContext = managementContext;\n+        ownNodeId = managementContext.getManagementNodeId();\n         startTimeUtc = localTickerUtc.read();\n     }\n \n@@ -242,7 +243,6 @@ public boolean isRunning() {\n     @Override\n     public void disabled() {\n         disabled = true;\n-        ownNodeId = managementContext.getManagementNodeId();\n         // this is notionally the master, just not running; see javadoc for more info\n         stop(ManagementNodeState.MASTER);\n         \n@@ -276,7 +276,6 @@ public void changeMode(HighAvailabilityMode startMode, boolean preventElectionOn\n             }\n         }\n         \n-        ownNodeId = managementContext.getManagementNodeId();\n         // TODO Small race in that we first check, and then we'll do checkMaster() on first poll,\n         // so another node could have already become master or terminated in that window.\n         ManagementPlaneSyncRecord planeRec = loadManagementPlaneSyncRecord(false);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/a78b98c9761b5e0c644da4aa0835d133402dfd91/core/src/main/java/org/apache/brooklyn/core/mgmt/ha/HighAvailabilityManagerImpl.java",
                "sha": "a4f88705fbcef111ba6015e3bf7f97184624a427",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/a78b98c9761b5e0c644da4aa0835d133402dfd91/core/src/main/java/org/apache/brooklyn/core/mgmt/internal/AbstractManagementContext.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/mgmt/internal/AbstractManagementContext.java?ref=a78b98c9761b5e0c644da4aa0835d133402dfd91",
                "deletions": 0,
                "filename": "core/src/main/java/org/apache/brooklyn/core/mgmt/internal/AbstractManagementContext.java",
                "patch": "@@ -80,6 +80,7 @@\n import org.apache.brooklyn.util.exceptions.Exceptions;\n import org.apache.brooklyn.util.guava.Maybe;\n import org.apache.brooklyn.util.javalang.Reflections;\n+import org.apache.brooklyn.util.text.Strings;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -132,6 +133,7 @@ public BrooklynClassLoadingContext apply(@Nullable Object input) {\n     }\n \n     private final AtomicLong totalEffectorInvocationCount = new AtomicLong();\n+    private final String managementNodeId;\n \n     protected DeferredBrooklynProperties configMap;\n     protected Scratchpad scratchpad;\n@@ -163,6 +165,8 @@ public BrooklynClassLoadingContext apply(@Nullable Object input) {\n     protected CatalogInitialization catalogInitialization;\n \n     public AbstractManagementContext(BrooklynProperties brooklynProperties) {\n+        this.managementNodeId = Strings.makeRandomId(8);\n+\n         this.configMap = new DeferredBrooklynProperties(brooklynProperties, this);\n         this.scratchpad = new BasicScratchpad();\n         this.entityDriverManager = new BasicEntityDriverManager();\n@@ -200,6 +204,11 @@ public boolean isStartupComplete() {\n         return startupComplete;\n     }\n \n+    @Override\n+    public String getManagementNodeId() {\n+        return managementNodeId;\n+    }\n+    \n     @Override\n     public BrooklynStorage getStorage() {\n         return storage;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/a78b98c9761b5e0c644da4aa0835d133402dfd91/core/src/main/java/org/apache/brooklyn/core/mgmt/internal/AbstractManagementContext.java",
                "sha": "b04cea437d1a48ed61917f695692c23cc594ad12",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/a78b98c9761b5e0c644da4aa0835d133402dfd91/core/src/main/java/org/apache/brooklyn/core/mgmt/internal/LocalManagementContext.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/mgmt/internal/LocalManagementContext.java?ref=a78b98c9761b5e0c644da4aa0835d133402dfd91",
                "deletions": 11,
                "filename": "core/src/main/java/org/apache/brooklyn/core/mgmt/internal/LocalManagementContext.java",
                "patch": "@@ -127,9 +127,8 @@ public static int terminateAll() {\n         return closed;\n     }\n \n-    private AtomicBoolean terminated = new AtomicBoolean(false);\n+    private final AtomicBoolean terminated = new AtomicBoolean(false);\n     private String managementPlaneId;\n-    private String managementNodeId;\n     private BasicExecutionManager execution;\n     private SubscriptionManager subscriptions;\n     private LocalEntityManager entityManager;\n@@ -172,7 +171,6 @@ public LocalManagementContext(Builder builder, Map<String, Object> brooklynAddit\n         \n         checkNotNull(configMap, \"brooklynProperties\");\n         \n-        this.managementNodeId = Strings.makeRandomId(8);\n         this.builder = builder;\n         this.brooklynAdditionalProperties = brooklynAdditionalProperties;\n         if (brooklynAdditionalProperties != null)\n@@ -206,24 +204,19 @@ public String getManagementPlaneId() {\n     \n     public void setManagementPlaneId(String newPlaneId) {\n         if (managementPlaneId != null && !managementPlaneId.equals(newPlaneId)) {\n-            log.warn(\"Management plane ID at {} {} changed from {} to {} (can happen on concurrent startup of multiple nodes)\", new Object[] { managementNodeId, getHighAvailabilityManager().getNodeState(), managementPlaneId, newPlaneId });\n-            log.debug(\"Management plane ID at {} {} changed from {} to {} (can happen on concurrent startup of multiple nodes)\", new Object[] {managementNodeId, getHighAvailabilityManager().getNodeState(), managementPlaneId, newPlaneId, new RuntimeException(\"Stack trace for setManagementPlaneId\")});\n+            log.warn(\"Management plane ID at {} {} changed from {} to {} (can happen on concurrent startup of multiple nodes)\", new Object[] { getManagementNodeId(), getHighAvailabilityManager().getNodeState(), managementPlaneId, newPlaneId });\n+            log.debug(\"Management plane ID at {} {} changed from {} to {} (can happen on concurrent startup of multiple nodes)\", new Object[] {getManagementNodeId(), getHighAvailabilityManager().getNodeState(), managementPlaneId, newPlaneId, new RuntimeException(\"Stack trace for setManagementPlaneId\")});\n         }\n         this.managementPlaneId = newPlaneId;\n     }\n \n     public void generateManagementPlaneId() {\n         if (this.managementPlaneId != null) {\n-            throw new IllegalStateException(\"Request to generate a management plane ID for node \"+managementNodeId+\" but one already exists (\" + managementPlaneId + \")\");\n+            throw new IllegalStateException(\"Request to generate a management plane ID for node \"+getManagementNodeId()+\" but one already exists (\" + managementPlaneId + \")\");\n         }\n         this.managementPlaneId = Strings.makeRandomId(8);\n     }\n     \n-    @Override\n-    public String getManagementNodeId() {\n-        return managementNodeId;\n-    }\n-    \n     @Override\n     public void prePreManage(Entity entity) {\n         getEntityManager().prePreManage(entity);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/a78b98c9761b5e0c644da4aa0835d133402dfd91/core/src/main/java/org/apache/brooklyn/core/mgmt/internal/LocalManagementContext.java",
                "sha": "4836d7061a37b1a16ab7b423ec994c1c51629b7b",
                "status": "modified"
            }
        ],
        "message": "BROOKLYN-120: fix NPE in /v1/server/up/extended",
        "parent": "https://github.com/apache/brooklyn-server/commit/6e5c2c25230861fe2ccc002f8cd8830aca08e906",
        "patched_files": [
            "LocalManagementContext.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "LocalManagementContextTest.java"
        ]
    },
    "brooklyn-server_aa96406": {
        "bug_id": "brooklyn-server_aa96406",
        "commit": "https://github.com/apache/brooklyn-server/commit/aa964060d1acee493763d827dcd19e831c12a29b",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/aa964060d1acee493763d827dcd19e831c12a29b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java?ref=aa964060d1acee493763d827dcd19e831c12a29b",
                "deletions": 3,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "patch": "@@ -80,7 +80,9 @@\n     private static String getProviderName(String providerOrApi, String locationName, Map<String, Object> properties) {\n         String provider = providerOrApi;\n         if(!Strings.isNullOrEmpty(locationName)) {\n-            provider = getProviderFromNamedProperty(locationName, properties);\n+            String providerDefinition = (String) properties.get(String.format(\"brooklyn.location.named.%s\", locationName));\n+            if (providerDefinition!=null)\n+                provider = getProviderFromDefinition(providerDefinition);\n         }\n         return provider;\n     }\n@@ -105,8 +107,8 @@ private static String getProviderName(String providerOrApi, String locationName,\n         return ConfigUtils.filterForPrefixAndStrip(properties, prefix).asMapWithStringKeys();\n     }\n \n-    private static String getProviderFromNamedProperty(String locationName, Map<String, Object> properties) {\n-        return Iterables.get(Splitter.on(\":\").split((String) properties.get(String.format(\"brooklyn.location.named.%s\", locationName))), 1);\n+    private static String getProviderFromDefinition(String definition) {\n+        return Iterables.get(Splitter.on(\":\").split(definition), 1);\n     }\n \n     private static void warnOfDeprecated(Map<String, Object> properties) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/aa964060d1acee493763d827dcd19e831c12a29b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "sha": "6330104e7bd0e3f9df3615bd5bdf7821d731455e",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/aa964060d1acee493763d827dcd19e831c12a29b/usage/rest-server/src/test/java/brooklyn/rest/resources/LocationResourceTest.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-server/src/test/java/brooklyn/rest/resources/LocationResourceTest.java?ref=aa964060d1acee493763d827dcd19e831c12a29b",
                "deletions": 2,
                "filename": "usage/rest-server/src/test/java/brooklyn/rest/resources/LocationResourceTest.java",
                "patch": "@@ -11,16 +11,16 @@\n import javax.annotation.Nullable;\n import javax.ws.rs.core.Response;\n \n-import brooklyn.test.Asserts;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.testng.Assert;\n import org.testng.annotations.Test;\n \n+import brooklyn.location.jclouds.JcloudsLocation;\n import brooklyn.rest.domain.LocationSpec;\n import brooklyn.rest.domain.LocationSummary;\n import brooklyn.rest.testing.BrooklynRestResourceTest;\n-import brooklyn.test.TestUtils;\n+import brooklyn.test.Asserts;\n \n import com.google.common.base.Predicate;\n import com.google.common.collect.ImmutableMap;\n@@ -57,6 +57,9 @@ public void testAddNewLocation() {\n     assertThat(location.getConfig().get(\"identity\"), is(\"bob\"));\n     assertFalse(location.getConfig().containsKey(\"CR3dential\"));\n     Assert.assertTrue(addedLocationUri.toString().startsWith(\"/v1/locations/\"));\n+    \n+    JcloudsLocation l = (JcloudsLocation) getManagementContext().getLocationRegistry().resolve(location.getId());\n+    Assert.assertEquals(l.getProvider(), \"aws-ec2\");\n   }\n \n   @Test(dependsOnMethods={\"testAddNewLocation\"})",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/aa964060d1acee493763d827dcd19e831c12a29b/usage/rest-server/src/test/java/brooklyn/rest/resources/LocationResourceTest.java",
                "sha": "6ba9a8d247de426579f26da34c387ac716a71ffe",
                "status": "modified"
            }
        ],
        "message": "don't throw NPE when named location refers to another (causing locations in catalog to fail), and extend unit test to trap this error",
        "parent": "https://github.com/apache/brooklyn-server/commit/83dd90e72cdf876ec31619f81509c74d131ea871",
        "patched_files": [
            "JcloudsPropertiesFromBrooklynProperties.java",
            "LocationResource.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "LocationResourceTest.java",
            "JcloudsPropertiesFromBrooklynPropertiesTest.java"
        ]
    },
    "brooklyn-server_b6a6565": {
        "bug_id": "brooklyn-server_b6a6565",
        "commit": "https://github.com/apache/brooklyn-server/commit/b6a65650e4a629eef3172c02a075df15419f9ffb",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/b6a65650e4a629eef3172c02a075df15419f9ffb/camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java?ref=b6a65650e4a629eef3172c02a075df15419f9ffb",
                "deletions": 2,
                "filename": "camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java",
                "patch": "@@ -32,14 +32,17 @@\n @Test\n public class EmptyWindowsProcessYamlTest extends AbstractYamlTest {\n \n-    @Test(groups=\"Integration\")\n+    // takes couple of seconds unfortunately (why?!), but our only unit-test coverage of \n+    // EmptyWindowsProcess so including in unit tests anyway.\n+    @Test\n     public void testNoWinrm() throws Exception {\n         Entity app = createAndStartApplication(\n                 \"location: byon:(hosts=\\\"1.2.3.4\\\",osFamily=windows)\",\n                 \"services:\",\n                 \"- type: \"+EmptyWindowsProcess.class.getName(),\n                 \"  brooklyn.config:\",\n-                \"    winrmMonitoring.enabled: false\");\n+                \"    winrmMonitoring.enabled: false\",\n+                \"    onbox.base.dir.skipResolution: true\");\n         waitForApplicationTasks(app);\n \n         EmptyWindowsProcess entity = Iterables.getOnlyElement(Entities.descendants(app, EmptyWindowsProcess.class));",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/b6a65650e4a629eef3172c02a075df15419f9ffb/camp/camp-brooklyn/src/test/java/org/apache/brooklyn/camp/brooklyn/EmptyWindowsProcessYamlTest.java",
                "sha": "3eaa963589dd01e58f9495669bd90f36d71f14c2",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/b6a65650e4a629eef3172c02a075df15419f9ffb/software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java?ref=b6a65650e4a629eef3172c02a075df15419f9ffb",
                "deletions": 1,
                "filename": "software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java",
                "patch": "@@ -28,6 +28,8 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.google.common.base.Optional;\n+\n public class EmptyWindowsProcessWinRmDriver extends AbstractSoftwareProcessWinRmDriver implements VanillaWindowsProcessDriver {\n     @SuppressWarnings(\"unused\")\n     private static final Logger LOG = LoggerFactory.getLogger(EmptyWindowsProcessWinRmDriver.class);\n@@ -41,7 +43,8 @@ public EmptyWindowsProcessWinRmDriver(EmptyWindowsProcessImpl entity, WinRmMachi\n     @Override\n     public void start() {\n         WinRmMachineLocation machine = (WinRmMachineLocation) location;\n-        UserAndHostAndPort winrmAddress = UserAndHostAndPort.fromParts(machine.getUser(), machine.getAddress().getHostName(), entity.getConfig(WinRmTool.PROP_PORT));\n+        Integer port = entity.getConfig(WinRmTool.PROP_PORT);\n+        UserAndHostAndPort winrmAddress = UserAndHostAndPort.fromParts(machine.getUser(), machine.getAddress().getHostName(), Optional.fromNullable(port));\n         getEntity().sensors().set(Attributes.WINRM_ADDRESS, winrmAddress);\n \n         super.start();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/b6a65650e4a629eef3172c02a075df15419f9ffb/software/base/src/main/java/org/apache/brooklyn/entity/software/base/EmptyWindowsProcessWinRmDriver.java",
                "sha": "c7842bae8c992a47b42cd6ae6b841b0911bd3a75",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/b6a65650e4a629eef3172c02a075df15419f9ffb/utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java?ref=b6a65650e4a629eef3172c02a075df15419f9ffb",
                "deletions": 0,
                "filename": "utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java",
                "patch": "@@ -21,6 +21,7 @@\n import java.io.Serializable;\n \n import com.google.common.base.Objects;\n+import com.google.common.base.Optional;\n import com.google.common.net.HostAndPort;\n \n public class UserAndHostAndPort implements Serializable {\n@@ -31,6 +32,14 @@ public static UserAndHostAndPort fromParts(String user, String host, int port) {\n         return new UserAndHostAndPort(user, HostAndPort.fromParts(host, port));\n     }\n \n+    public static UserAndHostAndPort fromParts(String user, String host, Optional<Integer> port) {\n+        HostAndPort hostAndPort = port.isPresent() ? HostAndPort.fromParts(host, port.get()) : HostAndPort.fromString(host);\n+        if (!port.isPresent() && hostAndPort.hasPort()) {\n+            throw new IllegalArgumentException(\"optional port absent, but host '\"+host+\"' parsed as containing port\");\n+        }\n+        return new UserAndHostAndPort(user, hostAndPort);\n+    }\n+\n     public static UserAndHostAndPort fromParts(String user, HostAndPort hostAndPort) {\n         return new UserAndHostAndPort(user, hostAndPort);\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/b6a65650e4a629eef3172c02a075df15419f9ffb/utils/common/src/main/java/org/apache/brooklyn/util/net/UserAndHostAndPort.java",
                "sha": "558af0cb1a03a1372fa26148b73e0daa548259ae",
                "status": "modified"
            }
        ],
        "message": "Closes #205\n\nBROOKLYN-303: Fix EmptyWindowsProcess\n\nPreviously gave NPE in driver",
        "parent": "https://github.com/apache/brooklyn-server/commit/460db56a4763feb7eb610c5657b8eca9d60585de",
        "patched_files": [
            "EmptyWindowsProcessWinRmDriver.java",
            "UserAndHostAndPort.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "UserAndHostAndPortTest.java",
            "EmptyWindowsProcessYamlTest.java"
        ]
    },
    "brooklyn-server_b8f4e4b": {
        "bug_id": "brooklyn-server_b8f4e4b",
        "commit": "https://github.com/apache/brooklyn-server/commit/b8f4e4b19e66fed30f6645be27871dcd753bd2fc",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/b8f4e4b19e66fed30f6645be27871dcd753bd2fc/core/src/main/java/brooklyn/management/ha/HighAvailabilityManagerImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/ha/HighAvailabilityManagerImpl.java?ref=b8f4e4b19e66fed30f6645be27871dcd753bd2fc",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/ha/HighAvailabilityManagerImpl.java",
                "patch": "@@ -436,6 +436,11 @@ protected ManagementPlaneSyncRecord loadManagementPlaneSyncRecord(boolean replac\n             }\n             return builder.build();\n         }\n+        if (persister == null) {\n+            // e.g. web-console may be polling before we've started up\n+            LOG.debug(\"High availablity manager has no persister; returning empty record\");\n+            return ManagementPlaneSyncRecordImpl.builder().build();\n+        }\n         \n         int maxLoadAttempts = 5;\n         Exception lastException = null;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/b8f4e4b19e66fed30f6645be27871dcd753bd2fc/core/src/main/java/brooklyn/management/ha/HighAvailabilityManagerImpl.java",
                "sha": "f19dcec0b73c65679b485802db0368ea35f717a9",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/b8f4e4b19e66fed30f6645be27871dcd753bd2fc/core/src/test/java/brooklyn/management/ha/HighAvailabilityManagerTest.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/management/ha/HighAvailabilityManagerTest.java?ref=b8f4e4b19e66fed30f6645be27871dcd753bd2fc",
                "deletions": 1,
                "filename": "core/src/test/java/brooklyn/management/ha/HighAvailabilityManagerTest.java",
                "patch": "@@ -2,6 +2,7 @@\n \n import static org.testng.Assert.assertEquals;\n import static org.testng.Assert.assertFalse;\n+import static org.testng.Assert.assertNotNull;\n import static org.testng.Assert.assertTrue;\n \n import java.util.List;\n@@ -69,6 +70,23 @@ public void tearDown() throws Exception {\n         if (managementContext != null) Entities.destroyAll(managementContext);\n     }\n     \n+    // The web-console could still be polling (e.g. if have just restarted brooklyn), before the persister is set.\n+    // Must not throw NPE, but instead return something sensible (e.g. an empty state record).\n+    @Test\n+    public void testGetManagementPlaneSyncStateDoesNotThrowNpeBeforePersisterSet() throws Exception {\n+        HighAvailabilityManagerImpl manager2 = new HighAvailabilityManagerImpl(managementContext)\n+            .setPollPeriod(Duration.of(10, TimeUnit.MILLISECONDS))\n+            .setHeartbeatTimeout(Duration.THIRTY_SECONDS)\n+            .setPromotionListener(promotionListener)\n+            .setTicker(ticker);\n+        try {\n+            ManagementPlaneSyncRecord state = manager2.getManagementPlaneSyncState();\n+            assertNotNull(state);\n+        } finally {\n+            manager2.stop();\n+        }\n+\n+    }\n     // Can get a log.error about our management node's heartbeat being out of date. Caused by\n     // poller first writing a heartbeat record, and then the clock being incremented. But the\n     // next poll fixes it.\n@@ -140,7 +158,7 @@ private long currentTimeMillis() {\n     }\n     \n     private long incrementClock(long increment, TimeUnit unit) {\n-        currentTime.addAndGet(unit.toNanos(increment));\n+        currentTime.addAndGet(unit.toMillis(increment));\n         return currentTimeMillis();\n     }\n     ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/b8f4e4b19e66fed30f6645be27871dcd753bd2fc/core/src/test/java/brooklyn/management/ha/HighAvailabilityManagerTest.java",
                "sha": "491e633ce0dab7ab2801988285b3fa10c2a48814",
                "status": "modified"
            }
        ],
        "message": "HA manager: loadManagementPlaneSyncRecord avoid NPE if persister null\n\n- return an empty ManagementPlaneSyncRecordImpl",
        "parent": "https://github.com/apache/brooklyn-server/commit/bfdc8dd77e2763f23c629150a36f842f624a4872",
        "patched_files": [
            "HighAvailabilityManagerImpl.java",
            "HighAvailabilityManager.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "HighAvailabilityManagerTest.java"
        ]
    },
    "brooklyn-server_bcb9689": {
        "bug_id": "brooklyn-server_bcb9689",
        "commit": "https://github.com/apache/brooklyn-server/commit/bcb96892991b72f7170e11b26140eff1fba8525d",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bcb96892991b72f7170e11b26140eff1fba8525d/utils/common/src/main/java/org/apache/brooklyn/util/time/Duration.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/org/apache/brooklyn/util/time/Duration.java?ref=bcb96892991b72f7170e11b26140eff1fba8525d",
                "deletions": 2,
                "filename": "utils/common/src/main/java/org/apache/brooklyn/util/time/Duration.java",
                "patch": "@@ -137,8 +137,10 @@ public long nanos() {\n \n     /** \n      * See {@link Time#parseElapsedTime(String)}; \n-     * also accepts \"forever\" (and for those who prefer things exceedingly accurate, \"practically_forever\"). \n-     * Also see {@link #of(Object)}. */\n+     * also accepts \"forever\" (and for those who prefer things exceedingly accurate, \"practically_forever\").\n+     * If null or blank or 'null' is passed in, then null will be returned. \n+     * Also see {@link #of(Object)}.\n+     */\n     public static Duration parse(String textualDescription) {\n         if (Strings.isBlank(textualDescription)) return null;\n         if (\"null\".equalsIgnoreCase(textualDescription)) return null;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bcb96892991b72f7170e11b26140eff1fba8525d/utils/common/src/main/java/org/apache/brooklyn/util/time/Duration.java",
                "sha": "473aef31a2aaf2034c196a39ccac7e7c0824ee84",
                "status": "modified"
            },
            {
                "additions": 50,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bcb96892991b72f7170e11b26140eff1fba8525d/utils/common/src/main/java/org/apache/brooklyn/util/time/Time.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/org/apache/brooklyn/util/time/Time.java?ref=bcb96892991b72f7170e11b26140eff1fba8525d",
                "deletions": 24,
                "filename": "utils/common/src/main/java/org/apache/brooklyn/util/time/Time.java",
                "patch": "@@ -87,7 +87,7 @@ public static String makeDateString(Date date, String format) {\n         return makeDateString(date, format, null);\n     }\n     /** as {@link #makeDateString(Date, String, TimeZone)} for the given time zone; consider {@link TimeZone#GMT} */\n-    public static String makeDateString(Date date, String format, TimeZone tz) {\n+    public static String makeDateString(Date date, String format, @Nullable TimeZone tz) {\n         SimpleDateFormat fmt = new SimpleDateFormat(format);\n         if (tz!=null) fmt.setTimeZone(tz);\n         return fmt.format(date);\n@@ -101,7 +101,9 @@ public static String makeDateString(Calendar date, String format) {\n         return makeDateString(date.getTime(), format, date.getTimeZone());\n     }\n \n-    public static Function<Long, String> toDateString() { return dateString; }\n+    public static Function<Long, String> toDateString() {\n+        return dateString;\n+    }\n     private static Function<Long, String> dateString = new Function<Long, String>() {\n             @Override\n             @Nullable\n@@ -136,7 +138,9 @@ public static String makeDateSimpleStampString(long date) {\n         return new SimpleDateFormat(DATE_FORMAT_SIMPLE_STAMP).format(new Date(date));\n     }\n \n-    public static Function<Long, String> toDateStampString() { return dateStampString; }\n+    public static Function<Long, String> toDateStampString() {\n+        return dateStampString;\n+    }\n     private static Function<Long, String> dateStampString = new Function<Long, String>() {\n             @Override\n             @Nullable\n@@ -156,8 +160,11 @@ public static String makeTimeStringRounded(long t, TimeUnit unit) {\n         long nanos = unit.toNanos(t);\n         return makeTimeStringNanoRounded(nanos);\n     }\n-    public static String makeTimeStringRounded(Stopwatch timer) {\n-        return makeTimeStringRounded(timer.elapsed(TimeUnit.MILLISECONDS), TimeUnit.MILLISECONDS);\n+    /**\n+     * A nice string representation of the stopwatch's elapsed time; or null if null is passed in.\n+     */\n+    public static String makeTimeStringRounded(@Nullable Stopwatch timer) {\n+        return (timer == null) ? null : makeTimeStringRounded(timer.elapsed(TimeUnit.MILLISECONDS), TimeUnit.MILLISECONDS);\n     }\n     /** @see #makeTimeString(long, boolean) */\n     public static String makeTimeStringExact(long t) {\n@@ -171,13 +178,19 @@ public static String makeTimeStringRounded(long t) {\n     public static String makeTimeStringRoundedSince(long utc) {\n         return makeTimeString(System.currentTimeMillis() - utc, true);\n     }\n-    /** @see #makeTimeString(long, boolean) */\n-    public static String makeTimeStringExact(Duration d) {\n-        return makeTimeStringNanoExact(d.toNanoseconds());\n+    /**\n+     * A nice string representation of the duration; or null if null is passed in.\n+     * @see #makeTimeString(long, boolean)\n+     */\n+    public static String makeTimeStringExact(@Nullable Duration d) {\n+        return (d == null) ? null : makeTimeStringNanoExact(d.toNanoseconds());\n     }\n-    /** @see #makeTimeString(long, boolean) */\n-    public static String makeTimeStringRounded(Duration d) {\n-        return makeTimeStringNanoRounded(d.toNanoseconds());\n+    /**\n+     * A nice string representation of the duration; or null if null is passed in.\n+     * @see #makeTimeString(long, boolean)\n+     */\n+    public static String makeTimeStringRounded(@Nullable Duration d) {\n+        return (d == null) ? null : makeTimeStringNanoRounded(d.toNanoseconds());\n     }\n     /** given an elapsed time, makes it readable, eg 44d 6h, or 8s 923ms, optionally rounding */\n     public static String makeTimeString(long t, boolean round) {\n@@ -282,7 +295,9 @@ public static String makeTimeStringNano(long tn, boolean round) {\n         return Strings.removeAllFromEnd(result, \" \");\n     }\n \n-    public static Function<Long, String> fromLongToTimeStringExact() { return LONG_TO_TIME_STRING_EXACT; }\n+    public static Function<Long, String> fromLongToTimeStringExact() {\n+        return LONG_TO_TIME_STRING_EXACT;\n+    }\n     private static final Function<Long, String> LONG_TO_TIME_STRING_EXACT = new FunctionLongToTimeStringExact();\n     private static final class FunctionLongToTimeStringExact implements Function<Long, String> {\n         @Override @Nullable\n@@ -292,8 +307,11 @@ public String apply(@Nullable Long input) {\n         }\n     }\n \n-    /** @deprecated since 0.7.0 use {@link #fromLongToTimeStringExact()} */ @Deprecated\n-    public static Function<Long, String> toTimeString() { return timeString; }\n+    /** @deprecated since 0.7.0 use {@link #fromLongToTimeStringExact()} */\n+    @Deprecated\n+    public static Function<Long, String> toTimeString() {\n+        return timeString;\n+    }\n     @Deprecated\n     private static Function<Long, String> timeString = new Function<Long, String>() {\n             @Override\n@@ -304,7 +322,9 @@ public String apply(@Nullable Long input) {\n             }\n         };\n         \n-    public static Function<Long, String> fromLongToTimeStringRounded() { return LONG_TO_TIME_STRING_ROUNDED; }\n+    public static Function<Long, String> fromLongToTimeStringRounded() {\n+        return LONG_TO_TIME_STRING_ROUNDED;\n+    }\n     private static final Function<Long, String> LONG_TO_TIME_STRING_ROUNDED = new FunctionLongToTimeStringRounded();\n     private static final class FunctionLongToTimeStringRounded implements Function<Long, String> {\n         @Override @Nullable\n@@ -314,8 +334,11 @@ public String apply(@Nullable Long input) {\n         }\n     }\n \n-    /** @deprecated since 0.7.0 use {@link #fromLongToTimeStringRounded()} */ @Deprecated\n-    public static Function<Long, String> toTimeStringRounded() { return timeStringRounded; }\n+    /** @deprecated since 0.7.0 use {@link #fromLongToTimeStringRounded()} */\n+    @Deprecated\n+    public static Function<Long, String> toTimeStringRounded() {\n+        return timeStringRounded;\n+    }\n     @Deprecated\n     private static Function<Long, String> timeStringRounded = new Function<Long, String>() {\n         @Override\n@@ -326,7 +349,9 @@ public String apply(@Nullable Long input) {\n         }\n     };\n \n-    public static Function<Duration, String> fromDurationToTimeStringRounded() { return DURATION_TO_TIME_STRING_ROUNDED; }\n+    public static Function<Duration, String> fromDurationToTimeStringRounded() {\n+        return DURATION_TO_TIME_STRING_ROUNDED;\n+    }\n     private static final Function<Duration, String> DURATION_TO_TIME_STRING_ROUNDED = new FunctionDurationToTimeStringRounded();\n     private static final class FunctionDurationToTimeStringRounded implements Function<Duration, String> {\n         @Override @Nullable\n@@ -412,7 +437,7 @@ public static long timeRemaining(long startTime, long maxTime) {\n     }\n     \n     /** Convenience for {@link Duration#parse(String)}. */\n-    public static Duration parseDuration(String timeString) {\n+    public static Duration parseDuration(@Nullable String timeString) {\n         return Duration.parse(timeString);\n     }\n     \n@@ -438,12 +463,13 @@ public static double parseTimeStringAsDouble(String timeString) {\n      * -1 on blank or never or off or false.\n      * Assumes unit is millisections if no unit is specified.\n      * \n-     * @throws NumberFormatException if cannot be parsed (or if null)\n+     * @throws NullPointerException if arg is null\n+     * @throws NumberFormatException if cannot be parsed\n      */\n     public static double parseElapsedTimeAsDouble(final String timeStringOrig) {\n         String timeString = timeStringOrig;\n         if (timeString==null)\n-            throw new NumberFormatException(\"GeneralHelper.parseTimeString cannot parse a null string\");\n+            throw new NullPointerException(\"GeneralHelper.parseTimeString cannot parse a null string\");\n         try {\n             double d = Double.parseDouble(timeString);\n             return d;\n@@ -522,7 +548,7 @@ public static Calendar newCalendarFromDate(Date date) {\n     \n     /** As {@link #parseCalendar(String)} but returning a {@link Date},\n      * (i.e. a record where the time zone has been applied and forgotten). */\n-    public static Date parseDate(String input) {\n+    public static Date parseDate(@Nullable String input) {\n         if (input==null) return null;\n         return parseCalendarMaybe(input).get().getTime();\n     }\n@@ -536,13 +562,13 @@ public static Date parseDate(String input) {\n      * <p>\n      * Other formats including locale-specific variants, e.g. recognising month names,\n      * are supported but this may vary from platform to platform and may change between versions. */\n-    public static Calendar parseCalendar(String input) {\n+    public static Calendar parseCalendar(@Nullable String input) {\n         if (input==null) return null;\n         return parseCalendarMaybe(input).get();\n     }\n     \n     /** as {@link #parseCalendar(String)} but returning a {@link Maybe} rather than throwing or returning null */\n-    public static Maybe<Calendar> parseCalendarMaybe(String input) {\n+    public static Maybe<Calendar> parseCalendarMaybe(@Nullable String input) {\n         if (input==null) return Maybe.absent(\"value is null\");\n         input = input.trim();\n         Maybe<Calendar> result;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bcb96892991b72f7170e11b26140eff1fba8525d/utils/common/src/main/java/org/apache/brooklyn/util/time/Time.java",
                "sha": "ef445d54f4c93aaa2dc03c03c8dae4362bf784c2",
                "status": "modified"
            },
            {
                "additions": 29,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bcb96892991b72f7170e11b26140eff1fba8525d/utils/common/src/test/java/org/apache/brooklyn/util/time/TimeTest.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/test/java/org/apache/brooklyn/util/time/TimeTest.java?ref=bcb96892991b72f7170e11b26140eff1fba8525d",
                "deletions": 2,
                "filename": "utils/common/src/test/java/org/apache/brooklyn/util/time/TimeTest.java",
                "patch": "@@ -20,12 +20,15 @@\n \n import java.util.Date;\n import java.util.TimeZone;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n \n-import org.apache.brooklyn.util.time.Duration;\n-import org.apache.brooklyn.util.time.Time;\n import org.testng.Assert;\n import org.testng.annotations.Test;\n \n+import com.google.common.base.Stopwatch;\n+import com.google.common.base.Ticker;\n+\n @Test\n public class TimeTest {\n \n@@ -140,6 +143,30 @@ public void testDateRoundingNull() {\n     @Test\n     public void testMakeStringRoundedNegative() { checkR(-1, \"-1ms\"); }\n \n+    @Test\n+    public void testMakeTimeStringFromDuration() {\n+        Assert.assertNull(Time.makeTimeStringExact((Duration)null));\n+        Assert.assertEquals(Time.makeTimeStringExact(Duration.millis(1100)), \"1s 100ms\");\n+        \n+        Assert.assertNull(Time.makeTimeStringRounded((Duration)null));\n+        Assert.assertEquals(Time.makeTimeStringRounded(Duration.millis(1100)), \"1.10s\");\n+    }\n+\n+    @Test\n+    public void testMakeTimeStringFromStopwatch() {\n+        final AtomicLong time = new AtomicLong();\n+        Ticker ticker = new Ticker() {\n+            @Override public long read() {\n+                return time.get();\n+            }\n+        };\n+        Assert.assertNull(Time.makeTimeStringRounded((Stopwatch)null));\n+        \n+        Stopwatch stopwatch = Stopwatch.createStarted(ticker);\n+        time.set(TimeUnit.MILLISECONDS.toNanos(1100));\n+        Assert.assertEquals(Time.makeTimeStringRounded(stopwatch), \"1.10s\");\n+    }\n+\n     @Test\n     public void testElapsedSince() {\n         long aFewSecondsAgo = System.currentTimeMillis() - 7*1000;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bcb96892991b72f7170e11b26140eff1fba8525d/utils/common/src/test/java/org/apache/brooklyn/util/time/TimeTest.java",
                "sha": "e3c81679e59274acc79d5e9a7b60d98d903f9988",
                "status": "modified"
            }
        ],
        "message": "Time.makeTimeString: avoid NPE if arg is null",
        "parent": "https://github.com/apache/brooklyn-server/commit/aa14b84ca1ae5707015708a4186cf5e4e33ac53f",
        "patched_files": [
            "Time.java",
            "Duration.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "TimeTest.java",
            "DurationTest.java"
        ]
    },
    "brooklyn-server_bd8f179": {
        "bug_id": "brooklyn-server_bd8f179",
        "commit": "https://github.com/apache/brooklyn-server/commit/bd8f179d8e860392f89ae15c0541c50da5059fe6",
        "file": [
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/api/src/main/java/brooklyn/catalog/CatalogItem.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/api/src/main/java/brooklyn/catalog/CatalogItem.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 1,
                "filename": "api/src/main/java/brooklyn/catalog/CatalogItem.java",
                "patch": "@@ -1,7 +1,9 @@\n package brooklyn.catalog;\n \n import java.util.List;\n+\n import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n \n public interface CatalogItem<T,SpecT> {\n     \n@@ -14,15 +16,28 @@\n     }\n \n     public CatalogItemType getCatalogItemType();\n+    /** the high-level type of this entity, e.g. Entity (not a specific Entity class) */\n     public Class<T> getCatalogItemJavaType();\n+    /** the type of the spec e.g. EntitySpec corresponding to {@link #getCatalogItemJavaType()} */\n+    public Class<SpecT> getSpecType();\n     \n+    /** the explicit ID of this item, or the type if not supplied */\n     public String getId();\n-    public String getJavaType();\n+    \n+    /** the type name registered in the catalog for this item */ \n+    public String getRegisteredTypeName();\n+    \n+    /** the underlying java type of the item represented, or null if not known (e.g. if it comes from yaml) */\n+    // TODO references to this should probably query getRegisteredType\n+    @Nullable public String getJavaType();\n+    \n     public String getName();\n     public String getDescription();\n     public String getIconUrl();\n     public String getVersion();\n \n+    // FIXME many of the static methods in CatalogItemAbstractDto which create CatalogItems set this as null\n+    // I (alex) suggest removing the annotation, here, and in subclasses where the method is defined\n     @Nonnull\n     public CatalogItemLibraries getLibraries();\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/api/src/main/java/brooklyn/catalog/CatalogItem.java",
                "sha": "276eba478a056b5c34182ade72f277635ef65e1d",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/camp/camp-base/src/test/java/io/brooklyn/camp/test/mock/web/MockWebPlatform.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/camp/camp-base/src/test/java/io/brooklyn/camp/test/mock/web/MockWebPlatform.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 3,
                "filename": "camp/camp-base/src/test/java/io/brooklyn/camp/test/mock/web/MockWebPlatform.java",
                "patch": "@@ -1,12 +1,15 @@\n package io.brooklyn.camp.test.mock.web;\n \n+import javax.annotation.Nullable;\n+\n import brooklyn.util.guava.Maybe;\n import io.brooklyn.camp.BasicCampPlatform;\n import io.brooklyn.camp.spi.ApplicationComponentTemplate;\n import io.brooklyn.camp.spi.AssemblyTemplate;\n import io.brooklyn.camp.spi.PlatformComponentTemplate;\n import io.brooklyn.camp.spi.collection.BasicResourceLookup;\n import io.brooklyn.camp.spi.collection.ResolvableLink;\n+import io.brooklyn.camp.spi.instantiate.AssemblyTemplateInstantiator;\n import io.brooklyn.camp.spi.pdp.Artifact;\n import io.brooklyn.camp.spi.pdp.AssemblyTemplateConstructor;\n import io.brooklyn.camp.spi.pdp.Service;\n@@ -57,7 +60,7 @@ public boolean apply(Object art, AssemblyTemplateConstructor atc) {\n         }\n     };\n \n-    public static final PdpMatcher newLiteralServiceTypeToPlatformComponentTemplateMatcher(final BasicCampPlatform platform) {\n+    public static final PdpMatcher newLiteralServiceTypeToPlatformComponentTemplateMatcher(final BasicCampPlatform platform, @Nullable final Class<? extends AssemblyTemplateInstantiator> instantiator) {\n         return new PdpMatcher() {\n             public boolean apply(Object item, AssemblyTemplateConstructor atc) {\n                 if (!(item instanceof Service)) return false;\n@@ -71,8 +74,11 @@ public boolean apply(Object item, AssemblyTemplateConstructor atc) {\n                             .customAttribute(\"serviceType\", type)\n                             .description(Maybe.fromNullable(svc.getDescription()).or(t.resolve().getDescription()))\n                             .build();\n-                        if (atc!=null)\n+                        if (atc!=null) {\n                             atc.add(pct);\n+                            if (instantiator!=null)\n+                                atc.instantiator(instantiator);\n+                        }\n                         return true;\n                     }\n                 }\n@@ -87,12 +93,15 @@ public boolean accepts(Object deploymentPlanItem) {\n     }\n     \n     public static <T extends BasicCampPlatform> T populate(T platform) {\n+        return populate(platform, null);\n+    }\n+    public static <T extends BasicCampPlatform> T populate(T platform, @Nullable Class<? extends AssemblyTemplateInstantiator> instantiator) {\n         platform.platformComponentTemplates().addAll(APPSERVER, DATABASE);\n         platform.applicationComponentTemplates().add(WAR);\n         platform.assemblyTemplates().add(ASSEMBLY1);\n         \n         platform.pdp().addMatcher(WAR_GETS_WAR_MATCHER);\n-        platform.pdp().addMatcher(newLiteralServiceTypeToPlatformComponentTemplateMatcher(platform));\n+        platform.pdp().addMatcher(newLiteralServiceTypeToPlatformComponentTemplateMatcher(platform, instantiator));\n         \n         return platform;\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/camp/camp-base/src/test/java/io/brooklyn/camp/test/mock/web/MockWebPlatform.java",
                "sha": "389ec41e71b1922f53042fe12418f85c5da9ef9c",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/camp/brooklyn/api/AssemblyTemplateSpecInstantiator.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/camp/brooklyn/api/AssemblyTemplateSpecInstantiator.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/camp/brooklyn/api/AssemblyTemplateSpecInstantiator.java",
                "patch": "@@ -0,0 +1,12 @@\n+package brooklyn.camp.brooklyn.api;\n+\n+import io.brooklyn.camp.CampPlatform;\n+import io.brooklyn.camp.spi.AssemblyTemplate;\n+import io.brooklyn.camp.spi.instantiate.AssemblyTemplateInstantiator;\n+import brooklyn.entity.proxying.EntitySpec;\n+\n+public interface AssemblyTemplateSpecInstantiator extends AssemblyTemplateInstantiator {\n+\n+    EntitySpec<?> createSpec(AssemblyTemplate template, CampPlatform platform);\n+    \n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/camp/brooklyn/api/AssemblyTemplateSpecInstantiator.java",
                "sha": "0054a8018ad6ce021668ae1486549e4fe3a5b0bb",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/camp/brooklyn/api/HasBrooklynManagementContext.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/camp/brooklyn/api/HasBrooklynManagementContext.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/camp/brooklyn/api/HasBrooklynManagementContext.java",
                "patch": "@@ -1,4 +1,4 @@\n-package io.brooklyn.camp.brooklyn.spi.platform;\n+package brooklyn.camp.brooklyn.api;\n \n import brooklyn.management.ManagementContext;\n ",
                "previous_filename": "usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/platform/HasBrooklynManagementContext.java",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/camp/brooklyn/api/HasBrooklynManagementContext.java",
                "sha": "e21bff1ff79875266246e6fe8b588fc5753aced0",
                "status": "renamed"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/CatalogPredicates.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/CatalogPredicates.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/catalog/CatalogPredicates.java",
                "patch": "@@ -47,6 +47,15 @@ public boolean apply(@Nullable CatalogItem<T,SpecT> item) {\n         };\n     }\n \n+    public static <T,SpecT> Predicate<CatalogItem<T,SpecT>> registeredType(final Predicate<? super String> filter) {\n+        return new Predicate<CatalogItem<T,SpecT>>() {\n+            @Override\n+            public boolean apply(@Nullable CatalogItem<T,SpecT> item) {\n+                return (item != null) && filter.apply(item.getRegisteredTypeName());\n+            }\n+        };\n+    }\n+\n     public static <T,SpecT> Predicate<CatalogItem<T,SpecT>> javaType(final Predicate<? super String> filter) {\n         return new Predicate<CatalogItem<T,SpecT>>() {\n             @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/CatalogPredicates.java",
                "sha": "6dfe89a8ba657b5603d389245131969d2abe5e8c",
                "status": "modified"
            },
            {
                "additions": 82,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/BasicBrooklynCatalog.java",
                "changes": 99,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/BasicBrooklynCatalog.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 17,
                "filename": "core/src/main/java/brooklyn/catalog/internal/BasicBrooklynCatalog.java",
                "patch": "@@ -1,7 +1,10 @@\n package brooklyn.catalog.internal;\n \n import io.brooklyn.camp.CampPlatform;\n+import io.brooklyn.camp.spi.AssemblyTemplate;\n+import io.brooklyn.camp.spi.instantiate.AssemblyTemplateInstantiator;\n import io.brooklyn.camp.spi.pdp.DeploymentPlan;\n+import io.brooklyn.camp.spi.pdp.Service;\n \n import java.util.NoSuchElementException;\n \n@@ -10,6 +13,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import brooklyn.camp.brooklyn.api.AssemblyTemplateSpecInstantiator;\n import brooklyn.catalog.BrooklynCatalog;\n import brooklyn.catalog.CatalogItem;\n import brooklyn.catalog.CatalogPredicates;\n@@ -18,7 +22,9 @@\n import brooklyn.util.exceptions.Exceptions;\n import brooklyn.util.javalang.AggregateClassLoader;\n import brooklyn.util.javalang.LoadedClassLoader;\n+import brooklyn.util.javalang.Reflections;\n import brooklyn.util.stream.Streams;\n+import brooklyn.util.text.Strings;\n import brooklyn.util.time.Duration;\n import brooklyn.util.time.Time;\n \n@@ -96,14 +102,57 @@ public void load() {\n         }\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n     @Override\n     public <T, SpecT> SpecT createSpec(CatalogItem<T, SpecT> item) {\n-        // TODO #2\n-        throw new UnsupportedOperationException();\n+        CatalogItemDo<T,SpecT> loadedItem = (CatalogItemDo<T, SpecT>) getCatalogItemDo(item.getId());\n+        \n+        Class<SpecT> specType = loadedItem.getSpecType();\n+        if (specType==null) return null;\n+            \n+        String yaml = loadedItem.getYaml();\n+        SpecT spec = null;\n+            \n+        if (yaml!=null) {\n+            DeploymentPlan plan = makePlanFromYaml(yaml);\n+            CampPlatform camp = BrooklynServerConfig.getCampPlatform(mgmt).get();\n+            \n+            // TODO should not register new AT each time we instantiate from the same plan; use some kind of cache\n+            AssemblyTemplate at = camp.pdp().registerDeploymentPlan(plan);\n+            \n+            try {\n+                AssemblyTemplateInstantiator instantiator = at.getInstantiator().newInstance();\n+                if (instantiator instanceof AssemblyTemplateSpecInstantiator) {\n+                    return (SpecT) ((AssemblyTemplateSpecInstantiator)instantiator).createSpec(at, camp);\n+                }\n+                throw new IllegalStateException(\"Unable to instantiate YAML; incompatible instantiator \"+instantiator+\" for \"+at);\n+            } catch (Exception e) {\n+                throw Exceptions.propagate(e);\n+            }\n+        }\n+            \n+        // revert to legacy mechanism\n+        try {\n+            if (loadedItem.getJavaType()!=null) {\n+                @SuppressWarnings({ \"deprecation\" })\n+                SpecT specT = (SpecT) Reflections.findMethod(specType, \"create\", Class.class).invoke(null, loadedItem.getJavaClass());\n+                spec = specT;\n+            }\n+        } catch (Exception e) {\n+            Exceptions.propagateIfFatal(e);\n+            throw new IllegalStateException(\"Unsupported creation of spec type \"+specType+\"; it must have a public static create(Class) method\", e);\n+        }\n+\n+        if (spec==null) \n+            throw new IllegalStateException(\"Unknown how to create instance of \"+this);\n+\n+        return spec;\n     }\n     \n     @SuppressWarnings(\"unchecked\")\n     @Override\n+    /** @deprecated since 0.7.0 use {@link #createSpec(CatalogItem)} */\n+    @Deprecated\n     public <T,SpecT> Class<? extends T> loadClass(CatalogItem<T,SpecT> item) {\n         if (log.isDebugEnabled())\n             log.debug(\"Loading class for catalog item \" + item);\n@@ -115,6 +164,8 @@ public void load() {\n     \n     @SuppressWarnings(\"unchecked\")\n     @Override\n+    /** @deprecated since 0.7.0 use {@link #createSpec(CatalogItem)} */\n+    @Deprecated\n     public <T> Class<? extends T> loadClassByType(String typeName, Class<T> typeClass) {\n         Iterable<CatalogItem<Object,Object>> resultL = getCatalogItems(CatalogPredicates.javaType(Predicates.equalTo(typeName)));\n         if (Iterables.isEmpty(resultL)) throw new NoSuchElementException(\"Unable to find catalog item for type \"+typeName);\n@@ -125,29 +176,45 @@ public void load() {\n         return (Class<? extends T>) loadClass(resultI);\n     }\n \n-    @Deprecated\n+    @Deprecated /** @deprecated since 0.7.0 only used by other deprecated items */ \n     private <T,SpecT> CatalogItemDtoAbstract<T,SpecT> getAbstractCatalogItem(CatalogItem<T,SpecT> item) {\n         while (item instanceof CatalogItemDo) item = ((CatalogItemDo<T,SpecT>)item).itemDto;\n         if (item==null) return null;\n         if (item instanceof CatalogItemDtoAbstract) return (CatalogItemDtoAbstract<T,SpecT>) item;\n         throw new IllegalStateException(\"Cannot unwrap catalog item '\"+item+\"' (type \"+item.getClass()+\") to restore DTO\");\n     }\n \n-    private <T,SpecT> CatalogItemDtoAbstract<T,SpecT> getAbstractCatalogItem(String yaml) {\n-        CampPlatform camp = BrooklynServerConfig.getCampPlatform(mgmt).get();\n+    private CatalogItemDtoAbstract<?,?> getAbstractCatalogItem(String yaml) {\n+        DeploymentPlan plan = makePlanFromYaml(yaml);\n         \n-        DeploymentPlan plan = camp.pdp().parseDeploymentPlan(Streams.newReaderWithContents(yaml));\n+        // TODO #2 parse brooklyn.catalog for metadata - name, bundles/libraries, etc\n+        // (for now we default to taking the name from the plan or from a single service type therein, below)\n+        String name = null;\n+        CatalogLibrariesDto libraries = null;\n         \n-        // TODO #2 parse brooklyn.catalog metadata, bundles etc.\n-        // for now take the name from the plan or from a single service type therein\n+        // TODO #3 support version info\n         \n-        // TODO #3 version info\n+        // take name from plan if not specified in brooklyn.catalog section not supplied\n+        if (Strings.isBlank(name)) {\n+            name = plan.getName();\n+            if (Strings.isBlank(name)) {\n+                if (plan.getServices().size()==1) {\n+                    Service svc = Iterables.getOnlyElement(plan.getServices());\n+                    name = svc.getServiceType();\n+                }\n+            }\n+        }\n         \n-        // TODO #1 build the catalog item from the plan (as CatalogItem<Entity> ?)\n-//        plan.getName()\n-        // TODO #2 then support instantiating from the item, replacing \n+        // build the catalog item from the plan (as CatalogItem<Entity> for now)\n+        // TODO applications / templates\n+        // TODO long-term support policies etc\n         \n-        throw new UnsupportedOperationException();\n+        return CatalogItemDtoAbstract.newEntityFromPlan(name, libraries, plan, yaml);\n+    }\n+\n+    private DeploymentPlan makePlanFromYaml(String yaml) {\n+        CampPlatform camp = BrooklynServerConfig.getCampPlatform(mgmt).get();\n+        return camp.pdp().parseDeploymentPlan(Streams.newReaderWithContents(yaml));\n     }\n \n     @Override\n@@ -160,15 +227,15 @@ public void load() {\n         return itemDto;\n     }\n \n-    @Override @Deprecated\n+    @Override @Deprecated /** @deprecated see super */\n     public void addItem(CatalogItem<?,?> item) {\n         log.debug(\"Adding manual catalog item to \"+mgmt+\": \"+item);\n         Preconditions.checkNotNull(item, \"item\");\n         if (manualAdditionsCatalog==null) loadManualAdditionsCatalog();\n         manualAdditionsCatalog.addEntry(getAbstractCatalogItem(item));\n     }\n \n-    @Override @Deprecated\n+    @Override @Deprecated /** @deprecated see super */\n     public CatalogItem<?,?> addItem(Class<?> type) {\n         log.debug(\"Adding manual catalog item to \"+mgmt+\": \"+type);\n         Preconditions.checkNotNull(type, \"type\");\n@@ -177,7 +244,6 @@ public void addItem(CatalogItem<?,?> item) {\n         return manualAdditionsCatalog.classpath.addCatalogEntry(type);\n     }\n \n-    @Deprecated\n     private synchronized void loadManualAdditionsCatalog() {\n         if (manualAdditionsCatalog!=null) return;\n         CatalogDto manualAdditionsCatalogDto = CatalogDto.newNamedInstance(\n@@ -218,7 +284,6 @@ private synchronized void loadManualAdditionsCatalog() {\n         return Iterables.transform(filtered, BasicBrooklynCatalog.<T,SpecT>itemDoToDto());\n     }\n \n-    @SuppressWarnings({ \"unchecked\" })\n     private static <T,SpecT> Function<CatalogItemDo<T,SpecT>, CatalogItem<T,SpecT>> itemDoToDto() {\n         return new Function<CatalogItemDo<T,SpecT>, CatalogItem<T,SpecT>>() {\n             @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/BasicBrooklynCatalog.java",
                "sha": "6a4f3d2c46966ed3bc00c70b5de354b03ac3572c",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogClasspathDo.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogClasspathDo.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogClasspathDo.java",
                "patch": "@@ -207,7 +207,9 @@ public boolean apply(@Nullable Class<? extends T> input) {\n         return Iterables.filter(input, f);\n     }\n \n-    /** augments the given item with annotations and class data for the given class, then adds to catalog */\n+    /** augments the given item with annotations and class data for the given class, then adds to catalog\n+     * @deprecated since 0.7.0 the classpath DO is replaced by libraries */\n+    @Deprecated\n     public CatalogItem<?,?> addCatalogEntry(Class<?> c) {\n         if (Application.class.isAssignableFrom(c)) return addCatalogEntry(new CatalogTemplateItemDto(), c);\n         if (ApplicationBuilder.class.isAssignableFrom(c)) return addCatalogEntry(new CatalogTemplateItemDto(), c);\n@@ -217,10 +219,12 @@ public boolean apply(@Nullable Class<? extends T> input) {\n     }\n     \n     /** augments the given item with annotations and class data for the given class, then adds to catalog \n-     */\n+     * @deprecated since 0.7.0 the classpath DO is replaced by libraries */\n+    @Deprecated\n     public CatalogItem<?,?> addCatalogEntry(CatalogItemDtoAbstract<?,?> item, Class<?> c) {\n         Catalog annotations = c.getAnnotation(Catalog.class);\n-        item.type = c.getName();\n+        item.registeredType = c.getName();\n+        item.javaType = c.getName();\n         item.name = firstNonEmpty(c.getSimpleName(), c.getName());\n         if (annotations!=null) {\n             item.name = firstNonEmpty(annotations.name(), item.name);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogClasspathDo.java",
                "sha": "badf3191f373600928ee40533cbfa93a0d67856d",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogConfigurationDto.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogConfigurationDto.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogConfigurationDto.java",
                "patch": "@@ -12,4 +12,15 @@ public CatalogItemType getCatalogItemType() {\n     }\n \n     public Class<ConfigKey> getCatalogItemJavaType() { return ConfigKey.class; }\n+\n+    @Override\n+    public String getRegisteredTypeName() {\n+        return getJavaType();\n+    }\n+    \n+    @Override\n+    public Class<Void> getSpecType() {\n+        return null;\n+    }\n+    \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogConfigurationDto.java",
                "sha": "f07c9422da7c7f91b7d94fcd558615ec8b12165a",
                "status": "modified"
            },
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogDo.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogDo.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 4,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogDo.java",
                "patch": "@@ -92,10 +92,15 @@ private void loadCatalogClasspath() {\n \n     private void loadCatalogItems() {\n         List<CatalogLibrariesDo> loadedLibraries = Lists.newLinkedList();\n-        for (CatalogItemDtoAbstract<?,?> entry : dto.entries) {\n-            CatalogLibrariesDo library = new CatalogLibrariesDo(entry.getLibrariesDto());\n-            library.load(mgmt);\n-            loadedLibraries.add(library);\n+        List<CatalogItemDtoAbstract<?, ?>> entries = dto.entries;\n+        if (entries!=null) {\n+            for (CatalogItemDtoAbstract<?,?> entry : entries) {\n+                if (entry.getLibrariesDto()!=null) {\n+                    CatalogLibrariesDo library = new CatalogLibrariesDo(entry.getLibrariesDto());\n+                    library.load(mgmt);\n+                    loadedLibraries.add(library);\n+                }\n+            }\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogDo.java",
                "sha": "5cda68dc61e24720d05192b3a8e54765cd64c5c0",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogDto.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogDto.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 4,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogDto.java",
                "patch": "@@ -7,10 +7,11 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.base.Objects;\n-\n import brooklyn.util.ResourceUtils;\n import brooklyn.util.exceptions.Exceptions;\n+import brooklyn.util.exceptions.PropagatedRuntimeException;\n+\n+import com.google.common.base.Objects;\n \n public class CatalogDto {\n \n@@ -42,8 +43,8 @@ public static CatalogDto newDtoFromUrl(String url) {\n             if (LOG.isDebugEnabled()) LOG.debug(\"Retrieved catalog from: {}\", url);\n             return result;\n         } catch (Throwable t) {\n-            LOG.debug(\"Unable to retrieve catalog from: \" + url + \" (\" + t + \")\");\n-            throw Exceptions.propagate(t);\n+            Exceptions.propagateIfFatal(t);\n+            throw new PropagatedRuntimeException(\"Unable to retrieve catalog from \" + url + \": \" + t, t);\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogDto.java",
                "sha": "655ed29d3a1347830fa444436ea969e1a25cdcd4",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogEntityItemDto.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogEntityItemDto.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogEntityItemDto.java",
                "patch": "@@ -6,6 +6,8 @@\n \n public class CatalogEntityItemDto extends CatalogItemDtoAbstract<Entity,EntitySpec<?>> {\n     \n+    String planYaml;\n+\n     @Override\n     public CatalogItemType getCatalogItemType() {\n         return CatalogItemType.ENTITY;\n@@ -16,4 +18,14 @@ public CatalogItemType getCatalogItemType() {\n         return Entity.class;\n     }\n \n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    @Override\n+    public Class<EntitySpec<?>> getSpecType() {\n+        return (Class)EntitySpec.class;\n+    }\n+\n+    public String getPlanYaml() {\n+        return planYaml;\n+    }\n+    \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogEntityItemDto.java",
                "sha": "60d6fbe5f587accc8433e21ba8e1648d10828cf8",
                "status": "modified"
            },
            {
                "additions": 28,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogItemDo.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogItemDo.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 4,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogItemDo.java",
                "patch": "@@ -1,22 +1,23 @@\n package brooklyn.catalog.internal;\n \n import javax.annotation.Nonnull;\n-\n-import com.google.common.base.Preconditions;\n+import javax.annotation.Nullable;\n \n import brooklyn.catalog.CatalogItem;\n import brooklyn.util.exceptions.Exceptions;\n \n+import com.google.common.base.Preconditions;\n+\n public class CatalogItemDo<T,SpecT> implements CatalogItem<T,SpecT> {\n \n     protected final CatalogDo catalog;\n-    protected final CatalogItem<T,SpecT> itemDto;\n+    protected final CatalogItemDtoAbstract<T,SpecT> itemDto;\n \n     protected volatile Class<T> javaClass; \n     \n     public CatalogItemDo(CatalogDo catalog, CatalogItem<T,SpecT> itemDto) {\n         this.catalog = Preconditions.checkNotNull(catalog, \"catalog\");\n-        this.itemDto = Preconditions.checkNotNull(itemDto, \"itemDto\");\n+        this.itemDto = (CatalogItemDtoAbstract<T, SpecT>) Preconditions.checkNotNull(itemDto, \"itemDto\");\n     }\n \n     public CatalogItem<T,SpecT> getDto() {\n@@ -38,6 +39,11 @@ public String getId() {\n         return itemDto.getId();\n     }\n \n+    @Override\n+    public String getRegisteredTypeName() {\n+        return itemDto.getRegisteredTypeName();\n+    }\n+    \n     @Override\n     public String getJavaType() {\n         return itemDto.getJavaType();\n@@ -69,6 +75,17 @@ public CatalogItemLibraries getLibraries() {\n         return itemDto.getLibraries();\n     }\n \n+    @Nullable\n+    public String getYaml() {\n+        if (itemDto instanceof CatalogEntityItemDto) {\n+            return ((CatalogEntityItemDto)itemDto).getPlanYaml();\n+        }\n+        return null;\n+    }\n+    \n+    /** @deprecated since 0.7.0 this is the legacy mechanism; still needed for policies and apps, but being phased out.\n+     * new items should use {@link #getYaml()} */\n+    @Deprecated\n     public Class<T> getJavaClass() {\n         if (javaClass==null) loadJavaClass();\n         return javaClass;\n@@ -78,6 +95,9 @@ public CatalogItemLibraries getLibraries() {\n     protected Class<? extends T> loadJavaClass() {\n         try {\n             if (javaClass!=null) return javaClass;\n+            \n+            // TODO use OSGi\n+            \n             javaClass = (Class<T>) catalog.getRootClassLoader().loadClass(getJavaType());\n             return javaClass;\n         } catch (ClassNotFoundException e) {\n@@ -93,5 +113,9 @@ public String toString() {\n     public String toXmlString() {\n         return itemDto.toXmlString();\n     }\n+\n+    public Class<SpecT> getSpecType() {\n+        return itemDto.getSpecType();\n+    }\n     \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogItemDo.java",
                "sha": "200db52772895244ddfa3b81da2c52d8c24d6749",
                "status": "modified"
            },
            {
                "additions": 51,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogItemDtoAbstract.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogItemDtoAbstract.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 23,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogItemDtoAbstract.java",
                "patch": "@@ -1,26 +1,45 @@\n package brooklyn.catalog.internal;\n \n+import io.brooklyn.camp.spi.pdp.DeploymentPlan;\n+\n import javax.annotation.Nonnull;\n \n import brooklyn.catalog.CatalogItem;\n \n public abstract class CatalogItemDtoAbstract<T,SpecT> implements CatalogItem<T,SpecT> {\n \n+    // TODO are ID and registeredType the same?\n     String id;\n-    String type;\n+    String registeredType;\n+    \n+    String javaType;\n     String name;\n     String description;\n     String iconUrl;\n     String version;\n     CatalogLibrariesDto libraries;\n     \n+    /** @deprecated since 0.7.0.\n+     * used for backwards compatibility when deserializing.\n+     * when catalogs are converted to new yaml format, this can be removed. */\n+    @Deprecated\n+    String type;\n+    \n     public String getId() {\n         if (id!=null) return id;\n-        return type;\n+        return getRegisteredTypeName();\n+    }\n+    \n+    @Override\n+    public String getRegisteredTypeName() {\n+        if (registeredType!=null) return registeredType;\n+        return getJavaType();\n     }\n     \n     public String getJavaType() {\n-        return type;\n+        if (javaType!=null) return javaType;\n+        if (type!=null) return type;\n+        return null;\n     }\n     \n     public String getName() {\n@@ -49,41 +68,48 @@ public CatalogLibrariesDto getLibrariesDto() {\n         return libraries;\n     }\n \n-    public static CatalogTemplateItemDto newTemplate(String type, String name) {\n-        return newTemplate(null, type, name, null);\n+    public static CatalogTemplateItemDto newTemplateFromJava(String javaType, String name) {\n+        return newTemplateFromJava(null, javaType, name, null);\n     }\n-    public static CatalogTemplateItemDto newTemplate(String id, String type, String name, String description) {\n-        return newTemplate(id, type, name, description, null);\n+    public static CatalogTemplateItemDto newTemplateFromJava(String id, String javaType, String name, String description) {\n+        return newTemplateFromJava(id, javaType, name, description, null);\n     }\n-    public static CatalogTemplateItemDto newTemplate(String id, String type, String name, String description, CatalogLibrariesDto libraries) {\n-        return set(new CatalogTemplateItemDto(), id, type, name, description, libraries);\n+    public static CatalogTemplateItemDto newTemplateFromJava(String id, String javaType, String name, String description, CatalogLibrariesDto libraries) {\n+        return set(new CatalogTemplateItemDto(), id, javaType, javaType, name, description, libraries);\n     }\n \n-    public static CatalogEntityItemDto newEntity(String type, String name) {\n-        return newEntity(null, type, name, null);\n+    public static CatalogEntityItemDto newEntityFromPlan(String registeredTypeName, CatalogLibrariesDto libraries, DeploymentPlan plan, String underlyingPlanYaml) {\n+        CatalogEntityItemDto target = set(new CatalogEntityItemDto(), null, registeredTypeName, null, plan.getName(), plan.getDescription(), libraries);\n+        target.planYaml = underlyingPlanYaml;\n+        return target;\n     }\n-    public static CatalogEntityItemDto newEntity(String id, String type, String name, String description) {\n-        return newEntity(id, type, name, description, null);\n+    \n+    public static CatalogEntityItemDto newEntityFromJava(String javaType, String name) {\n+        return newEntityFromJava(null, javaType, name, null);\n+    }\n+    public static CatalogEntityItemDto newEntityFromJava(String id, String javaType, String name, String description) {\n+        return newEntityFromJava(id, javaType, name, description, null);\n     }\n-    public static CatalogEntityItemDto newEntity(String id, String type, String name, String description, CatalogLibrariesDto libraries) {\n-        return set(new CatalogEntityItemDto(), id, type, name, description, libraries);\n+    public static CatalogEntityItemDto newEntityFromJava(String id, String javaType, String name, String description, CatalogLibrariesDto libraries) {\n+        return set(new CatalogEntityItemDto(), id, javaType, javaType, name, description, libraries);\n     }\n \n-    public static CatalogPolicyItemDto newPolicy(String type, String name) {\n-        return newPolicy(null, type, name, null);\n+    public static CatalogPolicyItemDto newPolicyFromJava(String javaType, String name) {\n+        return newPolicyFromJava(null, javaType, name, null);\n     }\n-    public static CatalogPolicyItemDto newPolicy(String id, String type, String name, String description) {\n-        return newPolicy(id, type, name, description, null);\n+    public static CatalogPolicyItemDto newPolicyFromJava(String id, String javaType, String name, String description) {\n+        return newPolicyFromJava(id, javaType, name, description, null);\n     }\n-    public static CatalogPolicyItemDto newPolicy(String id, String type, String name, String description, CatalogLibrariesDto libraries) {\n-        return set(new CatalogPolicyItemDto(), id, type, name, description, libraries);\n+    public static CatalogPolicyItemDto newPolicyFromJava(String id, String javaType, String name, String description, CatalogLibrariesDto libraries) {\n+        return set(new CatalogPolicyItemDto(), id, javaType, javaType, name, description, libraries);\n     }\n \n     @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n-    private static <T extends CatalogItemDtoAbstract> T set(T target, String id, String type, String name,\n+    private static <T extends CatalogItemDtoAbstract> T set(T target, String id, String registeredType, String javaType, String name,\n             String description, CatalogLibrariesDto libraries) {\n         target.id = id;\n-        target.type = type;\n+        target.registeredType = registeredType;\n+        target.javaType = javaType;\n         target.name = name;\n         target.description = description;\n         target.libraries = libraries != null ? libraries : new CatalogLibrariesDto();\n@@ -106,5 +132,7 @@ private synchronized void loadSerializer() {\n         if (serializer==null) \n             serializer = new CatalogXmlSerializer();\n     }\n+\n+    public abstract Class<SpecT> getSpecType();\n     \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogItemDtoAbstract.java",
                "sha": "4957474c1a138d6060be6d80f04591c56da52f15",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDo.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDo.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 5,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDo.java",
                "patch": "@@ -5,18 +5,17 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.base.Joiner;\n-import com.google.common.base.Preconditions;\n-import com.google.common.base.Stopwatch;\n-\n import brooklyn.catalog.CatalogItem;\n import brooklyn.management.ManagementContext;\n import brooklyn.management.ha.OsgiManager;\n import brooklyn.management.internal.ManagementContextInternal;\n import brooklyn.util.guava.Maybe;\n-import brooklyn.util.text.Strings;\n import brooklyn.util.time.Time;\n \n+import com.google.common.base.Joiner;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Stopwatch;\n+\n public class CatalogLibrariesDo implements CatalogItem.CatalogItemLibraries {\n \n     private static final Logger LOG = LoggerFactory.getLogger(CatalogLibrariesDo.class);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDo.java",
                "sha": "0892c31d16a7a4edcc852c053fead8b512c906a8",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDto.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDto.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDto.java",
                "patch": "@@ -1,8 +1,10 @@\n package brooklyn.catalog.internal;\n \n+import java.util.Collections;\n import java.util.List;\n import java.util.concurrent.CopyOnWriteArrayList;\n \n+import com.google.common.base.Preconditions;\n import com.google.common.collect.ImmutableList;\n \n import brooklyn.catalog.CatalogItem;\n@@ -12,11 +14,16 @@\n     private List<String> bundles = new CopyOnWriteArrayList<String>();\n \n     public void addBundle(String url) {\n-        bundles.add(url);\n+        Preconditions.checkNotNull(url, \"Cannot add a bundle to a deserialized DTO\");\n+        bundles.add( Preconditions.checkNotNull(url) );\n     }\n \n     /** @return An immutable copy of the bundle URLs referenced by this object */\n     public List<String> getBundles() {\n+        if (bundles==null)  {\n+            // can be null on deserialization\n+            return Collections.emptyList();\n+        }\n         return ImmutableList.copyOf(bundles);\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogLibrariesDto.java",
                "sha": "a4089218b182ef080b822fdea8be84130f58ab7f",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogPolicyItemDto.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogPolicyItemDto.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogPolicyItemDto.java",
                "patch": "@@ -16,4 +16,10 @@ public CatalogItemType getCatalogItemType() {\n         return Policy.class;\n     }\n \n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    @Override\n+    public Class<PolicySpec<?>> getSpecType() {\n+        return (Class)PolicySpec.class;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogPolicyItemDto.java",
                "sha": "a07781997071c318e9621abbef2f69499719391b",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogTemplateItemDto.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/catalog/internal/CatalogTemplateItemDto.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 2,
                "filename": "core/src/main/java/brooklyn/catalog/internal/CatalogTemplateItemDto.java",
                "patch": "@@ -3,7 +3,7 @@\n import brooklyn.entity.Application;\n import brooklyn.entity.proxying.EntitySpec;\n \n-public class CatalogTemplateItemDto extends CatalogItemDtoAbstract<Application,EntitySpec<?>> {\n+public class CatalogTemplateItemDto extends CatalogItemDtoAbstract<Application,EntitySpec<? extends Application>> {\n \n     @Override\n     public CatalogItemType getCatalogItemType() {\n@@ -14,5 +14,11 @@ public CatalogItemType getCatalogItemType() {\n     public Class<Application> getCatalogItemJavaType() {\n         return Application.class;\n     }\n-    \n+\n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    @Override\n+    public Class<EntitySpec<? extends Application>> getSpecType() {\n+        return (Class)EntitySpec.class;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/catalog/internal/CatalogTemplateItemDto.java",
                "sha": "76531e93845331db142dd2cfc620dbc2e8c09267",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/entity/rebind/plane/dto/BasicManagementNodeSyncRecord.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/rebind/plane/dto/BasicManagementNodeSyncRecord.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 2,
                "filename": "core/src/main/java/brooklyn/entity/rebind/plane/dto/BasicManagementNodeSyncRecord.java",
                "patch": "@@ -78,8 +78,14 @@ public ManagementNodeSyncRecord build() {\n     private String nodeId;\n     private URI uri;\n     private ManagementNodeState status;\n-    private long localTimestamp;\n+    private Long localTimestamp;\n     private Long remoteTimestamp;\n+    \n+    /** @deprecated since 0.7.0, use {@link #localTimestamp} or {@link #remoteTimestamp},\n+     * but kept (or rather added back in) to support deserializing previous instances */\n+    @Deprecated\n+    private Long timestampUtc;\n+\n \n     // for de-serialization\n     @SuppressWarnings(\"unused\")\n@@ -118,7 +124,9 @@ public ManagementNodeState getStatus() {\n     \n     @Override\n     public long getLocalTimestamp() {\n-        return localTimestamp;\n+        if (localTimestamp!=null) return localTimestamp;\n+        if (timestampUtc!=null) return timestampUtc;\n+        throw new NullPointerException(\"localTimestamp not known for \"+getNodeId());\n     }\n     \n     @Override",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/main/java/brooklyn/entity/rebind/plane/dto/BasicManagementNodeSyncRecord.java",
                "sha": "2d9ea9120c9c345e25f8b34f309b63dde13d517d",
                "status": "modified"
            },
            {
                "additions": 23,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/camp/lite/CampPlatformWithJustBrooklynMgmt.java",
                "changes": 23,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/camp/lite/CampPlatformWithJustBrooklynMgmt.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "core/src/test/java/brooklyn/camp/lite/CampPlatformWithJustBrooklynMgmt.java",
                "patch": "@@ -0,0 +1,23 @@\n+package brooklyn.camp.lite;\n+\n+import io.brooklyn.camp.BasicCampPlatform;\n+import brooklyn.camp.brooklyn.api.HasBrooklynManagementContext;\n+import brooklyn.config.BrooklynProperties;\n+import brooklyn.config.BrooklynServerConfig;\n+import brooklyn.management.ManagementContext;\n+\n+public class CampPlatformWithJustBrooklynMgmt extends BasicCampPlatform implements HasBrooklynManagementContext {\n+\n+    private ManagementContext mgmt;\n+\n+    public CampPlatformWithJustBrooklynMgmt(ManagementContext mgmt) {\n+        this.mgmt = mgmt;\n+        ((BrooklynProperties)mgmt.getConfig()).put(BrooklynServerConfig.CAMP_PLATFORM, this);\n+    }\n+    \n+    @Override\n+    public ManagementContext getBrooklynManagementContext() {\n+        return mgmt;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/camp/lite/CampPlatformWithJustBrooklynMgmt.java",
                "sha": "89e6b2eeeb0eac548e72939319b964b0a1b912e3",
                "status": "added"
            },
            {
                "additions": 30,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/camp/lite/CampYamlLiteTest.java",
                "changes": 37,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/camp/lite/CampYamlLiteTest.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 7,
                "filename": "core/src/test/java/brooklyn/camp/lite/CampYamlLiteTest.java",
                "patch": "@@ -1,12 +1,10 @@\n package brooklyn.camp.lite;\n \n-import io.brooklyn.camp.BasicCampPlatform;\n import io.brooklyn.camp.spi.Assembly;\n import io.brooklyn.camp.spi.AssemblyTemplate;\n import io.brooklyn.camp.spi.pdp.PdpYamlTest;\n import io.brooklyn.camp.test.mock.web.MockWebPlatform;\n \n-import java.io.IOException;\n import java.io.InputStreamReader;\n import java.io.Reader;\n import java.util.Map;\n@@ -18,12 +16,17 @@\n import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.Test;\n \n+import brooklyn.catalog.CatalogItem;\n+import brooklyn.catalog.CatalogPredicates;\n import brooklyn.entity.Entity;\n+import brooklyn.entity.proxying.EntitySpec;\n import brooklyn.management.internal.LocalManagementContext;\n import brooklyn.test.entity.LocalManagementContextForTests;\n import brooklyn.test.entity.TestApplication;\n import brooklyn.test.entity.TestEntity;\n+import brooklyn.util.stream.Streams;\n \n+import com.google.common.base.Predicates;\n import com.google.common.collect.Iterables;\n \n /** Tests of lightweight CAMP integration. Since the \"real\" integration is in brooklyn-camp project,\n@@ -33,10 +36,12 @@\n     private static final Logger log = LoggerFactory.getLogger(CampYamlLiteTest.class);\n     \n     protected LocalManagementContext mgmt;\n+    protected CampPlatformWithJustBrooklynMgmt platform;\n     \n     @BeforeMethod(alwaysRun=true)\n     public void setUp() {\n-        mgmt = new LocalManagementContextForTests();        \n+        mgmt = new LocalManagementContextForTests();\n+        platform = new CampPlatformWithJustBrooklynMgmt(mgmt);\n     }\n     \n     @AfterMethod(alwaysRun=true)\n@@ -47,16 +52,17 @@ public void tearDown() {\n     /** based on {@link PdpYamlTest} for parsing,\n      * then creating a {@link TestAppAssembly} */\n     @Test\n-    public void testYamlServiceMatchAndBrooklynInstantiate() throws IOException {\n-        BasicCampPlatform platform = MockWebPlatform.populate(new BasicCampPlatform());\n+    public void testYamlServiceMatchAndBrooklynInstantiate() throws Exception {\n+        MockWebPlatform.populate(platform, TestAppAssemblyInstantiator.class);\n+        \n         Reader input = new InputStreamReader(getClass().getResourceAsStream(\"test-app-service-blueprint.yaml\"));\n         AssemblyTemplate at = platform.pdp().registerDeploymentPlan(input);\n         log.info(\"AT is:\\n\"+at.toString());\n         Assert.assertEquals(at.getName(), \"sample\");\n         Assert.assertEquals(at.getPlatformComponentTemplates().links().size(), 1);\n         \n         // now use brooklyn to instantiate\n-        Assembly assembly = new TestAppAssemblyInstantiator(mgmt).instantiate(at, platform);\n+        Assembly assembly = at.getInstantiator().newInstance().instantiate(at, platform);\n         \n         TestApplication app = ((TestAppAssembly)assembly).getBrooklynApp();\n         Assert.assertEquals( app.getConfig(TestEntity.CONF_NAME), \"sample\" );\n@@ -71,5 +77,22 @@ public void testYamlServiceMatchAndBrooklynInstantiate() throws IOException {\n         // desc ensures we got the information from the matcher, as this value is NOT in the yaml\n         Assert.assertEquals( map.get(\"desc\"), MockWebPlatform.APPSERVER.getDescription() );\n     }\n-    \n+\n+    @Test(groups=\"WIP\")\n+    public void testYamlServiceForCatalog() {\n+        MockWebPlatform.populate(platform, TestAppAssemblyInstantiator.class);\n+        \n+        CatalogItem<?, ?> realItem = mgmt.getCatalog().addItem(Streams.readFullyString(getClass().getResourceAsStream(\"test-app-service-blueprint.yaml\")));\n+        Iterable<CatalogItem<Object, Object>> retrievedItems = mgmt.getCatalog().getCatalogItems(CatalogPredicates.registeredType(Predicates.equalTo(\"sample\")));\n+        \n+        Assert.assertEquals(Iterables.size(retrievedItems), 1, \"Wrong retrieved items: \"+retrievedItems);\n+        CatalogItem<Object, Object> retrievedItem = Iterables.getOnlyElement(retrievedItems);\n+        Assert.assertEquals(retrievedItem, realItem);\n+        \n+        EntitySpec<?> spec1 = (EntitySpec<?>) mgmt.getCatalog().createSpec(retrievedItem);\n+        Assert.assertNotNull(spec1);\n+        Assert.assertEquals(spec1.getConfig().get(TestEntity.CONF_NAME), \"sample\");\n+        \n+        // TODO other assertions, about children\n+    }\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/camp/lite/CampYamlLiteTest.java",
                "sha": "9bbadf7b53e0e6e4a97e08f406a23dd9fbf0544b",
                "status": "modified"
            },
            {
                "additions": 32,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/camp/lite/TestAppAssemblyInstantiator.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/camp/lite/TestAppAssemblyInstantiator.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 8,
                "filename": "core/src/test/java/brooklyn/camp/lite/TestAppAssemblyInstantiator.java",
                "patch": "@@ -6,9 +6,11 @@\n import io.brooklyn.camp.spi.PlatformComponentTemplate;\n import io.brooklyn.camp.spi.collection.ResolvableLink;\n import io.brooklyn.camp.spi.instantiate.BasicAssemblyTemplateInstantiator;\n+import brooklyn.camp.brooklyn.api.AssemblyTemplateSpecInstantiator;\n+import brooklyn.camp.brooklyn.api.HasBrooklynManagementContext;\n import brooklyn.entity.basic.ApplicationBuilder;\n import brooklyn.entity.proxying.EntitySpec;\n-import brooklyn.management.internal.LocalManagementContext;\n+import brooklyn.management.ManagementContext;\n import brooklyn.test.entity.TestApplication;\n import brooklyn.test.entity.TestEntity;\n import brooklyn.util.collections.MutableMap;\n@@ -17,16 +19,20 @@\n  * all setting {@link TestEntity#CONF_NAME} for the name in the plan and in the service specs\n  * <p>\n  * the \"real\" instantiator for brooklyn is in brooklyn-camp project, not visible here, so let's have something we can test */\n-public class TestAppAssemblyInstantiator extends BasicAssemblyTemplateInstantiator {\n+public class TestAppAssemblyInstantiator extends BasicAssemblyTemplateInstantiator implements AssemblyTemplateSpecInstantiator {\n \n-    protected final LocalManagementContext mgmt;\n-    \n-    public TestAppAssemblyInstantiator(LocalManagementContext mgmt) {\n-        this.mgmt = mgmt;\n-    }\n-    \n     @Override\n     public Assembly instantiate(AssemblyTemplate template, CampPlatform platform) {\n+        if (!(platform instanceof HasBrooklynManagementContext)) {\n+            throw new IllegalStateException(\"Instantiator can only be used with CAMP platforms with a Brooklyn management context\");\n+        }\n+        ManagementContext mgmt = ((HasBrooklynManagementContext)platform).getBrooklynManagementContext();\n+        \n+        // TODO when createSpec is working:\n+//        TestApplication app = (TestApplication) mgmt.getEntityManager().createEntity( createSpec(template, platform) );\n+//        mgmt.getEntityManager().manage(app);\n+        \n+        // workaround until above is reacy\n         TestApplication app = ApplicationBuilder.newManagedApp(EntitySpec.create(TestApplication.class)\n             .configure(TestEntity.CONF_NAME, template.getName())\n             .configure(TestEntity.CONF_MAP_THING, MutableMap.of(\"type\", template.getType(), \"desc\", template.getDescription()))\n@@ -37,7 +43,25 @@ public Assembly instantiate(AssemblyTemplate template, CampPlatform platform) {\n                 .configure(TestEntity.CONF_MAP_THING, MutableMap.of(\"type\", t.resolve().getType(), \"desc\", t.resolve().getDescription()))\n                 );\n         }\n+\n         return new TestAppAssembly(app);\n     }\n \n+    @Override\n+    public EntitySpec<?> createSpec(AssemblyTemplate template, CampPlatform platform) {\n+        EntitySpec<TestApplication> app = EntitySpec.create(TestApplication.class)\n+            .configure(TestEntity.CONF_NAME, template.getName())\n+            .configure(TestEntity.CONF_MAP_THING, MutableMap.of(\"type\", template.getType(), \"desc\", template.getDescription()));\n+        \n+        for (ResolvableLink<PlatformComponentTemplate> t: template.getPlatformComponentTemplates().links()) {\n+            // TODO use EntitySpec.child(...)\n+//            app.child(EntitySpec.create(TestEntity.class)\n+//                .configure(TestEntity.CONF_NAME, t.getName())\n+//                .configure(TestEntity.CONF_MAP_THING, MutableMap.of(\"type\", t.resolve().getType(), \"desc\", t.resolve().getDescription()))\n+//                );\n+        }\n+        \n+        return app;\n+    }\n+\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/camp/lite/TestAppAssemblyInstantiator.java",
                "sha": "e8b7ff863c7c5051576676c1e93b2c3e77396c40",
                "status": "modified"
            },
            {
                "additions": 36,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/catalog/internal/CatalogDtoTest.java",
                "changes": 74,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/catalog/internal/CatalogDtoTest.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 38,
                "filename": "core/src/test/java/brooklyn/catalog/internal/CatalogDtoTest.java",
                "patch": "@@ -11,6 +11,10 @@\n import brooklyn.entity.basic.Entities;\n import brooklyn.management.internal.LocalManagementContext;\n import brooklyn.test.entity.LocalManagementContextForTests;\n+import brooklyn.test.entity.TestApplication;\n+import brooklyn.test.entity.TestEntity;\n+import brooklyn.util.BrooklynMavenArtifacts;\n+import brooklyn.util.maven.MavenRetriever;\n \n public class CatalogDtoTest {\n \n@@ -31,28 +35,31 @@ public void tearDown() throws Exception {\n     @Test(groups=\"Integration\")\n     public void testCatalogLookup() {\n         CatalogDto root = buildExampleCatalog();\n-        checkHadoopsExample(root);\n+        checkCatalogHealthy(root);\n     }\n     \n     @Test(groups=\"Integration\")\n     public void testCatalogSerializeAndLookup() {\n         CatalogDto root = buildExampleCatalog();\n-        CatalogXmlSerializer seriailizer = new CatalogXmlSerializer();\n+        CatalogXmlSerializer serializer = new CatalogXmlSerializer();\n         \n-        String xml = seriailizer.toString(root);\n-        log.info(\"Hadoops example catalog serialized as:\\n\"+xml);\n+        String xml = serializer.toString(root);\n+        log.info(\"Example catalog serialized as:\\n\"+xml);\n         \n-        CatalogDto root2 = (CatalogDto) seriailizer.fromString(xml);\n-        checkHadoopsExample(root2);\n+        CatalogDto root2 = (CatalogDto) serializer.fromString(xml);\n+        checkCatalogHealthy(root2);\n     }\n \n-    protected void checkHadoopsExample(CatalogDto root) {\n-        Assert.assertEquals(root.catalogs.size(), 5);\n+    protected void checkCatalogHealthy(CatalogDto root) {\n+        Assert.assertEquals(root.catalogs.size(), 4);\n         CatalogDo loader = new CatalogDo(root).load(managementContext, null);\n         \n-        CatalogItemDo<?,?> worker = loader.getCache().get(\"io.brooklyn.mapr.m3.WorkerNode\");\n+        // test app comes from jar, by default\n+        CatalogItemDo<?,?> worker = loader.getCache().get(TestApplication.class.getCanonicalName());\n         Assert.assertNotNull(worker);\n-        Assert.assertEquals(worker.getName(), \"M3 Worker Node\");\n+        Assert.assertEquals(worker.getName(), \"Test App from JAR\");\n+        \n+        // TODO can test scanned elements, links to other catalogs, etc\n     }\n \n     public static CatalogDto buildExampleCatalog() {\n@@ -61,39 +68,30 @@ public static CatalogDto buildExampleCatalog() {\n         \t\t\"intended partly as a teaching example for what can be expressed, and how\"));\n         root.setClasspathScanForEntities(CatalogScanningModes.NONE);\n         \n-        CatalogDo m3Catalog = new CatalogDo(CatalogDto.newNamedInstance(\"MapR M3\", null));\n-        m3Catalog.addToClasspath(\"file://~/.m2/repository/io/cloudsoft/brooklyn-mapr/1.0.0-SNAPSHOT/brooklyn-mapr.jar\");\n-        m3Catalog.addEntry(CatalogItemDtoAbstract.newTemplate(\n-                \"io.brooklyn.mapr.M3App\", \"M3 Application\"));\n-        m3Catalog.addEntry(CatalogItemDtoAbstract.newEntity(\n-                \"io.brooklyn.mapr.m3.ZookeperWorkerNode\", \"M3 Zookeeper+Worker Node\"));\n-        m3Catalog.addEntry(CatalogItemDtoAbstract.newEntity(\n-                \"io.brooklyn.mapr.m3.WorkerNode\", \"M3 Worker Node\"));\n-        root.addCatalog(m3Catalog.dto);\n-        \n-        CatalogDo cdhCatalog = new CatalogDo(CatalogDto.newNamedInstance(\"Cloudera\", \n-                \"CDH catalog, pointing to JARs as I have them installed on my machine already, \"+\n-                \"tweaked for my preferences (overriding templates scanned from these JARs)\"));\n-        cdhCatalog.setClasspathScanForEntities(CatalogScanningModes.ANNOTATIONS);\n-        cdhCatalog.addToClasspath(\n-                \"file://~/.m2/repository/io/cloudsoft/brooklyn-cdh/1.0.0-SNAPSHOT/brooklyn-cdh.jar\",\n-                \"file://~/.m2/repository/io/cloudsoft/brooklyn-cdh/1.0.0-SNAPSHOT/whirr-cm.jar\");\n-        cdhCatalog.addEntry(CatalogItemDtoAbstract.newTemplate(\n-                \"io.brooklyn.cloudera.ClouderaForHadoopWithManager\",\n-                \"RECOMMENDED: CDH Hadoop Application with Cloudera Manager\"));\n-        root.addCatalog(cdhCatalog.dto);\n+        CatalogDo testEntitiesJavaCatalog = new CatalogDo(CatalogDto.newNamedInstance(\"Test Entities from Java\", null));\n+        testEntitiesJavaCatalog.setClasspathScanForEntities(CatalogScanningModes.NONE);\n+        testEntitiesJavaCatalog.addToClasspath(MavenRetriever.localUrl(BrooklynMavenArtifacts.artifact(\"\", \"brooklyn-core\", \"jar\", \"tests\")));\n+        testEntitiesJavaCatalog.addEntry(CatalogItemDtoAbstract.newTemplateFromJava(\n+                TestApplication.class.getCanonicalName(), \"Test App from JAR\"));\n+        testEntitiesJavaCatalog.addEntry(CatalogItemDtoAbstract.newEntityFromJava(\n+                TestEntity.class.getCanonicalName(), \"Test Entity from JAR\"));\n+        root.addCatalog(testEntitiesJavaCatalog.dto);\n \n-        CatalogDo osgiCatalog = new CatalogDo(CatalogDto.newNamedInstance(\"OSGi\",\n+        CatalogDo testEntitiesJavaCatalogScanning = new CatalogDo(CatalogDto.newNamedInstance(\"Test Entities from Java Scanning\", null));\n+        testEntitiesJavaCatalogScanning.addToClasspath(MavenRetriever.localUrl(BrooklynMavenArtifacts.artifact(\"\", \"brooklyn-core\", \"jar\", \"tests\")));\n+        testEntitiesJavaCatalogScanning.setClasspathScanForEntities(CatalogScanningModes.ANNOTATIONS);\n+        root.addCatalog(testEntitiesJavaCatalogScanning.dto);\n+        \n+        CatalogDo osgiCatalog = new CatalogDo(CatalogDto.newNamedInstance(\"Test Entities from OSGi\",\n                 \"A catalog whose entries define their libraries as a list of OSGi bundles\"));\n         osgiCatalog.setClasspathScanForEntities(CatalogScanningModes.NONE);\n-        CatalogLibrariesDto m3Context = new CatalogLibrariesDto();\n-        m3Context.addBundle(\"file://~/.m2/repository/io/cloudsoft/brooklyn-mapr/1.0.0-SNAPSHOT/brooklyn-mapr.jar\");\n-        osgiCatalog.addEntry(CatalogItemDtoAbstract.newTemplate(\"M3App\", \"io.brooklyn.mapr.M3App\", \"M3 Application\",\n-                \"Description\", m3Context));\n+        CatalogEntityItemDto osgiEntity = CatalogItemDtoAbstract.newEntityFromJava(TestEntity.class.getCanonicalName(), \"Test Entity from OSGi\");\n+        // NB: this is not actually an OSGi bundle, but it's okay as we don't instantiate the bundles ahead of time (currently)\n+        osgiEntity.libraries.addBundle(MavenRetriever.localUrl(BrooklynMavenArtifacts.artifact(\"\", \"brooklyn-core\", \"jar\", \"tests\")));\n+        testEntitiesJavaCatalog.addEntry(osgiEntity);\n         root.addCatalog(osgiCatalog.dto);\n \n-        root.addCatalog(CatalogDto.newLinkedInstance(\"http://cloudsoftcorp.com/amp-brooklyn-catalog.xml\"));\n-        root.addCatalog(CatalogDto.newLinkedInstance(\"http://microsoot.com/oofice-catalog.xml\"));\n+        root.addCatalog(CatalogDto.newLinkedInstance(\"classpath://brooklyn-catalog-empty.xml\"));\n         return root.dto;\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/core/src/test/java/brooklyn/catalog/internal/CatalogDtoTest.java",
                "sha": "1989cb22de02cd493a2e615f7e731daa3eb5c7c7",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/BrooklynCampPlatform.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/BrooklynCampPlatform.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 1,
                "filename": "usage/camp/src/main/java/io/brooklyn/camp/brooklyn/BrooklynCampPlatform.java",
                "patch": "@@ -5,8 +5,8 @@\n import io.brooklyn.camp.brooklyn.spi.creation.BrooklynEntityMatcher;\n import io.brooklyn.camp.brooklyn.spi.dsl.BrooklynDslInterpreter;\n import io.brooklyn.camp.brooklyn.spi.platform.BrooklynImmutableCampPlatform;\n-import io.brooklyn.camp.brooklyn.spi.platform.HasBrooklynManagementContext;\n import io.brooklyn.camp.spi.PlatformRootSummary;\n+import brooklyn.camp.brooklyn.api.HasBrooklynManagementContext;\n import brooklyn.config.BrooklynProperties;\n import brooklyn.management.ManagementContext;\n import brooklyn.management.ManagementContext.PropertiesReloadListener;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/BrooklynCampPlatform.java",
                "sha": "32102eea744b126f89b31c50433c6ce0746a701c",
                "status": "modified"
            },
            {
                "additions": 25,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/creation/BrooklynAssemblyTemplateInstantiator.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/creation/BrooklynAssemblyTemplateInstantiator.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 10,
                "filename": "usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/creation/BrooklynAssemblyTemplateInstantiator.java",
                "patch": "@@ -1,12 +1,10 @@\n package io.brooklyn.camp.brooklyn.spi.creation;\n \n import io.brooklyn.camp.CampPlatform;\n-import io.brooklyn.camp.brooklyn.spi.platform.HasBrooklynManagementContext;\n import io.brooklyn.camp.spi.Assembly;\n import io.brooklyn.camp.spi.AssemblyTemplate;\n import io.brooklyn.camp.spi.PlatformComponentTemplate;\n import io.brooklyn.camp.spi.collection.ResolvableLink;\n-import io.brooklyn.camp.spi.instantiate.AssemblyTemplateInstantiator;\n \n import java.lang.reflect.Constructor;\n import java.util.LinkedHashMap;\n@@ -17,6 +15,8 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import brooklyn.camp.brooklyn.api.AssemblyTemplateSpecInstantiator;\n+import brooklyn.camp.brooklyn.api.HasBrooklynManagementContext;\n import brooklyn.catalog.BrooklynCatalog;\n import brooklyn.catalog.CatalogItem;\n import brooklyn.config.ConfigKey;\n@@ -44,7 +44,7 @@\n \n import com.google.common.collect.Maps;\n \n-public class BrooklynAssemblyTemplateInstantiator implements AssemblyTemplateInstantiator {\n+public class BrooklynAssemblyTemplateInstantiator implements AssemblyTemplateSpecInstantiator {\n \n     private static final Logger log = LoggerFactory.getLogger(BrooklynAssemblyTemplateInstantiator.class);\n     \n@@ -76,6 +76,11 @@ public Application create(AssemblyTemplate template, CampPlatform platform) {\n         }\n     }\n \n+    public EntitySpec<?> createSpec(AssemblyTemplate template, CampPlatform platform) {\n+        // TODO rewrite this class so everything below returns a spec, then rewrite above just to instantiate (and start?) the spec\n+        throw new UnsupportedOperationException();\n+    }\n+    \n     protected Application createApplicationFromCatalog(CampPlatform platform, CatalogItem<?,?> item, AssemblyTemplate template) {\n         ManagementContext mgmt = getBrooklynManagementContext(platform);\n \n@@ -112,9 +117,7 @@ protected Application createApplicationFromCatalog(CampPlatform platform, Catalo\n                 appBuilder.configure( convertFlagsToKeys(appBuilder.getType(), configO) );\n                 instance = appBuilder.manage(mgmt);\n                 \n-                List<Location> locations = new BrooklynYamlLocationResolver(mgmt).resolveLocations(template.getCustomAttributes(), false);\n-                if (locations!=null)\n-                    ((EntityInternal)instance).addLocations(locations);\n+                applyLocations(mgmt, template, instance);\n                 \n             } else if (Application.class.isAssignableFrom(clazz)) {\n                 // TODO use resolver's configureEntitySpec instead\n@@ -126,9 +129,7 @@ protected Application createApplicationFromCatalog(CampPlatform platform, Catalo\n                 log.info(\"CAMP placing '{}' under management\", instance);\n                 Entities.startManagement(instance, mgmt);\n                 \n-                List<Location> locations = new BrooklynYamlLocationResolver(mgmt).resolveLocations(template.getCustomAttributes(), false);\n-                if (locations!=null)\n-                    ((EntityInternal)instance).addLocations(locations);\n+                applyLocations(mgmt, template, instance);\n                 \n             } else {\n                 throw new IllegalArgumentException(\"Class \"+clazz+\" must extend one of ApplicationBuilder or Application\");\n@@ -142,6 +143,12 @@ protected Application createApplicationFromCatalog(CampPlatform platform, Catalo\n         }\n     }\n \n+    private void applyLocations(ManagementContext mgmt, AssemblyTemplate template, final Application instance) {\n+        List<Location> locations = new BrooklynYamlLocationResolver(mgmt).resolveLocations(template.getCustomAttributes(), false);\n+        if (locations!=null)\n+            ((EntityInternal)instance).addLocations(locations);\n+    }\n+\n     private ManagementContext getBrooklynManagementContext(CampPlatform platform) {\n         return ((HasBrooklynManagementContext)platform).getBrooklynManagementContext();\n     }\n@@ -216,6 +223,13 @@ protected Application createApplicationFromNonCatalogCampTemplate(AssemblyTempla\n \n         Map<Entity, EntitySpec<?>> rootEntities = Maps.newLinkedHashMap();\n         Map<Entity, EntitySpec<?>> allEntities = Maps.newLinkedHashMap();\n+        /* FIXME there is a subtlety here, and tests failing;\n+         * OT1H we might not want/need the wrapper application if we are creating a single one,   \n+         * but OTOH we might need a guarantee of an app at root, if we are creating certain nested entities\n+         * \n+         * i (alex) think the solution is to use the new createSpec(...) and interrogate it\n+         * to see if we need the wrapper or not\n+         */\n         buildEntities(template, rootEntities, allEntities, mgmt);\n         \n         EntitySpec<StartableApplication> appSpec;\n@@ -230,11 +244,12 @@ protected Application createApplicationFromNonCatalogCampTemplate(AssemblyTempla\n             Entry<Entity, EntitySpec<?>> entry = rootEntities.entrySet().iterator().next();\n             app = (StartableApplication)entry.getKey();\n             appSpec = (EntitySpec<StartableApplication>)entry.getValue();\n+            applyLocations(mgmt, template, app);\n         }\n         \n         initEntities(mgmt, allEntities);\n         \n-        log.info(\"CAMP placing '{}' under management\", appSpec);\n+        log.info(\"CAMP placing '{}' under`` management\", appSpec);\n         Entities.startManagement(app, mgmt);\n \n         return app;",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/creation/BrooklynAssemblyTemplateInstantiator.java",
                "sha": "fbdd5ec2d27ab11c6f63e7be22d4f7ac4379604a",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/platform/BrooklynImmutableCampPlatform.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/platform/BrooklynImmutableCampPlatform.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 0,
                "filename": "usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/platform/BrooklynImmutableCampPlatform.java",
                "patch": "@@ -16,6 +16,7 @@\n import io.brooklyn.camp.spi.collection.BasicResourceLookup;\n import io.brooklyn.camp.spi.collection.ResourceLookup;\n import io.brooklyn.camp.spi.collection.ResourceLookup.EmptyResourceLookup;\n+import brooklyn.camp.brooklyn.api.HasBrooklynManagementContext;\n import brooklyn.management.ManagementContext;\n \n /** Immutable CAMP platform which reflects things in the underlying Brooklyn system */",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/main/java/io/brooklyn/camp/brooklyn/spi/platform/BrooklynImmutableCampPlatform.java",
                "sha": "8ddcddaf7931738c35b19104d6195aa9e91f6c63",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/test/java/io/brooklyn/camp/brooklyn/EmptySoftwareProcessYamlTest.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/camp/src/test/java/io/brooklyn/camp/brooklyn/EmptySoftwareProcessYamlTest.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 2,
                "filename": "usage/camp/src/test/java/io/brooklyn/camp/brooklyn/EmptySoftwareProcessYamlTest.java",
                "patch": "@@ -55,14 +55,14 @@ public void testProvisioningPropertiesViaJsonya() throws Exception {\n \n     @Test\n     // for issue #1377\n-    // currently provisions in the loopback-on-app location, rather surprisingly;\n-    // but not sure that's the desired behaviour\n     public void testWithAppAndEntityLocations() throws Exception {\n         Entity app = createAndStartApplication(Streams.newReaderWithContents(\"services:\\n\"+\n             \"- serviceType: \"+EmptySoftwareProcess.class.getName()+\"\\n\"+\n             \"  location: localhost:(name=localhost on entity)\"+\"\\n\"+\n             \"location: byon:(hosts=\\\"127.0.0.1\\\", name=loopback on app)\"));\n         waitForApplicationTasks(app);\n+        Entities.dumpInfo(app);\n+        \n         Assert.assertEquals(app.getLocations().size(), 1);\n         Assert.assertEquals(app.getChildren().size(), 1);\n         Entity entity = app.getChildren().iterator().next();\n@@ -75,6 +75,7 @@ public void testWithAppAndEntityLocations() throws Exception {\n         Assert.assertEquals(entityLocationIterator.next().getDisplayName(), \"localhost on entity\");\n         Location actualMachine = entityLocationIterator.next();\n         Assert.assertTrue(actualMachine instanceof SshMachineLocation, \"wrong location: \"+actualMachine);\n+        // TODO this, below, probably should be 'localhost on entity', see #1377\n         Assert.assertEquals(actualMachine.getParent().getDisplayName(), \"loopback on app\");\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/camp/src/test/java/io/brooklyn/camp/brooklyn/EmptySoftwareProcessYamlTest.java",
                "sha": "c4703e8e87e90f96b80065cadaa9ee7cb306fe5f",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/cli/src/main/java/brooklyn/cli/Main.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/cli/src/main/java/brooklyn/cli/Main.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 1,
                "filename": "usage/cli/src/main/java/brooklyn/cli/Main.java",
                "patch": "@@ -402,7 +402,13 @@ public Void call() throws Exception {\n             BrooklynServerDetails server = launcher.getServerDetails();\n             ManagementContext ctx = server.getManagementContext();\n             \n-            populateCatalog(launcher.getServerDetails().getManagementContext().getCatalog());\n+            try {\n+                populateCatalog(launcher.getServerDetails().getManagementContext().getCatalog());\n+            } catch (Exception e) {\n+                Exceptions.propagateIfFatal(e);\n+                // don't fail to start just because catalog is not available\n+                log.error(\"Error populating catalog: \"+e, e);\n+            }\n \n             if (verbose) {\n                 Entities.dumpInfo(launcher.getApplications());",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/cli/src/main/java/brooklyn/cli/Main.java",
                "sha": "0a0e67bb038351ee3d0a63ae1427eb3616e7bc31",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 4,
                "filename": "usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "patch": "@@ -32,6 +32,7 @@\n import brooklyn.entity.basic.ApplicationBuilder;\n import brooklyn.entity.basic.BrooklynShutdownHooks;\n import brooklyn.entity.basic.Entities;\n+import brooklyn.entity.basic.EntityInternal;\n import brooklyn.entity.basic.StartableApplication;\n import brooklyn.entity.proxying.EntitySpec;\n import brooklyn.entity.rebind.RebindManager;\n@@ -628,9 +629,8 @@ protected void createApps() {\n     }\n \n     protected Application getAppFromYaml(String input) {\n-        AssemblyTemplate at = campPlatform.pdp()\n-                .registerDeploymentPlan(new StringReader(input));\n-         BrooklynAssemblyTemplateInstantiator instantiator;\n+        AssemblyTemplate at = campPlatform.pdp().registerDeploymentPlan(new StringReader(input));\n+        BrooklynAssemblyTemplateInstantiator instantiator;\n         try {\n             AssemblyTemplateInstantiator ati = at.getInstantiator().newInstance();\n             if (ati instanceof BrooklynAssemblyTemplateInstantiator) {\n@@ -641,7 +641,9 @@ protected Application getAppFromYaml(String input) {\n         } catch (Exception e) {\n             throw Exceptions.propagate(e);\n         }\n-        return instantiator.create(at, campPlatform);\n+        Application app = instantiator.create(at, campPlatform);\n+//        ((EntityInternal)app).addLocations(XXX);\n+        return app;\n     }\n     \n     protected void startApps() {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "sha": "9e8c01a2a791f8c7c578058d85f5ed14d0bfe162",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/rest-server/src/main/java/brooklyn/rest/resources/AbstractBrooklynRestResource.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-server/src/main/java/brooklyn/rest/resources/AbstractBrooklynRestResource.java?ref=bd8f179d8e860392f89ae15c0541c50da5059fe6",
                "deletions": 3,
                "filename": "usage/rest-server/src/main/java/brooklyn/rest/resources/AbstractBrooklynRestResource.java",
                "patch": "@@ -8,6 +8,7 @@\n \n import org.codehaus.jackson.map.ObjectMapper;\n \n+import brooklyn.config.BrooklynServerConfig;\n import brooklyn.config.BrooklynServiceAttributes;\n import brooklyn.management.ManagementContext;\n import brooklyn.rest.util.BrooklynRestResourceUtils;\n@@ -63,9 +64,7 @@ protected Object getValueForDisplay(Object value, boolean preferJson, boolean is\n     }\n \n     protected CampPlatform camp() {\n-        CampPlatform camp = mgmt().getConfig().getConfig(BrooklynCampConstants.CAMP_PLATFORM);\n-        if (camp!=null) return camp;\n-        throw new IllegalStateException(\"CAMP platform server not enabled\");\n+        return BrooklynServerConfig.getCampPlatform(mgmt()).get();\n     }\n     \n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bd8f179d8e860392f89ae15c0541c50da5059fe6/usage/rest-server/src/main/java/brooklyn/rest/resources/AbstractBrooklynRestResource.java",
                "sha": "6dc15ade8ec81f0b3e3605f53e45a14a90732074",
                "status": "modified"
            }
        ],
        "message": "create specs from catalog items, and use these in many places.  also fix some NPE and serialization issues.",
        "parent": "https://github.com/apache/brooklyn-server/commit/e1c1a3590ad9bbc6c1647be4f5acc2ce198fb286",
        "patched_files": [
            "CatalogConfigurationDto.java",
            "BasicBrooklynCatalog.java",
            "BrooklynAssemblyTemplateInstantiator.java",
            "CatalogPredicates.java",
            "CatalogDo.java",
            "AbstractBrooklynRestResource.java",
            "CatalogItemDo.java",
            "CatalogItem.java",
            "BrooklynCampPlatform.java",
            "AssemblyTemplateSpecInstantiator.java",
            "BrooklynLauncher.java",
            "CampPlatformWithJustBrooklynMgmt.java",
            "CatalogItemDtoAbstract.java",
            "CatalogDto.java",
            "BasicManagementNodeSyncRecord.java",
            "CatalogEntityItemDto.java",
            "CatalogLibrariesDo.java",
            "CatalogLibrariesDto.java",
            "MockWebPlatform.java",
            "BrooklynImmutableCampPlatform.java",
            "CatalogTemplateItemDto.java",
            "CatalogPolicyItemDto.java",
            "CatalogClasspathDo.java",
            "Main.java",
            "HasBrooklynManagementContext.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BrooklynLauncherTest.java",
            "TestAppAssemblyInstantiator.java",
            "CampYamlLiteTest.java",
            "EmptySoftwareProcessYamlTest.java",
            "CatalogDtoTest.java"
        ]
    },
    "brooklyn-server_bfe7f8c": {
        "bug_id": "brooklyn-server_bfe7f8c",
        "commit": "https://github.com/apache/brooklyn-server/commit/bfe7f8c8d31103c097cdda0205f20a2733e44c46",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/bfe7f8c8d31103c097cdda0205f20a2733e44c46/usage/rest-server/src/main/java/brooklyn/rest/resources/SensorResource.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-server/src/main/java/brooklyn/rest/resources/SensorResource.java?ref=bfe7f8c8d31103c097cdda0205f20a2733e44c46",
                "deletions": 1,
                "filename": "usage/rest-server/src/main/java/brooklyn/rest/resources/SensorResource.java",
                "patch": "@@ -124,7 +124,7 @@ public void delete(String application, String entityToken, String sensorName) {\n         final EntityLocal entity = brooklyn().getEntity(application, entityToken);\n         AttributeSensor<?> sensor = findSensor(entity, sensorName);\n         if (log.isDebugEnabled())\n-            log.debug(\"REST user \"+Entitlements.getEntitlementContext().user()+\" deleting sensor \"+sensorName);\n+            log.debug(\"REST user \"+Entitlements.getEntitlementContext()+\" deleting sensor \"+sensorName);\n         ((EntityInternal)entity).removeAttribute(sensor);\n     }\n     ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/bfe7f8c8d31103c097cdda0205f20a2733e44c46/usage/rest-server/src/main/java/brooklyn/rest/resources/SensorResource.java",
                "sha": "fedd60dc9614620058012b4cbd7a61d9c43561fe",
                "status": "modified"
            }
        ],
        "message": "fix NPE in SensorResource",
        "parent": "https://github.com/apache/brooklyn-server/commit/fb265335b7bf9d082670431a9953e6eb48b9a859",
        "patched_files": [
            "SensorResource.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "SensorResourceTest.java"
        ]
    },
    "brooklyn-server_c545381": {
        "bug_id": "brooklyn-server_c545381",
        "commit": "https://github.com/apache/brooklyn-server/commit/c545381152a22df29d16c063fd6cd2fab4ec7b33",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/c545381152a22df29d16c063fd6cd2fab4ec7b33/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java?ref=c545381152a22df29d16c063fd6cd2fab4ec7b33",
                "deletions": 1,
                "filename": "rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java",
                "patch": "@@ -171,7 +171,7 @@ public String getMessage() {\n         public static BundleInstallationRestResult of(OsgiBundleInstallationResult in, ManagementContext mgmt, BrooklynRestResourceUtils brooklynU, UriInfo ui) {\n             BundleInstallationRestResult result = new BundleInstallationRestResult();\n             result.message = in.getMessage();\n-            result.bundle = in.getMetadata().getVersionedName().toString();\n+            result.bundle = in.getVersionedName() != null ? in.getVersionedName().toString() : \"\";\n             result.code = in.getCode();\n             if (in.getCatalogItemsInstalled()!=null) {\n                 result.types = MutableMap.of();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/c545381152a22df29d16c063fd6cd2fab4ec7b33/rest/rest-resources/src/main/java/org/apache/brooklyn/rest/resources/CatalogResource.java",
                "sha": "2d7487d481152cdb8c8946b7390df09452520a3f",
                "status": "modified"
            }
        ],
        "message": "Check versionedName to avoid NPE.\n\nFixes break from https://github.com/apache/brooklyn-server/pull/672,\nI merged without re-running unit tests :-(",
        "parent": "https://github.com/apache/brooklyn-server/commit/57b9d7270ba87486f311020bf62b37105d4ca0e4",
        "patched_files": [
            "CatalogResource.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "CatalogResourceTest.java"
        ]
    },
    "brooklyn-server_c713529": {
        "bug_id": "brooklyn-server_c713529",
        "commit": "https://github.com/apache/brooklyn-server/commit/c713529a99bdb4b22ed4035c4d1b9bff05229cd0",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/c713529a99bdb4b22ed4035c4d1b9bff05229cd0/core/src/main/java/org/apache/brooklyn/core/mgmt/rebind/BasicCatalogItemRebindSupport.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/mgmt/rebind/BasicCatalogItemRebindSupport.java?ref=c713529a99bdb4b22ed4035c4d1b9bff05229cd0",
                "deletions": 3,
                "filename": "core/src/main/java/org/apache/brooklyn/core/mgmt/rebind/BasicCatalogItemRebindSupport.java",
                "patch": "@@ -18,15 +18,12 @@\n  */\n package org.apache.brooklyn.core.mgmt.rebind;\n \n-import java.util.Set;\n-\n import org.apache.brooklyn.api.mgmt.rebind.RebindContext;\n import org.apache.brooklyn.api.mgmt.rebind.mementos.CatalogItemMemento;\n import org.apache.brooklyn.core.catalog.internal.CatalogItemDtoAbstract;\n import org.apache.brooklyn.core.typereg.BundleUpgradeParser.CatalogUpgrades;\n import org.apache.brooklyn.util.collections.MutableMap;\n import org.apache.brooklyn.util.core.flags.FlagUtils;\n-import org.apache.brooklyn.util.osgi.VersionedName;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/c713529a99bdb4b22ed4035c4d1b9bff05229cd0/core/src/main/java/org/apache/brooklyn/core/mgmt/rebind/BasicCatalogItemRebindSupport.java",
                "sha": "ee2871c2289f5e0d22f545d94a62687de218a924",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/c713529a99bdb4b22ed4035c4d1b9bff05229cd0/core/src/main/java/org/apache/brooklyn/core/typereg/BundleUpgradeParser.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/org/apache/brooklyn/core/typereg/BundleUpgradeParser.java?ref=c713529a99bdb4b22ed4035c4d1b9bff05229cd0",
                "deletions": 1,
                "filename": "core/src/main/java/org/apache/brooklyn/core/typereg/BundleUpgradeParser.java",
                "patch": "@@ -352,7 +352,8 @@ public static CatalogUpgrades getFromManagementContext(ManagementContext managem\n \n         @Beta\n         public static String getBundleUpgradedIfNecessary(ManagementContext mgmt, String vName) {\n-            if (vName==null) return null;\n+            // mgmt can be null in some edge cases, eg BasicCatalogItemRebindSupport.possiblyUpgradedBundle \n+            if (vName==null || mgmt==null) return null;\n             Maybe<OsgiManager> osgi = ((ManagementContextInternal)mgmt).getOsgiManager();\n             if (osgi.isAbsent()) {\n                 // ignore upgrades if not osgi",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/c713529a99bdb4b22ed4035c4d1b9bff05229cd0/core/src/main/java/org/apache/brooklyn/core/typereg/BundleUpgradeParser.java",
                "sha": "d808c24f66264e902e7c32fe5c9f1d2ebf506bb2",
                "status": "modified"
            }
        ],
        "message": "guard against possible NPE when rebinding legacy catalog items",
        "parent": "https://github.com/apache/brooklyn-server/commit/34016b66b0cfdfc2b4cff75ba7215832e417f40b",
        "patched_files": [
            "BundleUpgradeParser.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BundleUpgradeParserTest.java"
        ]
    },
    "brooklyn-server_c85d25f": {
        "bug_id": "brooklyn-server_c85d25f",
        "commit": "https://github.com/apache/brooklyn-server/commit/c85d25f2962f2e9ea39eeb04d8809449d01d3da6",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/c85d25f2962f2e9ea39eeb04d8809449d01d3da6/usage/rest-server/src/test/java/brooklyn/rest/BrooklynRestApiLauncher.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/rest-server/src/test/java/brooklyn/rest/BrooklynRestApiLauncher.java?ref=c85d25f2962f2e9ea39eeb04d8809449d01d3da6",
                "deletions": 0,
                "filename": "usage/rest-server/src/test/java/brooklyn/rest/BrooklynRestApiLauncher.java",
                "patch": "@@ -171,6 +171,8 @@ public static Server startServer(ManagementContext mgmt, ContextHandler context,\n                 ((BrooklynProperties)mgmt.getConfig()).put(BrooklynWebConfig.SECURITY_PROVIDER_CLASSNAME, AnyoneSecurityProvider.class.getName());\n             }\n         }\n+        if (mgmt != null)\n+            mgmt.getHighAvailabilityManager().disabled();\n         InetSocketAddress bindLocation = new InetSocketAddress(\n                 secure ? Networking.ANY_NIC : Networking.LOOPBACK, \n                         Networking.nextAvailablePort(FAVOURITE_PORT));",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/c85d25f2962f2e9ea39eeb04d8809449d01d3da6/usage/rest-server/src/test/java/brooklyn/rest/BrooklynRestApiLauncher.java",
                "sha": "6465799758bb9eccc8a0a72232750a93afcf4fb2",
                "status": "modified"
            }
        ],
        "message": "Disable HA when running from BrooklynRestApiLauncher\n\nOtherwise HighAvailabilityManagerImpl throws NPE when creating\nmanagement record",
        "parent": "https://github.com/apache/brooklyn-server/commit/c461f9486254892a5da28a3c8375c3fb214f1ad9",
        "patched_files": [
            "BrooklynRestApiLauncher.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BrooklynRestApiLauncherTest.java"
        ]
    },
    "brooklyn-server_d29a912": {
        "bug_id": "brooklyn-server_d29a912",
        "commit": "https://github.com/apache/brooklyn-server/commit/d29a912e1a4f9a6e1c88194d15ae614853734d7b",
        "file": [
            {
                "additions": 22,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/d29a912e1a4f9a6e1c88194d15ae614853734d7b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 38,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=d29a912e1a4f9a6e1c88194d15ae614853734d7b",
                "deletions": 16,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -742,25 +742,31 @@ protected JcloudsSshMachineLocation obtainOnce(ConfigBag setup) throws NoMachine\n                 }\n \n                 if (setup.get(OPEN_IPTABLES)) {\n-                    customisationForLogging.add(\"open iptables\");\n-                    \n                     @SuppressWarnings(\"unchecked\")\n-                    List<String> iptablesRules = createIptablesRulesForNetworkInterface((Iterable<Integer>) setup.get(INBOUND_PORTS));\n-                    iptablesRules.add(IptablesCommands.saveIptablesRules());\n-                    List<String> batch = Lists.newArrayList();\n-                    // Some entities, such as Riak (erlang based) have a huge range of ports, which leads to a script that\n-                    // is too large to run (fails with a broken pipe). Batch the rules into batches of 50\n-                    for (String rule : iptablesRules) {\n-                        batch.add(rule);\n-                        if (batch.size() == 50) {\n-                            sshMachineLocation.execCommands(\"Inserting iptables rules, 50 command batch\", batch);\n-                            batch.clear();\n+                    Iterable<Integer> inboundPorts = (Iterable<Integer>) setup.get(INBOUND_PORTS);\n+                    \n+                    if (inboundPorts == null || Iterables.isEmpty(inboundPorts)) {\n+                        LOG.info(\"No ports to open in iptables (no inbound ports) for {} at {}\", sshMachineLocation, this);\n+                    } else {\n+                        customisationForLogging.add(\"open iptables\");\n+                        \n+                        List<String> iptablesRules = createIptablesRulesForNetworkInterface(inboundPorts);\n+                        iptablesRules.add(IptablesCommands.saveIptablesRules());\n+                        List<String> batch = Lists.newArrayList();\n+                        // Some entities, such as Riak (erlang based) have a huge range of ports, which leads to a script that\n+                        // is too large to run (fails with a broken pipe). Batch the rules into batches of 50\n+                        for (String rule : iptablesRules) {\n+                            batch.add(rule);\n+                            if (batch.size() == 50) {\n+                                sshMachineLocation.execCommands(\"Inserting iptables rules, 50 command batch\", batch);\n+                                batch.clear();\n+                            }\n                         }\n+                        if (batch.size() > 0) {\n+                            sshMachineLocation.execCommands(\"Inserting iptables rules\", batch);\n+                        }\n+                        sshMachineLocation.execCommands(\"List iptables rules\", ImmutableList.of(IptablesCommands.listIptablesRule()));\n                     }\n-                    if (batch.size() > 0) {\n-                        sshMachineLocation.execCommands(\"Inserting iptables rules\", batch);\n-                    }\n-                    sshMachineLocation.execCommands(\"List iptables rules\", ImmutableList.of(IptablesCommands.listIptablesRule()));\n                 }\n                 \n                 if (setup.get(STOP_IPTABLES)) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/d29a912e1a4f9a6e1c88194d15ae614853734d7b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "706b3eefa95df870850d375206b85bc14e5ed187",
                "status": "modified"
            }
        ],
        "message": "Jclouds openIptables: avoid NPE if no inboundPorts",
        "parent": "https://github.com/apache/brooklyn-server/commit/524b660d64fc3873fa78478c31af44df02430efa",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_d3c8dc1": {
        "bug_id": "brooklyn-server_d3c8dc1",
        "commit": "https://github.com/apache/brooklyn-server/commit/d3c8dc1f14f99049991c704c697138553c6f129b",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/d3c8dc1f14f99049991c704c697138553c6f129b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=d3c8dc1f14f99049991c704c697138553c6f129b",
                "deletions": 1,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -1517,7 +1517,7 @@ protected JcloudsSshMachineLocation createJcloudsSshMachineLocation(ComputeServi\n     \n     protected Map<String,Object> extractSshConfig(ConfigBag setup, NodeMetadata node) {\n         ConfigBag nodeConfig = new ConfigBag();\n-        if (node!=null) {\n+        if (node!=null && node.getCredentials() != null) {\n             nodeConfig.putIfNotNull(PASSWORD, node.getCredentials().getPassword());\n             nodeConfig.putIfNotNull(PRIVATE_KEY_DATA, node.getCredentials().getPrivateKey());\n         }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/d3c8dc1f14f99049991c704c697138553c6f129b/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "51f5aa8ceb7c816c7302559f9ba7405fd5ac02b9",
                "status": "modified"
            }
        ],
        "message": "JcloudsLocation: avoid NPE on rebindMachine",
        "parent": "https://github.com/apache/brooklyn-server/commit/832007029a537dac5d35718e190640c86b8023ba",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_d6041d4": {
        "bug_id": "brooklyn-server_d6041d4",
        "commit": "https://github.com/apache/brooklyn-server/commit/d6041d4076c13d45f40c95856ddcd99ac736ea2c",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/d6041d4076c13d45f40c95856ddcd99ac736ea2c/utils/common/src/main/java/org/apache/brooklyn/util/repeat/Repeater.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/org/apache/brooklyn/util/repeat/Repeater.java?ref=d6041d4076c13d45f40c95856ddcd99ac736ea2c",
                "deletions": 2,
                "filename": "utils/common/src/main/java/org/apache/brooklyn/util/repeat/Repeater.java",
                "patch": "@@ -184,7 +184,7 @@ public Repeater every(long period, TimeUnit unit) {\n      */\n     public Repeater every(Duration duration) {\n         Preconditions.checkNotNull(duration, \"duration must not be null\");\n-        Preconditions.checkArgument(duration.toMilliseconds()>0, \"period must be positive: %s\", duration);\n+        Preconditions.checkArgument(duration.isPositive(), \"period must be positive: %s\", duration);\n         return delayOnIteration(Functions.constant(duration));\n     }\n \n@@ -321,7 +321,7 @@ public Repeater limitTimeTo(long deadline, TimeUnit unit) {\n      */\n     public Repeater limitTimeTo(Duration duration) {\n         Preconditions.checkNotNull(duration, \"duration must not be null\");\n-        Preconditions.checkArgument(duration.toMilliseconds() > 0, \"deadline must be positive: %s\", duration);\n+        Preconditions.checkArgument(duration.isPositive(), \"deadline must be positive: %s\", duration);\n         this.timeLimit = duration;\n         return this;\n     }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/d6041d4076c13d45f40c95856ddcd99ac736ea2c/utils/common/src/main/java/org/apache/brooklyn/util/repeat/Repeater.java",
                "sha": "e2acdc106db0cbbaf3e08e4f4004c04be9c09f1f",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/d6041d4076c13d45f40c95856ddcd99ac736ea2c/utils/common/src/test/java/org/apache/brooklyn/util/repeat/RepeaterTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/test/java/org/apache/brooklyn/util/repeat/RepeaterTest.java?ref=d6041d4076c13d45f40c95856ddcd99ac736ea2c",
                "deletions": 2,
                "filename": "utils/common/src/test/java/org/apache/brooklyn/util/repeat/RepeaterTest.java",
                "patch": "@@ -187,15 +187,15 @@ public void runRespectsTimeLimitAndReturnsFalseIfReached() {\n         assertTrue(difference < 4 * LIMIT, \"Difference was: \" + difference);\n     }\n \n-    @Test(expectedExceptions = { IllegalStateException.class })\n+    @Test(expectedExceptions = { NullPointerException.class })\n     public void runFailsIfUntilWasNotSet() {\n         new Repeater(\"runFailsIfUntilWasNotSet\")\n             .every(Duration.millis(10))\n             .run();\n         fail(\"Expected exception was not thrown\");\n     }\n \n-    @Test(expectedExceptions = { IllegalStateException.class })\n+    @Test(expectedExceptions = { NullPointerException.class })\n     public void runFailsIfEveryWasNotSet() {\n         new Repeater(\"runFailsIfEveryWasNotSet\")\n             .until(Callables.returning(true))",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/d6041d4076c13d45f40c95856ddcd99ac736ea2c/utils/common/src/test/java/org/apache/brooklyn/util/repeat/RepeaterTest.java",
                "sha": "06e67ad23b302aa66edbecf9197de98fcb947505",
                "status": "modified"
            }
        ],
        "message": "Check for NPE in tests and use isPositive check for Duration",
        "parent": "https://github.com/apache/brooklyn-server/commit/68664b8382da6daab7fbcad36f8a40c43a6844b4",
        "patched_files": [
            "Repeater.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "RepeaterTest.java"
        ]
    },
    "brooklyn-server_ea43742": {
        "bug_id": "brooklyn-server_ea43742",
        "commit": "https://github.com/apache/brooklyn-server/commit/ea43742db5bf96dc37e4ced97c72c72c78318252",
        "file": [
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/ea43742db5bf96dc37e4ced97c72c72c78318252/core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java?ref=ea43742db5bf96dc37e4ced97c72c72c78318252",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java",
                "patch": "@@ -275,15 +275,22 @@ public T call() {\n \n     protected abstract <T> Task<T> runAtEntity(final Entity entity, final Effector<T> eff, @SuppressWarnings(\"rawtypes\") final Map parameters);\n \n+    @Override\n     public abstract void addEntitySetListener(CollectionChangeListener<Entity> listener);\n \n+    @Override\n     public abstract void removeEntitySetListener(CollectionChangeListener<Entity> listener);\n     \n     @Override\n     public StringConfigMap getConfig() {\n         return configMap;\n     }\n \n+    @Override\n+    public BrooklynProperties getBrooklynProperties() {\n+        return configMap;\n+    }\n+\n     @Override\n     public synchronized LocationRegistry getLocationRegistry() {\n         if (locationRegistry==null) locationRegistry = new BasicLocationRegistry(this);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/ea43742db5bf96dc37e4ced97c72c72c78318252/core/src/main/java/brooklyn/management/internal/AbstractManagementContext.java",
                "sha": "d5d353fba9804d284eef2177a3a8bc3d906d21dd",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/ea43742db5bf96dc37e4ced97c72c72c78318252/core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java?ref=ea43742db5bf96dc37e4ced97c72c72c78318252",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java",
                "patch": "@@ -4,6 +4,7 @@\n import java.util.Map;\n import java.util.concurrent.ExecutionException;\n \n+import brooklyn.config.BrooklynProperties;\n import brooklyn.config.ConfigKey;\n import brooklyn.entity.Effector;\n import brooklyn.entity.Entity;\n@@ -41,4 +42,6 @@\n     <T> Task<T> invokeEffector(final Entity entity, final Effector<T> eff, @SuppressWarnings(\"rawtypes\") final Map parameters);\n \n     BrooklynStorage getStorage();\n+    \n+    BrooklynProperties getBrooklynProperties();\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/ea43742db5bf96dc37e4ced97c72c72c78318252/core/src/main/java/brooklyn/management/internal/ManagementContextInternal.java",
                "sha": "57139e3bdab9edee45c896b93b7045ed93ed61e3",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/ea43742db5bf96dc37e4ced97c72c72c78318252/core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java?ref=ea43742db5bf96dc37e4ced97c72c72c78318252",
                "deletions": 0,
                "filename": "core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java",
                "patch": "@@ -13,6 +13,7 @@\n import java.util.concurrent.TimeoutException;\n \n import brooklyn.catalog.BrooklynCatalog;\n+import brooklyn.config.BrooklynProperties;\n import brooklyn.config.StringConfigMap;\n import brooklyn.entity.Application;\n import brooklyn.entity.Effector;\n@@ -154,6 +155,12 @@ public StringConfigMap getConfig() {\n         return initialManagementContext.getConfig();\n     }\n \n+    @Override\n+    public BrooklynProperties getBrooklynProperties() {\n+        checkInitialManagementContextReal();\n+        return initialManagementContext.getBrooklynProperties();\n+    }\n+\n     @Override\n     public BrooklynStorage getStorage() {\n         checkInitialManagementContextReal();",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/ea43742db5bf96dc37e4ced97c72c72c78318252/core/src/main/java/brooklyn/management/internal/NonDeploymentManagementContext.java",
                "sha": "a4ef9b798647a2ae906645253f025f7a4ebffa57",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/ea43742db5bf96dc37e4ced97c72c72c78318252/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java?ref=ea43742db5bf96dc37e4ced97c72c72c78318252",
                "deletions": 0,
                "filename": "usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "patch": "@@ -331,7 +331,10 @@ protected BrooklynLauncher doLaunch() {\n                 brooklynProperties = builder.build();\n             }\n             managementContext = new LocalManagementContext(brooklynProperties);\n+        } else if (brooklynProperties == null) {\n+            brooklynProperties = ((ManagementContextInternal)managementContext).getBrooklynProperties();\n         }\n+        \n         for (Map.Entry<String, Object> entry : brooklynAdditionalProperties.entrySet()) {\n             brooklynProperties.put(entry.getKey(), entry.getValue());\n         }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/ea43742db5bf96dc37e4ced97c72c72c78318252/usage/launcher/src/main/java/brooklyn/launcher/BrooklynLauncher.java",
                "sha": "20425ed86bae779fc9d849ff5416e9e5f4bf55a6",
                "status": "modified"
            }
        ],
        "message": "Fix NPE when BrooklynLauncher given ManagementContext\n\n- caused by brooklynProperties being null",
        "parent": "https://github.com/apache/brooklyn-server/commit/b8a8d0783f59d54fae8efb003d89dcb4da74ec58",
        "patched_files": [
            "BrooklynLauncher.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "BrooklynLauncherTest.java"
        ]
    },
    "brooklyn-server_f08b868": {
        "bug_id": "brooklyn-server_f08b868",
        "commit": "https://github.com/apache/brooklyn-server/commit/f08b868dbb755518810b42084ed6b22c6223c877",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/entity/basic/Attributes.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/Attributes.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 1,
                "filename": "core/src/main/java/brooklyn/entity/basic/Attributes.java",
                "patch": "@@ -28,7 +28,7 @@\n     /**\n      * Application information sensors.\n      * \n-     * @deprecated since 0.5; see {@link ConfigKeys#SUGGESTED_VERSION}\n+     * @deprecated since 0.5; see {@link BrooklynConfigKeys#SUGGESTED_VERSION}\n      */\n     @Deprecated\n     AttributeSensor<String> VERSION = Sensors.newStringSensor( \"version\", \"Version information\");",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/entity/basic/Attributes.java",
                "sha": "6af95be92773598e35274f57ae13a63d05a65c51",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/entity/basic/ConfigKeys.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/basic/ConfigKeys.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 40,
                "filename": "core/src/main/java/brooklyn/entity/basic/ConfigKeys.java",
                "patch": "@@ -136,44 +136,4 @@\n     public static ConfigKey<Boolean> newBooleanConfigKey(String name, String description, Boolean defaultValue) {\n         return newConfigKey(Boolean.class, name, description, defaultValue);\n     }\n-\n-    /* Key definitions were deprecated here in 0.6.0 because they introduce nasty circular dependencies on the\n-     * methods in this class, causing some final fields to be null when they are accessed. \n-     */\n-\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> BROOKLYN_DATA_DIR = BrooklynConfigKeys.BROOKLYN_DATA_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SUGGESTED_VERSION = BrooklynConfigKeys.SUGGESTED_VERSION;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SUGGESTED_INSTALL_DIR = BrooklynConfigKeys.SUGGESTED_INSTALL_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SUGGESTED_RUN_DIR = BrooklynConfigKeys.SUGGESTED_RUN_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> START_LATCH = BrooklynConfigKeys.START_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> INSTALL_LATCH = BrooklynConfigKeys.INSTALL_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> CUSTOMIZE_LATCH = BrooklynConfigKeys.CUSTOMIZE_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Boolean> LAUNCH_LATCH = BrooklynConfigKeys.LAUNCH_LATCH;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Integer> START_TIMEOUT = BrooklynConfigKeys.START_TIMEOUT;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_TOOL_CLASS = BrooklynConfigKeys.SSH_TOOL_CLASS;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_HOST = BrooklynConfigKeys.SSH_CONFIG_HOST;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<Integer> SSH_CONFIG_PORT = BrooklynConfigKeys.SSH_CONFIG_PORT;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_USER = BrooklynConfigKeys.SSH_CONFIG_USER;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_PASSWORD = BrooklynConfigKeys.SSH_CONFIG_PASSWORD;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_SCRIPT_DIR = BrooklynConfigKeys.SSH_CONFIG_SCRIPT_DIR;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_SCRIPT_HEADER = BrooklynConfigKeys.SSH_CONFIG_SCRIPT_HEADER;\n-    /** @deprecated since 0.6.0; use {@link BrooklynConfigKeys} to prevent classload ordering problems */ @Deprecated\n-    public static final ConfigKey<String> SSH_CONFIG_DIRECT_HEADER = BrooklynConfigKeys.SSH_CONFIG_DIRECT_HEADER;\n-\n }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/entity/basic/ConfigKeys.java",
                "sha": "f4a27a7a4921369b651e823e92de197bffa63c64",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java",
                "patch": "@@ -13,7 +13,7 @@\n \n import brooklyn.entity.Entity;\n import brooklyn.entity.basic.Attributes;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.drivers.EntityDriver;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadRequirement;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadTargets;\n@@ -92,14 +92,14 @@ public static String substitute(DownloadRequirement req, String basevalue) {\n         Entity entity = driver.getEntity();\n         String type = entity.getEntityType().getName();\n         String simpleType = type.substring(type.lastIndexOf(\".\")+1);\n-        String version = entity.getConfig(ConfigKeys.SUGGESTED_VERSION);\n+        String version = entity.getConfig(BrooklynConfigKeys.SUGGESTED_VERSION);\n         \n         String v2 = entity.getAttribute(Attributes.VERSION);\n         if (v2!=null && !v2.equals(version)) {\n             // Attributes.VERSION was deprecated in 0.5.0 but was preferred here without warning in 0.6.0\n             // now warn on use of deprecated key when it is different\n             LOG.warn(\"Using deprecated key \"+Attributes.VERSION+\", value \"+v2+\", which differs from the \" +\n-            \t\t\"preferred key \"+ConfigKeys.SUGGESTED_VERSION+\", value \"+version+\"; old key will be retired shortly!\");\n+            \t\t\"preferred key \"+BrooklynConfigKeys.SUGGESTED_VERSION+\", value \"+version+\"; old key will be retired shortly!\");\n             version = v2;\n         }\n         ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/entity/drivers/downloads/DownloadSubstituters.java",
                "sha": "40c20b919763cabf2551d035a31e69d6d8a09424",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 2,
                "filename": "core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java",
                "patch": "@@ -13,7 +13,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.LocationRegistry;\n import brooklyn.location.LocationResolver;\n import brooklyn.location.LocationSpec;\n@@ -135,7 +135,7 @@ public void init(ManagementContext managementContext) {\n         if (user != null) flags.put(\"user\", user);\n         if (name != null) flags.put(\"name\", name);\n         if (registry != null) {\n-            String brooklynDataDir = (String) registry.getProperties().get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+            String brooklynDataDir = (String) registry.getProperties().get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n             if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n                 flags.put(\"localTempDir\", new File(brooklynDataDir));\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/location/basic/ByonLocationResolver.java",
                "sha": "1b8df65dae914ddd952b818d255127373af6e718",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/location/basic/LocalhostResolver.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/LocalhostResolver.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 5,
                "filename": "core/src/main/java/brooklyn/location/basic/LocalhostResolver.java",
                "patch": "@@ -12,9 +12,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import brooklyn.config.ConfigKey;\n-import brooklyn.config.ConfigUtils;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.Location;\n import brooklyn.location.LocationRegistry;\n import brooklyn.location.LocationResolver;\n@@ -24,7 +22,6 @@\n import brooklyn.util.text.KeyValueParser;\n \n import com.google.common.collect.ImmutableSet;\n-import com.google.common.collect.Maps;\n import com.google.common.collect.Sets;\n \n /**\n@@ -96,7 +93,7 @@ protected Location newLocationFromString(String spec, brooklyn.location.Location\n             flags.put(\"name\", namePart);\n         }\n         if (registry != null) {\n-            String brooklynDataDir = (String) registry.getProperties().get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+            String brooklynDataDir = (String) registry.getProperties().get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n             if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n                 flags.put(\"localTempDir\", new File(brooklynDataDir));\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/main/java/brooklyn/location/basic/LocalhostResolver.java",
                "sha": "ebd0d7636ae686baa7aec6400bba64af49bb322b",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 2,
                "filename": "core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java",
                "patch": "@@ -10,7 +10,7 @@\n import brooklyn.config.BrooklynProperties;\n import brooklyn.entity.basic.ApplicationBuilder;\n import brooklyn.entity.basic.Attributes;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.basic.Entities;\n import brooklyn.entity.proxying.EntitySpec;\n import brooklyn.location.Location;\n@@ -89,7 +89,7 @@ public void testReturnsLocalRepoThenOverrideThenAttributeValThenCloudsoftUrlThen\n         brooklynProperties.put(\"brooklyn.downloads.all.url\", \"http://fromprops/${version}.allprimary\");\n         brooklynProperties.put(\"brooklyn.downloads.all.fallbackurl\", \"http://fromfallback/${version}.allfallback\");\n         entity.setAttribute(Attributes.DOWNLOAD_URL, \"http://fromattrib/${version}.default\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         String expectedFilename = \"myversion.allprimary\";\n \n         String expectedLocalRepo = String.format(\"file://$HOME/.brooklyn/repository/%s/%s/%s\", \"TestEntity\", \"myversion\", expectedFilename);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/test/java/brooklyn/entity/drivers/downloads/BasicDownloadsRegistryTest.java",
                "sha": "e4d13d8fe85a0da239ea512ca9d6ca3f4b460bb2",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 4,
                "filename": "core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java",
                "patch": "@@ -10,7 +10,7 @@\n \n import brooklyn.config.BrooklynProperties;\n import brooklyn.entity.basic.ApplicationBuilder;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.basic.Entities;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadRequirement;\n import brooklyn.entity.drivers.downloads.DownloadResolverManager.DownloadTargets;\n@@ -79,7 +79,7 @@ public void testReturnsGlobalFallbackUrl() throws Exception {\n     @Test\n     public void testSubstitutionsAppliedToFallbackUrl() throws Exception {\n         brooklynProperties.put(\"brooklyn.downloads.all.fallbackurl\", \"version=${version}\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         assertResolves(ImmutableList.<String>of(), ImmutableList.of(\"version=myversion\"));\n     }\n \n@@ -93,15 +93,15 @@ public void testReturnsGlobalFallbackUrlAsLast() throws Exception {\n     @Test\n     public void testReturnsGlobalUrlWithEntitySubstituions() throws Exception {\n         brooklynProperties.put(\"brooklyn.downloads.all.url\", \"version=${version}\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         assertResolves(\"version=myversion\");\n     }\n     \n     @Test\n     public void testEntitySpecificUrlOverridesGlobalUrl() throws Exception {\n         brooklynProperties.put(\"brooklyn.downloads.all.url\", \"version=${version}\");\n         brooklynProperties.put(\"brooklyn.downloads.entity.TestEntity.url\", \"overridden,version=${version}\");\n-        entity.setConfig(ConfigKeys.SUGGESTED_VERSION, \"myversion\");\n+        entity.setConfig(BrooklynConfigKeys.SUGGESTED_VERSION, \"myversion\");\n         assertResolves(\"overridden,version=myversion\", \"version=myversion\");\n     }\n     ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/core/src/test/java/brooklyn/entity/drivers/downloads/DownloadProducerFromPropertiesTest.java",
                "sha": "f169bee621189aa2186d80cd49946c45e34503ce",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java",
                "patch": "@@ -12,7 +12,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.LocationRegistry;\n import brooklyn.location.LocationResolver;\n import brooklyn.location.LocationSpec;\n@@ -147,7 +147,7 @@ public void init(ManagementContext managementContext) {\n         if (user != null) flags.put(\"user\", user);\n         if (name != null) flags.put(\"name\", name);\n         if (registry != null) {\n-            String brooklynDataDir = (String) registry.getProperties().get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+            String brooklynDataDir = (String) registry.getProperties().get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n             if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n                 flags.put(\"localTempDir\", new File(brooklynDataDir));\n             }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsByonLocationResolver.java",
                "sha": "e9ac5b600cbd96274ed6a9a4f27a727e4874b6b4",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 2,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "patch": "@@ -7,7 +7,7 @@\n import org.slf4j.LoggerFactory;\n \n import brooklyn.config.ConfigUtils;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.location.basic.DeprecatedKeysMappingBuilder;\n import brooklyn.location.basic.LocationPropertiesFromBrooklynProperties;\n \n@@ -74,7 +74,7 @@\n         jcloudsProperties.putAll(transformDeprecated(getProviderOrApiJcloudsProperties(providerOrApi, properties)));\n         jcloudsProperties.putAll(transformDeprecated(getRegionJcloudsProperties(providerOrApi, regionName, properties)));\n         if (!Strings.isNullOrEmpty(namedLocation)) jcloudsProperties.putAll(transformDeprecated(getNamedJcloudsProperties(namedLocation, properties)));\n-        String brooklynDataDir = (String) properties.get(ConfigKeys.BROOKLYN_DATA_DIR.getName());\n+        String brooklynDataDir = (String) properties.get(BrooklynConfigKeys.BROOKLYN_DATA_DIR.getName());\n         if (brooklynDataDir != null && brooklynDataDir.length() > 0) {\n             jcloudsProperties.put(\"localTempDir\", new File(brooklynDataDir));\n         }",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsPropertiesFromBrooklynProperties.java",
                "sha": "a3cef2ce3ffe8ec88bb3be62b4c8c370cbaa21ab",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 5,
                "filename": "software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java",
                "patch": "@@ -56,17 +56,17 @@ public void rebind() {\n \t@Override\n \tpublic void start() {\n \t    DynamicTasks.queue(\"install\", new Runnable() { public void run() {\n-            waitForConfigKey(ConfigKeys.INSTALL_LATCH);\n+            waitForConfigKey(BrooklynConfigKeys.INSTALL_LATCH);\n             install();\n         }});\n         \n \t    DynamicTasks.queue(\"customize\", new Runnable() { public void run() {\n-            waitForConfigKey(ConfigKeys.CUSTOMIZE_LATCH);\n+            waitForConfigKey(BrooklynConfigKeys.CUSTOMIZE_LATCH);\n             customize();\n         }});\n         \n \t    DynamicTasks.queue(\"launch\", new Runnable() { public void run() {\n-            waitForConfigKey(ConfigKeys.LAUNCH_LATCH);\n+            waitForConfigKey(BrooklynConfigKeys.LAUNCH_LATCH);\n             launch();\n         }});\n         \n@@ -113,9 +113,11 @@ public void restart() {\n         }});\n \t}\n \t\n-\tpublic EntityLocal getEntity() { return entity; } \n+\t@Override\n+    public EntityLocal getEntity() { return entity; } \n \n-\tpublic Location getLocation() { return location; } \n+\t@Override\n+    public Location getLocation() { return location; } \n     \n     public InputStream getResource(String url) {\n         return new ResourceUtils(entity).getResourceFromUrl(url);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/software/base/src/main/java/brooklyn/entity/basic/AbstractSoftwareProcessDriver.java",
                "sha": "1adc1ee0948935095c2056ec67f77797f7c71083",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 1,
                "filename": "software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java",
                "patch": "@@ -5,6 +5,7 @@\n import java.util.Map;\n \n import brooklyn.config.ConfigKey;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.entity.basic.ConfigKeys;\n import brooklyn.entity.basic.SoftwareProcess;\n import brooklyn.entity.java.UsesJava;\n@@ -31,7 +32,7 @@\n             Map.class, \"brooklynnode.copytorundir\", \"URLs of resources to be copied across to the server, giving the path they are to be copied to\", MutableMap.of());\n     \n     @SetFromFlag(\"version\")\n-    public static final ConfigKey<String> SUGGESTED_VERSION = ConfigKeys.newConfigKeyWithDefault(ConfigKeys.SUGGESTED_VERSION, \"0.6.0-SNAPSHOT\"); // BROOKLYN_VERSION\n+    public static final ConfigKey<String> SUGGESTED_VERSION = ConfigKeys.newConfigKeyWithDefault(BrooklynConfigKeys.SUGGESTED_VERSION, \"0.6.0-SNAPSHOT\"); // BROOKLYN_VERSION\n \n     // Takes presidence over downloadUrl, if non-null\n     @SetFromFlag(\"distroUploadUrl\")",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/software/base/src/main/java/brooklyn/entity/brooklynnode/BrooklynNode.java",
                "sha": "b41bcad9694a57a5a38b1fe0917255d6bf0684bb",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 5,
                "filename": "software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy",
                "patch": "@@ -12,8 +12,7 @@ import org.testng.annotations.BeforeMethod\n import org.testng.annotations.Test\n \n import brooklyn.entity.basic.AbstractSoftwareProcessSshDriver\n-import brooklyn.entity.basic.ConfigKeys\n-import brooklyn.entity.basic.Entities;\n+import brooklyn.entity.basic.BrooklynConfigKeys\n import brooklyn.location.basic.SshMachineLocation\n import brooklyn.test.entity.TestApplication\n import brooklyn.test.entity.TestApplicationImpl\n@@ -22,7 +21,7 @@ import brooklyn.test.entity.TestEntityImpl\n import brooklyn.util.internal.ssh.SshTool\n import brooklyn.util.internal.ssh.cli.SshCliTool\n import brooklyn.util.internal.ssh.sshj.SshjTool\n-import brooklyn.util.stream.StreamGobbler;\n+import brooklyn.util.stream.StreamGobbler\n \n class StartStopSshDriverTest {\n \n@@ -69,7 +68,7 @@ class StartStopSshDriverTest {\n \n     @Test(groups = [ \"Integration\" ])\n     public void testSshScriptHeaderUsedWhenSpecified() {\n-        entity.setConfig(ConfigKeys.SSH_CONFIG_SCRIPT_HEADER, \"#!/bin/bash -e\\necho hello world\");\n+        entity.setConfig(BrooklynConfigKeys.SSH_CONFIG_SCRIPT_HEADER, \"#!/bin/bash -e\\necho hello world\");\n         ByteArrayOutputStream out = new ByteArrayOutputStream();\n         driver.execute(out: out, Arrays.asList(\"echo goodbye\"), \"test\");\n         String s = out.toString();\n@@ -81,7 +80,7 @@ class StartStopSshDriverTest {\n \n     @Test(groups = [ \"Integration\" ])\n     public void testSshCliPickedUpWhenSpecified() {\n-        entity.setConfig(ConfigKeys.SSH_TOOL_CLASS, SshCliTool.class.getName());\n+        entity.setConfig(BrooklynConfigKeys.SSH_TOOL_CLASS, SshCliTool.class.getName());\n         driver.execute(Arrays.asList(\"echo hi\"), \"test\");\n         assertTrue(sshMachineLocation.lastTool instanceof SshCliTool, \"expect CLI tool, got \"+\n                         (sshMachineLocation.lastTool!=null ? \"\"+sshMachineLocation.lastTool.getClass()+\":\" : \"\") + sshMachineLocation.lastTool);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/software/base/src/test/java/brooklyn/entity/basic/lifecycle/StartStopSshDriverTest.groovy",
                "sha": "84fdd44175812bd176981070400146c8c0830db6",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f08b868dbb755518810b42084ed6b22c6223c877/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java?ref=f08b868dbb755518810b42084ed6b22c6223c877",
                "deletions": 2,
                "filename": "usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "patch": "@@ -30,7 +30,7 @@\n import brooklyn.BrooklynVersion;\n import brooklyn.config.BrooklynServiceAttributes;\n import brooklyn.config.ConfigKey;\n-import brooklyn.entity.basic.ConfigKeys;\n+import brooklyn.entity.basic.BrooklynConfigKeys;\n import brooklyn.launcher.config.CustomResourceLocator;\n import brooklyn.location.PortRange;\n import brooklyn.location.basic.LocalhostMachineProvisioningLocation;\n@@ -147,7 +147,7 @@ public BrooklynWebServer(Map flags, ManagementContext managementContext) {\n         if (!leftovers.isEmpty())\n             log.warn(\"Ignoring unknown flags \" + leftovers);\n         \n-        String brooklynDataDir = checkNotNull(managementContext.getConfig().getConfig(ConfigKeys.BROOKLYN_DATA_DIR));\n+        String brooklynDataDir = checkNotNull(managementContext.getConfig().getConfig(BrooklynConfigKeys.BROOKLYN_DATA_DIR));\n         this.webappTempDir = new File(brooklynDataDir, \"jetty\");\n     }\n ",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f08b868dbb755518810b42084ed6b22c6223c877/usage/launcher/src/main/java/brooklyn/launcher/BrooklynWebServer.java",
                "sha": "12d43ef9ba9ae8b384bb3130d0319a0057c4f865",
                "status": "modified"
            }
        ],
        "message": "Deletes keys defined in ConfigKeys\n\n- Update all uses to the new BrooklynConfigKeys\n- Was previously deprecated, with fields in ConfigKeys referencing\n  those in BrooklynConfigKeys. But this led to strange NPEs where\n  ConfigKeys fields were null (presumably due to ordering of\n  initialising the two classes' fields)!\n- Breaks backwards compatibility, but better to have a compilation error\n  than a weird NPE.",
        "parent": "https://github.com/apache/brooklyn-server/commit/b98c6f3bc74a7dcd91b372109540bf18622e560a",
        "patched_files": [
            "BrooklynNode.java",
            "JcloudsByonLocationResolver.java",
            "LocalhostResolver.java",
            "ConfigKeys.java",
            "Attributes.java",
            "StartStopSshDriverTest.groovy",
            "AbstractSoftwareProcessDriver.java",
            "DownloadSubstituters.java",
            "BrooklynWebServer.java",
            "DownloadProducerFromProperties.java",
            "JcloudsPropertiesFromBrooklynProperties.java",
            "ByonLocationResolver.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsPropertiesFromBrooklynPropertiesTest.java",
            "BrooklynWebServerTest.java",
            "BasicDownloadsRegistryTest.java",
            "ByonLocationResolverTest.java",
            "DownloadProducerFromPropertiesTest.java",
            "DownloadSubstitutersTest.java",
            "BrooklynNodeTest.java",
            "JcloudsByonLocationResolverTest.java",
            "ConfigKeysTest.java"
        ]
    },
    "brooklyn-server_f787be3": {
        "bug_id": "brooklyn-server_f787be3",
        "commit": "https://github.com/apache/brooklyn-server/commit/f787be37fa3b04d9e702cdc6e74dbbddd43f362c",
        "file": [
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f787be37fa3b04d9e702cdc6e74dbbddd43f362c/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "changes": 30,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java?ref=f787be37fa3b04d9e702cdc6e74dbbddd43f362c",
                "deletions": 11,
                "filename": "locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "patch": "@@ -580,27 +580,35 @@ public void apply(TemplateOptions t, ConfigBag props, Object v) {\n                     }})\n             .put(LOGIN_USER, new CustomizeTemplateOptions() {\n                     public void apply(TemplateOptions t, ConfigBag props, Object v) {\n-                        t.overrideLoginUser(((CharSequence)v).toString());\n+                        if (v != null) {\n+                            t.overrideLoginUser(((CharSequence)v).toString());\n+                        }\n                     }})\n             .put(LOGIN_USER_PASSWORD, new CustomizeTemplateOptions() {\n                     public void apply(TemplateOptions t, ConfigBag props, Object v) {\n-                        t.overrideLoginPassword(((CharSequence)v).toString());\n+                        if (v != null) {\n+                            t.overrideLoginPassword(((CharSequence)v).toString());\n+                        }\n                     }})\n             .put(LOGIN_USER_PRIVATE_KEY_FILE, new CustomizeTemplateOptions() {\n                     public void apply(TemplateOptions t, ConfigBag props, Object v) {\n-                        String privateKeyFileName = ((CharSequence)v).toString();\n-                        String privateKey;\n-                        try {\n-                            privateKey = Files.toString(new File(ResourceUtils.tidyFilePath(privateKeyFileName)), Charsets.UTF_8);\n-                        } catch (IOException e) {\n-                            LOG.error(privateKeyFileName + \"not found\", e);\n-                            throw Exceptions.propagate(e);\n+                        if (v != null) {\n+                            String privateKeyFileName = ((CharSequence)v).toString();\n+                            String privateKey;\n+                            try {\n+                                privateKey = Files.toString(new File(ResourceUtils.tidyFilePath(privateKeyFileName)), Charsets.UTF_8);\n+                            } catch (IOException e) {\n+                                LOG.error(privateKeyFileName + \"not found\", e);\n+                                throw Exceptions.propagate(e);\n+                            }\n+                            t.overrideLoginPrivateKey(privateKey);\n                         }\n-                        t.overrideLoginPrivateKey(privateKey);\n                     }})\n             .put(LOGIN_USER_PRIVATE_KEY_DATA, new CustomizeTemplateOptions() {\n                     public void apply(TemplateOptions t, ConfigBag props, Object v) {\n-                        t.overrideLoginPrivateKey(((CharSequence)v).toString());\n+                        if (v != null) {\n+                            t.overrideLoginPrivateKey(((CharSequence)v).toString());\n+                        }\n                     }})                    \n             .put(KEY_PAIR, new CustomizeTemplateOptions() {\n                     public void apply(TemplateOptions t, ConfigBag props, Object v) {",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f787be37fa3b04d9e702cdc6e74dbbddd43f362c/locations/jclouds/src/main/java/brooklyn/location/jclouds/JcloudsLocation.java",
                "sha": "dc20f471bd6dc48659e17878e72b700e8b39ba9a",
                "status": "modified"
            }
        ],
        "message": "JcloudsLocation: support unsetting config\n\n- if set null loginUser, loginUserPassword, etc then don't pass it\n  through to jclouds (i.e. don't NPE)",
        "parent": "https://github.com/apache/brooklyn-server/commit/462fd6e65ae33367a2174a193e6ef241f28cd842",
        "patched_files": [
            "JcloudsLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JcloudsLocationTest.java"
        ]
    },
    "brooklyn-server_f9b52ce": {
        "bug_id": "brooklyn-server_f9b52ce",
        "commit": "https://github.com/apache/brooklyn-server/commit/f9b52ce37f395e44aed819794957f4ed88811b38",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/f9b52ce37f395e44aed819794957f4ed88811b38/utils/common/src/main/java/brooklyn/util/collections/Jsonya.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/utils/common/src/main/java/brooklyn/util/collections/Jsonya.java?ref=f9b52ce37f395e44aed819794957f4ed88811b38",
                "deletions": 1,
                "filename": "utils/common/src/main/java/brooklyn/util/collections/Jsonya.java",
                "patch": "@@ -213,9 +213,10 @@ protected void putInternal(Map target, Object k1, Object v1, Object ...kvOthers)\n             }\n         }\n \n-        /** as {@link #put(Object, Object, Object...)} for the kv-pairs in the given map */\n+        /** as {@link #put(Object, Object, Object...)} for the kv-pairs in the given map; ignores null for convenience */\n         public Navigator<T> put(Map map) {\n             map();\n+            if (map==null) return this;\n             ((Map)focus).putAll((Map)translate(map));\n             return this;\n         }\n@@ -388,6 +389,8 @@ protected void addFlattened(Collection target, Object item) {\n             target.add(translate(item));\n         }\n         \n+        /** Returns JSON serialized output for given focus in the given jsonya;\n+         * applies a naive toString for specialized types */\n         @Override\n         public String toString() {\n             return render(get());",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/f9b52ce37f395e44aed819794957f4ed88811b38/utils/common/src/main/java/brooklyn/util/collections/Jsonya.java",
                "sha": "c4bac406647a98e9dbf5f6b66218fd31d5fc5276",
                "status": "modified"
            }
        ],
        "message": "jsonya now no-op if put(null), previously threw NPE",
        "parent": "https://github.com/apache/brooklyn-server/commit/137209577b35f97bf1927b0c0d8e00928a0e933c",
        "patched_files": [
            "Jsonya.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "JsonyaTest.java"
        ]
    },
    "brooklyn-server_fe1aec0": {
        "bug_id": "brooklyn-server_fe1aec0",
        "commit": "https://github.com/apache/brooklyn-server/commit/fe1aec08f9cf3524d508ae5796603361f21dfde1",
        "file": [
            {
                "additions": 9,
                "blob_url": "https://github.com/apache/brooklyn-server/blob/fe1aec08f9cf3524d508ae5796603361f21dfde1/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/brooklyn-server/contents/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java?ref=fe1aec08f9cf3524d508ae5796603361f21dfde1",
                "deletions": 3,
                "filename": "core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "patch": "@@ -345,10 +345,12 @@ public void init() {\n     \n     @Override\n     public void close() throws IOException {\n-        if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"{} invalidating all entries in ssh pool cache. Final stats: {}\", this, sshPoolCache.stats());\n+        if (sshPoolCache != null) {\n+            if (LOG.isDebugEnabled()) {\n+                LOG.debug(\"{} invalidating all entries in ssh pool cache. Final stats: {}\", this, sshPoolCache.stats());\n+            }\n+            sshPoolCache.invalidateAll();\n         }\n-        sshPoolCache.invalidateAll();\n         if (cleanupTask != null) cleanupTask.cancel(false);\n     }\n \n@@ -389,6 +391,10 @@ public int getPort() {\n     }\n \n     protected <T> T execSsh(Map<String, ?> props, Function<ShellTool, T> task) {\n+        if (sshPoolCache == null) {\n+            // required for uses that instantiate SshMachineLocation directly, so init() will not have been called\n+            sshPoolCache = buildSshToolPoolCacheLoader();\n+        }\n         Pool<SshTool> pool = sshPoolCache.getUnchecked(props);\n         if (LOG.isTraceEnabled()) {\n             LOG.trace(\"{} execSsh got pool: {}\", this, pool);",
                "raw_url": "https://github.com/apache/brooklyn-server/raw/fe1aec08f9cf3524d508ae5796603361f21dfde1/core/src/main/java/brooklyn/location/basic/SshMachineLocation.java",
                "sha": "3bcb45131aac6c1b03dca25ac21c54669dac86fb",
                "status": "modified"
            }
        ],
        "message": "Fix SshMachineLocation NPE\n\n- sshPoolCache initialisation was moved to init() previously\n  But for things that instantiate SshMachineLocation directly then\n  the framework won't have called init.",
        "parent": "https://github.com/apache/brooklyn-server/commit/2ec4c9eb0ddaf57cc045ab910de4a1e98557889a",
        "patched_files": [
            "SshMachineLocation.java"
        ],
        "repo": "brooklyn-server",
        "unit_tests": [
            "SshMachineLocationTest.java"
        ]
    }
}