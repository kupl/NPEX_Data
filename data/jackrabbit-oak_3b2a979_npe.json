[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16",
        "bug_id": "jackrabbit-oak_3b2a979",
        "message": "OAK-2691: Blob GC throws NPE\n\nChecking existence of :clusterId property before retrieving\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1669992 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/64c57bd4a8a86e5f257422eaae38834397ba8aae",
        "patched_files": [
            "ClusterRepositoryInfo.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 9,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java?ref=3b2a979e5eef29cdcf35c20b7be1975d45ff8b16",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java",
                "deletions": 1,
                "sha": "d2755eb3359864572846b7bb310012dd2fc81e76",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java",
                "patch": "@@ -23,8 +23,11 @@\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n \n+import javax.annotation.CheckForNull;\n+\n /**\n  * Utility class to manage a unique cluster/repository id for the cluster.\n  */\n@@ -57,8 +60,13 @@ public static String createId(NodeStore store) throws CommitFailedException {\n      * @param store the NodeStore instance\n      * @return the repository id\n      */\n+    @CheckForNull\n     public static String getId(NodeStore store) {\n-        return store.getRoot().getChildNode(CLUSTER_CONFIG_NODE).getProperty(CLUSTER_ID_PROP).getValue(Type.STRING);\n+        NodeState state = store.getRoot().getChildNode(CLUSTER_CONFIG_NODE);\n+        if (state.hasProperty(CLUSTER_ID_PROP)) {\n+            return state.getProperty(CLUSTER_ID_PROP).getValue(Type.STRING);\n+        }\n+        return null;\n     }\n }\n ",
                "changes": 10
            },
            {
                "status": "modified",
                "additions": 13,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java?ref=3b2a979e5eef29cdcf35c20b7be1975d45ff8b16",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
                "deletions": 0,
                "sha": "eb27670bcecdf33bd66e64772bfe2b1e2189de8d",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
                "patch": "@@ -93,6 +93,19 @@ public void sameCluster() throws Exception {\n         Assert.assertEquals(repoId1, repoId2);\n     }\n \n+    @Test\n+    public void checkGetIdWhenNotRegistered() {\n+        MemoryDocumentStore store = new MemoryDocumentStore();\n+        DocumentNodeStore ds1 = new DocumentMK.Builder()\n+            .setAsyncDelay(0)\n+            .setDocumentStore(store)\n+            .setClusterId(1)\n+            .getNodeStore();\n+        // Should be null and no NPE\n+        String id = ClusterRepositoryInfo.getId(ds1);\n+        Assert.assertNull(id);\n+    }\n+\n     @After\n     public void close() throws IOException {\n         FileUtils.cleanDirectory(new File(DataStoreUtils.getHomeDir()));",
                "changes": 13
            }
        ],
        "unit_tests": [
            "ClusterRepositoryInfoTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
        "buggy_files": [
            "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java"
        ],
        "fixed": true
    }
]