[
    {
        "repo": "activemq",
        "commit": "https://github.com/apache/activemq/commit/0cfd22591260540301b18a893cd229c59e43dcf6",
        "bug_id": "activemq_0cfd225",
        "message": "AMQ-5890: prevent NPE if Modified disposition is applied without the delivery-failed flag set, add some general tests of Modified handling\n\nhttps://issues.apache.org/jira/browse/AMQ-5890",
        "parent": "https://github.com/apache/activemq/commit/c85c7c14720dffeb44633547db540533796a8388",
        "patched_files": [
            "AmqpReceiver.java",
            "AmqpSender.java",
            "AmqpMessage.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/activemq/raw/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/protocol/AmqpSender.java",
                "contents_url": "https://api.github.com/repos/apache/activemq/contents/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/protocol/AmqpSender.java?ref=0cfd22591260540301b18a893cd229c59e43dcf6",
                "filename": "activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/protocol/AmqpSender.java",
                "deletions": 1,
                "sha": "e0e7276ffa6961a51442c81b39c4594ab26bc382",
                "blob_url": "https://github.com/apache/activemq/blob/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/protocol/AmqpSender.java",
                "patch": "@@ -227,7 +227,7 @@ public void delivery(Delivery delivery) throws Exception {\n                 settle(delivery, -1);\n             } else if (state instanceof Modified) {\n                 Modified modified = (Modified) state;\n-                if (modified.getDeliveryFailed()) {\n+                if (Boolean.TRUE.equals(modified.getDeliveryFailed())) {\n                     // increment delivery counter..\n                     md.setRedeliveryCounter(md.getRedeliveryCounter() + 1);\n                 }",
                "changes": 2
            },
            {
                "status": "modified",
                "additions": 7,
                "raw_url": "https://github.com/apache/activemq/raw/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpMessage.java",
                "contents_url": "https://api.github.com/repos/apache/activemq/contents/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpMessage.java?ref=0cfd22591260540301b18a893cd229c59e43dcf6",
                "filename": "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpMessage.java",
                "deletions": 29,
                "sha": "e8ad7937fdbb4fd32497292b14ab98d360283a21",
                "blob_url": "https://github.com/apache/activemq/blob/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpMessage.java",
                "patch": "@@ -140,43 +140,21 @@ public void accept() throws Exception {\n     }\n \n     /**\n-     * Rejects the message, marking it as not deliverable here and failed to deliver.\n+     * Marks the message as Modified, indicating whether it failed to deliver and is not deliverable here.\n      *\n-     * @throws Exception if an error occurs during the reject.\n-     */\n-    public void reject() throws Exception {\n-        reject(true, true);\n-    }\n-\n-    /**\n-     * Rejects the message, marking it as failed to deliver and applying the given value\n-     * to the undeliverable here tag.\n-     *\n-     * @param undeliverableHere\n-     *        marks the delivery as not being able to be process by link it was sent to.\n-     *\n-     * @throws Exception if an error occurs during the reject.\n-     */\n-    public void reject(boolean undeliverableHere) throws Exception {\n-        reject(undeliverableHere, true);\n-    }\n-\n-    /**\n-     * Rejects the message, marking it as not deliverable here and failed to deliver.\n-     *\n-     * @param undeliverableHere\n-     *        marks the delivery as not being able to be process by link it was sent to.\n      * @param deliveryFailed\n      *        indicates that the delivery failed for some reason.\n+     * @param undeliverableHere\n+     *        marks the delivery as not being able to be process by link it was sent to.\n      *\n-     * @throws Exception if an error occurs during the reject.\n+     * @throws Exception if an error occurs during the process.\n      */\n-    public void reject(boolean undeliverableHere, boolean deliveryFailed) throws Exception {\n+    public void modified(Boolean deliveryFailed, Boolean undeliverableHere) throws Exception {\n         if (receiver == null) {\n-            throw new IllegalStateException(\"Can't reject non-received message.\");\n+            throw new IllegalStateException(\"Can't modify non-received message.\");\n         }\n \n-        receiver.reject(delivery, undeliverableHere, deliveryFailed);\n+        receiver.modified(delivery, deliveryFailed, undeliverableHere);\n     }\n \n     /**",
                "changes": 36
            },
            {
                "status": "modified",
                "additions": 5,
                "raw_url": "https://github.com/apache/activemq/raw/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpReceiver.java",
                "contents_url": "https://api.github.com/repos/apache/activemq/contents/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpReceiver.java?ref=0cfd22591260540301b18a893cd229c59e43dcf6",
                "filename": "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpReceiver.java",
                "deletions": 6,
                "sha": "98241cd9472515834fc4e04bb12e35bb58b5febe",
                "blob_url": "https://github.com/apache/activemq/blob/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpReceiver.java",
                "patch": "@@ -316,18 +316,17 @@ public void run() {\n     }\n \n     /**\n-     * Reject a message that was dispatched under the given Delivery instance.\n+     * Mark a message that was dispatched under the given Delivery instance as Modified.\n      *\n      * @param delivery\n-     *        the Delivery instance to reject.\n-     * @param undeliverableHere\n-     *        marks the delivery as not being able to be process by link it was sent to.\n+     *        the Delivery instance to mark modified.\n      * @param deliveryFailed\n      *        indicates that the delivery failed for some reason.\n-     *\n+     * @param undeliverableHere\n+     *        marks the delivery as not being able to be process by link it was sent to.\n      * @throws IOException if an error occurs while sending the reject.\n      */\n-    public void reject(final Delivery delivery, final boolean undeliverableHere, final boolean deliveryFailed) throws IOException {\n+    public void modified(final Delivery delivery, final Boolean deliveryFailed, final Boolean undeliverableHere) throws IOException {\n         checkClosed();\n \n         if (delivery == null) {",
                "changes": 11
            },
            {
                "status": "modified",
                "additions": 65,
                "raw_url": "https://github.com/apache/activemq/raw/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/interop/AmqpReceiverTest.java",
                "contents_url": "https://api.github.com/repos/apache/activemq/contents/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/interop/AmqpReceiverTest.java?ref=0cfd22591260540301b18a893cd229c59e43dcf6",
                "filename": "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/interop/AmqpReceiverTest.java",
                "deletions": 0,
                "sha": "1502bdaaf9d8358240f756044b1b268c6a7689c7",
                "blob_url": "https://github.com/apache/activemq/blob/0cfd22591260540301b18a893cd229c59e43dcf6/activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/interop/AmqpReceiverTest.java",
                "patch": "@@ -21,6 +21,7 @@\n import static org.apache.activemq.transport.amqp.AmqpSupport.findFilter;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n import static org.junit.Assert.assertTrue;\n \n import java.util.HashMap;\n@@ -43,6 +44,7 @@\n import org.apache.qpid.proton.amqp.messaging.TerminusDurability;\n import org.apache.qpid.proton.amqp.messaging.TerminusExpiryPolicy;\n import org.apache.qpid.proton.engine.Receiver;\n+import org.apache.qpid.proton.message.Message;\n import org.junit.Test;\n \n /**\n@@ -412,4 +414,67 @@ public void inspectOpenedResource(Receiver receiver) {\n         connection.getStateInspector().assertValid();\n         connection.close();\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testModifiedDispositionWithDeliveryFailedWithoutUndeliverableHereFieldsSet() throws Exception {\n+        doModifiedDispositionTestImpl(Boolean.TRUE, null);\n+    }\n+\n+    @Test(timeout = 30000)\n+    public void testModifiedDispositionWithoutDeliveryFailedWithoutUndeliverableHereFieldsSet() throws Exception {\n+        doModifiedDispositionTestImpl(null, null);\n+    }\n+\n+    @Test(timeout = 30000)\n+    public void testModifiedDispositionWithoutDeliveryFailedWithUndeliverableHereFieldsSet() throws Exception {\n+        doModifiedDispositionTestImpl(null, Boolean.TRUE);\n+    }\n+\n+    @Test(timeout = 30000)\n+    public void testModifiedDispositionWithDeliveryFailedWithUndeliverableHereFieldsSet() throws Exception {\n+        doModifiedDispositionTestImpl(Boolean.TRUE, Boolean.TRUE);\n+    }\n+\n+    private void doModifiedDispositionTestImpl(Boolean deliveryFailed, Boolean undeliverableHere) throws Exception {\n+        int msgCount = 1;\n+        sendMessages(getTestName(), msgCount, false);\n+\n+        AmqpClient client = createAmqpClient();\n+        AmqpConnection connection = client.connect();\n+        AmqpSession session = connection.createSession();\n+\n+        AmqpReceiver receiver = session.createReceiver(\"queue://\" + getTestName());\n+        receiver.flow(2 * msgCount);\n+\n+        AmqpMessage message = receiver.receive(5, TimeUnit.SECONDS);\n+        assertNotNull(\"did not receive message first time\", message);\n+\n+        Message protonMessage = message.getWrappedMessage();\n+        assertNotNull(protonMessage);\n+        assertEquals(\"Unexpected initial value for AMQP delivery-count\", 0, protonMessage.getDeliveryCount());\n+\n+        message.modified(deliveryFailed, undeliverableHere);\n+\n+        if(Boolean.TRUE.equals(undeliverableHere)) {\n+            message = receiver.receive(250, TimeUnit.MILLISECONDS);\n+            assertNull(\"Should not receive message again\", message);\n+        } else {\n+            message = receiver.receive(5, TimeUnit.SECONDS);\n+            assertNotNull(\"did not receive message again\", message);\n+\n+            int expectedDeliveryCount = 0;\n+            if(Boolean.TRUE.equals(deliveryFailed)) {\n+                expectedDeliveryCount = 1;\n+            }\n+\n+            message.accept();\n+\n+            Message protonMessage2 = message.getWrappedMessage();\n+            assertNotNull(protonMessage2);\n+            assertEquals(\"Unexpected updated value for AMQP delivery-count\", expectedDeliveryCount, protonMessage2.getDeliveryCount());\n+        }\n+\n+        receiver.close();\n+        connection.close();\n+    }\n }",
                "changes": 65
            }
        ],
        "unit_tests": [
            "AmqpSenderTest.java",
            "AmqpReceiverTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/interop/AmqpSenderTest.java",
        "buggy_files": [
            "activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/protocol/AmqpReceiver.java",
            "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpReceiver.java",
            "activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/protocol/AmqpSender.java",
            "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpSender.java",
            "activemq-amqp/src/test/java/org/apache/activemq/transport/amqp/client/AmqpMessage.java"
        ],
        "fixed": true
    }
]