[
    {
        "repo": "hive",
        "commit": "https://github.com/apache/hive/commit/0b810991a12bb7c8d52f64b781772a1deabcbe53",
        "bug_id": "hive_0b81099",
        "message": "HIVE-12740: NPE with HS2 when using null input format (Vikram Dixit K via Gunther Hagleitner)",
        "parent": "https://github.com/apache/hive/commit/6e513b06c12e508af655a6bea4aef55b86619cc6",
        "patched_files": [
            "Utilities.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 12,
                "raw_url": "https://github.com/apache/hive/raw/0b810991a12bb7c8d52f64b781772a1deabcbe53/ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java?ref=0b810991a12bb7c8d52f64b781772a1deabcbe53",
                "filename": "ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java",
                "deletions": 5,
                "sha": "fce11c86fcdf1e9c72575ce5025208e1018a3591",
                "blob_url": "https://github.com/apache/hive/blob/0b810991a12bb7c8d52f64b781772a1deabcbe53/ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java",
                "patch": "@@ -215,6 +215,7 @@\n   public static final String MAPRED_MAPPER_CLASS = \"mapred.mapper.class\";\n   public static final String MAPRED_REDUCER_CLASS = \"mapred.reducer.class\";\n   public static final String HIVE_ADDED_JARS = \"hive.added.jars\";\n+  public static final String VECTOR_MODE = \"VECTOR_MODE\";\n   public static String MAPNAME = \"Map \";\n   public static String REDUCENAME = \"Reducer \";\n \n@@ -3238,12 +3239,18 @@ private static void resetUmaskInConf(Configuration conf, boolean unsetUmask, Str\n    * but vectorization disallowed eg. for FetchOperator execution.\n    */\n   public static boolean isVectorMode(Configuration conf) {\n-    if (HiveConf.getBoolVar(conf, HiveConf.ConfVars.HIVE_VECTORIZATION_ENABLED) &&\n-        Utilities.getPlanPath(conf) != null && Utilities\n-        .getMapWork(conf).getVectorMode()) {\n-      return true;\n+    if (conf.get(VECTOR_MODE) != null) {\n+      // this code path is necessary, because with HS2 and client\n+      // side split generation we end up not finding the map work.\n+      // This is because of thread local madness (tez split\n+      // generation is multi-threaded - HS2 plan cache uses thread\n+      // locals).\n+      return conf.getBoolean(VECTOR_MODE, false);\n+    } else {\n+      return HiveConf.getBoolVar(conf, HiveConf.ConfVars.HIVE_VECTORIZATION_ENABLED)\n+        && Utilities.getPlanPath(conf) != null\n+        && Utilities.getMapWork(conf).getVectorMode();\n     }\n-    return false;\n   }\n \n   /**",
                "changes": 17
            },
            {
                "status": "modified",
                "additions": 9,
                "raw_url": "https://github.com/apache/hive/raw/0b810991a12bb7c8d52f64b781772a1deabcbe53/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/DagUtils.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/DagUtils.java?ref=0b810991a12bb7c8d52f64b781772a1deabcbe53",
                "filename": "ql/src/java/org/apache/hadoop/hive/ql/exec/tez/DagUtils.java",
                "deletions": 0,
                "sha": "e8864aee6428d3cc6b165acbc188cac8d22ffd61",
                "blob_url": "https://github.com/apache/hive/blob/0b810991a12bb7c8d52f64b781772a1deabcbe53/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/DagUtils.java",
                "patch": "@@ -614,6 +614,15 @@ private Vertex createVertex(JobConf conf, MapWork mapWork,\n       }\n     } else {\n       // Setup client side split generation.\n+\n+      // we need to set this, because with HS2 and client side split\n+      // generation we end up not finding the map work. This is\n+      // because of thread local madness (tez split generation is\n+      // multi-threaded - HS2 plan cache uses thread locals). Setting\n+      // VECTOR_MODE causes the split gen code to use the conf instead\n+      // of the map work.\n+      conf.setBoolean(Utilities.VECTOR_MODE, mapWork.getVectorMode());\n+\n       dataSource = MRInputHelpers.configureMRInputWithLegacySplitGeneration(conf, new Path(tezDir,\n           \"split_\" + mapWork.getName().replaceAll(\" \", \"_\")), true);\n       numTasks = dataSource.getNumberOfShards();",
                "changes": 9
            }
        ],
        "unit_tests": [
            "TestUtilities.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "ql/src/test/org/apache/hadoop/hive/ql/exec/TestUtilities.java",
        "buggy_files": [
            "ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java",
            "ql/src/test/org/apache/hadoop/hive/ql/exec/persistence/Utilities.java"
        ],
        "fixed": true
    }
]