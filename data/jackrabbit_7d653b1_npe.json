[
    {
        "repo": "jackrabbit",
        "commit": "https://github.com/apache/jackrabbit/commit/7d653b12127c3da2f5c1804551bd76c6797fd21d",
        "bug_id": "jackrabbit_7d653b1",
        "message": "JCR-3435: Fix NPE for xpath query with child axis and star name\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1393342 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/c403b6eca2b7722a9dc8db2fb237e2fb050f79ac",
        "patched_files": [
            "XPathQueryBuilder.java",
            "QueryFormat.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d",
                "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
                "deletions": 1,
                "sha": "d345adcaaaeb7c9dde3ff7b12e145c4c540a5b98",
                "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
                "patch": "@@ -348,7 +348,7 @@ public Object visit(RelationQueryNode node, Object data) throws RepositoryExcept\n             PathQueryNode relPath = node.getRelativePath();\n             if (relPath == null) {\n                 propPath.append(\".\");\n-            } else if (relPath.getNumOperands() > 0 && relPath.getPathSteps()[0].getNameTest().equals(XPathQueryBuilder.FN_POSITION_FULL)) {\n+            } else if (relPath.getNumOperands() > 0 && XPathQueryBuilder.FN_POSITION_FULL.equals(relPath.getPathSteps()[0].getNameTest())) {\n                 propPath.append(resolver.getJCRName(XPathQueryBuilder.FN_POSITION_FULL));\n             } else {\n                 LocationStepQueryNode[] steps = relPath.getPathSteps();",
                "changes": 2
            },
            {
                "status": "modified",
                "additions": 8,
                "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d",
                "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
                "deletions": 3,
                "sha": "2fa556437e041137d664dcbd958f04983d390450",
                "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
                "patch": "@@ -425,8 +425,13 @@ public Object visit(SimpleNode node, Object data) {\n                         }\n                         PathQueryNode relPath = tmp.getRelativePath();\n                         LocationStepQueryNode[] steps = relPath.getPathSteps();\n-                        \n-                        tmpRelPath.addLast(steps[steps.length-1].getNameTest());\n+\n+                        Name nameTest = steps[steps.length-1].getNameTest();\n+                        if (nameTest==null) {\n+                        \t// see LocationStepQueryNode javadoc on when getNameTest()==null: when it was a star (asterisk)\n+                        \tnameTest = RelationQueryNode.STAR_NAME_TEST;\n+                        }\n+\t\t\t\t\t\ttmpRelPath.addLast(nameTest);\n                     }\n                 }\n                 break;\n@@ -956,7 +961,7 @@ private QueryNode createFunction(SimpleNode node, QueryNode queryNode) {\n                     }\n                     if (queryNode.getType() == QueryNode.TYPE_PATH) {\n                         PathQueryNode pathNode = (PathQueryNode) queryNode;\n-                        \n+\n                         pathNode.addPathStep(createDerefQueryNode(node, descendant, pathNode));\n                     } else if (queryNode.getType() == QueryNode.TYPE_RELATION) {\n                         RelationQueryNode relNode = (RelationQueryNode) queryNode;",
                "changes": 11
            },
            {
                "status": "modified",
                "additions": 8,
                "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d",
                "filename": "jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
                "deletions": 0,
                "sha": "a07e8e255ab27c025c1e011d651663d55d8ab3a1",
                "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
                "patch": "@@ -67,6 +67,14 @@ public void testStarNameTest() throws Exception {\n         checkStatement(\"//element(*, foo)[foo/*/@bar = 'bla']\");\n     }\n \n+    public void testStarNameAtBeginningOfPredicate() throws Exception {\n+        checkStatement(\"//element(*, foo)[*/*/@bar = 'bla']\");\n+    }\n+\n+    public void testChildStarName() throws Exception {\n+        checkStatement(\"//programs//*[*/@sunday]\");\n+    }\n+\n     public void testRepSimilar() throws Exception {\n         checkStatement(\"//element(*, foo)[rep:similar(foo, '/some/path')]\");\n     }",
                "changes": 8
            }
        ],
        "unit_tests": [
            "QueryFormatTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
        "buggy_files": [
            "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
            "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/XPathQueryBuilder.java",
            "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
            "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/sql/QueryFormat.java"
        ],
        "fixed": true
    }
]