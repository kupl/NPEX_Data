[{"commit": "https://github.com/apache/cxf-fediz/commit/090031f0d97cc15cdaffe30932fb450267a363b0", "parent": "https://github.com/apache/cxf-fediz/commit/4a571afacb5e3b6dc7f1b0cf9472b1e507c5defa", "message": "Fixed some NPEs in the Fediz OIDC client registration console.", "bug_id": "cxf-fediz_1", "file": [{"additions": 12, "raw_url": "https://github.com/apache/cxf-fediz/raw/090031f0d97cc15cdaffe30932fb450267a363b0/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/090031f0d97cc15cdaffe30932fb450267a363b0/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java", "sha": "6327edf4e83414faed1200f25b6e92e628894d2c", "changes": 12, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java?ref=090031f0d97cc15cdaffe30932fb450267a363b0", "patch": "@@ -160,6 +160,9 @@ public Client resetClient(@PathParam(\"id\") String id,\n         checkSecurityContext();\n \n         Client c = getRegisteredClient(id);\n+        if (c == null) {\n+            throwInvalidRegistrationException(\"The client id is invalid\");\n+        }\n         if (c.isConfidential()) {\n             c.setClientSecret(generateClientSecret());\n         }\n@@ -173,6 +176,9 @@ public Client resetClient(@PathParam(\"id\") String id,\n     public ClientTokens getClientIssuedTokens(@PathParam(\"id\") String id) {\n         checkSecurityContext();\n         Client c = getRegisteredClient(id);\n+        if (c == null) {\n+            throwInvalidRegistrationException(\"The client id is invalid\");\n+        }\n         return doGetClientIssuedTokens(c);\n     }\n \n@@ -217,6 +223,9 @@ protected ClientTokens doRevokeClientToken(String clientId,\n         checkSecurityContext();\n \n         Client c = getRegisteredClient(clientId);\n+        if (c == null) {\n+            throwInvalidRegistrationException(\"The client id is invalid\");\n+        }\n         dataProvider.revokeToken(c, tokenId, tokenType);\n         return doGetClientIssuedTokens(c);\n     }\n@@ -228,6 +237,9 @@ public ClientCodeGrants getClientCodeGrants(@PathParam(\"id\") String id) {\n         checkSecurityContext();\n         if (dataProvider instanceof AuthorizationCodeDataProvider) {\n             Client c = getRegisteredClient(id);\n+            if (c == null) {\n+                throwInvalidRegistrationException(\"The client id is invalid\");\n+            }\n             UserSubject subject = new OidcUserSubject(getUserName());\n             List<ServerAuthorizationCodeGrant> codeGrants = new ArrayList<>(\n                ((AuthorizationCodeDataProvider)dataProvider).getCodeGrants(c, subject));", "filename": "services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/b89e7d21618b2fd282f0f9c07255c5f68b6c4ad2", "parent": "https://github.com/apache/cxf-fediz/commit/8a21a1cd08c2a40f60f4a03f5869a14e2ec4bec9", "message": "NPE guard", "bug_id": "cxf-fediz_2", "file": [{"additions": 4, "raw_url": "https://github.com/apache/cxf-fediz/raw/b89e7d21618b2fd282f0f9c07255c5f68b6c4ad2/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/handler/hrd/ClientIdHomeRealmDiscovery.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/b89e7d21618b2fd282f0f9c07255c5f68b6c4ad2/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/handler/hrd/ClientIdHomeRealmDiscovery.java", "sha": "86bb58bb54d1c6056534876762a5b682a48b04d6", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/handler/hrd/ClientIdHomeRealmDiscovery.java?ref=b89e7d21618b2fd282f0f9c07255c5f68b6c4ad2", "patch": "@@ -50,8 +50,10 @@ public void handle(Callback[] callbacks) throws IOException, UnsupportedCallback\n                     OAuthDataProvider dataManager = (OAuthDataProvider)ctx.getBean(\"oauthProvider\");\n \n                     Client client = dataManager.getClient(clientId);\n-                    callback.setHomeRealm(client.getHomeRealm());\n-                    LOG.debug(\"Retrieved home realm {}\", callback.getHomeRealm());\n+                    if (client != null) {\n+                        callback.setHomeRealm(client.getHomeRealm());\n+                        LOG.debug(\"Retrieved home realm {}\", callback.getHomeRealm());\n+                    }\n \n                 }\n ", "filename": "services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/handler/hrd/ClientIdHomeRealmDiscovery.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/2d42d674a49b07eb18656a1942e420ae656ad76f", "parent": "https://github.com/apache/cxf-fediz/commit/b54fb65539ce18f0ab602fe75b01c3fdc270e6b1", "message": "NPE guard", "bug_id": "cxf-fediz_3", "file": [{"additions": 5, "raw_url": "https://github.com/apache/cxf-fediz/raw/2d42d674a49b07eb18656a1942e420ae656ad76f/services/idp-core/src/main/java/org/apache/cxf/fediz/service/idp/STSUPAuthenticationProvider.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/2d42d674a49b07eb18656a1942e420ae656ad76f/services/idp-core/src/main/java/org/apache/cxf/fediz/service/idp/STSUPAuthenticationProvider.java", "sha": "54fb24e5004d302364cbad6a8f96ed1e606e818b", "changes": 8, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/idp-core/src/main/java/org/apache/cxf/fediz/service/idp/STSUPAuthenticationProvider.java?ref=2d42d674a49b07eb18656a1942e420ae656ad76f", "patch": "@@ -140,9 +140,11 @@ private String getCustomSTSParameterValue() {\n                 HttpServletResponse response =\n                         ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getResponse();\n                 SavedRequest savedRequest = requestCache.getRequest(request, response);\n-                String[] parameterValues = savedRequest.getParameterValues(this.getCustomSTSParameter());\n-                if (parameterValues != null && parameterValues.length > 0) {\n-                    authRealmParameter = parameterValues[0];\n+                if (savedRequest != null) {\n+                    String[] parameterValues = savedRequest.getParameterValues(this.getCustomSTSParameter());\n+                    if (parameterValues != null && parameterValues.length > 0) {\n+                        authRealmParameter = parameterValues[0];\n+                    }\n                 }\n             }\n             LOG.debug(\"Found {} custom STS parameter {}\", getCustomSTSParameter(), authRealmParameter);", "filename": "services/idp-core/src/main/java/org/apache/cxf/fediz/service/idp/STSUPAuthenticationProvider.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/d48929d903db8ddf71137aeb2b551c8e686b52ef", "parent": "https://github.com/apache/cxf-fediz/commit/0dabf1562f6ed6994c8e943460ef1107299203c0", "message": "NPE fix", "bug_id": "cxf-fediz_4", "file": [{"additions": 15, "raw_url": "https://github.com/apache/cxf-fediz/raw/d48929d903db8ddf71137aeb2b551c8e686b52ef/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/logout/LogoutRedirectConstraintHandler.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/d48929d903db8ddf71137aeb2b551c8e686b52ef/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/logout/LogoutRedirectConstraintHandler.java", "sha": "8335a5c90134d5c7d7f358d39931e9c46b8b88c9", "changes": 23, "status": "modified", "deletions": 8, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/logout/LogoutRedirectConstraintHandler.java?ref=d48929d903db8ddf71137aeb2b551c8e686b52ef", "patch": "@@ -48,19 +48,26 @@ public void handle(Callback[] callbacks) throws IOException, UnsupportedCallback\n                     if (request != null && request.getParameter(OAuthConstants.CLIENT_ID) != null) {\n                         String clientId = request.getParameter(OAuthConstants.CLIENT_ID);\n \n-                        ApplicationContext ctx = ApplicationContextProvider.getApplicationContext();\n-                        OAuthDataProvider dataManager = (OAuthDataProvider)ctx.getBean(\"oauthProvider\");\n-\n-                        Client client = dataManager.getClient(clientId);\n-                        String logoutUri = client.getProperties().get(CLIENT_LOGOUT_URI);\n-                        if (logoutUri != null) {\n-                            replyConstraintCallback.setReplyConstraint(Pattern.compile(logoutUri));\n-                        }\n+                        replyConstraintCallback.setReplyConstraint(getLogoutRedirectConstraint(clientId));\n                     }\n                 }\n             }\n         }\n     }\n \n+    private Pattern getLogoutRedirectConstraint(String clientId) {\n+        ApplicationContext ctx = ApplicationContextProvider.getApplicationContext();\n+        OAuthDataProvider dataManager = (OAuthDataProvider)ctx.getBean(\"oauthProvider\");\n+\n+        Client client = dataManager.getClient(clientId);\n+        if (client != null) {\n+            String logoutUri = client.getProperties().get(CLIENT_LOGOUT_URI);\n+            if (logoutUri != null) {\n+                return Pattern.compile(logoutUri);\n+            }\n+        }\n+        \n+        return null;\n+    }\n \n }", "filename": "services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/logout/LogoutRedirectConstraintHandler.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/841f380b914848743db284adfefede0621c524c7", "parent": "https://github.com/apache/cxf-fediz/commit/e8aec20af5e9f6ca5428dfb74ff1fd2c0e448298", "message": "NPE guard", "bug_id": "cxf-fediz_5", "file": [{"additions": 17, "raw_url": "https://github.com/apache/cxf-fediz/raw/841f380b914848743db284adfefede0621c524c7/plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/841f380b914848743db284adfefede0621c524c7/plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java", "sha": "88e8da1dddf80fd7bfe6c42366c4f991e8a17dea", "changes": 31, "status": "modified", "deletions": 14, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java?ref=841f380b914848743db284adfefede0621c524c7", "patch": "@@ -574,14 +574,16 @@ private String resolveSignInQuery(HttpServletRequest request, FedizContext confi\n                     callback\n                 });\n                 Map<String, String> signInQueryMap = callback.getSignInQueryParamMap();\n-                StringBuilder sbQuery = new StringBuilder();\n-                for (Entry<String, String> entry : signInQueryMap.entrySet()) {\n-                    if (sbQuery.length() > 0) {\n-                        sbQuery.append(\"&\");\n+                if (signInQueryMap != null) {\n+                    StringBuilder sbQuery = new StringBuilder();\n+                    for (Entry<String, String> entry : signInQueryMap.entrySet()) {\n+                        if (sbQuery.length() > 0) {\n+                            sbQuery.append(\"&\");\n+                        }\n+                        sbQuery.append(entry.getKey()).append('=').append(URLEncoder.encode(entry.getValue(), \"UTF-8\"));\n                     }\n-                    sbQuery.append(entry.getKey()).append('=').append(URLEncoder.encode(entry.getValue(), \"UTF-8\"));\n+                    signInQuery = sbQuery.toString();\n                 }\n-                signInQuery = sbQuery.toString();\n \n             }\n         }\n@@ -601,16 +603,17 @@ private String resolveSignOutQuery(HttpServletRequest request, FedizContext conf\n                 frCB.handle(new Callback[] {\n                     callback\n                 });\n-                Map<String, String> signInQueryMap = callback.getSignOutQueryParamMap();\n-                StringBuilder sbQuery = new StringBuilder();\n-                for (Entry<String, String> entry : signInQueryMap.entrySet()) {\n-                    if (sbQuery.length() > 0) {\n-                        sbQuery.append(\"&\");\n+                Map<String, String> signOutQueryMap = callback.getSignOutQueryParamMap();\n+                if (signOutQueryMap != null) {\n+                    StringBuilder sbQuery = new StringBuilder();\n+                    for (Entry<String, String> entry : signOutQueryMap.entrySet()) {\n+                        if (sbQuery.length() > 0) {\n+                            sbQuery.append(\"&\");\n+                        }\n+                        sbQuery.append(entry.getKey()).append('=').append(URLEncoder.encode(entry.getValue(), \"UTF-8\"));\n                     }\n-                    sbQuery.append(entry.getKey()).append('=').append(URLEncoder.encode(entry.getValue(), \"UTF-8\"));\n+                    signOutQuery = sbQuery.toString();\n                 }\n-                signOutQuery = sbQuery.toString();\n-    \n             }\n         }\n         return signOutQuery;", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/ad26d39f5e835c9810a0befb271282785c74e323", "parent": "https://github.com/apache/cxf-fediz/commit/e34b37f1d691bc36b212de9e23ef568f1cd4f5e5", "message": "Avoid NPE", "bug_id": "cxf-fediz_6", "file": [{"additions": 3, "raw_url": "https://github.com/apache/cxf-fediz/raw/ad26d39f5e835c9810a0befb271282785c74e323/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/samlsso/AuthnRequestValidator.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/ad26d39f5e835c9810a0befb271282785c74e323/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/samlsso/AuthnRequestValidator.java", "sha": "11be3f7874c8514a18a105db11b785d936cbc12c", "changes": 3, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/samlsso/AuthnRequestValidator.java?ref=ad26d39f5e835c9810a0befb271282785c74e323", "patch": "@@ -74,6 +74,9 @@ public void validateAuthnRequest(RequestContext context, Idp idp, String signatu\n         throws Exception {\n         AuthnRequest authnRequest = \n             (AuthnRequest)WebUtils.getAttributeFromFlowScope(context, IdpConstants.SAML_AUTHN_REQUEST);\n+        if (authnRequest == null) {\n+            throw new ProcessingException(TYPE.BAD_REQUEST);\n+        }\n         \n         validateSignature(context, authnRequest, idp, signature, relayState, samlRequest, realm);\n         ", "filename": "services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/samlsso/AuthnRequestValidator.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/12e5c23315a1a664661b2cd269c04467ed66afae", "parent": "https://github.com/apache/cxf-fediz/commit/2e119aa15d76c19b505db434313f84a9a4fde112", "message": "NPE guard", "bug_id": "cxf-fediz_7", "file": [{"additions": 6, "raw_url": "https://github.com/apache/cxf-fediz/raw/12e5c23315a1a664661b2cd269c04467ed66afae/plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/12e5c23315a1a664661b2cd269c04467ed66afae/plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java", "sha": "cc94fee2f8569aeb7d7ef3d432973a5a4b3d0aad", "changes": 8, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java?ref=12e5c23315a1a664661b2cd269c04467ed66afae", "patch": "@@ -152,8 +152,12 @@ protected FedizResponse processSignInRequest(FedizRequest request, FedizContext\n         }\n         \n         if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"RST: {}\", DOM2Writer.nodeToString(rst));\n-            LOG.debug(\"Lifetime: {}\", DOM2Writer.nodeToString(lifetimeElem));\n+            if (rst != null) {\n+                LOG.debug(\"RST: {}\", DOM2Writer.nodeToString(rst));\n+            }\n+            if (lifetimeElem != null) {\n+                LOG.debug(\"Lifetime: {}\", DOM2Writer.nodeToString(lifetimeElem));\n+            }\n         }\n         LOG.debug(\"Tokentype: {}\", tt);\n         ", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/processor/FederationProcessorImpl.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/1a26bcf4f0b34f10c23d0ca46b9bec72a4a956df", "parent": "https://github.com/apache/cxf-fediz/commit/d280bce7ca5d8751a285a541c424781a517b6b3f", "message": "Fixing NPE if no key alias", "bug_id": "cxf-fediz_8", "file": [{"additions": 4, "raw_url": "https://github.com/apache/cxf-fediz/raw/1a26bcf4f0b34f10c23d0ca46b9bec72a4a956df/plugins/core/src/main/java/org/apache/cxf/fediz/core/util/CertsUtils.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/1a26bcf4f0b34f10c23d0ca46b9bec72a4a956df/plugins/core/src/main/java/org/apache/cxf/fediz/core/util/CertsUtils.java", "sha": "24d6be10124454055f3c3df82ba33221aa4989c5", "changes": 4, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/util/CertsUtils.java?ref=1a26bcf4f0b34f10c23d0ca46b9bec72a4a956df", "patch": "@@ -110,6 +110,10 @@ public static X509Certificate getX509CertificateFromCrypto(Crypto crypto, String\n             keyAlias = crypto.getDefaultX509Identifier();\n         }\n         \n+        if (keyAlias == null) {\n+            throw new RuntimeException(\"No keystore alias was specified to sign the metadata\");\n+        }\n+        \n         CryptoType cryptoType = new CryptoType(CryptoType.TYPE.ALIAS);\n         cryptoType.setAlias(keyAlias);\n         X509Certificate[] issuerCerts = crypto.getX509Certificates(cryptoType);", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/util/CertsUtils.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/953282b320e5342020fe8b77e62715b617877479", "parent": "https://github.com/apache/cxf-fediz/commit/4c20cefb8369a79f946b13ba7c8f2d03b605c1c5", "message": "Consolidate Tomcat shutdown code + avoid a NPE", "bug_id": "cxf-fediz_9", "file": [{"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/cxf/src/test/java/org/apache/cxf/fediz/integrationtests/federation/FederationTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/cxf/src/test/java/org/apache/cxf/fediz/integrationtests/federation/FederationTest.java", "sha": "937d5afc82c33c0c111d5831a4d8ecf6e9ebfa2c", "changes": 28, "status": "modified", "deletions": 18, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/cxf/src/test/java/org/apache/cxf/fediz/integrationtests/federation/FederationTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -134,30 +134,22 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-        \n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();\n         }\n-        \n     }\n     \n     public String getIdpHttpsPort() {", "filename": "systests/cxf/src/test/java/org/apache/cxf/fediz/integrationtests/federation/FederationTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/federation/oidc/src/test/java/org/apache/cxf/fediz/integrationtests/OIDCTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/federation/oidc/src/test/java/org/apache/cxf/fediz/integrationtests/OIDCTest.java", "sha": "d1ba0129570214e83bc2537a652ea21ba72aa2fc", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/federation/oidc/src/test/java/org/apache/cxf/fediz/integrationtests/OIDCTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -200,25 +200,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/federation/oidc/src/test/java/org/apache/cxf/fediz/integrationtests/OIDCTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOFedizTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOFedizTest.java", "sha": "bd7d7f13702e53c09ca657e28ce0b4c4fd00ad5c", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOFedizTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -195,25 +195,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOFedizTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOTest.java", "sha": "7aeac6eee3c314da365a42b8ea8616c8a54beada", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -206,25 +206,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/federation/samlsso/src/test/java/org/apache/cxf/fediz/integrationtests/SAMLSSOTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/federation/wsfed/src/test/java/org/apache/cxf/fediz/integrationtests/WSFedTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/federation/wsfed/src/test/java/org/apache/cxf/fediz/integrationtests/WSFedTest.java", "sha": "f5cc0e66db8b600910827641e5037149eb1be889", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/federation/wsfed/src/test/java/org/apache/cxf/fediz/integrationtests/WSFedTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -198,25 +198,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/federation/wsfed/src/test/java/org/apache/cxf/fediz/integrationtests/WSFedTest.java"}, {"additions": 9, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/idp/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/idp/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java", "sha": "58ed81c324647fa4033bcaa7682a25604e9567a6", "changes": 14, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/idp/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -117,13 +117,17 @@ private static void initIdp() {\n \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                idpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/idp/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/kerberos/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/kerberos/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java", "sha": "74106e45f133c5a80041015223800ec1a98206e6", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/kerberos/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -241,25 +241,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/kerberos/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java"}, {"additions": 8, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/oidc/src/test/java/org/apache/cxf/fediz/systests/oidc/OIDCTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/oidc/src/test/java/org/apache/cxf/fediz/systests/oidc/OIDCTest.java", "sha": "f57aa1a083b963d03f697957d418e20fee7954be", "changes": 27, "status": "modified", "deletions": 19, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/oidc/src/test/java/org/apache/cxf/fediz/systests/oidc/OIDCTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -186,30 +186,19 @@ public static void cleanup() throws Exception {\n         try {\n             loginToClientsPageAndDeleteClient(rpHttpsPort, idpHttpsPort);\n         } finally {\n-            shutdownServers();\n+            shutdownServer(idpServer);\n+            shutdownServer(rpServer);\n         }\n     }\n     \n-    private static void shutdownServers() {\n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n-                }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/oidc/src/test/java/org/apache/cxf/fediz/systests/oidc/OIDCTest.java"}, {"additions": 9, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/samlsso/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/samlsso/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java", "sha": "fa75b9d9fa1a855ce148f72f079c0721cc225507", "changes": 14, "status": "modified", "deletions": 5, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/samlsso/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -137,13 +137,17 @@ private static void initIdp() {\n \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                idpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/samlsso/src/test/java/org/apache/cxf/fediz/systests/idp/IdpTest.java"}, {"additions": 11, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java", "sha": "f20a45f8a479698dbfc5173b50c535a64e79787c", "changes": 28, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -72,25 +72,18 @@ public static void init() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();\n@@ -259,6 +252,7 @@ public void testAliceModifiedSignature() throws Exception {\n             //                  || ex.getMessage().contains(\"403 Forbidden\"));\n         }\n \n+        webClient.close();\n     }\n     \n     @Override", "filename": "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java", "sha": "4da2edc7f2894bbc03cd2f7a68c217684b5b7505", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -58,25 +58,18 @@ public static void init() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java", "sha": "406e4b5319cfe85a4ee0cb81902090debf22d16d", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -139,25 +139,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java"}, {"additions": 11, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java", "sha": "9b996cfe22e598aeebaa7d06f3111183294b9e7f", "changes": 29, "status": "modified", "deletions": 18, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -149,31 +149,24 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();\n         }\n     }\n-\n+    \n     public String getIdpHttpsPort() {\n         return idpHttpsPort;\n     }", "filename": "systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java", "sha": "f41f03bf4968b5c2d9dbfdc00bff33f518385e56", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -138,25 +138,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java", "sha": "0bf76910bb227d55fdc5157dbf86e957c11556ee", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -152,25 +152,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java", "sha": "7a1e24ea21cb5dc926480633e4ce142468c87357", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -139,25 +139,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/ClientCertificateTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java", "sha": "650b610df9314acb450a8dafe381fb6384900e31", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -149,25 +149,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/HolderOfKeyTest.java"}, {"additions": 10, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java", "sha": "646c9ed71e932272c51ec97b95c3361d6b64723d", "changes": 27, "status": "modified", "deletions": 17, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -138,25 +138,18 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();", "filename": "systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/TomcatTest.java"}, {"additions": 11, "raw_url": "https://github.com/apache/cxf-fediz/raw/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/953282b320e5342020fe8b77e62715b617877479/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java", "sha": "48e58517397783e857e7c4be29bb47656f250646", "changes": 29, "status": "modified", "deletions": 18, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java?ref=953282b320e5342020fe8b77e62715b617877479", "patch": "@@ -152,31 +152,24 @@ private static void initRp() {\n     \n     @AfterClass\n     public static void cleanup() {\n+        shutdownServer(idpServer);\n+        shutdownServer(rpServer);\n+    }\n+    \n+    private static void shutdownServer(Tomcat server) {\n         try {\n-            if (idpServer.getServer() != null\n-                && idpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (idpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    idpServer.stop();\n-                }\n-                idpServer.destroy();\n-            }\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-        }\n-\n-        try {\n-            if (rpServer.getServer() != null\n-                && rpServer.getServer().getState() != LifecycleState.DESTROYED) {\n-                if (rpServer.getServer().getState() != LifecycleState.STOPPED) {\n-                    rpServer.stop();\n+            if (server != null && server.getServer() != null\n+                && server.getServer().getState() != LifecycleState.DESTROYED) {\n+                if (server.getServer().getState() != LifecycleState.STOPPED) {\n+                    server.stop();\n                 }\n-                rpServer.destroy();\n+                server.destroy();\n             }\n         } catch (Exception e) {\n             e.printStackTrace();\n         }\n     }\n-\n+    \n     public String getIdpHttpsPort() {\n         return idpHttpsPort;\n     }", "filename": "systests/tomcat8/src/test/java/org/apache/cxf/fediz/integrationtests/WReqTest.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/3844b00467c43808c728b4078f3fb3d82256ec94", "parent": "https://github.com/apache/cxf-fediz/commit/33a7e179c3e79b7c437e036aefc545234fc770aa", "message": "[FEDIZ-174] Fixing NPE when restarting Fediz OIDC after using dynamic registration, patch from Adrian Gonzalez applied, This closes #13", "bug_id": "cxf-fediz_10", "file": [{"additions": 9, "raw_url": "https://github.com/apache/cxf-fediz/raw/3844b00467c43808c728b4078f3fb3d82256ec94/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/3844b00467c43808c728b4078f3fb3d82256ec94/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java", "sha": "a4859cae4319a8ff81eda4e9b362bd64cdcc4490", "changes": 16, "status": "modified", "deletions": 7, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java?ref=3844b00467c43808c728b4078f3fb3d82256ec94", "patch": "@@ -422,14 +422,16 @@ public void setHomeRealms(Map<String, String> homeRealms) {\n \n     public void init() {\n         for (Client c : clientProvider.getClients(null)) {\n-            String userName = c.getResourceOwnerSubject().getLogin();\n-            getClientRegistrations(userName).add(c);\n-            Set<String> names = clientNames.get(userName);\n-            if (names == null) {\n-                names = new HashSet<>();\n-                clientNames.put(userName, names);\n+            if (c.getResourceOwnerSubject() != null) {\n+                String userName = c.getResourceOwnerSubject().getLogin();\n+                getClientRegistrations(userName).add(c);\n+                Set<String> names = clientNames.get(userName);\n+                if (names == null) {\n+                    names = new HashSet<>();\n+                    clientNames.put(userName, names);\n+                }\n+                names.add(c.getApplicationName());\n             }\n-            names.add(c.getApplicationName());\n         }\n     }\n ", "filename": "services/oidc/src/main/java/org/apache/cxf/fediz/service/oidc/clients/ClientRegistrationService.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/ce7c9a78951d8fde7188b08dac111262fb961c34", "parent": "https://github.com/apache/cxf-fediz/commit/a32b934ffc498410ba3761dd66c568df24a98a8f", "message": "NPE fix", "bug_id": "cxf-fediz_11", "file": [{"additions": 8, "raw_url": "https://github.com/apache/cxf-fediz/raw/ce7c9a78951d8fde7188b08dac111262fb961c34/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/ce7c9a78951d8fde7188b08dac111262fb961c34/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java", "sha": "9e9d2ed0faf0fe5b6e8d9bd01bc4bf908bc194ea", "changes": 10, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java?ref=ce7c9a78951d8fde7188b08dac111262fb961c34", "patch": "@@ -104,7 +104,7 @@ public void init() {\n         certificateStores = new ArrayList<TrustManager>();\n         CertificateStores certStores = config.getCertificateStores();\n         List<TrustManagersType> trustManagers = certStores.getTrustManager();\n-        for (TrustManagersType manager:trustManagers) {\n+        for (TrustManagersType manager : trustManagers) {\n             TrustManager tm = new TrustManager(manager);\n             \n             Crypto crypto = null;\n@@ -170,11 +170,14 @@ public String getLogoutRedirectTo() {\n     \n     \n     public KeyManager getSigningKey() {\n-        //return new KeyManager(config.getSigningKey());\n         \n         if (keyManager != null) {\n             return keyManager;\n         }\n+        if (config.getSigningKey() == null) {\n+            LOG.error(\"No signing key has been configured\");\n+            throw new IllegalConfigurationException(\"No signing key has been configured\");\n+        }\n         keyManager = new KeyManager(config.getSigningKey());\n         Properties sigProperties = createCryptoProperties(config.getSigningKey());\n         Crypto crypto;\n@@ -196,6 +199,9 @@ public KeyManager getDecryptionKey() {\n         if (decryptionKeyManager != null) {\n             return decryptionKeyManager;\n         }\n+        if (config.getTokenDecryptionKey() == null) {\n+            return null;\n+        }\n         decryptionKeyManager = new KeyManager(config.getTokenDecryptionKey());\n         Properties decProperties = createCryptoProperties(config.getTokenDecryptionKey());\n         Crypto crypto;", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/b409d475590b165537aea8cd3762e0442c9483ba", "parent": "https://github.com/apache/cxf-fediz/commit/dd161ea296dedd3028a0308d60ecdd50d44c6598", "message": "NPE fix", "bug_id": "cxf-fediz_12", "file": [{"additions": 20, "raw_url": "https://github.com/apache/cxf-fediz/raw/b409d475590b165537aea8cd3762e0442c9483ba/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/SigninParametersCacheAction.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/b409d475590b165537aea8cd3762e0442c9483ba/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/SigninParametersCacheAction.java", "sha": "93fab36184e7c0ddac8d911de76cbcce17fcd2d6", "changes": 35, "status": "modified", "deletions": 15, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/SigninParametersCacheAction.java?ref=b409d475590b165537aea8cd3762e0442c9483ba", "patch": "@@ -76,22 +76,27 @@ public void restore(RequestContext context) {\n         Map<String, Object> signinParams =\n             (Map<String, Object>)WebUtils.getAttributeFromExternalContext(context, uuidKey);\n         \n-        String value = (String)signinParams.get(FederationConstants.PARAM_REPLY);\n-        if (value != null) {\n-            WebUtils.putAttributeInFlowScope(context, FederationConstants.PARAM_REPLY, value);\n-        }\n-        value = (String)signinParams.get(FederationConstants.PARAM_TREALM);\n-        if (value != null) {\n-            WebUtils.putAttributeInFlowScope(context, FederationConstants.PARAM_TREALM, value);\n-        }\n-        value = (String)signinParams.get(FederationConstants.PARAM_HOME_REALM);\n-        if (value != null) {\n-            WebUtils.putAttributeInFlowScope(context, FederationConstants.PARAM_HOME_REALM, value);\n+        if (signinParams != null) {\n+            String value = (String)signinParams.get(FederationConstants.PARAM_REPLY);\n+            if (value != null) {\n+                WebUtils.putAttributeInFlowScope(context, FederationConstants.PARAM_REPLY, value);\n+            }\n+            value = (String)signinParams.get(FederationConstants.PARAM_TREALM);\n+            if (value != null) {\n+                WebUtils.putAttributeInFlowScope(context, FederationConstants.PARAM_TREALM, value);\n+            }\n+            value = (String)signinParams.get(FederationConstants.PARAM_HOME_REALM);\n+            if (value != null) {\n+                WebUtils.putAttributeInFlowScope(context, FederationConstants.PARAM_HOME_REALM, value);\n+            }\n+            \n+            LOG.debug(\"SignIn parameters restored: {}\", signinParams.toString());\n+            WebUtils.removeAttributeFromFlowScope(context, FederationConstants.PARAM_CONTEXT);\n+            LOG.info(\"SignIn parameters restored and \" + FederationConstants.PARAM_CONTEXT + \"[\" \n+                + uuidKey + \"] cleared.\");\n+        } else {\n+            LOG.debug(\"Error in restoring security context\");\n         }\n-        \n-        LOG.debug(\"SignIn parameters restored: {}\", signinParams.toString());\n-        WebUtils.removeAttributeFromFlowScope(context, FederationConstants.PARAM_CONTEXT);\n-        LOG.info(\"SignIn parameters restored and \" + FederationConstants.PARAM_CONTEXT + \"[\" + uuidKey + \"] cleared.\");\n     }\n \n     public void storeRPUrlInSession(RequestContext context) throws ProcessingException {", "filename": "services/idp/src/main/java/org/apache/cxf/fediz/service/idp/beans/SigninParametersCacheAction.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/e17038b5330bc4db66214bf59e5315d7efdeebde", "parent": "https://github.com/apache/cxf-fediz/commit/3f8504b95cddb0325948ab4be20cb42a35fd9c26", "message": "Fixing NPE", "bug_id": "cxf-fediz_13", "file": [{"additions": 6, "raw_url": "https://github.com/apache/cxf-fediz/raw/e17038b5330bc4db66214bf59e5315d7efdeebde/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/e17038b5330bc4db66214bf59e5315d7efdeebde/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java", "sha": "5212793035db46aed3d3588676e000c8030b4f44", "changes": 10, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java?ref=e17038b5330bc4db66214bf59e5315d7efdeebde", "patch": "@@ -182,9 +182,10 @@ public KeyManager getSigningKey() {\n             crypto = CryptoFactory.getInstance(sigProperties);\n             keyManager.setCrypto(crypto);\n         } catch (WSSecurityException e) {\n+            String name = keyManager.getName();\n             keyManager = null;\n-            LOG.error(\"Failed to load keystore '\" + keyManager.getName() + \"'\", e);\n-            throw new IllegalConfigurationException(\"Failed to load keystore '\" + keyManager.getName() + \"'\");\n+            LOG.error(\"Failed to load keystore '\" + name + \"'\", e);\n+            throw new IllegalConfigurationException(\"Failed to load keystore '\" + name + \"'\");\n         }\n         \n         return keyManager; \n@@ -202,9 +203,10 @@ public KeyManager getDecryptionKey() {\n             crypto = CryptoFactory.getInstance(decProperties);\n             decryptionKeyManager.setCrypto(crypto);\n         } catch (WSSecurityException e) {\n+            String name = decryptionKeyManager.getName();\n             decryptionKeyManager = null;\n-            LOG.error(\"Failed to load keystore '\" + decryptionKeyManager.getName() + \"'\", e);\n-            throw new IllegalConfigurationException(\"Failed to load keystore '\" + decryptionKeyManager.getName() + \"'\");\n+            LOG.error(\"Failed to load keystore '\" + name + \"'\", e);\n+            throw new IllegalConfigurationException(\"Failed to load keystore '\" + name + \"'\");\n         }\n         \n         return decryptionKeyManager; ", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/config/FedizContext.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/2d01528cb4b37edc46bb4366b965e56b5def49da", "parent": "https://github.com/apache/cxf-fediz/commit/cdfe522f2c21fc2df6f0a3ae4313af8d3df9128f", "message": "Avoiding some potential NPEs", "bug_id": "cxf-fediz_14", "file": [{"additions": 9, "raw_url": "https://github.com/apache/cxf-fediz/raw/2d01528cb4b37edc46bb4366b965e56b5def49da/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/STSAuthenticationProvider.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/2d01528cb4b37edc46bb4366b965e56b5def49da/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/STSAuthenticationProvider.java", "sha": "bf96affa6176957fa27c2c9e5b6f25de8005d819", "changes": 12, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/idp/src/main/java/org/apache/cxf/fediz/service/idp/STSAuthenticationProvider.java?ref=2d01528cb4b37edc46bb4366b965e56b5def49da", "patch": "@@ -150,12 +150,18 @@ public Authentication authenticate(Authentication authentication) throws Authent\n                 return null;\n             }\n             \n-            sts.getProperties().put(SecurityConstants.KERBEROS_JAAS_CONTEXT_NAME, \n+            if (kerberosTokenValidator.getContextName() != null) {\n+                sts.getProperties().put(SecurityConstants.KERBEROS_JAAS_CONTEXT_NAME, \n                                     kerberosTokenValidator.getContextName());\n-            sts.getProperties().put(SecurityConstants.KERBEROS_SPN,\n+            }\n+            if (kerberosTokenValidator.getServiceName() != null) {\n+                sts.getProperties().put(SecurityConstants.KERBEROS_SPN,\n                                     kerberosTokenValidator.getServiceName());\n-            sts.getProperties().put(SecurityConstants.CALLBACK_HANDLER, \n+            }\n+            if (kerberosCallbackHandler != null) {\n+                sts.getProperties().put(SecurityConstants.CALLBACK_HANDLER, \n                                     kerberosCallbackHandler);\n+            }\n             if (kerberosUsernameServiceNameForm) {\n                 sts.getProperties().put(SecurityConstants.KERBEROS_IS_USERNAME_IN_SERVICENAME_FORM, \n                                         \"true\");", "filename": "services/idp/src/main/java/org/apache/cxf/fediz/service/idp/STSAuthenticationProvider.java"}, {"additions": 34, "raw_url": "https://github.com/apache/cxf-fediz/raw/2d01528cb4b37edc46bb4366b965e56b5def49da/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/2d01528cb4b37edc46bb4366b965e56b5def49da/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java", "sha": "cbd2d2b0fda3820d2adfd8ef6fab44de9f067912", "changes": 37, "status": "modified", "deletions": 3, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java?ref=2d01528cb4b37edc46bb4366b965e56b5def49da", "patch": "@@ -222,7 +222,7 @@ public String getServletContextName() {\n     public void testKerberos() throws Exception {\n         String url = \"https://localhost:\" + getRpHttpsPort() + \"/fedizhelloworld/secure/fedservlet\";\n         // Get a Kerberos Ticket +  Base64 encode it\n-        String ticket = getEncodedKerberosTicket();\n+        String ticket = getEncodedKerberosTicket(false);\n         \n         String response = sendHttpGet(url, ticket, 200, 200, Integer.parseInt(getIdpHttpsPort()));\n \n@@ -244,12 +244,43 @@ public void testKerberos() throws Exception {\n     \n     }\n     \n-    private String getEncodedKerberosTicket() throws Exception {\n+    @org.junit.Test\n+    public void testSpnego() throws Exception {\n+        String url = \"https://localhost:\" + getRpHttpsPort() + \"/fedizhelloworld/secure/fedservlet\";\n+        // Get a Kerberos Ticket +  Base64 encode it\n+        String ticket = getEncodedKerberosTicket(true);\n+        \n+        String response = sendHttpGet(url, ticket, 200, 200, Integer.parseInt(getIdpHttpsPort()));\n+\n+        String user = \"alice\";\n+        Assert.assertTrue(\"Principal not \" + user, response.indexOf(\"userPrincipal=\" + user) > 0);\n+        Assert.assertTrue(\"User \" + user + \" does not have role Admin\", response.indexOf(\"role:Admin=false\") > 0);\n+        Assert.assertTrue(\"User \" + user + \" does not have role Manager\", response.indexOf(\"role:Manager=false\") > 0);\n+        Assert.assertTrue(\"User \" + user + \" must have role User\", response.indexOf(\"role:User=true\") > 0);\n+\n+        String claim = ClaimTypes.FIRSTNAME.toString();\n+        Assert.assertTrue(\"User \" + user + \" claim \" + claim + \" is not 'Alice'\",\n+                          response.indexOf(claim + \"=Alice\") > 0);\n+        claim = ClaimTypes.LASTNAME.toString();\n+        Assert.assertTrue(\"User \" + user + \" claim \" + claim + \" is not 'Smith'\",\n+                          response.indexOf(claim + \"=Smith\") > 0);\n+        claim = ClaimTypes.EMAILADDRESS.toString();\n+        Assert.assertTrue(\"User \" + user + \" claim \" + claim + \" is not 'alice@realma.org'\",\n+                          response.indexOf(claim + \"=alice@realma.org\") > 0);\n+    \n+    }\n+    \n+    private String getEncodedKerberosTicket(boolean spnego) throws Exception {\n         \n         System.setProperty(\"java.security.auth.login.config\", \"src/test/resources/kerberos.jaas\");\n         System.setProperty(\"org.apache.xml.security.ignoreLineBreaks\", \"true\");\n         \n-        Oid kerberos5Oid = new Oid(\"1.2.840.113554.1.2.2\");\n+        Oid kerberos5Oid = null;\n+        if (spnego) {\n+            kerberos5Oid = new Oid(\"1.3.6.1.5.5.2\");\n+        } else {\n+            kerberos5Oid = new Oid(\"1.2.840.113554.1.2.2\");\n+        }\n         \n         GSSManager manager = GSSManager.getInstance();\n         GSSName serverName = manager.createName(\"bob@service.ws.apache.org\", ", "filename": "systests/tomcat7/src/test/java/org/apache/cxf/fediz/integrationtests/KerberosTest.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/d01083531828754185749035b9e7d9b21a90afda", "parent": "https://github.com/apache/cxf-fediz/commit/85f7dda77873d5201d26f613725a1a07fa7aa3d5", "message": "Avoid NPE if no claims", "bug_id": "cxf-fediz_15", "file": [{"additions": 4, "raw_url": "https://github.com/apache/cxf-fediz/raw/d01083531828754185749035b9e7d9b21a90afda/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/Protocol.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/d01083531828754185749035b9e7d9b21a90afda/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/Protocol.java", "sha": "690089103924c70c34f6a28c1c753a5a04a8bf87", "changes": 6, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/config/Protocol.java?ref=d01083531828754185749035b9e7d9b21a90afda", "patch": "@@ -189,8 +189,10 @@ protected Object loadCallbackType(CallbackType cbt, String name) {\n     public List<Claim> getClaimTypesRequested() {\n         ClaimTypesRequested claimsRequested = getProtocolType().getClaimTypesRequested();\n         List<Claim> claims = new ArrayList<Claim>();\n-        for (ClaimType c : claimsRequested.getClaimType()) {\n-            claims.add(new Claim(c));\n+        if (claimsRequested != null) {\n+            for (ClaimType c : claimsRequested.getClaimType()) {\n+                claims.add(new Claim(c));\n+            }\n         }\n         return claims;\n     }", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/config/Protocol.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/3b55e0720ebbc9c9d8efbe4e3475868db94c8b7f", "parent": "https://github.com/apache/cxf-fediz/commit/0c1fd5321842aa806ae37104e2219d45b372f8d6", "message": "Preventing possible NPE\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/cxf/fediz/trunk@1470436 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "cxf-fediz_16", "file": [{"additions": 1, "raw_url": "https://github.com/apache/cxf-fediz/raw/3b55e0720ebbc9c9d8efbe4e3475868db94c8b7f/services/sts/src/main/java/org/apache/cxf/fediz/service/sts/FileClaimsHandler.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/3b55e0720ebbc9c9d8efbe4e3475868db94c8b7f/services/sts/src/main/java/org/apache/cxf/fediz/service/sts/FileClaimsHandler.java", "sha": "6aaf65cedf2c4f3f3ffbdc45ec82dc8db05bba15", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/services/sts/src/main/java/org/apache/cxf/fediz/service/sts/FileClaimsHandler.java?ref=3b55e0720ebbc9c9d8efbe4e3475868db94c8b7f", "patch": "@@ -63,7 +63,7 @@ public void setSupportedClaims(List<URI> supportedClaims) {\n     public ClaimCollection retrieveClaimValues(RequestClaimCollection claims,\n             ClaimsParameters parameters) {\n \n-        if (getUserClaims() == null) {\n+        if (getUserClaims() == null || parameters.getPrincipal() == null) {\n             return new ClaimCollection();\n         }\n ", "filename": "services/sts/src/main/java/org/apache/cxf/fediz/service/sts/FileClaimsHandler.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/82a2699a344f77ac605f8cab3465a11399f2aa3c", "parent": "https://github.com/apache/cxf-fediz/commit/5b6f607bf5013607dd7f6033b5f402c762585047", "message": "Fix NPE if user has no roles\n\ngit-svn-id: https://svn.apache.org/repos/asf/cxf/fediz/trunk@1454491 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "cxf-fediz_17", "file": [{"additions": 18, "raw_url": "https://github.com/apache/cxf-fediz/raw/82a2699a344f77ac605f8cab3465a11399f2aa3c/plugins/spring/src/main/java/org/apache/cxf/fediz/spring/authentication/GrantedAuthoritiesUserDetailsFederationService.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/82a2699a344f77ac605f8cab3465a11399f2aa3c/plugins/spring/src/main/java/org/apache/cxf/fediz/spring/authentication/GrantedAuthoritiesUserDetailsFederationService.java", "sha": "9d52c01fe25b6f7f91e484eb85596a73d99051a4", "changes": 20, "status": "modified", "deletions": 2, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/spring/src/main/java/org/apache/cxf/fediz/spring/authentication/GrantedAuthoritiesUserDetailsFederationService.java?ref=82a2699a344f77ac605f8cab3465a11399f2aa3c", "patch": "@@ -34,16 +34,32 @@\n public class GrantedAuthoritiesUserDetailsFederationService\n         extends AbstractFederationUserDetailsService {\n \n+    private boolean convertToUpperCase = true;\n+    \n     @Override\n     protected UserDetails loadUserDetails(FederationResponse response) {\n         \n         final List<GrantedAuthority> grantedAuthorities = new ArrayList<GrantedAuthority>();\n         \n-        for (final String role : response.getRoles()) {\n-            grantedAuthorities.add(new SimpleGrantedAuthority(\"ROLE_\" + role.toUpperCase()));\n+        if (response.getRoles() != null) {\n+            for (final String role : response.getRoles()) {\n+                \n+                grantedAuthorities.add(new SimpleGrantedAuthority(\"ROLE_\"\n+                                        + (this.convertToUpperCase ? role.toUpperCase() : role)));\n+            }\n         }\n         return new FederationUser(response.getUsername(), \"N/A\",\n                         grantedAuthorities, new ClaimCollection(response.getClaims()));\n         \n     }\n+    \n+    \n+    /**\n+     * Converts the role value to uppercase value.\n+     *\n+     * @param convertToUpperCase true if it should convert, false otherwise.\n+     */\n+    public void setConvertToUpperCase(final boolean convertToUpperCase) {\n+        this.convertToUpperCase = convertToUpperCase;\n+    }\n }", "filename": "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/authentication/GrantedAuthoritiesUserDetailsFederationService.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/14812049396f321702e920863d1f6a48cd18e081", "parent": "https://github.com/apache/cxf-fediz/commit/f225fdccbd2f73c46afc2d45716b4654babc2efa", "message": "NPE fixed when roleURI not configured\n\ngit-svn-id: https://svn.apache.org/repos/asf/cxf/fediz/trunk@1347143 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "cxf-fediz_18", "file": [{"additions": 1, "raw_url": "https://github.com/apache/cxf-fediz/raw/14812049396f321702e920863d1f6a48cd18e081/examples/wsclientWebapp/README.txt", "blob_url": "https://github.com/apache/cxf-fediz/blob/14812049396f321702e920863d1f6a48cd18e081/examples/wsclientWebapp/README.txt", "sha": "a3f5e73bf296f1485e033c7bc72d3bd5fb6ce829", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/examples/wsclientWebapp/README.txt?ref=14812049396f321702e920863d1f6a48cd18e081", "patch": "@@ -55,7 +55,7 @@ Demo Web Service\n The main and only code lives in the class GreeterImpl. It reads the authenticated principal from the JAX-WS WebServiceContext\n and returns the principal name to the Web Service Client (Web Application).\n \n-The interesting pieces are in beans.xml and the WS-SecurityPolicy definition in the WSDL hello_world.wsdl.\n+The interesting pieces are in applicationContext.xml and the WS-SecurityPolicy definition in the WSDL hello_world.wsdl.\n \n There is no security related programming required. CXF processes the information in the Spring configuration and\n the policy document and enforces that.", "filename": "examples/wsclientWebapp/README.txt"}, {"additions": 4, "raw_url": "https://github.com/apache/cxf-fediz/raw/14812049396f321702e920863d1f6a48cd18e081/plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/14812049396f321702e920863d1f6a48cd18e081/plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java", "sha": "9cc4b5f59140a5ed268efe36bf21d3ea33044d16", "changes": 8, "status": "modified", "deletions": 4, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java?ref=14812049396f321702e920863d1f6a48cd18e081", "patch": "@@ -178,9 +178,9 @@ public TokenValidatorResponse validateAndProcessToken(Element token,\n \n             List<String> roles = null;\n             FederationProtocol fp = (FederationProtocol)config.getProtocol();\n-            URI roleURI = URI.create(fp.getRoleURI());\n-            String delim = fp.getRoleDelimiter();\n-            if (roleURI != null) {\n+            if (fp.getRoleURI() != null) {\n+                URI roleURI = URI.create(fp.getRoleURI());\n+                String delim = fp.getRoleDelimiter();\n                 for (Claim c : claims) {\n                     URI claimURI = URI.create(c.getNamespace() + \"/\"\n                             + c.getClaimType());\n@@ -204,7 +204,7 @@ public TokenValidatorResponse validateAndProcessToken(Element token,\n                     }\n                 }\n             }\n-\n+            \n             SAMLTokenPrincipal p = new SAMLTokenPrincipal(assertion);\n \n             TokenValidatorResponse response = new TokenValidatorResponse(", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java"}, {"additions": 15, "raw_url": "https://github.com/apache/cxf-fediz/raw/14812049396f321702e920863d1f6a48cd18e081/plugins/core/src/test/java/org/apache/cxf/fediz/core/AbstractSAMLCallbackHandler.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/14812049396f321702e920863d1f6a48cd18e081/plugins/core/src/test/java/org/apache/cxf/fediz/core/AbstractSAMLCallbackHandler.java", "sha": "42c839a306d505ab5fc25db87d7d7c86b4bb43a0", "changes": 16, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/test/java/org/apache/cxf/fediz/core/AbstractSAMLCallbackHandler.java?ref=14812049396f321702e920863d1f6a48cd18e081", "patch": "@@ -170,6 +170,21 @@ protected void createAndSetStatement(SubjectBean subjectBean, SAMLCallback callb\n         } else if (statement == Statement.ATTR) {\n             AttributeStatementBean attrStateBean = new AttributeStatementBean();\n             \n+            if (this.roles == null) {\n+                AttributeBean attributeBean = new AttributeBean();\n+                if (subjectBean != null) {\n+                    attrStateBean.setSubject(subjectBean);\n+                    attributeBean.setSimpleName(\"name\");\n+                    attributeBean.setQualifiedName(\"dummy-ns\");\n+                } else {\n+                    attributeBean.setQualifiedName(\"dummy-ns\");\n+                }\n+                attributeBean.setAttributeValues(Collections.singletonList(\"myvalue\"));\n+                attrStateBean.setSamlAttributes(Collections.singletonList(attributeBean));\n+                callback.setAttributeStatementData(Collections.singletonList(attrStateBean));\n+                return;\n+            }\n+            \n             if (this.multiValueType.equals(MultiValue.MULTI_VALUE)\n                 || this.multiValueType.equals(MultiValue.ENC_VALUE)) {\n //              <saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:1.0:assertion\"\n@@ -226,7 +241,6 @@ protected void createAndSetStatement(SubjectBean subjectBean, SAMLCallback callb\n                 }\n                 attrStateBean.setSamlAttributes(attrBeans);\n             }\n-            \n             callback.setAttributeStatementData(Collections.singletonList(attrStateBean));\n                        \n         } else {", "filename": "plugins/core/src/test/java/org/apache/cxf/fediz/core/AbstractSAMLCallbackHandler.java"}, {"additions": 75, "raw_url": "https://github.com/apache/cxf-fediz/raw/14812049396f321702e920863d1f6a48cd18e081/plugins/core/src/test/java/org/apache/cxf/fediz/core/FederationProcessorTest.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/14812049396f321702e920863d1f6a48cd18e081/plugins/core/src/test/java/org/apache/cxf/fediz/core/FederationProcessorTest.java", "sha": "49f9ff727576c07d884ec608c0280ad8a7d2bea3", "changes": 75, "status": "modified", "deletions": 0, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/test/java/org/apache/cxf/fediz/core/FederationProcessorTest.java?ref=14812049396f321702e920863d1f6a48cd18e081", "patch": "@@ -180,6 +180,81 @@ public void validateSignInInvalidWResult() throws Exception {\n         }\n     }\n     \n+    /**\n+     * Validate SAML 2 token which doesn't include the role SAML attribute\n+     */\n+    @org.junit.Test\n+    public void validateSAML2TokenWithoutRoles() throws Exception {\n+        SAML2CallbackHandler callbackHandler = new SAML2CallbackHandler();\n+        callbackHandler.setStatement(SAML2CallbackHandler.Statement.ATTR);\n+        callbackHandler.setConfirmationMethod(SAML2Constants.CONF_BEARER);\n+        callbackHandler.setIssuer(TEST_RSTR_ISSUER);\n+        callbackHandler.setSubjectName(TEST_USER);\n+        callbackHandler.setRoles(null);\n+        ConditionsBean cp = new ConditionsBean();\n+        cp.setAudienceURI(TEST_AUDIENCE);\n+        callbackHandler.setConditions(cp);\n+        \n+        SAMLParms samlParms = new SAMLParms();\n+        samlParms.setCallbackHandler(callbackHandler);\n+        AssertionWrapper assertion = new AssertionWrapper(samlParms);\n+        String rstr = createSamlToken(assertion, \"mystskey\", true);\n+        \n+        FederationRequest wfReq = new FederationRequest();\n+        wfReq.setWa(FederationConstants.ACTION_SIGNIN);\n+        wfReq.setWresult(rstr);\n+        \n+        configurator = null;\n+        FederationContext config = getFederationConfigurator().getFederationContext(\"ROOT\");\n+        \n+        FederationProcessor wfProc = new FederationProcessorImpl();\n+        FederationResponse wfRes = wfProc.processRequest(wfReq, config);\n+        \n+        Assert.assertEquals(\"Principal name wrong\", TEST_USER,\n+                            wfRes.getUsername());\n+        Assert.assertEquals(\"Issuer wrong\", TEST_RSTR_ISSUER, wfRes.getIssuer());\n+        Assert.assertEquals(\"No roles must be found\", null, wfRes.getRoles());\n+        Assert.assertEquals(\"Audience wrong\", TEST_AUDIENCE, wfRes.getAudience());\n+    }\n+    \n+    /**\n+     * Validate SAML 2 token which includes role attribute\n+     * but RoleURI is not configured\n+     */\n+    @org.junit.Test\n+    public void validateSAML2TokenRoleURINotConfigured() throws Exception {\n+        SAML2CallbackHandler callbackHandler = new SAML2CallbackHandler();\n+        callbackHandler.setStatement(SAML2CallbackHandler.Statement.ATTR);\n+        callbackHandler.setConfirmationMethod(SAML2Constants.CONF_BEARER);\n+        callbackHandler.setIssuer(TEST_RSTR_ISSUER);\n+        callbackHandler.setSubjectName(TEST_USER);\n+        ConditionsBean cp = new ConditionsBean();\n+        cp.setAudienceURI(TEST_AUDIENCE);\n+        callbackHandler.setConditions(cp);\n+        \n+        SAMLParms samlParms = new SAMLParms();\n+        samlParms.setCallbackHandler(callbackHandler);\n+        AssertionWrapper assertion = new AssertionWrapper(samlParms);\n+        String rstr = createSamlToken(assertion, \"mystskey\", true);\n+        \n+        FederationRequest wfReq = new FederationRequest();\n+        wfReq.setWa(FederationConstants.ACTION_SIGNIN);\n+        wfReq.setWresult(rstr);\n+        \n+        configurator = null;\n+        FederationContext config = getFederationConfigurator().getFederationContext(\"ROOT\");\n+        ((FederationProtocol)config.getProtocol()).setRoleURI(null);\n+        \n+        FederationProcessor wfProc = new FederationProcessorImpl();\n+        FederationResponse wfRes = wfProc.processRequest(wfReq, config);\n+        \n+        Assert.assertEquals(\"Principal name wrong\", TEST_USER,\n+                            wfRes.getUsername());\n+        Assert.assertEquals(\"Issuer wrong\", TEST_RSTR_ISSUER, wfRes.getIssuer());\n+        Assert.assertEquals(\"Two roles must be found\", null, wfRes.getRoles());\n+        Assert.assertEquals(\"Audience wrong\", TEST_AUDIENCE, wfRes.getAudience());\n+    }\n+    \n     /**\n      * Validate SAML 2 token which includes the role attribute with 2 values\n      * Roles are encoded as a multi-value saml attribute", "filename": "plugins/core/src/test/java/org/apache/cxf/fediz/core/FederationProcessorTest.java"}], "repo": "cxf-fediz"}, {"commit": "https://github.com/apache/cxf-fediz/commit/532bf0ccdb50d81043c407c2eb195858a5798d1f", "parent": "https://github.com/apache/cxf-fediz/commit/ab27f94a02b57a5b756e663c4c950cdb18d66e4b", "message": "[FEDIZ-26] - SAMLTokenValidator throws a NPE when an Attribute of the Assertion does not have a NameFormat. \n\n\ngit-svn-id: https://svn.apache.org/repos/asf/cxf/fediz/trunk@1388043 13f79535-47bb-0310-9956-ffa450edef68", "bug_id": "cxf-fediz_19", "file": [{"additions": 1, "raw_url": "https://github.com/apache/cxf-fediz/raw/532bf0ccdb50d81043c407c2eb195858a5798d1f/plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java", "blob_url": "https://github.com/apache/cxf-fediz/blob/532bf0ccdb50d81043c407c2eb195858a5798d1f/plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java", "sha": "212edbb4f481071b5ee38198b6c0e1d6d734c91b", "changes": 2, "status": "modified", "deletions": 1, "contents_url": "https://api.github.com/repos/apache/cxf-fediz/contents/plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java?ref=532bf0ccdb50d81043c407c2eb195858a5798d1f", "patch": "@@ -320,7 +320,7 @@ public TokenValidatorResponse validateAndProcessToken(Element token,\n                 // if NameFormat is http://schemas.xmlsoap.org/ws/2005/05/identity/claims\n                 // but ClaimType value must be fully qualified as Namespace attribute goes away\n                 URI attrName = URI.create(attribute.getName());\n-                if (attribute.getNameFormat().equals(ClaimTypes.URI_BASE.toString()) \n+                if (ClaimTypes.URI_BASE.toString().equals(attribute.getNameFormat())\n                     && !attrName.isAbsolute()) {\n                     c.setClaimType(URI.create(ClaimTypes.URI_BASE + \"/\" + attribute.getName()));\n                 } else {", "filename": "plugins/core/src/main/java/org/apache/cxf/fediz/core/saml/SAMLTokenValidator.java"}], "repo": "cxf-fediz"}]
