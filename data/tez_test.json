{
    "tez_0ac846e": {
        "bug_id": "tez_0ac846e",
        "commit": "https://github.com/apache/tez/commit/0ac846ec5a41dd9f7839774eb9af4c8036e64a5b",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/0ac846ec5a41dd9f7839774eb9af4c8036e64a5b/TEZ-3334-CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/TEZ-3334-CHANGES.txt?ref=0ac846ec5a41dd9f7839774eb9af4c8036e64a5b",
                "deletions": 0,
                "filename": "TEZ-3334-CHANGES.txt",
                "patch": "@@ -4,6 +4,7 @@ Apache Tez Change Log\n INCOMPATIBLE CHANGES:\n \n ALL CHANGES:\n+  TEZ-3587. Fetcher fetchInputs() can NPE on srcAttempt due to missing entry in pathToAttemptMap\n   TEZ-3586. Remove fusesource.leveldbjni from the tez-auxservices shaded jar\n   TEZ-3532. Backport MAPREDUCE-6808. Log map attempts as part of shuffle handler audit log\n   TEZ-3563. Tez Shuffle Handler logging fails to initialize",
                "raw_url": "https://github.com/apache/tez/raw/0ac846ec5a41dd9f7839774eb9af4c8036e64a5b/TEZ-3334-CHANGES.txt",
                "sha": "d7c9e300c384a0e41bb3fbaae0fcb33f1e9f77aa",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/0ac846ec5a41dd9f7839774eb9af4c8036e64a5b/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java?ref=0ac846ec5a41dd9f7839774eb9af4c8036e64a5b",
                "deletions": 1,
                "filename": "tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java",
                "patch": "@@ -258,7 +258,7 @@ public FetchResult callInternal() throws Exception {\n       if (in instanceof CompositeInputAttemptIdentifier) {\n         CompositeInputAttemptIdentifier cin = (CompositeInputAttemptIdentifier)in;\n         for (int i = 0; i < cin.getInputIdentifierCount(); i++) {\n-          pathToAttemptMap.put(new PathPartition(cin.getPathComponent(), i), cin.expand(i));\n+          pathToAttemptMap.put(new PathPartition(cin.getPathComponent(), partition + i), cin.expand(i));\n         }\n       } else {\n         pathToAttemptMap.put(new PathPartition(in.getPathComponent(), 0), in);",
                "raw_url": "https://github.com/apache/tez/raw/0ac846ec5a41dd9f7839774eb9af4c8036e64a5b/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java",
                "sha": "7b5ca17115705c9561c5f8592b229d57319bd0bb",
                "status": "modified"
            }
        ],
        "message": "TEZ-3587. Fetcher fetchInputs() can NPE on srcAttempt due to missing entry in pathToAttemptMap (Kuhu Shukla via jeagles)",
        "parent": "https://github.com/apache/tez/commit/4e44712448361e2e62262d4c297c67995ff2c520",
        "patched_files": [
            "Fetcher.java",
            "TEZ-3334-CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestFetcher.java"
        ]
    },
    "tez_1795ea8": {
        "bug_id": "tez_1795ea8",
        "commit": "https://github.com/apache/tez/commit/1795ea84fc899f5e522680119b1853f559030a14",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/tez/blob/1795ea84fc899f5e522680119b1853f559030a14/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java?ref=1795ea84fc899f5e522680119b1853f559030a14",
                "deletions": 3,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "patch": "@@ -250,9 +250,6 @@\n               EnumSet.of(VertexState.TERMINATING, VertexState.KILLED, VertexState.FAILED),\n               VertexEventType.V_TASK_COMPLETED,\n               new TaskCompletedTransition())\n-          .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n-              VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n-              TASK_ATTEMPT_COMPLETED_EVENT_TRANSITION) // TODO shouldnt be done for KILL_WAIT vertex\n           .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n               VertexEventType.V_SOURCE_TASK_ATTEMPT_COMPLETED,\n               SOURCE_TASK_ATTEMPT_COMPLETED_EVENT_TRANSITION)\n@@ -263,6 +260,7 @@\n           // Ignore-able events\n           .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n               EnumSet.of(VertexEventType.V_TERMINATE,\n+                  VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n                   VertexEventType.V_TASK_RESCHEDULED))\n \n           // Transitions from SUCCEEDED state\n@@ -301,6 +299,7 @@\n           // Ignore-able events\n           .addTransition(VertexState.KILLED, VertexState.KILLED,\n               EnumSet.of(VertexEventType.V_TERMINATE,\n+                  VertexEventType.V_SOURCE_VERTEX_STARTED,\n                   VertexEventType.V_START,\n                   VertexEventType.V_TASK_RESCHEDULED,\n                   VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n@@ -311,6 +310,8 @@\n               VertexState.ERROR,\n               VertexState.ERROR,\n               EnumSet.of(VertexEventType.V_INIT,\n+                  VertexEventType.V_SOURCE_VERTEX_STARTED,\n+                  VertexEventType.V_START,\n                   VertexEventType.V_TERMINATE,\n                   VertexEventType.V_TASK_COMPLETED,\n                   VertexEventType.V_TASK_ATTEMPT_COMPLETED,",
                "raw_url": "https://github.com/apache/tez/raw/1795ea84fc899f5e522680119b1853f559030a14/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "sha": "597acb2aa2545374a181e0df604e9aad1bea06bd",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/tez/blob/1795ea84fc899f5e522680119b1853f559030a14/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java?ref=1795ea84fc899f5e522680119b1853f559030a14",
                "deletions": 6,
                "filename": "tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "patch": "@@ -98,13 +98,14 @@ public void run(Map<String, LogicalInput> inputs,\n     OnFileUnorderedKVOutput kvOutput = (OnFileUnorderedKVOutput) lo;\n \n     Configuration updatedConf = mrInput.getConfigUpdates();\n-    String fileName = updatedConf.get(MRJobConfig.MAP_INPUT_FILE);\n-    LOG.info(\"Processing file: \" + fileName);\n     Text srcFile = new Text();\n-    if (fileName == null) {\n-      srcFile.set(\"UNKNOWN_FILENAME_IN_PROCESSOR\");\n-    } else {\n-      srcFile.set(fileName);\n+    srcFile.set(\"UNKNOWN_FILENAME_IN_PROCESSOR\");\n+    if (updatedConf != null) {\n+      String fileName = updatedConf.get(MRJobConfig.MAP_INPUT_FILE);\n+      if (fileName != null) {\n+        LOG.info(\"Processing file: \" + fileName);\n+        srcFile.set(fileName);\n+      }\n     }\n \n     KVReader kvReader = mrInput.getReader();",
                "raw_url": "https://github.com/apache/tez/raw/1795ea84fc899f5e522680119b1853f559030a14/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "sha": "6c97430a889c5aab5beb9570b2b8fc6e833348ea",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/1795ea84fc899f5e522680119b1853f559030a14/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java?ref=1795ea84fc899f5e522680119b1853f559030a14",
                "deletions": 1,
                "filename": "tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "patch": "@@ -209,7 +209,7 @@ public void setNumPhysicalInputs(int numInputs) {\n    * @return the additional fields set by {@link MRInput}\n    */\n   public Configuration getConfigUpdates() {\n-    return new Configuration(incrementalConf);\n+    return incrementalConf;\n   }\n \n   public float getProgress() throws IOException, InterruptedException {",
                "raw_url": "https://github.com/apache/tez/raw/1795ea84fc899f5e522680119b1853f559030a14/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "sha": "f0aea339ed7f7fe629d2adc4a6c9e08d72d94969",
                "status": "modified"
            }
        ],
        "message": "TEZ-510. Test MRRJobs failing with NPE (bikas)",
        "parent": "https://github.com/apache/tez/commit/38350663c4f367efb46f7cb488cd85607d1dfc24",
        "patched_files": [
            "VertexImpl.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestVertexImpl.java"
        ]
    },
    "tez_1fc98d3": {
        "bug_id": "tez_1fc98d3",
        "commit": "https://github.com/apache/tez/commit/1fc98d3335c09169e258851e4fff014819c00c31",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/1fc98d3335c09169e258851e4fff014819c00c31/CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=1fc98d3335c09169e258851e4fff014819c00c31",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -30,6 +30,7 @@ ALL CHANGES:\n   TEZ-1479. Disambiguate (refactor) between ShuffleInputEventHandlers and Fetchers.\n   TEZ-1665. DAGScheduler should provide a priority range instead of an exact\n   priority\n+  TEZ-1632. NPE at TestPreemption.testPreemptionWithoutSession\n \n Release 0.5.1: 2014-10-02\n ",
                "raw_url": "https://github.com/apache/tez/raw/1fc98d3335c09169e258851e4fff014819c00c31/CHANGES.txt",
                "sha": "9ffc776de5c704e6c9d1a33740b57d62331888b4",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/tez/blob/1fc98d3335c09169e258851e4fff014819c00c31/tez-dag/src/test/java/org/apache/tez/dag/app/TestPreemption.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/TestPreemption.java?ref=1fc98d3335c09169e258851e4fff014819c00c31",
                "deletions": 1,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/TestPreemption.java",
                "patch": "@@ -99,7 +99,11 @@ public void testPreemptionWithoutSession() throws Exception {\n     // now the MockApp has been started. sync with it to get the launcher\n     syncWithMockAppLauncher(false, mockAppLauncherGoFlag, tezClient);\n \n-    DAGImpl dagImpl = (DAGImpl) mockApp.getContext().getCurrentDAG();\n+    DAGImpl dagImpl;\n+    do {\n+      Thread.sleep(100); // usually needs to sleep 2-3 times\n+    } while ((dagImpl = (DAGImpl) mockApp.getContext().getCurrentDAG()) == null);\n+\n     int vertexIndex = 0;\n     int upToTaskVersion = 3;\n     TezVertexID vertexId = TezVertexID.getInstance(dagImpl.getID(), vertexIndex);",
                "raw_url": "https://github.com/apache/tez/raw/1fc98d3335c09169e258851e4fff014819c00c31/tez-dag/src/test/java/org/apache/tez/dag/app/TestPreemption.java",
                "sha": "0958c48171dc64a37accf82b106b6e4ed8105a7b",
                "status": "modified"
            }
        ],
        "message": "TEZ-1632. NPE at TestPreemption.testPreemptionWithoutSession (Alexander Pivovarov via bikas)",
        "parent": "https://github.com/apache/tez/commit/71231c892deb40d4c7a0c9f948ea8d40ceb0ec6e",
        "patched_files": [
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestPreemption.java"
        ]
    },
    "tez_280a98e": {
        "bug_id": "tez_280a98e",
        "commit": "https://github.com/apache/tez/commit/280a98ed431aeb15890de1cca5397f63f0455905",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/tez/blob/280a98ed431aeb15890de1cca5397f63f0455905/CHANGES.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=280a98ed431aeb15890de1cca5397f63f0455905",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -7,6 +7,7 @@ INCOMPATIBLE CHANGES\n \n ALL CHANGES:\n \n+  TEZ-3348. NullPointerException in Tez MROutput while trying to write using Parquet's DeprecatedParquetOutputFormat.\n   TEZ-3356. Fix initializing of stats when custom ShuffleVertexManager is used.\n   TEZ-3235. Modify Example TestOrderedWordCount job to test the IPC limit for large dag plans.\n   TEZ-3337. Do not log empty fields of TaskAttemptFinishedEvent to avoid confusion.\n@@ -83,6 +84,7 @@ INCOMPATIBLE CHANGES\n \n ALL CHANGES:\n \n+  TEZ-3348. NullPointerException in Tez MROutput while trying to write using Parquet's DeprecatedParquetOutputFormat.\n   TEZ-3356. Fix initializing of stats when custom ShuffleVertexManager is used.\n   TEZ-3329. Tez ATS data is incomplete for a vertex which fails or gets killed before initialization\n   TEZ-3235. Modify Example TestOrderedWordCount job to test the IPC limit for large dag plans.",
                "raw_url": "https://github.com/apache/tez/raw/280a98ed431aeb15890de1cca5397f63f0455905/CHANGES.txt",
                "sha": "c40051246ec2adb6ecfd569ad5013f3650247b42",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/tez/blob/280a98ed431aeb15890de1cca5397f63f0455905/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/output/MROutput.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/output/MROutput.java?ref=280a98ed431aeb15890de1cca5397f63f0455905",
                "deletions": 1,
                "filename": "tez-mapreduce/src/main/java/org/apache/tez/mapreduce/output/MROutput.java",
                "patch": "@@ -395,6 +395,8 @@ public MROutput(OutputContext outputContext, int numPhysicalOutputs) {\n         throw new IOException(cnfe);\n       }\n \n+      initCommitter(jobConf, useNewApi);\n+\n       try {\n         newRecordWriter =\n             newOutputFormat.getRecordWriter(newApiTaskAttemptContext);\n@@ -409,14 +411,15 @@ public MROutput(OutputContext outputContext, int numPhysicalOutputs) {\n       oldOutputFormat = jobConf.getOutputFormat();\n       outputFormatClassName = oldOutputFormat.getClass().getName();\n \n+      initCommitter(jobConf, useNewApi);\n+\n       FileSystem fs = FileSystem.get(jobConf);\n       String finalName = getOutputName();\n \n       oldRecordWriter =\n           oldOutputFormat.getRecordWriter(\n               fs, jobConf, finalName, new MRReporter(getContext().getCounters()));\n     }\n-    initCommitter(jobConf, useNewApi);\n \n     LOG.info(getContext().getDestinationVertexName() + \": \"\n         + \"outputFormat=\" + outputFormatClassName",
                "raw_url": "https://github.com/apache/tez/raw/280a98ed431aeb15890de1cca5397f63f0455905/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/output/MROutput.java",
                "sha": "043085d2514c50957b417e49ae54c5ff10f82483",
                "status": "modified"
            },
            {
                "additions": 97,
                "blob_url": "https://github.com/apache/tez/blob/280a98ed431aeb15890de1cca5397f63f0455905/tez-mapreduce/src/test/java/org/apache/tez/mapreduce/output/TestMROutput.java",
                "changes": 99,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce/src/test/java/org/apache/tez/mapreduce/output/TestMROutput.java?ref=280a98ed431aeb15890de1cca5397f63f0455905",
                "deletions": 2,
                "filename": "tez-mapreduce/src/test/java/org/apache/tez/mapreduce/output/TestMROutput.java",
                "patch": "@@ -34,14 +34,17 @@\n import org.apache.hadoop.io.NullWritable;\n import org.apache.hadoop.io.Text;\n import org.apache.hadoop.mapred.JobConf;\n+import org.apache.hadoop.mapred.Reporter;\n import org.apache.hadoop.mapreduce.JobContext;\n import org.apache.hadoop.mapreduce.OutputCommitter;\n import org.apache.hadoop.mapreduce.OutputFormat;\n import org.apache.hadoop.mapreduce.RecordWriter;\n import org.apache.hadoop.mapreduce.TaskAttemptContext;\n import org.apache.hadoop.mapreduce.lib.output.FileOutputCommitter;\n+import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;\n import org.apache.hadoop.mapreduce.lib.output.SequenceFileOutputFormat;\n import org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;\n+import org.apache.hadoop.util.Progressable;\n import org.apache.hadoop.yarn.api.records.ApplicationId;\n import org.apache.tez.common.counters.TezCounters;\n import org.apache.tez.dag.api.DataSinkDescriptor;\n@@ -166,6 +169,58 @@ public void testOldAPI_SequenceFileOutputFormat() throws Exception {\n     assertEquals(org.apache.hadoop.mapred.FileOutputCommitter.class, output.committer.getClass());\n   }\n \n+  // test to try and use the WorkOutputPathOutputFormat - this checks that the getDefaultWorkFile is\n+  // set while creating recordWriters\n+  @Test(timeout = 5000)\n+  public void testNewAPI_WorkOutputPathOutputFormat() throws Exception {\n+    String outputPath = \"/tmp/output\";\n+    Configuration conf = new Configuration();\n+    conf.setBoolean(MRConfig.IS_MAP_PROCESSOR, true);\n+    DataSinkDescriptor dataSink = MROutput\n+      .createConfigBuilder(conf, NewAPI_WorkOutputPathReadingOutputFormat.class, outputPath)\n+      .build();\n+\n+    OutputContext outputContext = createMockOutputContext(dataSink.getOutputDescriptor().getUserPayload());\n+    MROutput output = new MROutput(outputContext, 2);\n+    output.initialize();\n+\n+    assertEquals(true, output.isMapperOutput);\n+    assertEquals(true, output.useNewApi);\n+    assertEquals(NewAPI_WorkOutputPathReadingOutputFormat.class, output.newOutputFormat.getClass());\n+    assertNull(output.oldOutputFormat);\n+    assertNotNull(output.newApiTaskAttemptContext);\n+    assertNull(output.oldApiTaskAttemptContext);\n+    assertNotNull(output.newRecordWriter);\n+    assertNull(output.oldRecordWriter);\n+    assertEquals(FileOutputCommitter.class, output.committer.getClass());\n+  }\n+\n+  // test to try and use the WorkOutputPathOutputFormat - this checks that the workOutput path is\n+  // set while creating recordWriters\n+  @Test(timeout = 5000)\n+  public void testOldAPI_WorkOutputPathOutputFormat() throws Exception {\n+    String outputPath = \"/tmp/output\";\n+    Configuration conf = new Configuration();\n+    conf.setBoolean(MRConfig.IS_MAP_PROCESSOR, false);\n+    DataSinkDescriptor dataSink = MROutput\n+      .createConfigBuilder(conf, OldAPI_WorkOutputPathReadingOutputFormat.class, outputPath)\n+      .build();\n+\n+    OutputContext outputContext = createMockOutputContext(dataSink.getOutputDescriptor().getUserPayload());\n+    MROutput output = new MROutput(outputContext, 2);\n+    output.initialize();\n+\n+    assertEquals(false, output.isMapperOutput);\n+    assertEquals(false, output.useNewApi);\n+    assertEquals(OldAPI_WorkOutputPathReadingOutputFormat.class, output.oldOutputFormat.getClass());\n+    assertNull(output.newOutputFormat);\n+    assertNotNull(output.oldApiTaskAttemptContext);\n+    assertNull(output.newApiTaskAttemptContext);\n+    assertNotNull(output.oldRecordWriter);\n+    assertNull(output.newRecordWriter);\n+    assertEquals(org.apache.hadoop.mapred.FileOutputCommitter.class, output.committer.getClass());\n+  }\n+\n   private OutputContext createMockOutputContext(UserPayload payload) {\n     OutputContext outputContext = mock(OutputContext.class);\n     ApplicationId appId = ApplicationId.newInstance(System.currentTimeMillis(), 1);\n@@ -199,7 +254,7 @@ public static LogicalIOProcessorRuntimeTask createLogicalTask(\n         new Path(new Path(System.getProperty(\"test.build.data\", \"/tmp\")),\n                  \"TestMapOutput\").makeQualified(fs.getUri(), fs.getWorkingDirectory());\n \n-    LogicalIOProcessorRuntimeTask task = new LogicalIOProcessorRuntimeTask(\n+    return new LogicalIOProcessorRuntimeTask(\n         taskSpec,\n         0,\n         conf,\n@@ -209,7 +264,6 @@ public static LogicalIOProcessorRuntimeTask createLogicalTask(\n         new HashMap<String, String>(),\n         HashMultimap.<String, String>create(), null, \"\", new ExecutionContextImpl(\"localhost\"),\n         Runtime.getRuntime().maxMemory(), true, new DefaultHadoopShim());\n-    return task;\n   }\n   \n   public static class TestOutputCommitter extends OutputCommitter {\n@@ -282,6 +336,47 @@ public OutputCommitter getOutputCommitter(TaskAttemptContext context)\n     }\n   }\n \n+  // OldAPI OutputFormat class that reads the workoutput path while creating recordWriters\n+  public static class OldAPI_WorkOutputPathReadingOutputFormat extends org.apache.hadoop.mapred.FileOutputFormat<String, String> {\n+    public static class NoOpRecordWriter implements org.apache.hadoop.mapred.RecordWriter<String, String> {\n+      @Override\n+      public void write(String key, String value) throws IOException {}\n+\n+      @Override\n+      public void close(Reporter reporter) throws IOException {}\n+    }\n+\n+    @Override\n+    public org.apache.hadoop.mapred.RecordWriter<String, String> getRecordWriter(\n+      FileSystem ignored, JobConf job, String name, Progressable progress) throws IOException {\n+      // check work output path is not null\n+      Path workOutputPath = org.apache.hadoop.mapred.FileOutputFormat.getWorkOutputPath(job);\n+      assertNotNull(workOutputPath);\n+      return new NoOpRecordWriter();\n+    }\n+  }\n+\n+  // NewAPI OutputFormat class that reads the default work file while creating recordWriters\n+  public static class NewAPI_WorkOutputPathReadingOutputFormat extends FileOutputFormat<String, String> {\n+    public static class NoOpRecordWriter extends RecordWriter<String, String> {\n+      @Override\n+      public void write(String key, String value) throws IOException, InterruptedException {\n+      }\n+\n+      @Override\n+      public void close(TaskAttemptContext context) throws IOException, InterruptedException {\n+      }\n+    }\n+\n+    @Override\n+    public RecordWriter<String, String> getRecordWriter(TaskAttemptContext job) throws IOException, InterruptedException {\n+      // check default work file is not null\n+      Path workOutputPath = getDefaultWorkFile(job, \".foo\");\n+      assertNotNull(workOutputPath);\n+      return new NoOpRecordWriter();\n+    }\n+  }\n+\n   public static class TestProcessor extends SimpleProcessor {\n     public TestProcessor(ProcessorContext context) {\n       super(context);",
                "raw_url": "https://github.com/apache/tez/raw/280a98ed431aeb15890de1cca5397f63f0455905/tez-mapreduce/src/test/java/org/apache/tez/mapreduce/output/TestMROutput.java",
                "sha": "8b52cc99b2c7fa010b52b19d082bbd82ba712e4e",
                "status": "modified"
            }
        ],
        "message": "TEZ-3348. NullPointerException in Tez MROutput while trying to write using Parquet's DeprecatedParquetOutputFormat. (Piyush Narang via hitesh)",
        "parent": "https://github.com/apache/tez/commit/8bfbdfefa4bf9a87acd90eb4582fe6a621fb2389",
        "patched_files": [
            "MROutput.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestMROutput.java"
        ]
    },
    "tez_28fb652": {
        "bug_id": "tez_28fb652",
        "commit": "https://github.com/apache/tez/commit/28fb6522f4510cf62021c6dec55159d3b4de1b35",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/tez/blob/28fb6522f4510cf62021c6dec55159d3b4de1b35/CHANGES.txt",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=28fb6522f4510cf62021c6dec55159d3b4de1b35",
                "deletions": 2,
                "filename": "CHANGES.txt",
                "patch": "@@ -8,8 +8,8 @@ INCOMPATIBLE CHANGES\n   TEZ-2948. Stop using dagName in the dagComplete notification to TaskCommunicators.\n \n ALL CHANGES:\n-  TEZ-2945. TEZ-2740 addendum to update API with currently supported\n-  parameters\n+  TEZ-2944. NPE in TestProcessorContext.\n+  TEZ-2945. TEZ-2740 addendum to update API with currently supported parameters\n   TEZ-2933. Tez UI: Load application details from RM when available\n   TEZ-2908. Tez UI: Errors are logged, but not displayed in the UI when AM fetch fails\n   TEZ-2923. Tez Live UI counters view empty for vertices, tasks, attempts",
                "raw_url": "https://github.com/apache/tez/raw/28fb6522f4510cf62021c6dec55159d3b4de1b35/CHANGES.txt",
                "sha": "a6c4a63d0c83865f6f0e5cab2faaf2cce3a13970",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/tez/blob/28fb6522f4510cf62021c6dec55159d3b4de1b35/tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java?ref=28fb6522f4510cf62021c6dec55159d3b4de1b35",
                "deletions": 4,
                "filename": "tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java",
                "patch": "@@ -96,9 +96,5 @@ public void testDagNumber() {\n     assertEquals(vertexName, procContext.getTaskVertexName());\n     assertEquals(vertexId.getId(), procContext.getTaskVertexIndex());\n     assertTrue(Arrays.equals(localDirs, procContext.getWorkDirs()));\n-    \n-    // test auto call of notifyProgress\n-    procContext.setProgress(0.1f);\n-    verify(runtimeTask, times(1)).notifyProgressInvocation();\n   }\n }",
                "raw_url": "https://github.com/apache/tez/raw/28fb6522f4510cf62021c6dec55159d3b4de1b35/tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java",
                "sha": "40bc257b6b0d667624c400b2d1b643a086d84ead",
                "status": "modified"
            }
        ],
        "message": "TEZ-2944. NPE in TestProcessorContext. (Bikas Saha via hitesh)",
        "parent": "https://github.com/apache/tez/commit/fd13f51b3f416dfe16da7279f10c3cbab21ff572",
        "patched_files": [
            "ProcessorContext.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestProcessorContext.java"
        ]
    },
    "tez_2debbca": {
        "bug_id": "tez_2debbca",
        "commit": "https://github.com/apache/tez/commit/2debbca5921daa8fd4a9080e8390c0c086914d62",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/tez/blob/2debbca5921daa8fd4a9080e8390c0c086914d62/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java?ref=2debbca5921daa8fd4a9080e8390c0c086914d62",
                "deletions": 6,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "patch": "@@ -250,19 +250,15 @@\n               EnumSet.of(VertexState.TERMINATING, VertexState.KILLED, VertexState.FAILED),\n               VertexEventType.V_TASK_COMPLETED,\n               new TaskCompletedTransition())\n-          .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n-              VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n-              TASK_ATTEMPT_COMPLETED_EVENT_TRANSITION) // TODO shouldnt be done for KILL_WAIT vertex\n-          .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n-              VertexEventType.V_SOURCE_TASK_ATTEMPT_COMPLETED,\n-              SOURCE_TASK_ATTEMPT_COMPLETED_EVENT_TRANSITION)\n           .addTransition(\n               VertexState.TERMINATING,\n               VertexState.ERROR, VertexEventType.V_INTERNAL_ERROR,\n               INTERNAL_ERROR_TRANSITION)\n           // Ignore-able events\n           .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n               EnumSet.of(VertexEventType.V_TERMINATE,\n+                  VertexEventType.V_SOURCE_TASK_ATTEMPT_COMPLETED,\n+                  VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n                   VertexEventType.V_TASK_RESCHEDULED))\n \n           // Transitions from SUCCEEDED state\n@@ -301,6 +297,7 @@\n           // Ignore-able events\n           .addTransition(VertexState.KILLED, VertexState.KILLED,\n               EnumSet.of(VertexEventType.V_TERMINATE,\n+                  VertexEventType.V_SOURCE_VERTEX_STARTED,\n                   VertexEventType.V_START,\n                   VertexEventType.V_TASK_RESCHEDULED,\n                   VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n@@ -311,6 +308,8 @@\n               VertexState.ERROR,\n               VertexState.ERROR,\n               EnumSet.of(VertexEventType.V_INIT,\n+                  VertexEventType.V_SOURCE_VERTEX_STARTED,\n+                  VertexEventType.V_START,\n                   VertexEventType.V_TERMINATE,\n                   VertexEventType.V_TASK_COMPLETED,\n                   VertexEventType.V_TASK_ATTEMPT_COMPLETED,",
                "raw_url": "https://github.com/apache/tez/raw/2debbca5921daa8fd4a9080e8390c0c086914d62/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "sha": "99dbb872f633b1545ebc2af2d52931d1c19bcc15",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/tez/blob/2debbca5921daa8fd4a9080e8390c0c086914d62/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java?ref=2debbca5921daa8fd4a9080e8390c0c086914d62",
                "deletions": 6,
                "filename": "tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "patch": "@@ -98,13 +98,14 @@ public void run(Map<String, LogicalInput> inputs,\n     OnFileUnorderedKVOutput kvOutput = (OnFileUnorderedKVOutput) lo;\n \n     Configuration updatedConf = mrInput.getConfigUpdates();\n-    String fileName = updatedConf.get(MRJobConfig.MAP_INPUT_FILE);\n-    LOG.info(\"Processing file: \" + fileName);\n     Text srcFile = new Text();\n-    if (fileName == null) {\n-      srcFile.set(\"UNKNOWN_FILENAME_IN_PROCESSOR\");\n-    } else {\n-      srcFile.set(fileName);\n+    srcFile.set(\"UNKNOWN_FILENAME_IN_PROCESSOR\");\n+    if (updatedConf != null) {\n+      String fileName = updatedConf.get(MRJobConfig.MAP_INPUT_FILE);\n+      if (fileName != null) {\n+        LOG.info(\"Processing file: \" + fileName);\n+        srcFile.set(fileName);\n+      }\n     }\n \n     KVReader kvReader = mrInput.getReader();",
                "raw_url": "https://github.com/apache/tez/raw/2debbca5921daa8fd4a9080e8390c0c086914d62/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "sha": "6c97430a889c5aab5beb9570b2b8fc6e833348ea",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/tez/blob/2debbca5921daa8fd4a9080e8390c0c086914d62/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java?ref=2debbca5921daa8fd4a9080e8390c0c086914d62",
                "deletions": 1,
                "filename": "tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "patch": "@@ -209,7 +209,10 @@ public void setNumPhysicalInputs(int numInputs) {\n    * @return the additional fields set by {@link MRInput}\n    */\n   public Configuration getConfigUpdates() {\n-    return new Configuration(incrementalConf);\n+    if (incrementalConf != null) {\n+      return new Configuration(incrementalConf);\n+    }\n+    return null;\n   }\n \n   public float getProgress() throws IOException, InterruptedException {",
                "raw_url": "https://github.com/apache/tez/raw/2debbca5921daa8fd4a9080e8390c0c086914d62/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "sha": "ed675a44ae397a5f552fd485391746410fc3b16d",
                "status": "modified"
            }
        ],
        "message": "Addendum TEZ-510. Test MRRJobs failing with NPE (bikas)",
        "parent": "https://github.com/apache/tez/commit/968e31f96e41ce4c4e7717c6264e70e627f99837",
        "patched_files": [
            "VertexImpl.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestVertexImpl.java"
        ]
    },
    "tez_3d795d6": {
        "bug_id": "tez_3d795d6",
        "commit": "https://github.com/apache/tez/commit/3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/TEZ-2003-CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/TEZ-2003-CHANGES.txt?ref=3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
                "deletions": 0,
                "filename": "TEZ-2003-CHANGES.txt",
                "patch": "@@ -25,5 +25,6 @@ ALL CHANGES:\n   TEZ-2433. Fixes after rebase 05/08\n   TEZ-2438. tez-tools version in the branch is incorrect.\n   TEZ-2434. Allow tasks to be killed in the Runtime.\n+  TEZ-2443. TaskRunner2 should call abort, NPEs while cleaning up tasks.\n \n INCOMPATIBLE CHANGES:",
                "raw_url": "https://github.com/apache/tez/raw/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/TEZ-2003-CHANGES.txt",
                "sha": "ed72d6befbb86a796bdefd7fabdf49e40d2eaa11",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/tez/blob/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-dag/src/main/java/org/apache/tez/dag/api/TaskCommunicator.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/api/TaskCommunicator.java?ref=3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
                "deletions": 0,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/api/TaskCommunicator.java",
                "patch": "@@ -48,6 +48,10 @@ public abstract void registerRunningTaskAttempt(ContainerId containerId, TaskSpe\n   // TODO TEZ-2003. Are additional APIs required to mark a container as completed ? - for completeness.\n \n   // TODO TEZ-2003 Remove reference to TaskAttemptID\n+  // TODO TEZ-2003 This needs some information about why the attempt is being unregistered.\n+  // e.g. preempted in which case the task may need to be informed. Alternately as a result of\n+  // a failed task.\n+  // In case of preemption - a killTask API is likely a better bet than trying to overload this method.\n   public abstract void unregisterRunningTaskAttempt(TezTaskAttemptID taskAttemptID);\n \n   // TODO TEZ-2003 This doesn't necessarily belong here. A server may not start within the AM.",
                "raw_url": "https://github.com/apache/tez/raw/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-dag/src/main/java/org/apache/tez/dag/api/TaskCommunicator.java",
                "sha": "2651013cd9008b0ac18f311c43f3ed8cd81a6bbb",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/tez/blob/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java?ref=3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
                "deletions": 5,
                "filename": "tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java",
                "patch": "@@ -704,7 +704,7 @@ public synchronized void handleEvents(Collection<TezEvent> events) {\n   }\n \n   @Override\n-  public synchronized void abortTask() throws Exception {\n+  public synchronized void abortTask() {\n     if (processor != null) {\n       processor.abort();\n     }\n@@ -803,6 +803,7 @@ public void cleanup() throws InterruptedException {\n       LOG.debug(\"Num of inputs to be closed={}\", initializedInputs.size());\n       LOG.debug(\"Num of outputs to be closed={}\", initializedOutputs.size());\n     }\n+\n     // Close processor\n     if (!processorClosed && processor != null) {\n       try {\n@@ -820,8 +821,8 @@ public void cleanup() throws InterruptedException {\n         Thread.currentThread().interrupt();\n       } catch (Throwable e) {\n         LOG.warn(\n-            \"Ignoring Exception when closing processor(cleanup). Exception class={}, message={}\",\n-                e.getClass().getName(), e.getMessage());\n+            \"Ignoring Exception when closing processor(cleanup). Exception class={}, message={}\" +\n+                e.getClass().getName(), e.getMessage(), e);\n       }\n     }\n \n@@ -842,7 +843,7 @@ public void cleanup() throws InterruptedException {\n       } catch (Throwable e) {\n         LOG.warn(\n             \"Ignoring exception when closing input {}(cleanup). Exception class={}, message={}\",\n-            srcVertexName, e.getClass().getName(), e.getMessage());\n+            srcVertexName, e.getClass().getName(), e.getMessage(), e);\n       } finally {\n         LOG.info(\"Close input for vertex={}, sourceVertex={}, interruptedStatus={}\", processor\n             .getContext().getTaskVertexName(), srcVertexName, Thread.currentThread().isInterrupted());\n@@ -866,7 +867,7 @@ public void cleanup() throws InterruptedException {\n       } catch (Throwable e) {\n         LOG.warn(\n             \"Ignoring exception when closing output {}(cleanup). Exception class={}, message={}\",\n-            destVertexName, e.getClass().getName(), e.getMessage());\n+            destVertexName, e.getClass().getName(), e.getMessage(), e);\n       } finally {\n         LOG.info(\"Close input for vertex={}, sourceVertex={}, interruptedStatus={}\", processor\n             .getContext().getTaskVertexName(), destVertexName, Thread.currentThread().isInterrupted());",
                "raw_url": "https://github.com/apache/tez/raw/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java",
                "sha": "de08e56ac4329f930d855fdc2d88e59ff0f40cec",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/RuntimeTask.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/main/java/org/apache/tez/runtime/RuntimeTask.java?ref=3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
                "deletions": 1,
                "filename": "tez-runtime-internals/src/main/java/org/apache/tez/runtime/RuntimeTask.java",
                "patch": "@@ -167,5 +167,5 @@ protected void setTaskDone() {\n     taskDone.set(true);\n   }\n \n-  public abstract void abortTask() throws Exception;\n+  public abstract void abortTask();\n }",
                "raw_url": "https://github.com/apache/tez/raw/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/RuntimeTask.java",
                "sha": "33c0113f1537ce81579d920b000bf70931da8f0a",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/tez/blob/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskRunner2Callable.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskRunner2Callable.java?ref=3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
                "deletions": 6,
                "filename": "tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskRunner2Callable.java",
                "patch": "@@ -63,26 +63,26 @@ public TaskRunner2CallableResult run() throws Exception {\n           if (stopRequested.get() || Thread.currentThread().isInterrupted()) {\n             return new TaskRunner2CallableResult(null);\n           }\n-          LOG.info(\"Initializing task\" + \", taskAttemptId=\" + task.getTaskAttemptID());\n+          LOG.info(\"Initializing task\" + \", taskAttemptId={}\", task.getTaskAttemptID());\n           task.initialize();\n \n           if (!stopRequested.get() && !Thread.currentThread().isInterrupted()) {\n-            LOG.info(\"Running task, taskAttemptId=\" + task.getTaskAttemptID());\n+            LOG.info(\"Running task, taskAttemptId={}\", task.getTaskAttemptID());\n             task.run();\n           } else {\n-            LOG.info(\"Stopped before running the processor.\");\n+            LOG.info(\"Stopped before running the processor taskAttemptId={}\", task.getTaskAttemptID());\n             return new TaskRunner2CallableResult(null);\n           }\n \n           if (!stopRequested.get() && !Thread.currentThread().isInterrupted()) {\n-            LOG.info(\"Closing task, taskAttemptId=\" + task.getTaskAttemptID());\n+            LOG.info(\"Closing task, taskAttemptId={}\", task.getTaskAttemptID());\n             task.close();\n             task.setFrameworkCounters();\n           } else {\n-            LOG.info(\"Stopped before closing the processor\");\n+            LOG.info(\"Stopped before closing the processor, taskAttemptId={}\", task.getTaskAttemptID());\n             return new TaskRunner2CallableResult(null);\n           }\n-          LOG.info(\"Task completed, taskAttemptId=\" + task.getTaskAttemptID() + \", askedToStop=\" + stopRequested.get());\n+          LOG.info(\"Task completed, taskAttemptId={}, askedToStop={}\", task.getTaskAttemptID(), stopRequested.get());\n \n \n           return new TaskRunner2CallableResult(null);\n@@ -115,6 +115,7 @@ private void maybeFixInterruptStatus() {\n   public void interruptTask() {\n     // Ensure the task is only interrupted once.\n     if (!stopRequested.getAndSet(true)) {\n+      task.abortTask();\n       if (ownThread != null) {\n         ownThread.interrupt();\n       }",
                "raw_url": "https://github.com/apache/tez/raw/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskRunner2Callable.java",
                "sha": "ab77635203f03cc3843a03a4a2304e3318389519",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/tez/blob/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TezTaskRunner2.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TezTaskRunner2.java?ref=3d795d62c0d471ff866adb9002e8c6fe6ea9536a",
                "deletions": 4,
                "filename": "tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TezTaskRunner2.java",
                "patch": "@@ -250,10 +250,12 @@ public TaskRunner2Result run() {\n   public void killTask() {\n     synchronized (this) {\n       if (isRunningState()) {\n-        trySettingEndReason(EndReason.KILL_REQUESTED);\n-        if (taskRunnerCallable != null) {\n-          taskKillStartTime = System.currentTimeMillis();\n-          taskRunnerCallable.interruptTask();\n+        if (trySettingEndReason(EndReason.KILL_REQUESTED)) {\n+          killTaskRequested.set(true);\n+          if (taskRunnerCallable != null) {\n+            taskKillStartTime = System.currentTimeMillis();\n+            taskRunnerCallable.interruptTask();\n+          }\n         }\n       }\n     }",
                "raw_url": "https://github.com/apache/tez/raw/3d795d62c0d471ff866adb9002e8c6fe6ea9536a/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TezTaskRunner2.java",
                "sha": "ffbc6e890801cffdeacc29b792ef9121e44d2831",
                "status": "modified"
            }
        ],
        "message": "TEZ-2443. TaskRunner2 should call abort, NPEs while cleaning up tasks. (sseth)",
        "parent": "https://github.com/apache/tez/commit/7cf416ae8cb19757e42530d42a7ccc3532d2f927",
        "patched_files": [
            "TEZ-2003-CHANGES.txt",
            "LogicalIOProcessorRuntimeTask.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestLogicalIOProcessorRuntimeTask.java"
        ]
    },
    "tez_4561b82": {
        "bug_id": "tez_4561b82",
        "commit": "https://github.com/apache/tez/commit/4561b82524ca6ee484910349a6c95703883757b6",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/4561b82524ca6ee484910349a6c95703883757b6/CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=4561b82524ca6ee484910349a6c95703883757b6",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -8,6 +8,7 @@ INCOMPATIBLE CHANGES\n   TEZ-2948. Stop using dagName in the dagComplete notification to TaskCommunicators.\n \n ALL CHANGES:\n+  TEZ-2952. NPE in TestOnFileUnorderedKVOutput\n   TEZ-2480. Exception when closing output is ignored.\n   TEZ-2944. NPE in TestProcessorContext.\n   TEZ-2945. TEZ-2740 addendum to update API with currently supported parameters",
                "raw_url": "https://github.com/apache/tez/raw/4561b82524ca6ee484910349a6c95703883757b6/CHANGES.txt",
                "sha": "9644a1ec2c9150f2c28564a241539625ce4091e6",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/tez/blob/4561b82524ca6ee484910349a6c95703883757b6/tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java",
                "changes": 20,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java?ref=4561b82524ca6ee484910349a6c95703883757b6",
                "deletions": 5,
                "filename": "tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java",
                "patch": "@@ -16,17 +16,17 @@\n \n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertTrue;\n-import static org.mockito.Matchers.any;\n import static org.mockito.Mockito.*;\n \n+import java.io.IOException;\n import java.nio.ByteBuffer;\n import java.util.Arrays;\n+import java.util.Collections;\n import java.util.Map;\n \n import com.google.common.collect.Maps;\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.yarn.api.records.ApplicationId;\n-import org.apache.tez.common.counters.TezCounters;\n import org.apache.tez.dag.api.ProcessorDescriptor;\n import org.apache.tez.dag.records.TezDAGID;\n import org.apache.tez.dag.records.TezTaskAttemptID;\n@@ -43,7 +43,7 @@\n public class TestProcessorContext {\n \n   @Test (timeout = 5000)\n-  public void testDagNumber() {\n+  public void testDagNumber() throws IOException {\n     String[] localDirs = new String[] {\"dummyLocalDir\"};\n     int appAttemptNumber = 1;\n     TezUmbilical tezUmbilical = mock(TezUmbilical.class);\n@@ -57,8 +57,14 @@ public void testDagNumber() {\n     TezTaskID taskId = TezTaskID.getInstance(vertexId, 4);\n     TezTaskAttemptID taskAttemptId = TezTaskAttemptID.getInstance(taskId, 2);\n \n-    LogicalIOProcessorRuntimeTask runtimeTask = mock(LogicalIOProcessorRuntimeTask.class);\n-    doReturn(new TezCounters()).when(runtimeTask).addAndGetTezCounter(any(String.class));\n+    TaskSpec mockSpec = mock(TaskSpec.class);\n+    when(mockSpec.getInputs()).thenReturn(Collections.singletonList(mock(InputSpec.class)));\n+    when(mockSpec.getOutputs()).thenReturn(Collections.singletonList(mock(OutputSpec.class)));\n+    LogicalIOProcessorRuntimeTask runtimeTask = new LogicalIOProcessorRuntimeTask(\n+        mockSpec, 1, \n+        new Configuration(), new String[]{\"/\"}, \n+        tezUmbilical, null, null, null, null, \"\", null, 1024, false);\n+    LogicalIOProcessorRuntimeTask mockTask = spy(runtimeTask);\n     Map<String, ByteBuffer> serviceConsumerMetadata = Maps.newHashMap();\n     Map<String, String> auxServiceEnv = Maps.newHashMap();\n     MemoryDistributor memDist = mock(MemoryDistributor.class);\n@@ -96,5 +102,9 @@ public void testDagNumber() {\n     assertEquals(vertexName, procContext.getTaskVertexName());\n     assertEquals(vertexId.getId(), procContext.getTaskVertexIndex());\n     assertTrue(Arrays.equals(localDirs, procContext.getWorkDirs()));\n+\n+     // test auto call of notifyProgress\n+     procContext.setProgress(0.1f);\n+     verify(mockTask, times(1)).notifyProgressInvocation();\n   }\n }",
                "raw_url": "https://github.com/apache/tez/raw/4561b82524ca6ee484910349a6c95703883757b6/tez-runtime-internals/src/test/java/org/apache/tez/runtime/api/impl/TestProcessorContext.java",
                "sha": "f0c1e66b3b70171ea018feffb4c54b6e3fb2918e",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/tez/blob/4561b82524ca6ee484910349a6c95703883757b6/tez-runtime-library/src/test/java/org/apache/tez/runtime/library/output/TestOnFileUnorderedKVOutput.java",
                "changes": 31,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-library/src/test/java/org/apache/tez/runtime/library/output/TestOnFileUnorderedKVOutput.java?ref=4561b82524ca6ee484910349a6c95703883757b6",
                "deletions": 12,
                "filename": "tez-runtime-library/src/test/java/org/apache/tez/runtime/library/output/TestOnFileUnorderedKVOutput.java",
                "patch": "@@ -33,6 +33,7 @@\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.Collections;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n@@ -49,7 +50,6 @@\n import org.apache.hadoop.io.Text;\n import org.apache.hadoop.yarn.util.AuxiliaryServiceHelper;\n import org.apache.tez.common.TezUtils;\n-import org.apache.tez.common.counters.TezCounters;\n import org.apache.tez.dag.api.OutputDescriptor;\n import org.apache.tez.dag.api.UserPayload;\n import org.apache.tez.dag.records.TezDAGID;\n@@ -62,7 +62,9 @@\n import org.apache.tez.runtime.api.OutputContext;\n import org.apache.tez.runtime.api.events.CompositeDataMovementEvent;\n import org.apache.tez.runtime.api.impl.ExecutionContextImpl;\n-import org.apache.tez.runtime.api.impl.TaskStatistics;\n+import org.apache.tez.runtime.api.impl.InputSpec;\n+import org.apache.tez.runtime.api.impl.OutputSpec;\n+import org.apache.tez.runtime.api.impl.TaskSpec;\n import org.apache.tez.runtime.api.impl.TezOutputContextImpl;\n import org.apache.tez.runtime.api.impl.TezUmbilical;\n import org.apache.tez.runtime.common.resources.MemoryDistributor;\n@@ -91,7 +93,7 @@\n   private static Path workDir = null;\n   private static final int shufflePort = 2112;\n \n-  TaskStatistics stats;\n+  LogicalIOProcessorRuntimeTask task;\n \n   static {\n     defaultConf.set(\"fs.defaultFS\", \"file:///\");\n@@ -108,7 +110,6 @@\n \n   @Before\n   public void setup() throws Exception {\n-    stats = new TaskStatistics();\n     localFs.mkdirs(workDir);\n   }\n \n@@ -139,8 +140,8 @@ public void testGeneratedDataMovementEvent() throws Exception {\n     }\n \n     events = kvOutput.close();\n-    assertEquals(45, stats.getIOStatistics().values().iterator().next().getDataSize());\n-    assertEquals(5, stats.getIOStatistics().values().iterator().next().getItemsProcessed());\n+    assertEquals(45, task.getTaskStatistics().getIOStatistics().values().iterator().next().getDataSize());\n+    assertEquals(5, task.getTaskStatistics().getIOStatistics().values().iterator().next().getItemsProcessed());\n     assertTrue(events != null && events.size() == 1);\n     CompositeDataMovementEvent dmEvent = (CompositeDataMovementEvent)events.get(0);\n \n@@ -212,12 +213,18 @@ private OutputContext createOutputContext(Configuration conf) throws IOException\n     TezVertexID vertexID = TezVertexID.getInstance(dagID, 1);\n     TezTaskID taskID = TezTaskID.getInstance(vertexID, 1);\n     TezTaskAttemptID taskAttemptID = TezTaskAttemptID.getInstance(taskID, 1);\n-    TezCounters counters = new TezCounters();\n     UserPayload userPayload = TezUtils.createUserPayloadFromConf(conf);\n-    LogicalIOProcessorRuntimeTask runtimeTask = mock(LogicalIOProcessorRuntimeTask.class);\n-    when(runtimeTask.addAndGetTezCounter(destinationVertexName)).thenReturn(counters);\n-    when(runtimeTask.getTaskStatistics()).thenReturn(stats);\n-\n+    \n+    TaskSpec mockSpec = mock(TaskSpec.class);\n+    when(mockSpec.getInputs()).thenReturn(Collections.singletonList(mock(InputSpec.class)));\n+    when(mockSpec.getOutputs()).thenReturn(Collections.singletonList(mock(OutputSpec.class)));\n+    task = new LogicalIOProcessorRuntimeTask(\n+        mockSpec, appAttemptNumber, \n+        new Configuration(), new String[]{\"/\"}, \n+        tezUmbilical, null, null, null, null, \"\", null, 1024, false);\n+    \n+    LogicalIOProcessorRuntimeTask runtimeTask = spy(task);\n+    \n     Map<String, String> auxEnv = new HashMap<String, String>();\n     ByteBuffer bb = ByteBuffer.allocate(4);\n     bb.putInt(shufflePort);\n@@ -236,7 +243,7 @@ private OutputContext createOutputContext(Configuration conf) throws IOException\n     verify(runtimeTask, times(1)).addAndGetTezCounter(destinationVertexName);\n     verify(runtimeTask, times(1)).getTaskStatistics();\n     // verify output stats object got created\n-    Assert.assertTrue(stats.getIOStatistics().containsKey(destinationVertexName));\n+    Assert.assertTrue(task.getTaskStatistics().getIOStatistics().containsKey(destinationVertexName));\n     OutputContext outputContext = spy(realOutputContext);\n     doAnswer(new Answer() {\n       @Override public Object answer(InvocationOnMock invocation) throws Throwable {",
                "raw_url": "https://github.com/apache/tez/raw/4561b82524ca6ee484910349a6c95703883757b6/tez-runtime-library/src/test/java/org/apache/tez/runtime/library/output/TestOnFileUnorderedKVOutput.java",
                "sha": "32a3619c7810f68063d7649e68f55d80c08ec7b5",
                "status": "modified"
            }
        ],
        "message": "TEZ-2952. NPE in TestOnFileUnorderedKVOutput (bikas)",
        "parent": "https://github.com/apache/tez/commit/c07f284ac1c764b32841a872dca1addaf46906a2",
        "patched_files": [
            "ProcessorContext.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestProcessorContext.java",
            "TestOnFileUnorderedKVOutput.java"
        ]
    },
    "tez_6176432": {
        "bug_id": "tez_6176432",
        "commit": "https://github.com/apache/tez/commit/61764323798385ec8d8103db2d4dcc24c2ebd1ae",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/61764323798385ec8d8103db2d4dcc24c2ebd1ae/CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=61764323798385ec8d8103db2d4dcc24c2ebd1ae",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -266,6 +266,7 @@ TEZ-UI CHANGES (TEZ-8):\n Release 0.5.4: Unreleased\n \n ALL CHANGES:\n+  TEZ-2257. Fix potential NPEs in TaskReporter.\n   TEZ-2192. Relocalization does not check for source.\n   TEZ-2224. EventQueue empty doesn't mean events are consumed in RecoveryService\n   TEZ-2240. Fix toUpperCase/toLowerCase to use Locale.ENGLISH.",
                "raw_url": "https://github.com/apache/tez/raw/61764323798385ec8d8103db2d4dcc24c2ebd1ae/CHANGES.txt",
                "sha": "dc28971462553026e26c583b1cd4c3f4ab4a9c28",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/61764323798385ec8d8103db2d4dcc24c2ebd1ae/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskReporter.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskReporter.java?ref=61764323798385ec8d8103db2d4dcc24c2ebd1ae",
                "deletions": 3,
                "filename": "tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskReporter.java",
                "patch": "@@ -374,16 +374,16 @@ public void onFailure(Throwable t) {\n     }\n   }\n \n-  public boolean taskSucceeded(TezTaskAttemptID taskAttemptID) throws IOException, TezException {\n+  public synchronized boolean taskSucceeded(TezTaskAttemptID taskAttemptID) throws IOException, TezException {\n     return currentCallable.taskSucceeded(taskAttemptID);\n   }\n \n-  public boolean taskFailed(TezTaskAttemptID taskAttemptID, Throwable t, String diagnostics,\n+  public synchronized boolean taskFailed(TezTaskAttemptID taskAttemptID, Throwable t, String diagnostics,\n       EventMetaData srcMeta) throws IOException, TezException {\n     return currentCallable.taskFailed(taskAttemptID, t, diagnostics, srcMeta);\n   }\n \n-  public void addEvents(TezTaskAttemptID taskAttemptID, Collection<TezEvent> events) {\n+  public synchronized void addEvents(TezTaskAttemptID taskAttemptID, Collection<TezEvent> events) {\n     currentCallable.addEvents(taskAttemptID, events);\n   }\n ",
                "raw_url": "https://github.com/apache/tez/raw/61764323798385ec8d8103db2d4dcc24c2ebd1ae/tez-runtime-internals/src/main/java/org/apache/tez/runtime/task/TaskReporter.java",
                "sha": "4c07f5a46a52c4ee50070b45c611e0a863260a42",
                "status": "modified"
            }
        ],
        "message": "TEZ-2257. Fix potential NPEs in TaskReporter. (sseth)",
        "parent": "https://github.com/apache/tez/commit/9316fe627a9153a5caf8c653e97300c7b4bb8095",
        "patched_files": [
            "TaskReporter.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskReporter.java"
        ]
    },
    "tez_633fde2": {
        "bug_id": "tez_633fde2",
        "commit": "https://github.com/apache/tez/commit/633fde2cd41ae0a2f51b5c34190318bae54a2ee6",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/633fde2cd41ae0a2f51b5c34190318bae54a2ee6/tez-plugins/tez-aux-services/src/main/java/org/apache/tez/auxservices/ShuffleHandler.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-plugins/tez-aux-services/src/main/java/org/apache/tez/auxservices/ShuffleHandler.java?ref=633fde2cd41ae0a2f51b5c34190318bae54a2ee6",
                "deletions": 1,
                "filename": "tez-plugins/tez-aux-services/src/main/java/org/apache/tez/auxservices/ShuffleHandler.java",
                "patch": "@@ -1399,9 +1399,9 @@ protected ChannelFuture sendMapOutput(ChannelHandlerContext ctx, Channel ch,\n         DataOutputBuffer dob = new DataOutputBuffer();\n         header.write(dob);\n         // Free the memory needed to store the spill and index records\n-        outputInfo.finish();\n         ch.write(wrappedBuffer(dob.getData(), 0, dob.getLength()));\n       }\n+      outputInfo.finish();\n \n       final long rangeOffset = firstIndex.getStartOffset();\n       final long rangePartLength = lastIndex.getStartOffset() + lastIndex.getPartLength() - firstIndex.getStartOffset();",
                "raw_url": "https://github.com/apache/tez/raw/633fde2cd41ae0a2f51b5c34190318bae54a2ee6/tez-plugins/tez-aux-services/src/main/java/org/apache/tez/auxservices/ShuffleHandler.java",
                "sha": "f294edced96410a5eca38581a4d12b95f4d31cf3",
                "status": "modified"
            },
            {
                "additions": 103,
                "blob_url": "https://github.com/apache/tez/blob/633fde2cd41ae0a2f51b5c34190318bae54a2ee6/tez-plugins/tez-aux-services/src/test/java/org/apache/tez/auxservices/TestShuffleHandler.java",
                "changes": 114,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-plugins/tez-aux-services/src/test/java/org/apache/tez/auxservices/TestShuffleHandler.java?ref=633fde2cd41ae0a2f51b5c34190318bae54a2ee6",
                "deletions": 11,
                "filename": "tez-plugins/tez-aux-services/src/test/java/org/apache/tez/auxservices/TestShuffleHandler.java",
                "patch": "@@ -55,6 +55,7 @@\n import org.apache.hadoop.fs.Path;\n import org.apache.hadoop.io.DataOutputBuffer;\n import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.WritableUtils;\n import org.apache.hadoop.io.nativeio.NativeIO;\n import org.apache.hadoop.mapred.JobID;\n import org.apache.hadoop.mapred.MapTask;\n@@ -75,6 +76,8 @@\n import org.apache.hadoop.yarn.server.api.ApplicationInitializationContext;\n import org.apache.hadoop.yarn.server.api.ApplicationTerminationContext;\n import org.apache.hadoop.yarn.server.records.Version;\n+import org.apache.tez.runtime.library.common.sort.impl.TezIndexRecord;\n+import org.apache.tez.runtime.library.common.sort.impl.TezSpillRecord;\n import org.jboss.netty.channel.Channel;\n import org.jboss.netty.channel.ChannelFuture;\n import org.jboss.netty.channel.ChannelHandlerContext;\n@@ -657,6 +660,102 @@ protected ChannelFuture sendMapOutput(ChannelHandlerContext ctx,\n     shuffleHandler.stop();\n   }\n \n+  /**\n+   * Validate the ranged fetch works as expected\n+   */\n+  @Test(timeout = 10000)\n+  public void testRangedFetch() throws IOException {\n+    Configuration conf = new Configuration();\n+    conf.setInt(ShuffleHandler.SHUFFLE_PORT_CONFIG_KEY, 0);\n+    conf.setInt(ShuffleHandler.MAX_SHUFFLE_CONNECTIONS, 3);\n+    conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,\n+        \"simple\");\n+    UserGroupInformation.setConfiguration(conf);\n+    File absLogDir = new File(\"target\",\n+        TestShuffleHandler.class.getSimpleName() + \"LocDir\").getAbsoluteFile();\n+    conf.set(YarnConfiguration.NM_LOCAL_DIRS, absLogDir.getAbsolutePath());\n+    ApplicationId appId = ApplicationId.newInstance(12345, 1);\n+    LOG.info(appId.toString());\n+    String appAttemptId = \"attempt_12345_1_m_1_0\";\n+    String user = \"randomUser\";\n+    String reducerIdStart = \"0\";\n+    String reducerIdEnd = \"1\";\n+    List<File> fileMap = new ArrayList<>();\n+    createShuffleHandlerFiles(absLogDir, user, appId.toString(), appAttemptId,\n+        conf, fileMap);\n+    ShuffleHandler shuffleHandler = new ShuffleHandler() {\n+\n+      @Override\n+      protected Shuffle getShuffle(Configuration conf) {\n+        // replace the shuffle handler with one stubbed for testing\n+        return new Shuffle(conf) {\n+\n+          @Override\n+          protected void verifyRequest(String appid, ChannelHandlerContext ctx,\n+                                       HttpRequest request, HttpResponse response, URL requestUri)\n+              throws IOException {\n+            // Do nothing.\n+          }\n+\n+        };\n+      }\n+    };\n+    shuffleHandler.init(conf);\n+    try {\n+      shuffleHandler.start();\n+      DataOutputBuffer outputBuffer = new DataOutputBuffer();\n+      outputBuffer.reset();\n+      Token<JobTokenIdentifier> jt =\n+          new Token<JobTokenIdentifier>(\"identifier\".getBytes(),\n+              \"password\".getBytes(), new Text(user), new Text(\"shuffleService\"));\n+      jt.write(outputBuffer);\n+      shuffleHandler\n+          .initializeApplication(new ApplicationInitializationContext(user,\n+              appId, ByteBuffer.wrap(outputBuffer.getData(), 0,\n+              outputBuffer.getLength())));\n+      URL url =\n+          new URL(\n+              \"http://127.0.0.1:\"\n+                  + shuffleHandler.getConfig().get(\n+                  ShuffleHandler.SHUFFLE_PORT_CONFIG_KEY)\n+                  + \"/mapOutput?job=job_12345_0001&dag=1&reduce=\" + reducerIdStart + \"-\" + reducerIdEnd\n+                  + \"&map=attempt_12345_1_m_1_0\");\n+      HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n+      conn.setRequestProperty(ShuffleHeader.HTTP_HEADER_NAME,\n+          ShuffleHeader.DEFAULT_HTTP_HEADER_NAME);\n+      conn.setRequestProperty(ShuffleHeader.HTTP_HEADER_VERSION,\n+          ShuffleHeader.DEFAULT_HTTP_HEADER_VERSION);\n+      conn.connect();\n+      boolean succeeded = false;\n+      try {\n+        DataInputStream is = new DataInputStream(conn.getInputStream());\n+        int partitionCount = WritableUtils.readVInt(is);\n+        List<ShuffleHeader> headers = new ArrayList<>(2);\n+        for (int i = 0; i < partitionCount; i++) {\n+          ShuffleHeader header = new ShuffleHeader();\n+          header.readFields(is);\n+          Assert.assertEquals(\"Incorrect map id\", \"attempt_12345_1_m_1_0\", header.getMapId());\n+          Assert.assertEquals(\"Incorrect reduce id\", i, header.getPartition());\n+          headers.add(header);\n+        }\n+        for (ShuffleHeader header: headers) {\n+          byte[] bytes = new byte[(int)header.getCompressedLength()];\n+          is.read(bytes);\n+        }\n+        succeeded = true;\n+        // Read one more byte to force EOF\n+        is.readByte();\n+        Assert.fail(\"More fetch bytes that expected in stream\");\n+      } catch (EOFException e) {\n+        Assert.assertTrue(\"Failed to copy ranged fetch\", succeeded);\n+      }\n+\n+    } finally {\n+      shuffleHandler.stop();\n+      FileUtil.fullyDelete(absLogDir);\n+    }\n+  }\n+\n   /**\n    * Validate the ownership of the map-output files being pulled in. The\n    * local-file-system owner of the file should match the user component in the\n@@ -785,18 +884,11 @@ private static void createIndexFile(File indexFile, Configuration conf)\n       System.out.println(\"Deleting existing file\");\n       indexFile.delete();\n     }\n-    indexFile.createNewFile();\n-    FSDataOutputStream output = FileSystem.getLocal(conf).getRaw().append(\n-        new Path(indexFile.getAbsolutePath()));\n     Checksum crc = new PureJavaCrc32();\n-    crc.reset();\n-    CheckedOutputStream chk = new CheckedOutputStream(output, crc);\n-    String msg = \"Writing new index file. This file will be used only \" +\n-        \"for the testing.\";\n-    chk.write(Arrays.copyOf(msg.getBytes(),\n-        MapTask.MAP_OUTPUT_INDEX_RECORD_LENGTH));\n-    output.writeLong(chk.getChecksum().getValue());\n-    output.close();\n+    TezSpillRecord tezSpillRecord = new TezSpillRecord(2);\n+    tezSpillRecord.putIndex(new TezIndexRecord(0, 10, 10), 0);\n+    tezSpillRecord.putIndex(new TezIndexRecord(10, 10, 10), 1);\n+    tezSpillRecord.writeToFile(new Path(indexFile.getAbsolutePath()), conf, crc);\n   }\n \n   @Test",
                "raw_url": "https://github.com/apache/tez/raw/633fde2cd41ae0a2f51b5c34190318bae54a2ee6/tez-plugins/tez-aux-services/src/test/java/org/apache/tez/auxservices/TestShuffleHandler.java",
                "sha": "7c421a9c17f354f326d615086ff3fa7eedcf4618",
                "status": "modified"
            }
        ],
        "message": "TEZ-3970. NullPointerException in Tez ShuffleHandler Ranged Fetch (Jonathan Eagles via kshukla)",
        "parent": "https://github.com/apache/tez/commit/4496f66673de97bbe92e9b143696635038c2b799",
        "patched_files": [
            "ShuffleHandler.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestShuffleHandler.java"
        ]
    },
    "tez_689d738": {
        "bug_id": "tez_689d738",
        "commit": "https://github.com/apache/tez/commit/689d7388592196c320319f026961b3fef0167dc5",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/689d7388592196c320319f026961b3fef0167dc5/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java?ref=689d7388592196c320319f026961b3fef0167dc5",
                "deletions": 1,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java",
                "patch": "@@ -1029,7 +1029,9 @@ public void transition(TaskImpl task, TaskEvent event) {\n         // find the oldest running attempt\n         if (!ta.isFinished()) {\n           earliestUnfinishedAttempt = ta;\n-          task.nodesWithRunningAttempts.add(ta.getNodeId());\n+          if (ta.getNodeId() != null) {\n+            task.nodesWithRunningAttempts.add(ta.getNodeId());\n+          }\n         } else {\n           if (TaskAttemptState.SUCCEEDED.equals(ta.getState())) {\n             LOG.info(\"Ignore speculation scheduling for task {} since it has succeeded with attempt {}.\",",
                "raw_url": "https://github.com/apache/tez/raw/689d7388592196c320319f026961b3fef0167dc5/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java",
                "sha": "39e2b4c1f7c40a27ae6b4a484999e0bbcf51a94b",
                "status": "modified"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/tez/blob/689d7388592196c320319f026961b3fef0167dc5/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestTaskImpl.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestTaskImpl.java?ref=689d7388592196c320319f026961b3fef0167dc5",
                "deletions": 0,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestTaskImpl.java",
                "patch": "@@ -887,6 +887,45 @@ public void testFailedThenSpeculativeSucceeded() {\n     assertEquals(2, mockTask.getAttemptList().size());\n   }\n \n+  @Test\n+  public void testKilledBeforeSpeculatedSucceeded() {\n+    conf.setInt(TezConfiguration.TEZ_AM_TASK_MAX_FAILED_ATTEMPTS, 1);\n+    Vertex vertex = mock(Vertex.class);\n+    doReturn(new VertexImpl.VertexConfigImpl(conf)).when(vertex).getVertexConfig();\n+    mockTask = new MockTaskImpl(vertexId, partition,\n+        eventHandler, conf, taskCommunicatorManagerInterface, clock,\n+        taskHeartbeatHandler, appContext, leafVertex,\n+        taskResource, containerContext, vertex);\n+    TezTaskID taskId = getNewTaskID();\n+    scheduleTaskAttempt(taskId);\n+    MockTaskAttemptImpl firstAttempt = mockTask.getLastAttempt();\n+    launchTaskAttempt(firstAttempt.getID());\n+    updateAttemptState(firstAttempt, TaskAttemptState.RUNNING);\n+\n+    mockTask.handle(createTaskTAKilledEvent(firstAttempt.getID()));\n+    assertEquals(TaskStateInternal.RUNNING, mockTask.getInternalState());\n+\n+    // We need to manually override the current node id\n+    // to induce NPE in the state machine transition\n+    // simulating killed before speculated scenario\n+    NodeId nodeId = mockNodeId;\n+    mockNodeId = null;\n+\n+    // Add a speculative task attempt\n+    mockTask.handle(createTaskTAAddSpecAttempt(mockTask.getLastAttempt().getID()));\n+    mockNodeId = nodeId;\n+    MockTaskAttemptImpl specAttempt = mockTask.getLastAttempt();\n+    launchTaskAttempt(specAttempt.getID());\n+    updateAttemptState(specAttempt, TaskAttemptState.RUNNING);\n+    assertEquals(3, mockTask.getAttemptList().size());\n+\n+    // Now succeed the speculative attempt\n+    updateAttemptState(specAttempt, TaskAttemptState.SUCCEEDED);\n+    mockTask.handle(createTaskTASucceededEvent(specAttempt.getID()));\n+    assertEquals(TaskState.SUCCEEDED, mockTask.getState());\n+    assertEquals(3, mockTask.getAttemptList().size());\n+  }\n+\n   @Test(timeout = 20000)\n   public void testKilledAttemptUpdatesDAGScheduler() {\n     TezTaskID taskId = getNewTaskID();",
                "raw_url": "https://github.com/apache/tez/raw/689d7388592196c320319f026961b3fef0167dc5/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestTaskImpl.java",
                "sha": "1af6092d1ecf5775c10bd390eb0a568f3eecb28d",
                "status": "modified"
            }
        ],
        "message": "TEZ-4108. NullPointerException during speculative execution race condition",
        "parent": "https://github.com/apache/tez/commit/09c6f902fdab527ca537f6b727e70c1579f2a2cf",
        "patched_files": [
            "TaskImpl.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskImpl.java"
        ]
    },
    "tez_72c458a": {
        "bug_id": "tez_72c458a",
        "commit": "https://github.com/apache/tez/commit/72c458a431545565d38681862a883065f4efa44e",
        "file": [
            {
                "additions": 29,
                "blob_url": "https://github.com/apache/tez/blob/72c458a431545565d38681862a883065f4efa44e/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java",
                "changes": 41,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java?ref=72c458a431545565d38681862a883065f4efa44e",
                "deletions": 12,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java",
                "patch": "@@ -420,10 +420,14 @@ private void handleTAUnsuccessfulEnd(AMSchedulerEventTAEnded event) {\n       // Inform the Node - the task has asked to be STOPPED / has already\n       // stopped.\n       // AMNodeImpl blacklisting logic does not account for KILLED attempts.\n-      sendEvent(new AMNodeEventTaskAttemptEnded(appContext.getAllContainers().\n-          get(attemptContainerId).getContainer().getNodeId(), event.getSchedulerId(),\n-          attemptContainerId,\n-          attempt.getID(), event.getState() == TaskAttemptState.FAILED));\n+      AMContainer amContainer = appContext.getAllContainers().get(attemptContainerId);\n+      // DAG can be shutting down so protect against container cleanup race\n+      if (amContainer != null) {\n+        Container container = amContainer.getContainer();\n+        sendEvent(new AMNodeEventTaskAttemptEnded(container.getNodeId(), event.getSchedulerId(),\n+            attemptContainerId,\n+            attempt.getID(), event.getState() == TaskAttemptState.FAILED));\n+      }\n     }\n   }\n \n@@ -436,9 +440,14 @@ private void handleTASucceeded(AMSchedulerEventTAEnded event) {\n     if (event.getUsedContainerId() != null) {\n       sendEvent(new AMContainerEventTASucceeded(usedContainerId,\n           event.getAttemptID()));\n-      sendEvent(new AMNodeEventTaskAttemptSucceeded(appContext.getAllContainers().\n-          get(usedContainerId).getContainer().getNodeId(), event.getSchedulerId(), usedContainerId,\n-          event.getAttemptID()));\n+      AMContainer amContainer = appContext.getAllContainers().get(usedContainerId);\n+      // DAG can be shutting down so protect against container cleanup race\n+      if (amContainer != null) {\n+        Container container = amContainer.getContainer();\n+        sendEvent(new AMNodeEventTaskAttemptSucceeded(container.getNodeId(), event.getSchedulerId(),\n+            usedContainerId,\n+            event.getAttemptID()));\n+      }\n     }\n \n     boolean wasContainerAllocated = false;\n@@ -742,10 +751,15 @@ public synchronized void taskAllocated(int schedulerId, Object task,\n     // because the deallocateTask downcall may have raced with the\n     // taskAllocated() upcall\n     assert task.equals(taskAttempt);\n- \n-    if (appContext.getAllContainers().get(containerId).getState() == AMContainerState.ALLOCATED) {\n-      sendEvent(new AMContainerEventLaunchRequest(containerId, taskAttempt.getVertexID(),\n-          event.getContainerContext(), event.getLauncherId(), event.getTaskCommId()));\n+\n+    AMContainer amContainer = appContext.getAllContainers().get(containerId);\n+    // Even though we just added this container,\n+    // DAG can be shutting down so protect against container cleanup race\n+    if (amContainer != null) {\n+      if (amContainer.getState() == AMContainerState.ALLOCATED) {\n+        sendEvent(new AMContainerEventLaunchRequest(containerId, taskAttempt.getVertexID(),\n+            event.getContainerContext(), event.getLauncherId(), event.getTaskCommId()));\n+      }\n     }\n     sendEvent(new AMContainerEventAssignTA(containerId, taskAttempt.getID(),\n         event.getRemoteTaskSpec(), event.getContainerContext().getLocalResources(), event\n@@ -951,7 +965,10 @@ public void preemptContainer(int schedulerId, ContainerId containerId) {\n     // An AMContainer instance should already exist if an attempt is being made to preempt it\n     AMContainer amContainer = appContext.getAllContainers().get(containerId);\n     try {\n-      taskSchedulers[amContainer.getTaskSchedulerIdentifier()].deallocateContainer(containerId);\n+      // DAG can be shutting down so protect against container cleanup race\n+      if (amContainer != null) {\n+        taskSchedulers[amContainer.getTaskSchedulerIdentifier()].deallocateContainer(containerId);\n+      }\n     } catch (Exception e) {\n       String msg = \"Error in TaskScheduler when preempting container\"\n           + \", scheduler=\" + Utils.getTaskSchedulerIdentifierString(amContainer.getTaskSchedulerIdentifier(), appContext)",
                "raw_url": "https://github.com/apache/tez/raw/72c458a431545565d38681862a883065f4efa44e/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java",
                "sha": "61e3702eafc33435ef17ddf1ec99a9c823666747",
                "status": "modified"
            },
            {
                "additions": 107,
                "blob_url": "https://github.com/apache/tez/blob/72c458a431545565d38681862a883065f4efa44e/tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java",
                "changes": 108,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java?ref=72c458a431545565d38681862a883065f4efa44e",
                "deletions": 1,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java",
                "patch": "@@ -70,6 +70,7 @@\n import org.apache.tez.dag.api.TezException;\n import org.apache.tez.dag.api.UserPayload;\n import org.apache.tez.dag.api.client.DAGClientServer;\n+import org.apache.tez.dag.api.oldrecords.TaskAttemptState;\n import org.apache.tez.dag.app.AppContext;\n import org.apache.tez.dag.app.ContainerContext;\n import org.apache.tez.dag.app.ServicePluginLifecycleAbstractService;\n@@ -84,6 +85,7 @@\n import org.apache.tez.dag.app.rm.container.AMContainer;\n import org.apache.tez.dag.app.rm.container.AMContainerEventAssignTA;\n import org.apache.tez.dag.app.rm.container.AMContainerEventCompleted;\n+import org.apache.tez.dag.app.rm.container.AMContainerEventStopRequest;\n import org.apache.tez.dag.app.rm.container.AMContainerEventType;\n import org.apache.tez.dag.app.rm.container.AMContainerMap;\n import org.apache.tez.dag.app.rm.container.AMContainerState;\n@@ -217,6 +219,79 @@ public void testSimpleAllocate() throws Exception {\n     assertEquals(mockAttemptId, assignEvent.getTaskAttemptId());\n   }\n \n+  @Test(timeout = 5000)\n+  public void testTASucceededAfterContainerCleanup() throws Exception {\n+    Configuration conf = new Configuration(false);\n+    schedulerHandler.init(conf);\n+    schedulerHandler.start();\n+\n+    TaskAttemptImpl mockTaskAttempt = mock(TaskAttemptImpl.class);\n+    TezTaskAttemptID mockAttemptId = mock(TezTaskAttemptID.class);\n+    when(mockAttemptId.getId()).thenReturn(0);\n+    when(mockTaskAttempt.getID()).thenReturn(mockAttemptId);\n+    Resource resource = Resource.newInstance(1024, 1);\n+    ContainerContext containerContext =\n+        new ContainerContext(new HashMap<String, LocalResource>(), new Credentials(),\n+            new HashMap<String, String>(), \"\");\n+    int priority = 10;\n+    TaskLocationHint locHint = TaskLocationHint.createTaskLocationHint(new HashSet<String>(), null);\n+\n+    ContainerId mockCId = mock(ContainerId.class);\n+    Container container = mock(Container.class);\n+    when(container.getId()).thenReturn(mockCId);\n+\n+    AMContainer mockAMContainer = mock(AMContainer.class);\n+    when(mockAMContainer.getContainerId()).thenReturn(mockCId);\n+    when(mockAMContainer.getState()).thenReturn(AMContainerState.IDLE);\n+\n+    // Returning null container will replicate container cleanup scenario\n+    when(mockAMContainerMap.get(mockCId)).thenReturn(null);\n+\n+    AMSchedulerEventTALaunchRequest lr =\n+        new AMSchedulerEventTALaunchRequest(mockAttemptId, resource, null, mockTaskAttempt, locHint,\n+            priority, containerContext, 0, 0, 0);\n+    schedulerHandler.taskAllocated(0, mockTaskAttempt, lr, container);\n+    assertEquals(1, mockEventHandler.events.size());\n+    assertTrue(mockEventHandler.events.get(0) instanceof AMContainerEventAssignTA);\n+    AMContainerEventAssignTA assignEvent =\n+        (AMContainerEventAssignTA) mockEventHandler.events.get(0);\n+    assertEquals(priority, assignEvent.getPriority());\n+    assertEquals(mockAttemptId, assignEvent.getTaskAttemptId());\n+  }\n+\n+  @Test(timeout = 5000)\n+  public void testTAUnsuccessfulAfterContainerCleanup() throws Exception {\n+    Configuration conf = new Configuration(false);\n+    schedulerHandler.init(conf);\n+    schedulerHandler.start();\n+\n+    TaskAttemptImpl mockTaskAttempt = mock(TaskAttemptImpl.class);\n+    TezTaskAttemptID mockAttemptId = mock(TezTaskAttemptID.class);\n+    when(mockAttemptId.getId()).thenReturn(0);\n+    when(mockTaskAttempt.getID()).thenReturn(mockAttemptId);\n+\n+    ContainerId mockCId = mock(ContainerId.class);\n+    Container container = mock(Container.class);\n+    when(container.getId()).thenReturn(mockCId);\n+\n+    AMContainer mockAMContainer = mock(AMContainer.class);\n+    when(mockAMContainer.getContainerId()).thenReturn(mockCId);\n+    when(mockAMContainer.getState()).thenReturn(AMContainerState.IDLE);\n+    when(mockTaskAttempt.getAssignedContainerID()).thenReturn(mockCId);\n+\n+    // Returning null container will replicate container cleanup scenario\n+    when(mockAMContainerMap.get(mockCId)).thenReturn(null);\n+\n+    schedulerHandler.handleEvent(\n+        new AMSchedulerEventTAEnded(\n+            mockTaskAttempt, mockCId, TaskAttemptState.KILLED, null, null, 0));\n+    assertEquals(1, mockEventHandler.events.size());\n+    assertTrue(mockEventHandler.events.get(0) instanceof AMContainerEventStopRequest);\n+    AMContainerEventStopRequest stopEvent =\n+        (AMContainerEventStopRequest) mockEventHandler.events.get(0);\n+    assertEquals(mockCId, stopEvent.getContainerId());\n+  }\n+\n   @Test (timeout = 5000)\n   public void testTaskBasedAffinity() throws Exception {\n     Configuration conf = new Configuration(false);\n@@ -288,7 +363,7 @@ public void testContainerPreempted() throws IOException {\n     schedulerHandler.stop();\n     schedulerHandler.close();\n   }\n-  \n+\n   @Test (timeout = 5000)\n   public void testContainerInternalPreempted() throws IOException, ServicePluginException {\n     Configuration conf = new Configuration(false);\n@@ -318,6 +393,37 @@ public void testContainerInternalPreempted() throws IOException, ServicePluginEx\n     schedulerHandler.stop();\n     schedulerHandler.close();\n   }\n+\n+  @Test(timeout = 5000)\n+  public void testContainerInternalPreemptedAfterContainerCleanup() throws IOException, ServicePluginException {\n+    Configuration conf = new Configuration(false);\n+    schedulerHandler.init(conf);\n+    schedulerHandler.start();\n+\n+    AMContainer mockAmContainer = mock(AMContainer.class);\n+    when(mockAmContainer.getTaskSchedulerIdentifier()).thenReturn(0);\n+    when(mockAmContainer.getContainerLauncherIdentifier()).thenReturn(0);\n+    when(mockAmContainer.getTaskCommunicatorIdentifier()).thenReturn(0);\n+    ContainerId mockCId = mock(ContainerId.class);\n+    verify(mockTaskScheduler, times(0)).deallocateContainer((ContainerId) any());\n+    // Returning null container will replicate container cleanup scenario\n+    when(mockAMContainerMap.get(mockCId)).thenReturn(null);\n+    schedulerHandler.preemptContainer(0, mockCId);\n+    verify(mockTaskScheduler, times(0)).deallocateContainer(mockCId);\n+    assertEquals(1, mockEventHandler.events.size());\n+    Event event = mockEventHandler.events.get(0);\n+    assertEquals(AMContainerEventType.C_COMPLETED, event.getType());\n+    AMContainerEventCompleted completedEvent = (AMContainerEventCompleted) event;\n+    assertEquals(mockCId, completedEvent.getContainerId());\n+    assertEquals(\"Container preempted internally\", completedEvent.getDiagnostics());\n+    assertTrue(completedEvent.isPreempted());\n+    Assert.assertFalse(completedEvent.isDiskFailed());\n+    assertEquals(TaskAttemptTerminationCause.INTERNAL_PREEMPTION,\n+        completedEvent.getTerminationCause());\n+\n+    schedulerHandler.stop();\n+    schedulerHandler.close();\n+  }\n   \n   @Test (timeout = 5000)\n   public void testContainerDiskFailed() throws IOException {",
                "raw_url": "https://github.com/apache/tez/raw/72c458a431545565d38681862a883065f4efa44e/tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java",
                "sha": "dcf9a5dd698c2b06e2ea9515aefdd83781d9d6de",
                "status": "modified"
            }
        ],
        "message": "TEZ-3932. TaskSchedulerManager can throw NullPointerException during DAGAppMaster container cleanup race (Jonathan Eagles via jlowe)",
        "parent": "https://github.com/apache/tez/commit/081a64f716a73a5f65c8d74e6ab729e57b0747bc",
        "patched_files": [
            "TaskSchedulerManager.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskSchedulerManager.java"
        ]
    },
    "tez_75bc7c1": {
        "bug_id": "tez_75bc7c1",
        "commit": "https://github.com/apache/tez/commit/75bc7c157682cc64eccfa4722226a8ac72161f17",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/tez/blob/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java?ref=75bc7c157682cc64eccfa4722226a8ac72161f17",
                "deletions": 4,
                "filename": "tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java",
                "patch": "@@ -807,10 +807,16 @@ static ConfigurationProto createFinalConfProtoForApp(Configuration amConf,\n     assert amConf != null;\n     ConfigurationProto.Builder builder = ConfigurationProto.newBuilder();\n     for (Entry<String, String> entry : amConf) {\n-      PlanKeyValuePair.Builder kvp = PlanKeyValuePair.newBuilder();\n-      kvp.setKey(entry.getKey());\n-      kvp.setValue(amConf.get(entry.getKey()));\n-      builder.addConfKeyValues(kvp);\n+      String key = entry.getKey();\n+      String val = amConf.get(key);\n+      if(val != null) {\n+        PlanKeyValuePair.Builder kvp = PlanKeyValuePair.newBuilder();\n+        kvp.setKey(key);\n+        kvp.setValue(val);\n+        builder.addConfKeyValues(kvp);\n+      } else {\n+        LOG.debug(\"null value in Configuration after replacement for key={}. Skipping.\", key);\n+      }\n     }\n \n     AMPluginDescriptorProto pluginDescriptorProto =",
                "raw_url": "https://github.com/apache/tez/raw/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java",
                "sha": "689d94797adc384eefd4d8394fef62ffd7ce650f",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/tez/blob/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/main/java/org/apache/tez/common/TezUtils.java",
                "changes": 38,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-api/src/main/java/org/apache/tez/common/TezUtils.java?ref=75bc7c157682cc64eccfa4722226a8ac72161f17",
                "deletions": 11,
                "filename": "tez-api/src/main/java/org/apache/tez/common/TezUtils.java",
                "patch": "@@ -134,16 +134,8 @@ public static Configuration createConfFromUserPayload(UserPayload payload) throw\n \n \n   private static void writeConfInPB(OutputStream dos, Configuration conf) throws IOException {\n-    DAGProtos.ConfigurationProto.Builder confProtoBuilder = DAGProtos.ConfigurationProto\n-        .newBuilder();\n-    Iterator<Map.Entry<String, String>> iter = conf.iterator();\n-    while (iter.hasNext()) {\n-      Map.Entry<String, String> entry = iter.next();\n-      DAGProtos.PlanKeyValuePair.Builder kvp = DAGProtos.PlanKeyValuePair.newBuilder();\n-      kvp.setKey(entry.getKey());\n-      kvp.setValue(entry.getValue());\n-      confProtoBuilder.addConfKeyValues(kvp);\n-    }\n+    DAGProtos.ConfigurationProto.Builder confProtoBuilder = DAGProtos.ConfigurationProto.newBuilder();\n+    populateConfProtoFromEntries(conf, confProtoBuilder);\n     DAGProtos.ConfigurationProto confProto = confProtoBuilder.build();\n     confProto.writeTo(dos);\n   }\n@@ -167,7 +159,13 @@ public static String convertToHistoryText(String description, Configuration conf\n         Iterator<Entry<String, String>> iter = conf.iterator();\n         while (iter.hasNext()) {\n           Entry<String, String> entry = iter.next();\n-          confJson.put(entry.getKey(), conf.get(entry.getKey()));\n+          String key = entry.getKey();\n+          String val = conf.get(entry.getKey());\n+          if(val != null) {\n+            confJson.put(key, val);\n+          } else {\n+            LOG.debug(\"null value in Configuration after replacement for key={}. Skipping.\", key);\n+          }\n         }\n         jsonObject.put(ATSConstants.CONFIG, confJson);\n       }\n@@ -181,4 +179,22 @@ public static String convertToHistoryText(Configuration conf) {\n     return convertToHistoryText(null, conf);\n   }\n \n+\n+  /* Copy each Map.Entry with non-null value to DAGProtos.ConfigurationProto */\n+  public static void populateConfProtoFromEntries(Iterable<Map.Entry<String, String>> params,\n+                                              DAGProtos.ConfigurationProto.Builder confBuilder) {\n+    for(Map.Entry<String, String> entry : params) {\n+      String key = entry.getKey();\n+      String val = entry.getValue();\n+      if(val != null) {\n+        DAGProtos.PlanKeyValuePair.Builder kvp = DAGProtos.PlanKeyValuePair.newBuilder();\n+        kvp.setKey(key);\n+        kvp.setValue(val);\n+        confBuilder.addConfKeyValues(kvp);\n+      } else {\n+        LOG.debug(\"null value for key={}. Skipping.\", key);\n+      }\n+    }\n+  }\n+\n }",
                "raw_url": "https://github.com/apache/tez/raw/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/main/java/org/apache/tez/common/TezUtils.java",
                "sha": "efd450290fde8374de1bd57ac3f457a9a50490d8",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/main/java/org/apache/tez/dag/api/DAG.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-api/src/main/java/org/apache/tez/dag/api/DAG.java?ref=75bc7c157682cc64eccfa4722226a8ac72161f17",
                "deletions": 12,
                "filename": "tez-api/src/main/java/org/apache/tez/dag/api/DAG.java",
                "patch": "@@ -41,6 +41,7 @@\n import org.apache.hadoop.yarn.util.ConverterUtils;\n import org.apache.tez.client.CallerContext;\n import org.apache.tez.common.JavaOptsChecker;\n+import org.apache.tez.common.TezUtils;\n import org.apache.tez.dag.api.Vertex.VertexExecutionContext;\n import org.apache.tez.dag.api.records.DAGProtos;\n import org.apache.tez.serviceplugins.api.ServicePluginsDescriptor;\n@@ -985,12 +986,7 @@ public synchronized DAGPlan createDag(Configuration tezConf, Credentials extraCr\n \n       if (vertex.getConf()!= null && vertex.getConf().size() > 0) {\n         ConfigurationProto.Builder confBuilder = ConfigurationProto.newBuilder();\n-        for (Map.Entry<String, String> entry : vertex.getConf().entrySet()) {\n-          PlanKeyValuePair.Builder keyValueBuilder = PlanKeyValuePair.newBuilder();\n-          keyValueBuilder.setKey(entry.getKey());\n-          keyValueBuilder.setValue(entry.getValue());\n-          confBuilder.addConfKeyValues(keyValueBuilder);\n-        }\n+        TezUtils.populateConfProtoFromEntries(vertex.getConf().entrySet(), confBuilder);\n         vertexBuilder.setVertexConf(confBuilder);\n       }\n \n@@ -1091,12 +1087,7 @@ public synchronized DAGPlan createDag(Configuration tezConf, Credentials extraCr\n \n     ConfigurationProto.Builder confProtoBuilder = ConfigurationProto.newBuilder();\n     if (!this.dagConf.isEmpty()) {\n-      for (Entry<String, String> entry : this.dagConf.entrySet()) {\n-        PlanKeyValuePair.Builder kvp = PlanKeyValuePair.newBuilder();\n-        kvp.setKey(entry.getKey());\n-        kvp.setValue(entry.getValue());\n-        confProtoBuilder.addConfKeyValues(kvp);\n-      }\n+      TezUtils.populateConfProtoFromEntries(this.dagConf.entrySet(), confProtoBuilder);\n     }\n     // Copy historyLogLevel from tezConf into dagConf if its not overridden in dagConf.\n     String logLevel = this.dagConf.get(TezConfiguration.TEZ_HISTORY_LOGGING_LOGLEVEL);",
                "raw_url": "https://github.com/apache/tez/raw/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/main/java/org/apache/tez/dag/api/DAG.java",
                "sha": "735c749ee5e7b45a9ca42ccda7879e90f5273a57",
                "status": "modified"
            },
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/tez/blob/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/test/java/org/apache/tez/client/TestTezClient.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-api/src/test/java/org/apache/tez/client/TestTezClient.java?ref=75bc7c157682cc64eccfa4722226a8ac72161f17",
                "deletions": 0,
                "filename": "tez-api/src/test/java/org/apache/tez/client/TestTezClient.java",
                "patch": "@@ -90,6 +90,7 @@\n import org.apache.tez.dag.api.client.rpc.DAGClientAMProtocolRPC.ShutdownSessionRequestProto;\n import org.apache.tez.dag.api.client.rpc.DAGClientAMProtocolRPC.SubmitDAGRequestProto;\n import org.apache.tez.dag.api.client.rpc.DAGClientAMProtocolRPC.TezAppMasterStatusProto;\n+import org.apache.tez.dag.api.records.DAGProtos.ConfigurationProto;\n import org.apache.tez.serviceplugins.api.ServicePluginsDescriptor;\n import org.hamcrest.CoreMatchers;\n import org.junit.Assert;\n@@ -927,4 +928,16 @@ public void testAMHeartbeatFailOnGetAMStatus() throws Exception {\n     Thread.sleep(3 * amHeartBeatTimeoutSecs * 1000);\n     assertTrue(client.getAMKeepAliveService().isTerminated());\n   }\n+\n+  //See TEZ-3874\n+  @Test(timeout = 5000)\n+  public void testYarnZkDeprecatedConf() {\n+    Configuration conf = new Configuration(false);\n+    String val = \"hostname:2181\";\n+    conf.set(\"yarn.resourcemanager.zk-address\", val);\n+\n+    ConfigurationProto confProto = null;\n+    //Test that Exception is not thrown by createFinalConfProtoForApp\n+    TezClientUtils.createFinalConfProtoForApp(conf, null);\n+  }\n }",
                "raw_url": "https://github.com/apache/tez/raw/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-api/src/test/java/org/apache/tez/client/TestTezClient.java",
                "sha": "2c0406153fd5fbc8299b2b8ea34fb30d5c201b74",
                "status": "modified"
            },
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/tez/blob/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-common/src/test/java/org/apache/tez/common/TestTezUtils.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-common/src/test/java/org/apache/tez/common/TestTezUtils.java?ref=75bc7c157682cc64eccfa4722226a8ac72161f17",
                "deletions": 0,
                "filename": "tez-common/src/test/java/org/apache/tez/common/TestTezUtils.java",
                "patch": "@@ -20,14 +20,19 @@\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertEquals;\n \n import java.io.IOException;\n import java.util.BitSet;\n+import java.util.HashMap;\n+import java.util.Map;\n import java.util.Random;\n \n import org.apache.hadoop.conf.Configuration;\n import org.apache.tez.dag.api.TezConfiguration;\n import org.apache.tez.dag.api.UserPayload;\n+import org.apache.tez.dag.api.records.DAGProtos;\n import org.codehaus.jettison.json.JSONException;\n import org.codehaus.jettison.json.JSONObject;\n import org.junit.Assert;\n@@ -230,4 +235,14 @@ public void testConvertToHistoryTextWithReplaceVars() throws JSONException {\n \n   }\n \n+  @Test(timeout = 5000)\n+  public void testPopulateConfProtoFromEntries() {\n+      Map<String, String> map = new HashMap<>();\n+      map.put(\"nonNullKey\", \"value\");\n+      map.put(\"nullKey\", null);\n+      DAGProtos.ConfigurationProto.Builder confBuilder = DAGProtos.ConfigurationProto.newBuilder();\n+      TezUtils.populateConfProtoFromEntries(map.entrySet(), confBuilder);\n+      assertEquals(confBuilder.getConfKeyValuesList().size(), 1);\n+  }\n+\n }",
                "raw_url": "https://github.com/apache/tez/raw/75bc7c157682cc64eccfa4722226a8ac72161f17/tez-common/src/test/java/org/apache/tez/common/TestTezUtils.java",
                "sha": "16efc8f52da2a377671295b46d55ab465973d0f6",
                "status": "modified"
            }
        ],
        "message": "TEZ-3874. NPE in TezClientUtils when \"yarn.resourcemanager.zk-address\" is present in Configuration. (Eric Wohlstadter via jlowe)",
        "parent": "https://github.com/apache/tez/commit/82d73b380881ef8e7d6e6c963289c4f479bbea59",
        "patched_files": [
            "DAG.java",
            "TezClientUtils.java",
            "TezUtils.java",
            "TezClient.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestDAG.java",
            "TestTezClientUtils.java",
            "TestTezUtils.java",
            "TestTezClient.java"
        ]
    },
    "tez_8a3dcf4": {
        "bug_id": "tez_8a3dcf4",
        "commit": "https://github.com/apache/tez/commit/8a3dcf4763ad1eaefd0b6d08685a3ade91977324",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/tez/blob/8a3dcf4763ad1eaefd0b6d08685a3ade91977324/tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java?ref=8a3dcf4763ad1eaefd0b6d08685a3ade91977324",
                "deletions": 3,
                "filename": "tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java",
                "patch": "@@ -364,9 +364,16 @@ static ApplicationSubmissionContext createApplicationSubmissionContext(\n     if(dag != null) {\n \n       for (Vertex v : dag.getVertices()) {\n+        if (v.getTaskLocalResources() == null) {\n+          v.setTaskLocalResources(new TreeMap<String, LocalResource>());\n+        }\n         v.getTaskLocalResources().putAll(tezJarResources);\n         v.getTaskLocalResources().put(TezConfiguration.TEZ_PB_BINARY_CONF_NAME,\n             binaryConfLRsrc);\n+\n+        if (v.getTaskEnvironment() == null) {\n+          v.setTaskEnvironment(new TreeMap<String, String>());\n+        }\n         Map<String, String> taskEnv = v.getTaskEnvironment();\n         for (Map.Entry<String, String> entry : environment.entrySet()) {\n           String key = entry.getKey();\n@@ -399,9 +406,9 @@ static ApplicationSubmissionContext createApplicationSubmissionContext(\n       }\n \n       localResources.put(TezConfiguration.TEZ_PB_PLAN_BINARY_NAME,\n-          TezClientUtils.createLocalResource(fs,\n-              binaryPath, LocalResourceType.FILE,\n-              LocalResourceVisibility.APPLICATION));\n+        TezClientUtils.createLocalResource(fs,\n+          binaryPath, LocalResourceType.FILE,\n+          LocalResourceVisibility.APPLICATION));\n \n       if (Level.DEBUG.isGreaterOrEqual(Level.toLevel(amLogLevel))) {\n         Path textPath = localizeDagPlanAsText(dagPB, fs,",
                "raw_url": "https://github.com/apache/tez/raw/8a3dcf4763ad1eaefd0b6d08685a3ade91977324/tez-api/src/main/java/org/apache/tez/client/TezClientUtils.java",
                "sha": "042ff91885e232ddf6a15a2ee127a020b0c46823",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/8a3dcf4763ad1eaefd0b6d08685a3ade91977324/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskScheduler.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskScheduler.java?ref=8a3dcf4763ad1eaefd0b6d08685a3ade91977324",
                "deletions": 1,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskScheduler.java",
                "patch": "@@ -670,7 +670,7 @@ public void onContainersAllocated(List<Container> containers) {\n             boolean safeToRelease = true;\n             Priority topPendingPriority = amRmClient.getTopPriority();\n             Priority containerPriority = heldContainer.container.getPriority();\n-            if (topPendingPriority != null && \n+            if (isNew && topPendingPriority != null &&\n                 containerPriority.compareTo(topPendingPriority) < 0) {\n               // this container is of lower priority and given to us by the RM for\n               // a task that will be matched after the current top priority. Keep ",
                "raw_url": "https://github.com/apache/tez/raw/8a3dcf4763ad1eaefd0b6d08685a3ade91977324/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskScheduler.java",
                "sha": "6eedb15adab8267cc86ce5fd8cb42609a6ce8e0a",
                "status": "modified"
            }
        ],
        "message": "TEZ-615. OrderedWordCount with -DUSE_TEZ_SESSION=false throws NPE. (hitesh)",
        "parent": "https://github.com/apache/tez/commit/d4bb730eaa4b8b793b2c7f8b08e1faa50ed566e8",
        "patched_files": [
            "TaskScheduler.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskScheduler.java"
        ]
    },
    "tez_968e31f": {
        "bug_id": "tez_968e31f",
        "commit": "https://github.com/apache/tez/commit/968e31f96e41ce4c4e7717c6264e70e627f99837",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/968e31f96e41ce4c4e7717c6264e70e627f99837/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java?ref=968e31f96e41ce4c4e7717c6264e70e627f99837",
                "deletions": 4,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "patch": "@@ -250,6 +250,9 @@\n               EnumSet.of(VertexState.TERMINATING, VertexState.KILLED, VertexState.FAILED),\n               VertexEventType.V_TASK_COMPLETED,\n               new TaskCompletedTransition())\n+          .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n+              VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n+              TASK_ATTEMPT_COMPLETED_EVENT_TRANSITION) // TODO shouldnt be done for KILL_WAIT vertex\n           .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n               VertexEventType.V_SOURCE_TASK_ATTEMPT_COMPLETED,\n               SOURCE_TASK_ATTEMPT_COMPLETED_EVENT_TRANSITION)\n@@ -260,7 +263,6 @@\n           // Ignore-able events\n           .addTransition(VertexState.TERMINATING, VertexState.TERMINATING,\n               EnumSet.of(VertexEventType.V_TERMINATE,\n-                  VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n                   VertexEventType.V_TASK_RESCHEDULED))\n \n           // Transitions from SUCCEEDED state\n@@ -299,7 +301,6 @@\n           // Ignore-able events\n           .addTransition(VertexState.KILLED, VertexState.KILLED,\n               EnumSet.of(VertexEventType.V_TERMINATE,\n-                  VertexEventType.V_SOURCE_VERTEX_STARTED,\n                   VertexEventType.V_START,\n                   VertexEventType.V_TASK_RESCHEDULED,\n                   VertexEventType.V_TASK_ATTEMPT_COMPLETED,\n@@ -310,8 +311,6 @@\n               VertexState.ERROR,\n               VertexState.ERROR,\n               EnumSet.of(VertexEventType.V_INIT,\n-                  VertexEventType.V_SOURCE_VERTEX_STARTED,\n-                  VertexEventType.V_START,\n                   VertexEventType.V_TERMINATE,\n                   VertexEventType.V_TASK_COMPLETED,\n                   VertexEventType.V_TASK_ATTEMPT_COMPLETED,",
                "raw_url": "https://github.com/apache/tez/raw/968e31f96e41ce4c4e7717c6264e70e627f99837/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "sha": "67523284ecd9677245093934878a0ae22b114cae",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/tez/blob/968e31f96e41ce4c4e7717c6264e70e627f99837/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java?ref=968e31f96e41ce4c4e7717c6264e70e627f99837",
                "deletions": 7,
                "filename": "tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "patch": "@@ -98,14 +98,13 @@ public void run(Map<String, LogicalInput> inputs,\n     OnFileUnorderedKVOutput kvOutput = (OnFileUnorderedKVOutput) lo;\n \n     Configuration updatedConf = mrInput.getConfigUpdates();\n+    String fileName = updatedConf.get(MRJobConfig.MAP_INPUT_FILE);\n+    LOG.info(\"Processing file: \" + fileName);\n     Text srcFile = new Text();\n-    srcFile.set(\"UNKNOWN_FILENAME_IN_PROCESSOR\");\n-    if (updatedConf != null) {\n-      String fileName = updatedConf.get(MRJobConfig.MAP_INPUT_FILE);\n-      if (fileName != null) {\n-        LOG.info(\"Processing file: \" + fileName);\n-        srcFile.set(fileName);\n-      }\n+    if (fileName == null) {\n+      srcFile.set(\"UNKNOWN_FILENAME_IN_PROCESSOR\");\n+    } else {\n+      srcFile.set(fileName);\n     }\n \n     KVReader kvReader = mrInput.getReader();",
                "raw_url": "https://github.com/apache/tez/raw/968e31f96e41ce4c4e7717c6264e70e627f99837/tez-mapreduce-examples/src/main/java/org/apache/tez/processor/FilterByWordInputProcessor.java",
                "sha": "e8e315a536113b35b3ca2b2e337ee19ef206ba37",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/968e31f96e41ce4c4e7717c6264e70e627f99837/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java?ref=968e31f96e41ce4c4e7717c6264e70e627f99837",
                "deletions": 1,
                "filename": "tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "patch": "@@ -209,7 +209,7 @@ public void setNumPhysicalInputs(int numInputs) {\n    * @return the additional fields set by {@link MRInput}\n    */\n   public Configuration getConfigUpdates() {\n-    return incrementalConf;\n+    return new Configuration(incrementalConf);\n   }\n \n   public float getProgress() throws IOException, InterruptedException {",
                "raw_url": "https://github.com/apache/tez/raw/968e31f96e41ce4c4e7717c6264e70e627f99837/tez-mapreduce/src/main/java/org/apache/tez/mapreduce/input/MRInput.java",
                "sha": "b9f22421a40857c4f1117cefe25bcf8e7f57b725",
                "status": "modified"
            }
        ],
        "message": "Revert \"TEZ-510. Test MRRJobs failing with NPE (bikas)\"\n\nThis reverts commit 1795ea84fc899f5e522680119b1853f559030a14.",
        "parent": "https://github.com/apache/tez/commit/1795ea84fc899f5e522680119b1853f559030a14",
        "patched_files": [
            "VertexImpl.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestVertexImpl.java"
        ]
    },
    "tez_971e095": {
        "bug_id": "tez_971e095",
        "commit": "https://github.com/apache/tez/commit/971e0957a1302e20fe241b4aeac278dc87111257",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/971e0957a1302e20fe241b4aeac278dc87111257/TEZ-2003-CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/TEZ-2003-CHANGES.txt?ref=971e0957a1302e20fe241b4aeac278dc87111257",
                "deletions": 0,
                "filename": "TEZ-2003-CHANGES.txt",
                "patch": "@@ -27,5 +27,6 @@ ALL CHANGES:\n   TEZ-2434. Allow tasks to be killed in the Runtime.\n   TEZ-2443. TaskRunner2 should call abort, NPEs while cleaning up tasks.\n   TEZ-2465. Retrun the status of a kill request in TaskRunner2.\n+  TEZ-2471. NPE in LogicalIOProcessorRuntimeTask while printing thread info.\n \n INCOMPATIBLE CHANGES:",
                "raw_url": "https://github.com/apache/tez/raw/971e0957a1302e20fe241b4aeac278dc87111257/TEZ-2003-CHANGES.txt",
                "sha": "d651960646bbcc697affa3d0d32a484e1efbe45a",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/tez/blob/971e0957a1302e20fe241b4aeac278dc87111257/tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java?ref=971e0957a1302e20fe241b4aeac278dc87111257",
                "deletions": 1,
                "filename": "tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java",
                "patch": "@@ -936,7 +936,10 @@ void printThreads() {\n     long[] threadIds = threadMXBean.getAllThreadIds();\n     for (Long id : threadIds) {\n       ThreadInfo threadInfo = threadMXBean.getThreadInfo(id);\n-      LOG.info(\"ThreadId : \" + id + \", name=\" + threadInfo.getThreadName());\n+      // The thread could have been shutdown before we read info about it.\n+      if (threadInfo != null) {\n+        LOG.debug(\"ThreadId : \" + id + \", name=\" + threadInfo.getThreadName());\n+      }\n     }\n   }\n   ",
                "raw_url": "https://github.com/apache/tez/raw/971e0957a1302e20fe241b4aeac278dc87111257/tez-runtime-internals/src/main/java/org/apache/tez/runtime/LogicalIOProcessorRuntimeTask.java",
                "sha": "449fa0fc7100e2a18291e7ce675d91510db9b5aa",
                "status": "modified"
            }
        ],
        "message": "TEZ-2471. NPE in LogicalIOProcessorRuntimeTask while printing thread info. (sseth)",
        "parent": "https://github.com/apache/tez/commit/9e6bd7c8025c63cd919b94cf7a99137f2fc253b6",
        "patched_files": [
            "TEZ-2003-CHANGES.txt",
            "LogicalIOProcessorRuntimeTask.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestLogicalIOProcessorRuntimeTask.java"
        ]
    },
    "tez_97e1d86": {
        "bug_id": "tez_97e1d86",
        "commit": "https://github.com/apache/tez/commit/97e1d867d961c5ae277a00f55757b29bd7f82a87",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/97e1d867d961c5ae277a00f55757b29bd7f82a87/CHANGES.txt",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=97e1d867d961c5ae277a00f55757b29bd7f82a87",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -7,6 +7,7 @@ Release 0.8.1: Unreleased\n INCOMPATIBLE CHANGES\n \n ALL CHANGES:\n+  TEZ-2855. Fix a potential NPE while routing VertexManager events.\n   TEZ-2758. Remove append API in RecoveryService after TEZ-1909.\n   TEZ-2851. Support a way for upstream applications to pass in a caller context to Tez.\n   TEZ-2859. TestMergeManager.testLocalDiskMergeMultipleTasks failing\n@@ -196,6 +197,7 @@ Release 0.7.1: Unreleased\n INCOMPATIBLE CHANGES\n \n ALL CHANGES\n+  TEZ-2855. Fix a potential NPE while routing VertexManager events.\n   TEZ-2758. Remove append API in RecoveryService after TEZ-1909.\n   TEZ-2851. Support a way for upstream applications to pass in a caller context to Tez.\n   TEZ-2858. Stop using System.currentTimeMillis in TestInputReadyTracker.\n@@ -468,6 +470,7 @@ Release 0.6.3: Unreleased\n INCOMPATIBLE CHANGES\n \n ALL CHANGES:\n+  TEZ-2855. Fix a potential NPE while routing VertexManager events.\n   TEZ-2716. DefaultSorter.isRleNeeded not thread safe\n   TEZ-2758. Remove append API in RecoveryService after TEZ-1909.\n   TEZ-2851. Support a way for upstream applications to pass in a caller context to Tez.",
                "raw_url": "https://github.com/apache/tez/raw/97e1d867d961c5ae277a00f55757b29bd7f82a87/CHANGES.txt",
                "sha": "8e1c1b3e784eb4e73b3927dd3215067e476f5254",
                "status": "modified"
            },
            {
                "additions": 21,
                "blob_url": "https://github.com/apache/tez/blob/97e1d867d961c5ae277a00f55757b29bd7f82a87/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java?ref=97e1d867d961c5ae277a00f55757b29bd7f82a87",
                "deletions": 3,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "patch": "@@ -288,6 +288,9 @@\n \n   @VisibleForTesting\n   final List<TezEvent> pendingInitializerEvents = new LinkedList<TezEvent>();\n+\n+  @VisibleForTesting\n+  final List<VertexManagerEvent> pendingVmEvents = new LinkedList<>();\n   \n   LegacySpeculator speculator;\n \n@@ -721,8 +724,8 @@ private void augmentStateMachine() {\n   private final ProcessorDescriptor processorDescriptor;\n   \n   private boolean vertexToBeReconfiguredByManager = false;\n-  AtomicBoolean vmIsInitialized = new AtomicBoolean(false);\n-  AtomicBoolean completelyConfiguredSent = new AtomicBoolean(false);\n+  final AtomicBoolean vmIsInitialized = new AtomicBoolean(false);\n+  final AtomicBoolean completelyConfiguredSent = new AtomicBoolean(false);\n \n   @VisibleForTesting\n   Map<Vertex, Edge> sourceVertices;\n@@ -2543,6 +2546,16 @@ private VertexState setupVertex(VertexInitializedEvent event) {\n     try {\n       vertexManager.initialize();\n       vmIsInitialized.set(true);\n+      if (!pendingVmEvents.isEmpty()) {\n+        if (LOG.isDebugEnabled()) {\n+          LOG.debug(\"Processing: \" + pendingVmEvents.size() + \" pending VMEvents for Vertex: \" +\n+              logIdentifier);\n+        }\n+        for (VertexManagerEvent vmEvent : pendingVmEvents) {\n+          vertexManager.onVertexManagerEventReceived(vmEvent);\n+        }\n+        pendingVmEvents.clear();\n+      }\n     } catch (AMUserCodeException e) {\n       String msg = \"Exception in \" + e.getSource()+ \", vertex:\" + logIdentifier;\n       LOG.error(msg, e);\n@@ -4506,7 +4519,12 @@ private void handleRoutedTezEvents(List<TezEvent> tezEvents, boolean recovered,\n               getTaskAttemptIdentifier(dag.getName(), getName(), srcTaId));\n         }\n         if (target == this) {\n-          vertexManager.onVertexManagerEventReceived(vmEvent);\n+          if (!vmIsInitialized.get()) {\n+            // The VM hasn't been setup yet, defer event consumption\n+            pendingVmEvents.add(vmEvent);\n+          } else {\n+            vertexManager.onVertexManagerEventReceived(vmEvent);\n+          }\n         } else {\n           checkEventSourceMetadata(this, sourceMeta);\n           eventHandler.handle(new VertexEventRouteEvent(target",
                "raw_url": "https://github.com/apache/tez/raw/97e1d867d961c5ae277a00f55757b29bd7f82a87/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "sha": "af55049e701cf7fcb04eb90ef17a3f80bbeb881c",
                "status": "modified"
            },
            {
                "additions": 171,
                "blob_url": "https://github.com/apache/tez/blob/97e1d867d961c5ae277a00f55757b29bd7f82a87/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java",
                "changes": 172,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java?ref=97e1d867d961c5ae277a00f55757b29bd7f82a87",
                "deletions": 1,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java",
                "patch": "@@ -20,6 +20,7 @@\n \n import java.nio.ByteBuffer;\n \n+import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertTrue;\n import static org.mockito.Matchers.any;\n import static org.mockito.Matchers.anyInt;\n@@ -41,6 +42,7 @@\n import java.util.Map;\n import java.util.concurrent.Callable;\n import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.locks.Condition;\n import java.util.concurrent.locks.ReentrantLock;\n \n@@ -432,7 +434,92 @@ private DAGPlan createInvalidDAGPlan() {\n         .build();\n     return dag;\n   }\n-  \n+\n+  // Simple dag with a CountingVM on v3 (which has v1, v2 as inputs)\n+  // v1, v2 -> v3\n+  private DAGPlan createDAGPlanWithCountingVM() {\n+    LOG.info(\"Setting up dag plan with coutning VertexManager\");\n+    DAGPlan dag = DAGPlan.newBuilder()\n+        .setName(\"dagWithCountingVM\")\n+        .addVertex(\n+            VertexPlan.newBuilder()\n+                .setName(\"vertex1\")\n+                .setType(PlanVertexType.NORMAL)\n+                .setTaskConfig(\n+                    PlanTaskConfiguration.newBuilder()\n+                        .setNumTasks(1)\n+                        .setVirtualCores(4)\n+                        .setMemoryMb(1024)\n+                        .setJavaOpts(\"\")\n+                        .setTaskModule(\"x1.y1\")\n+                        .build()\n+                )\n+                .addOutEdgeId(\"e1\")\n+                .build()\n+        )\n+        .addVertex(\n+            VertexPlan.newBuilder()\n+                .setName(\"vertex2\")\n+                .setType(PlanVertexType.NORMAL)\n+                .setTaskConfig(\n+                    PlanTaskConfiguration.newBuilder()\n+                        .setNumTasks(1)\n+                        .setVirtualCores(4)\n+                        .setMemoryMb(1024)\n+                        .setJavaOpts(\"\")\n+                        .setTaskModule(\"x2.y2\")\n+                        .build()\n+                )\n+                .addOutEdgeId(\"e2\")\n+                .build()\n+        )\n+        .addVertex(\n+            VertexPlan.newBuilder()\n+                .setName(\"vertex3\")\n+                .setType(PlanVertexType.NORMAL)\n+                .setTaskConfig(\n+                    PlanTaskConfiguration.newBuilder()\n+                        .setNumTasks(1)\n+                        .setVirtualCores(4)\n+                        .setMemoryMb(1024)\n+                        .setJavaOpts(\"\")\n+                        .setTaskModule(\"x3.y3\")\n+                        .build()\n+                )\n+                .addInEdgeId(\"e1\")\n+                .addInEdgeId(\"e2\")\n+                .setVertexManagerPlugin(TezEntityDescriptorProto.newBuilder()\n+                    .setClassName(InvocationCountingVertexManager.class.getName()))\n+                .build()\n+        )\n+        .addEdge(\n+            EdgePlan.newBuilder()\n+                .setEdgeDestination(TezEntityDescriptorProto.newBuilder().setClassName(\"v1_v2\"))\n+                .setInputVertexName(\"vertex1\")\n+                .setEdgeSource(TezEntityDescriptorProto.newBuilder().setClassName(\"o2\"))\n+                .setOutputVertexName(\"vertex3\")\n+                .setDataMovementType(PlanEdgeDataMovementType.BROADCAST)\n+                .setId(\"e1\")\n+                .setDataSourceType(PlanEdgeDataSourceType.PERSISTED)\n+                .setSchedulingType(PlanEdgeSchedulingType.SEQUENTIAL)\n+                .build()\n+        )\n+        .addEdge(\n+            EdgePlan.newBuilder()\n+                .setEdgeDestination(TezEntityDescriptorProto.newBuilder().setClassName(\"v1_v3\"))\n+                .setInputVertexName(\"vertex2\")\n+                .setEdgeSource(TezEntityDescriptorProto.newBuilder().setClassName(\"o2\"))\n+                .setOutputVertexName(\"vertex3\")\n+                .setDataMovementType(PlanEdgeDataMovementType.BROADCAST)\n+                .setId(\"e2\")\n+                .setDataSourceType(PlanEdgeDataSourceType.PERSISTED)\n+                .setSchedulingType(PlanEdgeSchedulingType.SEQUENTIAL)\n+                .build()\n+        )\n+        .build();\n+    return dag;\n+  }\n+\n   /**\n    * v1 -> v2\n    */\n@@ -5815,6 +5902,63 @@ VertexManagerEvent getVertexManagerEvent(long[] sizes, long totalSize, String ve\n     return vmEvent;\n   }\n \n+  @Test(timeout = 5000)\n+  public void testVMEventBeforeVertexInitialized() throws Exception {\n+    useCustomInitializer = true;\n+    setupPreDagCreation();\n+    dagPlan = createDAGPlanWithCountingVM();\n+    setupPostDagCreation();\n+\n+    VertexImpl v1 = vertices.get(\"vertex1\");\n+    VertexImpl v2 = vertices.get(\"vertex2\");\n+    VertexImpl v3 = vertices.get(\"vertex3\");\n+    dispatcher.getEventHandler().handle(new VertexEvent(v1.getVertexId(),\n+        VertexEventType.V_INIT));\n+    dispatcher.await();\n+    assertEquals(VertexState.INITED, v1.getState());\n+    dispatcher.getEventHandler().handle(new VertexEvent(v1.getVertexId(), VertexEventType.V_START));\n+    dispatcher.await();\n+    assertEquals(VertexState.RUNNING, v1.getState());\n+\n+    assertEquals(VertexState.NEW, v3.getState());\n+    // Generate a VM event for v1, targeted at v3\n+    VertexManagerEvent vmEvent = VertexManagerEvent.create(\"vertex3\", ByteBuffer.wrap(new byte[0]));\n+    TezEvent tezVmEvent = new TezEvent(vmEvent,\n+        new EventMetaData(EventProducerConsumerType.OUTPUT, \"vertex1\", null,\n+            TezTaskAttemptID.getInstance(\n+                TezTaskID.getInstance(v1.getVertexId(), 1), 1)));\n+    dispatcher.getEventHandler()\n+        .handle(new VertexEventRouteEvent(v1.getVertexId(), Collections.singletonList(tezVmEvent)));\n+    dispatcher.await();\n+\n+    assertEquals(1, v3.pendingVmEvents.size());\n+    assertEquals(0, InvocationCountingVertexManager.numVmEventsReceived.get());\n+\n+    // Initialize v2, which will trigger initialization of v3\n+    dispatcher.getEventHandler().handle(new VertexEvent(v2.getVertexId(),\n+        VertexEventType.V_INIT));\n+    dispatcher.await();\n+\n+    assertEquals(VertexState.INITED, v3.getState());\n+\n+    // The VM event should have been processed.\n+    assertEquals(0, v3.pendingVmEvents.size());\n+    assertEquals(1, InvocationCountingVertexManager.numVmEventsReceived.get());\n+\n+    // Send another VM event - make sure it's processed without additional events.\n+    vmEvent = VertexManagerEvent.create(\"vertex3\", ByteBuffer.wrap(new byte[0]));\n+    tezVmEvent = new TezEvent(vmEvent,\n+        new EventMetaData(EventProducerConsumerType.OUTPUT, \"vertex1\", null,\n+            TezTaskAttemptID.getInstance(\n+                TezTaskID.getInstance(v1.getVertexId(), 1), 2)));\n+    dispatcher.getEventHandler()\n+        .handle(new VertexEventRouteEvent(v1.getVertexId(), Collections.singletonList(tezVmEvent)));\n+    dispatcher.await();\n+\n+    assertEquals(0, v3.pendingVmEvents.size());\n+    assertEquals(2, InvocationCountingVertexManager.numVmEventsReceived.get());\n+  }\n+\n   @Test(timeout = 5000)\n   public void testExceptionFromVM_Initialize() throws TezException {\n     useCustomInitializer = true;\n@@ -6316,6 +6460,32 @@ public void handleInputInitializerEvent(List<InputInitializerEvent> events) thro\n     }\n   }\n \n+  public static class InvocationCountingVertexManager extends VertexManagerPlugin {\n+\n+    static final AtomicInteger numVmEventsReceived = new AtomicInteger(0);\n+    static final AtomicInteger numInitializedInputs = new AtomicInteger(0);\n+\n+    public InvocationCountingVertexManager(VertexManagerPluginContext context) {\n+      super(context);\n+    }\n+\n+    @Override\n+    public void initialize() throws Exception {\n+\n+    }\n+\n+    @Override\n+    public void onVertexManagerEventReceived(VertexManagerEvent vmEvent) throws Exception {\n+      numVmEventsReceived.incrementAndGet();\n+    }\n+\n+    @Override\n+    public void onRootVertexInitialized(String inputName, InputDescriptor inputDescriptor,\n+                                        List<Event> events) throws Exception {\n+      numInitializedInputs.incrementAndGet();\n+    }\n+  }\n+\n   @InterfaceAudience.Private\n   public static class VertexManagerWithException extends RootInputVertexManager{\n ",
                "raw_url": "https://github.com/apache/tez/raw/97e1d867d961c5ae277a00f55757b29bd7f82a87/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java",
                "sha": "eb95bf9997cc44bd5372c497cba97f29ecdcd361",
                "status": "modified"
            }
        ],
        "message": "TEZ-2855. Fix a potential NPE while routing VertexManager events. (sseth)",
        "parent": "https://github.com/apache/tez/commit/427fa620cb2a27fe25c39c9e947471f1e319c400",
        "patched_files": [
            "VertexImpl.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestVertexImpl.java"
        ]
    },
    "tez_a7f93ae": {
        "bug_id": "tez_a7f93ae",
        "commit": "https://github.com/apache/tez/commit/a7f93ae1da114fa03f7e500a12706e5737b189ee",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/tez/blob/a7f93ae1da114fa03f7e500a12706e5737b189ee/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java?ref=a7f93ae1da114fa03f7e500a12706e5737b189ee",
                "deletions": 0,
                "filename": "tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java",
                "patch": "@@ -853,7 +853,17 @@ public String toString() {\n           ShuffleHeader header = new ShuffleHeader();\n           header.readFields(input);\n           pathComponent = header.getMapId();\n+          if (!pathComponent.startsWith(InputAttemptIdentifier.PATH_PREFIX)) {\n+            throw new IllegalArgumentException(\"Invalid map id: \" + header.getMapId() + \", expected to start with \" +\n+                InputAttemptIdentifier.PATH_PREFIX + \", partition: \" + header.getPartition()\n+                + \" while fetching \" + inputAttemptIdentifier);\n+          }\n+\n           srcAttemptId = pathToAttemptMap.get(new PathPartition(pathComponent, header.getPartition()));\n+          if (srcAttemptId == null) {\n+            throw new IllegalArgumentException(\"Source attempt not found for map id: \" + header.getMapId() +\n+                \", partition: \" + header.getPartition() + \" while fetching \" + inputAttemptIdentifier);\n+          }\n \n           if (header.getCompressedLength() == 0) {\n             // Empty partitions are already accounted for",
                "raw_url": "https://github.com/apache/tez/raw/a7f93ae1da114fa03f7e500a12706e5737b189ee/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/Fetcher.java",
                "sha": "bf8c83b98e8e27456a13b67b914bd4809216a684",
                "status": "modified"
            }
        ],
        "message": "TEZ-3761. NPE in Fetcher under load (jeagles)",
        "parent": "https://github.com/apache/tez/commit/4a7719b0c164eae41845815d103ceb7e6e2548c3",
        "patched_files": [
            "Fetcher.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestFetcher.java"
        ]
    },
    "tez_a9bace0": {
        "bug_id": "tez_a9bace0",
        "commit": "https://github.com/apache/tez/commit/a9bace052a9dba4b1aa08c2e9310df73928dad84",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/tez/blob/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/main/java/org/apache/tez/dag/app/dag/Task.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/Task.java?ref=a9bace052a9dba4b1aa08c2e9310df73928dad84",
                "deletions": 2,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/Task.java",
                "patch": "@@ -78,8 +78,6 @@\n   public List<TezEvent> getTaskAttemptTezEvents(TezTaskAttemptID attemptID,\n       int fromEventId, int maxEvents);\n   \n-  public List<TezEvent> getAndClearTaskTezEvents();\n-\n   public List<String> getDiagnostics();\n \n }",
                "raw_url": "https://github.com/apache/tez/raw/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/main/java/org/apache/tez/dag/app/dag/Task.java",
                "sha": "8243b7047e2aa349ba73b6814c64065e7faf6aa3",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/tez/blob/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java?ref=a9bace052a9dba4b1aa08c2e9310df73928dad84",
                "deletions": 12,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java",
                "patch": "@@ -491,18 +491,6 @@ public float getProgress() {\n     }\n   }\n \n-  @Override\n-  public List<TezEvent> getAndClearTaskTezEvents() {\n-    readLock.lock();\n-    try {\n-      List<TezEvent> events = tezEventsForTaskAttempts;\n-      tezEventsForTaskAttempts = new ArrayList<TezEvent>();\n-      return events;\n-    } finally {\n-      readLock.unlock();\n-    }\n-  }\n-\n   @Override\n   public List<String> getDiagnostics() {\n     List<String> diagnostics = new ArrayList<String>(attempts.size());",
                "raw_url": "https://github.com/apache/tez/raw/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/TaskImpl.java",
                "sha": "793c12a44bc129f5a8fa62431003bde9cbcda14d",
                "status": "modified"
            },
            {
                "additions": 27,
                "blob_url": "https://github.com/apache/tez/blob/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "changes": 62,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java?ref=a9bace052a9dba4b1aa08c2e9310df73928dad84",
                "deletions": 35,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "patch": "@@ -462,7 +462,10 @@\n   private Set<String> inputsWithInitializers;\n   private int numInitializedInputs;\n   private boolean startSignalPending = false;\n-  List<TezEvent> pendingRouteEvents = null;\n+  private boolean tasksNotYetScheduled = true;\n+  // We may always store task events in the vertex for scalability\n+  List<TezEvent> pendingTaskEvents = Lists.newLinkedList();\n+  List<TezEvent> pendingRouteEventsWhileIniting = null;\n   List<TezTaskAttemptID> pendingReportedSrcCompletions = Lists.newLinkedList();\n \n   private RootInputInitializerRunner rootInputInitializer;\n@@ -803,6 +806,12 @@ public AppContext getAppContext() {\n   public void scheduleTasks(List<Integer> taskIDs) {\n     readLock.lock();\n     try {\n+      tasksNotYetScheduled = false;\n+      if (!pendingTaskEvents.isEmpty()) {\n+        VertexImpl.ROUTE_EVENT_TRANSITION.transition(this,\n+            new VertexEventRouteEvent(getVertexId(), pendingTaskEvents));\n+        pendingTaskEvents.clear();\n+      }\n       for (Integer taskID : taskIDs) {\n         if (tasks.size() <= taskID.intValue()) {\n           throw new TezUncheckedException(\n@@ -874,10 +883,6 @@ public boolean setParallelism(int parallelism, VertexLocationHint vertexLocation\n           edge.startEventBuffering();\n         }\n   \n-        // Use a set since the same event may have been sent to multiple tasks\n-        // and we want to avoid duplicates\n-        Set<TezEvent> pendingEvents = new HashSet<TezEvent>();\n-  \n         LOG.info(\"Vertex \" + getVertexId() + \n             \" parallelism set to \" + parallelism + \" from \" + numTasks);\n         // assign to local variable of LinkedHashMap to make sure that changing\n@@ -896,7 +901,6 @@ public boolean setParallelism(int parallelism, VertexLocationHint vertexLocation\n                     + \" for vertex: \" + getVertexId() + \" name: \" + getName());\n             return false;\n           }\n-          pendingEvents.addAll(task.getAndClearTaskTezEvents());\n           if (i <= parallelism) {\n             continue;\n           }\n@@ -913,7 +917,6 @@ public boolean setParallelism(int parallelism, VertexLocationHint vertexLocation\n                 + entry.getKey() + \" destination: \" + getVertexId());\n             Vertex sourceVertex = appContext.getCurrentDAG().getVertex(entry.getKey());\n             Edge edge = sourceVertices.get(sourceVertex);\n-            EdgeProperty edgeProperty = edge.getEdgeProperty();\n             try {\n               edge.setCustomEdgeManager(entry.getValue());\n             } catch (Exception e) {\n@@ -926,21 +929,6 @@ public boolean setParallelism(int parallelism, VertexLocationHint vertexLocation\n           }\n         }\n   \n-        // Re-route all existing TezEvents according to new routing table\n-        // At this point only events attributed to source task attempts can be\n-        // re-routed. e.g. DataMovement or InputFailed events.\n-        // This assumption is fine for now since these tasks haven't been started.\n-        // So they can only get events generated from source task attempts that\n-        // have already been started.\n-        DAG dag = getDAG();\n-        for(TezEvent event : pendingEvents) {\n-          TezVertexID sourceVertexId = event.getSourceInfo().getTaskAttemptID()\n-              .getTaskID().getVertexID();\n-          Vertex sourceVertex = dag.getVertex(sourceVertexId);\n-          Edge sourceEdge = sourceVertices.get(sourceVertex);\n-          sourceEdge.sendTezEventToDestinationTasks(event);\n-        }\n-  \n         // stop buffering events\n         for (Edge edge : sourceVertices.values()) {\n           edge.stopEventBuffering();\n@@ -1550,10 +1538,10 @@ private VertexState initializeVertexInInitializingState() {\n     }\n \n     // Vertex will be moving to INITED state, safe to process pending route events.\n-    if (pendingRouteEvents != null) {\n+    if (pendingRouteEventsWhileIniting != null) {\n       VertexImpl.ROUTE_EVENT_TRANSITION.transition(this,\n-          new VertexEventRouteEvent(getVertexId(), pendingRouteEvents));\n-      pendingRouteEvents = null;\n+          new VertexEventRouteEvent(getVertexId(), pendingRouteEventsWhileIniting));\n+      pendingRouteEventsWhileIniting = null;\n     }\n     return vertexState;\n   }\n@@ -2032,12 +2020,12 @@ private static void checkEventSourceMetadata(Vertex vertex,\n     @Override\n     public void transition(VertexImpl vertex, VertexEvent event) {\n       VertexEventRouteEvent re = (VertexEventRouteEvent) event;\n-      if (vertex.pendingRouteEvents == null) {\n-        vertex.pendingRouteEvents = Lists.newLinkedList();\n+      if (vertex.pendingRouteEventsWhileIniting == null) {\n+        vertex.pendingRouteEventsWhileIniting = Lists.newLinkedList();\n       }\n       // Store the events for post-init routing, since INIT state is when\n       // initial task parallelism will be set\n-      vertex.pendingRouteEvents.addAll(re.getEvents());\n+      vertex.pendingRouteEventsWhileIniting.addAll(re.getEvents());\n     }\n   }\n \n@@ -2103,14 +2091,18 @@ public void transition(VertexImpl vertex, VertexEvent event) {\n             } else {\n               // event not from this vertex. must have come from source vertex.\n               // send to tasks\n-              Edge srcEdge = vertex.sourceVertices.get(vertex.getDAG().getVertex(\n-                  sourceMeta.getTaskVertexName()));\n-              if (srcEdge == null) {\n-                throw new TezUncheckedException(\"Bad source vertex: \" +\n-                    sourceMeta.getTaskVertexName() + \" for destination vertex: \" +\n-                    vertex.getVertexId());\n+              if (vertex.tasksNotYetScheduled) {\n+                vertex.pendingTaskEvents.add(tezEvent);\n+              } else {\n+                Edge srcEdge = vertex.sourceVertices.get(vertex.getDAG().getVertex(\n+                    sourceMeta.getTaskVertexName()));\n+                if (srcEdge == null) {\n+                  throw new TezUncheckedException(\"Bad source vertex: \" +\n+                      sourceMeta.getTaskVertexName() + \" for destination vertex: \" +\n+                      vertex.getVertexId());\n+                }\n+                srcEdge.sendTezEventToDestinationTasks(tezEvent);\n               }\n-              srcEdge.sendTezEventToDestinationTasks(tezEvent);\n             }\n           }\n           break;",
                "raw_url": "https://github.com/apache/tez/raw/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/main/java/org/apache/tez/dag/app/dag/impl/VertexImpl.java",
                "sha": "d3e07cb2d09783e606c5cb20de16c1530c0fe8b6",
                "status": "modified"
            },
            {
                "additions": 42,
                "blob_url": "https://github.com/apache/tez/blob/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java",
                "changes": 42,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java?ref=a9bace052a9dba4b1aa08c2e9310df73928dad84",
                "deletions": 0,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java",
                "patch": "@@ -98,6 +98,7 @@\n import org.apache.tez.dag.app.dag.event.VertexEvent;\n import org.apache.tez.dag.app.dag.event.VertexEventRootInputFailed;\n import org.apache.tez.dag.app.dag.event.VertexEventRootInputInitialized;\n+import org.apache.tez.dag.app.dag.event.VertexEventRouteEvent;\n import org.apache.tez.dag.app.dag.event.VertexEventTaskAttemptCompleted;\n import org.apache.tez.dag.app.dag.event.VertexEventTaskCompleted;\n import org.apache.tez.dag.app.dag.event.VertexEventTaskReschedule;\n@@ -114,12 +115,16 @@\n import org.apache.tez.runtime.api.Event;\n import org.apache.tez.runtime.api.OutputCommitter;\n import org.apache.tez.runtime.api.OutputCommitterContext;\n+import org.apache.tez.runtime.api.events.CompositeDataMovementEvent;\n import org.apache.tez.runtime.api.events.DataMovementEvent;\n import org.apache.tez.runtime.api.events.InputReadErrorEvent;\n import org.apache.tez.runtime.api.events.RootInputConfigureVertexTasksEvent;\n import org.apache.tez.runtime.api.events.RootInputDataInformationEvent;\n import org.apache.tez.test.EdgeManagerForTest;\n+import org.apache.tez.runtime.api.impl.EventMetaData;\n+import org.apache.tez.runtime.api.impl.EventMetaData.EventProducerConsumerType;\n import org.apache.tez.runtime.api.impl.GroupInputSpec;\n+import org.apache.tez.runtime.api.impl.TezEvent;\n import org.junit.After;\n import org.junit.Assert;\n import org.junit.Before;\n@@ -1419,6 +1424,43 @@ public void testVertexSetParallelism() {\n     Assert.assertTrue(tasks.keySet().iterator().next().equals(firstTask));\n \n   }\n+  \n+  @SuppressWarnings(\"unchecked\")\n+  @Test(timeout = 5000)\n+  public void testVertexPendingTaskEvents() {\n+    initAllVertices(VertexState.INITED);\n+    VertexImpl v3 = vertices.get(\"vertex3\");\n+    VertexImpl v2 = vertices.get(\"vertex2\");\n+    \n+    startVertex(v2);\n+    startVertex(v3);\n+    \n+    TezTaskID t0_v2 = TezTaskID.getInstance(v2.getVertexId(), 0);\n+    TezTaskAttemptID ta0_t0_v2 = TezTaskAttemptID.getInstance(t0_v2, 0);\n+\n+    List<TezEvent> taskEvents = Lists.newLinkedList();\n+    TezEvent tezEvent1 = new TezEvent(\n+        new CompositeDataMovementEvent(0, 1, new byte[0]), \n+        new EventMetaData(EventProducerConsumerType.OUTPUT, \"vertex2\", \"vertex3\", ta0_t0_v2));\n+    TezEvent tezEvent2 = new TezEvent(\n+        new DataMovementEvent(0, new byte[0]), \n+        new EventMetaData(EventProducerConsumerType.OUTPUT, \"vertex2\", \"vertex3\", ta0_t0_v2));\n+    taskEvents.add(tezEvent1);\n+    taskEvents.add(tezEvent2);\n+    // send events and test that they are buffered until some task is scheduled\n+    dispatcher.getEventHandler().handle(\n+        new VertexEventRouteEvent(v3.getVertexId(), taskEvents));\n+    dispatcher.await();\n+    Assert.assertEquals(2, v3.pendingTaskEvents.size());\n+    v3.scheduleTasks(Collections.singletonList(new Integer(0)));\n+    dispatcher.await();\n+    Assert.assertEquals(0, v3.pendingTaskEvents.size());\n+    // send events and test that they are not buffered anymore\n+    dispatcher.getEventHandler().handle(\n+        new VertexEventRouteEvent(v3.getVertexId(), taskEvents));\n+    dispatcher.await();\n+    Assert.assertEquals(0, v3.pendingTaskEvents.size());\n+  }\n \n   @Test(timeout = 5000)\n   public void testSetCustomEdgeManager() throws UnsupportedEncodingException {",
                "raw_url": "https://github.com/apache/tez/raw/a9bace052a9dba4b1aa08c2e9310df73928dad84/tez-dag/src/test/java/org/apache/tez/dag/app/dag/impl/TestVertexImpl.java",
                "sha": "1a14b15b613b02082e02aaea2d02bf6ce8cab09d",
                "status": "modified"
            }
        ],
        "message": "TEZ-715. Auto Reduce Parallelism can rarely trigger NPE in AM at DAGAppMaster.handle(DAGAppMaster.java:1268) (bikas)",
        "parent": "https://github.com/apache/tez/commit/f2f31e0eff3f654d51ca7001a3bf1784cf8d5e0b",
        "patched_files": [
            "VertexImpl.java",
            "TaskImpl.java",
            "Task.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskImpl.java",
            "TestVertexImpl.java"
        ]
    },
    "tez_aeb7038": {
        "bug_id": "tez_aeb7038",
        "commit": "https://github.com/apache/tez/commit/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850/CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -9,6 +9,7 @@ INCOMPATIBLE CHANGES\n   TEZ-2949. Allow duplicate dag names within session for Tez.\n \n ALL CHANGES:\n+  TEZ-2798. NPE when executing TestMemoryWithEvents::testMemoryScatterGather.\n   TEZ-2963. RecoveryService#handleSummaryEvent exception with HDFS transparent encryption + kerberos authentication.\n   TEZ-2966. Tez does not honor mapreduce.task.timeout\n   TEZ-2979. FlakyTest: org.apache.tez.history.TestHistoryParser.",
                "raw_url": "https://github.com/apache/tez/raw/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850/CHANGES.txt",
                "sha": "cc5ff5a8f3e6c0f9f1e031e117868bb847b08a80",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850/tez-dag/src/main/java/org/apache/tez/dag/app/ContainerLauncherContextImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/ContainerLauncherContextImpl.java?ref=aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850",
                "deletions": 0,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/ContainerLauncherContextImpl.java",
                "patch": "@@ -14,6 +14,7 @@\n \n package org.apache.tez.dag.app;\n \n+import com.google.common.base.Preconditions;\n import org.apache.hadoop.yarn.api.records.ApplicationAttemptId;\n import org.apache.hadoop.yarn.api.records.ContainerId;\n import org.apache.tez.common.TezUtilsInternal;\n@@ -37,6 +38,8 @@\n   private final UserPayload initialUserPayload;\n \n   public ContainerLauncherContextImpl(AppContext appContext, TaskCommunicatorManagerInterface tal, UserPayload initialUserPayload) {\n+    Preconditions.checkNotNull(appContext, \"AppContext cannot be null\");\n+    Preconditions.checkNotNull(tal, \"TaskCommunicator cannot be null\");\n     this.context = appContext;\n     this.tal = tal;\n     this.initialUserPayload = initialUserPayload;",
                "raw_url": "https://github.com/apache/tez/raw/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850/tez-dag/src/main/java/org/apache/tez/dag/app/ContainerLauncherContextImpl.java",
                "sha": "a2e0dd685eb3598399fe52c9f3a68100d631151a",
                "status": "modified"
            },
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/tez/blob/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850/tez-dag/src/test/java/org/apache/tez/dag/app/MockDAGAppMaster.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/MockDAGAppMaster.java?ref=aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850",
                "deletions": 11,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/MockDAGAppMaster.java",
                "patch": "@@ -87,8 +87,8 @@\n public class MockDAGAppMaster extends DAGAppMaster {\n   \n   private static final Logger LOG = LoggerFactory.getLogger(MockDAGAppMaster.class);\n-  ContainerLauncherContext containerLauncherContext;\n   MockContainerLauncher containerLauncher;\n+  private final AtomicBoolean launcherGoFlag;\n   boolean initFailFlag;\n   boolean startFailFlag;\n   boolean recoveryFatalError = false;\n@@ -488,17 +488,8 @@ public MockDAGAppMaster(ApplicationAttemptId applicationAttemptId, ContainerId c\n     super(applicationAttemptId, containerId, nmHost, nmPort, nmHttpPort, clock, appSubmitTime,\n         isSession, workingDirectory, localDirs, logDirs,  new TezApiVersionInfo().getVersion(), 1,\n         credentials, jobUserName, null);\n-    Configuration conf = new Configuration(false);\n-    UserPayload userPayload;\n-    try {\n-      userPayload = TezUtils.createUserPayloadFromConf(conf);\n-    } catch (IOException e) {\n-      throw new TezUncheckedException(e);\n-    }\n-    containerLauncherContext =\n-        new ContainerLauncherContextImpl(getContext(), getTaskCommunicatorManager(), userPayload);\n-    containerLauncher = new MockContainerLauncher(launcherGoFlag, containerLauncherContext);\n     shutdownHandler = new MockDAGAppMasterShutdownHandler();\n+    this.launcherGoFlag = launcherGoFlag;\n     this.initFailFlag = initFailFlag;\n     this.startFailFlag = startFailFlag;\n     Preconditions.checkArgument(handlerConcurrency > 0);\n@@ -512,6 +503,15 @@ protected ContainerLauncherManager createContainerLauncherManager(\n       List<NamedEntityDescriptor> containerLauncherDescirptors,\n       boolean isLocal)\n       throws UnknownHostException {\n+    UserPayload userPayload;\n+    try {\n+      userPayload = TezUtils.createUserPayloadFromConf(new Configuration(false));\n+    } catch (IOException e) {\n+      throw new TezUncheckedException(e);\n+    }\n+    ContainerLauncherContext containerLauncherContext =\n+        new ContainerLauncherContextImpl(getContext(), getTaskCommunicatorManager(), userPayload);\n+    containerLauncher = new MockContainerLauncher(launcherGoFlag, containerLauncherContext);\n     return new ContainerLauncherManager(containerLauncher, getContext());\n   }\n ",
                "raw_url": "https://github.com/apache/tez/raw/aeb7038c35a5214d1ca5fe738da9bdeaf6e4a850/tez-dag/src/test/java/org/apache/tez/dag/app/MockDAGAppMaster.java",
                "sha": "bc7fa98e02d52399ae25b086c2d680db130a9339",
                "status": "modified"
            }
        ],
        "message": "TEZ-2798. NPE when executing TestMemoryWithEvents::testMemoryScatterGather. (sseth)",
        "parent": "https://github.com/apache/tez/commit/0c5ccb66afa1a972b2652ecd1d3f98c974f31add",
        "patched_files": [
            "MockDAGAppMaster.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestMockDAGAppMaster.java"
        ]
    },
    "tez_c411e4e": {
        "bug_id": "tez_c411e4e",
        "commit": "https://github.com/apache/tez/commit/c411e4edced690d111dac3cf2afcbb6cd39354f4",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/c411e4edced690d111dac3cf2afcbb6cd39354f4/CHANGES.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=c411e4edced690d111dac3cf2afcbb6cd39354f4",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -9,6 +9,7 @@ INCOMPATIBLE CHANGES\n   TEZ-1993. Implement a pluggable InputSizeEstimator for grouping fairly\n \n ALL CHANGES:\n+  TEZ-2405. PipelinedSorter can throw NPE with custom compartor.\n   TEZ-1897. Create a concurrent version of AsyncDispatcher\n   TEZ-2394. Issues when there is an error in VertexManager callbacks\n   TEZ-2386. Tez UI: Inconsistent usage of icon colors",
                "raw_url": "https://github.com/apache/tez/raw/c411e4edced690d111dac3cf2afcbb6cd39354f4/CHANGES.txt",
                "sha": "6c19770c3e8dff57f50fa9f2508f4b78b4315569",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/tez/blob/c411e4edced690d111dac3cf2afcbb6cd39354f4/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/sort/impl/PipelinedSorter.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/sort/impl/PipelinedSorter.java?ref=c411e4edced690d111dac3cf2afcbb6cd39354f4",
                "deletions": 1,
                "filename": "tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/sort/impl/PipelinedSorter.java",
                "patch": "@@ -749,7 +749,7 @@ public int compareInternal(final DataInputBuffer needle, final int needlePart, f\n         cmp = comparator.compare(buf,\n             keystart + off , (valstart - keystart),\n             needle.getData(),\n-            needle.getPosition(), needle.getLength());\n+            needle.getPosition(), (needle.getLength() - needle.getPosition()));\n       }\n       return cmp;\n     }",
                "raw_url": "https://github.com/apache/tez/raw/c411e4edced690d111dac3cf2afcbb6cd39354f4/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/sort/impl/PipelinedSorter.java",
                "sha": "661f54cac719d7fc37a977ed78a72677159c19ea",
                "status": "modified"
            },
            {
                "additions": 45,
                "blob_url": "https://github.com/apache/tez/blob/c411e4edced690d111dac3cf2afcbb6cd39354f4/tez-runtime-library/src/test/java/org/apache/tez/runtime/library/common/sort/impl/TestPipelinedSorter.java",
                "changes": 53,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-library/src/test/java/org/apache/tez/runtime/library/common/sort/impl/TestPipelinedSorter.java?ref=c411e4edced690d111dac3cf2afcbb6cd39354f4",
                "deletions": 8,
                "filename": "tez-runtime-library/src/test/java/org/apache/tez/runtime/library/common/sort/impl/TestPipelinedSorter.java",
                "patch": "@@ -8,6 +8,7 @@\n import org.apache.hadoop.io.DataInputBuffer;\n import org.apache.hadoop.io.DataOutputBuffer;\n import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.io.WritableComparator;\n import org.apache.hadoop.io.serializer.Deserializer;\n import org.apache.hadoop.io.serializer.SerializationFactory;\n import org.apache.hadoop.yarn.api.records.ApplicationId;\n@@ -22,6 +23,7 @@\n import org.apache.tez.runtime.library.conf.OrderedPartitionedKVOutputConfig.SorterImpl;\n import org.apache.tez.runtime.library.partitioner.HashPartitioner;\n import org.junit.After;\n+import org.junit.AfterClass;\n import org.junit.Assert;\n import org.junit.Before;\n import org.junit.Test;\n@@ -61,10 +63,10 @@\n   private static final Configuration conf = new Configuration();\n   private static FileSystem localFs = null;\n   private static Path workDir = null;\n+  private OutputContext outputContext;\n \n   private int numOutputs;\n   private long initialAvailableMem;\n-  private OutputContext outputContext;\n \n   //TODO: Need to make it nested structure so that multiple partition cases can be validated\n   private static TreeMap<String, String> sortedDataMap = Maps.newTreeMap();\n@@ -82,29 +84,35 @@\n     }\n   }\n \n+  @AfterClass\n+  public static void cleanup() throws IOException {\n+    localFs.delete(workDir, true);\n+  }\n+\n   @Before\n   public void setup() throws IOException {\n     ApplicationId appId = ApplicationId.newInstance(10000, 1);\n     TezCounters counters = new TezCounters();\n     String uniqueId = UUID.randomUUID().toString();\n     this.outputContext = createMockOutputContext(counters, appId, uniqueId);\n \n-    //To enable PipelinedSorter, set 2 threads\n+    //To enable PipelinedSorter\n     conf.set(TezRuntimeConfiguration.TEZ_RUNTIME_SORTER_CLASS, SorterImpl.PIPELINED.name());\n+\n     conf.set(TezRuntimeConfiguration.TEZ_RUNTIME_KEY_CLASS, Text.class.getName());\n     conf.set(TezRuntimeConfiguration.TEZ_RUNTIME_VALUE_CLASS, Text.class.getName());\n-    conf.set(TezRuntimeConfiguration.TEZ_RUNTIME_PARTITIONER_CLASS,\n-        HashPartitioner.class.getName());\n+    conf.set(TezRuntimeConfiguration.TEZ_RUNTIME_PARTITIONER_CLASS, HashPartitioner.class.getName());\n+\n+    conf.setBoolean(TezRuntimeConfiguration.TEZ_RUNTIME_ENABLE_FINAL_MERGE_IN_OUTPUT, true);\n \n     //Setup localdirs\n     String localDirs = workDir.toString();\n     conf.setStrings(TezRuntimeFrameworkConfigs.LOCAL_DIRS, localDirs);\n   }\n \n   @After\n-  public void cleanup() throws IOException {\n-    localFs.delete(workDir, true);\n-    sortedDataMap.clear();\n+  public void reset() throws IOException {\n+    cleanup();\n     localFs.mkdirs(workDir);\n   }\n \n@@ -132,6 +140,13 @@ public void basicTest() throws IOException {\n \n   }\n \n+  @Test\n+  public void testWithCustomComparator() throws IOException {\n+    //Test with custom comparator\n+    conf.set(TezRuntimeConfiguration.TEZ_RUNTIME_KEY_COMPARATOR_CLASS, CustomComparator.class.getName());\n+    basicTest(1, 100000, 100, (10 * 1024l * 1024l), 3 << 20);\n+  }\n+\n   @Test\n   public void testWithPipelinedShuffle() throws IOException {\n     this.numOutputs = 1;\n@@ -251,7 +266,7 @@ private void verifyData(IFile.Reader reader)\n     Assert.assertTrue(numRecordsRead == sortedDataMap.size());\n   }\n \n-  private OutputContext createMockOutputContext(TezCounters counters, ApplicationId appId,\n+  private static OutputContext createMockOutputContext(TezCounters counters, ApplicationId appId,\n       String uniqueId) throws IOException {\n     OutputContext outputContext = mock(OutputContext.class);\n \n@@ -280,4 +295,26 @@ private OutputContext createMockOutputContext(TezCounters counters, ApplicationI\n     doReturn(outDirs).when(outputContext).getWorkDirs();\n     return outputContext;\n   }\n+\n+  /**\n+   * E.g Hive uses TezBytesComparator which internally makes use of WritableComparator's comparison.\n+   * Any length mismatches are handled there.\n+   *\n+   * However, custom comparators can handle this differently and might throw\n+   * IndexOutOfBoundsException in case of invalid lengths.\n+   *\n+   * This comparator (similar to comparator in BinInterSedes of pig) would thrown exception when\n+   * wrong lengths are mentioned.\n+   */\n+  public static class CustomComparator extends WritableComparator {\n+    @Override\n+    public int compare(byte[] b1, int s1, int l1, byte[] b2, int s2, int l2) {\n+      //wrapping is done so that it would throw exceptions on wrong lengths\n+      ByteBuffer bb1 = ByteBuffer.wrap(b1, s1, l1);\n+      ByteBuffer bb2 = ByteBuffer.wrap(b2, s2, l2);\n+\n+      return bb1.compareTo(bb2);\n+    }\n+\n+  }\n }",
                "raw_url": "https://github.com/apache/tez/raw/c411e4edced690d111dac3cf2afcbb6cd39354f4/tez-runtime-library/src/test/java/org/apache/tez/runtime/library/common/sort/impl/TestPipelinedSorter.java",
                "sha": "5de96c95e87a757a5ad540097c219e1418faaa92",
                "status": "modified"
            }
        ],
        "message": "TEZ-2405. PipelinedSorter can throw NPE with custom compartor (rbalamohan)",
        "parent": "https://github.com/apache/tez/commit/f6ea0fb3306faa709c445e4d76081de60545d760",
        "patched_files": [
            "PipelinedSorter.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestPipelinedSorter.java"
        ]
    },
    "tez_ddfb262": {
        "bug_id": "tez_ddfb262",
        "commit": "https://github.com/apache/tez/commit/ddfb262223b7cb07957e1bd48a99d8a2e765aee7",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/ddfb262223b7cb07957e1bd48a99d8a2e765aee7/tez-dag/src/test/java/org/apache/tez/dag/app/TestTaskCommunicatorContextImpl.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/TestTaskCommunicatorContextImpl.java?ref=ddfb262223b7cb07957e1bd48a99d8a2e765aee7",
                "deletions": 0,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/TestTaskCommunicatorContextImpl.java",
                "patch": "@@ -21,7 +21,9 @@\n import static org.mockito.Mockito.never;\n import static org.mockito.Mockito.reset;\n import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.yarn.api.records.Container;\n import org.apache.hadoop.yarn.api.records.ContainerId;\n import org.apache.tez.common.ContainerSignatureMatcher;\n@@ -34,6 +36,7 @@\n   @Test(timeout = 5000)\n   public void testIsKnownContainer() {\n     AppContext appContext = mock(AppContext.class);\n+    when(appContext.getAMConf()).thenReturn(new Configuration());\n     TaskCommunicatorManager tal = mock(TaskCommunicatorManager.class);\n \n     AMContainerMap amContainerMap = new AMContainerMap(mock(ContainerHeartbeatHandler.class), tal, mock(",
                "raw_url": "https://github.com/apache/tez/raw/ddfb262223b7cb07957e1bd48a99d8a2e765aee7/tez-dag/src/test/java/org/apache/tez/dag/app/TestTaskCommunicatorContextImpl.java",
                "sha": "9f9150f7589677ba8fe365396b37668747a9a10b",
                "status": "modified"
            }
        ],
        "message": "TEZ-3743. TestTaskCommunicatorContextImpl throws NullPointerException after TEZ-3334 merge (Jonathan Eagles via kshukla)",
        "parent": "https://github.com/apache/tez/commit/c0faeaed6053b7ec102dedbae6ffdb2776a9c9cc",
        "patched_files": [
            "TaskCommunicatorContextImpl.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskCommunicatorContextImpl.java"
        ]
    },
    "tez_f3cea63": {
        "bug_id": "tez_f3cea63",
        "commit": "https://github.com/apache/tez/commit/f3cea630e8329018a1e600859353576cb83cf77d",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/tez/blob/f3cea630e8329018a1e600859353576cb83cf77d/CHANGES.txt",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/CHANGES.txt?ref=f3cea630e8329018a1e600859353576cb83cf77d",
                "deletions": 0,
                "filename": "CHANGES.txt",
                "patch": "@@ -6,6 +6,7 @@ Release 0.8.2: Unreleased\n INCOMPATIBLE CHANGES\n \n ALL CHANGES:\n+  TEZ-2907. NPE in IFile.Reader.getLength during final merge operation\n   TEZ-2903. Stop using proprietary APIs in RPCLoadGen.\n   TEZ-2882. Consider improving fetch failure handling\n   TEZ-2850. Tez MergeManager OOM for small Map Outputs\n@@ -220,6 +221,7 @@ Release 0.7.1: Unreleased\n INCOMPATIBLE CHANGES\n \n ALL CHANGES\n+  TEZ-2907. NPE in IFile.Reader.getLength during final merge operation\n   TEZ-2850. Tez MergeManager OOM for small Map Outputs\n   TEZ-2886. Ability to merge AM credentials with DAG credentials.\n   TEZ-2896. Fix thread names used during Input/Output initialization.\n@@ -504,6 +506,7 @@ Release 0.6.3: Unreleased\n INCOMPATIBLE CHANGES\n \n ALL CHANGES:\n+  TEZ-2907. NPE in IFile.Reader.getLength during final merge operation\n   TEZ-2850. Tez MergeManager OOM for small Map Outputs\n   TEZ-2781. Fallback to send only TaskAttemptFailedEvent if taskFailed heartbeat fails\n   TEZ-2855. Fix a potential NPE while routing VertexManager events.",
                "raw_url": "https://github.com/apache/tez/raw/f3cea630e8329018a1e600859353576cb83cf77d/CHANGES.txt",
                "sha": "d19df34be6c53231053ae3d7ba78e367da6b186c",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/tez/blob/f3cea630e8329018a1e600859353576cb83cf77d/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/orderedgrouped/MergeManager.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/orderedgrouped/MergeManager.java?ref=f3cea630e8329018a1e600859353576cb83cf77d",
                "deletions": 0,
                "filename": "tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/orderedgrouped/MergeManager.java",
                "patch": "@@ -949,12 +949,14 @@ private long createInMemorySegments(List<MapOutput> inMemoryMapOutputs,\n   class RawKVIteratorReader extends IFile.Reader {\n \n     private final TezRawKeyValueIterator kvIter;\n+    private final long size;\n \n     public RawKVIteratorReader(TezRawKeyValueIterator kvIter, long size)\n         throws IOException {\n       super(null, size, null, spilledRecordsCounter, null, ifileReadAhead,\n           ifileReadAheadLength, ifileBufferSize);\n       this.kvIter = kvIter;\n+      this.size = size;\n     }\n     @Override\n     public KeyState readRawKey(DataInputBuffer key) throws IOException {\n@@ -982,6 +984,10 @@ public long getPosition() throws IOException {\n     public void close() throws IOException {\n       kvIter.close();\n     }\n+\n+    @Override public long getLength() {\n+      return size;\n+    }\n   }\n \n   private TezRawKeyValueIterator finalMerge(Configuration job, FileSystem fs,",
                "raw_url": "https://github.com/apache/tez/raw/f3cea630e8329018a1e600859353576cb83cf77d/tez-runtime-library/src/main/java/org/apache/tez/runtime/library/common/shuffle/orderedgrouped/MergeManager.java",
                "sha": "fb9b2431e5a6f652614080b2f12d229d992d1a15",
                "status": "modified"
            }
        ],
        "message": "TEZ-2907. NPE in IFile.Reader.getLength during final merge operation (rbalamohan)",
        "parent": "https://github.com/apache/tez/commit/01ad29e44bfb3ca9d6bfff2cc82444e406721b2a",
        "patched_files": [
            "MergeManager.java",
            "CHANGES.txt"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestMergeManager.java"
        ]
    },
    "tez_f86128a": {
        "bug_id": "tez_f86128a",
        "commit": "https://github.com/apache/tez/commit/f86128a8dd8a7bbda6b2b61bcaee336b35c6100a",
        "file": [
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/tez/blob/f86128a8dd8a7bbda6b2b61bcaee336b35c6100a/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java",
                "changes": 24,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java?ref=f86128a8dd8a7bbda6b2b61bcaee336b35c6100a",
                "deletions": 7,
                "filename": "tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java",
                "patch": "@@ -684,12 +684,14 @@ protected void notifyForTest() {\n \n   public void initiateStop() {\n     for (int i = 0 ; i < taskSchedulers.length ; i++) {\n-      try {\n-        taskSchedulers[i].getTaskScheduler().initiateStop();\n-      } catch (Exception e) {\n-        // Ignore for now as scheduler stop invoked on shutdown\n-        LOG.error(\"Failed to do a clean initiateStop for Scheduler: \"\n-            + Utils.getTaskSchedulerIdentifierString(i, appContext), e);\n+      if (taskSchedulers[i] != null) {\n+        try {\n+          taskSchedulers[i].getTaskScheduler().initiateStop();\n+        } catch (Exception e) {\n+          // Ignore for now as scheduler stop invoked on shutdown\n+          LOG.error(\"Failed to do a clean initiateStop for Scheduler: \"\n+              + Utils.getTaskSchedulerIdentifierString(i, appContext), e);\n+        }\n       }\n     }\n   }\n@@ -978,13 +980,21 @@ public ContainerSignatureMatcher getContainerSignatureMatcher() {\n   }\n \n   public boolean hasUnregistered() {\n+    // Only return true if all task schedulers that were registered successfully unregister\n+    if (taskSchedulers.length == 0) {\n+      return false;\n+    }\n     boolean result = true;\n-    for (int i = 0 ; i < taskSchedulers.length ; i++) {\n+    for (int i = 0; i < taskSchedulers.length; i++) {\n       // Explicitly not catching any exceptions around this API\n       // No clear route to recover. Better to crash.\n+      if (taskSchedulers[i] == null) {\n+        return false;\n+      }\n       try {\n         result = result & this.taskSchedulers[i].hasUnregistered();\n       } catch (Exception e) {\n+        result = false;\n         String msg = \"Error in TaskScheduler when checking if a scheduler has unregistered\"\n             + \", scheduler=\" + Utils.getTaskSchedulerIdentifierString(i, appContext);\n         LOG.error(msg, e);",
                "raw_url": "https://github.com/apache/tez/raw/f86128a8dd8a7bbda6b2b61bcaee336b35c6100a/tez-dag/src/main/java/org/apache/tez/dag/app/rm/TaskSchedulerManager.java",
                "sha": "7c1b926e952adf6485a690c24f3f5680529597e6",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/tez/blob/f86128a8dd8a7bbda6b2b61bcaee336b35c6100a/tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/tez/contents/tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java?ref=f86128a8dd8a7bbda6b2b61bcaee336b35c6100a",
                "deletions": 0,
                "filename": "tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java",
                "patch": "@@ -568,6 +568,23 @@ public void testTaskSchedulerRouting() throws Exception {\n         eq(launchRequest2));\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n+  @Test(timeout = 5000)\n+  public void testShutdownBeforeStartTaskScheduler() {\n+    Configuration conf = new TezConfiguration();\n+    AppContext appContext = mock(AppContext.class, RETURNS_DEEP_STUBS);\n+    doReturn(conf).when(appContext).getAMConf();\n+\n+    List<NamedEntityDescriptor> list = new LinkedList<>();\n+    list.add(null);\n+\n+    TaskSchedulerManager taskSchedulerManager =\n+        new TaskSchedulerManager(appContext, null, null,\n+            null, null, list, false,null);\n+    assertFalse(\"Should not return true unless actually unregistered successfully\",\n+        taskSchedulerManager.hasUnregistered());\n+  }\n+\n   @SuppressWarnings(\"unchecked\")\n   @Test(timeout = 5000)\n   public void testReportFailureFromTaskScheduler() {",
                "raw_url": "https://github.com/apache/tez/raw/f86128a8dd8a7bbda6b2b61bcaee336b35c6100a/tez-dag/src/test/java/org/apache/tez/dag/app/rm/TestTaskSchedulerManager.java",
                "sha": "5df25de963798bc5a9e89ca733735c3782015ead",
                "status": "modified"
            }
        ],
        "message": "TEZ-3834. TaskSchedulerManager NullPointerException during shutdown when failed to start. Contributed by Jonathan Eagles",
        "parent": "https://github.com/apache/tez/commit/7236d1563ef71a4f551da2bca5501713cbf1d037",
        "patched_files": [
            "TaskSchedulerManager.java"
        ],
        "repo": "tez",
        "unit_tests": [
            "TestTaskSchedulerManager.java"
        ]
    }
}