[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3",
        "bug_id": "jackrabbit-oak_ac194bb",
        "message": "OAK-7357: NPE on activation of LuceneIndexProviderService with disabled CoR and CoR\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1827257 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/f8d8f4e9e0519570e68f4aee390ba34fe7d73268",
        "patched_files": [
            "LuceneIndexProviderService.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 3,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java?ref=ac194bbd073bbfb9c85e00db75350fdba4e2a6a3",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java",
                "deletions": 2,
                "sha": "e5211ac65fa5254566f73abc85b11cd816f48a81",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java",
                "patch": "@@ -755,10 +755,11 @@ private void initializeActiveBlobCollector(Whiteboard whiteboard, Map<String, ?>\n                 PROP_DELETED_BLOB_COLLECTION_DEFAULT_ENABLED);\n         if (activeDeletionEnabled && blobStore!= null) {\n             File blobCollectorWorkingDir = new File(indexDir, \"deleted-blobs\");\n-            activeDeletedBlobCollector = ActiveDeletedBlobCollectorFactory.newInstance(blobCollectorWorkingDir, executorService);\n+            activeDeletedBlobCollector = ActiveDeletedBlobCollectorFactory.newInstance(blobCollectorWorkingDir,\n+                    getExecutorService());\n             ActiveDeletedBlobCollectorMBean bean =\n                     new ActiveDeletedBlobCollectorMBeanImpl(activeDeletedBlobCollector, whiteboard, nodeStore,\n-                            indexPathService, asyncIndexInfoService, blobStore, executorService);\n+                            indexPathService, asyncIndexInfoService, blobStore, getExecutorService());\n \n             oakRegs.add(registerMBean(whiteboard, ActiveDeletedBlobCollectorMBean.class, bean,\n                     ActiveDeletedBlobCollectorMBean.TYPE, \"Active lucene files collection\"));",
                "changes": 5
            },
            {
                "status": "modified",
                "additions": 25,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java?ref=ac194bbd073bbfb9c85e00db75350fdba4e2a6a3",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
                "deletions": 0,
                "sha": "8fb74078f0dc64fc20a9b079da4d81c77381a46b",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
                "patch": "@@ -182,6 +182,31 @@ public void enableCopyOnWrite() throws Exception{\n         MockOsgi.deactivate(service, context.bundleContext());\n     }\n \n+    // OAK-7357\n+    @Test\n+    public void disableCoRCoW() throws Exception {\n+        // inject ds as OAK-7357 revealed ABD bean had a bug - which comes into play only with blob stores\n+        CachingFileDataStore ds = DataStoreUtils\n+                .createCachingFDS(folder.newFolder().getAbsolutePath(),\n+                        folder.newFolder().getAbsolutePath());\n+\n+        context.registerService(GarbageCollectableBlobStore.class, new DataStoreBlobStore(ds));\n+\n+        // re-init service and inject references\n+        service = new LuceneIndexProviderService();\n+        MockOsgi.injectServices(service, context.bundleContext());\n+\n+        Map<String,Object> config = getDefaultConfig();\n+        config.put(\"enableCopyOnReadSupport\", false);\n+        config.put(\"enableCopyOnWriteSupport\", false);\n+\n+        // activation should work\n+        MockOsgi.activate(service, context.bundleContext(), config);\n+\n+        // de-activation should work\n+        MockOsgi.deactivate(service, context.bundleContext());\n+    }\n+\n     @Test\n     public void enablePrefetchIndexFiles() throws Exception{\n         Map<String,Object> config = getDefaultConfig();",
                "changes": 25
            }
        ],
        "unit_tests": [
            "LuceneIndexProviderServiceTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
        "buggy_files": [
            "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java"
        ],
        "fixed": true
    }
]