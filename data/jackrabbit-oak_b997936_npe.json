[
    {
        "repo": "jackrabbit-oak",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/b997936d972e9b26f6ff276262428a9ddc5bd5ad",
        "bug_id": "jackrabbit-oak_b997936",
        "message": "OAK-7508: Text extraction timeout can lead to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1832376 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/dbc84d9b0751ec9e6dec8b0244497e0e36a41ccb",
        "patched_files": [
            "ExtractedTextCache.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 5,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java?ref=b997936d972e9b26f6ff276262428a9ddc5bd5ad",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
                "deletions": 2,
                "sha": "c07f1a4709645b82b4ed3f20f519c3a4c9bdaa8c",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
                "patch": "@@ -157,9 +157,12 @@ public void putTimeout(@Nonnull Blob blob, @Nonnull ExtractedText extractedText)\n         if (EXTRACT_FORGET_TIMEOUT) {\n             return;\n         }\n+\n         String id = blob.getContentIdentity();\n-        timeoutMap.put(id, getText(extractedText));\n-        storeTimeoutMap();\n+        if (id != null) {\n+            timeoutMap.put(id, getText(extractedText));\n+            storeTimeoutMap();\n+        }\n     }\n \n     private static String getText(ExtractedText text) {",
                "changes": 7
            },
            {
                "status": "modified",
                "additions": 11,
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java?ref=b997936d972e9b26f6ff276262428a9ddc5bd5ad",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
                "deletions": 0,
                "sha": "d6b06fb716801a44037a1f0da0bc5a1aa447a034",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
                "patch": "@@ -185,6 +185,17 @@ public Void call() throws Exception {\n         assertEquals(1, cache.getStatsMBean().getTimeoutCount());\n     }\n \n+    @Test\n+    public void nullContentIdentityBlob() throws Exception {\n+        ExtractedTextCache cache = new ExtractedTextCache(0, 0);\n+        Blob b = new IdBlob(\"hello\", null);\n+        cache.put(b, ExtractedText.ERROR);\n+        assertNull(cache.get(\"/a\", \"foo\", b, false));\n+        cache.putTimeout(b, ExtractedText.ERROR);\n+        assertNull(\"Cache returned non null text for blob with null content identity\",\n+                cache.get(\"/a\", \"foo\", b, false));\n+    }\n+\n     private static class IdBlob extends ArrayBasedBlob {\n         final String id;\n ",
                "changes": 11
            }
        ],
        "unit_tests": [
            "ExtractedTextCacheTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
        "buggy_files": [
            "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
            "oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCache.java"
        ],
        "fixed": true
    }
]