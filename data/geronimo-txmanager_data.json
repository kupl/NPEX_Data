[
    {
        "repo": "geronimo-txmanager",
        "message": "[GERONIMO-6541] NPE during XAResource recovery with invalid Xids\n\ngit-svn-id: https://svn.apache.org/repos/asf/geronimo/components/txmanager/trunk@1673231 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/geronimo-txmanager/commit/01e4d641665eadc84828157899ea1e86c08383f9",
        "parent": "https://github.com/apache/geronimo-txmanager/commit/87593cd3899e9aad8ac01afce68580d7ab01ba3c",
        "bug_id": "geronimo-txmanager_1",
        "file": [
            {
                "sha": "caa691dae886b36f9415a5f468666a5a1a740b7f",
                "filename": "geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoveryImpl.java",
                "blob_url": "https://github.com/apache/geronimo-txmanager/blob/01e4d641665eadc84828157899ea1e86c08383f9/geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoveryImpl.java",
                "raw_url": "https://github.com/apache/geronimo-txmanager/raw/01e4d641665eadc84828157899ea1e86c08383f9/geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoveryImpl.java",
                "status": "modified",
                "changes": 27,
                "additions": 19,
                "contents_url": "https://api.github.com/repos/apache/geronimo-txmanager/contents/geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoveryImpl.java?ref=01e4d641665eadc84828157899ea1e86c08383f9",
                "patch": "@@ -99,7 +99,11 @@ public synchronized void recoverResourceManager(NamedXAResource xaResource) thro\n         Xid[] prepared = xaResource.recover(XAResource.TMSTARTRSCAN + XAResource.TMENDRSCAN);\n         for (int i = 0; prepared != null && i < prepared.length; i++) {\n             Xid xid = prepared[i];\n-            log.trace(\"considering recovered xid from\\n name: \" + xaResource.getName() + \"\\n \" + toString(xid));\n+            if (xid.getGlobalTransactionId() == null || xid.getBranchQualifier() == null) {\n+                log.warn(\"Ignoring bad xid from\\n name: \" + xaResource.getName() + \"\\n \" + toString(xid));\n+                continue;\n+            }\n+            log.trace(\"Considering recovered xid from\\n name: \" + xaResource.getName() + \"\\n \" + toString(xid));\n             ByteArrayWrapper globalIdWrapper = new ByteArrayWrapper(xid.getGlobalTransactionId());\n             XidBranchesPair xidNamesPair = ourXids.get(globalIdWrapper);\n             \n@@ -226,17 +230,24 @@ private static String toString(Xid xid) {\n         StringBuilder s = new StringBuilder();\n         s.append(\"[Xid:class=\").append(xid.getClass().getSimpleName()).append(\":globalId=\");\n         byte[] globalId = xid.getGlobalTransactionId();\n-        for (int i = 0; i < globalId.length; i++) {\n-            s.append(Integer.toHexString(globalId[i]));\n+        if (globalId == null) {\n+            s.append(\"null\");\n+        } else {\n+            for (int i = 0; i < globalId.length; i++) {\n+                s.append(Integer.toHexString(globalId[i]));\n+            }\n+            s.append(\",length=\").append(globalId.length);\n         }\n-        s.append(\",length=\").append(globalId.length);\n         s.append(\",branchId=\");\n         byte[] branchId = xid.getBranchQualifier();\n-        for (int i = 0; i < branchId.length; i++) {\n-            s.append(Integer.toHexString(branchId[i]));\n+        if (branchId == null) {\n+            s.append(\"null\");\n+        } else {\n+            for (int i = 0; i < branchId.length; i++) {\n+                s.append(Integer.toHexString(branchId[i]));\n+            }\n+            s.append(\",length=\").append(branchId.length);\n         }\n-        s.append(\",length=\");\n-        s.append(branchId.length);\n         s.append(\"]\");\n         return s.toString();\n     }",
                "deletions": 8
            },
            {
                "sha": "bc8ec2fbcae7df41c5cbd1a125dedbe147c6bef6",
                "filename": "geronimo-transaction/src/test/java/org/apache/geronimo/transaction/manager/RecoveryTest.java",
                "blob_url": "https://github.com/apache/geronimo-txmanager/blob/01e4d641665eadc84828157899ea1e86c08383f9/geronimo-transaction/src/test/java/org/apache/geronimo/transaction/manager/RecoveryTest.java",
                "raw_url": "https://github.com/apache/geronimo-txmanager/raw/01e4d641665eadc84828157899ea1e86c08383f9/geronimo-transaction/src/test/java/org/apache/geronimo/transaction/manager/RecoveryTest.java",
                "status": "modified",
                "changes": 61,
                "additions": 61,
                "contents_url": "https://api.github.com/repos/apache/geronimo-txmanager/contents/geronimo-transaction/src/test/java/org/apache/geronimo/transaction/manager/RecoveryTest.java?ref=01e4d641665eadc84828157899ea1e86c08383f9",
                "patch": "@@ -99,6 +99,67 @@ public void test2ResOnlineAfterRecoveryStart() throws Exception {\n \n     }\n \n+    public void testInvalidXid() throws Exception {\n+        final Xid[] xids = new Xid[] { new Xid() {\n+            @Override\n+            public int getFormatId() {\n+                return 0;\n+            }\n+            @Override\n+            public byte[] getGlobalTransactionId() {\n+                return null;\n+            }\n+            @Override\n+            public byte[] getBranchQualifier() {\n+                return new byte[0];\n+            }\n+        } };\n+        final NamedXAResource xares = new NamedXAResource() {\n+            @Override\n+            public String getName() {\n+                return RM1;\n+            }\n+            @Override\n+            public void commit(Xid xid, boolean b) throws XAException {\n+            }\n+            @Override\n+            public void end(Xid xid, int i) throws XAException {\n+            }\n+            @Override\n+            public void forget(Xid xid) throws XAException {\n+            }\n+            @Override\n+            public int getTransactionTimeout() throws XAException {\n+                return 0;\n+            }\n+            @Override\n+            public boolean isSameRM(XAResource xaResource) throws XAException {\n+                return false;\n+            }\n+            @Override\n+            public int prepare(Xid xid) throws XAException {\n+                return 0;\n+            }\n+            @Override\n+            public Xid[] recover(int i) throws XAException {\n+                return xids;\n+            }\n+            @Override\n+            public void rollback(Xid xid) throws XAException {\n+            }\n+            @Override\n+            public boolean setTransactionTimeout(int i) throws XAException {\n+                return false;\n+            }\n+            @Override\n+            public void start(Xid xid, int i) throws XAException {\n+            }\n+        };\n+        prepareForReplay();\n+        Recovery recovery = txManager.recovery;\n+        recovery.recoverResourceManager(xares);\n+    }\n+\n     private void addBranch(MockTransactionInfo[] txInfos, MockXAResource xaRes) throws XAException {\n         for (int i = 0; i < txInfos.length; i++) {\n             MockTransactionInfo txInfo = txInfos[i];",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "geronimo-txmanager",
        "message": "This NPE fix never got ported from the 2.2 branch\n\ngit-svn-id: https://svn.apache.org/repos/asf/geronimo/components/txmanager/trunk@1001148 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/geronimo-txmanager/commit/0aa5544a7d0e4dae2bc58137cb15b4ab222d8d82",
        "parent": "https://github.com/apache/geronimo-txmanager/commit/afcf0cd53f7e80b17d5e72cd29fc3b26c178edd7",
        "bug_id": "geronimo-txmanager_2",
        "file": [
            {
                "sha": "65126b7d63eaf1abb508960d038a101978482502",
                "filename": "geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoverTask.java",
                "blob_url": "https://github.com/apache/geronimo-txmanager/blob/0aa5544a7d0e4dae2bc58137cb15b4ab222d8d82/geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoverTask.java",
                "raw_url": "https://github.com/apache/geronimo-txmanager/raw/0aa5544a7d0e4dae2bc58137cb15b4ab222d8d82/geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoverTask.java",
                "status": "modified",
                "changes": 10,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/geronimo-txmanager/contents/geronimo-transaction/src/main/java/org/apache/geronimo/transaction/manager/RecoverTask.java?ref=0aa5544a7d0e4dae2bc58137cb15b4ab222d8d82",
                "patch": "@@ -47,10 +47,12 @@ public RecoverTask(RetryScheduler retryScheduler, NamedXAResourceFactory namedXA\n     public void run() {\n         try {\n             NamedXAResource namedXAResource = namedXAResourceFactory.getNamedXAResource();\n-            try {\n-                recovery.recoverResourceManager(namedXAResource);\n-            } finally {\n-                namedXAResourceFactory.returnNamedXAResource(namedXAResource);\n+            if (namedXAResource != null) {\n+                try {\n+                    recovery.recoverResourceManager(namedXAResource);\n+                } finally {\n+                    namedXAResourceFactory.returnNamedXAResource(namedXAResource);\n+                }\n             }\n             return;\n         } catch (XAException e) {",
                "deletions": 4
            }
        ]
    },
    {
        "repo": "geronimo-txmanager",
        "message": "GERONIMO-5152 fix potential NPE, if a null xaResource is returned\n\ngit-svn-id: https://svn.apache.org/repos/asf/geronimo/components/txmanager/trunk@987165 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/geronimo-txmanager/commit/081b84ec154bfff6ee83ca5ea0b3c35d4b4f0674",
        "parent": "https://github.com/apache/geronimo-txmanager/commit/6dccacd297ff69accd4714485248e25a0d415451",
        "bug_id": "geronimo-txmanager_3",
        "file": [
            {
                "sha": "0818ba5c60e3c6c3cd695d72c11c046153a82cd9",
                "filename": "geronimo-connector/src/main/java/org/apache/geronimo/connector/ActivationSpecNamedXAResourceFactory.java",
                "blob_url": "https://github.com/apache/geronimo-txmanager/blob/081b84ec154bfff6ee83ca5ea0b3c35d4b4f0674/geronimo-connector/src/main/java/org/apache/geronimo/connector/ActivationSpecNamedXAResourceFactory.java",
                "raw_url": "https://github.com/apache/geronimo-txmanager/raw/081b84ec154bfff6ee83ca5ea0b3c35d4b4f0674/geronimo-connector/src/main/java/org/apache/geronimo/connector/ActivationSpecNamedXAResourceFactory.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/geronimo-txmanager/contents/geronimo-connector/src/main/java/org/apache/geronimo/connector/ActivationSpecNamedXAResourceFactory.java?ref=081b84ec154bfff6ee83ca5ea0b3c35d4b4f0674",
                "patch": "@@ -51,7 +51,7 @@ public String getName() {\n     public NamedXAResource getNamedXAResource() throws SystemException {\n         try {\n             XAResource[] xaResources = resourceAdapter.getXAResources(new ActivationSpec[]{activationSpec});\n-            if (xaResources == null || xaResources.length == 0) {\n+            if (xaResources == null || xaResources.length == 0 || xaResources[0] == null) {\n                 return null;\n             }\n             return new WrapperNamedXAResource(xaResources[0], name);",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "geronimo-txmanager",
        "message": "GERONIMO-4639 fix npe in MultiPoolConnectionInterceptor, thanks to bert nor\n\ngit-svn-id: https://svn.apache.org/repos/asf/geronimo/components/txmanager/trunk@776751 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/geronimo-txmanager/commit/549bc0302b7a8805b627468ca2e4e959e47a14ae",
        "parent": "https://github.com/apache/geronimo-txmanager/commit/ab37116d023f12c94045f195cfddfc82c6b3b933",
        "bug_id": "geronimo-txmanager_4",
        "file": [
            {
                "sha": "3534f7378fc247763c3a5c3c5e81af4e8eae1971",
                "filename": "geronimo-connector/src/main/java/org/apache/geronimo/connector/outbound/MultiPoolConnectionInterceptor.java",
                "blob_url": "https://github.com/apache/geronimo-txmanager/blob/549bc0302b7a8805b627468ca2e4e959e47a14ae/geronimo-connector/src/main/java/org/apache/geronimo/connector/outbound/MultiPoolConnectionInterceptor.java",
                "raw_url": "https://github.com/apache/geronimo-txmanager/raw/549bc0302b7a8805b627468ca2e4e959e47a14ae/geronimo-connector/src/main/java/org/apache/geronimo/connector/outbound/MultiPoolConnectionInterceptor.java",
                "status": "modified",
                "changes": 22,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/geronimo-txmanager/contents/geronimo-connector/src/main/java/org/apache/geronimo/connector/outbound/MultiPoolConnectionInterceptor.java?ref=549bc0302b7a8805b627468ca2e4e959e47a14ae",
                "patch": "@@ -181,18 +181,24 @@ public SubjectCRIKey(\n                     ^ (cri == null ? 1 : cri.hashCode());\n         }\n \n+        @Override\n         public int hashCode() {\n             return hashcode;\n         }\n \n-        public boolean equals(Object other) {\n-            if (!(other instanceof SubjectCRIKey)) {\n-                return false;\n-            }\n-            SubjectCRIKey o = (SubjectCRIKey) other;\n-            return hashcode == o.hashcode &&\n-                    (subject == null ? o.subject == null : subject.equals(o.subject) && \n-                    cri == null ? o.cri == null : cri.equals(o.cri));\n+        @Override\n+        public boolean equals(Object o) {\n+            if (this == o) return true;\n+            if (o == null || getClass() != o.getClass()) return false;\n+\n+            SubjectCRIKey that = (SubjectCRIKey) o;\n+\n+            if (hashcode != that.hashcode) return false;\n+            if (cri != null ? !cri.equals(that.cri) : that.cri != null) return false;\n+            if (subject != null ? !subject.equals(that.subject) : that.subject != null) return false;\n+\n+            return true;\n         }\n+        \n     }\n }",
                "deletions": 8
            }
        ]
    }
]