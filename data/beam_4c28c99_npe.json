[
    {
        "repo": "beam",
        "commit": "https://github.com/apache/beam/commit/4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c",
        "bug_id": "beam_4c28c99",
        "message": "[BEAM-2017] Fix NPE in DataflowRunner when there are no metrics",
        "parent": "https://github.com/apache/beam/commit/d54ace4f3113e8e7d17a0a2f6a5107b3e910b5d9",
        "patched_files": [
            "DataflowMetrics.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 6,
                "raw_url": "https://github.com/apache/beam/raw/4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowMetrics.java",
                "contents_url": "https://api.github.com/repos/apache/beam/contents/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowMetrics.java?ref=4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c",
                "filename": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowMetrics.java",
                "deletions": 1,
                "sha": "d4d29dd7a9af3f7705b09cb88e92c94060194ee9",
                "blob_url": "https://github.com/apache/beam/blob/4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowMetrics.java",
                "patch": "@@ -17,11 +17,14 @@\n  */\n package org.apache.beam.runners.dataflow;\n \n+import static com.google.common.base.MoreObjects.firstNonNull;\n+\n import com.google.api.services.dataflow.model.JobMetrics;\n import com.google.auto.value.AutoValue;\n import com.google.common.base.Objects;\n import com.google.common.collect.ImmutableList;\n import java.io.IOException;\n+import java.util.Collections;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n@@ -169,7 +172,9 @@ private MetricQueryResults queryServiceForMetrics(MetricsFilter filter) {\n       LOG.warn(\"Unable to query job metrics.\\n\");\n       return DataflowMetricQueryResults.create(counters, distributions, gauges);\n     }\n-    metricUpdates = jobMetrics.getMetrics();\n+    metricUpdates = firstNonNull(\n+        jobMetrics.getMetrics(),\n+        Collections.<com.google.api.services.dataflow.model.MetricUpdate>emptyList());\n     return populateMetricQueryResults(metricUpdates, filter);\n   }\n ",
                "changes": 7
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/beam/raw/4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c/runners/google-cloud-dataflow-java/src/test/java/org/apache/beam/runners/dataflow/DataflowMetricsTest.java",
                "contents_url": "https://api.github.com/repos/apache/beam/contents/runners/google-cloud-dataflow-java/src/test/java/org/apache/beam/runners/dataflow/DataflowMetricsTest.java?ref=4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c",
                "filename": "runners/google-cloud-dataflow-java/src/test/java/org/apache/beam/runners/dataflow/DataflowMetricsTest.java",
                "deletions": 1,
                "sha": "ddb719cc2230e469a038e234ff7607da393bdbf1",
                "blob_url": "https://github.com/apache/beam/blob/4c28c99cac26c1ec42b9bc9d20a03e53c43b1a7c/runners/google-cloud-dataflow-java/src/test/java/org/apache/beam/runners/dataflow/DataflowMetricsTest.java",
                "patch": "@@ -98,7 +98,7 @@ public void testEmptyMetricUpdates() throws IOException {\n     job.jobId = JOB_ID;\n \n     JobMetrics jobMetrics = new JobMetrics();\n-    jobMetrics.setMetrics(ImmutableList.<MetricUpdate>of());\n+    jobMetrics.setMetrics(null /* this is how the APIs represent empty metrics */);\n     DataflowClient dataflowClient = mock(DataflowClient.class);\n     when(dataflowClient.getJobMetrics(JOB_ID)).thenReturn(jobMetrics);\n ",
                "changes": 2
            }
        ],
        "unit_tests": [
            "DataflowMetricsTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "runners/google-cloud-dataflow-java/src/test/java/org/apache/beam/runners/dataflow/DataflowMetricsTest.java",
        "buggy_files": [
            "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowMetrics.java"
        ],
        "fixed": true
    }
]