[
    {
        "repo": "sling-org-apache-sling-security",
        "commit": "https://github.com/apache/sling-org-apache-sling-security/commit/1fa2f4de0a375a7d93338c7d6d640867590fefd3",
        "bug_id": "sling-org-apache-sling-security_1fa2f4d",
        "message": "SLING-4982 - NPE in ContentDispositionFilter\n\ngit-svn-id: https://svn.apache.org/repos/asf/sling/trunk@1700424 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/sling-org-apache-sling-security/commit/434f2a8d1e7dff11ddb7b1fa5167b2a792db7d91",
        "patched_files": [
            "ContentDispositionFilter.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 2,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-security/raw/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-security/contents/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java?ref=1fa2f4de0a375a7d93338c7d6d640867590fefd3",
                "filename": "src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "deletions": 2,
                "sha": "96b2df0913d42087be5ca4f857e6deda3eb6fe7e",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-security/blob/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java",
                "patch": "@@ -285,13 +285,13 @@ private boolean isJcrData(Resource resource){\n             boolean jcrData = false;\n             if (resource!= null) {\n                 ValueMap props = resource.adaptTo(ValueMap.class);\n-                if (props.containsKey(PROP_JCR_DATA) ) {\n+                if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n                     jcrData = true;\n                 } else {\n                     Resource jcrContent = resource.getChild(JCR_CONTENT_LEAF);\n                     if (jcrContent!= null) {\n                         props = jcrContent.adaptTo(ValueMap.class);\n-                        if (props.containsKey(PROP_JCR_DATA) ) {\n+                        if (props != null && props.containsKey(PROP_JCR_DATA) ) {\n                             jcrData = true;\n                         }\n                     }",
                "changes": 4
            },
            {
                "status": "modified",
                "additions": 57,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-security/raw/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-security/contents/src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java?ref=1fa2f4de0a375a7d93338c7d6d640867590fefd3",
                "filename": "src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
                "deletions": 0,
                "sha": "49b1ae7cc849813f4b8ce391ca589a39c2681dd5",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-security/blob/1fa2f4de0a375a7d93338c7d6d640867590fefd3/src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
                "patch": "@@ -1474,4 +1474,61 @@ public void test_isJcrData5() throws Throwable {\n         \n         Assert.assertTrue(result);\n     }\n+    \n+    @Test\n+    public void test_isJcrData6() throws Throwable {\n+        contentDispositionFilter = new ContentDispositionFilter();\n+        final SlingHttpServletRequest request = context.mock(SlingHttpServletRequest.class);\n+        final SlingHttpServletResponse response = context.mock(SlingHttpServletResponse.class);       \n+        final ContentDispositionFilter.RewriterResponse rewriterResponse = contentDispositionFilter. new RewriterResponse(request, response);\n+        \n+        \n+        final Resource resource = context.mock(Resource.class);\n+        final ValueMap properties = context.mock(ValueMap.class);\n+        \n+        context.checking(new Expectations() {\n+            {\n+                allowing(resource).adaptTo(ValueMap.class);\n+                will(returnValue(null));\n+                allowing(resource).getChild(JCR_CONTENT_LEAF);\n+                will(returnValue(null));\n+            }\n+        });     \n+        \n+        Boolean result = (Boolean) PrivateAccessor.invoke(rewriterResponse,\"isJcrData\",  new Class[]{Resource.class},new Object[]{resource});\n+        \n+        Assert.assertFalse(result);\n+    }\n+    \n+    \n+    @Test\n+    public void test_isJcrData7() throws Throwable {\n+        contentDispositionFilter = new ContentDispositionFilter();\n+        final SlingHttpServletRequest request = context.mock(SlingHttpServletRequest.class);\n+        final SlingHttpServletResponse response = context.mock(SlingHttpServletResponse.class);       \n+        final ContentDispositionFilter.RewriterResponse rewriterResponse = contentDispositionFilter. new RewriterResponse(request, response);\n+        \n+        final Resource child = context.mock(Resource.class, \"child\");\n+        final Resource resource = context.mock(Resource.class, \"resource\" );\n+        final ValueMap properties = context.mock(ValueMap.class);\n+        final ValueMap childPropoerties = context.mock(ValueMap.class, \"childPropoerties\");\n+\n+        \n+        context.checking(new Expectations() {\n+            {\n+                allowing(resource).adaptTo(ValueMap.class);\n+                will(returnValue(properties));\n+                allowing(properties).containsKey(PROP_JCR_DATA);\n+                will(returnValue(false));\n+                allowing(resource).getChild(JCR_CONTENT_LEAF);\n+                will(returnValue(child));\n+                allowing(child).adaptTo(ValueMap.class);\n+                will(returnValue(null));\n+            }\n+        });     \n+        \n+        Boolean result = (Boolean) PrivateAccessor.invoke(rewriterResponse,\"isJcrData\",  new Class[]{Resource.class},new Object[]{resource});\n+        \n+        Assert.assertFalse(result);\n+    }\n }\n\\ No newline at end of file",
                "changes": 57
            }
        ],
        "unit_tests": [
            "ContentDispositionFilterTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "src/test/java/org/apache/sling/security/impl/ContentDispositionFilterTest.java",
        "buggy_files": [
            "src/main/java/org/apache/sling/security/impl/ContentDispositionFilter.java"
        ],
        "fixed": true
    }
]