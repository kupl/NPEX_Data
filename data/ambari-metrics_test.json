{
    "ambari-metrics_ed51d8f": {
        "repo": "ambari-metrics",
        "message": "AMBARI-16949 Metrics Collector API shows NPE if we use wildcard (%25 for '%') for metric name (Jungtaek Lim via avijayan)",
        "commit": "https://github.com/apache/ambari-metrics/commit/ed51d8fd7ca8493312a953a1b64b49c001cdcd87",
        "parent": "https://github.com/apache/ambari-metrics/commit/19125fc40d4d3efcf35de07381bdd55988a2254b",
        "bug_id": "ambari-metrics_ed51d8f",
        "file": [
            {
                "sha": "bbd6d839ef71ed47ace28f6fdec452d214d6e073",
                "filename": "ambari-metrics-timelineservice/src/main/java/org/apache/hadoop/yarn/server/applicationhistoryservice/metrics/timeline/PhoenixHBaseAccessor.java",
                "blob_url": "https://github.com/apache/ambari-metrics/blob/ed51d8fd7ca8493312a953a1b64b49c001cdcd87/ambari-metrics-timelineservice/src/main/java/org/apache/hadoop/yarn/server/applicationhistoryservice/metrics/timeline/PhoenixHBaseAccessor.java",
                "raw_url": "https://github.com/apache/ambari-metrics/raw/ed51d8fd7ca8493312a953a1b64b49c001cdcd87/ambari-metrics-timelineservice/src/main/java/org/apache/hadoop/yarn/server/applicationhistoryservice/metrics/timeline/PhoenixHBaseAccessor.java",
                "status": "modified",
                "changes": 22,
                "additions": 19,
                "contents_url": "https://api.github.com/repos/apache/ambari-metrics/contents/ambari-metrics-timelineservice/src/main/java/org/apache/hadoop/yarn/server/applicationhistoryservice/metrics/timeline/PhoenixHBaseAccessor.java?ref=ed51d8fd7ca8493312a953a1b64b49c001cdcd87",
                "patch": "@@ -850,7 +850,7 @@ private void appendMetricFromResultSet(TimelineMetrics metrics, Condition condit\n                                          Map<String, List<Function>> metricFunctions,\n                                          ResultSet rs) throws SQLException, IOException {\n     String metricName = rs.getString(\"METRIC_NAME\");\n-    List<Function> functions = metricFunctions.get(metricName);\n+    List<Function> functions = findMetricFunctions(metricFunctions, metricName);\n \n     // Apply aggregation function if present\n     if ((functions != null && !functions.isEmpty())) {\n@@ -990,7 +990,7 @@ private void appendAggregateMetricFromResultSet(TimelineMetrics metrics,\n       ResultSet rs) throws SQLException {\n \n     String metricName = rs.getString(\"METRIC_NAME\");\n-    List<Function> functions = metricFunctions.get(metricName);\n+    List<Function> functions = findMetricFunctions(metricFunctions, metricName);\n \n     for (Function aggregateFunction : functions) {\n       SingleValuedTimelineMetric metric;\n@@ -1027,7 +1027,7 @@ private void getLatestAggregateMetricRecords(Condition condition,\n       try {\n         rs = stmt.executeQuery();\n         while (rs.next()) {\n-          List<Function> functions = metricFunctions.get(metricName);\n+          List<Function> functions = findMetricFunctions(metricFunctions, metricName);\n           if (functions != null) {\n             for (Function f : functions) {\n               SingleValuedTimelineMetric metric =\n@@ -1108,6 +1108,22 @@ private void validateConditionIsNotEmpty(Condition condition) {\n     }\n   }\n \n+  private List<Function> findMetricFunctions(Map<String, List<Function>> metricFunctions,\n+      String metricName) {\n+    if (metricFunctions.containsKey(metricName)) {\n+      return metricFunctions.get(metricName);\n+    }\n+\n+    for (Map.Entry<String, List<Function>> nameToFunctions : metricFunctions.entrySet()) {\n+      String metricRegEx = nameToFunctions.getKey().replace(\"%\", \".*\");\n+      if (metricName.matches(metricRegEx)) {\n+        return nameToFunctions.getValue();\n+      }\n+    }\n+\n+    return null;\n+  }\n+\n   public void saveHostAggregateRecords(Map<TimelineMetric, MetricHostAggregate> hostAggregateMap,\n                                        String phoenixTableName) throws SQLException {\n ",
                "deletions": 3
            }
        ],
        "patched_files": [
            "PhoenixHBaseAccessor.java"
        ],
        "unit_tests": [
            "PhoenixHBaseAccessorTest.java"
        ]
    }
}