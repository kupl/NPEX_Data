[
    {
        "repo": "directory-kerby",
        "commit": "https://github.com/apache/directory-kerby/commit/db14ad6b219c969e744c1d14e40f19230a5a5498",
        "bug_id": "directory-kerby_db14ad6",
        "message": "DIRKRB-637 - NPE in GssAcceptCred when no initial GSSCredential is passed to manager.createContext",
        "parent": "https://github.com/apache/directory-kerby/commit/6d38f80bd9e4952f0f272728a164c7ab00e81e6c",
        "patched_files": [
            "GssAcceptCred.java",
            "CredUtils.java",
            "GssNameElement.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 0,
                "raw_url": "https://github.com/apache/directory-kerby/raw/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/integration-test/src/test/java/org/apache/kerby/kerberos/kerb/integration/test/KerbyGssAppTest.java",
                "contents_url": "https://api.github.com/repos/apache/directory-kerby/contents/kerby-kerb/integration-test/src/test/java/org/apache/kerby/kerberos/kerb/integration/test/KerbyGssAppTest.java?ref=db14ad6b219c969e744c1d14e40f19230a5a5498",
                "filename": "kerby-kerb/integration-test/src/test/java/org/apache/kerby/kerberos/kerb/integration/test/KerbyGssAppTest.java",
                "deletions": 6,
                "sha": "b6f4e43100b4460cb39f6bd60717e486b5105c3c",
                "blob_url": "https://github.com/apache/directory-kerby/blob/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/integration-test/src/test/java/org/apache/kerby/kerberos/kerb/integration/test/KerbyGssAppTest.java",
                "patch": "@@ -21,7 +21,6 @@\n \n import org.apache.kerby.kerberos.kerb.gss.KerbyGssProvider;\n import org.junit.Before;\n-import org.junit.Test;\n \n import java.security.Provider;\n \n@@ -35,9 +34,4 @@ public void setUp() throws Exception {\n         super.setUp();\n     }\n \n-    @Test\n-    @org.junit.Ignore\n-    public void testServerWithoutInitialCredential() throws Exception {\n-        super.testServerWithoutInitialCredential();\n-    }\n }",
                "changes": 6
            },
            {
                "status": "modified",
                "additions": 7,
                "raw_url": "https://github.com/apache/directory-kerby/raw/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/CredUtils.java",
                "contents_url": "https://api.github.com/repos/apache/directory-kerby/contents/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/CredUtils.java?ref=db14ad6b219c969e744c1d14e40f19230a5a5498",
                "filename": "kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/CredUtils.java",
                "deletions": 1,
                "sha": "4088b5c1a72e7344be2d2d30997ce3fc684606ca",
                "blob_url": "https://github.com/apache/directory-kerby/blob/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/CredUtils.java",
                "patch": "@@ -52,7 +52,13 @@ public static KerberosTicket getKerberosTicketFromContext(GSSCaller caller,\n     public static KeyTab getKeyTabFromContext(KerberosPrincipal principal) throws GSSException {\n         Set<KeyTab> tabs = getContextCredentials(KeyTab.class);\n         for (KeyTab tab : tabs) {\n-            KerberosKey[] keys = tab.getKeys(principal);\n+            // Use the supplied principal, fall back to the principal of the KeyTab if none is supplied\n+            KerberosPrincipal princ = principal;\n+            if (princ == null) {\n+                princ = tab.getPrincipal();\n+            }\n+\n+            KerberosKey[] keys = tab.getKeys(princ);\n             if (keys != null && keys.length > 0) {\n                 return tab;\n             }",
                "changes": 8
            },
            {
                "status": "modified",
                "additions": 14,
                "raw_url": "https://github.com/apache/directory-kerby/raw/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssAcceptCred.java",
                "contents_url": "https://api.github.com/repos/apache/directory-kerby/contents/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssAcceptCred.java?ref=db14ad6b219c969e744c1d14e40f19230a5a5498",
                "filename": "kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssAcceptCred.java",
                "deletions": 3,
                "sha": "120f9de12c09464ed659d016d70d3bb81c459cce",
                "blob_url": "https://github.com/apache/directory-kerby/blob/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssAcceptCred.java",
                "patch": "@@ -21,6 +21,8 @@\n \n \n import org.ietf.jgss.GSSException;\n+import org.ietf.jgss.GSSName;\n+\n import sun.security.jgss.GSSCaller;\n \n import javax.security.auth.kerberos.KerberosKey;\n@@ -34,15 +36,24 @@\n     public static GssAcceptCred getInstance(final GSSCaller caller,\n                                             GssNameElement name, int lifeTime) throws GSSException {\n \n-        KerberosPrincipal princ = new KerberosPrincipal(name.getPrincipalName().getName(),\n-                name.getPrincipalName().getNameType().getValue());\n-        KeyTab keyTab = CredUtils.getKeyTabFromContext(princ);\n+        KeyTab keyTab = null;\n+        if (name == null) {\n+            keyTab = CredUtils.getKeyTabFromContext(null);\n+        } else {\n+            KerberosPrincipal princ = new KerberosPrincipal(name.getPrincipalName().getName(),\n+                                                            name.getPrincipalName().getNameType().getValue());\n+            keyTab = CredUtils.getKeyTabFromContext(princ);\n+        }\n \n         if (keyTab == null) {\n             throw new GSSException(GSSException.NO_CRED, -1,\n                     \"Failed to find any Kerberos credential for \" + name.getPrincipalName().getName());\n         }\n \n+        if (name == null) {\n+            name = GssNameElement.getInstance(keyTab.getPrincipal().getName(), GSSName.NT_HOSTBASED_SERVICE);\n+        }\n+\n         return new GssAcceptCred(caller, name, keyTab, lifeTime);\n     }\n ",
                "changes": 17
            },
            {
                "status": "modified",
                "additions": 4,
                "raw_url": "https://github.com/apache/directory-kerby/raw/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssNameElement.java",
                "contents_url": "https://api.github.com/repos/apache/directory-kerby/contents/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssNameElement.java?ref=db14ad6b219c969e744c1d14e40f19230a5a5498",
                "filename": "kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssNameElement.java",
                "deletions": 0,
                "sha": "619b7639dc00982fc1acb0f9b825d54c79d4087d",
                "blob_url": "https://github.com/apache/directory-kerby/blob/db14ad6b219c969e744c1d14e40f19230a5a5498/kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssNameElement.java",
                "patch": "@@ -68,6 +68,10 @@ public static NameType toKerbyNameType(Oid nameType) throws GSSException {\n \n     public static GssNameElement getInstance(String name, Oid oidNameType)\n             throws GSSException {\n+        if (oidNameType == null) {\n+            PrincipalName principalName = new PrincipalName(name);\n+            return new GssNameElement(principalName, null);\n+        }\n         PrincipalName principalName = new PrincipalName(name, toKerbyNameType(oidNameType));\n         return new GssNameElement(principalName, oidNameType);\n     }",
                "changes": 4
            }
        ],
        "unit_tests": [
            "KerbyGssAppTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "kerby-kerb/integration-test/src/test/java/org/apache/kerby/kerberos/kerb/integration/test/KerbyGssAppTest.java",
        "buggy_files": [
            "kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssAcceptCred.java",
            "kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/CredUtils.java",
            "kerby-kerb/kerb-gssapi/src/main/java/org/apache/kerby/kerberos/kerb/gss/impl/GssNameElement.java"
        ],
        "fixed": true
    }
]