[
    {
        "repo": "incubator-pinot",
        "message": "Possible fix for NPE seen in this test. (#4684)",
        "commit": "https://github.com/apache/incubator-pinot/commit/2d20c64793474125a575df3b9b0fd8d90a1afd1e",
        "parent": "https://github.com/apache/incubator-pinot/commit/18a9f2fa62e1aebe5c5678fa696faffc44e548d7",
        "bug_id": "incubator-pinot_1",
        "file": [
            {
                "sha": "50042e9ae61347b801430836d28859154d2a94ad",
                "filename": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/2d20c64793474125a575df3b9b0fd8d90a1afd1e/pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/2d20c64793474125a575df3b9b0fd8d90a1afd1e/pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManagerTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManagerTest.java?ref=2d20c64793474125a575df3b9b0fd8d90a1afd1e",
                "patch": "@@ -1559,7 +1559,7 @@ protected int getPartitionCount(StreamConfig metadata) {\n     @Override\n     public LLCRealtimeSegmentZKMetadata getRealtimeSegmentZKMetadata(String realtimeTableName, String segmentName,\n         Stat stat) {\n-      LLCRealtimeSegmentZKMetadata metadata = super.getRealtimeSegmentZKMetadata(realtimeTableName, segmentName, stat);\n+      LLCRealtimeSegmentZKMetadata metadata = _metadataMap.get(segmentName);\n       switch (_scenario) {\n         case SCENARIO_1_ZK_VERSION_NUM_HAS_CHANGE:\n           // Mock another controller has already updated the segment metadata, which makes the version number self increase.",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Handle NPE from getting live instance (#4528)",
        "commit": "https://github.com/apache/incubator-pinot/commit/6e209e4e0ef138f8c21d597aeb20d1993fd1af2b",
        "parent": "https://github.com/apache/incubator-pinot/commit/0a13d98760cf5ac557e5ea47766b68a4ad3131b7",
        "bug_id": "incubator-pinot_2",
        "file": [
            {
                "sha": "2079dbeb64c849fdd2bc8220dca5a02d8f914f77",
                "filename": "pinot-common/src/main/java/org/apache/pinot/common/utils/ServiceStatus.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/6e209e4e0ef138f8c21d597aeb20d1993fd1af2b/pinot-common/src/main/java/org/apache/pinot/common/utils/ServiceStatus.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/6e209e4e0ef138f8c21d597aeb20d1993fd1af2b/pinot-common/src/main/java/org/apache/pinot/common/utils/ServiceStatus.java",
                "status": "modified",
                "changes": 15,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/org/apache/pinot/common/utils/ServiceStatus.java?ref=6e209e4e0ef138f8c21d597aeb20d1993fd1af2b",
                "patch": "@@ -24,6 +24,7 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import javax.annotation.Nullable;\n import org.apache.helix.HelixAdmin;\n import org.apache.helix.HelixDataAccessor;\n import org.apache.helix.HelixManager;\n@@ -209,6 +210,7 @@ public synchronized String getStatusDescription() {\n           getResourceListAsString(), _instanceName);\n     }\n \n+    @Nullable\n     protected abstract T getState(String resourceName);\n \n     protected abstract Map<String, String> getPartitionStateMap(T state);\n@@ -381,12 +383,21 @@ public IdealStateAndCurrentStateMatchServiceStatusCallback(HelixManager helixMan\n       super(helixManager, clusterName, instanceName, resourcesToMonitor, minResourcesStartPercent);\n     }\n \n+    /**\n+     * Returns the current state for the given resource, or {@code null} if instance is not live or current state does\n+     * not exist.\n+     */\n+    @Nullable\n     @Override\n     protected CurrentState getState(String resourceName) {\n       PropertyKey.Builder keyBuilder = _helixDataAccessor.keyBuilder();\n       LiveInstance liveInstance = _helixDataAccessor.getProperty(keyBuilder.liveInstance(_instanceName));\n-      String sessionId = liveInstance.getSessionId();\n-      return _helixDataAccessor.getProperty(keyBuilder.currentState(_instanceName, sessionId, resourceName));\n+      if (liveInstance == null) {\n+        return null;\n+      } else {\n+        String sessionId = liveInstance.getSessionId();\n+        return _helixDataAccessor.getProperty(keyBuilder.currentState(_instanceName, sessionId, resourceName));\n+      }\n     }\n \n     @Override",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[TE] fix create alert error message NPE (#4594)\n\nThis PR fixes the create alert error message null pointer exception.",
        "commit": "https://github.com/apache/incubator-pinot/commit/0a3230928a52814f6926b38038a2f0c9bc704f31",
        "parent": "https://github.com/apache/incubator-pinot/commit/5e525d095cfc5d5aa20a2f3de4f9f46d15c4fa22",
        "bug_id": "incubator-pinot_3",
        "file": [
            {
                "sha": "cc31aa5ab1c28cb839c9c2d1b3d8242c85a044a2",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/validators/DetectionConfigValidator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/0a3230928a52814f6926b38038a2f0c9bc704f31/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/validators/DetectionConfigValidator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/0a3230928a52814f6926b38038a2f0c9bc704f31/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/validators/DetectionConfigValidator.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/validators/DetectionConfigValidator.java?ref=0a3230928a52814f6926b38038a2f0c9bc704f31",
                "patch": "@@ -159,7 +159,7 @@ private void validateMetricAlertConfig(Map<String, Object> detectionYaml, String\n     // Check if the metric defined in the config exists\n     MetricConfigDTO metricConfig = provider.fetchMetric(metric, dataset);\n     Preconditions.checkArgument(metricConfig != null,\n-        \"Metric doesn't exist in our records. Metric \" + metric + \" in sub-alert \" + alertName);\n+        \"Metric doesn't exist in our records. Metric \" + metric + \" Dataset \" + dataset + \" in sub-alert \" + alertName);\n \n     // Check if the dataset defined in the config exists\n     DatasetConfigDTO datasetConfig = provider",
                "deletions": 1
            },
            {
                "sha": "8ddc66f269ed5dd4fa81327448a36f460d2ef1ac",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/0a3230928a52814f6926b38038a2f0c9bc704f31/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/0a3230928a52814f6926b38038a2f0c9bc704f31/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java",
                "status": "modified",
                "changes": 10,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java?ref=0a3230928a52814f6926b38038a2f0c9bc704f31",
                "patch": "@@ -234,10 +234,12 @@ private Response processBadRequestResponse(String type, String operation, String\n     Map<String, String> responseMessage = new HashMap<>();\n     LOG.warn(\"Validation error while {} {} with payload {}\", operation, type, payload, e);\n     responseMessage.put(\"message\", \"Validation Error in \" + type + \"! \" + e.getMessage());\n-    StringWriter sw = new StringWriter();\n-    PrintWriter pw = new PrintWriter(sw);\n-    e.getCause().printStackTrace(pw);\n-    responseMessage.put(\"more-info\", \"Error = \" + sw.toString());\n+    if (e.getCause() != null) {\n+      StringWriter sw = new StringWriter();\n+      PrintWriter pw = new PrintWriter(sw);\n+      e.getCause().printStackTrace(pw);\n+      responseMessage.put(\"more-info\", \"Error = \" + sw.toString());\n+    }\n     return Response.status(Response.Status.BAD_REQUEST).entity(responseMessage).build();\n   }\n ",
                "deletions": 4
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Modify get tenant names APIs (#4688)\n\nThis PR modifies the logic of getting tenant name APIs.\r\n\r\nThe previous code firstly gets the list of instance names from /INSTANCES ZNode and then gets the instance config one by one from /CONFIG/PARTICIPANT/INSTANCES ZNode. Whereas these two ZNodes may be inconsistent.\r\nThat's why we sometimes encounter flaky NPE when calling these APIs.",
        "commit": "https://github.com/apache/incubator-pinot/commit/51c7a0f6b87f78d73a146607e5e8f4cdb8a6edd9",
        "parent": "https://github.com/apache/incubator-pinot/commit/ce298bae09b316b40fa1af65ce96af2bdfcbc286",
        "bug_id": "incubator-pinot_4",
        "file": [
            {
                "sha": "6ea61c18ba25049557a8b30e55898f16cf611a2e",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/51c7a0f6b87f78d73a146607e5e8f4cdb8a6edd9/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/51c7a0f6b87f78d73a146607e5e8f4cdb8a6edd9/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 15,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=51c7a0f6b87f78d73a146607e5e8f4cdb8a6edd9",
                "patch": "@@ -44,7 +44,6 @@\n import javax.annotation.Nullable;\n import org.apache.commons.configuration.Configuration;\n import org.apache.helix.AccessOption;\n-import org.apache.helix.BaseDataAccessor;\n import org.apache.helix.ClusterMessagingService;\n import org.apache.helix.Criteria;\n import org.apache.helix.HelixAdmin;\n@@ -801,10 +800,9 @@ public boolean isServerTenantDeletable(String tenantName) {\n \n   public Set<String> getAllBrokerTenantNames() {\n     Set<String> tenantSet = new HashSet<>();\n-    List<String> instancesInCluster = _helixAdmin.getInstancesInCluster(_helixClusterName);\n-    for (String instanceName : instancesInCluster) {\n-      InstanceConfig config = _helixDataAccessor.getProperty(_keyBuilder.instanceConfig(instanceName));\n-      for (String tag : config.getTags()) {\n+    List<InstanceConfig> instanceConfigs = getAllHelixInstanceConfigs();\n+    for (InstanceConfig instanceConfig : instanceConfigs) {\n+      for (String tag : instanceConfig.getTags()) {\n         if (TagNameUtils.isBrokerTag(tag)) {\n           tenantSet.add(TagNameUtils.getTenantNameFromTag(tag));\n         }\n@@ -815,10 +813,9 @@ public boolean isServerTenantDeletable(String tenantName) {\n \n   public Set<String> getAllServerTenantNames() {\n     Set<String> tenantSet = new HashSet<>();\n-    List<String> instancesInCluster = _helixAdmin.getInstancesInCluster(_helixClusterName);\n-    for (String instanceName : instancesInCluster) {\n-      InstanceConfig config = _helixDataAccessor.getProperty(_keyBuilder.instanceConfig(instanceName));\n-      for (String tag : config.getTags()) {\n+    List<InstanceConfig> instanceConfigs = getAllHelixInstanceConfigs();\n+    for (InstanceConfig instanceConfig : instanceConfigs) {\n+      for (String tag : instanceConfig.getTags()) {\n         if (TagNameUtils.isServerTag(tag)) {\n           tenantSet.add(TagNameUtils.getTenantNameFromTag(tag));\n         }",
                "deletions": 9
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Better handle NPE from getting instance config (#3758)\n\n* Better handle NPE from getting instance config",
        "commit": "https://github.com/apache/incubator-pinot/commit/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518",
        "parent": "https://github.com/apache/incubator-pinot/commit/4a1c3732ced819fe277afbf298967149b50574cb",
        "bug_id": "incubator-pinot_5",
        "file": [
            {
                "sha": "6ff9f1600109708d9e8b3258dbfa37c8cba48e7b",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotInstanceRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotInstanceRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotInstanceRestletResource.java",
                "status": "modified",
                "changes": 7,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotInstanceRestletResource.java?ref=f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518",
                "patch": "@@ -85,12 +85,13 @@ public Instances getAllInstances() {\n   @ApiOperation(value = \"Get instance information\", produces = MediaType.APPLICATION_JSON)\n   @ApiResponses(value = {@ApiResponse(code = 200, message = \"Success\"), @ApiResponse(code = 404, message = \"Instance not found\"), @ApiResponse(code = 500, message = \"Internal error\")})\n   public String getInstance(\n-      @ApiParam(value = \"Instance name\", required = true, example = \"Server_a.b.com_20000 | Broker_my.broker.com_30000\") @PathParam(\"instanceName\") String instanceName) {\n-    if (!pinotHelixResourceManager.instanceExists(instanceName)) {\n+      @ApiParam(value = \"Instance name\", required = true, example = \"Server_a.b.com_20000 | Broker_my.broker.com_30000\")\n+      @PathParam(\"instanceName\") String instanceName) {\n+    InstanceConfig instanceConfig = pinotHelixResourceManager.getHelixInstanceConfig(instanceName);\n+    if (instanceConfig == null) {\n       throw new ControllerApplicationException(LOGGER, \"Instance \" + instanceName + \" not found\",\n           Response.Status.NOT_FOUND);\n     }\n-    InstanceConfig instanceConfig = pinotHelixResourceManager.getHelixInstanceConfig(instanceName);\n     ObjectNode response = JsonUtils.newObjectNode();\n     response.put(\"instanceName\", instanceConfig.getInstanceName());\n     response.put(\"hostName\", instanceConfig.getHostName());",
                "deletions": 3
            },
            {
                "sha": "325dc04f29bc5a67df21ee4421cf0a7554915981",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PqlQueryResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PqlQueryResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PqlQueryResource.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PqlQueryResource.java?ref=f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518",
                "patch": "@@ -129,6 +129,10 @@ public String getQueryResponse(String pqlQuery, String traceEnabled, HttpHeaders\n     // Send query to a random broker.\n     String instanceId = instanceIds.get(RANDOM.nextInt(instanceIds.size()));\n     InstanceConfig instanceConfig = _pinotHelixResourceManager.getHelixInstanceConfig(instanceId);\n+    if (instanceConfig == null) {\n+      LOGGER.error(\"Instance {} not found\", instanceId);\n+      return QueryException.INTERNAL_ERROR.toString();\n+    }\n     String hostNameWithPrefix = instanceConfig.getHostName();\n     String url =\n         \"http://\" + hostNameWithPrefix.substring(hostNameWithPrefix.indexOf(\"_\") + 1) + \":\" + instanceConfig.getPort()",
                "deletions": 0
            },
            {
                "sha": "ed9b60480010b9763b5273484c32b6547d900e23",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 15,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518",
                "patch": "@@ -283,10 +283,9 @@ public HelixAdmin getHelixAdmin() {\n    * @param instanceId Instance Id\n    * @return Helix instance config\n    */\n-  @Nonnull\n   public InstanceConfig getHelixInstanceConfig(@Nonnull String instanceId) {\n     ZNRecord znRecord = _cacheInstanceConfigsDataAccessor.get(\"/\" + instanceId, null, AccessOption.PERSISTENT);\n-    return new InstanceConfig(znRecord);\n+    return znRecord != null ? new InstanceConfig(znRecord) : null;\n   }\n \n   /**\n@@ -2157,9 +2156,8 @@ public RebalanceResult rebalanceTable(final String rawTableName, TableType table\n    * @return True if instance exists in the Helix cluster, False otherwise.\n    */\n   public boolean instanceExists(String instanceName) {\n-    HelixDataAccessor helixDataAccessor = _helixZkManager.getHelixDataAccessor();\n-    InstanceConfig config = helixDataAccessor.getProperty(_keyBuilder.instanceConfig(instanceName));\n-    return (config != null);\n+    ZNRecord znRecord = _cacheInstanceConfigsDataAccessor.get(\"/\" + instanceName, null, AccessOption.PERSISTENT);\n+    return (znRecord != null);\n   }\n \n   public boolean isSingleTenantCluster() {\n@@ -2210,6 +2208,10 @@ public boolean isSingleTenantCluster() {\n     BiMap<String, String> endpointToInstance = HashBiMap.create(instances.size());\n     for (String instance : instances) {\n       InstanceConfig helixInstanceConfig = getHelixInstanceConfig(instance);\n+      if (helixInstanceConfig == null) {\n+        LOGGER.warn(\"Instance {} not found\", instance);\n+        continue;\n+      }\n       ZNRecord record = helixInstanceConfig.getRecord();\n       String[] hostnameSplit = helixInstanceConfig.getHostName().split(\"_\");\n       Preconditions.checkState(hostnameSplit.length >= 2);\n@@ -2239,13 +2241,14 @@ public static void main(String[] args) throws Exception {\n     final long externalViewOnlineToOfflineTimeoutMillis = 100L;\n     final boolean isSingleTenantCluster = false;\n     final boolean isUpdateStateModel = false;\n+    final boolean enableBatchMessageMode = false;\n     MetricsRegistry metricsRegistry = new MetricsRegistry();\n     final boolean dryRun = true;\n     final String tableName = \"testTable\";\n     final TableType tableType = TableType.OFFLINE;\n     PinotHelixResourceManager helixResourceManager =\n         new PinotHelixResourceManager(zkURL, helixClusterName, controllerInstanceId, localDiskDir,\n-            externalViewOnlineToOfflineTimeoutMillis, isSingleTenantCluster, isUpdateStateModel);\n+            externalViewOnlineToOfflineTimeoutMillis, isSingleTenantCluster, isUpdateStateModel, enableBatchMessageMode);\n     helixResourceManager.start();\n     ZNRecord record = helixResourceManager.rebalanceTable(tableName, dryRun, tableType);\n     ObjectMapper mapper = new ObjectMapper();",
                "deletions": 6
            },
            {
                "sha": "6d3a76f8aeb8edf9a0a41d2f7e00873fb6f33d28",
                "filename": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518/pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManagerTest.java",
                "status": "modified",
                "changes": 7,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManagerTest.java?ref=f8a1ff2c106cb41bd1e1d89dadc2edc177f6c518",
                "patch": "@@ -19,7 +19,6 @@\n package org.apache.pinot.controller.helix.core;\n \n import com.google.common.collect.BiMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Random;\n import java.util.Set;\n@@ -265,12 +264,6 @@ public void testRetrieveMetadata()\n     }\n   }\n \n-  @Test\n-  public void testGetDataInstanceAdminEndpoints() {\n-    Set<String> fakeInstances = new HashSet<>();\n-    new Random().nextInt(NUM_INSTANCES);\n-  }\n-\n   @AfterClass\n   public void tearDown() {\n     stopController();",
                "deletions": 7
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE while unparsing single key DSL output (#3501)\n\nFix NPE that can happen if unparsing of a single key DSL fails.",
        "commit": "https://github.com/apache/incubator-pinot/commit/ed1e0c0ed6d9a6328c07bd49cad2272ebe8ca9cc",
        "parent": "https://github.com/apache/incubator-pinot/commit/b21805cd332742df85d3b40eb5ff71745161e716",
        "bug_id": "incubator-pinot_6",
        "file": [
            {
                "sha": "9ca3fde664adeafe69ebe7fe8f4329b419c0a033",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/config/Serializer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed1e0c0ed6d9a6328c07bd49cad2272ebe8ca9cc/pinot-common/src/main/java/com/linkedin/pinot/common/config/Serializer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed1e0c0ed6d9a6328c07bd49cad2272ebe8ca9cc/pinot-common/src/main/java/com/linkedin/pinot/common/config/Serializer.java",
                "status": "modified",
                "changes": 7,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/config/Serializer.java?ref=ed1e0c0ed6d9a6328c07bd49cad2272ebe8ca9cc",
                "patch": "@@ -131,7 +131,12 @@\n         Class<?> dslValueType = dslClass.getMethod(\"parse\", String.class).getReturnType();\n         Object dslValueObject = Deserializer.deserialize(dslValueType, dslValueData, \"\");\n         if (dslValueObject != null) {\n-          return List.of(Tuple.of(configKey, dslInstance.unparse(dslValueObject)));\n+          String unparsedValue = dslInstance.unparse(dslValueObject);\n+          if (unparsedValue != null) {\n+            return List.of(Tuple.of(configKey, unparsedValue));\n+          } else {\n+            return List.empty();\n+          }\n         } else {\n           return List.empty();\n         }",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Minor deserialization fixes (#3508)\n\n- Add a missing conversion from ArrayList to Set\r\n- Avoid an NPE from being thrown during value injection. The injection\r\n  behavior stays the same, this just removes the NPE.",
        "commit": "https://github.com/apache/incubator-pinot/commit/e2916ed5aed7430d781a8aa602f995e24ffdb6e0",
        "parent": "https://github.com/apache/incubator-pinot/commit/ed88fb4e3824808701a0106b54193c124bfe6ea8",
        "bug_id": "incubator-pinot_7",
        "file": [
            {
                "sha": "c6673667882de750572679b36d22e55987990c54",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/config/Deserializer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e2916ed5aed7430d781a8aa602f995e24ffdb6e0/pinot-common/src/main/java/com/linkedin/pinot/common/config/Deserializer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e2916ed5aed7430d781a8aa602f995e24ffdb6e0/pinot-common/src/main/java/com/linkedin/pinot/common/config/Deserializer.java",
                "status": "modified",
                "changes": 10,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/config/Deserializer.java?ref=e2916ed5aed7430d781a8aa602f995e24ffdb6e0",
                "patch": "@@ -159,6 +159,11 @@\n       return list;\n     });\n \n+    typeConverters.put(Tuple.of(ArrayList.class, Set.class), items -> {\n+      ArrayList list = (ArrayList) items;\n+      return new HashSet(list);\n+    });\n+\n     // Mark all types that have a converter as simple types\n     simpleTypes = new HashSet<>();\n     typeConverters\n@@ -232,7 +237,10 @@\n \n               LOGGER.debug(\"Extracting value from field {} of {}, values are {}\", dslInfo.value(), dslValue, dslValues);\n \n-              valueInjected |= coerceValueIntoField(rootObject, declaredField, dslValues.getOrElse(dslInfo.value(), null));\n+              if (dslValues != null) {\n+                valueInjected |=\n+                    coerceValueIntoField(rootObject, declaredField, dslValues.getOrElse(dslInfo.value(), null));\n+              }\n             }\n           } else if (useChildKeyHandler != null) {\n             // Use a child key handler to handle this value",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix the issue where ZkCacheBaseDataAccessor.getChildren() can return list with null znRecords (#4152)\n\nThis can happen if the record gets removed while calling this method.\r\nNeed to handle it to prevent NPE.",
        "commit": "https://github.com/apache/incubator-pinot/commit/222162323d7a782a10d831ced93b95538a90e74a",
        "parent": "https://github.com/apache/incubator-pinot/commit/032866202df9d9cdb45fead75dbeed100be22a0a",
        "bug_id": "incubator-pinot_8",
        "file": [
            {
                "sha": "6634b2787777a6d03f33673a54ffdfcce333df1d",
                "filename": "pinot-common/src/main/java/org/apache/pinot/common/metadata/ZKMetadataProvider.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/222162323d7a782a10d831ced93b95538a90e74a/pinot-common/src/main/java/org/apache/pinot/common/metadata/ZKMetadataProvider.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/222162323d7a782a10d831ced93b95538a90e74a/pinot-common/src/main/java/org/apache/pinot/common/metadata/ZKMetadataProvider.java",
                "status": "modified",
                "changes": 98,
                "additions": 58,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/org/apache/pinot/common/metadata/ZKMetadataProvider.java?ref=222162323d7a782a10d831ced93b95538a90e74a",
                "patch": "@@ -297,70 +297,88 @@ public static Schema getTableSchema(@Nonnull ZkHelixPropertyStore<ZNRecord> prop\n    */\n   public static List<OfflineSegmentZKMetadata> getOfflineSegmentZKMetadataListForTable(\n       ZkHelixPropertyStore<ZNRecord> propertyStore, String tableName) {\n-    List<OfflineSegmentZKMetadata> resultList = new ArrayList<>();\n-    if (propertyStore == null) {\n-      return resultList;\n-    }\n     String offlineTableName = TableNameBuilder.OFFLINE.tableNameWithType(tableName);\n-    if (propertyStore.exists(constructPropertyStorePathForResource(offlineTableName), AccessOption.PERSISTENT)) {\n-      List<ZNRecord> znRecordList = propertyStore\n-          .getChildren(constructPropertyStorePathForResource(offlineTableName), null, AccessOption.PERSISTENT);\n-      if (znRecordList != null) {\n-        for (ZNRecord record : znRecordList) {\n-          resultList.add(new OfflineSegmentZKMetadata(record));\n+    String parentPath = constructPropertyStorePathForResource(offlineTableName);\n+    List<ZNRecord> znRecords = propertyStore.getChildren(parentPath, null, AccessOption.PERSISTENT);\n+    if (znRecords != null) {\n+      int numZNRecords = znRecords.size();\n+      List<OfflineSegmentZKMetadata> offlineSegmentZKMetadataList = new ArrayList<>(numZNRecords);\n+      for (ZNRecord znRecord : znRecords) {\n+        // NOTE: it is possible that znRecord is null if the record gets removed while calling this method\n+        if (znRecord != null) {\n+          offlineSegmentZKMetadataList.add(new OfflineSegmentZKMetadata(znRecord));\n         }\n       }\n+      int numNullZNRecords = numZNRecords - offlineSegmentZKMetadataList.size();\n+      if (numNullZNRecords > 0) {\n+        LOGGER.warn(\"Failed to read {}/{} offline segment ZK metadata under path: {}\", numZNRecords - numNullZNRecords,\n+            numZNRecords, parentPath);\n+      }\n+      return offlineSegmentZKMetadataList;\n+    } else {\n+      LOGGER.warn(\"Path: {} does not exist\", parentPath);\n+      return Collections.emptyList();\n     }\n-    return resultList;\n   }\n \n   /**\n    * NOTE: this method is very expensive, use {@link #getSegments(ZkHelixPropertyStore, String)} instead if only segment\n    * segment names are needed.\n    */\n   public static List<RealtimeSegmentZKMetadata> getRealtimeSegmentZKMetadataListForTable(\n-      ZkHelixPropertyStore<ZNRecord> propertyStore, String resourceName) {\n-    List<RealtimeSegmentZKMetadata> resultList = new ArrayList<>();\n-    if (propertyStore == null) {\n-      return resultList;\n-    }\n-    String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(resourceName);\n-    if (propertyStore.exists(constructPropertyStorePathForResource(realtimeTableName), AccessOption.PERSISTENT)) {\n-      List<ZNRecord> znRecordList = propertyStore\n-          .getChildren(constructPropertyStorePathForResource(realtimeTableName), null, AccessOption.PERSISTENT);\n-      if (znRecordList != null) {\n-        for (ZNRecord record : znRecordList) {\n-          resultList.add(new RealtimeSegmentZKMetadata(record));\n+      ZkHelixPropertyStore<ZNRecord> propertyStore, String tableName) {\n+    String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(tableName);\n+    String parentPath = constructPropertyStorePathForResource(realtimeTableName);\n+    List<ZNRecord> znRecords = propertyStore.getChildren(parentPath, null, AccessOption.PERSISTENT);\n+    if (znRecords != null) {\n+      int numZNRecords = znRecords.size();\n+      List<RealtimeSegmentZKMetadata> realtimeSegmentZKMetadataList = new ArrayList<>(numZNRecords);\n+      for (ZNRecord znRecord : znRecords) {\n+        // NOTE: it is possible that znRecord is null if the record gets removed while calling this method\n+        if (znRecord != null) {\n+          realtimeSegmentZKMetadataList.add(new RealtimeSegmentZKMetadata(znRecord));\n         }\n       }\n+      int numNullZNRecords = numZNRecords - realtimeSegmentZKMetadataList.size();\n+      if (numNullZNRecords > 0) {\n+        LOGGER.warn(\"Failed to read {}/{} realtime segment ZK metadata under path: {}\", numZNRecords - numNullZNRecords,\n+            numZNRecords, parentPath);\n+      }\n+      return realtimeSegmentZKMetadataList;\n+    } else {\n+      LOGGER.warn(\"Path: {} does not exist\", parentPath);\n+      return Collections.emptyList();\n     }\n-    return resultList;\n   }\n \n   /**\n    * NOTE: this method is very expensive, use {@link #getLLCRealtimeSegments(ZkHelixPropertyStore, String)} instead if\n    * only segment names are needed.\n    */\n   public static List<LLCRealtimeSegmentZKMetadata> getLLCRealtimeSegmentZKMetadataListForTable(\n-      ZkHelixPropertyStore<ZNRecord> propertyStore, String resourceName) {\n-    List<LLCRealtimeSegmentZKMetadata> resultList = new ArrayList<>();\n-    if (propertyStore == null) {\n-      return resultList;\n-    }\n-    String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(resourceName);\n-    if (propertyStore.exists(constructPropertyStorePathForResource(realtimeTableName), AccessOption.PERSISTENT)) {\n-      List<ZNRecord> znRecordList = propertyStore\n-          .getChildren(constructPropertyStorePathForResource(realtimeTableName), null, AccessOption.PERSISTENT);\n-      if (znRecordList != null) {\n-        for (ZNRecord record : znRecordList) {\n-          RealtimeSegmentZKMetadata realtimeSegmentZKMetadata = new RealtimeSegmentZKMetadata(record);\n-          if (SegmentName.isLowLevelConsumerSegmentName(realtimeSegmentZKMetadata.getSegmentName())) {\n-            resultList.add(new LLCRealtimeSegmentZKMetadata(record));\n-          }\n+      ZkHelixPropertyStore<ZNRecord> propertyStore, String tableName) {\n+    String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(tableName);\n+    String parentPath = constructPropertyStorePathForResource(realtimeTableName);\n+    List<ZNRecord> znRecords = propertyStore.getChildren(parentPath, null, AccessOption.PERSISTENT);\n+    if (znRecords != null) {\n+      int numZNRecords = znRecords.size();\n+      List<LLCRealtimeSegmentZKMetadata> llcRealtimeSegmentZKMetadataList = new ArrayList<>(numZNRecords);\n+      for (ZNRecord znRecord : znRecords) {\n+        // NOTE: it is possible that znRecord is null if the record gets removed while calling this method\n+        if (znRecord != null) {\n+          llcRealtimeSegmentZKMetadataList.add(new LLCRealtimeSegmentZKMetadata(znRecord));\n         }\n       }\n+      int numNullZNRecords = numZNRecords - llcRealtimeSegmentZKMetadataList.size();\n+      if (numNullZNRecords > 0) {\n+        LOGGER.warn(\"Failed to read {}/{} LLC realtime segment ZK metadata under path: {}\",\n+            numZNRecords - numNullZNRecords, numZNRecords, parentPath);\n+      }\n+      return llcRealtimeSegmentZKMetadataList;\n+    } else {\n+      LOGGER.warn(\"Path: {} does not exist\", parentPath);\n+      return Collections.emptyList();\n     }\n-    return resultList;\n   }\n \n   /**",
                "deletions": 40
            },
            {
                "sha": "0d0f6c07ba999aefe873b15d48feaed0d40b4da7",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/222162323d7a782a10d831ced93b95538a90e74a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/222162323d7a782a10d831ced93b95538a90e74a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 14,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=222162323d7a782a10d831ced93b95538a90e74a",
                "patch": "@@ -289,8 +289,18 @@ private HelixManager registerAndConnectAsHelixParticipant() {\n    */\n   public List<InstanceConfig> getAllHelixInstanceConfigs() {\n     List<ZNRecord> znRecords = _cacheInstanceConfigsDataAccessor.getChildren(\"/\", null, AccessOption.PERSISTENT);\n-    List<InstanceConfig> instanceConfigs = new ArrayList<>(znRecords.size());\n-    znRecords.forEach(znRecord -> instanceConfigs.add(new InstanceConfig(znRecord)));\n+    int numZNRecords = znRecords.size();\n+    List<InstanceConfig> instanceConfigs = new ArrayList<>(numZNRecords);\n+    for (ZNRecord znRecord : znRecords) {\n+      // NOTE: it is possible that znRecord is null if the record gets removed while calling this method\n+      if (znRecord != null) {\n+        instanceConfigs.add(new InstanceConfig(znRecord));\n+      }\n+    }\n+    int numNullZNRecords = numZNRecords - instanceConfigs.size();\n+    if (numNullZNRecords > 0) {\n+      LOGGER.warn(\"Failed to read {}/{} instance configs\", numZNRecords - numNullZNRecords, numZNRecords);\n+    }\n     return instanceConfigs;\n   }\n ",
                "deletions": 2
            },
            {
                "sha": "331a4a0a9f0ac8b0e2436db72afadff79b4879a8",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/222162323d7a782a10d831ced93b95538a90e74a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/222162323d7a782a10d831ced93b95538a90e74a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "status": "modified",
                "changes": 16,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java?ref=222162323d7a782a10d831ced93b95538a90e74a",
                "patch": "@@ -82,7 +82,8 @@\n   private ControllerMetrics _controllerMetrics;\n   private final ControllerLeadershipManager _controllerLeadershipManager;\n \n-  public PinotRealtimeSegmentManager(PinotHelixResourceManager pinotManager, ControllerLeadershipManager controllerLeadershipManager) {\n+  public PinotRealtimeSegmentManager(PinotHelixResourceManager pinotManager,\n+      ControllerLeadershipManager controllerLeadershipManager) {\n     _pinotHelixResourceManager = pinotManager;\n     _controllerLeadershipManager = controllerLeadershipManager;\n     String clusterName = _pinotHelixResourceManager.getHelixClusterName();\n@@ -331,6 +332,10 @@ private void refreshWatchers(String path) {\n     }\n \n     for (ZNRecord tableConfigZnRecord : tableConfigs) {\n+      // NOTE: it is possible that znRecord is null if the record gets removed while calling this method\n+      if (tableConfigZnRecord == null) {\n+        continue;\n+      }\n       try {\n         String znRecordId = tableConfigZnRecord.getId();\n         if (TableNameBuilder.getTableTypeFromTableName(znRecordId) == TableType.REALTIME) {\n@@ -374,13 +379,8 @@ private void refreshWatchers(String path) {\n       } catch (Exception e) {\n         // we want to continue setting watches for other tables for any kind of exception here so that\n         // errors with one table don't impact others\n-        if (tableConfigZnRecord == null) {\n-          // Can happen if the table config zn record failed to parse.\n-          LOGGER.error(\"Got null ZN record for table config\", e);\n-        } else {\n-          LOGGER.error(\"Caught exception while processing ZNRecord id: {}. Skipping node to continue setting watches\",\n-              tableConfigZnRecord.getId(), e);\n-        }\n+        LOGGER.error(\"Caught exception while processing ZNRecord id: {}. Skipping node to continue setting watches\",\n+            tableConfigZnRecord.getId(), e);\n       }\n     }\n   }",
                "deletions": 8
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE when getting rebalance strategy (#3102)",
        "commit": "https://github.com/apache/incubator-pinot/commit/6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9",
        "parent": "https://github.com/apache/incubator-pinot/commit/e308e886851c41e41837a978aec5079614e61508",
        "bug_id": "incubator-pinot_9",
        "file": [
            {
                "sha": "a3be0f2975d75912fd7979350bbe15bc702b1702",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/DefaultRebalanceSegmentStrategy.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/DefaultRebalanceSegmentStrategy.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/DefaultRebalanceSegmentStrategy.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/DefaultRebalanceSegmentStrategy.java?ref=6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9",
                "patch": "@@ -50,7 +50,7 @@\n \n \n /**\n- * Basic rebalance segments strategy, which rebalances offline segments using autorebalance strategy,\n+ * Basic rebalance segments strategy, which rebalances offline segments using auto-rebalance strategy,\n  * and consuming segments using the partition assignment strategy for the table\n  */\n public class DefaultRebalanceSegmentStrategy implements RebalanceSegmentStrategy {",
                "deletions": 1
            },
            {
                "sha": "8ef1f82aa7d411a5d05912c8faba0a67a40f1b5b",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/RebalanceSegmentStrategyFactory.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/RebalanceSegmentStrategyFactory.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/RebalanceSegmentStrategyFactory.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/rebalance/RebalanceSegmentStrategyFactory.java?ref=6446a9dfaf7059ecbbcac46ab1d809a3fa96a3f9",
                "patch": "@@ -16,7 +16,6 @@\n package com.linkedin.pinot.controller.helix.core.rebalance;\n \n import com.linkedin.pinot.common.config.TableConfig;\n-import com.linkedin.pinot.controller.helix.core.sharding.SegmentAssignmentStrategy;\n import com.linkedin.pinot.controller.helix.core.sharding.SegmentAssignmentStrategyEnum;\n import org.apache.helix.HelixManager;\n \n@@ -51,6 +50,9 @@ public static RebalanceSegmentStrategyFactory getInstance() {\n   public RebalanceSegmentStrategy getRebalanceSegmentsStrategy(TableConfig tableConfig) {\n     // If we use replica group segment assignment strategy, we pick the replica group rebalancer\n     String segmentAssignmentStrategy = tableConfig.getValidationConfig().getSegmentAssignmentStrategy();\n+    if (segmentAssignmentStrategy == null) {\n+      return new DefaultRebalanceSegmentStrategy(_helixManager);\n+    }\n     switch (SegmentAssignmentStrategyEnum.valueOf(segmentAssignmentStrategy)) {\n       case ReplicaGroupSegmentAssignmentStrategy:\n         return new ReplicaGroupRebalanceSegmentStrategy(_helixManager);",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE on configs with per-profile table types (#3503)\n\nFix NPEs on configurations that have per-profile table types, leading to\r\na merged output that has table-type specific keys for profiles that have\r\nonly one table type when other profiles have two table types.",
        "commit": "https://github.com/apache/incubator-pinot/commit/5900ff10f487725ccc85abda79609e9c5c2cf2b1",
        "parent": "https://github.com/apache/incubator-pinot/commit/d99d8d8a9dd31311aa959fa90b423073c7634ae4",
        "bug_id": "incubator-pinot_10",
        "file": [
            {
                "sha": "76a3fbdb5c7ddaefc1bfffb1720dd8029def1fd9",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/config/AdjustTableNameChildKeyTransformer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/5900ff10f487725ccc85abda79609e9c5c2cf2b1/pinot-common/src/main/java/com/linkedin/pinot/common/config/AdjustTableNameChildKeyTransformer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/5900ff10f487725ccc85abda79609e9c5c2cf2b1/pinot-common/src/main/java/com/linkedin/pinot/common/config/AdjustTableNameChildKeyTransformer.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/config/AdjustTableNameChildKeyTransformer.java?ref=5900ff10f487725ccc85abda79609e9c5c2cf2b1",
                "patch": "@@ -43,7 +43,9 @@\n         .getOrElse(List.empty())\n         .map(Object::toString);\n \n-    String tableName = childKeys.get(\"table.name\").map(Object::toString).getOrNull();\n+    String tableName = childKeys.get(\"table.name\").map(Object::toString).getOrElse(\n+            () -> childKeys.get(\"table.name.realtime\").map(Object::toString).getOrElse(\n+                () -> childKeys.get(\"table.name.offline\").map(Object::toString).getOrNull()));\n \n     Map<String, Object> remappedConfig = (Map<String, Object>) childKeys;\n ",
                "deletions": 1
            },
            {
                "sha": "f8fef317cdb156659836c8d25996ff47c8f340ca",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/config/CombinedConfigSeparatorChildKeyTransformer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/5900ff10f487725ccc85abda79609e9c5c2cf2b1/pinot-common/src/main/java/com/linkedin/pinot/common/config/CombinedConfigSeparatorChildKeyTransformer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/5900ff10f487725ccc85abda79609e9c5c2cf2b1/pinot-common/src/main/java/com/linkedin/pinot/common/config/CombinedConfigSeparatorChildKeyTransformer.java",
                "status": "modified",
                "changes": 8,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/config/CombinedConfigSeparatorChildKeyTransformer.java?ref=5900ff10f487725ccc85abda79609e9c5c2cf2b1",
                "patch": "@@ -45,6 +45,14 @@\n     // Move keys around so that they match with the combined config\n     Map<String, Object> remappedConfig = config.flatMap((k, v) -> {\n       if(k.startsWith(\"table.schema.\")) {\n+        // Remove realtime/offline suffixes\n+        if (k.endsWith(\".realtime\")) {\n+          k = k.substring(0, k.length() - \".realtime\".length());\n+        }\n+        if (k.endsWith(\".offline\")) {\n+          k = k.substring(0, k.length() - \".offline\".length());\n+        }\n+\n         // table.schema.foo -> schema.foo\n         return List.of(Tuple.of(k.replaceFirst(\"table.schema\", \"schema\"), v));\n       } else if (k.endsWith(\".realtime\") && hasRealtime) {",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[TE] auth - fix NPE on redundant logout (#3090)",
        "commit": "https://github.com/apache/incubator-pinot/commit/6f5d9af65ef7970a55ee51c88c0d64af2a885579",
        "parent": "https://github.com/apache/incubator-pinot/commit/199cf88a4cdf19e730df7bd18a8466f52ce698f4",
        "bug_id": "incubator-pinot_11",
        "file": [
            {
                "sha": "24b630ed11541163e5eae785fc465237d1a5aab2",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/v2/AuthResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/6f5d9af65ef7970a55ee51c88c0d64af2a885579/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/v2/AuthResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/6f5d9af65ef7970a55ee51c88c0d64af2a885579/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/v2/AuthResource.java",
                "status": "modified",
                "changes": 9,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/v2/AuthResource.java?ref=6f5d9af65ef7970a55ee51c88c0d64af2a885579",
                "patch": "@@ -88,7 +88,7 @@ public Response authenticate(Credentials credentials) {\n       sessionDTO.setSessionKey(sessionKey);\n       sessionDTO.setPrincipalType(SessionBean.PrincipalType.USER);\n       sessionDTO.setPrincipal(principal.getName());\n-      sessionDTO.setExpirationTime(System.currentTimeMillis() + TimeUnit.HOURS.toMillis(6));\n+      sessionDTO.setExpirationTime(System.currentTimeMillis() + TimeUnit.HOURS.toMillis(8));\n       this.sessionDAO.save(sessionDTO);\n \n       NewCookie cookie =\n@@ -100,12 +100,15 @@ public Response authenticate(Credentials credentials) {\n     }\n     return Response.status(Response.Status.UNAUTHORIZED).build();\n   }\n-\n   @Path(\"/logout\")\n   @GET\n   public Response logout() {\n     ThirdEyePrincipal principal = ThirdEyeAuthFilter.getCurrentPrincipal();\n-    this.sessionDAO.deleteByPredicate(Predicate.EQ(\"sessionKey\", principal.getSessionKey()));\n+\n+    if (principal != null) {\n+      // if not logged out already\n+      this.sessionDAO.deleteByPredicate(Predicate.EQ(\"sessionKey\", principal.getSessionKey()));\n+    }\n \n     NewCookie cookie = new NewCookie(AUTH_TOKEN_NAME, \"\", \"/\", null, null, -1, false);\n     return Response.ok().cookie(cookie).build();",
                "deletions": 3
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "In TableConfig, add checks for mandatory fields (#3993)\n\nAdd explicit checks for mandatory fields when serialize/deserialize table config\r\nWithout the explicit checks, it will throw NPE, which is not clear and hard to debug\r\n\r\nAlso change the serialize APIs to be non-static\r\n\r\nAdd unit test and integration test for the changes",
        "commit": "https://github.com/apache/incubator-pinot/commit/eccf573a636de84e60c85cc331fea0afc172c90c",
        "parent": "https://github.com/apache/incubator-pinot/commit/d78a8075d64801b258d5634bbcb82121e5f3506f",
        "bug_id": "incubator-pinot_12",
        "file": [
            {
                "sha": "1b5d7098a2dc800b69a149529bcfce8b0788de31",
                "filename": "pinot-broker/src/test/java/org/apache/pinot/broker/queryquota/TableQueryQuotaManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/queryquota/TableQueryQuotaManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/queryquota/TableQueryQuotaManagerTest.java",
                "status": "modified",
                "changes": 15,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/test/java/org/apache/pinot/broker/queryquota/TableQueryQuotaManagerTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -146,7 +146,7 @@ public void testOfflineTableWithNullQuotaButWithRealtimeTableConfigNullQpsConfig\n             .setRetentionTimeUnit(\"DAYS\").setRetentionTimeValue(\"1\").setSegmentPushType(\"APPEND\")\n             .setBrokerTenant(\"testBroker\").setServerTenant(\"testServer\").build();\n     ZKMetadataProvider\n-        .setRealtimeTableConfig(_testPropertyStore, REALTIME_TABLE_NAME, TableConfig.toZnRecord(realtimeTableConfig));\n+        .setRealtimeTableConfig(_testPropertyStore, REALTIME_TABLE_NAME, realtimeTableConfig.toZNRecord());\n \n     ExternalView brokerResource = generateBrokerResource(OFFLINE_TABLE_NAME);\n     TableConfig tableConfig = generateDefaultTableConfig(OFFLINE_TABLE_NAME);\n@@ -169,7 +169,7 @@ public void testOfflineTableWithNullQuotaButWithRealtimeTableConfigNotNullQpsCon\n             .setRetentionTimeUnit(\"DAYS\").setRetentionTimeValue(\"1\").setSegmentPushType(\"APPEND\")\n             .setBrokerTenant(\"testBroker\").setServerTenant(\"testServer\").build();\n     ZKMetadataProvider\n-        .setRealtimeTableConfig(_testPropertyStore, REALTIME_TABLE_NAME, TableConfig.toZnRecord(realtimeTableConfig));\n+        .setRealtimeTableConfig(_testPropertyStore, REALTIME_TABLE_NAME, realtimeTableConfig.toZNRecord());\n \n     ExternalView brokerResource = generateBrokerResource(REALTIME_TABLE_NAME);\n     TableConfig tableConfig = generateDefaultTableConfig(OFFLINE_TABLE_NAME);\n@@ -205,9 +205,8 @@ public void testBothTableHaveQpsQuotaConfig()\n             .setBrokerTenant(\"testBroker\").setServerTenant(\"testServer\").build();\n \n     ZKMetadataProvider\n-        .setRealtimeTableConfig(_testPropertyStore, REALTIME_TABLE_NAME, TableConfig.toZnRecord(realtimeTableConfig));\n-    ZKMetadataProvider\n-        .setOfflineTableConfig(_testPropertyStore, OFFLINE_TABLE_NAME, TableConfig.toZnRecord(offlineTableConfig));\n+        .setRealtimeTableConfig(_testPropertyStore, REALTIME_TABLE_NAME, realtimeTableConfig.toZNRecord());\n+    ZKMetadataProvider.setOfflineTableConfig(_testPropertyStore, OFFLINE_TABLE_NAME, offlineTableConfig.toZNRecord());\n \n     // Since each table has 2 online brokers, per broker rate becomes 100.0 / 2 = 50.0\n     _tableQueryQuotaManager.initTableQueryQuota(offlineTableConfig, brokerResource);\n@@ -261,8 +260,7 @@ public void testRealtimeTableWithNullQuotaButWithOfflineTableConfigNullQpsConfig\n         new TableConfig.Builder(TableType.OFFLINE).setTableName(RAW_TABLE_NAME).setQuotaConfig(quotaConfig)\n             .setRetentionTimeUnit(\"DAYS\").setRetentionTimeValue(\"1\").setSegmentPushType(\"APPEND\")\n             .setBrokerTenant(\"testBroker\").setServerTenant(\"testServer\").build();\n-    ZKMetadataProvider\n-        .setOfflineTableConfig(_testPropertyStore, OFFLINE_TABLE_NAME, TableConfig.toZnRecord(offlineTableConfig));\n+    ZKMetadataProvider.setOfflineTableConfig(_testPropertyStore, OFFLINE_TABLE_NAME, offlineTableConfig.toZNRecord());\n \n     ExternalView brokerResource = generateBrokerResource(REALTIME_TABLE_NAME);\n     TableConfig tableConfig = generateDefaultTableConfig(REALTIME_TABLE_NAME);\n@@ -280,8 +278,7 @@ public void testRealtimeTableWithNullQuotaButWithOfflineTableConfigNotNullQpsCon\n         new TableConfig.Builder(TableType.OFFLINE).setTableName(RAW_TABLE_NAME).setQuotaConfig(quotaConfig)\n             .setRetentionTimeUnit(\"DAYS\").setRetentionTimeValue(\"1\").setSegmentPushType(\"APPEND\")\n             .setBrokerTenant(\"testBroker\").setServerTenant(\"testServer\").build();\n-    ZKMetadataProvider\n-        .setOfflineTableConfig(_testPropertyStore, OFFLINE_TABLE_NAME, TableConfig.toZnRecord(offlineTableConfig));\n+    ZKMetadataProvider.setOfflineTableConfig(_testPropertyStore, OFFLINE_TABLE_NAME, offlineTableConfig.toZNRecord());\n \n     ExternalView brokerResource = generateBrokerResource(OFFLINE_TABLE_NAME);\n     TableConfig tableConfig = generateDefaultTableConfig(REALTIME_TABLE_NAME);",
                "deletions": 9
            },
            {
                "sha": "31e68398c685769e824701bbd7f79e399289373e",
                "filename": "pinot-broker/src/test/java/org/apache/pinot/broker/routing/TimeBoundaryServiceTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/routing/TimeBoundaryServiceTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/routing/TimeBoundaryServiceTest.java",
                "status": "modified",
                "changes": 3,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/test/java/org/apache/pinot/broker/routing/TimeBoundaryServiceTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -125,7 +125,6 @@ private void addingTableToPropertyStore(String tableName)\n       throws Exception {\n     TableConfig tableConfig = new TableConfig.Builder(CommonConstants.Helix.TableType.OFFLINE).setTableName(tableName)\n         .setTimeColumnName(\"timestamp\").setTimeType(\"DAYS\").build();\n-    ZKMetadataProvider\n-        .setOfflineTableConfig(_propertyStore, tableConfig.getTableName(), TableConfig.toZnRecord(tableConfig));\n+    ZKMetadataProvider.setOfflineTableConfig(_propertyStore, tableConfig.getTableName(), tableConfig.toZNRecord());\n   }\n }",
                "deletions": 2
            },
            {
                "sha": "225f3f89ee07ca830286beaa4029901108280f51",
                "filename": "pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/HighLevelConsumerRoutingTableBuilderTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/HighLevelConsumerRoutingTableBuilderTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/HighLevelConsumerRoutingTableBuilderTest.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/HighLevelConsumerRoutingTableBuilderTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -49,8 +49,8 @@ public void testHlcRoutingTableBuilder() {\n \n     Random random = new Random();\n \n-    TableConfig tableConfig = new TableConfig();\n-    tableConfig.setTableName(\"tableName\");\n+    TableConfig tableConfig =\n+        new TableConfig.Builder(CommonConstants.Helix.TableType.REALTIME).setTableName(\"tableName\").build();\n     HighLevelConsumerBasedRoutingTableBuilder routingTableBuilder = new HighLevelConsumerBasedRoutingTableBuilder();\n     routingTableBuilder.init(new BaseConfiguration(), tableConfig, null, null);\n ",
                "deletions": 2
            },
            {
                "sha": "23be4be07ea7c1b5b8384c621fdf95d3e825db37",
                "filename": "pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/LowLevelConsumerRoutingTableBuilderTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/LowLevelConsumerRoutingTableBuilderTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/LowLevelConsumerRoutingTableBuilderTest.java",
                "status": "modified",
                "changes": 12,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/test/java/org/apache/pinot/broker/routing/builder/LowLevelConsumerRoutingTableBuilderTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -52,8 +52,8 @@ public void testAllOnlineRoutingTable() {\n     final int ITERATIONS = 50;\n     Random random = new Random();\n \n-    TableConfig tableConfig = new TableConfig();\n-    tableConfig.setTableName(\"tableName\");\n+    TableConfig tableConfig =\n+        new TableConfig.Builder(CommonConstants.Helix.TableType.REALTIME).setTableName(\"tableName\").build();\n     LowLevelConsumerRoutingTableBuilder routingTableBuilder = new LowLevelConsumerRoutingTableBuilder();\n     routingTableBuilder.init(new BaseConfiguration(), tableConfig, null, null);\n \n@@ -161,8 +161,8 @@ public void testMultipleConsumingSegments() {\n     final int ONLINE_SEGMENT_COUNT = 8;\n     final int CONSUMING_SEGMENT_COUNT = SEGMENT_COUNT - ONLINE_SEGMENT_COUNT;\n \n-    TableConfig tableConfig = new TableConfig();\n-    tableConfig.setTableName(\"tableName\");\n+    TableConfig tableConfig =\n+        new TableConfig.Builder(CommonConstants.Helix.TableType.REALTIME).setTableName(\"tableName\").build();\n     LowLevelConsumerRoutingTableBuilder routingTableBuilder = new LowLevelConsumerRoutingTableBuilder();\n     routingTableBuilder.init(new BaseConfiguration(), tableConfig, null, null);\n \n@@ -207,8 +207,8 @@ public void testShutdownInProgressServer() {\n     final int SEGMENT_COUNT = 10;\n     final int ONLINE_SEGMENT_COUNT = 8;\n \n-    TableConfig tableConfig = new TableConfig();\n-    tableConfig.setTableName(\"tableName\");\n+    TableConfig tableConfig =\n+        new TableConfig.Builder(CommonConstants.Helix.TableType.REALTIME).setTableName(\"tableName\").build();\n     LowLevelConsumerRoutingTableBuilder routingTableBuilder = new LowLevelConsumerRoutingTableBuilder();\n     routingTableBuilder.init(new BaseConfiguration(), tableConfig, null, null);\n ",
                "deletions": 6
            },
            {
                "sha": "2f4ee1c3ff91f97c491d7a70c74c0734171e86bf",
                "filename": "pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java",
                "status": "modified",
                "changes": 235,
                "additions": 139,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/org/apache/pinot/common/config/TableConfig.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -27,7 +27,6 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n-import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n import org.apache.helix.ZNRecord;\n import org.apache.pinot.common.data.StarTreeIndexSpec;\n@@ -51,6 +50,8 @@\n   public static final String TASK_CONFIG_KEY = \"task\";\n   public static final String ROUTING_CONFIG_KEY = \"routing\";\n \n+  private static final String FIELD_MISSING_MESSAGE_TEMPLATE = \"Mandatory field '%s' is missing\";\n+\n   @ConfigKey(\"name\")\n   @ConfigDoc(value = \"The name for the table.\", mandatory = true, exampleValue = \"myTable\")\n   private String _tableName;\n@@ -81,15 +82,17 @@\n   @NestedConfig\n   private RoutingConfig _routingConfig;\n \n+  /**\n+   * NOTE: DO NOT use this constructor, use builder instead. This constructor is for deserializer only.\n+   */\n   public TableConfig() {\n     // TODO: currently these 2 fields are annotated as non-null. Revisit to see whether that's necessary\n     _tenantConfig = new TenantConfig();\n     _customConfig = new TableCustomConfig();\n   }\n \n-  private TableConfig(@Nonnull String tableName, @Nonnull TableType tableType,\n-      @Nonnull SegmentsValidationAndRetentionConfig validationConfig, @Nonnull TenantConfig tenantConfig,\n-      @Nonnull IndexingConfig indexingConfig, @Nonnull TableCustomConfig customConfig,\n+  private TableConfig(String tableName, TableType tableType, SegmentsValidationAndRetentionConfig validationConfig,\n+      TenantConfig tenantConfig, IndexingConfig indexingConfig, TableCustomConfig customConfig,\n       @Nullable QuotaConfig quotaConfig, @Nullable TableTaskConfig taskConfig, @Nullable RoutingConfig routingConfig) {\n     _tableName = TableNameBuilder.forType(tableType).tableNameWithType(tableName);\n     _tableType = tableType;\n@@ -102,111 +105,147 @@ private TableConfig(@Nonnull String tableName, @Nonnull TableType tableType,\n     _routingConfig = routingConfig;\n   }\n \n-  // For backward compatible\n-  @Deprecated\n-  @Nonnull\n-  public static TableConfig init(@Nonnull String jsonConfigString)\n-      throws IOException {\n-    return fromJsonString(jsonConfigString);\n-  }\n-\n   public static TableConfig fromJsonString(String jsonString)\n       throws IOException {\n-    return fromJSONConfig(JsonUtils.stringToJsonNode(jsonString));\n+    return fromJsonConfig(JsonUtils.stringToJsonNode(jsonString));\n   }\n \n-  @Nonnull\n-  public static TableConfig fromJSONConfig(@Nonnull JsonNode jsonConfig)\n+  public static TableConfig fromJsonConfig(JsonNode jsonConfig)\n       throws IOException {\n-    TableType tableType = TableType.valueOf(jsonConfig.get(TABLE_TYPE_KEY).asText().toUpperCase());\n-    String tableName = TableNameBuilder.forType(tableType).tableNameWithType(jsonConfig.get(TABLE_NAME_KEY).asText());\n+    // Mandatory fields\n+    JsonNode jsonTableType = jsonConfig.get(TABLE_TYPE_KEY);\n+    Preconditions\n+        .checkState(jsonTableType != null && !jsonTableType.isNull(), FIELD_MISSING_MESSAGE_TEMPLATE, TABLE_TYPE_KEY);\n+    TableType tableType = TableType.valueOf(jsonTableType.asText().toUpperCase());\n+\n+    JsonNode jsonTableName = jsonConfig.get(TABLE_NAME_KEY);\n+    Preconditions\n+        .checkState(jsonTableName != null && !jsonTableName.isNull(), FIELD_MISSING_MESSAGE_TEMPLATE, TABLE_NAME_KEY);\n+    String tableName = TableNameBuilder.forType(tableType).tableNameWithType(jsonTableName.asText());\n \n     SegmentsValidationAndRetentionConfig validationConfig =\n         extractChildConfig(jsonConfig, VALIDATION_CONFIG_KEY, SegmentsValidationAndRetentionConfig.class);\n+    Preconditions.checkState(validationConfig != null, FIELD_MISSING_MESSAGE_TEMPLATE, VALIDATION_CONFIG_KEY);\n+\n     TenantConfig tenantConfig = extractChildConfig(jsonConfig, TENANT_CONFIG_KEY, TenantConfig.class);\n+    Preconditions.checkState(tenantConfig != null, FIELD_MISSING_MESSAGE_TEMPLATE, TENANT_CONFIG_KEY);\n+\n     IndexingConfig indexingConfig = extractChildConfig(jsonConfig, INDEXING_CONFIG_KEY, IndexingConfig.class);\n+    Preconditions.checkState(indexingConfig != null, FIELD_MISSING_MESSAGE_TEMPLATE, INDEXING_CONFIG_KEY);\n+\n     TableCustomConfig customConfig = extractChildConfig(jsonConfig, CUSTOM_CONFIG_KEY, TableCustomConfig.class);\n-    QuotaConfig quotaConfig = null;\n-    if (jsonConfig.has(QUOTA_CONFIG_KEY)) {\n-      quotaConfig = extractChildConfig(jsonConfig, QUOTA_CONFIG_KEY, QuotaConfig.class);\n+    Preconditions.checkState(customConfig != null, FIELD_MISSING_MESSAGE_TEMPLATE, CUSTOM_CONFIG_KEY);\n+\n+    // Optional fields\n+    QuotaConfig quotaConfig = extractChildConfig(jsonConfig, QUOTA_CONFIG_KEY, QuotaConfig.class);\n+    if (quotaConfig != null) {\n       quotaConfig.validate();\n     }\n-    TableTaskConfig taskConfig = null;\n-    if (jsonConfig.has(TASK_CONFIG_KEY)) {\n-      taskConfig = extractChildConfig(jsonConfig, TASK_CONFIG_KEY, TableTaskConfig.class);\n-    }\n-    RoutingConfig routingConfig = null;\n-    if (jsonConfig.has(ROUTING_CONFIG_KEY)) {\n-      routingConfig = extractChildConfig(jsonConfig, ROUTING_CONFIG_KEY, RoutingConfig.class);\n-    }\n+\n+    TableTaskConfig taskConfig = extractChildConfig(jsonConfig, TASK_CONFIG_KEY, TableTaskConfig.class);\n+\n+    RoutingConfig routingConfig = extractChildConfig(jsonConfig, ROUTING_CONFIG_KEY, RoutingConfig.class);\n \n     return new TableConfig(tableName, tableType, validationConfig, tenantConfig, indexingConfig, customConfig,\n         quotaConfig, taskConfig, routingConfig);\n   }\n \n   /**\n-   * Extracts the child config from the table config.\n+   * Extracts the child config from the table config. Returns {@code null} if child config does not exist.\n    * <p>\n    * NOTE: for historical reason, we support two kinds of nested config values: normal json and serialized json string\n    */\n+  @Nullable\n   private static <T> T extractChildConfig(JsonNode jsonConfig, String childConfigKey, Class<T> childConfigClass)\n       throws IOException {\n     JsonNode childConfigNode = jsonConfig.get(childConfigKey);\n+    if (childConfigNode == null || childConfigNode.isNull()) {\n+      return null;\n+    }\n     if (childConfigNode.isObject()) {\n       return JsonUtils.jsonNodeToObject(childConfigNode, childConfigClass);\n     } else {\n       return JsonUtils.stringToObject(childConfigNode.asText(), childConfigClass);\n     }\n   }\n \n-  @Nonnull\n-  public static JsonNode toJSONConfig(@Nonnull TableConfig tableConfig) {\n+  public ObjectNode toJsonConfig() {\n+    validate();\n+\n     ObjectNode jsonConfig = JsonUtils.newObjectNode();\n-    jsonConfig.put(TABLE_NAME_KEY, tableConfig._tableName);\n-    jsonConfig.put(TABLE_TYPE_KEY, tableConfig._tableType.toString());\n-    jsonConfig.set(VALIDATION_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._validationConfig));\n-    jsonConfig.set(TENANT_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._tenantConfig));\n-    jsonConfig.set(INDEXING_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._indexingConfig));\n-    jsonConfig.set(CUSTOM_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._customConfig));\n-    if (tableConfig._quotaConfig != null) {\n-      jsonConfig.set(QUOTA_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._quotaConfig));\n+\n+    // Mandatory fields\n+    jsonConfig.put(TABLE_NAME_KEY, _tableName);\n+    jsonConfig.put(TABLE_TYPE_KEY, _tableType.toString());\n+    jsonConfig.set(VALIDATION_CONFIG_KEY, JsonUtils.objectToJsonNode(_validationConfig));\n+    jsonConfig.set(TENANT_CONFIG_KEY, JsonUtils.objectToJsonNode(_tenantConfig));\n+    jsonConfig.set(INDEXING_CONFIG_KEY, JsonUtils.objectToJsonNode(_indexingConfig));\n+    jsonConfig.set(CUSTOM_CONFIG_KEY, JsonUtils.objectToJsonNode(_customConfig));\n+\n+    // Optional fields\n+    if (_quotaConfig != null) {\n+      jsonConfig.set(QUOTA_CONFIG_KEY, JsonUtils.objectToJsonNode(_quotaConfig));\n     }\n-    if (tableConfig._taskConfig != null) {\n-      jsonConfig.set(TASK_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._taskConfig));\n+    if (_taskConfig != null) {\n+      jsonConfig.set(TASK_CONFIG_KEY, JsonUtils.objectToJsonNode(_taskConfig));\n     }\n-    if (tableConfig._routingConfig != null) {\n-      jsonConfig.set(ROUTING_CONFIG_KEY, JsonUtils.objectToJsonNode(tableConfig._routingConfig));\n+    if (_routingConfig != null) {\n+      jsonConfig.set(ROUTING_CONFIG_KEY, JsonUtils.objectToJsonNode(_routingConfig));\n     }\n+\n     return jsonConfig;\n   }\n \n-  @Nonnull\n-  public static TableConfig fromZnRecord(@Nonnull ZNRecord znRecord)\n+  public String toJsonConfigString() {\n+    return toJsonConfig().toString();\n+  }\n+\n+  public static TableConfig fromZnRecord(ZNRecord znRecord)\n       throws IOException {\n     Map<String, String> simpleFields = znRecord.getSimpleFields();\n-    TableType tableType = TableType.valueOf(simpleFields.get(TABLE_TYPE_KEY).toUpperCase());\n-    String tableName = TableNameBuilder.forType(tableType).tableNameWithType(simpleFields.get(TABLE_NAME_KEY));\n+\n+    // Mandatory fields\n+    String tableTypeString = simpleFields.get(TABLE_TYPE_KEY);\n+    Preconditions.checkState(tableTypeString != null, FIELD_MISSING_MESSAGE_TEMPLATE, TABLE_TYPE_KEY);\n+    TableType tableType = TableType.valueOf(tableTypeString.toUpperCase());\n+\n+    String tableNameString = simpleFields.get(TABLE_NAME_KEY);\n+    Preconditions.checkState(tableNameString != null, FIELD_MISSING_MESSAGE_TEMPLATE, TABLE_NAME_KEY);\n+    String tableName = TableNameBuilder.forType(tableType).tableNameWithType(tableNameString);\n+\n+    String validationConfigString = simpleFields.get(VALIDATION_CONFIG_KEY);\n+    Preconditions.checkState(validationConfigString != null, FIELD_MISSING_MESSAGE_TEMPLATE, VALIDATION_CONFIG_KEY);\n     SegmentsValidationAndRetentionConfig validationConfig =\n-        JsonUtils.stringToObject(simpleFields.get(VALIDATION_CONFIG_KEY), SegmentsValidationAndRetentionConfig.class);\n-    TenantConfig tenantConfig = JsonUtils.stringToObject(simpleFields.get(TENANT_CONFIG_KEY), TenantConfig.class);\n-    IndexingConfig indexingConfig =\n-        JsonUtils.stringToObject(simpleFields.get(INDEXING_CONFIG_KEY), IndexingConfig.class);\n-    TableCustomConfig customConfig =\n-        JsonUtils.stringToObject(simpleFields.get(CUSTOM_CONFIG_KEY), TableCustomConfig.class);\n+        JsonUtils.stringToObject(validationConfigString, SegmentsValidationAndRetentionConfig.class);\n+\n+    String tenantConfigString = simpleFields.get(TENANT_CONFIG_KEY);\n+    Preconditions.checkState(tenantConfigString != null, FIELD_MISSING_MESSAGE_TEMPLATE, TENANT_CONFIG_KEY);\n+    TenantConfig tenantConfig = JsonUtils.stringToObject(tenantConfigString, TenantConfig.class);\n+\n+    String indexingConfigString = simpleFields.get(INDEXING_CONFIG_KEY);\n+    Preconditions.checkState(indexingConfigString != null, FIELD_MISSING_MESSAGE_TEMPLATE, INDEXING_CONFIG_KEY);\n+    IndexingConfig indexingConfig = JsonUtils.stringToObject(indexingConfigString, IndexingConfig.class);\n+\n+    String customConfigString = simpleFields.get(CUSTOM_CONFIG_KEY);\n+    Preconditions.checkState(customConfigString != null, FIELD_MISSING_MESSAGE_TEMPLATE, CUSTOM_CONFIG_KEY);\n+    TableCustomConfig customConfig = JsonUtils.stringToObject(customConfigString, TableCustomConfig.class);\n+\n+    // Optional fields\n     QuotaConfig quotaConfig = null;\n     String quotaConfigString = simpleFields.get(QUOTA_CONFIG_KEY);\n     if (quotaConfigString != null) {\n       quotaConfig = JsonUtils.stringToObject(quotaConfigString, QuotaConfig.class);\n       quotaConfig.validate();\n     }\n+\n     TableTaskConfig taskConfig = null;\n     String taskConfigString = simpleFields.get(TASK_CONFIG_KEY);\n     if (taskConfigString != null) {\n       taskConfig = JsonUtils.stringToObject(taskConfigString, TableTaskConfig.class);\n     }\n-    String routingConfigString = simpleFields.get(ROUTING_CONFIG_KEY);\n \n     RoutingConfig routingConfig = null;\n+    String routingConfigString = simpleFields.get(ROUTING_CONFIG_KEY);\n     if (routingConfigString != null) {\n       routingConfig = JsonUtils.stringToObject(routingConfigString, RoutingConfig.class);\n     }\n@@ -215,84 +254,94 @@ public static TableConfig fromZnRecord(@Nonnull ZNRecord znRecord)\n         quotaConfig, taskConfig, routingConfig);\n   }\n \n-  @Nonnull\n-  public static ZNRecord toZnRecord(@Nonnull TableConfig tableConfig) {\n-    ZNRecord znRecord = new ZNRecord(tableConfig.getTableName());\n+  public ZNRecord toZNRecord()\n+      throws JsonProcessingException {\n+    validate();\n+\n     Map<String, String> simpleFields = new HashMap<>();\n-    simpleFields.put(TABLE_NAME_KEY, tableConfig._tableName);\n-    simpleFields.put(TABLE_TYPE_KEY, tableConfig._tableType.toString());\n-    try {\n-      simpleFields.put(VALIDATION_CONFIG_KEY, JsonUtils.objectToString(tableConfig._validationConfig));\n-      simpleFields.put(TENANT_CONFIG_KEY, JsonUtils.objectToString(tableConfig._tenantConfig));\n-      simpleFields.put(INDEXING_CONFIG_KEY, JsonUtils.objectToString(tableConfig._indexingConfig));\n-      simpleFields.put(CUSTOM_CONFIG_KEY, JsonUtils.objectToString(tableConfig._customConfig));\n-      if (tableConfig._quotaConfig != null) {\n-        simpleFields.put(QUOTA_CONFIG_KEY, JsonUtils.objectToString(tableConfig._quotaConfig));\n-      }\n-      if (tableConfig._taskConfig != null) {\n-        simpleFields.put(TASK_CONFIG_KEY, JsonUtils.objectToString(tableConfig._taskConfig));\n-      }\n-      if (tableConfig._routingConfig != null) {\n-        simpleFields.put(ROUTING_CONFIG_KEY, JsonUtils.objectToString(tableConfig._routingConfig));\n-      }\n-    } catch (IOException e) {\n-      throw new RuntimeException(e);\n+\n+    // Mandatory fields\n+    simpleFields.put(TABLE_NAME_KEY, _tableName);\n+    simpleFields.put(TABLE_TYPE_KEY, _tableType.toString());\n+    simpleFields.put(VALIDATION_CONFIG_KEY, JsonUtils.objectToString(_validationConfig));\n+    simpleFields.put(TENANT_CONFIG_KEY, JsonUtils.objectToString(_tenantConfig));\n+    simpleFields.put(INDEXING_CONFIG_KEY, JsonUtils.objectToString(_indexingConfig));\n+    simpleFields.put(CUSTOM_CONFIG_KEY, JsonUtils.objectToString(_customConfig));\n+\n+    // Optional fields\n+    if (_quotaConfig != null) {\n+      simpleFields.put(QUOTA_CONFIG_KEY, JsonUtils.objectToString(_quotaConfig));\n+    }\n+    if (_taskConfig != null) {\n+      simpleFields.put(TASK_CONFIG_KEY, JsonUtils.objectToString(_taskConfig));\n     }\n+    if (_routingConfig != null) {\n+      simpleFields.put(ROUTING_CONFIG_KEY, JsonUtils.objectToString(_routingConfig));\n+    }\n+\n+    ZNRecord znRecord = new ZNRecord(_tableName);\n     znRecord.setSimpleFields(simpleFields);\n     return znRecord;\n   }\n \n-  @Nonnull\n+  /**\n+   * Validates the table config.\n+   * TODO: revisit to see whether all the following fields are mandatory\n+   */\n+  public void validate() {\n+    Preconditions.checkState(_tableName != null, \"Table name is missing\");\n+    Preconditions.checkState(_tableType != null, \"Table type is missing\");\n+    Preconditions.checkState(_validationConfig != null, \"Validation config is missing\");\n+    Preconditions.checkState(_tenantConfig != null, \"Tenant config is missing\");\n+    Preconditions.checkState(_indexingConfig != null, \"Indexing config is missing\");\n+    Preconditions.checkState(_customConfig != null, \"Custom config is missing\");\n+  }\n+\n   public String getTableName() {\n     return _tableName;\n   }\n \n-  public void setTableName(@Nonnull String tableName) {\n+  public void setTableName(String tableName) {\n     _tableName = tableName;\n   }\n \n-  @Nonnull\n   public TableType getTableType() {\n     return _tableType;\n   }\n \n-  public void setTableType(@Nonnull TableType tableType) {\n+  public void setTableType(TableType tableType) {\n     _tableType = tableType;\n   }\n \n-  @Nonnull\n   public SegmentsValidationAndRetentionConfig getValidationConfig() {\n     return _validationConfig;\n   }\n \n-  public void setValidationConfig(@Nonnull SegmentsValidationAndRetentionConfig validationConfig) {\n+  public void setValidationConfig(SegmentsValidationAndRetentionConfig validationConfig) {\n     _validationConfig = validationConfig;\n   }\n \n-  @Nonnull\n   public TenantConfig getTenantConfig() {\n     return _tenantConfig;\n   }\n \n-  public void setTenantConfig(@Nonnull TenantConfig tenantConfig) {\n+  public void setTenantConfig(TenantConfig tenantConfig) {\n     _tenantConfig = tenantConfig;\n   }\n \n-  @Nonnull\n   public IndexingConfig getIndexingConfig() {\n     return _indexingConfig;\n   }\n \n-  public void setIndexingConfig(@Nonnull IndexingConfig indexingConfig) {\n+  public void setIndexingConfig(IndexingConfig indexingConfig) {\n     _indexingConfig = indexingConfig;\n   }\n \n-  @Nonnull\n   public TableCustomConfig getCustomConfig() {\n     return _customConfig;\n   }\n \n-  public void setCustomConfig(@Nonnull TableCustomConfig customConfig) {\n+  public void setCustomConfig(TableCustomConfig customConfig) {\n     _customConfig = customConfig;\n   }\n \n@@ -301,7 +350,7 @@ public QuotaConfig getQuotaConfig() {\n     return _quotaConfig;\n   }\n \n-  public void setQuotaConfig(@Nullable QuotaConfig quotaConfig) {\n+  public void setQuotaConfig(QuotaConfig quotaConfig) {\n     _quotaConfig = quotaConfig;\n   }\n \n@@ -310,7 +359,7 @@ public TableTaskConfig getTaskConfig() {\n     return _taskConfig;\n   }\n \n-  public void setTaskConfig(@Nullable TableTaskConfig taskConfig) {\n+  public void setTaskConfig(TableTaskConfig taskConfig) {\n     _taskConfig = taskConfig;\n   }\n \n@@ -323,16 +372,10 @@ public void setRoutingConfig(RoutingConfig routingConfig) {\n     _routingConfig = routingConfig;\n   }\n \n-  @Nonnull\n-  public String toJSONConfigString()\n-      throws IOException {\n-    return toJSONConfig(this).toString();\n-  }\n-\n   @Override\n   public String toString() {\n     try {\n-      return JsonUtils.objectToPrettyString(toJSONConfig(this));\n+      return JsonUtils.objectToPrettyString(toJsonConfig());\n     } catch (JsonProcessingException e) {\n       throw new RuntimeException(e);\n     }",
                "deletions": 96
            },
            {
                "sha": "38210942a5bd2025076bddf0569c7278bdae5528",
                "filename": "pinot-common/src/test/java/org/apache/pinot/common/config/TableConfigTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-common/src/test/java/org/apache/pinot/common/config/TableConfigTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-common/src/test/java/org/apache/pinot/common/config/TableConfigTest.java",
                "status": "modified",
                "changes": 336,
                "additions": 195,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/test/java/org/apache/pinot/common/config/TableConfigTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -18,21 +18,95 @@\n  */\n package org.apache.pinot.common.config;\n \n-import com.fasterxml.jackson.databind.JsonNode;\n import com.fasterxml.jackson.databind.node.ObjectNode;\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.Set;\n-import org.apache.helix.ZNRecord;\n import org.apache.pinot.common.data.StarTreeIndexSpec;\n import org.apache.pinot.common.utils.CommonConstants.Helix.TableType;\n import org.apache.pinot.startree.hll.HllConfig;\n-import org.testng.Assert;\n import org.testng.annotations.Test;\n \n+import static org.testng.Assert.*;\n+\n \n public class TableConfigTest {\n \n+  @Test\n+  public void testSerializeMandatoryFields()\n+      throws Exception {\n+    TableConfig tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    tableConfig.setTableName(null);\n+    testSerializeMandatoryFields(tableConfig, \"Table name\");\n+\n+    tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    tableConfig.setTableType(null);\n+    testSerializeMandatoryFields(tableConfig, \"Table type\");\n+\n+    tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    tableConfig.setValidationConfig(null);\n+    testSerializeMandatoryFields(tableConfig, \"Validation config\");\n+\n+    tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    tableConfig.setTenantConfig(null);\n+    testSerializeMandatoryFields(tableConfig, \"Tenant config\");\n+\n+    tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    tableConfig.setIndexingConfig(null);\n+    testSerializeMandatoryFields(tableConfig, \"Indexing config\");\n+\n+    tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    tableConfig.setCustomConfig(null);\n+    testSerializeMandatoryFields(tableConfig, \"Custom config\");\n+  }\n+\n+  private void testSerializeMandatoryFields(TableConfig tableConfig, String expectedMessage)\n+      throws Exception {\n+    try {\n+      tableConfig.toJsonConfig();\n+      fail();\n+    } catch (IllegalStateException e) {\n+      assertTrue(e.getMessage().contains(expectedMessage));\n+    }\n+    try {\n+      tableConfig.toZNRecord();\n+      fail();\n+    } catch (IllegalStateException e) {\n+      assertTrue(e.getMessage().contains(expectedMessage));\n+    }\n+  }\n+\n+  @Test\n+  public void testDeserializeMandatoryFields()\n+      throws Exception {\n+    TableConfig tableConfig = new TableConfig.Builder(TableType.OFFLINE).setTableName(\"myTable\").build();\n+    ObjectNode jsonTableConfig = tableConfig.toJsonConfig();\n+    TableConfig.fromJsonConfig(jsonTableConfig);\n+\n+    testDeserializeMandatoryFields(jsonTableConfig.deepCopy(), TableConfig.TABLE_TYPE_KEY);\n+\n+    testDeserializeMandatoryFields(jsonTableConfig.deepCopy(), TableConfig.TABLE_NAME_KEY);\n+\n+    testDeserializeMandatoryFields(jsonTableConfig.deepCopy(), TableConfig.VALIDATION_CONFIG_KEY);\n+\n+    testDeserializeMandatoryFields(jsonTableConfig.deepCopy(), TableConfig.TENANT_CONFIG_KEY);\n+\n+    testDeserializeMandatoryFields(jsonTableConfig.deepCopy(), TableConfig.INDEXING_CONFIG_KEY);\n+\n+    testDeserializeMandatoryFields(jsonTableConfig.deepCopy(), TableConfig.CUSTOM_CONFIG_KEY);\n+  }\n+\n+  private void testDeserializeMandatoryFields(ObjectNode jsonTableConfig, String mandatoryFieldKey)\n+      throws Exception {\n+    jsonTableConfig.remove(mandatoryFieldKey);\n+    try {\n+      TableConfig.fromJsonConfig(jsonTableConfig);\n+      fail();\n+    } catch (IllegalStateException e) {\n+      assertTrue(e.getMessage().contains(mandatoryFieldKey));\n+    }\n+  }\n+\n   @Test\n   public void testSerializeDeserialize()\n       throws Exception {\n@@ -41,136 +115,122 @@ public void testSerializeDeserialize()\n       // No quota config\n       TableConfig tableConfig = tableConfigBuilder.build();\n \n-      Assert.assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n-      Assert.assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n-      Assert.assertEquals(tableConfig.getIndexingConfig().getLoadMode(), \"HEAP\");\n-      Assert.assertNull(tableConfig.getQuotaConfig());\n+      assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n+      assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n+      assertEquals(tableConfig.getIndexingConfig().getLoadMode(), \"HEAP\");\n+      assertNull(tableConfig.getQuotaConfig());\n \n       // Serialize\n-      JsonNode jsonTableConfig = TableConfig.toJSONConfig(tableConfig);\n+      ObjectNode jsonTableConfig = tableConfig.toJsonConfig();\n       // All nested configs should be json objects instead of serialized strings\n-      Assert.assertTrue(jsonTableConfig.get(TableConfig.VALIDATION_CONFIG_KEY) instanceof ObjectNode);\n-      Assert.assertTrue(jsonTableConfig.get(TableConfig.TENANT_CONFIG_KEY) instanceof ObjectNode);\n-      Assert.assertTrue(jsonTableConfig.get(TableConfig.INDEXING_CONFIG_KEY) instanceof ObjectNode);\n-      Assert.assertTrue(jsonTableConfig.get(TableConfig.CUSTOM_CONFIG_KEY) instanceof ObjectNode);\n+      assertTrue(jsonTableConfig.get(TableConfig.VALIDATION_CONFIG_KEY) instanceof ObjectNode);\n+      assertTrue(jsonTableConfig.get(TableConfig.TENANT_CONFIG_KEY) instanceof ObjectNode);\n+      assertTrue(jsonTableConfig.get(TableConfig.INDEXING_CONFIG_KEY) instanceof ObjectNode);\n+      assertTrue(jsonTableConfig.get(TableConfig.CUSTOM_CONFIG_KEY) instanceof ObjectNode);\n \n       // De-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(jsonTableConfig);\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNull(tableConfigToCompare.getQuotaConfig());\n-      Assert.assertNull(tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig());\n-      Assert.assertNull(tableConfigToCompare.getValidationConfig().getHllConfig());\n-\n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNull(tableConfigToCompare.getQuotaConfig());\n-      Assert.assertNull(tableConfig.getValidationConfig().getReplicaGroupStrategyConfig());\n-      Assert.assertNull(tableConfigToCompare.getValidationConfig().getHllConfig());\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(jsonTableConfig);\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNull(tableConfigToCompare.getQuotaConfig());\n+      assertNull(tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig());\n+      assertNull(tableConfigToCompare.getValidationConfig().getHllConfig());\n+\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNull(tableConfigToCompare.getQuotaConfig());\n+      assertNull(tableConfig.getValidationConfig().getReplicaGroupStrategyConfig());\n+      assertNull(tableConfigToCompare.getValidationConfig().getHllConfig());\n     }\n     {\n       // With quota config\n       QuotaConfig quotaConfig = new QuotaConfig();\n       quotaConfig.setStorage(\"30G\");\n       TableConfig tableConfig = tableConfigBuilder.setQuotaConfig(quotaConfig).build();\n \n-      Assert.assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n-      Assert.assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n-      Assert.assertEquals(tableConfig.getIndexingConfig().getLoadMode(), \"HEAP\");\n-      Assert.assertNotNull(tableConfig.getQuotaConfig());\n-      Assert.assertEquals(tableConfig.getQuotaConfig().getStorage(), \"30G\");\n-      Assert.assertNull(tableConfig.getQuotaConfig().getMaxQueriesPerSecond());\n+      assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n+      assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n+      assertEquals(tableConfig.getIndexingConfig().getLoadMode(), \"HEAP\");\n+      assertNotNull(tableConfig.getQuotaConfig());\n+      assertEquals(tableConfig.getQuotaConfig().getStorage(), \"30G\");\n+      assertNull(tableConfig.getQuotaConfig().getMaxQueriesPerSecond());\n \n       // With qps quota\n       quotaConfig.setMaxQueriesPerSecond(\"100.00\");\n       tableConfig = tableConfigBuilder.setQuotaConfig(quotaConfig).build();\n-      Assert.assertNotNull(tableConfig.getQuotaConfig());\n-      Assert.assertNotNull(tableConfig.getQuotaConfig().getMaxQueriesPerSecond());\n-      Assert.assertEquals(tableConfig.getQuotaConfig().getMaxQueriesPerSecond(), \"100.00\");\n+      assertNotNull(tableConfig.getQuotaConfig());\n+      assertNotNull(tableConfig.getQuotaConfig().getMaxQueriesPerSecond());\n+      assertEquals(tableConfig.getQuotaConfig().getMaxQueriesPerSecond(), \"100.00\");\n \n       // Serialize then de-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNotNull(tableConfigToCompare.getQuotaConfig());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getQuotaConfig().getStorage(), tableConfig.getQuotaConfig().getStorage());\n-\n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNotNull(tableConfigToCompare.getQuotaConfig());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getQuotaConfig().getStorage(), tableConfig.getQuotaConfig().getStorage());\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNotNull(tableConfigToCompare.getQuotaConfig());\n+      assertEquals(tableConfigToCompare.getQuotaConfig().getStorage(), tableConfig.getQuotaConfig().getStorage());\n+\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNotNull(tableConfigToCompare.getQuotaConfig());\n+      assertEquals(tableConfigToCompare.getQuotaConfig().getStorage(), tableConfig.getQuotaConfig().getStorage());\n     }\n     {\n       // With tenant config\n       TableConfig tableConfig =\n           tableConfigBuilder.setServerTenant(\"aServerTenant\").setBrokerTenant(\"aBrokerTenant\").build();\n \n-      Assert.assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n-      Assert.assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n-      Assert.assertEquals(tableConfig.getIndexingConfig().getLoadMode(), \"HEAP\");\n-      Assert.assertNotNull(tableConfig.getTenantConfig());\n-      Assert.assertEquals(tableConfig.getTenantConfig().getServer(), \"aServerTenant\");\n-      Assert.assertEquals(tableConfig.getTenantConfig().getBroker(), \"aBrokerTenant\");\n-      Assert.assertNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n+      assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n+      assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n+      assertEquals(tableConfig.getIndexingConfig().getLoadMode(), \"HEAP\");\n+      assertNotNull(tableConfig.getTenantConfig());\n+      assertEquals(tableConfig.getTenantConfig().getServer(), \"aServerTenant\");\n+      assertEquals(tableConfig.getTenantConfig().getBroker(), \"aBrokerTenant\");\n+      assertNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n \n       // Serialize then de-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNotNull(tableConfigToCompare.getTenantConfig());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n-      Assert.assertNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n-\n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNotNull(tableConfigToCompare.getTenantConfig());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n-      Assert.assertNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNotNull(tableConfigToCompare.getTenantConfig());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n+      assertNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n+\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNotNull(tableConfigToCompare.getTenantConfig());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n+      assertNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n \n       TagOverrideConfig tagOverrideConfig = new TagOverrideConfig();\n       tagOverrideConfig.setRealtimeConsuming(\"aRTConsumingTag_REALTIME\");\n       tableConfig = tableConfigBuilder.setTagOverrideConfig(tagOverrideConfig).build();\n \n-      Assert.assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n-      Assert.assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n-      Assert.assertNotNull(tableConfig.getTenantConfig());\n-      Assert.assertEquals(tableConfig.getTenantConfig().getServer(), \"aServerTenant\");\n-      Assert.assertEquals(tableConfig.getTenantConfig().getBroker(), \"aBrokerTenant\");\n-      Assert.assertNotNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n-      Assert.assertEquals(tableConfig.getTenantConfig().getTagOverrideConfig().getRealtimeConsuming(),\n+      assertEquals(tableConfig.getTableName(), \"myTable_OFFLINE\");\n+      assertEquals(tableConfig.getTableType(), TableType.OFFLINE);\n+      assertNotNull(tableConfig.getTenantConfig());\n+      assertEquals(tableConfig.getTenantConfig().getServer(), \"aServerTenant\");\n+      assertEquals(tableConfig.getTenantConfig().getBroker(), \"aBrokerTenant\");\n+      assertNotNull(tableConfig.getTenantConfig().getTagOverrideConfig());\n+      assertEquals(tableConfig.getTenantConfig().getTagOverrideConfig().getRealtimeConsuming(),\n           \"aRTConsumingTag_REALTIME\");\n-      Assert.assertNull(tableConfig.getTenantConfig().getTagOverrideConfig().getRealtimeCompleted());\n+      assertNull(tableConfig.getTenantConfig().getTagOverrideConfig().getRealtimeCompleted());\n \n       // Serialize then de-serialize\n-      tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNotNull(tableConfigToCompare.getTenantConfig());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n-      Assert.assertNotNull(tableConfigToCompare.getTenantConfig().getTagOverrideConfig());\n-      Assert.assertEquals(tableConfig.getTenantConfig().getTagOverrideConfig(),\n+      tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNotNull(tableConfigToCompare.getTenantConfig());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n+      assertNotNull(tableConfigToCompare.getTenantConfig().getTagOverrideConfig());\n+      assertEquals(tableConfig.getTenantConfig().getTagOverrideConfig(),\n           tableConfigToCompare.getTenantConfig().getTagOverrideConfig());\n \n-      znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n-      Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-      Assert.assertNotNull(tableConfigToCompare.getTenantConfig());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n-      Assert\n-          .assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n-      Assert.assertNotNull(tableConfigToCompare.getTenantConfig().getTagOverrideConfig());\n-      Assert.assertEquals(tableConfig.getTenantConfig().getTagOverrideConfig(),\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n+      assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+      assertNotNull(tableConfigToCompare.getTenantConfig());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getServer(), tableConfig.getTenantConfig().getServer());\n+      assertEquals(tableConfigToCompare.getTenantConfig().getBroker(), tableConfig.getTenantConfig().getBroker());\n+      assertNotNull(tableConfigToCompare.getTenantConfig().getTagOverrideConfig());\n+      assertEquals(tableConfig.getTenantConfig().getTagOverrideConfig(),\n           tableConfigToCompare.getTenantConfig().getTagOverrideConfig());\n     }\n     {\n@@ -185,36 +245,32 @@ public void testSerializeDeserialize()\n       tableConfig.getValidationConfig().setReplicaGroupStrategyConfig(replicaGroupConfig);\n \n       // Serialize then de-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n       checkTableConfigWithAssignmentConfig(tableConfig, tableConfigToCompare);\n \n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n       checkTableConfigWithAssignmentConfig(tableConfig, tableConfigToCompare);\n     }\n     {\n       // With default StreamConsumptionConfig\n       TableConfig tableConfig = tableConfigBuilder.build();\n-      Assert.assertEquals(\n-          tableConfig.getIndexingConfig().getStreamConsumptionConfig().getStreamPartitionAssignmentStrategy(),\n+      assertEquals(tableConfig.getIndexingConfig().getStreamConsumptionConfig().getStreamPartitionAssignmentStrategy(),\n           \"UniformStreamPartitionAssignment\");\n \n       // with streamConsumptionConfig set\n       tableConfig =\n           tableConfigBuilder.setStreamPartitionAssignmentStrategy(\"BalancedStreamPartitionAssignment\").build();\n-      Assert.assertEquals(\n-          tableConfig.getIndexingConfig().getStreamConsumptionConfig().getStreamPartitionAssignmentStrategy(),\n+      assertEquals(tableConfig.getIndexingConfig().getStreamConsumptionConfig().getStreamPartitionAssignmentStrategy(),\n           \"BalancedStreamPartitionAssignment\");\n \n       // Serialize then de-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n-      Assert.assertEquals(\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n+      assertEquals(\n           tableConfigToCompare.getIndexingConfig().getStreamConsumptionConfig().getStreamPartitionAssignmentStrategy(),\n           \"BalancedStreamPartitionAssignment\");\n \n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n-      Assert.assertEquals(\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n+      assertEquals(\n           tableConfigToCompare.getIndexingConfig().getStreamConsumptionConfig().getStreamPartitionAssignmentStrategy(),\n           \"BalancedStreamPartitionAssignment\");\n     }\n@@ -233,11 +289,10 @@ public void testSerializeDeserialize()\n       tableConfig.getIndexingConfig().setStarTreeIndexSpec(starTreeIndexSpec);\n \n       // Serialize then de-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n       checkTableConfigWithStarTreeConfig(tableConfig, tableConfigToCompare);\n \n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n       checkTableConfigWithStarTreeConfig(tableConfig, tableConfigToCompare);\n     }\n     {\n@@ -253,68 +308,67 @@ public void testSerializeDeserialize()\n \n       String hllConfigJson = hllConfig.toJsonString();\n       HllConfig newHllConfig = HllConfig.fromJsonString(hllConfigJson);\n-      Assert.assertEquals(hllConfig.getColumnsToDeriveHllFields(), newHllConfig.getColumnsToDeriveHllFields());\n-      Assert.assertEquals(hllConfig.getHllLog2m(), newHllConfig.getHllLog2m());\n-      Assert.assertEquals(hllConfig.getHllDeriveColumnSuffix(), newHllConfig.getHllDeriveColumnSuffix());\n+      assertEquals(hllConfig.getColumnsToDeriveHllFields(), newHllConfig.getColumnsToDeriveHllFields());\n+      assertEquals(hllConfig.getHllLog2m(), newHllConfig.getHllLog2m());\n+      assertEquals(hllConfig.getHllDeriveColumnSuffix(), newHllConfig.getHllDeriveColumnSuffix());\n \n       TableConfig tableConfig = tableConfigBuilder.build();\n       tableConfig.getValidationConfig().setHllConfig(hllConfig);\n \n       // Serialize then de-serialize\n-      TableConfig tableConfigToCompare = TableConfig.fromJSONConfig(TableConfig.toJSONConfig(tableConfig));\n+      TableConfig tableConfigToCompare = TableConfig.fromJsonConfig(tableConfig.toJsonConfig());\n       checkTableConfigWithHllConfig(tableConfig, tableConfigToCompare);\n \n-      ZNRecord znRecord = TableConfig.toZnRecord(tableConfig);\n-      tableConfigToCompare = TableConfig.fromZnRecord(znRecord);\n+      tableConfigToCompare = TableConfig.fromZnRecord(tableConfig.toZNRecord());\n       checkTableConfigWithHllConfig(tableConfig, tableConfigToCompare);\n     }\n   }\n \n   private void checkTableConfigWithAssignmentConfig(TableConfig tableConfig, TableConfig tableConfigToCompare) {\n     // Check that the segment assignment configuration does exist.\n-    Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-    Assert.assertNotNull(tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig());\n-    Assert.assertEquals(tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig(),\n+    assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+    assertNotNull(tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig());\n+    assertEquals(tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig(),\n         tableConfig.getValidationConfig().getReplicaGroupStrategyConfig());\n \n     // Check that the configurations are correct.\n     ReplicaGroupStrategyConfig strategyConfig =\n         tableConfigToCompare.getValidationConfig().getReplicaGroupStrategyConfig();\n-    Assert.assertTrue(strategyConfig.getMirrorAssignmentAcrossReplicaGroups());\n-    Assert.assertEquals(strategyConfig.getNumInstancesPerPartition(), 5);\n-    Assert.assertEquals(strategyConfig.getPartitionColumn(), \"memberId\");\n+    assertTrue(strategyConfig.getMirrorAssignmentAcrossReplicaGroups());\n+    assertEquals(strategyConfig.getNumInstancesPerPartition(), 5);\n+    assertEquals(strategyConfig.getPartitionColumn(), \"memberId\");\n   }\n \n   private void checkTableConfigWithStarTreeConfig(TableConfig tableConfig, TableConfig tableConfigToCompare)\n       throws Exception {\n     // Check that the segment assignment configuration does exist.\n-    Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-    Assert.assertNotNull(tableConfigToCompare.getIndexingConfig().getStarTreeIndexSpec());\n+    assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+    assertNotNull(tableConfigToCompare.getIndexingConfig().getStarTreeIndexSpec());\n \n     // Check that the configurations are correct.\n     StarTreeIndexSpec starTreeIndexSpec = tableConfigToCompare.getIndexingConfig().getStarTreeIndexSpec();\n \n     Set<String> dims = new HashSet<>();\n     dims.add(\"dims\");\n \n-    Assert.assertEquals(starTreeIndexSpec.getDimensionsSplitOrder(), Collections.singletonList(\"dim\"));\n-    Assert.assertEquals(starTreeIndexSpec.getMaxLeafRecords(), 5);\n-    Assert.assertEquals(starTreeIndexSpec.getSkipMaterializationCardinalityThreshold(), 1);\n-    Assert.assertEquals(starTreeIndexSpec.getSkipMaterializationForDimensions(), dims);\n-    Assert.assertEquals(starTreeIndexSpec.getSkipStarNodeCreationForDimensions(), dims);\n+    assertEquals(starTreeIndexSpec.getDimensionsSplitOrder(), Collections.singletonList(\"dim\"));\n+    assertEquals(starTreeIndexSpec.getMaxLeafRecords(), 5);\n+    assertEquals(starTreeIndexSpec.getSkipMaterializationCardinalityThreshold(), 1);\n+    assertEquals(starTreeIndexSpec.getSkipMaterializationForDimensions(), dims);\n+    assertEquals(starTreeIndexSpec.getSkipStarNodeCreationForDimensions(), dims);\n \n     starTreeIndexSpec = StarTreeIndexSpec.fromJsonString(starTreeIndexSpec.toJsonString());\n-    Assert.assertEquals(starTreeIndexSpec.getDimensionsSplitOrder(), Collections.singletonList(\"dim\"));\n-    Assert.assertEquals(starTreeIndexSpec.getMaxLeafRecords(), 5);\n-    Assert.assertEquals(starTreeIndexSpec.getSkipMaterializationCardinalityThreshold(), 1);\n-    Assert.assertEquals(starTreeIndexSpec.getSkipMaterializationForDimensions(), dims);\n-    Assert.assertEquals(starTreeIndexSpec.getSkipStarNodeCreationForDimensions(), dims);\n+    assertEquals(starTreeIndexSpec.getDimensionsSplitOrder(), Collections.singletonList(\"dim\"));\n+    assertEquals(starTreeIndexSpec.getMaxLeafRecords(), 5);\n+    assertEquals(starTreeIndexSpec.getSkipMaterializationCardinalityThreshold(), 1);\n+    assertEquals(starTreeIndexSpec.getSkipMaterializationForDimensions(), dims);\n+    assertEquals(starTreeIndexSpec.getSkipStarNodeCreationForDimensions(), dims);\n   }\n \n   private void checkTableConfigWithHllConfig(TableConfig tableConfig, TableConfig tableConfigToCompare) {\n     // Check that the segment assignment configuration does exist.\n-    Assert.assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n-    Assert.assertNotNull(tableConfigToCompare.getValidationConfig().getHllConfig());\n+    assertEquals(tableConfigToCompare.getTableName(), tableConfig.getTableName());\n+    assertNotNull(tableConfigToCompare.getValidationConfig().getHllConfig());\n \n     // Check that the configurations are correct.\n     HllConfig hllConfig = tableConfigToCompare.getValidationConfig().getHllConfig();\n@@ -323,8 +377,8 @@ private void checkTableConfigWithHllConfig(TableConfig tableConfig, TableConfig\n     columns.add(\"column\");\n     columns.add(\"column2\");\n \n-    Assert.assertEquals(hllConfig.getColumnsToDeriveHllFields(), columns);\n-    Assert.assertEquals(hllConfig.getHllLog2m(), 9);\n-    Assert.assertEquals(hllConfig.getHllDeriveColumnSuffix(), \"suffix\");\n+    assertEquals(hllConfig.getColumnsToDeriveHllFields(), columns);\n+    assertEquals(hllConfig.getHllLog2m(), 9);\n+    assertEquals(hllConfig.getHllDeriveColumnSuffix(), \"suffix\");\n   }\n }",
                "deletions": 141
            },
            {
                "sha": "01d5fdf7ffac74233d369bddf0cd8d2db7e41949",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableConfigRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableConfigRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableConfigRestletResource.java",
                "status": "modified",
                "changes": 140,
                "additions": 74,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableConfigRestletResource.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -94,93 +94,101 @@ public Response readTableConfiguration(@PathParam(\"tableName\") String tableName,\n   @Produces(MediaType.APPLICATION_JSON)\n   @Path(\"/v2/tables\")\n   public Response createNewTable(String tableConfiguration) {\n-    CombinedConfig config = null;\n-\n     try {\n-      config = Deserializer.deserializeFromString(CombinedConfig.class, tableConfiguration);\n-    } catch (Exception e) {\n-      LOGGER.warn(\"Caught exception while deserializing the table configuration\", e);\n-      return Response.serverError().entity(e.getMessage()).type(MediaType.TEXT_PLAIN_TYPE).build();\n-    }\n+      CombinedConfig config;\n \n-    if (config == null) {\n-      LOGGER.warn(\"Failed to deserialize the table configuration: {}\", tableConfiguration);\n-      return Response.serverError().entity(\"Failed to deserialize the table configuration\")\n-          .type(MediaType.TEXT_PLAIN_TYPE).build();\n-    }\n+      try {\n+        config = Deserializer.deserializeFromString(CombinedConfig.class, tableConfiguration);\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Caught exception while deserializing the table configuration\", e);\n+        return Response.serverError().entity(e.getMessage()).type(MediaType.TEXT_PLAIN_TYPE).build();\n+      }\n \n-    if (config.getSchema() != null) {\n-      _resourceManager.addOrUpdateSchema(config.getSchema());\n-    }\n+      if (config == null) {\n+        LOGGER.warn(\"Failed to deserialize the table configuration: {}\", tableConfiguration);\n+        return Response.serverError().entity(\"Failed to deserialize the table configuration\")\n+            .type(MediaType.TEXT_PLAIN_TYPE).build();\n+      }\n \n-    if (config.getOfflineTableConfig() != null) {\n-      _resourceManager.addTable(config.getOfflineTableConfig());\n-    }\n+      if (config.getSchema() != null) {\n+        _resourceManager.addOrUpdateSchema(config.getSchema());\n+      }\n \n-    if (config.getRealtimeTableConfig() != null) {\n-      _resourceManager.addTable(config.getRealtimeTableConfig());\n-    }\n+      if (config.getOfflineTableConfig() != null) {\n+        _resourceManager.addTable(config.getOfflineTableConfig());\n+      }\n \n-    return Response.ok().build();\n+      if (config.getRealtimeTableConfig() != null) {\n+        _resourceManager.addTable(config.getRealtimeTableConfig());\n+      }\n+\n+      return Response.ok().build();\n+    } catch (Exception e) {\n+      throw new ControllerApplicationException(LOGGER, e.getMessage(), Response.Status.INTERNAL_SERVER_ERROR, e);\n+    }\n   }\n \n   @PUT\n   @Produces(MediaType.APPLICATION_JSON)\n   @Path(\"/v2/tables/{tableName}\")\n   public Response updateTable(String tableConfiguration) {\n-    CombinedConfig config = null;\n-\n     try {\n-      config = Deserializer.deserializeFromString(CombinedConfig.class, tableConfiguration);\n-    } catch (Exception e) {\n-      LOGGER.warn(\"Caught exception while deserializing the table configuration\", e);\n-      return Response.serverError().entity(e.getMessage()).type(MediaType.TEXT_PLAIN_TYPE).build();\n-    }\n+      CombinedConfig config;\n \n-    if (config == null) {\n-      LOGGER.warn(\"Failed to deserialize the table configuration: {}\", tableConfiguration);\n-      return Response.serverError().entity(\"Failed to deserialize the table configuration\")\n-          .type(MediaType.TEXT_PLAIN_TYPE).build();\n-    }\n+      try {\n+        config = Deserializer.deserializeFromString(CombinedConfig.class, tableConfiguration);\n+      } catch (Exception e) {\n+        LOGGER.warn(\"Caught exception while deserializing the table configuration\", e);\n+        return Response.serverError().entity(e.getMessage()).type(MediaType.TEXT_PLAIN_TYPE).build();\n+      }\n \n-    if (config.getSchema() != null) {\n-      _resourceManager.addOrUpdateSchema(config.getSchema());\n-    }\n+      if (config == null) {\n+        LOGGER.warn(\"Failed to deserialize the table configuration: {}\", tableConfiguration);\n+        return Response.serverError().entity(\"Failed to deserialize the table configuration\")\n+            .type(MediaType.TEXT_PLAIN_TYPE).build();\n+      }\n \n-    if (config.getOfflineTableConfig() != null) {\n-      if (_resourceManager.getAllTables().contains(config.getOfflineTableConfig().getTableName())) {\n-        try {\n-          _resourceManager\n-              .setExistingTableConfig(config.getOfflineTableConfig(), config.getOfflineTableConfig().getTableName(),\n-                  CommonConstants.Helix.TableType.OFFLINE);\n-        } catch (IOException e) {\n-          LOGGER.warn(\"Failed to update the offline table configuration for table {}\", e,\n-              config.getOfflineTableConfig().getTableName());\n-          return Response.serverError().entity(\"Failed to update the offline table configuration\")\n-              .type(MediaType.TEXT_PLAIN_TYPE).build();\n+      if (config.getSchema() != null) {\n+        _resourceManager.addOrUpdateSchema(config.getSchema());\n+      }\n+\n+      if (config.getOfflineTableConfig() != null) {\n+        if (_resourceManager.getAllTables().contains(config.getOfflineTableConfig().getTableName())) {\n+          try {\n+            _resourceManager\n+                .setExistingTableConfig(config.getOfflineTableConfig(), config.getOfflineTableConfig().getTableName(),\n+                    CommonConstants.Helix.TableType.OFFLINE);\n+          } catch (IOException e) {\n+            LOGGER.warn(\"Failed to update the offline table configuration for table {}\", e,\n+                config.getOfflineTableConfig().getTableName());\n+            return Response.serverError().entity(\"Failed to update the offline table configuration\")\n+                .type(MediaType.TEXT_PLAIN_TYPE).build();\n+          }\n+        } else {\n+          _resourceManager.addTable(config.getOfflineTableConfig());\n         }\n-      } else {\n-        _resourceManager.addTable(config.getOfflineTableConfig());\n       }\n-    }\n \n-    if (config.getRealtimeTableConfig() != null) {\n-      if (_resourceManager.getAllTables().contains(config.getRealtimeTableConfig().getTableName())) {\n-        try {\n-          _resourceManager\n-              .setExistingTableConfig(config.getRealtimeTableConfig(), config.getRealtimeTableConfig().getTableName(),\n-                  CommonConstants.Helix.TableType.REALTIME);\n-        } catch (IOException e) {\n-          LOGGER.warn(\"Failed to update the realtime table configuration for table {}\", e,\n-              config.getRealtimeTableConfig().getTableName());\n-          return Response.serverError().entity(\"Failed to update the realtime table configuration\")\n-              .type(MediaType.TEXT_PLAIN_TYPE).build();\n+      if (config.getRealtimeTableConfig() != null) {\n+        if (_resourceManager.getAllTables().contains(config.getRealtimeTableConfig().getTableName())) {\n+          try {\n+            _resourceManager\n+                .setExistingTableConfig(config.getRealtimeTableConfig(), config.getRealtimeTableConfig().getTableName(),\n+                    CommonConstants.Helix.TableType.REALTIME);\n+          } catch (IOException e) {\n+            LOGGER.warn(\"Failed to update the realtime table configuration for table {}\", e,\n+                config.getRealtimeTableConfig().getTableName());\n+            return Response.serverError().entity(\"Failed to update the realtime table configuration\")\n+                .type(MediaType.TEXT_PLAIN_TYPE).build();\n+          }\n+        } else {\n+          _resourceManager.addTable(config.getRealtimeTableConfig());\n         }\n-      } else {\n-        _resourceManager.addTable(config.getRealtimeTableConfig());\n       }\n-    }\n \n-    return Response.ok().build();\n+      return Response.ok().build();\n+    } catch (Exception e) {\n+      throw new ControllerApplicationException(LOGGER, e.getMessage(), Response.Status.INTERNAL_SERVER_ERROR, e);\n+    }\n   }\n }",
                "deletions": 66
            },
            {
                "sha": "a3b45e564800e18d776a21bebd5159fc383dfbc0",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableRestletResource.java",
                "status": "modified",
                "changes": 12,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableRestletResource.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -130,7 +130,7 @@ public SuccessResponse addTable(String tableConfigStr) {\n       } else if (e instanceof PinotHelixResourceManager.TableAlreadyExistsException) {\n         throw new ControllerApplicationException(LOGGER, e.getMessage(), Response.Status.CONFLICT, e);\n       } else {\n-        throw e;\n+        throw new ControllerApplicationException(LOGGER, e.getMessage(), Response.Status.INTERNAL_SERVER_ERROR, e);\n       }\n     }\n   }\n@@ -172,14 +172,14 @@ private String listTableConfigs(@Nonnull String tableName, @Nullable String tabl\n           && _pinotHelixResourceManager.hasOfflineTable(tableName)) {\n         TableConfig tableConfig = _pinotHelixResourceManager.getOfflineTableConfig(tableName);\n         Preconditions.checkNotNull(tableConfig);\n-        ret.set(CommonConstants.Helix.TableType.OFFLINE.name(), TableConfig.toJSONConfig(tableConfig));\n+        ret.set(CommonConstants.Helix.TableType.OFFLINE.name(), tableConfig.toJsonConfig());\n       }\n \n       if ((tableTypeStr == null || CommonConstants.Helix.TableType.REALTIME.name().equalsIgnoreCase(tableTypeStr))\n           && _pinotHelixResourceManager.hasRealtimeTable(tableName)) {\n         TableConfig tableConfig = _pinotHelixResourceManager.getRealtimeTableConfig(tableName);\n         Preconditions.checkNotNull(tableConfig);\n-        ret.set(CommonConstants.Helix.TableType.REALTIME.name(), TableConfig.toJSONConfig(tableConfig));\n+        ret.set(CommonConstants.Helix.TableType.REALTIME.name(), tableConfig.toJsonConfig());\n       }\n       return ret.toString();\n     } catch (Exception e) {\n@@ -325,11 +325,9 @@ public String checkTableConfig(String tableConfigStr) {\n       ObjectNode tableConfigValidateStr = JsonUtils.newObjectNode();\n       TableConfig tableConfig = TableConfig.fromJsonString(tableConfigStr);\n       if (tableConfig.getTableType() == CommonConstants.Helix.TableType.OFFLINE) {\n-        tableConfigValidateStr\n-            .set(CommonConstants.Helix.TableType.OFFLINE.name(), TableConfig.toJSONConfig(tableConfig));\n+        tableConfigValidateStr.set(CommonConstants.Helix.TableType.OFFLINE.name(), tableConfig.toJsonConfig());\n       } else {\n-        tableConfigValidateStr\n-            .set(CommonConstants.Helix.TableType.REALTIME.name(), TableConfig.toJSONConfig(tableConfig));\n+        tableConfigValidateStr.set(CommonConstants.Helix.TableType.REALTIME.name(), tableConfig.toJsonConfig());\n       }\n       return tableConfigValidateStr.toString();\n     } catch (Exception e) {",
                "deletions": 7
            },
            {
                "sha": "5e15bff739afcabe254bd69db92a589aaea700c0",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 13,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -1009,7 +1009,8 @@ public Schema getTableSchema(@Nonnull String tableName) {\n    * @throws InvalidTableConfigException\n    * @throws TableAlreadyExistsException for offline tables only if the table already exists\n    */\n-  public void addTable(@Nonnull TableConfig tableConfig) {\n+  public void addTable(@Nonnull TableConfig tableConfig)\n+      throws IOException {\n     final String tableNameWithType = tableConfig.getTableName();\n \n     TenantConfig tenantConfig;\n@@ -1086,8 +1087,7 @@ public void addTable(@Nonnull TableConfig tableConfig) {\n         LOGGER.info(\"successfully added the table : \" + tableNameWithType + \" to the cluster\");\n \n         // lets add table configs\n-        ZKMetadataProvider\n-            .setOfflineTableConfig(_propertyStore, tableNameWithType, TableConfig.toZnRecord(tableConfig));\n+        ZKMetadataProvider.setOfflineTableConfig(_propertyStore, tableNameWithType, tableConfig.toZNRecord());\n \n         _propertyStore.create(ZKMetadataProvider.constructPropertyStorePathForResource(tableNameWithType),\n             new ZNRecord(tableNameWithType), AccessOption.PERSISTENT);\n@@ -1109,8 +1109,7 @@ public void addTable(@Nonnull TableConfig tableConfig) {\n         }\n \n         // lets add table configs\n-        ZKMetadataProvider\n-            .setRealtimeTableConfig(_propertyStore, tableNameWithType, TableConfig.toZnRecord(tableConfig));\n+        ZKMetadataProvider.setRealtimeTableConfig(_propertyStore, tableNameWithType, tableConfig.toZNRecord());\n \n         /*\n          * PinotRealtimeSegmentManager sets up watches on table and segment path. When a table gets created,\n@@ -1248,13 +1247,13 @@ private void createHelixEntriesForHighLevelConsumer(TableConfig config, String r\n   public void setExistingTableConfig(TableConfig config, String tableNameWithType, TableType type)\n       throws IOException {\n     if (type == TableType.REALTIME) {\n-      ZKMetadataProvider.setRealtimeTableConfig(_propertyStore, tableNameWithType, TableConfig.toZnRecord(config));\n+      ZKMetadataProvider.setRealtimeTableConfig(_propertyStore, tableNameWithType, config.toZNRecord());\n       ensureRealtimeClusterIsSetUp(config, tableNameWithType, config.getIndexingConfig());\n     } else if (type == TableType.OFFLINE) {\n       // Update replica group partition assignment to the property store if applicable\n       updateReplicaGroupPartitionAssignment(config);\n \n-      ZKMetadataProvider.setOfflineTableConfig(_propertyStore, tableNameWithType, TableConfig.toZnRecord(config));\n+      ZKMetadataProvider.setOfflineTableConfig(_propertyStore, tableNameWithType, config.toZNRecord());\n       IdealState idealState = _helixAdmin.getResourceIdealState(_helixClusterName, tableNameWithType);\n       final String configReplication = config.getValidationConfig().getReplication();\n       if (configReplication != null && !config.getValidationConfig().getReplication()",
                "deletions": 7
            },
            {
                "sha": "26a5e464f0cbac822517e46934a0512566d5fccf",
                "filename": "pinot-controller/src/main/java/org/apache/pinot/controller/util/AutoAddInvertedIndex.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/util/AutoAddInvertedIndex.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/main/java/org/apache/pinot/controller/util/AutoAddInvertedIndex.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/org/apache/pinot/controller/util/AutoAddInvertedIndex.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -339,7 +339,7 @@ private boolean updateIndexConfig(String tableName, TableConfig tableConfig)\n     httpURLConnection.setRequestMethod(\"PUT\");\n \n     BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(httpURLConnection.getOutputStream(), \"UTF-8\"));\n-    writer.write(tableConfig.toJSONConfigString());\n+    writer.write(tableConfig.toJsonConfigString());\n     writer.flush();\n \n     BufferedReader reader = new BufferedReader(new InputStreamReader(httpURLConnection.getInputStream(), \"UTF-8\"));",
                "deletions": 1
            },
            {
                "sha": "5dbe2305ae5e8d0e1c49c3f8bdcfa9826061893c",
                "filename": "pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTableRestletResourceTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTableRestletResourceTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTableRestletResourceTest.java",
                "status": "modified",
                "changes": 34,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTableRestletResourceTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -109,7 +109,7 @@ public void testCreateTable()\n     TableConfig offlineTableConfig = _offlineBuilder.build();\n     offlineTableConfig.setTableName(\"bad__table__name\");\n     try {\n-      sendPostRequest(_createTableUrl, offlineTableConfig.toJSONConfigString());\n+      sendPostRequest(_createTableUrl, offlineTableConfig.toJsonConfigString());\n       Assert.fail(\"Creation of an OFFLINE table with two underscores in the table name does not fail\");\n     } catch (IOException e) {\n       // Expected 400 Bad Request\n@@ -118,7 +118,7 @@ public void testCreateTable()\n \n     // Create an OFFLINE table with a valid name which should succeed\n     offlineTableConfig.setTableName(\"valid_table_name\");\n-    String offlineTableJSONConfigString = offlineTableConfig.toJSONConfigString();\n+    String offlineTableJSONConfigString = offlineTableConfig.toJsonConfigString();\n     sendPostRequest(_createTableUrl, offlineTableJSONConfigString);\n \n     // Create an OFFLINE table that already exists which should fail\n@@ -134,7 +134,7 @@ public void testCreateTable()\n     offlineTableConfig.getValidationConfig().setReplication(\"abc\");\n     offlineTableConfig.setTableName(\"invalid_replication_table\");\n     try {\n-      sendPostRequest(_createTableUrl, offlineTableConfig.toJSONConfigString());\n+      sendPostRequest(_createTableUrl, offlineTableConfig.toJsonConfigString());\n       Assert.fail(\"Creation of an invalid OFFLINE table does not fail\");\n     } catch (IOException e) {\n       // Expected 400 Bad Request\n@@ -146,7 +146,7 @@ public void testCreateTable()\n     TableConfig realtimeTableConfig = _realtimeBuilder.build();\n     realtimeTableConfig.setTableName(\"bad__table__name\");\n     try {\n-      sendPostRequest(_createTableUrl, realtimeTableConfig.toJSONConfigString());\n+      sendPostRequest(_createTableUrl, realtimeTableConfig.toJsonConfigString());\n       Assert.fail(\"Creation of a REALTIME table with two underscores in the table name does not fail\");\n     } catch (IOException e) {\n       // Expected 400 Bad Request\n@@ -157,7 +157,7 @@ public void testCreateTable()\n     _realtimeBuilder.setSchemaName(\"invalidSchemaName\");\n     TableConfig invalidConfig = _realtimeBuilder.build();\n     try {\n-      sendPostRequest(_createTableUrl, realtimeTableConfig.toJSONConfigString());\n+      sendPostRequest(_createTableUrl, realtimeTableConfig.toJsonConfigString());\n       Assert.fail(\"Creation of a REALTIME table without a valid schema does not fail\");\n     } catch (IOException e) {\n       // Expected 400 Bad Request\n@@ -171,13 +171,13 @@ public void testCreateTable()\n     _realtimeBuilder.setTableName(\"RT_TABLE\");\n     addDummySchema(schemaName);\n     TableConfig diffConfig = _realtimeBuilder.build();\n-    sendPostRequest(_createTableUrl, diffConfig.toJSONConfigString());\n+    sendPostRequest(_createTableUrl, diffConfig.toJsonConfigString());\n \n     // Create a REALTIME table with a valid name and schema which should succeed\n     _realtimeBuilder.setTableName(REALTIME_TABLE_NAME);\n     _realtimeBuilder.setSchemaName(REALTIME_TABLE_NAME);\n     TableConfig config = _realtimeBuilder.build();\n-    String realtimeTableJSONConfigString = config.toJSONConfigString();\n+    String realtimeTableJSONConfigString = config.toJsonConfigString();\n     sendPostRequest(_createTableUrl, realtimeTableJSONConfigString);\n \n     // TODO: check whether we should allow POST request to create REALTIME table that already exists\n@@ -195,7 +195,7 @@ public void testTableMinReplication()\n   private void testTableMinReplicationInternal(String tableName, int tableReplication)\n       throws Exception {\n     String tableJSONConfigString =\n-        _offlineBuilder.setTableName(tableName).setNumReplicas(tableReplication).build().toJSONConfigString();\n+        _offlineBuilder.setTableName(tableName).setNumReplicas(tableReplication).build().toJsonConfigString();\n     sendPostRequest(_createTableUrl, tableJSONConfigString);\n     // table creation should succeed\n     TableConfig tableConfig = getTableConfig(tableName, \"OFFLINE\");\n@@ -204,7 +204,7 @@ private void testTableMinReplicationInternal(String tableName, int tableReplicat\n \n     addDummySchema(tableName);\n     tableJSONConfigString =\n-        _realtimeBuilder.setTableName(tableName).setNumReplicas(tableReplication).build().toJSONConfigString();\n+        _realtimeBuilder.setTableName(tableName).setNumReplicas(tableReplication).build().toJsonConfigString();\n     sendPostRequest(_createTableUrl, tableJSONConfigString);\n     tableConfig = getTableConfig(tableName, \"REALTIME\");\n     Assert.assertEquals(tableConfig.getValidationConfig().getReplicationNumber(),\n@@ -217,15 +217,15 @@ private void testTableMinReplicationInternal(String tableName, int tableReplicat\n   private TableConfig getTableConfig(String tableName, String tableType)\n       throws Exception {\n     String tableConfigString = sendGetRequest(_controllerRequestURLBuilder.forTableGet(tableName));\n-    return TableConfig.fromJSONConfig(JsonUtils.stringToJsonNode(tableConfigString).get(tableType));\n+    return TableConfig.fromJsonConfig(JsonUtils.stringToJsonNode(tableConfigString).get(tableType));\n   }\n \n   @Test\n   public void testUpdateTableConfig()\n       throws Exception {\n     String tableName = \"updateTC\";\n     String tableJSONConfigString =\n-        _offlineBuilder.setTableName(tableName).setNumReplicas(2).build().toJSONConfigString();\n+        _offlineBuilder.setTableName(tableName).setNumReplicas(2).build().toJsonConfigString();\n     sendPostRequest(_createTableUrl, tableJSONConfigString);\n     // table creation should succeed\n     TableConfig tableConfig = getTableConfig(tableName, \"OFFLINE\");\n@@ -236,7 +236,7 @@ public void testUpdateTableConfig()\n     tableConfig.getValidationConfig().setRetentionTimeValue(\"10\");\n \n     JsonNode jsonResponse = JsonUtils.stringToJsonNode(\n-        sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJSONConfigString()));\n+        sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJsonConfigString()));\n     Assert.assertTrue(jsonResponse.has(\"status\"));\n \n     TableConfig modifiedConfig = getTableConfig(tableName, \"OFFLINE\");\n@@ -245,7 +245,7 @@ public void testUpdateTableConfig()\n \n     // Realtime\n     addDummySchema(tableName);\n-    tableJSONConfigString = _realtimeBuilder.setTableName(tableName).setNumReplicas(2).build().toJSONConfigString();\n+    tableJSONConfigString = _realtimeBuilder.setTableName(tableName).setNumReplicas(2).build().toJsonConfigString();\n     sendPostRequest(_createTableUrl, tableJSONConfigString);\n     tableConfig = getTableConfig(tableName, \"REALTIME\");\n     Assert.assertEquals(tableConfig.getValidationConfig().getRetentionTimeValue(), \"5\");\n@@ -255,15 +255,15 @@ public void testUpdateTableConfig()\n     QuotaConfig quota = new QuotaConfig();\n     quota.setStorage(\"10G\");\n     tableConfig.setQuotaConfig(quota);\n-    sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJSONConfigString());\n+    sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJsonConfigString());\n     modifiedConfig = getTableConfig(tableName, \"REALTIME\");\n     Assert.assertNotNull(modifiedConfig.getQuotaConfig());\n     Assert.assertEquals(modifiedConfig.getQuotaConfig().getStorage(), \"10G\");\n     Assert.assertNull(modifiedConfig.getQuotaConfig().getMaxQueriesPerSecond());\n \n     quota.setMaxQueriesPerSecond(\"100.00\");\n     tableConfig.setQuotaConfig(quota);\n-    sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJSONConfigString());\n+    sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJsonConfigString());\n     modifiedConfig = getTableConfig(tableName, \"REALTIME\");\n     Assert.assertNotNull(modifiedConfig.getQuotaConfig().getMaxQueriesPerSecond());\n     Assert.assertEquals(modifiedConfig.getQuotaConfig().getMaxQueriesPerSecond(), \"100.00\");\n@@ -273,7 +273,7 @@ public void testUpdateTableConfig()\n       // table does not exist\n       tableConfig.setTableName(\"noSuchTable_REALTIME\");\n       sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(\"noSuchTable\"),\n-          tableConfig.toJSONConfigString());\n+          tableConfig.toJsonConfigString());\n     } catch (Exception e) {\n       Assert.assertTrue(e instanceof FileNotFoundException);\n       notFoundException = true;\n@@ -304,7 +304,7 @@ public void rebalanceOfflineTable() {\n     // create the table\n     try {\n       TableConfig offlineTableConfig = _offlineBuilder.build();\n-      sendPostRequest(_createTableUrl, offlineTableConfig.toJSONConfigString());\n+      sendPostRequest(_createTableUrl, offlineTableConfig.toJsonConfigString());\n     } catch (Exception e) {\n       Assert.fail(\"Failed to create offline table \" + tableName + \"Error: \" + e.getMessage());\n     }",
                "deletions": 17
            },
            {
                "sha": "645b195c22de8e61126eb06126baab5373cc5ed9",
                "filename": "pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTenantRestletResourceTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTenantRestletResourceTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTenantRestletResourceTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/org/apache/pinot/controller/api/resources/PinotTenantRestletResourceTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -93,7 +93,7 @@ public void testTableListForTenant()\n \n     TableConfig offlineTableConfig = _offlineBuilder.build();\n     offlineTableConfig.setTableName(\"mytable_OFFLINE\");\n-    String offlineTableJSONConfigString = offlineTableConfig.toJSONConfigString();\n+    String offlineTableJSONConfigString = offlineTableConfig.toJsonConfigString();\n     sendPostRequest(createTableUrl, offlineTableJSONConfigString);\n \n     // Try to make sure both kinds of tags work",
                "deletions": 1
            },
            {
                "sha": "25855a84d70d8af2ba569738c9d5f679723a8f64",
                "filename": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerInstanceToggleTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerInstanceToggleTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerInstanceToggleTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerInstanceToggleTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -59,7 +59,7 @@ public void testInstanceToggle()\n     // Create an offline table\n     String tableJSONConfigString =\n         new TableConfig.Builder(CommonConstants.Helix.TableType.OFFLINE).setTableName(RAW_TABLE_NAME)\n-            .setNumReplicas(NUM_INSTANCES).build().toJSONConfigString();\n+            .setNumReplicas(NUM_INSTANCES).build().toJsonConfigString();\n     sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), tableJSONConfigString);\n     Assert.assertEquals(\n         _helixAdmin.getResourceIdealState(_helixClusterName, CommonConstants.Helix.BROKER_RESOURCE_INSTANCE)",
                "deletions": 1
            },
            {
                "sha": "1411f147778bcdca9e7085d04e279aa2c5f2349f",
                "filename": "pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerSentinelTestV2.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerSentinelTestV2.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerSentinelTestV2.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/org/apache/pinot/controller/helix/ControllerSentinelTestV2.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -57,7 +57,7 @@ public void testOfflineTableLifeCycle()\n     String tableName = \"testTable\";\n     String tableJSONConfigString =\n         new TableConfig.Builder(CommonConstants.Helix.TableType.OFFLINE).setTableName(tableName).setNumReplicas(3)\n-            .build().toJSONConfigString();\n+            .build().toJsonConfigString();\n     sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), tableJSONConfigString);\n     Assert.assertEquals(\n         _helixAdmin.getResourceIdealState(_helixClusterName, CommonConstants.Helix.BROKER_RESOURCE_INSTANCE)",
                "deletions": 1
            },
            {
                "sha": "089ea6e0f87dc6e036c3ad5240467b48a287fd63",
                "filename": "pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/DefaultControllerRestApi.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/DefaultControllerRestApi.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/DefaultControllerRestApi.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/DefaultControllerRestApi.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -58,7 +58,7 @@ public TableConfig getTableConfig() {\n             .getRetrieveTableConfigHttpURI(pushLocation.getHost(), pushLocation.getPort(), _rawTableName));\n         JsonNode offlineJsonTableConfig = JsonUtils.stringToJsonNode(response.getResponse()).get(OFFLINE);\n         if (offlineJsonTableConfig != null) {\n-          TableConfig offlineTableConfig = TableConfig.fromJSONConfig(offlineJsonTableConfig);\n+          TableConfig offlineTableConfig = TableConfig.fromJsonConfig(offlineJsonTableConfig);\n           LOGGER.info(\"Got table config: {}\", offlineTableConfig);\n           return offlineTableConfig;\n         }",
                "deletions": 1
            },
            {
                "sha": "010be2473e09b12ea7db2569b3bc32f216610ebf",
                "filename": "pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/SegmentCreationJob.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/SegmentCreationJob.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/SegmentCreationJob.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-hadoop/src/main/java/org/apache/pinot/hadoop/job/SegmentCreationJob.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -157,7 +157,7 @@ public void run()\n     TableConfig tableConfig = getTableConfig();\n     if (tableConfig != null) {\n       validateTableConfig(tableConfig);\n-      jobConf.set(JobConfigConstants.TABLE_CONFIG, tableConfig.toJSONConfigString());\n+      jobConf.set(JobConfigConstants.TABLE_CONFIG, tableConfig.toJsonConfigString());\n     }\n     jobConf.set(JobConfigConstants.SCHEMA, getSchema().toSingleLineJsonString());\n ",
                "deletions": 1
            },
            {
                "sha": "9dd75c2df092f9a019350bdbf752846e7871e709",
                "filename": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ClusterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ClusterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ClusterTest.java",
                "status": "modified",
                "changes": 11,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/ClusterTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -302,7 +302,7 @@ protected void addOfflineTable(String tableName, String timeColumnName, String t\n             invertedIndexColumns, bloomFilterColumns, taskConfig);\n \n     if (!isUsingNewConfigFormat()) {\n-      sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), tableConfig.toJSONConfigString());\n+      sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), tableConfig.toJsonConfigString());\n     } else {\n       _offlineTableConfig = tableConfig;\n     }\n@@ -317,16 +317,15 @@ protected void updateOfflineTable(String tableName, String timeColumnName, Strin\n             invertedIndexColumns, bloomFilterColumns, taskConfig);\n \n     if (!isUsingNewConfigFormat()) {\n-      sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJSONConfigString());\n+      sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tableName), tableConfig.toJsonConfigString());\n     } else {\n       _offlineTableConfig = tableConfig;\n     }\n   }\n \n   private static TableConfig getOfflineTableConfig(String tableName, String timeColumnName, String timeType,\n       String brokerTenant, String serverTenant, String loadMode, SegmentVersion segmentVersion,\n-      List<String> invertedIndexColumns, List<String> bloomFilterColumns, TableTaskConfig taskConfig)\n-      throws Exception {\n+      List<String> invertedIndexColumns, List<String> bloomFilterColumns, TableTaskConfig taskConfig) {\n     return new TableConfig.Builder(Helix.TableType.OFFLINE).setTableName(tableName).setTimeColumnName(timeColumnName)\n         .setTimeType(timeType).setNumReplicas(3).setBrokerTenant(brokerTenant).setServerTenant(serverTenant)\n         .setLoadMode(loadMode).setSegmentVersion(segmentVersion.toString())\n@@ -430,7 +429,7 @@ protected void addRealtimeTable(String tableName, boolean useLlc, String kafkaBr\n     _realtimeTableConfig = tableConfig;\n \n     if (!isUsingNewConfigFormat()) {\n-      sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), tableConfig.toJSONConfigString());\n+      sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), tableConfig.toJsonConfigString());\n     }\n   }\n \n@@ -443,7 +442,7 @@ protected void updateRealtimeTableConfig(String tablename, List<String> inverted\n     config.setBloomFilterColumns(bloomFilterCols);\n \n     sendPutRequest(_controllerRequestURLBuilder.forUpdateTableConfig(tablename),\n-        _realtimeTableConfig.toJSONConfigString());\n+        _realtimeTableConfig.toJsonConfigString());\n   }\n \n   protected void dropRealtimeTable(String tableName)",
                "deletions": 6
            },
            {
                "sha": "172b2fa8396b2f04f59a15d2a006870f940f1a63",
                "filename": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java",
                "status": "modified",
                "changes": 18,
                "additions": 18,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -19,6 +19,7 @@\n package org.apache.pinot.integration.tests;\n \n import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n import com.google.common.base.Function;\n import com.google.common.collect.ImmutableList;\n import java.io.File;\n@@ -33,6 +34,7 @@\n import java.util.concurrent.TimeUnit;\n import javax.annotation.Nullable;\n import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.common.config.TableConfig;\n import org.apache.pinot.common.utils.CommonConstants;\n import org.apache.pinot.common.utils.JsonUtils;\n import org.apache.pinot.common.utils.ServiceStatus;\n@@ -150,6 +152,22 @@ public void testInstancesStarted() {\n     }\n   }\n \n+  @Test\n+  public void testInvalidTableConfig() {\n+    TableConfig tableConfig =\n+        new TableConfig.Builder(CommonConstants.Helix.TableType.OFFLINE).setTableName(\"badTable\").build();\n+    ObjectNode jsonConfig = tableConfig.toJsonConfig();\n+    // Remove a mandatory field\n+    jsonConfig.remove(TableConfig.VALIDATION_CONFIG_KEY);\n+    try {\n+      sendPostRequest(_controllerRequestURLBuilder.forTableCreate(), jsonConfig.toString());\n+      fail();\n+    } catch (IOException e) {\n+      // Should get response code 400 (BAD_REQUEST)\n+      assertTrue(e.getMessage().startsWith(\"Server returned HTTP response code: 400\"));\n+    }\n+  }\n+\n   @Test\n   public void testInvertedIndexTriggering()\n       throws Exception {",
                "deletions": 0
            },
            {
                "sha": "18dedc42604aad41ed6e06744745618847e7e085",
                "filename": "pinot-tools/src/main/java/org/apache/pinot/tools/query/comparison/ClusterStarter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-tools/src/main/java/org/apache/pinot/tools/query/comparison/ClusterStarter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/eccf573a636de84e60c85cc331fea0afc172c90c/pinot-tools/src/main/java/org/apache/pinot/tools/query/comparison/ClusterStarter.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-tools/src/main/java/org/apache/pinot/tools/query/comparison/ClusterStarter.java?ref=eccf573a636de84e60c85cc331fea0afc172c90c",
                "patch": "@@ -206,7 +206,7 @@ private void addTable()\n     String tableJSONConfigString =\n         new TableConfig.Builder(CommonConstants.Helix.TableType.OFFLINE).setTableName(_tableName)\n             .setTimeColumnName(_timeColumnName).setTimeType(_timeUnit).setNumReplicas(3).setBrokerTenant(\"broker\")\n-            .setServerTenant(\"server\").build().toJSONConfigString();\n+            .setServerTenant(\"server\").build().toJsonConfigString();\n     sendPostRequest(ControllerRequestURLBuilder.baseUrl(controllerAddress).forTableCreate(), tableJSONConfigString);\n   }\n ",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[TE] datasource - eliminate potential tracking NPE (#2809)",
        "commit": "https://github.com/apache/incubator-pinot/commit/404be05f3b9e12e4d0f5e46a9390aa36099d00d1",
        "parent": "https://github.com/apache/incubator-pinot/commit/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64",
        "bug_id": "incubator-pinot_13",
        "file": [
            {
                "sha": "22d6a15a4d8064371b5faa50b877c879800cf48d",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/tracking/RequestStatisticsFormatter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/404be05f3b9e12e4d0f5e46a9390aa36099d00d1/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/tracking/RequestStatisticsFormatter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/404be05f3b9e12e4d0f5e46a9390aa36099d00d1/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/tracking/RequestStatisticsFormatter.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/tracking/RequestStatisticsFormatter.java?ref=404be05f3b9e12e4d0f5e46a9390aa36099d00d1",
                "patch": "@@ -6,6 +6,7 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Objects;\n \n \n public class RequestStatisticsFormatter {\n@@ -80,7 +81,7 @@ public String format(RequestStatistics stats) {\n   private <K, V> String format(Map<K, V> map, Comparator<Map.Entry<K, V>> comparator, String format) {\n     StringBuilder builder = new StringBuilder();\n     for (Map.Entry<K, V> entry : topk(map, comparator)) {\n-      String key = entry.getKey().toString();\n+      String key = Objects.toString(entry.getKey());\n       if (key.length() > MAX_KEY_LEN) {\n         key = key.substring(0, MAX_KEY_LEN - 3) + \"...\";\n       }",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE when rebalance is called with a table that does not exist (#2969)",
        "commit": "https://github.com/apache/incubator-pinot/commit/1bf0f913568c4e3f08546ea55934139340735f2b",
        "parent": "https://github.com/apache/incubator-pinot/commit/80ddaf48cd61e8d9fa3e558eedf829f60aa23bb9",
        "bug_id": "incubator-pinot_14",
        "file": [
            {
                "sha": "e5d7dd704fc874347261b8998f18ba8864d43599",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1bf0f913568c4e3f08546ea55934139340735f2b/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1bf0f913568c4e3f08546ea55934139340735f2b/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResource.java",
                "status": "modified",
                "changes": 12,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResource.java?ref=1bf0f913568c4e3f08546ea55934139340735f2b",
                "patch": "@@ -23,6 +23,7 @@\n import com.linkedin.pinot.common.metrics.ControllerMeter;\n import com.linkedin.pinot.common.metrics.ControllerMetrics;\n import com.linkedin.pinot.common.utils.CommonConstants;\n+import com.linkedin.pinot.common.utils.CommonConstants.Helix.TableType;\n import com.linkedin.pinot.controller.ControllerConf;\n import com.linkedin.pinot.controller.helix.core.PinotHelixResourceManager;\n import com.linkedin.pinot.controller.helix.core.PinotResourceManagerResponse;\n@@ -413,10 +414,17 @@ public String rebalance(\n     rebalanceUserConfig.addProperty(RebalanceUserConfigConstants.DRYRUN, dryRun);\n     rebalanceUserConfig.addProperty(RebalanceUserConfigConstants.INCLUDE_CONSUMING, includeConsuming);\n \n+    TableType type = TableType.valueOf(tableType.toUpperCase());\n+    if (type == TableType.OFFLINE && (!_pinotHelixResourceManager.hasOfflineTable(tableName))\n+        || type == TableType.REALTIME && (!_pinotHelixResourceManager\n+        .hasRealtimeTable(tableName))) {\n+      throw new ControllerApplicationException(LOGGER, \"Table \" + tableName + \" does not exist\",\n+          Response.Status.NOT_FOUND);\n+    }\n+\n     JSONObject jsonObject;\n     try {\n-      jsonObject = _pinotHelixResourceManager.rebalanceTable(tableName,\n-          CommonConstants.Helix.TableType.valueOf(tableType.toUpperCase()), rebalanceUserConfig);\n+      jsonObject = _pinotHelixResourceManager.rebalanceTable(tableName, type, rebalanceUserConfig);\n     } catch (JSONException e) {\n       throw new ControllerApplicationException(LOGGER, e.getMessage(), Response.Status.INTERNAL_SERVER_ERROR);\n     } catch (InvalidConfigException e) {",
                "deletions": 2
            },
            {
                "sha": "bccc21ad2daeb56cfb2e7014164bbe4bb3d6aa4b",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/ControllerRequestURLBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1bf0f913568c4e3f08546ea55934139340735f2b/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/ControllerRequestURLBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1bf0f913568c4e3f08546ea55934139340735f2b/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/ControllerRequestURLBuilder.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/ControllerRequestURLBuilder.java?ref=1bf0f913568c4e3f08546ea55934139340735f2b",
                "patch": "@@ -135,6 +135,11 @@ public String forUpdateTableConfig(String tableName) {\n     return StringUtil.join(\"/\", StringUtils.chomp(_baseUrl, \"/\"), \"tables\", tableName);\n   }\n \n+  public String forTableRebalance(String tableName, String tableType) {\n+    String query = \"rebalance?dryrun=false&type=\" + tableType;\n+    return StringUtil.join(\"/\", StringUtils.chomp(_baseUrl, \"/\"), \"tables\", tableName, query);\n+  }\n+\n   public String forTableUpdateIndexingConfigs(String tableName) {\n     return StringUtil.join(\"/\", StringUtils.chomp(_baseUrl, \"/\"), \"tables\", tableName, \"indexingConfigs\");\n   }",
                "deletions": 0
            },
            {
                "sha": "7ef3eb87ec97a80dbac476ab282eb0e56ccce926",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResourceTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1bf0f913568c4e3f08546ea55934139340735f2b/pinot-controller/src/test/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResourceTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1bf0f913568c4e3f08546ea55934139340735f2b/pinot-controller/src/test/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResourceTest.java",
                "status": "modified",
                "changes": 47,
                "additions": 47,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/api/resources/PinotTableRestletResourceTest.java?ref=1bf0f913568c4e3f08546ea55934139340735f2b",
                "patch": "@@ -28,6 +28,7 @@\n import java.io.IOException;\n import java.util.HashMap;\n import java.util.Map;\n+import org.json.JSONException;\n import org.json.JSONObject;\n import org.testng.Assert;\n import org.testng.annotations.AfterClass;\n@@ -266,6 +267,52 @@ public void testUpdateTableConfig() throws Exception {\n     Assert.assertTrue(notFoundException);\n   }\n \n+  @Test(expectedExceptions = FileNotFoundException.class)\n+  public void rebalanceNonExistentOfflineTable() throws IOException, JSONException {\n+    String tableName = \"nonExistentTable\";\n+    // should result in file not found exception\n+    sendPostRequest(_controllerRequestURLBuilder.forTableRebalance(tableName, \"offline\"), null);\n+  }\n+\n+  @Test(expectedExceptions = FileNotFoundException.class)\n+  public void rebalanceNonExistentRealtimeTable() throws IOException, JSONException {\n+    String tableName = \"nonExistentTable\";\n+    // should result in file not found exception\n+    sendPostRequest(_controllerRequestURLBuilder.forTableRebalance(tableName, \"realtime\"), null);\n+  }\n+\n+  @Test\n+  public void rebalanceOfflineTable() {\n+    String tableName = \"testOfflineTable\";\n+    _offlineBuilder.setTableName(tableName);\n+    // create the table\n+    try {\n+      TableConfig offlineTableConfig = _offlineBuilder.build();\n+      sendPostRequest(_createTableUrl, offlineTableConfig.toJSONConfigString());\n+    } catch (Exception e) {\n+      Assert.fail(\"Failed to create offline table \" + tableName + \"Error: \" + e.getMessage());\n+    }\n+\n+    // rebalance should not throw exception\n+    try {\n+      sendPostRequest(_controllerRequestURLBuilder.forTableRebalance(tableName, \"offline\"), null);\n+    } catch (Exception e) {\n+      Assert.fail(\"Failed to rebalance existing offline table \" + tableName);\n+    }\n+\n+    // rebalance should throw exception because realtime table does not exist\n+    try {\n+      sendPostRequest(_controllerRequestURLBuilder.forTableRebalance(tableName, \"realtime\"), null);\n+    } catch (Exception e) {\n+      if (!(e instanceof FileNotFoundException)) {\n+        Assert.fail(\"Did not fail to create non existent realtime table \" + tableName);\n+      } else {\n+        return;\n+      }\n+    }\n+    Assert.fail(\"Did not fail to create non existent realtime table \" + tableName);\n+  }\n+\n   @AfterClass\n   public void tearDown() {\n     stopController();",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix the NPE in MetricFieldSpec.setFieldSize() (#2493)",
        "commit": "https://github.com/apache/incubator-pinot/commit/2f0e00392a9f52ffb1a6fdf263e826e699daf38c",
        "parent": "https://github.com/apache/incubator-pinot/commit/f617059b1d1a99733f7264dd8ca885879eb21bd3",
        "bug_id": "incubator-pinot_15",
        "file": [
            {
                "sha": "91be6d07674abc1a9070a6f97741d067d2fa4c3b",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/data/FieldSpec.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/2f0e00392a9f52ffb1a6fdf263e826e699daf38c/pinot-common/src/main/java/com/linkedin/pinot/common/data/FieldSpec.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/2f0e00392a9f52ffb1a6fdf263e826e699daf38c/pinot-common/src/main/java/com/linkedin/pinot/common/data/FieldSpec.java",
                "status": "modified",
                "changes": 3,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/data/FieldSpec.java?ref=2f0e00392a9f52ffb1a6fdf263e826e699daf38c",
                "patch": "@@ -21,7 +21,6 @@\n import com.linkedin.pinot.common.utils.DataSchema;\n import com.linkedin.pinot.common.utils.EqualityUtils;\n import javax.annotation.Nonnull;\n-import javax.annotation.Nullable;\n import org.apache.avro.Schema.Type;\n \n \n@@ -123,7 +122,7 @@ public void setDefaultNullValue(@Nonnull Object defaultNullValue) {\n   }\n \n   private static Object getDefaultNullValue(@Nonnull FieldType fieldType, @Nonnull DataType dataType,\n-      @Nullable String stringDefaultNullValue) {\n+      String stringDefaultNullValue) {\n     if (stringDefaultNullValue != null) {\n       switch (dataType) {\n         case INT:",
                "deletions": 2
            },
            {
                "sha": "5d13fe1c410b2e483ef954276c7f15440c79f29b",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/data/MetricFieldSpec.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/2f0e00392a9f52ffb1a6fdf263e826e699daf38c/pinot-common/src/main/java/com/linkedin/pinot/common/data/MetricFieldSpec.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/2f0e00392a9f52ffb1a6fdf263e826e699daf38c/pinot-common/src/main/java/com/linkedin/pinot/common/data/MetricFieldSpec.java",
                "status": "modified",
                "changes": 6,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/data/MetricFieldSpec.java?ref=2f0e00392a9f52ffb1a6fdf263e826e699daf38c",
                "patch": "@@ -19,7 +19,6 @@\n import com.google.gson.JsonObject;\n import com.linkedin.pinot.common.utils.EqualityUtils;\n import javax.annotation.Nonnull;\n-import javax.annotation.Nullable;\n import org.codehaus.jackson.annotate.JsonIgnore;\n import org.codehaus.jackson.annotate.JsonIgnoreProperties;\n \n@@ -78,20 +77,19 @@ public int getFieldSize() {\n   // Required by JSON de-serializer. DO NOT REMOVE.\n   public void setFieldSize(int fieldSize) {\n     Preconditions.checkArgument(fieldSize > 0, \"Field size: \" + fieldSize + \" is not a positive number.\");\n-    if (_dataType != DataType.STRING) {\n+    if (_dataType != null && _dataType != DataType.STRING) {\n       Preconditions.checkArgument(fieldSize == _dataType.size(),\n           \"Field size: \" + fieldSize + \" does not match data type: \" + _dataType);\n     }\n     _fieldSize = fieldSize;\n   }\n \n-  @Nullable\n   public DerivedMetricType getDerivedMetricType() {\n     return _derivedMetricType;\n   }\n \n   // Required by JSON de-serializer. DO NOT REMOVE.\n-  public void setDerivedMetricType(@Nullable DerivedMetricType derivedMetricType) {\n+  public void setDerivedMetricType(DerivedMetricType derivedMetricType) {\n     _derivedMetricType = derivedMetricType;\n   }\n ",
                "deletions": 4
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE in Segment Upload (#2294)",
        "commit": "https://github.com/apache/incubator-pinot/commit/ee3ffa80adf5fb4cdde36527a53aad8a4f404c1f",
        "parent": "https://github.com/apache/incubator-pinot/commit/9f28a99ae630b125d1eb8935ba4263b82fb1ee48",
        "bug_id": "incubator-pinot_16",
        "file": [
            {
                "sha": "4d4bfcf55df0922003acaf74cf61b67603d479e2",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotSegmentUploadRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ee3ffa80adf5fb4cdde36527a53aad8a4f404c1f/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotSegmentUploadRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ee3ffa80adf5fb4cdde36527a53aad8a4f404c1f/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotSegmentUploadRestletResource.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotSegmentUploadRestletResource.java?ref=ee3ffa80adf5fb4cdde36527a53aad8a4f404c1f",
                "patch": "@@ -433,7 +433,7 @@ private PinotResourceManagerResponse uploadSegment(File indexDir, SegmentMetadat\n     long minionExpectedCrc = -1L;\n     boolean isMinionConfigured = offlineTableConfig.getTaskConfig() != null;\n     String userAgentHeader = headers.getHeaderString(HttpHeaders.USER_AGENT);\n-    boolean minionHeaderPresent = userAgentHeader.contains(CommonConstants.Minion.MINION_HEADER_PREFIX);\n+    boolean minionHeaderPresent = userAgentHeader != null && userAgentHeader.contains(CommonConstants.Minion.HTTP_TASK_TYPE_HEADER_PREFIX);\n     boolean metadataRewritten = false;\n \n     if (isMinionConfigured) {",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed NPE bug for PartitionAwareOfflineRoutingTableBuilder (#2806)\n\nPartitionAwareOfflineRoutingTableBuilder was caching the number of replicas\r\nfrom the table config during the initialization and never updates the value\r\neven if there was a change. This caused NPE when the broker attempts to compute\r\nrouting table after servers were added to table and rebalance was invoked.\r\nThis PR addresses this bug and also added the unit test to make sure the fix\r\nresolves the issue.",
        "commit": "https://github.com/apache/incubator-pinot/commit/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64",
        "parent": "https://github.com/apache/incubator-pinot/commit/7570d00089c76fc69372bd5b7b2dfa1d8318d60c",
        "bug_id": "incubator-pinot_17",
        "file": [
            {
                "sha": "35fa19ed15e17f7ff85d3c6da6d9a3fd18852f6c",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/BasePartitionAwareRoutingTableBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/BasePartitionAwareRoutingTableBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/BasePartitionAwareRoutingTableBuilder.java",
                "status": "modified",
                "changes": 4,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/BasePartitionAwareRoutingTableBuilder.java?ref=4f7a970d6d4b66924f08239c47e2fc6fafcc2f64",
                "patch": "@@ -61,17 +61,15 @@\n \n   protected ZkHelixPropertyStore<ZNRecord> _propertyStore;\n   protected SegmentZKMetadataPrunerService _pruner;\n-  protected TableConfig _tableConfig;\n   protected Random _random = new Random();\n-  protected int _numReplicas;\n+  protected volatile int _numReplicas;\n \n   protected void setSegmentToReplicaToServerMap(Map<String, Map<Integer, String>> segmentToReplicaToServerMap) {\n     _segmentToReplicaToServerMap = segmentToReplicaToServerMap;\n   }\n \n   @Override\n   public void init(Configuration configuration, TableConfig tableConfig, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n-    _tableConfig = tableConfig;\n     _propertyStore = propertyStore;\n \n     // TODO: We need to specify the type of pruners via config instead of hardcoding.",
                "deletions": 3
            },
            {
                "sha": "18d5a496108cb3b199fb2db80d69ae64df50da42",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilder.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilder.java?ref=4f7a970d6d4b66924f08239c47e2fc6fafcc2f64",
                "patch": "@@ -89,6 +89,12 @@ public synchronized void computeRoutingTableFromExternalView(String tableName, E\n     ReplicaGroupPartitionAssignment partitionAssignment =\n         partitionAssignmentGenerator.getReplicaGroupPartitionAssignment(tableName);\n \n+    // Update numReplicas if the replica group partition assignment has been changed.\n+    int numReplicas = partitionAssignment.getNumReplicaGroups();\n+    if (_numReplicas != numReplicas) {\n+      _numReplicas = numReplicas;\n+    }\n+\n     // 1. Compute the partition id set by looking at the segment zk metadata and cache metadata when possible\n     Set<Integer> partitionIds = new HashSet<>();\n     for (String segmentName : segmentSet) {",
                "deletions": 0
            },
            {
                "sha": "bd5744c7c1475274507c126a9b86b4271dd36d44",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareRealtimeRoutingTableBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareRealtimeRoutingTableBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareRealtimeRoutingTableBuilder.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareRealtimeRoutingTableBuilder.java?ref=4f7a970d6d4b66924f08239c47e2fc6fafcc2f64",
                "patch": "@@ -48,7 +48,7 @@\n   @Override\n   public void init(Configuration configuration, TableConfig tableConfig, ZkHelixPropertyStore<ZNRecord> propertyStore) {\n     super.init(configuration, tableConfig, propertyStore);\n-    _numReplicas = Integer.valueOf(_tableConfig.getValidationConfig().getReplicasPerPartition());\n+    _numReplicas = Integer.valueOf(tableConfig.getValidationConfig().getReplicasPerPartition());\n   }\n \n   @Override",
                "deletions": 1
            },
            {
                "sha": "810aa998321422710f5011a38057e34e0d2b6a89",
                "filename": "pinot-broker/src/test/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilderTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/test/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilderTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4f7a970d6d4b66924f08239c47e2fc6fafcc2f64/pinot-broker/src/test/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilderTest.java",
                "status": "modified",
                "changes": 82,
                "additions": 78,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/test/java/com/linkedin/pinot/broker/routing/builder/PartitionAwareOfflineRoutingTableBuilderTest.java?ref=4f7a970d6d4b66924f08239c47e2fc6fafcc2f64",
                "patch": "@@ -94,14 +94,14 @@ public void testBrokerSideServerAndSegmentPruning() throws Exception {\n       }\n \n       // Update replica group mapping zk metadata\n-      updatePartitionMappingZkMetadata(OFFLINE_TABLE_NAME, fakePropertyStore);\n+      updatgeReplicaGroupPartitionAssignment(OFFLINE_TABLE_NAME, fakePropertyStore);\n \n       // Create the fake external view\n       ExternalView externalView = buildExternalView(OFFLINE_TABLE_NAME, replicaToServerMapping);\n \n       // Create instance Configs\n       List<InstanceConfig> instanceConfigs = new ArrayList<>();\n-      for (int serverId = 0; serverId <= NUM_SERVERS; serverId++) {\n+      for (int serverId = 0; serverId < NUM_SERVERS; serverId++) {\n         String serverName = \"Server_localhost_\" + serverId;\n         instanceConfigs.add(new InstanceConfig(serverName));\n       }\n@@ -151,12 +151,86 @@ public void testBrokerSideServerAndSegmentPruning() throws Exception {\n     }\n   }\n \n-  private void updatePartitionMappingZkMetadata(String tableNameWithType, FakePropertyStore propertyStore) {\n+  @Test\n+  public void testRoutingTableAfterRebalance() throws Exception {\n+    NUM_REPLICA = 1;\n+    NUM_PARTITION = 1;\n+    NUM_SERVERS = 1;\n+    NUM_SEGMENTS = 10;\n+\n+    // Create the fake property store\n+    FakePropertyStore fakePropertyStore = new FakePropertyStore();\n+\n+    // Create the table config, partition mapping,\n+    TableConfig tableConfig = buildOfflineTableConfig();\n+\n+    // Create the replica group id to server mapping\n+    Map<Integer, List<String>> replicaToServerMapping = buildReplicaGroupMapping();\n+\n+    // Update segment zk metadata.\n+    for (int i = 0; i < NUM_SEGMENTS; i++) {\n+      String segmentName = \"segment\" + i;\n+      int partition = i % NUM_PARTITION;\n+      SegmentZKMetadata metadata = buildOfflineSegmentZKMetadata(segmentName, partition);\n+      fakePropertyStore.setContents(\n+          ZKMetadataProvider.constructPropertyStorePathForSegment(OFFLINE_TABLE_NAME, segmentName),\n+          metadata.toZNRecord());\n+    }\n+\n+    // Update replica group mapping zk metadata\n+    updatgeReplicaGroupPartitionAssignment(OFFLINE_TABLE_NAME, fakePropertyStore);\n+\n+    // Create the fake external view\n+    ExternalView externalView = buildExternalView(OFFLINE_TABLE_NAME, replicaToServerMapping);\n+\n+    // Create instance Configs\n+    List<InstanceConfig> instanceConfigs = new ArrayList<>();\n+    for (int serverId = 0; serverId < NUM_SERVERS; serverId++) {\n+      String serverName = \"Server_localhost_\" + serverId;\n+      instanceConfigs.add(new InstanceConfig(serverName));\n+    }\n+\n+    // Create the partition aware offline routing table builder.\n+    RoutingTableBuilder routingTableBuilder =\n+        buildPartitionAwareOfflineRoutingTableBuilder(fakePropertyStore, tableConfig, externalView, instanceConfigs);\n+\n+    // Simulate the case where we add 1 more server/replica\n+    NUM_REPLICA = 2;\n+    NUM_SERVERS = 2;\n+\n+    // Update instance configs\n+    String newServerName = \"Server_localhost_\" + (NUM_SERVERS - 1);\n+    instanceConfigs.add(new InstanceConfig(newServerName));\n+\n+    // Update replica group partition assignment\n+    updatgeReplicaGroupPartitionAssignment(OFFLINE_TABLE_NAME, fakePropertyStore);\n+\n+    // Update external view\n+    Map<Integer, List<String>> newReplicaToServerMapping = buildReplicaGroupMapping();\n+    ExternalView newExternalView = buildExternalView(OFFLINE_TABLE_NAME, newReplicaToServerMapping);\n+\n+    // Compute routing table and this should not throw null pointer exception\n+    routingTableBuilder.computeRoutingTableFromExternalView(OFFLINE_TABLE_NAME, newExternalView, instanceConfigs);\n+\n+    Set<String> servers = new HashSet<>();\n+    for (int i = 0; i < 100; i++) {\n+      String countStarQuery = \"select count(*) from myTable\";\n+      Map<String, List<String>> routingTable =\n+          routingTableBuilder.getRoutingTable(buildRoutingTableLookupRequest(countStarQuery));\n+      Assert.assertEquals(routingTable.keySet().size(), 1);\n+      servers.add(routingTable.keySet().iterator().next());\n+    }\n+\n+    // Check if both servers are get picked\n+    Assert.assertEquals(servers.size(), 2);\n+  }\n+\n+  private void updatgeReplicaGroupPartitionAssignment(String tableNameWithType, FakePropertyStore propertyStore) {\n     // Create partition assignment mapping table.\n     ReplicaGroupPartitionAssignment replicaGroupPartitionAssignment = new ReplicaGroupPartitionAssignment(tableNameWithType);\n \n     int partitionId = 0;\n-    for (int serverId = 0; serverId <= NUM_SERVERS; serverId++) {\n+    for (int serverId = 0; serverId < NUM_SERVERS; serverId++) {\n       String serverName = \"Server_localhost_\" + serverId;\n       int replicaGroupId = serverId / (NUM_SERVERS / NUM_REPLICA);\n       replicaGroupPartitionAssignment.addInstanceToReplicaGroup(partitionId, replicaGroupId, serverName);",
                "deletions": 4
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix service status NPE (#1006)\n\nFix the service status API throwing NPE if there are zero replicas for\na segment.",
        "commit": "https://github.com/apache/incubator-pinot/commit/f46273747d5aedc0a10aefbcb7b0a0078516695e",
        "parent": "https://github.com/apache/incubator-pinot/commit/a79a8c3280e517746213a77348b807ca4025710e",
        "bug_id": "incubator-pinot_18",
        "file": [
            {
                "sha": "aaf7348c93304ed5fa4475398cfd3a624520149d",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/ServiceStatus.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f46273747d5aedc0a10aefbcb7b0a0078516695e/pinot-common/src/main/java/com/linkedin/pinot/common/utils/ServiceStatus.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f46273747d5aedc0a10aefbcb7b0a0078516695e/pinot-common/src/main/java/com/linkedin/pinot/common/utils/ServiceStatus.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/ServiceStatus.java?ref=f46273747d5aedc0a10aefbcb7b0a0078516695e",
                "patch": "@@ -122,6 +122,11 @@ public Status getServiceStatus() {\n         }\n \n         for (String partition : idealState.getPartitionSet()) {\n+          // If this partition is not in the external view, then it hasn't finished starting up\n+          if (!externalView.getPartitionSet().contains(partition)) {\n+            return Status.STARTING;\n+          }\n+\n           String idealStateStatus = idealState.getInstanceStateMap(partition).get(_instanceName);\n           String externalViewStatus = externalView.getStateMap(partition).get(_instanceName);\n ",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE from getTableSchema (#1284)\n\nWhen table does not exist, it will throw NPE.\r\nFor OFFLINE table, schema name should be the same as table name.",
        "commit": "https://github.com/apache/incubator-pinot/commit/c53fbd219fe48bd8ddc98a2b54ba1056386a90d9",
        "parent": "https://github.com/apache/incubator-pinot/commit/bd85e25513213c19d93fbe77fed6558250356b2a",
        "bug_id": "incubator-pinot_19",
        "file": [
            {
                "sha": "2ec8fe42201a1b44f7c863145faffac1ff0d6790",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c53fbd219fe48bd8ddc98a2b54ba1056386a90d9/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c53fbd219fe48bd8ddc98a2b54ba1056386a90d9/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java",
                "status": "modified",
                "changes": 45,
                "additions": 25,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java?ref=c53fbd219fe48bd8ddc98a2b54ba1056386a90d9",
                "patch": "@@ -1,5 +1,7 @@\n package com.linkedin.pinot.controller.api.restlet.resources;\n \n+import com.google.common.base.Preconditions;\n+import com.linkedin.pinot.common.config.TableNameBuilder;\n import java.io.File;\n import java.io.IOException;\n import org.apache.commons.io.FileUtils;\n@@ -55,41 +57,44 @@ public Representation get() {\n       \"/tables/{tableName}/schema/\"\n   })\n   private Representation getTableSchema(\n-      @Parameter(name = \"tableName\", in = \"path\", description = \"Table name for which to get the schema\", required = true)\n-      String tableName) {\n+      @Parameter(name = \"tableName\", in = \"path\", description = \"Table name for which to get the schema\",\n+          required = true) String tableName) {\n     if (_pinotHelixResourceManager.hasRealtimeTable(tableName)) {\n       try {\n         AbstractTableConfig config = _pinotHelixResourceManager.getTableConfig(tableName, TableType.REALTIME);\n-        return new StringRepresentation(_pinotHelixResourceManager.getSchema(config.getValidationConfig().getSchemaName()).getJSONSchema()\n-            .toString());\n+        String schemaName = config.getValidationConfig().getSchemaName();\n+        Schema schema = _pinotHelixResourceManager.getSchema(schemaName);\n+        Preconditions.checkNotNull(schema, \"Failed to fetch schema: %s for REALTIME table: %s\", schemaName, tableName);\n+        return new StringRepresentation(schema.getJSONSchema());\n       } catch (Exception e) {\n-        LOGGER.error(\"Caught exception while fetching schema for a realtime table : {} \", tableName, e);\n-        ControllerRestApplication.getControllerMetrics().addMeteredGlobalValue(ControllerMeter.CONTROLLER_TABLE_SCHEMA_GET_ERROR, 1L);\n+        LOGGER.error(\"Caught exception while fetching schema for REALTIME table: {} \", tableName, e);\n+        ControllerRestApplication.getControllerMetrics()\n+            .addMeteredGlobalValue(ControllerMeter.CONTROLLER_TABLE_SCHEMA_GET_ERROR, 1L);\n         setStatus(Status.SERVER_ERROR_INTERNAL);\n         return PinotSegmentUploadRestletResource.exceptionToStringRepresentation(e);\n       }\n-    } else {\n-      AbstractTableConfig config;\n+    }\n+\n+    if (_pinotHelixResourceManager.hasOfflineTable(tableName)) {\n+      // For OFFLINE table, schema name is the same as table name\n+      String schemaName = TableNameBuilder.OFFLINE_TABLE_NAME_BUILDER.forTable(tableName);\n       try {\n-        config = _pinotHelixResourceManager.getTableConfig(tableName, TableType.OFFLINE);\n-        String schemaName = config.getValidationConfig().getSchemaName();\n-        Schema schema = null;\n-        if (schemaName != null && !schemaName.isEmpty()) {\n-          schema = _pinotHelixResourceManager.getSchema(schemaName);\n-        }\n+        Schema schema = _pinotHelixResourceManager.getSchema(schemaName);\n         if (schema == null) {\n           setStatus(Status.CLIENT_ERROR_NOT_FOUND);\n-          StringRepresentation repr = new StringRepresentation(\"{\\\"error\\\": \\\"Schema \" + schemaName + \" not found\\\"\");\n-          repr.setMediaType(MediaType.APPLICATION_JSON);\n-          return repr;\n+          return new StringRepresentation(\"Error: schema \" + schemaName + \" not found\");\n         }\n-        return new StringRepresentation(schema.getJSONSchema().toString());\n+        return new StringRepresentation(schema.getJSONSchema());\n       } catch (Exception e) {\n-        LOGGER.error(\"Caught exception while fetching schema for a offline table : {} \", tableName, e);\n-        ControllerRestApplication.getControllerMetrics().addMeteredGlobalValue(ControllerMeter.CONTROLLER_TABLE_SCHEMA_GET_ERROR, 1L);\n+        LOGGER.error(\"Caught exception while fetching schema for OFFLINE table :{} \", tableName, e);\n+        ControllerRestApplication.getControllerMetrics()\n+            .addMeteredGlobalValue(ControllerMeter.CONTROLLER_TABLE_SCHEMA_GET_ERROR, 1L);\n         setStatus(Status.SERVER_ERROR_INTERNAL);\n         return PinotSegmentUploadRestletResource.exceptionToStringRepresentation(e);\n       }\n     }\n+\n+    setStatus(Status.CLIENT_ERROR_NOT_FOUND);\n+    return new StringRepresentation(\"Error: table \" + tableName + \" not found\");\n   }\n }",
                "deletions": 20
            },
            {
                "sha": "68dc728d6429a2a84f02c23e7bef578555fe8dd6",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c53fbd219fe48bd8ddc98a2b54ba1056386a90d9/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c53fbd219fe48bd8ddc98a2b54ba1056386a90d9/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 13,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=c53fbd219fe48bd8ddc98a2b54ba1056386a90d9",
                "patch": "@@ -936,15 +936,10 @@ public boolean deleteSchema(Schema schema) {\n     }\n     return false;\n   }\n-  /**\n-   *\n-   * @param schemaName\n-   * @return\n-   * @throws JsonParseException\n-   * @throws JsonMappingException\n-   * @throws IOException\n-   */\n-  public @Nullable Schema getSchema(String schemaName) throws JsonParseException, JsonMappingException, IOException {\n+\n+  @Nullable\n+  public Schema getSchema(String schemaName)\n+      throws IOException {\n     PinotHelixPropertyStoreZnRecordProvider propertyStoreHelper =\n         PinotHelixPropertyStoreZnRecordProvider.forSchema(_propertyStore);\n     ZNRecord record = propertyStoreHelper.get(schemaName);",
                "deletions": 9
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE when accessing broker's routing table debug endpoint. (#1669)\n\nThe broker endpoint at /debug/routingTable throws NPE if table name is\r\nnot specified. Fixed it to return all routing tables in that case.",
        "commit": "https://github.com/apache/incubator-pinot/commit/3f43c37d50bff9fe7252705bbc2e9f97b57a4cc2",
        "parent": "https://github.com/apache/incubator-pinot/commit/c05d5850ec42d825abee8afb6e7c26965a1be720",
        "bug_id": "incubator-pinot_20",
        "file": [
            {
                "sha": "24a8668e69f9a3a3cefb6d011cf309e6de4c518c",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/servlet/PinotBrokerRoutingTableDebugServlet.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/3f43c37d50bff9fe7252705bbc2e9f97b57a4cc2/pinot-broker/src/main/java/com/linkedin/pinot/broker/servlet/PinotBrokerRoutingTableDebugServlet.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/3f43c37d50bff9fe7252705bbc2e9f97b57a4cc2/pinot-broker/src/main/java/com/linkedin/pinot/broker/servlet/PinotBrokerRoutingTableDebugServlet.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/servlet/PinotBrokerRoutingTableDebugServlet.java?ref=3f43c37d50bff9fe7252705bbc2e9f97b57a4cc2",
                "patch": "@@ -49,7 +49,7 @@ protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws Se\n       String tableName;\n       String pathInfo = req.getPathInfo();\n \n-      if (pathInfo.startsWith(\"/\") && pathInfo.lastIndexOf('/') == 0) {\n+      if (pathInfo != null && !pathInfo.isEmpty() && pathInfo.startsWith(\"/\") && pathInfo.lastIndexOf('/') == 0) {\n         // Drop leading slash\n         tableName = pathInfo.substring(1);\n       } else {",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE and add a test case for older history files (#1827)\n\n* Fix NPE and add a test case for older history files\r\n\r\nIf we fail to read the stats history file for any reason, we would end up getting an NPE because _statsHistory\r\nwent uninitialized. Fixed to create an instance with a new file.\r\n\r\nAlso added a v1 serialized file to the repository so that we can ensure that future changes to the class\r\ncan still read v1 files.\r\n\r\n* Address review comments",
        "commit": "https://github.com/apache/incubator-pinot/commit/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da",
        "parent": "https://github.com/apache/incubator-pinot/commit/050886603ea2b4bc0eac543adeb96d6887ce237c",
        "bug_id": "incubator-pinot_21",
        "file": [
            {
                "sha": "0d0bbaa90b4cdf5b0c74d509da5961ca100f492c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeTableDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeTableDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeTableDataManager.java",
                "status": "modified",
                "changes": 8,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeTableDataManager.java?ref=962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.core.data.manager.realtime;\n \n+import com.linkedin.pinot.common.Utils;\n import com.linkedin.pinot.common.config.IndexingConfig;\n import com.linkedin.pinot.common.config.TableConfig;\n import com.linkedin.pinot.common.config.TableNameBuilder;\n@@ -96,7 +97,12 @@ protected void doInit() {\n         LOGGER.error(\"Could not move {} to {}\", statsFile.getAbsolutePath(), savedFile.getAbsolutePath(), e1);\n         throw new RuntimeException(e);\n       }\n-      LOGGER.warn(\"Saved unreadable {} into {}\", statsFile.getAbsolutePath(), savedFile.getAbsolutePath());\n+      LOGGER.warn(\"Saved unreadable {} into {}. Creating a fresh instance\", statsFile.getAbsolutePath(), savedFile.getAbsolutePath());\n+      try {\n+        _statsHistory = RealtimeSegmentStatsHistory.deserialzeFrom(statsFile);\n+      } catch (Exception e2) {\n+        Utils.rethrowException(e2);\n+      }\n     }\n   }\n ",
                "deletions": 1
            },
            {
                "sha": "2eec674b45f2074e02bbcd3d05c194c39158d091",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentStatsHistoryTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da/pinot-core/src/test/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentStatsHistoryTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da/pinot-core/src/test/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentStatsHistoryTest.java",
                "status": "modified",
                "changes": 25,
                "additions": 25,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentStatsHistoryTest.java?ref=962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da",
                "patch": "@@ -16,6 +16,7 @@\n \n package com.linkedin.pinot.core.realtime.impl;\n \n+import com.linkedin.pinot.util.TestUtils;\n import java.io.File;\n import java.util.Random;\n import org.apache.commons.io.FileUtils;\n@@ -180,6 +181,30 @@ public void testMultiThreadedUse() throws Exception {\n     FileUtils.deleteQuietly(serializedFile);\n   }\n \n+  // This test attempts to ensure that future modifications to RealtimeSegmentStatsHistory does not prevent the software\n+  // from reading data serialized by earlier versions. The serialized data has one segment, with 2 columns -- \"v1col1\" and\n+  // \"v1col2\".\n+  @Test\n+  public void testVersion1() throws Exception {\n+    final String fileName = \"realtime-segment-stats-history-v1.ser\";\n+    File v1StatsFile = new File(TestUtils.getFileFromResourceUrl(RealtimeSegmentStatsHistoryTest.class.getClassLoader().getResource(\"data\")), fileName);\n+    RealtimeSegmentStatsHistory statsHistory = RealtimeSegmentStatsHistory.deserialzeFrom(v1StatsFile);\n+    RealtimeSegmentStatsHistory.SegmentStats segmentStats = statsHistory.getSegmentStatsAt(0);\n+    RealtimeSegmentStatsHistory.ColumnStats columnStats;\n+\n+    columnStats = segmentStats.getColumnStats(\"v1col1\");\n+    Assert.assertEquals(columnStats.getCardinality(), 100);\n+    Assert.assertEquals(columnStats.getAvgColumnSize(), 200);\n+    columnStats = segmentStats.getColumnStats(\"v1col2\");\n+    Assert.assertEquals(columnStats.getCardinality(), 300);\n+    Assert.assertEquals(columnStats.getAvgColumnSize(), 400);\n+\n+    Assert.assertEquals(segmentStats.getNumRowsConsumed(), 500);\n+    Assert.assertEquals(segmentStats.getMemUsedBytes(), 600);\n+    Assert.assertEquals(segmentStats.getNumSeconds(), 700);\n+\n+  }\n+\n   private static class StatsUpdater implements Runnable {\n     private final RealtimeSegmentStatsHistory _statsHistory;\n     private final int _numIterations;",
                "deletions": 0
            },
            {
                "sha": "e0f09dc769423498ee3ecf3515117ac455c19fd0",
                "filename": "pinot-core/src/test/resources/data/realtime-segment-stats-history-v1.ser",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da/pinot-core/src/test/resources/data/realtime-segment-stats-history-v1.ser",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da/pinot-core/src/test/resources/data/realtime-segment-stats-history-v1.ser",
                "status": "added",
                "changes": 0,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/resources/data/realtime-segment-stats-history-v1.ser?ref=962c96a00c3dfd06f1ebf391a6b7ee26a3d1c3da",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Change compression type to pass-through for raw indexed realtime metric columns (#2296)\n\n* Change compression type to pass-through for raw indexed realtime metric columns\r\n\r\n* Fixing NPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b",
        "parent": "https://github.com/apache/incubator-pinot/commit/53239c53ee22c5d16a12a68f213fc1a779030e4c",
        "bug_id": "incubator-pinot_22",
        "file": [
            {
                "sha": "1fd075958b758a1d7d80618c468360cb357f555d",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/generator/SegmentGeneratorConfig.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b/pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/generator/SegmentGeneratorConfig.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b/pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/generator/SegmentGeneratorConfig.java",
                "status": "modified",
                "changes": 20,
                "additions": 20,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/generator/SegmentGeneratorConfig.java?ref=1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b",
                "patch": "@@ -25,6 +25,7 @@\n import com.linkedin.pinot.core.data.readers.CSVRecordReaderConfig;\n import com.linkedin.pinot.core.data.readers.FileFormat;\n import com.linkedin.pinot.core.data.readers.RecordReaderConfig;\n+import com.linkedin.pinot.core.io.compression.ChunkCompressorFactory;\n import com.linkedin.pinot.core.segment.DefaultSegmentNameGenerator;\n import com.linkedin.pinot.core.segment.SegmentNameGenerator;\n import com.linkedin.pinot.core.segment.creator.impl.V1Constants;\n@@ -65,6 +66,7 @@\n \n   private Map<String, String> _customProperties = new HashMap<>();\n   private Set<String> _rawIndexCreationColumns = new HashSet<>();\n+  private Map<String, ChunkCompressorFactory.CompressionType> _rawIndexCompressionType = new HashMap<>();\n   private List<String> _invertedIndexCreationColumns = new ArrayList<>();\n   private String _dataDir = null;\n   private String _inputFilePath = null;\n@@ -110,6 +112,7 @@ public SegmentGeneratorConfig(SegmentGeneratorConfig config) {\n     Preconditions.checkNotNull(config);\n     _customProperties.putAll(config._customProperties);\n     _rawIndexCreationColumns.addAll(config._rawIndexCreationColumns);\n+    _rawIndexCompressionType.putAll(config._rawIndexCompressionType);\n     _invertedIndexCreationColumns.addAll(config._invertedIndexCreationColumns);\n     _dataDir = config._dataDir;\n     _inputFilePath = config._inputFilePath;\n@@ -472,6 +475,23 @@ public void setOnHeap(boolean onHeap) {\n     _onHeap = onHeap;\n   }\n \n+  @JsonIgnore\n+  public ChunkCompressorFactory.CompressionType getColumnCompressionType(String columnName) {\n+    if (_rawIndexCompressionType.containsKey(columnName)) {\n+      return _rawIndexCompressionType.get(columnName);\n+    }\n+    return ChunkCompressorFactory.CompressionType.SNAPPY;\n+  }\n+\n+  public Map<String, ChunkCompressorFactory.CompressionType> getRawIndexCompressionType() {\n+    return _rawIndexCompressionType;\n+  }\n+\n+  public void setRawIndexCompressionType(Map<String, ChunkCompressorFactory.CompressionType> rawIndexCompressionType) {\n+    _rawIndexCompressionType.clear();\n+    _rawIndexCompressionType.putAll(rawIndexCompressionType);\n+  }\n+\n   @JsonIgnore\n   public String getMetrics() {\n     return getQualifyingFields(FieldType.METRIC);",
                "deletions": 0
            },
            {
                "sha": "31e4bd753ec5db24fec4130ea86b207097eac7ef",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/converter/RealtimeSegmentConverter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/converter/RealtimeSegmentConverter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/converter/RealtimeSegmentConverter.java",
                "status": "modified",
                "changes": 11,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/converter/RealtimeSegmentConverter.java?ref=1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b",
                "patch": "@@ -17,6 +17,7 @@\n \n import com.linkedin.pinot.common.config.ColumnPartitionConfig;\n import com.linkedin.pinot.common.config.SegmentPartitionConfig;\n+import com.linkedin.pinot.common.data.FieldSpec;\n import com.linkedin.pinot.common.data.Schema;\n import com.linkedin.pinot.common.data.StarTreeIndexSpec;\n import com.linkedin.pinot.common.data.TimeFieldSpec;\n@@ -25,11 +26,13 @@\n import com.linkedin.pinot.common.metrics.ServerMetrics;\n import com.linkedin.pinot.core.indexsegment.generator.SegmentGeneratorConfig;\n import com.linkedin.pinot.core.indexsegment.generator.SegmentVersion;\n+import com.linkedin.pinot.core.io.compression.ChunkCompressorFactory;\n import com.linkedin.pinot.core.realtime.converter.stats.RealtimeSegmentSegmentCreationDataSource;\n import com.linkedin.pinot.core.realtime.impl.RealtimeSegmentImpl;\n import com.linkedin.pinot.core.segment.creator.impl.SegmentIndexCreationDriverImpl;\n import java.io.File;\n import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import javax.annotation.Nullable;\n@@ -104,6 +107,14 @@ public void build(@Nullable SegmentVersion segmentVersion, ServerMetrics serverM\n     }\n     if (noDictionaryColumns != null) {\n       genConfig.setRawIndexCreationColumns(noDictionaryColumns);\n+      Map<String, ChunkCompressorFactory.CompressionType> columnToCompressionType = new HashMap<>();\n+      for (String column : noDictionaryColumns) {\n+        FieldSpec fieldSpec = dataSchema.getFieldSpecFor(column);\n+        if (fieldSpec.getFieldType().equals(FieldSpec.FieldType.METRIC)) {\n+          columnToCompressionType.put(column, ChunkCompressorFactory.CompressionType.PASS_THROUGH);\n+        }\n+      }\n+      genConfig.setRawIndexCompressionType(columnToCompressionType);\n     }\n \n     // Presence of the spec enables star tree generation.",
                "deletions": 0
            },
            {
                "sha": "6b3fab9c36cb828a6a7134c8293bdc0457206a48",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b/pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b/pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java",
                "status": "modified",
                "changes": 3,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java?ref=1797e4a25e1b5f02bfd29c3aa3befee41f92bd7b",
                "patch": "@@ -177,8 +177,7 @@ public void init(SegmentGeneratorConfig segmentCreationSpec, SegmentIndexCreatio\n         Preconditions.checkState(!invertedIndexColumns.contains(columnName),\n             \"Cannot create inverted index for raw index column: %s\", columnName);\n \n-        // TODO: make this configurable.\n-        ChunkCompressorFactory.CompressionType compressionType = ChunkCompressorFactory.CompressionType.SNAPPY;\n+        ChunkCompressorFactory.CompressionType compressionType = segmentCreationSpec.getColumnCompressionType(columnName);\n \n         // Initialize forward index creator\n         _forwardIndexCreatorMap.put(columnName,",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "TE: fixing npe (#436)",
        "commit": "https://github.com/apache/incubator-pinot/commit/3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29",
        "parent": "https://github.com/apache/incubator-pinot/commit/6eebcfa42d3b89b0e34e6d77591e27457bbfce4a",
        "bug_id": "incubator-pinot_23",
        "file": [
            {
                "sha": "badb75c17c61444718701eee8afbc033af33f599",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java?ref=3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29",
                "patch": "@@ -56,6 +56,7 @@ public TaskDriver(ThirdEyeAnomalyConfiguration thirdEyeAnomalyConfiguration, Ano\n     taskContext.setAnomalyTaskDAO(anomalyTaskDAO);\n     taskContext.setResultDAO(anomalyResultDAO);\n     taskContext.setAnomalyFunctionFactory(anomalyFunctionFactory);\n+    taskContext.setMergedResultDAO(mergedResultDAO);\n     taskContext.setThirdEyeAnomalyConfiguration(thirdEyeAnomalyConfiguration);\n   }\n ",
                "deletions": 0
            },
            {
                "sha": "9ed6fd02a1c15ab5cc81c469dfcce47004751007",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/pinot/PinotThirdEyeClient.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/pinot/PinotThirdEyeClient.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/pinot/PinotThirdEyeClient.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/pinot/PinotThirdEyeClient.java?ref=3fb5eb85b4376a043e4ba45f6c2ac7ed31ffab29",
                "patch": "@@ -48,7 +48,7 @@ protected PinotThirdEyeClient(String controllerHostName, int controllerPort) {\n     this.controllerHost = new HttpHost(controllerHostName, controllerPort);\n     // TODO currently no way to configure the CloseableHttpClient\n     this.controllerClient = HttpClients.createDefault();\n-    LOG.info(\"Created PinotThirdEyeClient to {} with controller {}\", controllerHost);\n+    LOG.info(\"Created PinotThirdEyeClient with controller {}\", controllerHost);\n   }\n \n   /* Static builder methods to mirror Pinot Java API (ConnectionFactory) */",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE and log message when rebuilding broker resource (#1125)",
        "commit": "https://github.com/apache/incubator-pinot/commit/f975fcbbcb8b7a03f90389c387e30ebf44bc6ba1",
        "parent": "https://github.com/apache/incubator-pinot/commit/7d1c7079c677d100e14bc87fed17a52b445162ea",
        "bug_id": "incubator-pinot_24",
        "file": [
            {
                "sha": "8f0703448383c707677a7557f4d50c90d4b587d9",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f975fcbbcb8b7a03f90389c387e30ebf44bc6ba1/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f975fcbbcb8b7a03f90389c387e30ebf44bc6ba1/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 11,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=f975fcbbcb8b7a03f90389c387e30ebf44bc6ba1",
                "patch": "@@ -464,15 +464,20 @@ public PinotResourceManagerResponse rebuildBrokerResourceFromHelixTags(final Str\n \n     try {\n       final TableType tableType = TableNameBuilder.getTableTypeFromTableName(tableName);\n+      AbstractTableConfig tableConfig;\n       if (tableType == TableType.OFFLINE) {\n-        tenantConfig = ZKMetadataProvider.getOfflineTableConfig(getPropertyStore(), tableName).getTenantConfig();\n+        tableConfig = ZKMetadataProvider.getOfflineTableConfig(getPropertyStore(), tableName);\n       } else if (tableType == TableType.REALTIME) {\n-        tenantConfig = ZKMetadataProvider.getRealtimeTableConfig(getPropertyStore(), tableName).getTenantConfig();\n+        tableConfig = ZKMetadataProvider.getRealtimeTableConfig(getPropertyStore(), tableName);\n       } else {\n         return new PinotResourceManagerResponse(\"Table \" + tableName + \" does not have a table type\", false);\n       }\n+      if (tableConfig == null) {\n+        return new PinotResourceManagerResponse(\"Table \" + tableName + \" does not exist\", false);\n+      }\n+      tenantConfig = tableConfig.getTenantConfig();\n     } catch (Exception e) {\n-      LOGGER.warn(\"Caught exception while rebuilding broker resource from Helix tags for table {}\", e, tableName);\n+      LOGGER.warn(\"Caught exception while getting tenant config for table {}\", tableName, e);\n       return new PinotResourceManagerResponse(\n           \"Failed to fetch broker tag for table \" + tableName + \" due to exception: \" + e.getMessage(), false);\n     }",
                "deletions": 3
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE in Broker when existing table configs don't have any routing config options (#1556)",
        "commit": "https://github.com/apache/incubator-pinot/commit/634cc603b7eb82b796d3194f341cb0ff27565102",
        "parent": "https://github.com/apache/incubator-pinot/commit/eff50f650cc5cb5721120b9615b09815edda4639",
        "bug_id": "incubator-pinot_25",
        "file": [
            {
                "sha": "653d5acbfd4c156ce0e13a7498b39ee1c62e400f",
                "filename": "pinot-transport/src/main/java/com/linkedin/pinot/routing/RoutingTableBuilderFactory.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/634cc603b7eb82b796d3194f341cb0ff27565102/pinot-transport/src/main/java/com/linkedin/pinot/routing/RoutingTableBuilderFactory.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/634cc603b7eb82b796d3194f341cb0ff27565102/pinot-transport/src/main/java/com/linkedin/pinot/routing/RoutingTableBuilderFactory.java",
                "status": "modified",
                "changes": 9,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-transport/src/main/java/com/linkedin/pinot/routing/RoutingTableBuilderFactory.java?ref=634cc603b7eb82b796d3194f341cb0ff27565102",
                "patch": "@@ -15,15 +15,11 @@\n  */\n package com.linkedin.pinot.routing;\n \n-import java.util.HashMap;\n import java.util.HashSet;\n-import java.util.Map;\n import java.util.Set;\n-\n import org.apache.commons.configuration.Configuration;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-\n import com.linkedin.pinot.common.config.TableConfig;\n import com.linkedin.pinot.common.utils.CommonConstants.Helix.TableType;\n import com.linkedin.pinot.routing.builder.BalancedRandomRoutingTableBuilder;\n@@ -48,7 +44,10 @@ public RoutingTableBuilderFactory(Configuration configuration) {\n   }\n \n   public RoutingTableBuilder createRoutingTableBuilder(TableConfig tableConfig) {\n-    String builderName = tableConfig.getRoutingConfig().getRoutingTableBuilderName();\n+    String builderName = null;\n+    if (tableConfig.getRoutingConfig() != null) {\n+      builderName = tableConfig.getRoutingConfig().getRoutingTableBuilderName();\n+    }\n     RoutingTableBuilderName buildNameEnum = null;\n \n     if (builderName != null) {",
                "deletions": 5
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE when getting max timestamp for realtime only table. (#428)\n\nRight now for realtime only table, this propertyStore call will throw NPE.",
        "commit": "https://github.com/apache/incubator-pinot/commit/841e2bc2b5dc904c59501a4d1cdeed5804678e6b",
        "parent": "https://github.com/apache/incubator-pinot/commit/0cfb2ae455626bf7772a206178c94e4d43e7732d",
        "bug_id": "incubator-pinot_26",
        "file": [
            {
                "sha": "358dd2583cb3b718a8099c992060ac90bc46d5e7",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/cache/CollectionMaxDataTimeCacheLoader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/841e2bc2b5dc904c59501a4d1cdeed5804678e6b/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/cache/CollectionMaxDataTimeCacheLoader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/841e2bc2b5dc904c59501a4d1cdeed5804678e6b/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/cache/CollectionMaxDataTimeCacheLoader.java",
                "status": "modified",
                "changes": 7,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/client/cache/CollectionMaxDataTimeCacheLoader.java?ref=841e2bc2b5dc904c59501a4d1cdeed5804678e6b",
                "patch": "@@ -47,11 +47,12 @@ public Long load(String collection) throws Exception {\n \n     LOGGER.info(\"Loading maxDataTime cache {}\", collection);\n     long maxTime = 0;\n-    if (propertyStore != null) {\n+    int options = AccessOption.PERSISTENT;\n+    String offlineTablePropertyStorePath = \"/SEGMENTS/\" + collection + \"_OFFLINE\";\n+    if ((propertyStore != null) && (propertyStore.exists(offlineTablePropertyStorePath, options))) {\n       List<Stat> stats = new ArrayList<>();\n-      int options = AccessOption.PERSISTENT;\n       List<ZNRecord> zkSegmentDataList =\n-          propertyStore.getChildren(\"/SEGMENTS/\" + collection + \"_OFFLINE\", stats, options);\n+          propertyStore.getChildren(offlineTablePropertyStorePath, stats, options);\n       for (ZNRecord record : zkSegmentDataList) {\n         try {\n           long endTime = Long.parseLong(record.getSimpleField(\"segment.end.time\"));",
                "deletions": 3
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed NPE in FileBased instance config, removed segment replace test via OFFLINE/ONLINE (no longer used) (#1638)",
        "commit": "https://github.com/apache/incubator-pinot/commit/e58f95d5e303079127bb81ee9a37137802ad987b",
        "parent": "https://github.com/apache/incubator-pinot/commit/362d4de73ac176f4de5b1018a464bc8eb8c88918",
        "bug_id": "incubator-pinot_27",
        "file": [
            {
                "sha": "4d71747c7784b86fdcbaa5c3a63311e73afdb1b4",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/config/FileBasedInstanceDataManagerConfig.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e58f95d5e303079127bb81ee9a37137802ad987b/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/config/FileBasedInstanceDataManagerConfig.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e58f95d5e303079127bb81ee9a37137802ad987b/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/config/FileBasedInstanceDataManagerConfig.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/config/FileBasedInstanceDataManagerConfig.java?ref=e58f95d5e303079127bb81ee9a37137802ad987b",
                "patch": "@@ -15,14 +15,14 @@\n  */\n package com.linkedin.pinot.core.data.manager.config;\n \n-import com.linkedin.pinot.common.segment.ReadMode;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import org.apache.commons.configuration.Configuration;\n import org.apache.commons.configuration.ConfigurationException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+import com.linkedin.pinot.common.segment.ReadMode;\n \n \n /**\n@@ -127,7 +127,7 @@ public ReadMode getReadMode() {\n       return ReadMode.valueOf(_instanceDataManagerConfiguration.getString(READ_MODE));\n     } catch (Exception e) {\n       LOGGER.warn(\"Caught exception file getting the read mode\", e);\n-      return null;\n+      return ReadMode.DEFAULT_MODE;\n     }\n \n   }",
                "deletions": 2
            },
            {
                "sha": "44393672279678a70f4f36d8013bd1e5ca719871",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/core/offline/OfflineTableDataManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e58f95d5e303079127bb81ee9a37137802ad987b/pinot-core/src/test/java/com/linkedin/pinot/core/offline/OfflineTableDataManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e58f95d5e303079127bb81ee9a37137802ad987b/pinot-core/src/test/java/com/linkedin/pinot/core/offline/OfflineTableDataManagerTest.java",
                "status": "modified",
                "changes": 54,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/core/offline/OfflineTableDataManagerTest.java?ref=e58f95d5e303079127bb81ee9a37137802ad987b",
                "patch": "@@ -15,18 +15,6 @@\n  */\n package com.linkedin.pinot.core.offline;\n \n-import com.google.common.collect.ImmutableList;\n-import com.linkedin.pinot.common.metrics.ServerMetrics;\n-import com.linkedin.pinot.common.segment.ReadMode;\n-import com.linkedin.pinot.common.segment.SegmentMetadata;\n-import com.linkedin.pinot.core.data.manager.config.TableDataManagerConfig;\n-import com.linkedin.pinot.core.data.manager.offline.AbstractTableDataManager;\n-import com.linkedin.pinot.core.data.manager.offline.OfflineSegmentDataManager;\n-import com.linkedin.pinot.core.data.manager.offline.OfflineTableDataManager;\n-import com.linkedin.pinot.core.data.manager.offline.SegmentDataManager;\n-import com.linkedin.pinot.core.data.manager.offline.TableDataManager;\n-import com.linkedin.pinot.core.indexsegment.IndexSegment;\n-import com.yammer.metrics.core.MetricsRegistry;\n import java.io.File;\n import java.lang.reflect.Field;\n import java.util.ArrayList;\n@@ -47,7 +35,18 @@\n import org.testng.annotations.BeforeMethod;\n import org.testng.annotations.BeforeSuite;\n import org.testng.annotations.Test;\n-\n+import com.google.common.collect.ImmutableList;\n+import com.linkedin.pinot.common.metrics.ServerMetrics;\n+import com.linkedin.pinot.common.segment.ReadMode;\n+import com.linkedin.pinot.common.segment.SegmentMetadata;\n+import com.linkedin.pinot.core.data.manager.config.TableDataManagerConfig;\n+import com.linkedin.pinot.core.data.manager.offline.AbstractTableDataManager;\n+import com.linkedin.pinot.core.data.manager.offline.OfflineSegmentDataManager;\n+import com.linkedin.pinot.core.data.manager.offline.OfflineTableDataManager;\n+import com.linkedin.pinot.core.data.manager.offline.SegmentDataManager;\n+import com.linkedin.pinot.core.data.manager.offline.TableDataManager;\n+import com.linkedin.pinot.core.indexsegment.IndexSegment;\n+import com.yammer.metrics.core.MetricsRegistry;\n import static org.mockito.Mockito.*;\n \n \n@@ -201,8 +200,6 @@ public void basicTest() throws Exception {\n \n   /*\n    * These tests simulate the access of segments via OfflineTableDataManager.\n-   * Two flavors are simulated : One to replace segments via OFFLINE/ONLINE transitions\n-   * and the other to replace segments via helix message.\n    *\n    * It creates 31 segments (0..30) to start with and adds them to the tableDataManager (hi = 30, lo = 0)\n    * It spawns 10 \"query\" threads, and one \"helix\" thread.\n@@ -216,21 +213,13 @@ public void basicTest() throws Exception {\n    * - Replaces a segment (a randomm one between (lo,hi), 60% of the time)\n    * and then waits for a random of 50-300ms before attempting one of the ops again.\n    */\n-  @Test\n-  public void testOfflineOnline() throws Exception {\n-    runStressTest(false);\n-  }\n \n   @Test\n   public void testReplace() throws Exception {\n-    runStressTest(true);\n-  }\n-\n-  private void runStressTest(boolean replaceSegments) throws  Exception {\n     _lo = 0;\n     _hi = 30;   // Total number of segments we have in the server.\n     final int numQueryThreads = 10;\n-    final int runTimeSec = 30;\n+    final int runTimeSec = 20;\n     // With the current parameters, 3k ops take about 15 seconds, create about 90 segments and drop about half of them\n     // Running with coverage, it provides complete coverage of the (relevant) lines in OfflineTableDataManager\n \n@@ -243,13 +232,13 @@ private void runStressTest(boolean replaceSegments) throws  Exception {\n       _allSegManagers.add(_internalSegMap.get(segName));\n     }\n \n-    runStorageServer(numQueryThreads, runTimeSec, tableDataManager, replaceSegments);  // replaces segments while online\n+    runStorageServer(numQueryThreads, runTimeSec, tableDataManager);  // replaces segments while online\n \n //    System.out.println(\"Nops = \" + _numQueries + \",nDrops=\" + _nDestroys + \",nCreates=\" + _allSegments.size());\n     tableDataManager.shutDown();\n   }\n \n-  private void runStorageServer(int numQueryThreads, int runTimeSec, TableDataManager tableDataManager, boolean replaceSegments) throws Exception {\n+  private void runStorageServer(int numQueryThreads, int runTimeSec, TableDataManager tableDataManager) throws Exception {\n     // Start 1 helix worker thread and as many query threads as configured.\n     List<Thread> queryThreads = new ArrayList<>(numQueryThreads);\n     for (int i = 0; i < numQueryThreads; i++) {\n@@ -259,7 +248,7 @@ private void runStorageServer(int numQueryThreads, int runTimeSec, TableDataMana\n       segUserThread.start();\n     }\n \n-    TestHelixWorker helixWorker = new TestHelixWorker(tableDataManager, replaceSegments);\n+    TestHelixWorker helixWorker = new TestHelixWorker(tableDataManager);\n     Thread helixWorkerThread = new Thread(helixWorker);\n     helixWorkerThread.start();\n     _masterThread = Thread.currentThread();\n@@ -390,17 +379,15 @@ public void run() {\n     private final int _maxSleepMs;\n     private final Random _random = new Random();\n     private final TableDataManager _tableDataManager;\n-    private final boolean _replaceSegments;\n \n-    private TestHelixWorker(TableDataManager tableDataManager, boolean replaceSegments) {\n+    private TestHelixWorker(TableDataManager tableDataManager) {\n       _tableDataManager = tableDataManager;\n \n       _removePercent = 20;\n       _addPercent = 20;\n       _replacePercent = 60;\n       _minSleepMs = 50;\n       _maxSleepMs = 300;\n-      _replaceSegments = replaceSegments;\n     }\n \n     @Override\n@@ -442,13 +429,6 @@ private void addSegment() {\n     private void replaceSegment() {\n       int segToReplace = _random.nextInt(_hi-_lo+1) + _lo;\n       final String segName = segmentPrefix + segToReplace;\n-      if (!_replaceSegments) {\n-        _tableDataManager.removeSegment(segName);\n-        try {\n-          Thread.sleep(4);\n-        } catch (InterruptedException e) {\n-        }\n-      }\n       _tableDataManager.addSegment(makeIndexSegment(segName, _random.nextInt()));\n       _allSegManagers.add(_internalSegMap.get(segName));\n     }",
                "deletions": 37
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Add metrics for keeping track of off-heap allocation for consuming segments (#1874)\n\n* Add metrics for keeping track of off-heap allocation for consuming segments\r\n\r\n* Undo changes to test, in favor of a new constructor\r\n\r\n* Fix NPE in a test. Don't know why other tests are failing yet\r\n\r\n* Fix NPE in tests\r\n\r\n* Calling size() on buffer object can throw NPE while closing memory manager\r\n\r\nThis is beacuse some of the memory is already freed up before we reach close() method of MemoryManager.\r\nSo, it seems better to just use _totalMemBytes to set the guage (and unset it)",
        "commit": "https://github.com/apache/incubator-pinot/commit/c802cdafb57343d174fdef623f25ef15aa45d782",
        "parent": "https://github.com/apache/incubator-pinot/commit/0d7d865d792205d33f1262588ff486dd47b2aeda",
        "bug_id": "incubator-pinot_28",
        "file": [
            {
                "sha": "39b0726824823b8e6c7c519dc8593357bb43441e",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/metrics/ServerGauge.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/ServerGauge.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/ServerGauge.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/ServerGauge.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -32,6 +32,7 @@\n   LAST_REALTIME_SEGMENT_CATCHUP_DURATION_SECONDS(\"seconds\", false),\n   LAST_REALTIME_SEGMENT_COMPLETION_DURATION_SECONDS(\"seconds\", false),\n   KAFKA_PARTITION_OFFSET_LAG(\"messages\", false),\n+  REALTIME_OFFHEAP_MEMORY_USED(\"bytes\", false),\n   RUNNING_QUERIES(\"runningQueries\", false);\n \n   private final String gaugeName;",
                "deletions": 0
            },
            {
                "sha": "14c10c71617fe6e8acb93e16eb7fab894192329c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/offline/AbstractTableDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/offline/AbstractTableDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/offline/AbstractTableDataManager.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/offline/AbstractTableDataManager.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -252,6 +252,10 @@ public void releaseSegment(SegmentDataManager segmentDataManager) {\n     }\n   }\n \n+  public ServerMetrics getServerMetrics() {\n+    return _serverMetrics;\n+  }\n+\n   @Override\n   public String getTableName() {\n     return _tableName;",
                "deletions": 0
            },
            {
                "sha": "0d391a65fe7485246f0198e0d87a983966eb709b",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "status": "modified",
                "changes": 7,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -17,6 +17,7 @@\n package com.linkedin.pinot.core.data.manager.realtime;\n \n import com.linkedin.pinot.common.data.Schema;\n+import com.linkedin.pinot.common.metrics.ServerMetrics;\n import com.linkedin.pinot.core.data.manager.offline.SegmentDataManager;\n import com.linkedin.pinot.core.io.readerwriter.RealtimeIndexOffHeapMemoryManager;\n import com.linkedin.pinot.core.io.writer.impl.DirectMemoryManager;\n@@ -49,10 +50,12 @@ public RealtimeSegmentStatsHistory getStatsHistory() {\n   }\n \n   protected void initMemoryManager(RealtimeTableDataManager realtimeTableDataManager, boolean isOffHeapAllocation, String segmentName) {\n+    ServerMetrics serverMetrics = realtimeTableDataManager.getServerMetrics();\n     if (isOffHeapAllocation) {\n-      _memoryManager = new MmapMemoryManager(realtimeTableDataManager.getConsumerDir(), segmentName);\n+      _memoryManager = new MmapMemoryManager(realtimeTableDataManager.getConsumerDir(), segmentName,\n+          realtimeTableDataManager.getServerMetrics());\n     } else {\n-      _memoryManager = new DirectMemoryManager(segmentName);\n+      _memoryManager = new DirectMemoryManager(segmentName, realtimeTableDataManager.getServerMetrics());\n     }\n   }\n ",
                "deletions": 2
            },
            {
                "sha": "b4f30cbd788a5b0784441ba30b6a5473c841dd6c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/io/readerwriter/RealtimeIndexOffHeapMemoryManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/io/readerwriter/RealtimeIndexOffHeapMemoryManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/io/readerwriter/RealtimeIndexOffHeapMemoryManager.java",
                "status": "modified",
                "changes": 24,
                "additions": 22,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/io/readerwriter/RealtimeIndexOffHeapMemoryManager.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -16,11 +16,16 @@\n \n package com.linkedin.pinot.core.io.readerwriter;\n \n+import com.linkedin.pinot.common.metrics.ServerGauge;\n+import com.linkedin.pinot.common.metrics.ServerMetrics;\n+import com.linkedin.pinot.common.utils.HLCSegmentName;\n+import com.linkedin.pinot.common.utils.LLCSegmentName;\n+import com.linkedin.pinot.common.utils.SegmentName;\n+import com.linkedin.pinot.core.segment.memory.PinotDataBuffer;\n import java.io.Closeable;\n import java.io.IOException;\n import java.util.LinkedList;\n import java.util.List;\n-import com.linkedin.pinot.core.segment.memory.PinotDataBuffer;\n \n \n /**\n@@ -35,10 +40,23 @@\n public abstract class RealtimeIndexOffHeapMemoryManager implements Closeable {\n   private final List<PinotDataBuffer> _buffers = new LinkedList<>();\n   private final String _segmentName;\n+  private final ServerMetrics _serverMetrics;\n   private long _totalMemBytes = 0;\n+  private final String _tableName;\n \n-  protected RealtimeIndexOffHeapMemoryManager(String segmentName) {\n+  protected RealtimeIndexOffHeapMemoryManager(ServerMetrics serverMetrics, String segmentName) {\n+    _serverMetrics = serverMetrics;\n     _segmentName = segmentName;\n+    if (SegmentName.isLowLevelConsumerSegmentName(segmentName)) {\n+      LLCSegmentName llcSegmentName = new LLCSegmentName(segmentName);\n+      _tableName = llcSegmentName.getTableName();\n+    } else if (SegmentName.isHighLevelConsumerSegmentName(segmentName)){\n+      HLCSegmentName hlcSegmentName = new HLCSegmentName(segmentName);\n+      _tableName = hlcSegmentName.getTableName();\n+    } else {\n+      // For testing only\n+      _tableName = \"NoSuchTable\";\n+    }\n   }\n \n   /**\n@@ -63,6 +81,7 @@ public PinotDataBuffer allocate(long size, String columnName) {\n     PinotDataBuffer buffer = allocateInternal(size, columnName);\n     _totalMemBytes += size;\n     _buffers.add(buffer);\n+    _serverMetrics.setValueOfTableGauge(_tableName, ServerGauge.REALTIME_OFFHEAP_MEMORY_USED, _totalMemBytes);\n     return buffer;\n   }\n \n@@ -85,6 +104,7 @@ public void close() throws IOException {\n     for (PinotDataBuffer buffer : _buffers) {\n       buffer.close();\n     }\n+    _serverMetrics.setValueOfTableGauge(_tableName, ServerGauge.REALTIME_OFFHEAP_MEMORY_USED, 0);\n     doClose();\n     _buffers.clear();\n   }",
                "deletions": 2
            },
            {
                "sha": "28a11a284d440e81bfa95b5bf0934b23da1582b9",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/DirectMemoryManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/DirectMemoryManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/DirectMemoryManager.java",
                "status": "modified",
                "changes": 10,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/DirectMemoryManager.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -16,8 +16,11 @@\n \n package com.linkedin.pinot.core.io.writer.impl;\n \n+import com.google.common.annotations.VisibleForTesting;\n+import com.linkedin.pinot.common.metrics.ServerMetrics;\n import com.linkedin.pinot.core.io.readerwriter.RealtimeIndexOffHeapMemoryManager;\n import com.linkedin.pinot.core.segment.memory.PinotDataBuffer;\n+import com.yammer.metrics.core.MetricsRegistry;\n \n \n // Allocates memory using direct allocation\n@@ -26,8 +29,13 @@\n   /**\n    * @see RealtimeIndexOffHeapMemoryManager\n    */\n+  public DirectMemoryManager(final String segmentName, ServerMetrics serverMetrics) {\n+    super(serverMetrics, segmentName);\n+  }\n+\n+  @VisibleForTesting\n   public DirectMemoryManager(final String segmentName) {\n-    super(segmentName);\n+    this(segmentName, new ServerMetrics(new MetricsRegistry()));\n   }\n \n   /**",
                "deletions": 1
            },
            {
                "sha": "a45b3a52c54238a42df2878d176fa80ad4984df7",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/MmapMemoryManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/MmapMemoryManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/MmapMemoryManager.java",
                "status": "modified",
                "changes": 12,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/io/writer/impl/MmapMemoryManager.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -16,6 +16,8 @@\n \n package com.linkedin.pinot.core.io.writer.impl;\n \n+import com.linkedin.pinot.common.metrics.ServerMetrics;\n+import com.yammer.metrics.core.MetricsRegistry;\n import java.io.File;\n import java.io.FileNotFoundException;\n import java.io.FilenameFilter;\n@@ -70,10 +72,11 @@ public static long getDefaultFileLength() {\n    * @param dirPathName directory under which all mmap files are created.\n    * @param segmentName Name of the segment for which this memory manager allocates memory\n    *\n+   * @param serverMetrics\n    * @see RealtimeIndexOffHeapMemoryManager\n    */\n-  public MmapMemoryManager(String dirPathName, String segmentName) {\n-    super(segmentName);\n+  public MmapMemoryManager(String dirPathName, String segmentName, ServerMetrics serverMetrics) {\n+    super(serverMetrics, segmentName);\n     _dirPathName = dirPathName;\n     File dirFile = new File(_dirPathName);\n     if (dirFile.exists()) {\n@@ -93,6 +96,11 @@ public boolean accept(File dir, String name) {\n     }\n   }\n \n+  @VisibleForTesting\n+  public MmapMemoryManager(String dirPathName, String segmentName) {\n+    this(dirPathName, segmentName, new ServerMetrics(new MetricsRegistry()));\n+  }\n+\n   private String getFilePrefix() {\n     return getSegmentName() + \".\";\n   }",
                "deletions": 2
            },
            {
                "sha": "95c49ed5dc3cf91f4cb7e0b5617abac30696e122",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c802cdafb57343d174fdef623f25ef15aa45d782/pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java?ref=c802cdafb57343d174fdef623f25ef15aa45d782",
                "patch": "@@ -123,6 +123,7 @@ private RealtimeTableDataManager createTableDataManager() {\n     when(statsHistory.getEstimatedCardinality(any(String.class))).thenReturn(200);\n     when(statsHistory.getEstimatedAvgColSize(any(String.class))).thenReturn(32);\n     when(tableDataManager.getStatsHistory()).thenReturn(statsHistory);\n+    when(tableDataManager.getServerMetrics()).thenReturn(new ServerMetrics(new MetricsRegistry()));\n     return tableDataManager;\n   }\n ",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE and return 404 if schema is not found (#696)\n\nOn controller REST API call to read table schema, return\r\n404 if the schema is not found. This also fixes NPE issue.",
        "commit": "https://github.com/apache/incubator-pinot/commit/1cb9b44c1cd470662d22b3113c8dec4e11612e03",
        "parent": "https://github.com/apache/incubator-pinot/commit/00047a7af24721cd3ed82c4a74aebb4e659432be",
        "bug_id": "incubator-pinot_29",
        "file": [
            {
                "sha": "691941059cab484ea88d7f0c3c9d1e5ff2b1ecd3",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1cb9b44c1cd470662d22b3113c8dec4e11612e03/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1cb9b44c1cd470662d22b3113c8dec4e11612e03/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java",
                "status": "modified",
                "changes": 13,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableSchema.java?ref=1cb9b44c1cd470662d22b3113c8dec4e11612e03",
                "patch": "@@ -1,11 +1,13 @@\n package com.linkedin.pinot.controller.api.restlet.resources;\n \n+import com.linkedin.pinot.common.data.Schema;\n import java.io.File;\n import java.io.IOException;\n \n import com.linkedin.pinot.common.metrics.ControllerMeter;\n import com.linkedin.pinot.controller.api.ControllerRestApplication;\n import org.apache.commons.io.FileUtils;\n+import org.restlet.data.MediaType;\n import org.restlet.data.Status;\n import org.restlet.representation.Representation;\n import org.restlet.representation.StringRepresentation;\n@@ -72,8 +74,15 @@ private Representation getTableSchema(\n       AbstractTableConfig config;\n       try {\n         config = _pinotHelixResourceManager.getTableConfig(tableName, TableType.OFFLINE);\n-        return new StringRepresentation(_pinotHelixResourceManager.getSchema(config.getValidationConfig().getSchemaName()).getJSONSchema()\n-            .toString());\n+        String schemaName = config.getValidationConfig().getSchemaName();\n+        Schema schema = _pinotHelixResourceManager.getSchema(schemaName);\n+        if (schema == null) {\n+          setStatus(Status.CLIENT_ERROR_NOT_FOUND);\n+          StringRepresentation repr = new StringRepresentation(\"{\\\"error\\\": \\\"Schema \" + schemaName + \" not found\\\"\");\n+          repr.setMediaType(MediaType.APPLICATION_JSON);\n+          return repr;\n+        }\n+        return new StringRepresentation(schema.getJSONSchema().toString());\n       } catch (Exception e) {\n         LOGGER.error(\"Caught exception while fetching schema for a offline table : {} \", tableName, e);\n         ControllerRestApplication.getControllerMetrics().addMeteredGlobalValue(ControllerMeter.CONTROLLER_TABLE_SCHEMA_GET_ERROR, 1L);",
                "deletions": 2
            },
            {
                "sha": "d3734137476e81fc62fd2d24e3b857ebc9e76f8e",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1cb9b44c1cd470662d22b3113c8dec4e11612e03/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1cb9b44c1cd470662d22b3113c8dec4e11612e03/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=1cb9b44c1cd470662d22b3113c8dec4e11612e03",
                "patch": "@@ -24,6 +24,7 @@\n import java.util.Set;\n import java.util.concurrent.Callable;\n import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nullable;\n import org.apache.commons.collections.CollectionUtils;\n import org.apache.commons.collections.Predicate;\n import org.apache.helix.AccessOption;\n@@ -863,10 +864,9 @@ public boolean deleteSchema(Schema schema) {\n    * @throws JsonMappingException\n    * @throws IOException\n    */\n-  public Schema getSchema(String schemaName) throws JsonParseException, JsonMappingException, IOException {\n+  public @Nullable Schema getSchema(String schemaName) throws JsonParseException, JsonMappingException, IOException {\n     PinotHelixPropertyStoreZnRecordProvider propertyStoreHelper =\n         PinotHelixPropertyStoreZnRecordProvider.forSchema(_propertyStore);\n-    LOGGER.info(\"found schema {} \", schemaName);\n     ZNRecord record = propertyStoreHelper.get(schemaName);\n     return record != null ? SchemaUtils.fromZNRecord(record) : null;\n   }",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Avoid throwing NPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/0b33742453430bde730fac4f6185ba7970c60991",
        "parent": "https://github.com/apache/incubator-pinot/commit/a26c9adc7bbb75217ea4abfb3c36b7ae6e674a87",
        "bug_id": "incubator-pinot_30",
        "file": [
            {
                "sha": "e9fe8525da72971616a507ef2620f20c135c9b69",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/0b33742453430bde730fac4f6185ba7970c60991/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/0b33742453430bde730fac4f6185ba7970c60991/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "status": "modified",
                "changes": 16,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java?ref=0b33742453430bde730fac4f6185ba7970c60991",
                "patch": "@@ -256,19 +256,15 @@ public String getTimeColumnName() {\n   }\n \n   @JsonIgnore(true)\n-  public TimeUnit getIncomingTimeUnit() throws NullPointerException {\n-    if (timeFieldSpec == null || timeFieldSpec.getIncomingGranularitySpec() == null) {\n-      throw new NullPointerException();\n-    }\n-    return timeFieldSpec.getIncomingGranularitySpec().getTimeType();\n+  public TimeUnit getIncomingTimeUnit() {\n+    return (timeFieldSpec != null && timeFieldSpec.getIncomingGranularitySpec() != null) ?\n+        timeFieldSpec.getIncomingGranularitySpec().getTimeType() : null;\n   }\n \n   @JsonIgnore(true)\n-  public TimeUnit getOutgoingTimeUnit() throws NullPointerException {\n-    if (timeFieldSpec == null || timeFieldSpec.getOutgoingGranularitySpec() == null) {\n-      throw new NullPointerException();\n-    }\n-    return timeFieldSpec.getIncomingGranularitySpec().getTimeType();\n+  public TimeUnit getOutgoingTimeUnit() {\n+    return (timeFieldSpec != null && timeFieldSpec.getOutgoingGranularitySpec() != null) ?\n+        timeFieldSpec.getIncomingGranularitySpec().getTimeType() : null;\n   }\n \n   public TimeFieldSpec getTimeFieldSpec() {",
                "deletions": 10
            },
            {
                "sha": "b9e63e0f0cb0dd7f51753544344cca759e3c33f7",
                "filename": "pinot-perf/src/main/java/com/linkedin/pinot/perf/PerfBenchmarkRunner.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/0b33742453430bde730fac4f6185ba7970c60991/pinot-perf/src/main/java/com/linkedin/pinot/perf/PerfBenchmarkRunner.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/0b33742453430bde730fac4f6185ba7970c60991/pinot-perf/src/main/java/com/linkedin/pinot/perf/PerfBenchmarkRunner.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-perf/src/main/java/com/linkedin/pinot/perf/PerfBenchmarkRunner.java?ref=0b33742453430bde730fac4f6185ba7970c60991",
                "patch": "@@ -99,7 +99,7 @@ public static void main(String[] args) throws Exception {\n       }\n \n     } else {\n-      System.err.println(\"Expected one of [setupWithPreLoadedSegments]\");\n+      System.err.println(\"Expected one of [startAll|startAllButServer|StartServerWithPreLoadedSegments]\");\n     }\n   }\n }",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing realtime retention NPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/72a3b62fbae38654331b9602234746da19ef3b8d",
        "parent": "https://github.com/apache/incubator-pinot/commit/3494074e27ae4000a4e9362329df87ec994a7a66",
        "bug_id": "incubator-pinot_31",
        "file": [
            {
                "sha": "c678b2ebd3860351cfbfaeba612928546634af89",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/72a3b62fbae38654331b9602234746da19ef3b8d/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/72a3b62fbae38654331b9602234746da19ef3b8d/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java?ref=72a3b62fbae38654331b9602234746da19ef3b8d",
                "patch": "@@ -191,7 +191,7 @@ private void updateDeletionStrategiesForEntireCluster() {\n \n     AbstractTableConfig realtimeTableConfig;\n     try {\n-      realtimeTableConfig = ZKMetadataProvider.getOfflineTableConfig(_pinotHelixResourceManager.getPropertyStore(), realtimeTableName);\n+      realtimeTableConfig = ZKMetadataProvider.getRealtimeTableConfig(_pinotHelixResourceManager.getPropertyStore(), realtimeTableName);\n     } catch (Exception e) {\n       LOGGER.error(\"Error getting realtime table config from property store!\", e);\n       return tableToDeletionStrategyMap;",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Build Fix, added null check to avoid NPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/aefdb82bb164e79ed75a1a745bf563e2bca1f0a8",
        "parent": "https://github.com/apache/incubator-pinot/commit/36935d7de6e2e8dd77cd8323fc8968a7b99c0b0a",
        "bug_id": "incubator-pinot_32",
        "file": [
            {
                "sha": "6bec1e7a7935632a7a8b791e8da9b3b400045de9",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/startree/OffHeapStarTreeBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/aefdb82bb164e79ed75a1a745bf563e2bca1f0a8/pinot-core/src/main/java/com/linkedin/pinot/core/startree/OffHeapStarTreeBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/aefdb82bb164e79ed75a1a745bf563e2bca1f0a8/pinot-core/src/main/java/com/linkedin/pinot/core/startree/OffHeapStarTreeBuilder.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/startree/OffHeapStarTreeBuilder.java?ref=aefdb82bb164e79ed75a1a745bf563e2bca1f0a8",
                "patch": "@@ -439,7 +439,7 @@ private int constructStarTree(StarTreeIndexNode node, int startDocId, int endDoc\n     }\n \n     // Return if star node does not need to be created.\n-    if (skipStarNodeCreationForDimensions.contains(splitDimensionName)) {\n+    if (skipStarNodeCreationForDimensions != null && skipStarNodeCreationForDimensions.contains(splitDimensionName)) {\n       return docsAdded;\n     }\n ",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "THIRDEYE-525 : NPE in SlideshowViewThirdeyeDaily_aggregation",
        "commit": "https://github.com/apache/incubator-pinot/commit/44db8707f6bf70d4a6f77e27beb38345cfefc884",
        "parent": "https://github.com/apache/incubator-pinot/commit/b10b5d46d56f33b297d592c19453d87b9fe2063d",
        "bug_id": "incubator-pinot_33",
        "file": [
            {
                "sha": "4b2a87b56b1f3bc196b9169e939d308878f19be8",
                "filename": "thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/44db8707f6bf70d4a6f77e27beb38345cfefc884/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/44db8707f6bf70d4a6f77e27beb38345cfefc884/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java?ref=44db8707f6bf70d4a6f77e27beb38345cfefc884",
                "patch": "@@ -103,7 +103,7 @@ public static AggregationJobConfig fromStarTreeConfig(StarTreeConfig config) thr\n       }\n     }\n     catch (Exception e) {\n-      throw new IllegalStateException(\"Error reading starTreeConfig \" + config.encode());\n+      throw new IllegalStateException(\"The config must contain dimensions and metrics : \" + config.encode(), e);\n     }\n     return new AggregationJobConfig(dimensionNames,\n                                     metricNames,",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "THIRDEYE-525 : NPE in SlideshowViewThirdeyeDaily_aggregation",
        "commit": "https://github.com/apache/incubator-pinot/commit/b10b5d46d56f33b297d592c19453d87b9fe2063d",
        "parent": "https://github.com/apache/incubator-pinot/commit/0219217d7ed8cd6243a295069772d4f68ce10305",
        "bug_id": "incubator-pinot_34",
        "file": [
            {
                "sha": "f1e876c6bc5ab46e5b4d9fa9730a8ee3b85d6f25",
                "filename": "thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b10b5d46d56f33b297d592c19453d87b9fe2063d/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b10b5d46d56f33b297d592c19453d87b9fe2063d/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "status": "modified",
                "changes": 47,
                "additions": 29,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java?ref=b10b5d46d56f33b297d592c19453d87b9fe2063d",
                "patch": "@@ -1,5 +1,6 @@\n package com.linkedin.thirdeye.bootstrap.aggregation;\n \n+import java.io.IOException;\n import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n@@ -71,28 +72,38 @@ public String getThresholdFuncClassName() {\n     return thresholdFuncParams;\n   }\n \n-  public static AggregationJobConfig fromStarTreeConfig(StarTreeConfig config) {\n-    List<String> metricNames = new ArrayList<String>(config.getMetrics().size());\n-    List<MetricType> metricTypes = new ArrayList<MetricType>(config.getMetrics().size());\n-    for (MetricSpec spec : config.getMetrics())\n-    {\n-      metricNames.add(spec.getName());\n-      metricTypes.add(spec.getType());\n-    }\n+  public static AggregationJobConfig fromStarTreeConfig(StarTreeConfig config) throws IOException {\n+    List<String> metricNames = null;\n+    List<MetricType> metricTypes = null;\n+    List<String> dimensionNames = null;\n+    Map<String, String> rollupFunctionConfig  = null;\n \n-    List<String> dimensionNames = new ArrayList<String>(config.getDimensions().size());\n-    for (DimensionSpec dimensionSpec : config.getDimensions())\n-    {\n-      dimensionNames.add(dimensionSpec.getName());\n-    }\n+    try {\n+      metricNames = new ArrayList<String>(config.getMetrics().size());\n+      metricTypes = new ArrayList<MetricType>(config.getMetrics().size());\n+      for (MetricSpec spec : config.getMetrics())\n+      {\n+        metricNames.add(spec.getName());\n+        metricTypes.add(spec.getType());\n+      }\n \n-    Map<String, String> rollupFunctionConfig = new HashMap<String, String>();\n-    if (config.getRollup().getFunctionConfig() != null)\n-    {\n-      for (Map.Entry<Object, Object> entry : config.getRollup().getFunctionConfig().entrySet())\n+      dimensionNames = new ArrayList<String>(config.getDimensions().size());\n+      for (DimensionSpec dimensionSpec : config.getDimensions())\n       {\n-        rollupFunctionConfig.put((String) entry.getKey(), (String) entry.getValue());\n+        dimensionNames.add(dimensionSpec.getName());\n       }\n+\n+      rollupFunctionConfig = new HashMap<String, String>();\n+      if (config.getRollup().getFunctionConfig() != null)\n+      {\n+        for (Map.Entry<Object, Object> entry : config.getRollup().getFunctionConfig().entrySet())\n+        {\n+          rollupFunctionConfig.put((String) entry.getKey(), (String) entry.getValue());\n+        }\n+      }\n+    }\n+    catch (Exception e) {\n+      throw new IllegalStateException(\"Error reading starTreeConfig \" + config.encode());\n     }\n     return new AggregationJobConfig(dimensionNames,\n                                     metricNames,",
                "deletions": 18
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Eliminate exception due to json parse error of table config zn record (#1325)\n\n* Eliminate exception due to json parse error of table config zn record\r\n\r\nIf a table config zn record fails to parse json, it is possible that controller fails to\r\ntake over leadership. We scan all table config records in PinotRealtimeSegmentManager.refreshWatchers()\r\nmethod. One of the ZN records in the list will be null, and will throw an NPE as we iterate over\r\nthe list of tables. We do catch the exception, but then attempt to log the table name from\r\nznRecord.getId(), and the log message throws an NPE\r\n\r\n* Log the NPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/a19850bbb5d7c5c4b46383e56824fcd4b8ed43b6",
        "parent": "https://github.com/apache/incubator-pinot/commit/681ca0df4be7fc338a7063c442404bb57f29f77d",
        "bug_id": "incubator-pinot_35",
        "file": [
            {
                "sha": "710c359c118746b45ac7d761d34d754c69568a53",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/a19850bbb5d7c5c4b46383e56824fcd4b8ed43b6/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/a19850bbb5d7c5c4b46383e56824fcd4b8ed43b6/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "status": "modified",
                "changes": 9,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java?ref=a19850bbb5d7c5c4b46383e56824fcd4b8ed43b6",
                "patch": "@@ -360,8 +360,13 @@ private void refreshWatchers(String path) {\n       } catch (Exception e) {\n         // we want to continue setting watches for other tables for any kind of exception here so that\n         // errors with one table don't impact others\n-        LOGGER.error(\"Caught exception while processing ZNRecord id: {}. Skipping node to continue setting watches\",\n-            tableConfigZnRecord.getId(), e);\n+        if (tableConfigZnRecord == null) {\n+          // Can happen if the table config zn record failed to parse.\n+          LOGGER.error(\"Got null ZN record for table config\", e);\n+        } else {\n+          LOGGER.error(\"Caught exception while processing ZNRecord id: {}. Skipping node to continue setting watches\",\n+              tableConfigZnRecord.getId(), e);\n+        }\n       }\n     }\n   }",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed DELETE table to not throw NPE when table has only LLC consumer type (#421)",
        "commit": "https://github.com/apache/incubator-pinot/commit/21bb2b849e6de348406516ed84ce7532703d1e2e",
        "parent": "https://github.com/apache/incubator-pinot/commit/e2992e6d1bd421ce79faad5ac4ce31cf3132739e",
        "bug_id": "incubator-pinot_36",
        "file": [
            {
                "sha": "efe20f6ce11e4615aa4b49e49524d936aa6690b6",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/21bb2b849e6de348406516ed84ce7532703d1e2e/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/21bb2b849e6de348406516ed84ce7532703d1e2e/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 6,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=21bb2b849e6de348406516ed84ce7532703d1e2e",
                "patch": "@@ -1114,8 +1114,10 @@ public void deleteRealtimeTable(String tableName) {\n     // Remove groupId/PartitionId mapping for realtime table type.\n     for (String instance : getAllInstancesForTable(realtimeTableName)) {\n       InstanceZKMetadata instanceZKMetadata = ZKMetadataProvider.getInstanceZKMetadata(getPropertyStore(), instance);\n-      instanceZKMetadata.removeResource(realtimeTableName);\n-      ZKMetadataProvider.setInstanceZKMetadata(getPropertyStore(), instanceZKMetadata);\n+      if (instanceZKMetadata != null) {\n+        instanceZKMetadata.removeResource(realtimeTableName);\n+        ZKMetadataProvider.setInstanceZKMetadata(getPropertyStore(), instanceZKMetadata);\n+      }\n     }\n \n     // dropping table",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix the bug where dropping a HLC table will throw NPE (#1666)\n\nThe reason for the NPE is that:\r\n1. We first drop the table config, then remove the Helix resource. When we rebuild IdealState, it accesses the table config, which will be null at that time.\r\n2. In the handleChildChange callback, when parentPath get removed, currentChildren will be null.\r\n\r\nUpdated RealtimeClusterIntegrationTest to test dropRealtimeTable() (also tested in HybridClusterIntegrationTest)",
        "commit": "https://github.com/apache/incubator-pinot/commit/872db00ad57d35552894c36e54c722f88a831002",
        "parent": "https://github.com/apache/incubator-pinot/commit/18a9d14a7a44c0e9e1ecceeff87f89e4dc211fac",
        "bug_id": "incubator-pinot_37",
        "file": [
            {
                "sha": "5fd39c12b9e96812931362b087947268b6571c7d",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/872db00ad57d35552894c36e54c722f88a831002/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/872db00ad57d35552894c36e54c722f88a831002/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java",
                "status": "modified",
                "changes": 57,
                "additions": 33,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotRealtimeSegmentManager.java?ref=872db00ad57d35552894c36e54c722f88a831002",
                "patch": "@@ -118,34 +118,39 @@ public void stop() {\n   private synchronized void assignRealtimeSegmentsToServerInstancesIfNecessary()\n       throws JSONException, IOException {\n     // Fetch current ideal state snapshot\n-    Map<String, IdealState> idealStateMap = new HashMap<String, IdealState>();\n+    Map<String, IdealState> idealStateMap = new HashMap<>();\n+\n+    for (String realtimeTableName : _pinotHelixResourceManager.getAllRealtimeTables()) {\n+      TableConfig tableConfig = _pinotHelixResourceManager.getTableConfig(realtimeTableName);\n+\n+      // Table config might have already been deleted\n+      if (tableConfig == null) {\n+        continue;\n+      }\n \n-    for (String resource : _pinotHelixResourceManager.getAllRealtimeTables()) {\n-      final String tableName = TableNameBuilder.extractRawTableName(resource);\n-      TableConfig tableConfig = _pinotHelixResourceManager.getRealtimeTableConfig(tableName);\n       KafkaStreamMetadata metadata = new KafkaStreamMetadata(tableConfig.getIndexingConfig().getStreamConfigs());\n       if (metadata.hasHighLevelKafkaConsumerType()) {\n-        idealStateMap.put(resource, _pinotHelixResourceManager.getHelixAdmin()\n-            .getResourceIdealState(_pinotHelixResourceManager.getHelixClusterName(), resource));\n+        idealStateMap.put(realtimeTableName, _pinotHelixResourceManager.getHelixAdmin()\n+            .getResourceIdealState(_pinotHelixResourceManager.getHelixClusterName(), realtimeTableName));\n       } else {\n         LOGGER.debug(\"Not considering table {} for realtime segment assignment\");\n       }\n     }\n \n     List<Pair<String, String>> listOfSegmentsToAddToInstances = new ArrayList<Pair<String, String>>();\n \n-    for (String resource : idealStateMap.keySet()) {\n+    for (String realtimeTableName : idealStateMap.keySet()) {\n       try {\n-        IdealState state = idealStateMap.get(resource);\n+        IdealState state = idealStateMap.get(realtimeTableName);\n \n         // Are there any partitions?\n         if (state.getPartitionSet().size() == 0) {\n           // No, this is a brand new ideal state, so we will add one new segment to every partition and replica\n-          List<String> instancesInResource = new ArrayList<String>();\n+          List<String> instancesInResource = new ArrayList<>();\n           try {\n-            instancesInResource.addAll(_pinotHelixResourceManager.getServerInstancesForTable(resource, TableType.REALTIME));\n+            instancesInResource.addAll(_pinotHelixResourceManager.getServerInstancesForTable(realtimeTableName, TableType.REALTIME));\n           } catch (Exception e) {\n-            LOGGER.error(\"Caught exception while fetching instances for resource {}\", resource, e);\n+            LOGGER.error(\"Caught exception while fetching instances for resource {}\", realtimeTableName, e);\n             _controllerMetrics.addMeteredGlobalValue(ControllerMeter.CONTROLLER_REALTIME_TABLE_SEGMENT_ASSIGNMENT_ERROR, 1L);\n           }\n \n@@ -160,15 +165,15 @@ private synchronized void assignRealtimeSegmentsToServerInstancesIfNecessary()\n               continue;\n             }\n \n-            String groupId = instanceZKMetadata.getGroupId(resource);\n-            String partitionId = instanceZKMetadata.getPartition(resource);\n+            String groupId = instanceZKMetadata.getGroupId(realtimeTableName);\n+            String partitionId = instanceZKMetadata.getPartition(realtimeTableName);\n             if (groupId != null && !groupId.isEmpty() && partitionId != null && !partitionId.isEmpty()) {\n               listOfSegmentsToAddToInstances.add(new Pair<String, String>(\n                   new HLCSegmentName(groupId, partitionId, String.valueOf(System.currentTimeMillis())).getSegmentName(),\n                   instanceId));\n             } else {\n               LOGGER.warn(\"Instance {} has invalid groupId ({}) and/or partitionId ({}) for resource {}, ignoring for segment assignment.\",\n-                  instanceId, groupId, partitionId, resource);\n+                  instanceId, groupId, partitionId, realtimeTableName);\n               _controllerMetrics.addMeteredGlobalValue(ControllerMeter.CONTROLLER_REALTIME_TABLE_SEGMENT_ASSIGNMENT_ERROR, 1L);\n             }\n           }\n@@ -177,9 +182,9 @@ private synchronized void assignRealtimeSegmentsToServerInstancesIfNecessary()\n           Set<String> instancesToAssignRealtimeSegment = new HashSet<String>();\n           try {\n             instancesToAssignRealtimeSegment.addAll(\n-                _pinotHelixResourceManager.getServerInstancesForTable(resource, TableType.REALTIME));\n+                _pinotHelixResourceManager.getServerInstancesForTable(realtimeTableName, TableType.REALTIME));\n           } catch (Exception e) {\n-            LOGGER.error(\"Caught exception while fetching instances for resource {}\", resource, e);\n+            LOGGER.error(\"Caught exception while fetching instances for resource {}\", realtimeTableName, e);\n             _controllerMetrics.addMeteredGlobalValue(ControllerMeter.CONTROLLER_REALTIME_TABLE_SEGMENT_ASSIGNMENT_ERROR, 1L);\n           }\n \n@@ -204,15 +209,15 @@ private synchronized void assignRealtimeSegmentsToServerInstancesIfNecessary()\n           // Assign a new segment to the server instances not currently processing this segment\n           for (String instanceId : instancesToAssignRealtimeSegment) {\n             InstanceZKMetadata instanceZKMetadata = _pinotHelixResourceManager.getInstanceZKMetadata(instanceId);\n-            String groupId = instanceZKMetadata.getGroupId(resource);\n-            String partitionId = instanceZKMetadata.getPartition(resource);\n+            String groupId = instanceZKMetadata.getGroupId(realtimeTableName);\n+            String partitionId = instanceZKMetadata.getPartition(realtimeTableName);\n             listOfSegmentsToAddToInstances.add(new Pair<String, String>(\n                 new HLCSegmentName(groupId, partitionId, String.valueOf(System.currentTimeMillis())).getSegmentName(),\n                 instanceId));\n           }\n         }\n       } catch (Exception e) {\n-        LOGGER.warn(\"Caught exception while processing resource {}, skipping.\", resource, e);\n+        LOGGER.warn(\"Caught exception while processing resource {}, skipping.\", realtimeTableName, e);\n         _controllerMetrics.addMeteredGlobalValue(ControllerMeter.CONTROLLER_REALTIME_TABLE_SEGMENT_ASSIGNMENT_ERROR, 1L);\n       }\n     }\n@@ -372,14 +377,18 @@ private void refreshWatchers(String path) {\n   }\n \n   @Override\n-  public void handleChildChange(String parentPath, List<String> currentChilds)\n+  public void handleChildChange(String parentPath, List<String> currentChildren)\n       throws Exception {\n     LOGGER.info(\"PinotRealtimeSegmentManager.handleChildChange: {}\", parentPath);\n     processPropertyStoreChange(parentPath);\n-    for (String table : currentChilds) {\n-      if (table.endsWith(\"_REALTIME\")) {\n-        LOGGER.info(\"PinotRealtimeSegmentManager.handleChildChange with table: {}\", parentPath + \"/\" + table);\n-        processPropertyStoreChange(parentPath + \"/\" + table);\n+\n+    // If parent path get removed, currentChildren will be null\n+    if (currentChildren != null) {\n+      for (String table : currentChildren) {\n+        if (table.endsWith(\"_REALTIME\")) {\n+          LOGGER.info(\"PinotRealtimeSegmentManager.handleChildChange with table: {}\", parentPath + \"/\" + table);\n+          processPropertyStoreChange(parentPath + \"/\" + table);\n+        }\n       }\n     }\n   }",
                "deletions": 24
            },
            {
                "sha": "d71b76f246b9ad50ef17dbb08eb806655b224d3d",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/872db00ad57d35552894c36e54c722f88a831002/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/872db00ad57d35552894c36e54c722f88a831002/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java?ref=872db00ad57d35552894c36e54c722f88a831002",
                "patch": "@@ -115,6 +115,7 @@ public void testInstanceShutdown()\n   @AfterClass\n   public void tearDown()\n       throws Exception {\n+    dropRealtimeTable(getTableName());\n     stopServer();\n     stopBroker();\n     stopController();",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-2286]: Fixing NPE in inverted index creation.",
        "commit": "https://github.com/apache/incubator-pinot/commit/42d5e69ead91d2d1ab2a226dad49055f4bc37ac4",
        "parent": "https://github.com/apache/incubator-pinot/commit/c393c8e2f3806729e43f9f5dd00bb0b4d16cfe45",
        "bug_id": "incubator-pinot_38",
        "file": [
            {
                "sha": "d70092c712b8d68ed7f5aedd0ec2b4adc0a47c5e",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/42d5e69ead91d2d1ab2a226dad49055f4bc37ac4/pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/42d5e69ead91d2d1ab2a226dad49055f4bc37ac4/pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java",
                "status": "modified",
                "changes": 8,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/creator/impl/SegmentColumnarIndexCreator.java?ref=42d5e69ead91d2d1ab2a226dad49055f4bc37ac4",
                "patch": "@@ -190,11 +190,13 @@ public void setSegmentName(String segmentName) {\n   public void seal() throws ConfigurationException, IOException {\n     for (final String column : forwardIndexCreatorMap.keySet()) {\n       forwardIndexCreatorMap.get(column).close();\n-      if (config.isCreateInvertedIndexEnabled()) {\n-        invertedIndexCreatorMap.get(column).seal();\n-      }\n       dictionaryCreatorMap.get(column).close();\n     }\n+\n+    // The map is only initialized for columns that have inverted index creation enabled.\n+    for (final String invertedColumn : invertedIndexCreatorMap.keySet()) {\n+      invertedIndexCreatorMap.get(invertedColumn).seal();\n+    }\n     writeMetadata();\n   }\n ",
                "deletions": 3
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-1978]: Fix for NPE in Retention Manager",
        "commit": "https://github.com/apache/incubator-pinot/commit/30722d3429fee28f5cba7ef6cc992338c362c68a",
        "parent": "https://github.com/apache/incubator-pinot/commit/3a533fc9625b85de2b816d92fc5b3954abf01417",
        "bug_id": "incubator-pinot_39",
        "file": [
            {
                "sha": "f59b467ecbf36c68e29e33e96f26cb3398d0db65",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/30722d3429fee28f5cba7ef6cc992338c362c68a/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/30722d3429fee28f5cba7ef6cc992338c362c68a/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java?ref=30722d3429fee28f5cba7ef6cc992338c362c68a",
                "patch": "@@ -172,6 +172,12 @@ private void updateDeletionStrategiesForEntireCluster() {\n       LOGGER.error(\"Error getting offline table config from property store!\", e);\n       return tableToDeletionStrategyMap;\n     }\n+\n+    if (offlineTableConfig == null) {\n+      LOGGER.info(\"Table config null for table: {}, treating it as refresh only table.\", offlineTableName);\n+      return tableToDeletionStrategyMap;\n+    }\n+    \n     if (offlineTableConfig.getValidationConfig().getSegmentPushType().equalsIgnoreCase(\"REFRESH\")) {\n       LOGGER.info(\"Table: {} is a refresh only table.\", offlineTableName);\n       return tableToDeletionStrategyMap;",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "fixing shema NPE\n\nRB=491262\nR=xiafu,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/dd2e6c5f55cfe03b2378103258c239ac8d6ccb27",
        "parent": "https://github.com/apache/incubator-pinot/commit/4d7029b25563d718461445e7bed98e0f1ebd8a49",
        "bug_id": "incubator-pinot_40",
        "file": [
            {
                "sha": "0bf566e391f7855ac0704f7fa503e0683c53a7b3",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/dd2e6c5f55cfe03b2378103258c239ac8d6ccb27/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/dd2e6c5f55cfe03b2378103258c239ac8d6ccb27/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java?ref=dd2e6c5f55cfe03b2378103258c239ac8d6ccb27",
                "patch": "@@ -192,7 +192,11 @@ public void setSchemaName(String schemaName) {\n \n   @JsonIgnore\n   public long getSchemaVersion() {\n+    if (schemaVersion == null) {\n+      return -1;\n+    }\n     return schemaVersion;\n+\n   }\n \n   public void setSchemaVersion(long schemaVersion) {",
                "deletions": 0
            },
            {
                "sha": "801350a4d47c13aedb5d28262d8f9137f7452bfc",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/dd2e6c5f55cfe03b2378103258c239ac8d6ccb27/pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/dd2e6c5f55cfe03b2378103258c239ac8d6ccb27/pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java?ref=dd2e6c5f55cfe03b2378103258c239ac8d6ccb27",
                "patch": "@@ -189,10 +189,10 @@ public static Boolean getClusterTenantIsolationEnabled(ZkHelixPropertyStore<ZNRe\n       if (znRecord.getSimpleFields().keySet().contains(CLUSTER_TENANT_ISOLATION_ENABLED_KEY)) {\n         return znRecord.getBooleanField(CLUSTER_TENANT_ISOLATION_ENABLED_KEY, true);\n       } else {\n-        return null;\n+        return true;\n       }\n     } else {\n-      return null;\n+      return true;\n     }\n   }\n }",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix segment deletion manager to handle deleted directory correctly (#1368)\n\nWhen deleted segment directory does not exist, segment deletion manager throws the NullPointerException because it does not check if the deleted directory path exists.\r\n- Added check for deleted directory path\r\n- Added unit test for checking when deleted segment directory does not exist",
        "commit": "https://github.com/apache/incubator-pinot/commit/46eedd56f93190b961e62a1ac855e4fa99b19e3b",
        "parent": "https://github.com/apache/incubator-pinot/commit/2c3685a19e9c152aea407172bf7ef807b57ded31",
        "bug_id": "incubator-pinot_41",
        "file": [
            {
                "sha": "4112929fd3e0485214708fccf9b691a39fe8c50b",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/SegmentDeletionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eedd56f93190b961e62a1ac855e4fa99b19e3b/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/SegmentDeletionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eedd56f93190b961e62a1ac855e4fa99b19e3b/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/SegmentDeletionManager.java",
                "status": "modified",
                "changes": 22,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/SegmentDeletionManager.java?ref=46eedd56f93190b961e62a1ac855e4fa99b19e3b",
                "patch": "@@ -31,7 +31,6 @@\n import org.apache.commons.io.FileUtils;\n import org.apache.commons.io.filefilter.AgeFileFilter;\n import org.apache.commons.io.filefilter.DirectoryFileFilter;\n-import org.apache.commons.io.filefilter.TrueFileFilter;\n import org.apache.helix.AccessOption;\n import org.apache.helix.HelixAdmin;\n import org.apache.helix.ZNRecord;\n@@ -205,21 +204,32 @@ protected void removeSegmentFromStore(String tableName, String segmentId) {\n    */\n   public void removeAgedDeletedSegments(int retentionInDays) {\n     if (_localDiskDir != null) {\n-      File targetDir = new File(_localDiskDir, DELETED_SEGMENTS);\n+      File deletedDir = new File(_localDiskDir, DELETED_SEGMENTS);\n+      // Check that the directory for deleted segments exists\n+      if (!deletedDir.isDirectory()) {\n+        LOGGER.warn(\"Deleted segment directory {} does not exist or it is not directory.\", deletedDir.getAbsolutePath());\n+        return;\n+      }\n+\n       AgeFileFilter fileFilter = new AgeFileFilter(DateTime.now().minusDays(retentionInDays).toDate());\n-      for (File currentDir : targetDir.listFiles((FileFilter) DirectoryFileFilter.DIRECTORY)) {\n+      File[] directories = deletedDir.listFiles((FileFilter) DirectoryFileFilter.DIRECTORY);\n+      // Check that the directory for deleted segments is empty\n+      if (directories == null) {\n+        LOGGER.warn(\"Deleted segment directory {} does not exist or it caused an I/O error.\", deletedDir);\n+        return;\n+      }\n+\n+      for (File currentDir : directories) {\n         // Get files that are aged\n         Collection<File> targetFiles = FileUtils.listFiles(currentDir, fileFilter, null);\n-\n         // Delete aged files\n         for (File f : targetFiles) {\n           if (!f.delete()) {\n             LOGGER.warn(\"Cannot remove file {} from deleted directory.\", f.getAbsolutePath());\n           }\n         }\n-\n         // Delete directory if it's empty\n-        if (currentDir.list().length == 0) {\n+        if (currentDir.list() != null && currentDir.list().length == 0) {\n           if (!currentDir.delete()) {\n             LOGGER.warn(\"The directory {} cannot be removed. The directory may not be empty.\", currentDir.getAbsolutePath());\n           }",
                "deletions": 6
            },
            {
                "sha": "213d319792fd44096684db058003864bf8f3b4ec",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eedd56f93190b961e62a1ac855e4fa99b19e3b/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eedd56f93190b961e62a1ac855e4fa99b19e3b/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "status": "modified",
                "changes": 10,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java?ref=46eedd56f93190b961e62a1ac855e4fa99b19e3b",
                "patch": "@@ -124,6 +124,8 @@ private void execute() {\n         LOGGER.info(\"Finished update segment metadata for entire cluster!\");\n         scanSegmentMetadataAndPurge();\n         LOGGER.info(\"Finished segment purge for entire cluster!\");\n+        removeAgedDeletedSegments();\n+        LOGGER.info(\"Finished remove aged deleted segments!\");\n       } else {\n         LOGGER.info(\"Not leader of the controller, sleep!\");\n       }\n@@ -177,12 +179,14 @@ private void scanSegmentMetadataAndPurge() {\n         LOGGER.info(\"Trying to delete {} segments for table {}\", segmentsToDelete.size(), tableName);\n         _pinotHelixResourceManager.deleteSegments(tableName, segmentsToDelete);\n       }\n-\n-      // Trigger clean-up for deleted segments from the deleted directory\n-      _pinotHelixResourceManager.getSegmentDeletionManager().removeAgedDeletedSegments(_deletedSegmentsRetentionInDays);\n     }\n   }\n \n+  private void removeAgedDeletedSegments() {\n+    // Trigger clean-up for deleted segments from the deleted directory\n+    _pinotHelixResourceManager.getSegmentDeletionManager().removeAgedDeletedSegments(_deletedSegmentsRetentionInDays);\n+  }\n+\n   private boolean shouldDeleteInProgressLLCSegment(final String segmentId, final IdealState idealState, RealtimeSegmentZKMetadata segmentZKMetadata) {\n     if (idealState == null) {\n       return false;",
                "deletions": 3
            },
            {
                "sha": "d46971640782d85e45e9e1a0a357f71375be25b4",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/util/SegmentDeletionManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eedd56f93190b961e62a1ac855e4fa99b19e3b/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/util/SegmentDeletionManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eedd56f93190b961e62a1ac855e4fa99b19e3b/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/util/SegmentDeletionManagerTest.java",
                "status": "modified",
                "changes": 15,
                "additions": 15,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/util/SegmentDeletionManagerTest.java?ref=46eedd56f93190b961e62a1ac855e4fa99b19e3b",
                "patch": "@@ -195,17 +195,32 @@ public void testRemoveDeletedSegments() throws Exception {\n     tempDir.deleteOnExit();\n     FakeDeletionManager deletionManager = new FakeDeletionManager(tempDir.getAbsolutePath(), helixAdmin, propertyStore);\n \n+    // Test delete when deleted segments directory does not exists\n+    deletionManager.removeAgedDeletedSegments(1);\n+\n     // Create deleted directory\n     String deletedDirectoryPath = tempDir + File.separator + \"Deleted_Segments\";\n     File deletedDirectory = new File(deletedDirectoryPath);\n     deletedDirectory.mkdir();\n \n+    // Test delete when deleted segments directory is empty\n+    deletionManager.removeAgedDeletedSegments(1);\n+\n     // Create dummy directories and files\n     File dummyDir1 = new File(deletedDirectoryPath + File.separator + \"dummy1\");\n     dummyDir1.mkdir();\n     File dummyDir2 = new File(deletedDirectoryPath + File.separator + \"dummy2\");\n     dummyDir2.mkdir();\n \n+    // Test delete when there is no files but some directories exist\n+    deletionManager.removeAgedDeletedSegments(1);\n+    Assert.assertEquals(dummyDir1.exists(), false);\n+    Assert.assertEquals(dummyDir2.exists(), false);\n+\n+    // Create dummy directories and files\n+    dummyDir1.mkdir();\n+    dummyDir2.mkdir();\n+\n     // Create dummy files\n     for (int i = 0; i < 3; i++) {\n       createTestFileWithAge(dummyDir1.getAbsolutePath() + File.separator + \"file\" + i, i);",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE from segment pruner by adding schema to realtime segment\nmetadata.\nFixing NPE from not in predicate.\nAdding hard coded query set to RealtimeClusterIntegrationTest.\n\nRB=470149\nR=xiafu\nA=jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/f70c106010175490dfb5951245c5bf0d29d8a2b2",
        "parent": "https://github.com/apache/incubator-pinot/commit/f95657831129b3cb9f0daaad670d6ad990b6b4a4",
        "bug_id": "incubator-pinot_42",
        "file": [
            {
                "sha": "07811a16e7f0407c87d6e97aae8a2af6e7e19645",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -116,7 +116,7 @@ public RealtimeSegmentDataManager(final RealtimeSegmentZKMetadata segmentMetadat\n     // lets create a new realtime segment\n     realtimeSegment = new RealtimeSegmentImpl(schema, FIVE_MILLION);\n     ((RealtimeSegmentImpl) (realtimeSegment)).setSegmentName(segmentMetadata.getSegmentName());\n-    ((RealtimeSegmentImpl) (realtimeSegment)).setSegmentMetadata(segmentMetadata);\n+    ((RealtimeSegmentImpl) (realtimeSegment)).setSegmentMetadata(segmentMetadata, this.schema);\n     notifier = realtimeResourceManager;\n \n     segmentStatusTask = new TimerTask() {",
                "deletions": 1
            },
            {
                "sha": "a1a083aad91b1978e0db9759be0f257563785bac",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java",
                "status": "modified",
                "changes": 19,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -40,21 +40,24 @@ public boolean prune(IndexSegment segment, BrokerRequest brokerRequest) {\n     Schema schema = segment.getSegmentMetadata().getSchema();\n     if (brokerRequest.getSelections() != null) {\n       // Check selection columns\n-      for (String columnName : brokerRequest.getSelections().getSelectionColumns()) {\n-        if ((!columnName.equalsIgnoreCase(\"*\")) && (!schema.isExisted(columnName))) {\n-          return true;\n+      if (brokerRequest.getSelections().getSelectionColumns() != null) {\n+        for (String columnName : brokerRequest.getSelections().getSelectionColumns()) {\n+          if ((!columnName.equalsIgnoreCase(\"*\")) && (!schema.isExisted(columnName))) {\n+            return true;\n+          }\n         }\n       }\n-\n       // Check columns to do sorting,\n-      for (SelectionSort selectionOrder : brokerRequest.getSelections().getSelectionSortSequence()) {\n-        if (!schema.isExisted(selectionOrder.getColumn())) {\n-          return true;\n+      if (brokerRequest.getSelections().getSelectionSortSequence() != null) {\n+        for (SelectionSort selectionOrder : brokerRequest.getSelections().getSelectionSortSequence()) {\n+          if (!schema.isExisted(selectionOrder.getColumn())) {\n+            return true;\n+          }\n         }\n       }\n     }\n     // Check groupBy columns.\n-    if (brokerRequest.getGroupBy() != null) {\n+    if ((brokerRequest.getGroupBy() != null) && (brokerRequest.getGroupBy().getColumns() != null)) {\n       for (String columnName : brokerRequest.getGroupBy().getColumns()) {\n         if (!schema.isExisted(columnName)) {\n           return true;",
                "deletions": 8
            },
            {
                "sha": "ee417c939dff500ebe100f9f157e1a439e007320",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -434,6 +434,10 @@ public void setSegmentMetadata(RealtimeSegmentZKMetadata segmentMetadata) {\n     _segmentMetadata = new SegmentMetadataImpl(segmentMetadata);\n   }\n \n+  public void setSegmentMetadata(RealtimeSegmentZKMetadata segmentMetadata, Schema schema) {\n+    _segmentMetadata = new SegmentMetadataImpl(segmentMetadata, schema);\n+  }\n+\n   @Override\n   public int getTotalDocs() {\n     return docIdSearchableOffset + 1;",
                "deletions": 0
            },
            {
                "sha": "b59013a34c35f7f62561542349436b6a4dfe4122",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -205,7 +205,7 @@ private boolean evalPredicateWithDictAndInvIdx() {\n \n         final MutableRoaringBitmap notINHolder = new MutableRoaringBitmap();\n \n-        for (int i = 0; i < dictionary.length(); i++) {\n+        for (int i = 1; i < dictionary.length(); i++) {\n           if (!notInIds.contains(new Integer(i))) {\n             notINHolder.or(invertedINdex.getDocIdSetFor(i));\n           }",
                "deletions": 1
            },
            {
                "sha": "7b4ec891eff3d6afd2bc5ffd5980e0318aad2248",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java",
                "status": "modified",
                "changes": 11,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -151,6 +151,17 @@ public SegmentMetadataImpl(RealtimeSegmentZKMetadata segmentMetadata) {\n     _indexDir = null;\n   }\n \n+  public SegmentMetadataImpl(RealtimeSegmentZKMetadata segmentMetadata, Schema schema) {\n+    this(segmentMetadata);\n+    setSchema(schema);\n+  }\n+\n+  private void setSchema(Schema schema) {\n+    for (String columnName : schema.getColumnNames()) {\n+      _schema.addSchema(columnName, schema.getFieldSpecFor(columnName));\n+    }\n+  }\n+\n   private void setTimeIntervalAndGranularity() {\n     if (_segmentMetadataPropertiesConfiguration.containsKey(V1Constants.MetadataKeys.Segment.SEGMENT_START_TIME)\n         && _segmentMetadataPropertiesConfiguration.containsKey(V1Constants.MetadataKeys.Segment.SEGMENT_END_TIME)",
                "deletions": 0
            },
            {
                "sha": "7d56bd328950e5a122aa4defb2dff3612395debd",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/BaseClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/BaseClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/BaseClusterIntegrationTest.java",
                "status": "modified",
                "changes": 23,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/BaseClusterIntegrationTest.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -317,6 +317,18 @@ public void testMultipleQueries() throws Exception {\n \n   @Test\n   public void testHardcodedQuerySet() throws Exception {\n+    for (String query : getHardCodedQuerySet()) {\n+      try {\n+        System.out.println(query);\n+        runQuery(query, Collections.singletonList(query.replace(\"'myresource.mytable'\", \"mytable\")));\n+      } catch (Exception e) {\n+        // TODO: handle exception\n+      }\n+\n+    }\n+  }\n+\n+  protected String[] getHardCodedQuerySet() {\n     String[] queries = new String[] {\n         \"select count(*) from 'myresource.mytable'\",\n         \"select sum(DepDelay) from 'myresource.mytable'\",\n@@ -343,16 +355,7 @@ public void testHardcodedQuerySet() throws Exception {\n         \"select FlightNum, avg(ArrDelay) from 'myresource.mytable' group by FlightNum TOP 100\",\n         // \"select distinctCount(Carrier) from 'myresource.mytable' where TailNum = 'D942DN' TOP 100\"\n     };\n-\n-    for (String query : queries) {\n-      try {\n-        System.out.println(query);\n-        runQuery(query, Collections.singletonList(query.replace(\"'myresource.mytable'\", \"mytable\")));\n-      } catch (Exception e) {\n-        // TODO: handle exception\n-      }\n-\n-    }\n+    return queries;\n   }\n \n   protected long getCurrentServingNumDocs() {",
                "deletions": 10
            },
            {
                "sha": "26dc3f7938c81bc44671b20f2f55ccb82feb6ffb",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/OfflineClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/OfflineClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/OfflineClusterIntegrationTest.java",
                "status": "modified",
                "changes": 29,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/OfflineClusterIntegrationTest.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -206,34 +206,7 @@ public void testMultipleQueries() throws Exception {\n   @Override\n   @Test\n   public void testHardcodedQuerySet() throws Exception {\n-    String[] queries = new String[] {\n-        \"select count(*) from 'myresource.mytable'\",\n-        \"select sum(DepDelay) from 'myresource.mytable'\",\n-        // \"select count(DepDelay) from 'myresource.mytable'\",\n-        \"select min(DepDelay) from 'myresource.mytable'\",\n-        \"select max(DepDelay) from 'myresource.mytable'\",\n-        \"select avg(DepDelay) from 'myresource.mytable'\",\n-        \"select Carrier, count(*) from 'myresource.mytable' group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where ArrDelay > 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where Cancelled = 1 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay >= 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay < 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where ArrDelay <= 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay >= 15 or ArrDelay >= 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay < 15 and ArrDelay <= 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay between 5 and 15 group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay in (2, 8, 42) group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where DepDelay not in (4, 16) group by Carrier TOP 100\",\n-        \"select Carrier, count(*) from 'myresource.mytable' where Cancelled <> 1 group by Carrier TOP 100\",\n-        \"select Carrier, min(ArrDelay) from 'myresource.mytable' group by Carrier TOP 100\",\n-        \"select Carrier, max(ArrDelay) from 'myresource.mytable' group by Carrier TOP 100\",\n-        \"select Carrier, sum(ArrDelay) from 'myresource.mytable' group by Carrier TOP 100\",\n-        \"select TailNum, avg(ArrDelay) from 'myresource.mytable' group by TailNum TOP 100\",\n-        \"select FlightNum, avg(ArrDelay) from 'myresource.mytable' group by FlightNum TOP 100\",\n-        // \"select distinctCount(Carrier) from 'myresource.mytable' where TailNum = 'D942DN' TOP 100\"\n-    };\n-\n-    for (String query : queries) {\n+    for (String query : getHardCodedQuerySet()) {\n       try {\n         System.out.println(query);\n         runQuery(query, Collections.singletonList(query.replace(\"'myresource.mytable'\", \"mytable\")));",
                "deletions": 28
            },
            {
                "sha": "6ba9e0ded5663657ce6deec0c23cc6cc5a2fa35c",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f70c106010175490dfb5951245c5bf0d29d8a2b2/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "status": "modified",
                "changes": 16,
                "additions": 15,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java?ref=f70c106010175490dfb5951245c5bf0d29d8a2b2",
                "patch": "@@ -20,6 +20,7 @@\n import java.sql.ResultSet;\n import java.sql.Statement;\n import java.util.ArrayList;\n+import java.util.Collections;\n import java.util.List;\n import java.util.concurrent.ExecutorService;\n import java.util.concurrent.Executors;\n@@ -86,7 +87,7 @@ public void setUp() throws Exception {\n \n     // Create Pinot resource and table\n     createRealtimeResource(\"myresource\", \"mytable\", \"DaysSinceEpoch\", \"daysSinceEpoch\", KafkaTestUtils.DEFAULT_ZK_STR,\n-        KAFKA_TOPIC,avroFiles.get(0));\n+        KAFKA_TOPIC, avroFiles.get(0));\n \n     // Load data into H2\n     ExecutorService executor = Executors.newCachedThreadPool();\n@@ -153,6 +154,19 @@ public void test1() {\n \n   }\n \n+  @Test\n+  public void testHardcodedQuerySet() throws Exception {\n+    for (String query : getHardCodedQuerySet()) {\n+      try {\n+        System.out.println(query);\n+        runQuery(query, Collections.singletonList(query.replace(\"'myresource.mytable'\", \"mytable\")));\n+      } catch (Exception e) {\n+        // TODO: handle exception\n+      }\n+\n+    }\n+  }\n+\n   @AfterClass\n   public void tearDown() throws Exception {\n     stopBroker();",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-2350] Fixes for bid-suggest issues\n\n1. Close operators at the end of query execution\n2. Removedlog statements that occassionally throws NullPointerException\n\nRB=616106\nG=pinot-dev-reviewers\nR=kgopalak,jfim,ssubrama,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/4d5ad2f0f2ea5383e9e891be65350fab80a9694b",
        "parent": "https://github.com/apache/incubator-pinot/commit/5b65bc4d6050ff436563c6887768653321f5af2b",
        "bug_id": "incubator-pinot_43",
        "file": [
            {
                "sha": "bb21b36ee61c1d8d29ca0daed603f360922152e6",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/SortedInvertedIndexBasedFilterOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4d5ad2f0f2ea5383e9e891be65350fab80a9694b/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/SortedInvertedIndexBasedFilterOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4d5ad2f0f2ea5383e9e891be65350fab80a9694b/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/SortedInvertedIndexBasedFilterOperator.java",
                "status": "modified",
                "changes": 2,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/SortedInvertedIndexBasedFilterOperator.java?ref=4d5ad2f0f2ea5383e9e891be65350fab80a9694b",
                "patch": "@@ -76,8 +76,6 @@ public BaseFilterBlock nextFilterBlock(BlockId BlockId) {\n \n   @Override\n   public boolean close() {\n-    LOGGER.info(\"Time spent in SortedInvertedIndexBasedFilterOperator operator:{} is {}\", this,\n-        sortedBlock.sortedDocIdSet.timeMeasure);\n     return true;\n   }\n ",
                "deletions": 2
            },
            {
                "sha": "ae5f7c4f3a0267ba87e18a5ea5090ac15abfdd1d",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/GlobalPlanImplV0.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4d5ad2f0f2ea5383e9e891be65350fab80a9694b/pinot-core/src/main/java/com/linkedin/pinot/core/plan/GlobalPlanImplV0.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4d5ad2f0f2ea5383e9e891be65350fab80a9694b/pinot-core/src/main/java/com/linkedin/pinot/core/plan/GlobalPlanImplV0.java",
                "status": "modified",
                "changes": 24,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/GlobalPlanImplV0.java?ref=4d5ad2f0f2ea5383e9e891be65350fab80a9694b",
                "patch": "@@ -53,16 +53,20 @@ public void execute() {\n     long startTime = System.currentTimeMillis();\n     PlanNode root = getRoot();\n     UResultOperator operator = (UResultOperator) root.run();\n-    long endTime1 = System.currentTimeMillis();\n-    LOGGER.info(\"InstanceResponsePlanNode.run took:\" + (endTime1 - startTime));\n-    InstanceResponseBlock instanceResponseBlock = (InstanceResponseBlock) operator.nextBlock();\n-    long endTime2 = System.currentTimeMillis();\n-    LOGGER.info(\"UResultOperator took :\" + (endTime2 - endTime1));\n-    _instanceResponseDataTable = instanceResponseBlock.getInstanceResponseDataTable();\n-    long endTime3 = System.currentTimeMillis();\n-    LOGGER.info(\"Converting to InstanceResponseBlock to DataTable took :\" + (endTime3 - endTime2));\n-    long endTime = System.currentTimeMillis();\n-    _instanceResponseDataTable.getMetadata().put(\"timeUsedMs\", \"\" + (endTime - startTime));\n+    try {\n+      long endTime1 = System.currentTimeMillis();\n+      LOGGER.info(\"InstanceResponsePlanNode.run took:\" + (endTime1 - startTime));\n+      InstanceResponseBlock instanceResponseBlock = (InstanceResponseBlock) operator.nextBlock();\n+      long endTime2 = System.currentTimeMillis();\n+      LOGGER.info(\"UResultOperator took :\" + (endTime2 - endTime1));\n+      _instanceResponseDataTable = instanceResponseBlock.getInstanceResponseDataTable();\n+      long endTime3 = System.currentTimeMillis();\n+      LOGGER.info(\"Converting to InstanceResponseBlock to DataTable took :\" + (endTime3 - endTime2));\n+      long endTime = System.currentTimeMillis();\n+      _instanceResponseDataTable.getMetadata().put(\"timeUsedMs\", \"\" + (endTime - startTime));\n+    } finally {\n+      operator.close();\n+    }\n   }\n \n   @Override",
                "deletions": 10
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "PINOT-1827: Correct schema related NullPointerExceptions\n\n* return empty Array, if no schemas are found\n* return empty Object, if schemaName is not found\n\nRB=531460\nBUG=\nG=pinot-dev-reviewers\nR=jfim\nA=jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/34ca1b8378d57a789dc6af0fb43a186a7b4aa600",
        "parent": "https://github.com/apache/incubator-pinot/commit/5b36e767fe40b5611baf9fbb668d0f9c6c63b0bc",
        "bug_id": "incubator-pinot_44",
        "file": [
            {
                "sha": "a4589e0f919370ad906bc48b713bfff38805f0ca",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSchemaRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/34ca1b8378d57a789dc6af0fb43a186a7b4aa600/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSchemaRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/34ca1b8378d57a789dc6af0fb43a186a7b4aa600/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSchemaRestletResource.java",
                "status": "modified",
                "changes": 8,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSchemaRestletResource.java?ref=34ca1b8378d57a789dc6af0fb43a186a7b4aa600",
                "patch": "@@ -77,6 +77,11 @@ public Representation get() {\n   private Representation getAllSchemas() {\n     List<String> schemaNames = manager.getSchemaNames();\n     JSONArray ret = new JSONArray();\n+\n+    if (schemaNames == null){\n+      return new StringRepresentation(ret.toString());\n+    }\n+\n     for (String schema : schemaNames) {\n       ret.put(schema);\n     }\n@@ -96,6 +101,9 @@ private Representation getSchema(\n       throws IOException {\n     LOGGER.info(\"looking for schema {}\", schemaName);\n     Schema schema = manager.getSchema(schemaName);\n+    if (schema == null) {\n+      return new StringRepresentation(\"{}\");\n+    }\n     LOGGER.info(\"schema string is : \" + schema.getJSONSchema());\n     return new StringRepresentation(schema.getJSONSchema());\n   }",
                "deletions": 0
            },
            {
                "sha": "ee7d539d4ed81b73212a3ce6e3aaa18b54b07ab9",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/34ca1b8378d57a789dc6af0fb43a186a7b4aa600/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/34ca1b8378d57a789dc6af0fb43a186a7b4aa600/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=34ca1b8378d57a789dc6af0fb43a186a7b4aa600",
                "patch": "@@ -811,7 +811,7 @@ public Schema getSchema(String schemaName) throws JsonParseException, JsonMappin\n         PinotHelixPropertyStoreZnRecordProvider.forSchema(_propertyStore);\n     LOGGER.info(\"found schema {} \", schemaName);\n     ZNRecord record = propertyStoreHelper.get(schemaName);\n-    return Schema.fromZNRecord(record);\n+    return record != null ? Schema.fromZNRecord(record) : null;\n   }\n \n   /**",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-2072]: Fix NPE in ShowClusterInfo command, due to unassigned segments",
        "commit": "https://github.com/apache/incubator-pinot/commit/e3cd68075472fbeab533b75a41d363392c51b4a5",
        "parent": "https://github.com/apache/incubator-pinot/commit/8c1055045dbb6b0d2d7a8467c97af5e9adfbff6f",
        "bug_id": "incubator-pinot_45",
        "file": [
            {
                "sha": "d33fba9959c9fe0fadfc24474a94ecb24517567f",
                "filename": "pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/ShowClusterInfoCommand.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e3cd68075472fbeab533b75a41d363392c51b4a5/pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/ShowClusterInfoCommand.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e3cd68075472fbeab533b75a41d363392c51b4a5/pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/ShowClusterInfoCommand.java",
                "status": "modified",
                "changes": 18,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/ShowClusterInfoCommand.java?ref=e3cd68075472fbeab533b75a41d363392c51b4a5",
                "patch": "@@ -72,9 +72,14 @@ public boolean execute() throws Exception {\n     clusterInfo.clusterName = _clusterName;\n \n     ZKHelixAdmin zkHelixAdmin = new ZKHelixAdmin(_zkAddress);\n-    List<String> instancesInCluster = zkHelixAdmin.getInstancesInCluster(_clusterName);\n+    if (!zkHelixAdmin.getClusters().contains(_clusterName)) {\n+      LOGGER.error(\"Cluster {} not found in {}.\", _clusterName, _zkAddress);\n+      return false;\n+    }\n \n+    List<String> instancesInCluster = zkHelixAdmin.getInstancesInCluster(_clusterName);\n     List<String> tables = zkHelixAdmin.getResourcesInCluster(_clusterName);\n+\n     ZkClient zkClient = new ZkClient(_zkAddress);\n     zkClient.setZkSerializer(new ZNRecordStreamingSerializer());\n     LOGGER.info(\"Connecting to Zookeeper at: {}\", _zkAddress);\n@@ -133,7 +138,16 @@ public boolean execute() throws Exception {\n         SegmentInfo segmentInfo = new SegmentInfo();\n         segmentInfo.name = segment;\n         Map<String, String> serverStateMapFromIS = idealState.getInstanceStateMap(segment);\n+        if (serverStateMapFromIS == null) {\n+          LOGGER.info(\"Unassigned segment {} in ideal state\", segment);\n+          serverStateMapFromIS = Collections.emptyMap();\n+        }\n         Map<String, String> serverStateMapFromEV = externalView.getStateMap(segment);\n+        if (serverStateMapFromEV == null) {\n+          LOGGER.info(\"Unassigned segment {} in external view\", segment);\n+          serverStateMapFromEV = Collections.emptyMap();\n+        }\n+\n         for (String serverName : serverStateMapFromIS.keySet()) {\n           segmentInfo.segmentStateMap.put(serverName, serverStateMapFromEV.get(serverName));\n         }\n@@ -145,7 +159,7 @@ public boolean execute() throws Exception {\n     StringWriter sw = new StringWriter();\n     yaml.dump(clusterInfo, sw);\n     LOGGER.info(sw.toString());\n-    return false;\n+    return true;\n   }\n \n   private String stripTypeFromName(String tableName) {",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NullPointerException during getSegmentInfo.\nReturn Empty response instead of null if routing table contains nothing,\nthis is corresponding to querying a table without any data.\n\nRB=487835\nR=xiafu\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/5084cd5ff836143fc08e1f6ce6a70548f18a5693",
        "parent": "https://github.com/apache/incubator-pinot/commit/42a905c939055a86fb0f7bccc842f34b4cc8853b",
        "bug_id": "incubator-pinot_46",
        "file": [
            {
                "sha": "34e7c18edacbbe6ac16b0d96a0d11f60daacfc63",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/reslet/resources/v2/PinotSegmentUploadRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/5084cd5ff836143fc08e1f6ce6a70548f18a5693/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/reslet/resources/v2/PinotSegmentUploadRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/5084cd5ff836143fc08e1f6ce6a70548f18a5693/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/reslet/resources/v2/PinotSegmentUploadRestletResource.java",
                "status": "modified",
                "changes": 15,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/reslet/resources/v2/PinotSegmentUploadRestletResource.java?ref=5084cd5ff836143fc08e1f6ce6a70548f18a5693",
                "patch": "@@ -106,11 +106,14 @@ public Representation get() {\n \n       } else if ((tableName != null) && (segmentName == null)) {\n         final JSONArray ret = new JSONArray();\n-        for (final File file : new File(baseDataDir, tableName).listFiles()) {\n-          final String url =\n-              \"http://\" + StringUtil.join(\":\", conf.getControllerVipHost(), conf.getControllerPort()) + \"/segments/\"\n-                  + tableName + \"/\" + file.getName();\n-          ret.put(url);\n+        File tableDir = new File(baseDataDir, tableName);\n+        if (tableDir.exists()) {\n+          for (final File file : tableDir.listFiles()) {\n+            final String url =\n+                \"http://\" + StringUtil.join(\":\", conf.getControllerVipHost(), conf.getControllerPort()) + \"/segments/\"\n+                    + tableName + \"/\" + file.getName();\n+            ret.put(url);\n+          }\n         }\n         presentation = new StringRepresentation(ret.toString());\n         return presentation;\n@@ -121,7 +124,7 @@ public Representation get() {\n         presentation = new FileRepresentation(dataFile, MediaType.ALL, 0);\n         return presentation;\n       }\n-      presentation = new StringRepresentation(\"this is a string\");\n+      presentation = new StringRepresentation(\"Table or segment is not found!\");\n     } catch (final Exception e) {\n       presentation = exceptionToStringRepresentation(e);\n       LOGGER.error(\"Caught exception while processing get request\", e);",
                "deletions": 6
            },
            {
                "sha": "07486f9f576ffb61390378a539f947a3a217ed59",
                "filename": "pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/5084cd5ff836143fc08e1f6ce6a70548f18a5693/pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/5084cd5ff836143fc08e1f6ce6a70548f18a5693/pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java?ref=5084cd5ff836143fc08e1f6ce6a70548f18a5693",
                "patch": "@@ -238,7 +238,7 @@ private Object getDataTableFromBrokerRequest(final BrokerRequest request, Bucket\n     Map<ServerInstance, SegmentIdSet> segmentServices = _routingTable.findServers(rtRequest);\n     if (segmentServices == null || segmentServices.isEmpty()) {\n       LOGGER.debug(\"Not found ServerInstances to Segments Mapping:\");\n-      return null;\n+      return BrokerResponse.getEmptyBrokerResponse();\n     }\n     LOGGER.debug(\"Find ServerInstances to Segments Mapping:\");\n     for (ServerInstance serverInstance : segmentServices.keySet()) {",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "THIRDEYE-525 : NPE in SlideshowViewThirdeyeDaily_aggregation\n\nRB=539969\nBUG=\nG=\nR=kgopalak,gbrandt\nA=gbrandt",
        "commit": "https://github.com/apache/incubator-pinot/commit/2e9468d955778afc9a136781395bfaaafb949733",
        "parent": "https://github.com/apache/incubator-pinot/commit/44db8707f6bf70d4a6f77e27beb38345cfefc884",
        "bug_id": "incubator-pinot_47",
        "file": [
            {
                "sha": "82c39abb96c2b5db7e1f9d886e35850c97a0547b",
                "filename": "thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/2e9468d955778afc9a136781395bfaaafb949733/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/2e9468d955778afc9a136781395bfaaafb949733/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java",
                "status": "modified",
                "changes": 8,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/aggregation/AggregationJobConfig.java?ref=2e9468d955778afc9a136781395bfaaafb949733",
                "patch": "@@ -103,7 +103,13 @@ public static AggregationJobConfig fromStarTreeConfig(StarTreeConfig config) thr\n       }\n     }\n     catch (Exception e) {\n-      throw new IllegalStateException(\"The config must contain dimensions and metrics : \" + config.encode(), e);\n+      if (config.getMetrics() == null) {\n+        throw new IllegalStateException(\"Metrics missing from config : \" + config.encode(), e);\n+      } else if (config.getDimensions() == null) {\n+        throw new IllegalStateException(\"Dimensions missing from config : \" + config.encode(), e);\n+      } else {\n+        throw new IllegalStateException(\"Error reading config : \" + config.encode(), e);\n+      }\n     }\n     return new AggregationJobConfig(dimensionNames,\n                                     metricNames,",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Merge pull request #17 from fx19880617/master\n\nFixing realtime retention NPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/319e1aa8d6e1ed3b1a129606df6731d662204520",
        "parent": "https://github.com/apache/incubator-pinot/commit/c875cc0a91046c21f5cfd53fbb98a24c13ce34b1",
        "bug_id": "incubator-pinot_48",
        "file": [
            {
                "sha": "c678b2ebd3860351cfbfaeba612928546634af89",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/319e1aa8d6e1ed3b1a129606df6731d662204520/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/319e1aa8d6e1ed3b1a129606df6731d662204520/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java?ref=319e1aa8d6e1ed3b1a129606df6731d662204520",
                "patch": "@@ -191,7 +191,7 @@ private void updateDeletionStrategiesForEntireCluster() {\n \n     AbstractTableConfig realtimeTableConfig;\n     try {\n-      realtimeTableConfig = ZKMetadataProvider.getOfflineTableConfig(_pinotHelixResourceManager.getPropertyStore(), realtimeTableName);\n+      realtimeTableConfig = ZKMetadataProvider.getRealtimeTableConfig(_pinotHelixResourceManager.getPropertyStore(), realtimeTableName);\n     } catch (Exception e) {\n       LOGGER.error(\"Error getting realtime table config from property store!\", e);\n       return tableToDeletionStrategyMap;",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "NPE fix\n\nRB=495083\nR=kgopalak,xiafu,jfim,dpatel\nA=dpatel",
        "commit": "https://github.com/apache/incubator-pinot/commit/08a29193b546f652002f3f80ca7046fa41405953",
        "parent": "https://github.com/apache/incubator-pinot/commit/aad717eb4050a375ef586d7f638204fc5079902d",
        "bug_id": "incubator-pinot_49",
        "file": [
            {
                "sha": "c5e25ba62e432793947ddb60f57a2437ecebcca3",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/08a29193b546f652002f3f80ca7046fa41405953/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/08a29193b546f652002f3f80ca7046fa41405953/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/data/Schema.java?ref=08a29193b546f652002f3f80ca7046fa41405953",
                "patch": "@@ -252,7 +252,7 @@ public boolean evaluate(Object object) {\n \n   @JsonIgnore(true)\n   public String getTimeColumnName() {\n-    return timeFieldSpec.getName();\n+    return (timeFieldSpec != null) ? timeFieldSpec.getName() : null;\n   }\n \n   public TimeFieldSpec getTimeFieldSpec() {",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "NPE fix\n\nRB=494158\nR=kgopalak,xiafu,jfim,dpatel\nA=jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/7d7d361c687688eed71063cae7eb0e3aa8e40414",
        "parent": "https://github.com/apache/incubator-pinot/commit/8a4f6e4ee4c6ea59f1b8a2c60f448822adf409f3",
        "bug_id": "incubator-pinot_50",
        "file": [
            {
                "sha": "1d27aec3cda374177fe665889cccff8f6dce8e9d",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/CSVRecordReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/7d7d361c687688eed71063cae7eb0e3aa8e40414/pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/CSVRecordReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/7d7d361c687688eed71063cae7eb0e3aa8e40414/pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/CSVRecordReader.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/CSVRecordReader.java?ref=7d7d361c687688eed71063cae7eb0e3aa8e40414",
                "patch": "@@ -54,7 +54,7 @@ public CSVRecordReader(String dataFile, RecordReaderConfig config, Schema schema\n     _schema = schema;\n \n     _config = config;\n-    _delimiterString = _config.getCsvDelimiter();\n+    _delimiterString = (_config != null) ? _config.getCsvDelimiter() : \",\";\n   }\n \n   @Override\n@@ -112,15 +112,15 @@ public void close() throws Exception {\n   }\n \n   private String getValueForColumn(CSVRecord record, String column) {\n-    if (_config.columnIsDate(column)) {\n+    if ((_config != null) && (_config.columnIsDate(column))) {\n       return dateToDaysSinceEpochMilli(record.get(column)).toString();\n     } else {\n       return record.get(column);\n     }\n   }\n \n   private Long dateToDaysSinceEpochMilli(String token) {\n-    if (token == null) {\n+    if ((token == null) || (_config == null)) {\n       return 0L;\n     }\n ",
                "deletions": 3
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed NPE on broker startup\n\nRB=490524\nR=kgopalak,xiafu,jfim,dpatel,mshrivas\nA=xiafu",
        "commit": "https://github.com/apache/incubator-pinot/commit/c292bc197322f120459e53deae98445c48d22343",
        "parent": "https://github.com/apache/incubator-pinot/commit/9bd2f4e3916a0a930d61239b537e406d1626cac2",
        "bug_id": "incubator-pinot_51",
        "file": [
            {
                "sha": "1a4f19d210b5f541de9ab3b44b5e44268bd2ad10",
                "filename": "pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/StartBrokerCommand.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/c292bc197322f120459e53deae98445c48d22343/pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/StartBrokerCommand.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/c292bc197322f120459e53deae98445c48d22343/pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/StartBrokerCommand.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-tools/src/main/java/com/linkedin/pinot/tools/admin/command/StartBrokerCommand.java?ref=c292bc197322f120459e53deae98445c48d22343",
                "patch": "@@ -89,6 +89,7 @@ public boolean execute() throws Exception {\n \n     configuration.addProperty(CommonConstants.Helix.KEY_OF_BROKER_QUERY_PORT, _queryPort);\n     configuration.setProperty(\"instanceId\", brokerInstanceName);\n+    configuration.setProperty(\"pinot.broker.routing.table.builder.class\", \"random\");\n \n     final HelixBrokerStarter pinotHelixBrokerStarter =\n         new HelixBrokerStarter(_clusterName, _zkAddress, configuration);",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE in getting routing table builder\n\nRB=489957\nR=xiafu\nA=jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/7c70b577a586c184d8cd635d2850c3946f1de149",
        "parent": "https://github.com/apache/incubator-pinot/commit/a699a293905cbfff80a37b66d4949c2c838f660b",
        "bug_id": "incubator-pinot_52",
        "file": [
            {
                "sha": "5c0f87b8073950105f900eac8bb9db92f241a2e7",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/HelixBrokerStarter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/7c70b577a586c184d8cd635d2850c3946f1de149/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/HelixBrokerStarter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/7c70b577a586c184d8cd635d2850c3946f1de149/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/HelixBrokerStarter.java",
                "status": "modified",
                "changes": 9,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/HelixBrokerStarter.java?ref=7c70b577a586c184d8cd635d2850c3946f1de149",
                "patch": "@@ -145,8 +145,13 @@ private void addInstanceTagIfNeeded(String clusterName, String instanceName) {\n   }\n \n   private RoutingTableBuilder getRoutingTableBuilder(Configuration routingTableBuilderConfig) {\n-    String routingTableBuilderKey = routingTableBuilderConfig.getString(\"class\", null);\n-    RoutingTableBuilder routingTableBuilder = RoutingTableBuilderFactory.get(routingTableBuilderKey);\n+    RoutingTableBuilder routingTableBuilder;\n+    try {\n+      String routingTableBuilderKey = routingTableBuilderConfig.getString(\"class\", null);\n+      routingTableBuilder = RoutingTableBuilderFactory.get(routingTableBuilderKey);\n+    } catch (Exception e) {\n+      return null;\n+    }\n     if (routingTableBuilder == null) {\n       return null;\n     }",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix LLC consumer to handle segment build fails gracefully (#2499)\n\n* Fix LLC consumer to handle segment build fails gracefully\r\n\r\nIf segment build fails then we used throw NPE while tyring to delete a null file name.\r\nFixed the condition, and added a test.\r\nWe now handle the condition gracefully, and also set LLC_PARTITION_CONSUMING gauge to 0\r\nso that we can alert on the partition that stopped consumption.\r\n\r\n* Modified comment",
        "commit": "https://github.com/apache/incubator-pinot/commit/5cb7839f5f8978eaae2a9c31aba72234bad6660e",
        "parent": "https://github.com/apache/incubator-pinot/commit/ccaa9f5ed02bcd26af78ffc1d4c1126b180566ad",
        "bug_id": "incubator-pinot_53",
        "file": [
            {
                "sha": "ebb23717ff1c3437d78965f1072b4d00199559d8",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/5cb7839f5f8978eaae2a9c31aba72234bad6660e/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/5cb7839f5f8978eaae2a9c31aba72234bad6660e/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManager.java",
                "status": "modified",
                "changes": 6,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManager.java?ref=5cb7839f5f8978eaae2a9c31aba72234bad6660e",
                "patch": "@@ -139,7 +139,11 @@ public String getSegmentFile() {\n     }\n \n     public void deleteSegmentFile() {\n-      FileUtils.deleteQuietly(new File(_segmentFile));\n+      // If segment build fails with an exception then we will not be able to create a segment file and\n+      // the file name will be null.\n+      if (_segmentFile != null) {\n+        FileUtils.deleteQuietly(new File(_segmentFile));\n+      }\n     }\n   }\n ",
                "deletions": 1
            },
            {
                "sha": "d3bb18289fb009a6969b4153f07a292bd73fa1b5",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/5cb7839f5f8978eaae2a9c31aba72234bad6660e/pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/5cb7839f5f8978eaae2a9c31aba72234bad6660e/pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java",
                "status": "modified",
                "changes": 23,
                "additions": 23,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java?ref=5cb7839f5f8978eaae2a9c31aba72234bad6660e",
                "patch": "@@ -252,6 +252,25 @@ public void testCommitAfterHold() throws Exception {\n     Assert.assertEquals(segmentDataManager._state.get(segmentDataManager), LLRealtimeSegmentDataManager.State.COMMITTED);\n   }\n \n+  @Test\n+  public void testSegmentBuildException() throws Exception {\n+    FakeLLRealtimeSegmentDataManager segmentDataManager = createFakeSegmentManager();\n+    LLRealtimeSegmentDataManager.PartitionConsumer consumer = segmentDataManager.createPartitionConsumer();\n+    final long endOffset = _startOffset + 500;\n+    // We should consume initially...\n+    segmentDataManager._consumeOffsets.add(endOffset);\n+    final SegmentCompletionProtocol.Response commitResponse = new SegmentCompletionProtocol.Response(\n+        new SegmentCompletionProtocol.Response.Params().withOffset(endOffset).withStatus(\n+            SegmentCompletionProtocol.ControllerResponseStatus.COMMIT));\n+    segmentDataManager._responses.add(commitResponse);\n+    segmentDataManager._failSegmentBuild = true;\n+\n+    consumer.run();\n+    Assert.assertTrue(segmentDataManager._buildSegmentCalled);\n+    Assert.assertEquals(segmentDataManager._state.get(segmentDataManager), LLRealtimeSegmentDataManager.State.ERROR);\n+  }\n+\n+\n   // Test hold, catchup. hold, commit\n   @Test\n   public void testCommitAfterCatchup() throws Exception {\n@@ -627,6 +646,7 @@ public void testFileRemovedDuringOnlineTransition() throws Exception {\n     public LinkedList<SegmentCompletionProtocol.Response> _responses = new LinkedList<>();\n     public boolean _commitSegmentCalled = false;\n     public boolean _buildSegmentCalled = false;\n+    public boolean _failSegmentBuild = false;\n     public boolean _buildAndReplaceCalled = false;\n     public int _stopWaitTimeMs = 100;\n     private boolean _downloadAndReplaceCalled = false;\n@@ -760,6 +780,9 @@ protected boolean buildSegmentAndReplace() {\n     @Override\n     protected String buildSegmentInternal(boolean forCommit) {\n       _buildSegmentCalled = true;\n+      if (_failSegmentBuild) {\n+        return null;\n+      }\n       if (!forCommit) {\n         return _segmentDir;\n       }",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "THIRDEYE-335 : DELETE of collection resulted in NPE\n\nRB=471549\nR=kgopalak,gbrandt\nA=gbrandt",
        "commit": "https://github.com/apache/incubator-pinot/commit/1b8be226b0084cbd6ae246a1e86df9aad5f95045",
        "parent": "https://github.com/apache/incubator-pinot/commit/05ba487d43ea015fddd1d903257da9118264983e",
        "bug_id": "incubator-pinot_54",
        "file": [
            {
                "sha": "00b94cac4fd53a8d9015dd42e413da5ba0f59751",
                "filename": "thirdeye/thirdeye-core/src/main/java/com/linkedin/thirdeye/impl/StarTreeImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1b8be226b0084cbd6ae246a1e86df9aad5f95045/thirdeye/thirdeye-core/src/main/java/com/linkedin/thirdeye/impl/StarTreeImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1b8be226b0084cbd6ae246a1e86df9aad5f95045/thirdeye/thirdeye-core/src/main/java/com/linkedin/thirdeye/impl/StarTreeImpl.java",
                "status": "modified",
                "changes": 6,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-core/src/main/java/com/linkedin/thirdeye/impl/StarTreeImpl.java?ref=1b8be226b0084cbd6ae246a1e86df9aad5f95045",
                "patch": "@@ -251,7 +251,11 @@ public void close() throws IOException {\n \n   private void close(StarTreeNode node) throws IOException {\n     if (node.isLeaf()) {\n-      node.getRecordStore().close();\n+      if (node.getRecordStore() != null) {\n+        node.getRecordStore().close();\n+      } else {\n+        throw new IllegalStateException(\"Cannot close null record store for leaf node \"+node.getId());\n+      }\n     } else {\n       for (StarTreeNode child : node.getChildren()) {\n         close(child);",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE from uploading large segment.\n\nRB=458028\nR=xiafu\nA=jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/75063b91d6eb1450afe481998343028ddbc947cf",
        "parent": "https://github.com/apache/incubator-pinot/commit/eb98e5dfc35aa03638c6b6bb08636d631eac7d76",
        "bug_id": "incubator-pinot_55",
        "file": [
            {
                "sha": "07d35ca12c4bacebe6a25e7248dd61e1b1310438",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/75063b91d6eb1450afe481998343028ddbc947cf/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/75063b91d6eb1450afe481998343028ddbc947cf/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 14,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=75063b91d6eb1450afe481998343028ddbc947cf",
                "patch": "@@ -940,7 +940,7 @@ private boolean updateExistedSegment(SegmentZKMetadata segmentZKMetadata) {\n         idealState.setPartitionState(segmentName, instance, \"OFFLINE\");\n       }\n       updateSuccessful = helixDataAccessor.updateProperty(idealStatePropertyKey, idealState);\n-    } while(!updateSuccessful);\n+    } while (!updateSuccessful);\n \n     // Wait until the partitions are offline in the external view\n     LOGGER.info(\"Wait until segment - \" + segmentName + \" to be OFFLINE in ExternalView\");\n@@ -958,7 +958,7 @@ private boolean updateExistedSegment(SegmentZKMetadata segmentZKMetadata) {\n         idealState.setPartitionState(segmentName, instance, \"ONLINE\");\n       }\n       updateSuccessful = helixDataAccessor.updateProperty(idealStatePropertyKey, idealState);\n-    } while(!updateSuccessful);\n+    } while (!updateSuccessful);\n \n     LOGGER.info(\"Refresh is done for segment - \" + segmentName);\n     return true;\n@@ -977,10 +977,14 @@ private boolean ifExternalViewChangeReflectedForState(String resourceName, Strin\n       isSucess = true;\n       ExternalView externalView = _helixAdmin.getResourceExternalView(_helixClusterName, resourceName);\n       Map<String, String> segmentStatsMap = externalView.getStateMap(segmentName);\n-      for (String instance : segmentStatsMap.keySet()) {\n-        if (!segmentStatsMap.get(instance).equalsIgnoreCase(targerStates)) {\n-          isSucess = false;\n+      if (segmentStatsMap != null) {\n+        for (String instance : segmentStatsMap.keySet()) {\n+          if (!segmentStatsMap.get(instance).equalsIgnoreCase(targerStates)) {\n+            isSucess = false;\n+          }\n         }\n+      } else {\n+        isSucess = false;\n       }\n       if (isSucess) {\n         break;",
                "deletions": 5
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix the NPE in MCombineOperator when query timed out (#1335)\n\nCause: the merge Callable will return null when the query timed out.\r\nFix: remove the timeout control inside the Callable, add early terminate when query timed out.",
        "commit": "https://github.com/apache/incubator-pinot/commit/4dcb7cc8f8705a36fbf12380718acc4bcbff331c",
        "parent": "https://github.com/apache/incubator-pinot/commit/adcf8cd98d5676bb329420943782312917037219",
        "bug_id": "incubator-pinot_56",
        "file": [
            {
                "sha": "6f31d26f8958cee29f51e4ab327cce5044e0391e",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4dcb7cc8f8705a36fbf12380718acc4bcbff331c/pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4dcb7cc8f8705a36fbf12380718acc4bcbff331c/pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java",
                "status": "modified",
                "changes": 30,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java?ref=4dcb7cc8f8705a36fbf12380718acc4bcbff331c",
                "patch": "@@ -47,18 +47,18 @@\n   private final List<Operator> _operators;\n   private final BrokerRequest _brokerRequest;\n   private final ExecutorService _executorService;\n-  private long _timeOutMs;\n+  private final long _timeOutMs;\n   //Make this configurable\n   //These two control the parallelism on a per query basis, depending on the number of segments to process\n-  private static int MIN_THREADS_PER_QUERY = 10;\n-  private static int MAX_THREADS_PER_QUERY = 10;\n-  private static int MIN_SEGMENTS_PER_THREAD = 10;\n+  private static final int MIN_THREADS_PER_QUERY;\n+  private static final int MAX_THREADS_PER_QUERY;\n+  private static final int MIN_SEGMENTS_PER_THREAD = 10;\n \n   static {\n     int numCores = Runtime.getRuntime().availableProcessors();\n     MIN_THREADS_PER_QUERY = Math.max(1, (int) (numCores * .5));\n     //Dont have more than 10 threads per query\n-    MAX_THREADS_PER_QUERY = Math.min(MAX_THREADS_PER_QUERY, (int) (numCores * .5));\n+    MAX_THREADS_PER_QUERY = Math.min(10, (int) (numCores * .5));\n   }\n \n   public MCombineOperator(List<Operator> operators, ExecutorService executorService, long timeOutMs,\n@@ -81,18 +81,20 @@ public boolean open() {\n   public Block getNextBlock() {\n     final long startTime = System.currentTimeMillis();\n     final long queryEndTime = System.currentTimeMillis() + _timeOutMs;\n-    int numGroups = Math.max(MIN_THREADS_PER_QUERY,\n-        Math.min(MAX_THREADS_PER_QUERY, (_operators.size() + MIN_SEGMENTS_PER_THREAD - 1) / MIN_SEGMENTS_PER_THREAD));\n-    //ensure that the number of groups is not more than the number of segments\n-    numGroups = Math.min(_operators.size(), numGroups);\n-    final List<List<Operator>> operatorGroups = new ArrayList<List<Operator>>(numGroups);\n+    final int numOperators = _operators.size();\n+    // Ensure that the number of groups is not more than the number of segments\n+    final int numGroups = Math.min(numOperators, Math.max(MIN_THREADS_PER_QUERY,\n+        Math.min(MAX_THREADS_PER_QUERY, (numOperators + MIN_SEGMENTS_PER_THREAD - 1) / MIN_SEGMENTS_PER_THREAD)));\n+\n+    final List<List<Operator>> operatorGroups = new ArrayList<>(numGroups);\n     for (int i = 0; i < numGroups; i++) {\n       operatorGroups.add(new ArrayList<Operator>());\n     }\n-    for (int i = 0; i < _operators.size(); i++) {\n+    for (int i = 0; i < numOperators; i++) {\n       operatorGroups.get(i % numGroups).add(_operators.get(i));\n     }\n-    final BlockingQueue<Block> blockingQueue = new ArrayBlockingQueue<>(operatorGroups.size());\n+\n+    final BlockingQueue<Block> blockingQueue = new ArrayBlockingQueue<>(numGroups);\n     // Submit operators.\n     for (final List<Operator> operatorGroup : operatorGroups) {\n       _executorService.submit(new TraceRunnable() {\n@@ -118,6 +120,7 @@ public void runJob() {\n             LOGGER.error(\"Caught exception while executing query.\", e);\n             mergedBlock = new IntermediateResultsBlock(e);\n           }\n+          assert mergedBlock != null;\n           blockingQueue.offer(mergedBlock);\n         }\n       });\n@@ -132,7 +135,7 @@ public IntermediateResultsBlock callJob()\n               throws Exception {\n             int mergedBlocksNumber = 0;\n             IntermediateResultsBlock mergedBlock = null;\n-            while ((queryEndTime > System.currentTimeMillis()) && (mergedBlocksNumber < operatorGroups.size())) {\n+            while (mergedBlocksNumber < numGroups) {\n               if (mergedBlock == null) {\n                 mergedBlock = (IntermediateResultsBlock) blockingQueue.poll(queryEndTime - System.currentTimeMillis(),\n                     TimeUnit.MILLISECONDS);\n@@ -176,6 +179,7 @@ public IntermediateResultsBlock callJob()\n       mergedBlock = new IntermediateResultsBlock(QueryException.getException(QueryException.MERGE_RESPONSE_ERROR, e));\n     } catch (TimeoutException e) {\n       LOGGER.error(\"Caught TimeoutException\", e);\n+      mergedBlockFuture.cancel(true);\n       mergedBlock =\n           new IntermediateResultsBlock(QueryException.getException(QueryException.EXECUTION_TIMEOUT_ERROR, e));\n     }",
                "deletions": 13
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed NPE\n\nRB=452779\nR=kgopalak,xiafu,jfim,dpatel\nA=pneppall",
        "commit": "https://github.com/apache/incubator-pinot/commit/1696da4c6e7226349e9bcea36097a1ab5c256537",
        "parent": "https://github.com/apache/incubator-pinot/commit/9fd90799603c105e22111e0874915d44503105fd",
        "bug_id": "incubator-pinot_57",
        "file": [
            {
                "sha": "9910a0cb6c3c5de5762f6b9dc4c5c13431ebf3bb",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/1696da4c6e7226349e9bcea36097a1ab5c256537/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/1696da4c6e7226349e9bcea36097a1ab5c256537/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 7,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=1696da4c6e7226349e9bcea36097a1ab5c256537",
                "patch": "@@ -904,13 +904,12 @@ public synchronized PinotResourceManagerResponse addSegment(SegmentMetadata segm\n   }\n \n   private boolean updateExistedSegment(SegmentZKMetadata segmentZKMetadata) {\n-    String resourceName = null;\n+    final String resourceName;\n     if (segmentZKMetadata instanceof RealtimeSegmentZKMetadata) {\n-      resourceName = BrokerRequestUtils.buildRealtimeResourceNameForResource(resourceName);\n+      resourceName = BrokerRequestUtils.buildRealtimeResourceNameForResource(segmentZKMetadata.getResourceName());\n     } else {\n-      resourceName = BrokerRequestUtils.getOfflineResourceNameForResource(resourceName);\n+      resourceName = BrokerRequestUtils.getOfflineResourceNameForResource(segmentZKMetadata.getResourceName());\n     }\n-    segmentZKMetadata.getResourceName();\n     final String segmentName = segmentZKMetadata.getSegmentName();\n \n     final IdealState currentIdealState = _helixAdmin.getResourceIdealState(_helixClusterName, resourceName);",
                "deletions": 4
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "TE: adding improvements for task driver (#467)\n\n* TE: adding improvements for task driver\r\n\r\n* removing another NPE from DetectionTaskRunner\r\n\r\n* randomizing start time for task workers",
        "commit": "https://github.com/apache/incubator-pinot/commit/77726cb01d1d7ac596bccefb71bfeb8c5099b055",
        "parent": "https://github.com/apache/incubator-pinot/commit/730dc153e62fdcabd61770f6f5f197364b8fd488",
        "bug_id": "incubator-pinot_58",
        "file": [
            {
                "sha": "17a654931b55836498d6dbd42ce4c736e49b17ad",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/ThirdEyeAnomalyApplication.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/ThirdEyeAnomalyApplication.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/ThirdEyeAnomalyApplication.java",
                "status": "modified",
                "changes": 3,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/ThirdEyeAnomalyApplication.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -33,7 +33,7 @@\n   private AnomalyMergeExecutor anomalyMergeExecutor = null;\n \n   public static void main(final String[] args) throws Exception {\n-    List<String> argList = new ArrayList<String>(Arrays.asList(args));\n+    List<String> argList = new ArrayList<>(Arrays.asList(args));\n     if (argList.size() == 1) {\n       argList.add(0, \"server\");\n     }\n@@ -62,7 +62,6 @@ public void run(final ThirdEyeAnomalyConfiguration config, final Environment env\n     LOG.info(\"Starting ThirdeyeAnomalyApplication : Scheduler {} Worker {}\", config.isScheduler(), config.isWorker());\n     super.initDAOs();\n     ThirdEyeCacheRegistry.initializeCaches(config, webappConfigDAO);\n-\n     environment.lifecycle().manage(new Managed() {\n       @Override\n       public void start() throws Exception {",
                "deletions": 2
            },
            {
                "sha": "2bd55a6ccc2e576d4e5572a3228677a02b367386",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/detection/DetectionTaskRunner.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/detection/DetectionTaskRunner.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/detection/DetectionTaskRunner.java",
                "status": "modified",
                "changes": 5,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/detection/DetectionTaskRunner.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -91,12 +91,11 @@ public DetectionTaskRunner() {\n \n     CollectionSchema collectionSchema = null;\n     try {\n-      collectionSchema = CACHE_REGISTRY_INSTANCE.getCollectionSchemaCache()\n-          .get(anomalyFunctionSpec.getCollection());\n+      collectionSchema = CACHE_REGISTRY_INSTANCE.getCollectionSchemaCache().get(anomalyFunctionSpec.getCollection());\n+      collectionDimensions = collectionSchema.getDimensionNames();\n     } catch (Exception e) {\n       LOG.error(\"Exception when reading collection schema cache\", e);\n     }\n-    collectionDimensions = collectionSchema.getDimensionNames();\n \n     // Get existing anomalies for this time range\n     knownAnomalies = getExistingAnomalies();",
                "deletions": 3
            },
            {
                "sha": "6485c490af342c59e3a2bd0a6562d17b5250feb7",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/job/JobRunner.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/job/JobRunner.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/job/JobRunner.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/job/JobRunner.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -7,6 +7,6 @@\n  */\n public interface JobRunner extends Runnable {\n \n-  long createJob();\n+  Long createJob();\n   List<Long> createTasks();\n }",
                "deletions": 1
            },
            {
                "sha": "9251fe6146ab12254fea393d941e2acb8eb041e1",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorConstants.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorConstants.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorConstants.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorConstants.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -6,7 +6,7 @@\n     EXPIRE\n   }\n \n-  public static int DEFAULT_EXPIRE_DAYS_AGO = 7;\n+  public static int DEFAULT_EXPIRE_DAYS_AGO = 3;\n   public static int DEFAULT_MONITOR_FREQUENCY_HOURS = 1;\n \n }",
                "deletions": 1
            },
            {
                "sha": "f37a6c5425894b5facf72e382753782a4d6b264a",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorJobRunner.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorJobRunner.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorJobRunner.java",
                "status": "modified",
                "changes": 11,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/monitor/MonitorJobRunner.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -45,16 +45,17 @@ public void run() {\n       List<AnomalyJobSpec> anomalyJobSpecs = findAnomalyJobsWithStatusScheduled();\n       monitorJobContext.setJobName(TaskType.MONITOR.toString());\n       monitorJobContext.setAnomalyJobSpecs(anomalyJobSpecs);\n-      long jobExecutionId = createJob();\n-      monitorJobContext.setJobExecutionId(jobExecutionId);\n-      List<Long> taskIds = createTasks();\n-\n+      Long jobExecutionId = createJob();\n+      if (jobExecutionId != null) {\n+        monitorJobContext.setJobExecutionId(jobExecutionId);\n+        List<Long> taskIds = createTasks();\n+      }\n     } catch (Exception e) {\n       LOG.error(\"Exception in monitor job runner\", e);\n     }\n   }\n \n-  public long createJob() {\n+  public Long createJob() {\n     Long jobExecutionId = null;\n     try {\n ",
                "deletions": 5
            },
            {
                "sha": "a1d5922a9a7ad7711d7b2084cd8fd0cda305fc20",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java",
                "status": "modified",
                "changes": 90,
                "additions": 47,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/task/TaskDriver.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -7,6 +7,7 @@\n \n import java.util.ArrayList;\n import java.util.List;\n+import java.util.Random;\n import java.util.concurrent.Callable;\n import java.util.concurrent.ExecutorService;\n import java.util.concurrent.Executors;\n@@ -31,24 +32,21 @@\n   private ExecutorService taskExecutorService;\n \n   private final AnomalyTaskDAO anomalyTaskDAO;\n-  private final AnomalyResultDAO anomalyResultDAO;\n-  private final AnomalyMergedResultDAO mergedResultDAO;\n-  private AnomalyFunctionFactory anomalyFunctionFactory;\n   private TaskContext taskContext;\n-  private ThirdEyeAnomalyConfiguration thirdEyeAnomalyConfiguration;\n   private long workerId;\n \n-  volatile boolean shutdown = false;\n-  private static int MAX_PARALLEL_TASK = 3;\n+  private volatile boolean shutdown = false;\n+  private static final int MAX_PARALLEL_TASK = 3;\n+  private static final int NO_TASK_IDLE_DELAY_MILLIS = 15_000; // 15 seconds\n+  private static final int TASK_FAILURE_DELAY_MILLIS = 5 * 60_000; // 5 minutes\n+  private static final int TASK_FETCH_SIZE = 10;\n+  private static final Random RANDOM = new Random();\n \n   public TaskDriver(ThirdEyeAnomalyConfiguration thirdEyeAnomalyConfiguration, AnomalyJobDAO anomalyJobDAO,\n       AnomalyTaskDAO anomalyTaskDAO, AnomalyResultDAO anomalyResultDAO, AnomalyMergedResultDAO mergedResultDAO,\n       AnomalyFunctionFactory anomalyFunctionFactory) {\n     this.workerId = thirdEyeAnomalyConfiguration.getId();\n     this.anomalyTaskDAO = anomalyTaskDAO;\n-    this.anomalyResultDAO = anomalyResultDAO;\n-    this.mergedResultDAO = mergedResultDAO;\n-    this.anomalyFunctionFactory = anomalyFunctionFactory;\n     taskExecutorService = Executors.newFixedThreadPool(MAX_PARALLEL_TASK);\n \n     taskContext = new TaskContext();\n@@ -63,36 +61,31 @@ public TaskDriver(ThirdEyeAnomalyConfiguration thirdEyeAnomalyConfiguration, Ano\n   public void start() throws Exception {\n     List<Callable<Void>> callables = new ArrayList<>();\n     for (int i = 0; i < MAX_PARALLEL_TASK; i++) {\n-      Callable<Void> callable = new Callable<Void>() {\n-        @Override\n-        public Void call() throws Exception {\n-          while (!shutdown) {\n-\n-            LOG.info(Thread.currentThread().getId() + \" : Finding next task to execute for threadId:{}\",\n-                Thread.currentThread().getId());\n-\n-            try {\n-              // select a task to execute, and update it to RUNNING\n-              AnomalyTaskSpec anomalyTaskSpec = selectAndUpdate();\n-              LOG.info(Thread.currentThread().getId() + \" : Executing task: {} {}\", anomalyTaskSpec.getId(),\n-                  anomalyTaskSpec.getTaskInfo());\n-\n-              // execute the selected task\n-              TaskType taskType = anomalyTaskSpec.getTaskType();\n-              TaskRunner taskRunner = TaskRunnerFactory.getTaskRunnerFromTaskType(taskType);\n-              TaskInfo taskInfo = TaskInfoFactory.getTaskInfoFromTaskType(taskType, anomalyTaskSpec.getTaskInfo());\n-              LOG.info(Thread.currentThread().getId() + \" : Task Info {}\", taskInfo);\n-              List<TaskResult> taskResults = taskRunner.execute(taskInfo, taskContext);\n-              LOG.info(Thread.currentThread().getId() + \" : DONE Executing task: {}\", anomalyTaskSpec.getId());\n-\n-              // update status to COMPLETED\n-              updateStatusAndTaskEndTime(anomalyTaskSpec.getId(), TaskStatus.RUNNING, TaskStatus.COMPLETED);\n-            } catch (Exception e) {\n-              LOG.error(\"Exception in electing and executing task\", e);\n-            }\n+      Callable<Void> callable = () -> {\n+        while (!shutdown) {\n+          LOG.info(Thread.currentThread().getId() + \" : Finding next task to execute for threadId:{}\",\n+              Thread.currentThread().getId());\n+          try {\n+            // select a task to execute, and update it to RUNNING\n+            AnomalyTaskSpec anomalyTaskSpec = selectAndUpdate();\n+            LOG.info(Thread.currentThread().getId() + \" : Executing task: {} {}\", anomalyTaskSpec.getId(),\n+                anomalyTaskSpec.getTaskInfo());\n+\n+            // execute the selected task\n+            TaskType taskType = anomalyTaskSpec.getTaskType();\n+            TaskRunner taskRunner = TaskRunnerFactory.getTaskRunnerFromTaskType(taskType);\n+            TaskInfo taskInfo = TaskInfoFactory.getTaskInfoFromTaskType(taskType, anomalyTaskSpec.getTaskInfo());\n+            LOG.info(Thread.currentThread().getId() + \" : Task Info {}\", taskInfo);\n+            List<TaskResult> taskResults = taskRunner.execute(taskInfo, taskContext);\n+            LOG.info(Thread.currentThread().getId() + \" : DONE Executing task: {}\", anomalyTaskSpec.getId());\n+\n+            // update status to COMPLETED\n+            updateStatusAndTaskEndTime(anomalyTaskSpec.getId(), TaskStatus.RUNNING, TaskStatus.COMPLETED);\n+          } catch (Exception e) {\n+            LOG.error(\"Exception in electing and executing task\", e);\n           }\n-          return null;\n         }\n+        return null;\n       };\n       callables.add(callable);\n     }\n@@ -106,16 +99,28 @@ public void stop() {\n     taskExecutorService.shutdown();\n   }\n \n-  private AnomalyTaskSpec selectAndUpdate() {\n+  private AnomalyTaskSpec selectAndUpdate() throws Exception {\n     LOG.info(Thread.currentThread().getId() + \" : Starting selectAndUpdate {}\", Thread.currentThread().getId());\n     AnomalyTaskSpec acquiredTask = null;\n     LOG.info(Thread.currentThread().getId() + \" : Trying to find a task to execute\");\n     do {\n-\n       List<AnomalyTaskSpec> anomalyTasks = new ArrayList<>();\n-      anomalyTasks = anomalyTaskDAO.findByStatusOrderByCreateTimeAscending(TaskStatus.WAITING);\n-      if (anomalyTasks.size() > 0)\n+      try {\n+        anomalyTasks = anomalyTaskDAO.findByStatusOrderByCreateTimeAsc(TaskStatus.WAITING, TASK_FETCH_SIZE);\n+      } catch (Exception e) {\n+        LOG.error(\"Exception found in fetching new tasks, sleeping for few seconds\", e);\n+        // TODO : Add better wait / clear call\n+        Thread.sleep(TASK_FAILURE_DELAY_MILLIS);\n+      }\n+      if (anomalyTasks.size() > 0) {\n         LOG.info(Thread.currentThread().getId() + \" : Found {} tasks in waiting state\", anomalyTasks.size());\n+      } else {\n+        // sleep for few seconds if not tasks found - avoid cpu thrashing\n+        // also add some extra random number of milli seconds to allow threads to start at different times\n+        // TODO : Add better wait / clear call\n+        LOG.debug(\"No tasks found to execute, sleeping for {} MS\", NO_TASK_IDLE_DELAY_MILLIS + RANDOM.nextInt(1000));\n+        Thread.sleep(NO_TASK_IDLE_DELAY_MILLIS);\n+      }\n \n       for (AnomalyTaskSpec anomalyTaskSpec : anomalyTasks) {\n         LOG.info(Thread.currentThread().getId() + \" : Trying to acquire task : {}\", anomalyTaskSpec.getId());\n@@ -126,7 +131,7 @@ private AnomalyTaskSpec selectAndUpdate() {\n               TaskStatus.RUNNING);\n           LOG.info(Thread.currentThread().getId() + \" : Task acquired success: {}\", success);\n         } catch (OptimisticLockException | RollbackException | StaleObjectStateException e) {\n-          LOG.warn(\"Optimistic lock exception in acquiring task by threadId {} and workerId {}\",\n+          LOG.warn(\"[{}] in acquiring task by threadId {} and workerId {}\", e.getClass().getSimpleName(),\n               Thread.currentThread().getId(), workerId);\n         }\n         if (success) {\n@@ -136,7 +141,6 @@ private AnomalyTaskSpec selectAndUpdate() {\n       }\n     } while (acquiredTask == null);\n     LOG.info(Thread.currentThread().getId() + \" : Acquired task ======\" + acquiredTask);\n-\n     return acquiredTask;\n   }\n ",
                "deletions": 43
            },
            {
                "sha": "c018b746f8be2532a8e496f816a8a7e1f16fbcaa",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/common/persistence/PersistenceUtil.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/common/persistence/PersistenceUtil.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/common/persistence/PersistenceUtil.java",
                "status": "modified",
                "changes": 9,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/common/persistence/PersistenceUtil.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -40,18 +40,21 @@ public static void init(File localConfigFile) {\n     ds.setDriverClassName(configuration.getDatabaseConfiguration().getProperties().get(\"hibernate.connection.driver_class\"));\n \n     // pool size configurations\n-    ds.setMaxActive(100);\n+    ds.setMaxActive(200);\n     ds.setMinIdle(10);\n     ds.setInitialSize(10);\n \n     // validate connection\n     ds.setValidationQuery(\"select 1 as dbcp_connection_test\");\n     ds.setTestWhileIdle(true);\n-    ds.setTestOnReturn(true);\n     ds.setTestOnBorrow(true);\n \n+    // when returning connection to pool\n+    ds.setTestOnReturn(true);\n+    ds.setRollbackOnReturn(true);\n+\n     // Timeout in seconds before an abandoned(in use) connection can be removed.\n-    ds.setRemoveAbandonedTimeout(15 * 60);\n+    ds.setRemoveAbandonedTimeout(600);\n     ds.setRemoveAbandoned(true);\n \n     properties.put(Environment.CONNECTION_PROVIDER, DatasourceConnectionProviderImpl.class.getName());",
                "deletions": 3
            },
            {
                "sha": "946d76538d29b5c28aecd72655d5a98e3d07a1af",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -326,7 +326,6 @@ public String getDashboardData(@QueryParam(\"dataset\") String collection,\n       LOG.error(\"Exception while processing /data/tabular call\", e);\n       return \"{\\\"ERROR\\\": + \" + e.getMessage() + \"}\";\n     }\n-\n   }\n \n   @GET",
                "deletions": 1
            },
            {
                "sha": "b2623dd09672dbe31568fdd56918c92b97220e77",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/db/dao/AnomalyTaskDAO.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/db/dao/AnomalyTaskDAO.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/db/dao/AnomalyTaskDAO.java",
                "status": "modified",
                "changes": 8,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/db/dao/AnomalyTaskDAO.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -17,8 +17,7 @@\n       + \"AND at.status != :status\";\n \n   private static final String FIND_BY_STATUS_ORDER_BY_CREATE_TIME_ASC = \"SELECT at FROM AnomalyTaskSpec at \"\n-      + \"WHERE at.status = :status \"\n-      + \"order by at.taskStartTime asc\";\n+      + \"WHERE at.status = :status order by at.taskStartTime asc\";\n \n   private static final String FIND_BY_STATUS_AND_LAST_MODIFIED_TIME_LT_EXPIRE = \"SELECT at FROM AnomalyTaskSpec at \"\n       + \"WHERE at.status = :status AND at.lastModified < :expireTimestamp\";\n@@ -35,10 +34,9 @@ public AnomalyTaskDAO() {\n   }\n \n   @Transactional\n-  public List<AnomalyTaskSpec> findByStatusOrderByCreateTimeAscending(TaskStatus status) {\n+  public List<AnomalyTaskSpec> findByStatusOrderByCreateTimeAsc(TaskStatus status, int fetchSize) {\n     return getEntityManager().createQuery(FIND_BY_STATUS_ORDER_BY_CREATE_TIME_ASC, entityClass)\n-            .setParameter(\"status\", status)\n-            .getResultList();\n+        .setMaxResults(fetchSize).setParameter(\"status\", status).getResultList();\n   }\n \n   @Transactional",
                "deletions": 5
            },
            {
                "sha": "6e5ef65eb8a86209eb7352cffe965bed901d3bb3",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/util/ThirdEyeUtils.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/util/ThirdEyeUtils.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/util/ThirdEyeUtils.java",
                "status": "modified",
                "changes": 11,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/util/ThirdEyeUtils.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -21,7 +21,6 @@\n import com.google.common.collect.Multimap;\n import com.linkedin.thirdeye.client.ThirdEyeCacheRegistry;\n import com.linkedin.thirdeye.dashboard.configs.CollectionConfig;\n-import com.linkedin.thirdeye.dashboard.resources.AnomalyResource;\n \n public class ThirdEyeUtils {\n   private static final Logger LOG = LoggerFactory.getLogger(ThirdEyeUtils.class);\n@@ -97,7 +96,6 @@ public static String getSortedFiltersFromMultiMap(Multimap<String, String> filte\n         sb.append(FILTER_CLAUSE_SEPARATOR);\n       }\n     }\n-\n     return StringUtils.chop(sb.toString());\n   }\n \n@@ -108,7 +106,6 @@ public static String getSortedFilters(String filters) {\n     if (StringUtils.isBlank(sortedFilters)) {\n       return null;\n     }\n-\n     return sortedFilters;\n   }\n \n@@ -119,7 +116,6 @@ public static String getSortedFiltersFromJson(String filterJson) {\n     if (StringUtils.isBlank(sortedFilters)) {\n       return null;\n     }\n-\n     return sortedFilters;\n   }\n \n@@ -151,7 +147,6 @@ public static String getAliasFromCollection(String collection) throws ExecutionE\n   }\n \n   public static String constructCron(String scheduleMinute, String scheduleHour, TimeUnit repeatEvery) {\n-\n     if (StringUtils.isNotBlank(scheduleMinute)\n         && (Integer.valueOf(scheduleMinute) < 0 || Integer.valueOf(scheduleMinute) > 59)) {\n       throw new IllegalArgumentException(\"scheduleMinute \" + scheduleMinute + \" must be between [0,60)\");\n@@ -162,17 +157,13 @@ public static String constructCron(String scheduleMinute, String scheduleHour, T\n     }\n     String minute = \"0\";\n     String hour = \"0\";\n-    String cron = AnomalyResource.DEFAULT_CRON;\n     if (repeatEvery.equals(TimeUnit.DAYS)) {\n       minute = StringUtils.isEmpty(scheduleMinute) ? minute : scheduleMinute;\n       hour = StringUtils.isEmpty(scheduleHour) ? hour : scheduleHour;\n     } else if (repeatEvery.equals(TimeUnit.HOURS)) {\n       minute = StringUtils.isEmpty(scheduleMinute) ? minute : scheduleMinute;\n       hour = \"*\";\n     }\n-    cron = String.format(\"0 %s %s * * ?\", minute, hour);\n-    return cron;\n+    return String.format(\"0 %s %s * * ?\", minute, hour);\n   }\n-\n-\n }",
                "deletions": 10
            },
            {
                "sha": "d8e0ed0dce433df8ce93938c55ebf398e5ccc616",
                "filename": "thirdeye/thirdeye-pinot/src/test/java/com/linkedin/thirdeye/db/dao/TestAnomalyTaskDAO.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/test/java/com/linkedin/thirdeye/db/dao/TestAnomalyTaskDAO.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/77726cb01d1d7ac596bccefb71bfeb8c5099b055/thirdeye/thirdeye-pinot/src/test/java/com/linkedin/thirdeye/db/dao/TestAnomalyTaskDAO.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/test/java/com/linkedin/thirdeye/db/dao/TestAnomalyTaskDAO.java?ref=77726cb01d1d7ac596bccefb71bfeb8c5099b055",
                "patch": "@@ -52,7 +52,8 @@ public void testUpdateStatusAndWorkerId() {\n \n   @Test(dependsOnMethods = {\"testUpdateStatusAndWorkerId\"})\n   public void testFindByStatusOrderByCreationTimeAsc() {\n-    List<AnomalyTaskSpec> anomalyTasks = anomalyTaskDAO.findByStatusOrderByCreateTimeAscending(TaskStatus.WAITING);\n+    List<AnomalyTaskSpec> anomalyTasks =\n+        anomalyTaskDAO.findByStatusOrderByCreateTimeAsc(TaskStatus.WAITING, Integer.MAX_VALUE);\n     Assert.assertEquals(anomalyTasks.size(), 1);\n   }\n ",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[EKG-85543] Fix NPE on segment refresh when no instances exist for the table.\n\nSegments can be added when there are no instances for a table, but if one is refreshed,\nwe throw an NPE. This happens only in state-changed based refresh, however.",
        "commit": "https://github.com/apache/incubator-pinot/commit/537212a0c9f4f958b7c80508a97eae44a4234789",
        "parent": "https://github.com/apache/incubator-pinot/commit/ecfe52cc4a23c2c29c5bb61baaa040d8933b12c2",
        "bug_id": "incubator-pinot_59",
        "file": [
            {
                "sha": "5cfc0adcd127fb9cc2786100799d3407f5f2f527",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/helix/HelixHelper.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/537212a0c9f4f958b7c80508a97eae44a4234789/pinot-common/src/main/java/com/linkedin/pinot/common/utils/helix/HelixHelper.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/537212a0c9f4f958b7c80508a97eae44a4234789/pinot-common/src/main/java/com/linkedin/pinot/common/utils/helix/HelixHelper.java",
                "status": "modified",
                "changes": 10,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/helix/HelixHelper.java?ref=537212a0c9f4f958b7c80508a97eae44a4234789",
                "patch": "@@ -338,12 +338,16 @@ public IdealState apply(IdealState idealState) {\n         try {\n           targetInstances = getInstancesForSegment.call();\n         } catch (Exception e) {\n-          LOGGER.error(\"Unable to get new instances for segment uploading.\");\n+          LOGGER.error(\"Unable to get new instances for uploading segment {}, table {}\", segmentName, tableName);\n           return null;\n         }\n \n-        for (final String instance : targetInstances) {\n-          idealState.setPartitionState(segmentName, instance, ONLINE);\n+        if (targetInstances == null || targetInstances.size() == 0) {\n+          LOGGER.warn(\"No instances assigned for segment {}, table {}\", segmentName, tableName);\n+        } else {\n+          for (final String instance : targetInstances) {\n+            idealState.setPartitionState(segmentName, instance, ONLINE);\n+          }\n         }\n \n         idealState.setNumPartitions(idealState.getNumPartitions() + 1);",
                "deletions": 3
            },
            {
                "sha": "4397e3cbee73cf15c5c5643b4bb1aa702ab67c06",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/537212a0c9f4f958b7c80508a97eae44a4234789/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/537212a0c9f4f958b7c80508a97eae44a4234789/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/PinotHelixResourceManager.java?ref=537212a0c9f4f958b7c80508a97eae44a4234789",
                "patch": "@@ -1337,6 +1337,12 @@ private boolean updateExistedSegment(SegmentZKMetadata segmentZKMetadata) {\n     do {\n       final IdealState idealState = _helixAdmin.getResourceIdealState(_helixClusterName, tableName);\n       final Set<String> instanceSet = idealState.getInstanceSet(segmentName);\n+      if (instanceSet == null || instanceSet.size() == 0) {\n+        // We are trying to refresh a segment, but there are no instances currently assigned for fielding this segment.\n+        // When those instances do come up, the segment will be uploaded correctly, so return success but log a warning.\n+        LOGGER.warn(\"No instances as yet for segment {}, table {}\", segmentName, tableName);\n+        return true;\n+      }\n       for (final String instance : instanceSet) {\n         idealState.setPartitionState(segmentName, instance, \"OFFLINE\");\n       }",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Handle exceptional cases in realtime consumption (#253)\n\nAvoid NPEs when transforming rows and properly bubble exceptions up on\r\nexceptional code paths as to trigger exponential backoff.",
        "commit": "https://github.com/apache/incubator-pinot/commit/64974aa070564bc5fb2643987e2833d9bc0d9577",
        "parent": "https://github.com/apache/incubator-pinot/commit/f7a5309d2cbe95b8b8fb0c37726a51a77a1e9871",
        "bug_id": "incubator-pinot_60",
        "file": [
            {
                "sha": "890c6f21a7f70c9bbe22d302edc2eaaaa93e845f",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/64974aa070564bc5fb2643987e2833d9bc0d9577/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/64974aa070564bc5fb2643987e2833d9bc0d9577/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java?ref=64974aa070564bc5fb2643987e2833d9bc0d9577",
                "patch": "@@ -179,8 +179,8 @@ public void run() {\n           try {\n             row = kafkaStreamProvider.next();\n \n-            row = extractor.transform(row);\n             if (row != null) {\n+              row = extractor.transform(row);\n               notFull = realtimeSegment.index(row);\n               exceptionSleepMillis = 50L;\n             }",
                "deletions": 1
            },
            {
                "sha": "5643dbde4baaea9a7c541e81f92c689b3205fae1",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/kafka/KafkaHighLevelConsumerStreamProvider.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/64974aa070564bc5fb2643987e2833d9bc0d9577/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/kafka/KafkaHighLevelConsumerStreamProvider.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/64974aa070564bc5fb2643987e2833d9bc0d9577/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/kafka/KafkaHighLevelConsumerStreamProvider.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/kafka/KafkaHighLevelConsumerStreamProvider.java?ref=64974aa070564bc5fb2643987e2833d9bc0d9577",
                "patch": "@@ -99,6 +99,7 @@ public GenericRow next() {\n         INSTANCE_LOGGER.warn(\"Caught exception while consuming events\", e);\n         serverMetrics.addMeteredTableValue(tableAndStreamName, ServerMeter.REALTIME_CONSUMPTION_EXCEPTIONS, 1L);\n         serverMetrics.addMeteredGlobalValue(ServerMeter.REALTIME_CONSUMPTION_EXCEPTIONS, 1L);\n+        throw e;\n       }\n     }\n     return null;",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "PINOT-1978 NPE fix for retention\n\nRB=558948\nG=pinot-dev-reviewers\nR=kgopalak,xiafu,jfim,dpatel,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/a365190dfbfe6adc7836bf8f33ed100f2674e58a",
        "parent": "https://github.com/apache/incubator-pinot/commit/908b5e1bba7341dd7a5ecbfd06241e39f52ebe19",
        "bug_id": "incubator-pinot_61",
        "file": [
            {
                "sha": "a88d9eb700ff603aafa0b364fd3d4e9af8f32645",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/a365190dfbfe6adc7836bf8f33ed100f2674e58a/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/a365190dfbfe6adc7836bf8f33ed100f2674e58a/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "status": "modified",
                "changes": 48,
                "additions": 30,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java?ref=a365190dfbfe6adc7836bf8f33ed100f2674e58a",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.controller.helix.core.retention;\n \n+import com.linkedin.pinot.common.config.SegmentsValidationAndRetentionConfig;\n import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n@@ -165,30 +166,41 @@ private void updateDeletionStrategiesForEntireCluster() {\n   private Map<String, RetentionStrategy> handleOfflineDeletionStrategy(String offlineTableName) {\n     Map<String, RetentionStrategy> tableToDeletionStrategyMap = new HashMap<String, RetentionStrategy>();\n \n-    AbstractTableConfig offlineTableConfig;\n     try {\n-      offlineTableConfig = ZKMetadataProvider.getOfflineTableConfig(_pinotHelixResourceManager.getPropertyStore(), offlineTableName);\n-    } catch (Exception e) {\n-      LOGGER.error(\"Error getting offline table config from property store!\", e);\n-      return tableToDeletionStrategyMap;\n-    }\n+      AbstractTableConfig offlineTableConfig;\n \n-    if (offlineTableConfig == null || offlineTableConfig.getValidationConfig() == null) {\n-      LOGGER.info(\"Table config null for table: {}, treating it as refresh only table.\", offlineTableName);\n-      return tableToDeletionStrategyMap;\n-    }\n-    \n-    if (offlineTableConfig.getValidationConfig().getSegmentPushType().equalsIgnoreCase(\"REFRESH\")) {\n-      LOGGER.info(\"Table: {} is a refresh only table.\", offlineTableName);\n-      return tableToDeletionStrategyMap;\n-    }\n-    try {\n-      TimeRetentionStrategy timeRetentionStrategy = new TimeRetentionStrategy(offlineTableConfig.getValidationConfig().getRetentionTimeUnit(),\n-          offlineTableConfig.getValidationConfig().getRetentionTimeValue());\n+      try {\n+        offlineTableConfig = ZKMetadataProvider.getOfflineTableConfig(_pinotHelixResourceManager.getPropertyStore(), offlineTableName);\n+      } catch (Exception e) {\n+        LOGGER.error(\"Error getting offline table config from property store!\", e);\n+        return tableToDeletionStrategyMap;\n+      }\n+\n+      if (offlineTableConfig == null || offlineTableConfig.getValidationConfig() == null) {\n+        LOGGER.info(\"Table config null for table: {}, treating it as refresh only table.\", offlineTableName);\n+        return tableToDeletionStrategyMap;\n+      }\n+\n+      SegmentsValidationAndRetentionConfig validationConfig = offlineTableConfig.getValidationConfig();\n+\n+      if (validationConfig.getSegmentPushType() == null || validationConfig.getSegmentPushType().isEmpty()) {\n+        LOGGER.info(\"Segment push type for table {} is empty, skipping retention processing\");\n+        return tableToDeletionStrategyMap;\n+      }\n+\n+      if (\"REFRESH\".equalsIgnoreCase(validationConfig.getSegmentPushType())) {\n+        LOGGER.info(\"Table: {} is a refresh only table.\", offlineTableName);\n+        return tableToDeletionStrategyMap;\n+      }\n+\n+      TimeRetentionStrategy timeRetentionStrategy = new TimeRetentionStrategy(\n+          validationConfig.getRetentionTimeUnit(),\n+          validationConfig.getRetentionTimeValue());\n       tableToDeletionStrategyMap.put(offlineTableName, timeRetentionStrategy);\n     } catch (Exception e) {\n       LOGGER.error(\"Error creating TimeRetentionStrategy for table: {}\", offlineTableName, e);\n     }\n+\n     return tableToDeletionStrategyMap;\n   }\n ",
                "deletions": 18
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE in integration tests when starting the broker\n\nRB=489921\nR=kgopalak,xiafu,jfim,dpatel,mshrivas\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/73ee15e16a25f693f0f99cb01095426ffb04c23d",
        "parent": "https://github.com/apache/incubator-pinot/commit/32e4b247046f94aba8f5d2287b18dd31455f4b47",
        "bug_id": "incubator-pinot_62",
        "file": [
            {
                "sha": "3972ed3dd5066a118359a7027be41ab205948ef9",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/73ee15e16a25f693f0f99cb01095426ffb04c23d/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/73ee15e16a25f693f0f99cb01095426ffb04c23d/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java",
                "status": "modified",
                "changes": 4,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java?ref=73ee15e16a25f693f0f99cb01095426ffb04c23d",
                "patch": "@@ -31,20 +31,17 @@\n import org.json.JSONObject;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.testng.Assert;\n \n import com.linkedin.pinot.broker.broker.BrokerTestUtils;\n import com.linkedin.pinot.broker.broker.helix.HelixBrokerStarter;\n import com.linkedin.pinot.common.ZkTestUtils;\n-import com.linkedin.pinot.common.data.FieldSpec;\n import com.linkedin.pinot.common.data.Schema;\n import com.linkedin.pinot.common.request.helper.ControllerRequestBuilder;\n import com.linkedin.pinot.common.utils.CommonConstants.Helix;\n import com.linkedin.pinot.common.utils.CommonConstants.Helix.DataSource;\n import com.linkedin.pinot.common.utils.CommonConstants.Helix.DataSource.Realtime.Kafka;\n import com.linkedin.pinot.common.utils.CommonConstants.Server;\n import com.linkedin.pinot.common.utils.FileUploadUtils;\n-import com.linkedin.pinot.controller.helix.ControllerRequestBuilderUtil;\n import com.linkedin.pinot.controller.helix.ControllerRequestURLBuilder;\n import com.linkedin.pinot.controller.helix.ControllerTest;\n import com.linkedin.pinot.controller.helix.ControllerTestUtils;\n@@ -76,6 +73,7 @@ protected void startBrokers(int brokerCount) {\n         Configuration configuration = BrokerTestUtils.getDefaultBrokerConfiguration();\n         configuration.setProperty(\"pinot.broker.time.out\", 100 * 1000L);\n         configuration.setProperty(\"pinot.broker.client.queryPort\", Integer.toString(18099 + i));\n+        configuration.setProperty(\"pinot.broker.routing.table.builder.class\", \"random\");\n         overrideBrokerConf(configuration);\n         _brokerStarters.add(BrokerTestUtils.startBroker(helixClusterName, ZkTestUtils.DEFAULT_ZK_STR, configuration));\n       }",
                "deletions": 3
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE in ControllerSentinelTest.\nFixing TestPinotResourceMananger by using empty server instances.\n\nRB=470077\nR=xiafu\nA=dpatel",
        "commit": "https://github.com/apache/incubator-pinot/commit/f24872913f498cd21f3bf9a5a809f4d5ca74696a",
        "parent": "https://github.com/apache/incubator-pinot/commit/3e45f310f6a6f47f6fce2a6404cd8c6a1b0f5553",
        "bug_id": "incubator-pinot_63",
        "file": [
            {
                "sha": "a569d3fc5067bd9be9e8a0c8ebc0cfffe5a90e57",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f24872913f498cd21f3bf9a5a809f4d5ca74696a/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f24872913f498cd21f3bf9a5a809f4d5ca74696a/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java",
                "status": "modified",
                "changes": 15,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java?ref=f24872913f498cd21f3bf9a5a809f4d5ca74696a",
                "patch": "@@ -15,13 +15,6 @@\n  */\n package com.linkedin.pinot.controller.helix;\n \n-import com.linkedin.pinot.common.ZkTestUtils;\n-import com.linkedin.pinot.common.utils.ZkUtils;\n-import com.linkedin.pinot.controller.ControllerConf;\n-import com.linkedin.pinot.controller.ControllerStarter;\n-import com.linkedin.pinot.controller.helix.core.HelixSetupUtils;\n-import com.linkedin.pinot.controller.helix.starter.HelixConfig;\n-\n import java.io.BufferedReader;\n import java.io.BufferedWriter;\n import java.io.IOException;\n@@ -31,6 +24,7 @@\n import java.net.HttpURLConnection;\n import java.net.URL;\n import java.net.URLConnection;\n+\n import org.apache.helix.HelixAdmin;\n import org.apache.helix.HelixManager;\n import org.apache.helix.ZNRecord;\n@@ -41,6 +35,10 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.linkedin.pinot.common.ZkTestUtils;\n+import com.linkedin.pinot.controller.ControllerConf;\n+import com.linkedin.pinot.controller.ControllerStarter;\n+\n \n /**\n  * Base class for controller tests.\n@@ -114,8 +112,9 @@ protected void startController() {\n     if (_zkClient.exists(\"/\" + getHelixClusterName())) {\n       _zkClient.deleteRecursive(\"/\" + getHelixClusterName());\n     }\n-\n     _controllerStarter = ControllerTestUtils.startController(getHelixClusterName(), ZkTestUtils.DEFAULT_ZK_STR, config);\n+    _helixAdmin = _controllerStarter.getHelixResourceManager().getHelixAdmin();\n+    _propertyStore = _controllerStarter.getHelixResourceManager().getPropertyStore();\n   }\n \n   /**",
                "deletions": 8
            },
            {
                "sha": "d269e55b885f93974b93149f07d2ca7e37ea9bd9",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/TestPinotResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f24872913f498cd21f3bf9a5a809f4d5ca74696a/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/TestPinotResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f24872913f498cd21f3bf9a5a809f4d5ca74696a/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/TestPinotResourceManager.java",
                "status": "modified",
                "changes": 13,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/TestPinotResourceManager.java?ref=f24872913f498cd21f3bf9a5a809f4d5ca74696a",
                "patch": "@@ -73,7 +73,7 @@ public void setUp() throws Exception {\n \n     /////////////////////////\n     _numInstance = 1;\n-    final List<HelixServerStarter> pinotHelixStarters = addInstancesToAutoJoinHelixCluster(_numInstance);\n+    ControllerRequestBuilderUtil.addFakeDataInstancesToAutoJoinHelixCluster(HELIX_CLUSTER_NAME, ZK_SERVER, _numInstance);\n     ControllerRequestBuilderUtil.addFakeBrokerInstancesToAutoJoinHelixCluster(HELIX_CLUSTER_NAME, ZK_SERVER, 1);\n     Thread.sleep(3000);\n     Assert.assertEquals(\n@@ -90,17 +90,6 @@ public void setUp() throws Exception {\n     _pinotResourceManager.handleAddTableToDataResource(addTableResource);\n   }\n \n-  private List<HelixServerStarter> addInstancesToAutoJoinHelixCluster(int numInstances) throws Exception {\n-    final List<HelixServerStarter> pinotHelixStarters = new ArrayList<HelixServerStarter>();\n-    for (int i = 0; i < numInstances; ++i) {\n-      final HelixServerStarter pinotHelixStarter =\n-          new HelixServerStarter(HELIX_CLUSTER_NAME, ZK_SERVER, new PropertiesConfiguration());\n-      pinotHelixStarters.add(pinotHelixStarter);\n-      Thread.sleep(1000);\n-    }\n-    return pinotHelixStarters;\n-  }\n-\n   @AfterTest\n   public void tearDown() {\n     _pinotResourceManager.stop();",
                "deletions": 12
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed NPE on server due to path changes, causing all segments to error out instead of coming online",
        "commit": "https://github.com/apache/incubator-pinot/commit/27a498d8423f76a82139301f35d5872bedbe00dd",
        "parent": "https://github.com/apache/incubator-pinot/commit/a1ca23b21bc94c2faff04e26b513e580c441a859",
        "bug_id": "incubator-pinot_64",
        "file": [
            {
                "sha": "c5e82ef3954283525fea31adc0ce3999ad9ff200",
                "filename": "pinot-server/src/main/java/com/linkedin/pinot/server/starter/helix/SegmentOnlineOfflineStateModelFactory.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/27a498d8423f76a82139301f35d5872bedbe00dd/pinot-server/src/main/java/com/linkedin/pinot/server/starter/helix/SegmentOnlineOfflineStateModelFactory.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/27a498d8423f76a82139301f35d5872bedbe00dd/pinot-server/src/main/java/com/linkedin/pinot/server/starter/helix/SegmentOnlineOfflineStateModelFactory.java",
                "status": "modified",
                "changes": 3,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-server/src/main/java/com/linkedin/pinot/server/starter/helix/SegmentOnlineOfflineStateModelFactory.java?ref=27a498d8423f76a82139301f35d5872bedbe00dd",
                "patch": "@@ -146,8 +146,7 @@ private void onBecomeOnlineFromOfflineForOfflineSegment(Message message, Notific\n       final String pathToPropertyStore = \"/\" + StringUtil.join(\"/\", resourceName, segmentId);\n \n       OfflineSegmentZKMetadata offlineSegmentZKMetadata =\n-          new OfflineSegmentZKMetadata(context.getManager().getHelixPropertyStore()\n-              .get(pathToPropertyStore, null, AccessOption.PERSISTENT));\n+          ZKMetadataProvider.getOfflineSegmentZKMetadata(context.getManager().getHelixPropertyStore(), resourceName, segmentId);\n \n       LOGGER.info(\"Trying to load segment : \" + segmentId + \" for resource : \" + resourceName);\n       try {",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix closing of index without dictionary. (#923)\n\n1. Added method 'hasDictionary' to the interface ColumnIndexContainer.\r\n2. Destory on segment checks presence of dictionary before closing it to\r\navoid NPE.",
        "commit": "https://github.com/apache/incubator-pinot/commit/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785",
        "parent": "https://github.com/apache/incubator-pinot/commit/04693ff89463c829083f42fdabd5e0ac30e8ade4",
        "bug_id": "incubator-pinot_65",
        "file": [
            {
                "sha": "9974c2cc988a41434fc854ee1462703fed1ae6aa",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/IndexSegmentImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/IndexSegmentImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/IndexSegmentImpl.java",
                "status": "modified",
                "changes": 13,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/IndexSegmentImpl.java?ref=d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785",
                "patch": "@@ -105,19 +105,24 @@ public DataSource getDataSource(String columnName, Predicate p) {\n   public void destroy() {\n     LOGGER.info(\"Trying to destroy segment : {}\", this.getSegmentName());\n     for (String column : indexContainerMap.keySet()) {\n+      ColumnIndexContainer columnIndexContainer = indexContainerMap.get(column);\n+\n       try {\n-        indexContainerMap.get(column).getDictionary().close();\n+        if (columnIndexContainer.hasDictionary()) {\n+          ImmutableDictionaryReader dictionary = columnIndexContainer.getDictionary();\n+          dictionary.close();\n+        }\n       } catch (Exception e) {\n         LOGGER.error(\"Error when close dictionary index for column : \" + column, e);\n       }\n       try {\n-        indexContainerMap.get(column).getForwardIndex().close();\n+        columnIndexContainer.getForwardIndex().close();\n       } catch (Exception e) {\n         LOGGER.error(\"Error when close forward index for column : \" + column, e);\n       }\n       try {\n-        if (indexContainerMap.get(column).getInvertedIndex() != null) {\n-          indexContainerMap.get(column).getInvertedIndex().close();\n+        if (columnIndexContainer.getInvertedIndex() != null) {\n+          columnIndexContainer.getInvertedIndex().close();\n         }\n       } catch (Exception e) {\n         LOGGER.error(\"Error when close inverted index for column : \" + column, e);",
                "deletions": 4
            },
            {
                "sha": "07ef238354ccc5478ef1028f4242f44410a2a1fa",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/ColumnIndexContainer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/ColumnIndexContainer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/ColumnIndexContainer.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/ColumnIndexContainer.java?ref=d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785",
                "patch": "@@ -159,6 +159,11 @@ private static ImmutableDictionaryReader load(ColumnMetadata metadata, PinotData\n    */\n   public abstract DataFileReader getForwardIndex();\n \n+  /**\n+   * @return True if index has dictionary, false otherwise\n+   */\n+  public abstract boolean hasDictionary();\n+\n   /**\n    * @return\n    */",
                "deletions": 0
            },
            {
                "sha": "09df72a94977a10eaa0ac73d79fd7eae66251a3c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/SortedSVColumnIndexContainer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/SortedSVColumnIndexContainer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/SortedSVColumnIndexContainer.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/SortedSVColumnIndexContainer.java?ref=d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785",
                "patch": "@@ -53,6 +53,11 @@ public DataFileReader getForwardIndex() {\n     return forwardIndexReader;\n   }\n \n+  @Override\n+  public boolean hasDictionary() {\n+    return columnMetadata.hasDictionary();\n+  }\n+\n   @Override\n   public ImmutableDictionaryReader getDictionary() {\n     return dictionaryReader;",
                "deletions": 0
            },
            {
                "sha": "9116074640ade8aa1f4434e7df9fa9c2ebe82962",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnSortedMVColumnIndexContainer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnSortedMVColumnIndexContainer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnSortedMVColumnIndexContainer.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnSortedMVColumnIndexContainer.java?ref=d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785",
                "patch": "@@ -56,6 +56,11 @@ public DataFileReader getForwardIndex() {\n     return indexReader;\n   }\n \n+  @Override\n+  public boolean hasDictionary() {\n+    return columnMetadata.hasDictionary();\n+  }\n+\n   @Override\n   public ImmutableDictionaryReader getDictionary() {\n     return dictionary;",
                "deletions": 0
            },
            {
                "sha": "8e9bf1ec1731a43a1f75ba7b935f8af7f9061f9f",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnsortedSVColumnIndexContainer.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnsortedSVColumnIndexContainer.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnsortedSVColumnIndexContainer.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/column/UnsortedSVColumnIndexContainer.java?ref=d35cc3ea2a9abc6ad3c2b2e189a7cfb1eed88785",
                "patch": "@@ -61,6 +61,11 @@ public ImmutableDictionaryReader getDictionary() {\n     return dictionary;\n   }\n \n+  @Override\n+  public boolean hasDictionary() {\n+    return columnMetadata.hasDictionary();\n+  }\n+\n   @Override\n   public ColumnMetadata getColumnMetadata() {\n     return columnMetadata;",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix FastHLL throw NPE. (#849)\n\nAdd BrokerRequestPreProcessor class to pre-process the broker request.\r\nMove hll derived column name map from StarTreeMetadata to SegmentMetadata.\r\nRewrite the hll derived column name before making the plan node.",
        "commit": "https://github.com/apache/incubator-pinot/commit/83b3512def190c49233a14280e5c178169ff155f",
        "parent": "https://github.com/apache/incubator-pinot/commit/cb866d837f72232201daa394b7188a1bd61199e9",
        "bug_id": "incubator-pinot_66",
        "file": [
            {
                "sha": "120b5b0c250ac3b0c7c1341f7bdc2dac1a60b1d4",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/segment/SegmentMetadata.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-common/src/main/java/com/linkedin/pinot/common/segment/SegmentMetadata.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-common/src/main/java/com/linkedin/pinot/common/segment/SegmentMetadata.java",
                "status": "modified",
                "changes": 150,
                "additions": 50,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/segment/SegmentMetadata.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -15,158 +15,108 @@\n  */\n package com.linkedin.pinot.common.segment;\n \n-import java.io.File;\n+import com.linkedin.pinot.common.data.MetricFieldSpec;\n+import com.linkedin.pinot.common.data.Schema;\n import java.util.Map;\n-\n import javax.annotation.Nullable;\n import org.joda.time.Duration;\n import org.joda.time.Interval;\n \n-import com.linkedin.pinot.common.data.Schema;\n-\n \n /**\n- * SegmentMetadata holds segment level management information and data\n- * statistics.\n+ * The <code>SegmentMetadata</code> class holds the segment level management information and data statistics.\n  */\n public interface SegmentMetadata {\n-  /**\n-   * @return\n-   */\n-  public String getTableName();\n \n-  /**\n-   * @return\n-   */\n-  public String getIndexType();\n+  String getTableName();\n \n-  /**\n-   * @return\n-   */\n-  public Duration getTimeGranularity();\n+  String getIndexType();\n \n-  /**\n-   * @return\n-   */\n-  public Interval getTimeInterval();\n+  Duration getTimeGranularity();\n \n-  /**\n-   * @return\n-   */\n-  public String getCrc();\n+  Interval getTimeInterval();\n \n-  /**\n-   * @return\n-   */\n-  public String getVersion();\n+  String getCrc();\n \n-  /**\n-   * @return\n-   */\n-  public Schema getSchema();\n+  String getVersion();\n \n-  /**\n-   * @return\n-   */\n-  public String getShardingKey();\n+  Schema getSchema();\n \n-  /**\n-   * @return\n-   */\n-  public int getTotalDocs();\n+  String getShardingKey();\n+\n+  int getTotalDocs();\n \n-  /**\n-   *\n-   * @return\n-   */\n   int getTotalRawDocs();\n \n-  /**\n-   * @return\n-   */\n-  public String getIndexDir();\n+  String getIndexDir();\n \n-  /**\n-   * @return\n-   */\n-  public String getName();\n+  String getName();\n \n-  /**\n-   * @return\n-   */\n-  public long getIndexCreationTime();\n+  long getIndexCreationTime();\n \n   /**\n-   * Returns the last time that this segment was pushed or Long.MIN_VALUE if it has never been\n-   * pushed.\n+   * Get the last time that this segment was pushed or <code>Long.MIN_VALUE</code> if it has never been pushed.\n    */\n-  public long getPushTime();\n+  long getPushTime();\n \n   /**\n-   * Returns the last time that this segment was refreshed or Long.MIN_VALUE if it has never been\n-   * refreshed.\n+   * Get the last time that this segment was refreshed or <code>Long.MIN_VALUE</code> if it has never been refreshed.\n    */\n-  public long getRefreshTime();\n+  long getRefreshTime();\n \n-  /**\n-   * Returns if a column has dictionary or not.\n-   */\n-  public boolean hasDictionary(String columnName);\n+  boolean hasDictionary(String columnName);\n \n-  /** Returns true if the segment has a StarTree index defined */\n-  public boolean hasStarTree();\n+  boolean hasStarTree();\n \n-  /**\n-   * Returns the StarTreeMetadata for the segment\n-   * @return\n-   */\n-  public StarTreeMetadata getStarTreeMetadata();\n+  @Nullable\n+  StarTreeMetadata getStarTreeMetadata();\n \n   /**\n-   * returns the forward Index file name with appropriate extension for a given version\n-   * @param column\n-   * @return\n+   * Get the forward index file name with appropriate extension for a given version.\n+   *\n+   * @param column column name.\n+   * @param segmentVersion segment version.\n+   * @return forward index file name.\n    */\n   String getForwardIndexFileName(String column, String segmentVersion);\n \n   /**\n-   * returns the dictionary file name with appropriate extension for a given version\n-   * @param column\n-   * @return\n+   * Get the dictionary file name with appropriate extension for a given version.\n+   *\n+   * @param column column name.\n+   * @param segmentVersion segment version.\n+   * @return dictionary file name.\n    */\n   String getDictionaryFileName(String column, String segmentVersion);\n \n   /**\n-   * returns the bitmap inverted index file name with appropriate extension for a given version\n-   * @param column\n-   * @return\n+   * Get the bitmap inverted index file name with appropriate extension for a given version.\n+   *\n+   * @param column column name.\n+   * @param segmentVersion segment version.\n+   * @return bitmap inverted index file name.\n    */\n   String getBitmapInvertedIndexFileName(String column, String segmentVersion);\n \n-  /**\n-   * returns the name of the component that created the segment\n-   * @return\n-   */\n   @Nullable\n   String getCreatorName();\n \n-  /**\n-   * returns the padding character\n-   * @return\n-   */\n-  Character getPaddingCharacter();\n+  char getPaddingCharacter();\n \n-  /**\n-   * returns Hll Log2m parameter\n-   * @return\n-   */\n   int getHllLog2m();\n \n   /**\n-   * @return\n+   * Get the derived column name for the given original column and derived metric type.\n+   *\n+   * @param column original column name.\n+   * @param derivedMetricType derived metric type.\n+   * @return derived column name if exists.\n+   *         null if not.\n    */\n-  public Map<String, String> toMap();\n+  @Nullable\n+  String getDerivedColumn(String column, MetricFieldSpec.DerivedMetricType derivedMetricType);\n \n-  public boolean close();\n+  Map<String, String> toMap();\n \n+  boolean close();\n }",
                "deletions": 100
            },
            {
                "sha": "36cdb1d1193a49118049a03b62157c9f284acaf1",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/segment/StarTreeMetadata.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-common/src/main/java/com/linkedin/pinot/common/segment/StarTreeMetadata.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-common/src/main/java/com/linkedin/pinot/common/segment/StarTreeMetadata.java",
                "status": "modified",
                "changes": 13,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/segment/StarTreeMetadata.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -16,8 +16,6 @@\n package com.linkedin.pinot.common.segment;\n \n import java.util.List;\n-import java.util.Map;\n-import javax.annotation.Nullable;\n \n \n /**\n@@ -32,8 +30,6 @@\n   private long _maxLeafRecords;\n   private long _skipMaterializationCardinality;\n \n-  private Map<String, String> _hllOriginToDerivedColumnMap;\n-\n   public StarTreeMetadata() {\n   }\n \n@@ -76,13 +72,4 @@ public void setSkipMaterializationCardinality(Long skipMaterializationCardinalit\n   public void setSkipMaterializationForDimensions(List<String> skipMaterializationForDimensions) {\n     _skipMaterializationForDimensions = skipMaterializationForDimensions;\n   }\n-\n-  @Nullable\n-  public String getDerivedHllColumnFromOrigin(String originColumn) {\n-    return _hllOriginToDerivedColumnMap.get(originColumn);\n-  }\n-\n-  public void setHllOriginToDerivedColumnMap(Map<String, String> hllOriginToDerivedColumnMap) {\n-    _hllOriginToDerivedColumnMap = hllOriginToDerivedColumnMap;\n-  }\n }",
                "deletions": 13
            },
            {
                "sha": "0d46df09e1f7fe8c6235e3432884003461c31459",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java",
                "status": "modified",
                "changes": 44,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -15,7 +15,6 @@\n  */\n package com.linkedin.pinot.common.utils.request;\n \n-import com.google.common.base.Preconditions;\n import com.google.common.collect.ImmutableSet;\n import com.linkedin.pinot.common.request.AggregationInfo;\n import com.linkedin.pinot.common.request.BrokerRequest;\n@@ -31,14 +30,14 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n-import javax.annotation.Nullable;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n \n public class RequestUtils {\n+  private RequestUtils() {\n+  }\n \n-  private static final Logger LOGGER = LoggerFactory.getLogger(RequestUtils.class);\n   private static final String USE_STAR_TREE_KEY = \"useStarTree\";\n \n   /**\n@@ -220,45 +219,6 @@ public static boolean isFitForStarTreeIndex(SegmentMetadata segmentMetadata, Fil\n     return true;\n   }\n \n-  /**\n-   * Must be called after a successful check of {@link #isFitForStarTreeIndex}\n-   * @return true if no fasthll aggregation or rewriting successful, false otherwise\n-   */\n-  public static boolean performFastHllRewriting(SegmentMetadata segmentMetadata, BrokerRequest brokerRequest) {\n-    List<AggregationInfo> aggregationsInfo = brokerRequest.getAggregationsInfo();\n-    StarTreeMetadata starTreeMetadata = segmentMetadata.getStarTreeMetadata();\n-    Map<AggregationInfo, String> fastHllAggregationInfoToDerivedColumnNameMap = new HashMap<>();\n-    // Check if all fasthll derived columns exist\n-    for (AggregationInfo aggregationInfo : aggregationsInfo) {\n-      if (aggregationInfo.getAggregationType().toLowerCase().equals(\"fasthll\")) {\n-        String derivedColumn = extractDerivedColumn(aggregationInfo, starTreeMetadata);\n-        if (derivedColumn == null) {\n-          // If derivedColumn does not exist, which means we need to aggregate directly on original column,\n-          // in that case, star tree can not be used since no generated star tree docs are available.\n-          return false;\n-        } else {\n-          fastHllAggregationInfoToDerivedColumnNameMap.put(aggregationInfo, derivedColumn);\n-        }\n-      }\n-    }\n-    // Rewrite all fasthll derived columns\n-    for (AggregationInfo aggregationInfo : fastHllAggregationInfoToDerivedColumnNameMap.keySet()) {\n-      String derivedColumn = fastHllAggregationInfoToDerivedColumnNameMap.get(aggregationInfo);\n-      LOGGER.info(\"Performed rewriting to fasthll({})\", derivedColumn);\n-      aggregationInfo.getAggregationParams().put(\"column\", derivedColumn);\n-    }\n-    return true;\n-  }\n-\n-  @Nullable\n-  private static String extractDerivedColumn(AggregationInfo aggregationInfo, StarTreeMetadata starTreeMetadata) {\n-    String[] columns = aggregationInfo.getAggregationParams().get(\"column\").trim().split(\",\");\n-    Preconditions.checkArgument(columns.length == 1);\n-    String aggrColumn = columns[0];\n-    return starTreeMetadata.getDerivedHllColumnFromOrigin(aggrColumn);\n-  }\n-\n-\n   /**\n    * This method returns the value of {@link #USE_STAR_TREE_KEY} boolean flag specified in the debug options\n    * in broker request. If the flag is not specified in the debug options, it returns true.",
                "deletions": 42
            },
            {
                "sha": "fcf74592a23fdf8be8ad8c20d7e1b9cdde2105b9",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/retention/RetentionManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/retention/RetentionManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/retention/RetentionManagerTest.java",
                "status": "modified",
                "changes": 12,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/retention/RetentionManagerTest.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.controller.helix.retention;\n \n+import com.linkedin.pinot.common.data.MetricFieldSpec;\n import com.linkedin.pinot.core.startree.hll.HllConstants;\n import java.io.File;\n import java.io.IOException;\n@@ -452,12 +453,14 @@ public String getBitmapInvertedIndexFileName(String column, String segmentVersio\n         throw new UnsupportedOperationException(\"getBitmapInvertedIndexFileName not supported in \" + this.getClass());\n       }\n \n-      @Nullable @Override public String getCreatorName() {\n+      @Nullable\n+      @Override\n+      public String getCreatorName() {\n         return null;\n       }\n \n       @Override\n-      public Character getPaddingCharacter() {\n+      public char getPaddingCharacter() {\n         return V1Constants.Str.DEFAULT_STRING_PAD_CHAR;\n       }\n \n@@ -466,6 +469,11 @@ public int getHllLog2m() {\n         return HllConstants.DEFAULT_LOG2M;\n       }\n \n+      @Nullable\n+      @Override\n+      public String getDerivedColumn(String column, MetricFieldSpec.DerivedMetricType derivedMetricType) {\n+        return null;\n+      }\n     };\n     return segmentMetadata;\n   }",
                "deletions": 2
            },
            {
                "sha": "976325577260f90e2ba30beb3f2ace1abfb622b9",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/validation/ValidationManagerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-controller/src/test/java/com/linkedin/pinot/controller/validation/ValidationManagerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-controller/src/test/java/com/linkedin/pinot/controller/validation/ValidationManagerTest.java",
                "status": "modified",
                "changes": 14,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/validation/ValidationManagerTest.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.controller.validation;\n \n+import com.linkedin.pinot.common.data.MetricFieldSpec;\n import com.linkedin.pinot.common.metrics.ControllerMetrics;\n import com.yammer.metrics.core.MetricsRegistry;\n import java.util.ArrayList;\n@@ -541,6 +542,7 @@ public boolean hasStarTree() {\n       return false;\n     }\n \n+    @Nullable\n     @Override\n     public StarTreeMetadata getStarTreeMetadata() {\n       return null;\n@@ -564,18 +566,26 @@ public String getBitmapInvertedIndexFileName(String column, String segmentVersio\n       return null;\n     }\n \n-    @Nullable @Override public String getCreatorName() {\n+    @Nullable\n+    @Override\n+    public String getCreatorName() {\n       return null;\n     }\n \n     @Override\n-    public Character getPaddingCharacter() {\n+    public char getPaddingCharacter() {\n       return V1Constants.Str.DEFAULT_STRING_PAD_CHAR;\n     }\n \n     @Override\n     public int getHllLog2m() {\n       return HllConstants.DEFAULT_LOG2M;\n     }\n+\n+    @Nullable\n+    @Override\n+    public String getDerivedColumn(String column, MetricFieldSpec.DerivedMetricType derivedMetricType) {\n+      return null;\n+    }\n   }\n }",
                "deletions": 2
            },
            {
                "sha": "e1007349436fd2e2178799bb94d39369f9101e77",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationGroupByPlanNode.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationGroupByPlanNode.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationGroupByPlanNode.java",
                "status": "modified",
                "changes": 3,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationGroupByPlanNode.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -61,9 +61,6 @@ public AggregationGroupByPlanNode(IndexSegment indexSegment, BrokerRequest broke\n       }\n       String columns = aggregationInfo.getAggregationParams().get(\"column\").trim();\n       aggregationGroupByRelatedColumns.addAll(Arrays.asList(columns.split(\",\")));\n-      if (aggregationInfo.getAggregationType().equalsIgnoreCase(\"fasthll\")) {\n-        aggregationGroupByRelatedColumns.add(columns + HllConstants.DEFAULT_HLL_DERIVE_COLUMN_SUFFIX);\n-      }\n     }\n     aggregationGroupByRelatedColumns.addAll(_groupBy.getColumns());\n     return aggregationGroupByRelatedColumns.toArray(new String[aggregationGroupByRelatedColumns.size()]);",
                "deletions": 3
            },
            {
                "sha": "39e13bad5d8c5a4460509d0d66257bbd4476af87",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationPlanNode.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationPlanNode.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationPlanNode.java",
                "status": "modified",
                "changes": 3,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/AggregationPlanNode.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -58,9 +58,6 @@ public AggregationPlanNode(IndexSegment indexSegment, BrokerRequest brokerReques\n       if (!aggregationInfo.getAggregationType().equalsIgnoreCase(\"count\")) {\n         String columns = aggregationInfo.getAggregationParams().get(\"column\").trim();\n         aggregationRelatedColumns.addAll(Arrays.asList(columns.split(\",\")));\n-        if (aggregationInfo.getAggregationType().equalsIgnoreCase(\"fasthll\")) {\n-          aggregationRelatedColumns.add(columns + HllConstants.DEFAULT_HLL_DERIVE_COLUMN_SUFFIX);\n-        }\n       }\n     }\n     return aggregationRelatedColumns.toArray(new String[aggregationRelatedColumns.size()]);",
                "deletions": 3
            },
            {
                "sha": "476ddcc91cf2819fb72a8997cc806749fef40723",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/FilterPlanNode.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/FilterPlanNode.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/FilterPlanNode.java",
                "status": "modified",
                "changes": 5,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/FilterPlanNode.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -63,9 +63,8 @@ public Operator run() {\n     long start = System.currentTimeMillis();\n     Operator operator;\n     FilterQueryTree filterQueryTree = RequestUtils.generateFilterQueryTree(_brokerRequest);\n-    if (_segment.getSegmentMetadata().hasStarTree() &&\n-        RequestUtils.isFitForStarTreeIndex(_segment.getSegmentMetadata(), filterQueryTree, _brokerRequest) &&\n-        RequestUtils.performFastHllRewriting(_segment.getSegmentMetadata(), _brokerRequest)) {\n+    if (_segment.getSegmentMetadata().hasStarTree()\n+        && RequestUtils.isFitForStarTreeIndex(_segment.getSegmentMetadata(), filterQueryTree, _brokerRequest)) {\n       operator = new StarTreeIndexOperator(_segment, _brokerRequest);\n     } else {\n       operator = constructPhysicalOperator(filterQueryTree);",
                "deletions": 3
            },
            {
                "sha": "f4b4035f1a4c1df9aec2e70998c763f2ee25b63b",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/BrokerRequestPreProcessor.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/BrokerRequestPreProcessor.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/BrokerRequestPreProcessor.java",
                "status": "added",
                "changes": 93,
                "additions": 93,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/BrokerRequestPreProcessor.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -0,0 +1,93 @@\n+/**\n+ * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linkedin.pinot.core.plan.maker;\n+\n+import com.linkedin.pinot.common.data.MetricFieldSpec;\n+import com.linkedin.pinot.common.request.AggregationInfo;\n+import com.linkedin.pinot.common.request.BrokerRequest;\n+import com.linkedin.pinot.common.segment.SegmentMetadata;\n+import com.linkedin.pinot.core.indexsegment.IndexSegment;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\n+/**\n+ * The <code>BrokerRequestPreProcessor</code> class provides the utility to pre-process the {@link BrokerRequest}.\n+ * <p>After the pre-process, the {@link BrokerRequest} should not be further changed.\n+ */\n+public class BrokerRequestPreProcessor {\n+  private BrokerRequestPreProcessor() {\n+  }\n+\n+  /**\n+   * Pre-process the {@link BrokerRequest}.\n+   * <p>Will apply the changes directly to the passed in object.\n+   * <p>The following steps are performed:\n+   * <ul>\n+   *   <li>Rewrite 'fasthll' column name.</li>\n+   * </ul>\n+   *\n+   * @param indexSegments list of index segments.\n+   * @param brokerRequest broker request.\n+   */\n+  public static void preProcess(List<IndexSegment> indexSegments, BrokerRequest brokerRequest) {\n+    if (brokerRequest.isSetAggregationsInfo()) {\n+      List<AggregationInfo> aggregationsInfo = brokerRequest.getAggregationsInfo();\n+      rewriteFastHllColumnName(indexSegments, aggregationsInfo);\n+    }\n+  }\n+\n+  /**\n+   * Rewrite 'fasthll' column name.\n+   *\n+   * @param indexSegments list of index segments.\n+   * @param aggregationsInfo list of aggregation info.\n+   */\n+  private static void rewriteFastHllColumnName(List<IndexSegment> indexSegments,\n+      List<AggregationInfo> aggregationsInfo) {\n+    // Consistent check.\n+    for (AggregationInfo aggregationInfo : aggregationsInfo) {\n+      if (aggregationInfo.getAggregationType().equalsIgnoreCase(\"fasthll\")) {\n+        String column = aggregationInfo.getAggregationParams().get(\"column\").trim();\n+        boolean isFirstSegment = true;\n+        String firstSegmentName = null;\n+        String hllDerivedColumn = null;\n+        for (IndexSegment indexSegment : indexSegments) {\n+          SegmentMetadata segmentMetadata = indexSegment.getSegmentMetadata();\n+          if (isFirstSegment) {\n+            // Use metadata from first index segment to perform rewrite.\n+            isFirstSegment = false;\n+            firstSegmentName = segmentMetadata.getName();\n+            hllDerivedColumn = segmentMetadata.getDerivedColumn(column, MetricFieldSpec.DerivedMetricType.HLL);\n+            if (hllDerivedColumn != null) {\n+              aggregationInfo.getAggregationParams().put(\"column\", hllDerivedColumn);\n+            }\n+          } else {\n+            // Perform consistency check on other index segments.\n+            String hllDerivedColumnToCheck =\n+                segmentMetadata.getDerivedColumn(column, MetricFieldSpec.DerivedMetricType.HLL);\n+            if (!Objects.equals(hllDerivedColumn, hllDerivedColumnToCheck)) {\n+              throw new RuntimeException(\n+                  \"Found inconsistency HLL derived column name. In segment \" + firstSegmentName + \": \"\n+                      + hllDerivedColumn + \"; In segment \" + segmentMetadata.getName() + \": \"\n+                      + hllDerivedColumnToCheck);\n+            }\n+          }\n+        }\n+      }\n+    }\n+  }\n+}",
                "deletions": 0
            },
            {
                "sha": "9f1ad6d82499979dea5a0180112c979e949b85a9",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/InstancePlanMakerImplV2.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/InstancePlanMakerImplV2.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/InstancePlanMakerImplV2.java",
                "status": "modified",
                "changes": 11,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/maker/InstancePlanMakerImplV2.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -92,12 +92,19 @@ public PlanNode makeInnerSegmentPlan(IndexSegment indexSegment, BrokerRequest br\n   @Override\n   public Plan makeInterSegmentPlan(List<SegmentDataManager> segmentDataManagers, BrokerRequest brokerRequest,\n       ExecutorService executorService, long timeOutMs) {\n-    List<PlanNode> planNodes = new ArrayList<>();\n+    // TODO: pass in List<IndexSegment> directly.\n+    List<IndexSegment> indexSegments = new ArrayList<>(segmentDataManagers.size());\n     for (SegmentDataManager segmentDataManager : segmentDataManagers) {\n-      IndexSegment indexSegment = segmentDataManager.getSegment();\n+      indexSegments.add(segmentDataManager.getSegment());\n+    }\n+    BrokerRequestPreProcessor.preProcess(indexSegments, brokerRequest);\n+\n+    List<PlanNode> planNodes = new ArrayList<>();\n+    for (IndexSegment indexSegment : indexSegments) {\n       planNodes.add(makeInnerSegmentPlan(indexSegment, brokerRequest));\n     }\n     CombinePlanNode combinePlanNode = new CombinePlanNode(planNodes, brokerRequest, executorService, timeOutMs);\n+\n     return new GlobalPlanImplV0(new InstanceResponsePlanNode(combinePlanNode));\n   }\n }",
                "deletions": 2
            },
            {
                "sha": "efb66f202813d196be0d9666cf35f400daadd1f9",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/utils/SimpleSegmentMetadata.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/query/utils/SimpleSegmentMetadata.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/query/utils/SimpleSegmentMetadata.java",
                "status": "modified",
                "changes": 14,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/utils/SimpleSegmentMetadata.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.core.query.utils;\n \n+import com.linkedin.pinot.common.data.MetricFieldSpec;\n import com.linkedin.pinot.common.segment.StarTreeMetadata;\n import com.linkedin.pinot.core.segment.creator.impl.V1Constants;\n import com.linkedin.pinot.core.startree.hll.HllConstants;\n@@ -172,6 +173,7 @@ public boolean hasStarTree() {\n     return false;\n   }\n \n+  @Nullable\n   @Override\n   public StarTreeMetadata getStarTreeMetadata() {\n     return null;\n@@ -195,11 +197,14 @@ public String getBitmapInvertedIndexFileName(String column, String segmentVersio\n     return null;\n   }\n \n-  @Nullable @Override public String getCreatorName() {\n+  @Nullable\n+  @Override\n+  public String getCreatorName() {\n     return null;\n   }\n \n-  @Override public Character getPaddingCharacter() {\n+  @Override\n+  public char getPaddingCharacter() {\n     return _paddingCharacter;\n   }\n \n@@ -208,4 +213,9 @@ public int getHllLog2m() {\n     return HllConstants.DEFAULT_LOG2M;\n   }\n \n+  @Nullable\n+  @Override\n+  public String getDerivedColumn(String column, MetricFieldSpec.DerivedMetricType derivedMetricType) {\n+    return null;\n+  }\n }",
                "deletions": 2
            },
            {
                "sha": "76007d16f15f660818de15909dca3d038e94bb23",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/83b3512def190c49233a14280e5c178169ff155f/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java",
                "status": "modified",
                "changes": 68,
                "additions": 33,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/SegmentMetadataImpl.java?ref=83b3512def190c49233a14280e5c178169ff155f",
                "patch": "@@ -85,6 +85,7 @@\n   private String _creatorName;\n   private char _paddingCharacter = V1Constants.Str.DEFAULT_STRING_PAD_CHAR;\n   private int _hllLog2m = HllConstants.DEFAULT_LOG2M;\n+  private final Map<String, String> _hllDerivedColumnMap = new HashMap<>();\n \n   public SegmentMetadataImpl(File indexDir) throws ConfigurationException, IOException {\n     LOGGER.debug(\"SegmentMetadata location: {}\", indexDir);\n@@ -284,28 +285,27 @@ private void init() {\n       }\n     }\n \n-    // Column Metadata\n-    for (final String column : _allColumns) {\n-      _columnMetadataMap.put(column,\n-          ColumnMetadata.fromPropertiesConfiguration(column, _segmentMetadataPropertiesConfiguration));\n-    }\n-\n-    // Segment Name\n+    // Set segment name.\n     _segmentName = _segmentMetadataPropertiesConfiguration.getString(Segment.SEGMENT_NAME);\n \n-    // Set hll log2m\n+    // Set hll log2m.\n     _hllLog2m = _segmentMetadataPropertiesConfiguration.getInt(Segment.SEGMENT_HLL_LOG2M, HllConstants.DEFAULT_LOG2M);\n \n-    // StarTree config here\n-    _hasStarTree = _segmentMetadataPropertiesConfiguration.getBoolean(\n-        MetadataKeys.StarTree.STAR_TREE_ENABLED, false);\n-    if (_hasStarTree) {\n-      initStarTreeMetadata();\n+    // Build column metadata map, schema and hll derived column map.\n+    for (String column : _allColumns) {\n+      ColumnMetadata columnMetadata =\n+          ColumnMetadata.fromPropertiesConfiguration(column, _segmentMetadataPropertiesConfiguration);\n+      _columnMetadataMap.put(column, columnMetadata);\n+      _schema.addField(columnMetadata.getFieldSpec());\n+      if (columnMetadata.getDerivedMetricType() == MetricFieldSpec.DerivedMetricType.HLL) {\n+        _hllDerivedColumnMap.put(columnMetadata.getOriginColumnName(), columnMetadata.getColumnName());\n+      }\n     }\n \n-    // Build Schema\n-    for (final String column : _columnMetadataMap.keySet()) {\n-      _schema.addField(_columnMetadataMap.get(column).getFieldSpec());\n+    // Build star-tree metadata.\n+    _hasStarTree = _segmentMetadataPropertiesConfiguration.getBoolean(MetadataKeys.StarTree.STAR_TREE_ENABLED, false);\n+    if (_hasStarTree) {\n+      initStarTreeMetadata();\n     }\n   }\n \n@@ -315,23 +315,6 @@ private void init() {\n   private void initStarTreeMetadata() {\n     _starTreeMetadata = new StarTreeMetadata();\n \n-    // Build Derived Column Map\n-    Map<String, String> hllOriginToDerivedColumnMap = new HashMap<>();\n-    for (final ColumnMetadata columnMetadata : _columnMetadataMap.values()) {\n-      MetricFieldSpec.DerivedMetricType derivedMetricType = columnMetadata.getDerivedMetricType();\n-      if (derivedMetricType != null) {\n-        switch (derivedMetricType) {\n-          case HLL:\n-            hllOriginToDerivedColumnMap.put(columnMetadata.getOriginColumnName(), columnMetadata.getColumnName());\n-            break;\n-          default:\n-            throw new IllegalArgumentException(\n-                columnMetadata.getDerivedMetricType() + \" type is not supported in building derived columns.\");\n-        }\n-      }\n-    }\n-    _starTreeMetadata.setHllOriginToDerivedColumnMap(hllOriginToDerivedColumnMap);\n-\n     // Set the maxLeafRecords\n     String maxLeafRecordsString =\n         _segmentMetadataPropertiesConfiguration.getString(\n@@ -533,6 +516,7 @@ public boolean hasStarTree() {\n     return _hasStarTree;\n   }\n \n+  @Nullable\n   @Override\n   public StarTreeMetadata getStarTreeMetadata() {\n     return _starTreeMetadata;\n@@ -568,11 +552,14 @@ public String getBitmapInvertedIndexFileName(String column, String segmentVersio\n     return column + V1Constants.Indexes.BITMAP_INVERTED_INDEX_FILE_EXTENSION;\n   }\n \n-  @Nullable @Override public String getCreatorName() {\n+  @Nullable\n+  @Override\n+  public String getCreatorName() {\n     return _creatorName;\n   }\n \n-  @Override public Character getPaddingCharacter() {\n+  @Override\n+  public char getPaddingCharacter() {\n     return _paddingCharacter;\n   }\n \n@@ -581,6 +568,17 @@ public int getHllLog2m() {\n     return _hllLog2m;\n   }\n \n+  @Nullable\n+  @Override\n+  public String getDerivedColumn(String column, MetricFieldSpec.DerivedMetricType derivedMetricType) {\n+    switch (derivedMetricType) {\n+      case HLL:\n+        return _hllDerivedColumnMap.get(column);\n+      default:\n+        throw new IllegalArgumentException();\n+    }\n+  }\n+\n   /**\n    * Converts segment metadata to json\n    * @param columnFilter list only  the columns in the set. Lists all the columns if",
                "deletions": 35
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Avoid NPE when indexing a null multivalue\n\nRB=635295\nG=pinot-dev-reviewers\nR=kgopalak,jfim,atumbde,ssubrama,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/ecfe52cc4a23c2c29c5bb61baaa040d8933b12c2",
        "parent": "https://github.com/apache/incubator-pinot/commit/3ae7f9c572af4130ef39ad40bd39863ebde70db1",
        "bug_id": "incubator-pinot_67",
        "file": [
            {
                "sha": "8524442ed501c9d45cbc025f20d3b340c3a34881",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ecfe52cc4a23c2c29c5bb61baaa040d8933b12c2/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ecfe52cc4a23c2c29c5bb61baaa040d8933b12c2/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java",
                "status": "modified",
                "changes": 16,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/RealtimeSegmentImpl.java?ref=ecfe52cc4a23c2c29c5bb61baaa040d8933b12c2",
                "patch": "@@ -15,7 +15,6 @@\n  */\n package com.linkedin.pinot.core.realtime.impl;\n \n-import com.linkedin.pinot.core.indexsegment.IndexSegment;\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Arrays;\n@@ -26,7 +25,6 @@\n import java.util.Map;\n import java.util.concurrent.atomic.AtomicInteger;\n \n-import com.linkedin.pinot.core.indexsegment.IndexSegment;\n import com.linkedin.pinot.core.startree.StarTreeIndexNode;\n import org.joda.time.DateTime;\n import org.joda.time.Interval;\n@@ -63,6 +61,7 @@\n \n public class RealtimeSegmentImpl implements RealtimeSegment {\n   private static final Logger LOGGER = LoggerFactory.getLogger(RealtimeSegmentImpl.class);\n+  public static final int[] EMPTY_DICTIONARY_IDS_ARRAY = new int[0];\n \n   private SegmentMetadataImpl _segmentMetadata;\n   private final Schema dataSchema;\n@@ -209,10 +208,17 @@ public boolean index(GenericRow row) {\n         rawRowToDicIdMap.put(dimension, dicId);\n       } else {\n         Object[] mValues = (Object[]) row.getValue(dimension);\n-        int[] dicIds = new int[mValues.length];\n-        for (int i = 0; i < dicIds.length; i++) {\n-          dicIds[i] = dictionaryMap.get(dimension).indexOf(mValues[i]);\n+        int[] dicIds;\n+\n+        if (mValues != null) {\n+          dicIds = new int[mValues.length];\n+          for (int i = 0; i < dicIds.length; i++) {\n+            dicIds[i] = dictionaryMap.get(dimension).indexOf(mValues[i]);\n+          }\n+        } else {\n+          dicIds = EMPTY_DICTIONARY_IDS_ARRAY;\n         }\n+\n         ((FixedByteSingleColumnMultiValueReaderWriter) columnIndexReaderWriterMap.get(dimension)).setIntArray(docId,\n             dicIds);\n         rawRowToDicIdMap.put(dimension, dicIds);",
                "deletions": 5
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE after swapping a realtime segment\n\nRB=621658\nG=pinot-dev-reviewers\nR=kgopalak,jfim,atumbde,ssubrama,mshrivas\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/9f9f95c2ff58c3104505846969a9106ee4da3d14",
        "parent": "https://github.com/apache/incubator-pinot/commit/fff33cfc7f1c729ef7770b7bb5dd666411fe13db",
        "bug_id": "incubator-pinot_68",
        "file": [
            {
                "sha": "da6fa71f0866210db00e6c32e529b71a3c2fad5d",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/9f9f95c2ff58c3104505846969a9106ee4da3d14/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/9f9f95c2ff58c3104505846969a9106ee4da3d14/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java?ref=9f9f95c2ff58c3104505846969a9106ee4da3d14",
                "patch": "@@ -190,6 +190,8 @@ public void run() {\n \n           kafkaStreamProvider.commit();\n           kafkaStreamProvider.shutdown();\n+\n+          realtimeSegment = null;\n         } catch (Exception e) {\n           LOGGER.error(\"Caught exception in the realtime indexing thread\", e);\n         }\n@@ -208,7 +210,6 @@ public void swap() throws Exception {\n     IndexSegment segment = Loaders.IndexSegment.load(new File(resourceDir, segmentMetatdaZk.getSegmentName()), mode);\n     synchronized (lock) {\n       indexSegment = segment;\n-      realtimeSegment = null;\n     }\n   }\n ",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "PINOT-1978 NPE fix when an offline table has no validation config\n\nRB=558304\nG=pinot-dev-reviewers\nR=kgopalak,xiafu,jfim,dpatel,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/55faf779594eaebfb5edceb47eeed0d2818cf32f",
        "parent": "https://github.com/apache/incubator-pinot/commit/aef7db88ff8563cbe59189ccda4eeefab55cffd4",
        "bug_id": "incubator-pinot_69",
        "file": [
            {
                "sha": "5b4e0eebcbab0e6782042de6fb31251362f6ff5a",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/55faf779594eaebfb5edceb47eeed0d2818cf32f/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/55faf779594eaebfb5edceb47eeed0d2818cf32f/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/RetentionManager.java?ref=55faf779594eaebfb5edceb47eeed0d2818cf32f",
                "patch": "@@ -173,7 +173,7 @@ private void updateDeletionStrategiesForEntireCluster() {\n       return tableToDeletionStrategyMap;\n     }\n \n-    if (offlineTableConfig == null) {\n+    if (offlineTableConfig == null || offlineTableConfig.getValidationConfig() == null) {\n       LOGGER.info(\"Table config null for table: {}, treating it as refresh only table.\", offlineTableName);\n       return tableToDeletionStrategyMap;\n     }",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixed exception message that caused a NPE when logging an exception\n\nRB=532346\nBUG=\nG=pinot-dev-reviewers\nR=kgopalak,xiafu,jfim,dpatel,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/aa1db3e57cf096f4c6db6236a5ac7687514fb6d6",
        "parent": "https://github.com/apache/incubator-pinot/commit/bab1b9f5b4d8eef9df6c95be6a2e1a5d7ec0af6e",
        "bug_id": "incubator-pinot_70",
        "file": [
            {
                "sha": "b774b97f30930b5ee4de22965e4d6ad5b348751d",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableMetadataConfigs.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/aa1db3e57cf096f4c6db6236a5ac7687514fb6d6/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableMetadataConfigs.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/aa1db3e57cf096f4c6db6236a5ac7687514fb6d6/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableMetadataConfigs.java",
                "status": "modified",
                "changes": 10,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableMetadataConfigs.java?ref=aa1db3e57cf096f4c6db6236a5ac7687514fb6d6",
                "patch": "@@ -53,12 +53,10 @@ public Representation put(Representation entity) {\n       return new StringRepresentation(\"tableName is not present\");\n     }\n \n-    AbstractTableConfig config = null;\n-\n     try {\n-      return updateTableMetadata(tableName, entity, config);\n+      return updateTableMetadata(tableName, entity);\n     } catch (final Exception e) {\n-      LOGGER.error(\"errpr updating medata configs for table {}\", config.getTableName(), e);\n+      LOGGER.error(\"Caught exception while updating metadata for table {}\", tableName, e);\n       return PinotSegmentUploadRestletResource.exceptionToStringRepresentation(e);\n     }\n   }\n@@ -71,9 +69,9 @@ public Representation put(Representation entity) {\n   })\n   private Representation updateTableMetadata(\n       @Parameter(name = \"tableName\", in = \"path\", description = \"The name of the table for which to update the metadata configuration\", required = true)\n-      String tableName, Representation entity, AbstractTableConfig config)\n+      String tableName, Representation entity)\n       throws Exception {\n-    config = AbstractTableConfig.init(entity.getText());\n+    AbstractTableConfig config = AbstractTableConfig.init(entity.getText());\n     manager.updateMetadataConfigFor(config.getTableName(), TableType.valueOf(config.getTableType()),\n         config.getCustomConfigs());\n     return new StringRepresentation(\"done\");",
                "deletions": 6
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE for flitering query.\nFixing exception in combinePlanNode.run() will cause query to be halted.\n\nRB=496031\nR=xiafu\nA=dpatel",
        "commit": "https://github.com/apache/incubator-pinot/commit/031d3b19e61ac0cb3799ee1024207f665590e30a",
        "parent": "https://github.com/apache/incubator-pinot/commit/375159aa5fb729aaf5857b052492266047070023",
        "bug_id": "incubator-pinot_71",
        "file": [
            {
                "sha": "fc69866c26e9bf0a7ffc22a3c39a64958ca880af",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/plan/CombinePlanNode.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/031d3b19e61ac0cb3799ee1024207f665590e30a/pinot-core/src/main/java/com/linkedin/pinot/core/plan/CombinePlanNode.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/031d3b19e61ac0cb3799ee1024207f665590e30a/pinot-core/src/main/java/com/linkedin/pinot/core/plan/CombinePlanNode.java",
                "status": "modified",
                "changes": 12,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/plan/CombinePlanNode.java?ref=031d3b19e61ac0cb3799ee1024207f665590e30a",
                "patch": "@@ -20,7 +20,6 @@\n import java.util.concurrent.ConcurrentLinkedQueue;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n import java.util.concurrent.TimeUnit;\n \n import org.slf4j.Logger;\n@@ -74,9 +73,14 @@ public Operator run() {\n         _executorService.execute(new Runnable() {\n           @Override\n           public void run() {\n-            Operator operator = planNode.run();\n-            queue.add(operator);\n-            latch.countDown();\n+            try {\n+              Operator operator = planNode.run();\n+              queue.add(operator);\n+            } catch (Exception e) {\n+              LOGGER.error(\"Getting exception when trying to run a planNode\", e);\n+            } finally {\n+              latch.countDown();\n+            }\n           }\n         });\n       }",
                "deletions": 4
            },
            {
                "sha": "15ee1ea094dc7d7b733750f5875620f8d1baf2e7",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/031d3b19e61ac0cb3799ee1024207f665590e30a/pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/031d3b19e61ac0cb3799ee1024207f665590e30a/pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/pruner/DataSchemaSegmentPruner.java?ref=031d3b19e61ac0cb3799ee1024207f665590e30a",
                "patch": "@@ -40,7 +40,7 @@\n   public boolean prune(IndexSegment segment, BrokerRequest brokerRequest) {\n     Schema schema = segment.getSegmentMetadata().getSchema();\n     // Check filtering columns\n-    if (!filterQueryMatchedSchema(schema, brokerRequest.getFilterQuery(), brokerRequest.getFilterSubQueryMap())) {\n+    if (brokerRequest.getFilterQuery() != null && !filterQueryMatchedSchema(schema, brokerRequest.getFilterQuery(), brokerRequest.getFilterSubQueryMap())) {\n       return true;\n     }\n     // Check aggregation function columns.",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix NPE in metrics if the BrokerRequest has a null query source\n\nRB=490493\nR=kgopalak,xiafu,jfim,dpatel,mshrivas\nA=mshrivas",
        "commit": "https://github.com/apache/incubator-pinot/commit/9bd2f4e3916a0a930d61239b537e406d1626cac2",
        "parent": "https://github.com/apache/incubator-pinot/commit/e24727e445c8beaf33765114813cce98ee9510c8",
        "bug_id": "incubator-pinot_72",
        "file": [
            {
                "sha": "ed13ee6f43aeb7133ceadd1a50a3f5d63c08b459",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/metrics/AbstractMetrics.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/9bd2f4e3916a0a930d61239b537e406d1626cac2/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/AbstractMetrics.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/9bd2f4e3916a0a930d61239b537e406d1626cac2/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/AbstractMetrics.java",
                "status": "modified",
                "changes": 6,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/AbstractMetrics.java?ref=9bd2f4e3916a0a930d61239b537e406d1626cac2",
                "patch": "@@ -81,7 +81,11 @@ public void addPhaseTiming(final BrokerRequest request, final QP phase, final lo\n    * @return The complete metric name\n    */\n   private String buildMetricName(BrokerRequest request, String metricName) {\n-    return _metricPrefix + request.getQuerySource().getTableName() + \".\" + metricName;\n+    if (request != null && request.getQuerySource() != null && request.getQuerySource().getTableName() != null) {\n+      return _metricPrefix + request.getQuerySource().getTableName() + \".\" + metricName;\n+    } else {\n+      return _metricPrefix + \"unknown.\" + metricName;\n+    }\n   }\n \n   /**",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Initialize the metadata of the data table with some defaults, fixes NPEs in DefaultReduceService and BrokerRequestHandler\n\nRB=470818\nR=kgopalak,xiafu,jfim,dpatel\nA=dpatel",
        "commit": "https://github.com/apache/incubator-pinot/commit/d0d4a8b1b43de5e8b1147923a02799a6e37d6bde",
        "parent": "https://github.com/apache/incubator-pinot/commit/df1dcd63f7f643a5d991557947862ad2e9ab169e",
        "bug_id": "incubator-pinot_73",
        "file": [
            {
                "sha": "16f36d3bcd84b8936e31f7dd2ca66219e80784e6",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d0d4a8b1b43de5e8b1147923a02799a6e37d6bde/pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d0d4a8b1b43de5e8b1147923a02799a6e37d6bde/pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java?ref=d0d4a8b1b43de5e8b1147923a02799a6e37d6bde",
                "patch": "@@ -24,6 +24,7 @@\n import java.io.ObjectOutputStream;\n import java.io.Serializable;\n import java.nio.ByteBuffer;\n+import java.util.HashMap;\n import java.util.Map;\n \n import com.linkedin.pinot.common.data.FieldSpec.DataType;\n@@ -214,6 +215,10 @@ public DataTable(byte[] buffer) {\n \n   public DataTable() {\n     // Used for empty results.\n+    metadata = new HashMap<String, String>();\n+    metadata.put(\"numDocsScanned\", \"0\");\n+    metadata.put(\"totalDocs\", \"0\");\n+    metadata.put(\"timeUsedMs\", \"0\");\n   }\n \n   /**",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE during filtering unexisted value in realtime segment.\nFixing no docs matched issue for aggregation functions.\n\nRB=465638\nR=xiafu\nA=jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/8c6fd1ccfd615c0f4848186a63aa12df579d4846",
        "parent": "https://github.com/apache/incubator-pinot/commit/4f13ac7b588ec8baf353a7f5495aa07b8fd9147e",
        "bug_id": "incubator-pinot_74",
        "file": [
            {
                "sha": "fc7605cecafc69ecdeff46ae40e5cc8a971274b6",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeResourceDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeResourceDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeResourceDataManager.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeResourceDataManager.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -39,6 +39,7 @@\n import com.linkedin.pinot.common.segment.ReadMode;\n import com.linkedin.pinot.common.segment.SegmentMetadata;\n import com.linkedin.pinot.common.utils.CommonConstants;\n+import com.linkedin.pinot.common.utils.CommonConstants.Segment.Realtime.Status;\n import com.linkedin.pinot.common.utils.NamedThreadFactory;\n import com.linkedin.pinot.core.data.manager.config.ResourceDataManagerConfig;\n import com.linkedin.pinot.core.data.manager.offline.OfflineSegmentDataManager;\n@@ -166,7 +167,7 @@ public void addSegment(ZkHelixPropertyStore<ZNRecord> propertyStore, DataResourc\n     this._helixPropertyStore = propertyStore;\n     String segmentId = segmentZKMetadata.getSegmentName();\n     if (segmentZKMetadata instanceof RealtimeSegmentZKMetadata) {\n-      if (new File(_indexDir, segmentId).exists()) {\n+      if (new File(_indexDir, segmentId).exists() && ((RealtimeSegmentZKMetadata) segmentZKMetadata).getStatus() == Status.DONE) {\n         // segment already exists on file, simply load it and add it to the map\n         if (!_segmentsMap.containsKey(segmentId)) {\n           synchronized (getGlobalLock()) {",
                "deletions": 1
            },
            {
                "sha": "c4736deaeeaa77fc3a6de0700f8c946d2f275cff",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java",
                "status": "modified",
                "changes": 5,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/realtime/RealtimeSegmentDataManager.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -147,8 +147,9 @@ public void run() {\n         try {\n           logger.info(\"Trying to build segment!\");\n           conveter.build();\n-          FileUtils.moveDirectory(tempSegmentFolder.listFiles()[0], new File(resourceDataDir,\n-              segmentMetadata.getSegmentName()));\n+          File destDir = new File(resourceDataDir, segmentMetadata.getSegmentName());\n+          FileUtils.deleteQuietly(destDir);\n+          FileUtils.moveDirectory(tempSegmentFolder.listFiles()[0], destDir);\n           FileUtils.deleteQuietly(tempSegmentFolder);\n           long startTime = ((RealtimeSegmentImpl) realtimeSegment).getMinTime();\n           long endTime = ((RealtimeSegmentImpl) realtimeSegment).getMaxTime();",
                "deletions": 2
            },
            {
                "sha": "951f3d4dad6ab977a3a53d7215ef6c66ca80d932",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MAggregationOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MAggregationOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MAggregationOperator.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MAggregationOperator.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -70,7 +70,7 @@ public boolean open() {\n   public Block nextBlock() {\n     List<Serializable> aggregationResults = new ArrayList<Serializable>();\n     for (int i = 0; i < _aggregationFunctionOperatorList.size(); ++i) {\n-      aggregationResults.add(null);\n+      aggregationResults.add(AggregationFunctionFactory.get(_aggregationInfoList.get(i), true).getDefaultValue());\n     }\n     final long startTime = System.currentTimeMillis();\n     long numDocsScanned = 0;",
                "deletions": 1
            },
            {
                "sha": "cce431b853a4cfacc10c81ecd7d081249c0a1b34",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/AggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/AggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/AggregationFunction.java",
                "status": "modified",
                "changes": 8,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/AggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -23,7 +23,6 @@\n import com.linkedin.pinot.common.data.FieldSpec.DataType;\n import com.linkedin.pinot.common.request.AggregationInfo;\n import com.linkedin.pinot.core.common.Block;\n-import com.linkedin.pinot.core.common.BlockValIterator;\n \n \n /**\n@@ -109,4 +108,11 @@\n    */\n   String getFunctionName();\n \n+  /**\n+   * Return default value if no doc is scanned.\n+   *\n+   * @return defaultValue\n+   */\n+  public Serializable getDefaultValue();\n+\n }",
                "deletions": 1
            },
            {
                "sha": "d29405228fe9f4e93b484cc53537592b734b9437",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/AvgAggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/AvgAggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/AvgAggregationFunction.java",
                "status": "modified",
                "changes": 13,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/AvgAggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -27,14 +27,12 @@\n import com.linkedin.pinot.core.common.Block;\n import com.linkedin.pinot.core.common.BlockDocIdIterator;\n import com.linkedin.pinot.core.common.BlockSingleValIterator;\n-import com.linkedin.pinot.core.common.BlockValIterator;\n import com.linkedin.pinot.core.common.Constants;\n import com.linkedin.pinot.core.query.aggregation.AggregationFunction;\n import com.linkedin.pinot.core.query.aggregation.CombineLevel;\n import com.linkedin.pinot.core.query.aggregation.function.AvgAggregationFunction.AvgPair;\n import com.linkedin.pinot.core.query.utils.Pair;\n import com.linkedin.pinot.core.segment.index.readers.Dictionary;\n-import com.linkedin.pinot.core.segment.index.readers.ImmutableDictionaryReader;\n \n \n /**\n@@ -173,11 +171,20 @@ public int compareTo(AvgPair o) {\n \n     @Override\n     public String toString() {\n-      return new DecimalFormat(\"####################.##########\").format((getFirst() / getSecond()));\n+      if (getSecond() != 0) {\n+        return new DecimalFormat(\"####################.##########\").format((getFirst() / getSecond()));\n+      } else {\n+        return \"0.0\";\n+      }\n     }\n   }\n \n   public AvgPair getAvgPair(double first, long second) {\n     return new AvgPair(first, second);\n   }\n+\n+  @Override\n+  public Serializable getDefaultValue() {\n+    return new AvgPair(0.0, 0L);\n+  }\n }",
                "deletions": 3
            },
            {
                "sha": "b52d2d9fe52cb3da6a9cd9c5059a731796db519c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/CountAggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/CountAggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/CountAggregationFunction.java",
                "status": "modified",
                "changes": 7,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/CountAggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.core.query.aggregation.function;\n \n+import java.io.Serializable;\n import java.util.List;\n \n import org.json.JSONException;\n@@ -23,7 +24,6 @@\n import com.linkedin.pinot.common.data.FieldSpec.DataType;\n import com.linkedin.pinot.common.request.AggregationInfo;\n import com.linkedin.pinot.core.common.Block;\n-import com.linkedin.pinot.core.common.BlockValIterator;\n import com.linkedin.pinot.core.operator.DocIdSetBlock;\n import com.linkedin.pinot.core.query.aggregation.AggregationFunction;\n import com.linkedin.pinot.core.query.aggregation.CombineLevel;\n@@ -111,4 +111,9 @@ public String getFunctionName() {\n     return \"count_star\";\n   }\n \n+  @Override\n+  public Serializable getDefaultValue() {\n+    return Long.valueOf(0);\n+  }\n+\n }",
                "deletions": 1
            },
            {
                "sha": "e9bfd34e1477226f826357d8970c6f460bdc3b53",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java",
                "status": "modified",
                "changes": 8,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -17,6 +17,7 @@\n \n import it.unimi.dsi.fastutil.ints.IntOpenHashSet;\n \n+import java.io.Serializable;\n import java.util.List;\n \n import org.json.JSONException;\n@@ -27,12 +28,10 @@\n import com.linkedin.pinot.core.common.Block;\n import com.linkedin.pinot.core.common.BlockDocIdIterator;\n import com.linkedin.pinot.core.common.BlockSingleValIterator;\n-import com.linkedin.pinot.core.common.BlockValIterator;\n import com.linkedin.pinot.core.common.Constants;\n import com.linkedin.pinot.core.query.aggregation.AggregationFunction;\n import com.linkedin.pinot.core.query.aggregation.CombineLevel;\n import com.linkedin.pinot.core.segment.index.readers.Dictionary;\n-import com.linkedin.pinot.core.segment.index.readers.ImmutableDictionaryReader;\n \n \n public class DistinctCountAggregationFunction implements AggregationFunction<IntOpenHashSet, Integer> {\n@@ -145,4 +144,9 @@ public String getFunctionName() {\n     return \"distinctCount_\" + _distinctCountColumnName;\n   }\n \n+  @Override\n+  public Serializable getDefaultValue() {\n+    return new IntOpenHashSet();\n+  }\n+\n }",
                "deletions": 2
            },
            {
                "sha": "02605014a9295a28a21d992fc05f576b36494c7f",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MaxAggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MaxAggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MaxAggregationFunction.java",
                "status": "modified",
                "changes": 17,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MaxAggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.core.query.aggregation.function;\n \n+import java.io.Serializable;\n import java.util.List;\n import java.util.NoSuchElementException;\n \n@@ -33,7 +34,7 @@\n \n \n public class MaxAggregationFunction implements AggregationFunction<Double, Double> {\n-\n+  private static final double DEFAULT_VALUE = Double.NEGATIVE_INFINITY;\n   private String _maxColumnName;\n \n   public MaxAggregationFunction() {\n@@ -47,7 +48,7 @@ public void init(AggregationInfo aggregationInfo) {\n \n   @Override\n   public Double aggregate(Block docIdSetBlock, Block[] block) {\n-    double ret = Double.NEGATIVE_INFINITY;\n+    double ret = DEFAULT_VALUE;\n     double tmp = 0;\n     int docId = 0;\n     Dictionary dictionaryReader = block[0].getMetadata().getDictionary();\n@@ -86,7 +87,7 @@ public Double aggregate(Double mergedResult, int docId, Block[] block) {\n \n   @Override\n   public List<Double> combine(List<Double> aggregationResultList, CombineLevel combineLevel) {\n-    double maxValue = Double.NEGATIVE_INFINITY;\n+    double maxValue = DEFAULT_VALUE;\n     for (double aggregationResult : aggregationResultList) {\n       if (maxValue < aggregationResult) {\n         maxValue = aggregationResult;\n@@ -110,7 +111,7 @@ public Double combineTwoValues(Double aggregationResult0, Double aggregationResu\n \n   @Override\n   public Double reduce(List<Double> combinedResultList) {\n-    double maxValue = Double.NEGATIVE_INFINITY;\n+    double maxValue = DEFAULT_VALUE;\n     for (double combinedResult : combinedResultList) {\n       if (maxValue < combinedResult) {\n         maxValue = combinedResult;\n@@ -125,6 +126,9 @@ public JSONObject render(Double finalAggregationResult) {\n       if (finalAggregationResult == null) {\n         throw new NoSuchElementException(\"Final result is null!\");\n       }\n+      if (finalAggregationResult.isInfinite()) {\n+        return new JSONObject().put(\"value\", \"null\");\n+      }\n       return new JSONObject().put(\"value\", String.format(\"%1.5f\", finalAggregationResult));\n     } catch (JSONException e) {\n       throw new RuntimeException(e);\n@@ -141,4 +145,9 @@ public String getFunctionName() {\n     return \"max_\" + _maxColumnName;\n   }\n \n+  @Override\n+  public Serializable getDefaultValue() {\n+    return new Double(DEFAULT_VALUE);\n+  }\n+\n }",
                "deletions": 4
            },
            {
                "sha": "8996ba720696521e4318c2dec547fc71002260f4",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MinAggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MinAggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MinAggregationFunction.java",
                "status": "modified",
                "changes": 16,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/MinAggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.core.query.aggregation.function;\n \n+import java.io.Serializable;\n import java.util.List;\n import java.util.NoSuchElementException;\n \n@@ -33,6 +34,7 @@\n \n \n public class MinAggregationFunction implements AggregationFunction<Double, Double> {\n+  private static final double DEFAULT_VALUE = Double.POSITIVE_INFINITY;\n   private String _minColumnName;\n \n   public MinAggregationFunction() {\n@@ -46,7 +48,7 @@ public void init(AggregationInfo aggregationInfo) {\n \n   @Override\n   public Double aggregate(Block docIdSetBlock, Block[] block) {\n-    double ret = Double.POSITIVE_INFINITY;\n+    double ret = DEFAULT_VALUE;\n     double tmp = 0;\n     int docId = 0;\n     Dictionary dictionaryReader = block[0].getMetadata().getDictionary();\n@@ -85,7 +87,7 @@ public Double aggregate(Double mergedResult, int docId, Block[] block) {\n \n   @Override\n   public List<Double> combine(List<Double> aggregationResultList, CombineLevel combineLevel) {\n-    double minValue = Double.POSITIVE_INFINITY;\n+    double minValue = DEFAULT_VALUE;\n     for (double aggregationResult : aggregationResultList) {\n       if (aggregationResult < minValue) {\n         minValue = aggregationResult;\n@@ -109,7 +111,7 @@ public Double combineTwoValues(Double aggregationResult0, Double aggregationResu\n \n   @Override\n   public Double reduce(List<Double> combinedResultList) {\n-    double minValue = Double.POSITIVE_INFINITY;\n+    double minValue = DEFAULT_VALUE;\n     for (double combinedResult : combinedResultList) {\n       if (combinedResult < minValue) {\n         minValue = combinedResult;\n@@ -124,6 +126,9 @@ public JSONObject render(Double finalAggregationResult) {\n       if (finalAggregationResult == null) {\n         throw new NoSuchElementException(\"Final result is null!\");\n       }\n+      if (finalAggregationResult.isInfinite()) {\n+        return new JSONObject().put(\"value\", \"null\");\n+      }\n       return new JSONObject().put(\"value\", String.format(\"%1.5f\", finalAggregationResult));\n     } catch (JSONException e) {\n       throw new RuntimeException(e);\n@@ -140,4 +145,9 @@ public String getFunctionName() {\n     return \"min_\" + _minColumnName;\n   }\n \n+  @Override\n+  public Serializable getDefaultValue() {\n+    return new Double(DEFAULT_VALUE);\n+  }\n+\n }",
                "deletions": 3
            },
            {
                "sha": "f35aab63779e533f5fee64d554c295869b938fb6",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/SumAggregationFunction.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/SumAggregationFunction.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/SumAggregationFunction.java",
                "status": "modified",
                "changes": 8,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/function/SumAggregationFunction.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -15,6 +15,7 @@\n  */\n package com.linkedin.pinot.core.query.aggregation.function;\n \n+import java.io.Serializable;\n import java.util.List;\n \n import org.json.JSONException;\n@@ -25,12 +26,10 @@\n import com.linkedin.pinot.core.common.Block;\n import com.linkedin.pinot.core.common.BlockDocIdIterator;\n import com.linkedin.pinot.core.common.BlockSingleValIterator;\n-import com.linkedin.pinot.core.common.BlockValIterator;\n import com.linkedin.pinot.core.common.Constants;\n import com.linkedin.pinot.core.query.aggregation.AggregationFunction;\n import com.linkedin.pinot.core.query.aggregation.CombineLevel;\n import com.linkedin.pinot.core.segment.index.readers.Dictionary;\n-import com.linkedin.pinot.core.segment.index.readers.ImmutableDictionaryReader;\n \n \n /**\n@@ -139,4 +138,9 @@ public String getFunctionName() {\n     return \"sum_\" + _sumByColumn;\n   }\n \n+  @Override\n+  public Serializable getDefaultValue() {\n+    return Double.valueOf(0);\n+  }\n+\n }",
                "deletions": 2
            },
            {
                "sha": "231947563bba9cbd935cb8bff5f46f69ee3fa05c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/8c6fd1ccfd615c0f4848186a63aa12df579d4846/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "status": "modified",
                "changes": 36,
                "additions": 22,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java?ref=8c6fd1ccfd615c0f4848186a63aa12df579d4846",
                "patch": "@@ -15,9 +15,9 @@\n  */\n package com.linkedin.pinot.core.realtime.impl.datasource;\n \n-import java.util.ArrayList;\n-import java.util.List;\n+import java.util.HashSet;\n import java.util.Map;\n+import java.util.Set;\n \n import org.apache.commons.lang3.tuple.Pair;\n import org.roaringbitmap.buffer.MutableRoaringBitmap;\n@@ -131,25 +131,32 @@ public boolean setPredicate(Predicate predicate) {\n     switch (predicate.getType()) {\n       case EQ:\n         String equalsValueToLookup = ((EqPredicate) predicate).getEqualsValue();\n-        filteredDocIdBitmap = invertedINdex.getDocIdSetFor(dictionary.indexOf(equalsValueToLookup));\n+        if (dictionary.contains(equalsValueToLookup)) {\n+          filteredDocIdBitmap = invertedINdex.getDocIdSetFor(dictionary.indexOf(equalsValueToLookup));\n+        } else {\n+          filteredDocIdBitmap = new MutableRoaringBitmap();\n+        }\n         break;\n       case IN:\n         MutableRoaringBitmap orBitmapForInQueries = new MutableRoaringBitmap();\n         String[] inRangeStrings = ((InPredicate) predicate).getInRange();\n-        int[] dicIdsToOrTogether = new int[inRangeStrings.length];\n-        int counter = 0;\n         for (String rawValueInString : inRangeStrings) {\n-          dicIdsToOrTogether[counter++] = dictionary.indexOf(rawValueInString);\n-        }\n-        for (int dicId : dicIdsToOrTogether) {\n-          orBitmapForInQueries.or(invertedINdex.getDocIdSetFor(dicId));\n+          if (dictionary.contains(rawValueInString)) {\n+            int dictId = dictionary.indexOf(rawValueInString);\n+            orBitmapForInQueries.or(invertedINdex.getDocIdSetFor(dictId));\n+          }\n         }\n         filteredDocIdBitmap = orBitmapForInQueries;\n         break;\n       case NEQ:\n         MutableRoaringBitmap neqBitmap = new MutableRoaringBitmap();\n-        int valueToExclude = ((NEqPredicate) predicate).getNotEqualsValue() == null ? 0 : dictionary.indexOf(((NEqPredicate) predicate).getNotEqualsValue());\n-\n+        String neqValue = ((NEqPredicate) predicate).getNotEqualsValue();\n+        int valueToExclude = -1;\n+        if (neqValue == null) {\n+          valueToExclude = 0;\n+        } else if (neqValue != null && dictionary.contains(neqValue)) {\n+          valueToExclude = dictionary.indexOf(neqValue);\n+        }\n         for (int i = 1; i <= dictionary.length(); i++) {\n           if (valueToExclude != i) {\n             neqBitmap.or(invertedINdex.getDocIdSetFor(i));\n@@ -159,10 +166,12 @@ public boolean setPredicate(Predicate predicate) {\n         break;\n       case NOT_IN:\n         final String[] notInValues = ((NotInPredicate) predicate).getNotInRange();\n-        final List<Integer> notInIds = new ArrayList<Integer>();\n+        final Set<Integer> notInIds = new HashSet<Integer>();\n \n         for (final String notInValue : notInValues) {\n-          notInIds.add(new Integer(dictionary.indexOf(notInValue)));\n+          if (dictionary.contains(notInValue)) {\n+            notInIds.add(dictionary.indexOf(notInValue));\n+          }\n         }\n \n         final MutableRoaringBitmap notINHolder = new MutableRoaringBitmap();\n@@ -209,5 +218,4 @@ public boolean setPredicate(Predicate predicate) {\n     }\n     return true;\n   }\n-\n }",
                "deletions": 14
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "- Throwing a relevant error message when no dimension combination can be rolled up, currently we are\n  getting NPE\n\nTHIRDEYE-179\n\nRB=439680\nR=kgopalak,gbrandt\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/f256099a021a9cf5a407ba97338e9187b4f6b06d",
        "parent": "https://github.com/apache/incubator-pinot/commit/b91d0dcc0de48266dcc366e134143b157eaf1e46",
        "bug_id": "incubator-pinot_75",
        "file": [
            {
                "sha": "6ad5ce7b3abe35682676294bc91205cb83b81d25",
                "filename": "thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/rollup/phase3/RollupPhaseThreeJob.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/f256099a021a9cf5a407ba97338e9187b4f6b06d/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/rollup/phase3/RollupPhaseThreeJob.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/f256099a021a9cf5a407ba97338e9187b4f6b06d/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/rollup/phase3/RollupPhaseThreeJob.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-bootstrap/src/main/java/com/linkedin/thirdeye/bootstrap/rollup/phase3/RollupPhaseThreeJob.java?ref=f256099a021a9cf5a407ba97338e9187b4f6b06d",
                "patch": "@@ -162,6 +162,8 @@ public void reduce(BytesWritable rawDimensionMD5KeyWritable,\n       // select the roll up dimension key\n       DimensionKey selectedRollup = rollupFunc.rollup(rawDimensionKey,\n           possibleRollupTimeSeriesMap, rollupThresholdFunction);\n+      if(selectedRollup == null)\n+        throw new IllegalStateException(\"rollup function could not find any dimension combination that passes threshold\");\n       context.write(new BytesWritable(selectedRollup.toBytes()),\n           new BytesWritable(rawMetricTimeSeries.toBytes()));\n     }",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-4768] Handle exceptions when a table gets dropped while committing an LLC segment (#1275)\n\n* [PINOT-4768] Handle exceptions when a table gets dropped while committing an LLC segment\r\n\r\nWe handle all exceptions inside the segment completion manager, and return a failed response.\r\n\r\nAdded unit test\r\n\r\n* Changed exception and error string message\r\n\r\n* Fixed the exception to be a RuntimeException instead of NPE\r\n\r\nThere are multiple points that call to get the segment metadata and they cannot handle null\r\nfor the metadata. One (normal) condition in which this can happen is:\r\n\r\n  table getting dropped AND (segment completing OR validation manager auto-createing segments)\r\n\r\nOther cases are manual edits of zknodes to remove metadata nodes (not expected)\r\n\r\nAdded an appropriate log message and turned the exception into RuntimeException instead of\r\nNPE",
        "commit": "https://github.com/apache/incubator-pinot/commit/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36",
        "parent": "https://github.com/apache/incubator-pinot/commit/d5128a74c1fea51087521e2e6adf9be64ee75b21",
        "bug_id": "incubator-pinot_76",
        "file": [
            {
                "sha": "605197236b4c58a422242818fdd3a79868a8da04",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java",
                "status": "modified",
                "changes": 8,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java?ref=dc88ec2dcabea304e98cb4b52fadfdaf385b9f36",
                "patch": "@@ -660,8 +660,12 @@ protected SegmentMetadataImpl extractSegmentMetadata(final String rawTableName,\n   }\n \n   public LLCRealtimeSegmentZKMetadata getRealtimeSegmentZKMetadata(String realtimeTableName, String segmentName) {\n-    return new LLCRealtimeSegmentZKMetadata(_propertyStore.get(\n-          ZKMetadataProvider.constructPropertyStorePathForSegment(realtimeTableName, segmentName), null, AccessOption.PERSISTENT));\n+    ZNRecord znRecord = _propertyStore.get(ZKMetadataProvider.constructPropertyStorePathForSegment(realtimeTableName, segmentName), null, AccessOption.PERSISTENT);\n+    if (znRecord == null) {\n+      LOGGER.error(\"Segment metadata not found for table {}, segment {}. (can happen during table drop)\");\n+      throw new RuntimeException(\"Segment metadata not found for table \" + realtimeTableName + \" segment \" + segmentName);\n+    }\n+    return new LLCRealtimeSegmentZKMetadata(znRecord);\n   }\n \n   private void completeCommittingSegments() {",
                "deletions": 2
            },
            {
                "sha": "64a7c9fcd30eb7406f3c1a81a815b679d945ddc1",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionManager.java",
                "status": "modified",
                "changes": 69,
                "additions": 47,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionManager.java?ref=dc88ec2dcabea304e98cb4b52fadfdaf385b9f36",
                "patch": "@@ -117,11 +117,6 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n         final String realtimeTableName = TableNameBuilder.REALTIME_TABLE_NAME_BUILDER.forTable(segmentName.getTableName());\n         LLCRealtimeSegmentZKMetadata segmentMetadata = _segmentManager.getRealtimeSegmentZKMetadata(\n             realtimeTableName, segmentName.getSegmentName());\n-        if (segmentMetadata == null) {\n-          // It is possible that we are in the process of reverting configuration back to high-level consumers.\n-          LOGGER.warn(\"Segment metadata not found for {}\", segmentNameStr);\n-          throw new RuntimeException(\"Segment metadata not found for \" + segmentNameStr);\n-        }\n         if (segmentMetadata.getStatus().equals(CommonConstants.Segment.Realtime.Status.DONE)) {\n           // Best to go through the state machine for this case as well, so that all code regarding state handling is in one place\n           // Also good for synchronization, because it is possible that multiple threads take this path, and we don't want\n@@ -139,8 +134,8 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n         _fsmMap.put(segmentNameStr, fsm);\n       } catch (Exception e) {\n         // Server gone wonky. Segment does not exist in propstore\n-        LOGGER.error(\"Exception reading segment read from propertystore {}\", segmentNameStr, e);\n-        throw new RuntimeException(\"Segment read from propertystore \" + segmentNameStr, e);\n+        LOGGER.error(\"Exception creating FSM for segment {}\", segmentNameStr, e);\n+        throw new RuntimeException(\"Exception creating FSM for segment \" + segmentNameStr, e);\n       }\n     }\n     return fsm;\n@@ -159,9 +154,15 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n     final long offset = reqParams.getOffset();\n \n     LLCSegmentName segmentName = new LLCSegmentName(segmentNameStr);\n-    SegmentCompletionFSM fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_CONSUMED);\n-    SegmentCompletionProtocol.Response response = fsm.segmentConsumed(instanceId, offset);\n-    if (fsm.isDone()) {\n+    SegmentCompletionProtocol.Response response = SegmentCompletionProtocol.RESP_FAILED;\n+    SegmentCompletionFSM fsm = null;\n+    try {\n+      fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_CONSUMED);\n+      response = fsm.segmentConsumed(instanceId, offset);\n+    } catch (Exception e) {\n+      // Return failed response\n+    }\n+    if (fsm != null && fsm.isDone()) {\n       LOGGER.info(\"Removing FSM (if present):{}\", fsm.toString());\n       _fsmMap.remove(segmentNameStr);\n     }\n@@ -187,9 +188,15 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n     final String instanceId = reqParams.getInstanceId();\n     final long offset = reqParams.getOffset();\n     LLCSegmentName segmentName = new LLCSegmentName(segmentNameStr);\n-    SegmentCompletionFSM fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_COMMIT);\n-    SegmentCompletionProtocol.Response response = fsm.segmentCommitStart(instanceId, offset);\n-    if (fsm.isDone()) {\n+    SegmentCompletionFSM fsm = null;\n+    SegmentCompletionProtocol.Response response = SegmentCompletionProtocol.RESP_FAILED;\n+    try {\n+      fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_COMMIT);\n+      response = fsm.segmentCommitStart(instanceId, offset);\n+    } catch (Exception e) {\n+      // Return failed response\n+    }\n+    if (fsm != null && fsm.isDone()) {\n       LOGGER.info(\"Removing FSM (if present):{}\", fsm.toString());\n       _fsmMap.remove(segmentNameStr);\n     }\n@@ -205,9 +212,15 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n     final long offset = reqParams.getOffset();\n     final int extTimeSec = reqParams.getExtraTimeSec();\n     LLCSegmentName segmentName = new LLCSegmentName(segmentNameStr);\n-    SegmentCompletionFSM fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_COMMIT);\n-    SegmentCompletionProtocol.Response response = fsm.extendBuildTime(instanceId, offset, extTimeSec);\n-    if (fsm.isDone()) {\n+    SegmentCompletionFSM fsm = null;\n+    SegmentCompletionProtocol.Response response = SegmentCompletionProtocol.RESP_FAILED;\n+    try {\n+      fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_COMMIT);\n+      response = fsm.extendBuildTime(instanceId, offset, extTimeSec);\n+    } catch (Exception e) {\n+      // Return failed response\n+    }\n+    if (fsm != null && fsm.isDone()) {\n       LOGGER.info(\"Removing FSM (if present):{}\", fsm.toString());\n       _fsmMap.remove(segmentNameStr);\n     }\n@@ -229,9 +242,15 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n     final long offset = reqParams.getOffset();\n     final String reason = reqParams.getReason();\n     LLCSegmentName segmentName = new LLCSegmentName(segmentNameStr);\n-    SegmentCompletionFSM fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_STOPPED_CONSUMING);\n-    SegmentCompletionProtocol.Response response = fsm.stoppedConsuming(instanceId, offset, reason);\n-    if (fsm.isDone()) {\n+    SegmentCompletionFSM fsm = null;\n+    SegmentCompletionProtocol.Response response = SegmentCompletionProtocol.RESP_FAILED;\n+    try {\n+      fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_STOPPED_CONSUMING);\n+      response = fsm.stoppedConsuming(instanceId, offset, reason);\n+    } catch (Exception e) {\n+      // Return failed response\n+    }\n+    if (fsm != null && fsm.isDone()) {\n       LOGGER.info(\"Removing FSM (if present):{}\", fsm.toString());\n       _fsmMap.remove(segmentNameStr);\n     }\n@@ -256,9 +275,15 @@ private synchronized SegmentCompletionFSM lookupOrCreateFsm(final LLCSegmentName\n     final String instanceId = reqParams.getInstanceId();\n     final long offset = reqParams.getOffset();\n     LLCSegmentName segmentName = new LLCSegmentName(segmentNameStr);\n-    SegmentCompletionFSM fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_COMMIT);\n-    SegmentCompletionProtocol.Response response = fsm.segmentCommitEnd(instanceId, offset, success);\n-    if (fsm.isDone()) {\n+    SegmentCompletionFSM fsm = null;\n+    SegmentCompletionProtocol.Response response = SegmentCompletionProtocol.RESP_FAILED;\n+    try {\n+      fsm = lookupOrCreateFsm(segmentName, SegmentCompletionProtocol.MSG_TYPE_COMMIT);\n+      response = fsm.segmentCommitEnd(instanceId, offset, success);\n+    } catch (Exception e) {\n+      // Return failed response\n+    }\n+    if (fsm != null && fsm.isDone()) {\n       LOGGER.info(\"Removing FSM (if present):{}\", fsm.toString());\n       _fsmMap.remove(segmentNameStr);\n     }",
                "deletions": 22
            },
            {
                "sha": "dc782d4f65a234d547a5f8d6e835fca6176ba8b9",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/dc88ec2dcabea304e98cb4b52fadfdaf385b9f36/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionTest.java",
                "status": "modified",
                "changes": 12,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/core/realtime/SegmentCompletionTest.java?ref=dc88ec2dcabea304e98cb4b52fadfdaf385b9f36",
                "patch": "@@ -249,6 +249,18 @@ public void testHappyPath() throws Exception {\n     testHappyPath(5L);\n   }\n \n+  @Test\n+  public void testExceptionInConsumedMessage() throws Exception {\n+    segmentManager._segmentMetadata = null;\n+\n+    SegmentCompletionProtocol.Response response;\n+    Request.Params params;\n+    segmentCompletionMgr._secconds = 10;\n+    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n+    response = segmentCompletionMgr.segmentConsumed(params);\n+    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.FAILED);\n+  }\n+\n   public void testHappyPath(long startTime) throws  Exception {\n     SegmentCompletionProtocol.Response response;\n     Request.Params params;",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-4312] Fix NPE in ValidationManager (#952)\n\nMoved the instantiation of ValidationManager to to be after that of PinotLLCRealtimeSegmentManager\r\nso that it can get a handle to the right instance of the latter.\r\n\r\nAdded an integration test to make sure that a ValidationManager run fixes offline partitions",
        "commit": "https://github.com/apache/incubator-pinot/commit/70c8f1b16cebbfadb025468e562e1a70a745fe81",
        "parent": "https://github.com/apache/incubator-pinot/commit/5e222ca123e7adbdb6d207dd8831810e6dceccb6",
        "bug_id": "incubator-pinot_77",
        "file": [
            {
                "sha": "62edfb964df6ffe0acfdaeb1c607472c8d9dacaa",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java",
                "status": "modified",
                "changes": 13,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java?ref=70c8f1b16cebbfadb025468e562e1a70a745fe81",
                "patch": "@@ -15,7 +15,6 @@\n  */\n package com.linkedin.pinot.controller;\n \n-import com.google.common.primitives.Longs;\n import java.io.File;\n import java.io.FileOutputStream;\n import java.io.IOException;\n@@ -26,14 +25,14 @@\n import org.apache.commons.httpclient.HttpConnectionManager;\n import org.apache.commons.httpclient.MultiThreadedHttpConnectionManager;\n import org.apache.commons.io.FileUtils;\n-import org.apache.commons.io.IOUtils;\n import org.apache.helix.PreConnectCallback;\n import org.restlet.Application;\n import org.restlet.Component;\n import org.restlet.Context;\n import org.restlet.data.Protocol;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+import com.google.common.primitives.Longs;\n import com.google.common.util.concurrent.ThreadFactoryBuilder;\n import com.linkedin.pinot.common.Utils;\n import com.linkedin.pinot.common.metrics.ControllerMeter;\n@@ -61,7 +60,7 @@\n   private final Application controllerRestApp;\n   private final PinotHelixResourceManager helixResourceManager;\n   private final RetentionManager retentionManager;\n-  private final ValidationManager validationManager;\n+  private ValidationManager validationManager;\n   private final MetricsRegistry _metricsRegistry;\n   private final PinotRealtimeSegmentManager realtimeSegmentsManager;\n   private final SegmentStatusChecker segmentStatusChecker;\n@@ -75,8 +74,6 @@ public ControllerStarter(ControllerConf conf) {\n     retentionManager = new RetentionManager(helixResourceManager, config.getRetentionControllerFrequencyInSeconds());\n     _metricsRegistry = new MetricsRegistry();\n     realtimeSegmentsManager = new PinotRealtimeSegmentManager(helixResourceManager);\n-    ValidationMetrics validationMetrics = new ValidationMetrics(_metricsRegistry);\n-    validationManager = new ValidationManager(validationMetrics, helixResourceManager, config, null);\n     segmentStatusChecker = new SegmentStatusChecker(helixResourceManager, config);\n     executorService = Executors.newCachedThreadPool(\n         new ThreadFactoryBuilder().setNameFormat(\"restlet-multiget-thread-%d\").build());\n@@ -86,6 +83,10 @@ public PinotHelixResourceManager getHelixResourceManager() {\n     return helixResourceManager;\n   }\n \n+  public ValidationManager getValidationManager() {\n+    return validationManager;\n+  }\n+\n   public void start() {\n     LOGGER.info(\"Starting Pinot controller\");\n \n@@ -119,6 +120,8 @@ public void start() {\n       helixResourceManager.start();\n       // Helix resource manager must be started in order to create PinotLLCRealtimeSegmentManager\n       PinotLLCRealtimeSegmentManager.create(helixResourceManager, config, controllerMetrics);\n+      ValidationMetrics validationMetrics = new ValidationMetrics(_metricsRegistry);\n+      validationManager = new ValidationManager(validationMetrics, helixResourceManager, config, PinotLLCRealtimeSegmentManager.getInstance());\n       LOGGER.info(\"Starting Pinot REST API component\");\n       component.start();\n       LOGGER.info(\"Starting retention manager\");",
                "deletions": 5
            },
            {
                "sha": "5f597bc88e726d5d0e7a2bfe7bba33f9b6a1f596",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/validation/ValidationManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-controller/src/main/java/com/linkedin/pinot/controller/validation/ValidationManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-controller/src/main/java/com/linkedin/pinot/controller/validation/ValidationManager.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/validation/ValidationManager.java?ref=70c8f1b16cebbfadb025468e562e1a70a745fe81",
                "patch": "@@ -169,6 +169,8 @@ public void runValidation() {\n             LOGGER.warn(\"Cannot get realtime tableconfig for {}\", tableName);\n           } else if (streamMetadata == null) {\n             LOGGER.warn(\"Cannot get streamconfig for {}\", tableName);\n+          } else {\n+            LOGGER.error(\"Exception while validating table {}\", tableName, e);\n           }\n         }\n       } else {",
                "deletions": 0
            },
            {
                "sha": "62cae19760b7a2747267e97250c1850d52c88c59",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/helix/ControllerTest.java?ref=70c8f1b16cebbfadb025468e562e1a70a745fe81",
                "patch": "@@ -36,6 +36,7 @@\n import com.linkedin.pinot.common.utils.ZkStarter;\n import com.linkedin.pinot.controller.ControllerConf;\n import com.linkedin.pinot.controller.ControllerStarter;\n+import com.linkedin.pinot.controller.validation.ValidationManager;\n \n \n /**\n@@ -139,6 +140,11 @@ protected void startController() {\n     startController(false);\n   }\n \n+  protected ValidationManager getControllerValidationManager() throws Exception {\n+    assert _controllerStarter != null;\n+    return _controllerStarter.getValidationManager();\n+  }\n+\n   /**\n    * Stops an already started controller\n    */",
                "deletions": 0
            },
            {
                "sha": "e9c0736f43506ae91e744221cb643608aaa756dd",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SegmentCompletionIntegrationTests.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SegmentCompletionIntegrationTests.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/70c8f1b16cebbfadb025468e562e1a70a745fe81/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SegmentCompletionIntegrationTests.java",
                "status": "modified",
                "changes": 24,
                "additions": 23,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SegmentCompletionIntegrationTests.java?ref=70c8f1b16cebbfadb025468e562e1a70a745fe81",
                "patch": "@@ -27,6 +27,7 @@\n import org.apache.helix.NotificationContext;\n import org.apache.helix.ZNRecord;\n import org.apache.helix.model.ExternalView;\n+import org.apache.helix.model.IdealState;\n import org.apache.helix.model.Message;\n import org.apache.helix.participant.StateMachineEngine;\n import org.apache.helix.participant.statemachine.StateModel;\n@@ -45,6 +46,7 @@\n import com.linkedin.pinot.common.utils.CommonConstants;\n import com.linkedin.pinot.common.utils.ControllerTenantNameBuilder;\n import com.linkedin.pinot.common.utils.KafkaStarterUtils;\n+import com.linkedin.pinot.common.utils.LLCSegmentName;\n import com.linkedin.pinot.common.utils.NetUtil;\n import com.linkedin.pinot.common.utils.ZkStarter;\n import com.linkedin.pinot.common.utils.ZkUtils;\n@@ -132,7 +134,7 @@ private void stopFakeServer() {\n \n   // Test that if we send stoppedConsuming to the controller, the segment goes offline.\n   @Test\n-  public void testStopConsumingToOffline() throws  Exception {\n+  public void testStopConsumingToOfflineAndAutofix() throws  Exception {\n     final String realtimeTableName = TableNameBuilder.REALTIME_TABLE_NAME_BUILDER.forTable(_tableName);\n     long endTime = now() + MAX_RUN_TIME_SECONDS * 1000L;\n \n@@ -169,6 +171,26 @@ public void testStopConsumingToOffline() throws  Exception {\n     }\n \n     Assert.assertTrue(now() < endTime, \"Failed trying to reach offline state\");\n+\n+    // Now call the validation manager, and the segment should fix itself\n+    getControllerValidationManager().runValidation();\n+\n+    // Now there should be a new segment in CONSUMING state in the IDEALSTATE.\n+    IdealState idealState = HelixHelper.getTableIdealState(_helixManager, realtimeTableName);\n+    Assert.assertEquals(idealState.getPartitionSet().size(), 2);\n+    for (String segmentId : idealState.getPartitionSet()) {\n+      if (!segmentId.equals(_segmentName)) {\n+        // This is a new segment. Verify that it is in CONSUMING state, and has a sequence number 1 more than prev one\n+        LLCSegmentName oldSegmentName = new LLCSegmentName(_segmentName);\n+        LLCSegmentName newSegmentName = new LLCSegmentName(segmentId);\n+        Assert.assertEquals(newSegmentName.getSequenceNumber(), oldSegmentName.getSequenceNumber() + 1);\n+        Map<String, String> instanceStateMap = idealState.getInstanceStateMap(segmentId);\n+        for (String state : instanceStateMap.values()) {\n+          Assert.assertTrue(state.equals(PinotHelixSegmentOnlineOfflineStateModelGenerator.CONSUMING_STATE));\n+        }\n+      }\n+    }\n+    // We will assume that it eventually makes it to externalview\n   }\n \n   @Override",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fixing NPE for getting next row, if the column from avro is not in pinot\nschema. Now we will just simply skip it.\n\nRemove debug code in SimpleRequestHandler.\n\nRB=492956\nR=xiafu\nA=jfim,dpatel",
        "commit": "https://github.com/apache/incubator-pinot/commit/b269443b2ed98798ac2bb738a228f5171064aee8",
        "parent": "https://github.com/apache/incubator-pinot/commit/46cad3c9eb29aaa4081e342e4d15968d1a67cf44",
        "bug_id": "incubator-pinot_78",
        "file": [
            {
                "sha": "60a32c1771651174b4dc3b91133752083671ef6a",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/AvroRecordReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b269443b2ed98798ac2bb738a228f5171064aee8/pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/AvroRecordReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b269443b2ed98798ac2bb738a228f5171064aee8/pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/AvroRecordReader.java",
                "status": "modified",
                "changes": 3,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/readers/AvroRecordReader.java?ref=b269443b2ed98798ac2bb738a228f5171064aee8",
                "patch": "@@ -91,6 +91,9 @@ public GenericRow next() {\n   private GenericRow getGenericRow(GenericRecord rawRecord) {\n     for (final Field field : _dataStream.getSchema().getFields()) {\n       FieldSpec spec = _schemaExtractor.getSchema().getFieldSpecFor(field.name());\n+      if (spec == null) {\n+        continue;\n+      }\n       Object value = rawRecord.get(field.name());\n       if (value instanceof Utf8) {\n         value = ((Utf8) value).toString();",
                "deletions": 0
            },
            {
                "sha": "9c7fa85b2927397938b36896fa1b64e214434a54",
                "filename": "pinot-server/src/main/java/com/linkedin/pinot/server/request/SimpleRequestHandler.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b269443b2ed98798ac2bb738a228f5171064aee8/pinot-server/src/main/java/com/linkedin/pinot/server/request/SimpleRequestHandler.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b269443b2ed98798ac2bb738a228f5171064aee8/pinot-server/src/main/java/com/linkedin/pinot/server/request/SimpleRequestHandler.java",
                "status": "modified",
                "changes": 7,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-server/src/main/java/com/linkedin/pinot/server/request/SimpleRequestHandler.java?ref=b269443b2ed98798ac2bb738a228f5171064aee8",
                "patch": "@@ -83,13 +83,6 @@ public DataTable call() throws Exception {\n           return _queryExecutor.processQuery(queryRequest);\n         }\n       });\n-      LOGGER.debug(\"******************************\");\n-      if (instanceResponse != null) {\n-        LOGGER.debug(\"instanceResponse : {}\", instanceResponse.toString());\n-      } else {\n-        LOGGER.debug(\"instanceResponse : null\");\n-      }\n-      LOGGER.debug(\"******************************\");\n     } catch (Exception e) {\n       LOGGER.error(\"Got exception while processing request. Returning error response\", e);\n       _serverMetrics.addMeteredValue(null, ServerMeter.UNCAUGHT_EXCEPTIONS, 1);",
                "deletions": 7
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Using BlockingQueue for server merging phase.\nFixing NPE in related combine functions.\nRemove Exception handlers in MSelectionOnlyOperator.\nHandling metadata only DataTable Ser/DeSer.\n\nRB=478761\nR=xiafu\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/b02cc238036b9cadc7c6df80a1004d61fa2349a6",
        "parent": "https://github.com/apache/incubator-pinot/commit/69a7ad04c3dbd78f23bd42bc2b33537f324b96c1",
        "bug_id": "incubator-pinot_79",
        "file": [
            {
                "sha": "0302aed9aab3c9209c2e536db986ea913f361a5c",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/exception/QueryException.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/main/java/com/linkedin/pinot/common/exception/QueryException.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/main/java/com/linkedin/pinot/common/exception/QueryException.java",
                "status": "modified",
                "changes": 14,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/exception/QueryException.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -15,6 +15,9 @@\n  */\n package com.linkedin.pinot.common.exception;\n \n+import java.io.PrintWriter;\n+import java.io.StringWriter;\n+\n import com.linkedin.pinot.common.response.ProcessingException;\n \n \n@@ -52,4 +55,15 @@\n     UNKNOWN_ERROR.setMessage(\"UnknownError\");\n   }\n \n+  public static ProcessingException getException(ProcessingException processingException, Exception exception, int sizeOfStackTraceToTruncate) {\n+    ProcessingException retProcessingException = QueryException.FUTURE_CALL_ERROR.deepCopy();\n+    StringWriter sw = new StringWriter(sizeOfStackTraceToTruncate);\n+    exception.printStackTrace(new PrintWriter(sw));\n+    retProcessingException.setMessage(sw.toString());\n+    return retProcessingException;\n+  }\n+\n+  public static ProcessingException getException(ProcessingException processingException, Exception exception) {\n+    return getException(processingException, exception, 1000);\n+  }\n }",
                "deletions": 0
            },
            {
                "sha": "42b8d2ca1e89b16c0cd0966391ce99bed312c1da",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/response/BrokerResponse.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/main/java/com/linkedin/pinot/common/response/BrokerResponse.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/main/java/com/linkedin/pinot/common/response/BrokerResponse.java",
                "status": "modified",
                "changes": 4,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/response/BrokerResponse.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -35,7 +35,7 @@\n public class BrokerResponse {\n   private long _totalDocs = 0;\n   private long _numDocsScanned = 0;\n-  private long _timeUsedMs;\n+  private long _timeUsedMs = 0;\n   private List<JSONObject> _aggregationResults;\n   private List<ResponseStatistics> _segmentStatistics;\n   private List<ProcessingException> _exceptions;\n@@ -62,8 +62,6 @@ public BrokerResponse() {\n     _segmentStatistics = new ArrayList<ResponseStatistics>();\n     _exceptions = new ArrayList<ProcessingException>();\n     _traceInfo = new HashMap<String, String>();\n-    _timeUsedMs = Long.MIN_VALUE;\n-\n   }\n \n   public long getTotalDocs() {",
                "deletions": 3
            },
            {
                "sha": "348b83ddb5c2c214fdf62905a789e5968bcc959e",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java",
                "status": "modified",
                "changes": 225,
                "additions": 126,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/DataTable.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -15,7 +15,6 @@\n  */\n package com.linkedin.pinot.common.utils;\n \n-import com.linkedin.pinot.common.Utils;\n import java.io.ByteArrayInputStream;\n import java.io.ByteArrayOutputStream;\n import java.io.Closeable;\n@@ -29,12 +28,15 @@\n import java.util.HashMap;\n import java.util.Map;\n \n-import com.linkedin.pinot.common.data.FieldSpec.DataType;\n-import com.linkedin.pinot.common.utils.DataTableBuilder.DataSchema;\n import org.apache.commons.io.IOUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.linkedin.pinot.common.Utils;\n+import com.linkedin.pinot.common.data.FieldSpec.DataType;\n+import com.linkedin.pinot.common.response.ProcessingException;\n+import com.linkedin.pinot.common.utils.DataTableBuilder.DataSchema;\n+\n \n /**\n  *\n@@ -90,7 +92,6 @@ public DataTable(int numRows, Map<String, Map<Integer, String>> dictionary,\n     fixedSizeData = ByteBuffer.wrap(fixedSizeDataBytes);\n     variableSizeData = ByteBuffer.wrap(variableSizeDataBytes);\n     columnOffsets = computeColumnOffsets(schema);\n-\n   }\n \n   /**\n@@ -107,54 +108,57 @@ public DataTable(Map<String, String> metadata) {\n    * @return\n    */\n   private int[] computeColumnOffsets(DataSchema schema) {\n+    if (schema == null) {\n+      return null;\n+    }\n     final int[] columnOffsets = new int[schema.columnNames.length];\n     for (int i = 0; i < schema.columnNames.length; i++) {\n       final DataType type = schema.columnTypes[i];\n       columnOffsets[i] = rowSizeInBytes;\n       switch (type) {\n-      case BOOLEAN:\n-        rowSizeInBytes += 1;\n-        break;\n-      case BYTE:\n-        rowSizeInBytes += 1;\n-        break;\n-      case CHAR:\n-        rowSizeInBytes += 2;\n-        break;\n-      case SHORT:\n-        rowSizeInBytes += 2;\n-        break;\n-      case INT:\n-        rowSizeInBytes += 4;\n-        break;\n-      case LONG:\n-        rowSizeInBytes += 8;\n-        break;\n-      case FLOAT:\n-        rowSizeInBytes += 8;\n-        break;\n-      case DOUBLE:\n-        rowSizeInBytes += 8;\n-        break;\n-      case STRING:\n-        rowSizeInBytes += 4;\n-        break;\n-      case OBJECT:\n-        rowSizeInBytes += 8;\n-        break;\n-      case BYTE_ARRAY:\n-      case CHAR_ARRAY:\n-      case INT_ARRAY:\n-      case LONG_ARRAY:\n-      case FLOAT_ARRAY:\n-      case SHORT_ARRAY:\n-      case DOUBLE_ARRAY:\n-      case STRING_ARRAY:\n-        rowSizeInBytes += 8;\n-        break;\n-\n-      default:\n-        throw new RuntimeException(\"Unsupported datatype:\" + type);\n+        case BOOLEAN:\n+          rowSizeInBytes += 1;\n+          break;\n+        case BYTE:\n+          rowSizeInBytes += 1;\n+          break;\n+        case CHAR:\n+          rowSizeInBytes += 2;\n+          break;\n+        case SHORT:\n+          rowSizeInBytes += 2;\n+          break;\n+        case INT:\n+          rowSizeInBytes += 4;\n+          break;\n+        case LONG:\n+          rowSizeInBytes += 8;\n+          break;\n+        case FLOAT:\n+          rowSizeInBytes += 8;\n+          break;\n+        case DOUBLE:\n+          rowSizeInBytes += 8;\n+          break;\n+        case STRING:\n+          rowSizeInBytes += 4;\n+          break;\n+        case OBJECT:\n+          rowSizeInBytes += 8;\n+          break;\n+        case BYTE_ARRAY:\n+        case CHAR_ARRAY:\n+        case INT_ARRAY:\n+        case LONG_ARRAY:\n+        case FLOAT_ARRAY:\n+        case SHORT_ARRAY:\n+        case DOUBLE_ARRAY:\n+        case STRING_ARRAY:\n+          rowSizeInBytes += 8;\n+          break;\n+\n+        default:\n+          throw new RuntimeException(\"Unsupported datatype:\" + type);\n       }\n     }\n     return columnOffsets;\n@@ -195,24 +199,24 @@ public DataTable(byte[] buffer) {\n     input.get(metadataBytes);\n     metadata = (Map<String, String>) deserialize(metadataBytes);\n \n-    // READ METADATA\n+    // READ SCHEMA\n     final byte[] schemaBytes = new byte[schemaLength];\n     input.position(schemaStart);\n     input.get(schemaBytes);\n     schema = deserialize(schemaBytes);\n     columnOffsets = computeColumnOffsets(schema);\n \n-    // READ METADATA\n+    // READ FIXED SIZE DATA BYTES \n     fixedSizeDataBytes = new byte[fixedDataLength];\n     input.position(fixedDataStart);\n     input.get(fixedSizeDataBytes);\n     fixedSizeData = ByteBuffer.wrap(fixedSizeDataBytes);\n \n+    // READ VARIABLE SIZE DATA BYTES \n     variableSizeDataBytes = new byte[variableDataLength];\n     input.position(variableDataStart);\n     input.get(variableSizeDataBytes);\n     variableSizeData = ByteBuffer.wrap(variableSizeDataBytes);\n-\n   }\n \n   public DataTable() {\n@@ -260,19 +264,31 @@ public DataTable() {\n \n     // datatable\n     out.writeInt(baseOffset);\n-    out.writeInt(fixedSizeDataBytes.length);\n-    baseOffset += fixedSizeDataBytes.length;\n+    if (fixedSizeDataBytes == null) {\n+      out.writeInt(0);\n+    } else {\n+      out.writeInt(fixedSizeDataBytes.length);\n+      baseOffset += fixedSizeDataBytes.length;\n+    }\n \n     // variable data\n     out.writeInt(baseOffset);\n-    out.writeInt(variableSizeDataBytes.length);\n+    if (variableSizeDataBytes == null) {\n+      out.writeInt(0);\n+    } else {\n+      out.writeInt(variableSizeDataBytes.length);\n+    }\n \n     // write them\n     out.write(dictionaryBytes);\n     out.write(metadataBytes);\n     out.write(schemaBytes);\n-    out.write(fixedSizeDataBytes);\n-    out.write(variableSizeDataBytes);\n+    if (fixedSizeDataBytes != null) {\n+      out.write(fixedSizeDataBytes);\n+    }\n+    if (variableSizeDataBytes != null) {\n+      out.write(variableSizeDataBytes);\n+    }\n     return baos.toByteArray();\n   }\n \n@@ -536,6 +552,7 @@ public String getString(int rowId, int colId) {\n     }\n     return ret;\n   }\n+\n   /**\n    *\n    * @param rowId\n@@ -596,6 +613,9 @@ private int positionCursorInVariableBuffer(int rowId, int colId) {\n    */\n   @Override\n   public String toString() {\n+    if (schema == null) {\n+      return metadata.toString();\n+    }\n     final StringBuilder b = new StringBuilder();\n     b.append(schema.toString());\n     b.append(\"\\n\");\n@@ -606,55 +626,62 @@ public String toString() {\n       for (int colId = 0; colId < numCols; colId++) {\n         final DataType type = schema.columnTypes[colId];\n         switch (type) {\n-        case BOOLEAN:\n-          b.append(fixedSizeData.get());\n-          break;\n-        case BYTE:\n-          b.append(fixedSizeData.get());\n-          break;\n-        case CHAR:\n-          b.append(fixedSizeData.getChar());\n-          break;\n-        case SHORT:\n-          b.append(fixedSizeData.getShort());\n-          break;\n-        case INT:\n-          b.append(fixedSizeData.getInt());\n-          break;\n-        case LONG:\n-          b.append(fixedSizeData.getLong());\n-          break;\n-        case FLOAT:\n-          b.append(fixedSizeData.getFloat());\n-          break;\n-        case DOUBLE:\n-          b.append(fixedSizeData.getDouble());\n-          break;\n-        case STRING:\n-          b.append(fixedSizeData.getInt());\n-          break;\n-        case OBJECT:\n-          b.append(String.format(\"(%s:%s)\", fixedSizeData.getInt(),\n-              fixedSizeData.getInt()));\n-          break;\n-        case BYTE_ARRAY:\n-        case CHAR_ARRAY:\n-        case SHORT_ARRAY:\n-        case INT_ARRAY:\n-        case LONG_ARRAY:\n-        case FLOAT_ARRAY:\n-        case DOUBLE_ARRAY:\n-        case STRING_ARRAY:\n-          b.append(String.format(\"(%s:%s)\", fixedSizeData.getInt(),\n-              fixedSizeData.getInt()));\n-          break;\n-        default:\n-          throw new RuntimeException(\"Unsupported datatype:\" + type);\n+          case BOOLEAN:\n+            b.append(fixedSizeData.get());\n+            break;\n+          case BYTE:\n+            b.append(fixedSizeData.get());\n+            break;\n+          case CHAR:\n+            b.append(fixedSizeData.getChar());\n+            break;\n+          case SHORT:\n+            b.append(fixedSizeData.getShort());\n+            break;\n+          case INT:\n+            b.append(fixedSizeData.getInt());\n+            break;\n+          case LONG:\n+            b.append(fixedSizeData.getLong());\n+            break;\n+          case FLOAT:\n+            b.append(fixedSizeData.getFloat());\n+            break;\n+          case DOUBLE:\n+            b.append(fixedSizeData.getDouble());\n+            break;\n+          case STRING:\n+            b.append(fixedSizeData.getInt());\n+            break;\n+          case OBJECT:\n+            b.append(String.format(\"(%s:%s)\", fixedSizeData.getInt(),\n+                fixedSizeData.getInt()));\n+            break;\n+          case BYTE_ARRAY:\n+          case CHAR_ARRAY:\n+          case SHORT_ARRAY:\n+          case INT_ARRAY:\n+          case LONG_ARRAY:\n+          case FLOAT_ARRAY:\n+          case DOUBLE_ARRAY:\n+          case STRING_ARRAY:\n+            b.append(String.format(\"(%s:%s)\", fixedSizeData.getInt(),\n+                fixedSizeData.getInt()));\n+            break;\n+          default:\n+            throw new RuntimeException(\"Unsupported datatype:\" + type);\n         }\n         b.append(\"\\t\");\n       }\n       b.append(\"\\n\");\n     }\n     return b.toString();\n   }\n+\n+  public void addException(ProcessingException exception) {\n+    if (metadata == null) {\n+      metadata = new HashMap<String, String>();\n+    }\n+    metadata.put(\"Exception\" + exception.getErrorCode(), exception.getMessage());\n+  }\n }",
                "deletions": 99
            },
            {
                "sha": "b0bdcf02fee4ff46810e1656229a11edc2a439ea",
                "filename": "pinot-common/src/test/java/com/linkedin/pinot/common/utils/TestDataTableBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/test/java/com/linkedin/pinot/common/utils/TestDataTableBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-common/src/test/java/com/linkedin/pinot/common/utils/TestDataTableBuilder.java",
                "status": "modified",
                "changes": 311,
                "additions": 164,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/test/java/com/linkedin/pinot/common/utils/TestDataTableBuilder.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -25,10 +25,26 @@\n import org.testng.annotations.Test;\n \n import com.linkedin.pinot.common.data.FieldSpec.DataType;\n+import com.linkedin.pinot.common.exception.QueryException;\n+import com.linkedin.pinot.common.response.ProcessingException;\n import com.linkedin.pinot.common.utils.DataTableBuilder.DataSchema;\n \n+\n public class TestDataTableBuilder {\n \n+  @Test\n+  public void testException() throws Exception {\n+    Exception exception = new UnsupportedOperationException(\"msg 0\");\n+    ProcessingException processingException = QueryException.EXECUTION_TIMEOUT_ERROR.deepCopy();\n+    processingException.setMessage(exception.toString());\n+    DataTable dataTable = new DataTable();\n+    dataTable.addException(processingException);\n+    byte[] bytes = dataTable.toBytes();\n+    DataTable desDataTable = new DataTable(bytes);\n+    String exceptionMsg = desDataTable.getMetadata().get(\"Exception\" + QueryException.EXECUTION_TIMEOUT_ERROR.getErrorCode());\n+    org.testng.Assert.assertEquals(exceptionMsg, exception.toString());\n+  }\n+\n   @Test\n   public void testSimple() throws Exception {\n     final DataType[] columnTypes = DataType.values();\n@@ -60,63 +76,63 @@ public void testSimple() throws Exception {\n       for (int colId = 0; colId < schema.columnNames.length; colId++) {\n         final DataType type = columnTypes[colId];\n         switch (type) {\n-        case BOOLEAN:\n-          final boolean bool = r.nextBoolean();\n-          boolArr[rowId] = bool;\n-          builder.setColumn(colId, bool);\n-          break;\n-        case CHAR:\n-          final char ch = (char) (r.nextInt(26) + 'a');\n-          cArr[rowId] = ch;\n-          builder.setColumn(colId, ch);\n-          break;\n-        case BYTE:\n-          final byte b = (byte) (r.nextInt((int) Math.pow(2, 8)));\n-          bArr[rowId] = b;\n-          builder.setColumn(colId, b);\n-\n-          break;\n-        case SHORT:\n-          final short s = (short) (r.nextInt((int) Math.pow(2, 16)));\n-          sArr[rowId] = s;\n-          builder.setColumn(colId, s);\n-\n-          break;\n-        case INT:\n-          final int i = (r.nextInt());\n-          iArr[rowId] = i;\n-          builder.setColumn(colId, i);\n-\n-          break;\n-        case LONG:\n-          final long l = (r.nextLong());\n-          lArr[rowId] = l;\n-          builder.setColumn(colId, l);\n-\n-          break;\n-        case FLOAT:\n-          final float f = (r.nextFloat());\n-          fArr[rowId] = f;\n-          builder.setColumn(colId, f);\n-          break;\n-        case DOUBLE:\n-          final double d = (r.nextDouble());\n-          dArr[rowId] = d;\n-          builder.setColumn(colId, d);\n-          break;\n-        case STRING:\n-          final String str = new BigInteger(130, r).toString(32);\n-          strArr[rowId] = str;\n-          builder.setColumn(colId, str);\n-          break;\n-        case OBJECT:\n-          final A obj = new A(r.nextInt());\n-          oArr[rowId] = obj;\n-          builder.setColumn(colId, obj);\n-\n-          break;\n-        default:\n-          break;\n+          case BOOLEAN:\n+            final boolean bool = r.nextBoolean();\n+            boolArr[rowId] = bool;\n+            builder.setColumn(colId, bool);\n+            break;\n+          case CHAR:\n+            final char ch = (char) (r.nextInt(26) + 'a');\n+            cArr[rowId] = ch;\n+            builder.setColumn(colId, ch);\n+            break;\n+          case BYTE:\n+            final byte b = (byte) (r.nextInt((int) Math.pow(2, 8)));\n+            bArr[rowId] = b;\n+            builder.setColumn(colId, b);\n+\n+            break;\n+          case SHORT:\n+            final short s = (short) (r.nextInt((int) Math.pow(2, 16)));\n+            sArr[rowId] = s;\n+            builder.setColumn(colId, s);\n+\n+            break;\n+          case INT:\n+            final int i = (r.nextInt());\n+            iArr[rowId] = i;\n+            builder.setColumn(colId, i);\n+\n+            break;\n+          case LONG:\n+            final long l = (r.nextLong());\n+            lArr[rowId] = l;\n+            builder.setColumn(colId, l);\n+\n+            break;\n+          case FLOAT:\n+            final float f = (r.nextFloat());\n+            fArr[rowId] = f;\n+            builder.setColumn(colId, f);\n+            break;\n+          case DOUBLE:\n+            final double d = (r.nextDouble());\n+            dArr[rowId] = d;\n+            builder.setColumn(colId, d);\n+            break;\n+          case STRING:\n+            final String str = new BigInteger(130, r).toString(32);\n+            strArr[rowId] = str;\n+            builder.setColumn(colId, str);\n+            break;\n+          case OBJECT:\n+            final A obj = new A(r.nextInt());\n+            oArr[rowId] = obj;\n+            builder.setColumn(colId, obj);\n+\n+            break;\n+          default:\n+            break;\n         }\n       }\n       builder.finishRow();\n@@ -133,6 +149,7 @@ public void testSimple() throws Exception {\n         fArr, lArr, dArr, strArr, oArr);\n \n   }\n+\n   @Test\n   public void testStringArray() throws Exception {\n     DataType[] columnTypes = new DataType[] { DataType.STRING_ARRAY };\n@@ -168,6 +185,7 @@ public void testStringArray() throws Exception {\n     }\n \n   }\n+\n   @Test\n   public void testIntArray() throws Exception {\n     DataType[] columnTypes = new DataType[] { DataType.INT_ARRAY };\n@@ -256,62 +274,62 @@ public void testComplexDataTypes() throws Exception {\n   private void validate(DataType type, DataTable dataTable, Object[] arr,\n       int rowId, int colId) {\n     switch (type) {\n-    case BOOLEAN:\n-      Assert.assertEquals(arr[rowId], dataTable.getBoolean(rowId, colId));\n-      break;\n-    case CHAR:\n-      Assert.assertEquals(arr[rowId], dataTable.getChar(rowId, colId));\n-      break;\n-    case BYTE:\n-      Assert.assertEquals(arr[rowId], dataTable.getByte(rowId, colId));\n-      break;\n-    case SHORT:\n-      Assert.assertEquals(arr[rowId], dataTable.getShort(rowId, colId));\n-      break;\n-    case INT:\n-      Assert.assertEquals(arr[rowId], dataTable.getInt(rowId, colId));\n-      break;\n-    case LONG:\n-      Assert.assertEquals(arr[rowId], dataTable.getLong(rowId, colId));\n-      break;\n-    case FLOAT:\n-      Assert.assertEquals(arr[rowId], dataTable.getFloat(rowId, colId));\n-      break;\n-    case DOUBLE:\n-      Assert.assertEquals(arr[rowId], dataTable.getDouble(rowId, colId));\n-      break;\n-    case STRING:\n-      Assert.assertEquals(arr[rowId], dataTable.getString(rowId, colId));\n-      break;\n-    case BYTE_ARRAY:\n-      byte[] expectedByteArray = (byte[]) arr[rowId];\n-      byte[] actualByteArray = (byte[]) dataTable.getByteArray(rowId, colId);\n-      Assert.assertEquals(expectedByteArray.length, actualByteArray.length);\n-      Assert.assertTrue(Arrays.equals(expectedByteArray, actualByteArray));\n-      break;\n-    case CHAR_ARRAY:\n-      char[] expectedCharArray = (char[]) arr[rowId];\n-      char[] actualChartArray = (char[]) dataTable.getCharArray(rowId, colId);\n-      Assert.assertEquals(expectedCharArray.length, actualChartArray.length);\n-      Assert.assertTrue(Arrays.equals(expectedCharArray, actualChartArray));\n-      break;\n-    case INT_ARRAY:\n-      int[] expectedIntArray = (int[]) arr[rowId];\n-      int[] actualIntArray = (int[]) dataTable.getIntArray(rowId, colId);\n-      Assert.assertEquals(expectedIntArray.length, actualIntArray.length);\n-      Assert.assertTrue(Arrays.equals(expectedIntArray, actualIntArray));\n-      break;\n-    case STRING_ARRAY:\n-      String[] expectedStringArray = (String[]) arr[rowId];\n-      String[] actualStringArray = (String[]) dataTable.getStringArray(rowId, colId);\n-      Assert.assertEquals(expectedStringArray.length, actualStringArray.length);\n-      Assert.assertTrue(Arrays.equals(expectedStringArray, actualStringArray));\n-      break;\n-    case OBJECT:\n-      Assert.assertEquals(arr[rowId], dataTable.getObject(rowId, colId));\n-      break;\n-    default:\n-      break;\n+      case BOOLEAN:\n+        Assert.assertEquals(arr[rowId], dataTable.getBoolean(rowId, colId));\n+        break;\n+      case CHAR:\n+        Assert.assertEquals(arr[rowId], dataTable.getChar(rowId, colId));\n+        break;\n+      case BYTE:\n+        Assert.assertEquals(arr[rowId], dataTable.getByte(rowId, colId));\n+        break;\n+      case SHORT:\n+        Assert.assertEquals(arr[rowId], dataTable.getShort(rowId, colId));\n+        break;\n+      case INT:\n+        Assert.assertEquals(arr[rowId], dataTable.getInt(rowId, colId));\n+        break;\n+      case LONG:\n+        Assert.assertEquals(arr[rowId], dataTable.getLong(rowId, colId));\n+        break;\n+      case FLOAT:\n+        Assert.assertEquals(arr[rowId], dataTable.getFloat(rowId, colId));\n+        break;\n+      case DOUBLE:\n+        Assert.assertEquals(arr[rowId], dataTable.getDouble(rowId, colId));\n+        break;\n+      case STRING:\n+        Assert.assertEquals(arr[rowId], dataTable.getString(rowId, colId));\n+        break;\n+      case BYTE_ARRAY:\n+        byte[] expectedByteArray = (byte[]) arr[rowId];\n+        byte[] actualByteArray = (byte[]) dataTable.getByteArray(rowId, colId);\n+        Assert.assertEquals(expectedByteArray.length, actualByteArray.length);\n+        Assert.assertTrue(Arrays.equals(expectedByteArray, actualByteArray));\n+        break;\n+      case CHAR_ARRAY:\n+        char[] expectedCharArray = (char[]) arr[rowId];\n+        char[] actualChartArray = (char[]) dataTable.getCharArray(rowId, colId);\n+        Assert.assertEquals(expectedCharArray.length, actualChartArray.length);\n+        Assert.assertTrue(Arrays.equals(expectedCharArray, actualChartArray));\n+        break;\n+      case INT_ARRAY:\n+        int[] expectedIntArray = (int[]) arr[rowId];\n+        int[] actualIntArray = (int[]) dataTable.getIntArray(rowId, colId);\n+        Assert.assertEquals(expectedIntArray.length, actualIntArray.length);\n+        Assert.assertTrue(Arrays.equals(expectedIntArray, actualIntArray));\n+        break;\n+      case STRING_ARRAY:\n+        String[] expectedStringArray = (String[]) arr[rowId];\n+        String[] actualStringArray = (String[]) dataTable.getStringArray(rowId, colId);\n+        Assert.assertEquals(expectedStringArray.length, actualStringArray.length);\n+        Assert.assertTrue(Arrays.equals(expectedStringArray, actualStringArray));\n+        break;\n+      case OBJECT:\n+        Assert.assertEquals(arr[rowId], dataTable.getObject(rowId, colId));\n+        break;\n+      default:\n+        break;\n     }\n   }\n \n@@ -322,39 +340,39 @@ private void validate(DataTable dataTable, int numRows, DataSchema schema,\n       for (int colId = 0; colId < schema.columnNames.length; colId++) {\n         final DataType type = schema.columnTypes[colId];\n         switch (type) {\n-        case BOOLEAN:\n-          Assert.assertEquals(boolArr[rowId],\n-              dataTable.getBoolean(rowId, colId));\n-          break;\n-        case CHAR:\n-          Assert.assertEquals(cArr[rowId], dataTable.getChar(rowId, colId));\n-          break;\n-        case BYTE:\n-          Assert.assertEquals(bArr[rowId], dataTable.getByte(rowId, colId));\n-          break;\n-        case SHORT:\n-          Assert.assertEquals(sArr[rowId], dataTable.getShort(rowId, colId));\n-          break;\n-        case INT:\n-          Assert.assertEquals(iArr[rowId], dataTable.getInt(rowId, colId));\n-          break;\n-        case LONG:\n-          Assert.assertEquals(lArr[rowId], dataTable.getLong(rowId, colId));\n-          break;\n-        case FLOAT:\n-          Assert.assertEquals(fArr[rowId], dataTable.getFloat(rowId, colId));\n-          break;\n-        case DOUBLE:\n-          Assert.assertEquals(dArr[rowId], dataTable.getDouble(rowId, colId));\n-          break;\n-        case STRING:\n-          Assert.assertEquals(strArr[rowId], dataTable.getString(rowId, colId));\n-          break;\n-        case OBJECT:\n-          Assert.assertEquals(oArr[rowId], dataTable.getObject(rowId, colId));\n-          break;\n-        default:\n-          break;\n+          case BOOLEAN:\n+            Assert.assertEquals(boolArr[rowId],\n+                dataTable.getBoolean(rowId, colId));\n+            break;\n+          case CHAR:\n+            Assert.assertEquals(cArr[rowId], dataTable.getChar(rowId, colId));\n+            break;\n+          case BYTE:\n+            Assert.assertEquals(bArr[rowId], dataTable.getByte(rowId, colId));\n+            break;\n+          case SHORT:\n+            Assert.assertEquals(sArr[rowId], dataTable.getShort(rowId, colId));\n+            break;\n+          case INT:\n+            Assert.assertEquals(iArr[rowId], dataTable.getInt(rowId, colId));\n+            break;\n+          case LONG:\n+            Assert.assertEquals(lArr[rowId], dataTable.getLong(rowId, colId));\n+            break;\n+          case FLOAT:\n+            Assert.assertEquals(fArr[rowId], dataTable.getFloat(rowId, colId));\n+            break;\n+          case DOUBLE:\n+            Assert.assertEquals(dArr[rowId], dataTable.getDouble(rowId, colId));\n+            break;\n+          case STRING:\n+            Assert.assertEquals(strArr[rowId], dataTable.getString(rowId, colId));\n+            break;\n+          case OBJECT:\n+            Assert.assertEquals(oArr[rowId], dataTable.getObject(rowId, colId));\n+            break;\n+          default:\n+            break;\n         }\n       }\n     }\n@@ -376,6 +394,5 @@ public boolean equals(Object obj) {\n     public int hashCode() {\n       return new Integer(i).hashCode();\n     }\n-\n   }\n }",
                "deletions": 147
            },
            {
                "sha": "a58bd3046369e850362f8584656bf09b928a5168",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/block/query/IntermediateResultsBlock.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/block/query/IntermediateResultsBlock.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/block/query/IntermediateResultsBlock.java",
                "status": "modified",
                "changes": 12,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/block/query/IntermediateResultsBlock.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -131,6 +131,9 @@ public DataTable getDataTable() throws Exception {\n     if (_selectionResult != null) {\n       return getSelectionResultDataTable();\n     }\n+    if (_processingExceptions != null && _processingExceptions.size() > 0) {\n+      return getExceptionsDataTable();\n+    }\n     throw new UnsupportedOperationException(\"Cannot get DataTable from IntermediateResultBlock!\");\n   }\n \n@@ -139,9 +142,18 @@ public DataTable attachMetadataToDataTable(DataTable dataTable) {\n     dataTable.getMetadata().put(NUM_DOCS_SCANNED, _numDocsScanned + \"\");\n     dataTable.getMetadata().put(TIME_USED_MS, _timeUsedMs + \"\");\n     dataTable.getMetadata().put(TOTAL_DOCS, _totalDocs + \"\");\n+    if (_processingExceptions != null && _processingExceptions.size() > 0) {\n+      for (int i = 0; i < _processingExceptions.size(); ++i) {\n+        dataTable.addException(_processingExceptions.get(i));\n+      }\n+    }\n     return dataTable;\n   }\n \n+  public DataTable getExceptionsDataTable() {\n+    return attachMetadataToDataTable(new DataTable());\n+  }\n+\n   private DataTable getSelectionResultDataTable() throws Exception {\n     return attachMetadataToDataTable(SelectionOperatorUtils.getDataTableFromRowSet(_selectionResult, _dataSchema));\n   }",
                "deletions": 0
            },
            {
                "sha": "3813f8be7438ddc23a1840285f8a82c4e3d3e1d5",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java",
                "status": "modified",
                "changes": 91,
                "additions": 59,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/MCombineOperator.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -17,6 +17,8 @@\n \n import java.util.ArrayList;\n import java.util.List;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n import java.util.concurrent.Callable;\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.ExecutorService;\n@@ -99,35 +101,65 @@ public boolean open() {\n \n   @Override\n   public Block nextBlock() {\n-    long start = System.currentTimeMillis();\n+    final long startTime = System.currentTimeMillis();\n     if (_isParallel) {\n-      long queryEndTime = System.currentTimeMillis() + _timeOutMs;\n+      final long queryEndTime = System.currentTimeMillis() + _timeOutMs;\n+      final BlockingQueue<Block> blockingQueue = new ArrayBlockingQueue<Block>(_operators.size());\n \n-      @SuppressWarnings(\"rawtypes\")\n-      List<Future> blocks = new ArrayList<Future>();\n+      // Submit operators.\n       for (final Operator operator : _operators) {\n-        blocks.add(_executorService.submit(new Callable<Block>() {\n+        _executorService.submit(new Runnable() {\n           @Override\n-          public Block call() throws Exception {\n-            return operator.nextBlock();\n+          public void run() {\n+            Block retBlock;\n+            try {\n+              retBlock = operator.nextBlock();\n+            } catch (Exception e) {\n+              retBlock = new IntermediateResultsBlock(e);\n+            }\n+            if (blockingQueue != null) {\n+              blockingQueue.offer(retBlock);\n+            }\n           }\n-        }));\n+        });\n       }\n-      LOGGER.debug(\"Submitting operators to be run in parallel and it took:\" + (System.currentTimeMillis() - start));\n+      LOGGER.debug(\"Submitting operators to be run in parallel and it took:\" + (System.currentTimeMillis() - startTime));\n+\n+      // Submit merger job:\n+      Future<IntermediateResultsBlock> mergedBlockFuture =\n+          _executorService.submit(new Callable<IntermediateResultsBlock>() {\n+            @Override\n+            public IntermediateResultsBlock call() throws Exception {\n+              int mergedBlocksNumber = 0;\n+              IntermediateResultsBlock mergedBlock = null;\n+              while ((queryEndTime > System.currentTimeMillis()) && (mergedBlocksNumber < _operators.size())) {\n+                if (mergedBlock == null) {\n+                  mergedBlock = (IntermediateResultsBlock) blockingQueue.poll(queryEndTime - System.currentTimeMillis(), TimeUnit.MILLISECONDS);\n+                  if (mergedBlock != null) {\n+                    mergedBlocksNumber++;\n+                  }\n+                  LOGGER.debug(\"Got response from operator 0 after: {}\", (System.currentTimeMillis() - startTime));\n+                } else {\n+                  IntermediateResultsBlock blockToMerge = (IntermediateResultsBlock) blockingQueue.poll(queryEndTime - System.currentTimeMillis(), TimeUnit.MILLISECONDS);\n+                  if (blockToMerge != null) {\n+                    try {\n+                      LOGGER.debug(\"Got response from operator {} after: {}\", mergedBlocksNumber, (System.currentTimeMillis() - startTime));\n+                      CombineService.mergeTwoBlocks(_brokerRequest, mergedBlock, blockToMerge);\n+                      LOGGER.debug(\"Merged response from operator {} after: {}\", mergedBlocksNumber, (System.currentTimeMillis() - startTime));\n+                    } catch (Exception e) {\n+                      mergedBlock.getExceptions().add(QueryException.getException(QueryException.MERGE_RESPONSE_ERROR, e));\n+                    }\n+                    mergedBlocksNumber++;\n+                  }\n+                }\n+              }\n+              return mergedBlock;\n+            }\n+          });\n+\n+      // Get merge results.\n       try {\n-        _mergedBlock =\n-            (IntermediateResultsBlock) blocks.get(0).get(queryEndTime - System.currentTimeMillis(),\n-                TimeUnit.MILLISECONDS);\n-        LOGGER.debug(\"Got response from operator 0 after: \" + (System.currentTimeMillis() - start));\n-\n-        for (int i = 1; i < blocks.size(); ++i) {\n-          IntermediateResultsBlock blockToMerge =\n-              (IntermediateResultsBlock) blocks.get(i).get(queryEndTime - System.currentTimeMillis(),\n-                  TimeUnit.MILLISECONDS);\n-          LOGGER.debug(\"Got response from operator \" + i + \" after: \" + (System.currentTimeMillis() - start));\n-          CombineService.mergeTwoBlocks(_brokerRequest, _mergedBlock, blockToMerge);\n-          LOGGER.debug(\"Merged response from operator \" + i + \" after: \" + (System.currentTimeMillis() - start));\n-        }\n+        _mergedBlock = mergedBlockFuture.get(queryEndTime - System.currentTimeMillis(), TimeUnit.MILLISECONDS);\n       } catch (InterruptedException e) {\n         LOGGER.error(\"InterruptedException \", e);\n         if (_mergedBlock == null) {\n@@ -137,9 +169,7 @@ public Block call() throws Exception {\n         if (exceptions == null) {\n           exceptions = new ArrayList<ProcessingException>();\n         }\n-        ProcessingException exception = QueryException.FUTURE_CALL_ERROR.deepCopy();\n-        exception.setMessage(e.getMessage());\n-        exceptions.add(exception);\n+        exceptions.add(QueryException.getException(QueryException.FUTURE_CALL_ERROR, e));\n         _mergedBlock.setExceptionsList(exceptions);\n       } catch (ExecutionException e) {\n         LOGGER.error(\"Execution Exception\", e);\n@@ -150,9 +180,7 @@ public Block call() throws Exception {\n         if (exceptions == null) {\n           exceptions = new ArrayList<ProcessingException>();\n         }\n-        ProcessingException exception = QueryException.QUERY_EXECUTION_ERROR.deepCopy();\n-        exception.setMessage(e.getMessage());\n-        exceptions.add(exception);\n+        exceptions.add(QueryException.getException(QueryException.MERGE_RESPONSE_ERROR, e));\n         _mergedBlock.setExceptionsList(exceptions);\n       } catch (TimeoutException e) {\n         LOGGER.error(\"TimeoutException \", e);\n@@ -163,11 +191,10 @@ public Block call() throws Exception {\n         if (exceptions == null) {\n           exceptions = new ArrayList<ProcessingException>();\n         }\n-        ProcessingException exception = QueryException.EXECUTION_TIMEOUT_ERROR.deepCopy();\n-        exception.setMessage(e.getMessage());\n-        exceptions.add(exception);\n+        exceptions.add(QueryException.getException(QueryException.EXECUTION_TIMEOUT_ERROR, e));\n         _mergedBlock.setExceptionsList(exceptions);\n       }\n+\n     } else {\n       for (Operator operator : _operators) {\n         if ((operator instanceof MAggregationOperator) || (operator instanceof MSelectionOrderByOperator) || (operator instanceof MSelectionOnlyOperator)\n@@ -189,7 +216,7 @@ public Block call() throws Exception {\n       trimToSize(_brokerRequest, _mergedBlock);\n     }\n     long end = System.currentTimeMillis();\n-    LOGGER.info(\"Time spent in MCombineOperator:\" + (end - start));\n+    LOGGER.info(\"Time spent in MCombineOperator:\" + (end - startTime));\n \n     return _mergedBlock;\n   }",
                "deletions": 32
            },
            {
                "sha": "af9f6e2ca1e02e1aeea5860e6ab487cfd381cb6c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MSelectionOnlyOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MSelectionOnlyOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MSelectionOnlyOperator.java",
                "status": "modified",
                "changes": 59,
                "additions": 20,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/query/MSelectionOnlyOperator.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -18,14 +18,11 @@\n import java.io.Serializable;\n import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.List;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.linkedin.pinot.common.exception.QueryException;\n import com.linkedin.pinot.common.request.Selection;\n-import com.linkedin.pinot.common.response.ProcessingException;\n import com.linkedin.pinot.common.utils.DataTableBuilder.DataSchema;\n import com.linkedin.pinot.core.block.query.IntermediateResultsBlock;\n import com.linkedin.pinot.core.block.query.ProjectionBlock;\n@@ -82,45 +79,29 @@ public Block nextBlock() {\n \n     long numDocsScanned = 0;\n     ProjectionBlock projectionBlock = null;\n-    try {\n-      while ((projectionBlock = (ProjectionBlock) _projectionOperator.nextBlock()) != null) {\n-        int j = 0;\n-        for (int i = 0; i < _dataSchema.size(); ++i) {\n-          _blocks[j++] = projectionBlock.getBlock(_dataSchema.getColumnName(i));\n-        }\n-        BlockDocIdIterator blockDocIdIterator = projectionBlock.getDocIdSetBlock().getBlockDocIdSet().iterator();\n-        int docId;\n-        while ((docId = blockDocIdIterator.next()) != Constants.EOF && _rowEvents.size() < _limitDocs) {\n-          numDocsScanned++;\n-          _rowEvents.add(SelectionOperatorUtils.collectRowFromBlockValSets(docId, _blocks, _dataSchema));\n-        }\n+    while ((projectionBlock = (ProjectionBlock) _projectionOperator.nextBlock()) != null) {\n+      int j = 0;\n+      for (int i = 0; i < _dataSchema.size(); ++i) {\n+        _blocks[j++] = projectionBlock.getBlock(_dataSchema.getColumnName(i));\n+      }\n+      BlockDocIdIterator blockDocIdIterator = projectionBlock.getDocIdSetBlock().getBlockDocIdSet().iterator();\n+      int docId;\n+      while ((docId = blockDocIdIterator.next()) != Constants.EOF && _rowEvents.size() < _limitDocs) {\n+        numDocsScanned++;\n+        _rowEvents.add(SelectionOperatorUtils.collectRowFromBlockValSets(docId, _blocks, _dataSchema));\n       }\n-\n-      final IntermediateResultsBlock resultBlock = new IntermediateResultsBlock();\n-      resultBlock.setSelectionResult(_rowEvents);\n-      resultBlock.setSelectionDataSchema(_dataSchema);\n-      resultBlock.setNumDocsScanned(numDocsScanned);\n-      resultBlock.setTotalDocs(_indexSegment.getTotalDocs());\n-      final long endTime = System.currentTimeMillis();\n-      resultBlock.setTimeUsedMs(endTime - startTime);\n-      LOGGER.debug(\"Time spent in MSelectionOnlyOperator:\" + (endTime - startTime));\n-      return resultBlock;\n-    } catch (Exception e) {\n-      LOGGER.warn(\"Caught exception while processing selection operator\", e);\n-      final IntermediateResultsBlock resultBlock = new IntermediateResultsBlock();\n-\n-      List<ProcessingException> processingExceptions = new ArrayList<ProcessingException>();\n-      ProcessingException exception = QueryException.QUERY_EXECUTION_ERROR.deepCopy();\n-      exception.setMessage(e.getMessage());\n-      processingExceptions.add(exception);\n-\n-      resultBlock.setExceptionsList(processingExceptions);\n-      resultBlock.setNumDocsScanned(0);\n-      resultBlock.setTotalDocs(_indexSegment.getTotalDocs());\n-      resultBlock.setTimeUsedMs(System.currentTimeMillis() - startTime);\n-      return resultBlock;\n     }\n \n+    final IntermediateResultsBlock resultBlock = new IntermediateResultsBlock();\n+    resultBlock.setSelectionResult(_rowEvents);\n+    resultBlock.setSelectionDataSchema(_dataSchema);\n+    resultBlock.setNumDocsScanned(numDocsScanned);\n+    resultBlock.setTotalDocs(_indexSegment.getTotalDocs());\n+    final long endTime = System.currentTimeMillis();\n+    resultBlock.setTimeUsedMs(endTime - startTime);\n+    LOGGER.debug(\"Time spent in MSelectionOnlyOperator:\" + (endTime - startTime));\n+    return resultBlock;\n+\n   }\n \n   @Override",
                "deletions": 39
            },
            {
                "sha": "f5128b38600c1769971a239d21f03efbc25e1de6",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/CombineService.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/CombineService.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/CombineService.java",
                "status": "modified",
                "changes": 30,
                "additions": 28,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/CombineService.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -41,7 +41,14 @@\n \n   public static void mergeTwoBlocks(BrokerRequest brokerRequest, IntermediateResultsBlock mergedBlock,\n       IntermediateResultsBlock blockToMerge) {\n-\n+    // Sanity check\n+    if (blockToMerge == null) {\n+      return;\n+    }\n+    if (mergedBlock == null) {\n+      mergedBlock = blockToMerge;\n+      return;\n+    }\n     // Combine NumDocsScanned\n     mergedBlock.setNumDocsScanned(mergedBlock.getNumDocsScanned() + blockToMerge.getNumDocsScanned());\n     // Combine TotalDocs\n@@ -83,6 +90,13 @@ public static void mergeTwoBlocks(BrokerRequest brokerRequest, IntermediateResul\n \n   private static List<Map<String, Serializable>> combineAggregationGroupByResults1(BrokerRequest brokerRequest,\n       List<Map<String, Serializable>> list1, List<Map<String, Serializable>> list2) {\n+    if (list1 == null) {\n+      return list2;\n+    }\n+    if (list2 == null) {\n+      return list1;\n+    }\n+\n     for (int i = 0; i < list1.size(); ++i) {\n       list1.set(i, mergeTwoGroupedResults(brokerRequest.getAggregationsInfo().get(i), list1.get(i), list2.get(i)));\n     }\n@@ -93,6 +107,13 @@ public static void mergeTwoBlocks(BrokerRequest brokerRequest, IntermediateResul\n \n   private static Map<String, Serializable> mergeTwoGroupedResults(AggregationInfo aggregationInfo,\n       Map<String, Serializable> map1, Map<String, Serializable> map2) {\n+    if (map1 == null) {\n+      return map2;\n+    }\n+    if (map2 == null) {\n+      return map1;\n+    }\n+\n     AggregationFunction aggregationFunction = AggregationFunctionFactory.get(aggregationInfo, true);\n     for (String key : map2.keySet()) {\n       if (map1.containsKey(key)) {\n@@ -106,7 +127,12 @@ public static void mergeTwoBlocks(BrokerRequest brokerRequest, IntermediateResul\n \n   private static List<Serializable> combineAggregationResults(BrokerRequest brokerRequest,\n       List<Serializable> aggregationResult1, List<Serializable> aggregationResult2) {\n-\n+    if (aggregationResult1 == null) {\n+      return aggregationResult2;\n+    }\n+    if (aggregationResult2 == null) {\n+      return aggregationResult1;\n+    }\n     List<List<Serializable>> aggregationResultsList = new ArrayList<List<Serializable>>();\n \n     for (int i = 0; i < brokerRequest.getAggregationsInfoSize(); ++i) {",
                "deletions": 2
            },
            {
                "sha": "db0a27e6438f18a9a92af891bce65906ca626b64",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/groupby/AggregationGroupByOperatorService.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/groupby/AggregationGroupByOperatorService.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/groupby/AggregationGroupByOperatorService.java",
                "status": "modified",
                "changes": 28,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/aggregation/groupby/AggregationGroupByOperatorService.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -15,7 +15,6 @@\n  */\n package com.linkedin.pinot.core.query.aggregation.groupby;\n \n-import com.linkedin.pinot.common.Utils;\n import it.unimi.dsi.fastutil.PriorityQueue;\n import it.unimi.dsi.fastutil.objects.ObjectArrayPriorityQueue;\n \n@@ -31,7 +30,10 @@\n import org.json.JSONArray;\n import org.json.JSONException;\n import org.json.JSONObject;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n+import com.linkedin.pinot.common.Utils;\n import com.linkedin.pinot.common.data.FieldSpec.DataType;\n import com.linkedin.pinot.common.request.AggregationInfo;\n import com.linkedin.pinot.common.request.GroupBy;\n@@ -40,8 +42,6 @@\n import com.linkedin.pinot.core.query.aggregation.AggregationFunction;\n import com.linkedin.pinot.core.query.aggregation.AggregationFunctionFactory;\n import com.linkedin.pinot.core.query.utils.Pair;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n \n /**\n@@ -91,7 +91,9 @@ public AggregationGroupByOperatorService(List<AggregationInfo> aggregationInfos,\n     List<Map<String, Serializable>> reducedResult = null;\n     for (DataTable toBeReducedGroupByResults : instanceResponseMap.values()) {\n       if (reducedResult == null) {\n-        reducedResult = transformDataTableToGroupByResult(toBeReducedGroupByResults);\n+        if (toBeReducedGroupByResults != null) {\n+          reducedResult = transformDataTableToGroupByResult(toBeReducedGroupByResults);\n+        }\n       } else {\n         List<Map<String, Serializable>> toBeReducedResult =\n             transformDataTableToGroupByResult(toBeReducedGroupByResults);\n@@ -109,12 +111,14 @@ public AggregationGroupByOperatorService(List<AggregationInfo> aggregationInfos,\n         }\n       }\n     }\n-    for (int i = 0; i < reducedResult.size(); ++i) {\n-      Map<String, Serializable> functionLevelReducedResult = reducedResult.get(i);\n-      for (String key : functionLevelReducedResult.keySet()) {\n-        if (functionLevelReducedResult.get(key) != null) {\n-          functionLevelReducedResult.put(key,\n-              _aggregationFunctionList.get(i).reduce(Arrays.asList(functionLevelReducedResult.get(key))));\n+    if (reducedResult != null) {\n+      for (int i = 0; i < reducedResult.size(); ++i) {\n+        Map<String, Serializable> functionLevelReducedResult = reducedResult.get(i);\n+        for (String key : functionLevelReducedResult.keySet()) {\n+          if (functionLevelReducedResult.get(key) != null) {\n+            functionLevelReducedResult.put(key,\n+                _aggregationFunctionList.get(i).reduce(Arrays.asList(functionLevelReducedResult.get(key))));\n+          }\n         }\n       }\n     }\n@@ -123,7 +127,9 @@ public AggregationGroupByOperatorService(List<AggregationInfo> aggregationInfos,\n \n   public List<JSONObject> renderGroupByOperators(List<Map<String, Serializable>> finalAggregationResult) {\n     try {\n-\n+      if (finalAggregationResult == null || finalAggregationResult.size() != _aggregationFunctionList.size()) {\n+        return null;\n+      }\n       List<JSONObject> retJsonResultList = new ArrayList<JSONObject>();\n       for (int i = 0; i < _aggregationFunctionList.size(); ++i) {\n         DecimalFormat df = DEFAULT_FORMAT_STRING_MAP.get(_aggregationFunctionList.get(i).aggregateResultDataType());",
                "deletions": 11
            },
            {
                "sha": "8825e161f69d927080caaa3c5bce3e834629b5ad",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/executor/ServerQueryExecutorV1Impl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/executor/ServerQueryExecutorV1Impl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/executor/ServerQueryExecutorV1Impl.java",
                "status": "modified",
                "changes": 19,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/executor/ServerQueryExecutorV1Impl.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -29,6 +29,7 @@\n import org.slf4j.LoggerFactory;\n \n import com.linkedin.pinot.common.data.DataManager;\n+import com.linkedin.pinot.common.exception.QueryException;\n import com.linkedin.pinot.common.metrics.ServerMeter;\n import com.linkedin.pinot.common.metrics.ServerMetrics;\n import com.linkedin.pinot.common.metrics.ServerQueryPhase;\n@@ -101,8 +102,8 @@ public void init(Configuration queryExecutorConfig, DataManager dataManager, Ser\n   @Override\n   public DataTable processQuery(final InstanceRequest instanceRequest) {\n     DataTable instanceResponse;\n+    long start = System.currentTimeMillis();\n     try {\n-      long start = System.currentTimeMillis();\n       final BrokerRequest brokerRequest = instanceRequest.getQuery();\n       LOGGER.info(\"Incoming query is :\" + brokerRequest);\n       final List<IndexSegment> queryableSegmentDataManagerList = _serverMetrics.timePhase(brokerRequest,\n@@ -127,6 +128,7 @@ public Plan call() throws Exception {\n               getResourceTimeOut(instanceRequest.getQuery()));\n         }\n       });\n+\n       if (_printQueryPlan) {\n         LOGGER.debug(\"***************************** Query Plan for Request \" + instanceRequest.getRequestId() + \"***********************************\");\n         globalQueryPlan.print();\n@@ -142,21 +144,28 @@ public Object call()\n       });\n       instanceResponse = globalQueryPlan.getInstanceResponse();\n       long end = System.currentTimeMillis();\n-      LOGGER.info(\"Searching Instance for Request Id - \" + instanceRequest.getRequestId() + \", browse took: \" + (end - start));\n-      LOGGER.debug(\"InstanceResponse for Request Id - \" + instanceRequest.getRequestId() + \" : \" + instanceResponse.toString());\n+      LOGGER.info(\"Searching Instance for Request Id - {}, browse took: {}\", instanceRequest.getRequestId(), (end - start));\n+      LOGGER.debug(\"InstanceResponse for Request Id - {} : {}\", instanceRequest.getRequestId(), instanceResponse.toString());\n       instanceResponse.getMetadata().put(\"timeUsedMs\", Long.toString((end - start)));\n       instanceResponse.getMetadata().put(\"requestId\", Long.toString(instanceRequest.getRequestId()));\n+      return instanceResponse;\n     } catch (Exception e) {\n       _serverMetrics.addMeteredValue(instanceRequest.getQuery(), ServerMeter.QUERY_EXECUTION_EXCEPTIONS, 1);\n       LOGGER.error(e.getMessage(), e);\n-      instanceResponse = null;\n+      instanceResponse = new DataTable();\n+      instanceResponse.addException(QueryException.getException(QueryException.QUERY_EXECUTION_ERROR, e));\n+      long end = System.currentTimeMillis();\n+      LOGGER.info(\"Searching Instance for Request Id - {}, browse took: {}\", instanceRequest.getRequestId(), (end - start));\n+      LOGGER.debug(\"InstanceResponse for Request Id - {} : {}\", instanceRequest.getRequestId(), instanceResponse.toString());\n+      instanceResponse.getMetadata().put(\"timeUsedMs\", Long.toString((end - start)));\n+      instanceResponse.getMetadata().put(\"requestId\", Long.toString(instanceRequest.getRequestId()));\n+      return instanceResponse;\n     } finally {\n       if (_instanceDataManager.getResourceDataManager(instanceRequest.getQuery().getQuerySource().getResourceName()) != null) {\n         _instanceDataManager.getResourceDataManager(instanceRequest.getQuery().getQuerySource().getResourceName())\n             .returnSegmentReaders(instanceRequest.getSearchSegments());\n       }\n     }\n-    return instanceResponse;\n   }\n \n   private List<IndexSegment> getPrunedQueryableSegments(final InstanceRequest instanceRequest) {",
                "deletions": 5
            },
            {
                "sha": "91b40dc30da8e196004f8cbce7ce1ecbbf3312f7",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/reduce/DefaultReduceService.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/reduce/DefaultReduceService.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/reduce/DefaultReduceService.java",
                "status": "modified",
                "changes": 81,
                "additions": 52,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/reduce/DefaultReduceService.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -15,8 +15,6 @@\n  */\n package com.linkedin.pinot.core.query.reduce;\n \n-import com.linkedin.pinot.common.Utils;\n-\n import java.io.Serializable;\n import java.util.ArrayList;\n import java.util.Collection;\n@@ -25,7 +23,11 @@\n \n import org.json.JSONException;\n import org.json.JSONObject;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n+import com.linkedin.pinot.common.Utils;\n+import com.linkedin.pinot.common.exception.QueryException;\n import com.linkedin.pinot.common.query.ReduceService;\n import com.linkedin.pinot.common.request.BrokerRequest;\n import com.linkedin.pinot.common.response.AggregationResult;\n@@ -42,9 +44,6 @@\n import com.linkedin.pinot.core.query.selection.SelectionOperatorService;\n import com.linkedin.pinot.core.query.selection.SelectionOperatorUtils;\n \n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n \n /**\n  * DefaultReduceService will reduce DataTables gathered from multiple instances\n@@ -123,8 +122,24 @@ public BrokerResponse reduceOnDataTable(BrokerRequest brokerRequest,\n     if (instanceResponseMap == null || instanceResponseMap.size() == 0) {\n       return BrokerResponse.EMPTY_RESULT;\n     }\n-    for (ServerInstance serverInstance : instanceResponseMap.keySet()) {\n+    for (ServerInstance serverInstance : instanceResponseMap.keySet().toArray(new ServerInstance[instanceResponseMap.size()])) {\n       DataTable instanceResponse = instanceResponseMap.get(serverInstance);\n+      if (instanceResponse == null) {\n+        continue;\n+      }\n+      if (instanceResponse.getDataSchema() == null && instanceResponse.getMetadata() != null) {\n+        for (String key : instanceResponse.getMetadata().keySet()) {\n+          if (key.startsWith(\"Exception\")) {\n+            ProcessingException processingException = new ProcessingException();\n+            processingException.setErrorCode(Integer.parseInt(key.substring(9)));\n+            processingException.setMessage(instanceResponse.getMetadata().get(key));\n+            brokerResponse.addToExceptions(processingException);\n+          }\n+        }\n+        instanceResponseMap.remove(serverInstance);\n+        continue;\n+      }\n+\n       // reduceOnNumDocsScanned\n       brokerResponse.setNumDocsScanned(brokerResponse.getNumDocsScanned()\n           + Long.parseLong(instanceResponse.getMetadata().get(NUM_DOCS_SCANNED)));\n@@ -135,35 +150,40 @@ public BrokerResponse reduceOnDataTable(BrokerRequest brokerRequest,\n         brokerResponse.setTimeUsedMs(Long.parseLong(instanceResponse.getMetadata().get(TIME_USED_MS)));\n       }\n     }\n+    try {\n \n-    if (brokerRequest.isSetSelections() && (brokerRequest.getSelections().getSelectionColumns() != null)\n-        && (brokerRequest.getSelections().getSelectionColumns().size() >= 0)) {\n-      // Reduce DataTable for selection query.\n-      JSONObject selectionRet = reduceOnSelectionResults(brokerRequest, instanceResponseMap);\n-      brokerResponse.setSelectionResults(selectionRet);\n-      return brokerResponse;\n-    }\n-    if (brokerRequest.isSetAggregationsInfo()) {\n-      if (!brokerRequest.isSetGroupBy()) {\n-        List<List<Serializable>> aggregationResultsList =\n-            getShuffledAggregationResults(brokerRequest, instanceResponseMap);\n-        brokerResponse.setAggregationResults(reduceOnAggregationResults(brokerRequest, aggregationResultsList));\n-      } else {\n-        // Reduce DataTable for aggregation groupby query.\n-        //        GroupByAggregationService groupByAggregationService =\n-        //            new GroupByAggregationService(brokerRequest.getAggregationsInfo(), brokerRequest.getGroupBy());\n-        //        brokerResponse.setAggregationResults(reduceOnAggregationGroupByResults(groupByAggregationService,\n-        //            instanceResponseMap));\n+      if (brokerRequest.isSetSelections() && (brokerRequest.getSelections().getSelectionColumns() != null)\n+          && (brokerRequest.getSelections().getSelectionColumns().size() >= 0)) {\n+        // Reduce DataTable for selection query.\n+        JSONObject selectionRet = reduceOnSelectionResults(brokerRequest, instanceResponseMap);\n+        brokerResponse.setSelectionResults(selectionRet);\n+        return brokerResponse;\n+      }\n+      if (brokerRequest.isSetAggregationsInfo()) {\n+        if (!brokerRequest.isSetGroupBy()) {\n+          List<List<Serializable>> aggregationResultsList =\n+              getShuffledAggregationResults(brokerRequest, instanceResponseMap);\n+          brokerResponse.setAggregationResults(reduceOnAggregationResults(brokerRequest, aggregationResultsList));\n+        } else {\n+          // Reduce DataTable for aggregation groupby query.\n+          //        GroupByAggregationService groupByAggregationService =\n+          //            new GroupByAggregationService(brokerRequest.getAggregationsInfo(), brokerRequest.getGroupBy());\n+          //        brokerResponse.setAggregationResults(reduceOnAggregationGroupByResults(groupByAggregationService,\n+          //            instanceResponseMap));\n \n-        AggregationGroupByOperatorService aggregationGroupByOperatorService =\n-            new AggregationGroupByOperatorService(brokerRequest.getAggregationsInfo(), brokerRequest.getGroupBy());\n-        brokerResponse.setAggregationResults(reduceOnAggregationGroupByOperatorResults(\n-            aggregationGroupByOperatorService, instanceResponseMap));\n+          AggregationGroupByOperatorService aggregationGroupByOperatorService =\n+              new AggregationGroupByOperatorService(brokerRequest.getAggregationsInfo(), brokerRequest.getGroupBy());\n+          brokerResponse.setAggregationResults(reduceOnAggregationGroupByOperatorResults(\n+              aggregationGroupByOperatorService, instanceResponseMap));\n \n+        }\n+        return brokerResponse;\n       }\n+\n+    } catch (Exception e) {\n+      brokerResponse.addToExceptions(QueryException.getException(QueryException.BROKER_GATHER_ERROR, e));\n       return brokerResponse;\n     }\n-\n     throw new UnsupportedOperationException(\n         \"Should not reach here, the query has no attributes of selection or aggregation!\");\n   }\n@@ -226,6 +246,9 @@ private JSONObject reduceOnSelectionResults(BrokerRequest brokerRequest,\n     for (ServerInstance serverInstance : instanceResponseMap.keySet()) {\n       DataTable instanceResponse = instanceResponseMap.get(serverInstance);\n       aggregationResultSchema = instanceResponse.getDataSchema();\n+      if (aggregationResultSchema == null) {\n+        continue;\n+      }\n       // Shuffle AggregationResults\n       for (int rowId = 0; rowId < instanceResponse.getNumberOfRows(); ++rowId) {\n         for (int colId = 0; colId < brokerRequest.getAggregationsInfoSize(); ++colId) {",
                "deletions": 29
            },
            {
                "sha": "3a1627e7e8a8f5da90c751444222d66c40177c2f",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorService.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorService.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorService.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorService.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -173,6 +173,12 @@ public SelectionOperatorService(Selection selections, DataSchema dataSchema) {\n \n   public Collection<Serializable[]> merge(Collection<Serializable[]> rowEventsSet1,\n       Collection<Serializable[]> rowEventsSet2) {\n+    if (rowEventsSet1 == null) {\n+      return rowEventsSet2;\n+    }\n+    if (rowEventsSet2 == null) {\n+      return rowEventsSet1;\n+    }\n     if (_doOrdering) {\n       PriorityQueue<Serializable[]> queue1 = (PriorityQueue<Serializable[]>) rowEventsSet1;\n       PriorityQueue<Serializable[]> queue2 = (PriorityQueue<Serializable[]>) rowEventsSet2;",
                "deletions": 0
            },
            {
                "sha": "4cb37776f844260192d20e5a006f34912da1c104",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorUtils.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorUtils.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorUtils.java",
                "status": "modified",
                "changes": 19,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/query/selection/SelectionOperatorUtils.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -53,8 +53,8 @@\n import com.linkedin.pinot.core.realtime.impl.dictionary.LongMutableDictionary;\n import com.linkedin.pinot.core.realtime.impl.dictionary.StringMutableDictionary;\n import com.linkedin.pinot.core.segment.index.data.source.mv.block.MultiValueBlock;\n-import com.linkedin.pinot.core.segment.index.data.source.sv.block.UnSortedSingleValueBlock;\n import com.linkedin.pinot.core.segment.index.data.source.sv.block.SortedSingleValueBlock;\n+import com.linkedin.pinot.core.segment.index.data.source.sv.block.UnSortedSingleValueBlock;\n import com.linkedin.pinot.core.segment.index.readers.Dictionary;\n import com.linkedin.pinot.core.segment.index.readers.DoubleDictionary;\n import com.linkedin.pinot.core.segment.index.readers.FloatDictionary;\n@@ -120,6 +120,12 @@\n \n   public static Collection<Serializable[]> merge(Collection<Serializable[]> rowEventsSet1,\n       Collection<Serializable[]> rowEventsSet2, int maxRowSize) {\n+    if (rowEventsSet1 == null) {\n+      return rowEventsSet2;\n+    }\n+    if (rowEventsSet2 == null) {\n+      return rowEventsSet1;\n+    }\n     final Iterator<Serializable[]> iterator = rowEventsSet2.iterator();\n     while (rowEventsSet1.size() < maxRowSize && iterator.hasNext()) {\n       final Serializable[] row = iterator.next();\n@@ -130,15 +136,10 @@\n \n   public static Collection<Serializable[]> reduce(Map<ServerInstance, DataTable> selectionResults, int maxRowSize) {\n     Collection<Serializable[]> rowEventsSet = new ArrayList<Serializable[]>();\n-\n     for (final DataTable dt : selectionResults.values()) {\n-      for (int rowId = 0; rowId < dt.getNumberOfRows(); ++rowId) {\n+      for (int rowId = 0; rowId < Math.min(dt.getNumberOfRows(), maxRowSize); ++rowId) {\n         final Serializable[] row = extractRowFromDataTable(dt, rowId);\n-        if (rowEventsSet.size() < maxRowSize) {\n-          rowEventsSet.add(row);\n-        } else {\n-          break;\n-        }\n+        rowEventsSet.add(row);\n       }\n     }\n     return rowEventsSet;\n@@ -202,7 +203,7 @@ public static DataSchema extractDataSchema(List<SelectionSort> sortSequence, Lis\n     return new DataSchema(columns.toArray(new String[0]), dataTypes);\n   }\n \n-  public static Serializable[] collectRowFromBlockValSets(int docId, Block[] blocks, DataSchema dataSchema) throws Exception {\n+  public static Serializable[] collectRowFromBlockValSets(int docId, Block[] blocks, DataSchema dataSchema) {\n \n     final Serializable[] row = new Serializable[dataSchema.size()];\n     int j = 0;",
                "deletions": 9
            },
            {
                "sha": "d10b5b7a3eb8c1181f3574f55c4818de9e23c3c3",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/queries/QueriesSentinelTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/test/java/com/linkedin/pinot/queries/QueriesSentinelTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/test/java/com/linkedin/pinot/queries/QueriesSentinelTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/queries/QueriesSentinelTest.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -77,7 +77,6 @@\n   private final String AVRO_DATA = \"data/mirror-mv.avro\";\n   private static File INDEX_DIR = new File(FileUtils.getTempDirectory() + File.separator + \"QueriesSentinelTest\");\n   private static AvroQueryGenerator AVRO_QUERY_GENERATOR;\n-  private static FileBasedInstanceDataManager INSTANCE_DATA_MANAGER;\n   private static QueryExecutor QUERY_EXECUTOR;\n   private static TestingServerPropertiesBuilder CONFIG_BUILDER;\n   private String segmentName;",
                "deletions": 1
            },
            {
                "sha": "672fa36f779f42a8bad785ac99a0bbc831cf7af3",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/queries/QueryExceptionTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/test/java/com/linkedin/pinot/queries/QueryExceptionTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/test/java/com/linkedin/pinot/queries/QueryExceptionTest.java",
                "status": "added",
                "changes": 186,
                "additions": 186,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/queries/QueryExceptionTest.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -0,0 +1,186 @@\n+/**\n+ * Copyright (C) 2014-2015 LinkedIn Corp. (pinot-core@linkedin.com)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linkedin.pinot.queries;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.antlr.runtime.RecognitionException;\n+import org.apache.commons.configuration.PropertiesConfiguration;\n+import org.apache.commons.io.FileUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.Assert;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import com.linkedin.pinot.common.client.request.RequestConverter;\n+import com.linkedin.pinot.common.metrics.ServerMetrics;\n+import com.linkedin.pinot.common.query.QueryExecutor;\n+import com.linkedin.pinot.common.query.ReduceService;\n+import com.linkedin.pinot.common.request.BrokerRequest;\n+import com.linkedin.pinot.common.request.InstanceRequest;\n+import com.linkedin.pinot.common.response.BrokerResponse;\n+import com.linkedin.pinot.common.response.ServerInstance;\n+import com.linkedin.pinot.common.segment.ReadMode;\n+import com.linkedin.pinot.common.utils.DataTable;\n+import com.linkedin.pinot.core.data.manager.config.FileBasedInstanceDataManagerConfig;\n+import com.linkedin.pinot.core.data.manager.offline.FileBasedInstanceDataManager;\n+import com.linkedin.pinot.core.indexsegment.IndexSegment;\n+import com.linkedin.pinot.core.indexsegment.columnar.ColumnarSegmentLoader;\n+import com.linkedin.pinot.core.indexsegment.generator.SegmentGeneratorConfig;\n+import com.linkedin.pinot.core.query.executor.ServerQueryExecutorV1Impl;\n+import com.linkedin.pinot.core.query.reduce.DefaultReduceService;\n+import com.linkedin.pinot.core.segment.creator.SegmentIndexCreationDriver;\n+import com.linkedin.pinot.core.segment.creator.impl.SegmentIndexCreationDriverImpl;\n+import com.linkedin.pinot.pql.parsers.PQLCompiler;\n+import com.linkedin.pinot.segments.v1.creator.SegmentTestUtils;\n+import com.linkedin.pinot.util.TestUtils;\n+import com.yammer.metrics.core.MetricsRegistry;\n+\n+\n+public class QueryExceptionTest {\n+  private static final Logger LOGGER = LoggerFactory.getLogger(QueriesSentinelTest.class);\n+  private static ReduceService REDUCE_SERVICE = new DefaultReduceService();\n+\n+  private static final PQLCompiler REQUEST_COMPILER = new PQLCompiler(new HashMap<String, String[]>());\n+  private final String AVRO_DATA = \"data/mirror-mv.avro\";\n+  private static File INDEX_DIR = new File(FileUtils.getTempDirectory() + File.separator + \"QueriesSentinelTest\");\n+  private static QueryExecutor QUERY_EXECUTOR;\n+  private static TestingServerPropertiesBuilder CONFIG_BUILDER;\n+  private String segmentName;\n+\n+  @BeforeClass\n+  public void setup() throws Exception {\n+    CONFIG_BUILDER = new TestingServerPropertiesBuilder(\"mirror\");\n+\n+    setupSegmentFor(\"mirror\");\n+\n+    final PropertiesConfiguration serverConf = CONFIG_BUILDER.build();\n+    serverConf.setDelimiterParsingDisabled(false);\n+\n+    final FileBasedInstanceDataManager instanceDataManager = FileBasedInstanceDataManager.getInstanceDataManager();\n+    instanceDataManager.init(new FileBasedInstanceDataManagerConfig(serverConf.subset(\"pinot.server.instance\")));\n+    instanceDataManager.start();\n+\n+    System.out.println(\"************************** : \" + new File(INDEX_DIR, \"segment\").getAbsolutePath());\n+    File segmentFile = new File(INDEX_DIR, \"segment\").listFiles()[0];\n+    segmentName = segmentFile.getName();\n+    final IndexSegment indexSegment = ColumnarSegmentLoader.load(segmentFile, ReadMode.heap);\n+    instanceDataManager.getResourceDataManager(\"mirror\");\n+    instanceDataManager.getResourceDataManager(\"mirror\").addSegment(indexSegment);\n+\n+    QUERY_EXECUTOR = new ServerQueryExecutorV1Impl(false);\n+    QUERY_EXECUTOR.init(serverConf.subset(\"pinot.server.query.executor\"), instanceDataManager, new ServerMetrics(\n+        new MetricsRegistry()));\n+  }\n+\n+  @AfterClass\n+  public void tearDown() {\n+    FileUtils.deleteQuietly(INDEX_DIR);\n+  }\n+\n+  private void setupSegmentFor(String resource) throws Exception {\n+    final String filePath = TestUtils.getFileFromResourceUrl(getClass().getClassLoader().getResource(AVRO_DATA));\n+\n+    if (INDEX_DIR.exists()) {\n+      FileUtils.deleteQuietly(INDEX_DIR);\n+    }\n+    INDEX_DIR.mkdir();\n+\n+    final SegmentGeneratorConfig config =\n+        SegmentTestUtils.getSegmentGenSpecWithSchemAndProjectedColumns(new File(filePath), new File(INDEX_DIR,\n+            \"segment\"), \"daysSinceEpoch\", TimeUnit.DAYS, resource, resource);\n+\n+    final SegmentIndexCreationDriver driver = new SegmentIndexCreationDriverImpl();\n+\n+    driver.init(config);\n+    driver.build();\n+\n+    System.out.println(\"built at : \" + INDEX_DIR.getAbsolutePath());\n+  }\n+\n+  @Test\n+  public void testSingleQuery() throws RecognitionException, Exception {\n+    String query = \"select count(*) from mirror where viewerId='24516187'\";\n+    LOGGER.info(\"running  : \" + query);\n+    final Map<ServerInstance, DataTable> instanceResponseMap = new HashMap<ServerInstance, DataTable>();\n+    final BrokerRequest brokerRequest = RequestConverter.fromJSON(REQUEST_COMPILER.compile(query));\n+    InstanceRequest instanceRequest = new InstanceRequest(1, brokerRequest);\n+    instanceRequest.setSearchSegments(new ArrayList<String>());\n+    instanceRequest.getSearchSegments().add(segmentName);\n+    final DataTable instanceResponse = QUERY_EXECUTOR.processQuery(instanceRequest);\n+    instanceResponseMap.clear();\n+    instanceResponseMap.put(new ServerInstance(\"localhost:0000\"), instanceResponse);\n+    final BrokerResponse brokerResponse = REDUCE_SERVICE.reduceOnDataTable(brokerRequest, instanceResponseMap);\n+    LOGGER.info(\"BrokerResponse is \" + brokerResponse.getAggregationResults().get(0));\n+  }\n+\n+  @Test\n+  public void testQueryParsingFailedQuery() throws RecognitionException, Exception {\n+    String query = \"select sudm(blablaa) from mirror where viewerId='24516187'\";\n+    LOGGER.info(\"running  : \" + query);\n+    final Map<ServerInstance, DataTable> instanceResponseMap = new HashMap<ServerInstance, DataTable>();\n+    final BrokerRequest brokerRequest = RequestConverter.fromJSON(REQUEST_COMPILER.compile(query));\n+    InstanceRequest instanceRequest = new InstanceRequest(1, brokerRequest);\n+    instanceRequest.setSearchSegments(new ArrayList<String>());\n+    instanceRequest.getSearchSegments().add(segmentName);\n+    final DataTable instanceResponse = QUERY_EXECUTOR.processQuery(instanceRequest);\n+    instanceResponseMap.clear();\n+    instanceResponseMap.put(new ServerInstance(\"localhost:0000\"), instanceResponse);\n+    final BrokerResponse brokerResponse = REDUCE_SERVICE.reduceOnDataTable(brokerRequest, instanceResponseMap);\n+    LOGGER.info(\"BrokerResponse is {}\", brokerResponse);\n+    Assert.assertTrue(brokerResponse.getExceptionsSize() > 0);\n+  }\n+\n+  @Test\n+  public void testQueryPlanFailedQuery() throws RecognitionException, Exception {\n+    String query = \"select sum(blablaa) from mirror where viewerId='24516187'\";\n+    LOGGER.info(\"running  : \" + query);\n+    final Map<ServerInstance, DataTable> instanceResponseMap = new HashMap<ServerInstance, DataTable>();\n+    final BrokerRequest brokerRequest = RequestConverter.fromJSON(REQUEST_COMPILER.compile(query));\n+    InstanceRequest instanceRequest = new InstanceRequest(1, brokerRequest);\n+    instanceRequest.setSearchSegments(new ArrayList<String>());\n+    instanceRequest.getSearchSegments().add(segmentName);\n+    final DataTable instanceResponse = QUERY_EXECUTOR.processQuery(instanceRequest);\n+    instanceResponseMap.clear();\n+    instanceResponseMap.put(new ServerInstance(\"localhost:0000\"), instanceResponse);\n+    final BrokerResponse brokerResponse = REDUCE_SERVICE.reduceOnDataTable(brokerRequest, instanceResponseMap);\n+    LOGGER.info(\"BrokerResponse is {}\", brokerResponse);\n+    Assert.assertTrue(brokerResponse.getExceptionsSize() > 0);\n+  }\n+\n+  @Test\n+  public void testQueryExecuteFailedQuery() throws RecognitionException, Exception {\n+    String query = \"select count(*) from mirror where viewerId='24516187' group by bla\";\n+    LOGGER.info(\"running  : \" + query);\n+    final Map<ServerInstance, DataTable> instanceResponseMap = new HashMap<ServerInstance, DataTable>();\n+    final BrokerRequest brokerRequest = RequestConverter.fromJSON(REQUEST_COMPILER.compile(query));\n+    InstanceRequest instanceRequest = new InstanceRequest(1, brokerRequest);\n+    instanceRequest.setSearchSegments(new ArrayList<String>());\n+    instanceRequest.getSearchSegments().add(segmentName);\n+    final DataTable instanceResponse = QUERY_EXECUTOR.processQuery(instanceRequest);\n+    instanceResponseMap.clear();\n+    instanceResponseMap.put(new ServerInstance(\"localhost:0000\"), instanceResponse);\n+    final BrokerResponse brokerResponse = REDUCE_SERVICE.reduceOnDataTable(brokerRequest, instanceResponseMap);\n+    LOGGER.info(\"BrokerResponse is {}\", brokerResponse);\n+    Assert.assertTrue(brokerResponse.getExceptionsSize() == 0);\n+  }\n+}",
                "deletions": 0
            },
            {
                "sha": "57fb3b4a6f47a5f31fdc9f6048feac5fa4007514",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/queries/TestingServerPropertiesBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/test/java/com/linkedin/pinot/queries/TestingServerPropertiesBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/b02cc238036b9cadc7c6df80a1004d61fa2349a6/pinot-core/src/test/java/com/linkedin/pinot/queries/TestingServerPropertiesBuilder.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/queries/TestingServerPropertiesBuilder.java?ref=b02cc238036b9cadc7c6df80a1004d61fa2349a6",
                "patch": "@@ -112,6 +112,8 @@ public PropertiesConfiguration build() throws IOException {\n \n     config.addProperty(StringUtil.join(\".\", PINOT_SERVER_PREFIX, EXECUTOR_PREFIX, \"pruner.class\"),\n         \"TableNameSegmentPruner\");\n+    config.addProperty(StringUtil.join(\".\", PINOT_SERVER_PREFIX, EXECUTOR_PREFIX, \"pruner.class\"),\n+        \"DataSchemaSegmentPruner\");\n     config.addProperty(StringUtil.join(\".\", PINOT_SERVER_PREFIX, EXECUTOR_PREFIX, \"class\"),\n         \"com.linkedin.pinot.core.query.executor.ServerQueryExecutor\");\n     config.addProperty(StringUtil.join(\".\", PINOT_SERVER_PREFIX, EXECUTOR_PREFIX, \"timeout\"), \"150000\");",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[TE] harden alert scheduler against incomplete/incorrect alert configs (#1918)\n\nThe current implementation does not handle unchecked exceptions. A NPE can interrupt scheduler execution and kill the thread silently, e.g. if an incomplete or incorrect alertConfig is processed.\r\n\r\nThis PR hardens the scheduler and protects the top-level run() method. Furthermore, it gracefully degrades by skipping erroneous alertConfigs rather than terminating execution.\r\n\r\nIn the long run, TE's job and task scheduling framework requires a major reliability overhaul, e.g. by porting it to Apache Helix.",
        "commit": "https://github.com/apache/incubator-pinot/commit/7955963de638a58521211c455f60f10c1b35501e",
        "parent": "https://github.com/apache/incubator-pinot/commit/c16258b77c9e8cd5628e1bd1e8e3c44053e0b5c9",
        "bug_id": "incubator-pinot_80",
        "file": [
            {
                "sha": "7b20a1e0c0030edaefe621e531c6eb4f43ce972c",
                "filename": "thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/alert/v2/AlertJobSchedulerV2.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/7955963de638a58521211c455f60f10c1b35501e/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/alert/v2/AlertJobSchedulerV2.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/7955963de638a58521211c455f60f10c1b35501e/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/alert/v2/AlertJobSchedulerV2.java",
                "status": "modified",
                "changes": 104,
                "additions": 58,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-pinot/src/main/java/com/linkedin/thirdeye/anomaly/alert/v2/AlertJobSchedulerV2.java?ref=7955963de638a58521211c455f60f10c1b35501e",
                "patch": "@@ -85,51 +85,68 @@ public void run() {\n       LOG.info(\"Scheduled jobs {}\", scheduledJobs);\n \n       for (AlertConfigDTO alertConfig : alertConfigs) {\n-        Long id = alertConfig.getId();\n-        String jobKey = getJobKey(id);\n-        boolean isActive = alertConfig.isActive();\n-        boolean isScheduled = scheduledJobs.contains(jobKey);\n-\n-        if (isActive) {\n-          if (isScheduled) {\n-            String cronInDatabase = alertConfig.getCronExpression();\n-            List<Trigger> triggers =\n-                (List<Trigger>) quartzScheduler.getTriggersOfJob(JobKey.jobKey(jobKey));\n-            CronTrigger cronTrigger = (CronTrigger) triggers.get(0);\n-            String cronInSchedule = cronTrigger.getCronExpression();\n-            // cron expression has been updated, restart this job\n-            if (!cronInDatabase.equals(cronInSchedule)) {\n-              LOG.info(\n-                  \"Cron expression for config {} with jobKey {} has been changed from {}  to {}. \"\n-                      + \"Restarting schedule\", id, jobKey, cronInSchedule, cronInDatabase);\n-              stopJob(jobKey);\n-              startJob(alertConfig, jobKey);\n-            }\n-          } else {\n-            LOG.info(\"Found active but not scheduled {}\", id);\n-            startJob(alertConfig, jobKey);\n-          }\n-        } else {\n-          if (isScheduled) {\n-            LOG.info(\"Found inactive but scheduled {}\", id);\n-            stopJob(jobKey);\n-          }\n-          // for all jobs with not isActive, and not isScheduled, no change required\n+        try {\n+          createOrUpdateAlertJob(scheduledJobs, alertConfig);\n+        } catch (Exception e) {\n+          LOG.error(\"Could not write job for alert config id {}. Skipping. {}\", alertConfig.getId(), alertConfig, e);\n         }\n       }\n \n       // for any scheduled jobs, not having a function in the database,\n       // stop the schedule, as function has been deleted\n       for (String scheduledJobKey : scheduledJobs) {\n-        Long configId = getIdFromJobKey(scheduledJobKey);\n-        AlertConfigDTO alertConfigSpec = alertConfigDAO.findById(configId);\n-        if (alertConfigSpec == null) {\n-          LOG.info(\"Found scheduled, but not in database {}\", configId);\n-          stopJob(scheduledJobKey);\n+        try {\n+          deleteAlertJob(scheduledJobKey);\n+        } catch(Exception e) {\n+          LOG.error(\"Could not delete alert job '{}'. Skipping.\", scheduledJobKey, e);\n         }\n       }\n-    } catch (SchedulerException e) {\n-      LOG.error(\"Exception in reading active jobs\", e);\n+\n+    } catch (Exception e) {\n+      LOG.error(\"Error running scheduler\", e);\n+    }\n+  }\n+\n+  private void deleteAlertJob(String scheduledJobKey) throws SchedulerException {\n+    Long configId = getIdFromJobKey(scheduledJobKey);\n+    AlertConfigDTO alertConfigSpec = alertConfigDAO.findById(configId);\n+    if (alertConfigSpec == null) {\n+      LOG.info(\"Found scheduled, but not in database {}\", configId);\n+      stopJob(scheduledJobKey);\n+    }\n+  }\n+\n+  private void createOrUpdateAlertJob(List<String> scheduledJobs, AlertConfigDTO alertConfig) throws SchedulerException {\n+    Long id = alertConfig.getId();\n+    String jobKey = getJobKey(id);\n+    boolean isActive = alertConfig.isActive();\n+    boolean isScheduled = scheduledJobs.contains(jobKey);\n+\n+    if (isActive) {\n+      if (isScheduled) {\n+        String cronInDatabase = alertConfig.getCronExpression();\n+        List<Trigger> triggers =\n+            (List<Trigger>) quartzScheduler.getTriggersOfJob(JobKey.jobKey(jobKey));\n+        CronTrigger cronTrigger = (CronTrigger) triggers.get(0);\n+        String cronInSchedule = cronTrigger.getCronExpression();\n+        // cron expression has been updated, restart this job\n+        if (!cronInDatabase.equals(cronInSchedule)) {\n+          LOG.info(\n+              \"Cron expression for config {} with jobKey {} has been changed from {}  to {}. \"\n+                  + \"Restarting schedule\", id, jobKey, cronInSchedule, cronInDatabase);\n+          stopJob(jobKey);\n+          startJob(alertConfig, jobKey);\n+        }\n+      } else {\n+        LOG.info(\"Found active but not scheduled {}\", id);\n+        startJob(alertConfig, jobKey);\n+      }\n+    } else {\n+      if (isScheduled) {\n+        LOG.info(\"Found inactive but scheduled {}\", id);\n+        stopJob(jobKey);\n+      }\n+      // for all jobs with not isActive, and not isScheduled, no change required\n     }\n   }\n \n@@ -169,28 +186,23 @@ public void stopJob(Long id) throws SchedulerException {\n     stopJob(jobKey);\n   }\n \n-  public void stopJob(String jobKey) throws SchedulerException {\n+  private void stopJob(String jobKey) throws SchedulerException {\n     if (!quartzScheduler.checkExists(JobKey.jobKey(jobKey))) {\n-      throw new IllegalStateException(\n-          \"Cannot stop alert config \" + jobKey + \", it has not been scheduled\");\n+      throw new IllegalStateException(\"Cannot stop alert config \" + jobKey + \", it has not been scheduled\");\n     }\n     quartzScheduler.deleteJob(JobKey.jobKey(jobKey));\n     LOG.info(\"Stopped alert config {}\", jobKey);\n   }\n \n-  private void scheduleJob(JobContext jobContext, AlertConfigDTO alertConfig) {\n+  private void scheduleJob(JobContext jobContext, AlertConfigDTO alertConfig) throws SchedulerException {\n     LOG.info(\"Starting {}\", jobContext.getJobName());\n     String triggerKey = String.format(\"alert_scheduler_trigger_%d\", alertConfig.getId());\n     CronTrigger trigger = TriggerBuilder.newTrigger().withIdentity(triggerKey)\n         .withSchedule(CronScheduleBuilder.cronSchedule(alertConfig.getCronExpression())).build();\n     String jobKey = jobContext.getJobName();\n     JobDetail job = JobBuilder.newJob(AlertJobRunnerV2.class).withIdentity(jobKey).build();\n     job.getJobDataMap().put(AlertJobRunnerV2.ALERT_JOB_CONTEXT_V2, jobContext);\n-    try {\n-      quartzScheduler.scheduleJob(job, trigger);\n-    } catch (SchedulerException e) {\n-      LOG.error(\"Exception while scheduling alert job\", e);\n-    }\n+    quartzScheduler.scheduleJob(job, trigger);\n     LOG.info(\"Started {}: {}\", jobKey, alertConfig);\n   }\n ",
                "deletions": 46
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[MINION] Clean up rest APIS and add API to clean up finished tasks (#1889)\n\nFixed the issue where TaskResource is not attached to the rest server\r\nAlways return result in JSON format (Added StringResultResponse class)\r\nRemoved rest APIs to create task/task queue because they should only be created by the scheduleTasks()\r\nAdded rest API to clean up finished tasks\r\nModified tests to test clean up API\r\nAlso Fixed the NPE in SimpleMinionClusterIntegrationTest by ensuring task queues show up in ZK when create them",
        "commit": "https://github.com/apache/incubator-pinot/commit/46eaed6e931fb633d415877c3430d134b4163141",
        "parent": "https://github.com/apache/incubator-pinot/commit/d44d16acce4cccf6e18da5dc20f887dadd0b0d2c",
        "bug_id": "incubator-pinot_81",
        "file": [
            {
                "sha": "daff8c01faefd26a1654cea1d1533c44789a134c",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/ControllerStarter.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -122,7 +122,6 @@ public void start() {\n       LOGGER.info(\"Starting task manager\");\n       _taskManager =\n           new PinotTaskManager(taskDriver, helixResourceManager, _helixTaskResourceManager, config, controllerMetrics);\n-      _taskManager.ensureTaskQueuesExist();\n       int taskManagerFrequencyInSeconds = config.getTaskManagerFrequencyInSeconds();\n       if (taskManagerFrequencyInSeconds > 0) {\n         LOGGER.info(\"Starting task manager with running frequency of {} seconds\", taskManagerFrequencyInSeconds);",
                "deletions": 1
            },
            {
                "sha": "ca7632dd0201ac892cd373cf117986b9b5bcda73",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTaskRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTaskRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTaskRestletResource.java",
                "status": "modified",
                "changes": 234,
                "additions": 54,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/PinotTaskRestletResource.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -16,35 +16,27 @@\n \n package com.linkedin.pinot.controller.api.resources;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.Iterator;\n-import java.util.List;\n-import java.util.Map;\n-import org.json.JSONArray;\n-import org.json.JSONObject;\n import com.linkedin.pinot.common.config.PinotTaskConfig;\n import com.linkedin.pinot.controller.helix.core.minion.PinotHelixTaskResourceManager;\n import com.linkedin.pinot.controller.helix.core.minion.PinotTaskManager;\n import io.swagger.annotations.Api;\n import io.swagger.annotations.ApiOperation;\n import io.swagger.annotations.ApiParam;\n+import java.util.Map;\n+import java.util.Set;\n import javax.inject.Inject;\n-import javax.ws.rs.Consumes;\n import javax.ws.rs.DELETE;\n import javax.ws.rs.GET;\n-import javax.ws.rs.POST;\n import javax.ws.rs.PUT;\n import javax.ws.rs.Path;\n import javax.ws.rs.PathParam;\n-import javax.ws.rs.Produces;\n import javax.ws.rs.QueryParam;\n import javax.ws.rs.WebApplicationException;\n-import javax.ws.rs.core.MediaType;\n+import org.apache.helix.task.TaskState;\n \n \n @Api(tags = Constants.TASK_TAG)\n+@Path(\"/\")\n public class PinotTaskRestletResource {\n   private static final String TASK_QUEUE_STATE_STOP = \"STOP\";\n   private static final String TASK_QUEUE_STATE_RESUME = \"RESUME\";\n@@ -55,211 +47,118 @@\n   @Inject\n   PinotTaskManager _pinotTaskManager;\n \n-  /**\n-   * URI Mappings:\n-   * <ul>\n-   *   <li>\n-   *     \"/tasks/tasktypes\":\n-   *     List all task types.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/tasks/{taskType}\":\n-   *     List all tasks for the specified task type.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/taskconfig/{taskName}\":\n-   *     Get the task config for the specified task name.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/taskstates/{taskType}\":\n-   *     Get a map from task name to task state for the specified task type.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/taskstate/{taskName}\":\n-   *     Get the task state for the specified task name.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/taskqueues\":\n-   *     List all task queues.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/taskqueuestate/{taskType}\":\n-   *     Get the task queue state for the specified task type.\n-   *   </li>\n-   * </ul>\n-   */\n-\n   @GET\n   @Path(\"/tasks/tasktypes\")\n-  @Produces(MediaType.APPLICATION_JSON)\n-  @ApiOperation(value = \"List all task types\", notes = \"List all task types\")\n-  public JSONArray listTaskTypes(\n-\n-  ) {\n-    List<String> taskTypes = new ArrayList<>(_pinotHelixTaskResourceManager.getTaskTypes());\n-    Collections.sort(taskTypes);\n-    return new JSONArray(taskTypes);\n+  @ApiOperation(\"List all task types\")\n+  public Set<String> listTaskTypes() {\n+    try {\n+      return _pinotHelixTaskResourceManager.getTaskTypes();\n+    } catch (Exception e) {\n+      throw new WebApplicationException(e);\n+    }\n   }\n \n   @GET\n-  @ApiOperation( value = \"List all tasks\", notes = \"List all tasks\")\n   @Path(\"/tasks/tasks/{taskType}\")\n-  @Produces(MediaType.APPLICATION_JSON)\n-  public JSONArray getTasks(\n-      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType\n-  ) {\n-    List<String> tasks = new ArrayList<>(_pinotHelixTaskResourceManager.getTasks(taskType));\n-    Collections.sort(tasks);\n-    return new JSONArray(tasks);\n+  @ApiOperation(\"List all tasks for the given task type\")\n+  public Set<String> getTasks(@ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType) {\n+    try {\n+      return _pinotHelixTaskResourceManager.getTasks(taskType);\n+    } catch (Exception e) {\n+      throw new WebApplicationException(e);\n+    }\n   }\n \n   @GET\n-  @ApiOperation(value = \"Get a task's configuration\")\n   @Path(\"/tasks/taskconfig/{taskName}\")\n-  @Produces(MediaType.APPLICATION_JSON)\n-  public JSONObject getTaskConfig(\n-      @ApiParam(value = \"Task name\", required = true) @PathParam(\"taskName\") String taskName\n-  ) {\n+  @ApiOperation(\"Get the task config for the given task name\")\n+  public PinotTaskConfig getTaskConfig(\n+      @ApiParam(value = \"Task name\", required = true) @PathParam(\"taskName\") String taskName) {\n     try {\n-      PinotTaskConfig taskConfig = _pinotHelixTaskResourceManager.getTaskConfig(taskName);\n-      JSONObject result = new JSONObject();\n-      result.put(\"taskType\", taskConfig.getTaskType());\n-      result.put(\"configs\", new JSONObject(taskConfig.getConfigs()));\n-      return result;\n+      return _pinotHelixTaskResourceManager.getTaskConfig(taskName);\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n   @GET\n-  @ApiOperation(value = \"Get all tasks' configuration\", notes = \"Get all tasks' configuration\")\n   @Path(\"/tasks/taskstates/{taskType}\")\n-  public JSONObject getTasksConfiguration(\n-      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType\n-  ) {\n+  @ApiOperation(\"Get a map from task name to task state for the given task type\")\n+  public Map<String, TaskState> getTaskStates(\n+      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType) {\n     try {\n-      return new JSONObject(_pinotHelixTaskResourceManager.getTaskStates(taskType));\n+      return _pinotHelixTaskResourceManager.getTaskStates(taskType);\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n   @GET\n-  @ApiOperation(value = \"Get a task's state\", notes = \"Get a task's state\")\n   @Path(\"/tasks/taskstate/{taskName}\")\n-  public String getTaskState(\n-      @ApiParam(value = \"Task name\", required = true) @PathParam(\"taskName\") String taskName\n-  ) {\n+  @ApiOperation(\"Get the task state for the given task name\")\n+  public StringResultResponse getTaskState(\n+      @ApiParam(value = \"Task name\", required = true) @PathParam(\"taskName\") String taskName) {\n     try {\n-      return _pinotHelixTaskResourceManager.getTaskState(taskName).toString();\n+      return new StringResultResponse(_pinotHelixTaskResourceManager.getTaskState(taskName).toString());\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n   @GET\n-  @ApiOperation(value = \"List all task queues\", notes = \"List all task queues\")\n   @Path(\"/tasks/taskqueues\")\n-  public JSONArray getTaskQueues(\n-\n-  ) {\n+  @ApiOperation(\"List all task queues\")\n+  public Set<String> getTaskQueues() {\n     try {\n-      List<String> taskQueues = new ArrayList<>(_pinotHelixTaskResourceManager.getTaskQueues());\n-      Collections.sort(taskQueues);\n-      return new JSONArray(taskQueues);\n+      return _pinotHelixTaskResourceManager.getTaskQueues();\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n   @GET\n-  @ApiOperation(value = \"Get a task queue's state\", notes = \"Get a task queue's state\")\n   @Path(\"/tasks/taskqueuestate/{taskType}\")\n-  public String getTaskQueueState(\n-      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType\n-  ) {\n+  @ApiOperation(\"Get the task queue state for the given task type\")\n+  public StringResultResponse getTaskQueueState(\n+      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType) {\n     try {\n-      return _pinotHelixTaskResourceManager.getTaskQueueState(taskType).toString();\n+      return new StringResultResponse(_pinotHelixTaskResourceManager.getTaskQueueState(taskType).toString());\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n-  /**\n-   * URI Mappings:\n-   * <ul>\n-   *   <li>\n-   *     \"/tasks/taskqueue/{taskType}\":\n-   *     Create a task queue for the specified task type.\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/task/{taskType}\":\n-   *     Submit a task of the specified task type to the task queue.\n-   *   </li>\n-   * </ul>\n-   */\n-  @POST\n-  @ApiOperation(value = \"Create a task queue\", notes = \"Create a task queue\")\n-  @Path(\"/tasks/taskqueue/{taskType}\")\n-  public SuccessResponse createTaskQueue(\n-      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType\n-  ) {\n+  @PUT\n+  @Path(\"/tasks/scheduletasks\")\n+  @ApiOperation(\"Schedule tasks\")\n+  public SuccessResponse scheduleTasks() {\n     try {\n-      _pinotHelixTaskResourceManager.createTaskQueue(taskType);\n-      return new SuccessResponse(\"Successfully created task queue for task type: \" + taskType);\n+      _pinotTaskManager.scheduleTasks();\n+      return new SuccessResponse(\"Successfully scheduled tasks\");\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n-  @POST\n-  @ApiOperation(value = \"Submit a task\", notes = \"Submit a task\")\n-  @Path(\"/tasks/task/{taskType}\")\n-  @Consumes(MediaType.APPLICATION_JSON)\n-  public SuccessResponse submitTask(\n-      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType,\n-      String configMapStr\n-  ) {\n+  @PUT\n+  @Path(\"/tasks/cleanuptasks/{taskType}\")\n+  @ApiOperation(\"Clean up tasks for the given task type\")\n+  public SuccessResponse cleanUpTasks(\n+      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType) {\n     try {\n-      Map<String, String> configs = new HashMap<>();\n-      PinotTaskConfig pinotTaskConfig;\n-      if (configMapStr != null) {\n-        JSONObject jsonConfig = new JSONObject(configMapStr);\n-        Iterator iterator = jsonConfig.keys();\n-        while (iterator.hasNext()) {\n-          String key = (String) iterator.next();\n-          configs.put(key, jsonConfig.getString(key));\n-        }\n-      }\n-      pinotTaskConfig = new PinotTaskConfig(taskType, configs);\n-      String taskName = _pinotHelixTaskResourceManager.submitTask(pinotTaskConfig);\n-      return new SuccessResponse(\"Successfully submitted task: \" + taskName);\n+      _pinotHelixTaskResourceManager.cleanUpTaskQueue(taskType);\n+      return new SuccessResponse(\"Successfully cleaned up tasks for task type: \" + taskType);\n     } catch (Exception e) {\n       throw new WebApplicationException(e);\n     }\n   }\n \n-  /**\n-   * URI Mappings:\n-   * <ul>\n-   *   <li>\n-   *     \"/tasks/taskqueue/{taskType}?state={state}\":\n-   *     Stop/resume a task queue based on the specified {state} (stop|resume).\n-   *   </li>\n-   *   <li>\n-   *     \"/tasks/scheduletasks\":\n-   *     Schedule tasks.\n-   *   </li>\n-   * </ul>\n-   */\n-\n   @PUT\n-  @ApiOperation(value = \"Stop/resume a task queue\", notes = \"Stop/resume a task queue\")\n   @Path(\"/tasks/taskqueue/{taskType}\")\n+  @ApiOperation(\"Stop/resume a task queue\")\n   public SuccessResponse toggleTaskQueueState(\n       @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType,\n-      @ApiParam(value = \"state\", required = true) @QueryParam(\"state\") String state\n-  ) {\n+      @ApiParam(value = \"state\", required = true) @QueryParam(\"state\") String state) {\n     try {\n       switch (state.toUpperCase()) {\n         case TASK_QUEUE_STATE_STOP:\n@@ -276,36 +175,11 @@ public SuccessResponse toggleTaskQueueState(\n     }\n   }\n \n-  @PUT\n-  @ApiOperation(value = \"Schedule tasks\", notes = \"Schedule tasks\")\n-  @Path(\"/tasks/scheduletasks\")\n-  public SuccessResponse scheduleTasks(\n-  ) {\n-    try {\n-      _pinotTaskManager.scheduleTasks();\n-      return new SuccessResponse(\"Succeeded\");\n-    } catch (Exception e) {\n-      throw new WebApplicationException(e);\n-    }\n-  }\n-\n-\n-  /**\n-   * URI Mappings:\n-   * <ul>\n-   *   <li>\n-   *     \"/tasks/taskqueue/{taskType}\":\n-   *     Delete a task queue for the specified task type.\n-   *   </li>\n-   * </ul>\n-   */\n-\n   @DELETE\n-  @ApiOperation(notes = \"Delete a task queue\", value = \"Delete a task queue\")\n   @Path(\"/tasks/taskqueue/{taskType}\")\n+  @ApiOperation(\"Delete a task queue\")\n   public SuccessResponse deleteTaskQueue(\n-      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType\n-  ) {\n+      @ApiParam(value = \"Task type\", required = true) @PathParam(\"taskType\") String taskType) {\n     try {\n       _pinotHelixTaskResourceManager.deleteTaskQueue(taskType);\n       return new SuccessResponse(\"Successfully deleted task queue for task type: \" + taskType);",
                "deletions": 180
            },
            {
                "sha": "3510b04c1b4bcd3436e7bf8bb32fcdc629b80497",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/StringResultResponse.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/StringResultResponse.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/StringResultResponse.java",
                "status": "added",
                "changes": 28,
                "additions": 28,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/StringResultResponse.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -0,0 +1,28 @@\n+/**\n+ * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linkedin.pinot.controller.api.resources;\n+\n+public final class StringResultResponse {\n+  private final String _result;\n+\n+  public StringResultResponse(String result) {\n+    _result = result;\n+  }\n+\n+  public String getResult() {\n+    return _result;\n+  }\n+}",
                "deletions": 0
            },
            {
                "sha": "6966736347019b66e284bb8e07c0e88a34259dde",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/SuccessResponse.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/SuccessResponse.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/SuccessResponse.java",
                "status": "modified",
                "changes": 22,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/resources/SuccessResponse.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -15,26 +15,14 @@\n  */\n package com.linkedin.pinot.controller.api.resources;\n \n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-import com.fasterxml.jackson.annotation.JsonProperty;\n+public final class SuccessResponse {\n+  private final String _status;\n \n-\n-public class SuccessResponse {\n-  private static final Logger LOGGER = LoggerFactory.getLogger(SuccessResponse.class);\n-  private String status;\n-\n-  public SuccessResponse(@JsonProperty(\"status\") String status) {\n-    this.status = status;\n+  public SuccessResponse(String status) {\n+    _status = status;\n   }\n \n   public String getStatus() {\n-    return status;\n+    return _status;\n   }\n-\n-  public SuccessResponse setStatus(String status) {\n-    this.status = status;\n-    return this;\n-  }\n-\n }",
                "deletions": 17
            },
            {
                "sha": "0940e803e22890a89be90cd0acfd4eaa3858e761",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotHelixTaskResourceManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotHelixTaskResourceManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotHelixTaskResourceManager.java",
                "status": "modified",
                "changes": 12,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotHelixTaskResourceManager.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -80,6 +80,18 @@ public synchronized void createTaskQueue(@Nonnull String taskType) {\n     _taskDriver.createQueue(jobQueue);\n   }\n \n+  /**\n+   * Clean up a task queue for the given task type.\n+   *\n+   * @param taskType Task type\n+   */\n+  // TODO: Seems the node under PROPERTYSTORE/TaskRebalancer is not cleaned up properly\n+  public synchronized void cleanUpTaskQueue(@Nonnull String taskType) {\n+    String helixJobQueueName = getHelixJobQueueName(taskType);\n+    LOGGER.info(\"Cleaning up task queue: {} for task type: {}\", helixJobQueueName, taskType);\n+    _taskDriver.cleanupJobQueue(helixJobQueueName);\n+  }\n+\n   /**\n    * Stop the task queue for the given task type.\n    *",
                "deletions": 0
            },
            {
                "sha": "e7b8342640e98d4034d34807aeeeb896bde6815d",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotTaskManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotTaskManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotTaskManager.java",
                "status": "modified",
                "changes": 54,
                "additions": 36,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/minion/PinotTaskManager.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -16,6 +16,7 @@\n package com.linkedin.pinot.controller.helix.core.minion;\n \n import com.google.common.base.Preconditions;\n+import com.google.common.util.concurrent.Uninterruptibles;\n import com.linkedin.pinot.common.config.PinotTaskConfig;\n import com.linkedin.pinot.common.config.TableConfig;\n import com.linkedin.pinot.common.config.TableTaskConfig;\n@@ -92,19 +93,6 @@ public void registerTaskGenerator(@Nonnull PinotTaskGenerator pinotTaskGenerator\n     _taskGeneratorRegistry.registerTaskGenerator(pinotTaskGenerator);\n   }\n \n-  /**\n-   * Ensure all registered task queues exist.\n-   * <p>Should be called after all task generators get registered.\n-   */\n-  public void ensureTaskQueuesExist() {\n-    Map<String, WorkflowConfig> helixWorkflows = _taskDriver.getWorkflows();\n-    for (String taskType : _taskGeneratorRegistry.getAllTaskTypes()) {\n-      if (!helixWorkflows.containsKey(PinotHelixTaskResourceManager.getHelixJobQueueName(taskType))) {\n-        _pinotHelixTaskResourceManager.createTaskQueue(taskType);\n-      }\n-    }\n-  }\n-\n   /**\n    * Start the task scheduler with the given running frequency.\n    *\n@@ -132,13 +120,22 @@ public void run() {\n     }, Math.min(60, runFrequencyInSeconds), runFrequencyInSeconds, TimeUnit.SECONDS);\n   }\n \n+  /**\n+   * Stop the task scheduler.\n+   */\n+  public void stopScheduler() {\n+    if (_executorService != null) {\n+      _executorService.shutdown();\n+    }\n+  }\n+\n   /**\n    * Check the Pinot cluster status and schedule new tasks.\n    */\n   public void scheduleTasks() {\n     _controllerMetrics.addMeteredGlobalValue(ControllerMeter.NUMBER_TIMES_SCHEDULE_TASKS_CALLED, 1L);\n \n-    // TODO: add JobQueue health check here\n+    ensureTaskQueuesExist();\n \n     Set<String> taskTypes = _taskGeneratorRegistry.getAllTaskTypes();\n     Map<String, List<TableConfig>> enabledTableConfigMap = new HashMap<>();\n@@ -177,11 +174,32 @@ public void scheduleTasks() {\n   }\n \n   /**\n-   * Stop the task scheduler.\n+   * Helper method to ensure all registered task queues exist.\n+   * <p>Should be called after all task generators get registered.\n    */\n-  public void stopScheduler() {\n-    if (_executorService != null) {\n-      _executorService.shutdown();\n+  private void ensureTaskQueuesExist() {\n+    Set<String> allTaskTypes = _taskGeneratorRegistry.getAllTaskTypes();\n+    Map<String, WorkflowConfig> helixWorkflows = _taskDriver.getWorkflows();\n+\n+    boolean done = true;\n+    for (String taskType : allTaskTypes) {\n+      if (!helixWorkflows.containsKey(PinotHelixTaskResourceManager.getHelixJobQueueName(taskType))) {\n+        _pinotHelixTaskResourceManager.createTaskQueue(taskType);\n+        done = false;\n+      }\n+    }\n+\n+    // Wait until all task queues show up\n+    while (!done) {\n+      Uninterruptibles.sleepUninterruptibly(100, TimeUnit.MILLISECONDS);\n+      done = true;\n+      helixWorkflows = _taskDriver.getWorkflows();\n+      for (String taskType : allTaskTypes) {\n+        if (!helixWorkflows.containsKey(PinotHelixTaskResourceManager.getHelixJobQueueName(taskType))) {\n+          done = false;\n+          break;\n+        }\n+      }\n     }\n   }\n }",
                "deletions": 18
            },
            {
                "sha": "2bcf01de9025cc8e9a90c0f0ad8a5ac2f18ddd1f",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ConvertToRawIndexMinionClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ConvertToRawIndexMinionClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ConvertToRawIndexMinionClusterIntegrationTest.java",
                "status": "modified",
                "changes": 11,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ConvertToRawIndexMinionClusterIntegrationTest.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -108,7 +108,7 @@ public void testConvertToRawIndexTask() throws Exception {\n     TestUtils.waitForCondition(new Function<Void, Boolean>() {\n       @Override\n       public Boolean apply(@Nullable Void aVoid) {\n-        return _helixTaskResourceManager.getTaskStates(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size() == 5;\n+        return _helixTaskResourceManager.getTasks(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size() == 5;\n       }\n     }, 60_000L, \"Failed to get all tasks showing up in the cluster\");\n \n@@ -118,14 +118,13 @@ public Boolean apply(@Nullable Void aVoid) {\n     TestUtils.waitForCondition(new Function<Void, Boolean>() {\n       @Override\n       public Boolean apply(@Nullable Void aVoid) {\n-        return _helixTaskResourceManager.getTaskStates(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size() == 8;\n+        return _helixTaskResourceManager.getTasks(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size() == 8;\n       }\n     }, 60_000L, \"Failed to get all tasks showing up in the cluster\");\n \n     // Should not generate more tasks\n     _taskManager.scheduleTasks();\n-    Assert.assertEquals(_helixTaskResourceManager.getTaskStates(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size(),\n-        8);\n+    Assert.assertEquals(_helixTaskResourceManager.getTasks(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size(), 8);\n \n     // Wait at most 600 seconds for all tasks COMPLETED and new segments refreshed\n     TestUtils.waitForCondition(new Function<Void, Boolean>() {\n@@ -182,6 +181,10 @@ public Boolean apply(@Nullable Void aVoid) {\n         }\n       }\n     }, 600_000L, \"Failed to get all tasks COMPLETED and new segments refreshed\");\n+\n+    // Clean up the COMPLETED tasks\n+    _helixTaskResourceManager.cleanUpTaskQueue(MinionConstants.ConvertToRawIndexTask.TASK_TYPE);\n+    Assert.assertEquals(_helixTaskResourceManager.getTasks(MinionConstants.ConvertToRawIndexTask.TASK_TYPE).size(), 0);\n   }\n \n   @Test",
                "deletions": 4
            },
            {
                "sha": "e6812c6194bf5d88b4b33afcfbf757b29538aca0",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SimpleMinionClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/46eaed6e931fb633d415877c3430d134b4163141/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SimpleMinionClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/46eaed6e931fb633d415877c3430d134b4163141/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SimpleMinionClusterIntegrationTest.java",
                "status": "modified",
                "changes": 7,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/SimpleMinionClusterIntegrationTest.java?ref=46eaed6e931fb633d415877c3430d134b4163141",
                "patch": "@@ -80,7 +80,6 @@ public void setUp() throws Exception {\n \n     // Register the test task generator into task manager\n     _pinotTaskManager.registerTaskGenerator(new TestTaskGenerator(_pinotTaskManager.getClusterInfoProvider()));\n-    _pinotTaskManager.ensureTaskQueuesExist();\n \n     Map<String, Class<? extends PinotTaskExecutor>> taskExecutorsToRegister = new HashMap<>(1);\n     taskExecutorsToRegister.put(TestTaskGenerator.TASK_TYPE, TestTaskExecutor.class);\n@@ -97,7 +96,7 @@ public void testStopAndResumeTaskQueue() throws Exception {\n     TestUtils.waitForCondition(new Function<Void, Boolean>() {\n       @Override\n       public Boolean apply(@Nullable Void aVoid) {\n-        return _pinotHelixTaskResourceManager.getTaskStates(TestTaskGenerator.TASK_TYPE).size() == 4;\n+        return _pinotHelixTaskResourceManager.getTasks(TestTaskGenerator.TASK_TYPE).size() == 4;\n       }\n     }, 60_000L, \"Failed to get all tasks showing up in the cluster\");\n \n@@ -143,6 +142,10 @@ public Boolean apply(@Nullable Void aVoid) {\n       }\n     }, 60_000L, \"Failed to get all tasks COMPLETED\");\n \n+    // Clean up the COMPLETED tasks\n+    _pinotHelixTaskResourceManager.cleanUpTaskQueue(TestTaskGenerator.TASK_TYPE);\n+    Assert.assertEquals(_pinotHelixTaskResourceManager.getTasks(TestTaskGenerator.TASK_TYPE).size(), 0);\n+\n     // Delete the task queue\n     _pinotHelixTaskResourceManager.deleteTaskQueue(TestTaskGenerator.TASK_TYPE);\n   }",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Fix the NPE for realtime segment (#1238)\n\nIn realtime consuming segment, we first add value to dictionary then update inverted index.\r\nIf we query a column with inverted index, it is possible that the inverted index has not been generated.\r\nThe fix is filter out all null inverted index.\r\nThis will not affect the accuracy of the results because we just ignore a single under-indexing record.",
        "commit": "https://github.com/apache/incubator-pinot/commit/e3157385648c210becd1cdb1ff8c0cb843680cf4",
        "parent": "https://github.com/apache/incubator-pinot/commit/8f5b4ee7a1afd20563b4db46ba3daae6a33e5673",
        "bug_id": "incubator-pinot_82",
        "file": [
            {
                "sha": "94bda7277568241d84427f12453e78e5f4e7648e",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/BitmapBasedFilterOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e3157385648c210becd1cdb1ff8c0cb843680cf4/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/BitmapBasedFilterOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e3157385648c210becd1cdb1ff8c0cb843680cf4/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/BitmapBasedFilterOperator.java",
                "status": "modified",
                "changes": 33,
                "additions": 24,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/BitmapBasedFilterOperator.java?ref=e3157385648c210becd1cdb1ff8c0cb843680cf4",
                "patch": "@@ -15,10 +15,6 @@\n  */\n package com.linkedin.pinot.core.operator.filter;\n \n-import org.roaringbitmap.buffer.ImmutableRoaringBitmap;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n import com.linkedin.pinot.core.common.Block;\n import com.linkedin.pinot.core.common.BlockId;\n import com.linkedin.pinot.core.common.DataSource;\n@@ -28,7 +24,11 @@\n import com.linkedin.pinot.core.operator.filter.predicate.PredicateEvaluator;\n import com.linkedin.pinot.core.operator.filter.predicate.PredicateEvaluatorProvider;\n import com.linkedin.pinot.core.segment.index.readers.InvertedIndexReader;\n-import com.linkedin.pinot.core.segment.index.readers.Dictionary;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.roaringbitmap.buffer.ImmutableRoaringBitmap;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n \n public class BitmapBasedFilterOperator extends BaseFilterOperator {\n@@ -86,11 +86,26 @@ public BaseFilterBlock nextFilterBlock(BlockId BlockId) {\n       default:\n         throw new UnsupportedOperationException(\"Regex is not supported\");\n     }\n-    ImmutableRoaringBitmap[] bitmaps = new ImmutableRoaringBitmap[dictionaryIds.length];\n-    for (int i = 0; i < dictionaryIds.length; i++) {\n-      bitmaps[i] = invertedIndex.getImmutable(dictionaryIds[i]);\n+\n+    // For realtime use case, it is possible that inverted index has not yet generated for the given dict id, so we\n+    // filter out null bitmaps\n+    int length = dictionaryIds.length;\n+    List<ImmutableRoaringBitmap> bitmaps = new ArrayList<>(length);\n+    for (int dictionaryId : dictionaryIds) {\n+      ImmutableRoaringBitmap bitmap = invertedIndex.getImmutable(dictionaryId);\n+      if (bitmap != null) {\n+        bitmaps.add(bitmap);\n+      }\n     }\n-    bitmapBlock = new BitmapBlock(dataSource.getOperatorName(), dataSourceBlock.getMetadata(), startDocId, endDocId, bitmaps, exclusion);\n+\n+    // Log size diff to verify the fix\n+    int numBitmaps = bitmaps.size();\n+    if (numBitmaps != length) {\n+      LOGGER.info(\"Not all inverted indexes are generated, numDictIds: {}, numBitmaps: {}\", length, numBitmaps);\n+    }\n+\n+    bitmapBlock = new BitmapBlock(dataSource.getOperatorName(), dataSourceBlock.getMetadata(), startDocId, endDocId,\n+        bitmaps.toArray(new ImmutableRoaringBitmap[numBitmaps]), exclusion);\n     return bitmapBlock;\n   }\n ",
                "deletions": 9
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-3471] Fix errors during checking of storage quota (#382)\n\nThis commit fixes following issues with checking segment quota:\r\n1. Fixed NPE if the table does not exist\r\n2. Convert configured timeout in seconds to milliseconds for reading table sizes from server",
        "commit": "https://github.com/apache/incubator-pinot/commit/61c3b43654b569d7192bb96b178c0dec0773416c",
        "parent": "https://github.com/apache/incubator-pinot/commit/97ee7c4f855d403cd9ed2e2be54f95d133fc55a9",
        "bug_id": "incubator-pinot_83",
        "file": [
            {
                "sha": "e79d2cb4a816d255b74ff83fed1e544830ff94fe",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/61c3b43654b569d7192bb96b178c0dec0773416c/pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/61c3b43654b569d7192bb96b178c0dec0773416c/pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/metadata/ZKMetadataProvider.java?ref=61c3b43654b569d7192bb96b178c0dec0773416c",
                "patch": "@@ -18,6 +18,7 @@\n import java.util.ArrayList;\n import java.util.List;\n \n+import javax.annotation.Nullable;\n import org.apache.helix.AccessOption;\n import org.apache.helix.ZNRecord;\n import org.apache.helix.store.zk.ZkHelixPropertyStore;\n@@ -122,7 +123,7 @@ public static RealtimeSegmentZKMetadata getRealtimeSegmentZKMetadata(ZkHelixProp\n     return new RealtimeSegmentZKMetadata(propertyStore.get(constructPropertyStorePathForSegment(realtimeTableName, segmentName), null, AccessOption.PERSISTENT));\n   }\n \n-  public static AbstractTableConfig getOfflineTableConfig(ZkHelixPropertyStore<ZNRecord> propertyStore, String tableName) {\n+  public static @Nullable AbstractTableConfig getOfflineTableConfig(ZkHelixPropertyStore<ZNRecord> propertyStore, String tableName) {\n     String offlineTableName = TableNameBuilder.OFFLINE_TABLE_NAME_BUILDER.forTable(tableName);\n     ZNRecord znRecord = propertyStore.get(constructPropertyStorePathForResourceConfig(offlineTableName), null, AccessOption.PERSISTENT);\n     if (znRecord == null) {",
                "deletions": 1
            },
            {
                "sha": "8354de3764dca8e227582bb14628d08739e19255",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSegmentUploadRestletResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/61c3b43654b569d7192bb96b178c0dec0773416c/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSegmentUploadRestletResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/61c3b43654b569d7192bb96b178c0dec0773416c/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSegmentUploadRestletResource.java",
                "status": "modified",
                "changes": 81,
                "additions": 46,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotSegmentUploadRestletResource.java?ref=61c3b43654b569d7192bb96b178c0dec0773416c",
                "patch": "@@ -15,37 +15,9 @@\n  */\n package com.linkedin.pinot.controller.api.restlet.resources;\n \n-import java.io.File;\n-import java.io.IOException;\n-import java.io.UnsupportedEncodingException;\n-import java.net.InetAddress;\n-import java.net.URLDecoder;\n-import java.util.Date;\n-import java.util.Iterator;\n-import java.util.List;\n-import org.apache.commons.configuration.ConfigurationException;\n-import org.apache.commons.fileupload.FileItem;\n-import org.apache.commons.fileupload.disk.DiskFileItemFactory;\n-import org.apache.commons.io.FileUtils;\n-import org.apache.helix.ZNRecord;\n-import org.apache.helix.store.zk.ZkHelixPropertyStore;\n-import org.joda.time.Interval;\n-import org.json.JSONArray;\n-import org.json.JSONException;\n-import org.restlet.data.MediaType;\n-import org.restlet.data.Status;\n-import org.restlet.ext.fileupload.RestletFileUpload;\n-import org.restlet.representation.FileRepresentation;\n-import org.restlet.representation.Representation;\n-import org.restlet.representation.StringRepresentation;\n-import org.restlet.resource.Delete;\n-import org.restlet.resource.Post;\n-import org.restlet.util.Series;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import com.alibaba.fastjson.JSONObject;\n import com.fasterxml.jackson.core.JsonProcessingException;\n-import com.linkedin.pinot.common.config.AbstractTableConfig;\n+import com.linkedin.pinot.common.config.OfflineTableConfig;\n import com.linkedin.pinot.common.config.TableNameBuilder;\n import com.linkedin.pinot.common.metadata.ZKMetadataProvider;\n import com.linkedin.pinot.common.metadata.segment.OfflineSegmentZKMetadata;\n@@ -72,7 +44,35 @@\n import com.linkedin.pinot.controller.helix.core.realtime.SegmentCompletionManager;\n import com.linkedin.pinot.controller.validation.StorageQuotaChecker;\n import com.linkedin.pinot.core.segment.index.SegmentMetadataImpl;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.UnsupportedEncodingException;\n+import java.net.InetAddress;\n+import java.net.URLDecoder;\n+import java.util.Date;\n+import java.util.Iterator;\n+import java.util.List;\n import javax.annotation.Nonnull;\n+import org.apache.commons.configuration.ConfigurationException;\n+import org.apache.commons.fileupload.FileItem;\n+import org.apache.commons.fileupload.disk.DiskFileItemFactory;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.store.zk.ZkHelixPropertyStore;\n+import org.joda.time.Interval;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.restlet.data.MediaType;\n+import org.restlet.data.Status;\n+import org.restlet.ext.fileupload.RestletFileUpload;\n+import org.restlet.representation.FileRepresentation;\n+import org.restlet.representation.Representation;\n+import org.restlet.representation.StringRepresentation;\n+import org.restlet.resource.Delete;\n+import org.restlet.resource.Post;\n+import org.restlet.util.Series;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n \n /**\n@@ -428,8 +428,19 @@ private Representation uploadSegment(File indexDir, File dataFile, String downlo\n       throws ConfigurationException, IOException, JSONException {\n     final SegmentMetadata metadata = new SegmentMetadataImpl(indexDir);\n     final File tableDir = new File(baseDataDir, metadata.getTableName());\n+    String tableName = metadata.getTableName();\n     File segmentFile = new File(tableDir, dataFile.getName());\n-    StorageQuotaChecker.QuotaCheckerResponse quotaResponse = checkStorageQuota(indexDir, metadata);\n+    OfflineTableConfig offlineTableConfig = (OfflineTableConfig) ZKMetadataProvider\n+        .getOfflineTableConfig(_pinotHelixResourceManager.getPropertyStore(), tableName);\n+\n+    if (offlineTableConfig == null) {\n+      LOGGER.info(\"Missing configuration for table: {} in helix\", metadata.getTableName());\n+      setStatus(Status.CLIENT_ERROR_NOT_FOUND);\n+      StringRepresentation repr = new StringRepresentation(\"{\\\"error\\\" : \\\"Missing table: \"  +  tableName + \"\\\"}\");\n+      repr.setMediaType(MediaType.APPLICATION_JSON);\n+      return repr;\n+    }\n+    StorageQuotaChecker.QuotaCheckerResponse quotaResponse = checkStorageQuota(indexDir, metadata, offlineTableConfig);\n     if (!quotaResponse.isSegmentWithinQuota) {\n       // this is not an \"error\" hence we don't increment segment upload errors\n       LOGGER.info(\"Rejecting segment upload for table: {}, segment: {}, reason: {}\",\n@@ -450,8 +461,9 @@ private Representation uploadSegment(File indexDir, File dataFile, String downlo\n       response = new PinotResourceManagerResponse(\"Invalid segment start/end time\", false);\n     } else {\n       if (downloadUrl == null) {\n-        downloadUrl = ControllerConf.constructDownloadUrl(metadata.getTableName(), dataFile.getName(), vip);\n+        downloadUrl = ControllerConf.constructDownloadUrl(tableName, dataFile.getName(), vip);\n       }\n+      // TODO: this will read table configuration again from ZK. We should optimize that\n       response = _pinotHelixResourceManager.addSegment(metadata, downloadUrl);\n     }\n \n@@ -571,14 +583,13 @@ private Representation deleteAllSegments(\n    *                    segmentFile must exist on disk and must be a directory\n    * @param metadata segment metadata. This should not be null\n    */\n-  private StorageQuotaChecker.QuotaCheckerResponse checkStorageQuota(@Nonnull File segmentFile, @Nonnull SegmentMetadata metadata) {\n+  private StorageQuotaChecker.QuotaCheckerResponse checkStorageQuota(@Nonnull File segmentFile, @Nonnull SegmentMetadata metadata,\n+      @Nonnull OfflineTableConfig offlineTableConfig) {\n     TableSizeReader tableSizeReader = new TableSizeReader(executor, connectionManager, _pinotHelixResourceManager);\n-    AbstractTableConfig offlineTableConfig = ZKMetadataProvider\n-        .getOfflineTableConfig(_pinotHelixResourceManager.getPropertyStore(), metadata.getTableName());\n     StorageQuotaChecker quotaChecker = new StorageQuotaChecker(offlineTableConfig, tableSizeReader);\n     String offlineTableName = TableNameBuilder.OFFLINE_TABLE_NAME_BUILDER.forTable(metadata.getTableName());\n     return quotaChecker.isSegmentStorageWithinQuota(segmentFile, offlineTableName,\n-        metadata.getName(), _controllerConf.getServerAdminRequestTimeoutSeconds());\n+        metadata.getName(), _controllerConf.getServerAdminRequestTimeoutSeconds() * 1000);\n   }\n \n }",
                "deletions": 35
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Reorder addition of pinot table views API (#835)\n\n* Reorder addition of pinot table views API\r\n\r\nMove addition of pinot tables views below the existing list.\r\nKeeping it clustered with other GET calls hides existing paths.\r\n\r\nTesting: manual\r\n\r\n* Gracefully handle missing request body on updating controller index\r\n\r\nReturn bad request error if the request to update indexing config is\r\nmissing request body instead of failing with NPE.",
        "commit": "https://github.com/apache/incubator-pinot/commit/819d29b6b4b1f546b53492dd5c0ca81b384acce4",
        "parent": "https://github.com/apache/incubator-pinot/commit/1e906370c878f60d94ac301a30ba13537b6a483e",
        "bug_id": "incubator-pinot_84",
        "file": [
            {
                "sha": "b9b5ec86de771ff65790c3418dc96de4a26a1346",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/ControllerRestApplication.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/ControllerRestApplication.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/ControllerRestApplication.java",
                "status": "modified",
                "changes": 34,
                "additions": 18,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/ControllerRestApplication.java?ref=819d29b6b4b1f546b53492dd5c0ca81b384acce4",
                "patch": "@@ -15,21 +15,6 @@\n  */\n package com.linkedin.pinot.controller.api;\n \n-import com.linkedin.pinot.controller.api.restlet.resources.TableViews;\n-import org.restlet.Context;\n-import org.restlet.Request;\n-import org.restlet.Response;\n-import org.restlet.Restlet;\n-import org.restlet.data.MediaType;\n-import org.restlet.representation.StringRepresentation;\n-import org.restlet.resource.Directory;\n-import org.restlet.resource.ServerResource;\n-import org.restlet.routing.Filter;\n-import org.restlet.routing.Redirector;\n-import org.restlet.routing.Router;\n-import org.restlet.routing.Template;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import com.linkedin.pinot.common.metrics.ControllerMetrics;\n import com.linkedin.pinot.common.restlet.PinotRestletApplication;\n import com.linkedin.pinot.common.restlet.swagger.SwaggerResource;\n@@ -52,6 +37,21 @@\n import com.linkedin.pinot.controller.api.restlet.resources.PinotVersionRestletResource;\n import com.linkedin.pinot.controller.api.restlet.resources.PqlQueryResource;\n import com.linkedin.pinot.controller.api.restlet.resources.TableSize;\n+import com.linkedin.pinot.controller.api.restlet.resources.TableViews;\n+import org.restlet.Context;\n+import org.restlet.Request;\n+import org.restlet.Response;\n+import org.restlet.Restlet;\n+import org.restlet.data.MediaType;\n+import org.restlet.representation.StringRepresentation;\n+import org.restlet.resource.Directory;\n+import org.restlet.resource.ServerResource;\n+import org.restlet.routing.Filter;\n+import org.restlet.routing.Redirector;\n+import org.restlet.routing.Router;\n+import org.restlet.routing.Template;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class ControllerRestApplication extends PinotRestletApplication {\n   private static final Logger LOGGER = LoggerFactory.getLogger(ControllerRestApplication.class);\n@@ -94,7 +94,6 @@ protected void configureRouter(Router router) {\n     attachRoutesForClass(router, PinotTableSchema.class);\n     attachRoutesForClass(router, PinotSegmentRestletResource.class);\n     attachRoutesForClass(router, TableSize.class);\n-    attachRoutesForClass(router, TableViews.class);\n     // PUT\n     attachRoutesForClass(router, PinotTableSegmentConfigs.class);\n     attachRoutesForClass(router, PinotTableIndexingConfigs.class);\n@@ -110,6 +109,9 @@ protected void configureRouter(Router router) {\n     attachRoutesForClass(router, LLCSegmentCommit.class);\n     attachRoutesForClass(router, LLCSegmentConsumed.class);\n \n+    // GET... add it here because it can block visibility of\n+    // some of the existing paths (like indexingConfigs) added above\n+    attachRoutesForClass(router, TableViews.class);\n \n     router.attach(\"/api\", SwaggerResource.class);\n ",
                "deletions": 16
            },
            {
                "sha": "4b60e41e80340cac13582ae4d6070267e7e15dd0",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableIndexingConfigs.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableIndexingConfigs.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableIndexingConfigs.java",
                "status": "modified",
                "changes": 5,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/PinotTableIndexingConfigs.java?ref=819d29b6b4b1f546b53492dd5c0ca81b384acce4",
                "patch": "@@ -48,7 +48,10 @@ public Representation put(Representation entity) {\n       setStatus(Status.CLIENT_ERROR_BAD_REQUEST);\n       return new StringRepresentation(error);\n     }\n-\n+    if (entity == null) {\n+      setStatus(Status.CLIENT_ERROR_BAD_REQUEST);\n+      return new StringRepresentation(\"{\\\"error\\\" : \\\"Request body is required\\\"}\");\n+    }\n     try {\n       return updateIndexingConfig(tableName, entity);\n     } catch (final Exception e) {",
                "deletions": 1
            },
            {
                "sha": "f791ffa486a589e93bcd0a38e56d6115015b075d",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/TableViews.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/TableViews.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/TableViews.java",
                "status": "modified",
                "changes": 49,
                "additions": 36,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/api/restlet/resources/TableViews.java?ref=819d29b6b4b1f546b53492dd5c0ca81b384acce4",
                "patch": "@@ -42,12 +42,25 @@\n \n public class TableViews extends BasePinotControllerRestletResource {\n   private static final Logger LOGGER = LoggerFactory.getLogger(TableViews.class);\n+  public static final String IDEALSTATE = \"idealstate\";\n+  public static final String EXTERNALVIEW = \"externalview\";\n \n   @Get\n   @Override\n   public Representation get() {\n     final String tableName = (String) getRequest().getAttributes().get(\"tableName\");\n-    final String view = (String) getRequest().getAttributes().get(\"view\");\n+    final int viewPositon = 3;\n+\n+    String[] path = getReference().getPath().split(\"/\");\n+    // first part is \"\" because paths start with /\n+    if (path.length < (viewPositon + 1) ||\n+        (!path[viewPositon].equalsIgnoreCase(EXTERNALVIEW) && !path[viewPositon].equalsIgnoreCase(IDEALSTATE))) {\n+      // this is unexpected condition\n+      LOGGER.error(\"Invalid path: {} while reading views\", path);\n+      return responseRepresentation(Status.SERVER_ERROR_INTERNAL, \"{\\\"error\\\":\\\"Invalid reqeust path\\\"\");\n+    }\n+\n+    final String view = path[viewPositon];\n     String tableTypeStr = getQuery().getValues(\"tableType\");\n \n     if (tableTypeStr == null) {\n@@ -83,21 +96,14 @@ public Representation get() {\n \n   // we use name \"view\" to closely match underlying names and to not\n   // confuse with table state of enable/disable\n-  @HttpVerb(\"get\")\n-  @Summary(\"Get table idealstate or external view\")\n-  @Tags({\"table\"})\n-  @Paths({\"/tables/{tableName}/{view}\"})\n   private Representation getTableState(\n-      @Parameter(name = \"tableName\", in = \"path\", description = \"Table name(without type)\", required = true)\n       String tableName,\n-      @Parameter(name=\"view\", in = \"path\", description = \"Table idealstate or external view\", required = true)\n       String view,\n-      @Parameter(name = \"tableType\", in=\"query\", description = \"Table type\", required = false)\n       TableType tableType) {\n     TableView tableView;\n-    if (view.equalsIgnoreCase(\"idealstate\")) {\n+    if (view.equalsIgnoreCase(IDEALSTATE)) {\n       tableView = getTableIdealState(tableName, tableType);\n-    } else if (view.equalsIgnoreCase(\"externalview\")) {\n+    } else if (view.equalsIgnoreCase(EXTERNALVIEW)) {\n       tableView = getTableExternalView(tableName, tableType);\n     } else {\n       return responseRepresentation(Status.CLIENT_ERROR_BAD_REQUEST,\n@@ -119,7 +125,15 @@ private Representation getTableState(\n     }\n   }\n \n-  private TableView getTableExternalView(@Nonnull String tableNameOptType, @Nullable TableType tableType) {\n+  @HttpVerb(\"get\")\n+  @Summary(\"Get table external view\")\n+  @Tags({\"table\"})\n+  @Paths({\"/tables/{tableName}/externalview\"})\n+  private TableView getTableExternalView(\n+      @Parameter(name = \"tableName\", in = \"path\", description = \"Table name(without type)\", required = true)\n+      @Nonnull String tableNameOptType,\n+      @Parameter(name = \"tableType\", in=\"query\", description = \"Table type\", required = false)\n+      @Nullable TableType tableType) {\n     TableView tableView = new TableView();\n     if (tableType == null || tableType == TableType.OFFLINE) {\n       tableView.offline = getExternalView(tableNameOptType, TableType.OFFLINE);\n@@ -130,7 +144,15 @@ private TableView getTableExternalView(@Nonnull String tableNameOptType, @Nullab\n     return tableView;\n   }\n \n-  private TableView getTableIdealState(String tableNameOptType, TableType tableType) {\n+  @HttpVerb(\"get\")\n+  @Summary(\"Get table idealstate\")\n+  @Tags({\"table\"})\n+  @Paths({\"/tables/{tableName}/idealstate\"})\n+  private TableView getTableIdealState(\n+      @Parameter(name = \"tableName\", in = \"path\", description = \"Table name(without type)\", required = true)\n+      String tableNameOptType,\n+      @Parameter(name = \"tableType\", in=\"query\", description = \"Table type\", required = false)\n+      TableType tableType) {\n     TableView tableView = new TableView();\n     if (tableType == null || tableType == TableType.OFFLINE) {\n       tableView.offline = getIdealState(tableNameOptType, TableType.OFFLINE);\n@@ -142,7 +164,8 @@ private TableView getTableIdealState(String tableNameOptType, TableType tableTyp\n   }\n \n   public @Nullable\n-  Map<String, Map<String, String>> getIdealState(@Nonnull String tableNameOptType, @Nullable TableType tableType) {\n+  Map<String, Map<String, String>> getIdealState(@Nonnull String tableNameOptType,\n+      @Parameter(name = \"tableType\", in=\"query\", description = \"Table type\", required = false)@Nullable TableType tableType) {\n     String tableName = getTableName(tableNameOptType, tableType);\n     IdealState resourceIdealState = _pinotHelixResourceManager.getHelixAdmin()\n         .getResourceIdealState(_pinotHelixResourceManager.getHelixClusterName(), tableName);",
                "deletions": 13
            },
            {
                "sha": "cf606dbb90e686ca9bb9093a2cb9cc43a40e4992",
                "filename": "pinot-controller/src/test/java/com/linkedin/pinot/controller/api/restlet/resources/TableViewsTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/test/java/com/linkedin/pinot/controller/api/restlet/resources/TableViewsTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/819d29b6b4b1f546b53492dd5c0ca81b384acce4/pinot-controller/src/test/java/com/linkedin/pinot/controller/api/restlet/resources/TableViewsTest.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/test/java/com/linkedin/pinot/controller/api/restlet/resources/TableViewsTest.java?ref=819d29b6b4b1f546b53492dd5c0ca81b384acce4",
                "patch": "@@ -111,8 +111,8 @@ public void teardownTest()\n   @DataProvider(name = \"stateProvider\")\n   public Object[][] stateProvider() {\n     Object[][] configs = {\n-        { \"idealstate\"},\n-        { \"externalview\"}\n+        {TableViews.IDEALSTATE},\n+        {TableViews.EXTERNALVIEW}\n     };\n     return configs;\n   }",
                "deletions": 2
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Remove the log statement from Or operator close() operation\n\nBlocks are not guaranteed to be initialized at the time of close\noperation. So, these log statements cause NPE. Removing because\nlogging profiling information isn't ideal.\n\nRB=620288\nG=pinot-dev-reviewers\nR=kgopalak,jfim,ssubrama,mshrivas\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/4d527b24d99610290e3487b0319a24836ec2dfc2",
        "parent": "https://github.com/apache/incubator-pinot/commit/5edaaa0c809a2c4012693997a139772b7659be37",
        "bug_id": "incubator-pinot_85",
        "file": [
            {
                "sha": "51e9abe62c42d6e6b57c55fe69b33b31f49a6c2f",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/OrOperator.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/4d527b24d99610290e3487b0319a24836ec2dfc2/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/OrOperator.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/4d527b24d99610290e3487b0319a24836ec2dfc2/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/OrOperator.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/operator/filter/OrOperator.java?ref=4d527b24d99610290e3487b0319a24836ec2dfc2",
                "patch": "@@ -64,7 +64,6 @@ public boolean close() {\n     for (Operator operator : operators) {\n       operator.close();\n     }\n-    LOGGER.info(\"Time spent in OrOperator operator:{} is {}\", this, orBlock.orBlockDocIdSet.timeMeasure);\n     return true;\n   }\n }",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT 2095] Use valid time retention values in integration tests\n\nIntegration tests passed bogus values for retention time unit causing\nNPE. Refactored the code to use valid and consistent values for time\nretention units\n\nRB=576002\nG=pinot-dev-reviewers\nR=kgopalak,jfim,ssubrama,dpatel,mshrivas\nA=ssubrama",
        "commit": "https://github.com/apache/incubator-pinot/commit/d5205cd7ade0c5223c5d6dbbffde5f51f13a056d",
        "parent": "https://github.com/apache/incubator-pinot/commit/151c4b32b3ea476a5f308cc1b1dd823ac70e9281",
        "bug_id": "incubator-pinot_86",
        "file": [
            {
                "sha": "9c421fba6b840ad02497846b5763a58d4dedef2a",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d5205cd7ade0c5223c5d6dbbffde5f51f13a056d/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d5205cd7ade0c5223c5d6dbbffde5f51f13a056d/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java",
                "status": "modified",
                "changes": 17,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/ClusterTest.java?ref=d5205cd7ade0c5223c5d6dbbffde5f51f13a056d",
                "patch": "@@ -169,8 +169,9 @@ public GenericRow decode(byte[] payload) {\n     }\n   }\n \n-  protected void addRealtimeTable(String tableName, String timeColumnName, String timeColumnType, String kafkaZkUrl,\n-      String kafkaTopic, String schemaName, String serverTenant, String brokerTenant, File avroFile) throws Exception {\n+  protected void addRealtimeTable(String tableName, String timeColumnName, String timeColumnType,\n+      int retentionDays, String retentionTimeUnit, String kafkaZkUrl, String kafkaTopic,\n+      String schemaName, String serverTenant, String brokerTenant, File avroFile) throws Exception {\n     JSONObject metadata = new JSONObject();\n     metadata.put(\"streamType\", \"kafka\");\n     metadata.put(DataSource.STREAM_PREFIX + \".\" + Kafka.CONSUMER_TYPE, Kafka.ConsumerType.highLevel.toString());\n@@ -183,7 +184,8 @@ protected void addRealtimeTable(String tableName, String timeColumnName, String\n     JSONObject request =\n         ControllerRequestBuilder\n             .buildCreateRealtimeTableJSON(tableName, serverTenant, brokerTenant, timeColumnName, timeColumnType,\n-                \"rententionTimeUnit\", \"900\", 1, \"BalanceNumSegmentAssignmentStrategy\", metadata, schemaName);\n+                retentionTimeUnit, Integer.toString(retentionDays),\n+                1, \"BalanceNumSegmentAssignmentStrategy\", metadata, schemaName);\n     sendPostRequest(ControllerRequestURLBuilder.baseUrl(CONTROLLER_BASE_API_URL).forTableCreate(), request.toString());\n \n     AvroFileSchemaKafkaAvroMessageDecoder.avroFile = avroFile;\n@@ -192,8 +194,11 @@ protected void addRealtimeTable(String tableName, String timeColumnName, String\n \n   protected void addHybridTable(String tableName, String timeColumnName, String timeColumnType, String kafkaZkUrl,\n       String kafkaTopic, String schemaName, String serverTenant, String brokerTenant, File avroFile) throws Exception {\n-    addRealtimeTable(tableName, timeColumnName, timeColumnType, kafkaZkUrl, kafkaTopic, schemaName, serverTenant,\n-        brokerTenant, avroFile);\n-    addOfflineTable(tableName, timeColumnName, timeColumnType, 900, \"Days\", brokerTenant, serverTenant);\n+    int retentionDays = 900;\n+    String retentionTimeUnit = \"Days\";\n+    addRealtimeTable(tableName, timeColumnName, timeColumnType,\n+        retentionDays, retentionTimeUnit, kafkaZkUrl, kafkaTopic,\n+        schemaName, serverTenant, brokerTenant, avroFile);\n+    addOfflineTable(tableName, timeColumnName, timeColumnType, retentionDays, retentionTimeUnit, brokerTenant, serverTenant);\n   }\n }",
                "deletions": 6
            },
            {
                "sha": "881a0207902a534ab3019b8827ddc20c876a6f34",
                "filename": "pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/d5205cd7ade0c5223c5d6dbbffde5f51f13a056d/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/d5205cd7ade0c5223c5d6dbbffde5f51f13a056d/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-integration-tests/src/test/java/com/linkedin/pinot/integration/tests/RealtimeClusterIntegrationTest.java?ref=d5205cd7ade0c5223c5d6dbbffde5f51f13a056d",
                "patch": "@@ -61,7 +61,7 @@ protected void setUpTable(String tableName, String timeColumnName, String timeCo\n       String kafkaTopic, File schemaFile, File avroFile) throws Exception {\n     Schema schema = Schema.fromFile(schemaFile);\n     addSchema(schemaFile, schema.getSchemaName());\n-    addRealtimeTable(tableName, timeColumnName, timeColumnType, kafkaZkUrl, kafkaTopic, schema.getSchemaName(),\n+    addRealtimeTable(tableName, timeColumnName, timeColumnType, 900, \"Days\", kafkaZkUrl, kafkaTopic, schema.getSchemaName(),\n         null, null, avroFile);\n   }\n ",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT 2095] Make TimeRetentionStrategy constructors consistent\n\nTimeRetentionsStrategy could throw NPE for bad time unit values.\nThe behavior of the constructors and rest of the code was also\ninconsistent in handling errors and negative values. This commit\nfixes it.\n\nRB=575997\nG=pinot-dev-reviewers\nR=kgopalak,jfim,ssubrama,dpatel,mshrivas\nA=ssubrama",
        "commit": "https://github.com/apache/incubator-pinot/commit/151c4b32b3ea476a5f308cc1b1dd823ac70e9281",
        "parent": "https://github.com/apache/incubator-pinot/commit/29b2d19e511c8a264d6688eaedd6fbb57c99506e",
        "bug_id": "incubator-pinot_87",
        "file": [
            {
                "sha": "dfaa7300a1bca24229e17ef6086fe3c40f194c8a",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/time/TimeUtils.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/151c4b32b3ea476a5f308cc1b1dd823ac70e9281/pinot-common/src/main/java/com/linkedin/pinot/common/utils/time/TimeUtils.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/151c4b32b3ea476a5f308cc1b1dd823ac70e9281/pinot-common/src/main/java/com/linkedin/pinot/common/utils/time/TimeUtils.java",
                "status": "modified",
                "changes": 9,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/time/TimeUtils.java?ref=151c4b32b3ea476a5f308cc1b1dd823ac70e9281",
                "patch": "@@ -29,9 +29,16 @@\n     }\n   }\n \n+  /**\n+   * Converts timeValue in timeUnitString to milliseconds\n+   * @param timeUnitString the time unit string to convert, such as DAYS or SECONDS\n+   * @param timeValue the time value to convert to milliseconds\n+   * @return corresponding value in milliseconds or LONG.MIN_VALUE if timeUnitString is invalid\n+   *         Returning LONG.MIN_VALUE gives consistent beahvior with the java library\n+   */\n   public static long toMillis(String timeUnitString, String timeValue) {\n     TimeUnit timeUnit = timeUnitFromString(timeUnitString);\n-    return timeUnit.toMillis(Long.parseLong(timeValue));\n+    return (timeUnit == null) ? Long.MIN_VALUE : timeUnit.toMillis(Long.parseLong(timeValue));\n   }\n \n   /**",
                "deletions": 1
            },
            {
                "sha": "add13c6bf01906b48f0ff6e679d9062423119a82",
                "filename": "pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/strategy/TimeRetentionStrategy.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/151c4b32b3ea476a5f308cc1b1dd823ac70e9281/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/strategy/TimeRetentionStrategy.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/151c4b32b3ea476a5f308cc1b1dd823ac70e9281/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/strategy/TimeRetentionStrategy.java",
                "status": "modified",
                "changes": 12,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-controller/src/main/java/com/linkedin/pinot/controller/helix/core/retention/strategy/TimeRetentionStrategy.java?ref=151c4b32b3ea476a5f308cc1b1dd823ac70e9281",
                "patch": "@@ -37,14 +37,12 @@\n   private Duration _retentionDuration;\n \n   public TimeRetentionStrategy(String timeUnit, String timeValue) throws Exception {\n-    try {\n-      _retentionDuration = new Duration(TimeUtils.toMillis(timeUnit, timeValue));\n-      if (_retentionDuration.getMillis() <= 0) {\n-        throw new RuntimeException(\"No retention value set.\");\n-      }\n-    } catch (Exception e) {\n+    long retentionMillis = TimeUtils.toMillis(timeUnit, timeValue);\n+    if (retentionMillis == Long.MIN_VALUE) {\n+      LOGGER.error(\"Failed to set retention duration, timeUnit: {}, timeValue: {}\", timeUnit, timeValue);\n       _retentionDuration = null;\n-      throw e;\n+    } else {\n+      _retentionDuration = new Duration(TimeUtils.toMillis(timeUnit, timeValue));\n     }\n   }\n ",
                "deletions": 7
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Minor code cleanups: Removed some System.out.println calls, fixed a variable name, removed a hardcoded class name, logged an error properly and rethrew the exception instead of NPE'ing on the next line\n\nRB=424253\nR=kgopalak,xiafu,jfim,dpatel\nA=dpatel",
        "commit": "https://github.com/apache/incubator-pinot/commit/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1",
        "parent": "https://github.com/apache/incubator-pinot/commit/6a0f57fadc881815d9b3a81d1cbc3186390d7179",
        "bug_id": "incubator-pinot_88",
        "file": [
            {
                "sha": "1b6e8506970933c787be4ab428f587f36a5ce51a",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/BrokerServerBuilder.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/BrokerServerBuilder.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/BrokerServerBuilder.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/BrokerServerBuilder.java?ref=966f1ba84a385f4a9eb811ef6a917c9a6aa485c1",
                "patch": "@@ -163,7 +163,7 @@ public void buildHTTP() {\n     context.addServlet(PinotClientRequestServlet.class, \"/query\");\n \n     if (clientConfig.enableConsole()) {\n-      System.out.println(clientConfig.getConsoleWebappPath());\n+      LOGGER.info(\"Console webapp path: \" + clientConfig.getConsoleWebappPath());\n       context.setResourceBase(clientConfig.getConsoleWebappPath());\n     } else {\n       context.setResourceBase(\"\");",
                "deletions": 1
            },
            {
                "sha": "a78ab81c51d2563f5212e29b0e5b52dcb5684a84",
                "filename": "pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/BrokerResourceOnlineOfflineStateModelFactory.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/BrokerResourceOnlineOfflineStateModelFactory.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/BrokerResourceOnlineOfflineStateModelFactory.java",
                "status": "modified",
                "changes": 4,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-broker/src/main/java/com/linkedin/pinot/broker/broker/helix/BrokerResourceOnlineOfflineStateModelFactory.java?ref=966f1ba84a385f4a9eb811ef6a917c9a6aa485c1",
                "patch": "@@ -49,7 +49,6 @@ public StateModel createNewStateModel(String resourceName) {\n     @Transition(from = \"OFFLINE\", to = \"ONLINE\")\n     public void onBecomeOnlineFromOffline(Message message, NotificationContext context) {\n       try {\n-        System.out.println(\"BrokerResourceOnlineOfflineStateModel.onBecomeOnlineFromOffline() : \" + message);\n         LOGGER.info(\"BrokerResourceOnlineOfflineStateModel.onBecomeOnlineFromOffline() : \" + message);\n         String resourceName = message.getPartitionName();\n         _helixExternalViewBasedRouting.markDataResourceOnline(\n@@ -64,7 +63,6 @@ public void onBecomeOnlineFromOffline(Message message, NotificationContext conte\n     @Transition(from = \"ONLINE\", to = \"OFFLINE\")\n     public void onBecomeOfflineFromOnline(Message message, NotificationContext context) {\n       try {\n-        System.out.println(\"BrokerResourceOnlineOfflineStateModel.onBecomeOfflineFromOnline() : \" + message);\n         LOGGER.info(\"BrokerResourceOnlineOfflineStateModel.onBecomeOfflineFromOnline() : \" + message);\n         String resourceName = message.getResourceName();\n         _helixExternalViewBasedRouting.markDataResourceOffline(resourceName);\n@@ -76,7 +74,6 @@ public void onBecomeOfflineFromOnline(Message message, NotificationContext conte\n     @Transition(from = \"OFFLINE\", to = \"DROPPED\")\n     public void onBecomeDroppedFromOffline(Message message, NotificationContext context) {\n       try {\n-        System.out.println(\"BrokerResourceOnlineOfflineStateModel.onBecomeDroppedFromOffline() : \" + message);\n         LOGGER.info(\"BrokerResourceOnlineOfflineStateModel.onBecomeDroppedFromOffline() : \" + message);\n         String resourceName = message.getResourceName();\n         _helixExternalViewBasedRouting.markDataResourceOffline(resourceName);\n@@ -88,7 +85,6 @@ public void onBecomeDroppedFromOffline(Message message, NotificationContext cont\n     @Transition(from = \"ONLINE\", to = \"DROPPED\")\n     public void onBecomeDroppedFromOnline(Message message, NotificationContext context) {\n       try {\n-        System.out.println(\"BrokerResourceOnlineOfflineStateModel.onBecomeDroppedFromOnline() : \" + message);\n         LOGGER.info(\"BrokerResourceOnlineOfflineStateModel.onBecomeDroppedFromOnline() : \" + message);\n         String resourceName = message.getResourceName();\n         _helixExternalViewBasedRouting.markDataResourceOffline(resourceName);",
                "deletions": 4
            },
            {
                "sha": "b5437772d7091a443fcc983f9036bf86669505a7",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/metrics/MetricsHelper.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/MetricsHelper.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/MetricsHelper.java",
                "status": "modified",
                "changes": 14,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/metrics/MetricsHelper.java?ref=966f1ba84a385f4a9eb811ef6a917c9a6aa485c1",
                "patch": "@@ -1,6 +1,5 @@\n package com.linkedin.pinot.common.metrics;\n \n-import com.google.common.base.Splitter;\n import com.yammer.metrics.core.Timer;\n import java.lang.reflect.Constructor;\n import java.util.Map;\n@@ -41,8 +40,7 @@ public static void initializeMetrics(Configuration configuration) {\n       String[] listenerClassNames = configuration.getStringArray(\"metricsRegistryRegistrationListeners\");\n \n       if (listenerClassNames.length < 1) {\n-        listenerClassNames = new String[] {\n-            \"com.linkedin.pinot.common.metrics.JmxReporterMetricsRegistryRegistrationListener\" };\n+        listenerClassNames = new String[] { JmxReporterMetricsRegistryRegistrationListener.class.getName() };\n       }\n \n       // Build each listener using their default constructor and add them\n@@ -294,18 +292,18 @@ public static TimerContext startTimer() {\n    *\n    */\n   public static class TimerContext {\n-    private final long _startTimeMs;\n-    private long _stopTimeMs;\n+    private final long _startTimeNanos;\n+    private long _stopTimeNanos;\n     private boolean _isDone;\n \n     public TimerContext() {\n-      _startTimeMs = System.nanoTime();\n+      _startTimeNanos = System.nanoTime();\n       _isDone = false;\n     }\n \n     public void stop() {\n       _isDone = true;\n-      _stopTimeMs = System.nanoTime();\n+      _stopTimeNanos = System.nanoTime();\n     }\n \n     /**\n@@ -316,7 +314,7 @@ public long getLatencyMs() {\n       if (!_isDone) {\n         stop();\n       }\n-      return (_stopTimeMs - _startTimeMs) / 1000000L;\n+      return (_stopTimeNanos - _startTimeNanos) / 1000000L;\n     }\n   }\n }",
                "deletions": 8
            },
            {
                "sha": "a9e110b19f0b1cfa7250776ddc6567d78235d5e4",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/InstanceDataManager.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/InstanceDataManager.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/966f1ba84a385f4a9eb811ef6a917c9a6aa485c1/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/InstanceDataManager.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/data/manager/InstanceDataManager.java?ref=966f1ba84a385f4a9eb811ef6a917c9a6aa485c1",
                "patch": "@@ -59,7 +59,8 @@ public synchronized void init(Configuration dataManagerConfig) {\n       _instanceDataManagerConfig = new InstanceDataManagerConfig(dataManagerConfig);\n     } catch (Exception e) {\n       _instanceDataManagerConfig = null;\n-      e.printStackTrace();\n+      LOGGER.error(\"Error during InstanceDataManager initialization\", e);\n+      throw new RuntimeException(e);\n     }\n     for (String resourceName : _instanceDataManagerConfig.getResourceNames()) {\n       ResourceDataManagerConfig resourceDataManagerConfig =",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "[PINOT-2262] Set mmap handles to null after the file is unmapped.\n\nThis moves us one step easier to debug the issue. We will get an NPE instead of\na JVM crash (which is what is happening now)\n\nFix usages of CustomBitSet to close it, and remove the finalize method from it.\nThe finalize method was used only in tests\n\nRB=596782\nBUG=PINOT-2262\nG=pinot-dev-reviewers\nR=kgopalak,jfim\nA=kgopalak,jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/69b2e7b0483dd697014d381dcc99a3fdb78282c9",
        "parent": "https://github.com/apache/incubator-pinot/commit/2cb57cea1d7292dd09a31e361120edc0db7c9c47",
        "bug_id": "incubator-pinot_89",
        "file": [
            {
                "sha": "3367939e188bcfe3413b35eaaa703733951ad7de",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitSkipListSCMVReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitSkipListSCMVReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitSkipListSCMVReader.java",
                "status": "modified",
                "changes": 7,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitSkipListSCMVReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -155,8 +155,15 @@ public int getRowsPerChunk() {\n   @Override\n   public void close() throws IOException {\n     MmapUtils.unloadByteBuffer(chunkOffsetsBuffer);\n+    chunkOffsetsBuffer = null;\n     MmapUtils.unloadByteBuffer(bitsetBuffer);\n+    bitsetBuffer = null;\n     MmapUtils.unloadByteBuffer(rawDataBuffer);\n+    rawDataBuffer = null;\n+    customBitSet.close();\n+    customBitSet = null;\n+    rawDataReader.close();\n+    rawDataReader = null;\n \n     if (isMmap) {\n       raf.close();",
                "deletions": 0
            },
            {
                "sha": "dc631f862d853ea0938e89468ef6adddadac4c19",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitWidthRowColDataFileReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitWidthRowColDataFileReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitWidthRowColDataFileReader.java",
                "status": "modified",
                "changes": 12,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedBitWidthRowColDataFileReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -15,20 +15,17 @@\n  */\n package com.linkedin.pinot.core.index.reader.impl;\n \n-import com.google.common.primitives.Ints;\n+import com.linkedin.pinot.common.utils.MmapUtils;\n+import com.linkedin.pinot.core.util.CustomBitSet;\n import java.io.File;\n import java.io.IOException;\n import java.io.RandomAccessFile;\n import java.nio.ByteBuffer;\n import java.nio.channels.FileChannel;\n import java.util.Arrays;\n-\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.linkedin.pinot.common.utils.MmapUtils;\n-import com.linkedin.pinot.core.util.CustomBitSet;\n-\n \n /**\n  *\n@@ -61,7 +58,7 @@\n    * contain negative numbers\n    */\n   private int[] offsets;\n-  private final CustomBitSet customBitSet;\n+  private CustomBitSet customBitSet;\n \n   private int totalSizeInBytes;\n   private boolean isMmap;\n@@ -286,6 +283,9 @@ public int getNumberOfCols() {\n   public void close() throws IOException {\n     if (ownsByteBuffer) {\n       MmapUtils.unloadByteBuffer(byteBuffer);\n+      byteBuffer = null;\n+      customBitSet.close();\n+      customBitSet = null;\n \n       if (isMmap) {\n         file.close();",
                "deletions": 6
            },
            {
                "sha": "1eb4e73c6a7de3c5f6babd4824ee5702f4c9cee2",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteSkipListSCMVReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteSkipListSCMVReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteSkipListSCMVReader.java",
                "status": "modified",
                "changes": 17,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteSkipListSCMVReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -15,18 +15,16 @@\n  */\n package com.linkedin.pinot.core.index.reader.impl;\n \n-import com.google.common.primitives.Ints;\n+import com.linkedin.pinot.common.utils.MmapUtils;\n+import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n+import com.linkedin.pinot.core.index.reader.SingleColumnMultiValueReader;\n+import com.linkedin.pinot.core.util.CustomBitSet;\n import java.io.File;\n import java.io.IOException;\n import java.io.RandomAccessFile;\n import java.nio.ByteBuffer;\n import java.nio.channels.FileChannel;\n \n-import com.linkedin.pinot.common.utils.MmapUtils;\n-import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n-import com.linkedin.pinot.core.index.reader.SingleColumnMultiValueReader;\n-import com.linkedin.pinot.core.util.CustomBitSet;\n-\n \n /**\n  * Storage Layout\n@@ -166,8 +164,15 @@ private int computeStartOffset(int row) {\n \n   public void close() throws IOException {\n     MmapUtils.unloadByteBuffer(chunkOffsetsBuffer);\n+    chunkOffsetsBuffer = null;\n     MmapUtils.unloadByteBuffer(bitsetBuffer);\n+    bitsetBuffer = null;\n     MmapUtils.unloadByteBuffer(rawDataBuffer);\n+    rawDataBuffer = null;\n+    customBitSet.close();\n+    customBitSet = null;\n+    rawDataReader.close();\n+    rawDataReader = null;\n \n     if (isMmap) {\n       raf.close();",
                "deletions": 6
            },
            {
                "sha": "321d1ec23dec093537487c1770e8c55f18a9e29d",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthRowColDataFileReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthRowColDataFileReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthRowColDataFileReader.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthRowColDataFileReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -272,6 +272,7 @@ public int getNumberOfCols() {\n \n   public void close() throws IOException {\n     MmapUtils.unloadByteBuffer(byteBuffer);\n+    byteBuffer = null;\n \n     if (isMMap) {\n       file.close();",
                "deletions": 0
            },
            {
                "sha": "f238d23770f784185173ceacc6e56cc71f45dd6d",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthSingleColumnMultiValueReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthSingleColumnMultiValueReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthSingleColumnMultiValueReader.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/reader/impl/FixedByteWidthSingleColumnMultiValueReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -131,7 +131,13 @@ public DataFileMetadata getMetadata() {\n   @Override\n   public void close() throws IOException {\n     MmapUtils.unloadByteBuffer(headerSectionByteBuffer);\n+    headerSectionByteBuffer = null;\n     MmapUtils.unloadByteBuffer(dataSectionByteBuffer);\n+    dataSectionByteBuffer = null;\n+    headerSectionReader.close();\n+    headerSectionReader = null;\n+    dataSectionReader.close();\n+    dataSectionReader = null;\n \n     if (isMMap) {\n       raf.close();",
                "deletions": 0
            },
            {
                "sha": "d222ff254d8cee052a09463ded76e9ba4108878e",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnMultiValueReaderWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnMultiValueReaderWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnMultiValueReaderWriter.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnMultiValueReaderWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -156,7 +156,9 @@ public void close() {\n     for (ByteBuffer dataBuffer : dataBuffers) {\n       MmapUtils.unloadByteBuffer(dataBuffer);\n     }\n+    dataBuffers.clear();\n     MmapUtils.unloadByteBuffer(headerBuffer);\n+    headerBuffer = null;\n   }\n \n   private int updateHeader(int row, int length) {",
                "deletions": 0
            },
            {
                "sha": "b10045f3c2e771b8f511fc14d27c93ff7c33bb91",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnSingleValueReaderWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnSingleValueReaderWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnSingleValueReaderWriter.java",
                "status": "modified",
                "changes": 12,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/readerwriter/impl/FixedByteSingleColumnSingleValueReaderWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -16,17 +16,14 @@\n package com.linkedin.pinot.core.index.readerwriter.impl;\n \n import com.linkedin.pinot.common.utils.MmapUtils;\n+import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n+import com.linkedin.pinot.core.index.reader.impl.FixedByteWidthRowColDataFileReader;\n import com.linkedin.pinot.core.index.readerwriter.SingleColumnSingleValueReaderWriter;\n+import com.linkedin.pinot.core.index.writer.impl.FixedByteWidthRowColDataFileWriter;\n import java.io.IOException;\n import java.nio.ByteBuffer;\n import java.nio.ByteOrder;\n \n-import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n-import com.linkedin.pinot.core.index.reader.SingleColumnSingleValueReader;\n-import com.linkedin.pinot.core.index.reader.impl.FixedByteWidthRowColDataFileReader;\n-import com.linkedin.pinot.core.index.writer.SingleColumnSingleValueWriter;\n-import com.linkedin.pinot.core.index.writer.impl.FixedByteWidthRowColDataFileWriter;\n-\n \n public class FixedByteSingleColumnSingleValueReaderWriter implements SingleColumnSingleValueReaderWriter {\n \n@@ -68,8 +65,11 @@ public DataFileMetadata getMetadata() {\n   @Override\n   public void close() throws IOException {\n     reader.close();\n+    reader = null;\n     writer.close();\n+    writer = null;\n     MmapUtils.unloadByteBuffer(_buffer);\n+    _buffer = null;\n   }\n \n   @Override",
                "deletions": 6
            },
            {
                "sha": "b60a9331f091672fa482860785c0524ec2c3c43b",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitSkipListSCMVWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitSkipListSCMVWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitSkipListSCMVWriter.java",
                "status": "modified",
                "changes": 9,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitSkipListSCMVWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -139,8 +139,17 @@ public void close() {\n     IOUtils.closeQuietly(raf);\n     raf = null;\n     MmapUtils.unloadByteBuffer(chunkOffsetsBuffer);\n+    chunkOffsetsBuffer = null;\n     MmapUtils.unloadByteBuffer(bitsetBuffer);\n+    bitsetBuffer = null;\n     MmapUtils.unloadByteBuffer(rawDataBuffer);\n+    rawDataBuffer = null;\n+    customBitSet.close();\n+    customBitSet = null;\n+    chunkOffsetsWriter.close();\n+    chunkOffsetsWriter = null;\n+    rawDataWriter.close();\n+    rawDataWriter = null;\n   }\n \n   private int updateHeader(int rowId, int length) {",
                "deletions": 0
            },
            {
                "sha": "6f758bb0bfb56aeb4095fd0d4c036ac9658eda5e",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthRowColDataFileWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthRowColDataFileWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthRowColDataFileWriter.java",
                "status": "modified",
                "changes": 8,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthRowColDataFileWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -15,8 +15,8 @@\n  */\n package com.linkedin.pinot.core.index.writer.impl;\n \n-import com.google.common.primitives.Ints;\n import com.linkedin.pinot.common.utils.MmapUtils;\n+import com.linkedin.pinot.core.util.CustomBitSet;\n import java.io.Closeable;\n import java.io.File;\n import java.io.FileNotFoundException;\n@@ -25,8 +25,6 @@\n import java.nio.ByteBuffer;\n import java.nio.channels.FileChannel;\n import java.util.Arrays;\n-\n-import com.linkedin.pinot.core.util.CustomBitSet;\n import org.apache.commons.io.IOUtils;\n \n \n@@ -146,9 +144,13 @@ public void setInt(int row, int col, int val) {\n     }\n   }\n \n+  @Override\n   public void close() {\n     IOUtils.closeQuietly(raf);\n     raf = null;\n     MmapUtils.unloadByteBuffer(byteBuffer);\n+    byteBuffer = null;\n+    bitSet.close();\n+    bitSet = null;\n   }\n }",
                "deletions": 3
            },
            {
                "sha": "5c84861193c482d70d27fd4f817e62c7a21a1b4a",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthSingleColumnMultiValueWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthSingleColumnMultiValueWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthSingleColumnMultiValueWriter.java",
                "status": "modified",
                "changes": 10,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedBitWidthSingleColumnMultiValueWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -17,6 +17,7 @@\n \n import com.linkedin.pinot.common.utils.MmapUtils;\n import java.io.File;\n+import java.io.IOException;\n import java.io.RandomAccessFile;\n import java.nio.ByteBuffer;\n import java.nio.channels.FileChannel;\n@@ -67,11 +68,18 @@ public boolean setMetadata(DataFileMetadata metadata) {\n   }\n \n   @Override\n-  public void close() {\n+  public void close() throws IOException {\n     IOUtils.closeQuietly(raf);\n     raf = null;\n     MmapUtils.unloadByteBuffer(dataBuffer);\n+    dataBuffer = null;\n     MmapUtils.unloadByteBuffer(headerBuffer);\n+    headerBuffer = null;\n+    headerWriter.close();\n+    headerWriter = null;\n+    headerReader.close();\n+    dataWriter.close();\n+    dataWriter = null;\n   }\n \n   private int updateHeader(int row, int length) {",
                "deletions": 1
            },
            {
                "sha": "bc63ac88a91602a8a7e9e6e796691ece2b0b8735",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteSkipListSCMVWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteSkipListSCMVWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteSkipListSCMVWriter.java",
                "status": "modified",
                "changes": 19,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteSkipListSCMVWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -15,18 +15,16 @@\n  */\n package com.linkedin.pinot.core.index.writer.impl;\n \n+import com.linkedin.pinot.common.utils.MmapUtils;\n+import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n+import com.linkedin.pinot.core.index.writer.SingleColumnMultiValueWriter;\n+import com.linkedin.pinot.core.util.CustomBitSet;\n import java.io.File;\n import java.io.RandomAccessFile;\n import java.nio.ByteBuffer;\n import java.nio.channels.FileChannel;\n-\n import org.apache.commons.io.IOUtils;\n \n-import com.linkedin.pinot.common.utils.MmapUtils;\n-import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n-import com.linkedin.pinot.core.index.writer.SingleColumnMultiValueWriter;\n-import com.linkedin.pinot.core.util.CustomBitSet;\n-\n \n /**\n  * Storage Layout\n@@ -132,8 +130,17 @@ public void close() {\n     IOUtils.closeQuietly(raf);\n     raf = null;\n     MmapUtils.unloadByteBuffer(chunkOffsetsBuffer);\n+    chunkOffsetsBuffer = null;\n     MmapUtils.unloadByteBuffer(bitsetBuffer);\n+    bitsetBuffer = null;\n     MmapUtils.unloadByteBuffer(rawDataBuffer);\n+    rawDataBuffer = null;\n+    customBitSet.close();\n+    customBitSet = null;\n+    chunkOffsetsWriter.close();\n+    chunkOffsetsWriter = null;\n+    rawDataWriter.close();\n+    rawDataWriter = null;\n   }\n \n   private int updateHeader(int rowId, int length) {",
                "deletions": 6
            },
            {
                "sha": "7a5e21777f287725449deaf4b4fe32b4fbe07545",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthRowColDataFileWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthRowColDataFileWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthRowColDataFileWriter.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthRowColDataFileWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -120,6 +120,7 @@ public void close() {\n     raf = null;\n     if (ownsByteBuffer) {\n       MmapUtils.unloadByteBuffer(byteBuffer);\n+      byteBuffer = null;\n     }\n   }\n }",
                "deletions": 0
            },
            {
                "sha": "9ad02874e8b4101019666b34a58c22c70fedab09",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthSingleColumnMultiValueWriter.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthSingleColumnMultiValueWriter.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthSingleColumnMultiValueWriter.java",
                "status": "modified",
                "changes": 17,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/index/writer/impl/FixedByteWidthSingleColumnMultiValueWriter.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -16,15 +16,14 @@\n package com.linkedin.pinot.core.index.writer.impl;\n \n import com.linkedin.pinot.common.utils.MmapUtils;\n+import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n+import com.linkedin.pinot.core.index.reader.impl.FixedByteWidthRowColDataFileReader;\n+import com.linkedin.pinot.core.index.writer.SingleColumnMultiValueWriter;\n import java.io.File;\n import java.io.IOException;\n import java.io.RandomAccessFile;\n import java.nio.ByteBuffer;\n import java.nio.channels.FileChannel;\n-\n-import com.linkedin.pinot.core.index.reader.DataFileMetadata;\n-import com.linkedin.pinot.core.index.reader.impl.FixedByteWidthRowColDataFileReader;\n-import com.linkedin.pinot.core.index.writer.SingleColumnMultiValueWriter;\n import org.apache.commons.io.IOUtils;\n \n \n@@ -68,11 +67,19 @@ public boolean setMetadata(DataFileMetadata metadata) {\n   }\n \n   @Override\n-  public void close() {\n+  public void close() throws IOException {\n     IOUtils.closeQuietly(raf);\n     raf = null;\n     MmapUtils.unloadByteBuffer(dataBuffer);\n+    dataBuffer = null;\n     MmapUtils.unloadByteBuffer(headerBuffer);\n+    headerBuffer = null;\n+    dataWriter.close();\n+    dataWriter = null;\n+    headerWriter.close();\n+    headerWriter = null;\n+    headerReader.close();\n+    headerReader = null;\n   }\n \n   private int updateHeader(int row, int length) {",
                "deletions": 5
            },
            {
                "sha": "ee7b10277f607dbdd927387d3a2a843768ed2d2c",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/utils/GenericRowColumnDataFileReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/utils/GenericRowColumnDataFileReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/utils/GenericRowColumnDataFileReader.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/indexsegment/utils/GenericRowColumnDataFileReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -232,5 +232,6 @@ public int getNumberOfCols() {\n   public void close() {\n     IOUtils.closeQuietly(file);\n     MmapUtils.unloadByteBuffer(byteBuffer);\n+    byteBuffer = null;\n   }\n }",
                "deletions": 0
            },
            {
                "sha": "a44719f99565e26244cad71fa723a92e16fe6681",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/BitmapInvertedIndexReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/BitmapInvertedIndexReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/BitmapInvertedIndexReader.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/BitmapInvertedIndexReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -127,6 +127,7 @@ private void load(File file, boolean isMmap) throws IOException {\n   @Override\n   public void close() throws IOException {\n     MmapUtils.unloadByteBuffer(buffer);\n+    buffer = null;\n     if (_rndFile != null) {\n       _rndFile.close();\n     }",
                "deletions": 0
            },
            {
                "sha": "0e00e12b204a2e14a24e4f2c4fe60ec1b5505929",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/readers/FixedBitCompressedMVForwardIndexReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/readers/FixedBitCompressedMVForwardIndexReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/readers/FixedBitCompressedMVForwardIndexReader.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/readers/FixedBitCompressedMVForwardIndexReader.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -164,7 +164,13 @@ public DataFileMetadata getMetadata() {\n   @Override\n   public void close() throws IOException {\n     MmapUtils.unloadByteBuffer(dataSectionBuffer);\n+    dataSectionBuffer = null;\n     MmapUtils.unloadByteBuffer(headerSectionBuffer);\n+    headerSectionBuffer = null;\n+    dataSectionReader.close();\n+    dataSectionReader = null;\n+    headerSectionReader.close();\n+    headerSectionReader = null;\n \n     if (isMmap) {\n       raf.close();",
                "deletions": 0
            },
            {
                "sha": "de0eeed17d9f17d63c2377dd21cd1ad7a2d9660b",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/util/CustomBitSet.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/util/CustomBitSet.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/main/java/com/linkedin/pinot/core/util/CustomBitSet.java",
                "status": "modified",
                "changes": 12,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/util/CustomBitSet.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -15,9 +15,9 @@\n  */\n package com.linkedin.pinot.core.util;\n \n-import com.google.common.primitives.Ints;\n import com.linkedin.pinot.common.utils.MmapUtils;\n import com.linkedin.pinot.core.indexsegment.utils.BitUtils;\n+import java.io.Closeable;\n import java.nio.ByteBuffer;\n \n \n@@ -26,10 +26,10 @@\n  * Util class to store bit set, provides additional utility over java bit set by\n  * allowing reading int from start bit to end bit\n  */\n-public final class CustomBitSet {\n+public final class CustomBitSet implements Closeable {\n \n   private final int nrBytes;\n-  private final ByteBuffer buf;\n+  private ByteBuffer buf;\n   private final static int[] bitCountArray = new int[256];\n   private final static int IGNORED_ZEROS_COUNT = Integer.SIZE - Byte.SIZE;\n   private final boolean ownsByteBuffer;\n@@ -268,11 +268,11 @@ public boolean isBitSet(long index) {\n     return ((b & (1 << offset)) != 0);\n   }\n \n-  protected void finalize() throws Throwable {\n+  @Override\n+  public void close() {\n     if (ownsByteBuffer) {\n       MmapUtils.unloadByteBuffer(buf);\n+      buf = null;\n     }\n-\n-    super.finalize();\n   }\n }",
                "deletions": 6
            },
            {
                "sha": "4130d93c4a61c54c5c0c13f189a800ae228b8888",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/core/util/CustomBitSetTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/core/util/CustomBitSetTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/core/util/CustomBitSetTest.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/core/util/CustomBitSetTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -41,6 +41,7 @@ public void testSetBit() {\n         Assert.assertFalse(customBitSet.isBitSet(i));\n       }\n     }\n+    customBitSet.close();\n   }\n \n   @Test\n@@ -52,6 +53,7 @@ public void testFindNthBitSet() {\n     customBitSet.setBit(250);\n     System.out.println(customBitSet.findNthBitSetAfter(0, 1));\n     System.out.println(customBitSet.findNthBitSetAfter(100, 1));\n+    customBitSet.close();\n \n   }\n \n@@ -135,6 +137,7 @@ public void testFindNthBitSetRandom() {\n       }\n       Assert.assertEquals(nthBitSetAfter, expectedIndex, \"Bits set \" +\n           bitsOnCopy + \", searching for \" + nthBitToFind + \"th bit from \" + startSearchIndex);\n+      customBitSet.close();\n     }\n   }\n \n@@ -153,6 +156,7 @@ public void testNthBit() {\n           Assert.assertEquals(foundSetBitIndex, -1, \"Found bit at index \" + foundSetBitIndex + \" while it was set at \"\n               + setBitIndex + \" searching from \" + searchStartIndex);\n         }\n+        customBitSet.close();\n       }\n     }\n   }\n@@ -179,6 +183,7 @@ public void testNthBitWithConfusingBit() {\n             Assert.assertEquals(foundSetBitIndex, -1, \"Found bit at index \" + foundSetBitIndex\n                 + \" while it was set at \" + setBitIndex + \" searching from \" + searchStartIndex);\n           }\n+          customBitSet.close();\n         }\n       }\n     }\n@@ -200,5 +205,6 @@ public void testNthBitFixed() {\n       Assert.assertEquals(foundSetBitIndex, -1, \"Found bit at index \" + foundSetBitIndex + \" while it was set at \"\n           + setBitIndex + \" searching from \" + searchStartIndex);\n     }\n+    customBitSet.close();\n   }\n }",
                "deletions": 0
            },
            {
                "sha": "339987172e8f4eb964802fc8fa37ea71b5820c1b",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthRowColDataFileReaderTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthRowColDataFileReaderTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthRowColDataFileReaderTest.java",
                "status": "modified",
                "changes": 13,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthRowColDataFileReaderTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -72,7 +72,7 @@ public void testReadIntFromByteBuffer() {\n       }\n       System.out.println(\"END MAX BITS:\" + maxBits);\n       maxBits = maxBits + 1;\n-\n+      customBitSet.close();\n     }\n   }\n \n@@ -88,10 +88,11 @@ public void testSingleColUnsigned() throws Exception {\n     for (int maxBits : maxBitArray) {\n       String fileName = \"test\" + maxBits + \"FixedBitWidthSingleCol\";\n       File file = new File(fileName);\n+      CustomBitSet bitset = null;\n       try {\n         System.out.println(\"START MAX BITS:\" + maxBits);\n         int numElements = 100;\n-        CustomBitSet bitset = CustomBitSet.withBitLength(numElements * maxBits);\n+        bitset = CustomBitSet.withBitLength(numElements * maxBits);\n         int max = (int) Math.pow(2, maxBits);\n         Random r = new Random();\n         int[] values = new int[numElements];\n@@ -135,9 +136,8 @@ public void testSingleColUnsigned() throws Exception {\n         System.out.println(\"END MAX BITS:\" + maxBits);\n       } finally {\n         file.delete();\n-\n+        bitset.close();\n       }\n-\n     }\n   }\n \n@@ -153,12 +153,12 @@ public void testSingleColSigned() throws Exception {\n     for (int maxBits : maxBitArray) {\n       String fileName = \"test\" + maxBits + \"FixedBitWidthSingleCol\";\n       File file = new File(fileName);\n+      CustomBitSet bitset = null;\n       try {\n         System.out.println(\"START MAX BITS:\" + maxBits);\n         int numElements = 100;\n         int requiredBits = maxBits + 1;\n-        CustomBitSet bitset = CustomBitSet.withBitLength(numElements\n-            * requiredBits);\n+        bitset = CustomBitSet.withBitLength(numElements * requiredBits);\n         int max = (int) Math.pow(2, maxBits);\n         Random r = new Random();\n         int[] values = new int[numElements];\n@@ -207,6 +207,7 @@ public void testSingleColSigned() throws Exception {\n         System.out.println(\"END MAX BITS:\" + maxBits);\n       } finally {\n         file.delete();\n+        bitset.close();\n       }\n \n     }",
                "deletions": 6
            },
            {
                "sha": "65c7f384011cf74acc6f4fc302f1ad0aaa4ee047",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthSingleColumnMultiValueReaderTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthSingleColumnMultiValueReaderTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthSingleColumnMultiValueReaderTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/index/reader/FixedBitWidthSingleColumnMultiValueReaderTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -74,6 +74,7 @@ public void testSingleColMultiValue() throws Exception {\n       dos.write(bitSet.toByteArray());\n       dos.flush();\n       dos.close();\n+      bitSet.close();\n \n       // Assert.assertEquals(FileReaderTestUtils.getNumOpenFiles(f), 0);\n       final int[] readValues = new int[100];",
                "deletions": 0
            },
            {
                "sha": "04db98342ecbf4eff0d761b5ea48301d6a3d218f",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitSkipListSCMVWriterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitSkipListSCMVWriterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitSkipListSCMVWriterTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitSkipListSCMVWriterTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -114,6 +114,8 @@ public void testSingleColMultiValue() throws Exception {\n       file.delete();\n       System.out.println(\"END test maxBit:\" + maxBits);\n       maxBits = maxBits + 1;\n+      bitSet.close();\n+      customBit.close();\n     }\n   }\n }",
                "deletions": 0
            },
            {
                "sha": "d9afc8ff569bc93964be902302c4962a10396c69",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthRowColDataFileWriterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthRowColDataFileWriterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthRowColDataFileWriterTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthRowColDataFileWriterTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -79,6 +79,7 @@ public void testSingleColUnsigned() throws Exception {\n       System.out.println(\"END test maxBits:\" + maxBits);\n       maxBits = maxBits + 1;\n       file.delete();\n+      set.close();\n     }\n   }\n \n@@ -140,6 +141,7 @@ public void testSingleColSigned() throws Exception {\n       System.out.println(\"END test maxBits:\" + maxBits);\n       maxBits = maxBits + 1;\n       file.delete();\n+      set.close();\n     }\n   }\n }",
                "deletions": 0
            },
            {
                "sha": "f569683bd9450d072f061197ee4a104df2310cc9",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthSingleColumnMultiValueWriterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthSingleColumnMultiValueWriterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthSingleColumnMultiValueWriterTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedBitWidthSingleColumnMultiValueWriterTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -90,6 +90,7 @@ public void testSingleColMultiValue() throws Exception {\n       file.delete();\n       System.out.println(\"END test maxBit:\" + maxBits);\n       maxBits = maxBits + 1;\n+      bitSet.close();\n     }\n \n   }",
                "deletions": 0
            },
            {
                "sha": "12d180628cd25b7e8d0c4e2a1207e8a4ab7ba153",
                "filename": "pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedByteSkipListSCMVWriterTest.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedByteSkipListSCMVWriterTest.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/69b2e7b0483dd697014d381dcc99a3fdb78282c9/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedByteSkipListSCMVWriterTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/test/java/com/linkedin/pinot/index/writer/FixedByteSkipListSCMVWriterTest.java?ref=69b2e7b0483dd697014d381dcc99a3fdb78282c9",
                "patch": "@@ -92,5 +92,6 @@ public void testSingleColMultiValue() throws Exception {\n     dis.close();\n     file.delete();\n     raf.close();\n+    customBit.close();\n   }\n }",
                "deletions": 0
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "THIRDEYE-262 (Several dashboard bug fixes)\n\nMulti time series does not show loading\n\nFixed bug not persisting window hash\n\nShow \"No data available\"\n\nLegend separate\n\nSplit View into Metric / Dimension\n\ngroup heat map cells by metric\n\nFixes NPE when heat map has no data\n\nFixed problem with multi time series comparator when zero series\n\nFixed bug where derived metric was not persisted\n\nFixed plot hover going off screen\n\nFixes array index out of bouds\n\nRB=475917\nR=kgopalak,npawar\nA=kgopalak",
        "commit": "https://github.com/apache/incubator-pinot/commit/ed55988e5a02ad50a011856e94d1bd33d559c63c",
        "parent": "https://github.com/apache/incubator-pinot/commit/d44790581e062392211b2b7fec821d868ae7fb52",
        "bug_id": "incubator-pinot_90",
        "file": [
            {
                "sha": "84072bfd602e6469fdffa06e6a30c07e85654c9e",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/HeatMap.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/HeatMap.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/HeatMap.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/HeatMap.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -10,8 +10,8 @@\n   private final ObjectMapper objectMapper;\n   private final String metric;\n   private final String dimension;\n-  private final List<String> statsNames;\n   private final List<HeatMapCell> cells;\n+  private final List<String> statsNames;\n \n   public HeatMap(ObjectMapper objectMapper,\n                  String metric,\n@@ -21,8 +21,8 @@ public HeatMap(ObjectMapper objectMapper,\n     this.objectMapper = objectMapper;\n     this.metric = metric;\n     this.dimension = dimension;\n-    this.statsNames = statsNames;\n     this.cells = cells;\n+    this.statsNames = statsNames;\n   }\n \n   public String getMetric() {",
                "deletions": 2
            },
            {
                "sha": "d71623cdec79ce47964cca2cf4baa1907befd589",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/QueryResult.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/QueryResult.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/QueryResult.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/api/QueryResult.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -36,7 +36,7 @@ public void setMetrics(List<String> metrics) {\n     this.metrics = metrics;\n   }\n \n-  public void checkEmpty() throws NotFoundException {\n+  public QueryResult checkEmpty() throws NotFoundException {\n     if (data.isEmpty()) {\n       throw new NotFoundException(\"No dimension combinations in result\");\n     }\n@@ -53,5 +53,7 @@ public void checkEmpty() throws NotFoundException {\n     if (allEmpty) {\n       throw new NotFoundException(\"No data for any dimension combination\");\n     }\n+\n+    return this;\n   }\n }",
                "deletions": 1
            },
            {
                "sha": "82405b4095f871c7fb329166988c451b8a4752e8",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java",
                "status": "modified",
                "changes": 5,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/DashboardResource.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -167,11 +167,10 @@ public View getMetricView(\n       case INTRA_DAY:\n         String sql = SqlUtils.getSql(metricFunction, collection, new DateTime(baselineMillis - INTRA_DAY_PERIOD), new DateTime(currentMillis), dimensionValues);\n         LOG.info(\"Generated SQL for {}: {}\", uriInfo.getRequestUri(), sql);\n-        Future<QueryResult> resultFuture = queryCache.getQueryResultAsync(serverUri, sql);\n-\n+        QueryResult result = queryCache.getQueryResult(serverUri, sql);\n         return new MetricViewTabular(\n             objectMapper,\n-            resultFuture.get(),\n+            result,\n             currentMillis - baselineMillis,\n             INTRA_DAY_PERIOD);\n       case TIME_SERIES_FULL:",
                "deletions": 3
            },
            {
                "sha": "d2390f26f92bcb249bf6616c269dd84f691a39e7",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/FlotTimeSeriesResource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/FlotTimeSeriesResource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/FlotTimeSeriesResource.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/resources/FlotTimeSeriesResource.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -46,7 +46,7 @@ public FlotTimeSeriesResource(String serverUri, QueryCache queryCache, ObjectMap\n     DateTime current = new DateTime(currentMillis);\n     Map<String, String> dimensionValues = UriUtils.extractDimensionValues(uriInfo.getQueryParameters());\n     String sql = SqlUtils.getSql(metricFunction, collection, baseline, current, dimensionValues);\n-    QueryResult queryResult = queryCache.getQueryResult(serverUri, sql);\n+    QueryResult queryResult = queryCache.getQueryResult(serverUri, sql).checkEmpty();\n     return FlotTimeSeries.fromQueryResult(objectMapper, queryResult);\n   }\n \n@@ -79,9 +79,9 @@ public FlotTimeSeriesResource(String serverUri, QueryCache queryCache, ObjectMap\n \n     // Generate series\n     List<FlotTimeSeries> baselineSeries\n-        = FlotTimeSeries.fromQueryResult(objectMapper, baselineResult.get(), BASELINE_LABEL_PREFIX);\n+        = FlotTimeSeries.fromQueryResult(objectMapper, baselineResult.get().checkEmpty(), BASELINE_LABEL_PREFIX);\n     List<FlotTimeSeries> currentSeries\n-        = FlotTimeSeries.fromQueryResult(objectMapper, currentResult.get());\n+        = FlotTimeSeries.fromQueryResult(objectMapper, currentResult.get().checkEmpty());\n \n     // Shift all baseline results up by window size\n     long offsetMillis = currentMillis - baselineMillis;",
                "deletions": 3
            },
            {
                "sha": "1dc2085f66740334a963060853f5e34abb0055e4",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/util/SnapshotUtils.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/util/SnapshotUtils.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/util/SnapshotUtils.java",
                "status": "added",
                "changes": 294,
                "additions": 294,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/util/SnapshotUtils.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -0,0 +1,294 @@\n+package com.linkedin.thirdeye.dashboard.util;\n+\n+import com.google.common.base.Joiner;\n+import com.linkedin.thirdeye.dashboard.api.QueryResult;\n+import org.apache.commons.math3.distribution.NormalDistribution;\n+import org.apache.commons.math3.linear.Array2DRowRealMatrix;\n+import org.apache.commons.math3.linear.RealMatrix;\n+import org.apache.commons.math3.stat.descriptive.DescriptiveStatistics;\n+\n+import java.util.*;\n+\n+public class SnapshotUtils {\n+  public static final String REST = \"REST\";\n+\n+  private static final String SEP = \"\\t\";\n+  private static final Joiner TSV = Joiner.on(SEP);\n+\n+  /**\n+   * Calculates the compression loss.\n+   *\n+   * <p>\n+   *   We expect currentValue to be expectedGrowthRatio * baselineValue.\n+   *   The difference between these two quantities is the compression loss.\n+   * </p>\n+   *\n+   * @param expectedGrowthRatio\n+   *  The ratio by which we expect baselineValue to grow\n+   * @param baselineValue\n+   *  Starting value\n+   * @param currentValue\n+   *  Ending value\n+   * @param standardDeviation\n+   *  The standard deviation of the distribution of baseline values\n+   */\n+  private static double compressionLoss(double expectedGrowthRatio,\n+                                        double baselineValue,\n+                                        double currentValue,\n+                                        double standardDeviation) {\n+    NormalDistribution dist = new NormalDistribution(baselineValue * expectedGrowthRatio, standardDeviation);\n+    return -Math.log(dist.density(currentValue));\n+  }\n+\n+  /**\n+   * Returns descriptive statistics for each metric for a set of dimension combinations.\n+   *\n+   * @param numMetrics\n+   *  The number of metric values\n+   * @param metricsByDimension\n+   *  Metrics grouped by dimension combination\n+   */\n+  private static DescriptiveStatistics[] getStats(int numMetrics, Map<String, Number[]> metricsByDimension) {\n+    if (metricsByDimension.isEmpty()) {\n+      throw new IllegalArgumentException(\"Cannot calculate statistics for no metrics\");\n+    }\n+\n+    DescriptiveStatistics[] stats = new DescriptiveStatistics[numMetrics];\n+    for (int i = 0; i < numMetrics; i++) {\n+      stats[i] = new DescriptiveStatistics();\n+    }\n+\n+    for (Map.Entry<String, Number[]> entry : metricsByDimension.entrySet()) {\n+      Number[] metrics = entry.getValue();\n+      for (int i = 0; i < metrics.length; i++) {\n+        if (metrics[i].doubleValue() != Double.NEGATIVE_INFINITY) {\n+          stats[i].addValue(metrics[i].doubleValue());\n+        }\n+      }\n+    }\n+\n+    return stats;\n+  }\n+\n+  /**\n+   * Compute the initial growth ratio at the highest aggregation granularity.\n+   *\n+   * @param numMetrics\n+   *  The number of metric values\n+   * @param baseline\n+   *  Baseline data grouped by dimension\n+   * @param current\n+   *  Current data grouped by dimension\n+   */\n+  private static double[] getInitialRatios(int numMetrics,\n+                                           Map<String, Number[]> baseline,\n+                                           Map<String, Number[]> current) {\n+    double[] ratios = new double[numMetrics];\n+    for (int i = 0; i < numMetrics; i++) {\n+      double valueT1 = 0.0;\n+      double valueT2 = 0.0;\n+      for (Map.Entry<String, Number[]> entry : baseline.entrySet()) {\n+        String combination = entry.getKey();\n+        Number[] baselineData = entry.getValue();\n+        Number[] currentData = current.get(combination);\n+\n+        if (currentData == null) {\n+          continue;\n+        }\n+\n+        valueT1 += baselineData[i].doubleValue();\n+        valueT2 += currentData[i].doubleValue();\n+      }\n+      ratios[i] = valueT2 / valueT1;\n+    }\n+    return ratios;\n+  }\n+\n+  /**\n+   * Returns the records that were biggest movers.\n+   *\n+   * @param metricIdx\n+   *  Only compute snapshot on this particular metric\n+   * @param maxRecords\n+   *  Return this many records\n+   * @param growthRatio\n+   *  The expected growth ratio from baseline to current\n+   * @param baseline\n+   *  Baseline data\n+   * @param current\n+   *  Current data\n+   */\n+  private static SnapshotResult computeOneSnapshot(int metricIdx,\n+                                                   int maxRecords,\n+                                                   double growthRatio,\n+                                                   Map<String, Number[]> baseline,\n+                                                   Map<String, Number[]> current) {\n+    int rowNum = baseline.size();\n+    int colNum = maxRecords + 1;\n+    RealMatrix table = new Array2DRowRealMatrix(rowNum, colNum);\n+    String[][] recordTable = new String[rowNum][colNum];\n+    String[] combinationTable = new String[rowNum];\n+\n+    // Fill in combination table\n+    int idx = 0;\n+    for (String combination : baseline.keySet()) {\n+      combinationTable[idx] = combination;\n+      idx++;\n+    }\n+\n+    // Compute the variance / standard deviation\n+    double variance = 0.0;\n+    for (int i = 0; i < rowNum; i++) {\n+      String combination = combinationTable[i];\n+      Number[] baselineData = baseline.get(combination);\n+      Number[] currentData = current.get(combination);\n+      if (currentData == null) {\n+        continue;\n+      }\n+\n+      double baselineValue = baselineData[metricIdx].doubleValue();\n+      double currentValue = currentData[metricIdx].doubleValue();\n+      double diff = currentValue - growthRatio * baselineValue;\n+      variance += diff * diff;\n+    }\n+    double stDev = Math.sqrt(variance);\n+\n+    // Update first column\n+    for (int i = 0; i < rowNum; i++) {\n+      String combination = combinationTable[i];\n+      Number[] baselineData = baseline.get(combination);\n+      Number[] currentData = current.get(combination);\n+      if (currentData == null) {\n+        continue;\n+      }\n+\n+      double baselineValue = baselineData[metricIdx].doubleValue();\n+      double currentValue = currentData[metricIdx].doubleValue();\n+      double loss = compressionLoss(growthRatio, baselineValue, currentValue, stDev);\n+      if (i == 0) {\n+        table.setEntry(i, 0, loss);\n+      } else {\n+        table.setEntry(i, 0, table.getEntry(i - 1, 0) + loss);\n+      }\n+\n+      recordTable[i][0] = REST;\n+    }\n+\n+    // Update first row\n+    for (int j = 1; j < colNum; j++) {\n+      table.setEntry(0, j, 0);\n+      recordTable[0][j] = combinationTable[0];\n+    }\n+\n+    // Update rest of columns\n+    for (int i = 1; i < rowNum; i++) {\n+      String combination = combinationTable[i];\n+      Number[] baselineData = baseline.get(combination);\n+      Number[] currentData = current.get(combination);\n+      if (currentData == null) {\n+        continue;\n+      }\n+\n+      double baselineValue = baselineData[metricIdx].doubleValue();\n+      double currentValue = currentData[metricIdx].doubleValue();\n+\n+      for (int j = 1; j < colNum; j++) {\n+        // D(T_(i+1), n, r) = min (D(T_i, n-1, r) + D(t_(i+1), 1, r), D(T_i, n, r) +D(t_(i+1), 0, r))\n+        double t1 = table.getEntry(i - 1, j - 1);\n+        double t2 = table.getEntry(i - 1, j) + compressionLoss(growthRatio, baselineValue, currentValue, stDev);\n+        table.setEntry(i, j, Math.min(t1, t2));\n+\n+        // Record combinations\n+        if (t1 < t2) {\n+          recordTable[i][j] = TSV.join(combination, recordTable[i - 1][j - 1]);\n+        } else if (recordTable[i - 1][j - 1].contains(REST)) {\n+          recordTable[i][j] = recordTable[i - 1][j];\n+        } else {\n+          recordTable[i][j] = TSV.join(recordTable[i - 1][j], REST);\n+        }\n+      }\n+    }\n+\n+    double cost = table.getEntry(rowNum - 1, colNum - 1);\n+    String[] records = recordTable[rowNum - 1][colNum - 1].split(SEP);\n+    return new SnapshotResult(cost, records);\n+  }\n+\n+  /**\n+   * Computes snapshot for each metric.\n+   */\n+  private static String[][] computeSnapshot(int maxRecords,\n+                                            int numMetrics,\n+                                            Map<String, Number[]> baseline,\n+                                            Map<String, Number[]> current) {\n+    double[] ratios = getInitialRatios(numMetrics, baseline, current);\n+    String[][] records = new String[numMetrics][];\n+\n+    for (int i = 0; i < numMetrics; i++) {\n+      double ratio = ratios[i];\n+      double lo = ratio / 2;\n+      double hi = 2 * ratio;\n+      int steps = 25;  // TODO Configurable? (was 100)\n+      double stepSize = (hi - lo) / steps;\n+      double minCost = computeOneSnapshot(i, maxRecords, lo, baseline, current).getCost();\n+      double minRatio = lo;\n+\n+      for (int j = 1; j < steps; j++) {\n+        double currentRatio = lo + i * stepSize;\n+        double currentCost = computeOneSnapshot(i, maxRecords, currentRatio, baseline, current).getCost();\n+        if (currentCost < minCost) {\n+          minCost = currentCost;\n+          minRatio = currentRatio;\n+        }\n+      }\n+\n+      records[i] = computeOneSnapshot(i, maxRecords, minRatio, baseline, current).getRecords();\n+    }\n+\n+    return records;\n+  }\n+\n+  /**\n+   * Clusters the biggest movers among all dimension combinations.\n+   */\n+  public static String[][] snapshot(int maxRecords, QueryResult queryResult) {\n+    Map<String, Number[]> baseline = new HashMap<>(queryResult.getData().size());\n+    Map<String, Number[]> current = new HashMap<>(queryResult.getData().size());\n+    for (Map.Entry<String, Map<String, Number[]>> entry : queryResult.getData().entrySet()) {\n+      // Find current / baseline time\n+      List<Long> times = new ArrayList<>(entry.getValue().size());\n+      for (String timeString : entry.getValue().keySet()) {\n+        times.add(Long.valueOf(timeString));\n+      }\n+      Long baselineTime = Collections.min(times);\n+      Long currentTime = Collections.max(times);\n+\n+      // Get current / baseline data\n+      Number[] baselineData = entry.getValue().get(Long.toString(baselineTime));\n+      Number[] currentData = entry.getValue().get(Long.toString(currentTime));\n+      baseline.put(entry.getKey(), baselineData);\n+      current.put(entry.getKey(), currentData);\n+    }\n+\n+    // Compute snapshot\n+    return computeSnapshot(maxRecords, queryResult.getMetrics().size(), baseline, current);\n+  }\n+\n+  private static class SnapshotResult {\n+    private final double cost;\n+    private final String[] records;\n+\n+    SnapshotResult(double cost, String[] records) {\n+      this.cost = cost;\n+      this.records = records;\n+    }\n+\n+    double getCost() {\n+      return cost;\n+    }\n+\n+    String[] getRecords() {\n+      return records;\n+    }\n+  }\n+}",
                "deletions": 0
            },
            {
                "sha": "e6095941b5400424fefa24a3bd086851967a4a2b",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/DimensionViewHeatMap.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/DimensionViewHeatMap.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/DimensionViewHeatMap.java",
                "status": "modified",
                "changes": 35,
                "additions": 33,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/DimensionViewHeatMap.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -5,6 +5,7 @@\n import com.linkedin.thirdeye.dashboard.api.HeatMap;\n import com.linkedin.thirdeye.dashboard.api.HeatMapCell;\n import com.linkedin.thirdeye.dashboard.api.QueryResult;\n+import com.linkedin.thirdeye.dashboard.util.SnapshotUtils;\n import io.dropwizard.views.View;\n import org.apache.commons.math3.distribution.NormalDistribution;\n import org.apache.commons.math3.stat.descriptive.DescriptiveStatistics;\n@@ -38,6 +39,29 @@ public DimensionViewHeatMap(ObjectMapper objectMapper, Map<String, QueryResult>\n   private List<HeatMap> generateHeatMaps(String dimension, QueryResult queryResult) throws Exception {\n     int dimensionIdx = queryResult.getDimensions().indexOf(dimension);\n \n+    if (queryResult.getData().isEmpty()) {\n+      return Collections.emptyList();\n+    }\n+\n+    // Snapshot\n+    String[][] snapshot = SnapshotUtils.snapshot(2, queryResult); // show top 2 movers\n+    Map<String, Set<String>> snapshotValues = new HashMap<>();\n+    for (int i = 0; i < queryResult.getMetrics().size(); i++) {\n+      String[] snapshotCombinations = snapshot[i];\n+      String metricName = queryResult.getMetrics().get(i);\n+      Set<String> dimensionValues = new HashSet<>();\n+      for (String combinationString : snapshotCombinations) {\n+        if (SnapshotUtils.REST.equals(combinationString)) {\n+          continue;\n+        }\n+        List<String> combination = objectMapper.readValue(combinationString.getBytes(), LIST_TYPE_REFERENCE);\n+        String value = combination.get(dimensionIdx);\n+        dimensionValues.add(value);\n+      }\n+      snapshotValues.put(metricName, dimensionValues);\n+    }\n+    LOG.info(\"snapshotValues={}\", snapshotValues);\n+\n     // Initialize metric info\n     Map<String, List<HeatMapCell>> allCells = new HashMap<>();\n     Map<String, DescriptiveStatistics> allBaselineStats = new HashMap<>();\n@@ -88,7 +112,6 @@ public DimensionViewHeatMap(ObjectMapper objectMapper, Map<String, QueryResult>\n       }\n     }\n \n-\n     List<HeatMap> heatMaps = new ArrayList<>();\n     for (Map.Entry<String, List<HeatMapCell>> entry : allCells.entrySet()) {\n       String metric = entry.getKey();\n@@ -133,6 +156,13 @@ public DimensionViewHeatMap(ObjectMapper objectMapper, Map<String, QueryResult>\n         } else {\n           cell.addStat(null);\n         }\n+\n+        // Snapshot category (i.e. is one of the biggest movers)\n+        if (snapshotValues.get(metric).contains(cell.getValue())) {\n+          cell.addStat(1);\n+        } else {\n+          cell.addStat(0);\n+        }\n       }\n \n       heatMaps.add(new HeatMap(objectMapper, entry.getKey(), dimension, entry.getValue(), Arrays.asList(\n@@ -141,7 +171,8 @@ public DimensionViewHeatMap(ObjectMapper objectMapper, Map<String, QueryResult>\n           \"baseline_p_value\",\n           \"current_p_value\",\n           \"contribution_difference\",\n-          \"volume_difference\"\n+          \"volume_difference\",\n+          \"snapshot_category\"\n       )));\n     }\n ",
                "deletions": 2
            },
            {
                "sha": "fa6091daed08c36d19635324a6457a99b4e6b779",
                "filename": "thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/MetricViewTabular.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/MetricViewTabular.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/MetricViewTabular.java",
                "status": "modified",
                "changes": 8,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/java/com/linkedin/thirdeye/dashboard/views/MetricViewTabular.java?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -24,7 +24,7 @@ public MetricViewTabular(ObjectMapper objectMapper,\n                            QueryResult result,\n                            long baselineOffsetMillis,\n                            long intraDayPeriod) throws Exception {\n-    super(\"metric/table.ftl\");\n+    super(\"metric/intra-day.ftl\");\n     this.objectMapper = objectMapper;\n     this.result = result;\n     this.baselineOffsetMillis = baselineOffsetMillis;\n@@ -64,12 +64,16 @@ public MetricViewTabular(ObjectMapper objectMapper,\n       while (windowFilled < intraDayPeriod && idx < times.size() - 1) {\n         long current = times.get(idx);\n         long next = times.get(idx + 1);\n+        idx++;\n \n         // n.b. this is inefficient, but prevents us from having to pass around aggregation granularity info\n+        int timeIndex = times.indexOf(current - baselineOffsetMillis);\n+        if (timeIndex < 0) {\n+          continue;\n+        }\n         long baseline = times.get(times.indexOf(current - baselineOffsetMillis) - 1);\n \n         windowFilled += (current - next);\n-        idx++;\n \n         Number[] currentData = entry.getValue().get(String.valueOf(current));\n         Number[] baselineData = entry.getValue().get(String.valueOf(baseline));",
                "deletions": 2
            },
            {
                "sha": "4fea7ccc2e92906755ea3742cd1a8d1674a38a0d",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/css/dashboard.css",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/css/dashboard.css",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/css/dashboard.css",
                "status": "modified",
                "changes": 20,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/css/dashboard.css?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -81,10 +81,6 @@\n     background-color: #FAFF94;\n }\n \n-#metric-time-series-tooltip {\n-    color: #777777;\n-}\n-\n #time-nav-buttons {\n     float: right;\n     margin-right: 2%;\n@@ -107,6 +103,11 @@\n     margin-bottom: 2%;\n }\n \n+#metric-table-area {\n+    clear: both;\n+    margin-top: 5%;\n+}\n+\n /* Dimension */\n \n #dimension-heat-map-area,\n@@ -117,4 +118,15 @@\n #dimension-time-series-buttons,\n #dimension-heat-map-buttons {\n     margin-bottom: 2%;\n+    clear: both;\n+}\n+\n+/* Both */\n+\n+.time-series-legend {\n+    overflow: hidden;\n+}\n+\n+.time-series-legend table {\n+    float: right;\n }",
                "deletions": 4
            },
            {
                "sha": "36f1a9e74b72b68136f7f9ad476ab0e1d6521dc4",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dashboard.js",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dashboard.js",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dashboard.js",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dashboard.js?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -1,5 +1,5 @@\n $(document).ready(function() {\n-    $(\"#view-links a\").each(function(i, link) {\n+    $(\".view-links a\").each(function(i, link) {\n         var linkObj = $(link)\n         var linkType = linkObj.attr('type')\n         linkObj.click(function() {\n@@ -33,7 +33,7 @@ $(document).ready(function() {\n         var period = currentMillis - baselineMillis\n         path.baselineMillis = baselineMillis - (period / 2)\n         path.currentMillis = currentMillis - (period / 2)\n-        window.location.pathname = getDashboardPath(path)\n+        window.location.href = window.location.href.replace(window.location.pathname, getDashboardPath(path))\n     })\n \n     $(\"#time-nav-right\").click(function() {\n@@ -43,6 +43,6 @@ $(document).ready(function() {\n         var period = currentMillis - baselineMillis\n         path.baselineMillis = baselineMillis + (period / 2)\n         path.currentMillis = currentMillis + (period / 2)\n-        window.location.pathname = getDashboardPath(path)\n+        window.location.href = window.location.href.replace(window.location.pathname, getDashboardPath(path))\n     })\n })",
                "deletions": 3
            },
            {
                "sha": "58f400fb71cd0ff3a7c6d979feb39cd4ec7e39e9",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.heatmap.js",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.heatmap.js",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.heatmap.js",
                "status": "modified",
                "changes": 20,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.heatmap.js?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -21,7 +21,8 @@ $(document).ready(function() {\n         },\n         backgroundColor: function(cell) {\n             return 'rgba(136, 138, 252, ' + cell.stats['baseline_p_value'].toFixed(3) + ')'\n-        }\n+        },\n+        groupBy: 'METRIC'\n     }\n \n     var contributionOptions = {\n@@ -47,7 +48,13 @@ $(document).ready(function() {\n             } else {\n               return 'rgba(138, 252, 136, ' + (cell.stats['current_p_value']) + ')'\n             }\n-        }\n+        },\n+        groupBy: 'METRIC'\n+    }\n+\n+    var snapshotOptions = $.extend(true, {}, contributionOptions)\n+    snapshotOptions.filter = function(cell) {\n+        return cell.stats['snapshot_category'] > 0\n     }\n \n     $(\"#dimension-heat-map-button-contribution\").click(function() {\n@@ -60,12 +67,19 @@ $(document).ready(function() {\n       renderHeatMap(data, container, volumeOptions)\n     })\n \n+    $(\"#dimension-heat-map-button-snapshot\").click(function() {\n+      window.location.hash = setHashParameter(window.location.hash, 'heatMap', 'snapshot')\n+      renderHeatMap(data, container, snapshotOptions)\n+    })\n+\n     var hashParams = parseHashParameters(window.location.hash)\n     if (hashParams['heatMap'] == 'volume') {\n       renderHeatMap(data, container, volumeOptions)\n     } else if (hashParams['heatMap'] == 'contribution') {\n       renderHeatMap(data, container, contributionOptions)\n-    } else { // not provided -> default\n+    } else if (hashParams['heatMap'] == 'snapshot') {\n+      renderHeatMap(data, container, snapshotOptions)\n+    } else {\n       window.location.hash = setHashParameter(window.location.hash, 'heatMap', 'volume')\n       renderHeatMap(data, container, volumeOptions)\n     }",
                "deletions": 3
            },
            {
                "sha": "2cf4a68cbebacedbe76fb02d00ec6e86efc4011f",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.timeseries.js",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.timeseries.js",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.timeseries.js",
                "status": "modified",
                "changes": 37,
                "additions": 21,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.dimension.timeseries.js?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -7,7 +7,6 @@ $(document).ready(function() {\n         containers[dimension] = {\n             plot: containerObj\n         }\n-        containerObj.html(\"<p>Loading \" + dimension + \"...</p>\")\n     })\n \n     $(\"#dimension-time-series-area\").find('.dimension-time-series-tooltip').each(function(i, container) {\n@@ -22,20 +21,29 @@ $(document).ready(function() {\n         containers[dimension].title = containerObj\n     })\n \n+    $(\"#dimension-time-series-area\").find('.dimension-time-series-legend').each(function(i, container) {\n+        var containerObj = $(container)\n+        var dimension = containerObj.attr('dimension')\n+        containers[dimension].legend = containerObj\n+    })\n+\n+    var hash = parseHashParameters(window.location.hash)\n+\n     var options = {\n+        mode: hash['dimensionTimeSeriesMode'] ? hash['dimensionTimeSeriesMode'] : 'same',\n         legend: true,\n         filter: function(data) {\n             // Pick the top 4 according to baseline value\n             data.sort(function(a, b) {\n-                var cmp = b.data[0][1] - a.data[0][1]\n-\n-                if (cmp < 0) {\n-                    return -1\n-                } else if (cmp > 0) {\n-                    return 1\n-                } else {\n+                if (!b.data[0] && !a.data[0]) {\n                     return 0\n+                } else if (b.data[0] && !a.data[0]) {\n+                    return 1\n+                } else if (!b.data[0] && a.data[0]) {\n+                    return -1\n                 }\n+\n+                return b.data[0][1] - a.data[0][1]\n             })\n \n             return data.slice(0, 4)\n@@ -72,21 +80,18 @@ $(document).ready(function() {\n \n     function plotAllSeries() {\n         $.each(containers, function(dimension, container) {\n+            var optionsCopy = $.extend(true, {}, options)\n             container.title.html(dimension)\n-            options.dimension = dimension\n-            renderTimeSeries(container.plot, container.tooltip, options)\n+            optionsCopy.dimension = dimension\n+            optionsCopy.legendContainer = container.legend\n+            renderTimeSeries(container.plot, container.tooltip, optionsCopy)\n         })\n     }\n \n-    $(\"#dimension-time-series-button-legend\").click(function() {\n-        options.legend = !options.legend\n-        plotAllSeries()\n-    })\n-\n     $(\".dimension-time-series-button-mode\").click(function() {\n         var mode = $(this).attr('mode')\n         var hash = parseHashParameters(window.location.hash)\n-        hash['timeSeriesMode'] = mode\n+        hash['dimensionTimeSeriesMode'] = mode\n         window.location.hash = encodeHashParameters(hash)\n \n         if (options.mode != mode) {",
                "deletions": 16
            },
            {
                "sha": "b20dd31d766699e53e179c610ee3e0bd92056233",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.js",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.js",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.js",
                "status": "modified",
                "changes": 199,
                "additions": 141,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.js?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -202,10 +202,11 @@ function renderFunnel(container, options) {\n         url += '?' + encodeURIComponent(options.dimension) + '=!'\n     }\n \n-    container.css('width', container.width())\n-    container.css('height', '400px')\n \n-    $.get(url, function(data) {\n+    var render = function(data) {\n+        container.css('width', container.width())\n+        container.css('height', '400px')\n+\n         data.sort(function(a, b) {\n             return b.data[0][1] - a.data[0][1]\n         })\n@@ -245,7 +246,25 @@ function renderFunnel(container, options) {\n                 }\n             }\n         })\n-    })\n+    }\n+\n+    $.ajax({\n+        url: url,\n+        statusCode: {\n+            404: function() {\n+                container.empty()\n+                var warning = $('<div></div>', { class: 'uk-alert uk-alert-warning' })\n+                warning.append($('<p></p>', { html: 'No data available' }))\n+                container.append(warning)\n+            },\n+            500: function() {\n+                container.empty()\n+                var error = $('<div></div>', { class: 'uk-alert uk-alert-danger' })\n+                error.append($('<p></p>', { html: 'Internal server error' }))\n+                container.append(error)\n+            }\n+        }\n+    }).done(render)\n }\n \n /**\n@@ -254,6 +273,7 @@ function renderFunnel(container, options) {\n  */\n function renderTimeSeries(container, tooltip, options) {\n     container.empty()\n+    container.html('Loading...')\n \n     var path = parsePath(window.location.pathname)\n     var url = getFlotPath(path, options)\n@@ -262,6 +282,10 @@ function renderTimeSeries(container, tooltip, options) {\n         options = {}\n     }\n \n+    if (options.legendContainer) {\n+        options.legendContainer.empty()\n+    }\n+\n     if (window.location.search) {\n         url += window.location.search\n         if (options.dimension) {\n@@ -277,7 +301,8 @@ function renderTimeSeries(container, tooltip, options) {\n \n     options.minTickSize = (path.currentMillis - path.baselineMillis) / 10\n \n-    $.get(url, function(data) {\n+    var render = function(data) {\n+        container.empty()\n         if (options.mode == 'own') {\n             var groups = {}\n             $.each(data, function(i, datum) {\n@@ -297,19 +322,48 @@ function renderTimeSeries(container, tooltip, options) {\n                 groupValues.push(values)\n             })\n \n-            container.css('height', (groupValues.length * 200) + 'px')\n+            var totalHeight = 0\n             for (var i = 0; i < groupValues.length; i++) {\n                 var subContainer = $(\"<div></div>\")\n+                var subCanvas = $(\"<div></div>\")\n+                var subLegend = $(\"<div></div>\", { class: 'time-series-legend' })\n+                var optionsCopy = $.extend(true, {}, options)\n+\n+                subContainer.append(subCanvas).append(subLegend)\n                 container.append(subContainer)\n-                subContainer.css('width', container.width())\n-                subContainer.css('height', '200px')\n-                plotOne(subContainer, tooltip, options, groupValues[i])\n+\n+                subCanvas.css('width', container.width())\n+                subCanvas.css('height', '200px')\n+                optionsCopy.legendContainer = subLegend\n+                plotOne(subCanvas, tooltip, optionsCopy, groupValues[i])\n+\n+                totalHeight += subContainer.height()\n             }\n+\n+            container.css('height', totalHeight)\n         } else {\n             container.css('height', '400px')\n             plotOne(container, tooltip, options, data)\n         }\n-    })\n+    }\n+\n+    $.ajax({\n+        url: url,\n+        statusCode: {\n+            404: function() {\n+                container.empty()\n+                var warning = $('<div></div>', { class: 'uk-alert uk-alert-warning' })\n+                warning.append($('<p></p>', { html: 'No data available' }))\n+                container.append(warning)\n+            },\n+            500: function() {\n+                container.empty()\n+                var error = $('<div></div>', { class: 'uk-alert uk-alert-danger' })\n+                error.append($('<p></p>', { html: 'Internal server error' }))\n+                container.append(error)\n+            }\n+        }\n+    }).done(render)\n }\n \n function plotOne(container, tooltip, options, data) {\n@@ -320,7 +374,8 @@ function plotOne(container, tooltip, options, data) {\n     container.plot(data, {\n         legend: {\n             show: options.legend == null ? true : options.legend,\n-            position: \"se\"\n+            position: \"se\",\n+            container: options.legendContainer\n         },\n         grid: {\n             clickable: true,\n@@ -339,7 +394,13 @@ function plotOne(container, tooltip, options, data) {\n             var dateString = moment.utc(item.datapoint[0]).tz(jstz().timezone_name).format()\n             var value = item.datapoint[1]\n             tooltip.html(item.series.label + \" = \" + value + \" @ \" + dateString)\n-                   .css({ top: container.position().top + 25, left: container.position().left + 75 })\n+                   .css({\n+                        top: item.pageY + 5,\n+                        right: $(window).width() - item.pageX,\n+                        'background-color': '#ffcc00',\n+                        border: '1px solid #cc9900',\n+                        'z-index': 1000\n+                   })\n                    .fadeIn(100)\n         } else {\n             tooltip.hide()\n@@ -400,61 +461,83 @@ function renderHeatMap(rawData, container, options) {\n \n     container.empty()\n \n+    // Group\n+    var groups = {}\n     $.each(data, function(heatMapId, cells) {\n-        // Table structure\n-        var table = $(\"<table></table>\", {\n-            class: 'uk-table dimension-view-heat-map-rendered'\n+        var tokens = heatMapId.split('-')\n+        var metric = tokens[0]\n+        var dimension = tokens[1]\n+        var groupKey = options.groupBy == 'DIMENSION' ? dimension : metric\n+        var caption = options.groupBy == 'DIMENSION' ? metric : dimension // show the other as caption\n+\n+        if (!groups[groupKey]) {\n+            groups[groupKey] = []\n+        }\n+\n+        groups[groupKey].push({\n+            dimension: dimension,\n+            metric: metric,\n+            caption: caption,\n+            cells: cells\n         })\n-        table.append($(\"<caption></caption>\", {\n-            html: heatMapId.replace('-', '.')\n-        }))\n-\n-        // Sort cells\n-        cells.sort(options.comparator)\n-\n-        // Group into rows\n-        var numColumns = 5\n-        var rows = []\n-        var currentRow = []\n-        for (var i = 0; i < cells.length; i++) {\n-            if (options.filter != null && !options.filter(cells[i])) {\n-                continue\n+    })\n+\n+    $.each(groups, function(groupId, group) {\n+        var header = $('<h2></h2>', { html: groupId })\n+        container.append(header)\n+\n+        $.each(group, function(i, heatMap) {\n+            var table = $('<table></table>', { class: 'uk-table dimension-view-heat-map-rendered' })\n+            var caption = $('<caption></caption>', { html: heatMap.caption })\n+            var cells = heatMap.cells\n+            cells.sort(options.comparator)\n+\n+            // Group cells into rows\n+            var numColumns = 5\n+            var rows = []\n+            var currentRow = []\n+            for (var i = 0; i < cells.length; i++) {\n+                if (options.filter != null && !options.filter(cells[i])) {\n+                    continue\n+                }\n+                currentRow.push(cells[i])\n+                if (currentRow.length == numColumns) {\n+                    rows.push(currentRow)\n+                    currentRow = []\n+                }\n             }\n-            currentRow.push(cells[i])\n-            if (currentRow.length == numColumns) {\n+            if (currentRow.length > 0) {\n                 rows.push(currentRow)\n-                currentRow = []\n             }\n-        }\n-        if (currentRow.length > 0) {\n-            rows.push(currentRow)\n-        }\n \n-        // Generate table body\n-        var tbody = $(\"<tbody></tbody>\")\n-        $.each(rows, function(i, row) {\n-            var tr = $(\"<tr></tr>\")\n-            $.each(row, function(j, cell) {\n-                var td = $(\"<td></td>\")\n-                td.html(options.display(cell))\n-                td.css('background-color', options.backgroundColor(cell))\n-                td.hover(function() { $(this).css('cursor', 'pointer') })\n-                tr.append(td)\n-\n-                // Drill-down click handler\n-                td.click(function() {\n-                    var name = $(\"#dimension-view-heat-map-\" + heatMapId).attr('dimension')\n-                    var value = cell.value\n-                    var dimensionValues = parseDimensionValues(window.location.search)\n-                    dimensionValues[name] = value\n-                    window.location.search = encodeDimensionValues(dimensionValues)\n+            // Generate table body\n+            var tbody = $(\"<tbody></tbody>\")\n+            $.each(rows, function(i, row) {\n+                var tr = $(\"<tr></tr>\")\n+                $.each(row, function(j, cell) {\n+                    var td = $(\"<td></td>\")\n+                    td.html(options.display(cell))\n+                    td.css('background-color', options.backgroundColor(cell))\n+                    td.hover(function() { $(this).css('cursor', 'pointer') })\n+                    tr.append(td)\n+\n+                    // Drill-down click handler\n+                    td.click(function() {\n+                        var name = $(\"#dimension-view-heat-map-\" + heatMapId).attr('dimension')\n+                        var value = cell.value\n+                        var dimensionValues = parseDimensionValues(window.location.search)\n+                        dimensionValues[name] = value\n+                        window.location.search = encodeDimensionValues(dimensionValues)\n+                    })\n                 })\n+                tbody.append(tr)\n             })\n-            tbody.append(tr)\n-        })\n-        table.append(tbody)\n \n-        container.append(table)\n+            // Append\n+            table.append(caption)\n+            table.append(tbody)\n+            container.append(table)\n+        })\n     })\n }\n ",
                "deletions": 58
            },
            {
                "sha": "c1c3e91dfcd84025baee88f38da64feefba149a8",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.metric.timeseries.js",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.metric.timeseries.js",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.metric.timeseries.js",
                "status": "modified",
                "changes": 8,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.metric.timeseries.js?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -11,7 +11,8 @@ $(document).ready(function() {\n         path.currentMillis = item.datapoint[0] + aggregateMillis\n         path.baselineMillis = item.datapoint[0] + aggregateMillis - baselineDiff\n         window.location.pathname = getDashboardPath(path)\n-      }\n+      },\n+      legendContainer: $(\"#metric-time-series-legend\")\n     }\n \n     var path = parsePath(window.location.pathname)\n@@ -34,11 +35,6 @@ $(document).ready(function() {\n         }\n     })\n \n-    $(\"#metric-time-series-button-legend\").click(function() {\n-        options.legend = !options.legend\n-        renderTimeSeries(container, tooltip, options)\n-    })\n-\n     $(\"#metric-time-series-placeholder\").html(\"<p>Loading...</p>\")\n     renderTimeSeries(container, tooltip, options)\n })",
                "deletions": 6
            },
            {
                "sha": "83ba78915946c04f2252ca27431c6cc9e59436c9",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.sidenav.js",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.sidenav.js",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.sidenav.js",
                "status": "modified",
                "changes": 9,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/assets/js/thirdeye.sidenav.js?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -89,17 +89,18 @@ $(document).ready(function() {\n     // n.b. This assumes a non-general function composition, for the sake of simplicity\n     // in integrating with the UI.\n     if (path.metricFunction) {\n-      var metricFunctionObj = parseMetricFunction(path.metricFunction)\n+      var metricFunctionObj = parseMetricFunction(decodeURIComponent(path.metricFunction))\n \n       // Always start at AGGREGATE\n       var tokens = metricFunctionObj.name.split(\"_\")\n       $(\"#sidenav-aggregate-size\").val(tokens[tokens.length - 2])\n       $(\"#sidenav-aggregate-unit\").val(tokens[tokens.length - 1])\n \n       // May have applied moving average as well\n-      if (typeof(metricFunctionObj.args[0]) === 'object') {\n-        metricFunctionObj = metricFunctionObj.args[0]\n-        if (metricFunctionObj.name && metricFunctionObj.name.indexOf(\"MOVING_AVERAGE\") >= 0) {\n+      var firstArg = metricFunctionObj.args[0]\n+      if (typeof(firstArg) === 'object') {\n+        if (firstArg.name && firstArg.name.indexOf(\"MOVING_AVERAGE\") >= 0) {\n+          metricFunctionObj = firstArg\n           var tokens = metricFunctionObj.name.split(\"_\")\n           $(\"#sidenav-moving-average\").attr('checked', 'checked')\n           $(\"#sidenav-moving-average-controls\").fadeIn(100)",
                "deletions": 4
            },
            {
                "sha": "57f8081aa01fa61879cb8f5e3165b77a8b0a560a",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dashboard.ftl",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dashboard.ftl",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dashboard.ftl",
                "status": "modified",
                "changes": 13,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dashboard.ftl?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -20,15 +20,20 @@\n                         <div class=\"uk-navbar-flip\">\n                             <ul class=\"uk-navbar-nav\">\n                                 <li class=\"uk-parent\" data-uk-dropdown>\n-                                    <a href=\"#dashboard-metric-view\">View</a>\n+                                    <a href=\"#dashboard-metric-view\">Metric</a>\n                                     <div class=\"uk-dropdown uk-dropdown-navbar\">\n-                                        <ul id=\"view-links\" class=\"uk-nav uk-nav-navbar\">\n-                                            <li class=\"uk-nav-header\">Metric</li>\n+                                        <ul class=\"view-links uk-nav uk-nav-navbar\">\n                                             <li><a href=\"#\" type=\"METRIC\" view=\"INTRA_DAY\">Intra-day</a></li>\n                                             <li><a href=\"#\" type=\"METRIC\" view=\"FUNNEL\">Funnel</a></li>\n                                             <li><a href=\"#\" type=\"METRIC\" view=\"TIME_SERIES_OVERLAY\">Series (Overlay)</a></li>\n                                             <li><a href=\"#\" type=\"METRIC\" view=\"TIME_SERIES_FULL\">Series (Full)</a></li>\n-                                            <li class=\"uk-nav-header\">Dimension</li>\n+                                        </ul>\n+                                    </div>\n+                                </li>\n+                                <li class=\"uk-parent\" data-uk-dropdown>\n+                                    <a href=\"#dashboard-metric-view\">Dimension</a>\n+                                    <div class=\"uk-dropdown uk-dropdown-navbar\">\n+                                        <ul class=\"view-links uk-nav uk-nav-navbar\">\n                                             <li><a href=\"#\" type=\"DIMENSION\" view=\"HEAT_MAP\">Heat Map</a></li>\n                                             <li><a href=\"#\" type=\"DIMENSION\" view=\"MULTI_TIME_SERIES\">Series (Multi)</a></li>\n                                         </ul>",
                "deletions": 4
            },
            {
                "sha": "9777319f6d5e0e922175eb1ce0a324ddf18efb07",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/heat-map.ftl",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/heat-map.ftl",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/heat-map.ftl",
                "status": "modified",
                "changes": 16,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/heat-map.ftl?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -1,11 +1,21 @@\n <script src=\"/assets/js/thirdeye.dimension.heatmap.js\"></script>\n \n-<div id=\"dimension-heat-map-buttons\" data-uk-button-radio>\n-    <button id=\"dimension-heat-map-button-volume\" class=\"uk-button\" type=\"button\">Volume</button>\n-    <button id=\"dimension-heat-map-button-contribution\" class=\"uk-button\" type=\"button\">Contribution</button>\n+<div id=\"dimension-heat-map-buttons\">\n+    <div class=\"uk-button-group\" data-uk-button-radio>\n+        <button id=\"dimension-heat-map-button-volume\" class=\"uk-button uk-active\" type=\"button\">Volume</button>\n+        <button id=\"dimension-heat-map-button-contribution\" class=\"uk-button\" type=\"button\">Contribution</button>\n+        <button id=\"dimension-heat-map-button-snapshot\" class=\"uk-button\" type=\"button\">Snapshot</button>\n+    </div>\n </div>\n \n+\n <div id=\"dimension-heat-map-area\">\n+    <#if (dimensionView.view.heatMaps?size == 0)>\n+        <div class=\"uk-alert uk-alert-warning\">\n+            <p>No data available</p>\n+        </div>\n+    </#if>\n+\n     <div id=\"dimension-heat-map-container\"></div>\n     <div id=\"dimension-heat-map-data\">\n         <#list dimensionView.view.heatMaps as heatMap>",
                "deletions": 3
            },
            {
                "sha": "6ab59f44576a14a9d62e446ee96cb1e31dee313b",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/multi-time-series.ftl",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/multi-time-series.ftl",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/multi-time-series.ftl",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/dimension/multi-time-series.ftl?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -1,7 +1,6 @@\n <script src=\"/assets/js/thirdeye.dimension.timeseries.js\"></script>\n \n <div id=\"dimension-time-series-buttons\">\n-    <button id=\"dimension-time-series-button-legend\" class=\"uk-button\" type=\"button\">Legend</button>\n     <button class=\"dimension-time-series-button-mode uk-button\" mode=\"same\" type=\"button\">Same</button>\n     <button class=\"dimension-time-series-button-mode uk-button\" mode=\"own\" type=\"button\">Own</button>\n </div>\n@@ -11,5 +10,6 @@\n         <h3 class=\"dimension-time-series-title\" dimension=\"${dimension}\"></h3>\n         <div class=\"dimension-time-series-placeholder\" dimension=\"${dimension}\"></div>\n         <div class=\"dimension-time-series-tooltip\" dimension=\"${dimension}\"></div>\n+        <div class=\"dimension-time-series-legend time-series-legend\" dimension=\"${dimension}\"></div>\n     </#list>\n </div>",
                "deletions": 1
            },
            {
                "sha": "8c8a27c0b9f45fdbcf51411b95f8cc41b03710b2",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/intra-day.ftl",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/intra-day.ftl",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/intra-day.ftl",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/intra-day.ftl?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -7,6 +7,12 @@\n <script src=\"/assets/js/thirdeye.metric.table.js\"></script>\n \n <div id=\"metric-table-area\">\n+    <#if (((metricView.view.metricTables)!metricTables)?size == 0)>\n+        <div class=\"uk-alert uk-alert-warning\">\n+            <p>No data available</p>\n+        </div>\n+    </#if>\n+\n     <#list (metricView.view.metricTables)!metricTables as metricTable>\n         <#assign dimensions = metricTable.dimensionValues>\n         <#include \"../common/dimension-header.ftl\">",
                "deletions": 0
            },
            {
                "sha": "b45e9edc767d9d9aa13bd6efbc535e89bc99b097",
                "filename": "thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/time-series.ftl",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/time-series.ftl",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/ed55988e5a02ad50a011856e94d1bd33d559c63c/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/time-series.ftl",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/thirdeye/thirdeye-dashboard/src/main/resources/com/linkedin/thirdeye/dashboard/views/metric/time-series.ftl?ref=ed55988e5a02ad50a011856e94d1bd33d559c63c",
                "patch": "@@ -7,7 +7,6 @@\n <script src=\"/assets/js/thirdeye.metric.timeseries.js\"></script>\n \n <div id=\"metric-time-series-buttons\" data-uk-button-radio>\n-    <button id=\"metric-time-series-button-legend\" class=\"uk-button\" type=\"button\">Legend</button>\n     <button class=\"metric-time-series-button-mode uk-button\" mode=\"same\" type=\"button\">Same</button>\n     <button class=\"metric-time-series-button-mode uk-button\" mode=\"own\" type=\"button\">Own</button>\n </div>\n@@ -18,4 +17,5 @@\n <div id=\"metric-time-series-area\">\n     <div id=\"metric-time-series-placeholder\"></div>\n     <div id=\"metric-time-series-tooltip\"></div>\n+    <div id=\"metric-time-series-legend\" class=\"time-series-legend\"></div>\n </div>",
                "deletions": 1
            }
        ]
    },
    {
        "repo": "incubator-pinot",
        "message": "Bug fixing for federated broker test.\n1. fix logic for RealtimeColumnDataSource set range predicate as for\nrealtime dictionary, dictId is from 1 to dictionary size.\n2. in MutableDictionaryReader, getString is also used for other data\ntype dictionary, so change it to toString().\n3. fixing  offline ColumnDataSourceImpl would set filteredBitMap to null\nin Range query, which actually should be an empty bitMap.\nThis is the root cause of DummyBlock get called.\n4. fixing NPE in HelixExternalViewBasedTimeBoundaryService.\n5. fixing time filter attching logic in BrokerRequestHandler for no\nfilter request.\n6. changing attached time filters' ids to -1 and -2 to avoid potiential\nduplicated.\n\nRB=453859\nR=xiafu\nA=kgopalak,jfim",
        "commit": "https://github.com/apache/incubator-pinot/commit/e29933810a701e2e8c4690465ccb8774a0324180",
        "parent": "https://github.com/apache/incubator-pinot/commit/2a3cfbb468cd58ca23fc6aebab5f7d8bcab31663",
        "bug_id": "incubator-pinot_91",
        "file": [
            {
                "sha": "c9ce11ce541a568c1e769ffc8a375469c8771477",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/response/ServerInstance.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-common/src/main/java/com/linkedin/pinot/common/response/ServerInstance.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-common/src/main/java/com/linkedin/pinot/common/response/ServerInstance.java",
                "status": "modified",
                "changes": 11,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/response/ServerInstance.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -48,6 +48,8 @@\n   /** IP Address. Not used in equals/hash-code generation **/\n   private final InetAddress _ipAddress;\n \n+  private final int _seq;\n+\n   /**\n    * Use this constructor if the name and port are embedded as string with \":\" as delimiter\n    *\n@@ -58,6 +60,10 @@ public ServerInstance(String namePortStr) {\n   }\n \n   public ServerInstance(String name, int port) {\n+    this(name, port, 0);\n+  }\n+\n+  public ServerInstance(String name, int port, int seq) {\n     super();\n     InetAddress ipAddr = null;\n     try {\n@@ -70,6 +76,7 @@ public ServerInstance(String name, int port) {\n     _ipAddress = ipAddr;\n     _hostname = _ipAddress != null ? _ipAddress.getHostName() : name;\n     _port = port;\n+    _seq = seq;\n   }\n \n   public String getHostname() {\n@@ -90,6 +97,7 @@ public int hashCode() {\n     int result = 1;\n     result = (prime * result) + (_hostname == null ? 0 : _hostname.hashCode());\n     result = (prime * result) + _port;\n+    result = (prime * result) + _seq;\n     return result;\n   }\n \n@@ -115,6 +123,9 @@ public boolean equals(Object obj) {\n     if (_port != other._port) {\n       return false;\n     }\n+    if (_seq != other._seq) {\n+      return false;\n+    }\n     return true;\n   }\n ",
                "deletions": 0
            },
            {
                "sha": "59a937fb2c86f2f4868ecb666230d532b5ebff01",
                "filename": "pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-common/src/main/java/com/linkedin/pinot/common/utils/request/RequestUtils.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -84,7 +84,7 @@ private static FilterQueryTree buildFilterQuery(Integer id, Map<Integer, FilterQ\n     List<Integer> children = q.getNestedFilterQueryIds();\n \n     List<FilterQueryTree> c = null;\n-    if (null != children) {\n+    if (null != children && !children.isEmpty()) {\n       c = new ArrayList<FilterQueryTree>();\n       for (final Integer i : children) {\n         final FilterQueryTree t = buildFilterQuery(i, queryMap);",
                "deletions": 1
            },
            {
                "sha": "16ff3fd2fb8659ee49dcb464c30233b89baf391b",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java",
                "status": "modified",
                "changes": 27,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/datasource/RealtimeColumnDataSource.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -37,6 +37,7 @@\n \n public class RealtimeColumnDataSource implements DataSource {\n \n+  private static final int REALTIME_DICTIONARY_INIT_ID = 1;\n   private final FieldSpec spec;\n   private final MutableDictionaryReader dictionary;\n   private final Map<Object, Pair<Long, Object>> docIdMap;\n@@ -165,7 +166,7 @@ public boolean setPredicate(Predicate predicate) {\n             notINHolder.or(invertedINdex.getDocIdSetFor(i));\n           }\n         }\n-\n+        filteredDocIdBitmap = notINHolder;\n         break;\n       case RANGE:\n         String rangeStart = \"\";\n@@ -187,24 +188,24 @@ public boolean setPredicate(Predicate predicate) {\n         final String upper = rangeString.split(\",\")[1].substring(0, rangeString.split(\",\")[1].length() - 1);\n \n         if (lower.equals(\"*\")) {\n-          rangeStart = dictionary.getString(0);\n+          rangeStart = dictionary.getString(REALTIME_DICTIONARY_INIT_ID);\n+          incLower = true;\n+        } else {\n+          rangeStart = lower;\n         }\n \n         if (upper.equals(\"*\")) {\n-          rangeEnd = dictionary.getString(dictionary.length() - 1);\n-        }\n-\n-        List<Integer> rangeCollector = new ArrayList<Integer>();\n-\n-        for (int i = 0; i < dictionary.length(); i++) {\n-          if (dictionary.inRange(rangeStart, rangeEnd, i, incLower, incUpper)) {\n-            rangeCollector.add(i);\n-          }\n+          rangeEnd = dictionary.getString(dictionary.length());\n+          incUpper = true;\n+        } else {\n+          rangeEnd = upper;\n         }\n \n         MutableRoaringBitmap rangeBitmap = new MutableRoaringBitmap();\n-        for (Integer dicId : rangeCollector) {\n-          rangeBitmap.or(invertedINdex.getDocIdSetFor(dicId));\n+        for (int dicId = 1; dicId <= dictionary.length(); dicId++) {\n+          if (dictionary.inRange(rangeStart, rangeEnd, dicId, incLower, incUpper)) {\n+            rangeBitmap.or(invertedINdex.getDocIdSetFor(dicId));\n+          }\n         }\n \n         filteredDocIdBitmap = rangeBitmap;",
                "deletions": 13
            },
            {
                "sha": "aa908b576b48227dda2033e60aae3f60a580646f",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/dictionary/MutableDictionaryReader.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/dictionary/MutableDictionaryReader.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/dictionary/MutableDictionaryReader.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/realtime/impl/dictionary/MutableDictionaryReader.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -66,7 +66,7 @@ public int getInt(int dictionaryId) {\n \n   @Override\n   public String getString(int dictionaryId) {\n-    return ((String) dictionaryIdBiMap.get(new Integer(dictionaryId)));\n+    return dictionaryIdBiMap.get(new Integer(dictionaryId)).toString();\n   }\n \n   @Override",
                "deletions": 1
            },
            {
                "sha": "041274423368957a561579e5decf49ab13eab1c1",
                "filename": "pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/data/source/ColumnDataSourceImpl.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/data/source/ColumnDataSourceImpl.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/data/source/ColumnDataSourceImpl.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-core/src/main/java/com/linkedin/pinot/core/segment/index/data/source/ColumnDataSourceImpl.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -125,7 +125,6 @@ public boolean setPredicate(Predicate p) {\n             holderNEQ.or(invertedIndex.getImmutable(i));\n           }\n         }\n-\n         filteredBitmap = holderNEQ;\n         break;\n       case IN:\n@@ -202,7 +201,8 @@ public boolean setPredicate(Predicate p) {\n         }\n \n         if (rangeStartIndex > rangeEndIndex) {\n-          return false;\n+          filteredBitmap = new MutableRoaringBitmap();\n+          return true;\n         }\n \n         final MutableRoaringBitmap rangeBitmapHolder = invertedIndex.getMutable(rangeStartIndex);",
                "deletions": 2
            },
            {
                "sha": "215855402a8eb9ab48951ac782fe04b097b3498a",
                "filename": "pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java",
                "status": "modified",
                "changes": 57,
                "additions": 33,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-transport/src/main/java/com/linkedin/pinot/requestHandler/BrokerRequestHandler.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -186,37 +186,44 @@ private BrokerRequest getRealtimeBrokerRequest(BrokerRequest request) {\n   }\n \n   private void attachTimeBoundary(String hybridResourceName, BrokerRequest offlineRequest, boolean isOfflineRequest) {\n-    TimeBoundaryInfo timeBoundaryInfo = _timeBoundaryService.getTimeBoundaryInfoFor(hybridResourceName);\n+    TimeBoundaryInfo timeBoundaryInfo = _timeBoundaryService.getTimeBoundaryInfoFor(\n+        BrokerRequestUtils.getOfflineResourceNameForResource(hybridResourceName));\n     if (timeBoundaryInfo == null || timeBoundaryInfo.getTimeColumn() == null || timeBoundaryInfo.getTimeValue() == null) {\n       return;\n     }\n     FilterQuery timeFilterQuery = new FilterQuery();\n     timeFilterQuery.setOperator(FilterOperator.RANGE);\n     timeFilterQuery.setColumn(timeBoundaryInfo.getTimeColumn());\n+    timeFilterQuery.setNestedFilterQueryIds(new ArrayList<Integer>());\n     List<String> values = new ArrayList<String>();\n     if (isOfflineRequest) {\n       values.add(\"(*,\" + timeBoundaryInfo.getTimeValue() + \")\");\n     } else {\n-      values.add(\"[\" + timeBoundaryInfo.getTimeValue() + \", *)\");\n+      values.add(\"[\" + timeBoundaryInfo.getTimeValue() + \",*)\");\n     }\n     timeFilterQuery.setValue(values);\n+    timeFilterQuery.setId(-1);\n     FilterQuery currentFilterQuery = offlineRequest.getFilterQuery();\n-\n-    FilterQuery andFilterQuery = new FilterQuery();\n-    andFilterQuery.setOperator(FilterOperator.AND);\n-    List<Integer> nestedFilterQueryIds = new ArrayList<Integer>();\n-    nestedFilterQueryIds.add(currentFilterQuery.getId());\n-    nestedFilterQueryIds.add(timeFilterQuery.getId());\n-    andFilterQuery.setNestedFilterQueryIds(nestedFilterQueryIds);\n-    andFilterQuery.setId(andFilterQuery.hashCode());\n-\n-    FilterQueryMap filterSubQueryMap = offlineRequest.getFilterSubQueryMap();\n-\n-    filterSubQueryMap.putToFilterQueryMap(timeFilterQuery.getId(), timeFilterQuery);\n-    filterSubQueryMap.putToFilterQueryMap(andFilterQuery.getId(), andFilterQuery);\n-\n-    offlineRequest.setFilterQuery(andFilterQuery);\n-    offlineRequest.setFilterSubQueryMap(filterSubQueryMap);\n+    if (currentFilterQuery != null) {\n+      FilterQuery andFilterQuery = new FilterQuery();\n+      andFilterQuery.setOperator(FilterOperator.AND);\n+      List<Integer> nestedFilterQueryIds = new ArrayList<Integer>();\n+      nestedFilterQueryIds.add(currentFilterQuery.getId());\n+      nestedFilterQueryIds.add(timeFilterQuery.getId());\n+      andFilterQuery.setNestedFilterQueryIds(nestedFilterQueryIds);\n+      andFilterQuery.setId(-2);\n+      FilterQueryMap filterSubQueryMap = offlineRequest.getFilterSubQueryMap();\n+      filterSubQueryMap.putToFilterQueryMap(timeFilterQuery.getId(), timeFilterQuery);\n+      filterSubQueryMap.putToFilterQueryMap(andFilterQuery.getId(), andFilterQuery);\n+\n+      offlineRequest.setFilterQuery(andFilterQuery);\n+      offlineRequest.setFilterSubQueryMap(filterSubQueryMap);\n+    } else {\n+      FilterQueryMap filterSubQueryMap = new FilterQueryMap();\n+      filterSubQueryMap.putToFilterQueryMap(timeFilterQuery.getId(), timeFilterQuery);\n+      offlineRequest.setFilterQuery(timeFilterQuery);\n+      offlineRequest.setFilterSubQueryMap(filterSubQueryMap);\n+    }\n   }\n \n   private Object getDataTableFromBrokerRequest(final BrokerRequest request, BucketingSelection overriddenSelection)\n@@ -225,7 +232,7 @@ private Object getDataTableFromBrokerRequest(final BrokerRequest request, Bucket\n     final long routingStartTime = System.nanoTime();\n     RoutingTableLookupRequest rtRequest = new RoutingTableLookupRequest(request.getQuerySource().getResourceName());\n     Map<ServerInstance, SegmentIdSet> segmentServices = _routingTable.findServers(rtRequest);\n-    if (segmentServices == null) {\n+    if (segmentServices == null || segmentServices.isEmpty()) {\n       LOGGER.info(\"Not found ServerInstances to Segments Mapping:\");\n       return null;\n     }\n@@ -320,11 +327,11 @@ private Object getDataTableFromBrokerRequestList(final BrokerRequest federatedBr\n       final long routingStartTime = System.nanoTime();\n       RoutingTableLookupRequest rtRequest = new RoutingTableLookupRequest(request.getQuerySource().getResourceName());\n       Map<ServerInstance, SegmentIdSet> segmentServices = _routingTable.findServers(rtRequest);\n-      if (segmentServices == null) {\n-        LOGGER.info(\"Not found ServerInstances to Segments Mapping:\");\n-        return null;\n+      if (segmentServices == null || segmentServices.isEmpty()) {\n+        LOGGER.info(\"Not found ServerInstances to Segments Mapping for resource - \" + rtRequest.getResourceName());\n+        continue;\n       }\n-      LOGGER.info(\"Find ServerInstances to Segments Mapping:\");\n+      LOGGER.info(\"Find ServerInstances to Segments Mapping for resource - \" + rtRequest.getResourceName());\n       for (ServerInstance serverInstance : segmentServices.keySet()) {\n         LOGGER.info(serverInstance + \" : \" + segmentServices.get(serverInstance));\n       }\n@@ -363,6 +370,7 @@ private Object getDataTableFromBrokerRequestList(final BrokerRequest federatedBr\n         Map<ServerInstance, Throwable> errors = response.getError();\n \n         if (null != responses) {\n+          int responseSeq = 0;\n           for (Entry<ServerInstance, ByteBuf> e : responses.entrySet()) {\n             try {\n               ByteBuf b = e.getValue();\n@@ -372,8 +380,9 @@ private Object getDataTableFromBrokerRequestList(final BrokerRequest federatedBr\n               }\n               b.readBytes(b2);\n               DataTable r2 = new DataTable(b2);\n+              // Hybrid requests may get response from same instance, so we need to distinguish them.\n               ServerInstance decoratedServerInstance =\n-                  new ServerInstance(e.getKey().getHostname() + \"_\" + request.hashCode(), e.getKey().getPort());\n+                  new ServerInstance(e.getKey().getHostname(), e.getKey().getPort(), (responseSeq++));\n               instanceResponseMap.put(decoratedServerInstance, r2);\n             } catch (Exception ex) {\n               LOGGER.error(\"Got exceptions in collect query result for instance \" + e.getKey() + \", error: \"",
                "deletions": 24
            },
            {
                "sha": "d57635109238aa5fc6f347763beb1e81672d8c1d",
                "filename": "pinot-transport/src/main/java/com/linkedin/pinot/routing/HelixExternalViewBasedTimeBoundaryService.java",
                "blob_url": "https://github.com/apache/incubator-pinot/blob/e29933810a701e2e8c4690465ccb8774a0324180/pinot-transport/src/main/java/com/linkedin/pinot/routing/HelixExternalViewBasedTimeBoundaryService.java",
                "raw_url": "https://github.com/apache/incubator-pinot/raw/e29933810a701e2e8c4690465ccb8774a0324180/pinot-transport/src/main/java/com/linkedin/pinot/routing/HelixExternalViewBasedTimeBoundaryService.java",
                "status": "modified",
                "changes": 7,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/incubator-pinot/contents/pinot-transport/src/main/java/com/linkedin/pinot/routing/HelixExternalViewBasedTimeBoundaryService.java?ref=e29933810a701e2e8c4690465ccb8774a0324180",
                "patch": "@@ -58,17 +58,14 @@ public synchronized void updateTimeBoundaryService(ExternalView externalView) {\n     OfflineDataResourceZKMetadata offlineDataResourceZKMetadata = ZKMetadataProvider.getOfflineResourceZKMetadata(_propertyStore, resourceName);\n     TimeUnit resourceTimeUnit = getTimeUnitFromString(offlineDataResourceZKMetadata.getTimeType());\n \n-    if (offlineSegmentZKMetadatas.get(0).getTimeUnit() != null) {\n+    if (!offlineSegmentZKMetadatas.isEmpty() && offlineSegmentZKMetadatas.get(0).getTimeUnit() != null) {\n       long maxTimeValue = -1;\n       for (OfflineSegmentZKMetadata offlineSegmentZKMetadata : offlineSegmentZKMetadatas) {\n         long endTime = resourceTimeUnit.convert(offlineSegmentZKMetadata.getEndTime(), offlineSegmentZKMetadata.getTimeUnit());\n-        if (maxTimeValue < endTime) {\n-          maxTimeValue = endTime;\n-        }\n+        maxTimeValue = Math.max(maxTimeValue, endTime);\n       }\n \n       TimeBoundaryInfo timeBoundaryInfo = new TimeBoundaryInfo();\n-      offlineDataResourceZKMetadata.getTimeType();\n       timeBoundaryInfo.setTimeColumn(offlineDataResourceZKMetadata.getTimeColumnName());\n       timeBoundaryInfo.setTimeValue(Long.toString(maxTimeValue));\n       _timeBoundaryInfoMap.put(resourceName, timeBoundaryInfo);",
                "deletions": 5
            }
        ]
    }
]