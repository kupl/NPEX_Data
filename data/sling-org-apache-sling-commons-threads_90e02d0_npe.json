[
    {
        "repo": "sling-org-apache-sling-commons-threads",
        "commit": "https://github.com/apache/sling-org-apache-sling-commons-threads/commit/90e02d020644ef1a2b5852171a59c6cbe84f5857",
        "bug_id": "sling-org-apache-sling-commons-threads_90e02d0",
        "message": "SLING-7526 - NPE in DefaultThreadPool$LoggingThreadLocalChangeListener.changed\n\nOnly generate the (relatively expensive) ThreadLocal diff events if the\nlistener is actually enabled.",
        "parent": "https://github.com/apache/sling-org-apache-sling-commons-threads/commit/830c606b753def2b78f2ac9f9f334e3182068455",
        "patched_files": [
            "ThreadLocalCleaner.java",
            "DefaultThreadPool.java",
            "ThreadLocalChangeListener.java",
            "ThreadPoolExecutorCleaningThreadLocals.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 5,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/raw/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/main/java/org/apache/sling/commons/threads/impl/DefaultThreadPool.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-commons-threads/contents/src/main/java/org/apache/sling/commons/threads/impl/DefaultThreadPool.java?ref=90e02d020644ef1a2b5852171a59c6cbe84f5857",
                "filename": "src/main/java/org/apache/sling/commons/threads/impl/DefaultThreadPool.java",
                "deletions": 0,
                "sha": "e60cf9706506998888217cb6237c4c941812e856",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/blob/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/main/java/org/apache/sling/commons/threads/impl/DefaultThreadPool.java",
                "patch": "@@ -172,6 +172,11 @@ public void changed(Mode mode, Thread thread, ThreadLocal<?> threadLocal, Object\n             LOGGER.debug(\"Thread '{}' {} ThreadLocal {} with value {}\", thread, mode, \n                     threadLocal != null ? threadLocal.getClass() : \"<null>\", value);\n         }\n+        \n+        @Override\n+        public boolean isEnabled() {\n+            return LOGGER.isDebugEnabled();\n+        }\n     }\n \n     /**",
                "changes": 5
            },
            {
                "status": "modified",
                "additions": 2,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/raw/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalChangeListener.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-commons-threads/contents/src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalChangeListener.java?ref=90e02d020644ef1a2b5852171a59c6cbe84f5857",
                "filename": "src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalChangeListener.java",
                "deletions": 0,
                "sha": "72237dadbf4c7fc3c4f8f97ccc1e2e0e06b06fc3",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/blob/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalChangeListener.java",
                "patch": "@@ -39,6 +39,8 @@\n      */\n     \n     void changed(Mode mode, Thread thread, ThreadLocal<?> threadLocal, Object value);\n+    \n+    boolean isEnabled();\n \n     enum Mode {\n         ADDED, REMOVED",
                "changes": 2
            },
            {
                "status": "modified",
                "additions": 4,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/raw/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalCleaner.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-commons-threads/contents/src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalCleaner.java?ref=90e02d020644ef1a2b5852171a59c6cbe84f5857",
                "filename": "src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalCleaner.java",
                "deletions": 2,
                "sha": "5db69eca1f7f764d1b2859547273205b25df9422",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/blob/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalCleaner.java",
                "patch": "@@ -145,8 +145,10 @@ public ThreadLocalCleaner(ThreadLocalChangeListener listener) {\n \n     public void cleanup() {\n         // the first two diff calls are only to notify the listener, the actual cleanup is done by restoreOldThreadLocals\n-        diff(threadLocalsField, threadLocalsCopy.references);\n-        diff(inheritableThreadLocalsField, inheritableThreadLocalsCopy.references);\n+        if ( listener.isEnabled() ) {\n+            diff(threadLocalsField, threadLocalsCopy.references);\n+            diff(inheritableThreadLocalsField, inheritableThreadLocalsCopy.references);\n+        }\n         restoreOldThreadLocals();\n     }\n ",
                "changes": 6
            },
            {
                "status": "modified",
                "additions": 1,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/raw/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/test/java/org/apache/sling/commons/threads/impl/ThreadPoolExecutorCleaningThreadLocalsTest.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-commons-threads/contents/src/test/java/org/apache/sling/commons/threads/impl/ThreadPoolExecutorCleaningThreadLocalsTest.java?ref=90e02d020644ef1a2b5852171a59c6cbe84f5857",
                "filename": "src/test/java/org/apache/sling/commons/threads/impl/ThreadPoolExecutorCleaningThreadLocalsTest.java",
                "deletions": 0,
                "sha": "8ceff1f0a1525d569fe4964dba9c360e35c24233",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-commons-threads/blob/90e02d020644ef1a2b5852171a59c6cbe84f5857/src/test/java/org/apache/sling/commons/threads/impl/ThreadPoolExecutorCleaningThreadLocalsTest.java",
                "patch": "@@ -54,6 +54,7 @@ public void setUp() {\n         pool = new ThreadPoolExecutorCleaningThreadLocals(\n                     1, 1, 100, TimeUnit.MILLISECONDS,\n                     queue, Executors.defaultThreadFactory(), rejectionHandler, listener);\n+        Mockito.when(listener.isEnabled()).thenReturn(true);\n     }\n     \n     @Test(timeout = 10000)",
                "changes": 1
            }
        ],
        "unit_tests": [
            "ThreadPoolExecutorCleaningThreadLocalsTest.java",
            "DefaultThreadPoolTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "src/test/java/org/apache/sling/commons/threads/impl/ThreadPoolExecutorCleaningThreadLocalsTest.java",
        "buggy_files": [
            "src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalCleaner.java",
            "src/main/java/org/apache/sling/commons/threads/impl/DefaultThreadPool.java",
            "src/main/java/org/apache/sling/commons/threads/impl/ThreadLocalChangeListener.java",
            "src/main/java/org/apache/sling/commons/threads/impl/ThreadPoolExecutorCleaningThreadLocals.java"
        ],
        "fixed": true
    }
]