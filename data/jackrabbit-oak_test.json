{
    "jackrabbit-oak_ad39877": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7289: RDBDocumentStore: potential NPE in error handling code\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1825442 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ad39877cbf8a55a93636f8c356ab29201290921c",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/8a90e73d23ab1b4fe07fca92d64c395e95921969",
        "bug_id": "jackrabbit-oak_ad39877",
        "file": [
            {
                "sha": "96d04b76d42b872e3b0017740d26d83786f2cfbf",
                "filename": "oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad39877cbf8a55a93636f8c356ab29201290921c/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad39877cbf8a55a93636f8c356ab29201290921c/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java?ref=ad39877cbf8a55a93636f8c356ab29201290921c",
                "patch": "@@ -1949,7 +1949,7 @@ public void close() throws IOException {\n         } catch (SQLException ex) {\n             this.ch.rollbackConnection(connection);\n             String addDiags = \"\";\n-            if (RDBJDBCTools.matchesSQLState(ex, \"22\", \"72\")) {\n+            if (data != null && RDBJDBCTools.matchesSQLState(ex, \"22\", \"72\")) {\n                 byte[] bytes = asBytes(data);\n                 addDiags = String.format(\" (DATA size in Java characters: %d, in octets: %d, computed character limit: %d)\",\n                         data.length(), bytes.length, tmd.getDataLimitInOctets() / CHAR2OCTETRATIO);\n@@ -2058,7 +2058,7 @@ private static long getModifiedFromOperation(Operation op) {\n     private static final boolean BATCHUPDATES = Boolean.parseBoolean(System\n             .getProperty(\"org.apache.jackrabbit.oak.plugins.document.rdb.RDBDocumentStore.BATCHUPDATES\", \"true\"));\n \n-    public static byte[] asBytes(String data) {\n+    public static byte[] asBytes(@Nonnull String data) {\n         byte[] bytes;\n         try {\n             bytes = data.getBytes(\"UTF-8\");",
                "deletions": 2
            }
        ],
        "patched_files": [
            "RDBDocumentStore.java"
        ],
        "unit_tests": [
            "RDBDocumentStoreTest.java"
        ]
    },
    "jackrabbit-oak_d074fc8": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4107 : avoid NPE when db.serverStatus.localTime returns null - even though that is unexpected - just issue a WARN then\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1740462 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/d074fc8e1a74dfa4c163dad625f224cd73bc92fb",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/fc2da6a8eb7406d173ffab922742c77617c47795",
        "bug_id": "jackrabbit-oak_d074fc8",
        "file": [
            {
                "sha": "971954b5c3343d8f9ce89f825321c05849e03b85",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d074fc8e1a74dfa4c163dad625f224cd73bc92fb/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d074fc8e1a74dfa4c163dad625f224cd73bc92fb/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java",
                "status": "modified",
                "changes": 8,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java?ref=d074fc8e1a74dfa4c163dad625f224cd73bc92fb",
                "patch": "@@ -1565,6 +1565,14 @@ public long determineServerTimeDifferenceMillis() {\n         // assumption here: server returns UTC - ie the returned\n         // date object is correctly taking care of time zones.\n         final Date serverLocalTime = db.command(\"serverStatus\").getDate(\"localTime\");\n+        if (serverLocalTime == null) {\n+        \t// OAK-4107 : looks like this can happen - at least\n+        \t// has been seen once on mongo 3.0.9\n+        \t// let's handle this gently and issue a log.warn\n+        \t// instead of throwing a NPE\n+        \tLOG.warn(\"determineServerTimeDifferenceMillis: db.serverStatus.localTime returned null - cannot determine time difference - assuming 0ms\");\n+        \treturn 0;\n+        }\n         final long end = System.currentTimeMillis();\n \n         final long midPoint = (start + end) / 2;",
                "deletions": 0
            }
        ],
        "patched_files": [
            "MongoDocumentStore.java"
        ],
        "unit_tests": [
            "MongoDocumentStoreTest.java"
        ]
    },
    "jackrabbit-oak_00ab785": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4998: NPE when starting Oak Console\nAlign test expectations with fix from OAK-5002\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766549 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/00ab785367a8b9c191165811cb1371d8491a4bd0",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc",
        "bug_id": "jackrabbit-oak_00ab785",
        "file": [
            {
                "sha": "db175c7ec2df5950ff9aac209408cb94e5c24a40",
                "filename": "oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/00ab785367a8b9c191165811cb1371d8491a4bd0/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/00ab785367a8b9c191165811cb1371d8491a4bd0/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java?ref=00ab785367a8b9c191165811cb1371d8491a4bd0",
                "patch": "@@ -47,7 +47,7 @@ public void testReadWrite() throws IOException, CommitFailedException {\n         }\n     }\n \n-    @Test\n+    @Test(expected = UnsupportedOperationException.class)\n     @Ignore(\"OAK-4998\")  // FIXME OAK-4998\n     public void testReadOnly()\n     throws IOException, CommitFailedException, InvalidFileStoreVersionException {",
                "deletions": 1
            }
        ],
        "patched_files": [
            "SegmentTarFixture.java"
        ],
        "unit_tests": [
            "SegmentTarFixtureTest.java"
        ]
    },
    "jackrabbit-oak_1a2a484": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1218: NPE in PrincipalManagerTest#testMembers\n@Ignore failing test\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1545198 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/1a2a484a41e592d7df42c4ab58dcc540e0cc141b",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/1362f1282a3f99e2655427c489bec00bec03827d",
        "bug_id": "jackrabbit-oak_1a2a484",
        "file": [
            {
                "sha": "c75d9fda6d273d25d956d9bc1977de2daeee427e",
                "filename": "oak-jcr/pom.xml",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1a2a484a41e592d7df42c4ab58dcc540e0cc141b/oak-jcr/pom.xml",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1a2a484a41e592d7df42c4ab58dcc540e0cc141b/oak-jcr/pom.xml",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/pom.xml?ref=1a2a484a41e592d7df42c4ab58dcc540e0cc141b",
                "patch": "@@ -170,6 +170,8 @@\n \n       <!-- Node Types -->\n       org.apache.jackrabbit.oak.jcr.nodetype.MixinTest#testRemoveAddMixVersionable1                  <!-- OAK-1118 -->\n+\n+      org.apache.jackrabbit.oak.jcr.security.principal.PrincipalManagerTest#testMembers              <!-- OAK-1218 -->\n     </known.issues>\n   </properties>\n ",
                "deletions": 0
            },
            {
                "sha": "a2e33e0e9cee04ceb94246c2dd4d44b29d2dc705",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1a2a484a41e592d7df42c4ab58dcc540e0cc141b/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1a2a484a41e592d7df42c4ab58dcc540e0cc141b/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java?ref=1a2a484a41e592d7df42c4ab58dcc540e0cc141b",
                "patch": "@@ -175,6 +175,7 @@ public void testGetAllPrincipals() {\n     }\n \n     @Test\n+    // FIXME See OAK-1218\n     public void testMembers() {\n         PrincipalIterator it = principalMgr.getPrincipals(PrincipalManager.SEARCH_TYPE_ALL);\n         while (it.hasNext()) {",
                "deletions": 0
            },
            {
                "sha": "fb09228f43d59034b4ea69ea75ff9fe4af12f54d",
                "filename": "oak-parent/pom.xml",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1a2a484a41e592d7df42c4ab58dcc540e0cc141b/oak-parent/pom.xml",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1a2a484a41e592d7df42c4ab58dcc540e0cc141b/oak-parent/pom.xml",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-parent/pom.xml?ref=1a2a484a41e592d7df42c4ab58dcc540e0cc141b",
                "patch": "@@ -156,7 +156,6 @@\n               <segment.db>${segment.db}</segment.db>\n             </systemPropertyVariables>\n             <redirectTestOutputToFile>true</redirectTestOutputToFile>\n-            <useFile>false</useFile>  <!-- FIXME remove again: put her to diagnose test failure on Buildbot -->\n           </configuration>\n         </plugin>\n         <plugin>",
                "deletions": 1
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "PrincipalManagerTest.java"
        ]
    },
    "jackrabbit-oak_5f36b76": {
        "repo": "jackrabbit-oak",
        "message": "OAK-5107 : avoid NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1769682 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5f36b76a6174d3163fdc4b23e667a2cb68896923",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/404602df60b3c38b0d0ff1ccdeb5830c7865b76d",
        "bug_id": "jackrabbit-oak_5f36b76",
        "file": [
            {
                "sha": "d93b6e9d4d5492b80ae0d241cedcfb99dfbb81a0",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/ChangeSetFilterImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5f36b76a6174d3163fdc4b23e667a2cb68896923/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/ChangeSetFilterImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5f36b76a6174d3163fdc4b23e667a2cb68896923/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/ChangeSetFilterImpl.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/ChangeSetFilterImpl.java?ref=5f36b76a6174d3163fdc4b23e667a2cb68896923",
                "patch": "@@ -87,7 +87,8 @@ private Pattern asPattern(String patternWithGlobs) {\n \n     @Override\n     public boolean excludes(ChangeSet changeSet) {\n-        final Set<String> parentPaths = new HashSet<String>(changeSet.getParentPaths());\n+        final Set<String> cpp = changeSet.getParentPaths();\n+        final Set<String> parentPaths = cpp != null ? new HashSet<String>(cpp) : new HashSet<String>();\n \n         // first go through excludes to remove those that are explicitly\n         // excluded",
                "deletions": 1
            }
        ],
        "patched_files": [
            "ChangeSetFilterImpl.java"
        ],
        "unit_tests": [
            "ChangeSetFilterImplTest.java"
        ]
    },
    "jackrabbit-oak_8489fc4": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7513 - avoid NPE in exact size calculation, adjusted some log statements\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1832379 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/8489fc4bd3591a7664b39627e689d162313a1c40",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/99bcde9a7a9192ac8ff93473bf8d0c1086627045",
        "bug_id": "jackrabbit-oak_8489fc4",
        "file": [
            {
                "sha": "8b8a0ee6884fd3cc8caa72d3f3d8a9314c49400a",
                "filename": "oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/configuration/nodestate/NodeStateSolrServersObserver.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/8489fc4bd3591a7664b39627e689d162313a1c40/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/configuration/nodestate/NodeStateSolrServersObserver.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/8489fc4bd3591a7664b39627e689d162313a1c40/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/configuration/nodestate/NodeStateSolrServersObserver.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/configuration/nodestate/NodeStateSolrServersObserver.java?ref=8489fc4bd3591a7664b39627e689d162313a1c40",
                "patch": "@@ -117,7 +117,6 @@ public boolean childNodeDeleted(String name, NodeState before) {\n         }\n \n         private boolean isSolrServerNode(String name, NodeState nodeState) {\n-            log.info(\"checking {} in {}\", name, nodeState);\n             return \"server\".equals(name) && nodeState.hasProperty(\"solrServerType\");\n         }\n ",
                "deletions": 1
            },
            {
                "sha": "625bb86a8a6737c0060f5fdbef8d4600e29a2c55",
                "filename": "oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/FilterQueryParser.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/8489fc4bd3591a7664b39627e689d162313a1c40/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/FilterQueryParser.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/8489fc4bd3591a7664b39627e689d162313a1c40/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/FilterQueryParser.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/FilterQueryParser.java?ref=8489fc4bd3591a7664b39627e689d162313a1c40",
                "patch": "@@ -65,8 +65,8 @@ static SolrQuery getQuery(Filter filter, QueryIndex.IndexPlan plan, OakSolrConfi\n             }\n         }\n \n-        List<QueryIndex.OrderEntry> sortOrder = plan.getSortOrder();\n-        if (sortOrder != null) {\n+        if (plan != null && plan.getSortOrder() != null) {\n+            List<QueryIndex.OrderEntry> sortOrder = plan.getSortOrder();\n             for (QueryIndex.OrderEntry orderEntry : sortOrder) {\n                 SolrQuery.ORDER order;\n                 if (QueryIndex.OrderEntry.Order.ASCENDING.equals(orderEntry.getOrder())) {",
                "deletions": 2
            },
            {
                "sha": "99c0d4a54d58f28b169df55e9c25e1626c3d5a93",
                "filename": "oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrQueryIndex.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/8489fc4bd3591a7664b39627e689d162313a1c40/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrQueryIndex.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/8489fc4bd3591a7664b39627e689d162313a1c40/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrQueryIndex.java",
                "status": "modified",
                "changes": 18,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrQueryIndex.java?ref=8489fc4bd3591a7664b39627e689d162313a1c40",
                "patch": "@@ -152,7 +152,7 @@ int getMatchingFilterRestrictions(Filter filter, OakSolrConfiguration configurat\n                 match++;\n             }\n         }\n-\n+        log.debug(\"{}\u00a0matched restrictions for filter {} and configuration {}\", match, filter, configuration);\n \n         return match;\n     }\n@@ -587,12 +587,14 @@ private OakSolrConfiguration getConfiguration(String path, NodeState rootState)\n     private IndexPlan getIndexPlan(Filter filter, OakSolrConfiguration configuration, LMSEstimator estimator,\n                                    List<OrderEntry> sortOrder, String path) {\n         if (getMatchingFilterRestrictions(filter, configuration) > 0) {\n-            return planBuilder(filter)\n-                    .setEstimatedEntryCount(estimator.estimate(filter))\n-                    .setSortOrder(sortOrder)\n-                    .setPlanName(path)\n-                    .setPathPrefix(getPathPrefix(path))\n-                    .build();\n+            IndexPlan indexPlan = planBuilder(filter)\n+                .setEstimatedEntryCount(estimator.estimate(filter))\n+                .setSortOrder(sortOrder)\n+                .setPlanName(path)\n+                .setPathPrefix(getPathPrefix(path))\n+                .build();\n+            log.debug(\"index plan {}\", indexPlan);\n+            return indexPlan;\n         } else {\n             return null;\n         }\n@@ -792,7 +794,7 @@ public long getSize(SizePrecision precision, long max) {\n             switch (precision) {\n                 case EXACT:\n                     // query solr\n-                    SolrQuery countQuery = FilterQueryParser.getQuery(plan.getFilter(), null, this.configuration);\n+                    SolrQuery countQuery = FilterQueryParser.getQuery(plan.getFilter(), plan, this.configuration);\n                     countQuery.setRows(0);\n                     try {\n                         estimate = this.solrServer.query(countQuery).getResults().getNumFound();",
                "deletions": 8
            }
        ],
        "patched_files": [
            "SolrQueryIndex.java",
            "FilterQueryParser.java"
        ],
        "unit_tests": [
            "FilterQueryParserTest.java",
            "SolrQueryIndexTest.java"
        ]
    },
    "jackrabbit-oak_0c10969": {
        "repo": "jackrabbit-oak",
        "message": "OAK-5738: Potential NPE in LargeLdapProviderTest\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1783855 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/0c10969b0aa84a8e916cc5c377659761ed761862",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/b104f429250bd1c5f88c0715b80f2d711078a15a",
        "bug_id": "jackrabbit-oak_0c10969",
        "file": [
            {
                "sha": "2105ae4bf6a176f6446e2de08d24e7062a02d969",
                "filename": "oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LargeLdapProviderTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0c10969b0aa84a8e916cc5c377659761ed761862/oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LargeLdapProviderTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0c10969b0aa84a8e916cc5c377659761ed761862/oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LargeLdapProviderTest.java",
                "status": "modified",
                "changes": 6,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LargeLdapProviderTest.java?ref=0c10969b0aa84a8e916cc5c377659761ed761862",
                "patch": "@@ -95,8 +95,10 @@ public void after() throws Exception {\n         if (!USE_COMMON_LDAP_FIXTURE) {\n             LDAP_SERVER.tearDown();\n         }\n-        idp.close();\n-        idp = null;\n+        if (idp != null) {\n+            idp.close();\n+            idp = null;\n+        }\n     }\n \n     protected LdapIdentityProvider createIDP() {",
                "deletions": 2
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "LargeLdapProviderTest.java"
        ]
    },
    "jackrabbit-oak_7a00410": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6229: NPE when running datastorecheck command with S3\n\n- Added cleanup for S3 & Azure tests\n- Changed readme to reflect the latest aws version\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1795491 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/7a00410e55ee9226e4401f95225c4c784737e13a",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/5de3a8abc0f35dc90f47dd0ba85eac961e95a617",
        "bug_id": "jackrabbit-oak_7a00410",
        "file": [
            {
                "sha": "9c4ec537e84b081213596caf472db33ecd58d09c",
                "filename": "oak-run/README.md",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7a00410e55ee9226e4401f95225c4c784737e13a/oak-run/README.md",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7a00410e55ee9226e4401f95225c4c784737e13a/oak-run/README.md",
                "status": "modified",
                "changes": 5,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/README.md?ref=7a00410e55ee9226e4401f95225c4c784737e13a",
                "patch": "@@ -475,12 +475,11 @@ The following options are available:\n Note:\n For using S3DataStore the following additional jars have to be downloaded\n     - [commons-logging-1.1.3.jar](http://central.maven.org/maven2/commons-logging/commons-logging/1.1.3/commons-logging-1.1.3.jar)\n-    - [httpcore-4.4.4.jar](http://central.maven.org/maven2/org/apache/httpcomponents/httpcore/4.4.4/httpcore-4.4.4.jar)\n-    - [aws-java-sdk-osgi-1.10.76.jar](http://central.maven.org/maven2/com/amazonaws/aws-java-sdk-osgi/1.10.76/aws-java-sdk-osgi-1.10.76.jar)\n+    - [aws-java-sdk-osgi-1.11.24.jar](http://central.maven.org/maven2/com/amazonaws/aws-java-sdk-osgi/1.11.24/aws-java-sdk-osgi-1.11.24.jar)\n     \n The command to be executed for S3DataStore\n \n-    java -classpath oak-run-*.jar:httpcore-4.4.4.jar:aws-java-sdk-osgi-1.10.76.jar:commons-logging-1.1.3.jar \\\n+    java -classpath oak-run-*.jar:aws-java-sdk-osgi-1.11.24.jar:commons-logging-1.1.3.jar \\\n         org.apache.jackrabbit.oak.run.Main \\\n         datastorecheck --id --ref --consistency \\\n         --store <path>|<mongo_uri> \\",
                "deletions": 3
            },
            {
                "sha": "ac1cbfb244bf62e61f2541c4d60ac30e1aff32e0",
                "filename": "oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7a00410e55ee9226e4401f95225c4c784737e13a/oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7a00410e55ee9226e4401f95225c4c784737e13a/oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java",
                "status": "modified",
                "changes": 19,
                "additions": 19,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java?ref=7a00410e55ee9226e4401f95225c4c784737e13a",
                "patch": "@@ -31,6 +31,7 @@\n import java.io.InputStream;\n import java.io.PrintStream;\n import java.util.ArrayList;\n+import java.util.Date;\n import java.util.Iterator;\n import java.util.List;\n import java.util.Properties;\n@@ -41,11 +42,14 @@\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Lists;\n import com.google.common.collect.Sets;\n+import joptsimple.internal.Strings;\n import org.apache.commons.io.FileUtils;\n import org.apache.commons.io.filefilter.FileFilterUtils;\n import org.apache.felix.cm.file.ConfigurationHandler;\n import org.apache.jackrabbit.core.data.DataStore;\n+import org.apache.jackrabbit.oak.blob.cloud.azure.blobstorage.AzureConstants;\n import org.apache.jackrabbit.oak.blob.cloud.azure.blobstorage.AzureDataStoreUtils;\n+import org.apache.jackrabbit.oak.blob.cloud.s3.S3Constants;\n import org.apache.jackrabbit.oak.blob.cloud.s3.S3DataStoreUtils;\n import org.apache.jackrabbit.oak.commons.FileIOUtils;\n import org.apache.jackrabbit.oak.plugins.blob.datastore.DataStoreBlobStore;\n@@ -88,11 +92,14 @@\n \n     private String dsOption;\n \n+    private String container;\n+\n     @Before\n     public void setup() throws Exception {\n         if (S3DataStoreUtils.isS3Configured()) {\n             Properties props = S3DataStoreUtils.getS3Config();\n             props.setProperty(\"cacheSize\", \"0\");\n+            container = props.getProperty(S3Constants.S3_BUCKET);\n             DataStore ds = S3DataStoreUtils.getS3DataStore(S3DataStoreUtils.getFixtures().get(0),\n                 props,\n                 temporaryFolder.newFolder().getAbsolutePath());\n@@ -102,6 +109,7 @@ public void setup() throws Exception {\n         } else if (AzureDataStoreUtils.isAzureConfigured()) {\n             Properties props = AzureDataStoreUtils.getAzureConfig();\n             props.setProperty(\"cacheSize\", \"0\");\n+            container = props.getProperty(AzureConstants.AZURE_BLOB_CONTAINER_NAME);\n             DataStore ds = AzureDataStoreUtils.getAzureDataStore(props,\n                 temporaryFolder.newFolder().getAbsolutePath());\n             setupDataStore = new DataStoreBlobStore(ds);\n@@ -155,6 +163,17 @@ public void setup() throws Exception {\n     @After\n     public void tearDown() {\n         System.setErr(new PrintStream(new FileOutputStream(FileDescriptor.err)));\n+        if (!Strings.isNullOrEmpty(container)) {\n+            try {\n+                if (dsOption.equals(\"s3ds\")) {\n+                    S3DataStoreUtils.deleteBucket(container, new Date());\n+                } else {\n+                    AzureDataStoreUtils.deleteContainer(container);\n+                }\n+            } catch (Exception e) {\n+                log.error(\"Error in cleaning container\", e);\n+            }\n+        }\n     }\n \n     @Test",
                "deletions": 0
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "DataStoreCheckTest.java"
        ]
    },
    "jackrabbit-oak_157bf55": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4894: Potential NPE in Commit.apply()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1763465 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/157bf5548ac23a22822ad38fff87a969114f7b43",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/dcdae91c976a111315ee0e9a373c4e6556e49065",
        "bug_id": "jackrabbit-oak_157bf55",
        "file": [
            {
                "sha": "97ed2c6cd6895ceee8f907be7c7ca28d9cd69c03",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java",
                "status": "modified",
                "changes": 9,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/Commit.java?ref=157bf5548ac23a22822ad38fff87a969114f7b43",
                "patch": "@@ -179,9 +179,12 @@ void apply() throws DocumentStoreException {\n                 success = true;\n             } finally {\n                 if (!success) {\n-                    b.removeCommit(rev.asBranchRevision());\n-                    if (!b.hasCommits()) {\n-                        nodeStore.getBranches().remove(b);\n+                    Branch branch = getBranch();\n+                    if (branch != null) {\n+                        branch.removeCommit(rev.asBranchRevision());\n+                        if (!branch.hasCommits()) {\n+                            nodeStore.getBranches().remove(branch);\n+                        }\n                     }\n                 }\n             }",
                "deletions": 3
            },
            {
                "sha": "4250ba299a0677319a21bdfd4878476679941749",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/157bf5548ac23a22822ad38fff87a969114f7b43/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java",
                "status": "modified",
                "changes": 24,
                "additions": 24,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/CommitTest.java?ref=157bf5548ac23a22822ad38fff87a969114f7b43",
                "patch": "@@ -25,6 +25,7 @@\n import org.junit.Rule;\n import org.junit.Test;\n \n+import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.EMPTY_NODE;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n@@ -109,4 +110,27 @@ public void mergeExceptionMessage() throws Exception {\n             ns.canceled(c);\n         }\n     }\n+\n+    // OAK-4894\n+    @Test\n+    public void branchCommitFails() throws Exception {\n+        // prepare node store\n+        DocumentNodeStore ns = builderProvider.newBuilder().getNodeStore();\n+\n+        // this branch commit must fail with a DocumentStoreException\n+        Commit c = ns.newCommit(ns.getHeadRevision().asBranchRevision(ns.getClusterId()), null);\n+        try {\n+            c.removeNode(\"/foo\", EMPTY_NODE);\n+            try {\n+                c.apply();\n+                fail(\"commit must fail\");\n+            } catch (DocumentStoreException e) {\n+                // expected\n+                assertTrue(\"Unexpected exception message: \" + e.getMessage(),\n+                        e.getMessage().contains(\"does not exist\"));\n+            }\n+        } finally {\n+            ns.canceled(c);\n+        }\n+    }\n }",
                "deletions": 0
            }
        ],
        "patched_files": [
            "Commit.java"
        ],
        "unit_tests": [
            "CommitTest.java"
        ]
    },
    "jackrabbit-oak_5c0ab6f": {
        "repo": "jackrabbit-oak",
        "message": "OAK-3396 NPE during syncAllExternalUsers in LdapIdentityProvider.createUser\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1706457 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5c0ab6ffcb436957ac44e2950b743910ea7046e0",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/b645443d6b597b5f88cd2c47b5e9ecb9f74651ae",
        "bug_id": "jackrabbit-oak_5c0ab6f",
        "file": [
            {
                "sha": "512a1bf1c958f32ab65f350984f8f4ed365c49e9",
                "filename": "oak-auth-ldap/src/main/java/org/apache/jackrabbit/oak/security/authentication/ldap/impl/LdapIdentityProvider.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5c0ab6ffcb436957ac44e2950b743910ea7046e0/oak-auth-ldap/src/main/java/org/apache/jackrabbit/oak/security/authentication/ldap/impl/LdapIdentityProvider.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5c0ab6ffcb436957ac44e2950b743910ea7046e0/oak-auth-ldap/src/main/java/org/apache/jackrabbit/oak/security/authentication/ldap/impl/LdapIdentityProvider.java",
                "status": "modified",
                "changes": 16,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-ldap/src/main/java/org/apache/jackrabbit/oak/security/authentication/ldap/impl/LdapIdentityProvider.java?ref=5c0ab6ffcb436957ac44e2950b743910ea7046e0",
                "patch": "@@ -702,7 +702,13 @@ private ExternalUser createUser(@Nonnull Entry entry, @CheckForNull String id)\n             throws LdapInvalidAttributeValueException {\n         ExternalIdentityRef ref = new ExternalIdentityRef(entry.getDn().getName(), this.getName());\n         if (id == null) {\n-            id = entry.get(config.getUserConfig().getIdAttribute()).getString();\n+            String idAttribute = config.getUserConfig().getIdAttribute();\n+            Attribute attr = entry.get(idAttribute);\n+            if (attr == null) {\n+                throw new LdapInvalidAttributeValueException(ResultCodeEnum.CONSTRAINT_VIOLATION,\n+                        \"no value found for attribute '\" + idAttribute + \"' for entry \" + entry);\n+            }\n+            id = attr.getString();\n         }\n         String path = config.getUserConfig().makeDnPath()\n                 ? createDNPath(entry.getDn())\n@@ -718,7 +724,13 @@ private ExternalGroup createGroup(@Nonnull Entry entry, @CheckForNull String nam\n             throws LdapInvalidAttributeValueException {\n         ExternalIdentityRef ref = new ExternalIdentityRef(entry.getDn().getName(), this.getName());\n         if (name == null) {\n-            name = entry.get(config.getGroupConfig().getIdAttribute()).getString();\n+            String idAttribute = config.getGroupConfig().getIdAttribute();\n+            Attribute attr = entry.get(idAttribute);\n+            if (attr == null) {\n+                throw new LdapInvalidAttributeValueException(ResultCodeEnum.CONSTRAINT_VIOLATION,\n+                        \"no value found for attribute '\" + idAttribute + \"' for entry \" + entry);\n+            }\n+            name = attr.getString();\n         }\n         String path = config.getGroupConfig().makeDnPath()\n                 ? createDNPath(entry.getDn())",
                "deletions": 2
            },
            {
                "sha": "e43b9680ba29ad3daa424ec5d2a50f0ac1a99e31",
                "filename": "oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LdapProviderTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5c0ab6ffcb436957ac44e2950b743910ea7046e0/oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LdapProviderTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5c0ab6ffcb436957ac44e2950b743910ea7046e0/oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LdapProviderTest.java",
                "status": "modified",
                "changes": 22,
                "additions": 22,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-ldap/src/test/java/org/apache/jackrabbit/oak/security/authentication/ldap/LdapProviderTest.java?ref=5c0ab6ffcb436957ac44e2950b743910ea7046e0",
                "patch": "@@ -21,6 +21,7 @@\n import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Iterator;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n@@ -62,6 +63,8 @@\n \n     private static final String TUTORIAL_LDIF = \"apache-ds-tutorial.ldif\";\n \n+    private static final String ERRONEOUS_LDIF = \"erroneous.ldif\";\n+\n     public static final String IDP_NAME = \"ldap\";\n \n     protected LdapIdentityProvider idp;\n@@ -164,6 +167,25 @@ public void testGetUserByRef() throws Exception {\n         assertTrue(\"User instance\", id instanceof ExternalUser);\n         assertEquals(\"User ID\", TEST_USER1_UID, id.getId());\n     }\n+    \n+    /**\n+     * Test case to reproduce OAK-3396 where an ldap user entry\n+     * without a uid caused a NullpointerException in LdapIdentityProvider.createUser\n+     */\n+    @Test\n+    public void testListUsersWithMissingUid() throws Exception {\n+        // the ERRONEOUS_LDIF contains an entry without uid\n+        InputStream erroneousDIF = LdapProviderTest.class.getResourceAsStream(ERRONEOUS_LDIF);\n+        LDAP_SERVER.loadLdif(erroneousDIF);\n+        Iterator<ExternalUser> users = idp.listUsers();\n+        // without the LdapInvalidAttributeValueException a NPE would result here:\n+        while(users.hasNext()) {\n+            ExternalUser user = users.next();\n+            // the 'Faulty Entry' of the ERRONEOUS_LDIF should be filtered out\n+            // (by LdapIdentityProvider.listUsers.getNext())\n+            assertTrue(!user.getPrincipalName().startsWith(\"cn=Faulty Entry\"));\n+        }\n+    }\n \n     @Test\n     public void testGetUserByUserId() throws Exception {",
                "deletions": 0
            },
            {
                "sha": "180cb21265a5d023ec467afba13593650c6d6cd8",
                "filename": "oak-auth-ldap/src/test/resources/org/apache/jackrabbit/oak/security/authentication/ldap/erroneous.ldif",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5c0ab6ffcb436957ac44e2950b743910ea7046e0/oak-auth-ldap/src/test/resources/org/apache/jackrabbit/oak/security/authentication/ldap/erroneous.ldif",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5c0ab6ffcb436957ac44e2950b743910ea7046e0/oak-auth-ldap/src/test/resources/org/apache/jackrabbit/oak/security/authentication/ldap/erroneous.ldif",
                "status": "added",
                "changes": 40,
                "additions": 40,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-ldap/src/test/resources/org/apache/jackrabbit/oak/security/authentication/ldap/erroneous.ldif?ref=5c0ab6ffcb436957ac44e2950b743910ea7046e0",
                "patch": "@@ -0,0 +1,40 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# Sample LDIF data containing a faulty entry (without uid)\n+#\n+version: 1\n+\n+dn: ou=faulty,ou=groups,ou=system\n+objectclass: organizationalUnit\n+objectclass: top\n+description: Contains a faulty entry\n+ou: faulty\n+\n+# Faulty entry without uid\n+# ---------\n+dn: cn=Faulty Entry,ou=users,ou=system\n+objectclass: person\n+objectclass: organizationalPerson\n+objectclass: inetOrgPerson\n+objectclass: top\n+cn: Faulty Entry\n+description: Example erroneous entry\n+givenname: Faulty\n+sn: Entry\n+mail: no-reply@no.reply\n+userpassword: foobar",
                "deletions": 0
            }
        ],
        "patched_files": [
            "LdapIdentityProvider.java"
        ],
        "unit_tests": [
            "LdapProviderTest.java"
        ]
    },
    "jackrabbit-oak_9b00d1d": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6410: NPE when removing inexistent property from checked in node\n\nAdd ignored test\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1800606 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/9b00d1d4306804c8d25f3c1c48402af497015d55",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/1a6e0afb63b8849f64a12963ed80db5823d87acc",
        "bug_id": "jackrabbit-oak_9b00d1d",
        "file": [
            {
                "sha": "0db3b1b14d342728d0cce22d8e04789b8b619a11",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/9b00d1d4306804c8d25f3c1c48402af497015d55/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/9b00d1d4306804c8d25f3c1c48402af497015d55/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "status": "modified",
                "changes": 11,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java?ref=9b00d1d4306804c8d25f3c1c48402af497015d55",
                "patch": "@@ -1224,6 +1224,17 @@ public void setPropertyAgain() throws RepositoryException {\n         assertEquals(\"newValue\", p3.getString());\n     }\n \n+    // OAK-6410\n+    @Ignore(\"OAK-6410\")\n+    @Test\n+    public void setInexistentProperty() throws RepositoryException {\n+        Node node = getNode(TEST_PATH);\n+        node.addMixin(JcrConstants.MIX_VERSIONABLE);\n+        node.getSession().save();\n+        node.getSession().getWorkspace().getVersionManager().checkin(TEST_PATH);\n+        node.setProperty(\"inexistent\", (Value) null);\n+    }\n+\n     @Test\n     public void setDoubleNaNProperty() throws RepositoryException, IOException {\n         Node parentNode = getNode(TEST_PATH);",
                "deletions": 0
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "RepositoryTest.java"
        ]
    },
    "jackrabbit-oak_0eecb7f": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8051: PersistentCache: error during open can lead to incomplete initialization and subsequent NPEs\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1854701 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/0eecb7fb3687e829dc298d428862d171be3617e5",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/b3367cb8bb44c826f68c56b4aead8de67afae236",
        "bug_id": "jackrabbit-oak_0eecb7f",
        "file": [
            {
                "sha": "6a838de0deb4ae3582685d6a526431f4f41b2cf2",
                "filename": "oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheMap.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0eecb7fb3687e829dc298d428862d171be3617e5/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheMap.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0eecb7fb3687e829dc298d428862d171be3617e5/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheMap.java",
                "status": "modified",
                "changes": 14,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheMap.java?ref=0eecb7fb3687e829dc298d428862d171be3617e5",
                "patch": "@@ -25,7 +25,12 @@\n \n /**\n  * A cache map. This map supports re-opening the store if this is needed.\n- *\n+ * <p>\n+ * Note that a failure to open the underlying store will be handled gracefully,\n+ * in that the {@code CacheMap} can be constructed, but will not actually cache\n+ * anything. The same is true for the case where the underlying store starts to\n+ * fail and can not be re-opened.\n+ * \n  * @param <K> the key type\n  * @param <V> the value type\n  */\n@@ -46,6 +51,13 @@ public CacheMap(MapFactory factory, String name, Builder<K, V> builder) {\n         this.name = name;\n         this.builder = builder;\n         openMap();\n+        // OAK-8051: if opening failed, immediately try to re-open,\n+        // until either the the map is closed, or open\n+        for (int i = 0; map == null && !closed; i++) {\n+            if (map == null) {\n+                reopen(i, null);\n+            }\n+        }\n     }\n \n     private void reopen(int i, Exception e) {",
                "deletions": 1
            },
            {
                "sha": "6983a21745389c464bbbc139048f8eee5045d44d",
                "filename": "oak-store-document/src/test/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0eecb7fb3687e829dc298d428862d171be3617e5/oak-store-document/src/test/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0eecb7fb3687e829dc298d428862d171be3617e5/oak-store-document/src/test/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheTest.java",
                "status": "modified",
                "changes": 59,
                "additions": 37,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-document/src/test/java/org/apache/jackrabbit/oak/plugins/document/persistentCache/CacheTest.java?ref=0eecb7fb3687e829dc298d428862d171be3617e5",
                "patch": "@@ -26,43 +26,58 @@\n import java.io.FileOutputStream;\n \n import com.google.common.cache.Cache;\n+\n import org.apache.commons.io.FileUtils;\n import org.apache.jackrabbit.oak.cache.CacheLIRS;\n+import org.apache.jackrabbit.oak.commons.junit.LogCustomizer;\n import org.apache.jackrabbit.oak.plugins.document.PathRev;\n import org.apache.jackrabbit.oak.plugins.document.Revision;\n import org.apache.jackrabbit.oak.plugins.document.RevisionVector;\n import org.apache.jackrabbit.oak.plugins.document.util.StringValue;\n import org.junit.Test;\n+import org.slf4j.event.Level;\n \n public class CacheTest {\n \n     @Test\n     public void recoverIfCorrupt() throws Exception {\n-        FileUtils.deleteDirectory(new File(\"target/cacheTest\"));\n-        new File(\"target/cacheTest\").mkdirs();\n-        FileOutputStream out = new FileOutputStream(\"target/cacheTest/cache-0.data\");\n-        out.write(\"corrupt\".getBytes());\n-        out.close();\n-        PersistentCache pCache = new PersistentCache(\"target/cacheTest\");\n-        CacheLIRS<PathRev, StringValue> cache = new CacheLIRS.Builder<PathRev, StringValue>().\n-                maximumSize(1).build();\n-        Cache<PathRev, StringValue> map = pCache.wrap(null,  null,  cache, CacheType.DIFF);\n-        String largeString = new String(new char[1024 * 1024]);\n-        for (int counter = 0; counter < 10; counter++) {\n-            long end = System.currentTimeMillis() + 100;\n-            while (System.currentTimeMillis() < end) {\n-                Thread.yield();\n-            }\n-            for (int i = 0; i < 100; i++) {\n-                PathRev k = new PathRev(\"/\" + counter, new RevisionVector(new Revision(0, 0, i)));\n-                map.getIfPresent(k);\n-                map.put(k, new StringValue(largeString));\n+        String expectedWarning = \"Too many re-opens\";\n+        LogCustomizer lc = LogCustomizer.forLogger(CacheMap.class).enable(Level.WARN).contains(expectedWarning).create();\n+\n+        try {\n+            lc.starting();\n+\n+            FileUtils.deleteDirectory(new File(\"target/cacheTest\"));\n+            new File(\"target/cacheTest\").mkdirs();\n+            FileOutputStream out = new FileOutputStream(\"target/cacheTest/cache-0.data\");\n+            out.write(\"corrupt\".getBytes());\n+            out.close();\n+            PersistentCache pCache = new PersistentCache(\"target/cacheTest\");\n+            CacheLIRS<PathRev, StringValue> cache = new CacheLIRS.Builder<PathRev, StringValue>().\n+                    maximumSize(1).build();\n+            Cache<PathRev, StringValue> map = pCache.wrap(null,  null,  cache, CacheType.DIFF);\n+            String largeString = new String(new char[1024 * 1024]);\n+            for (int counter = 0; counter < 10; counter++) {\n+                long end = System.currentTimeMillis() + 100;\n+                while (System.currentTimeMillis() < end) {\n+                    Thread.yield();\n+                }\n+                for (int i = 0; i < 100; i++) {\n+                    PathRev k = new PathRev(\"/\" + counter, new RevisionVector(new Revision(0, 0, i)));\n+                    map.getIfPresent(k);\n+                    map.put(k, new StringValue(largeString));\n+                }\n             }\n+            assertTrue(\"Exceptions: \" + pCache.getExceptionCount(), \n+                    pCache.getExceptionCount() < 100);\n+\n+            assertTrue(\"WARN level log should contain one entry containing '\" + expectedWarning + \"'\", lc.getLogs().size() == 1);\n+        }\n+        finally {\n+            lc.finished();\n         }\n-        assertTrue(\"Exceptions: \" + pCache.getExceptionCount(), \n-                pCache.getExceptionCount() < 100);\n     }\n-    \n+\n     @Test\n     public void closeAlways() throws Exception {\n         FileUtils.deleteDirectory(new File(\"target/cacheTest\"));",
                "deletions": 22
            }
        ],
        "patched_files": [
            "Cache.java",
            "CacheMap.java"
        ],
        "unit_tests": [
            "CacheTest.java"
        ]
    },
    "jackrabbit-oak_286a898": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8589: NPE in IndexDefintionBuilder with existing property rule without \"name\" property\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1866456 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/286a898a9680f1ea097d9fb2486e9193dde83dc5",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/96d4dfe757fad11f18fd0d29b89f39308c906e4c",
        "bug_id": "jackrabbit-oak_286a898",
        "file": [
            {
                "sha": "72147939cc7d891669fc1f6b9be4e0255edfbfb1",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/286a898a9680f1ea097d9fb2486e9193dde83dc5/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/286a898a9680f1ea097d9fb2486e9193dde83dc5/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilder.java",
                "status": "modified",
                "changes": 8,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilder.java?ref=286a898a9680f1ea097d9fb2486e9193dde83dc5",
                "patch": "@@ -312,7 +312,13 @@ private void loadExisting() {\n \n         private Tree findExisting(String name) {\n             for (Tree tree : getPropsTree().getChildren()){\n-                if (name.equals(tree.getProperty(FulltextIndexConstants.PROP_NAME).getValue(Type.STRING))){\n+                String treeName = tree.getName();\n+                PropertyState ps = tree.getProperty(FulltextIndexConstants.PROP_NAME);\n+                if(ps != null) {\n+                    treeName = ps.getValue(Type.STRING);\n+                }\n+\n+                if (name.equals(treeName)) {\n                     return tree;\n                 }\n             }",
                "deletions": 1
            },
            {
                "sha": "1fecbe6c0a3a1b8db0fca7329d8ebd59e249dbae",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilderTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/286a898a9680f1ea097d9fb2486e9193dde83dc5/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilderTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/286a898a9680f1ea097d9fb2486e9193dde83dc5/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilderTest.java",
                "status": "modified",
                "changes": 16,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/IndexDefinitionBuilderTest.java?ref=286a898a9680f1ea097d9fb2486e9193dde83dc5",
                "patch": "@@ -973,4 +973,20 @@ public void tags() {\n         assertThat(state.getProperty(INDEX_TAGS).getValue(Type.STRINGS),\n                 Matchers.containsInAnyOrder(\"foo5\"));\n     }\n+\n+    @Test\n+    public void unnamedPropertyRuleInExistingIndex() {\n+        // create an initial index with property rule for \"foo\"\n+        builder\n+                .indexRule(\"nt:base\")\n+                .property(\"foo\")\n+                //  remove \"name\" property explicitly\n+                .getBuilderTree().removeProperty(\"name\");\n+        NodeState initialIndexState = builder.build();\n+\n+        // Use initial index def to add some other property rule - this should work\n+        new IndexDefinitionBuilder(initialIndexState.builder())\n+                .indexRule(\"nt:base\")\n+                .property(\"bar\");\n+    }\n }\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "IndexDefinitionBuilder.java"
        ],
        "unit_tests": [
            "IndexDefinitionBuilderTest.java"
        ]
    },
    "jackrabbit-oak_a077b2e": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8229 : LoginModuleImpl.commit will end in NPE if credentials are null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1857352 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/a077b2e1d2ed47122b41791460866d1e9605827b",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/81fb633f4230495a862429f3636c01a8a0d420f7",
        "bug_id": "jackrabbit-oak_a077b2e",
        "file": [
            {
                "sha": "73d25074538fc9a078b69f8a0a48021fa22e14bd",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a077b2e1d2ed47122b41791460866d1e9605827b/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a077b2e1d2ed47122b41791460866d1e9605827b/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImpl.java",
                "status": "modified",
                "changes": 5,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImpl.java?ref=a077b2e1d2ed47122b41791460866d1e9605827b",
                "patch": "@@ -167,7 +167,9 @@ public boolean commit() {\n                 } else if (userId != null) {\n                     principals.addAll(getPrincipals(userId));\n                 }\n-                subject.getPublicCredentials().add(credentials);\n+                if (credentials != null) {\n+                    subject.getPublicCredentials().add(credentials);\n+                }\n                 setAuthInfo(createAuthInfo(principals), subject);\n             } else {\n                 log.debug(\"Could not add information to read only subject {}\", subject);\n@@ -229,6 +231,7 @@ private String getLoginId(@Nullable PreAuthenticatedLogin preAuthenticatedLogin)\n         return uid;\n     }\n \n+    @Nullable\n     private String getAnonymousId() {\n         SecurityProvider sp = getSecurityProvider();\n         if (sp == null) {",
                "deletions": 1
            },
            {
                "sha": "3d316245fed627c1e3515b1f7fb9c16aca04f6dc",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImplTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a077b2e1d2ed47122b41791460866d1e9605827b/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImplTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a077b2e1d2ed47122b41791460866d1e9605827b/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImplTest.java",
                "status": "modified",
                "changes": 457,
                "additions": 270,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authentication/user/LoginModuleImplTest.java?ref=a077b2e1d2ed47122b41791460866d1e9605827b",
                "patch": "@@ -16,20 +16,6 @@\n  */\n package org.apache.jackrabbit.oak.security.authentication.user;\n \n-import java.io.IOException;\n-import java.security.Principal;\n-import java.util.Arrays;\n-import javax.jcr.Credentials;\n-import javax.jcr.GuestCredentials;\n-import javax.jcr.RepositoryException;\n-import javax.jcr.SimpleCredentials;\n-import javax.security.auth.Subject;\n-import javax.security.auth.callback.Callback;\n-import javax.security.auth.callback.CallbackHandler;\n-import javax.security.auth.callback.UnsupportedCallbackException;\n-import javax.security.auth.login.Configuration;\n-import javax.security.auth.login.LoginException;\n-\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Maps;\n import com.google.common.collect.Sets;\n@@ -44,9 +30,11 @@\n import org.apache.jackrabbit.oak.security.internal.SecurityProviderBuilder;\n import org.apache.jackrabbit.oak.spi.security.ConfigurationParameters;\n import org.apache.jackrabbit.oak.spi.security.SecurityProvider;\n+import org.apache.jackrabbit.oak.spi.security.authentication.AuthInfoImpl;\n import org.apache.jackrabbit.oak.spi.security.authentication.Authentication;\n import org.apache.jackrabbit.oak.spi.security.authentication.ConfigurationUtil;\n import org.apache.jackrabbit.oak.spi.security.authentication.ImpersonationCredentials;\n+import org.apache.jackrabbit.oak.spi.security.authentication.PreAuthenticatedLogin;\n import org.apache.jackrabbit.oak.spi.security.authentication.callback.RepositoryCallback;\n import org.apache.jackrabbit.oak.spi.security.user.UserAuthenticationFactory;\n import org.apache.jackrabbit.oak.spi.security.user.UserConfiguration;\n@@ -55,13 +43,33 @@\n import org.jetbrains.annotations.NotNull;\n import org.jetbrains.annotations.Nullable;\n import org.junit.Test;\n-import org.mockito.Mockito;\n \n+import javax.jcr.Credentials;\n+import javax.jcr.GuestCredentials;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.SimpleCredentials;\n+import javax.security.auth.Subject;\n+import javax.security.auth.callback.Callback;\n+import javax.security.auth.callback.CallbackHandler;\n+import javax.security.auth.callback.UnsupportedCallbackException;\n+import javax.security.auth.login.Configuration;\n+import javax.security.auth.login.LoginException;\n+import java.security.Principal;\n+import java.util.Arrays;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static org.apache.jackrabbit.oak.spi.security.authentication.AbstractLoginModule.SHARED_KEY_PRE_AUTH_LOGIN;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n public class LoginModuleImplTest extends AbstractSecurityTest {\n \n@@ -83,27 +91,18 @@ protected Configuration getConfiguration() {\n         return ConfigurationUtil.getDefaultConfiguration(ConfigurationParameters.EMPTY);\n     }\n \n-    private User createTestUser() throws RepositoryException, CommitFailedException {\n+    private void createTestUser() throws RepositoryException, CommitFailedException {\n         if (user == null) {\n             UserManager userManager = getUserManager(root);\n             user = userManager.createUser(USER_ID, USER_PW);\n             root.commit();\n         }\n-        return user;\n     }\n \n-    @Test\n+    @Test(expected = LoginException.class)\n     public void testNullLogin() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            cs = login(null);\n+        try (ContentSession cs = login(null)) {\n             fail(\"Null login should fail\");\n-        } catch (LoginException e) {\n-            // success\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n@@ -116,7 +115,7 @@ public void testGuestLogin() throws Exception {\n         }\n     }\n \n-    @Test\n+    @Test(expected = LoginException.class)\n     public void testAnonymousLogin() throws Exception {\n         String anonymousID = UserUtil.getAnonymousId(getUserConfiguration().getParameters());\n \n@@ -127,268 +126,353 @@ public void testAnonymousLogin() throws Exception {\n         assertNotNull(anonymous);\n         assertFalse(root.getTree(anonymous.getPath()).hasProperty(UserConstants.REP_PASSWORD));\n \n-        ContentSession cs = null;\n-        try {\n-            cs = login(new SimpleCredentials(anonymousID, new char[0]));\n+        try (ContentSession cs = login(new SimpleCredentials(anonymousID, new char[0]))) {\n             fail(\"Login with anonymousID should fail since the initial setup doesn't provide a password.\");\n-        } catch (LoginException e) {\n-            // success\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n     @Test\n     public void testUserLogin() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n-\n-            cs = login(new SimpleCredentials(USER_ID, USER_PW.toCharArray()));\n+        createTestUser();\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID, USER_PW.toCharArray()))) {\n             AuthInfo authInfo = cs.getAuthInfo();\n             assertEquals(USER_ID, authInfo.getUserID());\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n     @Test\n     public void testAuthInfoContainsUserId() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n-\n-            cs = login(new SimpleCredentials(USER_ID_CASED, USER_PW.toCharArray()));\n+        createTestUser();\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID_CASED, USER_PW.toCharArray()))) {\n             AuthInfo authInfo = cs.getAuthInfo();\n             assertEquals(user.getID(), authInfo.getUserID());\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n     @Test\n     public void testUserLoginIsCaseInsensitive() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n-\n-            cs = login(new SimpleCredentials(USER_ID_CASED, USER_PW.toCharArray()));\n+        createTestUser();\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID_CASED, USER_PW.toCharArray()))) {\n             AuthInfo authInfo = cs.getAuthInfo();\n             UserManager userMgr = getUserManager(root);\n             Authorizable auth = userMgr.getAuthorizable(authInfo.getUserID());\n             assertNotNull(auth);\n             assertTrue(auth.getID().equalsIgnoreCase(USER_ID_CASED));\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n     @Test\n     public void testUserLoginIsCaseInsensitive2() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n-            cs = login(new SimpleCredentials(USER_ID_CASED, USER_PW.toCharArray()));\n+        createTestUser();\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID_CASED, USER_PW.toCharArray()))) {\n             AuthInfo authInfo = cs.getAuthInfo();\n             assertEquals(user.getID(), authInfo.getUserID());\n             assertTrue(USER_ID_CASED.equalsIgnoreCase(authInfo.getUserID()));\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n-    @Test\n+    @Test(expected = LoginException.class)\n     public void testUnknownUserLogin() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            cs = login(new SimpleCredentials(\"unknown\", \"\".toCharArray()));\n+        try (ContentSession cs = login(new SimpleCredentials(\"unknown\", \"\".toCharArray()))) {\n             fail(\"Unknown user must not be able to login\");\n-        } catch (LoginException e) {\n-            // success\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n     @Test\n     public void testSelfImpersonation() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n-\n-            SimpleCredentials sc = new SimpleCredentials(USER_ID, USER_PW.toCharArray());\n-            cs = login(sc);\n-\n-            AuthInfo authInfo = cs.getAuthInfo();\n+        createTestUser();\n+        AuthInfo authInfo;\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID, USER_PW.toCharArray()))) {\n+            authInfo = cs.getAuthInfo();\n             assertEquals(USER_ID, authInfo.getUserID());\n+        }\n \n-            cs.close();\n-\n-            sc = new SimpleCredentials(USER_ID, new char[0]);\n-            ImpersonationCredentials ic = new ImpersonationCredentials(sc, authInfo);\n-            cs = login(ic);\n-\n+        SimpleCredentials sc = new SimpleCredentials(USER_ID, new char[0]);\n+        ImpersonationCredentials ic = new ImpersonationCredentials(sc, authInfo);\n+        try (ContentSession cs = login(ic)) {\n             authInfo = cs.getAuthInfo();\n             assertEquals(USER_ID, authInfo.getUserID());\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n         }\n     }\n \n-    @Test\n+    @Test(expected = LoginException.class)\n     public void testInvalidImpersonation() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n+        createTestUser();\n+        AuthInfo authInfo;\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID, USER_PW.toCharArray()))) {\n+            authInfo = cs.getAuthInfo();\n+            assertEquals(USER_ID, authInfo.getUserID());\n+        }\n \n-            SimpleCredentials sc = new SimpleCredentials(USER_ID, USER_PW.toCharArray());\n-            cs = login(sc);\n+        ConfigurationParameters config = securityProvider.getConfiguration(UserConfiguration.class).getParameters();\n+        String adminId = UserUtil.getAdminId(config);\n+        SimpleCredentials sc = new SimpleCredentials(adminId, new char[0]);\n+        ImpersonationCredentials ic = new ImpersonationCredentials(sc, authInfo);\n+        // test-user should not be allowed to impersonate admin -> exception expected\n+        try (ContentSession cs = login(ic)) {\n+            fail(\"User 'test' should not be allowed to impersonate \" + adminId);\n+        }\n+    }\n \n+    @Test\n+    public void testLoginWithAttributes( ) throws Exception {\n+        createTestUser();\n+        SimpleCredentials sc = new SimpleCredentials(USER_ID, USER_PW.toCharArray());\n+        sc.setAttribute(\"attr\", \"value\");\n+        try (ContentSession cs = login(sc)){\n             AuthInfo authInfo = cs.getAuthInfo();\n-            assertEquals(USER_ID, authInfo.getUserID());\n+            assertTrue(Arrays.asList(authInfo.getAttributeNames()).contains(\"attr\"));\n+            assertEquals(\"value\", authInfo.getAttribute(\"attr\"));\n+        }\n+    }\n \n-            cs.close();\n-            cs = null;\n+    @Test\n+    public void testImpersonationWithAttributes() throws Exception {\n+        createTestUser();\n+        AuthInfo authInfo;\n+        try (ContentSession cs = login(new SimpleCredentials(USER_ID, USER_PW.toCharArray()))) {\n+            authInfo = cs.getAuthInfo();\n+        }\n \n-            ConfigurationParameters config = securityProvider.getConfiguration(UserConfiguration.class).getParameters();\n-            String adminId = UserUtil.getAdminId(config);\n-            sc = new SimpleCredentials(adminId, new char[0]);\n-            ImpersonationCredentials ic = new ImpersonationCredentials(sc, authInfo);\n+        SimpleCredentials sc = new SimpleCredentials(USER_ID, new char[0]);\n+        sc.setAttribute(\"attr\", \"value\");\n+        ImpersonationCredentials ic = new ImpersonationCredentials(sc, authInfo);\n+        try (ContentSession cs = login(ic)) {\n+            authInfo = cs.getAuthInfo();\n+            assertTrue(Arrays.asList(authInfo.getAttributeNames()).contains(\"attr\"));\n+            assertEquals(\"value\", authInfo.getAttribute(\"attr\"));\n+        }\n+    }\n \n-            try {\n-                cs = login(ic);\n-                fail(\"User 'test' should not be allowed to impersonate \" + adminId);\n-            } catch (LoginException e) {\n-                // success\n-            }\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n-            }\n+    @Test(expected = LoginException.class)\n+    public void testImpersonationWithUnsupportedBaseCredentials() throws Exception {\n+        Credentials baseCredentials = mock(Credentials.class);\n+        ImpersonationCredentials ic = new ImpersonationCredentials(baseCredentials, new AuthInfoImpl(USER_ID, null, null));\n+        try (ContentSession cs = login(ic)) {\n+            fail(\"Base credentials of ImpersonationCredentials can only be SimpleCredentials.\");\n         }\n     }\n \n     @Test\n-    public void testLoginWithAttributes( ) throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n+    public void testLoginPreAuthenticated() throws Exception {\n+        Authentication authentication = mock(Authentication.class);\n+        when(authentication.authenticate(any(Credentials.class))).thenReturn(true).getMock();\n+        when(authentication.getUserId()).thenReturn(\"uid\"); // but getUserPrincipal returns null\n+\n+        UserAuthenticationFactory uaf = when(mock(UserAuthenticationFactory.class).getAuthentication(any(UserConfiguration.class), any(Root.class), anyString())).thenReturn(authentication).getMock();\n+        Map<String, Object> sharedState = Maps.newHashMap();\n+        sharedState.put(SHARED_KEY_PRE_AUTH_LOGIN, new PreAuthenticatedLogin(\"uid\"));\n+\n+        Subject subject = new Subject();\n+        LoginModuleImpl lm = new LoginModuleImpl();\n+        lm.initialize(subject, new TestCallbackHandler(uaf), sharedState, Maps.newHashMap());\n+        assertTrue(lm.login());\n+        assertTrue(lm.commit());\n+\n+        assertTrue(subject.getPrincipals().isEmpty());\n+        // no other public credentials than the AuthInfo\n+        assertEquals(1, subject.getPublicCredentials().size());\n+        // verify AuthInfo\n+        Set<AuthInfo> authInfos = subject.getPublicCredentials(AuthInfo.class);\n+        assertFalse(authInfos.isEmpty());\n+        assertEquals(\"uid\", authInfos.iterator().next().getUserID());\n+    }\n \n-            SimpleCredentials sc = new SimpleCredentials(USER_ID, USER_PW.toCharArray());\n-            sc.setAttribute(\"attr\", \"value\");\n+    @Test\n+    public void testLoginPreAuthenticatedWithReadOnlySubject() throws Exception {\n+        Authentication authentication = when(mock(Authentication.class).authenticate(any(Credentials.class))).thenReturn(true).getMock();\n+        UserAuthenticationFactory uaf = when(mock(UserAuthenticationFactory.class).getAuthentication(any(UserConfiguration.class), any(Root.class), anyString())).thenReturn(authentication).getMock();\n+\n+        Map<String, Object> sharedState = Maps.newHashMap();\n+        sharedState.put(SHARED_KEY_PRE_AUTH_LOGIN, new PreAuthenticatedLogin(\"uid\"));\n+\n+        Subject subject = new Subject();\n+        subject.setReadOnly();\n+        LoginModuleImpl lm = new LoginModuleImpl();\n+        lm.initialize(subject, new TestCallbackHandler(uaf), sharedState, Maps.newHashMap());\n+        assertTrue(lm.login());\n+        assertTrue(lm.commit());\n+\n+        assertTrue(subject.getPrincipals().isEmpty());\n+        assertTrue(subject.getPublicCredentials().isEmpty());\n+    }\n \n-            cs = login(sc);\n+    @Test\n+    public void testNullUserAuthentication() throws Exception {\n+        LoginModuleImpl loginModule = new LoginModuleImpl();\n+        CallbackHandler cbh = new TestCallbackHandler(mock(UserAuthenticationFactory.class));\n+        loginModule.initialize(new Subject(), cbh, Maps.newHashMap(), Maps.newHashMap());\n \n-            AuthInfo authInfo = cs.getAuthInfo();\n-            assertTrue(Arrays.asList(authInfo.getAttributeNames()).contains(\"attr\"));\n-            assertEquals(\"value\", authInfo.getAttribute(\"attr\"));\n+        assertFalse(loginModule.login());\n+        assertFalse(loginModule.commit());\n+    }\n \n-            cs.close();\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n+    @Test\n+    public void testMissingUserAuthenticationFactory() throws Exception {\n+        CallbackHandler cbh = callbacks -> {\n+            for (Callback callback : callbacks) {\n+                if (callback instanceof RepositoryCallback) {\n+                    UserConfiguration uc = when(mock(UserConfiguration.class).getParameters()).thenReturn(ConfigurationParameters.EMPTY).getMock();\n+                    SecurityProvider sp = when(mock(SecurityProvider.class).getConfiguration(UserConfiguration.class)).thenReturn(uc).getMock();\n+                    ((RepositoryCallback) callback).setSecurityProvider(sp);\n+                    ((RepositoryCallback) callback).setContentRepository(getContentRepository());\n+                } else {\n+                    throw new UnsupportedCallbackException(callback);\n+                }\n             }\n-        }\n+        };\n+\n+        LoginModuleImpl loginModule = new LoginModuleImpl();\n+        loginModule.initialize(new Subject(), cbh, Maps.newHashMap(), Maps.newHashMap());\n+\n+        assertFalse(loginModule.login());\n+        assertFalse(loginModule.commit());\n     }\n \n     @Test\n-    public void testImpersonationWithAttributes() throws Exception {\n-        ContentSession cs = null;\n-        try {\n-            createTestUser();\n+    public void testMissingSecurityProviderGuestLogin() throws Exception {\n+        CallbackHandler cbh = callbacks -> {\n+            for (Callback callback : callbacks) {\n+                if (callback instanceof RepositoryCallback) {\n+                    ((RepositoryCallback) callback).setSecurityProvider(null);\n+                    ((RepositoryCallback) callback).setContentRepository(getContentRepository());\n+                } else {\n+                    throw new UnsupportedCallbackException(callback);\n+                }\n+            }\n+        };\n \n-            SimpleCredentials sc = new SimpleCredentials(USER_ID, USER_PW.toCharArray());\n-            cs = login(sc);\n-            AuthInfo authInfo = cs.getAuthInfo();\n-            cs.close();\n-            cs = null;\n+        LoginModuleImpl loginModule = new LoginModuleImpl();\n+        loginModule.initialize(new Subject(false, ImmutableSet.of(), ImmutableSet.of(new GuestCredentials()), ImmutableSet.of()), cbh, Maps.newHashMap(), Maps.newHashMap());\n \n-            sc = new SimpleCredentials(USER_ID, new char[0]);\n-            sc.setAttribute(\"attr\", \"value\");\n-            ImpersonationCredentials ic = new ImpersonationCredentials(sc, authInfo);\n-            cs = login(ic);\n+        assertFalse(loginModule.login());\n+        assertFalse(loginModule.commit());\n+    }\n \n-            authInfo = cs.getAuthInfo();\n-            assertTrue(Arrays.asList(authInfo.getAttributeNames()).contains(\"attr\"));\n-            assertEquals(\"value\", authInfo.getAttribute(\"attr\"));\n-        } finally {\n-            if (cs != null) {\n-                cs.close();\n+    @Test\n+    public void testMissingSecurityProvider() throws Exception {\n+        CallbackHandler cbh = callbacks -> {\n+            for (Callback callback : callbacks) {\n+                if (callback instanceof RepositoryCallback) {\n+                    ((RepositoryCallback) callback).setSecurityProvider(null);\n+                    ((RepositoryCallback) callback).setContentRepository(getContentRepository());\n+                } else {\n+                    throw new UnsupportedCallbackException(callback);\n+                }\n             }\n-        }\n+        };\n+\n+        LoginModuleImpl loginModule = new LoginModuleImpl();\n+        loginModule.initialize(new Subject(), cbh, Maps.newHashMap(), Maps.newHashMap());\n+\n+        assertFalse(loginModule.login());\n+        assertFalse(loginModule.commit());\n     }\n \n     @Test\n-    public void testGetNullUserAuthentication() throws Exception {\n+    public void testMissingRoot() throws Exception {\n+        CallbackHandler cbh = callbacks -> {\n+            for (Callback callback : callbacks) {\n+                if (callback instanceof RepositoryCallback) {\n+                    ((RepositoryCallback) callback).setSecurityProvider(getSecurityProvider());\n+                    ((RepositoryCallback) callback).setContentRepository(null);\n+                } else {\n+                    throw new UnsupportedCallbackException(callback);\n+                }\n+            }\n+        };\n+\n         LoginModuleImpl loginModule = new LoginModuleImpl();\n-        CallbackHandler cbh = new TestCallbackHandler(Mockito.mock(UserAuthenticationFactory.class));\n-        loginModule.initialize(new Subject(), cbh, Maps.<String, Object>newHashMap(), Maps.<String, Object>newHashMap());\n+        loginModule.initialize(new Subject(), cbh, Maps.newHashMap(), Maps.newHashMap());\n \n         assertFalse(loginModule.login());\n         assertFalse(loginModule.commit());\n     }\n \n     @Test\n-    public void testCustomUserAuthentication() throws Exception {\n+    public void testMissingCallbackHandler() throws Exception {\n         LoginModuleImpl loginModule = new LoginModuleImpl();\n+        loginModule.initialize(new Subject(), null, Maps.newHashMap(), Maps.newHashMap());\n+\n+        assertFalse(loginModule.login());\n+        assertFalse(loginModule.commit());\n+    }\n+\n+    @Test\n+    public void testLoginCustomUserAuthenticationFactory() throws Exception {\n+        UserAuthenticationFactory factory = (configuration, root, userId) -> new Authentication() {\n+            @Override\n+            public boolean authenticate(@Nullable Credentials credentials) {\n+                return true;\n+            }\n \n-        UserAuthenticationFactory factory = new UserAuthenticationFactory() {\n             @Nullable\n             @Override\n-            public Authentication getAuthentication(@NotNull UserConfiguration configuration, @NotNull Root root, @Nullable String userId) {\n-                return new Authentication() {\n-                    @Override\n-                    public boolean authenticate(@Nullable Credentials credentials) throws LoginException {\n-                        return true;\n-                    }\n-\n-                    @Nullable\n-                    @Override\n-                    public String getUserId() {\n-                        return null;\n-                    }\n-\n-                    @Nullable\n-                    @Override\n-                    public Principal getUserPrincipal() {\n-                        return null;\n-                    }\n-                };\n+            public String getUserId() {\n+                return null;\n+            }\n+\n+            @Nullable\n+            @Override\n+            public Principal getUserPrincipal() {\n+                return null;\n             }\n         };\n \n         CallbackHandler cbh = new TestCallbackHandler(factory);\n         SimpleCredentials creds = new SimpleCredentials(\"loginId\", new char[0]);\n-        Subject subject = new Subject(false, Sets.<Principal>newHashSet(), ImmutableSet.of(creds), Sets.newHashSet());\n+        Subject subject = new Subject(false, Sets.newHashSet(), ImmutableSet.of(creds), Sets.newHashSet());\n \n-        loginModule.initialize(subject, cbh, Maps.<String, Object>newHashMap(), Maps.<String, Object>newHashMap());\n+        LoginModuleImpl loginModule = new LoginModuleImpl();\n+        loginModule.initialize(subject, cbh, Maps.newHashMap(), Maps.newHashMap());\n         assertTrue(loginModule.login());\n         assertTrue(loginModule.commit());\n \n+        // authinfo falls back to loginId because Authentication.getUserId returned null\n         AuthInfo authInfo = subject.getPublicCredentials(AuthInfo.class).iterator().next();\n         assertEquals(\"loginId\", authInfo.getUserID());\n     }\n \n+    @Test\n+    public void testMissingUserId() throws Exception {\n+        UserAuthenticationFactory factory = (configuration, root, userId) -> new Authentication() {\n+            @Override\n+            public boolean authenticate(@Nullable Credentials credentials) {\n+                return true;\n+            }\n+\n+            @Nullable\n+            @Override\n+            public String getUserId() {\n+                return null;\n+            }\n+\n+            @Nullable\n+            @Override\n+            public Principal getUserPrincipal() {\n+                return null;\n+            }\n+        };\n+\n+        CallbackHandler cbh = new TestCallbackHandler(factory);\n+        Subject subject = new Subject(false, Sets.newHashSet(), ImmutableSet.of(), Sets.newHashSet());\n+\n+        LoginModuleImpl loginModule = new LoginModuleImpl();\n+        loginModule.initialize(subject, cbh, Maps.newHashMap(), Maps.newHashMap());\n+        assertTrue(loginModule.login());\n+        assertTrue(loginModule.commit());\n+\n+        AuthInfo authInfo = subject.getPublicCredentials(AuthInfo.class).iterator().next();\n+        assertNull(authInfo.getUserID());\n+        assertTrue(subject.getPrincipals().isEmpty());\n+    }\n+\n \n     private class TestCallbackHandler implements CallbackHandler {\n \n         private final SecurityProvider sp;\n \n-        private TestCallbackHandler(@Nullable UserAuthenticationFactory authenticationFactory) {\n+        private TestCallbackHandler(@NotNull UserAuthenticationFactory authenticationFactory) {\n             ConfigurationParameters params = ConfigurationParameters.of(\n                     UserConfiguration.NAME,\n                     ConfigurationParameters.of(\n@@ -397,7 +481,7 @@ private TestCallbackHandler(@Nullable UserAuthenticationFactory authenticationFa\n         }\n \n         @Override\n-        public void handle(Callback[] callbacks) throws IOException, UnsupportedCallbackException {\n+        public void handle(Callback[] callbacks) throws UnsupportedCallbackException {\n             for (Callback callback : callbacks) {\n                 if (callback instanceof RepositoryCallback) {\n                     ((RepositoryCallback) callback).setSecurityProvider(sp);\n@@ -408,5 +492,4 @@ public void handle(Callback[] callbacks) throws IOException, UnsupportedCallback\n             }\n         }\n     }\n-\n }",
                "deletions": 187
            }
        ],
        "patched_files": [
            "LoginModuleImpl.java"
        ],
        "unit_tests": [
            "LoginModuleImplTest.java"
        ]
    },
    "jackrabbit-oak_0f75aa9": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4046: NPE in oak-run graph when repository contains bulk segments\nCheck info map for bulk segments\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1731972 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/0f75aa9f436da9e7cc21bc2027d10fb7a408cd32",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/7ceef5234025e5991fa73328ec892b1ecddc32b6",
        "bug_id": "jackrabbit-oak_0f75aa9",
        "file": [
            {
                "sha": "c77d53ef172ffc1acdb2f28371d1fa94ac2d5234",
                "filename": "oak-segment/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentGraph.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0f75aa9f436da9e7cc21bc2027d10fb7a408cd32/oak-segment/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentGraph.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0f75aa9f436da9e7cc21bc2027d10fb7a408cd32/oak-segment/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentGraph.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-segment/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentGraph.java?ref=0f75aa9f436da9e7cc21bc2027d10fb7a408cd32",
                "patch": "@@ -452,7 +452,7 @@ protected void onListBucket(RecordId parentId, RecordId listId, int index, int c\n \n     private static void writeNode(UUID node, PrintWriter writer, boolean inHead, Date epoch, SegmentTracker tracker) {\n         Map<String, String> sInfo = getSegmentInfoMap(node, tracker);\n-        if (sInfo == null) {\n+        if (!sInfo.containsKey(\"t\")) {\n             writer.write(node + \",b,bulk,b,-1,-1,\" + inHead + \"\\n\");\n         } else {\n             String error = sInfo.get(\"error\");",
                "deletions": 1
            }
        ],
        "patched_files": [
            "SegmentGraph.java"
        ],
        "unit_tests": [
            "SegmentGraphTest.java"
        ]
    },
    "jackrabbit-oak_10be946": {
        "repo": "jackrabbit-oak",
        "message": "OAK-3951: TimingDocumentStoreWrapper throws NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1727429 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/10be946c533730a583434791c64f836861ac6ea6",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/0aabaec2eafcb61109307b4721210f2b646f5aa2",
        "bug_id": "jackrabbit-oak_10be946",
        "file": [
            {
                "sha": "414f04a64710f533f11eee031c18f832186e780d",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapper.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/10be946c533730a583434791c64f836861ac6ea6/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapper.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/10be946c533730a583434791c64f836861ac6ea6/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapper.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapper.java?ref=10be946c533730a583434791c64f836861ac6ea6",
                "patch": "@@ -433,7 +433,7 @@ private void log(String message) {\n     private static <T extends Document> int size(List<T> list) {\n         int result = 0;\n         for (T doc : list) {\n-            result += doc.getMemory();\n+            result += size(doc);\n         }\n         return result;\n     }",
                "deletions": 1
            },
            {
                "sha": "898f98dec0e9c40ce3b6cb92774ed2ec8a1f3ea4",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapperTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/10be946c533730a583434791c64f836861ac6ea6/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapperTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/10be946c533730a583434791c64f836861ac6ea6/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapperTest.java",
                "status": "added",
                "changes": 37,
                "additions": 37,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/util/TimingDocumentStoreWrapperTest.java?ref=10be946c533730a583434791c64f836861ac6ea6",
                "patch": "@@ -0,0 +1,37 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.plugins.document.util;\n+\n+import java.util.Collections;\n+\n+import org.apache.jackrabbit.oak.plugins.document.Collection;\n+import org.apache.jackrabbit.oak.plugins.document.Document;\n+import org.apache.jackrabbit.oak.plugins.document.DocumentStore;\n+import org.apache.jackrabbit.oak.plugins.document.UpdateOp;\n+import org.apache.jackrabbit.oak.plugins.document.memory.MemoryDocumentStore;\n+import org.junit.Test;\n+\n+public class TimingDocumentStoreWrapperTest {\n+\n+    @Test\n+    public void createOrUpdate() {\n+        DocumentStore store = new TimingDocumentStoreWrapper(new MemoryDocumentStore());\n+        UpdateOp op = new UpdateOp(\"foo\", true);\n+        op.set(Document.ID, \"foo\");\n+        store.createOrUpdate(Collection.NODES, Collections.singletonList(op));\n+    }\n+}",
                "deletions": 0
            }
        ],
        "patched_files": [
            "TimingDocumentStoreWrapper.java"
        ],
        "unit_tests": [
            "TimingDocumentStoreWrapperTest.java"
        ]
    },
    "jackrabbit-oak_ac194bb": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7357: NPE on activation of LuceneIndexProviderService with disabled CoR and CoR\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1827257 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/f8d8f4e9e0519570e68f4aee390ba34fe7d73268",
        "bug_id": "jackrabbit-oak_ac194bb",
        "file": [
            {
                "sha": "e5211ac65fa5254566f73abc85b11cd816f48a81",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java",
                "status": "modified",
                "changes": 5,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderService.java?ref=ac194bbd073bbfb9c85e00db75350fdba4e2a6a3",
                "patch": "@@ -755,10 +755,11 @@ private void initializeActiveBlobCollector(Whiteboard whiteboard, Map<String, ?>\n                 PROP_DELETED_BLOB_COLLECTION_DEFAULT_ENABLED);\n         if (activeDeletionEnabled && blobStore!= null) {\n             File blobCollectorWorkingDir = new File(indexDir, \"deleted-blobs\");\n-            activeDeletedBlobCollector = ActiveDeletedBlobCollectorFactory.newInstance(blobCollectorWorkingDir, executorService);\n+            activeDeletedBlobCollector = ActiveDeletedBlobCollectorFactory.newInstance(blobCollectorWorkingDir,\n+                    getExecutorService());\n             ActiveDeletedBlobCollectorMBean bean =\n                     new ActiveDeletedBlobCollectorMBeanImpl(activeDeletedBlobCollector, whiteboard, nodeStore,\n-                            indexPathService, asyncIndexInfoService, blobStore, executorService);\n+                            indexPathService, asyncIndexInfoService, blobStore, getExecutorService());\n \n             oakRegs.add(registerMBean(whiteboard, ActiveDeletedBlobCollectorMBean.class, bean,\n                     ActiveDeletedBlobCollectorMBean.TYPE, \"Active lucene files collection\"));",
                "deletions": 2
            },
            {
                "sha": "8fb74078f0dc64fc20a9b079da4d81c77381a46b",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ac194bbd073bbfb9c85e00db75350fdba4e2a6a3/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java",
                "status": "modified",
                "changes": 25,
                "additions": 25,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexProviderServiceTest.java?ref=ac194bbd073bbfb9c85e00db75350fdba4e2a6a3",
                "patch": "@@ -182,6 +182,31 @@ public void enableCopyOnWrite() throws Exception{\n         MockOsgi.deactivate(service, context.bundleContext());\n     }\n \n+    // OAK-7357\n+    @Test\n+    public void disableCoRCoW() throws Exception {\n+        // inject ds as OAK-7357 revealed ABD bean had a bug - which comes into play only with blob stores\n+        CachingFileDataStore ds = DataStoreUtils\n+                .createCachingFDS(folder.newFolder().getAbsolutePath(),\n+                        folder.newFolder().getAbsolutePath());\n+\n+        context.registerService(GarbageCollectableBlobStore.class, new DataStoreBlobStore(ds));\n+\n+        // re-init service and inject references\n+        service = new LuceneIndexProviderService();\n+        MockOsgi.injectServices(service, context.bundleContext());\n+\n+        Map<String,Object> config = getDefaultConfig();\n+        config.put(\"enableCopyOnReadSupport\", false);\n+        config.put(\"enableCopyOnWriteSupport\", false);\n+\n+        // activation should work\n+        MockOsgi.activate(service, context.bundleContext(), config);\n+\n+        // de-activation should work\n+        MockOsgi.deactivate(service, context.bundleContext());\n+    }\n+\n     @Test\n     public void enablePrefetchIndexFiles() throws Exception{\n         Map<String,Object> config = getDefaultConfig();",
                "deletions": 0
            }
        ],
        "patched_files": [
            "LuceneIndexProviderService.java"
        ],
        "unit_tests": [
            "LuceneIndexProviderServiceTest.java"
        ]
    },
    "jackrabbit-oak_0ca2725": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8346: RDBDocumentStore*: fix several potential but improbable NPEs\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1859881 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/0ca272564f169715049fc2a7f3b49a3079a95eb0",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/7cbf317f8e540adabd017ec11c0ee3714a27f830",
        "bug_id": "jackrabbit-oak_0ca2725",
        "file": [
            {
                "sha": "d7cd619d2dc27561f28b8617ff51ef04856ad8b0",
                "filename": "oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0ca272564f169715049fc2a7f3b49a3079a95eb0/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0ca272564f169715049fc2a7f3b49a3079a95eb0/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java?ref=0ca272564f169715049fc2a7f3b49a3079a95eb0",
                "patch": "@@ -833,7 +833,7 @@ public void dispose() {\n \n     private <T extends Document> T getIfCached(Collection<T> collection, String id, long modCount) {\n         T doc = getIfCached(collection, id);\n-        if (doc != null && doc.getModCount() == modCount) {\n+        if (doc != null && doc.getModCount() != null && doc.getModCount() == modCount) {\n             return doc;\n         } else {\n             return null;",
                "deletions": 1
            },
            {
                "sha": "eb038b66fa28840181ca26b9f32d406603bc2724",
                "filename": "oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0ca272564f169715049fc2a7f3b49a3079a95eb0/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0ca272564f169715049fc2a7f3b49a3079a95eb0/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "status": "modified",
                "changes": 9,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java?ref=0ca272564f169715049fc2a7f3b49a3079a95eb0",
                "patch": "@@ -62,6 +62,7 @@\n import org.slf4j.LoggerFactory;\n \n import com.google.common.base.Function;\n+import com.google.common.base.Strings;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Lists;\n \n@@ -84,6 +85,8 @@\n     private final RDBDocumentSerializer ser;\n     private final int queryHitsLimit, queryTimeLimit;\n \n+    private static final Long INITIALMODCOUNT = Long.valueOf(1);\n+    \n     public RDBDocumentStoreJDBC(RDBDocumentStoreDB dbInfo, RDBDocumentSerializer ser, int queryHitsLimit, int queryTimeLimit) {\n         this.dbInfo = dbInfo;\n         this.ser = ser;\n@@ -343,7 +346,7 @@ public long determineServerTimeDifferenceMillis(Connection connection) {\n             boolean batchIsEmpty = true;\n             for (T document : sortDocuments(documents)) {\n                 Long modcount = (Long) document.get(MODCOUNT);\n-                if (modcount == 1) {\n+                if (INITIALMODCOUNT.equals(modcount)) {\n                     continue; // This is a new document. We'll deal with the inserts later.\n                 }\n \n@@ -414,7 +417,7 @@ public long determineServerTimeDifferenceMillis(Connection connection) {\n         if (upsert) {\n             List<T> toBeInserted = new ArrayList<T>(documents.size());\n             for (T doc : documents) {\n-                if ((Long) doc.get(MODCOUNT) == 1) {\n+                if (INITIALMODCOUNT.equals(doc.get(MODCOUNT))) {\n                     toBeInserted.add(doc);\n                 }\n             }\n@@ -1111,7 +1114,7 @@ private static Integer hasBinaryAsNullOrInteger(Number n) {\n         Collections.sort(result, new Comparator<T>() {\n             @Override\n             public int compare(T o1, T o2) {\n-                return o1.getId().compareTo(o2.getId());\n+                return Strings.nullToEmpty(o1.getId()).compareTo(Strings.nullToEmpty(o2.getId()));\n             }\n         });\n         return result;",
                "deletions": 3
            }
        ],
        "patched_files": [
            "RDBDocumentStoreJDBC.java",
            "RDBDocumentStore.java"
        ],
        "unit_tests": [
            "RDBDocumentStoreJDBCTest.java",
            "RDBDocumentStoreTest.java"
        ]
    },
    "jackrabbit-oak_20fc4ec": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1288: NPE when running SmallFileReadTest on mongo\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1551591 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/20fc4ecc0b0dfbfe8e9876833526025ab1002d62",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/937bc27af3354e958ba9b93779d2a8db7b826998",
        "bug_id": "jackrabbit-oak_20fc4ec",
        "file": [
            {
                "sha": "75d6c457d34ce8034be0a173375cc33238c8c93c",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/20fc4ecc0b0dfbfe8e9876833526025ab1002d62/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/20fc4ecc0b0dfbfe8e9876833526025ab1002d62/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "status": "modified",
                "changes": 7,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java?ref=20fc4ecc0b0dfbfe8e9876833526025ab1002d62",
                "patch": "@@ -19,11 +19,6 @@\n import static com.google.common.base.Objects.toStringHelper;\n import static com.google.common.base.Preconditions.checkNotNull;\n import static com.google.common.base.Preconditions.checkState;\n-import static java.util.Collections.emptyList;\n-import static org.apache.jackrabbit.oak.api.Type.BOOLEAN;\n-import static org.apache.jackrabbit.oak.api.Type.NAME;\n-import static org.apache.jackrabbit.oak.api.Type.NAMES;\n-import static org.apache.jackrabbit.oak.api.Type.STRING;\n import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.EMPTY_NODE;\n \n import java.io.IOException;\n@@ -128,8 +123,8 @@ protected MemoryNodeBuilder(MemoryNodeBuilder parent, String name) {\n         this.parent = parent;\n         this.name = name;\n         this.rootBuilder = parent.rootBuilder;\n+        this.base = parent.base().getChildNode(name);\n         this.baseRevision = parent.baseRevision;\n-        this.base = parent.base.getChildNode(name);\n         this.head = new UnconnectedHead();\n     }\n ",
                "deletions": 6
            }
        ],
        "patched_files": [
            "MemoryNodeBuilder.java"
        ],
        "unit_tests": [
            "MemoryNodeBuilderTest.java"
        ]
    },
    "jackrabbit-oak_d4ef60c": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1464 FileStoreBackup NPE in retrieving old state\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1571250 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/d4ef60c19484d4295593a6e03b9c08975295160f",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/a6ff1c86fa326ee277e87eda7946ab6e5b135a52",
        "bug_id": "jackrabbit-oak_d4ef60c",
        "file": [
            {
                "sha": "4757b9bb009603191c0e453588d0c95de4c3e271",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d4ef60c19484d4295593a6e03b9c08975295160f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d4ef60c19484d4295593a6e03b9c08975295160f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java?ref=d4ef60c19484d4295593a6e03b9c08975295160f",
                "patch": "@@ -69,7 +69,7 @@ public static void backup(NodeStore store, File destination)\n             } else {\n                 // 3.2 try to retrieve the previously backed up checkpoint\n                 NodeState before = store.retrieve(beforeCheckpoint);\n-                if (before != null) {\n+                if (before == null) {\n                     // the previous checkpoint is no longer available,\n                     // so use the backed up state as the basis of the\n                     // incremental backup diff",
                "deletions": 1
            }
        ],
        "patched_files": [
            "FileStoreBackup.java"
        ],
        "unit_tests": [
            "FileStoreBackupTest.java"
        ]
    },
    "jackrabbit-oak_81df42a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-3123: NPE in RecordIdMap\n* Properly guard against NPE\n* Added test case for empty map\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1691965 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/81df42a4951b96f87cbe108bf58715c8bc318b93",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/8f832fdbdfc169715462c2a853175ec573fc5045",
        "bug_id": "jackrabbit-oak_81df42a",
        "file": [
            {
                "sha": "fe62ffdc3c16a5f4e4ee451736b7c98189e240b0",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMap.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/81df42a4951b96f87cbe108bf58715c8bc318b93/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMap.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/81df42a4951b96f87cbe108bf58715c8bc318b93/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMap.java",
                "status": "modified",
                "changes": 13,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMap.java?ref=81df42a4951b96f87cbe108bf58715c8bc318b93",
                "patch": "@@ -29,8 +29,11 @@\n  * A memory optimised map of {@code short} key to {@link RecordId} values.\n  */\n public class RecordIdMap {\n-    private short[] keys;\n-    private RecordId[] values;\n+    private static final short[] NO_KEYS = new short[0];\n+    private static final RecordId[] NO_VALUES = new RecordId[0];\n+\n+    private short[] keys = NO_KEYS;\n+    private RecordId[] values = NO_VALUES;\n \n     /**\n      * Associates {@code key} with {@code value} if not already present\n@@ -39,7 +42,7 @@\n      * @return  {@code true} if added, {@code false} if already present\n      */\n     public boolean put(short key, @Nonnull RecordId value) {\n-        if (keys == null) {\n+        if (keys.length == 0) {\n             keys = new short[1];\n             values = new RecordId[1];\n             keys[0] = key;\n@@ -90,7 +93,7 @@ public RecordId get(short key) {\n      * @return  {@code true} iff {@code key} is present.\n      */\n     public boolean containsKey(short key) {\n-        return keys != null && binarySearch(keys, key) >= 0;\n+        return binarySearch(keys, key) >= 0;\n     }\n \n     /**\n@@ -105,6 +108,7 @@ public int size() {\n      * the natural ordering of shorts.\n      * @param index\n      * @return the key at {@code index}\n+     * @throws ArrayIndexOutOfBoundsException if not {@code 0 <= index < size()}\n      */\n     public short getKey(int index) {\n         return keys[index];\n@@ -115,6 +119,7 @@ public short getKey(int index) {\n      * the natural ordering of shorts.\n      * @param index\n      * @return the value at {@code index}\n+     * @throws ArrayIndexOutOfBoundsException if not {@code 0 <= index < size()}\n      */\n     @Nonnull\n     public RecordId getRecordId(int index) {",
                "deletions": 4
            },
            {
                "sha": "25ccd576545d5f6d4cce2454bc22dbfb9fd454ee",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMapTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/81df42a4951b96f87cbe108bf58715c8bc318b93/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMapTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/81df42a4951b96f87cbe108bf58715c8bc318b93/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMapTest.java",
                "status": "modified",
                "changes": 19,
                "additions": 19,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordIdMapTest.java?ref=81df42a4951b96f87cbe108bf58715c8bc318b93",
                "patch": "@@ -25,7 +25,10 @@\n import static org.apache.jackrabbit.oak.plugins.segment.Segment.encode;\n import static org.apache.jackrabbit.oak.plugins.segment.TestUtils.newValidOffset;\n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNull;\n import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n \n import java.util.Map;\n import java.util.Map.Entry;\n@@ -36,6 +39,22 @@\n \n public class RecordIdMapTest {\n \n+    @Test\n+    public void testEmpty() {\n+        RecordIdMap map = new RecordIdMap();\n+        assertFalse(map.containsKey((short) 0));\n+        assertNull(map.get((short) 0));\n+        assertEquals(0, map.size());\n+        try {\n+            map.getKey(0);\n+            fail(\"Expected AIOBE\");\n+        } catch (ArrayIndexOutOfBoundsException ignored) {}\n+        try {\n+            map.getRecordId(0);\n+            fail(\"Expected AIOBE\");\n+        } catch (ArrayIndexOutOfBoundsException ignored) {}\n+    }\n+\n     @Test\n     public void testRecordIdMap() {\n         int maxSegments = 1000;",
                "deletions": 0
            }
        ],
        "patched_files": [
            "RecordIdMap.java"
        ],
        "unit_tests": [
            "RecordIdMapTest.java"
        ]
    },
    "jackrabbit-oak_b9e993f": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4830: StringUtils.estimateMemoryUsage() can throw NullPointerException\n\nApplied patch by Matt Ryan\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1761696 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/b9e993fdabdbdc4ad2b941d4294904f2cdb072c1",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/9e413148245ca23bb71f959362a0936af0e25624",
        "bug_id": "jackrabbit-oak_b9e993f",
        "file": [
            {
                "sha": "f7a8cfb85ef884523f7bdfa87157164b114f2062",
                "filename": "oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b9e993fdabdbdc4ad2b941d4294904f2cdb072c1/oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b9e993fdabdbdc4ad2b941d4294904f2cdb072c1/oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java?ref=b9e993fdabdbdc4ad2b941d4294904f2cdb072c1",
                "patch": "@@ -87,6 +87,6 @@ private static int getHexDigit(String s, int i) {\n      * @return the estimated memory usage.\n      */\n     public static int estimateMemoryUsage(String s) {\n-        return 48 + s.length() * 2;\n+        return s == null ? 0 : 48 + s.length() * 2;\n     }\n }",
                "deletions": 1
            },
            {
                "sha": "5075045fadd51d31ce6fe26a3084895b1bd893da",
                "filename": "oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b9e993fdabdbdc4ad2b941d4294904f2cdb072c1/oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b9e993fdabdbdc4ad2b941d4294904f2cdb072c1/oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java",
                "status": "modified",
                "changes": 15,
                "additions": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java?ref=b9e993fdabdbdc4ad2b941d4294904f2cdb072c1",
                "patch": "@@ -16,8 +16,11 @@\n  */\n package org.apache.jackrabbit.oak.commons;\n \n+import com.google.common.collect.Maps;\n import junit.framework.TestCase;\n \n+import java.util.Map;\n+\n /**\n  * Test the string utilities.\n  */\n@@ -41,4 +44,16 @@ public void testHex() {\n         }\n     }\n \n+    public void testEstimateMemoryUsage() {\n+        final Map<String, Integer> testStrings = Maps.newHashMap();\n+        testStrings.put(null, 0);\n+        testStrings.put(\"\", 48);\n+        testStrings.put(\"a\", 50);\n+        testStrings.put(\"short string\", 72);\n+        testStrings.put(\"a much longer string than the one named 'short string'\", 156);\n+        for (final Map.Entry<String, Integer> e : testStrings.entrySet()) {\n+            assertEquals(e.getValue().intValue(), StringUtils.estimateMemoryUsage(e.getKey()));\n+        }\n+    }\n+\n }",
                "deletions": 0
            }
        ],
        "patched_files": [
            "StringUtils.java"
        ],
        "unit_tests": [
            "StringUtilsTest.java"
        ]
    },
    "jackrabbit-oak_baa97f5": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4998: NPE when starting Oak Console\nOAK-4999: ISE when starting Oak Console\n@Ignored test cases\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766525 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/baa97f5b4099d54959b604bafb234691f1a387c6",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/880afaa22cfbf7bab55f593d0350ee7e28336e49",
        "bug_id": "jackrabbit-oak_baa97f5",
        "file": [
            {
                "sha": "4efa3b7082187ef3a10da3b9693ce13a430a3c49",
                "filename": "oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/baa97f5b4099d54959b604bafb234691f1a387c6/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/baa97f5b4099d54959b604bafb234691f1a387c6/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "status": "added",
                "changes": 71,
                "additions": 71,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java?ref=baa97f5b4099d54959b604bafb234691f1a387c6",
                "patch": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.console;\n+\n+import static org.apache.jackrabbit.oak.segment.file.FileStoreBuilder.fileStoreBuilder;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import org.apache.jackrabbit.oak.api.CommitFailedException;\n+import org.apache.jackrabbit.oak.segment.file.FileStore;\n+import org.apache.jackrabbit.oak.segment.file.InvalidFileStoreVersionException;\n+import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n+import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n+import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeStore;\n+import org.junit.Ignore;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+public class SegmentTarFixtureTest {\n+    @Rule\n+    public TemporaryFolder folder = new TemporaryFolder(new File(\"target\"));\n+\n+    @Test\n+    @Ignore(\"OAK-4999\")  // FIXME OAK-4999\n+    public void testReadWrite() throws IOException, CommitFailedException {\n+        try (NodeStoreFixture fixture = SegmentTarFixture.create(folder.getRoot(), false, null)) {\n+            NodeStore store = fixture.getStore();\n+            NodeBuilder builder = store.getRoot().builder();\n+            builder.setChildNode(\"foo\");\n+            store.merge(builder, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n+        }\n+    }\n+\n+    @Test\n+    @Ignore(\"OAK-4998\")  // FIXME OAK-4998\n+    public void testReadOnly()\n+    throws IOException, CommitFailedException, InvalidFileStoreVersionException {\n+        File directory = folder.getRoot();\n+        createStoreAt(directory);\n+\n+\n+        try (NodeStoreFixture fixture = SegmentTarFixture.create(directory, true, null)) {\n+            NodeStore s = fixture.getStore();\n+            NodeBuilder builder = s.getRoot().builder();\n+            builder.setChildNode(\"foo\");\n+            s.merge(builder, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n+        }\n+    }\n+\n+    private static void createStoreAt(File path) throws InvalidFileStoreVersionException, IOException {\n+        FileStore store = fileStoreBuilder(path).build();\n+        store.close();\n+    }\n+}",
                "deletions": 0
            }
        ],
        "patched_files": [
            "SegmentTarFixture.java"
        ],
        "unit_tests": [
            "SegmentTarFixtureTest.java"
        ]
    },
    "jackrabbit-oak_5cc0e30": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4986: RDBDocumentStore: potential NPE in document read\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766554 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5cc0e30fad5b798514e98dce1727672aa74dacb0",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/00ab785367a8b9c191165811cb1371d8491a4bd0",
        "bug_id": "jackrabbit-oak_5cc0e30",
        "file": [
            {
                "sha": "c5b584e573ed67a25a57a4d814796468caf8216e",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java",
                "status": "modified",
                "changes": 6,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentSerializer.java?ref=5cc0e30fad5b798514e98dce1727672aa74dacb0",
                "patch": "@@ -16,6 +16,7 @@\n  */\n package org.apache.jackrabbit.oak.plugins.document.rdb;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n import static org.apache.jackrabbit.oak.plugins.document.rdb.RDBJSONSupport.appendJsonMember;\n import static org.apache.jackrabbit.oak.plugins.document.rdb.RDBJSONSupport.appendJsonString;\n import static org.apache.jackrabbit.oak.plugins.document.rdb.RDBJSONSupport.appendJsonValue;\n@@ -144,6 +145,10 @@ public String asString(UpdateOp update) {\n      */\n     @Nonnull\n     public <T extends Document> T fromRow(@Nonnull Collection<T> collection, @Nonnull RDBRow row) throws DocumentStoreException {\n+\n+        final String charData = row.getData();\n+        checkNotNull(charData, \"RDBRow.getData() is null for collection \" + collection + \", id: \" + row.getId());\n+\n         T doc = collection.newDocument(store);\n         doc.put(ID, row.getId());\n         if (row.getModified() != RDBRow.LONG_UNSET) {\n@@ -181,7 +186,6 @@ public String asString(UpdateOp update) {\n             throw new DocumentStoreException(ex);\n         }\n \n-        String charData = row.getData();\n         json = new JsopTokenizer(charData);\n \n         // start processing the VARCHAR data",
                "deletions": 1
            },
            {
                "sha": "51e1342fc765c5e577e4b276280d48577a635396",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5cc0e30fad5b798514e98dce1727672aa74dacb0/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java?ref=5cc0e30fad5b798514e98dce1727672aa74dacb0",
                "patch": "@@ -631,7 +631,7 @@ public long determineServerTimeDifferenceMillis(Connection connection) {\n     @CheckForNull\n     public RDBRow read(Connection connection, RDBTableMetaData tmd, String id, long lastmodcount, long lastmodified) throws SQLException {\n \n-        boolean useCaseStatement = lastmodcount != -1 && this.dbInfo.allowsCaseInSelect();\n+        boolean useCaseStatement = lastmodcount != -1 && lastmodified >= 1 && this.dbInfo.allowsCaseInSelect();\n         StringBuffer sql = new StringBuffer();\n         sql.append(\"select MODIFIED, MODCOUNT, CMODCOUNT, HASBINARY, DELETEDONCE, \");\n         if (useCaseStatement) {",
                "deletions": 1
            }
        ],
        "patched_files": [
            "RDBDocumentSerializer.java",
            "RDBDocumentStoreJDBC.java"
        ],
        "unit_tests": [
            "RDBDocumentStoreJDBCTest.java",
            "RDBDocumentSerializerTest.java"
        ]
    },
    "jackrabbit-oak_d6a2d3d": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2930 - RDBBlob/DocumentStore: do not NPE calls after dispose()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1682494 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/39e931e22fe8a579822f622bd6328116ab25c9d6",
        "bug_id": "jackrabbit-oak_d6a2d3d",
        "file": [
            {
                "sha": "43ec7303b8cdacc642f677341e3653edbe5b4d57",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBBlobStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBBlobStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBBlobStore.java",
                "status": "modified",
                "changes": 8,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBBlobStore.java?ref=d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4",
                "patch": "@@ -100,12 +100,16 @@ public void close() {\n                 }\n             }\n         }\n-        this.ch = null;\n+        try {\n+            this.ch.close();\n+        } catch (IOException ex) {\n+            LOG.error(\"closing connection handler\", ex);\n+        }\n     }\n \n     @Override\n     protected void finalize() {\n-        if (this.ch != null && this.callStack != null) {\n+        if (!this.ch.isClosed() && this.callStack != null) {\n             LOG.debug(\"finalizing RDBDocumentStore that was not disposed\", this.callStack);\n         }\n     }",
                "deletions": 2
            },
            {
                "sha": "1a6b8a15f4fca3412ed63b538fc94c20d54b5fb8",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBConnectionHandler.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBConnectionHandler.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBConnectionHandler.java",
                "status": "modified",
                "changes": 29,
                "additions": 25,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBConnectionHandler.java?ref=d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4",
                "patch": "@@ -16,6 +16,8 @@\n  */\n package org.apache.jackrabbit.oak.plugins.document.rdb;\n \n+import java.io.Closeable;\n+import java.io.IOException;\n import java.sql.Connection;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n@@ -32,9 +34,10 @@\n /**\n  * Utility functions for connection handling.\n  */\n-public class RDBConnectionHandler {\n+public class RDBConnectionHandler implements Closeable {\n \n-    private final DataSource ds;\n+    private DataSource ds;\n+    private long closedTime = 0L;\n \n     private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(RDBConnectionHandler.class);\n \n@@ -56,7 +59,7 @@ public RDBConnectionHandler(@Nonnull DataSource ds) {\n      * Obtain a {@link Connection} suitable for read-only operations.\n      */\n     public @Nonnull Connection getROConnection() throws SQLException {\n-        Connection c = this.ds.getConnection();\n+        Connection c = getDataSource().getConnection();\n         c.setAutoCommit(false);\n         setReadOnly(c, true);\n         return c;\n@@ -66,7 +69,7 @@ public RDBConnectionHandler(@Nonnull DataSource ds) {\n      * Obtain a {@link Connection} suitable for read-write operations.\n      */\n     public @Nonnull Connection getRWConnection() throws SQLException {\n-        Connection c = this.ds.getConnection();\n+        Connection c = getDataSource().getConnection();\n         c.setAutoCommit(false);\n         setReadOnly(c, false);\n         return c;\n@@ -139,6 +142,24 @@ public ResultSet closeResultSet(@CheckForNull ResultSet rs) {\n         return null;\n     }\n \n+    public boolean isClosed() {\n+        return this.ds == null;\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        this.ds = null;\n+        this.closedTime = System.currentTimeMillis();\n+    }\n+\n+    private DataSource getDataSource() throws IllegalStateException {\n+        DataSource result = this.ds;\n+        if (result == null) {\n+            throw new IllegalStateException(\"Connection handler is already closed (\"\n+                    + (System.currentTimeMillis() - this.closedTime) + \"ms ago)\");\n+        }\n+        return result;\n+    }\n \n     // workaround for broken connection wrappers\n     // see https://issues.apache.org/jira/browse/OAK-2918",
                "deletions": 4
            },
            {
                "sha": "1082f3885ee9cdb90792029da842b3b040f89e73",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java",
                "status": "modified",
                "changes": 8,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStore.java?ref=d6a2d3ddcfbb56f5fc5e7e02e76a4c58bdbbeab4",
                "patch": "@@ -347,7 +347,11 @@ public void dispose() {\n             }\n             this.droppedTables = dropped.trim();\n         }\n-        this.ch = null;\n+        try {\n+            this.ch.close();\n+        } catch (IOException ex) {\n+            LOG.error(\"closing connection handler\", ex);\n+        }\n     }\n \n     @Override\n@@ -911,7 +915,7 @@ private void createTableFor(Connection con, Collection<? extends Document> col,\n \n     @Override\n     protected void finalize() {\n-        if (this.ch != null && this.callStack != null) {\n+        if (!this.ch.isClosed() && this.callStack != null) {\n             LOG.debug(\"finalizing RDBDocumentStore that was not disposed\", this.callStack);\n         }\n     }",
                "deletions": 2
            }
        ],
        "patched_files": [
            "RDBBlobStore.java"
        ],
        "unit_tests": [
            "RDBBlobStoreTest.java"
        ]
    },
    "jackrabbit-oak_7b9355d": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6410: NPE when removing inexistent property from checked in node\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1800613 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/7b9355dc640a941bb98f9298a2b248c72c6b816d",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/9bd923c6c4ef701ae5a14e4767bdb4d9ae02f4cc",
        "bug_id": "jackrabbit-oak_7b9355d",
        "file": [
            {
                "sha": "52cb25a4b9ec143bc0cf26f929879e300c0c1ca5",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/NodeImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7b9355dc640a941bb98f9298a2b248c72c6b816d/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/NodeImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7b9355dc640a941bb98f9298a2b248c72c6b816d/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/NodeImpl.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/NodeImpl.java?ref=7b9355dc640a941bb98f9298a2b248c72c6b816d",
                "patch": "@@ -1446,7 +1446,9 @@ private Property internalRemoveProperty(final String jcrName)\n             public void checkPreconditions() throws RepositoryException {\n                 super.checkPreconditions();\n                 PropertyDelegate property = dlg.getPropertyOrNull(oakName);\n-                if (!isCheckedOut() && getOPV(dlg.getTree(), property.getPropertyState()) != OnParentVersionAction.IGNORE) {\n+                if (property != null &&\n+                        !isCheckedOut() &&\n+                        getOPV(dlg.getTree(), property.getPropertyState()) != OnParentVersionAction.IGNORE) {\n                     throw new VersionException(format(\n                             \"Cannot remove property. Node [%s] is checked in.\", getNodePath()));\n                 }",
                "deletions": 1
            },
            {
                "sha": "6526b3757d918d5d4fa5deb36313b7ebc2499597",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7b9355dc640a941bb98f9298a2b248c72c6b816d/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7b9355dc640a941bb98f9298a2b248c72c6b816d/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java?ref=7b9355dc640a941bb98f9298a2b248c72c6b816d",
                "patch": "@@ -1225,7 +1225,6 @@ public void setPropertyAgain() throws RepositoryException {\n     }\n \n     // OAK-6410\n-    @Ignore(\"OAK-6410\")\n     @Test\n     public void setInexistentProperty() throws RepositoryException {\n         Node node = getNode(TEST_PATH);",
                "deletions": 1
            }
        ],
        "patched_files": [
            "NodeImpl.java"
        ],
        "unit_tests": [
            "RepositoryTest.java"
        ]
    },
    "jackrabbit-oak_7e2905c": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6493 - LuceneIndexProviderService.enableHybridIndexing=false results in NullPointerException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1802938 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/7e2905cfb0221cc6c77b60b3761b17f6233c668f",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/444c5c968d7c9aa482c0082b4a359ebd40ca0162",
        "bug_id": "jackrabbit-oak_7e2905c",
        "file": [
            {
                "sha": "59dff61291ff9ea508d739b5daff601c41cb67a3",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProvider.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7e2905cfb0221cc6c77b60b3761b17f6233c668f/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProvider.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7e2905cfb0221cc6c77b60b3761b17f6233c668f/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProvider.java",
                "status": "modified",
                "changes": 8,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProvider.java?ref=7e2905cfb0221cc6c77b60b3761b17f6233c668f",
                "patch": "@@ -68,6 +68,7 @@\n     private final ActiveDeletedBlobCollector activeDeletedBlobCollector;\n     private GarbageCollectableBlobStore blobStore;\n     private IndexingQueue indexingQueue;\n+    private boolean nrtIndexingEnabled;\n \n     /**\n      * Number of indexed Lucene document that can be held in memory\n@@ -134,7 +135,7 @@ public Editor getIndexEditor(\n             LuceneIndexWriterFactory writerFactory = indexWriterFactory;\n             IndexDefinition indexDefinition = null;\n             boolean asyncIndexing = true;\n-            if (!indexingContext.isAsync() && IndexDefinition.supportsSyncOrNRTIndexing(definition)) {\n+            if (nrtIndexingEnabled() && !indexingContext.isAsync() && IndexDefinition.supportsSyncOrNRTIndexing(definition)) {\n \n                 //Would not participate in reindexing. Only interested in\n                 //incremental indexing\n@@ -221,12 +222,17 @@ public void setBlobStore(@Nullable GarbageCollectableBlobStore blobStore) {\n \n     public void setIndexingQueue(IndexingQueue indexingQueue) {\n         this.indexingQueue = indexingQueue;\n+        this.nrtIndexingEnabled = indexingQueue != null;\n     }\n \n     GarbageCollectableBlobStore getBlobStore() {\n         return blobStore;\n     }\n \n+    private boolean nrtIndexingEnabled() {\n+        return nrtIndexingEnabled;\n+    }\n+\n     private static CommitContext getCommitContext(IndexingContext indexingContext) {\n         return (CommitContext) indexingContext.getCommitInfo().getInfo().get(CommitContext.NAME);\n     }",
                "deletions": 1
            },
            {
                "sha": "da5b6e81612501c2c7d2996dab112ed99744db16",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProviderTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7e2905cfb0221cc6c77b60b3761b17f6233c668f/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProviderTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7e2905cfb0221cc6c77b60b3761b17f6233c668f/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProviderTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexEditorProviderTest.java?ref=7e2905cfb0221cc6c77b60b3761b17f6233c668f",
                "patch": "@@ -109,7 +109,7 @@ public void editorNullInCaseOfReindex() throws Exception{\n                 null,\n                 null,\n                 Mounts.defaultMountInfoProvider());\n-\n+        editorProvider.setIndexingQueue(mock(DocumentQueue.class));\n         IndexUpdateCallback callback = new TestCallback(\"/oak:index/fooIndex\", newCommitInfo(), true, false);\n         NodeBuilder defnBuilder = createIndexDefinition(\"fooIndex\").builder();\n         Editor editor = editorProvider.getIndexEditor(TYPE_LUCENE, defnBuilder, root, callback);",
                "deletions": 1
            },
            {
                "sha": "c9310b5035ea2705da2fe4aa2182269de2b8d5a1",
                "filename": "oak-pojosr/src/test/groovy/org/apache/jackrabbit/oak/run/osgi/HybridIndexDisabledTest.groovy",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7e2905cfb0221cc6c77b60b3761b17f6233c668f/oak-pojosr/src/test/groovy/org/apache/jackrabbit/oak/run/osgi/HybridIndexDisabledTest.groovy",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7e2905cfb0221cc6c77b60b3761b17f6233c668f/oak-pojosr/src/test/groovy/org/apache/jackrabbit/oak/run/osgi/HybridIndexDisabledTest.groovy",
                "status": "modified",
                "changes": 2,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-pojosr/src/test/groovy/org/apache/jackrabbit/oak/run/osgi/HybridIndexDisabledTest.groovy?ref=7e2905cfb0221cc6c77b60b3761b17f6233c668f",
                "patch": "@@ -26,7 +26,6 @@ import org.apache.jackrabbit.oak.spi.lifecycle.RepositoryInitializer\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder\n import org.junit.After\n import org.junit.Before\n-import org.junit.Ignore\n import org.junit.Test\n \n import javax.jcr.Node\n@@ -37,7 +36,6 @@ import static org.apache.jackrabbit.oak.run.osgi.OakOSGiRepositoryFactory.REPOSI\n import static org.apache.jackrabbit.oak.run.osgi.OakOSGiRepositoryFactory.REPOSITORY_CONFIG_FILE\n \n \n-@Ignore(\"OAK-6493\")\n class HybridIndexDisabledTest extends AbstractRepositoryFactoryTest {\n     Session session\n ",
                "deletions": 2
            }
        ],
        "patched_files": [
            "LuceneIndexEditorProvider.java"
        ],
        "unit_tests": [
            "LuceneIndexEditorProviderTest.java"
        ]
    },
    "jackrabbit-oak_a181a08": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7912: ValidNamesTest: potential NPE in teardown\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1847088 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/a181a0884d77b54a72b4b217035e6c2f1dd18253",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/92486ba6d62e6c2fcc33ad0a70d6ae0e98f8586f",
        "bug_id": "jackrabbit-oak_a181a08",
        "file": [
            {
                "sha": "bcff29cba49efbdde5cb25cdf8b9f33f5a5a2b3a",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/ValidNamesTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a181a0884d77b54a72b4b217035e6c2f1dd18253/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/ValidNamesTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a181a0884d77b54a72b4b217035e6c2f1dd18253/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/ValidNamesTest.java",
                "status": "modified",
                "changes": 21,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/ValidNamesTest.java?ref=a181a0884d77b54a72b4b217035e6c2f1dd18253",
                "patch": "@@ -47,6 +47,8 @@\n     private static final String TEST_PATH = '/' + TEST_NODE;\n     private static final Map<NodeStoreFixture, NodeStore> STORES = Maps.newConcurrentMap();\n \n+    private Repository repo;\n+    private Session session;\n     private Node testNode;\n \n     private String unmappedNsPrefix;\n@@ -61,8 +63,8 @@ public ValidNamesTest(NodeStoreFixture fixture) {\n \n     @Before\n     public void setup() throws NamespaceException, RepositoryException {\n-        Repository repo = createRepository(fixture);\n-        Session session = repo.login(getAdminCredentials());\n+        repo = createRepository(fixture);\n+        session = repo.login(getAdminCredentials());\n         Node root = session.getRootNode();\n         testNode = root.addNode(TEST_NODE);\n         session.save();\n@@ -93,12 +95,15 @@ public void setup() throws NamespaceException, RepositoryException {\n \n     @After\n     public void tearDown() throws RepositoryException {\n-        Session s = testNode.getSession();\n-        s.removeItem(TEST_PATH);\n-        s.save();\n-        Repository r = s.getRepository();\n-        s.logout();\n-        dispose(r);\n+        if (session != null) {\n+            session.removeItem(TEST_PATH);\n+            session.save();\n+            session.logout();\n+        }\n+\n+        if (repo != null) {\n+            dispose(repo);\n+        }\n     }\n \n     @AfterClass",
                "deletions": 8
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "ValidNamesTest.java"
        ]
    },
    "jackrabbit-oak_e2945fb": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8700 : ExternalIdentityConflictHandler prone to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1869187 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/fc73eb4c80f1c30fa2256ab7c6b1e07a95e21ea9",
        "bug_id": "jackrabbit-oak_e2945fb",
        "file": [
            {
                "sha": "336bdd0d94a43e1e647033beecc18740c0821a44",
                "filename": "oak-auth-external/pom.xml",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a/oak-auth-external/pom.xml",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a/oak-auth-external/pom.xml",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/pom.xml?ref=e2945fb8f0cf6cffa3bc1f823ce8a088a120560a",
                "patch": "@@ -179,6 +179,11 @@\n             <artifactId>easymock</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.mockito</groupId>\n+            <artifactId>mockito-core</artifactId>\n+            <scope>test</scope>\n+        </dependency>\n         <dependency>\n             <groupId>org.slf4j</groupId>\n             <artifactId>jul-to-slf4j</artifactId>",
                "deletions": 0
            },
            {
                "sha": "c70b1be4311e94af178377e5d728b99da0bf682f",
                "filename": "oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandler.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a/oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandler.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a/oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandler.java",
                "status": "modified",
                "changes": 29,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandler.java?ref=e2945fb8f0cf6cffa3bc1f823ce8a088a120560a",
                "patch": "@@ -40,36 +40,41 @@\n \n     @NotNull\n     @Override\n-    public Resolution addExistingProperty(NodeBuilder parent, PropertyState ours, PropertyState theirs) {\n+    public Resolution addExistingProperty(@NotNull NodeBuilder parent, @NotNull PropertyState ours, @NotNull PropertyState theirs) {\n         if (ExternalIdentityConstants.REP_LAST_SYNCED.equals(ours.getName())) {\n-            merge(parent, ours, theirs);\n-            return Resolution.MERGED;\n+            return merge(parent, ours, theirs);\n         }\n         return Resolution.IGNORED;\n     }\n \n     @NotNull\n     @Override\n-    public Resolution changeChangedProperty(NodeBuilder parent, PropertyState ours, PropertyState theirs,\n-            PropertyState base) {\n+    public Resolution changeChangedProperty(@NotNull NodeBuilder parent, @NotNull PropertyState ours, @NotNull PropertyState theirs,\n+                                            @NotNull PropertyState base) {\n         if (ExternalIdentityConstants.REP_LAST_SYNCED.equals(ours.getName())) {\n-            merge(parent, ours, theirs);\n-            return Resolution.MERGED;\n+            return merge(parent, ours, theirs);\n         }\n         return Resolution.IGNORED;\n     }\n \n-    private static void merge(NodeBuilder parent, PropertyState ours, PropertyState theirs) {\n+    private static Resolution merge(@NotNull NodeBuilder parent, @NotNull PropertyState ours, @NotNull PropertyState theirs) {\n         Calendar o = parse(ours.getValue(Type.DATE));\n         Calendar t = parse(theirs.getValue(Type.DATE));\n-        Calendar v = o.before(t) ? t : o;\n-        parent.setProperty(ours.getName(), v);\n+        if (o != null) {\n+            Calendar v = o.before(t) ? t : o;\n+            parent.setProperty(ours.getName(), v);\n+            return Resolution.MERGED;\n+        } else if (t != null) {\n+            parent.setProperty(ours.getName(), t);\n+            return Resolution.MERGED;\n+        } else {\n+            return Resolution.IGNORED;\n+        }\n     }\n \n     @Override\n     @NotNull\n-    public Resolution changeDeletedProperty(@NotNull NodeBuilder parent, @NotNull PropertyState ours,\n-            @NotNull PropertyState base) {\n+    public Resolution changeDeletedProperty(@NotNull NodeBuilder parent, @NotNull PropertyState ours, @NotNull PropertyState base) {\n         return Resolution.IGNORED;\n     }\n ",
                "deletions": 12
            },
            {
                "sha": "2ef23ffa720ce77b6d90a15eb45128fa53c18ff6",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandlerTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandlerTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/e2945fb8f0cf6cffa3bc1f823ce8a088a120560a/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandlerTest.java",
                "status": "added",
                "changes": 151,
                "additions": 151,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/principal/ExternalIdentityConflictHandlerTest.java?ref=e2945fb8f0cf6cffa3bc1f823ce8a088a120560a",
                "patch": "@@ -0,0 +1,151 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.spi.security.authentication.external.impl.principal;\n+\n+import org.apache.jackrabbit.oak.api.PropertyState;\n+import org.apache.jackrabbit.oak.api.Type;\n+import org.apache.jackrabbit.oak.spi.commit.ThreeWayConflictHandler;\n+import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n+import org.apache.jackrabbit.util.ISO8601;\n+import org.junit.Test;\n+\n+import java.util.Calendar;\n+\n+import static org.apache.jackrabbit.oak.spi.security.authentication.external.impl.ExternalIdentityConstants.REP_LAST_SYNCED;\n+import static org.junit.Assert.assertSame;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.verify;\n+\n+public class ExternalIdentityConflictHandlerTest {\n+\n+    private ExternalIdentityConflictHandler handler = new ExternalIdentityConflictHandler();\n+\n+    @Test\n+    public void testAddExistingProperty() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.addExistingProperty(mock(NodeBuilder.class), mock(PropertyState.class), mock(PropertyState.class)));\n+    }\n+\n+    @Test\n+    public void testAddExistingPropertyRepLastSynced() {\n+        Calendar cal = Calendar.getInstance();\n+        String calStr = ISO8601.format(cal);\n+        cal.set(Calendar.YEAR, 2000);\n+        String calStr2 = ISO8601.format(cal);\n+\n+        PropertyState ours = when(mock(PropertyState.class).getName()).thenReturn(REP_LAST_SYNCED).getMock();\n+        when(ours.getValue(Type.DATE)).thenReturn(calStr);\n+        PropertyState theirs = when(mock(PropertyState.class).getValue(Type.DATE)).thenReturn(calStr2).getMock();\n+\n+        assertSame(ThreeWayConflictHandler.Resolution.MERGED, handler.addExistingProperty(mock(NodeBuilder.class), ours, theirs));\n+    }\n+\n+    @Test\n+    public void testChangeChangedProperty() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.changeChangedProperty(mock(NodeBuilder.class), mock(PropertyState.class), mock(PropertyState.class), mock(PropertyState.class)));\n+    }\n+\n+    @Test\n+    public void testChangeChangedPropertyRepLastSynced() {\n+        Calendar cal = Calendar.getInstance();\n+        String calStr = ISO8601.format(cal);\n+        cal.set(Calendar.YEAR, 2000);\n+        String calStr2 = ISO8601.format(cal);\n+\n+        PropertyState ours = when(mock(PropertyState.class).getName()).thenReturn(REP_LAST_SYNCED).getMock();\n+        when(ours.getValue(Type.DATE)).thenReturn(calStr2);\n+        PropertyState theirs = when(mock(PropertyState.class).getValue(Type.DATE)).thenReturn(calStr).getMock();\n+\n+        assertSame(ThreeWayConflictHandler.Resolution.MERGED, handler.changeChangedProperty(mock(NodeBuilder.class), ours, theirs, mock(PropertyState.class)));\n+    }\n+\n+    @Test\n+    public void testChangeDeletedProperty() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.changeDeletedProperty(mock(NodeBuilder.class), mock(PropertyState.class), mock(PropertyState.class)));\n+    }\n+\n+    @Test\n+    public void testDeleteDeletedProperty() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.deleteDeletedProperty(mock(NodeBuilder.class), mock(PropertyState.class)));\n+    }\n+\n+    @Test\n+    public void testDeleteChangedProperty() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.deleteChangedProperty(mock(NodeBuilder.class), mock(PropertyState.class), mock(PropertyState.class)));\n+    }\n+\n+    @Test\n+    public void testAddExistingNode() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.addExistingNode(mock(NodeBuilder.class), \"name\", mock(NodeState.class), mock(NodeState.class)));\n+    }\n+\n+    @Test\n+    public void testChangeDeletedNode() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.changeDeletedNode(mock(NodeBuilder.class), \"name\", mock(NodeState.class), mock(NodeState.class)));\n+    }\n+\n+    @Test\n+    public void testDeleteChangedNode() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.deleteChangedNode(mock(NodeBuilder.class), \"name\", mock(NodeState.class), mock(NodeState.class)));\n+    }\n+\n+    @Test\n+    public void testDeleteDeletedNode() {\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.deleteDeletedNode(mock(NodeBuilder.class), \"name\", mock(NodeState.class)));\n+    }\n+\n+    @Test\n+    public void testMergeOursCannotBeParsed() {\n+        Calendar cal = Calendar.getInstance();\n+        String calStr = ISO8601.format(cal);\n+\n+        PropertyState ours = when(mock(PropertyState.class).getName()).thenReturn(REP_LAST_SYNCED).getMock();\n+        when(ours.getValue(Type.DATE)).thenReturn(\"notParseable\");\n+        PropertyState theirs = when(mock(PropertyState.class).getValue(Type.DATE)).thenReturn(calStr).getMock();\n+\n+        NodeBuilder parent = mock(NodeBuilder.class);\n+        assertSame(ThreeWayConflictHandler.Resolution.MERGED, handler.changeChangedProperty(parent, ours, theirs, mock(PropertyState.class)));\n+        verify(parent, times(1)).setProperty(REP_LAST_SYNCED, ISO8601.parse(theirs.getValue(Type.DATE)));\n+    }\n+\n+    @Test\n+    public void testMergeTheirsCannotBeParsed() {\n+        Calendar cal = Calendar.getInstance();\n+        String calStr = ISO8601.format(cal);\n+\n+        PropertyState ours = when(mock(PropertyState.class).getName()).thenReturn(REP_LAST_SYNCED).getMock();\n+        when(ours.getValue(Type.DATE)).thenReturn(calStr);\n+        PropertyState theirs = when(mock(PropertyState.class).getValue(Type.DATE)).thenReturn(\"notParseable\").getMock();\n+\n+        NodeBuilder parent = mock(NodeBuilder.class);\n+        assertSame(ThreeWayConflictHandler.Resolution.MERGED, handler.changeChangedProperty(parent, ours, theirs, mock(PropertyState.class)));\n+        verify(parent, times(1)).setProperty(REP_LAST_SYNCED, ISO8601.parse(ours.getValue(Type.DATE)));\n+    }\n+\n+    @Test\n+    public void testMergeNoneCannotBeParsed() {\n+        PropertyState ours = when(mock(PropertyState.class).getName()).thenReturn(REP_LAST_SYNCED).getMock();\n+        when(ours.getValue(Type.DATE)).thenReturn(\"notParseable1\");\n+        PropertyState theirs = when(mock(PropertyState.class).getValue(Type.DATE)).thenReturn(\"notParseable2\").getMock();\n+\n+        NodeBuilder parent = mock(NodeBuilder.class);\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.changeChangedProperty(parent, ours, theirs, mock(PropertyState.class)));\n+        assertSame(ThreeWayConflictHandler.Resolution.IGNORED, handler.addExistingProperty(parent, ours, theirs));\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ExternalIdentityConflictHandler.java"
        ],
        "unit_tests": [
            "ExternalIdentityConflictHandlerTest.java"
        ]
    },
    "jackrabbit-oak_48efca8": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2420: DocumentNodeStore revision GC may lead to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1667782 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/48efca81de62165637b4ce11cb226d44957e7c31",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/3074f54f9771bafa6fe69f13f231d670eafd79a1",
        "bug_id": "jackrabbit-oak_48efca8",
        "file": [
            {
                "sha": "fe60e13b92b9afac7bdea538d154bb3f3114a81a",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/48efca81de62165637b4ce11cb226d44957e7c31/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/48efca81de62165637b4ce11cb226d44957e7c31/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java",
                "status": "modified",
                "changes": 47,
                "additions": 32,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java?ref=48efca81de62165637b4ce11cb226d44957e7c31",
                "patch": "@@ -18,6 +18,7 @@\n \n import static com.google.common.base.Preconditions.checkArgument;\n import static com.google.common.base.Preconditions.checkNotNull;\n+import static com.google.common.collect.Iterables.filter;\n import static com.google.common.collect.Iterables.toArray;\n import static com.google.common.collect.Iterables.transform;\n import static org.apache.jackrabbit.oak.api.CommitFailedException.MERGE;\n@@ -27,6 +28,7 @@\n import static org.apache.jackrabbit.oak.plugins.document.DocumentMK.MANY_CHILDREN_THRESHOLD;\n import static org.apache.jackrabbit.oak.plugins.document.UpdateOp.Key;\n import static org.apache.jackrabbit.oak.plugins.document.UpdateOp.Operation;\n+import static org.apache.jackrabbit.oak.plugins.document.util.Utils.getIdFromPath;\n import static org.apache.jackrabbit.oak.plugins.document.util.Utils.unshareString;\n \n import java.io.Closeable;\n@@ -60,6 +62,7 @@\n import javax.management.NotCompliantMBeanException;\n \n import com.google.common.base.Function;\n+import com.google.common.base.Predicates;\n import com.google.common.cache.Cache;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Lists;\n@@ -866,11 +869,11 @@ public DocumentNodeState call() throws Exception {\n      * @return the child documents.\n      */\n     @Nonnull\n-    Iterable<NodeDocument> readChildDocs(@Nonnull final String path,\n-                                         @Nullable String name,\n-                                         int limit) {\n-        String to = Utils.getKeyUpperLimit(checkNotNull(path));\n-        String from;\n+    private Iterable<NodeDocument> readChildDocs(@Nonnull final String path,\n+                                                 @Nullable String name,\n+                                                 final int limit) {\n+        final String to = Utils.getKeyUpperLimit(checkNotNull(path));\n+        final String from;\n         if (name != null) {\n             from = Utils.getIdFromPath(concat(path, name));\n         } else {\n@@ -881,7 +884,7 @@ public DocumentNodeState call() throws Exception {\n             // or more than 16k child docs are requested\n             return store.query(Collection.NODES, from, to, limit);\n         }\n-        StringValue key = new StringValue(path);\n+        final StringValue key = new StringValue(path);\n         // check cache\n         NodeDocument.Children c = docChildrenCache.getIfPresent(key);\n         if (c == null) {\n@@ -898,10 +901,10 @@ public DocumentNodeState call() throws Exception {\n             // fetch more and update cache\n             String lastName = c.childNames.get(c.childNames.size() - 1);\n             String lastPath = concat(path, lastName);\n-            from = Utils.getIdFromPath(lastPath);\n+            String low = Utils.getIdFromPath(lastPath);\n             int remainingLimit = limit - c.childNames.size();\n             List<NodeDocument> docs = store.query(Collection.NODES,\n-                    from, to, remainingLimit);\n+                    low, to, remainingLimit);\n             NodeDocument.Children clone = c.clone();\n             for (NodeDocument doc : docs) {\n                 String p = doc.getPath();\n@@ -911,22 +914,36 @@ public DocumentNodeState call() throws Exception {\n             docChildrenCache.put(key, clone);\n             c = clone;\n         }\n-        Iterable<NodeDocument> it = transform(c.childNames, new Function<String, NodeDocument>() {\n+        Iterable<NodeDocument> head = filter(transform(c.childNames,\n+                new Function<String, NodeDocument>() {\n             @Override\n             public NodeDocument apply(String name) {\n                 String p = concat(path, name);\n                 NodeDocument doc = store.find(Collection.NODES, Utils.getIdFromPath(p));\n                 if (doc == null) {\n-                    docChildrenCache.invalidateAll();\n-                    throw new NullPointerException(\"Document \" + p + \" not found\");\n+                    docChildrenCache.invalidate(key);\n                 }\n                 return doc;\n             }\n-        });\n-        if (c.childNames.size() > limit * 2) {\n-            it = Iterables.limit(it, limit * 2);\n+        }), Predicates.notNull());\n+        Iterable<NodeDocument> it;\n+        if (c.isComplete) {\n+            it = head;\n+        } else {\n+            // OAK-2420: 'head' may have null documents when documents are\n+            // concurrently removed from the store. concat 'tail' to fetch\n+            // more documents if necessary\n+            final String last = getIdFromPath(concat(\n+                    path, c.childNames.get(c.childNames.size() - 1)));\n+            Iterable<NodeDocument> tail = new Iterable<NodeDocument>() {\n+                @Override\n+                public Iterator<NodeDocument> iterator() {\n+                    return store.query(NODES, last, to, limit).iterator();\n+                }\n+            };\n+            it = Iterables.concat(head, tail);\n         }\n-        return it;\n+        return Iterables.limit(it, limit);\n     }\n \n     /**",
                "deletions": 15
            },
            {
                "sha": "5523258c4889be1b2a2b10e20402f5a593718455",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/48efca81de62165637b4ce11cb226d44957e7c31/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/48efca81de62165637b4ce11cb226d44957e7c31/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java",
                "status": "modified",
                "changes": 25,
                "additions": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java?ref=48efca81de62165637b4ce11cb226d44957e7c31",
                "patch": "@@ -30,6 +30,8 @@\n \n import javax.annotation.Nonnull;\n \n+import com.google.common.collect.Lists;\n+\n import org.apache.jackrabbit.oak.api.CommitFailedException;\n import org.apache.jackrabbit.oak.plugins.document.VersionGarbageCollector.VersionGCStats;\n import org.apache.jackrabbit.oak.plugins.document.memory.MemoryDocumentStore;\n@@ -41,7 +43,6 @@\n import org.apache.jackrabbit.oak.stats.Clock;\n import org.junit.After;\n import org.junit.Before;\n-import org.junit.Ignore;\n import org.junit.Test;\n \n import static java.util.concurrent.Executors.newSingleThreadExecutor;\n@@ -164,7 +165,6 @@ public void deleteLargeNumber() throws Exception{\n     }\n \n     // OAK-2420\n-    @Ignore\n     @Test\n     public void queryWhileDocsAreRemoved() throws Exception {\n         //Baseline the clock\n@@ -190,7 +190,7 @@ public void queryWhileDocsAreRemoved() throws Exception {\n         // create nodes\n         NodeBuilder builder = store.getRoot().builder();\n         NodeBuilder node = builder.child(\"node\");\n-        for (int i = 0; i < 100; i++) {\n+        for (int i = 0; i < 200; i++) {\n             node.child(\"c-\" + i);\n         }\n         merge(store, builder);\n@@ -209,23 +209,27 @@ public void queryWhileDocsAreRemoved() throws Exception {\n \n         clock.waitUntil(clock.getTime() + HOURS.toMillis(1));\n \n+        List<String> expected = Lists.newArrayList();\n         // fill caches\n         NodeState n = store.getRoot().getChildNode(\"node\");\n         for (ChildNodeEntry entry : n.getChildNodeEntries()) {\n-            entry.getName();\n+            expected.add(entry.getName());\n         }\n+        assertEquals(110, expected.size());\n \n         // invalidate the nodeChildren cache only\n         store.invalidateNodeChildrenCache();\n \n-        Future f = newSingleThreadExecutor().submit(new Callable<Object>() {\n+        Future<List<String>> f = newSingleThreadExecutor().submit(\n+                new Callable<List<String>>() {\n             @Override\n-            public Object call() throws Exception {\n+            public List<String> call() throws Exception {\n+                List<String> names = Lists.newArrayList();\n                 NodeState n = store.getRoot().getChildNode(\"node\");\n                 for (ChildNodeEntry entry : n.getChildNodeEntries()) {\n-                    entry.getName();\n+                    names.add(entry.getName());\n                 }\n-                return null;\n+                return names;\n             }\n         });\n \n@@ -235,9 +239,10 @@ public Object call() throws Exception {\n         VersionGCStats stats = gc.gc(30, MINUTES);\n         assertEquals(90, stats.deletedDocGCCount);\n \n-        queries.release(100);\n+        queries.release(200);\n \n-        f.get();\n+        List<String> names = f.get();\n+        assertEquals(expected, names);\n     }\n \n     private void merge(DocumentNodeStore store, NodeBuilder builder)",
                "deletions": 10
            }
        ],
        "patched_files": [
            "DocumentNodeStore.java"
        ],
        "unit_tests": [
            "VersionGCDeletionTest.java",
            "DocumentNodeStoreTest.java"
        ]
    },
    "jackrabbit-oak_8580c23": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7839 - minor fix to prevent NPEs in case MeterStat is not registered\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1844321 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/8580c2389d46c7fbc13ee78fd5053a958f8ec6f7",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/eb55ba5aaf9a7d432d37e982566ab7c6910aa870",
        "bug_id": "jackrabbit-oak_8580c23",
        "file": [
            {
                "sha": "422e4cacdfac974f38b337eabf915b2717896fdf",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/TrackingCorruptIndexHandler.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/8580c2389d46c7fbc13ee78fd5053a958f8ec6f7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/TrackingCorruptIndexHandler.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/8580c2389d46c7fbc13ee78fd5053a958f8ec6f7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/TrackingCorruptIndexHandler.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/TrackingCorruptIndexHandler.java?ref=8580c2389d46c7fbc13ee78fd5053a958f8ec6f7",
                "patch": "@@ -88,7 +88,7 @@ public void markWorkingIndexes(Set<String> updatedIndexPaths) {\n             CorruptIndexInfo info = indexes.remove(indexPath);\n             if (info != null){\n                 log.info(\"Index at [{}] which was so far failing {} is now working again.\", info.path, info.getStats());\n-            } else {\n+            } else if (meter != null) {\n                 meter.mark();\n             }\n         }",
                "deletions": 1
            }
        ],
        "patched_files": [
            "TrackingCorruptIndexHandler.java"
        ],
        "unit_tests": [
            "TrackingCorruptIndexHandlerTest.java"
        ]
    },
    "jackrabbit-oak_61e0362": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1593 : Guard against NPE in ConfigurationParameters.of(ConfigurationParameters...)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1580003 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/61e036252f696b699e2581db862e2bb0ffe6468e",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/eadb0078a0201ee542c84fde24f362a7e698632b",
        "bug_id": "jackrabbit-oak_61e0362",
        "file": [
            {
                "sha": "08de2e8c57b5eaff3321b68b9b96299585f87a3a",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParameters.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/61e036252f696b699e2581db862e2bb0ffe6468e/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParameters.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/61e036252f696b699e2581db862e2bb0ffe6468e/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParameters.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParameters.java?ref=61e036252f696b699e2581db862e2bb0ffe6468e",
                "patch": "@@ -83,7 +83,9 @@ private ConfigurationParameters(@Nonnull Map<String, ?> options) {\n     public static ConfigurationParameters of(@Nonnull ConfigurationParameters... params) {\n         Map<String, Object> m = new HashMap<String, Object>();\n         for (ConfigurationParameters cp : params) {\n-            m.putAll(cp.options);\n+            if (cp != null) {\n+                m.putAll(cp.options);\n+            }\n         }\n         return m.isEmpty() ? EMPTY : new ConfigurationParameters(m);\n     }",
                "deletions": 1
            },
            {
                "sha": "8fc6c0279cac506af32de49669867f6816459d8e",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParametersTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/61e036252f696b699e2581db862e2bb0ffe6468e/oak-core/src/test/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParametersTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/61e036252f696b699e2581db862e2bb0ffe6468e/oak-core/src/test/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParametersTest.java",
                "status": "renamed",
                "changes": 22,
                "additions": 20,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/spi/security/ConfigurationParametersTest.java?ref=61e036252f696b699e2581db862e2bb0ffe6468e",
                "patch": "@@ -14,14 +14,13 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package org.apache.jackrabbit.oak.security;\n+package org.apache.jackrabbit.oak.spi.security;\n \n import java.util.Calendar;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n \n-import org.apache.jackrabbit.oak.spi.security.ConfigurationParameters;\n import org.junit.After;\n import org.junit.Before;\n import org.junit.Test;\n@@ -33,6 +32,7 @@\n import static junit.framework.Assert.assertTrue;\n import static junit.framework.Assert.fail;\n import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertSame;\n \n public class ConfigurationParametersTest {\n \n@@ -42,6 +42,24 @@ public void setup() {}\n     @After\n     public void tearDown() {}\n \n+    @Test\n+    public void testCreation() {\n+        ConfigurationParameters params = ConfigurationParameters.of(\n+                ConfigurationParameters.EMPTY,\n+                null,\n+                ConfigurationParameters.of(Collections.singletonMap(\"a\", \"a\")));\n+        assertFalse(params.isEmpty());\n+        assertEquals(1, params.size());\n+        assertTrue(params.contains(\"a\"));\n+    }\n+\n+    @Test\n+    public void testCreationFromNull() {\n+        ConfigurationParameters cp = null;\n+        ConfigurationParameters params = ConfigurationParameters.of(new ConfigurationParameters[] {cp});\n+        assertSame(ConfigurationParameters.EMPTY, params);\n+    }\n+\n     @Test\n     public void testContains() {\n         ConfigurationParameters params = ConfigurationParameters.EMPTY;",
                "deletions": 2,
                "previous_filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/ConfigurationParametersTest.java"
            }
        ],
        "patched_files": [
            "ConfigurationParameters.java"
        ],
        "unit_tests": [
            "ConfigurationParametersTest.java"
        ]
    },
    "jackrabbit-oak_c61d6a2": {
        "repo": "jackrabbit-oak",
        "message": "OAK-5002: NPE when creating read only store\nIntroduce a segment writer that throws an exception when written to\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766548 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/02776f5169a6382c2891ed2768f084c8a5188de6",
        "bug_id": "jackrabbit-oak_c61d6a2",
        "file": [
            {
                "sha": "4470492e508f0da5d5cbe1974ec5f128f185141c",
                "filename": "oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/SegmentWriterBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/SegmentWriterBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/SegmentWriterBuilder.java",
                "status": "modified",
                "changes": 29,
                "additions": 29,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/SegmentWriterBuilder.java?ref=c61d6a280ecdf001f9708b9059e27dbbaaf89ecc",
                "patch": "@@ -21,12 +21,15 @@\n \n import static com.google.common.base.Preconditions.checkNotNull;\n \n+import java.io.IOException;\n+\n import javax.annotation.Nonnull;\n \n import com.google.common.base.Supplier;\n import com.google.common.base.Suppliers;\n import org.apache.jackrabbit.oak.segment.WriterCacheManager.Empty;\n import org.apache.jackrabbit.oak.segment.file.FileStore;\n+import org.apache.jackrabbit.oak.segment.file.ReadOnlyFileStore;\n import org.apache.jackrabbit.oak.segment.http.HttpStore;\n import org.apache.jackrabbit.oak.segment.memory.MemoryStore;\n \n@@ -152,6 +155,32 @@ public SegmentWriter build(@Nonnull FileStore store) {\n         );\n     }\n \n+    /**\n+     * Build a {@code SegmentWriter} for a {@code ReadOnlyFileStore}.\n+     * Attempting to write to the returned writer will cause a\n+     * {@code UnsupportedOperationException} to be thrown.\n+     */\n+    @Nonnull\n+    public SegmentWriter build(@Nonnull ReadOnlyFileStore store) {\n+        return new SegmentWriter(\n+                checkNotNull(store),\n+                store.getReader(),\n+                store.getBlobStore(),\n+                cacheManager,\n+                new WriteOperationHandler() {\n+                    @Nonnull\n+                    @Override\n+                    public RecordId execute(@Nonnull WriteOperation writeOperation) throws IOException {\n+                        throw new UnsupportedOperationException(\"Cannot write to read-only store\");\n+                    }\n+\n+                    @Override\n+                    public void flush() throws IOException {\n+                        throw new UnsupportedOperationException(\"Cannot write to read-only store\");\n+                    }\n+                });\n+    }\n+\n     /**\n      * Build a {@code SegmentWriter} for a {@code MemoryStore}.\n      */",
                "deletions": 0
            },
            {
                "sha": "e8ddb7c5e5a344345176b087be7833821ae3a14e",
                "filename": "oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/AbstractFileStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/AbstractFileStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/AbstractFileStore.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/AbstractFileStore.java?ref=c61d6a280ecdf001f9708b9059e27dbbaaf89ecc",
                "patch": "@@ -265,6 +265,7 @@ public SegmentTracker getTracker() {\n         return tracker;\n     }\n \n+    @Nonnull\n     public abstract SegmentWriter getWriter();\n \n     @Nonnull",
                "deletions": 0
            },
            {
                "sha": "76b30b9ed947080882a125883a95a948eebbafc7",
                "filename": "oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/ReadOnlyFileStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/ReadOnlyFileStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/ReadOnlyFileStore.java",
                "status": "modified",
                "changes": 9,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-segment-tar/src/main/java/org/apache/jackrabbit/oak/segment/file/ReadOnlyFileStore.java?ref=c61d6a280ecdf001f9708b9059e27dbbaaf89ecc",
                "patch": "@@ -24,6 +24,7 @@\n import static com.google.common.collect.Maps.newHashMap;\n import static com.google.common.collect.Sets.newHashSet;\n import static java.util.Collections.emptyMap;\n+import static org.apache.jackrabbit.oak.segment.SegmentWriterBuilder.segmentWriterBuilder;\n \n import java.io.File;\n import java.io.IOException;\n@@ -61,6 +62,9 @@\n \n     private final List<TarReader> readers;\n \n+    @Nonnull\n+    private final SegmentWriter writer;\n+\n     private ReadOnlyRevisions revisions;\n \n     private RecordId currentHead;\n@@ -84,6 +88,8 @@\n             boolean recover = i == indices.length - 1;\n             readers.add(TarReader.openRO(map.get(indices[i]), memoryMapping, recover, recovery));\n         }\n+\n+        writer = segmentWriterBuilder(\"read-only\").withoutCache().build(this);\n         log.info(\"TarMK ReadOnly opened: {} (mmap={})\", directory,\n                 memoryMapping);\n     }\n@@ -209,9 +215,10 @@ public void close() {\n         log.info(\"TarMK closed: {}\", directory);\n     }\n \n+    @Nonnull\n     @Override\n     public SegmentWriter getWriter() {\n-        return null;\n+        return writer;\n     }\n \n     public Map<String, Set<UUID>> getTarReaderIndex() {",
                "deletions": 1
            },
            {
                "sha": "7d6a0fdf08fa1cd306a3608668b94fa040e2245e",
                "filename": "oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c61d6a280ecdf001f9708b9059e27dbbaaf89ecc/oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java",
                "status": "modified",
                "changes": 23,
                "additions": 19,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java?ref=c61d6a280ecdf001f9708b9059e27dbbaaf89ecc",
                "patch": "@@ -19,16 +19,21 @@\n package org.apache.jackrabbit.oak.segment;\n \n import static org.apache.jackrabbit.oak.segment.file.FileStoreBuilder.fileStoreBuilder;\n+import static org.junit.Assert.assertEquals;\n \n import java.io.File;\n import java.io.IOException;\n \n+import org.apache.jackrabbit.oak.api.CommitFailedException;\n import org.apache.jackrabbit.oak.segment.file.FileStore;\n import org.apache.jackrabbit.oak.segment.file.InvalidFileStoreVersionException;\n import org.apache.jackrabbit.oak.segment.file.ReadOnlyFileStore;\n+import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n+import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n+import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.junit.After;\n import org.junit.Before;\n-import org.junit.Ignore;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n@@ -38,12 +43,14 @@\n     public TemporaryFolder folder = new TemporaryFolder(new File(\"target\"));\n \n     private ReadOnlyFileStore fileStore;\n+    private SegmentNodeStore store;\n \n     @Before\n     public void setup() throws IOException, InvalidFileStoreVersionException {\n         File path = folder.getRoot();\n         initStoreAt(path);\n         fileStore = fileStoreBuilder(path).buildReadOnly();\n+        store = SegmentNodeStoreBuilders.builder(fileStore).build();\n     }\n \n     private static void initStoreAt(File path) throws InvalidFileStoreVersionException, IOException {\n@@ -57,8 +64,16 @@ public void tearDown() {\n     }\n \n     @Test\n-    @Ignore(\"OAK-5002\")  // FIXME OAK-5002\n-    public void createStore() {\n-        SegmentNodeStoreBuilders.builder(fileStore).build();\n+    public void getRoot() {\n+        NodeState root = store.getRoot();\n+        assertEquals(0, root.getChildNodeCount(1));\n     }\n+\n+    @Test(expected = UnsupportedOperationException.class)\n+    public void setRoot() throws CommitFailedException {\n+        NodeBuilder root = store.getRoot().builder();\n+        root.setChildNode(\"foo\");\n+        store.merge(root, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n+    }\n+\n }",
                "deletions": 4
            }
        ],
        "patched_files": [
            "SegmentWriterBuilder.java",
            "AbstractFileStore.java",
            "ReadOnlyFileStore.java"
        ],
        "unit_tests": [
            "ReadOnlyStoreTest.java"
        ]
    },
    "jackrabbit-oak_efb99d1": {
        "repo": "jackrabbit-oak",
        "message": "OAK-60: workaround for NPEs in derived classes\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1325296 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/efb99d1cdd803881f4f77ba279d1b82f51908535",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/832f89b221d34d728fa04ac43de5dede54c356ab",
        "bug_id": "jackrabbit-oak_efb99d1",
        "file": [
            {
                "sha": "da6487740625821e0053cb442e6ce800b7f72e97",
                "filename": "oak-mk/src/test/java/org/apache/jackrabbit/mk/blobs/DbBlobStoreTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/efb99d1cdd803881f4f77ba279d1b82f51908535/oak-mk/src/test/java/org/apache/jackrabbit/mk/blobs/DbBlobStoreTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/efb99d1cdd803881f4f77ba279d1b82f51908535/oak-mk/src/test/java/org/apache/jackrabbit/mk/blobs/DbBlobStoreTest.java",
                "status": "modified",
                "changes": 5,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mk/src/test/java/org/apache/jackrabbit/mk/blobs/DbBlobStoreTest.java?ref=efb99d1cdd803881f4f77ba279d1b82f51908535",
                "patch": "@@ -62,7 +62,10 @@ public void tearDown() throws Exception {\n             sentinel.close();\n         }\n         store.close();\n-        cp.dispose();\n+\n+        if (cp != null) {\n+            cp.dispose();\n+        }\n     }\n \n     public void testAddFile() throws Exception {",
                "deletions": 1
            }
        ],
        "patched_files": [
            "DbBlobStore.java"
        ],
        "unit_tests": [
            "DbBlobStoreTest.java"
        ]
    },
    "jackrabbit-oak_609bf1e": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6486: NPE in CompositeNodeStore\n\nDon't use lazy loading for the CompositeNodeBuilder#getBaseState()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1802912 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/dd00cdfd720893ec08f67d108bc5787bf3cf5008",
        "bug_id": "jackrabbit-oak_609bf1e",
        "file": [
            {
                "sha": "4f66417530a626a9b236a2b821008897a4a7fedd",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java?ref=609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb",
                "patch": "@@ -84,7 +84,7 @@ private CompositeNodeBuilder(String path, Map<MountedNodeStore, NodeBuilder> nod\n \n     @Override\n     public CompositeNodeState getNodeState() {\n-        return new CompositeNodeState(path, new IdentityHashMap<>(buildersToNodeStates(nodeBuilders)), ctx);\n+        return new CompositeNodeState(path, buildersToNodeStates(nodeBuilders), ctx);\n     }\n \n     @Override\n@@ -93,7 +93,7 @@ public CompositeNodeState getBaseState() {\n     }\n \n     private static Map<MountedNodeStore, NodeState> buildersToNodeStates(Map<MountedNodeStore, NodeBuilder> builders) {\n-        return transformValues(builders, new Function<NodeBuilder, NodeState>() {\n+        return new IdentityHashMap<>(transformValues(builders, new Function<NodeBuilder, NodeState>() {\n             @Override\n             public NodeState apply(NodeBuilder input) {\n                 if (input.exists()) {\n@@ -102,7 +102,7 @@ public NodeState apply(NodeBuilder input) {\n                     return MISSING_NODE;\n                 }\n             }\n-        });\n+        }));\n     }\n \n     private static Map<MountedNodeStore, NodeState> buildersToBaseStates(Map<MountedNodeStore, NodeBuilder> builders) {",
                "deletions": 3
            },
            {
                "sha": "cbbb348ae84af52539f12fc6de311db5d1393974",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java?ref=609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb",
                "patch": "@@ -324,7 +324,7 @@ public NodeState retrieve(String checkpoint) {\n             LOG.warn(\"Checkpoint {} doesn't exist. Debug info:\\n{}\", checkpoint, checkpointDebugInfo());\n             return null;\n         }\n-        return new CompositeNodeState(\"/\", nodeStates, ctx);\n+        return ctx.createRootNodeState(nodeStates);\n     }\n \n     @Override",
                "deletions": 1
            },
            {
                "sha": "48ade28651a67f98ee1da953175b6dcea4c26ebc",
                "filename": "oak-store-composite/src/test/java/org/apache/jackrabbit/oak/composite/CompositeChildrenCountTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb/oak-store-composite/src/test/java/org/apache/jackrabbit/oak/composite/CompositeChildrenCountTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb/oak-store-composite/src/test/java/org/apache/jackrabbit/oak/composite/CompositeChildrenCountTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/test/java/org/apache/jackrabbit/oak/composite/CompositeChildrenCountTest.java?ref=609bf1e8b6e9d0edaee161a66cd492f2c36fb8eb",
                "patch": "@@ -169,7 +169,7 @@ public TestingNodeState configureMount(String mountPath, String... children) {\n         }\n \n         public CompositeNodeState getNodeState() {\n-            return new CompositeNodeState(\"/\", rootStates, ctx);\n+            return ctx.createRootNodeState(rootStates);\n         }\n \n         public CompositeNodeStoreBuilder clear() {",
                "deletions": 1
            }
        ],
        "patched_files": [
            "CompositeNodeStore.java",
            "CompositeNodeBuilder.java"
        ],
        "unit_tests": [
            "CompositeChildrenCountTest.java",
            "CompositeNodeStoreTest.java"
        ]
    },
    "jackrabbit-oak_49e2ab5": {
        "repo": "jackrabbit-oak",
        "message": "OAK-720 - avoid possible NPE in UpToDate NSC\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1461454 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/49e2ab570e2bb1cd0835c223b213348ba08c71ee",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/4b8097aa5b2f203fa2b2763e89aa8bb5aed4b2f8",
        "bug_id": "jackrabbit-oak_49e2ab5",
        "file": [
            {
                "sha": "ba9299488d2cadc544600f85aba1e1b00770d71e",
                "filename": "oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/server/UpToDateNodeStateConfiguration.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/49e2ab570e2bb1cd0835c223b213348ba08c71ee/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/server/UpToDateNodeStateConfiguration.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/49e2ab570e2bb1cd0835c223b213348ba08c71ee/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/server/UpToDateNodeStateConfiguration.java",
                "status": "modified",
                "changes": 5,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-solr-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/solr/server/UpToDateNodeStateConfiguration.java?ref=49e2ab570e2bb1cd0835c223b213348ba08c71ee",
                "patch": "@@ -37,7 +37,10 @@ public UpToDateNodeStateConfiguration(NodeStore store, String path) {\n     protected NodeState getConfigurationNodeState() {\n         NodeState currentState = store.getRoot();\n         for (String child : path.split(\"/\")) {\n-            currentState = currentState.getChildNode(child);\n+            NodeState childNode = currentState.getChildNode(child);\n+            if (childNode != null) {\n+                currentState = childNode;\n+            }\n         }\n         return currentState;\n     }",
                "deletions": 1
            },
            {
                "sha": "a585612df7abaae710a6270a51b7643fde43d899",
                "filename": "oak-solr-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrIndexQueryTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/49e2ab570e2bb1cd0835c223b213348ba08c71ee/oak-solr-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrIndexQueryTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/49e2ab570e2bb1cd0835c223b213348ba08c71ee/oak-solr-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrIndexQueryTest.java",
                "status": "modified",
                "changes": 10,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-solr-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/solr/query/SolrIndexQueryTest.java?ref=49e2ab570e2bb1cd0835c223b213348ba08c71ee",
                "patch": "@@ -78,15 +78,7 @@ protected ContentRepository createRepository() {\n \n     private NodeState createMockedConfigurationNodeState() {\n         NodeState mockedNodeState = mock(NodeState.class);\n-        when(mockedNodeState.getProperty(anyString())).thenReturn(null);\n-//        when(mockedNodeState.getProperty(OakSolrNodeStateConfiguration.Properties.SOLRHOME_PATH)).\n-//                thenReturn(PropertyStates.createProperty(OakSolrNodeStateConfiguration.Properties.SOLRHOME_PATH, TestUtils.SOLR_HOME_PATH));\n-//        when(mockedNodeState.getProperty(OakSolrNodeStateConfiguration.Properties.SOLRCONFIG_PATH)).\n-//                thenReturn(PropertyStates.createProperty(OakSolrNodeStateConfiguration.Properties.SOLRCONFIG_PATH, TestUtils.SOLRCONFIG_PATH));\n-//        when(mockedNodeState.getProperty(OakSolrNodeStateConfiguration.Properties.PATH_FIELD)).\n-//                thenReturn(PropertyStates.createProperty(OakSolrNodeStateConfiguration.Properties.PATH_FIELD, \"path_exact\"));\n-//        when(mockedNodeState.getProperty(OakSolrNodeStateConfiguration.Properties.COMMIT_POLICY)).\n-//                thenReturn(PropertyStates.createProperty(OakSolrNodeStateConfiguration.Properties.COMMIT_POLICY, \"HARD\"));\n+        when(mockedNodeState.getProperty(anyString())).thenReturn(null); // this triggers defaults\n         return mockedNodeState;\n     }\n ",
                "deletions": 9
            }
        ],
        "patched_files": [
            "UpToDateNodeStateConfiguration.java"
        ],
        "unit_tests": [
            "UpToDateNodeStateConfigurationTest.java",
            "SolrIndexQueryTest.java"
        ]
    },
    "jackrabbit-oak_958223c": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6486: NPE in CompositeNodeStore\n\nReplaced the CopyOnReadIdentityMap with a Function<MountedNodeStore, NodeState>\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1803029 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/958223cabe378fac83a77fca359748ec3bd9dc3a",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/79a66bca4c6ca6afc91c03b6b690f7ca454b5004",
        "bug_id": "jackrabbit-oak_958223c",
        "file": [
            {
                "sha": "136bec295b80a2cec3bcf59c1c77210487944b76",
                "filename": "oak-it/src/test/java/org/apache/jackrabbit/oak/composite/CompositeNodeStoreTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-it/src/test/java/org/apache/jackrabbit/oak/composite/CompositeNodeStoreTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-it/src/test/java/org/apache/jackrabbit/oak/composite/CompositeNodeStoreTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-it/src/test/java/org/apache/jackrabbit/oak/composite/CompositeNodeStoreTest.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -82,7 +82,6 @@\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n import org.junit.After;\n import org.junit.Before;\n-import org.junit.Ignore;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.Parameterized;",
                "deletions": 1
            },
            {
                "sha": "25e28da4a28cfc154efc1088a62ced139602eb70",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java",
                "status": "modified",
                "changes": 11,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -20,7 +20,6 @@\n import org.apache.jackrabbit.oak.spi.commit.CommitHook;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n import org.apache.jackrabbit.oak.spi.state.ApplyDiff;\n-import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n import org.apache.jackrabbit.oak.spi.state.NodeState;\n \n import javax.annotation.Nonnull;\n@@ -33,15 +32,15 @@\n \n     private final CompositionContext ctx;\n \n-    private final Map<MountedNodeStore, NodeBuilder> builders;\n+    private final CompositeNodeBuilder builder;\n \n     private final CommitHook hook;\n \n     private Optional<CompositeNodeBuilder> updatedBuilder = Optional.empty();\n \n-    CommitHookEnhancer(CommitHook hook, CompositionContext ctx, Map<MountedNodeStore, NodeBuilder> builders) {\n+    CommitHookEnhancer(CommitHook hook, CompositionContext ctx, CompositeNodeBuilder builder) {\n         this.ctx = ctx;\n-        this.builders = builders;\n+        this.builder = builder;\n         this.hook = hook;\n     }\n \n@@ -51,8 +50,8 @@ public NodeState processCommit(NodeState before, NodeState after, CommitInfo inf\n         Map<MountedNodeStore, NodeState> beforeStates = newHashMap();\n         Map<MountedNodeStore, NodeState> afterStates = newHashMap();\n         for (MountedNodeStore mns : ctx.getNonDefaultStores()) {\n-            afterStates.put(mns, mns.getNodeStore().rebase(builders.get(mns)));\n-            beforeStates.put(mns, builders.get(mns).getBaseState());\n+            afterStates.put(mns, mns.getNodeStore().rebase(builder.getNodeBuilder(mns)));\n+            beforeStates.put(mns, builder.getNodeBuilder(mns).getBaseState());\n         }\n         afterStates.put(ctx.getGlobalStore(), after);\n         beforeStates.put(ctx.getGlobalStore(), before);",
                "deletions": 6
            },
            {
                "sha": "866c37eaf998c9ae698daced9cae144f7daff0a3",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java",
                "status": "modified",
                "changes": 140,
                "additions": 56,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeBuilder.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -16,59 +16,62 @@\n  */\n package org.apache.jackrabbit.oak.composite;\n \n-import com.google.common.base.Function;\n import com.google.common.base.Objects;\n-import com.google.common.collect.Maps;\n+import com.google.common.collect.FluentIterable;\n import org.apache.jackrabbit.oak.api.Blob;\n import org.apache.jackrabbit.oak.api.PropertyState;\n import org.apache.jackrabbit.oak.api.Type;\n import org.apache.jackrabbit.oak.commons.PathUtils;\n+import org.apache.jackrabbit.oak.composite.util.Memoizer;\n import org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState;\n import org.apache.jackrabbit.oak.spi.state.MoveDetector;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n import org.apache.jackrabbit.oak.spi.state.NodeState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.io.InputStream;\n-import java.util.IdentityHashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n \n-import static com.google.common.base.Preconditions.checkArgument;\n import static com.google.common.base.Preconditions.checkNotNull;\n import static com.google.common.base.Preconditions.checkState;\n-import static com.google.common.collect.Iterables.concat;\n-import static com.google.common.collect.Iterables.filter;\n-import static com.google.common.collect.Iterables.transform;\n-import static com.google.common.collect.Maps.transformValues;\n+import static com.google.common.collect.Maps.newHashMap;\n import static java.lang.Long.MAX_VALUE;\n import static java.util.Collections.singleton;\n+import static org.apache.jackrabbit.oak.composite.CompositeNodeState.STOP_COUNTING_CHILDREN;\n+import static org.apache.jackrabbit.oak.composite.CompositeNodeState.accumulateChildSizes;\n+import static org.apache.jackrabbit.oak.composite.CompositeNodeState.wrapWithNullCheck;\n import static org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.MISSING_NODE;\n import static org.apache.jackrabbit.oak.spi.state.AbstractNodeState.checkValidName;\n \n class CompositeNodeBuilder implements NodeBuilder {\n \n+    private static final Logger LOG = LoggerFactory.getLogger(CompositeNodeBuilder.class);\n+\n     private final String path;\n \n     private final CompositionContext ctx;\n \n-    private Map<MountedNodeStore, NodeBuilder> nodeBuilders;\n+    private Function<MountedNodeStore, NodeBuilder> nodeBuilders;\n \n     private final MountedNodeStore owningStore;\n \n     private final CompositeNodeBuilder parent;\n \n     private final CompositeNodeBuilder rootBuilder;\n \n-    CompositeNodeBuilder(String path, Map<MountedNodeStore, NodeBuilder> nodeBuilders, CompositionContext ctx) {\n+    CompositeNodeBuilder(String path, Function<MountedNodeStore, NodeBuilder> nodeBuilders, CompositionContext ctx) {\n         this(path, nodeBuilders, ctx, null);\n     }\n \n-    private CompositeNodeBuilder(String path, Map<MountedNodeStore, NodeBuilder> nodeBuilders, CompositionContext ctx, CompositeNodeBuilder parent) {\n-        checkArgument(nodeBuilders.size() == ctx.getStoresCount(), \"Got %s builders but the context manages %s stores\", nodeBuilders.size(), ctx.getStoresCount());\n+    private CompositeNodeBuilder(String path, Function<MountedNodeStore, NodeBuilder> nodeBuilders, CompositionContext ctx, CompositeNodeBuilder parent) {\n         this.path = path;\n         this.ctx = ctx;\n-        this.nodeBuilders = new CopyOnReadIdentityMap<>(nodeBuilders);\n+        this.nodeBuilders = wrapWithNullCheck(Memoizer.memoize(nodeBuilders), LOG, path);\n         this.owningStore = ctx.getOwningStore(path);\n         this.parent = parent;\n         if (parent == null) {\n@@ -78,40 +81,24 @@ private CompositeNodeBuilder(String path, Map<MountedNodeStore, NodeBuilder> nod\n         }\n     }\n \n-    Map<MountedNodeStore, NodeBuilder> getBuilders() {\n-        return nodeBuilders;\n+    NodeBuilder getNodeBuilder(MountedNodeStore mns) {\n+        return nodeBuilders.apply(mns);\n     }\n \n     @Override\n     public CompositeNodeState getNodeState() {\n-        return new CompositeNodeState(path, buildersToNodeStates(nodeBuilders), ctx);\n+        Map<MountedNodeStore, NodeState> states = ctx.getAllMountedNodeStores().stream().collect(Collectors.toMap(Function.identity(),\n+                nodeBuilders\n+                        .andThen(n -> n.exists() ? n.getNodeState() : MISSING_NODE)));\n+        return new CompositeNodeState(path, states, ctx);\n     }\n \n     @Override\n     public CompositeNodeState getBaseState() {\n-        return new CompositeNodeState(path, buildersToBaseStates(nodeBuilders), ctx);\n-    }\n-\n-    private static Map<MountedNodeStore, NodeState> buildersToNodeStates(Map<MountedNodeStore, NodeBuilder> builders) {\n-        return new IdentityHashMap<>(transformValues(builders, new Function<NodeBuilder, NodeState>() {\n-            @Override\n-            public NodeState apply(NodeBuilder input) {\n-                if (input.exists()) {\n-                    return input.getNodeState();\n-                } else {\n-                    return MISSING_NODE;\n-                }\n-            }\n-        }));\n-    }\n-\n-    private static Map<MountedNodeStore, NodeState> buildersToBaseStates(Map<MountedNodeStore, NodeBuilder> builders) {\n-        return new IdentityHashMap<>(transformValues(builders, new Function<NodeBuilder, NodeState>() {\n-            @Override\n-            public NodeState apply(NodeBuilder input) {\n-                return input.getBaseState();\n-            }\n-        }));\n+        Map<MountedNodeStore, NodeState> states = ctx.getAllMountedNodeStores().stream().collect(Collectors.toMap(Function.identity(),\n+                nodeBuilders\n+                        .andThen(NodeBuilder::getBaseState)));\n+        return new CompositeNodeState(path, states, ctx);\n     }\n \n     // node or property-related methods ; directly delegate to wrapped builder\n@@ -219,35 +206,31 @@ public long getChildNodeCount(final long max) {\n             return getWrappedNodeBuilder().getChildNodeCount(max);\n         } else {\n             // Count the children in each contributing store.\n-            return CompositeNodeState.accumulateChildSizes(concat(transform(contributingStores, new Function<MountedNodeStore, Iterable<String>>() {\n-                @Override\n-                public Iterable<String> apply(MountedNodeStore input) {\n-                    NodeBuilder contributing = nodeBuilders.get(input);\n-                    if (contributing.getChildNodeCount(max) == MAX_VALUE) {\n-                        return singleton(CompositeNodeState.STOP_COUNTING_CHILDREN);\n-                    } else {\n-                        return filter(contributing.getChildNodeNames(), ctx.belongsToStore(input, path));\n-                    }\n-                }\n-            })), max);\n+            return accumulateChildSizes(FluentIterable.from(contributingStores)\n+                    .transformAndConcat(mns -> {\n+                        NodeBuilder node = nodeBuilders.apply(mns);\n+                        if (node.getChildNodeCount(max) == MAX_VALUE) {\n+                            return singleton(STOP_COUNTING_CHILDREN);\n+                        } else {\n+                            return FluentIterable.from(node.getChildNodeNames()).filter(e -> belongsToStore(mns, e));\n+                        }\n+                    }), max);\n         }\n     }\n \n     @Override\n     public Iterable<String> getChildNodeNames() {\n-        return concat(transform(ctx.getContributingStoresForBuilders(path, nodeBuilders), new Function<MountedNodeStore, Iterable<String>>() {\n-            @Override\n-            public Iterable<String> apply(final MountedNodeStore mountedNodeStore) {\n-                return filter(nodeBuilders.get(mountedNodeStore).getChildNodeNames(), ctx.belongsToStore(mountedNodeStore, path));\n-            }\n-        }));\n+        return FluentIterable.from(ctx.getContributingStoresForBuilders(path, nodeBuilders))\n+                .transformAndConcat(mns -> FluentIterable\n+                        .from(nodeBuilders.apply(mns).getChildNodeNames())\n+                        .filter(e -> belongsToStore(mns, e)));\n     }\n \n     @Override\n     public boolean hasChildNode(String name) {\n         String childPath = simpleConcat(path, name);\n         MountedNodeStore mountedStore = ctx.getOwningStore(childPath);\n-        return nodeBuilders.get(mountedStore).hasChildNode(name);\n+        return nodeBuilders.apply(mountedStore).hasChildNode(name);\n     }\n \n     @Override\n@@ -260,29 +243,24 @@ public NodeBuilder child(String name) {\n     }\n \n     private void createAncestors(MountedNodeStore mountedNodeStore) {\n-        NodeBuilder builder = rootBuilder.nodeBuilders.get(mountedNodeStore);\n+        NodeBuilder builder = rootBuilder.nodeBuilders.apply(mountedNodeStore);\n         for (String element : PathUtils.elements(path)) {\n             builder = builder.child(element);\n         }\n-        if (nodeBuilders instanceof CopyOnReadIdentityMap) {\n-            nodeBuilders = new IdentityHashMap<>(nodeBuilders);\n-        }\n-        nodeBuilders.put(mountedNodeStore, builder);\n+\n+        // the nodeBuilders function should be updated, to return the new node builder\n+        Map<MountedNodeStore, NodeBuilder> map = newHashMap(ctx.getAllMountedNodeStores().stream().collect(Collectors.toMap(Function.identity(), nodeBuilders)));\n+        map.put(mountedNodeStore, builder);\n+        nodeBuilders = wrapWithNullCheck(m -> map.get(m), LOG, path);\n     }\n \n     @Override\n     public NodeBuilder getChildNode(final String name) {\n         String childPath = simpleConcat(path, name);\n         if (!ctx.shouldBeComposite(childPath)) {\n-            return nodeBuilders.get(ctx.getOwningStore(childPath)).getChildNode(name);\n+            return nodeBuilders.apply(ctx.getOwningStore(childPath)).getChildNode(name);\n         }\n-        Map<MountedNodeStore, NodeBuilder> newNodeBuilders = transformValues(nodeBuilders, new Function<NodeBuilder, NodeBuilder>() {\n-            @Override\n-            public NodeBuilder apply(NodeBuilder input) {\n-                return input.getChildNode(name);\n-            }\n-        });\n-        return new CompositeNodeBuilder(childPath, newNodeBuilders, ctx, this);\n+        return new CompositeNodeBuilder(childPath, nodeBuilders.andThen(b -> b.getChildNode(name)), ctx, this);\n     }\n \n     @Override\n@@ -295,25 +273,15 @@ public NodeBuilder setChildNode(final String name, NodeState nodeState) {\n         checkState(exists(), \"This builder does not exist: \" + PathUtils.getName(path));\n         String childPath = simpleConcat(path, name);\n         final MountedNodeStore childStore = ctx.getOwningStore(childPath);\n-        if (childStore != owningStore && !nodeBuilders.get(childStore).exists()) {\n+        if (childStore != owningStore && !nodeBuilders.apply(childStore).exists()) {\n             createAncestors(childStore);\n         }\n-        final NodeBuilder childBuilder = nodeBuilders.get(childStore).setChildNode(name, nodeState);\n+        final NodeBuilder childBuilder = nodeBuilders.apply(childStore).setChildNode(name, nodeState);\n         if (!ctx.shouldBeComposite(childPath)) {\n             return childBuilder;\n         }\n \n-        Map<MountedNodeStore, NodeBuilder> newNodeBuilders = Maps.transformEntries(nodeBuilders, new Maps.EntryTransformer<MountedNodeStore, NodeBuilder, NodeBuilder>() {\n-            @Override\n-            public NodeBuilder transformEntry(MountedNodeStore key, NodeBuilder value) {\n-                if (key == childStore) {\n-                    return childBuilder;\n-                } else {\n-                    return value.getChildNode(name);\n-                }\n-            }\n-        });\n-        return new CompositeNodeBuilder(childPath, newNodeBuilders, ctx, this);\n+        return new CompositeNodeBuilder(childPath, m -> m == childStore ? childBuilder : nodeBuilders.apply(m).getChildNode(name), ctx, this);\n     }\n \n     @Override\n@@ -346,7 +314,7 @@ public Blob createBlob(InputStream stream) throws IOException {\n     }\n \n     private NodeBuilder getWrappedNodeBuilder() {\n-        return nodeBuilders.get(owningStore);\n+        return nodeBuilders.apply (owningStore);\n     }\n \n     private void annotateSourcePath() {\n@@ -403,6 +371,10 @@ String getPath() {\n         return path;\n     }\n \n+    private boolean belongsToStore(MountedNodeStore mns, String childName) {\n+        return ctx.belongsToStore(mns, path, childName);\n+    }\n+\n     /**\n      * This simplified version of {@link PathUtils#concat(String, String)} method\n      * assumes that the parentPath is valid and not null, while the second argument",
                "deletions": 84
            },
            {
                "sha": "8bbc3d54de34e0549c3d9c8d27ffcaf263d9046c",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java",
                "status": "modified",
                "changes": 117,
                "additions": 50,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -18,32 +18,26 @@\n  */\n package org.apache.jackrabbit.oak.composite;\n \n-import com.google.common.base.Function;\n+import com.google.common.collect.FluentIterable;\n import org.apache.jackrabbit.oak.api.PropertyState;\n import org.apache.jackrabbit.oak.commons.PathUtils;\n+import org.apache.jackrabbit.oak.composite.util.Memoizer;\n import org.apache.jackrabbit.oak.plugins.memory.MemoryChildNodeEntry;\n import org.apache.jackrabbit.oak.spi.state.AbstractNodeState;\n import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;\n-import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.apache.jackrabbit.oak.spi.state.NodeStateDiff;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import java.util.List;\n import java.util.Map;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n \n-import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Predicates.compose;\n-import static com.google.common.collect.Iterables.concat;\n-import static com.google.common.collect.Iterables.filter;\n-import static com.google.common.collect.Iterables.transform;\n-import static com.google.common.collect.Maps.asMap;\n-import static com.google.common.collect.Maps.transformValues;\n import static java.lang.Long.MAX_VALUE;\n import static java.util.Collections.singleton;\n import static org.apache.jackrabbit.oak.composite.CompositeNodeBuilder.simpleConcat;\n-import static org.apache.jackrabbit.oak.spi.state.ChildNodeEntry.GET_NAME;\n \n class CompositeNodeState extends AbstractNodeState {\n \n@@ -70,25 +64,36 @@\n \n     private final MountedNodeStore owningStore;\n \n-    private final Map<MountedNodeStore, NodeState> nodeStates;\n+    private final Function<MountedNodeStore, NodeState> nodeStates;\n \n     CompositeNodeState(String path, Map<MountedNodeStore, NodeState> nodeStates, CompositionContext ctx) {\n-        checkArgument(nodeStates.size() == ctx.getStoresCount(), \"Got %s node states but the context manages %s stores\", nodeStates.size(), ctx.getStoresCount());\n         this.path = path;\n         this.ctx = ctx;\n-        this.nodeStates = new CopyOnReadIdentityMap<>(nodeStates);\n+        this.nodeStates = wrapWithNullCheck(mns -> nodeStates.get(mns), LOG, path);\n         this.owningStore = ctx.getOwningStore(path);\n     }\n \n-    NodeState getNodeState(MountedNodeStore mns) {\n-        NodeState nodeState = nodeStates.get(mns);\n-        if (nodeState != null) {\n+    CompositeNodeState(String path, Function<MountedNodeStore, NodeState> nodeStates, CompositionContext ctx) {\n+        this.path = path;\n+        this.ctx = ctx;\n+        this.nodeStates = wrapWithNullCheck(Memoizer.memoize(nodeStates), LOG, path);\n+        this.owningStore = ctx.getOwningStore(path);\n+    }\n+\n+    static <N> Function<MountedNodeStore, N> wrapWithNullCheck(Function<MountedNodeStore, N> f, Logger log, String path) {\n+        return mns -> {\n+            N nodeState = f.apply(mns);\n+            if (nodeState == null) {\n+                // this shouldn't happen, so we need to log some more debug info\n+                log.warn(\"Can't find node state for path {} and mount {}.\", path, mns);\n+                throw new IllegalStateException(\"Can't find the node state for mount \" + mns);\n+            }\n             return nodeState;\n-        }\n+        };\n+    }\n \n-        // this shouldn't happen, so we need to log some more debug info\n-        LOG.warn(\"Can't find node state for path {} and mount {}. The node state map: {}\", path, mns, nodeStates);\n-        throw new IllegalStateException(\"Can't find the node state for mount \" + mns);\n+    NodeState getNodeState(MountedNodeStore mns) {\n+        return nodeStates.apply(mns);\n     }\n \n     @Override\n@@ -122,44 +127,37 @@ public long getPropertyCount() {\n     public boolean hasChildNode(String name) {\n         String childPath = simpleConcat(path, name);\n         MountedNodeStore mountedStore = ctx.getOwningStore(childPath);\n-        return getNodeState(mountedStore).hasChildNode(name);\n+        return nodeStates.apply(mountedStore).hasChildNode(name);\n     }\n \n     @Override\n     public NodeState getChildNode(final String name) {\n         String childPath = simpleConcat(path, name);\n         if (!ctx.shouldBeComposite(childPath)) {\n-            return getNodeState(ctx.getOwningStore(childPath)).getChildNode(name);\n+            return nodeStates.apply(ctx.getOwningStore(childPath)).getChildNode(name);\n         }\n-        Map<MountedNodeStore, NodeState> newNodeStates = transformValues(safeGetMap(), new Function<NodeState, NodeState>() {\n-            @Override\n-            public NodeState apply(NodeState input) {\n-                return input.getChildNode(name);\n-            }\n-        });\n+        Function<MountedNodeStore, NodeState> newNodeStates = nodeStates.andThen(n -> n.getChildNode(name));\n         return new CompositeNodeState(childPath, newNodeStates, ctx);\n     }\n \n     @Override\n     public long getChildNodeCount(final long max) {\n-        List<MountedNodeStore> contributingStores = ctx.getContributingStoresForNodes(path, safeGetMap());\n+        List<MountedNodeStore> contributingStores = ctx.getContributingStoresForNodes(path, nodeStates);\n         if (contributingStores.isEmpty()) {\n             return 0; // this shouldn't happen\n         } else if (contributingStores.size() == 1) {\n             return getWrappedNodeState().getChildNodeCount(max);\n         } else {\n             // Count the children in each contributing store.\n-            return accumulateChildSizes(concat(transform(contributingStores, new Function<MountedNodeStore, Iterable<String>>() {\n-                @Override\n-                public Iterable<String> apply(MountedNodeStore mns) {\n-                    NodeState contributing = getNodeState(mns);\n-                    if (contributing.getChildNodeCount(max) == MAX_VALUE) {\n-                        return singleton(STOP_COUNTING_CHILDREN);\n-                    } else {\n-                        return filter(contributing.getChildNodeNames(), ctx.belongsToStore(mns, path));\n-                    }\n-                }\n-            })), max);\n+            return accumulateChildSizes(FluentIterable.from(contributingStores)\n+                    .transformAndConcat(mns -> {\n+                        NodeState node = nodeStates.apply(mns);\n+                        if (node.getChildNodeCount(max) == MAX_VALUE) {\n+                            return singleton(STOP_COUNTING_CHILDREN);\n+                        } else {\n+                            return FluentIterable.from(node.getChildNodeNames()).filter(e -> belongsToStore(mns, e));\n+                        }\n+                    }), max);\n         }\n     }\n \n@@ -176,19 +174,11 @@ static long accumulateChildSizes(Iterable<String> nodeNames, long max) {\n \n     @Override\n     public Iterable<? extends ChildNodeEntry> getChildNodeEntries() {\n-        Iterable<? extends ChildNodeEntry> nativeChildren = concat(transform(ctx.getContributingStoresForNodes(path, safeGetMap()), new Function<MountedNodeStore, Iterable<? extends ChildNodeEntry>>() {\n-            @Override\n-            public Iterable<? extends ChildNodeEntry> apply(final MountedNodeStore mountedNodeStore) {\n-                return filter(getNodeState(mountedNodeStore).getChildNodeEntries(), compose(ctx.belongsToStore(mountedNodeStore, path), GET_NAME));\n-            }\n-        }));\n-        return transform(nativeChildren, new Function<ChildNodeEntry, ChildNodeEntry>() {\n-            @Override\n-            public ChildNodeEntry apply(ChildNodeEntry input) {\n-                NodeState wrapped = getChildNode(input.getName());\n-                return new MemoryChildNodeEntry(input.getName(), wrapped);\n-            }\n-        });\n+        return FluentIterable.from(ctx.getContributingStoresForNodes(path, nodeStates))\n+                .transformAndConcat(mns -> FluentIterable\n+                        .from(nodeStates.apply(mns).getChildNodeNames())\n+                        .filter(n -> belongsToStore(mns, n)))\n+                .transform(n -> new MemoryChildNodeEntry(n, getChildNode(n)));\n     }\n \n     @Override\n@@ -197,13 +187,13 @@ public boolean compareAgainstBaseState(NodeState base, NodeStateDiff diff) {\n             CompositeNodeState multiBase = (CompositeNodeState) base;\n             NodeStateDiff wrappingDiff = new WrappingDiff(diff, multiBase);\n             boolean full = getWrappedNodeState().compareAgainstBaseState(multiBase.getWrappedNodeState(), new ChildrenDiffFilter(wrappingDiff, owningStore, true));\n-            for (MountedNodeStore mns : ctx.getContributingStoresForNodes(path, safeGetMap())) {\n+            for (MountedNodeStore mns : ctx.getContributingStoresForNodes(path, nodeStates)) {\n                 if (owningStore == mns) {\n                     continue;\n                 }\n                 NodeStateDiff childrenDiffFilter = new ChildrenDiffFilter(wrappingDiff, mns, false);\n-                NodeState contributing = getNodeState(mns);\n-                NodeState contributingBase = multiBase.getNodeState(mns);\n+                NodeState contributing = nodeStates.apply(mns);\n+                NodeState contributingBase = multiBase.nodeStates.apply(mns);\n                 full = full && contributing.compareAgainstBaseState(contributingBase, childrenDiffFilter);\n             }\n             return full;\n@@ -215,21 +205,15 @@ public boolean compareAgainstBaseState(NodeState base, NodeStateDiff diff) {\n     // write operations\n     @Override\n     public CompositeNodeBuilder builder() {\n-        Map<MountedNodeStore, NodeBuilder> nodeBuilders = transformValues(safeGetMap(), new Function<NodeState, NodeBuilder>() {\n-            @Override\n-            public NodeBuilder apply(NodeState input) {\n-                return input.builder();\n-            }\n-        });\n-        return new CompositeNodeBuilder(path, nodeBuilders, ctx);\n+        return new CompositeNodeBuilder(path, nodeStates.andThen(NodeState::builder), ctx);\n     }\n \n     private NodeState getWrappedNodeState() {\n-        return getNodeState(owningStore);\n+        return nodeStates.apply(owningStore);\n     }\n \n-    private Map<MountedNodeStore, NodeState> safeGetMap() {\n-        return asMap(ctx.getAllMountedNodeStores(), this::getNodeState);\n+    private boolean belongsToStore(MountedNodeStore mns, String childName) {\n+        return ctx.belongsToStore(mns, path, childName);\n     }\n \n     private class ChildrenDiffFilter implements NodeStateDiff {\n@@ -354,5 +338,4 @@ private NodeState wrapAfter(String name) {\n             return CompositeNodeState.this.getChildNode(name);\n         }\n     }\n-\n }",
                "deletions": 67
            },
            {
                "sha": "e8d2b2c3c0b8d7124c81fc0052fb3da45553862e",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "status": "modified",
                "changes": 12,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -141,8 +141,8 @@ public NodeState merge(NodeBuilder builder, CommitHook commitHook, CommitInfo in\n             // merge the global builder and apply the commit hooks within\n             Map<MountedNodeStore, NodeState> resultStates = newHashMap();\n             MountedNodeStore globalStore = ctx.getGlobalStore();\n-            CommitHookEnhancer hookEnhancer = new CommitHookEnhancer(commitHook, ctx, nodeBuilder.getBuilders());\n-            NodeState globalResult = globalStore.getNodeStore().merge(nodeBuilder.getBuilders().get(globalStore), hookEnhancer, info);\n+            CommitHookEnhancer hookEnhancer = new CommitHookEnhancer(commitHook, ctx, nodeBuilder);\n+            NodeState globalResult = globalStore.getNodeStore().merge(nodeBuilder.getNodeBuilder(globalStore), hookEnhancer, info);\n             resultStates.put(globalStore, globalResult);\n \n             if (!hookEnhancer.getUpdatedBuilder().isPresent()) {\n@@ -154,7 +154,7 @@ public NodeState merge(NodeBuilder builder, CommitHook commitHook, CommitInfo in\n \n             // merge the partial builders\n             for (MountedNodeStore mns : ctx.getNonDefaultStores()) {\n-                NodeBuilder partialBuilder = updatedBuilder.getBuilders().get(mns);\n+                NodeBuilder partialBuilder = updatedBuilder.getNodeBuilder(mns);\n \n                 if (mns.getMount().isReadOnly()) {\n                     assertNoChange(mns, partialBuilder);\n@@ -180,7 +180,7 @@ private void assertNoChangesOnReadOnlyMounts(CompositeNodeBuilder nodeBuilder) t\n             if (!mountedNodeStore.getMount().isReadOnly()) {\n                 continue;\n             }\n-            NodeBuilder partialBuilder = nodeBuilder.getBuilders().get(mountedNodeStore);\n+            NodeBuilder partialBuilder = nodeBuilder.getNodeBuilder(mountedNodeStore);\n             assertNoChange(mountedNodeStore, partialBuilder);\n         }\n     }\n@@ -209,7 +209,7 @@ public NodeState rebase(NodeBuilder builder) {\n         Map<MountedNodeStore, NodeState> resultStates = newHashMap();\n         for (MountedNodeStore mountedNodeStore : ctx.getAllMountedNodeStores()) {\n             NodeStore nodeStore = mountedNodeStore.getNodeStore();\n-            NodeBuilder partialBuilder = nodeBuilder.getBuilders().get(mountedNodeStore);\n+            NodeBuilder partialBuilder = nodeBuilder.getNodeBuilder(mountedNodeStore);\n             NodeState result = nodeStore.rebase(partialBuilder);\n             resultStates.put(mountedNodeStore, result);\n         }\n@@ -224,7 +224,7 @@ public NodeState reset(NodeBuilder builder) {\n         Map<MountedNodeStore, NodeState> resultStates = newHashMap();\n         for (MountedNodeStore mountedNodeStore : ctx.getAllMountedNodeStores()) {\n             NodeStore nodeStore = mountedNodeStore.getNodeStore();\n-            NodeBuilder partialBuilder = nodeBuilder.getBuilders().get(mountedNodeStore);\n+            NodeBuilder partialBuilder = nodeBuilder.getNodeBuilder(mountedNodeStore);\n             NodeState result = nodeStore.reset(partialBuilder);\n             resultStates.put(mountedNodeStore, result);\n         }",
                "deletions": 6
            },
            {
                "sha": "46ee4c268b39c51853de7aaea2c8bde195c55234",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositionContext.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositionContext.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositionContext.java",
                "status": "modified",
                "changes": 68,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositionContext.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -16,11 +16,7 @@\n  */\n package org.apache.jackrabbit.oak.composite;\n \n-import com.google.common.base.Function;\n-import com.google.common.base.Predicate;\n-import com.google.common.collect.ImmutableMap;\n import com.google.common.collect.ImmutableSet;\n-import com.google.common.collect.Iterables;\n import org.apache.jackrabbit.oak.api.Blob;\n import org.apache.jackrabbit.oak.commons.PathUtils;\n import org.apache.jackrabbit.oak.spi.mount.Mount;\n@@ -35,13 +31,11 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n \n-import static com.google.common.collect.ImmutableMap.copyOf;\n-import static com.google.common.collect.Iterables.concat;\n-import static com.google.common.collect.Iterables.tryFind;\n import static com.google.common.collect.Lists.newArrayList;\n-import static com.google.common.collect.Maps.uniqueIndex;\n-import static java.util.Collections.singleton;\n import static java.util.Collections.singletonList;\n \n class CompositionContext {\n@@ -66,12 +60,7 @@\n         b.addAll(this.nonDefaultStores);\n         allStores = b.build();\n \n-        this.nodeStoresByMount = copyOf(uniqueIndex(allStores, new Function<MountedNodeStore, Mount>() {\n-            @Override\n-            public Mount apply(MountedNodeStore input) {\n-                return input.getMount();\n-            }\n-        }));\n+        this.nodeStoresByMount = allStores.stream().collect(Collectors.toMap(MountedNodeStore::getMount, Function.identity()));\n \n     }\n \n@@ -92,31 +81,18 @@ MountedNodeStore getOwningStore(String path) {\n         }\n     }\n \n-    List<MountedNodeStore> getContributingStoresForNodes(String path, final Map<MountedNodeStore, NodeState> nodeStates) {\n-        return getContributingStores(path, new Function<MountedNodeStore, Iterable<String>>() {\n-            @Override\n-            public Iterable<String> apply(MountedNodeStore input) {\n-                return nodeStates.get(input).getChildNodeNames();\n-            }\n-        });\n+    List<MountedNodeStore> getContributingStoresForNodes(String path, final Function<MountedNodeStore, NodeState> nodeStates) {\n+        return getContributingStores(path, mns -> nodeStates.apply(mns).getChildNodeNames());\n     }\n \n-    List<MountedNodeStore> getContributingStoresForBuilders(String path, final Map<MountedNodeStore, NodeBuilder> nodeBuilders) {\n-        return getContributingStores(path, new Function<MountedNodeStore, Iterable<String>>() {\n-            @Override\n-            public Iterable<String> apply(MountedNodeStore input) {\n-                return nodeBuilders.get(input).getChildNodeNames();\n-            }\n-        });\n+    List<MountedNodeStore> getContributingStoresForBuilders(String path, final Function<MountedNodeStore, NodeBuilder> nodeBuilders) {\n+        return getContributingStores(path, mns -> nodeBuilders.apply(mns).getChildNodeNames());\n     }\n \n     boolean shouldBeComposite(final String path) {\n-        if (Iterables.tryFind(nonDefaultStores, new Predicate<MountedNodeStore>() {\n-            @Override\n-            public boolean apply(MountedNodeStore input) {\n-                return input.getMount().isSupportFragment(path);\n-            }\n-        }).isPresent()) {\n+        if (nonDefaultStores.stream()\n+                .map(MountedNodeStore::getMount)\n+                .anyMatch(m -> m.isSupportFragment(path))) {\n             return true;\n         }\n         return !mip.getMountsPlacedUnder(path).isEmpty();\n@@ -156,12 +132,9 @@ private boolean hasChildrenContainingPathFragmentName(MountedNodeStore mns, Stri\n         if (!mount.isSupportFragment(parentPath)) {\n             return false;\n         }\n-        return tryFind(childrenProvider.apply(mns), new Predicate<String>() {\n-            @Override\n-            public boolean apply(String input) {\n-                return input.contains(mount.getPathFragmentName());\n-            }\n-        }).isPresent();\n+\n+        return StreamSupport.stream(childrenProvider.apply(mns).spliterator(), false)\n+                .anyMatch(i -> i.contains(mount.getPathFragmentName()));\n     }\n \n     Set<MountedNodeStore> getAllMountedNodeStores() {\n@@ -172,17 +145,8 @@ Blob createBlob(InputStream inputStream) throws IOException {\n         return globalStore.getNodeStore().createBlob(inputStream);\n     }\n \n-    int getStoresCount() {\n-        return nonDefaultStores.size() + 1;\n-    }\n-\n-    Predicate<String> belongsToStore(final MountedNodeStore mountedNodeStore, final String parentPath) {\n-        return new Predicate<String>() {\n-            @Override\n-            public boolean apply(String childName) {\n-                return getOwningStore(PathUtils.concat(parentPath, childName)) == mountedNodeStore;\n-            }\n-        };\n+    boolean belongsToStore(final MountedNodeStore mountedNodeStore, final String parentPath, final String childName) {\n+        return getOwningStore(PathUtils.concat(parentPath, childName)) == mountedNodeStore;\n     }\n \n     CompositeNodeState createRootNodeState(Map<MountedNodeStore, NodeState> rootStates) {",
                "deletions": 52
            },
            {
                "sha": "fdf7ff5f7d916e4e94d2650bd48e524fcc745ed2",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CopyOnReadIdentityMap.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/79a66bca4c6ca6afc91c03b6b690f7ca454b5004/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CopyOnReadIdentityMap.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/79a66bca4c6ca6afc91c03b6b690f7ca454b5004/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CopyOnReadIdentityMap.java",
                "status": "removed",
                "changes": 191,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CopyOnReadIdentityMap.java?ref=79a66bca4c6ca6afc91c03b6b690f7ca454b5004",
                "patch": "@@ -1,191 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.oak.composite;\n-\n-import com.google.common.base.Function;\n-\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.IdentityHashMap;\n-import java.util.Map;\n-import java.util.Set;\n-\n-/**\n- * This map wraps around the passed argument and caches all the returned values.\n- * It is meant to be wrapped around the result of\n- * {@link com.google.common.collect.Maps#transformValues(Map, Function)} method\n- * or its variant. This allows to preserve the laziness of map transformation and\n- * at the same time to avoid re-calculating the same values.\n- * <br>\n- * It's immutable and used IdentityHashMap for caching values.\n- *\n- * @param <K> - the type of keys maintained by this map\n- * @param <V> - the type of mapped values\n- */\n-class CopyOnReadIdentityMap<K, V> implements Map<K, V> {\n-\n-    private final Map<K, V> map;\n-\n-    private Integer cachedSize;\n-\n-    private Boolean cachedIsEmpty;\n-\n-    private Map<K, V> cachedValues;\n-\n-    private boolean allValuesCached;\n-\n-    public CopyOnReadIdentityMap(Map<K, V> wrappedMap) {\n-        this.map = wrappedMap;\n-    }\n-\n-    @Override\n-    public int size() {\n-        if (allValuesCached) {\n-            return cachedValues.size();\n-        }\n-        if (cachedSize == null) {\n-            cachedSize = map.size();\n-        }\n-        return cachedSize;\n-    }\n-\n-    @Override\n-    public boolean isEmpty() {\n-        if (allValuesCached) {\n-            return cachedValues.isEmpty();\n-        }\n-        if (cachedIsEmpty == null) {\n-            if (cachedSize == null) {\n-                cachedIsEmpty = map.isEmpty();\n-            } else {\n-                cachedIsEmpty = cachedSize > 0;\n-            }\n-        }\n-        return cachedIsEmpty;\n-    }\n-\n-    @Override\n-    public boolean containsKey(Object key) {\n-        if (allValuesCached) {\n-            return cachedValues.containsKey(key);\n-        }\n-        if (cachedValues != null && cachedValues.containsKey(key)) {\n-            return true;\n-        } else {\n-            return map.containsKey(key);\n-        }\n-    }\n-\n-    @Override\n-    public boolean containsValue(Object value) {\n-        if (allValuesCached) {\n-            return cachedValues.containsValue(value);\n-        }\n-        for (K k : keySet()) {\n-            V v = get(k);\n-            if (value == null && v == null) {\n-                return true;\n-            } else if (value != null && value.equals(v)) {\n-                return true;\n-            }\n-        }\n-        if (cachedValues == null) {\n-            cachedValues = Collections.emptyMap();\n-        }\n-        allValuesCached = true;\n-        return false;\n-    }\n-\n-    @Override\n-    public V get(Object key) {\n-        if (allValuesCached) {\n-            return cachedValues.get(key);\n-        }\n-        if (cachedValues != null && cachedValues.containsKey(key)) {\n-            return cachedValues.get(key);\n-        } else if (map.containsKey(key)) {\n-            initCachedValues();\n-            V v = map.get(key);\n-            cachedValues.put((K) key, v);\n-            return v;\n-        } else {\n-            return null;\n-        }\n-    }\n-\n-    @Override\n-    public V put(K key, V value) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public V remove(Object key) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public void putAll(Map<? extends K, ? extends V> m) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public void clear() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public Set<K> keySet() {\n-        return map.keySet();\n-    }\n-\n-    @Override\n-    public Collection<V> values() {\n-        readAll();\n-        return cachedValues.values();\n-    }\n-\n-    @Override\n-    public Set<Entry<K, V>> entrySet() {\n-        readAll();\n-        return cachedValues.entrySet();\n-    }\n-\n-    private void readAll() {\n-        if (allValuesCached) {\n-            return;\n-        }\n-        initCachedValues();\n-        for (Entry<K, V> e : map.entrySet()) {\n-            if (!cachedValues.containsKey(e.getKey())) {\n-                cachedValues.put(e.getKey(), e.getValue());\n-            }\n-        }\n-        allValuesCached = true;\n-    }\n-\n-    private void initCachedValues() {\n-        if (cachedValues == null) {\n-            cachedValues = new IdentityHashMap<>(map.size());\n-        }\n-    }\n-\n-    @Override\n-    public String toString() {\n-        readAll();\n-        return cachedValues.toString();\n-    }\n-}",
                "deletions": 191
            },
            {
                "sha": "5cc902692fcfd4eb48fb6813f60b7e420cc59e11",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/util/Memoizer.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/util/Memoizer.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/958223cabe378fac83a77fca359748ec3bd9dc3a/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/util/Memoizer.java",
                "status": "added",
                "changes": 34,
                "additions": 34,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/util/Memoizer.java?ref=958223cabe378fac83a77fca359748ec3bd9dc3a",
                "patch": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.composite.util;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.function.Function;\n+\n+public final class Memoizer {\n+\n+    private Memoizer() {\n+\n+    }\n+\n+    public static <I, O> Function<I, O> memoize(Function<I, O> f) {\n+        ConcurrentMap<I, O> lookup = new ConcurrentHashMap<>();\n+        return input -> lookup.computeIfAbsent(input, f);\n+    }\n+\n+}",
                "deletions": 0
            }
        ],
        "patched_files": [
            "CompositeNodeStore.java",
            "CompositeNodeBuilder.java",
            "Memoizer.java",
            "CommitHookEnhancer.java",
            "CompositionContext.java",
            "CopyOnReadIdentityMap.java",
            "CompositeNodeState.java"
        ],
        "unit_tests": [
            "CompositeNodeStoreTest.java"
        ]
    },
    "jackrabbit-oak_ebea8a9": {
        "repo": "jackrabbit-oak",
        "message": "OAK-5357: StringUtils conversion functions can throw NullPointerException\nMake the NPE explicit and add test coverage\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1784288 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ebea8a9817849c178510a3586136227fd1fc0445",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/526e5e21c1f0b821b2513251d3855e5666a1ca91",
        "bug_id": "jackrabbit-oak_ebea8a9",
        "file": [
            {
                "sha": "2c064017c889e92dd38d7f4abc433b2edef1205a",
                "filename": "oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ebea8a9817849c178510a3586136227fd1fc0445/oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ebea8a9817849c178510a3586136227fd1fc0445/oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java",
                "status": "modified",
                "changes": 20,
                "additions": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-commons/src/main/java/org/apache/jackrabbit/oak/commons/StringUtils.java?ref=ebea8a9817849c178510a3586136227fd1fc0445",
                "patch": "@@ -16,6 +16,11 @@\n  */\n package org.apache.jackrabbit.oak.commons;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import javax.annotation.Nonnull;\n+\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -28,13 +33,17 @@\n \n     private static final char[] HEX = \"0123456789abcdef\".toCharArray();\n \n+    private StringUtils() {}\n+\n     /**\n      * Convert a byte array to a hex encoded string.\n      *\n      * @param value the byte array\n      * @return the hex encoded string\n      */\n-    public static String convertBytesToHex(byte[] value) {\n+    @Nonnull\n+    public static String convertBytesToHex(@Nonnull byte[] value) {\n+        checkNotNull(value);\n         int len = value.length;\n         char[] buff = new char[len + len];\n         char[] hex = HEX;\n@@ -52,11 +61,12 @@ public static String convertBytesToHex(byte[] value) {\n      * @param s the hex encoded string\n      * @return the byte array\n      */\n-    public static byte[] convertHexToBytes(String s) {\n+    @Nonnull\n+    public static byte[] convertHexToBytes(@Nonnull String s) {\n+        checkNotNull(s);\n         int len = s.length();\n-        if (len % 2 != 0) {\n-            throw new IllegalArgumentException(s);\n-        }\n+        checkArgument(len % 2 == 0);\n+\n         len /= 2;\n         byte[] buff = new byte[len];\n         for (int i = 0; i < len; i++) {",
                "deletions": 5
            },
            {
                "sha": "059f229a1540fea86c3a78db1240d46d858743c9",
                "filename": "oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ebea8a9817849c178510a3586136227fd1fc0445/oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ebea8a9817849c178510a3586136227fd1fc0445/oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java",
                "status": "modified",
                "changes": 53,
                "additions": 38,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-commons/src/test/java/org/apache/jackrabbit/oak/commons/StringUtilsTest.java?ref=ebea8a9817849c178510a3586136227fd1fc0445",
                "patch": "@@ -16,34 +16,57 @@\n  */\n package org.apache.jackrabbit.oak.commons;\n \n-import com.google.common.collect.Maps;\n-import junit.framework.TestCase;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n \n import java.util.Map;\n \n+import com.google.common.collect.Maps;\n+import org.junit.Test;\n+\n /**\n  * Test the string utilities.\n  */\n-public class StringUtilsTest extends TestCase {\n-\n-    public void testHex() {\n-        assertEquals(\"0123\", StringUtils.convertBytesToHex(new byte[]{(byte) 0x01, (byte) 0x23}));\n-        assertEquals(\"89bd\", StringUtils.convertBytesToHex(new byte[]{(byte) 0x89, (byte) 0xbd}));\n-        assertEquals(\"face\", StringUtils.convertBytesToHex(new byte[]{(byte) 0xfa, (byte) 0xce}));\n-        IOUtilsTest.assertEquals(new byte[]{(byte) 0xfa, (byte) 0xce}, StringUtils.convertHexToBytes(\"face\"));\n-        IOUtilsTest.assertEquals(new byte[]{(byte) 0xfa, (byte) 0xce}, StringUtils.convertHexToBytes(\"fAcE\"));\n-        IOUtilsTest.assertEquals(new byte[]{(byte) 0xfa, (byte) 0xce}, StringUtils.convertHexToBytes(\"FaCe\"));\n-        IOUtilsTest.assertEquals(new byte[]{(byte) 0x09, (byte) 0xaf}, StringUtils.convertHexToBytes(\"09af\"));\n+public class StringUtilsTest {\n+\n+    @Test\n+    public void testBytesToHex() {\n+        assertEquals(\"0123\", StringUtils.convertBytesToHex(new byte[] {(byte) 0x01, (byte) 0x23}));\n+        assertEquals(\"89bd\", StringUtils.convertBytesToHex(new byte[] {(byte) 0x89, (byte) 0xbd}));\n+        assertEquals(\"face\", StringUtils.convertBytesToHex(new byte[] {(byte) 0xfa, (byte) 0xce}));\n+        assertEquals(\"\", StringUtils.convertBytesToHex(new byte[] {}));\n+    }\n+\n+    @Test(expected = NullPointerException.class)\n+    public void testNullToHex() {\n+        StringUtils.convertBytesToHex(null);\n+    }\n+\n+    @Test\n+    public void testHexToBytes() {\n+        IOUtilsTest.assertEquals(new byte[] {(byte) 0xfa, (byte) 0xce}, StringUtils.convertHexToBytes(\"face\"));\n+        IOUtilsTest.assertEquals(new byte[] {(byte) 0xfa, (byte) 0xce}, StringUtils.convertHexToBytes(\"fAcE\"));\n+        IOUtilsTest.assertEquals(new byte[] {(byte) 0xfa, (byte) 0xce}, StringUtils.convertHexToBytes(\"FaCe\"));\n+        IOUtilsTest.assertEquals(new byte[] {(byte) 0x09, (byte) 0xaf}, StringUtils.convertHexToBytes(\"09af\"));\n+        IOUtilsTest.assertEquals(new byte[] {}, StringUtils.convertHexToBytes(\"\"));\n+    }\n+\n+    @Test\n+    public void testInvalidHexToBytes() {\n         for (String s : new String[]{\"120\", \"1/\", \"9:\", \"fast\", \"a`\", \"ag\", \"0@\", \"aG\"}) {\n             try {\n                 StringUtils.convertHexToBytes(s);\n                 fail();\n-            } catch (IllegalArgumentException e) {\n-                // expected\n-            }\n+            } catch (IllegalArgumentException expected) { }\n         }\n     }\n \n+    @Test(expected = NullPointerException.class)\n+    public void testNullToBytes() {\n+        StringUtils.convertHexToBytes(null);\n+    }\n+\n+    @Test\n     public void testEstimateMemoryUsage() {\n         final Map<String, Integer> testStrings = Maps.newHashMap();\n         testStrings.put(null, 0);",
                "deletions": 15
            }
        ],
        "patched_files": [
            "StringUtils.java"
        ],
        "unit_tests": [
            "StringUtilsTest.java"
        ]
    },
    "jackrabbit-oak_ef0855c": {
        "repo": "jackrabbit-oak",
        "message": "OAK-992: NPE when running FlatTreeWithAceForSamePrincipalTest on MongoMK\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1522482 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/35c3ad072df911b14bffec7f9c827f38edd9b3fb",
        "bug_id": "jackrabbit-oak_ef0855c",
        "file": [
            {
                "sha": "6dd49a7d822cbb87fc2a729d9633225f0d3ea42e",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Branch.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Branch.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Branch.java",
                "status": "modified",
                "changes": 38,
                "additions": 30,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Branch.java?ref=ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
                "patch": "@@ -41,20 +41,31 @@\n      */\n     private final Revision base;\n \n+    /**\n+     * Create a new branch instance with an initial set of commits and a given\n+     * base revision.\n+     *\n+     * @param commits the initial branch commits.\n+     * @param base the base commit.\n+     * @param comparator the revision comparator.\n+     * @throws IllegalArgumentException if base is a branch revision.\n+     */\n     Branch(@Nonnull SortedSet<Revision> commits,\n            @Nonnull Revision base,\n            @Nonnull Revision.RevisionComparator comparator) {\n-        this.base = checkNotNull(base);\n+        checkArgument(!checkNotNull(base).isBranch(), \"base is not a trunk revision: %s\", base);\n+        this.base = base;\n         this.commits = new TreeMap<Revision, BranchCommit>(\n                 checkNotNull(comparator));\n         for (Revision r : commits) {\n-            this.commits.put(r, new BranchCommit(base));\n+            this.commits.put(r.asBranchRevision(), new BranchCommit(base));\n         }\n     }\n \n     /**\n      * @return the initial base of this branch.\n      */\n+    @Nonnull\n     Revision getBase() {\n         return base;\n     }\n@@ -67,8 +78,9 @@ Revision getBase() {\n      * @throws IllegalArgumentException if <code>r</code> is not a commit of\n      *                                  this branch.\n      */\n-    synchronized Revision getBase(Revision r) {\n-        BranchCommit c = commits.get(r);\n+    @Nonnull\n+    synchronized Revision getBase(@Nonnull Revision r) {\n+        BranchCommit c = commits.get(checkNotNull(r).asBranchRevision());\n         if (c == null) {\n             throw new IllegalArgumentException(\n                     \"Revision \" + r + \" is not a commit in this branch\");\n@@ -81,8 +93,12 @@ synchronized Revision getBase(Revision r) {\n      *\n      * @param head the new head of the branch.\n      * @param base rebase to this revision.\n+     * @throws IllegalArgumentException if head is a trunk revision or base is a\n+     *                                  branch revision.\n      */\n-    synchronized void rebase(Revision head, Revision base) {\n+    synchronized void rebase(@Nonnull Revision head, @Nonnull Revision base) {\n+        checkArgument(checkNotNull(head).isBranch(), \"Not a branch revision: %s\", head);\n+        checkArgument(!checkNotNull(base).isBranch(), \"Not a trunk revision: %s\", base);\n         Revision last = commits.lastKey();\n         checkArgument(commits.comparator().compare(head, last) > 0);\n         commits.put(head, new BranchCommit(base));\n@@ -92,8 +108,10 @@ synchronized void rebase(Revision head, Revision base) {\n      * Adds a new commit with revision <code>r</code> to this branch.\n      *\n      * @param r the revision of the branch commit to add.\n+     * @throws IllegalArgumentException if r is not a branch revision.\n      */\n     synchronized void addCommit(@Nonnull Revision r) {\n+        checkArgument(checkNotNull(r).isBranch(), \"Not a branch revision: %s\", r);\n         Revision last = commits.lastKey();\n         checkArgument(commits.comparator().compare(r, last) > 0);\n         commits.put(r, new BranchCommit(commits.get(last).getBase()));\n@@ -124,16 +142,18 @@ synchronized boolean hasCommits() {\n      *         revision; <code>false</code> otherwise.\n      */\n     synchronized boolean containsCommit(@Nonnull Revision r) {\n-        return commits.containsKey(r);\n+        return commits.containsKey(checkNotNull(r).asBranchRevision());\n     }\n \n     /**\n      * Removes the commit with the given revision <code>r</code>. Does nothing\n      * if there is no such commit.\n      *\n      * @param r the revision of the commit to remove.\n+     * @throws IllegalArgumentException if r is not a branch revision.\n      */\n     public synchronized void removeCommit(@Nonnull Revision r) {\n+        checkArgument(checkNotNull(r).isBranch(), \"Not a branch revision: %s\", r);\n         commits.remove(r);\n     }\n \n@@ -142,11 +162,12 @@ public synchronized void removeCommit(@Nonnull Revision r) {\n      *\n      * @param r a branch commit revision.\n      * @return the unsaved modification for the given branch commit.\n-     * @throws IllegalArgumentException if there is no commit with the given\n-     *                                  revision.\n+     * @throws IllegalArgumentException r is not a branch revision or if there\n+     *                                  is no commit with the given revision.\n      */\n     @Nonnull\n     public synchronized UnsavedModifications getModifications(@Nonnull Revision r) {\n+        checkArgument(checkNotNull(r).isBranch(), \"Not a branch revision: %s\", r);\n         BranchCommit c = commits.get(r);\n         if (c == null) {\n             throw new IllegalArgumentException(\n@@ -182,6 +203,7 @@ public synchronized void applyTo(@Nonnull UnsavedModifications trunk,\n     @CheckForNull\n     public synchronized Revision getUnsavedLastRevision(String path,\n                                                         Revision readRevision) {\n+        readRevision = readRevision.asBranchRevision();\n         for (Revision r : commits.descendingKeySet()) {\n             if (readRevision.compareRevisionTime(r) < 0) {\n                 continue;",
                "deletions": 8
            },
            {
                "sha": "f23e3d9cd11f55fbd9cd151816c5a14317caf069",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMK.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMK.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMK.java",
                "status": "modified",
                "changes": 51,
                "additions": 23,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMK.java?ref=ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
                "patch": "@@ -658,8 +658,6 @@ synchronized String diffImpl(String fromRevisionId, String toRevisionId, String\n         if (path == null || path.equals(\"\")) {\n             path = \"/\";\n         }\n-        fromRevisionId = stripBranchRevMarker(fromRevisionId);\n-        toRevisionId = stripBranchRevMarker(toRevisionId);\n         Revision fromRev = Revision.fromString(fromRevisionId);\n         Revision toRev = Revision.fromString(toRevisionId);\n         Node from = getNode(path, fromRev);\n@@ -779,7 +777,7 @@ public boolean nodeExists(String path, String revisionId)\n             throw new MicroKernelException(\"Path is not absolute: \" + path);\n         }\n         revisionId = revisionId != null ? revisionId : headRevision.toString();\n-        Revision rev = Revision.fromString(stripBranchRevMarker(revisionId));\n+        Revision rev = Revision.fromString(revisionId);\n         Node n = getNode(path, rev);\n         return n != null;\n     }\n@@ -799,7 +797,6 @@ public synchronized String getNodes(String path, String revisionId, int depth,\n             throw new MicroKernelException(\"Only depth 0 is supported, depth is \" + depth);\n         }\n         revisionId = revisionId != null ? revisionId : headRevision.toString();\n-        revisionId = stripBranchRevMarker(revisionId);\n         Revision rev = Revision.fromString(revisionId);\n         Node n = getNode(path, rev);\n         if (n == null) {\n@@ -850,7 +847,7 @@ public synchronized String commit(String rootPath, String json, String baseRevId\n             baseRev = headRevision;\n             baseRevId = baseRev.toString();\n         } else {\n-            baseRev = Revision.fromString(stripBranchRevMarker(baseRevId));\n+            baseRev = Revision.fromString(baseRevId);\n         }\n         JsopReader t = new JsopTokenizer(json);\n         Revision rev = newRevision();\n@@ -923,11 +920,13 @@ public synchronized String commit(String rootPath, String json, String baseRevId\n                 throw new MicroKernelException(\"token: \" + (char) t.getTokenType());\n             }\n         }\n-        if (baseRevId.startsWith(\"b\")) {\n+        if (baseRev.isBranch()) {\n+            rev = rev.asBranchRevision();\n             // remember branch commit\n             Branch b = branches.getBranch(baseRev);\n             if (b == null) {\n-                b = branches.create(baseRev, rev);\n+                // baseRev is marker for new branch\n+                b = branches.create(baseRev.asTrunkRevision(), rev);\n             } else {\n                 b.addCommit(rev);\n             }\n@@ -945,11 +944,12 @@ public synchronized String commit(String rootPath, String json, String baseRevId\n                 }\n             }\n \n-            return \"b\" + rev.toString();\n+            return rev.toString();\n+        } else {\n+            commit.apply();\n+            headRevision = commit.getRevision();\n+            return rev.toString();\n         }\n-        commit.apply();\n-        headRevision = commit.getRevision();\n-        return rev.toString();\n     }\n \n     //------------------------< RevisionContext >-------------------------------\n@@ -1073,13 +1073,6 @@ private void markAsDeleted(String path, Commit commit, boolean subTreeAlso) {\n         nodeCache.invalidate(path + \"@\" + rev);\n     }\n \n-    private static String stripBranchRevMarker(String revisionId) {\n-        if (revisionId.startsWith(\"b\")) {\n-            return revisionId.substring(1);\n-        }\n-        return revisionId;\n-    }\n-    \n     public static void parseAddNode(Commit commit, JsopReader t, String path) {\n         Node n = new Node(path, commit.getRevision());\n         if (!t.matches('}')) {\n@@ -1104,27 +1097,28 @@ public static void parseAddNode(Commit commit, JsopReader t, String path) {\n     public String branch(@Nullable String trunkRevisionId) throws MicroKernelException {\n         // nothing is written when the branch is created, the returned\n         // revision simply acts as a reference to the branch base revision\n-        String revisionId = trunkRevisionId != null ? trunkRevisionId : headRevision.toString();\n-        return \"b\" + revisionId;\n+        Revision revision = trunkRevisionId != null\n+                ? Revision.fromString(trunkRevisionId) : headRevision;\n+        return revision.asBranchRevision().toString();\n     }\n \n     @Override\n     public synchronized String merge(String branchRevisionId, String message)\n             throws MicroKernelException {\n         // TODO improve implementation if needed\n-        if (!branchRevisionId.startsWith(\"b\")) {\n+        Revision revision = Revision.fromString(branchRevisionId);\n+        if (!revision.isBranch()) {\n             throw new MicroKernelException(\"Not a branch: \" + branchRevisionId);\n         }\n \n-        String revisionId = stripBranchRevMarker(branchRevisionId);\n         // make branch commits visible\n         UpdateOp op = new UpdateOp(Utils.getIdFromPath(\"/\"), false);\n-        Revision revision = Revision.fromString(revisionId);\n         Branch b = branches.getBranch(revision);\n         Revision mergeCommit = newRevision();\n         NodeDocument.setModified(op, mergeCommit);\n         if (b != null) {\n             for (Revision rev : b.getCommits()) {\n+                rev = rev.asTrunkRevision();\n                 NodeDocument.setRevision(op, rev, \"c-\" + mergeCommit.toString());\n                 op.containsMapEntry(NodeDocument.COLLISIONS, rev.toString(), false);\n             }\n@@ -1148,23 +1142,23 @@ public String rebase(@Nonnull String branchRevisionId,\n                          @Nullable String newBaseRevisionId)\n             throws MicroKernelException {\n         // TODO conflict handling\n-        Revision r = Revision.fromString(stripBranchRevMarker(branchRevisionId));\n+        Revision r = Revision.fromString(branchRevisionId);\n         Revision base = newBaseRevisionId != null ?\n                 Revision.fromString(newBaseRevisionId) :\n                 headRevision;\n         Branch b = branches.getBranch(r);\n         if (b == null) {\n             // empty branch\n-            return \"b\" + base.toString();\n+            return base.asBranchRevision().toString();\n         }\n         if (b.getBase().equals(base)) {\n             return branchRevisionId;\n         }\n         // add a pseudo commit to make sure current head of branch\n         // has a higher revision than base of branch\n-        Revision head = newRevision();\n+        Revision head = newRevision().asBranchRevision();\n         b.rebase(head, base);\n-        return \"b\" + head.toString();\n+        return head.toString();\n     }\n \n     @Override\n@@ -1226,7 +1220,8 @@ public void applyChanges(Revision rev, String path,\n             ArrayList<String> removed) {\n         UnsavedModifications unsaved = unsavedLastRevisions;\n         if (isBranchCommit) {\n-            unsaved = branches.getBranch(rev).getModifications(rev);\n+            Revision branchRev = rev.asBranchRevision();\n+            unsaved = branches.getBranch(branchRev).getModifications(branchRev);\n         }\n         // track unsaved modifications of nodes that were not\n         // written in the commit (implicitly modified parent)",
                "deletions": 28
            },
            {
                "sha": "c815e5a951d24017d671c693a8bf1dc1466e6b97",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/NodeDocument.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/NodeDocument.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/NodeDocument.java",
                "status": "modified",
                "changes": 122,
                "additions": 73,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/NodeDocument.java?ref=ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
                "patch": "@@ -338,37 +338,7 @@ boolean isValidRevision(@Nonnull RevisionContext context,\n         if (validRevisions.contains(rev)) {\n             return true;\n         }\n-        if (containsRevision(rev)) {\n-            if (isCommitted(context, rev, readRevision)) {\n-                validRevisions.add(rev);\n-                return true;\n-            } else {\n-                // rev is in revisions map of this node, but not committed\n-                // no need to check _commitRoot field\n-                return false;\n-            }\n-        }\n-        // check commit root\n-        @SuppressWarnings(\"unchecked\")\n-        Map<String, Integer> commitRoot = (Map<String, Integer>) get(COMMIT_ROOT);\n-        String commitRootPath = null;\n-        if (commitRoot != null) {\n-            Integer depth = commitRoot.get(rev.toString());\n-            if (depth != null) {\n-                String p = Utils.getPathFromId(getId());\n-                commitRootPath = PathUtils.getAncestorPath(p, PathUtils.getDepth(p) - depth);\n-            }\n-        }\n-        if (commitRootPath == null) {\n-            // shouldn't happen, either node is commit root for a revision\n-            // or has a reference to the commit root\n-            log.warn(\"Node {} does not have commit root reference for revision {}\",\n-                    getId(), rev);\n-            return false;\n-        }\n-        // get root of commit\n-        NodeDocument doc = store.find(Collection.NODES,\n-                Utils.getIdFromPath(commitRootPath));\n+        NodeDocument doc = getCommitRoot(rev);\n         if (doc == null) {\n             return false;\n         }\n@@ -760,6 +730,40 @@ public static void setDeleted(@Nonnull UpdateOp op,\n \n     //----------------------------< internal >----------------------------------\n \n+    /**\n+     * Returns the commit root document for the given revision. This may either\n+     * be this document or another one.\n+     *\n+     * @param rev a revision.\n+     * @return the commit root or <code>null</code> if there is none.\n+     */\n+    @CheckForNull\n+    private NodeDocument getCommitRoot(@Nonnull Revision rev) {\n+        if (containsRevision(rev)) {\n+            return this;\n+        }\n+        // check commit root\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Integer> commitRoot = (Map<String, Integer>) get(COMMIT_ROOT);\n+        String commitRootPath = null;\n+        if (commitRoot != null) {\n+            Integer depth = commitRoot.get(rev.toString());\n+            if (depth != null) {\n+                String p = Utils.getPathFromId(getId());\n+                commitRootPath = PathUtils.getAncestorPath(p, PathUtils.getDepth(p) - depth);\n+            }\n+        }\n+        if (commitRootPath == null) {\n+            // shouldn't happen, either node is commit root for a revision\n+            // or has a reference to the commit root\n+            log.warn(\"Node {} does not have commit root reference for revision {}\",\n+                    getId(), rev);\n+            return null;\n+        }\n+        // get root of commit\n+        return store.find(Collection.NODES, Utils.getIdFromPath(commitRootPath));\n+    }\n+\n     /**\n      * Checks that revision x is newer than another revision.\n      *\n@@ -787,40 +791,59 @@ private static boolean isRevisionNewer(@Nonnull RevisionContext context,\n     private boolean isCommitted(@Nonnull RevisionContext context,\n                                 @Nonnull Revision revision,\n                                 @Nonnull Revision readRevision) {\n-        if (revision.equals(readRevision)) {\n+        if (revision.equalsIgnoreBranch(readRevision)) {\n             return true;\n         }\n-        String r = revision.toString();\n-        String value = getRevisionsMap().get(r);\n-        if (value == null) {\n-            // check previous\n-            for (NodeDocument prev : getPreviousDocs(revision)) {\n-                value = prev.getRevisionsMap().get(r);\n-                if (value != null) {\n-                    break;\n-                }\n-            }\n-        }\n+        String value = getCommitValue(revision);\n         if (value == null) {\n             return false;\n         }\n         if (Utils.isCommitted(value)) {\n-            // resolve commit revision\n-            revision = Utils.resolveCommitRevision(revision, value);\n-            if (context.getBranches().getBranch(readRevision) == null) {\n+            if (context.getBranches().getBranch(readRevision) == null\n+                    && !readRevision.isBranch()) {\n+                // resolve commit revision\n+                revision = Utils.resolveCommitRevision(revision, value);\n                 // readRevision is not from a branch\n                 // compare resolved revision as is\n                 return !isRevisionNewer(context, revision, readRevision);\n+            } else {\n+                // on same merged branch?\n+                if (value.equals(getCommitValue(readRevision.asTrunkRevision()))) {\n+                    // compare unresolved revision\n+                    return !isRevisionNewer(context, revision, readRevision);\n+                }\n             }\n         } else {\n-            // branch commit\n+            // branch commit (not merged)\n             if (Revision.fromString(value).getClusterId() != context.getClusterId()) {\n                 // this is an unmerged branch commit from another cluster node,\n                 // hence never visible to us\n                 return false;\n             }\n         }\n-        return includeRevision(context, revision, readRevision);\n+        return includeRevision(context, Utils.resolveCommitRevision(revision, value), readRevision);\n+    }\n+\n+    /**\n+     * Returns the commit value for the given <code>revision</code>.\n+     *\n+     * @param revision a revision.\n+     * @return the commit value or <code>null</code> if the revision is unknown.\n+     */\n+    @CheckForNull\n+    private String getCommitValue(Revision revision) {\n+        String r = revision.toString();\n+        String value = getRevisionsMap().get(r);\n+        if (value == null) {\n+            // check previous\n+            for (NodeDocument prev : getPreviousDocs(revision)) {\n+                value = prev.getRevisionsMap().get(r);\n+                if (value != null) {\n+                    break;\n+                }\n+            }\n+        }\n+        return value;\n     }\n \n     private static boolean includeRevision(RevisionContext context,\n@@ -833,7 +856,8 @@ private static boolean includeRevision(RevisionContext context,\n             if (b.containsCommit(requestRevision)) {\n                 // in same branch, include if the same revision or\n                 // requestRevision is newer\n-                return x.equals(requestRevision) || isRevisionNewer(context, requestRevision, x);\n+                return x.equalsIgnoreBranch(requestRevision)\n+                        || isRevisionNewer(context, requestRevision, x);\n             }\n             // not part of branch identified by requestedRevision\n             return false;",
                "deletions": 49
            },
            {
                "sha": "69c05ad57c5edacd8b64f0982e5ed27c73967c80",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java",
                "status": "modified",
                "changes": 74,
                "additions": 69,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/Revision.java?ref=ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
                "patch": "@@ -51,18 +51,28 @@\n      * The cluster id (the MongoDB machine id).\n      */\n     private int clusterId;\n+\n+    /**\n+     * Whether this is a branch revision.\n+     */\n+    private final boolean branch;\n     \n     /**\n      * The string representation.\n      */\n     private String string;\n     \n     public Revision(long timestamp, int counter, int clusterId) {\n+        this(timestamp, counter, clusterId, false);\n+    }\n+    \n+    public Revision(long timestamp, int counter, int clusterId, boolean branch) {\n         this.timestamp = timestamp;\n         this.counter = counter;\n         this.clusterId = clusterId;\n+        this.branch = branch;\n     }\n-    \n+\n     /**\n      * Compare the time part of two revisions. If they contain the same time,\n      * the counter is compared.\n@@ -128,6 +138,11 @@ public static long getTimestampDifference(long a, long b) {\n     }\n     \n     public static Revision fromString(String rev) {\n+        boolean isBranch = false;\n+        if (rev.startsWith(\"b\")) {\n+            isBranch = true;\n+            rev = rev.substring(1);\n+        }\n         if (!rev.startsWith(\"r\")) {\n             throw new IllegalArgumentException(rev);\n         }\n@@ -145,14 +160,15 @@ public static Revision fromString(String rev) {\n         int c = Integer.parseInt(t, 16);\n         t = rev.substring(idxClusterId + 1);\n         int clusterId = Integer.parseInt(t, 16);\n-        Revision r = new Revision(timestamp, c, clusterId);\n+        Revision r = new Revision(timestamp, c, clusterId, isBranch);\n         return r;\n     }\n     \n     @Override\n     public String toString() {\n         if (string == null) {\n-            string = new StringBuilder(\"r\").\n+            string = new StringBuilder(branch ? \"b\" : \"\").\n+                append('r').\n                 append(Long.toHexString(timestamp)).\n                 append('-').\n                 append(Integer.toHexString(counter)).\n@@ -175,7 +191,43 @@ public long getTimestamp() {\n     public int getCounter() {\n         return counter;\n     }\n-    \n+\n+    /**\n+     * @return <code>true</code> if this is a branch revision, otherwise\n+     *         <code>false</code>.\n+     */\n+    public boolean isBranch() {\n+        return branch;\n+    }\n+\n+    /**\n+     * Returns a revision with the same timestamp, counter and clusterId as this\n+     * revision and the branch flag set to <code>true</code>.\n+     *\n+     * @return branch revision with this timestamp, counter and clusterId.\n+     */\n+    public Revision asBranchRevision() {\n+        if (isBranch()) {\n+            return this;\n+        } else {\n+            return new Revision(timestamp, counter, clusterId, true);\n+        }\n+    }\n+\n+    /**\n+     * Returns a revision with the same timestamp, counter and clusterId as this\n+     * revision and the branch flag set to <code>false</code>.\n+     *\n+     * @return trunkrevision with this timestamp, counter and clusterId.\n+     */\n+    public Revision asTrunkRevision() {\n+        if (!isBranch()) {\n+            return this;\n+        } else {\n+            return new Revision(timestamp, counter, clusterId);\n+        }\n+    }\n+\n     @Override\n     public int hashCode() {\n         return (int) (timestamp >>> 32) ^ (int) timestamp ^ counter ^ clusterId;\n@@ -193,7 +245,19 @@ public boolean equals(Object other) {\n         Revision r = (Revision) other;\n         return r.timestamp == this.timestamp && \n                 r.counter == this.counter && \n-                r.clusterId == this.clusterId;\n+                r.clusterId == this.clusterId &&\n+                r.branch == this.branch;\n+    }\n+\n+    public boolean equalsIgnoreBranch(Revision other) {\n+        if (this == other) {\n+            return true;\n+        } else if (other == null) {\n+            return false;\n+        }\n+        return other.timestamp == this.timestamp &&\n+                other.counter == this.counter &&\n+                other.clusterId == this.clusterId;\n     }\n \n     public int getClusterId() {",
                "deletions": 5
            },
            {
                "sha": "86522e01e8bee4bbb8b43f44048c764f18b1e038",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/UnmergedBranches.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/UnmergedBranches.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/UnmergedBranches.java",
                "status": "modified",
                "changes": 17,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/mongomk/UnmergedBranches.java?ref=ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
                "patch": "@@ -28,6 +28,7 @@\n \n import org.apache.jackrabbit.oak.plugins.mongomk.util.Utils;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n import static com.google.common.base.Preconditions.checkNotNull;\n \n /**\n@@ -67,15 +68,18 @@ void init(DocumentStore store, RevisionContext context) {\n             throw new IllegalStateException(\"already initialized\");\n         }\n         NodeDocument doc = store.find(Collection.NODES, Utils.getIdFromPath(\"/\"));\n+        if (doc == null) {\n+            return;\n+        }\n         SortedMap<Revision, Revision> revisions = doc.getUncommittedRevisions(context);\n         while (!revisions.isEmpty()) {\n             SortedSet<Revision> commits = new TreeSet<Revision>(comparator);\n             Revision head = revisions.lastKey();\n             commits.add(head);\n-            Revision base = revisions.remove(head);\n+            Revision base = revisions.remove(head).asTrunkRevision();\n             while (revisions.containsKey(base)) {\n                 commits.add(base);\n-                base = revisions.remove(base);\n+                base = revisions.remove(base).asTrunkRevision();\n             }\n             branches.add(new Branch(commits, base, comparator));\n         }\n@@ -87,12 +91,17 @@ void init(DocumentStore store, RevisionContext context) {\n      * @param base the base revision of the branch.\n      * @param initial the initial commit to the branch.\n      * @return the branch.\n+     * @throws IllegalArgumentException if\n      */\n     @Nonnull\n     Branch create(@Nonnull Revision base, @Nonnull Revision initial) {\n+        checkArgument(!checkNotNull(base).isBranch(),\n+                \"base is not a trunk revision: %s\", base);\n+        checkArgument(checkNotNull(initial).isBranch(),\n+                \"initial is not a branch revision: %s\", initial);\n         SortedSet<Revision> commits = new TreeSet<Revision>(comparator);\n-        commits.add(checkNotNull(initial));\n-        Branch b = new Branch(commits, checkNotNull(base), comparator);\n+        commits.add(initial);\n+        Branch b = new Branch(commits, base, comparator);\n         synchronized (branches) {\n             branches.add(b);\n         }",
                "deletions": 4
            },
            {
                "sha": "48e8e3a6c99c16b4d575557956e43f49ad95c715",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ef0855c515b0cb4d8124270fb85ab9a638c3c7b8/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java",
                "status": "modified",
                "changes": 14,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java?ref=ef0855c515b0cb4d8124270fb85ab9a638c3c7b8",
                "patch": "@@ -441,14 +441,18 @@ public void run() {\n         }\n     }\n \n-    @Ignore(\"OAK-992\")\n     @Test\n     public void branchReadAfterMerge() {\n         String branchRev = mk.branch(null);\n-        branchRev = mk.commit(\"/\", \"+\\\"foo\\\":{}\", branchRev, null);\n-        branchRev = mk.commit(\"/\", \"+\\\"bar\\\":{}\", branchRev, null);\n-        mk.merge(branchRev, null);\n-        assertNodesExist(branchRev, \"/foo\");\n+        String branchRev1 = mk.commit(\"/\", \"+\\\"foo\\\":{}\", branchRev, null);\n+        String branchRev2 = mk.commit(\"/\", \"+\\\"bar\\\":{}\", branchRev1, null);\n+        mk.merge(branchRev2, null);\n+\n+        assertNodesExist(branchRev2, \"/foo\");\n+        assertNodesExist(branchRev2, \"/bar\");\n+\n+        assertNodesExist(branchRev1, \"/foo\");\n+        assertNodesNotExist(branchRev1, \"/bar\");\n     }\n \n     //--------------------------< internal >------------------------------------",
                "deletions": 5
            }
        ],
        "patched_files": [
            "MongoMK.java",
            "UnmergedBranches.java",
            "NodeDocument.java",
            "Revision.java",
            "Branch.java"
        ],
        "unit_tests": [
            "MongoMKBranchMergeTest.java",
            "RevisionTest.java"
        ]
    },
    "jackrabbit-oak_a510d38": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6379 NPE in MergingNodeStateDiff on DELETE_DELETED_PROPERTY\n\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1799559 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/a510d38b482574dba044ff0bd6610391321e1bc1",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/9b42e01a703186bb29630b3051cd7810be5008ed",
        "bug_id": "jackrabbit-oak_a510d38",
        "file": [
            {
                "sha": "58e1ac7e2c33d2f96adf49b37cc00978818cff57",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/commit/MergingNodeStateDiff.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a510d38b482574dba044ff0bd6610391321e1bc1/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/commit/MergingNodeStateDiff.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a510d38b482574dba044ff0bd6610391321e1bc1/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/commit/MergingNodeStateDiff.java",
                "status": "modified",
                "changes": 11,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/commit/MergingNodeStateDiff.java?ref=a510d38b482574dba044ff0bd6610391321e1bc1",
                "patch": "@@ -164,13 +164,11 @@ private void resolveConflict(ConflictType conflictType, NodeState conflictInfo)\n     private void applyPropertyResolution(Resolution resolution, ConflictType conflictType, String name, PropertyState ours) {\n         NodeBuilder conflictMarker = getConflictMarker(conflictType);\n         if (resolution == Resolution.OURS) {\n-            if (DELETE_CHANGED_PROPERTY == conflictType) {\n+            if (DELETE_CHANGED_PROPERTY == conflictType || DELETE_DELETED_PROPERTY == conflictType) {\n                 target.removeProperty(name);\n-            }\n-            else {\n+            } else {\n                 target.setProperty(ours);\n             }\n-\n         }\n         NodeBuilder baseClean = conflictMarker.getChildNode(ConflictAnnotatingRebaseDiff.BASE);\n         if (baseClean.exists()) {\n@@ -185,10 +183,9 @@ private void applyPropertyResolution(Resolution resolution, ConflictType conflic\n     private void applyResolution(Resolution resolution, ConflictType conflictType, String name, NodeState ours) {\n         NodeBuilder conflictMarker = getConflictMarker(conflictType);\n         if (resolution == Resolution.OURS) {\n-            if (DELETE_CHANGED_NODE == conflictType) {\n+            if (DELETE_CHANGED_NODE == conflictType || DELETE_DELETED_NODE == conflictType) {\n                 removeChild(target, name);\n-            }\n-            else {\n+            } else {\n                 addChild(target, name, ours);\n             }\n         }",
                "deletions": 7
            },
            {
                "sha": "18cdb8405899b0d4e1f3ca62671f1c466ae9be9b",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerOursTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a510d38b482574dba044ff0bd6610391321e1bc1/oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerOursTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a510d38b482574dba044ff0bd6610391321e1bc1/oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerOursTest.java",
                "status": "modified",
                "changes": 25,
                "additions": 24,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerOursTest.java?ref=a510d38b482574dba044ff0bd6610391321e1bc1",
                "patch": "@@ -74,7 +74,7 @@ public void tearDown() {\n     }\n \n     @Test\n-    public void testAddExistingProperties() throws CommitFailedException {\n+    public void testAddExistingProperty() throws CommitFailedException {\n         theirRoot.getTree(\"/\").setProperty(\"p\", THEIR_VALUE);\n         theirRoot.getTree(\"/\").setProperty(\"q\", THEIR_VALUE);\n         ourRoot.getTree(\"/\").setProperty(\"p\", OUR_VALUE);\n@@ -118,6 +118,18 @@ public void testChangeChangedProperty() throws CommitFailedException {\n         assertEquals(OUR_VALUE, p.getValue(STRING));\n     }\n \n+    @Test\n+    public void testDeleteDeletedProperty() throws CommitFailedException {\n+        theirRoot.getTree(\"/\").removeProperty(\"a\");\n+        ourRoot.getTree(\"/\").removeProperty(\"a\");\n+\n+        theirRoot.commit();\n+        ourRoot.commit();\n+\n+        PropertyState p = ourRoot.getTree(\"/\").getProperty(\"a\");\n+        assertNull(p);\n+    }\n+\n     @Test\n     public void testDeleteChangedProperty() throws CommitFailedException {\n         theirRoot.getTree(\"/\").setProperty(\"a\", THEIR_VALUE);\n@@ -168,4 +180,15 @@ public void testDeleteChangedNode() throws CommitFailedException {\n         assertFalse(n.exists());\n     }\n \n+    @Test\n+    public void testDeleteDeletedNode() throws CommitFailedException {\n+        theirRoot.getTree(\"/x\").remove();\n+        ourRoot.getTree(\"/x\").remove();\n+\n+        theirRoot.commit();\n+        ourRoot.commit();\n+\n+        assertFalse(ourRoot.getTree(\"/x\").exists());\n+    }\n+\n }",
                "deletions": 1
            },
            {
                "sha": "0cc2802b3326832752cb20f82ff4573996d25c90",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerTheirsTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a510d38b482574dba044ff0bd6610391321e1bc1/oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerTheirsTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a510d38b482574dba044ff0bd6610391321e1bc1/oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerTheirsTest.java",
                "status": "modified",
                "changes": 24,
                "additions": 23,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/core/DefaultThreeWayConflictHandlerTheirsTest.java?ref=a510d38b482574dba044ff0bd6610391321e1bc1",
                "patch": "@@ -74,7 +74,7 @@ public void tearDown() {\n     }\n \n     @Test\n-    public void testAddExistingProperties() throws CommitFailedException {\n+    public void testAddExistingProperty() throws CommitFailedException {\n         theirRoot.getTree(\"/\").setProperty(\"p\", THEIR_VALUE);\n         theirRoot.getTree(\"/\").setProperty(\"q\", THEIR_VALUE);\n         ourRoot.getTree(\"/\").setProperty(\"p\", OUR_VALUE);\n@@ -117,6 +117,18 @@ public void testChangeChangedProperty() throws CommitFailedException {\n         assertEquals(THEIR_VALUE, p.getValue(STRING));\n     }\n \n+    @Test\n+    public void testDeleteDeletedProperty() throws CommitFailedException {\n+        theirRoot.getTree(\"/\").removeProperty(\"a\");\n+        ourRoot.getTree(\"/\").removeProperty(\"a\");\n+\n+        theirRoot.commit();\n+        ourRoot.commit();\n+\n+        PropertyState p = ourRoot.getTree(\"/\").getProperty(\"a\");\n+        assertNull(p);\n+    }\n+\n     @Test\n     public void testDeleteChangedProperty() throws CommitFailedException {\n         theirRoot.getTree(\"/\").setProperty(\"a\", THEIR_VALUE);\n@@ -168,4 +180,14 @@ public void testDeleteChangedNode() throws CommitFailedException {\n         assertEquals(THEIR_VALUE, n.getProperty(\"p\").getValue(STRING));\n     }\n \n+    @Test\n+    public void testDeleteDeletedNode() throws CommitFailedException {\n+        theirRoot.getTree(\"/x\").remove();\n+        ourRoot.getTree(\"/x\").remove();\n+\n+        theirRoot.commit();\n+        ourRoot.commit();\n+\n+        assertFalse(ourRoot.getTree(\"/x\").exists());\n+    }\n }",
                "deletions": 1
            }
        ],
        "patched_files": [
            "MergingNodeStateDiff.java"
        ],
        "unit_tests": [
            "DefaultThreeWayConflictHandlerOursTest.java",
            "DefaultThreeWayConflictHandlerTheirsTest.java"
        ]
    },
    "jackrabbit-oak_53bf04a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-883 Possible NPE in ContentMirrorStoreStrategy.PathIterator\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1497366 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/53bf04acfe787b9c25885cdf43df9a243d78ffda",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/f93ea42ccd1630b1cf605906b2a4121176a64580",
        "bug_id": "jackrabbit-oak_53bf04a",
        "file": [
            {
                "sha": "f096a63930d7bc130008253918e9f81f1af2216d",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/property/strategy/ContentMirrorStoreStrategy.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/53bf04acfe787b9c25885cdf43df9a243d78ffda/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/property/strategy/ContentMirrorStoreStrategy.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/53bf04acfe787b9c25885cdf43df9a243d78ffda/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/property/strategy/ContentMirrorStoreStrategy.java",
                "status": "modified",
                "changes": 46,
                "additions": 28,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/property/strategy/ContentMirrorStoreStrategy.java?ref=53bf04acfe787b9c25885cdf43df9a243d78ffda",
                "patch": "@@ -200,6 +200,9 @@ void enqueue(Iterator<? extends ChildNodeEntry> it) {\n         }\n         \n         void setPathContainsValue(boolean pathContainsValue) {\n+            if (init) {\n+                throw new IllegalStateException(\"This iterator is already initialized\");\n+            }\n             this.pathContainsValue = pathContainsValue;\n         }\n \n@@ -211,8 +214,28 @@ public boolean hasNext() {\n             }\n             return !closed;\n         }\n-        \n+\n         private void fetchNext() {\n+            while (true) {\n+                fetchNextPossiblyDuplicate();\n+                if (closed) {\n+                    return;\n+                }\n+                if (pathContainsValue) {\n+                    String value = PathUtils.elements(currentPath).iterator().next();\n+                    currentPath = PathUtils.relativize(value, currentPath);\n+                    // don't return duplicate paths:\n+                    // Set.add returns true if the entry was new,\n+                    // so if it returns false, it was already known\n+                    if (!knownPaths.add(currentPath)) {\n+                        continue;\n+                    }\n+                }\n+                break;\n+            }\n+        }\n+        \n+        private void fetchNextPossiblyDuplicate() {\n             while (!nodeIterators.isEmpty()) {\n                 Iterator<? extends ChildNodeEntry> iterator = nodeIterators.getLast();\n                 if (iterator.hasNext()) {\n@@ -247,7 +270,6 @@ private void fetchNext() {\n             closed = true;\n         }\n \n-\n         @Override\n         public String next() {\n             if (closed) {\n@@ -257,23 +279,11 @@ public String next() {\n                 fetchNext();\n                 init = true;\n             }\n-            while (true) {\n-                String result = currentPath;\n-                fetchNext();\n-                if (pathContainsValue) {\n-                    String value = PathUtils.elements(result).iterator().next();\n-                    result = PathUtils.relativize(value, result);\n-                    // don't return duplicate paths:\n-                    // Set.add returns true if the entry was new,\n-                    // so if it returns false, it was already known\n-                    if (!knownPaths.add(result)) {\n-                        continue;\n-                    }\n-                }\n-                return result;\n-            }\n+            String result = currentPath;\n+            fetchNext();\n+            return result;\n         }\n-\n+        \n         @Override\n         public void remove() {\n             throw new UnsupportedOperationException();",
                "deletions": 18
            }
        ],
        "patched_files": [
            "ContentMirrorStoreStrategy.java"
        ],
        "unit_tests": [
            "ContentMirrorStoreStrategyTest.java"
        ]
    },
    "jackrabbit-oak_1d6dfdf": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7508: Text extraction timeout can lead to NPE\n\nAlso fix in oak-seach module (test to be committed under OAK-7410)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1832377 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/1d6dfdf596072ebc761081576469bcc943a49804",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/b997936d972e9b26f6ff276262428a9ddc5bd5ad",
        "bug_id": "jackrabbit-oak_1d6dfdf",
        "file": [
            {
                "sha": "98a8c0b5b84437796f5429ef5def72e9ddbebcc2",
                "filename": "oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCache.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1d6dfdf596072ebc761081576469bcc943a49804/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCache.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1d6dfdf596072ebc761081576469bcc943a49804/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCache.java",
                "status": "modified",
                "changes": 7,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCache.java?ref=1d6dfdf596072ebc761081576469bcc943a49804",
                "patch": "@@ -158,9 +158,12 @@ public void putTimeout(@Nonnull Blob blob, @Nonnull ExtractedText extractedText)\n         if (EXTRACT_FORGET_TIMEOUT) {\n             return;\n         }\n+\n         String id = blob.getContentIdentity();\n-        timeoutMap.put(id, getText(extractedText));\n-        storeTimeoutMap();\n+        if (id != null) {\n+            timeoutMap.put(id, getText(extractedText));\n+            storeTimeoutMap();\n+        }\n     }\n \n     private static String getText(ExtractedText text) {",
                "deletions": 2
            }
        ],
        "patched_files": [
            "ExtractedTextCache.java"
        ],
        "unit_tests": [
            "ExtractedTextCacheTest.java"
        ]
    },
    "jackrabbit-oak_b71e923": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2844 - avoid a NPE on clear on jenkins\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1697399 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/b71e923471c3a1744bf3f1dfdec08ee51a316ffa",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/b901500a21fcef14873de95e188f1b87903eecf9",
        "bug_id": "jackrabbit-oak_b71e923",
        "file": [
            {
                "sha": "a5bfea0f55c3f192931a42f785b0171cecc3caff",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentDiscoveryLiteServiceTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b71e923471c3a1744bf3f1dfdec08ee51a316ffa/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentDiscoveryLiteServiceTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b71e923471c3a1744bf3f1dfdec08ee51a316ffa/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentDiscoveryLiteServiceTest.java",
                "status": "modified",
                "changes": 10,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentDiscoveryLiteServiceTest.java?ref=b71e923471c3a1744bf3f1dfdec08ee51a316ffa",
                "patch": "@@ -55,6 +55,7 @@\n import org.apache.jackrabbit.oak.commons.json.JsonObject;\n import org.apache.jackrabbit.oak.commons.json.JsopTokenizer;\n import org.apache.jackrabbit.oak.plugins.document.memory.MemoryDocumentStore;\n+import org.apache.jackrabbit.oak.plugins.document.util.MongoConnection;\n import org.apache.jackrabbit.oak.spi.blob.BlobStore;\n import org.apache.jackrabbit.oak.spi.blob.MemoryBlobStore;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n@@ -1009,8 +1010,13 @@ public void clear() {\n         }\n         mks.clear();\n         if (MONGO_DB) {\n-            DB db = MongoUtils.getConnection().getDB();\n-            MongoUtils.dropCollections(db);\n+            MongoConnection connection = MongoUtils.getConnection();\n+            if (connection != null) {\n+                DB db = connection.getDB();\n+                if (db != null) {\n+                    MongoUtils.dropCollections(db);\n+                }\n+            }\n         }\n     }\n ",
                "deletions": 2
            }
        ],
        "patched_files": [
            "DocumentDiscoveryLiteService.java"
        ],
        "unit_tests": [
            "DocumentDiscoveryLiteServiceTest.java"
        ]
    },
    "jackrabbit-oak_bc30ef8": {
        "repo": "jackrabbit-oak",
        "message": "OAK-741: Better toString() methods\nAvoid NPE in toString\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1467298 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/bc30ef8e4c0dbc097c25346d36b8c16355df29a5",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/a5ea2cdad86b8677b46c4c88954ec90c2f28760d",
        "bug_id": "jackrabbit-oak_bc30ef8",
        "file": [
            {
                "sha": "211871a1a95278fe49b419fe5d80b86b3ee873b9",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/core/RootImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/bc30ef8e4c0dbc097c25346d36b8c16355df29a5/oak-core/src/main/java/org/apache/jackrabbit/oak/core/RootImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/bc30ef8e4c0dbc097c25346d36b8c16355df29a5/oak-core/src/main/java/org/apache/jackrabbit/oak/core/RootImpl.java",
                "status": "modified",
                "changes": 17,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/core/RootImpl.java?ref=bc30ef8e4c0dbc097c25346d36b8c16355df29a5",
                "patch": "@@ -18,12 +18,19 @@\n  */\n package org.apache.jackrabbit.oak.core;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.jackrabbit.oak.commons.PathUtils.elements;\n+import static org.apache.jackrabbit.oak.commons.PathUtils.getName;\n+import static org.apache.jackrabbit.oak.commons.PathUtils.getParentPath;\n+\n import java.io.IOException;\n import java.io.InputStream;\n import java.security.PrivilegedAction;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n+\n import javax.annotation.Nonnull;\n import javax.security.auth.Subject;\n \n@@ -60,12 +67,6 @@\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n import org.apache.jackrabbit.oak.spi.state.NodeStoreBranch;\n \n-import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static org.apache.jackrabbit.oak.commons.PathUtils.elements;\n-import static org.apache.jackrabbit.oak.commons.PathUtils.getName;\n-import static org.apache.jackrabbit.oak.commons.PathUtils.getParentPath;\n-\n public class RootImpl implements Root {\n \n     /**\n@@ -510,7 +511,9 @@ Move apply(TreeImpl tree) {\n \n         @Override\n         public String toString() {\n-            return '>' + source + ':' + PathUtils.concat(destParent.getPathInternal(), destName);\n+            return source == null\n+                ? \"NIL\"\n+                : '>' + source + ':' + PathUtils.concat(destParent.getPathInternal(), destName);\n         }\n     }\n }",
                "deletions": 7
            }
        ],
        "patched_files": [
            "RootImpl.java"
        ],
        "unit_tests": [
            "RootImplTest.java"
        ]
    },
    "jackrabbit-oak_1d42f6d": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2784 - Potential NPEs in BackgroundObserverMBean\n\nApply patch from Marcel. Remove Nullable annotation to indicate that parameter cannot be null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1675074 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/1d42f6d206286e51fc0396c932d29a9b4726fdc3",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/65e7265b5f890d946c8438b3c63693cf7e147127",
        "bug_id": "jackrabbit-oak_1d42f6d",
        "file": [
            {
                "sha": "3e15297b76359fef8ed21286a414076259dc2465",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/BackgroundObserver.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1d42f6d206286e51fc0396c932d29a9b4726fdc3/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/BackgroundObserver.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1d42f6d206286e51fc0396c932d29a9b4726fdc3/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/BackgroundObserver.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/commit/BackgroundObserver.java?ref=1d42f6d206286e51fc0396c932d29a9b4726fdc3",
                "patch": "@@ -227,7 +227,7 @@ public int getMaxQueueSize() {\n             public int getLocalEventCount() {\n                 return size(filter(queue, new Predicate<ContentChange>() {\n                     @Override\n-                    public boolean apply(@Nullable ContentChange input) {\n+                    public boolean apply(ContentChange input) {\n                         return input.info != null;\n                     }\n                 }));\n@@ -237,7 +237,7 @@ public boolean apply(@Nullable ContentChange input) {\n             public int getExternalEventCount() {\n                 return size(filter(queue, new Predicate<ContentChange>() {\n                     @Override\n-                    public boolean apply(@Nullable ContentChange input) {\n+                    public boolean apply(ContentChange input) {\n                         return input.info == null;\n                     }\n                 }));",
                "deletions": 2
            }
        ],
        "patched_files": [
            "BackgroundObserver.java"
        ],
        "unit_tests": [
            "BackgroundObserverTest.java"
        ]
    },
    "jackrabbit-oak_d8432d6": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4017: fix potential NPE in ObservationTest.tearDown()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1730216 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/d8432d67f443b8a028c3df8b0f90450b42b4a3f4",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/2d31be49c0be7fb090dd5fc442cc244a9952488e",
        "bug_id": "jackrabbit-oak_d8432d6",
        "file": [
            {
                "sha": "9883295dc5f105417cbb14873cdf3949f78a512c",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ObservationTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d8432d67f443b8a028c3df8b0f90450b42b4a3f4/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ObservationTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d8432d67f443b8a028c3df8b0f90450b42b4a3f4/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ObservationTest.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ObservationTest.java?ref=d8432d67f443b8a028c3df8b0f90450b42b4a3f4",
                "patch": "@@ -131,7 +131,9 @@ public void setup() throws RepositoryException {\n \n     @After\n     public void tearDown() {\n-        observingSession.logout();\n+        if (observingSession != null) {\n+            observingSession.logout();\n+        }\n     }\n \n     @Test",
                "deletions": 1
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "ObservationTest.java"
        ]
    },
    "jackrabbit-oak_2dc3516": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1953: Oak console on MongoMK fails with NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1608463 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/2dc351603dfef3d214b562b821dcfec45f22de13",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/4af966397dcbf4a0c54a28ddd1034cb556bc315d",
        "bug_id": "jackrabbit-oak_2dc3516",
        "file": [
            {
                "sha": "810fbede3177deefb3c935c8cb47bdaf35086557",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/LastRevRecoveryAgent.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/2dc351603dfef3d214b562b821dcfec45f22de13/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/LastRevRecoveryAgent.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/2dc351603dfef3d214b562b821dcfec45f22de13/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/LastRevRecoveryAgent.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/LastRevRecoveryAgent.java?ref=2dc351603dfef3d214b562b821dcfec45f22de13",
                "patch": "@@ -78,11 +78,11 @@ public int recover(int clusterId) {\n         final long asyncDelay = nodeStore.getAsyncDelay();\n \n         if (nodeInfo != null) {\n-            long leaseEnd = nodeInfo.getLeaseEndTime();\n-\n             // Check if _lastRev recovery needed for this cluster node\n             // state is Active && recoveryLock not held by someone\n-            if (isRecoveryNeeded(nodeInfo)) {            \n+            if (isRecoveryNeeded(nodeInfo)) {\n+                long leaseEnd = nodeInfo.getLeaseEndTime();\n+\n                 // retrieve the root document's _lastRev\n                 NodeDocument root = missingLastRevUtil.getRoot();\n                 Revision lastRev = root.getLastRev().get(clusterId);",
                "deletions": 3
            }
        ],
        "patched_files": [
            "LastRevRecoveryAgent.java"
        ],
        "unit_tests": [
            "LastRevRecoveryAgentTest.java"
        ]
    },
    "jackrabbit-oak_053f110": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1218 : NPE in PrincipalManagerTest#testMembers\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1545217 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/053f110542ffb177894d8662ca1e6e58ad469734",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/1a2a484a41e592d7df42c4ab58dcc540e0cc141b",
        "bug_id": "jackrabbit-oak_053f110",
        "file": [
            {
                "sha": "31ed6d346e1046cb7fa7b3ab7591f8249529a934",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/IdentifierManager.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/053f110542ffb177894d8662ca1e6e58ad469734/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/IdentifierManager.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/053f110542ffb177894d8662ca1e6e58ad469734/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/IdentifierManager.java",
                "status": "modified",
                "changes": 39,
                "additions": 30,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/IdentifierManager.java?ref=053f110542ffb177894d8662ca1e6e58ad469734",
                "patch": "@@ -16,19 +16,11 @@\n  */\n package org.apache.jackrabbit.oak.plugins.identifier;\n \n-import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Predicates.notNull;\n-import static com.google.common.collect.Iterators.emptyIterator;\n-import static com.google.common.collect.Iterators.filter;\n-import static com.google.common.collect.Iterators.singletonIterator;\n-import static com.google.common.collect.Iterators.transform;\n-\n import java.text.ParseException;\n import java.util.Collections;\n import java.util.Iterator;\n import java.util.Map;\n import java.util.UUID;\n-\n import javax.annotation.CheckForNull;\n import javax.annotation.Nonnull;\n import javax.jcr.PropertyType;\n@@ -54,6 +46,13 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Predicates.notNull;\n+import static com.google.common.collect.Iterators.emptyIterator;\n+import static com.google.common.collect.Iterators.filter;\n+import static com.google.common.collect.Iterators.singletonIterator;\n+import static com.google.common.collect.Iterators.transform;\n+\n /**\n  * TODO document\n  */\n@@ -171,6 +170,24 @@ public String getPath(PropertyState referenceValue) {\n         }\n     }\n \n+    /**\n+     * Returns the path of the tree references by the specified (weak)\n+     * reference {@code PropertyState}.\n+     *\n+     * @param referenceValue A (weak) reference value.\n+     * @return The tree with the given {@code identifier} or {@code null} if no\n+     *         such tree exists or isn't accessible to the content session.\n+     */\n+    @CheckForNull\n+    public String getPath(PropertyValue referenceValue) {\n+        int type = referenceValue.getType().tag();\n+        if (type == PropertyType.REFERENCE || type == PropertyType.WEAKREFERENCE) {\n+            return resolveUUID(referenceValue);\n+        } else {\n+            throw new IllegalArgumentException(\"Invalid value type\");\n+        }\n+    }\n+\n     /**\n      * Searches all reference properties to the specified {@code tree} that match\n      * the given name and node type constraints.\n@@ -274,8 +291,12 @@ public String resolveUUID(String uuid) {\n     }\n \n     private String resolveUUID(PropertyState uuid) {\n+        return resolveUUID(PropertyValues.create(uuid));\n+    }\n+\n+    private String resolveUUID(PropertyValue uuid) {\n         try {\n-            Map<String, PropertyValue> bindings = Collections.singletonMap(\"id\", PropertyValues.create(uuid));\n+            Map<String, PropertyValue> bindings = Collections.singletonMap(\"id\", uuid);\n             Result result = root.getQueryEngine().executeQuery(\n                     \"SELECT * FROM [nt:base] WHERE [jcr:uuid] = $id\", Query.JCR_SQL2,\n                     Long.MAX_VALUE, 0, bindings, new NamePathMapper.Default());",
                "deletions": 9
            },
            {
                "sha": "4c774742dfca406477c2c3454bcbdd2466c94124",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/GroupImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/053f110542ffb177894d8662ca1e6e58ad469734/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/GroupImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/053f110542ffb177894d8662ca1e6e58ad469734/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/GroupImpl.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/GroupImpl.java?ref=053f110542ffb177894d8662ca1e6e58ad469734",
                "patch": "@@ -191,7 +191,7 @@ public boolean apply(@Nullable Authorizable authorizable) {\n                     }\n             );\n         } else {\n-            Iterator oakPaths = getMembershipProvider().getMembers(getTree(), AuthorizableType.AUTHORIZABLE, includeInherited);\n+            Iterator<String> oakPaths = getMembershipProvider().getMembers(getTree(), AuthorizableType.AUTHORIZABLE, includeInherited);\n             if (oakPaths.hasNext()) {\n                 AuthorizableIterator iterator = AuthorizableIterator.create(oakPaths, userMgr, AuthorizableType.AUTHORIZABLE);\n                 return new RangeIteratorAdapter(iterator, iterator.getSize());",
                "deletions": 1
            },
            {
                "sha": "45e111411dfe43d9585e8eca2a4afd848fb5c02f",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/MembershipProvider.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/053f110542ffb177894d8662ca1e6e58ad469734/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/MembershipProvider.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/053f110542ffb177894d8662ca1e6e58ad469734/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/MembershipProvider.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/MembershipProvider.java?ref=053f110542ffb177894d8662ca1e6e58ad469734",
                "patch": "@@ -28,7 +28,7 @@\n import org.apache.jackrabbit.oak.api.Root;\n import org.apache.jackrabbit.oak.api.Tree;\n import org.apache.jackrabbit.oak.api.Type;\n-import org.apache.jackrabbit.oak.plugins.memory.PropertyStates;\n+import org.apache.jackrabbit.oak.spi.query.PropertyValues;\n import org.apache.jackrabbit.oak.spi.security.ConfigurationParameters;\n import org.apache.jackrabbit.oak.spi.security.user.AuthorizableType;\n import org.apache.jackrabbit.oak.spi.security.user.util.UserUtil;\n@@ -263,10 +263,10 @@ protected String getNext() {\n                         break;\n                     } else {\n                         String value = references.next();\n-                        next = identifierManager.getPath(PropertyStates.createProperty(\"\", value, Type.WEAKREFERENCE));\n+                        next = identifierManager.getPath(PropertyValues.newWeakReference(value));\n \n                         // filter by authorizable type, and/or get inherited members\n-                        if (includeInherited || authorizableType != AuthorizableType.AUTHORIZABLE) {\n+                        if (next != null && (includeInherited || authorizableType != AuthorizableType.AUTHORIZABLE)) {\n                             Tree auth = getByPath(next);\n                             AuthorizableType type = UserUtil.getType(auth);\n ",
                "deletions": 3
            },
            {
                "sha": "a306f868516b7236051f74e01616fe5caacd08bb",
                "filename": "oak-jcr/pom.xml",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/053f110542ffb177894d8662ca1e6e58ad469734/oak-jcr/pom.xml",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/053f110542ffb177894d8662ca1e6e58ad469734/oak-jcr/pom.xml",
                "status": "modified",
                "changes": 2,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/pom.xml?ref=053f110542ffb177894d8662ca1e6e58ad469734",
                "patch": "@@ -170,8 +170,6 @@\n \n       <!-- Node Types -->\n       org.apache.jackrabbit.oak.jcr.nodetype.MixinTest#testRemoveAddMixVersionable1                  <!-- OAK-1118 -->\n-\n-      org.apache.jackrabbit.oak.jcr.security.principal.PrincipalManagerTest#testMembers              <!-- OAK-1218 -->\n     </known.issues>\n   </properties>\n ",
                "deletions": 2
            },
            {
                "sha": "8154409f4ad5a6c092471adab7874e3dfa14f77d",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/053f110542ffb177894d8662ca1e6e58ad469734/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/053f110542ffb177894d8662ca1e6e58ad469734/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java",
                "status": "modified",
                "changes": 30,
                "additions": 29,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/principal/PrincipalManagerTest.java?ref=053f110542ffb177894d8662ca1e6e58ad469734",
                "patch": "@@ -28,6 +28,7 @@\n import org.apache.jackrabbit.api.JackrabbitSession;\n import org.apache.jackrabbit.api.security.principal.PrincipalIterator;\n import org.apache.jackrabbit.api.security.principal.PrincipalManager;\n+import org.apache.jackrabbit.api.security.user.Authorizable;\n import org.apache.jackrabbit.oak.spi.security.principal.EveryonePrincipal;\n import org.apache.jackrabbit.test.AbstractJCRTest;\n import org.apache.jackrabbit.test.NotExecutableException;\n@@ -175,7 +176,6 @@ public void testGetAllPrincipals() {\n     }\n \n     @Test\n-    // FIXME See OAK-1218\n     public void testMembers() {\n         PrincipalIterator it = principalMgr.getPrincipals(PrincipalManager.SEARCH_TYPE_ALL);\n         while (it.hasNext()) {\n@@ -193,6 +193,34 @@ public void testMembers() {\n         }\n     }\n \n+    @Test\n+    public void testMembers2() throws Exception {\n+        Authorizable gr = null;\n+        try {\n+            gr = ((JackrabbitSession) superuser).getUserManager().createGroup(getClass().getName());\n+            superuser.save();\n+            PrincipalIterator it = principalMgr.getPrincipals(PrincipalManager.SEARCH_TYPE_ALL);\n+            while (it.hasNext()) {\n+                Principal p = it.nextPrincipal();\n+                if (p.equals(principalMgr.getEveryone())) {\n+                    continue;\n+                }\n+                if (isGroup(p)) {\n+                    Enumeration<? extends Principal> en = ((java.security.acl.Group) p).members();\n+                    while (en.hasMoreElements()) {\n+                        Principal memb = en.nextElement();\n+                        assertTrue(principalMgr.hasPrincipal(memb.getName()));\n+                    }\n+                }\n+            }\n+        } finally {\n+            if (gr != null) {\n+                gr.remove();\n+                superuser.save();\n+            }\n+        }\n+    }\n+\n     @Test\n     public void testGroupMembership() {\n         testMembership(PrincipalManager.SEARCH_TYPE_NOT_GROUP);",
                "deletions": 1
            }
        ],
        "patched_files": [
            "GroupImpl.java",
            "IdentifierManager.java",
            "MembershipProvider.java"
        ],
        "unit_tests": [
            "MembershipProviderTest.java",
            "IdentifierManagerTest.java",
            "PrincipalManagerTest.java"
        ]
    },
    "jackrabbit-oak_82819bc": {
        "repo": "jackrabbit-oak",
        "message": "OAK-5636: potential NPE in ReplicaSetInfo\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1782962 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/82819bc6c0aa9992777d4b233db641c174804233",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/302228a44592c10b690f957107fe257566f951a0",
        "bug_id": "jackrabbit-oak_82819bc",
        "file": [
            {
                "sha": "a3477464a2ad1fc6d41460bc7161bbec2b8c32f9",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/82819bc6c0aa9992777d4b233db641c174804233/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/82819bc6c0aa9992777d4b233db641c174804233/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java",
                "status": "modified",
                "changes": 6,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/replica/ReplicaSetInfo.java?ref=82819bc6c0aa9992777d4b233db641c174804233",
                "patch": "@@ -250,18 +250,22 @@ private void updateRevisions(Iterable<BasicBSONObject> members) {\n             }\n         }\n \n+        Set<String> hostsToCheck = new HashSet<String>();\n         if (secondaries.isEmpty()) {\n             LOG.debug(\"No secondaries found: {}\", members);\n             unknownState = true;\n+        } else {\n+            hostsToCheck.addAll(secondaries);\n         }\n \n         if (primary == null) {\n             LOG.debug(\"No primary found: {}\", members);\n             unknownState = true;\n+        } else {\n+            hostsToCheck.add(primary);\n         }\n \n         Map<String, Timestamped<RevisionVector>> vectors = null;\n-        Set<String> hostsToCheck = union(secondaries, of(primary));\n         if (!unknownState) {\n             vectors = getRootRevisions(hostsToCheck);\n             if (vectors.containsValue(null)) {",
                "deletions": 1
            }
        ],
        "patched_files": [
            "ReplicaSetInfo.java"
        ],
        "unit_tests": [
            "ReplicaSetInfoTest.java"
        ]
    },
    "jackrabbit-oak_a762bbc": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2420: DocumentNodeStore revision GC may lead to NPE\n\nTest to reproduce the problem\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1667590 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/a762bbcda5dd6c3c7d36b3f1df992d30b6eafd18",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/e195c84619389d8dcaaee2f28c9e7359844ca344",
        "bug_id": "jackrabbit-oak_a762bbc",
        "file": [
            {
                "sha": "2e493f2369de00e37bc8d98d207353a3a1211ac2",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a762bbcda5dd6c3c7d36b3f1df992d30b6eafd18/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a762bbcda5dd6c3c7d36b3f1df992d30b6eafd18/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java",
                "status": "modified",
                "changes": 95,
                "additions": 94,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/VersionGCDeletionTest.java?ref=a762bbcda5dd6c3c7d36b3f1df992d30b6eafd18",
                "patch": "@@ -22,20 +22,31 @@\n import java.util.Collections;\n import java.util.Comparator;\n import java.util.List;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.Semaphore;\n import java.util.concurrent.TimeUnit;\n \n import javax.annotation.Nonnull;\n \n+import org.apache.jackrabbit.oak.api.CommitFailedException;\n+import org.apache.jackrabbit.oak.plugins.document.VersionGarbageCollector.VersionGCStats;\n import org.apache.jackrabbit.oak.plugins.document.memory.MemoryDocumentStore;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n+import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.apache.jackrabbit.oak.stats.Clock;\n import org.junit.After;\n import org.junit.Before;\n+import org.junit.Ignore;\n import org.junit.Test;\n \n+import static java.util.concurrent.Executors.newSingleThreadExecutor;\n import static java.util.concurrent.TimeUnit.HOURS;\n+import static java.util.concurrent.TimeUnit.MINUTES;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNull;\n import static org.junit.Assert.fail;\n@@ -140,7 +151,7 @@ public void deleteLargeNumber() throws Exception{\n         VersionGarbageCollector gc = store.getVersionGarbageCollector();\n         gc.setOverflowToDiskThreshold(100);\n \n-        VersionGarbageCollector.VersionGCStats stats = gc.gc(maxAge * 2, HOURS);\n+        VersionGCStats stats = gc.gc(maxAge * 2, HOURS);\n         assertEquals(noOfDocsToDelete * 2 + 1, stats.deletedDocGCCount);\n \n \n@@ -152,6 +163,88 @@ public void deleteLargeNumber() throws Exception{\n         }\n     }\n \n+    // OAK-2420\n+    @Ignore\n+    @Test\n+    public void queryWhileDocsAreRemoved() throws Exception {\n+        //Baseline the clock\n+        clock.waitUntil(Revision.getCurrentTimestamp());\n+\n+        final Thread currentThread = Thread.currentThread();\n+        final Semaphore queries = new Semaphore(0);\n+        final CountDownLatch ready = new CountDownLatch(1);\n+        MemoryDocumentStore ms = new MemoryDocumentStore() {\n+            @Override\n+            public <T extends Document> T find(Collection<T> collection,\n+                                               String key) {\n+                if (Thread.currentThread() != currentThread) {\n+                    ready.countDown();\n+                    queries.acquireUninterruptibly();\n+                }\n+                return super.find(collection, key);\n+            }\n+        };\n+        store = new DocumentMK.Builder().clock(clock)\n+                .setDocumentStore(ms).setAsyncDelay(0).getNodeStore();\n+\n+        // create nodes\n+        NodeBuilder builder = store.getRoot().builder();\n+        NodeBuilder node = builder.child(\"node\");\n+        for (int i = 0; i < 100; i++) {\n+            node.child(\"c-\" + i);\n+        }\n+        merge(store, builder);\n+\n+        clock.waitUntil(clock.getTime() + HOURS.toMillis(1));\n+\n+        // remove nodes\n+        builder = store.getRoot().builder();\n+        node = builder.child(\"node\");\n+        for (int i = 0; i < 90; i++) {\n+            node.getChildNode(\"c-\" + i).remove();\n+        }\n+        merge(store, builder);\n+\n+        store.runBackgroundOperations();\n+\n+        clock.waitUntil(clock.getTime() + HOURS.toMillis(1));\n+\n+        // fill caches\n+        NodeState n = store.getRoot().getChildNode(\"node\");\n+        for (ChildNodeEntry entry : n.getChildNodeEntries()) {\n+            entry.getName();\n+        }\n+\n+        // invalidate the nodeChildren cache only\n+        store.invalidateNodeChildrenCache();\n+\n+        Future f = newSingleThreadExecutor().submit(new Callable<Object>() {\n+            @Override\n+            public Object call() throws Exception {\n+                NodeState n = store.getRoot().getChildNode(\"node\");\n+                for (ChildNodeEntry entry : n.getChildNodeEntries()) {\n+                    entry.getName();\n+                }\n+                return null;\n+            }\n+        });\n+\n+        // run GC once the reader thread is collecting documents\n+        ready.await();\n+        VersionGarbageCollector gc = store.getVersionGarbageCollector();\n+        VersionGCStats stats = gc.gc(30, MINUTES);\n+        assertEquals(90, stats.deletedDocGCCount);\n+\n+        queries.release(100);\n+\n+        f.get();\n+    }\n+\n+    private void merge(DocumentNodeStore store, NodeBuilder builder)\n+            throws CommitFailedException {\n+        store.merge(builder, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n+    }\n+\n     private static class TestDocumentStore extends MemoryDocumentStore {\n         boolean throwException;\n         @Override",
                "deletions": 1
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "VersionGCDeletionTest.java"
        ]
    },
    "jackrabbit-oak_4779cb2": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8338: RDBDocumentStoreJDBC: fix theoretically possible NPE in perflogging code\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1859716 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/4779cb2531e02230636c81630b93e07dc60ea38c",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/2b2f3043e08b92d00f6abcfcad97437a1b76c3d6",
        "bug_id": "jackrabbit-oak_4779cb2",
        "file": [
            {
                "sha": "7fa2be4f34aab525e515e1ec51f183401fd5e83f",
                "filename": "oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/4779cb2531e02230636c81630b93e07dc60ea38c/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/4779cb2531e02230636c81630b93e07dc60ea38c/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-document/src/main/java/org/apache/jackrabbit/oak/plugins/document/rdb/RDBDocumentStoreJDBC.java?ref=4779cb2531e02230636c81630b93e07dc60ea38c",
                "patch": "@@ -478,7 +478,7 @@ public long determineServerTimeDifferenceMillis(Connection connection) {\n                 byte[] bdata = rs.getBytes(field++);\n                 result.add(new RDBRow(id, hasBinary, deletedOnce, modified, modcount, cmodcount, schemaVersion, sdType,\n                         sdMaxRevTime, data, bdata));\n-                dataTotal += data.length();\n+                dataTotal += data == null ? 0 : data.length();\n                 bdataTotal += bdata == null ? 0 : bdata.length;\n                 PERFLOG.end(pstart, 10, \"queried: table={} -> id={}, modcount={}, modified={}, data={}, bdata={}\", tmd.getName(), id,\n                         modcount, modified, (data == null ? 0 : data.length()), (bdata == null ? 0 : bdata.length));",
                "deletions": 1
            }
        ],
        "patched_files": [
            "RDBDocumentStoreJDBC.java"
        ],
        "unit_tests": [
            "RDBDocumentStoreJDBCTest.java"
        ]
    },
    "jackrabbit-oak_b7f274a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7078: NullPointerException in FilteredSortedSetDocValuesFacetCounts during query evaluation\n\nApplied fix from Dirk Rudolph ([~diru]) and a bit of modified test from\nhis patch in r1819048. Thanks Dirk for the contribution.\nRemoving an unused import here.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1819050 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/b7f274a595df895ad3330bc9c611cc705249eb3f",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/e094b0d2c7a340a201a522a6d082f71315594ef4",
        "bug_id": "jackrabbit-oak_b7f274a",
        "file": [
            {
                "sha": "ad21406c82545a1aa9a7b092963df1fa970041b5",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b7f274a595df895ad3330bc9c611cc705249eb3f/oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b7f274a595df895ad3330bc9c611cc705249eb3f/oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java?ref=b7f274a595df895ad3330bc9c611cc705249eb3f",
                "patch": "@@ -26,7 +26,6 @@\n import javax.jcr.query.QueryManager;\n import javax.jcr.query.QueryResult;\n import javax.jcr.query.RowIterator;\n-import java.util.ArrayList;\n import java.util.List;\n \n import org.apache.jackrabbit.core.query.AbstractQueryTest;",
                "deletions": 1
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "FacetTest.java"
        ]
    },
    "jackrabbit-oak_ad17bb2": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2876: Test failure: RepositorySidegradeTest.verifyAsync (NPE)\nDisable test as it keeps failing the build\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1680195 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ad17bb2b08121821fdbd8fd0009d9cd502eda0ab",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/7edbb5d5b2e0af3e7e17001bfe7cb8b073417c8e",
        "bug_id": "jackrabbit-oak_ad17bb2",
        "file": [
            {
                "sha": "a0318e3a18f5f84fe19c267c046f5a94629333f1",
                "filename": "oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad17bb2b08121821fdbd8fd0009d9cd502eda0ab/oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad17bb2b08121821fdbd8fd0009d9cd502eda0ab/oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java",
                "status": "modified",
                "changes": 27,
                "additions": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java?ref=ad17bb2b08121821fdbd8fd0009d9cd502eda0ab",
                "patch": "@@ -18,11 +18,23 @@\n  */\n package org.apache.jackrabbit.oak.upgrade;\n \n+import static junit.framework.Assert.assertEquals;\n+import static junit.framework.Assert.assertFalse;\n+import static junit.framework.Assert.assertNotNull;\n+import static junit.framework.Assert.assertTrue;\n+import static org.apache.jackrabbit.JcrConstants.JCR_FROZENMIXINTYPES;\n+import static org.apache.jackrabbit.JcrConstants.JCR_FROZENPRIMARYTYPE;\n+import static org.apache.jackrabbit.JcrConstants.JCR_FROZENUUID;\n+import static org.apache.jackrabbit.JcrConstants.JCR_UUID;\n+import static org.apache.jackrabbit.JcrConstants.MIX_VERSIONABLE;\n+import static org.apache.jackrabbit.JcrConstants.NT_UNSTRUCTURED;\n+\n import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.math.BigDecimal;\n import java.util.Calendar;\n import java.util.Random;\n+\n import javax.jcr.Binary;\n import javax.jcr.Credentials;\n import javax.jcr.NamespaceRegistry;\n@@ -58,19 +70,9 @@\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n import org.junit.Before;\n import org.junit.BeforeClass;\n+import org.junit.Ignore;\n import org.junit.Test;\n \n-import static junit.framework.Assert.assertEquals;\n-import static junit.framework.Assert.assertFalse;\n-import static junit.framework.Assert.assertNotNull;\n-import static junit.framework.Assert.assertTrue;\n-import static org.apache.jackrabbit.JcrConstants.JCR_FROZENMIXINTYPES;\n-import static org.apache.jackrabbit.JcrConstants.JCR_FROZENPRIMARYTYPE;\n-import static org.apache.jackrabbit.JcrConstants.JCR_FROZENUUID;\n-import static org.apache.jackrabbit.JcrConstants.JCR_UUID;\n-import static org.apache.jackrabbit.JcrConstants.MIX_VERSIONABLE;\n-import static org.apache.jackrabbit.JcrConstants.NT_UNSTRUCTURED;\n-\n public class RepositorySidegradeTest {\n \n     private static final Calendar DATE = Calendar.getInstance();\n@@ -120,7 +122,8 @@ private static void setAsync(NodeStore source) throws Exception {\n     }\n     \n     // OAK-2869\n-    @Test    \n+    @Test\n+    @Ignore(\"OAK-2876\")  // FIXME See OAK-2876\n     public void verifyAsync() throws Exception {\n         NodeState state = targetNodeStore.getRoot().getChildNode(\":async\");\n         assertFalse(state.hasProperty(\"test\"));",
                "deletions": 12
            }
        ],
        "patched_files": [
            "RepositorySidegrade.java"
        ],
        "unit_tests": [
            "RepositorySidegradeTest.java"
        ]
    },
    "jackrabbit-oak_3668247": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2956 : NPE in UserImporter when importing group with modified authorizable id\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1689869 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/36682476226d2f7e2318e6b3f794cc1f2dee491e",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/4a71b875c0a392468b8c4a36ed6499937262badb",
        "bug_id": "jackrabbit-oak_3668247",
        "file": [
            {
                "sha": "aa4b989f04d37f225c9ec9c7322a9015177a5471",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/UserImporter.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/36682476226d2f7e2318e6b3f794cc1f2dee491e/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/UserImporter.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/36682476226d2f7e2318e6b3f794cc1f2dee491e/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/UserImporter.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/user/UserImporter.java?ref=36682476226d2f7e2318e6b3f794cc1f2dee491e",
                "patch": "@@ -240,6 +240,12 @@ public boolean handlePropInfo(@Nonnull Tree parent, @Nonnull PropInfo propInfo,\n                 }\n                 String id = propInfo.getTextValue().getString();\n                 Authorizable existing = userManager.getAuthorizable(id);\n+                if (existing == null) {\n+                    String msg = \"Cannot handle protected PropInfo \" + propInfo + \". Invalid rep:authorizableId.\";\n+                    log.warn(msg);\n+                    throw new ConstraintViolationException(msg);\n+                }\n+\n                 if (a.getPath().equals(existing.getPath())) {\n                     parent.setProperty(REP_AUTHORIZABLE_ID, id);\n                 } else {",
                "deletions": 0
            },
            {
                "sha": "175a7148ae1a7baf5ffe657ad66385635bd588b6",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/user/UserImportTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/36682476226d2f7e2318e6b3f794cc1f2dee491e/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/user/UserImportTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/36682476226d2f7e2318e6b3f794cc1f2dee491e/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/user/UserImportTest.java",
                "status": "modified",
                "changes": 32,
                "additions": 32,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/security/user/UserImportTest.java?ref=36682476226d2f7e2318e6b3f794cc1f2dee491e",
                "patch": "@@ -419,6 +419,38 @@ public void testImportUuidCollisionRemoveExisting() throws Exception {\n         getImportSession().save();\n     }\n \n+    @Test\n+    public void testImportUuidCollisionRemoveExistingWithInvalidUUID() throws Exception {\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\" +\n+                \"<sv:node sv:name=\\\"r\\\" xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\" xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\" xmlns:fn_old=\\\"http://www.w3.org/2004/10/xpath-functions\\\" xmlns:fn=\\\"http://www.w3.org/2005/xpath-functions\\\" xmlns:xs=\\\"http://www.w3.org/2001/XMLSchema\\\" xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\" xmlns:rep=\\\"internal\\\" xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\">\" +\n+                \"   <sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\"><sv:value>rep:User</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"jcr:uuid\\\" sv:type=\\\"String\\\"><sv:value>4b43b0ae-e356-34cd-95b9-10189b3dc231</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"rep:password\\\" sv:type=\\\"String\\\"><sv:value>{sha1}8efd86fb78a56a5145ed7739dcb00c78581c5375</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"rep:authorizableId\\\" sv:type=\\\"String\\\"><sv:value>r</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"rep:principalName\\\" sv:type=\\\"String\\\"><sv:value>t</sv:value></sv:property>\" +\n+                \"</sv:node>\";\n+\n+        doImport(getTargetPath(), xml);\n+\n+        xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\" +\n+                \"<sv:node sv:name=\\\"r\\\" xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\" xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\" xmlns:fn_old=\\\"http://www.w3.org/2004/10/xpath-functions\\\" xmlns:fn=\\\"http://www.w3.org/2005/xpath-functions\\\" xmlns:xs=\\\"http://www.w3.org/2001/XMLSchema\\\" xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\" xmlns:rep=\\\"internal\\\" xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\">\" +\n+                \"   <sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\"><sv:value>rep:User</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"jcr:uuid\\\" sv:type=\\\"String\\\"><sv:value>4b43b0ae-e356-34cd-95b9-10189b3dc231</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"rep:password\\\" sv:type=\\\"String\\\"><sv:value>{sha1}8efd86fb78a56a5145ed7739dcb00c78581c5375</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"rep:authorizableId\\\" sv:type=\\\"String\\\"><sv:value>ANOTHER_ID</sv:value></sv:property>\" +\n+                \"   <sv:property sv:name=\\\"rep:principalName\\\" sv:type=\\\"String\\\"><sv:value>t</sv:value></sv:property>\" +\n+                \"</sv:node>\";\n+\n+        try {\n+            doImport(getTargetPath(), xml, ImportUUIDBehavior.IMPORT_UUID_COLLISION_REMOVE_EXISTING);\n+            fail(\"Xml with illegal authorizable id must fail.\");\n+        } catch (ConstraintViolationException e) {\n+            // success\n+        } finally {\n+            getImportSession().refresh(false);\n+        }\n+    }\n+\n     /**\n      * Same as {@link #testImportUuidCollisionRemoveExisting} with the single\n      * difference that the initial import is saved before being overwritten.",
                "deletions": 0
            }
        ],
        "patched_files": [
            "UserImporter.java"
        ],
        "unit_tests": [
            "UserImportTest.java"
        ]
    },
    "jackrabbit-oak_7a2efa1": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4998: NPE when starting Oak Console\nReenable ignored test\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1784525 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/7a2efa1187b06a042442cda24b1ae3c9d8950c2b",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/5839fcf03d6f5660663d67b61a1e1096d8453743",
        "bug_id": "jackrabbit-oak_7a2efa1",
        "file": [
            {
                "sha": "1291ed96960c4118bd599b7fed7245142322b6a7",
                "filename": "oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/7a2efa1187b06a042442cda24b1ae3c9d8950c2b/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/7a2efa1187b06a042442cda24b1ae3c9d8950c2b/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/test/java/org/apache/jackrabbit/oak/console/SegmentTarFixtureTest.java?ref=7a2efa1187b06a042442cda24b1ae3c9d8950c2b",
                "patch": "@@ -28,7 +28,6 @@\n import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n-import org.junit.Ignore;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n@@ -48,7 +47,6 @@ public void testReadWrite() throws IOException, CommitFailedException {\n     }\n \n     @Test(expected = UnsupportedOperationException.class)\n-    @Ignore(\"OAK-4998\")  // FIXME OAK-4998\n     public void testReadOnly()\n     throws IOException, CommitFailedException, InvalidFileStoreVersionException {\n         File directory = folder.getRoot();",
                "deletions": 2
            }
        ],
        "patched_files": [
            "SegmentTarFixture.java"
        ],
        "unit_tests": [
            "SegmentTarFixtureTest.java"
        ]
    },
    "jackrabbit-oak_5ec570c": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8117 : NPE when adding ACE with restrictions and remapped namespaces\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1855402 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5ec570cfbd4cd8ee377c8877558cf91bbe74cf15",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/47952742585e8d91d95f424e7ae3074f057f3dfe",
        "bug_id": "jackrabbit-oak_5ec570c",
        "file": [
            {
                "sha": "060fd71e080f825e9b12f9b8f29671dbcfaff159",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/ACL.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5ec570cfbd4cd8ee377c8877558cf91bbe74cf15/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/ACL.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5ec570cfbd4cd8ee377c8877558cf91bbe74cf15/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/ACL.java",
                "status": "modified",
                "changes": 12,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/ACL.java?ref=5ec570cfbd4cd8ee377c8877558cf91bbe74cf15",
                "patch": "@@ -120,15 +120,15 @@ public boolean addEntry(Principal principal, Privilege[] privileges,\n         } else {\n             rs = new HashSet<>();\n             if (restrictions != null) {\n-                for (String jcrName : restrictions.keySet()) {\n-                    String oakName = getNamePathMapper().getOakName(jcrName);\n-                    rs.add(getRestrictionProvider().createRestriction(getOakPath(), oakName, restrictions.get(oakName)));\n+                for (Map.Entry<String, Value> restrEntry : restrictions.entrySet()) {\n+                    String oakName = getNamePathMapper().getOakName(restrEntry.getKey());\n+                    rs.add(getRestrictionProvider().createRestriction(getOakPath(), oakName, restrEntry.getValue()));\n                 }\n             }\n             if (mvRestrictions != null) {\n-                for (String jcrName : mvRestrictions.keySet()) {\n-                    String oakName = getNamePathMapper().getOakName(jcrName);\n-                    rs.add(getRestrictionProvider().createRestriction(getOakPath(), oakName, mvRestrictions.get(oakName)));\n+                for (Map.Entry<String, Value[]> restrEntry : mvRestrictions.entrySet()) {\n+                    String oakName = getNamePathMapper().getOakName(restrEntry.getKey());\n+                    rs.add(getRestrictionProvider().createRestriction(getOakPath(), oakName, restrEntry.getValue()));\n                 }\n             }\n         }",
                "deletions": 6
            },
            {
                "sha": "68e505e81dba672945be11befbb09beb096afa54",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/RemappedRestrictionNamesTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5ec570cfbd4cd8ee377c8877558cf91bbe74cf15/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/RemappedRestrictionNamesTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5ec570cfbd4cd8ee377c8877558cf91bbe74cf15/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/RemappedRestrictionNamesTest.java",
                "status": "added",
                "changes": 99,
                "additions": 99,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/RemappedRestrictionNamesTest.java?ref=5ec570cfbd4cd8ee377c8877558cf91bbe74cf15",
                "patch": "@@ -0,0 +1,99 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.security.authorization.accesscontrol;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Iterables;\n+import org.apache.jackrabbit.oak.namepath.NamePathMapper;\n+import org.apache.jackrabbit.oak.namepath.impl.LocalNameMapper;\n+import org.apache.jackrabbit.oak.namepath.impl.NamePathMapperImpl;\n+import org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.ACE;\n+import org.apache.jackrabbit.oak.spi.security.privilege.PrivilegeConstants;\n+import org.jetbrains.annotations.NotNull;\n+import org.junit.Test;\n+\n+import javax.jcr.PropertyType;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Value;\n+import javax.jcr.security.Privilege;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AccessControlConstants.REP_GLOB;\n+import static org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AccessControlConstants.REP_ITEM_NAMES;\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+public class RemappedRestrictionNamesTest extends AbstractAccessControlTest {\n+\n+    private static final Map<String, String> LOCAL_NAME_MAPPINGS = ImmutableMap.of(\n+            \"a\",\"internal\",\n+            \"b\",\"http://www.jcp.org/jcr/1.0\",\n+            \"c\",\"http://jackrabbit.apache.org/oak/ns/1.0\"\n+    );\n+\n+    private NamePathMapperImpl remapped;\n+\n+    private Privilege[] privs;\n+\n+    @Override\n+    public void before() throws Exception {\n+        super.before();\n+\n+        privs = privilegesFromNames(PrivilegeConstants.JCR_READ);\n+    }\n+\n+    @Override\n+    protected NamePathMapper getNamePathMapper() {\n+        if (remapped == null) {\n+            remapped = new NamePathMapperImpl(new LocalNameMapper(root, LOCAL_NAME_MAPPINGS));\n+        }\n+        return remapped;\n+    }\n+\n+    protected Privilege[] privilegesFromNames(@NotNull String... privilegeNames) throws RepositoryException {\n+        Iterable<String> jcrNames = Iterables.transform(Arrays.asList(privilegeNames), s -> getNamePathMapper().getJcrName(s));\n+        return super.privilegesFromNames(jcrNames);\n+    }\n+\n+    @Test\n+    public void testAddEntryWithSingleValueRestriction() throws Exception {\n+        String jcrGlobName = getNamePathMapper().getJcrName(REP_GLOB);\n+        Map<String, Value> rest = ImmutableMap.of(jcrGlobName, getValueFactory(root).createValue(\"*\"));\n+        assertTrue(acl.addEntry(testPrincipal, privs, false, rest));\n+\n+        List<ACE> entries = acl.getEntries();\n+        assertEquals(1, entries.size());\n+        assertArrayEquals(new String[] {jcrGlobName}, entries.get(0).getRestrictionNames());\n+        assertEquals(rest.get(jcrGlobName), entries.get(0).getRestriction(jcrGlobName));\n+    }\n+\n+    @Test\n+    public void testAddEntryWithMVRestriction() throws Exception {\n+        String jcrItemNames = getNamePathMapper().getJcrName(REP_ITEM_NAMES);\n+        Value[] valArray = new Value[] {getValueFactory(root).createValue(\"myItemName\", PropertyType.NAME)};\n+        Map<String, Value[]> rest = ImmutableMap.of(jcrItemNames, valArray);\n+        assertTrue(acl.addEntry(testPrincipal, privs, false, null, rest));\n+\n+        List<ACE> entries = acl.getEntries();\n+        assertEquals(1, entries.size());\n+        assertArrayEquals(new String[] {jcrItemNames}, entries.get(0).getRestrictionNames());\n+        assertArrayEquals(valArray, entries.get(0).getRestrictions(jcrItemNames));\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ACL.java"
        ],
        "unit_tests": [
            "TestACL.java",
            "ACLTest.java",
            "RemappedRestrictionNamesTest.java"
        ]
    },
    "jackrabbit-oak_2a7cd0f": {
        "repo": "jackrabbit-oak",
        "message": "minor improvement (prevent NPE in AbstractNameMapper)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1346879 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/b32db799cca7d8499622fcb52c45b0594cd06790",
        "bug_id": "jackrabbit-oak_2a7cd0f",
        "file": [
            {
                "sha": "e92fb3dbc1ea88e39266ad076f418b599ca392e5",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/namepath/AbstractNameMapper.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7/oak-core/src/main/java/org/apache/jackrabbit/oak/namepath/AbstractNameMapper.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7/oak-core/src/main/java/org/apache/jackrabbit/oak/namepath/AbstractNameMapper.java",
                "status": "modified",
                "changes": 10,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/namepath/AbstractNameMapper.java?ref=2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7",
                "patch": "@@ -26,9 +26,10 @@\n \n     @Override\n     public String getOakName(String jcrName) {\n-\n+        if (jcrName == null || jcrName.isEmpty()) {\n+            return jcrName;\n+        }\n         int pos = jcrName.indexOf(':');\n-        \n         if (pos < 0) {\n             // no colon\n             return jcrName.startsWith(\"{}\") ? jcrName.substring(2) : jcrName;\n@@ -66,6 +67,10 @@ public String getOakName(String jcrName) {\n \n     @Override\n     public String getJcrName(String oakName) {\n+        if (oakName == null || oakName.isEmpty()) {\n+            return oakName;\n+        }\n+\n         int pos = oakName.indexOf(':');\n         if (pos < 0) {\n             // non-prefixed\n@@ -88,5 +93,4 @@ public String getJcrName(String oakName) {\n             }\n         }\n     }\n-\n }",
                "deletions": 3
            },
            {
                "sha": "a3b3454e6f9b354a503f2bb4f4e47564d2bca239",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/namepath/NamePathMapperImplTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7/oak-core/src/test/java/org/apache/jackrabbit/oak/namepath/NamePathMapperImplTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7/oak-core/src/test/java/org/apache/jackrabbit/oak/namepath/NamePathMapperImplTest.java",
                "status": "modified",
                "changes": 26,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/namepath/NamePathMapperImplTest.java?ref=2a7cd0fd0b1d2fb3b76c90792b2e5ffa802bbab7",
                "patch": "@@ -29,12 +29,11 @@\n import static org.junit.Assert.fail;\n \n public class NamePathMapperImplTest {\n+    private TestNameMapper mapper = new TestNameMapper(true);\n+    private NamePathMapper npMapper = new NamePathMapperImpl(mapper);\n \n     @Test\n     public void testInvalidIdentifierPath() {\n-        TestNameMapper mapper = new TestNameMapper(true);\n-        NamePathMapper npMapper = new NamePathMapperImpl(mapper);\n-\n         List<String> invalid = new ArrayList<String>();\n         invalid.add('[' + UUID.randomUUID().toString() + \"]abc\");\n         invalid.add('[' + UUID.randomUUID().toString() + \"]/a/b/c\");\n@@ -45,10 +44,19 @@ public void testInvalidIdentifierPath() {\n     }\n \n     @Test\n-    public void testJcrToOak() {\n-        TestNameMapper mapper = new TestNameMapper(true);\n-        NamePathMapper npMapper = new NamePathMapperImpl(mapper);\n+    public void testNullName() {\n+        assertNull(npMapper.getJcrName(null));\n+        assertNull(npMapper.getOakName(null));\n+    }\n+\n+    @Test\n+    public void testEmptyName() {\n+        assertEquals(\"\", npMapper.getJcrName(\"\"));\n+        assertEquals(\"\", npMapper.getOakName(\"\"));\n+    }\n \n+    @Test\n+    public void testJcrToOak() {\n         assertEquals(\"/\", npMapper.getOakPath(\"/\"));\n         assertEquals(\"foo\", npMapper.getOakPath(\"{}foo\"));\n         assertEquals(\"/oak-foo:bar\", npMapper.getOakPath(\"/foo:bar\"));\n@@ -73,9 +81,6 @@ public void testJcrToOak() {\n \n     @Test\n     public void testJcrToOakKeepIndex() {\n-        TestNameMapper mapper = new TestNameMapper(true);\n-        NamePathMapper npMapper = new NamePathMapperImpl(mapper);\n-\n         assertEquals(\"/\", npMapper.getOakPathKeepIndex(\"/\"));\n         assertEquals(\"foo\", npMapper.getOakPathKeepIndex(\"{}foo\"));\n         assertEquals(\"/oak-foo:bar\", npMapper.getOakPathKeepIndex(\"/foo:bar\"));\n@@ -111,9 +116,6 @@ public void testJcrToOakKeepIndexNoRemap() {\n \n     @Test\n     public void testOakToJcr() {\n-        TestNameMapper mapper = new TestNameMapper(true);\n-        NamePathMapper npMapper = new NamePathMapperImpl(mapper);\n-\n         assertEquals(\"/jcr-foo:bar\", npMapper.getJcrPath(\"/foo:bar\"));\n         assertEquals(\"/jcr-foo:bar/jcr-quu:qux\", npMapper.getJcrPath(\"/foo:bar/quu:qux\"));\n         assertEquals(\"jcr-foo:bar\", npMapper.getJcrPath(\"foo:bar\"));",
                "deletions": 12
            }
        ],
        "patched_files": [
            "NamePathMapperImpl.java",
            "AbstractNameMapper.java"
        ],
        "unit_tests": [
            "NamePathMapperImplTest.java"
        ]
    },
    "jackrabbit-oak_f878b38": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8218: ReadOnlyNodeTypeManager.isNodeType prone to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1857304 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/f878b3867093dbcc53760f2acadfa12dbf31801f",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/11903eb48da994d1477df04eb4aa7e86750005bb",
        "bug_id": "jackrabbit-oak_f878b38",
        "file": [
            {
                "sha": "5f80affba976045796a82fda4315856d40d699d0",
                "filename": "oak-authorization-cug/src/main/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugConfiguration.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-authorization-cug/src/main/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugConfiguration.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-authorization-cug/src/main/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugConfiguration.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-authorization-cug/src/main/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugConfiguration.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -233,6 +233,7 @@ private CugExclude getExclude() {\n     static boolean registerCugNodeTypes(@NotNull final Root root) {\n         try {\n             ReadOnlyNodeTypeManager ntMgr = new ReadOnlyNodeTypeManager() {\n+                @NotNull\n                 @Override\n                 protected Tree getTypes() {\n                     return root.getTree(NodeTypeConstants.NODE_TYPES_PATH);",
                "deletions": 0
            },
            {
                "sha": "a35c1bbc58d3d6dc84b17c508cb3601c64f0ecfd",
                "filename": "oak-authorization-cug/src/test/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugValidatorTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-authorization-cug/src/test/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugValidatorTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-authorization-cug/src/test/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugValidatorTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-authorization-cug/src/test/java/org/apache/jackrabbit/oak/spi/security/authorization/cug/impl/CugValidatorTest.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -153,7 +153,7 @@ protected Root getWriteRoot() {\n                 return root;\n             }\n \n-            @Nullable\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return root.getTree(NODE_TYPES_PATH);",
                "deletions": 1
            },
            {
                "sha": "c019c5f34445cb2ad64f75e1251d7c5e5106c575",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/NodeTypeImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/NodeTypeImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/NodeTypeImpl.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/NodeTypeImpl.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -485,7 +485,8 @@ private boolean internalCanRemoveItem(String itemName,\n     private ReadOnlyNodeTypeManager getManager() {\n         final Tree types = definition.getParent();\n         return new ReadOnlyNodeTypeManager() {\n-            @Override @Nullable\n+            @NotNull\n+            @Override\n             protected Tree getTypes() {\n                 return types;\n             }",
                "deletions": 1
            },
            {
                "sha": "3fdd4802c26b6a8dce75c28a982b9ebcb140f337",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/ReadOnlyNodeTypeManager.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/ReadOnlyNodeTypeManager.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/ReadOnlyNodeTypeManager.java",
                "status": "modified",
                "changes": 29,
                "additions": 14,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/ReadOnlyNodeTypeManager.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -82,10 +82,13 @@ protected final String getOakName(String jcrName) throws RepositoryException {\n     }\n \n     /**\n-     * @return  {@link org.apache.jackrabbit.oak.api.Tree} instance where the node types\n-     * are stored or {@code null} if none.\n+     * Returns the {@link Tree} instance where the node types are stored. This\n+     * method never returns {@code null} and may return a {@code Tree} that\n+     * does not exist (see {@link Tree#exists()} when there are no types stored.\n+     *\n+     * @return {@link Tree} instance where the node types are stored.\n      */\n-    @Nullable\n+    @NotNull\n     protected abstract Tree getTypes();\n \n     /**\n@@ -125,6 +128,7 @@ protected NamePathMapper getNamePathMapper() {\n     public static ReadOnlyNodeTypeManager getInstance(final Root root,\n                                                       final NamePathMapper namePathMapper) {\n         return new ReadOnlyNodeTypeManager() {\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return root.getTree(NODE_TYPES_PATH);\n@@ -142,8 +146,7 @@ protected NamePathMapper getNamePathMapper() {\n \n     @Override\n     public boolean hasNodeType(String name) throws RepositoryException {\n-        Tree types = getTypes();\n-        return types != null && types.hasChild(getOakName(name));\n+        return getTypes().hasChild(getOakName(name));\n     }\n \n     @Override\n@@ -155,11 +158,9 @@ public NodeType getNodeType(String name) throws RepositoryException {\n     public NodeTypeIterator getAllNodeTypes() throws RepositoryException {\n         List<NodeType> list = Lists.newArrayList();\n         Tree types = getTypes();\n-        if (types != null) {\n-            NamePathMapper mapper = getNamePathMapper();\n-            for (Tree type : types.getChildren()) {\n-                list.add(new NodeTypeImpl(type, mapper));\n-            }\n+        NamePathMapper mapper = getNamePathMapper();\n+        for (Tree type : types.getChildren()) {\n+            list.add(new NodeTypeImpl(type, mapper));\n         }\n         return new NodeTypeIteratorAdapter(list);\n     }\n@@ -411,11 +412,9 @@ public PropertyDefinition getDefinition(@NotNull Tree parent, @NotNull PropertyS\n     @NotNull\n     NodeTypeImpl internalGetNodeType(@NotNull String oakName) throws NoSuchNodeTypeException {\n         Tree types = getTypes();\n-        if (types != null) {\n-            Tree type = types.getChild(oakName);\n-            if (type.exists()) {\n-                return new NodeTypeImpl(type, getNamePathMapper());\n-            }\n+        Tree type = types.getChild(oakName);\n+        if (type.exists()) {\n+            return new NodeTypeImpl(type, getNamePathMapper());\n         }\n         throw new NoSuchNodeTypeException(getNamePathMapper().getJcrName(oakName));\n     }",
                "deletions": 15
            },
            {
                "sha": "d7afc68120bdeb4813bc3f8136e4ee2c3083d918",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistry.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistry.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistry.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistry.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -51,6 +51,7 @@\n \n     private NodeTypeRegistry(final Root root) {\n         this.ntMgr =  new ReadWriteNodeTypeManager() {\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return root.getTree(NODE_TYPES_PATH);",
                "deletions": 0
            },
            {
                "sha": "fff81a9d937bdb4bb3c40a44083ed00bca45234e",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistryTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistryTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistryTest.java",
                "status": "modified",
                "changes": 3,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/nodetype/write/NodeTypeRegistryTest.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -182,12 +182,14 @@ public void registerNodeType() throws Exception {\n         registerNodeType(root, \"oak6440-1.cnd\");\n         NodeTypeManager readOnlyNtMgr = new ReadOnlyNodeTypeManager() {\n             private Root r = session.getLatestRoot();\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return r.getTree(NODE_TYPES_PATH);\n             }\n         };\n         NodeTypeManager ntMgr = new ReadWriteNodeTypeManager() {\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return root.getTree(NODE_TYPES_PATH);\n@@ -234,6 +236,7 @@ protected Root getWriteRoot() {\n     @Test\n     public void reRegisterNtResource() throws Exception {\n         NodeTypeManager ntMgr = new ReadWriteNodeTypeManager() {\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return root.getTree(NODE_TYPES_PATH);",
                "deletions": 0
            },
            {
                "sha": "830c07dd599ef4b0e157e966c03937d5422cd9b7",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/JcrUUIDTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/JcrUUIDTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/JcrUUIDTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/JcrUUIDTest.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -57,6 +57,7 @@ protected Root getWriteRoot() {\n                 return root;\n             }\n \n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return root.getTree(NODE_TYPES_PATH);",
                "deletions": 0
            },
            {
                "sha": "e6b70950a16238306fdb88183cab8c106062c248",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/WorkspaceImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/WorkspaceImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/WorkspaceImpl.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/session/WorkspaceImpl.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -81,6 +81,7 @@ protected void refresh() throws RepositoryException {\n                 getSession().refresh(true);\n             }\n \n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n                 return sessionDelegate.getRoot().getTree(NODE_TYPES_PATH);",
                "deletions": 0
            },
            {
                "sha": "01d0430a6ba7da8ef9a8997d35a83dc1b81cb0cd",
                "filename": "oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/IndexDefinition.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/IndexDefinition.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/IndexDefinition.java",
                "status": "modified",
                "changes": 10,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-search/src/main/java/org/apache/jackrabbit/oak/plugins/index/search/IndexDefinition.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -42,6 +42,7 @@\n import com.google.common.primitives.Ints;\n import org.apache.jackrabbit.JcrConstants;\n import org.apache.jackrabbit.oak.api.PropertyState;\n+import org.apache.jackrabbit.oak.api.Root;\n import org.apache.jackrabbit.oak.api.Tree;\n import org.apache.jackrabbit.oak.api.Type;\n import org.apache.jackrabbit.oak.commons.PathUtils;\n@@ -51,7 +52,7 @@\n import org.apache.jackrabbit.oak.plugins.index.search.util.FunctionIndexProcessor;\n import org.apache.jackrabbit.oak.plugins.memory.PropertyStates;\n import org.apache.jackrabbit.oak.plugins.nodetype.ReadOnlyNodeTypeManager;\n-import org.apache.jackrabbit.oak.plugins.tree.TreeUtil;\n+import org.apache.jackrabbit.oak.plugins.tree.factories.RootFactory;\n import org.apache.jackrabbit.oak.plugins.tree.factories.TreeFactory;\n import org.apache.jackrabbit.oak.spi.filter.PathFilter;\n import org.apache.jackrabbit.oak.spi.query.QueryIndex.OrderEntry;\n@@ -774,7 +775,7 @@ public IndexingRule getApplicableIndexingRule(NodeState state) {\n         }\n \n         Map<String, List<IndexingRule>> nt2rules = newHashMap();\n-        ReadOnlyNodeTypeManager ntReg = createNodeTypeManager(TreeFactory.createReadOnlyTree(root));\n+        ReadOnlyNodeTypeManager ntReg = createNodeTypeManager(RootFactory.createReadOnlyRoot(root));\n \n         //Use Tree API to read ordered child nodes\n         Tree ruleTree = TreeFactory.createReadOnlyTree(indexRules);\n@@ -1593,11 +1594,12 @@ private NodeState getTikaConfigNode() {\n         }\n     }\n \n-    private static ReadOnlyNodeTypeManager createNodeTypeManager(final Tree root) {\n+    private static ReadOnlyNodeTypeManager createNodeTypeManager(final Root root) {\n         return new ReadOnlyNodeTypeManager() {\n+            @NotNull\n             @Override\n             protected Tree getTypes() {\n-                return TreeUtil.getTree(root,NODE_TYPES_PATH);\n+                return root.getTree(NODE_TYPES_PATH);\n             }\n \n             @NotNull",
                "deletions": 4
            },
            {
                "sha": "34e2ca87f4b0c1f908b2e34fe167aaae9e609fe2",
                "filename": "oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f878b3867093dbcc53760f2acadfa12dbf31801f/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java?ref=f878b3867093dbcc53760f2acadfa12dbf31801f",
                "patch": "@@ -451,6 +451,7 @@ public void copy(RepositoryInitializer initializer) throws RepositoryException {\n             } else {\n                 logger.info(\"Copying registered node types\");\n                 NodeTypeManager ntMgr = new ReadWriteNodeTypeManager() {\n+                    @NotNull\n                     @Override\n                     protected Tree getTypes() {\n                         return upgradeRoot.getTree(NODE_TYPES_PATH);",
                "deletions": 0
            }
        ],
        "patched_files": [
            "NodeTypeRegistry.java",
            "RepositoryUpgrade.java",
            "WorkspaceImpl.java",
            "NodeTypeImpl.java",
            "ReadOnlyNodeTypeManager.java",
            "IndexDefinition.java",
            "CugConfiguration.java"
        ],
        "unit_tests": [
            "NodeTypeRegistryTest.java",
            "JcrUUIDTest.java",
            "CugConfigurationTest.java",
            "CugValidatorTest.java",
            "IndexDefinitionTest.java",
            "RepositoryUpgradeTest.java"
        ]
    },
    "jackrabbit-oak_83dcea5": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6229: NPE when running datastorecheck command with S3\n\n- Initializing the S3DataStore with a temp directory\n- Changed setup to also enable testing for S3 & Azure and test dependencies to s3, azure modules\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1795475 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/83dcea53271e4d34e2de60152ca935b637eb70fb",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/39cc2d5741d2eba1f0e2eb4eefb5d8b7774315b1",
        "bug_id": "jackrabbit-oak_83dcea5",
        "file": [
            {
                "sha": "7d41b5a258a10f6aa75837c12941852aefa30841",
                "filename": "oak-run/pom.xml",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/pom.xml",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/pom.xml",
                "status": "modified",
                "changes": 22,
                "additions": 21,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/pom.xml?ref=83dcea53271e4d34e2de60152ca935b637eb70fb",
                "patch": "@@ -319,7 +319,27 @@\n       <artifactId>junit</artifactId>\n       <scope>test</scope>\n     </dependency>\n-\n+    <dependency>\n+      <groupId>org.apache.jackrabbit</groupId>\n+      <artifactId>oak-blob-plugins</artifactId>\n+      <version>${project.version}</version>\n+      <type>test-jar</type>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.jackrabbit</groupId>\n+      <artifactId>oak-blob-cloud</artifactId>\n+      <version>${project.version}</version>\n+      <type>test-jar</type>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.jackrabbit</groupId>\n+      <artifactId>oak-blob-cloud-azure</artifactId>\n+      <version>${project.version}</version>\n+      <type>test-jar</type>\n+      <scope>test</scope>\n+    </dependency>\n   </dependencies>\n \n   <profiles>",
                "deletions": 1
            },
            {
                "sha": "4c7b3b606bcf94d6861a7cdde15dc9846bb3fe63",
                "filename": "oak-run/src/main/java/org/apache/jackrabbit/oak/run/DataStoreCheckCommand.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/main/java/org/apache/jackrabbit/oak/run/DataStoreCheckCommand.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/main/java/org/apache/jackrabbit/oak/run/DataStoreCheckCommand.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/main/java/org/apache/jackrabbit/oak/run/DataStoreCheckCommand.java?ref=83dcea53271e4d34e2de60152ca935b637eb70fb",
                "patch": "@@ -305,4 +305,4 @@ private static void retrieveBlobIds(GarbageCollectableBlobStore blobStore, File\n         System.out.println(count + \" blob ids found\");\n         System.out.println(\"Finished in \" + watch.elapsed(TimeUnit.SECONDS) + \" seconds\");\n     }\n-}\n\\ No newline at end of file\n+}",
                "deletions": 1
            },
            {
                "sha": "3dc5f56ad794264daacb92d04e9ccd9a1e36a109",
                "filename": "oak-run/src/main/java/org/apache/jackrabbit/oak/run/Utils.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/main/java/org/apache/jackrabbit/oak/run/Utils.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/main/java/org/apache/jackrabbit/oak/run/Utils.java",
                "status": "modified",
                "changes": 6,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/main/java/org/apache/jackrabbit/oak/run/Utils.java?ref=83dcea53271e4d34e2de60152ca935b637eb70fb",
                "patch": "@@ -233,7 +233,9 @@ public static GarbageCollectableBlobStore bootstrapDataStore(String[] args, Clos\n             String cfgPath = s3dsConfig.value(options);\n             Properties props = loadAndTransformProps(cfgPath);\n             s3ds.setProperties(props);\n-            s3ds.init(null);\n+            File homeDir =  Files.createTempDir();\n+            closer.register(asCloseable(homeDir));\n+            s3ds.init(homeDir.getAbsolutePath());\n             delegate = s3ds;\n         } else if (options.has(azureBlobDSConfig)) {\n             AzureDataStore azureds = new AzureDataStore();\n@@ -312,4 +314,4 @@ private static Properties loadAndTransformProps(String cfgPath) throws IOExcepti\n         }\n         return props;\n     }\n-}\n\\ No newline at end of file\n+}",
                "deletions": 2
            },
            {
                "sha": "0716bfa11fc6e9448e93d0c289ffa04ff5699cb8",
                "filename": "oak-run/src/main/java/org/apache/jackrabbit/oak/run/cli/BlobStoreFixtureProvider.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/main/java/org/apache/jackrabbit/oak/run/cli/BlobStoreFixtureProvider.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/main/java/org/apache/jackrabbit/oak/run/cli/BlobStoreFixtureProvider.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/main/java/org/apache/jackrabbit/oak/run/cli/BlobStoreFixtureProvider.java?ref=83dcea53271e4d34e2de60152ca935b637eb70fb",
                "patch": "@@ -68,7 +68,9 @@ public static BlobStoreFixture create(Options options) throws Exception{\n             SharedS3DataStore s3ds = new SharedS3DataStore();\n             Properties props = loadAndTransformProps(bsopts.getS3ConfigPath());\n             s3ds.setProperties(props);\n-            s3ds.init(null);\n+            File homeDir =  Files.createTempDir();\n+            closer.register(asCloseable(homeDir));\n+            s3ds.init(homeDir.getAbsolutePath());\n             delegate = s3ds;\n         } else if(bsType == Type.AZURE){\n             AzureDataStore azureds = new AzureDataStore();",
                "deletions": 1
            },
            {
                "sha": "3706ff740868d81006892e2b2787c34e3d020226",
                "filename": "oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/83dcea53271e4d34e2de60152ca935b637eb70fb/oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java",
                "status": "modified",
                "changes": 89,
                "additions": 60,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-run/src/test/java/org/apache/jackrabbit/oak/run/DataStoreCheckTest.java?ref=83dcea53271e4d34e2de60152ca935b637eb70fb",
                "patch": "@@ -21,7 +21,6 @@\n import static com.google.common.base.Charsets.UTF_8;\n import static org.junit.Assert.assertEquals;\n \n-import java.io.BufferedWriter;\n import java.io.ByteArrayInputStream;\n import java.io.ByteArrayOutputStream;\n import java.io.File;\n@@ -34,16 +33,20 @@\n import java.util.ArrayList;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.Properties;\n import java.util.Random;\n import java.util.Set;\n \n import com.google.common.collect.ImmutableList;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Lists;\n import com.google.common.collect.Sets;\n-import com.google.common.io.Files;\n+import org.apache.commons.io.FileUtils;\n import org.apache.commons.io.filefilter.FileFilterUtils;\n-import org.apache.commons.lang3.StringEscapeUtils;\n+import org.apache.felix.cm.file.ConfigurationHandler;\n+import org.apache.jackrabbit.core.data.DataStore;\n+import org.apache.jackrabbit.oak.blob.cloud.azure.blobstorage.AzureDataStoreUtils;\n+import org.apache.jackrabbit.oak.blob.cloud.s3.S3DataStoreUtils;\n import org.apache.jackrabbit.oak.commons.FileIOUtils;\n import org.apache.jackrabbit.oak.plugins.blob.datastore.DataStoreBlobStore;\n import org.apache.jackrabbit.oak.plugins.blob.datastore.OakFileDataStore;\n@@ -81,18 +84,48 @@\n \n     private String dsPath;\n \n+    private DataStoreBlobStore setupDataStore;\n+\n+    private String dsOption;\n+\n     @Before\n     public void setup() throws Exception {\n-        OakFileDataStore delegate = new OakFileDataStore();\n-        dsPath = temporaryFolder.newFolder().getAbsolutePath();\n-        delegate.setPath(dsPath);\n-        delegate.init(null);\n-        DataStoreBlobStore blobStore = new DataStoreBlobStore(delegate);\n+        if (S3DataStoreUtils.isS3Configured()) {\n+            Properties props = S3DataStoreUtils.getS3Config();\n+            props.setProperty(\"cacheSize\", \"0\");\n+            DataStore ds = S3DataStoreUtils.getS3DataStore(S3DataStoreUtils.getFixtures().get(0),\n+                props,\n+                temporaryFolder.newFolder().getAbsolutePath());\n+            setupDataStore = new DataStoreBlobStore(ds);\n+            cfgFilePath = createTempConfig(temporaryFolder.newFile(), props);\n+            dsOption = \"s3ds\";\n+        } else if (AzureDataStoreUtils.isAzureConfigured()) {\n+            Properties props = AzureDataStoreUtils.getAzureConfig();\n+            props.setProperty(\"cacheSize\", \"0\");\n+            DataStore ds = AzureDataStoreUtils.getAzureDataStore(props,\n+                temporaryFolder.newFolder().getAbsolutePath());\n+            setupDataStore = new DataStoreBlobStore(ds);\n+            cfgFilePath = createTempConfig(temporaryFolder.newFile(), props);\n+            dsOption = \"azureblobds\";\n+        }\n+        else {\n+            OakFileDataStore delegate = new OakFileDataStore();\n+            dsPath = temporaryFolder.newFolder().getAbsolutePath();\n+            delegate.setPath(dsPath);\n+            delegate.init(null);\n+            setupDataStore = new DataStoreBlobStore(delegate);\n+\n+            File cfgFile = temporaryFolder.newFile();\n+            Properties props = new Properties();\n+            props.put(\"path\", dsPath);\n+            cfgFilePath = createTempConfig(cfgFile, props);\n+            dsOption = \"fds\";\n+        }\n \n         File storeFile = temporaryFolder.newFolder();\n         storePath = storeFile.getAbsolutePath();\n         FileStore fileStore = FileStoreBuilder.fileStoreBuilder(storeFile)\n-                .withBlobStore(blobStore)\n+                .withBlobStore(setupDataStore)\n                 .withMaxFileSize(256)\n                 .withSegmentCacheSize(64)\n                 .build();\n@@ -104,7 +137,7 @@ public void setup() throws Exception {\n         blobsAdded = Sets.newHashSet();\n         for (int i = 0; i < numBlobs; i++) {\n             SegmentBlob b = (SegmentBlob) store.createBlob(randomStream(i, 18342));\n-            Iterator<String> idIter = blobStore.resolveChunks(b.getBlobId());\n+            Iterator<String> idIter = setupDataStore.resolveChunks(b.getBlobId());\n             while (idIter.hasNext()) {\n                 String chunk = idIter.next();\n                 blobsAdded.add(chunk);\n@@ -115,14 +148,7 @@ public void setup() throws Exception {\n         store.merge(a, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n         log.info(\"Created blobs : {}\", blobsAdded);\n \n-        File cfgFile = temporaryFolder.newFile();\n-        BufferedWriter writer = Files.newWriter(cfgFile, UTF_8);\n-        FileIOUtils.writeAsLine(writer, \"path=\\\"\" + StringEscapeUtils.escapeJava(dsPath) + \"\\\"\",false);\n-        writer.close();\n-        cfgFilePath = cfgFile.getAbsolutePath();\n-\n         fileStore.close();\n-        blobStore.close();\n     }\n \n     @After\n@@ -133,24 +159,20 @@ public void tearDown() {\n     @Test\n     public void testCorrect() throws Exception {\n         File dump = temporaryFolder.newFolder();\n+        setupDataStore.close();\n         testAllParams(dump);\n     }\n \n     @Test\n     public void testConsistency() throws Exception {\n         File dump = temporaryFolder.newFolder();\n \n-        // Delete a random blob from datastore\n-        OakFileDataStore delegate = new OakFileDataStore();\n-        delegate.setPath(dsPath);\n-        delegate.init(null);\n-        DataStoreBlobStore blobStore = new DataStoreBlobStore(delegate);\n-\n         Random rand = new Random();\n         String deletedBlobId = Iterables.get(blobsAdded, rand.nextInt(blobsAdded.size()));\n         blobsAdded.remove(deletedBlobId);\n-        long count = blobStore.countDeleteChunks(ImmutableList.of(deletedBlobId), 0);\n+        long count = setupDataStore.countDeleteChunks(ImmutableList.of(deletedBlobId), 0);\n         assertEquals(1, count);\n+        setupDataStore.close();\n \n         testAllParams(dump);\n \n@@ -159,27 +181,29 @@ public void testConsistency() throws Exception {\n         assertFileEquals(dump, \"[consistency]\", Sets.newHashSet(deletedBlobId));\n     }\n \n-    public void testAllParams(File dump) throws Exception {\n+    private void testAllParams(File dump) throws Exception {\n         DataStoreCheckCommand checkCommand = new DataStoreCheckCommand();\n         List<String> argsList = Lists\n-            .newArrayList(\"--id\", \"--ref\", \"--consistency\", \"--fds\", cfgFilePath, \"--store\", storePath,\n+            .newArrayList(\"--id\", \"--ref\", \"--consistency\", \"--\" + dsOption, cfgFilePath, \"--store\", storePath,\n                 \"--dump\", dump.getAbsolutePath());\n \n         checkCommand.execute(argsList.toArray(new String[0]));\n     }\n \n     @Test\n     public void testMissingOpParams() throws Exception {\n+        setupDataStore.close();\n         File dump = temporaryFolder.newFolder();\n         List<String> argsList = Lists\n-            .newArrayList(\"--fds\", cfgFilePath, \"--store\", storePath,\n+            .newArrayList(\"--\" + dsOption, cfgFilePath, \"--store\", storePath,\n                 \"--dump\", dump.getAbsolutePath());\n         log.info(\"Running testMissinOpParams: {}\", argsList);\n         testIncorrectParams(argsList, Lists.newArrayList(\"Missing required option(s)\", \"'id'\", \"'ref'\", \"'consistency'\"));\n     }\n \n     @Test\n     public void testTarNoDS() throws Exception {\n+        setupDataStore.close();\n         File dump = temporaryFolder.newFolder();\n         List<String> argsList = Lists\n             .newArrayList(\"--id\", \"--ref\", \"--consistency\", \"--store\", storePath,\n@@ -190,14 +214,15 @@ public void testTarNoDS() throws Exception {\n \n     @Test\n     public void testOpNoStore() throws Exception {\n+        setupDataStore.close();\n         File dump = temporaryFolder.newFolder();\n         List<String> argsList = Lists\n-            .newArrayList(\"--consistency\", \"--fds\", cfgFilePath,\n+            .newArrayList(\"--consistency\", \"--\" + dsOption, cfgFilePath,\n                 \"--dump\", dump.getAbsolutePath());\n         testIncorrectParams(argsList, Lists.newArrayList(\"Missing required option(s) ['store']\"));\n \n         argsList = Lists\n-            .newArrayList(\"--ref\", \"--fds\", cfgFilePath,\n+            .newArrayList(\"--ref\", \"--\" + dsOption, cfgFilePath,\n                 \"--dump\", dump.getAbsolutePath());\n         testIncorrectParams(argsList, Lists.newArrayList(\"Missing required option(s) ['store']\"));\n     }\n@@ -236,4 +261,10 @@ static InputStream randomStream(int seed, int size) {\n         r.nextBytes(data);\n         return new ByteArrayInputStream(data);\n     }\n+\n+    private static String createTempConfig(File cfgFile, Properties props) throws IOException {\n+        FileOutputStream fos = FileUtils.openOutputStream(cfgFile);\n+        ConfigurationHandler.write(fos, props);\n+        return cfgFile.getAbsolutePath();\n+    }\n }",
                "deletions": 29
            }
        ],
        "patched_files": [
            "Utils.java",
            "BlobStoreFixtureProvider.java",
            "DataStoreCheckCommand.java"
        ],
        "unit_tests": [
            "TestUtils.java",
            "UtilsTest.java",
            "DataStoreCheckTest.java"
        ]
    },
    "jackrabbit-oak_72223c2": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1464 FileStoreBackup NPE in retrieving old state\n - re-wording debug logs\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1571251 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/72223c27b998e7a579cc41986f3315e3f493f521",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/d4ef60c19484d4295593a6e03b9c08975295160f",
        "bug_id": "jackrabbit-oak_72223c2",
        "file": [
            {
                "sha": "935734ff0c3fafd3047f76882a5e60860fa3854d",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/72223c27b998e7a579cc41986f3315e3f493f521/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/72223c27b998e7a579cc41986f3315e3f493f521/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/backup/FileStoreBackup.java?ref=72223c27b998e7a579cc41986f3315e3f493f521",
                "patch": "@@ -87,6 +87,6 @@ public static void backup(NodeStore store, File destination)\n             backup.close();\n         }\n \n-        log.debug(\"Backup done in {} ms.\", System.currentTimeMillis() - s);\n+        log.debug(\"Backup finished in {} ms.\", System.currentTimeMillis() - s);\n     }\n }",
                "deletions": 1
            }
        ],
        "patched_files": [
            "FileStoreBackup.java"
        ],
        "unit_tests": [
            "FileStoreBackupTest.java"
        ]
    },
    "jackrabbit-oak_49c7ec4": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2876 Test failure: RepositorySidegradeTest.verifyAsync (NPE)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1681105 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/49c7ec47e910f62344482ce1e1cb74ce2a9deb0e",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/c94c35d555d409fe809ec017360a171e244a5a24",
        "bug_id": "jackrabbit-oak_49c7ec4",
        "file": [
            {
                "sha": "ec14fc91d29694bdcab89572dbbdd413b686dd50",
                "filename": "oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/49c7ec47e910f62344482ce1e1cb74ce2a9deb0e/oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/49c7ec47e910f62344482ce1e1cb74ce2a9deb0e/oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java",
                "status": "modified",
                "changes": 32,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-upgrade/src/test/java/org/apache/jackrabbit/oak/upgrade/RepositorySidegradeTest.java?ref=49c7ec47e910f62344482ce1e1cb74ce2a9deb0e",
                "patch": "@@ -69,8 +69,6 @@\n import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n import org.junit.Before;\n-import org.junit.BeforeClass;\n-import org.junit.Ignore;\n import org.junit.Test;\n \n public class RepositorySidegradeTest {\n@@ -83,35 +81,22 @@\n         new Random().nextBytes(BINARY);\n     }\n     \n-    protected static final Credentials CREDENTIALS = new SimpleCredentials(\"admin\", \"admin\".toCharArray());\n+    private static final Credentials CREDENTIALS = new SimpleCredentials(\"admin\", \"admin\".toCharArray());\n \n     private NodeStore targetNodeStore;\n-    private static Repository targetRepository;\n-\n-    \n-    @BeforeClass\n-    public static void init() {\n-        // ensure that we create a new repository for the next test\n-        targetRepository = null;\n-    }\n+    private Repository targetRepository;\n \n     @Before\n     public synchronized void upgradeRepository() throws Exception {\n-        if (targetRepository == null) {\n-            targetNodeStore = new SegmentNodeStore();\n-            targetRepository = new Jcr(new Oak(targetNodeStore)).createRepository();\n-            NodeStore source = createSourceContent();\n-            RepositorySidegrade sidegrade = new RepositorySidegrade(source, targetNodeStore);\n-            sidegrade.copy();\n-        }\n-    }\n-    \n-    public Repository getTargetRepository() {\n-        return targetRepository;\n+        targetNodeStore = new SegmentNodeStore();\n+        targetRepository = new Jcr(new Oak(targetNodeStore)).createRepository();\n+        NodeStore source = createSourceContent();\n+        RepositorySidegrade sidegrade = new RepositorySidegrade(source, targetNodeStore);\n+        sidegrade.copy();\n     }\n     \n     public JackrabbitSession createAdminSession() throws RepositoryException {\n-        return (JackrabbitSession) getTargetRepository().login(CREDENTIALS);\n+        return (JackrabbitSession) targetRepository.login(CREDENTIALS);\n     }\n     \n     // OAK-2869\n@@ -123,7 +108,6 @@ private static void setAsync(NodeStore source) throws Exception {\n     \n     // OAK-2869\n     @Test\n-    @Ignore(\"OAK-2876\")  // FIXME See OAK-2876\n     public void verifyAsync() throws Exception {\n         NodeState state = targetNodeStore.getRoot().getChildNode(\":async\");\n         assertFalse(state.hasProperty(\"test\"));",
                "deletions": 24
            }
        ],
        "patched_files": [
            "RepositorySidegrade.java"
        ],
        "unit_tests": [
            "RepositorySidegradeTest.java"
        ]
    },
    "jackrabbit-oak_578efe2": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1817: NPE in MarkSweepGarbageCollector.saveBatchToFile during Datastore GC with FileDataStore\n\nUse correct segment size when wrapping the buffer\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1596534 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/578efe27c207f6daffb3dd9223cb6bbe14794c12",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/6186a1229ff657dbb4c6a993f16533d8815c0f94",
        "bug_id": "jackrabbit-oak_578efe2",
        "file": [
            {
                "sha": "16c3f8377730c92f2ece7953b3bd97b79a469ed3",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/578efe27c207f6daffb3dd9223cb6bbe14794c12/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/578efe27c207f6daffb3dd9223cb6bbe14794c12/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java?ref=578efe27c207f6daffb3dd9223cb6bbe14794c12",
                "patch": "@@ -219,7 +219,7 @@ public synchronized void flush() {\n                 data.put(buffer, buffer.length - length, length);\n                 data.rewind();\n             } else {\n-                data = ByteBuffer.wrap(buffer);\n+                data = ByteBuffer.wrap(buffer, buffer.length - length, length);\n             }\n             tracker.setSegment(id, new Segment(tracker, id, data));\n ",
                "deletions": 1
            },
            {
                "sha": "00d2321903eeae4e69c7bdcaa3777f8995873954",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/578efe27c207f6daffb3dd9223cb6bbe14794c12/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/578efe27c207f6daffb3dd9223cb6bbe14794c12/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java?ref=578efe27c207f6daffb3dd9223cb6bbe14794c12",
                "patch": "@@ -82,7 +82,6 @@ public void testDataStoreBlob() throws Exception {\n         is.close();\n     }\n \n-    @Ignore(\"OAK-1817\")\n     @Test\n     public void testNullBlobId() throws Exception{\n         FileDataStore fds = createFileDataStore();",
                "deletions": 1
            }
        ],
        "patched_files": [
            "SegmentWriter.java"
        ],
        "unit_tests": [
            "ExternalBlobTest.java"
        ]
    },
    "jackrabbit-oak_47c4aef": {
        "repo": "jackrabbit-oak",
        "message": "OAK-635 SegmentMK NPE in SegmentNodeState#getChildNode\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1447780 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/47c4aef10ce3427b420b2ee7cc076c9683a6e268",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/0989e5157186aa7dc17b428625bb70aa573757a0",
        "bug_id": "jackrabbit-oak_47c4aef",
        "file": [
            {
                "sha": "d74f2f45063c22e7fef729c701a6d451deea825e",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/api/Tree.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/api/Tree.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/api/Tree.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/api/Tree.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -179,7 +179,7 @@\n      *         child exists or the child is not accessible.\n      */\n     @CheckForNull\n-    Tree getChild(String name);\n+    Tree getChild(@Nonnull String name);\n \n     /**\n      * Determine if a child of this {@code Tree} instance exists. If no child\n@@ -189,7 +189,7 @@\n      * @return {@code true} if and only if a child with the given {@code name}\n      *         exists and is accessible for the current content session.\n      */\n-    boolean hasChild(String name);\n+    boolean hasChild(@Nonnull String name);\n \n     /**\n      * Determine the number of children of this {@code Tree} instance taking",
                "deletions": 2
            },
            {
                "sha": "fc0e72fa844e0189fe4a9f268636ca83bf0fa8cb",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -136,7 +136,7 @@ public long getPropertyCount() {\n     }\n \n     @Override\n-    public ReadOnlyTree getChild(String name) {\n+    public ReadOnlyTree getChild(@Nonnull String name) {\n         NodeState child = state.getChildNode(name);\n         if (child != null) {\n             return new ReadOnlyTree(this, name, child);\n@@ -156,8 +156,8 @@ public TreeLocation getLocation() {\n     }\n \n     @Override\n-    public boolean hasChild(String name) {\n-        return state.getChildNode(name) != null;\n+    public boolean hasChild(@Nonnull String name) {\n+        return state.hasChildNode(name);\n     }\n \n     @Override",
                "deletions": 3
            },
            {
                "sha": "687956d36b6debde73c231579652b3275bf27105",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/core/TreeImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/core/TreeImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/core/TreeImpl.java",
                "status": "modified",
                "changes": 6,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/core/TreeImpl.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -198,7 +198,8 @@ public boolean apply(PropertyState propertyState) {\n     }\n \n     @Override\n-    public TreeImpl getChild(String name) {\n+    public TreeImpl getChild(@Nonnull String name) {\n+        checkNotNull(name);\n         root.checkLive();\n         TreeImpl child = internalGetChild(name);\n         if (child != null && canRead(child)) {\n@@ -239,8 +240,7 @@ public Status getStatus() {\n     }\n \n     @Override\n-    public boolean hasChild(String name) {\n-        root.checkLive();\n+    public boolean hasChild(@Nonnull String name) {\n         return getChild(name) != null;\n     }\n ",
                "deletions": 3
            },
            {
                "sha": "e9bda16c39707829c1becaa4d0f163cd85cc5117",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeState.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/kernel/KernelNodeState.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -205,6 +205,7 @@ public long getChildNodeCount() {\n \n     @Override\n     public NodeState getChildNode(String name) {\n+        checkNotNull(name);\n         init();\n         String childPath = childPaths.get(name);\n         if (childPath == null && childNodeCount > MAX_CHILD_NODE_NAMES) {",
                "deletions": 0
            },
            {
                "sha": "86cc383a794fd337b0beffa2ad86471f611b3ad6",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -577,11 +577,13 @@ public long getChildNodeCount() {\n \n         @Override\n         public boolean hasChildNode(String name) {\n+            checkNotNull(name);\n             return withNodes(base, nodes).hasChildNode(name);\n         }\n \n         @Override\n         public NodeState getChildNode(String name) {\n+            checkNotNull(name);\n             return withNodes(base, nodes).getChildNode(name); // mutable\n         }\n ",
                "deletions": 0
            },
            {
                "sha": "0abd1ea74d071d4f6722bf2e2d2b16c85cb432de",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeState.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeState.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -16,6 +16,8 @@\n  */\n package org.apache.jackrabbit.oak.plugins.memory;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n import org.apache.jackrabbit.oak.api.PropertyState;\n import org.apache.jackrabbit.oak.spi.state.AbstractNodeState;\n import org.apache.jackrabbit.oak.spi.state.ChildNodeEntry;\n@@ -78,11 +80,13 @@ public long getPropertyCount() {\n \n     @Override\n     public boolean hasChildNode(String name) {\n+        checkNotNull(name);\n         return nodes.containsKey(name);\n     }\n \n     @Override\n     public NodeState getChildNode(String name) {\n+        checkNotNull(name);\n         return nodes.get(name);\n     }\n ",
                "deletions": 0
            },
            {
                "sha": "7c8ae464c65ead9614313290504a1f85afc7d76a",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/ModifiedNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/ModifiedNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/ModifiedNodeState.java",
                "status": "modified",
                "changes": 2,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/ModifiedNodeState.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -204,6 +204,7 @@ public long getChildNodeCount() {\n \n     @Override\n     public boolean hasChildNode(String name) {\n+        checkNotNull(name);\n         NodeState child = nodes.get(name);\n         if (child != null) {\n             return true;\n@@ -216,6 +217,7 @@ public boolean hasChildNode(String name) {\n \n     @Override\n     public NodeState getChildNode(String name) {\n+        checkNotNull(name);\n         NodeState child = nodes.get(name);\n         if (child != null) {\n             return child;",
                "deletions": 0
            },
            {
                "sha": "ecc89f3cd148dd36cbbd766efda40e627c80b5fc",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/AbstractNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/AbstractNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/AbstractNodeState.java",
                "status": "modified",
                "changes": 3,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/AbstractNodeState.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -16,6 +16,8 @@\n  */\n package org.apache.jackrabbit.oak.spi.state;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n import org.apache.jackrabbit.oak.api.PropertyState;\n \n import com.google.common.base.Function;\n@@ -65,6 +67,7 @@ public boolean hasChildNode(String name) {\n \n     @Override\n     public NodeState getChildNode(String name) {\n+        checkNotNull(name);\n         for (ChildNodeEntry entry : getChildNodeEntries()) {\n             if (name.equals(entry.getName())) {\n                 return entry.getNodeState();",
                "deletions": 0
            },
            {
                "sha": "e2d19b9a38224c8f5c5c7263a922fe6dc1ddae2c",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeBuilder.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeBuilder.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -97,7 +97,7 @@ void reset(@Nonnull NodeState state)\n      * @return {@code true} if the named child node exists,\n      *         {@code false} otherwise\n      */\n-    boolean hasChildNode(String name);\n+    boolean hasChildNode(@Nonnull String name);\n \n     /**\n      * Returns the names of current child nodes.\n@@ -213,6 +213,6 @@ void reset(@Nonnull NodeState state)\n      * @return child builder\n      */\n     @Nonnull\n-    NodeBuilder child(String name);\n+    NodeBuilder child(@Nonnull String name);\n \n }",
                "deletions": 2
            },
            {
                "sha": "375ac003f87e5e22e868ebed77a37f7e12d9d8de",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeState.java",
                "status": "modified",
                "changes": 4,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/spi/state/NodeState.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -134,7 +134,7 @@\n      * @return {@code true} if the named child node exists,\n      *         {@code false} otherwise\n      */\n-    boolean hasChildNode(String name);\n+    boolean hasChildNode(@Nonnull String name);\n \n     /**\n      * Returns the named child node. The name is an opaque string and\n@@ -149,7 +149,7 @@\n      * @return named child node, or {@code null} if not found\n      */\n     @CheckForNull\n-    NodeState getChildNode(String name);\n+    NodeState getChildNode(@Nonnull String name);\n \n     /**\n      * Returns the number of child nodes of this node.",
                "deletions": 2
            },
            {
                "sha": "9234fd187f1e29eb84016d7c8c912de2d1c743c8",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/AccessControlManagerImplTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/AccessControlManagerImplTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47c4aef10ce3427b420b2ee7cc076c9683a6e268/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/AccessControlManagerImplTest.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/AccessControlManagerImplTest.java?ref=47c4aef10ce3427b420b2ee7cc076c9683a6e268",
                "patch": "@@ -557,6 +557,7 @@ public void testGetEffectivePolicies() throws Exception {\n         // TODO\n     }\n \n+    @Ignore(\"OAK-644\")\n     @Test\n     public void testSetPolicy() throws Exception {\n         ACL acl = getApplicablePolicy(testPath);\n@@ -575,6 +576,7 @@ public void testSetPolicy() throws Exception {\n         assertArrayEquals(acl.getAccessControlEntries(), acl2.getAccessControlEntries());\n     }\n \n+    @Ignore(\"OAK-644\")\n     @Test\n     public void testSetPolicyWritesAcContent() throws Exception {\n         ACL acl = getApplicablePolicy(testPath);\n@@ -695,4 +697,4 @@ public void testRemovePolicyOnAclNode() throws Exception {\n     public void testRemoveRepoPolicy() throws Exception {\n         // TODO\n     }\n-}\n\\ No newline at end of file\n+}",
                "deletions": 1
            }
        ],
        "patched_files": [
            "MemoryNodeState.java",
            "NodeState.java",
            "ReadOnlyTree.java",
            "ModifiedNodeState.java",
            "Tree.java",
            "AbstractNodeState.java",
            "AccessControlManagerImpl.java",
            "NodeBuilder.java",
            "KernelNodeState.java",
            "MemoryNodeBuilder.java",
            "TreeImpl.java"
        ],
        "unit_tests": [
            "TreeImplTest.java",
            "NodeBuilderTest.java",
            "TreeTest.java",
            "KernelNodeStateTest.java",
            "ReadOnlyTreeTest.java",
            "MemoryNodeBuilderTest.java",
            "AccessControlManagerImplTest.java"
        ]
    },
    "jackrabbit-oak_9611fa1": {
        "repo": "jackrabbit-oak",
        "message": "OAK-992: NPE when running FlatTreeWithAceForSamePrincipalTest on MongoMK\n- Adding simplified test case (currently ignored)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1521805 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/9611fa16aa016db7fac0c96b25b6a43a76d1186b",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/a9667e3896d39b51738cf266c3a5d51bc5201219",
        "bug_id": "jackrabbit-oak_9611fa1",
        "file": [
            {
                "sha": "56ca5bfaf2161536664ddcf0eb80595421c90ddc",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/9611fa16aa016db7fac0c96b25b6a43a76d1186b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/9611fa16aa016db7fac0c96b25b6a43a76d1186b/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java",
                "status": "modified",
                "changes": 12,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/mongomk/MongoMKBranchMergeTest.java?ref=9611fa16aa016db7fac0c96b25b6a43a76d1186b",
                "patch": "@@ -441,6 +441,18 @@ public void run() {\n         }\n     }\n \n+    @Ignore(\"OAK-992\")\n+    @Test\n+    public void branchReadAfterMerge() {\n+        String branchRev = mk.branch(null);\n+        branchRev = mk.commit(\"/\", \"+\\\"foo\\\":{}\", branchRev, null);\n+        branchRev = mk.commit(\"/\", \"+\\\"bar\\\":{}\", branchRev, null);\n+        mk.merge(branchRev, null);\n+        assertNodesExist(branchRev, \"/foo\");\n+    }\n+\n+    //--------------------------< internal >------------------------------------\n+\n     private String addNodes(String rev, String...nodes) {\n         for (String node : nodes) {\n             rev = mk.commit(\"\", \"+\\\"\" + node + \"\\\":{}\", rev, \"\");",
                "deletions": 0
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "MongoMKBranchMergeTest.java"
        ]
    },
    "jackrabbit-oak_de6253b": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2297: Update for absent document may throw NPE\n\nTest case and fix\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1641811 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/de6253b2590bced117e12eabadc26d0a97bff8ec",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/9dd8254dbe9986c72a63140775d46eb74215cf7b",
        "bug_id": "jackrabbit-oak_de6253b",
        "file": [
            {
                "sha": "df185cb83d6ae2b2dbb426e7e70d238209ad6070",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/de6253b2590bced117e12eabadc26d0a97bff8ec/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/de6253b2590bced117e12eabadc26d0a97bff8ec/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/mongo/MongoDocumentStore.java?ref=de6253b2590bced117e12eabadc26d0a97bff8ec",
                "patch": "@@ -758,7 +758,8 @@ boolean canUseModifiedTimeIdx(long modifiedTimeInSecs) {\n                     for (Entry<String, NodeDocument> entry : cachedDocs.entrySet()) {\n                         TreeLock lock = acquire(entry.getKey());\n                         try {\n-                            if (entry.getValue() == null) {\n+                            if (entry.getValue() == null\n+                                    || entry.getValue() == NodeDocument.NULL) {\n                                 // make sure concurrently loaded document is invalidated\n                                 nodesCache.invalidate(new StringValue(entry.getKey()));\n                             } else {",
                "deletions": 1
            },
            {
                "sha": "a90288cc87879d83e4125a27dba71c63d925e3c7",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreIT.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/de6253b2590bced117e12eabadc26d0a97bff8ec/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreIT.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/de6253b2590bced117e12eabadc26d0a97bff8ec/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreIT.java",
                "status": "modified",
                "changes": 17,
                "additions": 17,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStoreIT.java?ref=de6253b2590bced117e12eabadc26d0a97bff8ec",
                "patch": "@@ -16,7 +16,10 @@\n  */\n package org.apache.jackrabbit.oak.plugins.document;\n \n+import java.util.Collections;\n+\n import org.apache.jackrabbit.oak.plugins.document.util.TimingDocumentStoreWrapper;\n+import org.apache.jackrabbit.oak.plugins.document.util.Utils;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n@@ -25,6 +28,7 @@\n import org.junit.Test;\n \n import static java.util.concurrent.TimeUnit.SECONDS;\n+import static org.apache.jackrabbit.oak.plugins.document.Collection.NODES;\n import static org.apache.jackrabbit.oak.plugins.document.NodeDocument.MODIFIED_IN_SECS_RESOLUTION;\n import static org.apache.jackrabbit.oak.plugins.document.util.Utils.getIdFromPath;\n import static org.junit.Assert.assertEquals;\n@@ -113,4 +117,17 @@ public void dispose() {\n         ns1.dispose();\n         ns2.dispose();\n     }\n+\n+    // OAK-2297\n+    @Test\n+    public void updateAbsentDocument() throws Exception {\n+        String id = Utils.getIdFromPath(\"/test\");\n+        // trigger cache entry for /test\n+        ds.find(NODES, id);\n+\n+        UpdateOp updateOp = new UpdateOp(id, false);\n+        updateOp.setMapEntry(\"foo\", Revision.newRevision(1), \"bar\");\n+\n+        ds.update(NODES, Collections.singletonList(id), updateOp);\n+    }\n }",
                "deletions": 0
            }
        ],
        "patched_files": [
            "MongoDocumentStore.java"
        ],
        "unit_tests": [
            "MongoDocumentStoreTest.java"
        ]
    },
    "jackrabbit-oak_ea6bb4b": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4997: RevisionGCTest.teardown() may fail with NPE when store == null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766496 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ea6bb4be1b0b92532611af2f572bdc0d3e8ac584",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/151f9bb824ebf80cdeb2b9ad13b49c4484ec1b0a",
        "bug_id": "jackrabbit-oak_ea6bb4b",
        "file": [
            {
                "sha": "22fa57ccc38b620193c863663b960250da879a94",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/RevisionGCTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ea6bb4be1b0b92532611af2f572bdc0d3e8ac584/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/RevisionGCTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ea6bb4be1b0b92532611af2f572bdc0d3e8ac584/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/RevisionGCTest.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/document/RevisionGCTest.java?ref=ea6bb4be1b0b92532611af2f572bdc0d3e8ac584",
                "patch": "@@ -69,7 +69,9 @@ public void setUp() throws InterruptedException {\n \n     @After\n     public void tearDown() throws Exception {\n-        store.dispose();\n+        if (store != null) {\n+            store.dispose();\n+        }\n         Revision.resetClockToDefault();\n     }\n ",
                "deletions": 1
            }
        ],
        "patched_files": [
            "RevisionGC.java"
        ],
        "unit_tests": [
            "RevisionGCTest.java"
        ]
    },
    "jackrabbit-oak_f65d4d6": {
        "repo": "jackrabbit-oak",
        "message": "OAK-5002: NPE when creating read only store\n@Ignored test case\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1766531 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/f65d4d6bb32840ee3667a783941f658153a97435",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/e0e47e08a8e16bc9b92912dea70d39d01d4c7186",
        "bug_id": "jackrabbit-oak_f65d4d6",
        "file": [
            {
                "sha": "3b475376bf6d2f2ecd8011b153c4feabf3da38c3",
                "filename": "oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/f65d4d6bb32840ee3667a783941f658153a97435/oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/f65d4d6bb32840ee3667a783941f658153a97435/oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java",
                "status": "added",
                "changes": 64,
                "additions": 64,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-segment-tar/src/test/java/org/apache/jackrabbit/oak/segment/ReadOnlyStoreTest.java?ref=f65d4d6bb32840ee3667a783941f658153a97435",
                "patch": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.jackrabbit.oak.segment;\n+\n+import static org.apache.jackrabbit.oak.segment.file.FileStoreBuilder.fileStoreBuilder;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import org.apache.jackrabbit.oak.segment.file.FileStore;\n+import org.apache.jackrabbit.oak.segment.file.InvalidFileStoreVersionException;\n+import org.apache.jackrabbit.oak.segment.file.ReadOnlyFileStore;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Ignore;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+public class ReadOnlyStoreTest {\n+    @Rule\n+    public TemporaryFolder folder = new TemporaryFolder(new File(\"target\"));\n+\n+    private ReadOnlyFileStore fileStore;\n+\n+    @Before\n+    public void setup() throws IOException, InvalidFileStoreVersionException {\n+        File path = folder.getRoot();\n+        initStoreAt(path);\n+        fileStore = fileStoreBuilder(path).buildReadOnly();\n+    }\n+\n+    private static void initStoreAt(File path) throws InvalidFileStoreVersionException, IOException {\n+        FileStore store = fileStoreBuilder(path).build();\n+        store.close();\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        fileStore.close();\n+    }\n+\n+    @Test\n+    @Ignore(\"OAK-5002\")  // FIXME OAK-5002\n+    public void createStore() {\n+        SegmentNodeStoreBuilders.builder(fileStore).build();\n+    }\n+}",
                "deletions": 0
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "ReadOnlyStoreTest.java"
        ]
    },
    "jackrabbit-oak_c4fbc5b": {
        "repo": "jackrabbit-oak",
        "message": "OAK-613 NPE in Property2IndexDiff#getIndexes(String) when processing a removed node.\n - Test for the NPE guard\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1443498 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/c4fbc5ba29d529b27f5374e2273894da6106dd61",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/d2f71270a1bb8e662c77cd2a913e888879626647",
        "bug_id": "jackrabbit-oak_c4fbc5b",
        "file": [
            {
                "sha": "b1b35fb8260a3db921d02fa5aebde89eb8082b0d",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/p2/Property2IndexTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c4fbc5ba29d529b27f5374e2273894da6106dd61/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/p2/Property2IndexTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c4fbc5ba29d529b27f5374e2273894da6106dd61/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/p2/Property2IndexTest.java",
                "status": "modified",
                "changes": 32,
                "additions": 31,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/index/p2/Property2IndexTest.java?ref=c4fbc5ba29d529b27f5374e2273894da6106dd61",
                "patch": "@@ -84,7 +84,7 @@ public void testPropertyLookup() throws Exception {\n         cost = lookup.getCost(\"foo\", null);\n         assertTrue(\"cost: \" + cost, cost >= MANY);\n     }\n-    \n+\n     private static Set<String> find(Property2IndexLookup lookup, String name, String value) {\n         return Sets.newHashSet(lookup.query(null, name, value == null ? null : PropertyValues.newString(value)));\n     }\n@@ -232,4 +232,34 @@ public void testUniqueByTypeKO() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testUniqueByTypeDelete() throws Exception {\n+\n+        NodeState root = MemoryNodeState.EMPTY_NODE;\n+\n+        // Add index definition\n+        NodeBuilder builder = root.builder();\n+        builder.child(\"oak:index\").child(\"fooIndex\")\n+                .setProperty(\"jcr:primaryType\", \"oak:queryIndexDefinition\", Type.NAME)\n+                .setProperty(\"type\", \"p2\")\n+                .setProperty(\"unique\", \"true\")\n+                .setProperty(\"propertyNames\", Arrays.asList(\"foo\"), Type.STRINGS)\n+                .setProperty(Property2IndexDiff.declaringNodeTypes, Arrays.asList(\"typeFoo\"), Type.STRINGS);\n+        builder.child(\"a\")\n+                .setProperty(\"jcr:primaryType\", \"typeFoo\", Type.NAME)\n+                .setProperty(\"foo\", \"abc\");\n+        builder.child(\"b\")\n+                .setProperty(\"jcr:primaryType\", \"typeBar\", Type.NAME)\n+                .setProperty(\"foo\", \"abc\");\n+        NodeState before = builder.getNodeState();\n+        builder = before.builder();\n+        builder.removeNode(\"b\");\n+        NodeState after = builder.getNodeState();\n+\n+        IndexHook p = new Property2IndexDiff(builder);\n+        after.compareAgainstBaseState(before, p);\n+        p.apply();\n+        p.close();\n+    }\n+\n }",
                "deletions": 1
            }
        ],
        "patched_files": [
            "Property2Index.java"
        ],
        "unit_tests": [
            "Property2IndexTest.java"
        ]
    },
    "jackrabbit-oak_50b189f": {
        "repo": "jackrabbit-oak",
        "message": "OAK-677: Property events on root node fail with NPE\n- adding test case\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1453345 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/50b189f0c3b6228a4867653202a6cc785dc5c3d7",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/ec55ba76831b7470184d6bfc4d2d999d998292c1",
        "bug_id": "jackrabbit-oak_50b189f",
        "file": [
            {
                "sha": "0e30b327adce48076194bd4f8f72f29cd2ced237",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/50b189f0c3b6228a4867653202a6cc785dc5c3d7/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/50b189f0c3b6228a4867653202a6cc785dc5c3d7/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "status": "modified",
                "changes": 32,
                "additions": 32,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java?ref=50b189f0c3b6228a4867653202a6cc785dc5c3d7",
                "patch": "@@ -2071,6 +2071,38 @@ public Void call() throws Exception {\n         }\n     }\n \n+    @Test\n+    @Ignore(\"OAK-677\")\n+    public void observationOnRootNode() throws Exception {\n+        final AtomicReference<CountDownLatch> hasEvents = new AtomicReference<CountDownLatch>(new CountDownLatch(1));\n+        Session observingSession = createAdminSession();\n+        try {\n+            ObservationManager obsMgr = observingSession.getWorkspace().getObservationManager();\n+            EventListener listener = new EventListener() {\n+                @Override\n+                public void onEvent(EventIterator events) {\n+                    while (events.hasNext()) {\n+                        events.next();\n+                        hasEvents.get().countDown();\n+                    }\n+                }\n+            };\n+\n+            obsMgr.addEventListener(listener, Event.PROPERTY_ADDED,\n+                    \"/\", true, null, null, false);\n+\n+            // add property to root node\n+            Node root = getNode(\"/\");\n+            root.setProperty(\"prop\", \"value\");\n+            root.getSession().save();\n+\n+            assertTrue(hasEvents.get().await(2, TimeUnit.SECONDS));\n+            obsMgr.removeEventListener(listener);\n+        } finally {\n+            observingSession.logout();\n+        }\n+    }\n+\n     @Test\n     public void liveNode() throws RepositoryException {\n         Session session = getAdminSession();",
                "deletions": 0
            }
        ],
        "patched_files": [
            "Repository.java"
        ],
        "unit_tests": [
            "RepositoryTest.java"
        ]
    },
    "jackrabbit-oak_95eb2de": {
        "repo": "jackrabbit-oak",
        "message": "OAK-47 Wrong results and NPE with copy operation (support the copy operation in the Indexer and the SimpleKernel)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1309835 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/95eb2de3c182b09a44c00a5e1e3b9642a7005f88",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/625f5c692194033ac5c3db8d626ffc5dfd1cc639",
        "bug_id": "jackrabbit-oak_95eb2de",
        "file": [
            {
                "sha": "be48a2818fa243d9670c0773ff43c2fbe09aa8dd",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/mk/index/Indexer.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/main/java/org/apache/jackrabbit/mk/index/Indexer.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/main/java/org/apache/jackrabbit/mk/index/Indexer.java",
                "status": "modified",
                "changes": 25,
                "additions": 20,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/mk/index/Indexer.java?ref=95eb2de3c182b09a44c00a5e1e3b9642a7005f88",
                "patch": "@@ -299,6 +299,7 @@ public String updateEnd(String toRevision) {\n     /**\n      * Update the index with the given changes.\n      *\n+     * @param rootPath the root path\n      * @param t the changes\n      * @param lastRevision\n      */\n@@ -309,6 +310,7 @@ public void updateIndex(String rootPath, JsopReader t, String lastRevision) {\n                 break;\n             }\n             String path = PathUtils.concat(rootPath, t.readString());\n+            String target;\n             switch (r) {\n             case '+': {\n                 t.read(':');\n@@ -327,8 +329,16 @@ public void updateIndex(String rootPath, JsopReader t, String lastRevision) {\n                 }\n                 break;\n             }\n+            case '*':\n+                // TODO support and test copy operation (\"*\"),\n+                // specially in combination with other operations\n+                // possibly split up the commit in this case\n+                t.read(':');\n+                target = t.readString();\n+                moveOrCopyNode(path, false, target, lastRevision);\n+                break;\n             case '-':\n-                moveNode(path, null, lastRevision);\n+                moveOrCopyNode(path, true, null, lastRevision);\n                 break;\n             case '^': {\n                 removeProperty(path, lastRevision);\n@@ -342,9 +352,12 @@ public void updateIndex(String rootPath, JsopReader t, String lastRevision) {\n                 break;\n             }\n             case '>':\n+                // TODO does move work correctly\n+                // in combination with other operations?\n+                // possibly split up the commit in this case\n                 t.read(':');\n                 String name = PathUtils.getName(path);\n-                String target, position;\n+                String position;\n                 if (t.matches('{')) {\n                     position = t.readString();\n                     t.read(':');\n@@ -364,7 +377,7 @@ public void updateIndex(String rootPath, JsopReader t, String lastRevision) {\n                 } else {\n                     throw ExceptionFactory.get(\"position: \" + position);\n                 }\n-                moveNode(path, target, lastRevision);\n+                moveOrCopyNode(path, true, target, lastRevision);\n                 break;\n             default:\n                 throw new AssertionError(\"token: \" + (char) t.getTokenType());\n@@ -430,7 +443,7 @@ private void addProperty(String path, String value) {\n         }\n     }\n \n-    private void moveNode(String sourcePath, String targetPath, String lastRevision) {\n+    private void moveOrCopyNode(String sourcePath, boolean remove, String targetPath, String lastRevision) {\n         if (isInIndex(sourcePath)) {\n             // don't index the index\n             return;\n@@ -444,7 +457,9 @@ private void moveNode(String sourcePath, String targetPath, String lastRevision)\n         NodeMap map = new NodeMap();\n         t.read('{');\n         NodeImpl n = NodeImpl.parse(map, t, 0, sourcePath);\n-        addOrRemoveRecursive(n, true, false);\n+        if (remove) {\n+            addOrRemoveRecursive(n, true, false);\n+        }\n         if (targetPath != null) {\n             t = new JsopTokenizer(node);\n             map = new NodeMap();",
                "deletions": 5
            },
            {
                "sha": "185731e6a3bb0def620db3a6ddaa74abc9f40fb2",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/mk/simple/SimpleKernelImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/main/java/org/apache/jackrabbit/mk/simple/SimpleKernelImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/main/java/org/apache/jackrabbit/mk/simple/SimpleKernelImpl.java",
                "status": "modified",
                "changes": 13,
                "additions": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/mk/simple/SimpleKernelImpl.java?ref=95eb2de3c182b09a44c00a5e1e3b9642a7005f88",
                "patch": "@@ -278,18 +278,20 @@ private String doCommit(String rootPath, JsopReader t, String revisionId, String\n                 break;\n             }\n             case '*': {\n-                // TODO is it really required?\n                 // TODO possibly support target position notation\n-                // TODO support copy in wrappers, index,...\n                 t.read(':');\n                 String target = t.readString();\n-                diff.tag('*').key(path).value(target);\n                 if (!PathUtils.isAbsolute(target)) {\n                     target = PathUtils.concat(rootPath, target);\n                 }\n-                NodeImpl node = data.getNode(from);\n+                diff.tag('*').key(path).value(target);\n                 String to = PathUtils.relativize(\"/\", target);\n-                data = data.cloneAndAddChildNode(to, false, null, node, rev);\n+                NodeImpl node = data.getNode(from);\n+                JsopStream json = new JsopStream();\n+                node.append(json, Integer.MAX_VALUE, 0, Integer.MAX_VALUE, false);\n+                json.read('{');\n+                NodeImpl n2 = NodeImpl.parse(nodeMap, json, rev);\n+                data = data.cloneAndAddChildNode(to, false, null, n2, rev);\n                 break;\n             }\n             default:\n@@ -555,6 +557,7 @@ public synchronized void dispose() {\n         }\n     }\n \n+    @Override\n     public String toString() {\n         return \"simple:\" + name;\n     }",
                "deletions": 5
            },
            {
                "sha": "e7d544d2b38f38015ad2204442e1d29a88f63b0d",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/mk/MoveNodeTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/test/java/org/apache/jackrabbit/mk/MoveNodeTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/test/java/org/apache/jackrabbit/mk/MoveNodeTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/mk/MoveNodeTest.java?ref=95eb2de3c182b09a44c00a5e1e3b9642a7005f88",
                "patch": "@@ -39,6 +39,7 @@ public MoveNodeTest(String url) {\n     }\n \n     @Before\n+    @Override\n     public void setUp() throws Exception {\n         super.setUp();\n         head = mk.getHeadRevision();",
                "deletions": 0
            },
            {
                "sha": "4918c1b3615f97ba082bb13f98362b227c7f696b",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/mk/index/IndexTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/test/java/org/apache/jackrabbit/mk/index/IndexTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/95eb2de3c182b09a44c00a5e1e3b9642a7005f88/oak-core/src/test/java/org/apache/jackrabbit/mk/index/IndexTest.java",
                "status": "modified",
                "changes": 24,
                "additions": 24,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/mk/index/IndexTest.java?ref=95eb2de3c182b09a44c00a5e1e3b9642a7005f88",
                "patch": "@@ -90,6 +90,30 @@ public void move() {\n         Assert.assertEquals(\"/moved/test2\", index.getPath(\"2\", mk.getHeadRevision()));\n     }\n \n+    @Test\n+    public void copy() {\n+        Indexer indexer = new Indexer(mk);\n+        PropertyIndex index = indexer.createPropertyIndex(\"id\", false);\n+\n+        mk.commit(\"/\", \"+ \\\"test\\\": { \\\"test2\\\": { \\\"id\\\": 2 }, \\\"id\\\": 1 }\", mk.getHeadRevision(), \"\");\n+        Assert.assertEquals(\"/test\", index.getPath(\"1\", mk.getHeadRevision()));\n+        Assert.assertEquals(\"/test/test2\", index.getPath(\"2\", mk.getHeadRevision()));\n+\n+        mk.commit(\"/\", \"* \\\"test\\\": \\\"copied\\\"\", mk.getHeadRevision(), \"\");\n+        Iterator<String> it = index.getPaths(\"1\", mk.getHeadRevision());\n+        Assert.assertTrue(it.hasNext());\n+        Assert.assertEquals(\"/copied\", it.next());\n+        Assert.assertTrue(it.hasNext());\n+        Assert.assertEquals(\"/test\", it.next());\n+        Assert.assertFalse(it.hasNext());\n+        it = index.getPaths(\"2\", mk.getHeadRevision());\n+        Assert.assertTrue(it.hasNext());\n+        Assert.assertEquals(\"/copied/test2\", it.next());\n+        Assert.assertTrue(it.hasNext());\n+        Assert.assertEquals(\"/test/test2\", it.next());\n+        Assert.assertFalse(it.hasNext());\n+    }\n+\n     @Test\n     public void ascending() {\n         Indexer indexer = new Indexer(mk);",
                "deletions": 0
            }
        ],
        "patched_files": [
            "Index.java",
            "SimpleKernelImpl.java",
            "Indexer.java"
        ],
        "unit_tests": [
            "MoveNodeTest.java",
            "IndexTest.java"
        ]
    },
    "jackrabbit-oak_0a4a05c": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7508: Text extraction timeout can lead to NPE\n\nAdding license (broken build reported at OAK-7514)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1832392 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/0a4a05cc132e2959c083446141d964b5a3b4b52d",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/8489fc4bd3591a7664b39627e689d162313a1c40",
        "bug_id": "jackrabbit-oak_0a4a05c",
        "file": [
            {
                "sha": "3c5d9bb40ce168f6259749e1e8b86ed8aa48d84d",
                "filename": "oak-search/src/test/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCacheTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0a4a05cc132e2959c083446141d964b5a3b4b52d/oak-search/src/test/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCacheTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0a4a05cc132e2959c083446141d964b5a3b4b52d/oak-search/src/test/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCacheTest.java",
                "status": "modified",
                "changes": 19,
                "additions": 19,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-search/src/test/java/org/apache/jackrabbit/oak/plugins/index/search/ExtractedTextCacheTest.java?ref=0a4a05cc132e2959c083446141d964b5a3b4b52d",
                "patch": "@@ -1,3 +1,22 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n package org.apache.jackrabbit.oak.plugins.index.search;\n \n import org.apache.commons.io.FileUtils;",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ExtractedTextCache.java"
        ],
        "unit_tests": [
            "ExtractedTextCacheTest.java"
        ]
    },
    "jackrabbit-oak_b94fb97": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8656: ListenerStatsData.toCompositeData() throws NPE\n\nApply slightly modified patch provided by Jos\u00e9 Cordero\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1867773 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/b94fb97bbc47db4fce681c7f367da1616f15399c",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/c78ed7ee17e37b661ebbd8aacec5079f83493bd4",
        "bug_id": "jackrabbit-oak_b94fb97",
        "file": [
            {
                "sha": "8f4d3e76fd195724d7edb9e04ff971dfd0d2f157",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b94fb97bbc47db4fce681c7f367da1616f15399c/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b94fb97bbc47db4fce681c7f367da1616f15399c/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanImpl.java",
                "status": "modified",
                "changes": 14,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanImpl.java?ref=b94fb97bbc47db4fce681c7f367da1616f15399c",
                "patch": "@@ -417,13 +417,13 @@ CompositeDataSupport toCompositeData() {\n                     mbeans.changeProcessorMBean == null ? -1 : mbeans.changeProcessorMBean.getPrefilterSkipCount(),\n                     mbeans.changeProcessorMBean == null ? -1 : mbeans.changeProcessorMBean.getPrefilterExcludeCount(),\n                     mbeans.changeProcessorMBean == null ? -1 : mbeans.changeProcessorMBean.getPrefilterIncludeCount(),\n-                    mbeans.observerMBean.getQueueSize(),\n-                    mbeans.observerMBean.getLocalEventCount(),\n-                    mbeans.observerMBean.getExternalEventCount(),\n-                    Arrays.toString(mbeans.filterConfigMBean.getPaths()),\n-                    mbeans.filterConfigMBean.isIncludeClusterExternal(),\n-                    mbeans.filterConfigMBean.isIncludeClusterLocal(),\n-                    mbeans.observerMBean.getMaxQueueSize(),\n+                    mbeans.observerMBean == null ? -1 : mbeans.observerMBean.getQueueSize(),\n+                    mbeans.observerMBean == null ? -1 : mbeans.observerMBean.getLocalEventCount(),\n+                    mbeans.observerMBean == null ? -1 : mbeans.observerMBean.getExternalEventCount(),\n+                    mbeans.filterConfigMBean == null ? \"n/a\" : Arrays.toString(mbeans.filterConfigMBean.getPaths()),\n+                    mbeans.filterConfigMBean != null && mbeans.filterConfigMBean.isIncludeClusterExternal(),\n+                    mbeans.filterConfigMBean != null && mbeans.filterConfigMBean.isIncludeClusterLocal(),\n+                    mbeans.observerMBean == null ? -1 : mbeans.observerMBean.getMaxQueueSize(),\n             };\n             try {\n                 return new CompositeDataSupport(TYPE, FIELD_NAMES, values);",
                "deletions": 7
            },
            {
                "sha": "4343c54ae03d2573705c0fc066efb64f7608667c",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b94fb97bbc47db4fce681c7f367da1616f15399c/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b94fb97bbc47db4fce681c7f367da1616f15399c/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanTest.java",
                "status": "added",
                "changes": 67,
                "additions": 67,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/observation/ConsolidatedListenerMBeanTest.java?ref=b94fb97bbc47db4fce681c7f367da1616f15399c",
                "patch": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.jackrabbit.oak.jcr.observation;\n+\n+import static org.junit.Assert.assertNotNull;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.jcr.observation.EventIterator;\n+import javax.jcr.observation.EventListener;\n+import javax.management.MalformedObjectNameException;\n+import javax.management.ObjectName;\n+import javax.management.openmbean.TabularData;\n+\n+import org.apache.jackrabbit.api.jmx.EventListenerMBean;\n+import org.apache.jackrabbit.commons.observation.ListenerTracker;\n+import org.junit.Test;\n+\n+public class ConsolidatedListenerMBeanTest {\n+\n+    @Test\n+    public void testListenerStatsData() throws MalformedObjectNameException {\n+        ConsolidatedListenerMBeanImpl consolidatedListener = new ConsolidatedListenerMBeanImpl();\n+\n+        EventListener listener = new Listener(new AtomicInteger());\n+        EventListenerMBean mbean = new ListenerTracker(listener, 0, \"/\", false, null, null, false).getListenerMBean();\n+\n+        Map<String, ObjectName> config = new HashMap<>();\n+        config.put(\"jmx.objectname\", new ObjectName(\"*:*\"));\n+        consolidatedListener.bindListenerMBean(mbean, config);\n+        TabularData data = consolidatedListener.getListenerStats();\n+        assertNotNull(data);\n+    }\n+\n+    private static class Listener implements EventListener {\n+        private final AtomicInteger eventCount;\n+\n+        Listener(AtomicInteger eventCount) {\n+            this.eventCount = eventCount;\n+        }\n+\n+        @Override\n+        public void onEvent(EventIterator events) {\n+            for (; events.hasNext(); events.nextEvent()) {\n+                eventCount.incrementAndGet();\n+            }\n+        }\n+    }\n+}",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ConsolidatedListenerMBean.java",
            "ConsolidatedListenerMBeanImpl.java"
        ],
        "unit_tests": [
            "ConsolidatedListenerMBeanTest.java"
        ]
    },
    "jackrabbit-oak_b997936": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7508: Text extraction timeout can lead to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1832376 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/b997936d972e9b26f6ff276262428a9ddc5bd5ad",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/dbc84d9b0751ec9e6dec8b0244497e0e36a41ccb",
        "bug_id": "jackrabbit-oak_b997936",
        "file": [
            {
                "sha": "c07f1a4709645b82b4ed3f20f519c3a4c9bdaa8c",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java",
                "status": "modified",
                "changes": 7,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCache.java?ref=b997936d972e9b26f6ff276262428a9ddc5bd5ad",
                "patch": "@@ -157,9 +157,12 @@ public void putTimeout(@Nonnull Blob blob, @Nonnull ExtractedText extractedText)\n         if (EXTRACT_FORGET_TIMEOUT) {\n             return;\n         }\n+\n         String id = blob.getContentIdentity();\n-        timeoutMap.put(id, getText(extractedText));\n-        storeTimeoutMap();\n+        if (id != null) {\n+            timeoutMap.put(id, getText(extractedText));\n+            storeTimeoutMap();\n+        }\n     }\n \n     private static String getText(ExtractedText text) {",
                "deletions": 2
            },
            {
                "sha": "d6b06fb716801a44037a1f0da0bc5a1aa447a034",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/b997936d972e9b26f6ff276262428a9ddc5bd5ad/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java",
                "status": "modified",
                "changes": 11,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/ExtractedTextCacheTest.java?ref=b997936d972e9b26f6ff276262428a9ddc5bd5ad",
                "patch": "@@ -185,6 +185,17 @@ public Void call() throws Exception {\n         assertEquals(1, cache.getStatsMBean().getTimeoutCount());\n     }\n \n+    @Test\n+    public void nullContentIdentityBlob() throws Exception {\n+        ExtractedTextCache cache = new ExtractedTextCache(0, 0);\n+        Blob b = new IdBlob(\"hello\", null);\n+        cache.put(b, ExtractedText.ERROR);\n+        assertNull(cache.get(\"/a\", \"foo\", b, false));\n+        cache.putTimeout(b, ExtractedText.ERROR);\n+        assertNull(\"Cache returned non null text for blob with null content identity\",\n+                cache.get(\"/a\", \"foo\", b, false));\n+    }\n+\n     private static class IdBlob extends ArrayBasedBlob {\n         final String id;\n ",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ExtractedTextCache.java"
        ],
        "unit_tests": [
            "ExtractedTextCacheTest.java"
        ]
    },
    "jackrabbit-oak_e094b0d": {
        "repo": "jackrabbit-oak",
        "message": "OAK-7078: NullPointerException in FilteredSortedSetDocValuesFacetCounts during query evaluation\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1819048 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/e094b0d2c7a340a201a522a6d082f71315594ef4",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/16af76e4ba5db12e52686c3579ec1a20124405f1",
        "bug_id": "jackrabbit-oak_e094b0d",
        "file": [
            {
                "sha": "46ac345b87001bc64106ec4b0e5ecaf5e3a016ae",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/FilteredSortedSetDocValuesFacetCounts.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/e094b0d2c7a340a201a522a6d082f71315594ef4/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/FilteredSortedSetDocValuesFacetCounts.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/e094b0d2c7a340a201a522a6d082f71315594ef4/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/FilteredSortedSetDocValuesFacetCounts.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/util/FilteredSortedSetDocValuesFacetCounts.java?ref=e094b0d2c7a340a201a522a6d082f71315594ef4",
                "patch": "@@ -60,6 +60,10 @@ public FilteredSortedSetDocValuesFacetCounts(DefaultSortedSetDocValuesReaderStat\n     public FacetResult getTopChildren(int topN, String dim, String... path) throws IOException {\n         FacetResult topChildren = super.getTopChildren(topN, dim, path);\n \n+        if (topChildren == null) {\n+            return null;\n+        }\n+\n         LabelAndValue[] labelAndValues = topChildren.labelValues;\n \n         for (ScoreDoc scoreDoc : docs.scoreDocs) {",
                "deletions": 0
            },
            {
                "sha": "63d01e0e5d092727c2d4c0c38c15bd5bf8b7c899",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/e094b0d2c7a340a201a522a6d082f71315594ef4/oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/e094b0d2c7a340a201a522a6d082f71315594ef4/oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java",
                "status": "modified",
                "changes": 31,
                "additions": 31,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/jcr/query/FacetTest.java?ref=e094b0d2c7a340a201a522a6d082f71315594ef4",
                "patch": "@@ -25,6 +25,8 @@\n import javax.jcr.query.Query;\n import javax.jcr.query.QueryManager;\n import javax.jcr.query.QueryResult;\n+import javax.jcr.query.RowIterator;\n+import java.util.ArrayList;\n import java.util.List;\n \n import org.apache.jackrabbit.core.query.AbstractQueryTest;\n@@ -602,6 +604,35 @@ public void testFacetRetrievalNumberOfFacetsConfiguredLowerThanDefault() throws\n         assertEquals(7, facets.size());\n     }\n \n+    // OAK-7078\n+    public void testFacetsOfResultSetThatDoesntContainDim() throws Exception {\n+        Node content = testRootNode.addNode(\"absentDimFacets\");\n+\n+        // create a document with a simple/tags property\n+        Node foo = content.addNode(\"foo\");\n+        Node fooSimple = foo.addNode(\"jc\");\n+        foo.setProperty(\"text\", \"lorem lorem\");\n+        fooSimple.setProperty(\"text\", new String[]{\"tag1\", \"tag2\"});\n+        // now create a document without simple/tags property\n+        Node bar = content.addNode(\"bar\");\n+        bar.setProperty(\"text\", \"lorem ipsum\");\n+\n+        superuser.save();\n+\n+        String query = \"select [rep:facet(jc/text)] from [nt:base] where contains(*, 'ipsum')\";\n+\n+        Query q = qm.createQuery(query, Query.JCR_SQL2);\n+        QueryResult result = q.execute();\n+        FacetResult facetResult = new FacetResult(result);\n+        assertNotNull(facetResult);\n+        assertTrue(facetResult.getDimensions().isEmpty());\n+\n+        RowIterator rows = result.getRows();\n+        assertTrue(rows.hasNext());\n+        assertEquals(bar.getPath(), rows.nextRow().getPath());\n+        assertFalse(rows.hasNext());\n+    }\n+\n     private void markIndexForReindex() throws RepositoryException {\n         superuser.getNode(\"/oak:index/luceneGlobal\").setProperty(REINDEX_PROPERTY_NAME, true);\n     }",
                "deletions": 0
            }
        ],
        "patched_files": [
            "FilteredSortedSetDocValuesFacetCounts.java"
        ],
        "unit_tests": [
            "FacetTest.java"
        ]
    },
    "jackrabbit-oak_c8000c1": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1173 : NPE if TreePermissionImpl if tree does not have a primary type\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1541452 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/c8000c14cfaaecc183bfee8773552ef0837a52ef",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/c9c85507704868cbb37287b26b4ebada1d938e34",
        "bug_id": "jackrabbit-oak_c8000c1",
        "file": [
            {
                "sha": "c9d0fa0f2ba2827102371d98523457657859ce5c",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/CompiledPermissionImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c8000c14cfaaecc183bfee8773552ef0837a52ef/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/CompiledPermissionImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c8000c14cfaaecc183bfee8773552ef0837a52ef/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/CompiledPermissionImpl.java",
                "status": "modified",
                "changes": 5,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/CompiledPermissionImpl.java?ref=c8000c14cfaaecc183bfee8773552ef0837a52ef",
                "patch": "@@ -157,7 +157,10 @@ public TreePermission getTreePermission(@Nonnull ImmutableTree tree, @Nonnull Tr\n                 // TODO: OAK-753 decide on where to filter out hidden items.\n                 return TreePermission.ALL;\n             case TreeTypeProvider.TYPE_VERSION:\n-                String ntName = checkNotNull(TreeUtil.getPrimaryTypeName(tree));\n+                String ntName = TreeUtil.getPrimaryTypeName(tree);\n+                if (ntName == null) {\n+                    return TreePermission.EMPTY;\n+                }\n                 if (VersionConstants.VERSION_STORE_NT_NAMES.contains(ntName) || VersionConstants.NT_ACTIVITY.equals(ntName)) {\n                     return new TreePermissionImpl(tree, TreeTypeProvider.TYPE_VERSION, parentPermission);\n                 } else {",
                "deletions": 1
            },
            {
                "sha": "b5916a1bc15f1593df3e6126dedae3ff9178f6db",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/VersionStorageTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/c8000c14cfaaecc183bfee8773552ef0837a52ef/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/VersionStorageTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/c8000c14cfaaecc183bfee8773552ef0837a52ef/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/VersionStorageTest.java",
                "status": "added",
                "changes": 148,
                "additions": 148,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/evaluation/VersionStorageTest.java?ref=c8000c14cfaaecc183bfee8773552ef0837a52ef",
                "patch": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.security.authorization.evaluation;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.security.AccessControlEntry;\n+import javax.jcr.security.AccessControlManager;\n+\n+import org.apache.jackrabbit.JcrConstants;\n+import org.apache.jackrabbit.api.security.JackrabbitAccessControlList;\n+import org.apache.jackrabbit.commons.jackrabbit.authorization.AccessControlUtils;\n+import org.apache.jackrabbit.oak.Oak;\n+import org.apache.jackrabbit.oak.api.Root;\n+import org.apache.jackrabbit.oak.api.Tree;\n+import org.apache.jackrabbit.oak.plugins.nodetype.ReadOnlyNodeTypeManager;\n+import org.apache.jackrabbit.oak.plugins.version.ReadOnlyVersionManager;\n+import org.apache.jackrabbit.oak.plugins.version.VersionConstants;\n+import org.apache.jackrabbit.oak.plugins.version.VersionEditorProvider;\n+import org.apache.jackrabbit.oak.spi.security.privilege.PrivilegeConstants;\n+import org.apache.jackrabbit.oak.util.TreeUtil;\n+import org.junit.Test;\n+\n+import static org.apache.jackrabbit.oak.plugins.nodetype.NodeTypeConstants.NODE_TYPES_PATH;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Tests related to permission evaluation within the version storage.\n+ */\n+public class VersionStorageTest extends AbstractOakCoreTest {\n+\n+    private String vhPath;\n+\n+    @Override\n+    public void before() throws Exception {\n+        super.before();\n+\n+        // make sure the version storage has been setup\n+        Tree a = root.getTree(\"/a\");\n+        TreeUtil.addMixin(a, JcrConstants.MIX_VERSIONABLE, root.getTree(NODE_TYPES_PATH), adminSession.getAuthInfo().getUserID());\n+        root.commit();\n+\n+        Tree vs = root.getTree(VersionConstants.VERSION_STORE_PATH);\n+        assertTrue(vs.exists());\n+        String vhUUID = TreeUtil.getString(a, VersionConstants.JCR_VERSIONHISTORY);\n+        assertNotNull(vhUUID);\n+\n+        String versionableUuid = TreeUtil.getString(a, JcrConstants.JCR_UUID);\n+        vhPath = getVersionHistoryPath(versionableUuid, vs);\n+    }\n+\n+    private String getVersionHistoryPath(String vUUID, final Tree vs) {\n+        ReadOnlyVersionManager vMgr = new ReadOnlyVersionManager() {\n+            @Nonnull\n+            @Override\n+            protected Tree getVersionStorage() {\n+                return vs;\n+            }\n+\n+            @Nonnull\n+            @Override\n+            protected Root getWorkspaceRoot() {\n+                return root;\n+            }\n+\n+            @Nonnull\n+            @Override\n+            protected ReadOnlyNodeTypeManager getNodeTypeManager() {\n+                throw new UnsupportedOperationException();\n+            }\n+        };\n+        return VersionConstants.VERSION_STORE_PATH + '/' + vMgr.getVersionHistoryPath(vUUID);\n+    }\n+\n+    @Override\n+    public void after() throws Exception {\n+        AccessControlManager acMgr = getAccessControlManager(root);\n+        JackrabbitAccessControlList acl = AccessControlUtils.getAccessControlList(acMgr, \"/\");\n+        for (AccessControlEntry ace : acl.getAccessControlEntries()) {\n+            if (testPrincipal.equals(ace.getPrincipal())) {\n+                acl.removeAccessControlEntry(ace);\n+            }\n+        }\n+        acMgr.setPolicy(\"/\", acl);\n+        root.commit();\n+    }\n+\n+    @Override\n+    protected Oak withEditors(Oak oak) {\n+        return oak.with(new VersionEditorProvider());\n+    }\n+\n+    @Test\n+    public void testGetVersionStorage() throws Exception {\n+        Tree vs = getTestRoot().getTree(VersionConstants.VERSION_STORE_PATH);\n+        assertFalse(vs.exists());\n+    }\n+\n+    @Test\n+    public void testGetVersionStorage2() throws Exception {\n+        setupPermission(\"/\", testPrincipal, true, PrivilegeConstants.JCR_READ);\n+\n+        Tree vs = getTestRoot().getTree(VersionConstants.VERSION_STORE_PATH);\n+        assertTrue(vs.exists());\n+    }\n+\n+    @Test\n+    public void testGetVersionHistory() throws Exception {\n+        Tree vs = getTestRoot().getTree(vhPath);\n+        assertFalse(vs.exists());\n+    }\n+\n+    @Test\n+    public void testGetVersionHistory2() throws Exception {\n+        setupPermission(\"/\", testPrincipal, true, PrivilegeConstants.JCR_READ);\n+\n+        Tree vs = getTestRoot().getTree(vhPath);\n+        assertTrue(vs.exists());\n+    }\n+\n+    @Test\n+    public void testGetChildrenCountOnVersionStorage() throws Exception {\n+        Tree vs = getTestRoot().getTree(VersionConstants.VERSION_STORE_PATH);\n+        vs.getChildrenCount(Long.MAX_VALUE);\n+    }\n+\n+    @Test\n+    public void testGetChildrenCountOnVersionStorage2() throws Exception {\n+        setupPermission(\"/\", testPrincipal, true, PrivilegeConstants.JCR_READ);\n+        Tree vs = getTestRoot().getTree(VersionConstants.VERSION_STORE_PATH);\n+        vs.getChildrenCount(Long.MAX_VALUE);\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "CompiledPermissionImpl.java",
            "VersionStorage.java"
        ],
        "unit_tests": [
            "VersionStorageTest.java"
        ]
    },
    "jackrabbit-oak_5320dc0": {
        "repo": "jackrabbit-oak",
        "message": "OAK-642: NPE trying to add a node to an nt:folder node\nfix test expectation\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1447939 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5320dc096065db80daed31e620db835baf96b0d2",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/1aa40c6c3bcef1a952eaca2f86a6e41cbbf3796a",
        "bug_id": "jackrabbit-oak_5320dc0",
        "file": [
            {
                "sha": "deb057f7c71d4bfc121b641ef2651d2d1cc59b3f",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5320dc096065db80daed31e620db835baf96b0d2/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5320dc096065db80daed31e620db835baf96b0d2/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java?ref=5320dc096065db80daed31e620db835baf96b0d2",
                "patch": "@@ -22,6 +22,7 @@\n import javax.jcr.Property;\n import javax.jcr.RepositoryException;\n import javax.jcr.Session;\n+import javax.jcr.nodetype.ConstraintViolationException;\n \n import org.junit.Ignore;\n import org.junit.Test;\n@@ -117,7 +118,7 @@ public void testRootPropertyPath() throws RepositoryException {\n         assertEquals(\"/jcr:primaryType\", property.getPath());\n     }\n     \n-    @Test\n+    @Test(expected = ConstraintViolationException.class)\n     @Ignore(\"OAK-642\")\n     public void nodeType() throws RepositoryException {\n             Session s = getAdminSession();",
                "deletions": 1
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "CRUDTest.java"
        ]
    },
    "jackrabbit-oak_01ee66a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-781: Clarify / fix effects of MISSING_NODE as base state of NodeBuilder\nDisallow removing root node. Avoid NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1493222 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/01ee66aef3ff08ddf94b357eb0773a338d4b8374",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/4b0b2d010afc72d98e7d29074e3b96e4062bd2df",
        "bug_id": "jackrabbit-oak_01ee66a",
        "file": [
            {
                "sha": "07decb1eaa5a750e8eda5aa525edd4e4d51dc638",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/01ee66aef3ff08ddf94b357eb0773a338d4b8374/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/01ee66aef3ff08ddf94b357eb0773a338d4b8374/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilder.java?ref=01ee66aef3ff08ddf94b357eb0773a338d4b8374",
                "patch": "@@ -269,7 +269,7 @@ public NodeBuilder setChildNode(String name, NodeState state) {\n \n     @Override\n     public boolean remove() {\n-        if (exists()) {\n+        if (!isRoot() && exists()) {\n             head().getMutableNodeState();  // Make sure the removed node is connected\n             parent.head().getMutableNodeState().removeChildNode(name);\n             return true;",
                "deletions": 1
            },
            {
                "sha": "22f309bf882b8e17c3c87e52e1b3a7e9d1292ba6",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilderTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/01ee66aef3ff08ddf94b357eb0773a338d4b8374/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilderTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/01ee66aef3ff08ddf94b357eb0773a338d4b8374/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilderTest.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/memory/MemoryNodeBuilderTest.java?ref=01ee66aef3ff08ddf94b357eb0773a338d4b8374",
                "patch": "@@ -447,6 +447,11 @@ public void navigateNonExistingNode() {\n         assertTrue(c.hasProperty(\"c2\"));\n     }\n \n+    @Test\n+    public void removeRoot() {\n+        assertFalse(base.builder().remove());\n+    }\n+\n     private static NodeState createBC(final boolean exists) {\n         final NodeState C = new MemoryNodeBuilder(EmptyNodeState.EMPTY_NODE)\n             .setProperty(\"c\", \"cValue\")",
                "deletions": 0
            }
        ],
        "patched_files": [
            "MemoryNodeBuilder.java"
        ],
        "unit_tests": [
            "MemoryNodeBuilderTest.java"
        ]
    },
    "jackrabbit-oak_941571b": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1817 - NPE in MarkSweepGarbageCollector.saveBatchToFile during Datastore GC with FileDataStore\n\nModified the testcase which reproduces the original issue. Looks like creating large number of blob causes issue with blob ref accounting logic\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1596474 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/941571bd2fe530be820ae6444e72eaabc17ffb6e",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/3f69427a0ce433b7d711a3b7651f5ccd8560e860",
        "bug_id": "jackrabbit-oak_941571b",
        "file": [
            {
                "sha": "715f0a7272f086a243ef33f25c8deedbfa6a9960",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/941571bd2fe530be820ae6444e72eaabc17ffb6e/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/941571bd2fe530be820ae6444e72eaabc17ffb6e/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "status": "modified",
                "changes": 14,
                "additions": 12,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java?ref=941571bd2fe530be820ae6444e72eaabc17ffb6e",
                "patch": "@@ -44,6 +44,7 @@\n import java.util.Random;\n \n import static junit.framework.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertNull;\n \n@@ -81,6 +82,7 @@ public void testDataStoreBlob() throws Exception {\n         is.close();\n     }\n \n+    @Ignore(\"OAK-1817\")\n     @Test\n     public void testNullBlobId() throws Exception{\n         FileDataStore fds = createFileDataStore();\n@@ -90,8 +92,14 @@ public void testNullBlobId() throws Exception{\n         NodeBuilder nb = nodeStore.getRoot().builder();\n         NodeBuilder cb = nb.child(\"hello\");\n         cb.setProperty(\"blob1\", createBlob(Segment.MEDIUM_LIMIT - 1));\n-        cb.setProperty(\"blob2\", createBlob(Segment.MEDIUM_LIMIT + 1));\n-        cb.setProperty(\"blob3\", createBlob(Segment.MEDIUM_LIMIT + 1));\n+\n+        int noOfBlobs = 4000;\n+        for(int i = 0; i < noOfBlobs; i++){\n+            cb.setProperty(\"blob\"+i, createBlob(Segment.MEDIUM_LIMIT+1));\n+        }\n+\n+        cb.setProperty(\"anotherBlob2\", createBlob(Segment.MEDIUM_LIMIT + 1));\n+        cb.setProperty(\"anotherBlob3\", createBlob(Segment.MEDIUM_LIMIT + 1));\n         nodeStore.merge(nb, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n \n         final List<String> refrences = Lists.newArrayList();\n@@ -102,6 +110,8 @@ public void addReference(String reference) {\n                 refrences.add(reference);\n             }\n         });\n+\n+        assertEquals(noOfBlobs + 2, refrences.size());\n     }\n \n     private Blob testCreateAndRead(Blob blob) throws Exception {",
                "deletions": 2
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "ExternalBlobTest.java"
        ]
    },
    "jackrabbit-oak_fb31aec": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1877: Hourly async reindexing on an idle instance\n - added null check to comply with the #release apis, and prevent an eventual NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1602207 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/fb31aecc28238d02797722083e2f0e3cad532715",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/40b75b38b369f145ea018f258c114a95559acec9",
        "bug_id": "jackrabbit-oak_fb31aec",
        "file": [
            {
                "sha": "d52c43090dfce297c6d957326d68ec6456d6b399",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/fb31aecc28238d02797722083e2f0e3cad532715/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/fb31aecc28238d02797722083e2f0e3cad532715/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java",
                "status": "modified",
                "changes": 9,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/index/AsyncIndexUpdate.java?ref=fb31aecc28238d02797722083e2f0e3cad532715",
                "patch": "@@ -236,9 +236,12 @@ public synchronized void run() {\n                     name, checkpoint);\n             store.release(checkpoint);\n         } else {\n-            log.debug(\"The {} index update succeeded; releasing the previous checkpoint {}\",\n-                    name, refCheckpoint);\n-            store.release(refCheckpoint);\n+            if (refCheckpoint != null) {\n+                log.debug(\n+                        \"The {} index update succeeded; releasing the previous checkpoint {}\",\n+                        name, refCheckpoint);\n+                store.release(refCheckpoint);\n+            }\n         }\n \n         if (exception != null) {",
                "deletions": 3
            }
        ],
        "patched_files": [
            "AsyncIndexUpdate.java"
        ],
        "unit_tests": [
            "AsyncIndexUpdateTest.java"
        ]
    },
    "jackrabbit-oak_53f884a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-677: Property events on root node fail with NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1453359 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/53f884a3739d2feea0aae5543caaf47966cf9deb",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/50b189f0c3b6228a4867653202a6cc785dc5c3d7",
        "bug_id": "jackrabbit-oak_53f884a",
        "file": [
            {
                "sha": "00ba65e5facc0966ec355d20f65fab405ddebcb4",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/53f884a3739d2feea0aae5543caaf47966cf9deb/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/53f884a3739d2feea0aae5543caaf47966cf9deb/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/core/ReadOnlyTree.java?ref=53f884a3739d2feea0aae5543caaf47966cf9deb",
                "patch": "@@ -51,7 +51,7 @@\n      */\n     private final NodeState state;\n \n-    public ReadOnlyTree(NodeState rootState) {\n+    public ReadOnlyTree(@Nonnull NodeState rootState) {\n         this(null, \"\", rootState);\n     }\n ",
                "deletions": 1
            },
            {
                "sha": "970793f249cab08ea916d8173dee6b65243fa7d3",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeFilter.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/53f884a3739d2feea0aae5543caaf47966cf9deb/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeFilter.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/53f884a3739d2feea0aae5543caaf47966cf9deb/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeFilter.java",
                "status": "modified",
                "changes": 5,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/ChangeFilter.java?ref=53f884a3739d2feea0aae5543caaf47966cf9deb",
                "patch": "@@ -61,10 +61,11 @@ public ChangeFilter(ReadOnlyNodeTypeManager ntMgr,\n         this.noLocal = noLocal;\n     }\n \n-    public boolean include(int eventType, String path, NodeState associatedParentNode) {\n+    public boolean include(int eventType, String path, @Nullable NodeState associatedParentNode) {\n         return include(eventType)\n                 && include(path)\n-                && includeByType(new ReadOnlyTree(associatedParentNode));\n+                && (associatedParentNode == null\n+                    || includeByType(new ReadOnlyTree(associatedParentNode)));\n     }\n \n     public boolean includeChildren(String path) {",
                "deletions": 2
            },
            {
                "sha": "4e186b69a615474c03661ba229374b153b3f943d",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/53f884a3739d2feea0aae5543caaf47966cf9deb/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/53f884a3739d2feea0aae5543caaf47966cf9deb/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java",
                "status": "modified",
                "changes": 1,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/RepositoryTest.java?ref=53f884a3739d2feea0aae5543caaf47966cf9deb",
                "patch": "@@ -2072,7 +2072,6 @@ public Void call() throws Exception {\n     }\n \n     @Test\n-    @Ignore(\"OAK-677\")\n     public void observationOnRootNode() throws Exception {\n         final AtomicReference<CountDownLatch> hasEvents = new AtomicReference<CountDownLatch>(new CountDownLatch(1));\n         Session observingSession = createAdminSession();",
                "deletions": 1
            }
        ],
        "patched_files": [
            "ChangeFilter.java",
            "ReadOnlyTree.java",
            "Repository.java"
        ],
        "unit_tests": [
            "ReadOnlyTreeTest.java",
            "RepositoryTest.java"
        ]
    },
    "jackrabbit-oak_3b2a979": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2691: Blob GC throws NPE\n\nChecking existence of :clusterId property before retrieving\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1669992 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/64c57bd4a8a86e5f257422eaae38834397ba8aae",
        "bug_id": "jackrabbit-oak_3b2a979",
        "file": [
            {
                "sha": "d2755eb3359864572846b7bb310012dd2fc81e76",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java",
                "status": "modified",
                "changes": 10,
                "additions": 9,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/identifier/ClusterRepositoryInfo.java?ref=3b2a979e5eef29cdcf35c20b7be1975d45ff8b16",
                "patch": "@@ -23,8 +23,11 @@\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n import org.apache.jackrabbit.oak.spi.commit.EmptyHook;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n \n+import javax.annotation.CheckForNull;\n+\n /**\n  * Utility class to manage a unique cluster/repository id for the cluster.\n  */\n@@ -57,8 +60,13 @@ public static String createId(NodeStore store) throws CommitFailedException {\n      * @param store the NodeStore instance\n      * @return the repository id\n      */\n+    @CheckForNull\n     public static String getId(NodeStore store) {\n-        return store.getRoot().getChildNode(CLUSTER_CONFIG_NODE).getProperty(CLUSTER_ID_PROP).getValue(Type.STRING);\n+        NodeState state = store.getRoot().getChildNode(CLUSTER_CONFIG_NODE);\n+        if (state.hasProperty(CLUSTER_ID_PROP)) {\n+            return state.getProperty(CLUSTER_ID_PROP).getValue(Type.STRING);\n+        }\n+        return null;\n     }\n }\n ",
                "deletions": 1
            },
            {
                "sha": "eb27670bcecdf33bd66e64772bfe2b1e2189de8d",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/3b2a979e5eef29cdcf35c20b7be1975d45ff8b16/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java",
                "status": "modified",
                "changes": 13,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/blob/ClusterRepositoryInfoTest.java?ref=3b2a979e5eef29cdcf35c20b7be1975d45ff8b16",
                "patch": "@@ -93,6 +93,19 @@ public void sameCluster() throws Exception {\n         Assert.assertEquals(repoId1, repoId2);\n     }\n \n+    @Test\n+    public void checkGetIdWhenNotRegistered() {\n+        MemoryDocumentStore store = new MemoryDocumentStore();\n+        DocumentNodeStore ds1 = new DocumentMK.Builder()\n+            .setAsyncDelay(0)\n+            .setDocumentStore(store)\n+            .setClusterId(1)\n+            .getNodeStore();\n+        // Should be null and no NPE\n+        String id = ClusterRepositoryInfo.getId(ds1);\n+        Assert.assertNull(id);\n+    }\n+\n     @After\n     public void close() throws IOException {\n         FileUtils.cleanDirectory(new File(DataStoreUtils.getHomeDir()));",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ClusterRepositoryInfo.java"
        ],
        "unit_tests": [
            "ClusterRepositoryInfoTest.java"
        ]
    },
    "jackrabbit-oak_09b75c7": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1817 - NPE in MarkSweepGarbageCollector.saveBatchToFile during Datastore GC with FileDataStore\n\nAdding testcase to try to reproduce the issue\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1596241 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/09b75c7ef70827361c2d34cdaf1e9ee9c656c732",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/7b2fe52eafdaa83730b88517bf13b9d296536750",
        "bug_id": "jackrabbit-oak_09b75c7",
        "file": [
            {
                "sha": "13064a60c48f5064c071f1b6449ab38384d11a29",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/09b75c7ef70827361c2d34cdaf1e9ee9c656c732/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/09b75c7ef70827361c2d34cdaf1e9ee9c656c732/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java",
                "status": "modified",
                "changes": 50,
                "additions": 42,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/ExternalBlobTest.java?ref=09b75c7ef70827361c2d34cdaf1e9ee9c656c732",
                "patch": "@@ -16,11 +16,12 @@\n  */\n package org.apache.jackrabbit.oak.plugins.segment;\n \n+import com.google.common.collect.Lists;\n import org.apache.commons.io.FileUtils;\n import org.apache.commons.io.IOUtils;\n-import org.apache.jackrabbit.core.data.DataIdentifier;\n import org.apache.jackrabbit.core.data.FileDataStore;\n import org.apache.jackrabbit.oak.api.Blob;\n+import org.apache.jackrabbit.oak.plugins.blob.ReferenceCollector;\n import org.apache.jackrabbit.oak.plugins.blob.datastore.DataStoreBlobStore;\n import org.apache.jackrabbit.oak.plugins.memory.AbstractBlob;\n import org.apache.jackrabbit.oak.plugins.segment.file.FileBlob;\n@@ -39,6 +40,7 @@\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.util.List;\n import java.util.Random;\n \n import static junit.framework.Assert.assertTrue;\n@@ -59,16 +61,12 @@ public void testFileBlob() throws Exception {\n \n     @Test\n     public void testDataStoreBlob() throws Exception {\n-        FileDataStore fds = new FileDataStore();\n-        fds.setMinRecordLength(4092);\n-        fds.init(getWorkDir().getAbsolutePath());\n+        FileDataStore fds = createFileDataStore();\n         DataStoreBlobStore dbs = new DataStoreBlobStore(fds);\n         nodeStore = getNodeStore(dbs);\n \n         //Test for Blob which get inlined\n-        byte[] data = new byte[fds.getMinRecordLength()-2];\n-        new Random().nextBytes(data);\n-        Blob b1 = testCreateAndRead(nodeStore.createBlob(new ByteArrayInputStream(data)));\n+        Blob b1 = testCreateAndRead(createBlob(fds.getMinRecordLength()-2));\n         assertTrue(b1 instanceof SegmentBlob);\n         assertNull(((SegmentBlob) b1).getBlobId());\n \n@@ -83,7 +81,30 @@ public void testDataStoreBlob() throws Exception {\n         is.close();\n     }\n \n-    public Blob testCreateAndRead(Blob blob) throws Exception {\n+    @Test\n+    public void testNullBlobId() throws Exception{\n+        FileDataStore fds = createFileDataStore();\n+        DataStoreBlobStore dbs = new DataStoreBlobStore(fds);\n+        nodeStore = getNodeStore(dbs);\n+\n+        NodeBuilder nb = nodeStore.getRoot().builder();\n+        NodeBuilder cb = nb.child(\"hello\");\n+        cb.setProperty(\"blob1\", createBlob(Segment.MEDIUM_LIMIT - 1));\n+        cb.setProperty(\"blob2\", createBlob(Segment.MEDIUM_LIMIT + 1));\n+        cb.setProperty(\"blob3\", createBlob(Segment.MEDIUM_LIMIT + 1));\n+        nodeStore.merge(nb, EmptyHook.INSTANCE, CommitInfo.EMPTY);\n+\n+        final List<String> refrences = Lists.newArrayList();\n+        store.getTracker().collectBlobReferences(new ReferenceCollector() {\n+            @Override\n+            public void addReference(String reference) {\n+                assertNotNull(reference);\n+                refrences.add(reference);\n+            }\n+        });\n+    }\n+\n+    private Blob testCreateAndRead(Blob blob) throws Exception {\n         NodeState state = nodeStore.getRoot().getChildNode(\"hello\");\n         if (!state.exists()) {\n             NodeBuilder builder = nodeStore.getRoot().builder();\n@@ -119,6 +140,19 @@ protected SegmentNodeStore getNodeStore(BlobStore blobStore) throws IOException\n         return nodeStore;\n     }\n \n+    private Blob createBlob(int size) throws IOException {\n+        byte[] data = new byte[size];\n+        new Random().nextBytes(data);\n+        return nodeStore.createBlob(new ByteArrayInputStream(data));\n+    }\n+\n+    private FileDataStore createFileDataStore() {\n+        FileDataStore fds = new FileDataStore();\n+        fds.setMinRecordLength(4092);\n+        fds.init(getWorkDir().getAbsolutePath());\n+        return fds;\n+    }\n+\n     private File getWorkDir(){\n         return new File(\"target\", \"ExternalBlobTest\");\n     }",
                "deletions": 8
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "ExternalBlobTest.java"
        ]
    },
    "jackrabbit-oak_d3fea45": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2363: NPE in DocumentNodeStore#retrieve for non existing checkpoint\nAdd null check and test case\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1646236 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/66195240e9c895d3f0940e2754a7b505166c8156",
        "bug_id": "jackrabbit-oak_d3fea45",
        "file": [
            {
                "sha": "5c519c2e693db549b494349202210e41511f0639",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java",
                "status": "modified",
                "changes": 5,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/document/DocumentNodeStore.java?ref=d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7",
                "patch": "@@ -39,6 +39,7 @@\n import java.util.Map;\n import java.util.NavigableSet;\n import java.util.Set;\n+import java.util.SortedMap;\n import java.util.TimeZone;\n import java.util.concurrent.Callable;\n import java.util.concurrent.ConcurrentHashMap;\n@@ -70,6 +71,7 @@\n import org.apache.jackrabbit.oak.commons.json.JsopTokenizer;\n import org.apache.jackrabbit.oak.plugins.blob.BlobStoreBlob;\n import org.apache.jackrabbit.oak.plugins.blob.MarkSweepGarbageCollector;\n+import org.apache.jackrabbit.oak.plugins.document.Checkpoints.Info;\n import org.apache.jackrabbit.oak.plugins.document.mongo.MongoBlobReferenceIterator;\n import org.apache.jackrabbit.oak.plugins.document.mongo.MongoDocumentStore;\n import org.apache.jackrabbit.oak.plugins.document.persistentCache.PersistentCache;\n@@ -1404,7 +1406,8 @@ public String checkpoint(long lifetime) {\n     @Override\n     public NodeState retrieve(@Nonnull String checkpoint) {\n         Revision r = Revision.fromString(checkpoint);\n-        if (checkpoints.getCheckpoints().containsKey(r)) {\n+        SortedMap<Revision, Info> checkpoints = this.checkpoints.getCheckpoints();\n+        if (checkpoints != null && checkpoints.containsKey(r)) {\n             return getRoot(r);\n         } else {\n             return null;",
                "deletions": 1
            },
            {
                "sha": "f9fc298470d5ad2e4162cfdd1c69031a66880856",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/CheckpointTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/CheckpointTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/CheckpointTest.java",
                "status": "modified",
                "changes": 5,
                "additions": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/kernel/CheckpointTest.java?ref=d3fea45b096fa2a6f66bb529ed145ae8c7bb01e7",
                "patch": "@@ -107,4 +107,9 @@ public void checkpointInfo() throws CommitFailedException {\n         assertEquals(props, store.checkpointInfo(cp));\n     }\n \n+    @Test\n+    public void retrieveAny() {\n+        assertTrue(store.retrieve(\"r42-0-0\") == null);\n+    }\n+\n }",
                "deletions": 0
            }
        ],
        "patched_files": [
            "DocumentNodeStore.java"
        ],
        "unit_tests": [
            "CheckpointTest.java",
            "DocumentNodeStoreTest.java"
        ]
    },
    "jackrabbit-oak_1a1e8ba": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2880: NPE in SegmentWriter.writeMap\nTest case and fix: ignore null keys that are not present in the base map\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1681955 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/1a1e8bad9305895763693b650e91dbce39908e42",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/f5513256cddf7af2e41e27a39c141396c3b82dbe",
        "bug_id": "jackrabbit-oak_1a1e8ba",
        "file": [
            {
                "sha": "abab3d489f24db12d6983aecb72d3f8f2668bf78",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1a1e8bad9305895763693b650e91dbce39908e42/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1a1e8bad9305895763693b650e91dbce39908e42/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "status": "modified",
                "changes": 6,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java?ref=1a1e8bad9305895763693b650e91dbce39908e42",
                "patch": "@@ -701,11 +701,13 @@ MapRecord writeMap(MapRecord base, Map<String, RecordId> changes) {\n                     keyId = e.getKey();\n                 }\n             }\n-            if (keyId == null) {\n+            if (keyId == null && entry.getValue() != null) {\n                 keyId = writeString(key);\n             }\n \n-            entries.add(new MapEntry(key, keyId, entry.getValue()));\n+            if (keyId != null) {\n+                entries.add(new MapEntry(key, keyId, entry.getValue()));\n+            }\n         }\n \n         return writeMapBucket(base, entries, 0);",
                "deletions": 2
            },
            {
                "sha": "9633a0564f5304841bd5dbeaf7d1674bcd90b0b9",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/1a1e8bad9305895763693b650e91dbce39908e42/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/1a1e8bad9305895763693b650e91dbce39908e42/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordTest.java",
                "status": "modified",
                "changes": 23,
                "additions": 16,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordTest.java?ref=1a1e8bad9305895763693b650e91dbce39908e42",
                "patch": "@@ -17,6 +17,7 @@\n package org.apache.jackrabbit.oak.plugins.segment;\n \n import static com.google.common.collect.Lists.newArrayList;\n+import static com.google.common.collect.Maps.newHashMap;\n import static java.util.Collections.singletonList;\n import static junit.framework.Assert.assertNotNull;\n import static junit.framework.Assert.fail;\n@@ -40,16 +41,14 @@\n import java.util.Map;\n import java.util.Random;\n \n+import com.google.common.base.Charsets;\n+import com.google.common.collect.ImmutableMap;\n import org.apache.jackrabbit.oak.api.Blob;\n import org.apache.jackrabbit.oak.plugins.segment.memory.MemoryStore;\n import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.junit.Test;\n \n-import com.google.common.base.Charsets;\n-import com.google.common.collect.ImmutableMap;\n-import com.google.common.collect.Maps;\n-\n public class RecordTest {\n \n     private String hello = \"Hello, World!\";\n@@ -199,7 +198,7 @@ public void testMapRecord() {\n                 null, ImmutableMap.of(\"one\", blockId));\n         MapRecord two = writer.writeMap(\n                 null, ImmutableMap.of(\"one\", blockId, \"two\", blockId));\n-        Map<String, RecordId> map = Maps.newHashMap();\n+        Map<String, RecordId> map = newHashMap();\n         for (int i = 0; i < 1000; i++) {\n             map.put(\"key\" + i, blockId);\n         }\n@@ -241,7 +240,7 @@ public void testMapRecord() {\n         assertFalse(iterator.hasNext());\n         assertNull(many.getEntry(\"foo\"));\n \n-        Map<String, RecordId> changes = Maps.newHashMap();\n+        Map<String, RecordId> changes = newHashMap();\n         changes.put(\"key0\", null);\n         changes.put(\"key1000\", blockId);\n         MapRecord modified = writer.writeMap(many, changes);\n@@ -256,10 +255,20 @@ public void testMapRecord() {\n         assertNull(many.getEntry(\"foo\"));\n     }\n \n+    @Test\n+    public void testMapRemoveNonExisting() {\n+        RecordId blockId = writer.writeBlock(bytes, 0, bytes.length);\n+\n+        Map<String, RecordId> changes = newHashMap();\n+        changes.put(\"one\", null);\n+        MapRecord zero = writer.writeMap(null, changes);\n+        assertEquals(0, zero.size());\n+    }\n+\n     @Test\n     public void testWorstCaseMap() {\n         RecordId blockId = writer.writeBlock(bytes, 0, bytes.length);\n-        Map<String, RecordId> map = Maps.newHashMap();\n+        Map<String, RecordId> map = newHashMap();\n         char[] key = new char[2];\n         for (int i = 0; i <= MapRecord.BUCKETS_PER_LEVEL; i++) {\n             key[0] = (char) ('A' + i);",
                "deletions": 7
            }
        ],
        "patched_files": [
            "SegmentWriter.java",
            "Record.java"
        ],
        "unit_tests": [
            "RecordTest.java"
        ]
    },
    "jackrabbit-oak_500b703": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8389 : AccessControlValidator prone to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1860716 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/500b7032c86ba479a71937cb008226b360972266",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/21cc8ffd973a925ebae94aa19647e160ae49d0b9",
        "bug_id": "jackrabbit-oak_500b703",
        "file": [
            {
                "sha": "1ef42ac4740451b2654f3b08580d60968fdd40d8",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidator.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/500b7032c86ba479a71937cb008226b360972266/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidator.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/500b7032c86ba479a71937cb008226b360972266/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidator.java",
                "status": "modified",
                "changes": 33,
                "additions": 21,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidator.java?ref=500b7032c86ba479a71937cb008226b360972266",
                "patch": "@@ -23,14 +23,14 @@\n import javax.jcr.security.AccessControlException;\n import javax.jcr.security.Privilege;\n \n+import com.google.common.base.Strings;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Sets;\n import org.apache.jackrabbit.JcrConstants;\n import org.apache.jackrabbit.api.security.authorization.PrivilegeManager;\n import org.apache.jackrabbit.oak.api.CommitFailedException;\n import org.apache.jackrabbit.oak.api.PropertyState;\n import org.apache.jackrabbit.oak.api.Tree;\n-import org.apache.jackrabbit.oak.api.Type;\n import org.apache.jackrabbit.oak.plugins.nodetype.TypePredicate;\n import org.apache.jackrabbit.oak.plugins.tree.TreeConstants;\n import org.apache.jackrabbit.oak.plugins.tree.TreeProvider;\n@@ -236,20 +236,19 @@ private void checkValidAccessControlEntry(@NotNull Tree aceNode) throws CommitFa\n         checkValidRestrictions(aceNode);\n     }\n \n-    private void checkValidPrincipal(@NotNull Tree aceNode) throws CommitFailedException {\n+    @NotNull\n+    private String checkValidPrincipal(@NotNull Tree aceNode) throws CommitFailedException {\n         String principalName = TreeUtil.getString(aceNode, REP_PRINCIPAL_NAME);\n-        if (principalName == null || principalName.isEmpty()) {\n+        if (Strings.isNullOrEmpty(principalName)) {\n             throw accessViolation(8, \"Missing principal name at \" + aceNode.getPath());\n         }\n         // validity of principal is only a JCR specific contract and will not be\n         // enforced on the oak level.\n+        return principalName;\n     }\n \n     private void checkValidPrivileges(@NotNull Tree aceNode) throws CommitFailedException {\n-        Iterable<String> privilegeNames = TreeUtil.getStrings(aceNode, REP_PRIVILEGES);\n-        if (privilegeNames == null || Iterables.isEmpty(privilegeNames)) {\n-            throw accessViolation(9, \"Missing privileges at \" + aceNode.getPath());\n-        }\n+        Iterable<String> privilegeNames = getPrivilegeNames(aceNode);\n         for (String privilegeName : privilegeNames) {\n             try {\n                 Privilege privilege = privilegeManager.getPrivilege(privilegeName);\n@@ -264,6 +263,15 @@ private void checkValidPrivileges(@NotNull Tree aceNode) throws CommitFailedExce\n         }\n     }\n \n+    @NotNull\n+    private Iterable<String> getPrivilegeNames(@NotNull Tree aceNode) throws CommitFailedException {\n+        Iterable<String> privilegeNames = TreeUtil.getNames(aceNode, REP_PRIVILEGES);\n+        if (Iterables.isEmpty(privilegeNames)) {\n+            throw accessViolation(9, \"Missing privileges at \" + aceNode.getPath());\n+        }\n+        return privilegeNames;\n+    }\n+\n     private void checkValidRestrictions(@NotNull Tree aceTree) throws CommitFailedException {\n         String path;\n         Tree aclTree = checkNotNull(aceTree.getParent());\n@@ -290,20 +298,21 @@ private static void checkMixinTypes(Tree parentTree) throws CommitFailedExceptio\n         }\n     }\n \n-    private static void checkValidRepoAccessControlled(Tree accessControlledTree) throws CommitFailedException {\n+    private static void checkValidRepoAccessControlled(@NotNull Tree accessControlledTree) throws CommitFailedException {\n         if (!accessControlledTree.isRoot()) {\n             throw accessViolation(12, \"Only root can store repository level policies (\" + accessControlledTree.getPath() + ')');\n         }\n     }\n \n+    @NotNull\n     private static CommitFailedException accessViolation(int code, String message) {\n         return new CommitFailedException(ACCESS_CONTROL, code, message);\n     }\n \n-    private ValidationEntry createAceEntry(@Nullable String path, @NotNull Tree aceTree) {\n-        String principalName = aceTree.getProperty(REP_PRINCIPAL_NAME).getValue(Type.STRING);\n-        PrivilegeBits privilegeBits = privilegeBitsProvider.getBits(aceTree.getProperty(REP_PRIVILEGES).getValue(Type.NAMES));\n-\n+     @NotNull\n+     private ValidationEntry createAceEntry(@Nullable String path, @NotNull Tree aceTree) throws CommitFailedException {\n+        String principalName = checkValidPrincipal(aceTree);\n+        PrivilegeBits privilegeBits = privilegeBitsProvider.getBits(getPrivilegeNames(aceTree));\n         boolean isAllow = NT_REP_GRANT_ACE.equals(TreeUtil.getPrimaryTypeName(aceTree));\n         Set<Restriction> restrictions = restrictionProvider.readRestrictions(path, aceTree);\n         return new ValidationEntry(principalName, privilegeBits, isAllow, restrictions);",
                "deletions": 12
            },
            {
                "sha": "9c889e87bf9b0ca71d8fb26b944054f7ad1b9c63",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidatorTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/500b7032c86ba479a71937cb008226b360972266/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidatorTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/500b7032c86ba479a71937cb008226b360972266/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidatorTest.java",
                "status": "modified",
                "changes": 100,
                "additions": 100,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/security/authorization/accesscontrol/AccessControlValidatorTest.java?ref=500b7032c86ba479a71937cb008226b360972266",
                "patch": "@@ -16,6 +16,7 @@\n  */\n package org.apache.jackrabbit.oak.security.authorization.accesscontrol;\n \n+import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableMap;\n import com.google.common.collect.ImmutableSet;\n import org.apache.jackrabbit.JcrConstants;\n@@ -25,6 +26,7 @@\n import org.apache.jackrabbit.oak.AbstractSecurityTest;\n import org.apache.jackrabbit.oak.api.CommitFailedException;\n import org.apache.jackrabbit.oak.api.Tree;\n+import org.apache.jackrabbit.oak.api.Type;\n import org.apache.jackrabbit.oak.commons.PathUtils;\n import org.apache.jackrabbit.oak.plugins.memory.MemoryNodeStore;\n import org.apache.jackrabbit.oak.plugins.tree.TreeUtil;\n@@ -57,6 +59,8 @@\n import javax.jcr.security.AccessControlManager;\n import java.security.Principal;\n \n+import static org.apache.jackrabbit.JcrConstants.JCR_MIXINTYPES;\n+import static org.apache.jackrabbit.oak.spi.security.privilege.PrivilegeConstants.JCR_READ;\n import static org.hamcrest.CoreMatchers.containsString;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotNull;\n@@ -90,6 +94,7 @@ public void before() throws Exception {\n     @After\n     public void after() throws Exception {\n         try {\n+            root.refresh();\n             Tree testRoot = root.getTree(testPath);\n             if (testRoot.exists()) {\n                 testRoot.remove();\n@@ -109,6 +114,25 @@ private AccessControlValidatorProvider createValidatorProvider() {\n         return new AccessControlValidatorProvider((AuthorizationConfigurationImpl) cac.getDefaultConfig());\n     }\n \n+    @NotNull\n+    private Validator createRootValidator(@NotNull Tree rootTree) {\n+        NodeState ns = getTreeProvider().asNodeState(rootTree);\n+        return createValidatorProvider().getRootValidator(ns, ns, new CommitInfo(\"sid\", null));\n+    }\n+\n+    @NotNull\n+    private Tree createPolicy(@NotNull Tree tree, boolean createRestrictionNode) throws AccessDeniedException {\n+        tree.setProperty(JCR_MIXINTYPES, ImmutableList.of(MIX_REP_ACCESS_CONTROLLABLE), Type.NAMES);\n+\n+        Tree acl = TreeUtil.addChild(tree, REP_POLICY, NT_REP_ACL);\n+        acl.setOrderableChildren(true);\n+        Tree ace = createACE(acl, aceName, NT_REP_GRANT_ACE, testPrincipal.getName(), JCR_READ);\n+        if (createRestrictionNode) {\n+            TreeUtil.addChild(ace, REP_RESTRICTIONS, NT_REP_RESTRICTIONS);\n+        }\n+        return acl;\n+    }\n+\n     private NodeUtil createAcl() throws AccessDeniedException {\n         NodeUtil testRoot = getTestRoot();\n         testRoot.setNames(JcrConstants.JCR_MIXINTYPES, MIX_REP_ACCESS_CONTROLLABLE);\n@@ -126,6 +150,20 @@ private static NodeUtil createACE(NodeUtil acl, String aceName, String ntName, S\n         return ace;\n     }\n \n+    @NotNull\n+    private static Tree createACE(@NotNull Tree acl, @NotNull String aceName, @NotNull String ntName, @NotNull String principalName, @NotNull String... privilegeNames) throws AccessDeniedException {\n+        Tree ace = TreeUtil.addChild(acl, aceName, ntName);\n+        ace.setProperty(REP_PRINCIPAL_NAME, principalName);\n+        ace.setProperty(REP_PRIVILEGES, ImmutableList.copyOf(privilegeNames), Type.NAMES);\n+        return ace;\n+    }\n+\n+    private static CommitFailedException assertCommitFailedException(@NotNull CommitFailedException e, @NotNull String type, int expectedCode) {\n+        assertTrue(e.isOfType(type));\n+        assertEquals(expectedCode, e.getCode());\n+        return e;\n+    }\n+\n     @Test\n     public void testPolicyWithOutChildOrder() throws AccessDeniedException {\n         NodeUtil testRoot = getTestRoot();\n@@ -550,4 +588,66 @@ public void testRestrictionsUsedByOtherModule2() throws Exception {\n             root.refresh();\n         }\n     }\n+\n+\n+\n+    @Test(expected = CommitFailedException.class)\n+    public void testAddEntyWithEmptyPrivileges() throws Exception {\n+        Tree rootTree = root.getTree(PathUtils.ROOT_PATH);\n+        Tree policy = createPolicy(rootTree, false);\n+        Tree entry = policy.getChild(aceName);\n+        entry.setProperty(REP_PRIVILEGES, ImmutableList.of(), Type.NAMES);\n+\n+        Validator v = createRootValidator(rootTree);\n+        try {\n+            v.childNodeAdded(policy.getName(), getTreeProvider().asNodeState(policy)).childNodeAdded(entry.getName(), getTreeProvider().asNodeState(entry));\n+        } catch (CommitFailedException e) {\n+            throw assertCommitFailedException(e, CommitFailedException.ACCESS_CONTROL, 9);\n+        }\n+    }\n+\n+    @Test(expected = CommitFailedException.class)\n+    public void testAddEntyWithNullrivileges() throws Exception {\n+        Tree rootTree = root.getTree(PathUtils.ROOT_PATH);\n+        Tree policy = createPolicy(rootTree, false);\n+        Tree entry = policy.getChild(aceName);\n+        entry.removeProperty(REP_PRIVILEGES);\n+\n+        Validator v = createRootValidator(rootTree);\n+        try {\n+            v.childNodeAdded(policy.getName(), getTreeProvider().asNodeState(policy)).childNodeAdded(entry.getName(), getTreeProvider().asNodeState(entry));\n+        } catch (CommitFailedException e) {\n+            throw assertCommitFailedException(e, CommitFailedException.ACCESS_CONTROL, 9);\n+        }\n+    }\n+\n+    @Test(expected = CommitFailedException.class)\n+    public void testAddEntyWithEmptyPrincipalName() throws Exception {\n+        Tree rootTree = root.getTree(PathUtils.ROOT_PATH);\n+        Tree policy = createPolicy(rootTree, false);\n+        Tree entry = policy.getChild(aceName);\n+        entry.setProperty(REP_PRINCIPAL_NAME, \"\");\n+\n+        Validator v = createRootValidator(rootTree);\n+        try {\n+            v.childNodeAdded(policy.getName(), getTreeProvider().asNodeState(policy)).childNodeAdded(entry.getName(), getTreeProvider().asNodeState(entry));\n+        } catch (CommitFailedException e) {\n+            throw assertCommitFailedException(e, CommitFailedException.ACCESS_CONTROL, 8);\n+        }\n+    }\n+\n+    @Test(expected = CommitFailedException.class)\n+    public void testAddEntyWithNullPrincipalName() throws Exception {\n+        Tree rootTree = root.getTree(PathUtils.ROOT_PATH);\n+        Tree policy = createPolicy(rootTree, false);\n+        Tree entry = policy.getChild(aceName);\n+        entry.removeProperty(REP_PRINCIPAL_NAME);\n+\n+        Validator v = createRootValidator(rootTree);\n+        try {\n+            v.childNodeAdded(policy.getName(), getTreeProvider().asNodeState(policy)).childNodeAdded(entry.getName(), getTreeProvider().asNodeState(entry));\n+        } catch (CommitFailedException e) {\n+            throw assertCommitFailedException(e, CommitFailedException.ACCESS_CONTROL, 8);\n+        }\n+    }\n }\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "AccessControlValidator.java"
        ],
        "unit_tests": [
            "AccessControlValidatorTest.java"
        ]
    },
    "jackrabbit-oak_0989e51": {
        "repo": "jackrabbit-oak",
        "message": "OAK-642 NPE trying to add a node to an nt:folder node\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1447734 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/0989e5157186aa7dc17b428625bb70aa573757a0",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/d52bd84517f1c3d2a329fea8c1dd41dc3f256be6",
        "bug_id": "jackrabbit-oak_0989e51",
        "file": [
            {
                "sha": "e93861aa90169e674291171e60f49e187dcc0dee",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/0989e5157186aa7dc17b428625bb70aa573757a0/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/0989e5157186aa7dc17b428625bb70aa573757a0/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "status": "modified",
                "changes": 10,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java?ref=0989e5157186aa7dc17b428625bb70aa573757a0",
                "patch": "@@ -23,6 +23,7 @@\n import javax.jcr.RepositoryException;\n import javax.jcr.Session;\n \n+import org.junit.Ignore;\n import org.junit.Test;\n \n import static junit.framework.Assert.assertEquals;\n@@ -115,4 +116,13 @@ public void testRootPropertyPath() throws RepositoryException {\n         Property property = getAdminSession().getRootNode().getProperty(\"jcr:primaryType\");\n         assertEquals(\"/jcr:primaryType\", property.getPath());\n     }\n+    \n+    @Test\n+    @Ignore(\"OAK-642\")\n+    public void nodeType() throws RepositoryException {\n+            Session s = getAdminSession();\n+            s.getRootNode().addNode(\"a\", \"nt:folder\").addNode(\"b\");\n+            s.save();        \n+    }\n+    \n }",
                "deletions": 0
            }
        ],
        "patched_files": [],
        "unit_tests": [
            "CRUDTest.java"
        ]
    },
    "jackrabbit-oak_443b0bb": {
        "repo": "jackrabbit-oak",
        "message": "OAK-6486: NPE in CompositeNodeStore\n\n-implemented MountedNodeStore#toString()\n-treat the NodeState returned from the commit hook as a composite one in the CommitHookEnhancer\n-throw an exception if the commit hooks were not invoked by the global store\n-return the root node state as a partial state in the merge() method for read-only stores\n-run the commit hooks and rebase the partial builders even if there are no changes on the global builder\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1803002 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/443b0bb82aba1829d443e38306ea2a4754b3982b",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/641ee6bdf1e9a0d6f7709765d47b0c5fa9ae1c80",
        "bug_id": "jackrabbit-oak_443b0bb",
        "file": [
            {
                "sha": "04267508c10092f024b3956040b855e3f3c2b577",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java",
                "status": "modified",
                "changes": 15,
                "additions": 10,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CommitHookEnhancer.java?ref=443b0bb82aba1829d443e38306ea2a4754b3982b",
                "patch": "@@ -50,19 +50,24 @@\n     public NodeState processCommit(NodeState before, NodeState after, CommitInfo info) throws CommitFailedException {\n         Map<MountedNodeStore, NodeState> beforeStates = newHashMap();\n         Map<MountedNodeStore, NodeState> afterStates = newHashMap();\n-        for (Map.Entry<MountedNodeStore, NodeBuilder> e : builders.entrySet()) {\n-            afterStates.put(e.getKey(), e.getKey().getNodeStore().rebase(e.getValue()));\n-            beforeStates.put(e.getKey(), e.getValue().getBaseState());\n+        for (MountedNodeStore mns : ctx.getNonDefaultStores()) {\n+            afterStates.put(mns, mns.getNodeStore().rebase(builders.get(mns)));\n+            beforeStates.put(mns, builders.get(mns).getBaseState());\n         }\n-        beforeStates.put(ctx.getGlobalStore(), before);\n         afterStates.put(ctx.getGlobalStore(), after);\n+        beforeStates.put(ctx.getGlobalStore(), before);\n \n         CompositeNodeState compositeBefore = ctx.createRootNodeState(beforeStates);\n         CompositeNodeState compositeAfter = ctx.createRootNodeState(afterStates);\n \n         NodeState result = hook.processCommit(compositeBefore, compositeAfter, info);\n         updatedBuilder = Optional.of(toComposite(result, compositeBefore));\n-        return updatedBuilder.get().getNodeState().getNodeState(ctx.getGlobalStore());\n+\n+        if (result instanceof CompositeNodeState) {\n+            return ((CompositeNodeState) result).getNodeState(ctx.getGlobalStore());\n+        } else {\n+            throw new IllegalStateException(\"The commit hook result should be a composite node state\");\n+        }\n     }\n \n     Optional<CompositeNodeBuilder> getUpdatedBuilder() {",
                "deletions": 5
            },
            {
                "sha": "a6375c7743c1636b252e0453e4d55c5216093d23",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java",
                "status": "modified",
                "changes": 10,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeState.java?ref=443b0bb82aba1829d443e38306ea2a4754b3982b",
                "patch": "@@ -19,9 +19,6 @@\n package org.apache.jackrabbit.oak.composite;\n \n import com.google.common.base.Function;\n-import com.google.common.collect.ImmutableSet;\n-import com.google.common.collect.Maps;\n-import com.google.common.collect.Sets;\n import org.apache.jackrabbit.oak.api.PropertyState;\n import org.apache.jackrabbit.oak.commons.PathUtils;\n import org.apache.jackrabbit.oak.plugins.memory.MemoryChildNodeEntry;\n@@ -33,7 +30,6 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import javax.annotation.Nullable;\n import java.util.List;\n import java.util.Map;\n \n@@ -44,7 +40,6 @@\n import static com.google.common.collect.Iterables.transform;\n import static com.google.common.collect.Maps.asMap;\n import static com.google.common.collect.Maps.transformValues;\n-import static com.google.common.collect.Sets.newHashSet;\n import static java.lang.Long.MAX_VALUE;\n import static java.util.Collections.singleton;\n import static org.apache.jackrabbit.oak.composite.CompositeNodeBuilder.simpleConcat;\n@@ -92,9 +87,8 @@ NodeState getNodeState(MountedNodeStore mns) {\n         }\n \n         // this shouldn't happen, so we need to log some more debug info\n-        String mountName = mns.getMount().isDefault() ? \"[default]\" : mns.getMount().getName();\n-        LOG.warn(\"Can't find node state for path {} and mount {}. The node state map: {}\", path, mountName, nodeStates);\n-        throw new IllegalStateException(\"Can't find the node state for mount \" + mountName);\n+        LOG.warn(\"Can't find node state for path {} and mount {}. The node state map: {}\", path, mns, nodeStates);\n+        throw new IllegalStateException(\"Can't find the node state for mount \" + mns);\n     }\n \n     @Override",
                "deletions": 8
            },
            {
                "sha": "72ca9b3aa273f1f97d64f1d9105bf46ff0122082",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java",
                "status": "modified",
                "changes": 49,
                "additions": 28,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/CompositeNodeStore.java?ref=443b0bb82aba1829d443e38306ea2a4754b3982b",
                "patch": "@@ -144,22 +144,25 @@ public NodeState merge(NodeBuilder builder, CommitHook commitHook, CommitInfo in\n             CommitHookEnhancer hookEnhancer = new CommitHookEnhancer(commitHook, ctx, nodeBuilder.getBuilders());\n             NodeState globalResult = globalStore.getNodeStore().merge(nodeBuilder.getBuilders().get(globalStore), hookEnhancer, info);\n             resultStates.put(globalStore, globalResult);\n-            CompositeNodeBuilder updatedBuilder = hookEnhancer.getUpdatedBuilder().orElse(nodeBuilder);\n+\n+            if (!hookEnhancer.getUpdatedBuilder().isPresent()) {\n+                // it means that the commit hook wasn't invoked, because there were\n+                // no changes on the global store. we should invoke it anyway.\n+                hookEnhancer.processCommit(globalResult, globalResult, info);\n+            }\n+            CompositeNodeBuilder updatedBuilder = hookEnhancer.getUpdatedBuilder().get();\n \n             // merge the partial builders\n             for (MountedNodeStore mns : ctx.getNonDefaultStores()) {\n                 NodeBuilder partialBuilder = updatedBuilder.getBuilders().get(mns);\n \n                 if (mns.getMount().isReadOnly()) {\n-                    if (!partialBuilder.getNodeState().equals(partialBuilder.getBaseState())) {\n-                        throw new CommitFailedException(\"CompositeStore\", 31, \"Unable to perform changes on read-only mount \" + mns.getMount().getName());\n-                    }\n-                    resultStates.put(mns, partialBuilder.getBaseState());\n-                    continue;\n+                    assertNoChange(mns, partialBuilder);\n+                    resultStates.put(mns, mns.getNodeStore().getRoot());\n+                } else {\n+                    NodeState partialState = mns.getNodeStore().merge(partialBuilder, EmptyHook.INSTANCE, info);\n+                    resultStates.put(mns, partialState);\n                 }\n-\n-                NodeState partialState = mns.getNodeStore().merge(partialBuilder, EmptyHook.INSTANCE, info);\n-                resultStates.put(mns, partialState);\n             }\n \n             CompositeNodeState newRoot = ctx.createRootNodeState(resultStates);\n@@ -178,18 +181,22 @@ private void assertNoChangesOnReadOnlyMounts(CompositeNodeBuilder nodeBuilder) t\n                 continue;\n             }\n             NodeBuilder partialBuilder = nodeBuilder.getBuilders().get(mountedNodeStore);\n-            NodeState baseState = partialBuilder.getBaseState();\n-            NodeState nodeState = partialBuilder.getNodeState();\n-            if (!nodeState.equals(baseState)) {\n-                Set<String> changedPaths = getModifiedPaths(baseState, nodeState);\n-                Set<String> ignoredChangedPaths = getIgnoredPaths(changedPaths);\n-                if (!ignoredChangedPaths.isEmpty()) {\n-                    LOG.debug(\"Can't merge following read-only paths (they are configured to be ignored): {}.\", ignoredChangedPaths);\n-                }\n-                Set<String> failingChangedPaths = difference(changedPaths, ignoredChangedPaths);\n-                if (!failingChangedPaths.isEmpty()) {\n-                    throw new CommitFailedException(\"CompositeStore\", 31, \"Unable to perform changes on read-only mount \" + mountedNodeStore.getMount().getName() + \". Failing paths: \" + failingChangedPaths.toString());\n-                }\n+            assertNoChange(mountedNodeStore, partialBuilder);\n+        }\n+    }\n+\n+    private void assertNoChange(MountedNodeStore mountedNodeStore, NodeBuilder partialBuilder) throws CommitFailedException {\n+        NodeState baseState = partialBuilder.getBaseState();\n+        NodeState nodeState = partialBuilder.getNodeState();\n+        if (!nodeState.equals(baseState)) {\n+            Set<String> changedPaths = getModifiedPaths(baseState, nodeState);\n+            Set<String> ignoredChangedPaths = getIgnoredPaths(changedPaths);\n+            if (!ignoredChangedPaths.isEmpty()) {\n+                LOG.debug(\"Can't merge following read-only paths (they are configured to be ignored): {}.\", ignoredChangedPaths);\n+            }\n+            Set<String> failingChangedPaths = difference(changedPaths, ignoredChangedPaths);\n+            if (!failingChangedPaths.isEmpty()) {\n+                throw new CommitFailedException(\"CompositeStore\", 31, \"Unable to perform changes on read-only mount \" + mountedNodeStore.getMount().getName() + \". Failing paths: \" + failingChangedPaths.toString());\n             }\n         }\n     }",
                "deletions": 21
            },
            {
                "sha": "a1cce9d1ca45a260df30789e816461eab4dfbed2",
                "filename": "oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/MountedNodeStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/MountedNodeStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/443b0bb82aba1829d443e38306ea2a4754b3982b/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/MountedNodeStore.java",
                "status": "modified",
                "changes": 13,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-store-composite/src/main/java/org/apache/jackrabbit/oak/composite/MountedNodeStore.java?ref=443b0bb82aba1829d443e38306ea2a4754b3982b",
                "patch": "@@ -39,4 +39,17 @@ public Mount getMount() {\n     public NodeStore getNodeStore() {\n         return nodeStore;\n     }\n+\n+    @Override\n+    public String toString() {\n+        StringBuilder result = new StringBuilder(super.toString());\n+        result.append('[');\n+        if (mount.isDefault()) {\n+            result.append(\"default\");\n+        } else {\n+            result.append(mount.getName());\n+        }\n+        result.append(']');\n+        return result.toString();\n+    }\n }\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "CompositeNodeStore.java"
        ],
        "unit_tests": [
            "CompositeNodeStoreTest.java"
        ]
    },
    "jackrabbit-oak_50c12c3": {
        "repo": "jackrabbit-oak",
        "message": "OAK-642: NPE trying to add a node to an nt:folder node\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1447940 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/50c12c33f7bc381d413f9354f67573a7b180a765",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/5320dc096065db80daed31e620db835baf96b0d2",
        "bug_id": "jackrabbit-oak_50c12c3",
        "file": [
            {
                "sha": "7cb7e2c47789b3168d49b265a56ea6ada7edc182",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/NodeImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/50c12c33f7bc381d413f9354f67573a7b180a765/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/NodeImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/50c12c33f7bc381d413f9354f67573a7b180a765/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/NodeImpl.java",
                "status": "modified",
                "changes": 9,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/NodeImpl.java?ref=50c12c33f7bc381d413f9354f67573a7b180a765",
                "patch": "@@ -250,11 +250,10 @@ public Node perform() throws RepositoryException {\n                 String ntName = primaryNodeTypeName;\n                 if (ntName == null) {\n                     DefinitionProvider dp = sessionDelegate.getDefinitionProvider();\n-                    try {\n-                        String childName = sessionDelegate.getOakName(PathUtils.getName(relPath));\n-                        NodeDefinition def = dp.getDefinition(new NodeImpl<NodeDelegate>(parent), childName);\n-                        ntName = def.getDefaultPrimaryTypeName();\n-                    } catch (RepositoryException e) {\n+                    String childName = sessionDelegate.getOakName(PathUtils.getName(relPath));\n+                    NodeDefinition def = dp.getDefinition(new NodeImpl<NodeDelegate>(parent), childName);\n+                    ntName = def.getDefaultPrimaryTypeName();\n+                    if (ntName == null) {\n                         throw new ConstraintViolationException(\n                                 \"no matching child node definition found for \" + relPath);\n                     }",
                "deletions": 5
            },
            {
                "sha": "13757ed002833b205b076ba84eeb595a39584169",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/50c12c33f7bc381d413f9354f67573a7b180a765/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/50c12c33f7bc381d413f9354f67573a7b180a765/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/CRUDTest.java?ref=50c12c33f7bc381d413f9354f67573a7b180a765",
                "patch": "@@ -24,7 +24,6 @@\n import javax.jcr.Session;\n import javax.jcr.nodetype.ConstraintViolationException;\n \n-import org.junit.Ignore;\n import org.junit.Test;\n \n import static junit.framework.Assert.assertEquals;\n@@ -119,7 +118,6 @@ public void testRootPropertyPath() throws RepositoryException {\n     }\n     \n     @Test(expected = ConstraintViolationException.class)\n-    @Ignore(\"OAK-642\")\n     public void nodeType() throws RepositoryException {\n             Session s = getAdminSession();\n             s.getRootNode().addNode(\"a\", \"nt:folder\").addNode(\"b\");",
                "deletions": 2
            }
        ],
        "patched_files": [
            "NodeImpl.java"
        ],
        "unit_tests": [
            "CRUDTest.java"
        ]
    },
    "jackrabbit-oak_a65b925": {
        "repo": "jackrabbit-oak",
        "message": "OAK-8212 : ImporterImpl.importProperties prone to NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1857242 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/a65b925e661e0cbf22e2844f85e68c6b6aaeae55",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/002c7d9e31ac0160e52213bf2e0d18558b467187",
        "bug_id": "jackrabbit-oak_a65b925",
        "file": [
            {
                "sha": "2e126b5d8fa9287f4058f053492cfe7141002264",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java",
                "status": "modified",
                "changes": 3,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/xml/ImporterImpl.java?ref=a65b925e661e0cbf22e2844f85e68c6b6aaeae55",
                "patch": "@@ -272,6 +272,9 @@ private void importProperties(@NotNull Tree tree,\n             //TODO find better heuristics?\n             EffectiveNodeType ent = effectiveNodeTypeProvider.getEffectiveNodeType(tree);\n             PropertyDefinition def = ent.getPropertyDefinition(pi.getName(), pi.getType(), pi.isUnknownMultiple());\n+            if (def == null) {\n+                throw new ConstraintViolationException(\"No matching property definition found for \" + pi.getName());\n+            }\n             if (def.isProtected()) {\n                 // skip protected property\n                 log.debug(\"Protected property {}\", pi.getName());",
                "deletions": 0
            },
            {
                "sha": "d3afb1659e1772975449ec20686c2003e1635d8b",
                "filename": "oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/a65b925e661e0cbf22e2844f85e68c6b6aaeae55/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java",
                "status": "modified",
                "changes": 22,
                "additions": 22,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/test/java/org/apache/jackrabbit/oak/jcr/xml/ImportTest.java?ref=a65b925e661e0cbf22e2844f85e68c6b6aaeae55",
                "patch": "@@ -29,6 +29,9 @@\n \n import org.apache.jackrabbit.test.AbstractJCRTest;\n \n+import static org.apache.jackrabbit.JcrConstants.JCR_DATA;\n+import static org.apache.jackrabbit.JcrConstants.JCR_PRIMARYTYPE;\n+\n public class ImportTest extends AbstractJCRTest {\n \n     private String uuid;\n@@ -226,4 +229,23 @@ public void testTransientThrow() throws Exception {\n             // success\n         }\n     }\n+\n+    /**\n+     * @see <a href=\"https://issues.apache.org/jira/browse/OAK-8212\">OAK-8212</a>\n+     */\n+    public void testNoMatchingPropertyDefinition() throws Exception {\n+        // jcr:data must be BINARY not BOOLEAN -> should fail\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\" +\n+                \"<sv:node sv:name=\\\"resourceName\\\" xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\" xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\" xmlns:fn_old=\\\"http://www.w3.org/2004/10/xpath-functions\\\" xmlns:fn=\\\"http://www.w3.org/2005/xpath-functions\\\" xmlns:xs=\\\"http://www.w3.org/2001/XMLSchema\\\" xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\" xmlns:rep=\\\"internal\\\" xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\">\" +\n+                    \"<sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\"><sv:value>oak:Resource</sv:value></sv:property>\" +\n+                    \"<sv:property sv:name=\\\"jcr:data\\\" sv:type=\\\"Boolean\\\"><sv:value>true</sv:value></sv:property>\" +\n+                \"</sv:node>\";\n+        try {\n+            superuser.importXML(path, new ByteArrayInputStream(xml.getBytes()), ImportUUIDBehavior.IMPORT_UUID_CREATE_NEW);\n+            fail(\"ConstraintViolationException expected\");\n+        } catch (ConstraintViolationException e) {\n+            // success\n+            assertEquals(\"No matching property definition found for jcr:data\", e.getMessage());\n+        }\n+    }\n }\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "ImporterImpl.java"
        ],
        "unit_tests": [
            "ImportTest.java"
        ]
    },
    "jackrabbit-oak_ad8fcef": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2256: MemoryNodeBuilder NPE on base() following root refresh\nAvoid concurrent access to NodeBuilder.base()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1637413 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/5d0ad3c91e7f2440e8eddf3edbd74604822dc47b",
        "bug_id": "jackrabbit-oak_ad8fcef",
        "file": [
            {
                "sha": "a440f662f8d5a0f39d8ab611df9136e326b5eb5f",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java",
                "status": "modified",
                "changes": 4,
                "additions": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/FilterBuilder.java?ref=ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
                "patch": "@@ -40,6 +40,7 @@\n import com.google.common.base.Predicate;\n import com.google.common.collect.ImmutableList;\n import org.apache.jackrabbit.oak.api.PropertyState;\n+import org.apache.jackrabbit.oak.core.ImmutableRoot;\n import org.apache.jackrabbit.oak.plugins.nodetype.TypePredicate;\n import org.apache.jackrabbit.oak.plugins.observation.filter.UniversalFilter.Selector;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n@@ -427,7 +428,8 @@ public ACCondition(PermissionProviderFactory permissionProviderFactory) {\n \n         @Override\n         public EventFilter createFilter(NodeState before, NodeState after) {\n-            return new ACFilter(before, after, permissionProviderFactory.create());\n+            return new ACFilter(before, after,\n+                    permissionProviderFactory.create(new ImmutableRoot(after)));\n         }\n     }\n ",
                "deletions": 1
            },
            {
                "sha": "90fff96afeea2c96e0ea6b94b8e7235f85fb8279",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java",
                "status": "modified",
                "changes": 3,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/observation/filter/PermissionProviderFactory.java?ref=ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
                "patch": "@@ -21,6 +21,7 @@\n \n import javax.annotation.Nonnull;\n \n+import org.apache.jackrabbit.oak.api.Root;\n import org.apache.jackrabbit.oak.spi.security.authorization.permission.PermissionProvider;\n \n /**\n@@ -33,5 +34,5 @@\n      * @return\n      */\n     @Nonnull\n-    PermissionProvider create();\n+    PermissionProvider create(Root root);\n }",
                "deletions": 1
            },
            {
                "sha": "edcd4921c4d398b14aa957eb89aa8ceca5734624",
                "filename": "oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java",
                "status": "modified",
                "changes": 9,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-jcr/src/main/java/org/apache/jackrabbit/oak/jcr/observation/ObservationManagerImpl.java?ref=ad8fcefe1e19bf25c6d8930e8b91def7ac90d0b7",
                "patch": "@@ -50,7 +50,6 @@\n import org.apache.jackrabbit.oak.api.Root;\n import org.apache.jackrabbit.oak.jcr.delegate.SessionDelegate;\n import org.apache.jackrabbit.oak.jcr.session.SessionContext;\n-import org.apache.jackrabbit.oak.jcr.session.operation.SessionOperation;\n import org.apache.jackrabbit.oak.namepath.NamePathMapper;\n import org.apache.jackrabbit.oak.plugins.nodetype.ReadOnlyNodeTypeManager;\n import org.apache.jackrabbit.oak.plugins.observation.CommitRateLimiter;\n@@ -119,13 +118,7 @@ public ObservationManagerImpl(\n             Set<Principal> principals = sessionDelegate.getAuthInfo().getPrincipals();\n             @Nonnull\n             @Override\n-            public PermissionProvider create() {\n-                Root root = sessionDelegate.safePerform(new SessionOperation<Root>(\"refresh-root\") {\n-                    @Override\n-                    public Root perform() {\n-                        return sessionDelegate.getRoot();\n-                    }\n-                });\n+            public PermissionProvider create(Root root) {\n                 return authorizationConfig.getPermissionProvider(root,\n                         sessionDelegate.getWorkspaceName(), principals);\n             }",
                "deletions": 8
            }
        ],
        "patched_files": [
            "FilterBuilder.java"
        ],
        "unit_tests": [
            "FilterBuilderTest.java"
        ]
    },
    "jackrabbit-oak_47b44cb": {
        "repo": "jackrabbit-oak",
        "message": "OAK-3856: Potential NPE in SegmentWriter\nInline constructor only used from tests\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1723804 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/47b44cb8ff145c56c7080a56f3221bc5a60d8298",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/bfc07661f765e7696386b872cd2466058f8398b8",
        "bug_id": "jackrabbit-oak_47b44cb",
        "file": [
            {
                "sha": "f4b4bb2e9253024683a4dd9aa5ed0c37257ad606",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java",
                "status": "modified",
                "changes": 4,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentWriter.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -125,10 +125,6 @@ public synchronized void clear() {\n \n     private final String wid;\n \n-    public SegmentWriter(SegmentStore store, SegmentVersion version) {\n-        this(store, version, \"\");\n-    }\n-\n     /**\n      * @param store     store to write to\n      * @param version   segment version to write",
                "deletions": 4
            },
            {
                "sha": "861b80c37737b0cf12308f30896eb106b7a48d42",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/package-info.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -14,7 +14,7 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-@Version(\"8.1.0\")\n+@Version(\"9.0.0\")\n @Export(optional = \"provide:=true\")\n package org.apache.jackrabbit.oak.plugins.segment;\n ",
                "deletions": 1
            },
            {
                "sha": "a85f70edef27b5e0a20eef622b6419688ac66d01",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMapTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMapTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMapTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/PartialCompactionMapTest.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -120,7 +120,7 @@ private SegmentTracker getTracker() {\n     }\n \n     private PartialCompactionMap createCompactionMap() {\n-        SegmentWriter writer = new SegmentWriter(segmentStore, V_11);\n+        SegmentWriter writer = new SegmentWriter(segmentStore, V_11, \"\");\n         if (usePersistedMap) {\n             return new PersistedCompactionMap(segmentStore);\n         } else {",
                "deletions": 1
            },
            {
                "sha": "0604718fa75158fb11a56de9271d57aec4dbc194",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordUsageAnalyserTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordUsageAnalyserTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordUsageAnalyserTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/RecordUsageAnalyserTest.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -70,7 +70,7 @@ public void setup() {\n         store = mock(SegmentStore.class);\n         SegmentTracker tracker = new SegmentTracker(store);\n         when(store.getTracker()).thenReturn(tracker);\n-        writer = new SegmentWriter(store, segmentVersion);\n+        writer = new SegmentWriter(store, segmentVersion, \"\");\n         analyser = new RecordUsageAnalyser();\n     }\n ",
                "deletions": 1
            },
            {
                "sha": "5195f9e73b60e97b210c2719471e99eb439779c1",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/SegmentParserTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/SegmentParserTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/SegmentParserTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/SegmentParserTest.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -156,7 +156,7 @@ public void setup() {\n         store = mock(SegmentStore.class, withSettings().stubOnly());\n         SegmentTracker tracker = new SegmentTracker(store);\n         when(store.getTracker()).thenReturn(tracker);\n-        writer = new SegmentWriter(store, segmentVersion);\n+        writer = new SegmentWriter(store, segmentVersion, \"\");\n     }\n \n     @Test",
                "deletions": 1
            },
            {
                "sha": "157aaab97cf9b227017a46f4ba4cd19295422258",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStoreIT.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStoreIT.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStoreIT.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/FileStoreIT.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -162,7 +162,7 @@ public void testCompaction() throws IOException {\n         store = new FileStore(directory, 1, false);\n         head = store.getHead();\n         assertTrue(store.size() > largeBinarySize);\n-        writer = new SegmentWriter(store, V_11);\n+        writer = new SegmentWriter(store, V_11, \"\");\n         compactor = new Compactor(store);\n         compacted = compactor.compact(EMPTY_NODE, head, EMPTY_NODE);\n         builder = head.builder();",
                "deletions": 1
            },
            {
                "sha": "1828d75f00a4dd4561226f18a402696f1b91b2b9",
                "filename": "oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/TarWriterTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/TarWriterTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/47b44cb8ff145c56c7080a56f3221bc5a60d8298/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/TarWriterTest.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/test/java/org/apache/jackrabbit/oak/plugins/segment/file/TarWriterTest.java?ref=47b44cb8ff145c56c7080a56f3221bc5a60d8298",
                "patch": "@@ -162,7 +162,7 @@ public void writeSegment(SegmentId id, byte[] data, int offset, int length) thro\n                     segments.put(id, buffer);\n                 }\n             };\n-            writer = new SegmentWriter(store, V_11);\n+            writer = new SegmentWriter(store, V_11, \"\");\n         }\n \n         public class Node {",
                "deletions": 1
            }
        ],
        "patched_files": [
            "package-info.java",
            "FileStoreIT.java",
            "SegmentParser.java",
            "SegmentWriter.java",
            "RecordUsageAnalyser.java",
            "PartialCompactionMap.java",
            "TarWriter.java"
        ],
        "unit_tests": [
            "RecordUsageAnalyserTest.java",
            "SegmentParserTest.java",
            "PartialCompactionMapTest.java",
            "TarWriterTest.java"
        ]
    },
    "jackrabbit-oak_db03994": {
        "repo": "jackrabbit-oak",
        "message": "OAK-619 Lock-free MongoMK implementation\n- Improve branch support\n- Copied over some tests from previous MongoDB based MicroKernel implementation. Some tests are still marked ignored.\n- Fixed NPE in Commit.createOrUpdateNode() (newestRev may be null)\n- Disabled document splitting until it is fully implemented -> max size set to Integer.MAX_VALUE\n- Fixed path issue with JSOP move and copy operation\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1461044 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/db039944fd62e1c48e58cbaacecba8021d96bb0a",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/56112cb2ae3f679e480478f7b2433d476634a759",
        "bug_id": "jackrabbit-oak_db03994",
        "file": [
            {
                "sha": "0454555312c9cb505ccc2577562782f09771df61",
                "filename": "oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/Commit.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/Commit.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/Commit.java",
                "status": "modified",
                "changes": 38,
                "additions": 33,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/Commit.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -41,8 +41,10 @@\n      * The maximum size of a document. If it is larger, it is split.\n      */\n     // TODO check which value is the best one\n-    private static final int MAX_DOCUMENT_SIZE = 16 * 1024;\n-    \n+    //private static final int MAX_DOCUMENT_SIZE = 16 * 1024;\n+    // TODO disabled until document split is fully implemented\n+    private static final int MAX_DOCUMENT_SIZE = Integer.MAX_VALUE;\n+\n     /**\n      * Whether to purge old revisions if a node gets too large. If false, old\n      * revisions are stored in a separate document. If true, old revisions are\n@@ -115,12 +117,38 @@ void apply() {\n         }\n     }\n \n+    void prepare(Revision baseRevision) {\n+        if (!operations.isEmpty()) {\n+            applyToDocumentStore(baseRevision);\n+            applyToCache();\n+        }\n+    }\n+\n     /**\n      * Apply the changes to the document store (to update MongoDB).\n      */\n     void applyToDocumentStore() {\n+        applyToDocumentStore(null);\n+    }\n+\n+    /**\n+     * Apply the changes to the document store (to update MongoDB).\n+     *\n+     * @param baseRevision the base revision of this commit. Currently only\n+     *                     used for branch commits.\n+     */\n+    void applyToDocumentStore(Revision baseRevision) {\n+        // the value in _revisions.<revision> property of the commit root node\n+        // regular commits use \"true\", which makes the commit visible to\n+        // other readers. branch commits use the base revision to indicate\n+        // the visibility of the commit\n+        String commitValue = baseRevision != null ? baseRevision.toString() : \"true\";\n         DocumentStore store = mk.getDocumentStore();\n         String commitRootPath = null;\n+        if (baseRevision != null) {\n+            // branch commits always use root node as commit root\n+            commitRootPath = \"/\";\n+        }\n         ArrayList<UpdateOp> newNodes = new ArrayList<UpdateOp>();\n         ArrayList<UpdateOp> changedNodes = new ArrayList<UpdateOp>();\n         for (String p : operations.keySet()) {\n@@ -160,7 +188,7 @@ void applyToDocumentStore() {\n             // no updates and root of commit is also new. that is,\n             // it is the root of a subtree added in a commit.\n             // so we try to add the root like all other nodes\n-            commitRoot.addMapEntry(UpdateOp.REVISIONS + \".\" + revision.toString(), \"true\");\n+            commitRoot.addMapEntry(UpdateOp.REVISIONS + \".\" + revision.toString(), commitValue);\n             newNodes.add(commitRoot);\n         }\n         try {\n@@ -191,7 +219,7 @@ void applyToDocumentStore() {\n             // first to check if there was a conflict, and only then to commit\n             // the revision, with the revision property set)\n             if (changedNodes.size() > 0 || !commitRoot.isNew) {\n-                commitRoot.addMapEntry(UpdateOp.REVISIONS + \".\" + revision.toString(), \"true\");\n+                commitRoot.addMapEntry(UpdateOp.REVISIONS + \".\" + revision.toString(), commitValue);\n                 createOrUpdateNode(store, commitRoot);\n                 operations.put(commitRootPath, commitRoot);\n             }\n@@ -207,7 +235,7 @@ private void createOrUpdateNode(DocumentStore store, UpdateOp op) {\n         if (baseRevision != null) {\n             // TODO detect conflicts here\n             Revision newestRev = mk.getNewestRevision(map, revision, true);\n-            if (mk.isRevisionNewer(newestRev, baseRevision)) {\n+            if (newestRev != null && mk.isRevisionNewer(newestRev, baseRevision)) {\n                 // TODO transaction rollback\n                 throw new MicroKernelException(\"The node \" + \n                         op.path + \" was changed in revision \" + ",
                "deletions": 5
            },
            {
                "sha": "08c2553ea0b0d1f0aa70b729ca519d50bfcca087",
                "filename": "oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/DocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/DocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/DocumentStore.java",
                "status": "modified",
                "changes": 16,
                "additions": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/DocumentStore.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -19,6 +19,11 @@\n import java.util.List;\n import java.util.Map;\n \n+import javax.annotation.CheckForNull;\n+import javax.annotation.Nonnull;\n+\n+import org.apache.jackrabbit.mk.api.MicroKernelException;\n+\n /**\n  * The interface for the backend storage for documents.\n  */\n@@ -34,18 +39,20 @@\n      * can modify it without affecting the stored version).\n      *\n      * @param collection the collection\n-     * @param path the path\n+     * @param key the key\n      * @return the map, or null if not found\n      */\n+    @CheckForNull\n     Map<String, Object> find(Collection collection, String key);\n \n+    @Nonnull\n     List<Map<String, Object>> query(Collection collection, String fromKey, String toKey, int limit);\n     \n     /**\n      * Remove a document.\n      *\n      * @param collection the collection\n-     * @param path the path\n+     * @param key the key\n      */\n     void remove(Collection collection, String key);\n \n@@ -65,8 +72,11 @@\n      * @param collection the collection\n      * @param update the update operation\n      * @return the new document\n+     * @throws MicroKernelException if the operation failed.\n      */    \n-    Map<String, Object> createOrUpdate(Collection collection, UpdateOp update); \n+    @Nonnull\n+    Map<String, Object> createOrUpdate(Collection collection, UpdateOp update)\n+            throws MicroKernelException;\n     \n     void dispose();\n ",
                "deletions": 3
            },
            {
                "sha": "09af5068a9d54276faa8de0938476ef4e0b3c857",
                "filename": "oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MemoryDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MemoryDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MemoryDocumentStore.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MemoryDocumentStore.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -23,6 +23,8 @@\n import java.util.concurrent.ConcurrentNavigableMap;\n import java.util.concurrent.ConcurrentSkipListMap;\n \n+import javax.annotation.Nonnull;\n+\n import org.apache.jackrabbit.mongomk.prototype.UpdateOp.Operation;\n \n /**\n@@ -58,6 +60,7 @@\n         return copy;\n     }\n     \n+    @Nonnull\n     public List<Map<String, Object>> query(Collection collection, String fromKey, String toKey, int limit) {\n         ConcurrentSkipListMap<String, Map<String, Object>> map = getMap(collection);\n         ConcurrentNavigableMap<String, Map<String, Object>> sub = map.subMap(fromKey, toKey);\n@@ -94,6 +97,7 @@ public void remove(Collection collection, String path) {\n         }\n     }\n \n+    @Nonnull\n     public Map<String, Object> createOrUpdate(Collection collection, UpdateOp update) {\n         ConcurrentSkipListMap<String, Map<String, Object>> map = getMap(collection);\n         Map<String, Object> n;",
                "deletions": 0
            },
            {
                "sha": "6bdb9efa4d98d83011cb9785141f98a5016f3f42",
                "filename": "oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoDocumentStore.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoDocumentStore.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoDocumentStore.java",
                "status": "modified",
                "changes": 4,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoDocumentStore.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -25,6 +25,8 @@\n import java.util.concurrent.Callable;\n import java.util.concurrent.ExecutionException;\n \n+import javax.annotation.Nonnull;\n+\n import com.google.common.cache.Cache;\n import com.google.common.cache.CacheBuilder;\n import org.apache.jackrabbit.mk.api.MicroKernelException;\n@@ -130,6 +132,7 @@ public void finalize() throws Throwable {\n         }\n     }\n     \n+    @Nonnull\n     @Override\n     public List<Map<String, Object>> query(Collection collection,\n             String fromKey, String toKey, int limit) {\n@@ -172,6 +175,7 @@ public void remove(Collection collection, String path) {\n         }\n     }\n \n+    @Nonnull\n     @Override\n     public Map<String, Object> createOrUpdate(Collection collection, UpdateOp updateOp) {\n         log(\"createOrUpdate\", updateOp);        ",
                "deletions": 0
            },
            {
                "sha": "19981392eaf355acb4868eb525254ecbbab0dc65",
                "filename": "oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoMK.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoMK.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoMK.java",
                "status": "modified",
                "changes": 133,
                "additions": 100,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/main/java/org/apache/jackrabbit/mongomk/prototype/MongoMK.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -29,6 +29,7 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n \n import com.google.common.cache.Cache;\n import com.google.common.cache.CacheBuilder;\n@@ -139,8 +140,8 @@\n     /**\n      * Maps branch commit revision to revision it is based on\n      */\n-    private final Map<String, String> branchCommits =\n-            Collections.synchronizedMap(new HashMap<String, String>());\n+    private final Map<Revision, Revision> branchCommits =\n+            Collections.synchronizedMap(new HashMap<Revision, Revision>());\n \n     /**\n      * Create a new in-memory MongoMK used for testing.\n@@ -265,6 +266,29 @@ private void checkRevisionAge(Revision r, String path) {\n     }\n     \n     private boolean includeRevision(Revision x, Revision requestRevision) {\n+        if (branchCommits.containsKey(x)) {\n+            // only include if requested revision is also a branch revision\n+            // with a history including x\n+            Revision rev = requestRevision;\n+            for (;;) {\n+                if (rev != null) {\n+                    if (rev.equals(x)) {\n+                        return true;\n+                    }\n+                } else {\n+                    // not part of branch identified by requestedRevision\n+                    return false;\n+                }\n+                rev = branchCommits.get(rev);\n+            }\n+        }\n+        // assert: x is not a branch commit\n+        while (branchCommits.containsKey(requestRevision)) {\n+            // reset requestRevision to branch base revision to make\n+            // sure we don't include revisions committed after branch\n+            // was created\n+            requestRevision = branchCommits.get(requestRevision);\n+        }\n         if (x.getClusterId() == this.clusterId && \n                 requestRevision.getClusterId() == this.clusterId) {\n             // both revisions were created by this cluster node: \n@@ -275,7 +299,7 @@ private boolean includeRevision(Revision x, Revision requestRevision) {\n         return requestRevision.compareRevisionTime(x) >= 0;\n     }\n     \n-    boolean isRevisionNewer(Revision x, Revision previous) {\n+    boolean isRevisionNewer(@Nonnull Revision x, @Nonnull Revision previous) {\n         // TODO currently we only compare the timestamps\n         return x.compareRevisionTime(previous) > 0;\n     }\n@@ -285,16 +309,23 @@ boolean isRevisionNewer(Revision x, Revision previous) {\n      * considered valid if the given node map is the root of the commit, or the\n      * commit root has the revision set. This method may read further nodes to\n      * perform this check.\n+     * This method also takes pending branches into consideration.\n+     * The <code>readRevision</code> identifies the read revision used by the\n+     * client, which may be a branch revision logged in {@link #branchCommits}.\n+     * The revision <code>rev</code> is valid if it is part of the branch\n+     * history of <code>readRevision</code>.\n      *\n      * @param rev     revision to check.\n+     * @param readRevision the read revision of the client.\n      * @param nodeMap the node to check.\n      * @return <code>true</code> if the revision is valid; <code>false</code>\n      *         otherwise.\n      */\n-    boolean isValidRevision(Revision rev, Map<String, Object> nodeMap) {\n-        @SuppressWarnings(\"unchecked\")\n-        Map<String, String> revisions = (Map<String, String>) nodeMap.get(UpdateOp.REVISIONS);\n-        if (revisions != null && revisions.containsKey(rev.toString())) {\n+    boolean isValidRevision(@Nonnull Revision rev,\n+                            @Nonnull Revision readRevision,\n+                            @Nonnull Map<String, Object> nodeMap) {\n+        //noinspection unchecked\n+        if (isCommitted(rev, readRevision, (Map<String, String>) nodeMap.get(UpdateOp.REVISIONS))) {\n             return true;\n         }\n         // check commit root\n@@ -325,8 +356,37 @@ boolean isValidRevision(Revision rev, Map<String, Object> nodeMap) {\n             return false;\n         }\n         //noinspection unchecked\n-        revisions = (Map<String, String>) nodeMap.get(UpdateOp.REVISIONS);\n-        return revisions != null && revisions.containsKey(rev.toString());\n+        return isCommitted(rev, readRevision, (Map<String, String>) nodeMap.get(UpdateOp.REVISIONS));\n+    }\n+\n+    /**\n+     * Returns <code>true</code> if the given revision is set to committed in\n+     * the revisions map. That is, the revision exists in the map and the string\n+     * value is <code>\"true\"</code> or equals the <code>readRevision</code>.\n+     *\n+     * @param revision  the revision to check.\n+     * @param readRevision the read revision.\n+     * @param revisions the revisions map, or <code>null</code> if none is set.\n+     * @return <code>true</code> if the revision is committed, otherwise\n+     *         <code>false</code>.\n+     */\n+    private boolean isCommitted(@Nonnull Revision revision,\n+                                @Nonnull Revision readRevision,\n+                                @Nullable Map<String, String> revisions) {\n+        if (revision.equals(readRevision)) {\n+            return true;\n+        }\n+        if (revisions == null) {\n+            return false;\n+        }\n+        String value = revisions.get(revision.toString());\n+        if (value == null) {\n+            return false;\n+        }\n+        if (!value.equals(\"true\")) {\n+            revision = Revision.fromString(value);\n+        }\n+        return includeRevision(revision, readRevision);\n     }\n \n     public Children getChildren(String path, Revision rev, int limit) {\n@@ -447,12 +507,8 @@ private String getLatestValue(Map<String, String> valueMap, Revision min, Revisi\n     }\n \n     @Override\n-    public synchronized String getHeadRevision() throws MicroKernelException {\n-        String head = headRevision.toString();\n-        while (branchCommits.containsKey(head)) {\n-            head = branchCommits.get(head);\n-        }\n-        return head;\n+    public String getHeadRevision() throws MicroKernelException {\n+        return headRevision.toString();\n     }\n \n     @Override\n@@ -647,10 +703,10 @@ public synchronized String commit(String rootPath, String json, String baseRevId\n                 String sourcePath = path;\n                 String targetPath = t.readString();\n                 if (!PathUtils.isAbsolute(targetPath)) {\n-                    targetPath = PathUtils.concat(path, targetPath);\n+                    targetPath = PathUtils.concat(rootPath, targetPath);\n                 }\n                 commit.moveNode(sourcePath, targetPath);\n-                moveNode(sourcePath, targetPath, Revision.fromString(stripBranchRevMarker(baseRevId)), commit);\n+                moveNode(sourcePath, targetPath, baseRev, commit);\n                 break;\n             }\n             case '*': {\n@@ -659,23 +715,22 @@ public synchronized String commit(String rootPath, String json, String baseRevId\n                 String sourcePath = path;\n                 String targetPath = t.readString();\n                 if (!PathUtils.isAbsolute(targetPath)) {\n-                    targetPath = PathUtils.concat(path, targetPath);\n+                    targetPath = PathUtils.concat(rootPath, targetPath);\n                 }\n                 commit.copyNode(sourcePath, targetPath);\n-                copyNode(sourcePath, targetPath, Revision.fromString(stripBranchRevMarker(baseRevId)), commit);\n+                copyNode(sourcePath, targetPath, baseRev, commit);\n                 break;\n             }\n             default:\n                 throw new MicroKernelException(\"token: \" + (char) t.getTokenType());\n             }\n         }\n         if (baseRevId.startsWith(\"b\")) {\n-            // just commit to head currently\n-            commit.apply();\n+            // prepare commit\n+            commit.prepare(baseRev);\n             // remember branch commit\n-            branchCommits.put(rev.toString(), baseRevId.substring(1));\n+            branchCommits.put(rev, baseRev);\n \n-            headRevision = commit.getRevision();\n             return \"b\" + rev.toString();\n \n             // String jsonBranch = branchCommits.remove(revisionId);\n@@ -777,7 +832,8 @@ private Revision getLiveRevision(Map<String, Object> nodeMap,\n         String value = null;\n         for (String r : valueMap.keySet()) {\n             Revision propRev = Revision.fromString(r);\n-            if (isRevisionNewer(propRev, maxRev)) {\n+            if (isRevisionNewer(propRev, maxRev)\n+                    || !isValidRevision(propRev, maxRev, nodeMap)) {\n                 continue;\n             }\n             if (firstRev == null || isRevisionNewer(propRev, firstRev)) {\n@@ -799,7 +855,7 @@ private Revision getLiveRevision(Map<String, Object> nodeMap,\n      * @param onlyCommitted whether only committed changes should be considered\n      * @return the revision, or null if deleted\n      */\n-    Revision getNewestRevision(Map<String, Object> nodeMap, Revision before, boolean onlyCommitted) {\n+    @Nullable Revision getNewestRevision(Map<String, Object> nodeMap, Revision before, boolean onlyCommitted) {\n         if (nodeMap == null) {\n             return null;\n         }\n@@ -848,11 +904,11 @@ public static void parseAddNode(Commit commit, JsopReader t, String path) {\n     }\n \n     @Override\n-    public String branch(String trunkRevisionId) throws MicroKernelException {\n-        // TODO improve implementation if needed\n-        String branchId = \"b\" + trunkRevisionId;\n-        // branchCommits.put(branchId, \"\");\n-        return branchId;\n+    public String branch(@Nullable String trunkRevisionId) throws MicroKernelException {\n+        // nothing is written when the branch is created, the returned\n+        // revision simply acts as a reference to the branch base revision\n+        String revisionId = trunkRevisionId != null ? trunkRevisionId : headRevision.toString();\n+        return \"b\" + revisionId;\n     }\n \n     @Override\n@@ -865,11 +921,22 @@ public String merge(String branchRevisionId, String message)\n \n         // reading from the branch is reading from the trunk currently\n         String revisionId = branchRevisionId.substring(1).replace('+', ' ').trim();\n-        String baseRevId = revisionId;\n+        // make branch commits visible\n+        List<Revision> branchRevisions = new ArrayList<Revision>();\n+        UpdateOp op = new UpdateOp(\"/\", Utils.getIdFromPath(\"/\"), false);\n+        Revision baseRevId = Revision.fromString(revisionId);\n         while (baseRevId != null) {\n-            baseRevId = branchCommits.remove(baseRevId);\n+            branchRevisions.add(baseRevId);\n+            op.set(UpdateOp.REVISIONS + \".\" + baseRevId, \"true\");\n+            baseRevId = branchCommits.get(baseRevId);\n         }\n-        return revisionId;\n+        store.createOrUpdate(DocumentStore.Collection.NODES, op);\n+        // remove from branchCommits map after successful update\n+        for (Revision r : branchRevisions) {\n+            branchCommits.remove(r);\n+        }\n+        headRevision = newRevision();\n+        return headRevision.toString();\n \n         // TODO improve implementation if needed\n         // if (!branchRevisionId.startsWith(\"b\")) {",
                "deletions": 33
            },
            {
                "sha": "ec893c4722b4b101ddad4672f15bb3781d340658",
                "filename": "oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/AbstractMongoConnectionTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/AbstractMongoConnectionTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/AbstractMongoConnectionTest.java",
                "status": "modified",
                "changes": 14,
                "additions": 11,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/AbstractMongoConnectionTest.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -41,31 +41,39 @@\n     protected static final String DB =\n             System.getProperty(\"mongo.db\", \"MongoMKDB\");\n \n-    protected static MongoConnection mongoConnection;\n+    protected static Boolean mongoAvailable;\n+\n+    protected MongoConnection mongoConnection;\n \n     private static Exception mongoException = null;\n \n     @BeforeClass\n     public static void setUpBeforeClass() throws Exception {\n-        if (mongoConnection == null) {\n-            mongoConnection = new MongoConnection(HOST, PORT, DB);\n+        if (mongoAvailable == null) {\n+            MongoConnection mongoConnection = new MongoConnection(HOST, PORT, DB);\n             try {\n                 mongoConnection.getDB().command(new BasicDBObject(\"ping\", 1));\n+                mongoAvailable = Boolean.TRUE;\n             } catch (Exception e) {\n+                mongoAvailable = Boolean.FALSE;\n                 mongoException = e;\n+            } finally {\n+                mongoConnection.close();\n             }\n         }\n         Assume.assumeNoException(mongoException);\n     }\n \n     @Before\n     public void setUpConnection() throws Exception {\n+        mongoConnection = new MongoConnection(HOST, PORT, DB);\n         dropCollections(mongoConnection.getDB());\n     }\n \n     @After\n     public void tearDownConnection() throws Exception {\n         dropCollections(mongoConnection.getDB());\n+        mongoConnection.close();\n     }\n \n     protected void dropCollections(DB db) throws Exception {",
                "deletions": 3
            },
            {
                "sha": "5667c1111e03c15c0a13eed4f422ca26096787c6",
                "filename": "oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/BaseMongoMicroKernelTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/BaseMongoMicroKernelTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/BaseMongoMicroKernelTest.java",
                "status": "modified",
                "changes": 8,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/BaseMongoMicroKernelTest.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -39,7 +39,7 @@\n  */\n public class BaseMongoMicroKernelTest extends AbstractMongoConnectionTest {\n \n-    public static MicroKernel mk;\n+    public MicroKernel mk;\n \n     @Before\n     public void setUp() throws Exception {\n@@ -95,13 +95,13 @@ protected void assertNodesNotExist(String revision, String...paths) {\n     }\n \n     protected void assertPropExists(String rev, String path, String property) {\n-        String nodes = mk.getNodes(path, rev, -1 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        String nodes = mk.getNodes(path, rev, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n         JSONObject obj = parseJSONObject(nodes);\n         assertPropertyExists(obj, property);\n     }\n \n     protected void assertPropNotExists(String rev, String path, String property) {\n-        String nodes = mk.getNodes(path, rev, -1 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        String nodes = mk.getNodes(path, rev, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n         if (nodes == null) {\n             return;\n         }\n@@ -110,7 +110,7 @@ protected void assertPropNotExists(String rev, String path, String property) {\n     }\n \n     protected void assertPropValue(String rev, String path, String property, String value) {\n-        String nodes = mk.getNodes(path, rev, -1 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        String nodes = mk.getNodes(path, rev, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n         JSONObject obj = parseJSONObject(nodes);\n         assertPropertyValue(obj, property, value);\n     }",
                "deletions": 4
            },
            {
                "sha": "824fc8ccc51171d219bec41531775d0b65642f5d",
                "filename": "oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/BaseMongoMKTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/BaseMongoMKTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/BaseMongoMKTest.java",
                "status": "added",
                "changes": 42,
                "additions": 42,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/BaseMongoMKTest.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.mongomk.prototype;\n+\n+import org.apache.jackrabbit.mongomk.BaseMongoMicroKernelTest;\n+import org.apache.jackrabbit.mongomk.prototype.MongoMK;\n+import org.junit.Before;\n+\n+import com.mongodb.DB;\n+\n+/**\n+ * <code>BaseMongoMKTest</code>...\n+ */\n+public class BaseMongoMKTest extends BaseMongoMicroKernelTest {\n+\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        DB db = mongoConnection.getDB();\n+        mk = new MongoMK(db, 0);\n+    }\n+\n+    @Override\n+    public void tearDownConnection() throws Exception {\n+        super.tearDownConnection();\n+        ((MongoMK) mk).dispose();\n+    }\n+}",
                "deletions": 0
            },
            {
                "sha": "1fdb37127350e19f1b6a9b0bfc975180ab7b6dbe",
                "filename": "oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchMergeTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchMergeTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchMergeTest.java",
                "status": "added",
                "changes": 421,
                "additions": 421,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchMergeTest.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -0,0 +1,421 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.mongomk.prototype;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.apache.jackrabbit.mk.api.MicroKernelException;\n+import org.junit.Ignore;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Tests for {@code MicroKernel#branch}\n+ */\n+public class MongoMKBranchMergeTest extends BaseMongoMKTest {\n+\n+    @Test\n+    public void oneBranchAddedChildren1() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = addNodes(branchRev, \"/branch1\", \"/branch1/child1\");\n+        assertNodesExist(branchRev, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(branchRev, \"/branch1\", \"/branch1/child1\");\n+        assertNodesNotExist(null, \"/branch1\", \"/branch1/child1\");\n+\n+        addNodes(null, \"/trunk/child2\");\n+        assertNodesExist(null, \"/trunk/child2\");\n+        assertNodesNotExist(branchRev, \"/trunk/child2\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\", \"/trunk/child2\", \"/branch1\", \"/branch1/child1\");\n+    }\n+\n+    @Test\n+    public void oneBranchAddedChildren2() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = addNodes(branchRev, \"/trunk/child1/child2\");\n+        assertNodesExist(branchRev, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(branchRev, \"/trunk/child1/child2\");\n+        assertNodesNotExist(null, \"/trunk/child1/child2\");\n+\n+        addNodes(null, \"/trunk/child3\");\n+        assertNodesExist(null, \"/trunk/child3\");\n+        assertNodesNotExist(branchRev, \"/trunk/child3\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\", \"/trunk/child1/child2\", \"/trunk/child3\");\n+    }\n+\n+    @Test\n+    public void oneBranchAddedChildren3() {\n+        addNodes(null, \"/root\", \"/root/child1\");\n+        assertNodesExist(null, \"/root\", \"/root/child1\");\n+\n+        String branchRev = mk.branch(null);\n+        System.out.println(\"branchRev: \" + branchRev);\n+\n+        addNodes(null, \"/root/child2\");\n+        assertNodesExist(null, \"/root\", \"/root/child1\", \"/root/child2\");\n+        assertNodesExist(branchRev, \"/root\", \"/root/child1\");\n+        assertNodesNotExist(branchRev, \"/root/child2\");\n+\n+        branchRev = addNodes(branchRev, \"/root/child1/child3\", \"/root/child4\");\n+        assertNodesExist(branchRev, \"/root\", \"/root/child1\", \"/root/child1/child3\", \"/root/child4\");\n+        assertNodesNotExist(branchRev, \"/root/child2\");\n+        assertNodesExist(null, \"/root\", \"/root/child1\", \"/root/child2\");\n+        assertNodesNotExist(null, \"/root/child1/child3\", \"/root/child4\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/root\", \"/root/child1\", \"/root/child2\",\n+                \"/root/child1/child3\", \"/root/child4\");\n+    }\n+\n+    @Test\n+    public void oneBranchRemovedChildren() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = removeNodes(branchRev, \"/trunk/child1\");\n+        assertNodesExist(branchRev, \"/trunk\");\n+        assertNodesNotExist(branchRev, \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/trunk\");\n+        assertNodesNotExist(null, \"/trunk/child1\");\n+    }\n+\n+    @Test\n+    public void oneBranchRemovedRoot() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = removeNodes(branchRev, \"/trunk\");\n+        assertNodesNotExist(branchRev, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesNotExist(null, \"/trunk\", \"/trunk/child1\");\n+    }\n+\n+    /**\n+     * This is a test to make sure properties are properly escaped in merge.\n+     */\n+    @Test\n+    public void oneBranchAddPropertyRoot() {\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = setProp(branchRev, \"/jcr:primaryType\", \"nam:rep:root\");\n+        assertPropExists(branchRev, \"/\", \"jcr:primaryType\");\n+\n+        branchRev = mk.merge(branchRev, \"\");\n+        assertPropExists(branchRev, \"/\", \"jcr:primaryType\");\n+\n+        String mergedNode = mk.getNodes(\"/\", branchRev, 0, 0, -1, null);\n+        String expectedNode = \"{\\\"jcr:primaryType\\\":\\\"nam:rep:root\\\",\\\":childNodeCount\\\":0}\";\n+        assertEquals(\"Wrong property value after merge\", expectedNode, mergedNode);\n+    }\n+\n+    @Test\n+    public void oneBranchChangedProperties() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        setProp(null, \"/trunk/child1/prop1\", \"value1\");\n+        setProp(null, \"/trunk/child1/prop2\", \"value2\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop2\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = setProp(branchRev, \"/trunk/child1/prop1\", \"value1a\");\n+        branchRev = setProp(branchRev, \"/trunk/child1/prop2\", null);\n+        branchRev = setProp(branchRev, \"/trunk/child1/prop3\", \"value3\");\n+        assertPropValue(branchRev, \"/trunk/child1\", \"prop1\", \"value1a\");\n+        assertPropNotExists(branchRev, \"/trunk/child1\", \"prop2\");\n+        assertPropValue(branchRev, \"/trunk/child1\", \"prop3\", \"value3\");\n+        assertPropValue(null, \"/trunk/child1\", \"prop1\", \"value1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop2\");\n+        assertPropNotExists(null, \"/trunk/child1\", \"prop3\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertPropValue(null, \"/trunk/child1\", \"prop1\", \"value1a\");\n+        assertPropNotExists(null, \"/trunk/child1\", \"prop2\");\n+        assertPropValue(null, \"/trunk/child1\", \"prop3\", \"value3\");\n+    }\n+\n+    @Test\n+    public void oneBranchAddedSubChildren() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\", \"/trunk/child1/child2\", \"/trunk/child1/child2/child3\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\", \"/trunk/child1/child2\", \"/trunk/child1/child2/child3\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = addNodes(branchRev, \"/branch1\", \"/branch1/child1\", \"/branch1/child1/child2\", \"/branch1/child1/child2/child3\");\n+        assertNodesExist(branchRev, \"/trunk\", \"/trunk/child1\", \"/trunk/child1/child2\", \"/trunk/child1/child2/child3\");\n+        assertNodesExist(branchRev, \"/branch1\", \"/branch1/child1\", \"/branch1/child1/child2\", \"/branch1/child1/child2/child3\");\n+        assertNodesNotExist(null, \"/branch1\", \"/branch1/child1\", \"/branch1/child1/child2\", \"/branch1/child1/child2/child3\");\n+\n+        addNodes(null, \"/trunk/child1/child2/child3/child4\", \"/trunk/child5\");\n+        assertNodesExist(null, \"/trunk/child1/child2/child3/child4\", \"/trunk/child5\");\n+        assertNodesNotExist(branchRev, \"/trunk/child1/child2/child3/child4\", \"/trunk/child5\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\", \"/trunk/child1/child2\", \"/trunk/child1/child2/child3\", \"/trunk/child1/child2/child3/child4\");\n+        assertNodesExist(null, \"/branch1\", \"/branch1/child1\", \"/branch1/child1/child2\", \"/branch1/child1/child2/child3\");\n+    }\n+\n+    @Test\n+    public void oneBranchAddedChildrenAndAddedProperties() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        setProp(null, \"/trunk/child1/prop1\", \"value1\");\n+        setProp(null, \"/trunk/child1/prop2\", \"value2\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop2\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = addNodes(branchRev, \"/branch1\", \"/branch1/child1\");\n+        branchRev = setProp(branchRev, \"/branch1/child1/prop1\", \"value1\");\n+        branchRev = setProp(branchRev, \"/branch1/child1/prop2\", \"value2\");\n+        assertNodesExist(branchRev, \"/trunk\", \"/trunk/child1\");\n+        assertPropExists(branchRev, \"/trunk/child1\", \"prop1\");\n+        assertPropExists(branchRev, \"/trunk/child1\", \"prop2\");\n+        assertNodesExist(branchRev, \"/branch1\", \"/branch1/child1\");\n+        assertPropExists(branchRev, \"/branch1/child1\", \"prop1\");\n+        assertPropExists(branchRev, \"/branch1/child1\", \"prop2\");\n+        assertNodesNotExist(null, \"/branch1\", \"/branch1/child1\");\n+        assertPropNotExists(null, \"/branch1/child1\", \"prop1\");\n+        assertPropNotExists(null, \"/branch1/child1\", \"prop2\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop1\");\n+        assertPropExists(null, \"/trunk/child1\", \"prop2\");\n+        assertNodesExist(null, \"/branch1\", \"/branch1/child1\");\n+        assertPropExists(null, \"/branch1/child1\", \"prop1\");\n+        assertPropExists(null, \"/branch1/child1\", \"prop2\");\n+    }\n+\n+    @Test\n+    @Ignore\n+    public void twoBranchesAddedChildren1() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        String branchRev1 = mk.branch(null);\n+        String branchRev2 = mk.branch(null);\n+\n+        branchRev1 = addNodes(branchRev1, \"/branch1\", \"/branch1/child1\");\n+        branchRev2 = addNodes(branchRev2, \"/branch2\", \"/branch2/child2\");\n+        assertNodesExist(branchRev1, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(branchRev2, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(branchRev1, \"/branch1/child1\");\n+        assertNodesNotExist(branchRev1, \"/branch2/child2\");\n+        assertNodesExist(branchRev2, \"/branch2/child2\");\n+        assertNodesNotExist(branchRev2, \"/branch1/child1\");\n+        assertNodesNotExist(null, \"/branch1/child1\", \"/branch2/child2\");\n+\n+        addNodes(null, \"/trunk/child2\");\n+        assertNodesExist(null, \"/trunk/child2\");\n+        assertNodesNotExist(branchRev1, \"/trunk/child2\");\n+        assertNodesNotExist(branchRev2, \"/trunk/child2\");\n+\n+        mk.merge(branchRev1, \"\");\n+        assertNodesExist(null, \"/trunk\", \"/branch1\", \"/branch1/child1\");\n+        assertNodesNotExist(null, \"/branch2\", \"/branch2/child2\");\n+\n+        mk.merge(branchRev2, \"\");\n+        assertNodesExist(null, \"/trunk\", \"/branch1\", \"/branch1/child1\", \"/branch2\", \"/branch2/child2\");\n+    }\n+\n+    @Test\n+    @Ignore\n+    public void oneBranchAddedChildrenWithConflict() {\n+        addNodes(null, \"/trunk\", \"/trunk/child1\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = removeNodes(branchRev, \"/trunk/child1\");\n+        assertNodesExist(branchRev, \"/trunk\");\n+        assertNodesNotExist(branchRev, \"/trunk/child1\");\n+\n+        addNodes(null, \"/trunk/child1/child2\");\n+        assertNodesExist(null, \"/trunk\", \"/trunk/child1\", \"/trunk/child1/child2\");\n+\n+        mk.merge(branchRev, \"\");\n+        assertNodesExist(null, \"/trunk\");\n+        assertNodesNotExist(null, \"/trunk/child1\", \"/trunk/child1/child2\");\n+    }\n+\n+    @Test\n+    @Ignore\n+    public void oneBranchChangedPropertiesWithConflict() {\n+        addNodes(null, \"/trunk\");\n+        setProp(null, \"/trunk/prop1\", \"value1\");\n+        assertPropExists(null, \"/trunk\", \"prop1\");\n+\n+        String branchRev = mk.branch(null);\n+\n+        branchRev = setProp(branchRev, \"/trunk/prop1\", \"value1a\");\n+        assertPropValue(branchRev, \"/trunk\", \"prop1\", \"value1a\");\n+\n+        setProp(null, \"/trunk/prop1\", \"value1b\");\n+        try {\n+            mk.merge(branchRev, \"\");\n+            fail(\"Expected: Concurrent modification exception\");\n+        } catch (Exception expected){}\n+    }\n+\n+    @Test\n+    @Ignore\n+    public void addExistingRootInBranch() {\n+        addNodes(null, \"/root\");\n+        assertNodesExist(null, \"/root\");\n+\n+        String branchRev = mk.branch(null);\n+        try {\n+            branchRev = addNodes(branchRev, \"/root\");\n+            fail(\"Should not be able to add the same root node twice\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    @Ignore\n+    public void addExistingChildInBranch() {\n+        addNodes(null, \"/root\", \"/root/child1\");\n+        assertNodesExist(null, \"/root\", \"/root/child1\");\n+\n+        String branchRev = mk.branch(null);\n+        branchRev = addNodes(branchRev, \"/root/child2\");\n+        assertNodesExist(branchRev, \"/root/child1\", \"/root/child2\");\n+\n+        try {\n+            branchRev = addNodes(branchRev, \"/root/child1\");\n+            fail(\"Should not be able to add the same root node twice\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    @Ignore(\"Implementation specific behavior\")\n+    public void emptyMergeCausesNoChange() {\n+        String rev1 = mk.commit(\"\", \"+\\\"/child1\\\":{}\", null, \"\");\n+\n+        String branchRev = mk.branch(null);\n+        branchRev = mk.commit(\"\", \"+\\\"/child2\\\":{}\", branchRev, \"\");\n+        branchRev = mk.commit(\"\", \"-\\\"/child2\\\"\", branchRev, \"\");\n+\n+        String rev2 = mk.merge(branchRev, \"\");\n+\n+        assertTrue(mk.nodeExists(\"/child1\", null));\n+        assertFalse(mk.nodeExists(\"/child2\", null));\n+        assertEquals(rev1, rev2);\n+    }\n+\n+    @Test\n+    public void trunkMergeNotAllowed() {\n+        String rev = mk.commit(\"\", \"+\\\"/child1\\\":{}\", null, \"\");\n+        try {\n+            mk.merge(rev, \"\");\n+            fail(\"Exception expected\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    @Ignore\n+    public void movesInBranch() {\n+        String rev = mk.commit(\"/\", \"+\\\"a\\\":{\\\"b\\\":{}}\", null, null);\n+        String branchRev = mk.branch(rev);\n+        branchRev = mk.commit(\"/\", \">\\\"a\\\":\\\"x\\\"^\\\"x/b/p\\\":1>\\\"x\\\":\\\"a\\\"\", branchRev, null);\n+        rev = mk.merge(branchRev, null);\n+        assertNodesExist(rev, \"/a\", \"/a/b\");\n+        assertPropExists(rev, \"/a/b\", \"p\");\n+    }\n+\n+    @Test\n+    public void concurrentNonConflictingMerges() throws Exception {\n+        int numThreads = 10;\n+        mk.commit(\"/\", \"+\\\"test\\\":{}\", null, null);\n+        List<Thread> workers = new ArrayList<Thread>();\n+        final List<Exception> exceptions = Collections.synchronizedList(new ArrayList<Exception>());\n+        for (int i = 0; i < numThreads; i++) {\n+            final String path = \"/test/t\" + i;\n+            mk.commit(\"\", \"+\\\"\" + path + \"\\\":{}\", null, null);\n+            workers.add(new Thread(new Runnable() {\n+                @Override\n+                public void run() {\n+                    try {\n+                        for (int i = 0; i < 50; i++) {\n+                            String branchRev = mk.branch(null);\n+                            branchRev = mk.commit(path, \"+\\\"node\" + i + \"\\\":{}\", branchRev, null);\n+                            mk.merge(branchRev, null);\n+                        }\n+                    } catch (MicroKernelException e) {\n+                        exceptions.add(e);\n+                    }\n+                }\n+            }));\n+        }\n+        for (Thread t : workers) {\n+            t.start();\n+        }\n+        for (Thread t : workers) {\n+            t.join();\n+        }\n+        if (!exceptions.isEmpty()) {\n+            throw exceptions.get(0);\n+        }\n+    }\n+\n+    private String addNodes(String rev, String...nodes) {\n+        for (String node : nodes) {\n+            rev = mk.commit(\"\", \"+\\\"\" + node + \"\\\":{}\", rev, \"\");\n+        }\n+        return rev;\n+    }\n+\n+    private String removeNodes(String rev, String...nodes) {\n+        for (String node : nodes) {\n+            rev = mk.commit(\"\", \"-\\\"\" + node + \"\\\"\", rev, \"\");\n+        }\n+        return rev;\n+    }\n+\n+    private String setProp(String rev, String prop, Object value) {\n+        value = value == null? null : \"\\\"\" + value + \"\\\"\";\n+        return mk.commit(\"\", \"^\\\"\" + prop + \"\\\" : \" + value, rev, \"\");\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            },
            {
                "sha": "59ae766ba9e64a5deda0cb6db89c629f8ff165a9",
                "filename": "oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchTest.java",
                "status": "added",
                "changes": 77,
                "additions": 77,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKBranchTest.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.mongomk.prototype;\n+\n+import org.json.simple.JSONObject;\n+import org.json.simple.parser.JSONParser;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * <code>MongoMKBranchTest</code> performs a test to check if commits\n+ * to a branch are not visible to other branches.\n+ */\n+public class MongoMKBranchTest extends BaseMongoMKTest {\n+\n+    /**\n+     * Creates the following revision history:\n+     * <pre>\n+     *   + rev1 (first commit with /child1)\n+     *   |\\\n+     *   | + branchRev1 (branch from rev1)\n+     *   | + branchRev11 (branch commit /child1/foo:1)\n+     *   |\n+     *   + rev2 (second commit with /child2)\n+     *   |\\\n+     *   | + branchRev2 (brach from rev2)\n+     * </pre>\n+     * The test reads /child from <code>branchRev2</code> and expects\n+     * the version from the first commit.\n+     */\n+    @Test\n+    public void isolatedBranches() throws Exception {\n+        String rev1 = mk.commit(\"\", \"+\\\"/child1\\\":{}\", null, \"\");\n+\n+        String branchRev1 = mk.branch(rev1);\n+        mk.commit(\"/child1\", \"^\\\"foo\\\":1\", branchRev1, \"\");\n+\n+        String rev2 = mk.commit(\"\", \"+\\\"/child2\\\":{}\", null, \"\");\n+\n+        String branchRev2 = mk.branch(rev2);\n+        String json = mk.getNodes(\"/child1\", branchRev2, 0, 0, -1, null);\n+        JSONParser parser = new JSONParser();\n+        JSONObject obj = (JSONObject) parser.parse(json);\n+        assertFalse(obj.containsKey(\"foo\"));\n+    }\n+\n+    @Test\n+    public void movesInBranch() throws Exception {\n+        String branchRev = mk.branch(null);\n+        branchRev = mk.commit(\"/\", \"+\\\"a\\\":{}\", branchRev, null);\n+        branchRev = mk.commit(\"/a\", \"^\\\"foo\\\":1\", branchRev, null);\n+        branchRev = mk.commit(\"/\", \">\\\"a\\\" : \\\"b\\\"\", branchRev, null);\n+        branchRev = mk.commit(\"/\", \">\\\"b\\\" : \\\"a\\\"\", branchRev, null);\n+        mk.merge(branchRev, null);\n+\n+        String json = mk.getNodes(\"/a\", null, 0, 0, -1, null);\n+        JSONParser parser = new JSONParser();\n+        JSONObject obj = (JSONObject) parser.parse(json);\n+        assertTrue(obj.containsKey(\"foo\"));\n+    }\n+}",
                "deletions": 0
            },
            {
                "sha": "b69ccb20270f3e47ef995388999ea9a4d4146a4e",
                "filename": "oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKCommitMoveTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKCommitMoveTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/db039944fd62e1c48e58cbaacecba8021d96bb0a/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKCommitMoveTest.java",
                "status": "added",
                "changes": 365,
                "additions": 365,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-mongomk/src/test/java/org/apache/jackrabbit/mongomk/prototype/MongoMKCommitMoveTest.java?ref=db039944fd62e1c48e58cbaacecba8021d96bb0a",
                "patch": "@@ -0,0 +1,365 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.mongomk.prototype;\n+\n+import org.apache.jackrabbit.mongomk.impl.MongoMicroKernel;\n+import org.json.simple.JSONObject;\n+import org.junit.Ignore;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Tests for {@link MongoMicroKernel#commit(String, String, String, String)}\n+ * with emphasis on move operations.\n+ */\n+@Ignore\n+public class MongoMKCommitMoveTest extends BaseMongoMKTest {\n+\n+    @Test\n+    public void moveNode() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : {}\", null, null);\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+\n+        mk.commit(\"/\", \">\\\"a\\\" : \\\"b\\\"\", null, null);\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/b\", null));\n+    }\n+\n+    @Test\n+    public void moveUnderSourcePath() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : { \\\"b\\\" : {} }\", null, null);\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/a/b\", null));\n+\n+        try {\n+            mk.commit(\"/\", \">\\\"b\\\" : \\\"a\\\"\", null, null);\n+            fail(\"Exception expected\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    public void moveNodeWithChild() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : { \\\"b\\\" : {} }\", null, null);\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/a/b\", null));\n+\n+        mk.commit(\"/\", \">\\\"a\\\" : \\\"c\\\"\", null, null);\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+        assertTrue(mk.nodeExists(\"/c/b\", null));\n+    }\n+\n+    @Test\n+    public void moveNodeWithChildren() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : { \\\"b\\\" : {},  \\\"c\\\" : {}, \\\"d\\\" : {}}\", null, null);\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/a/c\", null));\n+        assertTrue(mk.nodeExists(\"/a/d\", null));\n+\n+        mk.commit(\"/\", \">\\\"a\\\" : \\\"e\\\"\", null, null);\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertFalse(mk.nodeExists(\"/a/c\", null));\n+        assertFalse(mk.nodeExists(\"/a/d\", null));\n+        assertTrue(mk.nodeExists(\"/e\", null));\n+        assertTrue(mk.nodeExists(\"/e/b\", null));\n+        assertTrue(mk.nodeExists(\"/e/c\", null));\n+        assertTrue(mk.nodeExists(\"/e/d\", null));\n+    }\n+\n+    @Test\n+    public void moveNodeWithNestedChildren() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : { \\\"b\\\" : { \\\"c\\\" : { \\\"d\\\" : {} } } }\", null, null);\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/a/b/c\", null));\n+        assertTrue(mk.nodeExists(\"/a/b/c/d\", null));\n+\n+        mk.commit(\"/\", \">\\\"a\\\" : \\\"e\\\"\", null, null);\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertFalse(mk.nodeExists(\"/a/b/c\", null));\n+        assertFalse(mk.nodeExists(\"/a/b/c/d\", null));\n+        assertTrue(mk.nodeExists(\"/e\", null));\n+        assertTrue(mk.nodeExists(\"/e/b\", null));\n+        assertTrue(mk.nodeExists(\"/e/b/c\", null));\n+        assertTrue(mk.nodeExists(\"/e/b/c/d\", null));\n+\n+        mk.commit(\"/\", \">\\\"e/b\\\" : \\\"f\\\"\", null, null);\n+        assertTrue(mk.nodeExists(\"/e\", null));\n+        assertFalse(mk.nodeExists(\"/e/b\", null));\n+        assertFalse(mk.nodeExists(\"/e/b/c\", null));\n+        assertFalse(mk.nodeExists(\"/e/b/c/d\", null));\n+        assertTrue(mk.nodeExists(\"/f\", null));\n+        assertTrue(mk.nodeExists(\"/f/c\", null));\n+        assertTrue(mk.nodeExists(\"/f/c/d\", null));\n+    }\n+\n+    @Test\n+    public void moveNodeWithProperties() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : { \\\"key1\\\" : \\\"value1\\\" }\", null, null);\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        String nodes = mk.getNodes(\"/a\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyValue(obj, \"key1\", \"value1\");\n+\n+        mk.commit(\"/\", \">\\\"a\\\" : \\\"c\\\"\", null, null);\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+        nodes = mk.getNodes(\"/c\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        obj = parseJSONObject(nodes);\n+        assertPropertyValue(obj, \"key1\", \"value1\");\n+    }\n+\n+    @Test\n+    public void moveFromNonExistentNode() throws Exception {\n+        try {\n+            mk.commit(\"/\", \">\\\"b\\\" : \\\"c\\\"\", null, null);\n+            fail(\"Exception expected\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    public void moveToAnExistentNode() throws Exception {\n+        mk.commit(\"/\", \"+\\\"a\\\" : { \\\"b\\\" : {} }\", null, null);\n+        mk.commit(\"/\", \"+\\\"c\\\" : {}\", null, null);\n+\n+        try {\n+            mk.commit(\"/\", \">\\\"c\\\" : \\\"a/b\\\"\", null, null);\n+            fail(\"Exception expected\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    public void addNodeAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \"+\\\"a/b\\\": {}\\n\"\n+                     + \">\\\"a/b\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+    }\n+\n+    @Test\n+    public void addNodeAndMove2() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \"+\\\"a/b\\\": {}\\n\", null, null);\n+        mk.commit(\"/\", \">\\\"a/b\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+    }\n+\n+    @Test\n+    public void addNodeWithChildrenAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \"+\\\"a/b\\\":{ \\\"c\\\" : {}, \\\"d\\\" : {} }\\n\"\n+                     + \">\\\"a/b\\\":\\\"e\\\"\", null, null);\n+\n+        assertTrue(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertFalse(mk.nodeExists(\"/a/b/c\", null));\n+        assertFalse(mk.nodeExists(\"/a/b/d\", null));\n+\n+        assertTrue(mk.nodeExists(\"/e\", null));\n+        assertTrue(mk.nodeExists(\"/e/c\", null));\n+        assertTrue(mk.nodeExists(\"/e/d\", null));\n+    }\n+\n+    @Test\n+    public void addNodeWithNestedChildrenAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"b\\\" : { \\\"c\\\" : { } } }\", null, null);\n+        mk.commit(\"/\", \"+\\\"a/b/c/d\\\":{}\\n\"\n+                     + \">\\\"a\\\":\\\"e\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a/b/c/d\", null));\n+        assertTrue(mk.nodeExists(\"/e/b/c/d\", null));\n+    }\n+\n+    @Test\n+    public void addNodeAndMoveParent() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \"+\\\"a/b\\\":{}\\n\" +\n+                        \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+        assertTrue(mk.nodeExists(\"/c/b\", null));\n+    }\n+\n+    @Test\n+    public void removeNodeAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"b\\\" : {} }\", null, null);\n+\n+        try {\n+            mk.commit(\"/\", \"-\\\"a/b\\\"\\n\"\n+                         + \">\\\"a/b\\\":\\\"c\\\"\", null, null);\n+            fail(\"Expected expected\");\n+        } catch (Exception expected) {}\n+    }\n+\n+    @Test\n+    public void removeNodeWithNestedChildrenAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"b\\\" : { \\\"c\\\" : { \\\"d\\\" : {} } } }\", null, null);\n+        mk.commit(\"/\", \"-\\\"a/b/c/d\\\"\\n\"\n+                     + \">\\\"a\\\" : \\\"e\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/e/b/c\", null));\n+        assertFalse(mk.nodeExists(\"/e/b/c/d\", null));\n+    }\n+\n+    @Test\n+    public void removeNodeAndMoveParent() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"b\\\" : {} }\", null, null);\n+        mk.commit(\"/\", \"-\\\"a/b\\\"\\n\"\n+                     + \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+        assertFalse(mk.nodeExists(\"/c/b\", null));\n+    }\n+\n+    @Test\n+    public void setPropertyAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \"^\\\"a/key1\\\": \\\"value1\\\"\\n\" +\n+                        \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+\n+        String nodes = mk.getNodes(\"/c\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyValue(obj, \"key1\", \"value1\");\n+    }\n+\n+    @Test\n+    public void setNestedPropertyAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"b\\\" : {} }\", null, null);\n+        mk.commit(\"/\", \"^\\\"a/b/key1\\\": \\\"value1\\\"\\n\" +\n+                        \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+        assertTrue(mk.nodeExists(\"/c/b\", null));\n+\n+        String nodes = mk.getNodes(\"/c/b\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyValue(obj, \"key1\", \"value1\");\n+    }\n+\n+    @Test\n+    public void modifyParentAddPropertyAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \"+\\\"b\\\" : {}\\n\"\n+                     + \"^\\\"a/key1\\\": \\\"value1\\\"\\n\"\n+                     + \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+\n+        String nodes = mk.getNodes(\"/c\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyValue(obj, \"key1\", \"value1\");\n+    }\n+\n+    @Test\n+    public void removePropertyAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"b\\\" : { \\\"key1\\\" : \\\"value1\\\" } }\", null, null);\n+        mk.commit(\"/\", \"^\\\"a/b/key1\\\": null\\n\"\n+                     + \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertFalse(mk.nodeExists(\"/a/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+        assertTrue(mk.nodeExists(\"/c/b\", null));\n+\n+        String nodes = mk.getNodes(\"/c/b\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyNotExists(obj, \"key1\");\n+    }\n+\n+    @Test\n+    public void removeNestedPropertyAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"key1\\\" : \\\"value1\\\"}\", null, null);\n+        mk.commit(\"/\", \"^\\\"a/key1\\\" : null\\n\"\n+                     + \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+\n+        String nodes = mk.getNodes(\"/c\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyNotExists(obj, \"key1\");\n+    }\n+\n+    @Test\n+    public void modifyParentRemovePropertyAndMove() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{ \\\"key1\\\" : \\\"value1\\\"}\", null, null);\n+        mk.commit(\"/\", \"+\\\"b\\\" : {}\\n\"\n+                     + \"^\\\"a/key1\\\" : null\\n\"\n+                     + \">\\\"a\\\":\\\"c\\\"\", null, null);\n+\n+        assertFalse(mk.nodeExists(\"/a\", null));\n+        assertTrue(mk.nodeExists(\"/b\", null));\n+        assertTrue(mk.nodeExists(\"/c\", null));\n+\n+        String nodes = mk.getNodes(\"/c\", null, 0 /*depth*/, 0 /*offset*/, -1 /*maxChildNodes*/, null /*filter*/);\n+        JSONObject obj = parseJSONObject(nodes);\n+        assertPropertyNotExists(obj, \"key1\");\n+    }\n+\n+    @Test\n+    public void moveAndMoveBack() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{}\", null, null);\n+        mk.commit(\"/\", \">\\\"a\\\":\\\"x\\\">\\\"x\\\":\\\"a\\\"\", null, null);\n+        assertNodesExist(null, \"/a\");\n+    }\n+\n+    @Test\n+    public void moveAndMoveBackWithChildren() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{\\\"b\\\":{}}\", null, null);\n+        mk.commit(\"/\", \">\\\"a\\\":\\\"x\\\">\\\"x\\\":\\\"a\\\"\", null, null);\n+        assertNodesExist(null, \"/a\", \"/a/b\");\n+    }\n+\n+    @Test\n+    public void moveAndMoveBackWithAddedChildren() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{\\\"b\\\":{}}\", null, null);\n+        mk.commit(\"/\", \">\\\"a\\\":\\\"x\\\"+\\\"x/c\\\":{}>\\\"x\\\":\\\"a\\\"\", null, null);\n+        assertNodesExist(null, \"/a\", \"/a/b\", \"/a/c\");\n+    }\n+\n+    @Test\n+    public void moveAndMoveBackWithSetProperties() {\n+        mk.commit(\"/\", \"+\\\"a\\\":{\\\"b\\\":{}}\", null, null);\n+        mk.commit(\"/\", \">\\\"a\\\":\\\"x\\\"^\\\"x/p\\\":1>\\\"x\\\":\\\"a\\\"\", null, null);\n+        assertNodesExist(null, \"/a\", \"/a/b\");\n+        assertPropExists(null, \"/a\", \"p\");\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            }
        ],
        "patched_files": [
            "MongoMK.java",
            "MemoryDocumentStore.java",
            "Commit.java",
            "DocumentStore.java",
            "MongoDocumentStore.java"
        ],
        "unit_tests": [
            "MongoMKCommitMoveTest.java",
            "BaseMongoMicroKernelTest.java",
            "MongoDocumentStoreTest.java",
            "MongoMKBranchTest.java",
            "BaseMongoMKTest.java",
            "AbstractMongoConnectionTest.java",
            "MongoMKBranchMergeTest.java"
        ]
    },
    "jackrabbit-oak_aadf67e": {
        "repo": "jackrabbit-oak",
        "message": "OAK-4248 More tests for the exposed 'basic' package \n OAK-4249 Extract abstract test-base without OSGi registrations\nOAK-4251 Guard against NPE in DefaultSyncConfig.Authorizable.setAutoMembership\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1740114 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/c9c8744830a72da9d3b0515606852869f869542b",
        "bug_id": "jackrabbit-oak_aadf67e",
        "file": [
            {
                "sha": "ef81e68afb5948ae543f5a51363f53035010c717",
                "filename": "oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfig.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfig.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfig.java",
                "status": "modified",
                "changes": 6,
                "additions": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/main/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfig.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -118,7 +118,9 @@ public Authorizable setExpirationTime(long expirationTime) {\n         }\n \n         /**\n-         * Sets the auto membership\n+         * Sets the auto membership. Note that the passed group names will be trimmed\n+         * and empty string values will be ignored (along with {@code null} values).\n+         *\n          * @param autoMembership the membership\n          * @return {@code this}\n          * @see #getAutoMembership()\n@@ -127,7 +129,7 @@ public Authorizable setExpirationTime(long expirationTime) {\n         public Authorizable setAutoMembership(@Nonnull String ... autoMembership) {\n             this.autoMembership = new HashSet<String>();\n             for (String groupName: autoMembership) {\n-                if (!groupName.trim().isEmpty()) {\n+                if (groupName != null && !groupName.trim().isEmpty()) {\n                     this.autoMembership.add(groupName.trim());\n                 }\n             }",
                "deletions": 2
            },
            {
                "sha": "76fe3f9f6e7f47d4c961cf9de91e8cf201d300c0",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/AbstractExternalAuthTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/AbstractExternalAuthTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/AbstractExternalAuthTest.java",
                "status": "added",
                "changes": 130,
                "additions": 130,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/AbstractExternalAuthTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -0,0 +1,130 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.spi.security.authentication.external;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import javax.jcr.RepositoryException;\n+\n+import com.google.common.base.Function;\n+import com.google.common.base.Predicates;\n+import com.google.common.collect.Iterators;\n+import com.google.common.collect.Sets;\n+import org.apache.jackrabbit.api.security.user.Authorizable;\n+import org.apache.jackrabbit.api.security.user.UserManager;\n+import org.apache.jackrabbit.oak.AbstractSecurityTest;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.basic.DefaultSyncConfig;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+/**\n+ * Abstract base test for external-authentication tests.\n+ */\n+public abstract class AbstractExternalAuthTest extends AbstractSecurityTest {\n+\n+    protected static final String USER_ID = TestIdentityProvider.ID_TEST_USER;\n+    protected static final String TEST_CONSTANT_PROPERTY_NAME = \"profile/constantProperty\";\n+    protected static final String TEST_CONSTANT_PROPERTY_VALUE = \"constant-value\";\n+\n+    protected ExternalIdentityProvider idp;\n+\n+    protected DefaultSyncConfig syncConfig;\n+\n+    private Set<String> ids;\n+\n+    @Before\n+    public void before() throws Exception {\n+        super.before();\n+\n+        getTestUser();\n+        ids = Sets.newHashSet(getAllAuthorizableIds(getUserManager(root)));\n+\n+        idp = createIDP();\n+        syncConfig = createSyncConfig();\n+    }\n+\n+    @After\n+    public void after() throws Exception {\n+        try {\n+            destroyIDP();\n+            idp = null;\n+\n+            // discard any pending changes\n+            root.refresh();\n+\n+            UserManager userManager = getUserManager(root);\n+            Iterator<String> iter = getAllAuthorizableIds(userManager);\n+            while (iter.hasNext()) {\n+                String id = iter.next();\n+                if (!ids.remove(id)) {\n+                    Authorizable a = userManager.getAuthorizable(id);\n+                    if (a != null) {\n+                        a.remove();\n+                    }\n+                }\n+            }\n+            root.commit();\n+        } finally {\n+            root.refresh();\n+            super.after();\n+        }\n+    }\n+\n+    private static Iterator<String> getAllAuthorizableIds(@Nonnull UserManager userManager) throws Exception {\n+        Iterator<Authorizable> iter = userManager.findAuthorizables(\"jcr:primaryType\", null);\n+        return Iterators.filter(Iterators.transform(iter, new Function<Authorizable, String>() {\n+            @Nullable\n+            @Override\n+            public String apply(Authorizable input) {\n+                try {\n+                    if (input != null) {\n+                        return input.getID();\n+                    }\n+                } catch (RepositoryException e) {\n+                    // failed to retrieve ID\n+                }\n+                return null;\n+            }\n+        }), Predicates.notNull());\n+    }\n+\n+\n+    protected ExternalIdentityProvider createIDP() {\n+        return new TestIdentityProvider();\n+    }\n+\n+    protected void destroyIDP() {\n+        // nothing to do\n+    }\n+\n+    protected DefaultSyncConfig createSyncConfig() {\n+        DefaultSyncConfig syncConfig = new DefaultSyncConfig();\n+        Map<String, String> mapping = new HashMap<String, String>();\n+        mapping.put(\"name\", \"name\");\n+        mapping.put(\"email\", \"email\");\n+        mapping.put(\"profile/name\", \"profile/name\");\n+        mapping.put(\"profile/age\", \"profile/age\");\n+        mapping.put(TEST_CONSTANT_PROPERTY_NAME, \"\\\"\" + TEST_CONSTANT_PROPERTY_VALUE + \"\\\"\");\n+        syncConfig.user().setPropertyMapping(mapping);\n+        syncConfig.user().setMembershipNestingDepth(1);\n+        return syncConfig;\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            },
            {
                "sha": "93d3cf8af4e49f3c3401e8a3608ffa40ffcb496f",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTest.java",
                "status": "modified",
                "changes": 9,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -53,15 +53,6 @@ public void after() throws Exception {\n         super.after();\n     }\n \n-    protected ExternalIdentityProvider createIDP() {\n-        return new TestIdentityProvider();\n-    }\n-\n-    @Override\n-    protected void destroyIDP(ExternalIdentityProvider idp) {\n-    // ignore\n-    }\n-\n     @Test\n     public void testLoginFailed() throws Exception {\n         UserManager userManager = getUserManager(root);",
                "deletions": 9
            },
            {
                "sha": "5ae2c088088af5d086e55a02c2c75ab480f3a690",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTestBase.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTestBase.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTestBase.java",
                "status": "modified",
                "changes": 91,
                "additions": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/ExternalLoginModuleTestBase.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -19,23 +19,9 @@\n \n import java.util.Collections;\n import java.util.HashMap;\n-import java.util.Iterator;\n-import java.util.Map;\n-import java.util.Set;\n-\n-import javax.annotation.Nonnull;\n-import javax.annotation.Nullable;\n-import javax.jcr.RepositoryException;\n import javax.security.auth.login.AppConfigurationEntry;\n import javax.security.auth.login.Configuration;\n \n-import com.google.common.base.Function;\n-import com.google.common.base.Predicates;\n-import com.google.common.collect.Iterators;\n-import com.google.common.collect.Sets;\n-import org.apache.jackrabbit.api.security.user.Authorizable;\n-import org.apache.jackrabbit.api.security.user.UserManager;\n-import org.apache.jackrabbit.oak.AbstractSecurityTest;\n import org.apache.jackrabbit.oak.Oak;\n import org.apache.jackrabbit.oak.spi.security.authentication.external.basic.DefaultSyncConfig;\n import org.apache.jackrabbit.oak.spi.security.authentication.external.impl.DefaultSyncHandler;\n@@ -49,106 +35,47 @@\n import org.junit.Before;\n \n /**\n- * Abstract base test for external-authentication tests.\n+ * Abstract base test for external-authentication including proper OSGi service\n+ * registrations required for repository login respecting the {@link ExternalLoginModule}.\n  */\n-public abstract class ExternalLoginModuleTestBase extends AbstractSecurityTest {\n-\n-    protected static final String USER_ID = TestIdentityProvider.ID_TEST_USER;\n-    protected static final String TEST_CONSTANT_PROPERTY_NAME = \"profile/constantProperty\";\n-    protected static final String TEST_CONSTANT_PROPERTY_VALUE = \"constant-value\";\n-\n-    private Set<String> ids;\n+public abstract class ExternalLoginModuleTestBase extends AbstractExternalAuthTest {\n \n     private Registration testIdpReg;\n-\n     private Registration syncHandlerReg;\n \n     protected final HashMap<String, Object> options = new HashMap<String, Object>();\n \n     protected Whiteboard whiteboard;\n \n-    protected ExternalIdentityProvider idp;\n-\n     protected SyncManager syncManager;\n \n     protected ExternalIdentityProviderManager idpManager;\n \n-    protected DefaultSyncConfig syncConfig;\n-\n     @Before\n     public void before() throws Exception {\n         super.before();\n-        ids = Sets.newHashSet(getAllAuthorizableIds(getUserManager(root)));\n-        idp = createIDP();\n \n         testIdpReg = whiteboard.register(ExternalIdentityProvider.class, idp, Collections.<String, Object>emptyMap());\n \n         options.put(ExternalLoginModule.PARAM_SYNC_HANDLER_NAME, \"default\");\n         options.put(ExternalLoginModule.PARAM_IDP_NAME, idp.getName());\n \n-        // set default sync config\n-        syncConfig = new DefaultSyncConfig();\n-        Map<String, String> mapping = new HashMap<String, String>();\n-        mapping.put(\"name\", \"name\");\n-        mapping.put(\"email\", \"email\");\n-        mapping.put(\"profile/name\", \"profile/name\");\n-        mapping.put(\"profile/age\", \"profile/age\");\n-        mapping.put(TEST_CONSTANT_PROPERTY_NAME, \"\\\"\" + TEST_CONSTANT_PROPERTY_VALUE + \"\\\"\");\n-        syncConfig.user().setPropertyMapping(mapping);\n-        syncConfig.user().setMembershipNestingDepth(1);\n         setSyncConfig(syncConfig);\n     }\n \n     @After\n     public void after() throws Exception {\n-        if (testIdpReg != null) {\n-            testIdpReg.unregister();\n-            testIdpReg = null;\n-        }\n-        destroyIDP(idp);\n-        idp = null;\n-        setSyncConfig(null);\n-\n         try {\n-            // discard any pending changes\n-            root.refresh();\n-\n-            UserManager userManager = getUserManager(root);\n-            Iterator<String> iter = getAllAuthorizableIds(userManager);\n-            while (iter.hasNext()) {\n-                String id = iter.next();\n-                if (!ids.remove(id)) {\n-                    Authorizable a = userManager.getAuthorizable(id);\n-                    if (a != null) {\n-                        a.remove();\n-                    }\n-                }\n+            if (testIdpReg != null) {\n+                testIdpReg.unregister();\n+                testIdpReg = null;\n             }\n-            root.commit();\n+            setSyncConfig(null);\n         } finally {\n-            root.refresh();\n             super.after();\n         }\n     }\n \n-    private static Iterator<String> getAllAuthorizableIds(@Nonnull UserManager userManager) throws Exception {\n-        Iterator<Authorizable> iter = userManager.findAuthorizables(\"jcr:primaryType\", null);\n-        return Iterators.filter(Iterators.transform(iter, new Function<Authorizable, String>() {\n-            @Nullable\n-            @Override\n-            public String apply(Authorizable input) {\n-                try {\n-                    if (input != null) {\n-                        return input.getID();\n-                    }\n-                } catch (RepositoryException e) {\n-                    // failed to retrieve ID\n-                }\n-                return null;\n-            }\n-        }), Predicates.notNull());\n-    }\n-\n     @Override\n     protected Oak withEditors(Oak oak) {\n         super.withEditors(oak);\n@@ -163,10 +90,6 @@ protected Oak withEditors(Oak oak) {\n         return oak;\n     }\n \n-    protected abstract ExternalIdentityProvider createIDP();\n-\n-    protected abstract void destroyIDP(ExternalIdentityProvider idp);\n-\n     protected SynchronizationMBean createMBean() {\n         // todo: how to retrieve JCR repository here? maybe we should base the sync mbean on oak directly (=> OAK-4218).\n         // JackrabbitRepository repository =  null;",
                "deletions": 84
            },
            {
                "sha": "1fa86248883d47fab9fe9539a75c9a85b2ecb62d",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfigTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfigTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfigTest.java",
                "status": "added",
                "changes": 101,
                "additions": 101,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncConfigTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -0,0 +1,101 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.spi.security.authentication.external.basic;\n+\n+import java.util.Map;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertSame;\n+import static org.junit.Assert.assertTrue;\n+\n+public class DefaultSyncConfigTest {\n+\n+    private DefaultSyncConfig config = new DefaultSyncConfig();\n+\n+    private static void assertAuthorizableConfig(@Nonnull DefaultSyncConfig.Authorizable authorizableConfig) {\n+        assertEquals(\"\", authorizableConfig.getPathPrefix());\n+        assertSame(authorizableConfig, authorizableConfig.setPathPrefix(null));\n+        assertEquals(\"\", authorizableConfig.getPathPrefix());\n+        assertEquals(\"hu/hu\", authorizableConfig.setPathPrefix(\"hu/hu\").getPathPrefix());\n+\n+        Set<String> autoMembership = authorizableConfig.getAutoMembership();\n+        assertNotNull(autoMembership);\n+        assertTrue(autoMembership.isEmpty());\n+\n+        assertSame(authorizableConfig, authorizableConfig.setAutoMembership());\n+        assertTrue(authorizableConfig.getAutoMembership().isEmpty());\n+\n+        assertEquals(ImmutableSet.of(\"gr1\", \"gr2\"), authorizableConfig.setAutoMembership(\"gr1\", \"gr2\").getAutoMembership());\n+        assertEquals(ImmutableSet.of(\"gr\"), authorizableConfig.setAutoMembership(\"\", \" gr \", null, \"\").getAutoMembership());\n+\n+        Map<String, String> mapping = authorizableConfig.getPropertyMapping();\n+        assertNotNull(mapping);\n+        assertTrue(mapping.isEmpty());\n+\n+        assertSame(authorizableConfig, authorizableConfig.setPropertyMapping(ImmutableMap.of(\"a\", \"b\")));\n+        assertEquals(ImmutableMap.of(\"a\", \"b\"), authorizableConfig.getPropertyMapping());\n+        assertEquals(ImmutableMap.of(), authorizableConfig.setPropertyMapping(null).getPropertyMapping());\n+\n+        assertEquals(0, authorizableConfig.getExpirationTime());\n+        assertSame(authorizableConfig, authorizableConfig.setExpirationTime(Long.MAX_VALUE));\n+        assertEquals(Long.MAX_VALUE, authorizableConfig.getExpirationTime());\n+    }\n+\n+\n+    @Test\n+    public void testName() {\n+        assertEquals(\"default\", config.getName());\n+\n+        assertSame(config, config.setName(\"name\"));\n+        assertEquals(\"name\", config.getName());\n+    }\n+\n+    @Test\n+    public void testUserConfig() {\n+        DefaultSyncConfig.User userConfig = config.user();\n+\n+        assertNotNull(userConfig);\n+        assertAuthorizableConfig(userConfig);\n+\n+        assertEquals(0, userConfig.getMembershipExpirationTime());\n+\n+        assertSame(userConfig, userConfig.setMembershipExpirationTime(1));\n+        assertEquals(1, userConfig.getMembershipExpirationTime());\n+        assertEquals(Long.MIN_VALUE, userConfig.setMembershipExpirationTime(Long.MIN_VALUE).getMembershipExpirationTime());\n+\n+        assertEquals(0, userConfig.getMembershipNestingDepth());\n+\n+        assertSame(userConfig, userConfig.setMembershipNestingDepth(5));\n+        assertEquals(5, userConfig.getMembershipNestingDepth());\n+        assertEquals(0, userConfig.setMembershipExpirationTime(0).getMembershipExpirationTime());\n+    }\n+\n+    @Test\n+    public void testGroupConfig() {\n+        DefaultSyncConfig.Group groupConfig = config.group();\n+\n+        assertNotNull(groupConfig);\n+        assertAuthorizableConfig(groupConfig);\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            },
            {
                "sha": "f71842378b05033497c9a74fea0d529ccfdf0116",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncContextTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncContextTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncContextTest.java",
                "status": "modified",
                "changes": 53,
                "additions": 24,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncContextTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -24,7 +24,6 @@\n import java.util.Collection;\n import java.util.Date;\n import java.util.HashMap;\n-import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n import java.util.UUID;\n@@ -40,13 +39,12 @@\n import com.google.common.collect.ImmutableMap;\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Iterables;\n-import com.google.common.collect.Iterators;\n import com.google.common.collect.Lists;\n import org.apache.jackrabbit.api.security.user.Authorizable;\n import org.apache.jackrabbit.api.security.user.Group;\n import org.apache.jackrabbit.api.security.user.User;\n import org.apache.jackrabbit.api.security.user.UserManager;\n-import org.apache.jackrabbit.oak.AbstractSecurityTest;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.AbstractExternalAuthTest;\n import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalGroup;\n import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalIdentity;\n import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalIdentityException;\n@@ -69,10 +67,9 @@\n import static org.junit.Assert.assertSame;\n import static org.junit.Assert.assertTrue;\n \n-public class DefaultSyncContextTest extends AbstractSecurityTest {\n+public class DefaultSyncContextTest extends AbstractExternalAuthTest {\n \n     private TestIdentityProvider idp = new TestIdentityProvider();\n-    private DefaultSyncConfig config = new DefaultSyncConfig();\n \n     private DefaultSyncContext syncCtx;\n \n@@ -81,7 +78,7 @@\n     @Before\n     public void before() throws Exception {\n         super.before();\n-        syncCtx = new DefaultSyncContext(config, idp, getUserManager(root), getValueFactory());\n+        syncCtx = new DefaultSyncContext(syncConfig, idp, getUserManager(root), getValueFactory());\n     }\n \n     @After\n@@ -90,13 +87,6 @@ public void after() throws Exception {\n             syncCtx.close();\n             root.refresh();\n             UserManager umgr = getUserManager(root);\n-            Iterator<ExternalIdentity> ids = Iterators.concat(idp.listGroups(), idp.listUsers());\n-            while (ids.hasNext()) {\n-                Authorizable a = umgr.getAuthorizable(ids.next().getId());\n-                if (a != null) {\n-                    a.remove();\n-                }\n-            }\n             for (String id : authorizableIds) {\n                 Authorizable a = umgr.getAuthorizable(id);\n                 if (a != null) {\n@@ -109,6 +99,11 @@ public void after() throws Exception {\n         }\n     }\n \n+    @Override\n+    protected DefaultSyncConfig createSyncConfig() {\n+        return new DefaultSyncConfig();\n+    }\n+\n     private Group createTestGroup() throws Exception {\n         Group gr = getUserManager(root).createGroup(\"group\" + UUID.randomUUID());\n         authorizableIds.add(gr.getID());\n@@ -459,7 +454,7 @@ public void testSyncByIdUsingExceptionId() throws Exception {\n     public void testSyncAutoMembership() throws Exception {\n         Group gr = createTestGroup();\n \n-        config.user().setAutoMembership(gr.getID());\n+        syncConfig.user().setAutoMembership(gr.getID());\n \n         SyncResult result = syncCtx.sync(idp.listUsers().next());\n         assertEquals(SyncResult.Status.ADD, result.getStatus());\n@@ -470,7 +465,7 @@ public void testSyncAutoMembership() throws Exception {\n \n     @Test\n     public void testSyncAutoMembershipListsNonExistingGroup() throws Exception {\n-        config.user().setAutoMembership(\"nonExistingGroup\");\n+        syncConfig.user().setAutoMembership(\"nonExistingGroup\");\n \n         SyncResult result = syncCtx.sync(idp.listUsers().next());\n         assertEquals(SyncResult.Status.ADD, result.getStatus());\n@@ -479,7 +474,7 @@ public void testSyncAutoMembershipListsNonExistingGroup() throws Exception {\n     @Test\n     public void testSyncAutoMembershipListsUser() throws Exception {\n         // set auto-membership config to point to a user instead a group\n-        config.user().setAutoMembership(getTestUser().getID());\n+        syncConfig.user().setAutoMembership(getTestUser().getID());\n         syncCtx.sync(idp.listUsers().next());\n     }\n \n@@ -500,15 +495,15 @@ public void testLostMembership() throws Exception {\n \n         // enforce synchronization of the user and it's group membership\n         syncCtx.setForceUserSync(true);\n-        config.user().setMembershipExpirationTime(-1);\n+        syncConfig.user().setMembershipExpirationTime(-1);\n \n         // 1. membership nesting is < 0 => membership not synchronized\n-        config.user().setMembershipNestingDepth(-1);\n+        syncConfig.user().setMembershipNestingDepth(-1);\n         syncCtx.sync(user.getID()).getStatus();\n         assertTrue(gr.isDeclaredMember(user));\n \n         // 2. membership nesting is > 0 => membership gets synchronized\n-        config.user().setMembershipNestingDepth(1);\n+        syncConfig.user().setMembershipNestingDepth(1);\n         assertEquals(SyncResult.Status.UPDATE, syncCtx.sync(user.getID()).getStatus());\n \n         assertFalse(gr.isDeclaredMember(user));\n@@ -530,8 +525,8 @@ public void testLostMembershipDifferentIDP() throws Exception {\n \n         // enforce synchronization of the user and it's group membership\n         syncCtx.setForceUserSync(true);\n-        config.user().setMembershipExpirationTime(-1);\n-        config.user().setMembershipNestingDepth(1);\n+        syncConfig.user().setMembershipExpirationTime(-1);\n+        syncConfig.user().setMembershipNestingDepth(1);\n \n         assertEquals(SyncResult.Status.UPDATE, syncCtx.sync(user.getID()).getStatus());\n \n@@ -891,15 +886,15 @@ public void testSyncPropertiesRemapped() throws Exception {\n     @Test\n     public void testIsExpiredLocalGroup() throws Exception {\n         Group gr = createTestGroup();\n-        assertTrue(syncCtx.isExpired(gr, config.group().getExpirationTime(), \"any\"));\n+        assertTrue(syncCtx.isExpired(gr, syncConfig.group().getExpirationTime(), \"any\"));\n     }\n \n     @Test\n     public void testIsExpiredEmptyLastSyncedProperty() throws Exception {\n         Group gr = createTestGroup();\n         gr.setProperty(DefaultSyncContext.REP_LAST_SYNCED, new Value[0]);\n \n-        assertTrue(syncCtx.isExpired(gr, config.group().getExpirationTime(), \"any\"));\n+        assertTrue(syncCtx.isExpired(gr, syncConfig.group().getExpirationTime(), \"any\"));\n     }\n \n     @Test\n@@ -908,16 +903,16 @@ public void testIsExpiredSyncedUser() throws Exception {\n         sync(externalUser);\n \n         Authorizable a = getUserManager(root).getAuthorizable(externalUser.getId());\n-        assertFalse(syncCtx.isExpired(a, config.user().getExpirationTime(), \"any\"));\n+        assertFalse(syncCtx.isExpired(a, syncConfig.user().getExpirationTime(), \"any\"));\n         assertTrue(syncCtx.isExpired(a, -1, \"any\"));\n \n         // create a ctx with a newer 'now'\n-        DefaultSyncContext ctx = new DefaultSyncContext(config, idp, getUserManager(root), getValueFactory());\n+        DefaultSyncContext ctx = new DefaultSyncContext(syncConfig, idp, getUserManager(root), getValueFactory());\n         assertTrue(ctx.isExpired(a, 1, \"any\"));\n \n         // remove last-sync property\n         a.removeProperty(DefaultSyncContext.REP_LAST_SYNCED);\n-        assertTrue(syncCtx.isExpired(a, config.user().getExpirationTime(), \"any\"));\n+        assertTrue(syncCtx.isExpired(a, syncConfig.user().getExpirationTime(), \"any\"));\n     }\n \n     @Test\n@@ -926,16 +921,16 @@ public void testIsExpiredSyncedGroup() throws Exception {\n         sync(externalGroup);\n \n         Authorizable a = getUserManager(root).getAuthorizable(externalGroup.getId());\n-        assertFalse(syncCtx.isExpired(a, config.group().getExpirationTime(), \"any\"));\n+        assertFalse(syncCtx.isExpired(a, syncConfig.group().getExpirationTime(), \"any\"));\n         assertTrue(syncCtx.isExpired(a, -1, \"any\"));\n \n         // create a ctx with a newer 'now'\n-        DefaultSyncContext ctx = new DefaultSyncContext(config, idp, getUserManager(root), getValueFactory());\n+        DefaultSyncContext ctx = new DefaultSyncContext(syncConfig, idp, getUserManager(root), getValueFactory());\n         assertTrue(ctx.isExpired(a, 1, \"any\"));\n \n         // remove last-sync property\n         a.removeProperty(DefaultSyncContext.REP_LAST_SYNCED);\n-        assertTrue(syncCtx.isExpired(a, config.group().getExpirationTime(), \"any\"));\n+        assertTrue(syncCtx.isExpired(a, syncConfig.group().getExpirationTime(), \"any\"));\n     }\n \n     @Test",
                "deletions": 29
            },
            {
                "sha": "77d56bbdb04cfeee523478fbbe9e208aae4e3d78",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncResultImplTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncResultImplTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncResultImplTest.java",
                "status": "added",
                "changes": 64,
                "additions": 64,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncResultImplTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -0,0 +1,64 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.spi.security.authentication.external.basic;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalIdentityRef;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.SyncResult;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertSame;\n+\n+public class DefaultSyncResultImplTest {\n+\n+    @Test\n+    public void testGetIdentityFromNull() {\n+        SyncResult res = new DefaultSyncResultImpl(null, SyncResult.Status.NOP);\n+        assertNull(res.getIdentity());\n+    }\n+\n+    @Test\n+    public void testGetIdentity() {\n+        List<DefaultSyncedIdentity> l = new ArrayList();\n+        l.add(new DefaultSyncedIdentity(\"id\", null, true, -1));\n+        l.add(new DefaultSyncedIdentity(\"id\", new ExternalIdentityRef(\"id\", \"idp\"), false, 500));\n+\n+        for (DefaultSyncedIdentity si : l) {\n+            assertEquals(si, new DefaultSyncResultImpl(si, SyncResult.Status.NOP).getIdentity());\n+        }\n+    }\n+\n+    @Test\n+    public void testGetStatus() {\n+        for (SyncResult.Status s : SyncResult.Status.values()) {\n+            assertSame(s, new DefaultSyncResultImpl(null, s).getStatus());\n+        }\n+    }\n+\n+    @Test\n+    public void testSetStatus() {\n+        DefaultSyncResultImpl res = new DefaultSyncResultImpl(null, SyncResult.Status.NOP);\n+        for (SyncResult.Status s : SyncResult.Status.values()) {\n+            res.setStatus(s);\n+            assertSame(s, res.getStatus());\n+        }\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            },
            {
                "sha": "1c9ef1a7e23cda2a9e13867037017da517fb7882",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncedIdentityTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncedIdentityTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncedIdentityTest.java",
                "status": "added",
                "changes": 85,
                "additions": 85,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/DefaultSyncedIdentityTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.spi.security.authentication.external.basic;\n+\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalGroup;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalIdentityProvider;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalUser;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.SyncedIdentity;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.TestIdentityProvider;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class DefaultSyncedIdentityTest {\n+\n+    private final ExternalIdentityProvider idp = new TestIdentityProvider();\n+\n+    private ExternalUser externalUser;\n+    private ExternalGroup externalGroup;\n+\n+    private SyncedIdentity si;\n+    private SyncedIdentity siGroup;\n+\n+    @Before\n+    public void before() throws Exception {\n+        externalUser = idp.getUser(TestIdentityProvider.ID_TEST_USER);\n+        assertNotNull(externalUser);\n+        si = new DefaultSyncedIdentity(externalUser.getId(), externalUser.getExternalId(), false, 234);\n+\n+        externalGroup = idp.listGroups().next();\n+        siGroup = new DefaultSyncedIdentity(externalGroup.getId(), externalGroup.getExternalId(), true, 234);\n+    }\n+\n+    @Test\n+    public void testGetId() {\n+        assertEquals(externalUser.getId(), si.getId());\n+        assertEquals(externalGroup.getId(), siGroup.getId());\n+\n+        SyncedIdentity siOtherId = new DefaultSyncedIdentity(\"otherId\", externalUser.getExternalId(), false, -1);\n+        assertEquals(\"otherId\", siOtherId.getId());\n+    }\n+\n+    @Test\n+    public void testGetExternalIdRef() {\n+        assertEquals(externalUser.getExternalId(), si.getExternalIdRef());\n+        assertEquals(externalGroup.getExternalId(), siGroup.getExternalIdRef());\n+\n+        SyncedIdentity siNullExtRef = new DefaultSyncedIdentity(TestIdentityProvider.ID_TEST_USER, null, false, 234);\n+        assertNull(siNullExtRef.getExternalIdRef());\n+    }\n+\n+    @Test\n+    public void testIsGroup() {\n+        assertFalse(si.isGroup());\n+        assertTrue(siGroup.isGroup());\n+    }\n+\n+    @Test\n+    public void testLastSynced() {\n+        assertEquals(234, si.lastSynced());\n+        assertEquals(234, siGroup.lastSynced());\n+\n+        SyncedIdentity siNeverSynced = new DefaultSyncedIdentity(TestIdentityProvider.ID_TEST_USER, externalUser.getExternalId(), false, -1);\n+        assertEquals(-1, siNeverSynced.lastSynced());\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            },
            {
                "sha": "85c9dbac898206f9fad4af6868bde0ccd57c845b",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/RepExternalIdTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/RepExternalIdTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/RepExternalIdTest.java",
                "status": "added",
                "changes": 90,
                "additions": 90,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/basic/RepExternalIdTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.spi.security.authentication.external.basic;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.apache.jackrabbit.api.security.user.Authorizable;\n+import org.apache.jackrabbit.oak.api.PropertyState;\n+import org.apache.jackrabbit.oak.api.Tree;\n+import org.apache.jackrabbit.oak.api.Type;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.AbstractExternalAuthTest;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.ExternalIdentityRef;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.SyncResult;\n+import org.apache.jackrabbit.oak.spi.security.authentication.external.SyncedIdentity;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertSame;\n+import static org.junit.Assert.assertTrue;\n+\n+public class RepExternalIdTest extends AbstractExternalAuthTest {\n+\n+    private DefaultSyncContext syncCtx;\n+\n+    @Before\n+    public void before() throws Exception {\n+        super.before();\n+\n+        syncCtx = new DefaultSyncContext(syncConfig, idp, getUserManager(root), getValueFactory());\n+    }\n+\n+    @Override\n+    public void after() throws Exception {\n+        try {\n+            syncCtx.close();\n+        } finally {\n+            super.after();\n+        }\n+    }\n+\n+    private void assertRepExternalId(@Nonnull SyncResult result) throws Exception {\n+        assertSame(SyncResult.Status.ADD, result.getStatus());\n+        SyncedIdentity si = result.getIdentity();\n+        assertNotNull(si);\n+\n+\n+        Authorizable authorizable = getUserManager(root).getAuthorizable(si.getId());\n+        assertNotNull(authorizable);\n+\n+        Tree userTree = root.getTree(authorizable.getPath());\n+        assertTrue(userTree.hasProperty(DefaultSyncContext.REP_EXTERNAL_ID));\n+\n+        PropertyState ps = userTree.getProperty(DefaultSyncContext.REP_EXTERNAL_ID);\n+        assertNotNull(ps);\n+        assertFalse(ps.isArray());\n+        assertSame(Type.STRING, ps.getType());\n+        assertEquals(si.getExternalIdRef(), ExternalIdentityRef.fromString(ps.getValue(Type.STRING)));\n+    }\n+\n+    @Test\n+    public void syncExternalUser() throws Exception {\n+        SyncResult res = syncCtx.sync(idp.getUser(USER_ID));\n+\n+        assertRepExternalId(res);\n+    }\n+\n+    @Test\n+    public void syncExternalGroup() throws Exception {\n+        SyncResult res = syncCtx.sync(idp.listGroups().next());\n+\n+        assertRepExternalId(res);\n+    }\n+}\n\\ No newline at end of file",
                "deletions": 0
            },
            {
                "sha": "6565da710405520c09f44a4261aa623ce326c1a1",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/CustomCredentialsSupportTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/CustomCredentialsSupportTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/CustomCredentialsSupportTest.java",
                "status": "modified",
                "changes": 11,
                "additions": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/CustomCredentialsSupportTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -52,8 +52,6 @@\n  */\n public class CustomCredentialsSupportTest extends ExternalLoginModuleTestBase {\n \n-    private final IDP idp = new IDP();\n-\n     private static void assertAttributes(@Nonnull Map<String, ?> expected, @Nonnull AuthInfo info) {\n         assertEquals(expected.size(), info.getAttributeNames().length);\n         for (String aName : info.getAttributeNames()) {\n@@ -69,7 +67,7 @@ public void testLogin() throws Exception {\n         try {\n             AuthInfo info = cs.getAuthInfo();\n             assertEquals(\"testUser\", info.getUserID());\n-            assertAttributes(idp.getAttributes(creds), info);\n+            assertAttributes(((IDP) idp).getAttributes(creds), info);\n         } finally {\n             cs.close();\n         }\n@@ -93,12 +91,7 @@ public void testLoginWithUnsupportedCredentials() throws Exception {\n \n     @Override\n     protected ExternalIdentityProvider createIDP() {\n-        return idp;\n-    }\n-\n-    @Override\n-    protected void destroyIDP(ExternalIdentityProvider idp) {\n-        // ignore\n+        return new IDP();\n     }\n \n     private static final class TestCredentials implements Credentials {",
                "deletions": 9
            },
            {
                "sha": "d73be2fa5ff6d548766da3913b7557dc3929d5cc",
                "filename": "oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/DefaultSyncHandlerTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/DefaultSyncHandlerTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/aadf67ebdcd35dbe55d20af84d6050c18ad391b7/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/DefaultSyncHandlerTest.java",
                "status": "modified",
                "changes": 9,
                "additions": 0,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-auth-external/src/test/java/org/apache/jackrabbit/oak/spi/security/authentication/external/impl/DefaultSyncHandlerTest.java?ref=aadf67ebdcd35dbe55d20af84d6050c18ad391b7",
                "patch": "@@ -75,15 +75,6 @@ public void after() throws Exception {\n         super.after();\n     }\n \n-    protected ExternalIdentityProvider createIDP() {\n-        return new TestIdentityProvider();\n-    }\n-\n-    @Override\n-    protected void destroyIDP(ExternalIdentityProvider idp) {\n-    // ignore\n-    }\n-\n     @Override\n     protected void setSyncConfig(DefaultSyncConfig cfg) {\n         if (cfg != null) {",
                "deletions": 9
            }
        ],
        "patched_files": [
            "ExternalLoginModuleTestBase.java",
            "DefaultSyncResultImpl.java",
            "ExternalLoginModule.java",
            "DefaultSyncedIdentity.java",
            "DefaultSyncHandler.java",
            "DefaultSyncContext.java",
            "DefaultSyncConfig.java"
        ],
        "unit_tests": [
            "RepExternalIdTest.java",
            "AbstractExternalAuthTest.java",
            "CustomCredentialsSupportTest.java",
            "ExternalLoginModuleTest.java",
            "DefaultSyncResultImplTest.java",
            "DefaultSyncHandlerTest.java",
            "DefaultSyncConfigTest.java",
            "DefaultSyncedIdentityTest.java",
            "DefaultSyncContextTest.java"
        ]
    },
    "jackrabbit-oak_5e6906a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-1719: Missing commit hooks in upgrade\n\nAdd an editor for upgrading rep:glob entries in existing Jackrabbit Classic ACEs to the rep:restrictions structure used in Oak\nMake the RepositoryUpgrade class easier to extend and customize.\nUse the after instead of the before state to get privilege bits in PermissionHook, as otherwise newly added privileges won't be reflected in the permission store.\nAlso: Avoid NPE in SegmentNodeState.getStringValue(\"jcr:primaryType\") in the unexpected case when a primary type is not set.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1587399 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/5e6906ad61e8c2b1486712588563a596180ca215",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/4af5ecb70ea65998974635de8749873794947e9b",
        "bug_id": "jackrabbit-oak_5e6906a",
        "file": [
            {
                "sha": "eefc447458bab744712c4d48d7530428402fca3a",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeState.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5e6906ad61e8c2b1486712588563a596180ca215/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeState.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5e6906ad61e8c2b1486712588563a596180ca215/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeState.java",
                "status": "modified",
                "changes": 10,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/plugins/segment/SegmentNodeState.java?ref=5e6906ad61e8c2b1486712588563a596180ca215",
                "patch": "@@ -219,10 +219,12 @@ private String getValueAsString(String name, Type<?> type) {\n         Template template = getTemplate();\n         if (JCR_PRIMARYTYPE.equals(name)) {\n             PropertyState primary = template.getPrimaryType();\n-            if (type == NAME) {\n-                return primary.getValue(NAME);\n-            } else if (primary != null) {\n-                return null;\n+            if (primary != null) {\n+                if (type == NAME) {\n+                    return primary.getValue(NAME);\n+                } else {\n+                    return null;\n+                }\n             }\n         } else if (JCR_MIXINTYPES.equals(name)\n                 && template.getMixinTypes() != null) {",
                "deletions": 4
            },
            {
                "sha": "57618dc17d3ecd7c244e5bed7329223febfe512b",
                "filename": "oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/PermissionHook.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5e6906ad61e8c2b1486712588563a596180ca215/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/PermissionHook.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5e6906ad61e8c2b1486712588563a596180ca215/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/PermissionHook.java",
                "status": "modified",
                "changes": 2,
                "additions": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-core/src/main/java/org/apache/jackrabbit/oak/security/authorization/permission/PermissionHook.java?ref=5e6906ad61e8c2b1486712588563a596180ca215",
                "patch": "@@ -92,7 +92,7 @@ public NodeState processCommit(\n         NodeBuilder rootAfter = after.builder();\n \n         permissionRoot = getPermissionRoot(rootAfter);\n-        bitsProvider = new PrivilegeBitsProvider(new ImmutableRoot(before));\n+        bitsProvider = new PrivilegeBitsProvider(new ImmutableRoot(after));\n \n         isACL = new TypePredicate(after, NT_REP_ACL);\n         isACE = new TypePredicate(after, NT_REP_ACE);",
                "deletions": 1
            },
            {
                "sha": "72899ea61e82385ff4546a11a8a998a17bff5820",
                "filename": "oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5e6906ad61e8c2b1486712588563a596180ca215/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5e6906ad61e8c2b1486712588563a596180ca215/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java",
                "status": "modified",
                "changes": 34,
                "additions": 22,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/RepositoryUpgrade.java?ref=5e6906ad61e8c2b1486712588563a596180ca215",
                "patch": "@@ -55,6 +55,7 @@\n import org.apache.jackrabbit.oak.spi.commit.CompositeEditorProvider;\n import org.apache.jackrabbit.oak.spi.commit.CompositeHook;\n import org.apache.jackrabbit.oak.spi.commit.EditorHook;\n+import org.apache.jackrabbit.oak.spi.lifecycle.RepositoryInitializer;\n import org.apache.jackrabbit.oak.spi.security.ConfigurationParameters;\n import org.apache.jackrabbit.oak.spi.security.SecurityConfiguration;\n import org.apache.jackrabbit.oak.spi.security.privilege.PrivilegeBits;\n@@ -65,6 +66,7 @@\n import org.apache.jackrabbit.oak.spi.state.NodeState;\n import org.apache.jackrabbit.oak.spi.state.NodeStore;\n import org.apache.jackrabbit.oak.upgrade.security.GroupEditorProvider;\n+import org.apache.jackrabbit.oak.upgrade.security.RestrictionEditorProvider;\n import org.apache.jackrabbit.spi.Name;\n import org.apache.jackrabbit.spi.QItemDefinition;\n import org.apache.jackrabbit.spi.QNodeDefinition;\n@@ -173,7 +175,7 @@ public static void copy(RepositoryConfig source, NodeStore target)\n             throws RepositoryException {\n         RepositoryContext context = RepositoryContext.create(source);\n         try {\n-            new RepositoryUpgrade(context, target).copy();\n+            new RepositoryUpgrade(context, target).copy(null);\n         } finally {\n             context.getRepository().shutdown();\n         }\n@@ -206,15 +208,14 @@ public void setCopyBinariesByReference(boolean copyBinariesByReference) {\n      * The source repository <strong>must not be modified</strong> while\n      * the copy operation is running to avoid an inconsistent copy.\n      * <p>\n-     * This method leaves the search indexes of the target repository in\n-     * an \n      * Note that both the source and the target repository must be closed\n      * during the copy operation as this method requires exclusive access\n      * to the repositories.\n      *\n+     * @param initializer optional extra repository initializer to use\n      * @throws RepositoryException if the copy operation fails\n      */\n-    public void copy() throws RepositoryException {\n+    public void copy(RepositoryInitializer initializer) throws RepositoryException {\n         RepositoryConfig config = source.getRepositoryConfig();\n         logger.info(\n                 \"Copying repository content from {} to Oak\", config.getHomeDir());\n@@ -228,6 +229,9 @@ public void copy() throws RepositoryException {\n \n             // init target repository first\n             new InitialContent().initialize(builder);\n+            if (initializer != null) {\n+                initializer.initialize(builder);\n+            }\n             for (SecurityConfiguration sc : security.getConfigurations()) {\n                 sc.getWorkspaceInitializer().initialize(builder, workspace);\n             }\n@@ -251,25 +255,31 @@ public void copy() throws RepositoryException {\n             String groupsPath = userConf.getParameters().getConfigValue(\n                     UserConstants.PARAM_GROUP_PATH,\n                     UserConstants.DEFAULT_GROUP_PATH);\n-            hooks.add(new EditorHook(new GroupEditorProvider(groupsPath)));\n+\n+            // hooks specific to the upgrade, need to run first\n             hooks.add(new EditorHook(new CompositeEditorProvider(\n-                            new GroupEditorProvider(groupsPath),\n-                            new TypeEditorProvider(false),\n-                            new IndexUpdateProvider(new CompositeIndexEditorProvider(\n-                                    new ReferenceEditorProvider(),\n-                                    new PropertyIndexEditorProvider())))));\n+                    new RestrictionEditorProvider(),\n+                    new GroupEditorProvider(groupsPath))));\n \n+            // security-related hooks\n             for (SecurityConfiguration sc : security.getConfigurations()) {\n                 hooks.addAll(sc.getCommitHooks(workspace));\n             }\n \n+            // type validation, reference and indexing hooks\n+            hooks.add(new EditorHook(new CompositeEditorProvider(\n+                            new TypeEditorProvider(false),\n+                            new IndexUpdateProvider(new CompositeIndexEditorProvider(\n+                                    new ReferenceEditorProvider(),\n+                                    new PropertyIndexEditorProvider())))));\n+\n             target.merge(builder, CompositeHook.compose(hooks), CommitInfo.EMPTY);\n         } catch (Exception e) {\n             throw new RepositoryException(\"Failed to copy content\", e);\n         }\n     }\n \n-    private ConfigurationParameters mapSecurityConfig(SecurityConfig config) {\n+    protected ConfigurationParameters mapSecurityConfig(SecurityConfig config) {\n         ConfigurationParameters loginConfig = mapConfigurationParameters(\n                 config.getLoginModuleConfig(),\n                 LoginModuleConfig.PARAM_ADMIN_ID, UserConstants.PARAM_ADMIN_ID,\n@@ -286,7 +296,7 @@ private ConfigurationParameters mapSecurityConfig(SecurityConfig config) {\n                 ConfigurationParameters.of(loginConfig, userConfig)));\n     }\n \n-    private ConfigurationParameters mapConfigurationParameters(\n+    protected ConfigurationParameters mapConfigurationParameters(\n             BeanConfig config, String... mapping) {\n         Map<String, String> map = newHashMap();\n         if (config != null) {",
                "deletions": 12
            },
            {
                "sha": "a81dfe60d56bfa508d871873c05c9be8de8acec1",
                "filename": "oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditor.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5e6906ad61e8c2b1486712588563a596180ca215/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditor.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5e6906ad61e8c2b1486712588563a596180ca215/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditor.java",
                "status": "added",
                "changes": 87,
                "additions": 87,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditor.java?ref=5e6906ad61e8c2b1486712588563a596180ca215",
                "patch": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.upgrade.security;\n+\n+import static org.apache.jackrabbit.JcrConstants.JCR_PRIMARYTYPE;\n+import static org.apache.jackrabbit.oak.api.Type.NAME;\n+import static org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AccessControlConstants.NT_REP_RESTRICTIONS;\n+import static org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AccessControlConstants.REP_GLOB;\n+import static org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AccessControlConstants.REP_RESTRICTIONS;\n+\n+import org.apache.jackrabbit.oak.api.PropertyState;\n+import org.apache.jackrabbit.oak.plugins.nodetype.TypePredicate;\n+import org.apache.jackrabbit.oak.spi.commit.DefaultEditor;\n+import org.apache.jackrabbit.oak.spi.commit.Editor;\n+import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n+\n+public class RestrictionEditor extends DefaultEditor {\n+\n+    private final NodeBuilder builder;\n+\n+    private final TypePredicate isACE;\n+\n+    private PropertyState glob = null;\n+\n+    public RestrictionEditor(NodeBuilder builder, TypePredicate isACE) {\n+        this.builder = builder;\n+        this.isACE = isACE;\n+    }\n+\n+    private RestrictionEditor(RestrictionEditor parent, String name) {\n+        this.builder = parent.builder.getChildNode(name);\n+        this.isACE = parent.isACE;\n+    }\n+\n+    @Override\n+    public void leave(NodeState before, NodeState after) {\n+        if (glob != null\n+                && isACE.apply(after)\n+                && !builder.hasChildNode(REP_RESTRICTIONS)) {\n+            NodeBuilder restrictions = builder.setChildNode(REP_RESTRICTIONS);\n+            restrictions.setProperty(JCR_PRIMARYTYPE, NT_REP_RESTRICTIONS, NAME);\n+            restrictions.setProperty(glob);\n+            builder.removeProperty(REP_GLOB);\n+        }\n+    }\n+\n+    @Override\n+    public void propertyAdded(PropertyState after) {\n+        if (REP_GLOB.equals(after.getName())) {\n+            glob = after;\n+        }\n+    }\n+\n+    @Override\n+    public void propertyChanged(PropertyState before, PropertyState after) {\n+        if (REP_GLOB.equals(after.getName())) {\n+            glob = after;\n+        }\n+    }\n+\n+    @Override\n+    public Editor childNodeAdded(String name, NodeState after) {\n+        return new RestrictionEditor(this, name);\n+    }\n+\n+    @Override\n+    public Editor childNodeChanged(\n+            String name, NodeState before, NodeState after) {\n+        return new RestrictionEditor(this, name);\n+    }\n+\n+}",
                "deletions": 0
            },
            {
                "sha": "13c4989fde60dad3157b0d0e3ea4ea6c94b37697",
                "filename": "oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditorProvider.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/5e6906ad61e8c2b1486712588563a596180ca215/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditorProvider.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/5e6906ad61e8c2b1486712588563a596180ca215/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditorProvider.java",
                "status": "added",
                "changes": 42,
                "additions": 42,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-upgrade/src/main/java/org/apache/jackrabbit/oak/upgrade/security/RestrictionEditorProvider.java?ref=5e6906ad61e8c2b1486712588563a596180ca215",
                "patch": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.oak.upgrade.security;\n+\n+import static org.apache.jackrabbit.oak.spi.security.authorization.accesscontrol.AccessControlConstants.NT_REP_ACE;\n+\n+import org.apache.jackrabbit.oak.plugins.nodetype.TypePredicate;\n+import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n+import org.apache.jackrabbit.oak.spi.commit.Editor;\n+import org.apache.jackrabbit.oak.spi.commit.EditorProvider;\n+import org.apache.jackrabbit.oak.spi.state.NodeBuilder;\n+import org.apache.jackrabbit.oak.spi.state.NodeState;\n+\n+/**\n+ * Editor provider for upgrading ACL restrictions (rep:glob) from\n+ * Jackrabbit Classic to Oak.\n+ */\n+public class RestrictionEditorProvider implements EditorProvider {\n+\n+    @Override\n+    public Editor getRootEditor(\n+            NodeState before, NodeState after,\n+            NodeBuilder builder, CommitInfo info) {\n+        TypePredicate isACE = new TypePredicate(after, NT_REP_ACE);\n+        return new RestrictionEditor(builder, isACE);\n+    }\n+\n+}",
                "deletions": 0
            }
        ],
        "patched_files": [
            "PermissionHook.java",
            "RepositoryUpgrade.java"
        ],
        "unit_tests": [
            "PermissionHookTest.java",
            "RepositoryUpgradeTest.java"
        ]
    },
    "jackrabbit-oak_6f3c58a": {
        "repo": "jackrabbit-oak",
        "message": "OAK-2732 - NPE in lucene search\n\nHandle the case where a field with given name is not indexed and hence term would be null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/oak/trunk@1673695 13f79535-47bb-0310-9956-ffa450edef68",
        "commit": "https://github.com/apache/jackrabbit-oak/commit/6f3c58af575d0bf1c3e9e30da27b40830dbf3d30",
        "parent": "https://github.com/apache/jackrabbit-oak/commit/ecf654528f15017fd3268433e22d4507d2ebbdbb",
        "bug_id": "jackrabbit-oak_6f3c58a",
        "file": [
            {
                "sha": "c8bdb76471b8d57ac9b33a42cc60b8938b43e18a",
                "filename": "oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndex.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/6f3c58af575d0bf1c3e9e30da27b40830dbf3d30/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndex.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/6f3c58af575d0bf1c3e9e30da27b40830dbf3d30/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndex.java",
                "status": "modified",
                "changes": 6,
                "additions": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/main/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndex.java?ref=6f3c58af575d0bf1c3e9e30da27b40830dbf3d30",
                "patch": "@@ -896,6 +896,12 @@ static Query tokenToQuery(String text, String fieldName, Analyzer analyzer, Inde\n             List<Term> terms = new ArrayList<Term>();\n             Term onTerm = newFulltextTerm(token, fieldName);\n             Terms t = MultiFields.getTerms(reader, onTerm.field());\n+\n+            //No existing field with given name indexed so no possible term values\n+            if (t == null){\n+                return new Term[0];\n+            }\n+\n             Automaton a = WildcardQuery.toAutomaton(onTerm);\n             CompiledAutomaton ca = new CompiledAutomaton(a);\n             TermsEnum te = ca.getTermsEnum(t);",
                "deletions": 0
            },
            {
                "sha": "c0a46177e6573a9511cfcc195cbe2df2040e5a8b",
                "filename": "oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexTest.java",
                "blob_url": "https://github.com/apache/jackrabbit-oak/blob/6f3c58af575d0bf1c3e9e30da27b40830dbf3d30/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexTest.java",
                "raw_url": "https://github.com/apache/jackrabbit-oak/raw/6f3c58af575d0bf1c3e9e30da27b40830dbf3d30/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexTest.java",
                "status": "modified",
                "changes": 35,
                "additions": 35,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit-oak/contents/oak-lucene/src/test/java/org/apache/jackrabbit/oak/plugins/index/lucene/LuceneIndexTest.java?ref=6f3c58af575d0bf1c3e9e30da27b40830dbf3d30",
                "patch": "@@ -73,6 +73,7 @@\n import org.apache.jackrabbit.oak.query.QueryEngineSettings;\n import org.apache.jackrabbit.oak.query.ast.Operator;\n import org.apache.jackrabbit.oak.query.ast.SelectorImpl;\n+import org.apache.jackrabbit.oak.query.fulltext.FullTextParser;\n import org.apache.jackrabbit.oak.query.fulltext.FullTextTerm;\n import org.apache.jackrabbit.oak.query.index.FilterImpl;\n import org.apache.jackrabbit.oak.spi.commit.CommitInfo;\n@@ -112,6 +113,40 @@\n \n     private Set<File> dirs = newHashSet();\n \n+    @Test\n+    public void testLuceneV1NonExistentProperty() throws Exception {\n+        NodeBuilder index = builder.child(INDEX_DEFINITIONS_NAME);\n+        newLuceneIndexDefinition(index, \"lucene\", ImmutableSet.of(\"String\"));\n+\n+        NodeState before = builder.getNodeState();\n+        builder.setProperty(\"foo\", \"value-with-dash\");\n+        NodeState after = builder.getNodeState();\n+\n+        NodeState indexed = HOOK.processCommit(before, after, CommitInfo.EMPTY);\n+\n+        IndexTracker tracker = new IndexTracker();\n+        tracker.update(indexed);\n+        AdvancedQueryIndex queryIndex = new LuceneIndex(tracker, null);\n+\n+        FilterImpl filter = createFilter(NT_BASE);\n+        filter.restrictPath(\"/\", Filter.PathRestriction.EXACT);\n+        filter.setFullTextConstraint(FullTextParser.parse(\"foo\", \"value-with*\"));\n+        List<IndexPlan> plans = queryIndex.getPlans(filter, null, builder.getNodeState());\n+        Cursor cursor = queryIndex.query(plans.get(0), indexed);\n+        assertTrue(cursor.hasNext());\n+        assertEquals(\"/\", cursor.next().getPath());\n+        assertFalse(cursor.hasNext());\n+\n+        //Now perform a query against a field which does not exist\n+        FilterImpl filter2 = createFilter(NT_BASE);\n+        filter2.restrictPath(\"/\", Filter.PathRestriction.EXACT);\n+        filter2.setFullTextConstraint(FullTextParser.parse(\"baz\", \"value-with*\"));\n+        List<IndexPlan> plans2 = queryIndex.getPlans(filter2, null, builder.getNodeState());\n+        Cursor cursor2 = queryIndex.query(plans2.get(0), indexed);\n+        assertFalse(cursor2.hasNext());\n+    }\n+\n+\n     @Test\n     public void testLucene() throws Exception {\n         NodeBuilder index = builder.child(INDEX_DEFINITIONS_NAME);",
                "deletions": 0
            }
        ],
        "patched_files": [
            "LuceneIndex.java"
        ],
        "unit_tests": [
            "LuceneIndexTest.java"
        ]
    }
}