[
    {
        "repo": "hive",
        "commit": "https://github.com/apache/hive/commit/80aaa1e65894400d16df608e48bf838238152ec8",
        "bug_id": "hive_80aaa1e",
        "message": "HIVE-18898: Fix NPEs in HiveMetastore.dropPartition method (Marta Kuczora, reviewed by Sahil Takiar, Alexander Kolbasov and Peter Vary)",
        "parent": "https://github.com/apache/hive/commit/901a3b3fb04a9d78c64e661ca47e7ebe184abfb8",
        "patched_files": [
            "HiveMetaStoreClient.java",
            "HiveMetaStore.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 10,
                "raw_url": "https://github.com/apache/hive/raw/80aaa1e65894400d16df608e48bf838238152ec8/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java?ref=80aaa1e65894400d16df608e48bf838238152ec8",
                "filename": "standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java",
                "deletions": 0,
                "sha": "84fac2dfa4f29c1cd67d6a06e1f31e6aad016c75",
                "blob_url": "https://github.com/apache/hive/blob/80aaa1e65894400d16df608e48bf838238152ec8/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java",
                "patch": "@@ -3555,6 +3555,16 @@ private boolean drop_partition_common(RawStore ms, String db_name, String tbl_na\n       boolean isExternalTbl = false;\n       Map<String, String> transactionalListenerResponses = Collections.emptyMap();\n \n+      if (db_name == null) {\n+        throw new MetaException(\"The DB name cannot be null.\");\n+      }\n+      if (tbl_name == null) {\n+        throw new MetaException(\"The table name cannot be null.\");\n+      }\n+      if (part_vals == null) {\n+        throw new MetaException(\"The partition values cannot be null.\");\n+      }\n+\n       try {\n         ms.openTransaction();\n         part = ms.getPartition(db_name, tbl_name, part_vals);",
                "changes": 10
            },
            {
                "status": "modified",
                "additions": 10,
                "raw_url": "https://github.com/apache/hive/raw/80aaa1e65894400d16df608e48bf838238152ec8/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java?ref=80aaa1e65894400d16df608e48bf838238152ec8",
                "filename": "standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java",
                "deletions": 0,
                "sha": "0e561f82ff28242f1ec62dd0b141b6707506d461",
                "blob_url": "https://github.com/apache/hive/blob/80aaa1e65894400d16df608e48bf838238152ec8/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java",
                "patch": "@@ -993,13 +993,23 @@ public boolean dropPartition(String db_name, String tbl_name,\n   @Override\n   public boolean dropPartition(String db_name, String tbl_name,\n       List<String> part_vals, PartitionDropOptions options) throws TException {\n+    if (options == null) {\n+      options = PartitionDropOptions.instance();\n+    }\n     return dropPartition(db_name, tbl_name, part_vals, options.deleteData,\n                          options.purgeData? getEnvironmentContextWithIfPurgeSet() : null);\n   }\n \n   public boolean dropPartition(String db_name, String tbl_name, List<String> part_vals,\n       boolean deleteData, EnvironmentContext envContext) throws NoSuchObjectException,\n       MetaException, TException {\n+    if (part_vals != null) {\n+      for (String partVal : part_vals) {\n+        if (partVal == null) {\n+          throw new MetaException(\"The partition value must not be null.\");\n+        }\n+      }\n+    }\n     return client.drop_partition_with_environment_context(db_name, tbl_name, part_vals, deleteData,\n         envContext);\n   }",
                "changes": 10
            },
            {
                "status": "modified",
                "additions": 7,
                "raw_url": "https://github.com/apache/hive/raw/80aaa1e65894400d16df608e48bf838238152ec8/standalone-metastore/src/test/java/org/apache/hadoop/hive/metastore/client/TestDropPartitions.java",
                "contents_url": "https://api.github.com/repos/apache/hive/contents/standalone-metastore/src/test/java/org/apache/hadoop/hive/metastore/client/TestDropPartitions.java?ref=80aaa1e65894400d16df608e48bf838238152ec8",
                "filename": "standalone-metastore/src/test/java/org/apache/hadoop/hive/metastore/client/TestDropPartitions.java",
                "deletions": 9,
                "sha": "d2ba4be7c055ef3ab3ee76ec771066bb41003854",
                "blob_url": "https://github.com/apache/hive/blob/80aaa1e65894400d16df608e48bf838238152ec8/standalone-metastore/src/test/java/org/apache/hadoop/hive/metastore/client/TestDropPartitions.java",
                "patch": "@@ -264,18 +264,13 @@ public void testDropPartitionNonExistingPartVals() throws Exception {\n     client.dropPartition(DB_NAME, TABLE_NAME, Lists.newArrayList(\"2017\", \"may\"), false);\n   }\n \n-  @Test\n+  @Test(expected = MetaException.class)\n   public void testDropPartitionNullVal() throws Exception {\n \n     List<String> partVals = new ArrayList<>();\n     partVals.add(null);\n     partVals.add(null);\n-    try {\n-      client.dropPartition(DB_NAME, TABLE_NAME, partVals, false);\n-      Assert.fail(\"NullPointerException or NoSuchObjectException is expected to be thrown\");\n-    } catch (NullPointerException | NoSuchObjectException e) {\n-      // TODO: Should not throw NPE.\n-    }\n+    client.dropPartition(DB_NAME, TABLE_NAME, partVals, false);\n   }\n \n   @Test(expected = NoSuchObjectException.class)\n@@ -400,10 +395,13 @@ public void testDropPartitionPurgeSetInTable() throws Exception {\n     checkPartitionsAfterDelete(tableName, droppedPartitions, remainingPartitions, true, true);\n   }\n \n-  @Test(expected = NullPointerException.class)\n+  @Test\n   public void testDropPartitionNullPartDropOptions() throws Exception {\n-    // TODO: This should not throw NPE\n+\n     client.dropPartition(DB_NAME, TABLE_NAME, PARTITIONS[0].getValues(), null);\n+    List<Partition> droppedPartitions = Lists.newArrayList(PARTITIONS[0]);\n+    List<Partition> remainingPartitions = Lists.newArrayList(PARTITIONS[1], PARTITIONS[2]);\n+    checkPartitionsAfterDelete(TABLE_NAME, droppedPartitions, remainingPartitions, true, false);\n   }\n \n   // Tests for dropPartition(String db_name, String tbl_name, String name,",
                "changes": 16
            }
        ],
        "unit_tests": [
            "TestHiveMetaStore.java",
            "TestDropPartitions.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "standalone-metastore/src/test/java/org/apache/hadoop/hive/metastore/client/TestDropPartitions.java",
        "buggy_files": [
            "standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java",
            "standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java"
        ],
        "fixed": true
    }
]