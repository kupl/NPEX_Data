[
    {
        "repo": "sling-org-apache-sling-distribution-core",
        "commit": "https://github.com/apache/sling-org-apache-sling-distribution-core/commit/57abab27db7adfc3bcd06083e090c83f8e82e10b",
        "bug_id": "sling-org-apache-sling-distribution-core_57abab2",
        "message": "SLING-7229 - DistributionAgentServlet throws NPE upon test action",
        "parent": "https://github.com/apache/sling-org-apache-sling-distribution-core/commit/b066d5452017bdb4ed26d3468e041a2b02e0ea09",
        "patched_files": [
            "ServletJsonUtils.java"
        ],
        "file": [
            {
                "status": "modified",
                "additions": 35,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-distribution-core/raw/57abab27db7adfc3bcd06083e090c83f8e82e10b/src/main/java/org/apache/sling/distribution/servlet/ServletJsonUtils.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-distribution-core/contents/src/main/java/org/apache/sling/distribution/servlet/ServletJsonUtils.java?ref=57abab27db7adfc3bcd06083e090c83f8e82e10b",
                "filename": "src/main/java/org/apache/sling/distribution/servlet/ServletJsonUtils.java",
                "deletions": 20,
                "sha": "4c4b9251ab7277fc3d14d702e130bc598daf0b10",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-distribution-core/blob/57abab27db7adfc3bcd06083e090c83f8e82e10b/src/main/java/org/apache/sling/distribution/servlet/ServletJsonUtils.java",
                "patch": "@@ -43,15 +43,6 @@\n     private final static Logger log = LoggerFactory.getLogger(ServletJsonUtils.class);\n \n     public static void writeJson(SlingHttpServletResponse response, DistributionResponse distributionResponse) throws IOException {\n-        JsonObjectBuilder json = Json.createObjectBuilder();\n-        try {\n-            json.add(\"success\", distributionResponse.isSuccessful());\n-            json.add(\"state\", distributionResponse.getState().name());\n-            json.add(\"message\", distributionResponse.getMessage());\n-\n-        } catch (JsonException e) {\n-            log.error(\"Cannot write json\", e);\n-        }\n \n         switch (distributionResponse.getState()) {\n             case DISTRIBUTED:\n@@ -67,14 +58,46 @@ public static void writeJson(SlingHttpServletResponse response, DistributionResp\n                 // TODO\n                 break;\n         }\n-        append(json.build(), response.getWriter());\n+        JsonObject body = buildBody(distributionResponse);\n+        append(body, response.getWriter());\n     }\n \n     public static void writeJson(SlingHttpServletResponse response, int status, String message,\n                                  @Nullable Map<String, String> kv) throws IOException {\n+\n+        response.setStatus(status);\n+        JsonObject body = buildBody(message, kv);\n+        append(body, response.getWriter());\n+    }\n+\n+    private static void append(JsonObject json, Writer writer) throws IOException {\n+        StringWriter buffer = new StringWriter();\n+        Json.createWriter(buffer).writeObject(json);\n+        writer.append(buffer.toString());\n+    }\n+\n+    protected static JsonObject buildBody(DistributionResponse distributionResponse) {\n         JsonObjectBuilder json = Json.createObjectBuilder();\n         try {\n-            json.add(\"message\", message);\n+            json.add(\"success\", distributionResponse.isSuccessful());\n+            json.add(\"state\", distributionResponse.getState().name());\n+            String message = distributionResponse.getMessage();\n+            if (message != null) {\n+                json.add(\"message\", message);\n+            }\n+\n+        } catch (JsonException e) {\n+            log.error(\"Cannot write json\", e);\n+        }\n+        return json.build();\n+    }\n+\n+    protected static JsonObject buildBody(String message, @Nullable Map<String, String> kv) {\n+        JsonObjectBuilder json = Json.createObjectBuilder();\n+        try {\n+            if (message != null) {\n+                json.add(\"message\", message);\n+            }\n             if (kv != null && kv.size() > 0) {\n                 for (Map.Entry<String, String> entry : kv.entrySet()) {\n                     json.add(entry.getKey(), entry.getValue());\n@@ -83,14 +106,6 @@ public static void writeJson(SlingHttpServletResponse response, int status, Stri\n         } catch (JsonException e) {\n             log.error(\"Cannot write json\", e);\n         }\n-        response.setStatus(status);\n-\n-        append(json.build(), response.getWriter());\n-    }\n-    \n-    private static void append(JsonObject json, Writer writer) throws IOException {\n-        StringWriter buffer = new StringWriter();\n-        Json.createWriter(buffer).writeObject(json);\n-        writer.append(buffer.toString());\n+        return json.build();\n     }\n }",
                "changes": 55
            },
            {
                "status": "added",
                "additions": 69,
                "raw_url": "https://github.com/apache/sling-org-apache-sling-distribution-core/raw/57abab27db7adfc3bcd06083e090c83f8e82e10b/src/test/java/org/apache/sling/distribution/servlet/ServletJsonUtilsTest.java",
                "contents_url": "https://api.github.com/repos/apache/sling-org-apache-sling-distribution-core/contents/src/test/java/org/apache/sling/distribution/servlet/ServletJsonUtilsTest.java?ref=57abab27db7adfc3bcd06083e090c83f8e82e10b",
                "filename": "src/test/java/org/apache/sling/distribution/servlet/ServletJsonUtilsTest.java",
                "deletions": 0,
                "sha": "1ccbe4e87c78332208899fa332594e1e0fe45ee3",
                "blob_url": "https://github.com/apache/sling-org-apache-sling-distribution-core/blob/57abab27db7adfc3bcd06083e090c83f8e82e10b/src/test/java/org/apache/sling/distribution/servlet/ServletJsonUtilsTest.java",
                "patch": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.sling.distribution.servlet;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import javax.json.JsonObject;\n+\n+import org.apache.sling.distribution.DistributionRequestState;\n+import org.apache.sling.distribution.DistributionResponse;\n+import org.apache.sling.distribution.impl.SimpleDistributionResponse;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.*;\n+\n+public class ServletJsonUtilsTest {\n+\n+    @Test\n+    public void testBuildBodyWithMessageAndNoProperties() throws Exception {\n+        String message1 = \"message #1\";\n+        JsonObject body = ServletJsonUtils.buildBody(message1, null);\n+        assertEquals(message1, body.getString(\"message\"));\n+    }\n+\n+    @Test\n+    public void testBuildBodyWithMessageAndProperties() throws Exception {\n+        String message2 = \"message #2\";\n+        String k1 = \"keyOne\", v1 = \"value #1\";\n+        Map<String,String> props = Collections.singletonMap(k1, v1);\n+        JsonObject body = ServletJsonUtils.buildBody(message2, props);\n+        assertEquals(message2, body.getString(\"message\"));\n+        assertEquals(v1, body.getString(k1));\n+    }\n+\n+    @Test\n+    public void testBuildBodyWithDistributionResponseContainingMessage() throws Exception {\n+        String message1 = \"message #1\";\n+        DistributionRequestState state = DistributionRequestState.ACCEPTED;\n+        DistributionResponse response = new SimpleDistributionResponse(state, message1);\n+        JsonObject body = ServletJsonUtils.buildBody(response);\n+        assertEquals(message1, body.getString(\"message\"));\n+    }\n+\n+    @Test\n+    public void testBuildBodyWithDistributionResponseContainingNoMessage() throws Exception {\n+        DistributionRequestState state = DistributionRequestState.ACCEPTED;\n+        DistributionResponse response = new SimpleDistributionResponse(state, null);\n+        JsonObject body = ServletJsonUtils.buildBody(response);\n+        assertFalse(body.containsKey(\"message\"));\n+    }\n+\n+}\n\\ No newline at end of file",
                "changes": 69
            }
        ],
        "unit_tests": [
            "ServletJsonUtilsTest.java"
        ]
    },
    {
        "buggy": false,
        "test_file": "src/test/java/org/apache/sling/distribution/servlet/ServletJsonUtilsTest.java",
        "buggy_files": [
            "src/main/java/org/apache/sling/distribution/servlet/ServletJsonUtils.java"
        ],
        "fixed": true
    }
]