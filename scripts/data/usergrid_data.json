[
    {
        "commit": "https://github.com/apache/usergrid/commit/455bdde7004f1f610f6ac2395298167ee9a3e7b2",
        "file": [
            {
                "patch": "@@ -682,7 +682,7 @@ public void sendMessages( final List bodies ) throws IOException {\n \n     @Override\n     public <T extends Serializable> void sendMessageToLocalRegion(final T body, Boolean async) throws IOException {\n-        boolean sendAsync = async.booleanValue();\n+        boolean sendAsync = async == null || async.booleanValue();\n         if (sendAsync) {\n             sendMessageToLocalRegionAsync(body);\n         } else {",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/455bdde7004f1f610f6ac2395298167ee9a3e7b2/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/SNSQueueManagerImpl.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "83b65de5ef92cb13be784419a2d12008fc2f2394",
                "blob_url": "https://github.com/apache/usergrid/blob/455bdde7004f1f610f6ac2395298167ee9a3e7b2/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/SNSQueueManagerImpl.java",
                "filename": "stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/SNSQueueManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/SNSQueueManagerImpl.java?ref=455bdde7004f1f610f6ac2395298167ee9a3e7b2"
            }
        ],
        "bug_id": "usergrid_1",
        "parent": "https://github.com/apache/usergrid/commit/8913e43d28a191ff8437dacc62c25df8e1e37e6e",
        "message": "fix NPE with push notifications and sendMessageToLocalRegion",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/98a2f5d23d4736219d23c637223a891c47216eed",
        "file": [
            {
                "patch": "@@ -289,13 +289,16 @@ public void merge(boolean keepStaleEntries, String query, boolean isDirectQuery)\n             if (!isDirectQuery) {\n                 filterDuplicateCandidates(query);\n             } else {\n-                // remove direct query duplicates\n+                // remove direct query duplicates or missing entities (names that don't exist will have null ids)\n                 Set<UUID> foundUUIDs = new HashSet<>();\n                 for (FilterResult<Candidate> candidateFilterResult : candidateResults) {\n-                    UUID uuid = candidateFilterResult.getValue().getCandidateResult().getId().getUuid();\n-                    if (!foundUUIDs.contains(uuid)) {\n-                        dedupedCandidateResults.add(candidateFilterResult);\n-                        foundUUIDs.add(uuid);\n+                    Id id = candidateFilterResult.getValue().getCandidateResult().getId();\n+                    if (id != null) {\n+                        UUID uuid = id.getUuid();\n+                        if (!foundUUIDs.contains(uuid)) {\n+                            dedupedCandidateResults.add(candidateFilterResult);\n+                            foundUUIDs.add(uuid);\n+                        }\n                     }\n                 }\n             }",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/98a2f5d23d4736219d23c637223a891c47216eed/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java",
                "status": "modified",
                "changes": 13,
                "deletions": 5,
                "sha": "cf1984d673574aaed9343a297583b80674d71aac",
                "blob_url": "https://github.com/apache/usergrid/blob/98a2f5d23d4736219d23c637223a891c47216eed/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java?ref=98a2f5d23d4736219d23c637223a891c47216eed"
            },
            {
                "patch": "@@ -456,14 +456,15 @@ public CandidateResults search( final SearchEdge searchEdge, final SearchTypes s\n             throw new IllegalArgumentException(\"a null query string cannot be parsed\");\n         }\n \n+        if (parsedQuery.isDirectQuery() && parsedQuery.getDirectQueryItemCount() > indexFig.directQueryMaxItems()) {\n+            throw new TooManyDirectEntitiesException(parsedQuery.getDirectQueryItemCount(), indexFig.directQueryMaxItems());\n+        }\n+\n         final QueryVisitor visitor = visitParsedQuery(parsedQuery);\n \n         List<Identifier> directIdentifiers = visitor.getDirectIdentifiers();\n         if (directIdentifiers != null && directIdentifiers.size() > 0) {\n             // this is a direct query\n-            if (directIdentifiers.size() > indexFig.directQueryMaxItems()) {\n-                throw new TooManyDirectEntitiesException(directIdentifiers.size(), indexFig.directQueryMaxItems());\n-            }\n             return buildCandidateResultsForDirectQuery(directIdentifiers, parsedQuery, searchTypes);\n         }\n ",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/98a2f5d23d4736219d23c637223a891c47216eed/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "status": "modified",
                "changes": 7,
                "deletions": 3,
                "sha": "82be6ecfdfc566a27ef33a7f7c4f9da6c49f176d",
                "blob_url": "https://github.com/apache/usergrid/blob/98a2f5d23d4736219d23c637223a891c47216eed/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java?ref=98a2f5d23d4736219d23c637223a891c47216eed"
            },
            {
                "patch": "@@ -211,4 +211,13 @@ public boolean isGeoQuery(){\n     public boolean isDirectQuery() {\n         return rootOperand instanceof DirectOperand;\n     }\n+\n+    public int getDirectQueryItemCount() {\n+        int count = 0;\n+        if (rootOperand instanceof DirectOperand) {\n+            DirectOperand root = (DirectOperand)rootOperand;\n+            count = root.getChildCount();\n+        }\n+        return count;\n+    }\n }",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/98a2f5d23d4736219d23c637223a891c47216eed/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/query/ParsedQuery.java",
                "status": "modified",
                "changes": 9,
                "deletions": 0,
                "sha": "4c0da5d38f532f409ba179cfd0b763315f8b7547",
                "blob_url": "https://github.com/apache/usergrid/blob/98a2f5d23d4736219d23c637223a891c47216eed/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/query/ParsedQuery.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/query/ParsedQuery.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/query/ParsedQuery.java?ref=98a2f5d23d4736219d23c637223a891c47216eed"
            }
        ],
        "bug_id": "usergrid_2",
        "parent": "https://github.com/apache/usergrid/commit/59e7a24e9ebd577bd892812bd36f2626fa011677",
        "message": "fix NPE for missing names in direct queries and block requests based on direct query count before deduping",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/063595805cbf3efad6b961a9170bdf4953aa2e9d",
        "file": [
            {
                "patch": "@@ -356,11 +356,11 @@ public void queueNotification(final Notification notification, final JobExecutio\n                             if(logger.isTraceEnabled()) {\n                                 logger.trace(\"Queueing notification message for device: {}\", message.get().getDeviceId());\n                             }\n-                            qm.sendMessageToLocalRegion( message.get() , null );\n+                            qm.sendMessageToLocalRegion( message.get(), Boolean.TRUE );\n                             queueMeter.mark();\n                         }\n \n-                    } catch (IOException e) {\n+                    } catch (Exception e) {\n \n                         if(message.isPresent()){\n                             logger.error(\"Unable to queue notification for notification UUID {} and device UUID {} \",",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/063595805cbf3efad6b961a9170bdf4953aa2e9d/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "fcf63a8043bf056b705faa18e03207f75e4c0aa4",
                "blob_url": "https://github.com/apache/usergrid/blob/063595805cbf3efad6b961a9170bdf4953aa2e9d/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java?ref=063595805cbf3efad6b961a9170bdf4953aa2e9d"
            }
        ],
        "bug_id": "usergrid_3",
        "parent": "https://github.com/apache/usergrid/commit/bd2385d76c3343d96b3b8648d1f68904e2247ed7",
        "message": "Fix NPE for push notification processing.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/c0eeefd52f9e17e53d9f924f812624ca022d3040",
        "file": [
            {
                "patch": "@@ -157,7 +157,11 @@ public ServiceResults deleteEntityDictionary(ServiceContext context, List<Entity\n                 throw new IllegalArgumentException(String.format(\"Could not load role with id '%s'\", ref.getUuid()));\n             }\n \n-            Query q = context.getParameters().get(0).getQuery();\n+            Query q = null;\n+\n+            if (context.getParameters().size() > 0) {\n+                q = context.getParameters().get(0).getQuery();\n+            }\n \n             if (q == null) {\n                 throw new IllegalArgumentException(\"You must supply a 'permission' query parameter\");",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/c0eeefd52f9e17e53d9f924f812624ca022d3040/stack/services/src/main/java/org/usergrid/services/roles/RolesService.java",
                "status": "modified",
                "changes": 6,
                "deletions": 1,
                "sha": "4a837a3119d8ca0080c0a7eb5f826238cce41b71",
                "blob_url": "https://github.com/apache/usergrid/blob/c0eeefd52f9e17e53d9f924f812624ca022d3040/stack/services/src/main/java/org/usergrid/services/roles/RolesService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/roles/RolesService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/roles/RolesService.java?ref=c0eeefd52f9e17e53d9f924f812624ca022d3040"
            }
        ],
        "bug_id": "usergrid_4",
        "parent": "https://github.com/apache/usergrid/commit/546051f47223b26c7fd75863c0a63b5763e3b145",
        "message": "avoid NullPointerException",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/5fc3c506a14ac28a702a2c146466b9f3907e4125",
        "file": [
            {
                "patch": "@@ -27,6 +27,7 @@\n import org.apache.usergrid.persistence.Schema;\n import org.apache.usergrid.persistence.index.*;\n import org.apache.usergrid.persistence.index.impl.IndexProducer;\n+import org.apache.usergrid.persistence.index.query.ParsedQuery;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n import org.apache.usergrid.persistence.model.field.DistanceField;\n import org.apache.usergrid.persistence.model.field.EntityObjectField;\n@@ -103,7 +104,8 @@ public CandidateEntityFilter( final EntityCollectionManagerFactory entityCollect\n \n         boolean keepStaleEntries = pipelineContext.getKeepStaleEntries();\n         String query = pipelineContext.getQuery();\n-        boolean isDirectQuery = pipelineContext.getParsedQuery().isDirectQuery();\n+        ParsedQuery parsedQuery = pipelineContext.getParsedQuery();\n+        boolean isDirectQuery = parsedQuery == null ? false : parsedQuery.isDirectQuery();\n \n         //buffer them to get a page size we can make 1 network hop\n         final Observable<FilterResult<Entity>> searchIdSetObservable =",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java",
                "status": "modified",
                "changes": 4,
                "deletions": 1,
                "sha": "c0db02f94aeafb048185def76aac4422f8743210",
                "blob_url": "https://github.com/apache/usergrid/blob/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/search/CandidateEntityFilter.java?ref=5fc3c506a14ac28a702a2c146466b9f3907e4125"
            },
            {
                "patch": "@@ -84,8 +84,11 @@ public ConnectionServiceImpl( final PipelineBuilderFactory pipelineBuilderFactor\n         final Optional<String> query = search.getQuery();\n \n         final IdBuilder pipelineBuilder =\n-            pipelineBuilderFactory.create( search.getApplicationScope() ).withCursor( search.getCursor() )\n-                                  .withLimit( search.getLimit() ).fromId( search.getSourceNodeId() );\n+            pipelineBuilderFactory.create( search.getApplicationScope() )\n+            \t.withCursor( search.getCursor() )\n+            \t.withLimit( search.getLimit() )\n+            \t.query(query)\n+            \t.fromId( search.getSourceNodeId() );\n \n \n         //we want to load all entities",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java",
                "status": "modified",
                "changes": 7,
                "deletions": 2,
                "sha": "c476f1fc57635e43cbf07bccdf5a61d1047603e0",
                "blob_url": "https://github.com/apache/usergrid/blob/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java?ref=5fc3c506a14ac28a702a2c146466b9f3907e4125"
            },
            {
                "patch": "@@ -17,33 +17,31 @@\n package org.apache.usergrid.persistence;\n \n \n-import com.codahale.metrics.MetricRegistry;\n-import com.google.inject.Injector;\n-import net.jcip.annotations.NotThreadSafe;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.UUID;\n+\n import org.apache.commons.lang.RandomStringUtils;\n import org.apache.usergrid.AbstractCoreIT;\n-import org.apache.usergrid.cassandra.SpringResource;\n-import org.apache.usergrid.corepersistence.index.*;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScopeImpl;\n-import org.apache.usergrid.persistence.index.EntityIndex;\n-import org.apache.usergrid.persistence.index.EntityIndexFactory;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-import org.apache.usergrid.persistence.model.entity.SimpleId;\n+import org.apache.usergrid.corepersistence.index.CollectionDeleteRequestBuilder;\n+import org.apache.usergrid.corepersistence.index.CollectionDeleteService;\n import org.junit.After;\n import org.junit.Before;\n import org.junit.Test;\n-import org.junit.Ignore;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import java.util.*;\n+import com.codahale.metrics.MetricRegistry;\n \n-import static org.junit.Assert.*;\n \n \n-@NotThreadSafe\n-@Ignore(\"fix later\")\n public class CollectionDeleteTest extends AbstractCoreIT {\n     private static final Logger logger = LoggerFactory.getLogger( CollectionDeleteTest.class );\n \n@@ -201,9 +199,10 @@ private void waitForDelete( final CollectionDeleteService.CollectionDeleteStatus\n \n     private int retryReadData(EntityManager em, String collectionName, int expectedEntities,  int retry) throws Exception {\n         int count = -1;\n+        Set<Entity> uniqueRemEnts = new HashSet<Entity>();\n         do {\n             try {\n-                count = readData(em, collectionName, expectedEntities);\n+                count = readData(em, collectionName, expectedEntities, uniqueRemEnts);\n             } catch (Exception ignore) {\n                 logger.info( \"caught exception \", ignore);\n             }\n@@ -213,53 +212,52 @@ private int retryReadData(EntityManager em, String collectionName, int expectedE\n         return count;\n     }\n \n-    private int readData(EntityManager em, String collectionName, int expectedEntities)\n+    private int readData(EntityManager em, String collectionName, int expectedEntities, Set<Entity> uniqueRemEnts)\n         throws Exception {\n \n         app.waitForQueueDrainAndRefreshIndex();\n \n         Results results = em.getCollection(em.getApplicationRef(), collectionName, null, expectedEntities,\n             Query.Level.ALL_PROPERTIES, false);\n \n-        int count = 0;\n-        List<Entity> list = new ArrayList<>();\n+        \n         while ( true ) {\n \n             if (results.getEntities().size() == 0) {\n                 break;\n             }\n+            \n \n             UUID lastEntityUUID = null;\n             for ( Entity e : results.getEntities() ) {\n \n                 assertEquals(2000, e.getProperty(\"key2\"));\n \n-                if (count % 100 == 0) {\n-                    logger.info(\"read {} entities\", count);\n+                if (uniqueRemEnts.size() % 100 == 0) {\n+                    logger.info(\"read {} entities\", uniqueRemEnts.size());\n                 }\n                 lastEntityUUID = e.getUuid();\n-                count++;\n-                list.add(e);\n+                uniqueRemEnts.add(e);\n+                logger.info(\"Found remaining entity {}\", lastEntityUUID);\n             }\n \n             results = em.getCollection(em.getApplicationRef(), collectionName, lastEntityUUID, expectedEntities,\n                 Query.Level.ALL_PROPERTIES, false);\n \n         }\n-        logger.info(\"read {} total entities\", count);\n \n-        if (count != expectedEntities) {\n-            logger.info(\"Expected {} did not match actual {}\", expectedEntities, count);\n-            if (count < 20) {\n-                for (Entity e : list) {\n+        if (uniqueRemEnts.size() != expectedEntities) {\n+            logger.info(\"Expected {} did not match actual {}\", expectedEntities, uniqueRemEnts.size());\n+            if (uniqueRemEnts.size() < 20) {\n+                for (Entity e : uniqueRemEnts) {\n                     Object key = e.getProperty(\"key2\");\n-                    logger.info(\"Entity key {} ceated {}\", key, e.getCreated());\n+                    logger.info(\"Entity key {} uuid {} created {}\", key,e.getUuid(), e.getCreated());\n                 }\n             }\n         }\n \n-        assertEquals( \"Did not get expected entities\", expectedEntities, count );\n-        return count;\n+        assertEquals( \"Did not get expected entities\", expectedEntities, uniqueRemEnts.size() );\n+        return uniqueRemEnts.size();\n     }\n \n     private int countEntities( EntityManager em, String collectionName, int expectedEntities)",
                "additions": 30,
                "raw_url": "https://github.com/apache/usergrid/raw/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/core/src/test/java/org/apache/usergrid/persistence/CollectionDeleteTest.java",
                "status": "modified",
                "changes": 62,
                "deletions": 32,
                "sha": "c22a62756f966242a60bc7df5722cbd33811e0e3",
                "blob_url": "https://github.com/apache/usergrid/blob/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/core/src/test/java/org/apache/usergrid/persistence/CollectionDeleteTest.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/CollectionDeleteTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/CollectionDeleteTest.java?ref=5fc3c506a14ac28a702a2c146466b9f3907e4125"
            },
            {
                "patch": "@@ -1,3 +1,21 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n package org.apache.usergrid.rest.exceptions;\n \n ",
                "additions": 18,
                "raw_url": "https://github.com/apache/usergrid/raw/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/TooManyDirectEntitiesExceptionMapper.java",
                "status": "modified",
                "changes": 18,
                "deletions": 0,
                "sha": "06226a5d6c9a6709588c7ff981834900674e049a",
                "blob_url": "https://github.com/apache/usergrid/blob/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/TooManyDirectEntitiesExceptionMapper.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/TooManyDirectEntitiesExceptionMapper.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/TooManyDirectEntitiesExceptionMapper.java?ref=5fc3c506a14ac28a702a2c146466b9f3907e4125"
            },
            {
                "patch": "@@ -24,6 +24,8 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import net.jcip.annotations.NotThreadSafe;\n+\n import java.io.IOException;\n import java.util.List;\n \n@@ -35,6 +37,7 @@\n  *\n  * @since 4.0\n  */\n+@NotThreadSafe\n public class AndOrQueryTest extends QueryTestBase {\n     private static final Logger logger = LoggerFactory.getLogger(AndOrQueryTest.class);\n ",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/rest/src/test/java/org/apache/usergrid/rest/applications/queries/AndOrQueryTest.java",
                "status": "modified",
                "changes": 3,
                "deletions": 0,
                "sha": "61e2760745b670ed6361b5ca13c5c17a3d65cce6",
                "blob_url": "https://github.com/apache/usergrid/blob/5fc3c506a14ac28a702a2c146466b9f3907e4125/stack/rest/src/test/java/org/apache/usergrid/rest/applications/queries/AndOrQueryTest.java",
                "filename": "stack/rest/src/test/java/org/apache/usergrid/rest/applications/queries/AndOrQueryTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/java/org/apache/usergrid/rest/applications/queries/AndOrQueryTest.java?ref=5fc3c506a14ac28a702a2c146466b9f3907e4125"
            }
        ],
        "bug_id": "usergrid_5",
        "parent": "https://github.com/apache/usergrid/commit/749a97f86e8f7470a73a90a0f6221a9dba9c4cf6",
        "message": "Fixed failing tests and bugs\n-Fixed issue where query was not being passed correctly for ql search on\nconnections\n-Fixed NPE for direct query\n-Fixed tests that were failing sometimes due to parallel execution\n-Fixed CollectionDeleteTest so that it doesn not have to be ignored",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/4043e9a34981207e672c1091d2cc3f1b3b7548f9",
        "file": [
            {
                "patch": "@@ -2447,9 +2447,11 @@ public Entity createItemInCollection(String collectionName,\n                 itemType = singularize(collectionName);\n             }\n             if (itemType.equals(TYPE_ROLE)) {\n-                return em.createRole((String) properties.get(PROPERTY_NAME),\n-                        (String) properties.get(PROPERTY_TITLE),\n-                        (Long) properties.get(PROPERTY_INACTIVITY));\n+                Long inactivity = (Long)properties.get(PROPERTY_INACTIVITY);\n+                if (inactivity == null) inactivity = 0L;\n+                return em.createRole((String)properties.get(PROPERTY_NAME),\n+                                     (String)properties.get(PROPERTY_TITLE),\n+                                      inactivity);\n             }\n             return em.create(itemType, properties);\n         } else if (headEntity.getType().equals(Group.ENTITY_TYPE)",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/4043e9a34981207e672c1091d2cc3f1b3b7548f9/stack/core/src/main/java/org/usergrid/persistence/cassandra/RelationManagerImpl.java",
                "status": "modified",
                "changes": 8,
                "deletions": 3,
                "sha": "210dc67b79b8db28472b561341b1013b0470ee23",
                "blob_url": "https://github.com/apache/usergrid/blob/4043e9a34981207e672c1091d2cc3f1b3b7548f9/stack/core/src/main/java/org/usergrid/persistence/cassandra/RelationManagerImpl.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/cassandra/RelationManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/cassandra/RelationManagerImpl.java?ref=4043e9a34981207e672c1091d2cc3f1b3b7548f9"
            }
        ],
        "bug_id": "usergrid_6",
        "parent": "https://github.com/apache/usergrid/commit/7e965d42b4a6a4d87c0c9ffdedf17b0e9ed695f4",
        "message": "fix a NullPointerException when inactivity was not passed in",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/158b5de37fbfa1c6585dadb14b9d8508ecc06026",
        "file": [
            {
                "patch": "@@ -136,7 +136,10 @@ public ServiceResults postCollection(ServiceContext context) throws Exception {\n             // perform some input validates on useGraph payload property vs. ql= path query\n             final List<ServiceParameter> parameters = context.getRequest().getOriginalParameters();\n             for (ServiceParameter parameter : parameters){\n-                if( parameter instanceof ServiceParameter.QueryParameter && context.getProperties().get(\"useGraph\").equals(true)){\n+                if( parameter instanceof ServiceParameter.QueryParameter\n+                    && context.getProperties().get(\"useGraph\") != null\n+                      && context.getProperties().get(\"useGraph\").equals(true)){\n+\n                     throw new IllegalArgumentException(\"Query ql parameter cannot be used with useGraph:true property value\");\n                 }\n             }",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/158b5de37fbfa1c6585dadb14b9d8508ecc06026/stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java",
                "status": "modified",
                "changes": 5,
                "deletions": 1,
                "sha": "65425d7ae8fc83f3a36324d41458ec979d58fce7",
                "blob_url": "https://github.com/apache/usergrid/blob/158b5de37fbfa1c6585dadb14b9d8508ecc06026/stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java?ref=158b5de37fbfa1c6585dadb14b9d8508ecc06026"
            },
            {
                "patch": "@@ -52,6 +52,7 @@\n     private final String queueName;\n     private final Meter queueMeter;\n     private final Meter sendMeter;\n+    private int concurrencyFactor;\n \n     private final static String PUSH_PROCESSING_MAXTHREADS_PROP = \"usergrid.push.async.processing.threads\";\n     private final static String PUSH_PROCESSING_QUEUESIZE_PROP = \"usergrid.push.async.processing.queue.size\";\n@@ -84,12 +85,14 @@ public ApplicationQueueManagerImpl( JobScheduler jobScheduler, EntityManager ent\n \n             maxAsyncThreads = Integer.valueOf(System.getProperty(PUSH_PROCESSING_MAXTHREADS_PROP, \"200\"));\n             workerQueueSize = Integer.valueOf(System.getProperty(PUSH_PROCESSING_QUEUESIZE_PROP, \"2000\"));\n+            this.concurrencyFactor = Integer.valueOf(System.getProperty(PUSH_PROCESSING_CONCURRENCY_PROP, \"50\"));\n \n         } catch (Exception e){\n \n             // if junk is passed into the property, just default the values\n             maxAsyncThreads = 200;\n             workerQueueSize = 2000;\n+            this.concurrencyFactor = 50;\n \n         }\n \n@@ -330,7 +333,7 @@ public void queueNotification(final Notification notification, final JobExecutio\n \n                         }).subscribeOn(Schedulers.from(asyncExecutor));\n \n-                }, Integer.valueOf(System.getProperty(PUSH_PROCESSING_CONCURRENCY_PROP, \"50\")))\n+                }, concurrencyFactor)\n                 .doOnError(throwable -> {\n \n                     logger.error(\"Error while processing devices for notification : {}\", notification.getUuid());",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/158b5de37fbfa1c6585dadb14b9d8508ecc06026/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "status": "modified",
                "changes": 5,
                "deletions": 1,
                "sha": "5254fd61acc053bd738752411857b5c1610eaf0a",
                "blob_url": "https://github.com/apache/usergrid/blob/158b5de37fbfa1c6585dadb14b9d8508ecc06026/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java?ref=158b5de37fbfa1c6585dadb14b9d8508ecc06026"
            }
        ],
        "bug_id": "usergrid_7",
        "parent": "https://github.com/apache/usergrid/commit/c5b06dba4a7b6fafebe613d7d8e4be89cd68755d",
        "message": "Fix NPE.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/588a0b5848eb946492afbfb7fa50cd3a4ca79c78",
        "file": [
            {
                "patch": "@@ -20,7 +20,6 @@\n import org.apache.usergrid.AbstractCoreIT;\n import org.apache.usergrid.persistence.Query.Level;\n import org.apache.usergrid.persistence.entities.User;\n-import org.junit.Ignore;\n import org.junit.Test;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -329,7 +328,6 @@ public void testGetConnectingEntities() throws Exception {\n     }\n \n     //not required . addd tests at service layer.\n-    @Ignore\n     @Test\n     public void testGetConnectingEntitiesCursor() throws Exception {\n ",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/588a0b5848eb946492afbfb7fa50cd3a4ca79c78/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "status": "modified",
                "changes": 2,
                "deletions": 2,
                "sha": "d9ee960b4c1e636d087c5d21c44181ac10e22b96",
                "blob_url": "https://github.com/apache/usergrid/blob/588a0b5848eb946492afbfb7fa50cd3a4ca79c78/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java?ref=588a0b5848eb946492afbfb7fa50cd3a4ca79c78"
            },
            {
                "patch": "@@ -233,7 +233,7 @@ public ServiceResults getItemByName( ServiceContext context, String name ) throw\n \n         ServiceResults results = getItemsByQuery( context, context.getQuery() );\n \n-        if ( results.size() == 0 ) {\n+        if ( results == null || results.size() == 0 ) {\n             throw new ServiceResourceNotFoundException( context );\n         }\n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/588a0b5848eb946492afbfb7fa50cd3a4ca79c78/stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "dee78f9aa474e0089e6f776ccf0a3b57c677c668",
                "blob_url": "https://github.com/apache/usergrid/blob/588a0b5848eb946492afbfb7fa50cd3a4ca79c78/stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java?ref=588a0b5848eb946492afbfb7fa50cd3a4ca79c78"
            }
        ],
        "bug_id": "usergrid_8",
        "parent": "https://github.com/apache/usergrid/commit/73834698d722c6760ca42a10b765a7233d74e157",
        "message": "NPE bug fix and uncommenting the test",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/dd74b7a17e7240abace3baf71a878eaf91edf2d6",
        "file": [
            {
                "patch": "@@ -41,11 +41,12 @@ public void setSampleAppName(String sampleAppName) {\n     @Override\n     public ApplicationInfo createSampleFor(OrganizationInfo organizationInfo)\n             throws ApplicationCreationException {\n-        logger.info(\"create sample app {} in: {}\", sampleAppName, organizationInfo.getName());\n+\n         Preconditions.checkArgument(organizationInfo != null,\n                 \"OrganizationInfo was null\");\n         Preconditions.checkArgument(organizationInfo.getUuid() != null,\n                 \"OrganizationInfo had no UUID\");\n+\t\tlogger.info(\"create sample app {} in: {}\", sampleAppName, organizationInfo.getName());\n         UUID appId = null;\n         try {\n             appId = managementService.createApplication(",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/dd74b7a17e7240abace3baf71a878eaf91edf2d6/stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java",
                "status": "modified",
                "changes": 3,
                "deletions": 1,
                "sha": "5ac34189dac688cf207d50b361a69665e51ea771",
                "blob_url": "https://github.com/apache/usergrid/blob/dd74b7a17e7240abace3baf71a878eaf91edf2d6/stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java?ref=dd74b7a17e7240abace3baf71a878eaf91edf2d6"
            },
            {
                "patch": "@@ -39,7 +39,7 @@\n \tprivate static final Logger logger = LoggerFactory\n \t\t\t.getLogger(DevicesService.class);\n \n-\tprivate static LRUMap deviceCache = new LRUMap(DEVICE_CACHE_COUNT);\n+\tprivate static final LRUMap deviceCache = new LRUMap(DEVICE_CACHE_COUNT);\n \n \tpublic DevicesService() {\n \t\tsuper();",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/dd74b7a17e7240abace3baf71a878eaf91edf2d6/stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "8514dbe96f3bdbf9a5222a69e2cd352d6fb14e16",
                "blob_url": "https://github.com/apache/usergrid/blob/dd74b7a17e7240abace3baf71a878eaf91edf2d6/stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java?ref=dd74b7a17e7240abace3baf71a878eaf91edf2d6"
            }
        ],
        "bug_id": "usergrid_9",
        "parent": "https://github.com/apache/usergrid/commit/19a6c701e76153f0919d593ec2cb6e5114b6f898",
        "message": "Merge pull request #106 from stliu/NPE\n\nMay produce NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/e982ba4ed97cf9993cbc21460791207a8f6bb62d",
        "file": [
            {
                "patch": "@@ -391,7 +391,7 @@ public ServiceResults postCollection( ServiceContext context ) throws Exception\n             for ( Map<String, Object> p : batch ) {\n \n                 // track unique name value in the batch to identify if duplicates are trying to be created\n-                String name = p.get(\"name\").toString();\n+                String name = (String) p.get(\"name\");\n                 if( name !=null && nameValues.get(name) !=null ){\n                     logger.warn(\"Batch contains more than 1 entity with the same name: {}\", name);\n                 }else{",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e982ba4ed97cf9993cbc21460791207a8f6bb62d/stack/services/src/main/java/org/apache/usergrid/services/AbstractCollectionService.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "7539e0c6790e862eabfbbbac38d579c5e71b47cd",
                "blob_url": "https://github.com/apache/usergrid/blob/e982ba4ed97cf9993cbc21460791207a8f6bb62d/stack/services/src/main/java/org/apache/usergrid/services/AbstractCollectionService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/AbstractCollectionService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/AbstractCollectionService.java?ref=e982ba4ed97cf9993cbc21460791207a8f6bb62d"
            }
        ],
        "bug_id": "usergrid_10",
        "parent": "https://github.com/apache/usergrid/commit/57494925989bcd6cc10f09af5d16b6af18d0e707",
        "message": "Fix NPE with batch creation of entities.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/b1157a8924686557e5c26966c5a0b14fb87eb2d6",
        "file": [
            {
                "patch": "@@ -17,69 +17,48 @@\n package org.apache.usergrid.corepersistence;\n \n \n-import java.util.*;\n-\n+import com.google.common.base.Optional;\n+import com.google.common.base.Preconditions;\n+import org.apache.usergrid.corepersistence.asyncevents.AsyncEventService;\n import org.apache.usergrid.corepersistence.index.CollectionSettings;\n import org.apache.usergrid.corepersistence.index.CollectionSettingsFactory;\n import org.apache.usergrid.corepersistence.index.CollectionSettingsScopeImpl;\n-import org.apache.usergrid.corepersistence.results.IdQueryExecutor;\n-import org.apache.usergrid.persistence.map.MapManager;\n-import org.apache.usergrid.persistence.map.MapScope;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-import org.springframework.util.Assert;\n-\n-import org.apache.usergrid.corepersistence.asyncevents.AsyncEventService;\n import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n import org.apache.usergrid.corepersistence.results.ConnectionRefQueryExecutor;\n import org.apache.usergrid.corepersistence.results.EntityQueryExecutor;\n+import org.apache.usergrid.corepersistence.results.IdQueryExecutor;\n import org.apache.usergrid.corepersistence.service.CollectionSearch;\n import org.apache.usergrid.corepersistence.service.CollectionService;\n import org.apache.usergrid.corepersistence.service.ConnectionSearch;\n import org.apache.usergrid.corepersistence.service.ConnectionService;\n import org.apache.usergrid.corepersistence.util.CpEntityMapUtils;\n import org.apache.usergrid.corepersistence.util.CpNamingUtils;\n-import org.apache.usergrid.persistence.ConnectedEntityRef;\n-import org.apache.usergrid.persistence.ConnectionRef;\n-import org.apache.usergrid.persistence.Entity;\n-import org.apache.usergrid.persistence.EntityManager;\n-import org.apache.usergrid.persistence.EntityRef;\n-import org.apache.usergrid.persistence.Query;\n+import org.apache.usergrid.persistence.*;\n import org.apache.usergrid.persistence.Query.Level;\n-import org.apache.usergrid.persistence.RelationManager;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.RoleRef;\n-import org.apache.usergrid.persistence.Schema;\n-import org.apache.usergrid.persistence.SimpleEntityRef;\n-import org.apache.usergrid.persistence.SimpleRoleRef;\n import org.apache.usergrid.persistence.cassandra.ConnectionRefImpl;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.entities.Group;\n import org.apache.usergrid.persistence.entities.User;\n-import org.apache.usergrid.persistence.graph.Edge;\n-import org.apache.usergrid.persistence.graph.GraphManager;\n-import org.apache.usergrid.persistence.graph.MarkedEdge;\n-import org.apache.usergrid.persistence.graph.SearchByEdge;\n-import org.apache.usergrid.persistence.graph.SearchByEdgeType;\n+import org.apache.usergrid.persistence.graph.*;\n import org.apache.usergrid.persistence.graph.impl.SimpleSearchByEdge;\n import org.apache.usergrid.persistence.graph.impl.SimpleSearchByEdgeType;\n import org.apache.usergrid.persistence.graph.impl.SimpleSearchEdgeType;\n import org.apache.usergrid.persistence.index.query.Identifier;\n+import org.apache.usergrid.persistence.map.MapManager;\n+import org.apache.usergrid.persistence.map.MapScope;\n import org.apache.usergrid.persistence.model.entity.Id;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n import org.apache.usergrid.persistence.schema.CollectionInfo;\n import org.apache.usergrid.utils.InflectionUtils;\n import org.apache.usergrid.utils.MapUtils;\n-\n-import com.google.common.base.Optional;\n-import com.google.common.base.Preconditions;\n-\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.util.Assert;\n import rx.Observable;\n \n-import static org.apache.usergrid.corepersistence.util.CpNamingUtils.createCollectionEdge;\n-import static org.apache.usergrid.corepersistence.util.CpNamingUtils.createConnectionEdge;\n-import static org.apache.usergrid.corepersistence.util.CpNamingUtils.createConnectionSearchByEdge;\n-import static org.apache.usergrid.corepersistence.util.CpNamingUtils.getNameFromEdgeType;\n+import java.util.*;\n+\n+import static org.apache.usergrid.corepersistence.util.CpNamingUtils.*;\n import static org.apache.usergrid.persistence.Schema.*;\n import static org.apache.usergrid.utils.ClassUtils.cast;\n import static org.apache.usergrid.utils.InflectionUtils.singularize;\n@@ -954,7 +933,7 @@ public Results searchTargetEntities( Query query ) throws Exception {\n         final Id sourceId = headEntity.asId();\n \n         final Optional<String> queryString = query.isGraphSearch()? Optional.<String>absent(): query.getQl();\n-\n+        final boolean isConnecting = query.isConnecting();\n \n         if ( query.getResultsLevel() == Level.REFS || query.getResultsLevel() == Level.IDS ) {\n \n@@ -968,7 +947,7 @@ public Results searchTargetEntities( Query query ) throws Exception {\n \n                     final ConnectionSearch search =\n                         new ConnectionSearch( applicationScope, sourceId, entityType, connection, toExecute.getLimit(),\n-                            queryString, cursor );\n+                            queryString, cursor, isConnecting );\n                     return connectionService.searchConnectionAsRefs( search );\n                 }\n             }.next();\n@@ -983,7 +962,7 @@ public Results searchTargetEntities( Query query ) throws Exception {\n                 //we need the callback so as we get a new cursor, we execute a new search and re-initialize our builders\n                 final ConnectionSearch search =\n                     new ConnectionSearch( applicationScope, sourceId, entityType, connection, toExecute.getLimit(),\n-                        queryString, cursor );\n+                        queryString, cursor, isConnecting );\n                 return connectionService.searchConnection( search );\n             }\n         }.next();",
                "additions": 17,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "status": "modified",
                "changes": 55,
                "deletions": 38,
                "sha": "57b1526e692f1b91f14bea8fa0e6ab8b0a4fe4c2",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -20,23 +20,20 @@\n package org.apache.usergrid.corepersistence.pipeline.builder;\n \n \n+import com.google.common.base.Optional;\n+import org.apache.usergrid.corepersistence.pipeline.Pipeline;\n import org.apache.usergrid.corepersistence.pipeline.PipelineOperation;\n import org.apache.usergrid.corepersistence.pipeline.read.FilterFactory;\n-import org.apache.usergrid.corepersistence.pipeline.Pipeline;\n import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n import org.apache.usergrid.corepersistence.pipeline.read.collect.ConnectionRefFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.collect.ConnectionRefResumeFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.collect.IdResumeFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.collect.ResultsPageCollector;\n import org.apache.usergrid.corepersistence.pipeline.read.search.Candidate;\n-import org.apache.usergrid.corepersistence.pipeline.read.traverse.IdFilter;\n import org.apache.usergrid.persistence.ConnectionRef;\n import org.apache.usergrid.persistence.model.entity.Entity;\n import org.apache.usergrid.persistence.model.entity.Id;\n-\n-import com.google.common.base.Optional;\n-\n import rx.Observable;\n \n \n@@ -68,6 +65,28 @@ public EntityBuilder loadEntities() {\n     }\n \n \n+    /**\n+     * Traverse all connection edges to our input Id\n+     * @param connectionName The name of the connection\n+     * @param entityType The optional type of the entity\n+     * @return\n+     */\n+    public IdBuilder traverseReverseConnection( final String connectionName, final Optional<String> entityType ) {\n+\n+        final PipelineOperation<FilterResult<Id>, FilterResult<Id>> filter;\n+\n+        if(entityType.isPresent()){\n+            //todo: change this too.\n+            filter = filterFactory.readGraphConnectionByTypeFilter( connectionName, entityType.get() );\n+        }else{\n+            filter = filterFactory.readGraphReverseConnectionFilter( connectionName );\n+        }\n+\n+\n+        return new IdBuilder( pipeline.withFilter(filter ), filterFactory );\n+    }\n+\n+\n     /**\n      * Traverse all the collection edges from our input Id\n      * @param collectionName",
                "additions": 24,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/builder/IdBuilder.java",
                "status": "modified",
                "changes": 29,
                "deletions": 5,
                "sha": "b7d1f867c7363640787be87b6dd5b865139dc8bf",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/builder/IdBuilder.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/builder/IdBuilder.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/builder/IdBuilder.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -62,6 +62,14 @@\n      */\n     ReadGraphConnectionFilter readGraphConnectionFilter( final String connectionName );\n \n+\n+    /**\n+     * Generate a new instance of the command with the specified parameters\n+     *\n+     * @param connectionName The connection name to use when reverse traversing the graph\n+     */\n+    ReadGraphReverseConnectionFilter readGraphReverseConnectionFilter( final String connectionName );\n+\n     /**\n      * Generate a new instance of the command with the specified parameters\n      *",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java",
                "status": "modified",
                "changes": 8,
                "deletions": 0,
                "sha": "4b615d840c0022bc044e0b5d8db7da657acb5eb3",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -0,0 +1,291 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read.traverse;\n+\n+\n+import org.apache.usergrid.corepersistence.asyncevents.AsyncEventService;\n+import org.apache.usergrid.corepersistence.asyncevents.EventBuilder;\n+import org.apache.usergrid.corepersistence.asyncevents.EventBuilderImpl;\n+import org.apache.usergrid.persistence.core.rx.RxTaskScheduler;\n+import org.apache.usergrid.persistence.index.impl.IndexOperationMessage;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.usergrid.corepersistence.pipeline.cursor.CursorSerializer;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractPathFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n+import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n+import org.apache.usergrid.persistence.graph.Edge;\n+import org.apache.usergrid.persistence.graph.GraphManager;\n+import org.apache.usergrid.persistence.graph.GraphManagerFactory;\n+import org.apache.usergrid.persistence.graph.MarkedEdge;\n+import org.apache.usergrid.persistence.graph.SearchByEdgeType;\n+import org.apache.usergrid.persistence.graph.impl.SimpleSearchByEdgeType;\n+import org.apache.usergrid.persistence.model.entity.Id;\n+\n+import com.google.common.base.Optional;\n+\n+import rx.Observable;\n+import rx.functions.Func1;\n+\n+\n+/**\n+ * Command for reading graph edges in reverse order.\n+ */\n+public abstract class AbstractReadReverseGraphFilter extends AbstractPathFilter<Id, Id, MarkedEdge> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger( AbstractReadGraphFilter.class );\n+\n+    private final GraphManagerFactory graphManagerFactory;\n+    private final RxTaskScheduler rxTaskScheduler;\n+    private final EventBuilder eventBuilder;\n+    private final AsyncEventService asyncEventService;\n+\n+\n+    /**\n+     * Create a new instance of our command\n+     */\n+    public AbstractReadReverseGraphFilter( final GraphManagerFactory graphManagerFactory,\n+                                    final RxTaskScheduler rxTaskScheduler,\n+                                    final EventBuilder eventBuilder,\n+                                    final AsyncEventService asyncEventService ) {\n+        this.graphManagerFactory = graphManagerFactory;\n+        this.rxTaskScheduler = rxTaskScheduler;\n+        this.eventBuilder = eventBuilder;\n+        this.asyncEventService = asyncEventService;\n+    }\n+\n+\n+    @Override\n+    public Observable<FilterResult<Id>> call( final Observable<FilterResult<Id>> previousIds ) {\n+\n+\n+        final ApplicationScope applicationScope = pipelineContext.getApplicationScope();\n+\n+        //get the graph manager\n+        final GraphManager graphManager =\n+            graphManagerFactory.createEdgeManager( applicationScope );\n+\n+\n+        final String edgeName = getEdgeTypeName();\n+        final EdgeState edgeCursorState = new EdgeState();\n+\n+\n+        //return all ids that are emitted from this edge\n+        return previousIds.flatMap( previousFilterValue -> {\n+\n+            //set our our constant state\n+            final Optional<MarkedEdge> startFromCursor = getSeekValue();\n+            final Id id = previousFilterValue.getValue();\n+\n+\n+            final Optional<Edge> typeWrapper = Optional.fromNullable(startFromCursor.orNull());\n+\n+            /**\n+             * We do not want to filter.  This is intentional DO NOT REMOVE!!!\n+             *\n+             * We want to fire events on these edges if they exist, the delete was missed.\n+             */\n+            final SimpleSearchByEdgeType search =\n+                new SimpleSearchByEdgeType( id, edgeName, Long.MAX_VALUE, SearchByEdgeType.Order.DESCENDING,\n+                    typeWrapper, false );\n+\n+            /**\n+             * TODO, pass a message with pointers to our cursor values to be generated later\n+             */\n+            return graphManager.loadEdgesToTarget( search ).filter(markedEdge -> {\n+\n+                final boolean isDeleted = markedEdge.isDeleted();\n+                final boolean isSourceNodeDeleted = markedEdge.isSourceNodeDelete();\n+                final boolean isTargetNodeDelete = markedEdge.isTargetNodeDeleted();\n+\n+\n+                if (isDeleted) {\n+\n+                    logger.info(\"Edge {} is deleted when seeking, deleting the edge\", markedEdge);\n+                    final Observable<IndexOperationMessage> indexMessageObservable = eventBuilder.buildDeleteEdge(applicationScope, markedEdge);\n+\n+                    indexMessageObservable\n+                        .compose(applyCollector())\n+                        .subscribeOn(rxTaskScheduler.getAsyncIOScheduler())\n+                        .subscribe();\n+\n+                }\n+\n+                if (isSourceNodeDeleted) {\n+\n+                    final Id sourceNodeId = markedEdge.getSourceNode();\n+                    logger.info(\"Edge {} has a deleted source node, deleting the entity for id {}\", markedEdge, sourceNodeId);\n+\n+                    final EventBuilderImpl.EntityDeleteResults\n+                        entityDeleteResults = eventBuilder.buildEntityDelete(applicationScope, sourceNodeId);\n+\n+                    entityDeleteResults.getIndexObservable()\n+                        .compose(applyCollector())\n+                        .subscribeOn(rxTaskScheduler.getAsyncIOScheduler())\n+                        .subscribe();\n+\n+                    Observable.merge(entityDeleteResults.getEntitiesDeleted(),\n+                        entityDeleteResults.getCompactedNode())\n+                        .subscribeOn(rxTaskScheduler.getAsyncIOScheduler()).\n+                        subscribe();\n+\n+                }\n+\n+                if (isTargetNodeDelete) {\n+\n+                    final Id targetNodeId = markedEdge.getTargetNode();\n+                    logger.info(\"Edge {} has a deleted target node, deleting the entity for id {}\", markedEdge, targetNodeId);\n+\n+                    final EventBuilderImpl.EntityDeleteResults\n+                        entityDeleteResults = eventBuilder.buildEntityDelete(applicationScope, targetNodeId);\n+\n+                    entityDeleteResults.getIndexObservable()\n+                        .compose(applyCollector())\n+                        .subscribeOn(rxTaskScheduler.getAsyncIOScheduler())\n+                        .subscribe();\n+\n+                    Observable.merge(entityDeleteResults.getEntitiesDeleted(),\n+                        entityDeleteResults.getCompactedNode())\n+                        .subscribeOn(rxTaskScheduler.getAsyncIOScheduler()).\n+                        subscribe();\n+\n+                }\n+\n+\n+                //filter if any of them are marked\n+                return !isDeleted && !isSourceNodeDeleted && !isTargetNodeDelete;\n+\n+\n+            })  // any non-deleted edges should be de-duped here so the results are unique\n+                .distinct( new EdgeDistinctKey() )\n+                //set the edge state for cursors\n+                .doOnNext( edge -> {\n+                    if (logger.isTraceEnabled()) {\n+                        logger.trace(\"Seeking over edge {}\", edge);\n+                    }\n+                    edgeCursorState.update( edge );\n+                } )\n+\n+                //map our id from the target edge  and set our cursor every edge we traverse\n+                .map( edge -> createFilterResult( edge.getSourceNode(), edgeCursorState.getCursorEdge(),\n+                    previousFilterValue.getPath() ) );\n+        } );\n+    }\n+\n+\n+    @Override\n+    protected FilterResult<Id> createFilterResult( final Id emit, final MarkedEdge cursorValue,\n+                                                   final Optional<EdgePath> parent ) {\n+\n+        //if it's our first pass, there's no cursor to generate\n+        if(cursorValue == null){\n+            return new FilterResult<>( emit, parent );\n+        }\n+\n+        return super.createFilterResult( emit, cursorValue, parent );\n+    }\n+\n+\n+    @Override\n+    protected CursorSerializer<MarkedEdge> getCursorSerializer() {\n+        return EdgeCursorSerializer.INSTANCE;\n+    }\n+\n+\n+    /**\n+     * Get the edge type name we should use when traversing\n+     */\n+    protected abstract String getEdgeTypeName();\n+\n+\n+    /**\n+     * Wrapper class. Because edges seek > the last returned, we need to keep our n-1 value. This will be our cursor We\n+     * always try to seek to the same position as we ended.  Since we don't deal with a persistent read result, if we\n+     * seek to a value = to our last, we may skip data.\n+     */\n+    private final class EdgeState {\n+\n+        private MarkedEdge cursorEdge = null;\n+        private MarkedEdge currentEdge = null;\n+\n+\n+        /**\n+         * Update the pointers\n+         */\n+        private void update( final MarkedEdge newEdge ) {\n+            cursorEdge = currentEdge;\n+            currentEdge = newEdge;\n+        }\n+\n+\n+        /**\n+         * Get the edge to use in cursors for resume\n+         */\n+        private MarkedEdge getCursorEdge() {\n+            return cursorEdge;\n+        }\n+    }\n+\n+    private Observable.Transformer<IndexOperationMessage, IndexOperationMessage> applyCollector() {\n+\n+        return observable -> observable\n+            .collect(() -> new IndexOperationMessage(), (collector, single) -> collector.ingest(single))\n+            .filter(msg -> !msg.isEmpty())\n+            .doOnNext(indexOperation -> {\n+                asyncEventService.queueIndexOperationMessage(indexOperation);\n+            });\n+\n+    }\n+\n+    /**\n+     *  Return a key that Rx can use for determining a distinct edge.  Build a string containing the UUID\n+     *  of the source and target nodes, with the type to ensure uniqueness rather than the int sum of the hash codes.\n+     *  Edge timestamp is specifically left out as edges with the same source,target,type but different timestamps\n+     *  are considered duplicates.\n+     */\n+    private class EdgeDistinctKey implements Func1<Edge,String> {\n+\n+        @Override\n+        public String call(Edge edge) {\n+\n+            return buildDistinctKey(edge.getSourceNode().getUuid().toString(), edge.getTargetNode().getUuid().toString(),\n+                edge.getType().toLowerCase());\n+        }\n+    }\n+\n+    protected static String buildDistinctKey(final String sourceNode, final String targetNode, final String type){\n+\n+        final String DISTINCT_KEY_SEPARATOR = \":\";\n+        StringBuilder stringBuilder = new StringBuilder();\n+\n+        stringBuilder\n+            .append(sourceNode)\n+            .append(DISTINCT_KEY_SEPARATOR)\n+            .append(targetNode)\n+            .append(DISTINCT_KEY_SEPARATOR)\n+            .append(type);\n+\n+        return stringBuilder.toString();\n+\n+    }\n+\n+}",
                "additions": 291,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/AbstractReadReverseGraphFilter.java",
                "status": "added",
                "changes": 291,
                "deletions": 0,
                "sha": "dcda98f508be1bacd8d1b1a227e18b6288d45acf",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/AbstractReadReverseGraphFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/AbstractReadReverseGraphFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/AbstractReadReverseGraphFilter.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read.traverse;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.assistedinject.Assisted;\n+import org.apache.usergrid.corepersistence.asyncevents.AsyncEventService;\n+import org.apache.usergrid.corepersistence.asyncevents.EventBuilder;\n+import org.apache.usergrid.corepersistence.rx.impl.AsyncRepair;\n+import org.apache.usergrid.persistence.core.rx.RxTaskScheduler;\n+import org.apache.usergrid.persistence.graph.GraphManagerFactory;\n+\n+import static org.apache.usergrid.corepersistence.util.CpNamingUtils.getEdgeTypeFromConnectionType;\n+\n+/**\n+ * Created by ayeshadastagiri on 8/9/16.\n+ */\n+public class ReadGraphReverseConnectionFilter extends AbstractReadReverseGraphFilter{\n+    private final String connectionName;\n+\n+    /**\n+     * Create a new instance of our command\n+     */\n+    @Inject\n+    public ReadGraphReverseConnectionFilter( final GraphManagerFactory graphManagerFactory,\n+                                      @AsyncRepair final RxTaskScheduler rxTaskScheduler,\n+                                      final EventBuilder eventBuilder,\n+                                      final AsyncEventService asyncEventService,\n+                                      @Assisted final String connectionName ) {\n+        super( graphManagerFactory, rxTaskScheduler, eventBuilder, asyncEventService );\n+        this.connectionName = connectionName;\n+    }\n+    @Override\n+    protected String getEdgeTypeName() {\n+        return getEdgeTypeFromConnectionType( connectionName );    }\n+}",
                "additions": 53,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/ReadGraphReverseConnectionFilter.java",
                "status": "added",
                "changes": 53,
                "deletions": 0,
                "sha": "aa369c25258e2716e1744aadc7868696204cf843",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/ReadGraphReverseConnectionFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/ReadGraphReverseConnectionFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/traverse/ReadGraphReverseConnectionFilter.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -36,18 +36,20 @@\n     private final int limit;\n     private final Optional<String> query;\n     private final Optional<String> cursor;\n+    private final boolean isConnecting;\n \n \n     public ConnectionSearch( final ApplicationScope applicationScope, final Id sourceNodeId, final Optional<String> entityType,\n                              final String connectionName, final int limit, final Optional<String> query, final\n-                             Optional<String> cursor ) {\n+                             Optional<String> cursor, boolean isConnecting ) {\n         this.applicationScope = applicationScope;\n         this.sourceNodeId = sourceNodeId;\n         this.entityType = entityType;\n         this.connectionName = connectionName;\n         this.limit = limit;\n         this.query = query;\n         this.cursor = cursor;\n+        this.isConnecting = isConnecting;\n     }\n \n \n@@ -84,4 +86,8 @@ public Id getSourceNodeId() {\n     public Optional<String> getEntityType() {\n         return entityType;\n     }\n+\n+    public boolean getIsConnecting(){\n+        return isConnecting;\n+    }\n }",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionSearch.java",
                "status": "modified",
                "changes": 8,
                "deletions": 1,
                "sha": "8ad57fbdcda7e603c54313fd5fe6367f5a1acf2b",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionSearch.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionSearch.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionSearch.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -94,8 +94,13 @@ public ConnectionServiceImpl( final PipelineBuilderFactory pipelineBuilderFactor\n \n \n         if ( !query.isPresent() ) {\n-            results =\n-                pipelineBuilder.traverseConnection( search.getConnectionName(), search.getEntityType() ).loadEntities();\n+            if(search.getIsConnecting()){\n+                results = pipelineBuilder.traverseReverseConnection(search.getConnectionName(), search.getEntityType()).loadEntities();\n+            }\n+            else {\n+                results =\n+                    pipelineBuilder.traverseConnection(search.getConnectionName(), search.getEntityType()).loadEntities();\n+            }\n         }\n \n         else {",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java",
                "status": "modified",
                "changes": 9,
                "deletions": 2,
                "sha": "926c67627e2bc9687734ae1bb9863bda0727b398",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/service/ConnectionServiceImpl.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -19,36 +19,25 @@\n package org.apache.usergrid.persistence;\n \n \n-import java.io.IOException;\n-import java.io.Serializable;\n-import java.io.UnsupportedEncodingException;\n-import java.net.URLDecoder;\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Map.Entry;\n-import java.util.UUID;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import org.apache.commons.codec.binary.Base64;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.base.Optional;\n import org.apache.commons.lang.StringUtils;\n-\n import org.apache.usergrid.persistence.index.SelectFieldMapping;\n import org.apache.usergrid.persistence.index.exceptions.QueryParseException;\n import org.apache.usergrid.persistence.index.query.CounterResolution;\n import org.apache.usergrid.persistence.index.query.Identifier;\n import org.apache.usergrid.persistence.index.query.tree.Operand;\n import org.apache.usergrid.persistence.index.utils.ClassUtils;\n-import org.apache.usergrid.persistence.index.utils.ConversionUtils;\n import org.apache.usergrid.persistence.index.utils.ListUtils;\n import org.apache.usergrid.persistence.index.utils.MapUtils;\n \n-import com.fasterxml.jackson.annotation.JsonIgnore;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.google.common.base.Optional;\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLDecoder;\n+import java.util.*;\n+import java.util.Map.Entry;\n \n \n public class Query {\n@@ -82,6 +71,7 @@\n     private Long startTime;\n     private Long finishTime;\n     private boolean pad;\n+    private boolean connecting = false;\n     private CounterResolution resolution = CounterResolution.ALL;\n     private List<Identifier> identifiers;\n     private List<CounterFilterPredicate> counterFilters;\n@@ -611,6 +601,15 @@ public void setPad( boolean pad ) {\n         this.pad = pad;\n     }\n \n+    //set the flag to retrieve the edges in the reverse direction.\n+    public void setConnecting( boolean connecting ) {\n+        this.connecting = connecting;\n+    }\n+\n+    public boolean isConnecting() {\n+        return connecting;\n+    }\n+\n \n     public void setResolution( CounterResolution resolution ) {\n         this.resolution = resolution;",
                "additions": 19,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/persistence/Query.java",
                "status": "modified",
                "changes": 39,
                "deletions": 20,
                "sha": "d68c08534524729c661819c779d64bb0cffb6cbc",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/main/java/org/apache/usergrid/persistence/Query.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/Query.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/Query.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -17,24 +17,17 @@\n package org.apache.usergrid.persistence;\n \n \n-import java.util.HashMap;\n-import java.util.LinkedHashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.UUID;\n-\n+import org.apache.usergrid.AbstractCoreIT;\n+import org.apache.usergrid.persistence.Query.Level;\n+import org.apache.usergrid.persistence.entities.User;\n+import org.junit.Ignore;\n import org.junit.Test;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import org.apache.usergrid.AbstractCoreIT;\n-import org.apache.usergrid.persistence.entities.User;\n-import org.apache.usergrid.persistence.Query.Level;\n+import java.util.*;\n \n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertNotNull;\n-import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.*;\n \n public class EntityConnectionsIT extends AbstractCoreIT {\n     private static final Logger logger = LoggerFactory.getLogger( EntityConnectionsIT.class );\n@@ -335,6 +328,54 @@ public void testGetConnectingEntities() throws Exception {\n         assertEquals( \"user\", res.getEntity().getType() );\n     }\n \n+    //not required . addd tests at service layer.\n+    @Ignore\n+    @Test\n+    public void testGetConnectingEntitiesCursor() throws Exception {\n+\n+        UUID applicationId = app.getId( );\n+        assertNotNull( applicationId );\n+\n+        EntityManager em = app.getEntityManager();\n+        assertNotNull( em );\n+\n+        User fred = new User();\n+        fred.setUsername( \"fred\" );\n+        fred.setEmail( \"fred@flintstones.com\" );\n+        Entity fredEntity = em.create( fred );\n+        assertNotNull( fredEntity );\n+\n+        User wilma = new User();\n+        wilma.setUsername( \"wilma\" );\n+        wilma.setEmail( \"wilma@flintstones.com\" );\n+        Entity wilmaEntity = em.create( wilma );\n+        assertNotNull( wilmaEntity );\n+\n+        User John = new User();\n+        John.setUsername( \"John\" );\n+        John.setEmail( \"John@flintstones.com\" );\n+        Entity JohnEntity = em.create( John );\n+        assertNotNull( JohnEntity );\n+\n+        em.createConnection( fredEntity, \"likes\", wilmaEntity );\n+        em.createConnection( fredEntity, \"likes\", JohnEntity );\n+\n+\n+        app.refreshIndex();\n+\n+        // now query via the testConnection, this should work\n+\n+        Query query = Query.fromQLNullSafe(\"\" );\n+        query.setConnectionType( \"likes\" );\n+//        query.setConnecting(true);\n+        query.setEntityType( \"user\" );\n+\n+        // goes through \"traverseReverseConnection\"\n+        Results r = em.searchTargetEntities(fredEntity, query);\n+\n+        assertEquals( 2, r.size() );\n+    }\n+\n \n \n ",
                "additions": 54,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "status": "modified",
                "changes": 67,
                "deletions": 13,
                "sha": "3d4e53c53592ea1908f1f726da119e041d7b7da0",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -17,32 +17,24 @@\n package org.apache.usergrid.services;\n \n \n-import java.util.List;\n-import java.util.Set;\n-import java.util.UUID;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import org.apache.usergrid.persistence.ConnectionRef;\n-import org.apache.usergrid.persistence.Entity;\n-import org.apache.usergrid.persistence.EntityRef;\n-import org.apache.usergrid.persistence.Query;\n+import org.apache.usergrid.persistence.*;\n import org.apache.usergrid.persistence.Query.Level;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.Schema;\n-import org.apache.usergrid.persistence.SimpleEntityRef;\n import org.apache.usergrid.persistence.index.query.Identifier;\n import org.apache.usergrid.services.ServiceParameter.IdParameter;\n import org.apache.usergrid.services.ServiceParameter.NameParameter;\n import org.apache.usergrid.services.ServiceParameter.QueryParameter;\n import org.apache.usergrid.services.ServiceResults.Type;\n import org.apache.usergrid.services.exceptions.ServiceResourceNotFoundException;\n import org.apache.usergrid.services.exceptions.UnsupportedServiceOperationException;\n-\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import rx.Observable;\n import rx.schedulers.Schedulers;\n \n+import java.util.List;\n+import java.util.Set;\n+import java.util.UUID;\n+\n import static org.apache.usergrid.services.ServiceParameter.filter;\n import static org.apache.usergrid.services.ServiceParameter.firstParameterIsName;\n import static org.apache.usergrid.utils.ClassUtils.cast;\n@@ -307,20 +299,15 @@ public ServiceResults getItemsByQuery( ServiceContext context, Query query ) thr\n         Results r = null;\n \n         if ( connecting() ) {\n+            query.setConnecting(true);\n             if ( query.hasQueryPredicates() ) {\n                 if (logger.isTraceEnabled()) {\n                     logger.trace(\"Attempted query of backwards connections\");\n                 }\n                 return null;\n             }\n             else {\n-//            \tr = em.getSourceEntities( context.getOwner().getUuid(), query.getConnectionType(),\n-//            \t\t\tquery.getEntityType(), level );\n-                // usergrid-2389: User defined limit in the query is ignored. Fixed it by adding\n-                // the limit to the method parameter downstream.\n-            \tr = em.getSourceEntities(\n-                    new SimpleEntityRef(context.getOwner().getType(), context.getOwner().getUuid()),\n-                    query.getConnectionType(), query.getEntityType(), level, query.getLimit());\n+                r = em.searchTargetEntities(context.getOwner(),query);\n             }\n         }\n         else {\n@@ -381,6 +368,10 @@ public ServiceResults postItemsByQuery( ServiceContext context, Query query ) th\n             }\n             else {\n                 entity = em.create( query.getEntityType(), context.getProperties() );\n+                //if entity is null here it throws NPE. Fixing it to throw 404.\n+                if ( entity == null ) {\n+                    throw new ServiceResourceNotFoundException( context );\n+                }\n             }\n             entity = importEntity( context, entity );\n ",
                "additions": 13,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java",
                "status": "modified",
                "changes": 35,
                "deletions": 22,
                "sha": "0a9f6a779b50499f6ac472536b9d7a843218c009",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/AbstractConnectionsService.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            },
            {
                "patch": "@@ -17,19 +17,17 @@\n package org.apache.usergrid.services;\n \n \n-import java.util.Map;\n-\n+import org.apache.usergrid.persistence.Entity;\n+import org.apache.usergrid.persistence.Query;\n import org.junit.Assert;\n import org.junit.Test;\n-\n-import org.apache.usergrid.persistence.Entity;\n-\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertNotNull;\n-import static org.junit.Assert.assertTrue;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.util.Map;\n+\n+import static org.junit.Assert.*;\n+\n \n \n public class ConnectionsServiceIT extends AbstractServiceIT {\n@@ -86,6 +84,66 @@ public void testUserConnections() throws Exception {\n         app.testRequest( ServiceAction.POST, 1, \"users\", \"conn-user1\", \"manages\", \"user\" );\n     }\n \n+    @SuppressWarnings(\"rawtypes\")\n+    @Test\n+    public void testUserConnectionsCursor() throws Exception {\n+        app.put(\"username\", \"conn-user1\");\n+        app.put(\"email\", \"conn-user1@apigee.com\");\n+\n+        Entity user1 = app.testRequest(ServiceAction.POST, 1, \"users\").getEntity();\n+        assertNotNull(user1);\n+\n+        app.testRequest(ServiceAction.GET, 1, \"users\", \"conn-user1\");\n+\n+        app.put(\"username\", \"conn-user2\");\n+        app.put(\"email\", \"conn-user2@apigee.com\");\n+\n+        Entity user2 = app.testRequest(ServiceAction.POST, 1, \"users\").getEntity();\n+        assertNotNull(user2);\n+\n+\n+        app.put(\"username\", \"conn-user3\");\n+        app.put(\"email\", \"conn-user3@apigee.com\");\n+\n+        Entity user3 = app.testRequest(ServiceAction.POST, 1, \"users\").getEntity();\n+        assertNotNull(user3);\n+\n+\n+        //POST users/conn-user2/manages/user2/conn-user1\n+        app.testRequest(ServiceAction.POST, 1, \"users\", \"conn-user2\", \"likes\", \"users\", \"conn-user1\");\n+        //POST users/conn-user3/reports/users/conn-user1\n+        app.testRequest(ServiceAction.POST, 1, \"users\", \"conn-user3\", \"likes\", \"users\", \"conn-user1\");\n+\n+        Query query = new Query().fromQLNullSafe(\"\");\n+        query.setLimit(1);\n+\n+        //the result should return a valid cursor.\n+        ServiceResults result = app.testRequest(ServiceAction.GET, 1, \"users\", \"conn-user1\", \"connecting\", \"likes\",query);\n+        assertNotNull(result.getCursor());\n+        String enityName1 = result.getEntity().getProperty(\"email\").toString();\n+\n+        Query newquery = new Query().fromQLNullSafe(\"\");\n+        query.setCursor(result.getCursor());\n+        result = app.testRequest(ServiceAction.GET,1,\"users\",\"conn-user1\",\"connecting\",\"likes\",query);\n+        String enityName2 = result.getEntity().getProperty(\"email\").toString();\n+\n+        //ensure the two entities returned in above requests are different.\n+        assertNotEquals(enityName1,enityName2);\n+\n+        newquery = new Query().fromQLNullSafe(\"\");\n+        query.setCursor(result.getCursor());\n+        result = app.testRequest(ServiceAction.GET,0,\"users\",\"conn-user1\",\"connecting\",\"likes\",query);\n+        //return empty cursor when no more entitites found.\n+        assertNull(result.getCursor());\n+\n+        //DELETE users/conn-user1/manages/user2/conn-user2 (qualified by collection type on second entity)\n+        app.testRequest(ServiceAction.DELETE, 1, \"users\", \"conn-user2\", \"likes\", \"users\", \"conn-user1\");\n+\n+        app.testRequest(ServiceAction.GET,1,\"users\",\"conn-user1\",\"connecting\",\"likes\");\n+\n+\n+    }\n+\n     @Test\n     public void testNonExistentEntity() throws Exception {\n ",
                "additions": 66,
                "raw_url": "https://github.com/apache/usergrid/raw/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java",
                "status": "modified",
                "changes": 74,
                "deletions": 8,
                "sha": "4e65f54d2079825b59e371d425f814653ac82bc5",
                "blob_url": "https://github.com/apache/usergrid/blob/b1157a8924686557e5c26966c5a0b14fb87eb2d6/stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java",
                "filename": "stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java?ref=b1157a8924686557e5c26966c5a0b14fb87eb2d6"
            }
        ],
        "bug_id": "usergrid_11",
        "parent": "https://github.com/apache/usergrid/commit/10e895767c9cc661ad6c6e728eb1b780e0efe7e9",
        "message": "Fixing https://issues.apache.org/jira/browse/USERGRID-1310.\nAlso fixed an NPE found during the fix. ( in abstract connection service when entity us null it throws NPE. Changed it to throw 404)",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/94579c7213862afa194a7aec78b1a92070e7bbf8",
        "file": [
            {
                "patch": "@@ -457,7 +457,7 @@ private static DirectedEdgeMeta fromTargetNodeSourceType( final NodeMeta[] nodes\n \n \n                 final SearchByIdType search =\n-                        new SimpleSearchByIdType( targetId, edgeType, maxValue, order, sourceType,  null );\n+                        new SimpleSearchByIdType( targetId, edgeType, maxValue, order, sourceType,  Optional.absent() );\n \n                 return serialization.getEdgesToTargetBySourceType( edgeColumnFamilies, scope, search, shards );\n             }\n@@ -517,7 +517,7 @@ private static DirectedEdgeMeta fromEdge( final NodeMeta[] nodes, final String[]\n                 final String edgeType = types[0];\n \n                 final SimpleSearchByEdge search =\n-                        new SimpleSearchByEdge( sourceId, edgeType, targetId, maxValue, order, null );\n+                        new SimpleSearchByEdge( sourceId, edgeType, targetId, maxValue, order,  Optional.absent() );\n \n                 return serialization.getEdgeVersions( edgeColumnFamilies, scope, search, shards );\n             }",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/94579c7213862afa194a7aec78b1a92070e7bbf8/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/DirectedEdgeMeta.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "e7143bc124fd9c4a23a65d7f93c935c21f05f949",
                "blob_url": "https://github.com/apache/usergrid/blob/94579c7213862afa194a7aec78b1a92070e7bbf8/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/DirectedEdgeMeta.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/DirectedEdgeMeta.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/DirectedEdgeMeta.java?ref=94579c7213862afa194a7aec78b1a92070e7bbf8"
            },
            {
                "patch": "@@ -358,6 +358,11 @@ public void onFailure( final Throwable t ) {\n             Thread.sleep( 2000 );\n         }\n \n+\n+        //now continue reading everything for 30 seconds\n+\n+        Thread.sleep(30000);\n+\n         executor.shutdownNow();\n     }\n ",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/94579c7213862afa194a7aec78b1a92070e7bbf8/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerShardConsistencyIT.java",
                "status": "modified",
                "changes": 5,
                "deletions": 0,
                "sha": "a9f9cb759e7f21fe83ff368a5477652d00e70d33",
                "blob_url": "https://github.com/apache/usergrid/blob/94579c7213862afa194a7aec78b1a92070e7bbf8/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerShardConsistencyIT.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerShardConsistencyIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerShardConsistencyIT.java?ref=94579c7213862afa194a7aec78b1a92070e7bbf8"
            }
        ],
        "bug_id": "usergrid_12",
        "parent": "https://github.com/apache/usergrid/commit/591a2f1fd97b7259cf72d10855f2832b8342b5a4",
        "message": "Fixes NPE issue.\n\nAdds additional validation time",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/52335673b3f9b1dd63300654785a28c9278d22ea",
        "file": [
            {
                "patch": "@@ -178,6 +178,8 @@ private void migrateAppInfo( org.apache.usergrid.persistence.model.entity.Entity\n \n         final String name = ( String ) oldAppInfoMap.get( PROPERTY_NAME );\n \n+        logger.info( \"Attempting to migrate app {}\", name );\n+\n         try {\n             final String orgName = name.split( \"/\" )[0];\n             final String appName = name.split( \"/\" )[1];\n@@ -190,6 +192,15 @@ private void migrateAppInfo( org.apache.usergrid.persistence.model.entity.Entity\n             //avoid management org\n \n             EntityRef orgRef = managementEm.getAlias( Group.ENTITY_TYPE, orgName );\n+\n+            /**\n+             * No op, we couldn't find the org, so we can't roll the app forward\n+             */\n+            if(orgRef == null){\n+                logger.error( \"Unable to retrieve ref for org {}.  Not migrating app {}\", orgName, appName );\n+                return;\n+            }\n+\n             // create and connect new APPLICATION_INFO oldAppInfo to Organization\n             managementService.createApplication( orgRef.getUuid(), name, applicationId, null );\n ",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/52335673b3f9b1dd63300654785a28c9278d22ea/stack/services/src/main/java/org/apache/usergrid/management/AppInfoMigrationPlugin.java",
                "status": "modified",
                "changes": 11,
                "deletions": 0,
                "sha": "b78b64637b2fcd6ef0f63a08c281d1268dd3555f",
                "blob_url": "https://github.com/apache/usergrid/blob/52335673b3f9b1dd63300654785a28c9278d22ea/stack/services/src/main/java/org/apache/usergrid/management/AppInfoMigrationPlugin.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/management/AppInfoMigrationPlugin.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/management/AppInfoMigrationPlugin.java?ref=52335673b3f9b1dd63300654785a28c9278d22ea"
            }
        ],
        "bug_id": "usergrid_13",
        "parent": "https://github.com/apache/usergrid/commit/0b243c4d516e0f6ae58421c63787421b8b806052",
        "message": "Fixes NPE from missing org during testing",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/5fdce93b72481ec55d491150d52b1f5feed4fade",
        "file": [
            {
                "patch": "@@ -79,16 +79,12 @@ public UsersService() {\n \n     @Override\n     public ServiceResults getItemByName( ServiceContext context, String name ) throws Exception {\n-        String nameProperty = Schema.getDefaultSchema().aliasProperty( getEntityType() );\n-\n-        if ( nameProperty == null ) {\n-            nameProperty = \"name\";\n-        }\n-\n+        \n         EntityRef entity = null;\n         Identifier id = Identifier.from( name );\n \n         if ( id != null ) {\n+            // get the entityRef from the unique value index\n             entity = em.getUserByIdentifier( id );\n         }\n \n@@ -97,7 +93,14 @@ public ServiceResults getItemByName( ServiceContext context, String name ) throw\n         }\n \n         if ( !context.moreParameters() ) {\n+\n+            // full load the entity from the database based on the UUID from the unique value index\n             entity = em.get( entity );\n+\n+            if ( entity == null ) {\n+                throw new ServiceResourceNotFoundException( context );\n+            }\n+\n             entity = importEntity( context, ( Entity ) entity );\n         }\n ",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/5fdce93b72481ec55d491150d52b1f5feed4fade/stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java",
                "status": "modified",
                "changes": 15,
                "deletions": 6,
                "sha": "734174328113125cf4201dcc44f910e6999711ac",
                "blob_url": "https://github.com/apache/usergrid/blob/5fdce93b72481ec55d491150d52b1f5feed4fade/stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java?ref=5fdce93b72481ec55d491150d52b1f5feed4fade"
            }
        ],
        "bug_id": "usergrid_14",
        "parent": "https://github.com/apache/usergrid/commit/ef51f3d7b15be1000dc03e614afba57d46f17fe0",
        "message": "Fix NPE when user doesn't exist after lookup from the unique value index.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/ad4a33713e8280a4d3637bf1395937bd32aa5fca",
        "file": [
            {
                "patch": "@@ -22,6 +22,8 @@\n package org.apache.usergrid.persistence.core.datastax;\n \n \n+import com.google.common.base.Preconditions;\n+\n import java.util.Collection;\n import java.util.HashMap;\n import java.util.Map;\n@@ -65,6 +67,12 @@ public TableDefinition( final String tableName, final Collection<String> primary\n                             final Map<String, String> columns, final CacheOption cacheOption,\n                             final Map<String, String> clusteringOrder){\n \n+        Preconditions.checkNotNull(tableName, \"Table name cannot be null\");\n+        Preconditions.checkNotNull(primaryKeys, \"Primary Key(s) cannot be null\");\n+        Preconditions.checkNotNull(columns, \"Columns cannot be null\");\n+        Preconditions.checkNotNull(cacheOption, \"CacheOption cannot be null\");\n+\n+\n         this.tableName = tableName;\n         this.primaryKeys = primaryKeys;\n         this.columns = columns;",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/ad4a33713e8280a4d3637bf1395937bd32aa5fca/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/datastax/TableDefinition.java",
                "status": "modified",
                "changes": 8,
                "deletions": 0,
                "sha": "801eaa710b0234ebe57dd742a2ceb562b9e001ee",
                "blob_url": "https://github.com/apache/usergrid/blob/ad4a33713e8280a4d3637bf1395937bd32aa5fca/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/datastax/TableDefinition.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/datastax/TableDefinition.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/datastax/TableDefinition.java?ref=ad4a33713e8280a4d3637bf1395937bd32aa5fca"
            },
            {
                "patch": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.usergrid.persistence.core.datastax;\n+\n+\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class TableDefinitionTest {\n+\n+    @Test\n+    public void testNullTableName(){\n+\n+        try{\n+            TableDefinition table1 = new TableDefinition(null, null, null, null, null);\n+        } catch (NullPointerException npe){\n+            assertEquals(\"Table name cannot be null\", npe.getMessage());\n+        }\n+\n+\n+    }\n+\n+    @Test\n+    public void testNullPrimaryKeys(){\n+\n+        try{\n+            TableDefinition table1 = new TableDefinition(\"table1\", null, null, null, null);\n+        } catch (NullPointerException npe){\n+            assertEquals(\"Primary Key(s) cannot be null\", npe.getMessage());\n+        }\n+\n+\n+    }\n+\n+    @Test\n+    public void testNullColumns(){\n+\n+        try{\n+            TableDefinition table1 = new TableDefinition(\"table1\",\n+                new ArrayList<>(), null, null, null);\n+        } catch (NullPointerException npe){\n+            assertEquals(\"Columns cannot be null\", npe.getMessage());\n+        }\n+\n+\n+    }\n+\n+    @Test\n+    public void testNullCacheOption(){\n+\n+        try{\n+            TableDefinition table1 = new TableDefinition(\"table1\",\n+                new ArrayList<>(),\n+                new HashMap<>(), null, null);\n+        } catch (NullPointerException npe){\n+            assertEquals(\"CacheOption cannot be null\", npe.getMessage());\n+        }\n+\n+\n+    }\n+}",
                "additions": 81,
                "raw_url": "https://github.com/apache/usergrid/raw/ad4a33713e8280a4d3637bf1395937bd32aa5fca/stack/corepersistence/common/src/test/java/org/apache/usergrid/persistence/core/datastax/TableDefinitionTest.java",
                "status": "added",
                "changes": 81,
                "deletions": 0,
                "sha": "792864bdd01462e65f8b451b284cb58cb3d43a1e",
                "blob_url": "https://github.com/apache/usergrid/blob/ad4a33713e8280a4d3637bf1395937bd32aa5fca/stack/corepersistence/common/src/test/java/org/apache/usergrid/persistence/core/datastax/TableDefinitionTest.java",
                "filename": "stack/corepersistence/common/src/test/java/org/apache/usergrid/persistence/core/datastax/TableDefinitionTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/test/java/org/apache/usergrid/persistence/core/datastax/TableDefinitionTest.java?ref=ad4a33713e8280a4d3637bf1395937bd32aa5fca"
            }
        ],
        "bug_id": "usergrid_15",
        "parent": "https://github.com/apache/usergrid/commit/a62fb0a0c95ece13c84a563e58802230bdcff1cb",
        "message": "Add null checks and tests confirming NPEs are thrown.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/04530d9109e2195b42838fc6fe5f0cf3c7107a4d",
        "file": [
            {
                "patch": "@@ -1241,10 +1241,20 @@ public DynamicEntity loadPartialEntity(UUID entityId,\n \t\t\t\tMap<String, Object> properties = deserializeEntityProperties(results\n \t\t\t\t\t\t.getByKey(key));\n \n+\t\t\t\tif (properties == null) {\n+\t\t\t\t\tlogger.error(\"Error deserializing entity with key \"\n+\t\t\t\t\t\t\t+ key\n+\t\t\t\t\t\t\t+ \", entity probaby doesn't exist, where did this key come from?\");\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\n \t\t\t\tUUID id = uuid(properties.get(PROPERTY_UUID));\n \t\t\t\tString type = string(properties.get(PROPERTY_TYPE));\n \n \t\t\t\tif ((id == null) || (type == null)) {\n+\t\t\t\t\tlogger.error(\"Error retrieving entity with key \"\n+\t\t\t\t\t\t\t+ key\n+\t\t\t\t\t\t\t+ \", no type or id deseriazable, where did this key come from?\");\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n \t\t\t\tA entity = EntityFactory.newEntity(id, type, entityClass);\n@@ -1255,7 +1265,9 @@ public DynamicEntity loadPartialEntity(UUID entityId,\n \n \t\t\tfor (UUID entityId : entityIds) {\n \t\t\t\tA entity = resultSet.get(entityId);\n-\t\t\t\tentities.add(entity);\n+\t\t\t\tif (entity != null) {\n+\t\t\t\t\tentities.add(entity);\n+\t\t\t\t}\n \t\t\t}\n \n \t\t}",
                "additions": 13,
                "raw_url": "https://github.com/apache/usergrid/raw/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "status": "modified",
                "changes": 14,
                "deletions": 1,
                "sha": "58aae5a360edfcf5fa4d9cfd14a4e9bd5ead3902",
                "blob_url": "https://github.com/apache/usergrid/blob/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java?ref=04530d9109e2195b42838fc6fe5f0cf3c7107a4d"
            },
            {
                "patch": "@@ -45,7 +45,7 @@\n \t@EntityProperty(indexed = false, mutable = false)\n \tprotected String destination;\n \n-\t@EntityProperty(indexed = false, mutable = false)\n+\t@EntityProperty(name = \"reply_to\", indexed = false, mutable = false)\n \tprotected String replyTo;\n \n \t@EntityProperty(fulltextIndexed = false, required = true, mutable = false)",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/core/src/main/java/org/usergrid/persistence/entities/Message.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "1f59328e83b9fa0829d2531397b65619d0ed1c29",
                "blob_url": "https://github.com/apache/usergrid/blob/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/core/src/main/java/org/usergrid/persistence/entities/Message.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/entities/Message.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/entities/Message.java?ref=04530d9109e2195b42838fc6fe5f0cf3c7107a4d"
            },
            {
                "patch": "@@ -16,7 +16,35 @@\n     <packaging>jar</packaging>\n     <name>${bundle.symbolicName} [${bundle.namespace}]</name>\n     <description>Counter batching service for Usergrid distributed counter architechture</description>\n-\n+\t<build>\n+\t\t<plugins>\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-surefire-plugin</artifactId>\n+\t\t\t\t<version>2.6</version>\n+\t\t\t\t<configuration>\n+\t\t\t\t\t<!-- <groups>fast,${groups}</groups> -->\n+\t\t\t\t\t<systemPropertyVariables>\n+\t\t\t\t\t\t<storage-config>${basedir}/src/test/conf</storage-config>\n+\t\t\t\t\t</systemPropertyVariables>\n+\t\t\t\t\t<forkMode>always</forkMode>\n+\t\t\t\t</configuration>\n+\t\t\t</plugin>\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-compiler-plugin</artifactId>\n+\t\t\t\t<version>2.3.2</version>\n+\t\t\t\t<configuration>\n+\t\t\t\t\t<source>1.6</source>\n+\t\t\t\t\t<target>1.6</target>\n+\t\t\t\t\t<optimize>true</optimize>\n+\t\t\t\t\t<debug>true</debug>\n+\t\t\t\t\t<showDeprecation>true</showDeprecation>\n+\t\t\t\t\t<showWarnings>true</showWarnings>\n+\t\t\t\t</configuration>\n+\t\t\t</plugin>\n+\t\t</plugins>\n+\t</build>\n     <dependencies>\n         <dependency>\n             <groupId>junit</groupId>",
                "additions": 29,
                "raw_url": "https://github.com/apache/usergrid/raw/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/count-batcher/pom.xml",
                "status": "modified",
                "changes": 30,
                "deletions": 1,
                "sha": "c420bce6bf9fd2e15469da13f0c0ed44d185a607",
                "blob_url": "https://github.com/apache/usergrid/blob/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/count-batcher/pom.xml",
                "filename": "stack/count-batcher/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/count-batcher/pom.xml?ref=04530d9109e2195b42838fc6fe5f0cf3c7107a4d"
            },
            {
                "patch": "@@ -190,6 +190,21 @@\n \t\t\t<artifactId>usergrid-config</artifactId>\n \t\t\t<version>${project.version}</version>\n \t\t</dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-common</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-inserter</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-batcher</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n \t\t<dependency>\n \t\t\t<groupId>org.usergrid</groupId>\n \t\t\t<artifactId>usergrid-core</artifactId>",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/rest/pom.xml",
                "status": "modified",
                "changes": 15,
                "deletions": 0,
                "sha": "ed6fc59ce54b5da24a3ac9eca2bae7443e092957",
                "blob_url": "https://github.com/apache/usergrid/blob/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/rest/pom.xml",
                "filename": "stack/rest/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/pom.xml?ref=04530d9109e2195b42838fc6fe5f0cf3c7107a4d"
            },
            {
                "patch": "@@ -148,6 +148,21 @@\n \t\t\t<artifactId>usergrid-config</artifactId>\n \t\t\t<version>${project.version}</version>\n \t\t</dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-common</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-inserter</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-batcher</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n \t\t<dependency>\n \t\t\t<groupId>org.usergrid</groupId>\n \t\t\t<artifactId>usergrid-core</artifactId>",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/standalone/pom.xml",
                "status": "modified",
                "changes": 15,
                "deletions": 0,
                "sha": "126d0a13ad1c5d6fa516f6df1e0255cd0b9f24f9",
                "blob_url": "https://github.com/apache/usergrid/blob/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/standalone/pom.xml",
                "filename": "stack/standalone/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/standalone/pom.xml?ref=04530d9109e2195b42838fc6fe5f0cf3c7107a4d"
            },
            {
                "patch": "@@ -102,39 +102,37 @@\n \t\t<constructor-arg ref=\"cassandraHostConfigurator\" />\n \t\t<constructor-arg ref=\"lockManager\" />\n \t</bean>\n-    <bean id=\"entityManagerFactory\"\n-    \t\tclass=\"org.usergrid.persistence.cassandra.EntityManagerFactoryImpl\">\n-    \t\t<constructor-arg ref=\"cassandraService\" />\n-            <constructor-arg ref=\"counterUtils\"/>\n-    \t</bean>\n-\n-    \t<bean id=\"queueManagerFactory\"\n-    \t\tclass=\"org.usergrid.mq.cassandra.QueueManagerFactoryImpl\">\n-    \t\t<constructor-arg ref=\"cassandraService\" />\n-            <constructor-arg ref=\"counterUtils\"/>\n-    \t</bean>\n-\n-        <bean id=\"simpleBatcher\" class=\"com.usergrid.count.SimpleBatcher\">\n-            <constructor-arg value=\"3\"/>\n-            <property name=\"batchSubmitter\" ref=\"batchSubmitter\"/>\n-        </bean>\n-\n-        <bean id=\"batchSubmitter\" class=\"com.usergrid.count.CassandraSubmitter\">\n-            <constructor-arg ref=\"cassandraCounterStore\"/>\n-        </bean>\n-\n-        <bean id=\"cassandraCounterStore\" class=\"com.usergrid.count.CassandraCounterStore\">\n-            <constructor-arg>\n-                <bean id=\"keyspace\"\n-                      factory-bean=\"cassandraService\"\n-                      factory-method=\"getUsergridApplicationKeyspace\"/>\n-            </constructor-arg>\n-        </bean>\n-\n-        <bean id=\"counterUtils\" class=\"org.usergrid.persistence.cassandra.CounterUtils\">\n-            <property name=\"batcher\" ref=\"simpleBatcher\"/>\n-            <property name=\"counterType\" value=\"n\"/> <!-- use new couter architecture. p: parallel, o: old -->\n-        </bean>\n+\t<bean id=\"entityManagerFactory\"\n+\t\tclass=\"org.usergrid.persistence.cassandra.EntityManagerFactoryImpl\">\n+\t\t<constructor-arg ref=\"cassandraService\" />\n+\t\t<constructor-arg ref=\"counterUtils\" />\n+\t</bean>\n+\n+\t<bean id=\"queueManagerFactory\" class=\"org.usergrid.mq.cassandra.QueueManagerFactoryImpl\">\n+\t\t<constructor-arg ref=\"cassandraService\" />\n+\t\t<constructor-arg ref=\"counterUtils\" />\n+\t</bean>\n+\n+\t<bean id=\"simpleBatcher\" class=\"com.usergrid.count.SimpleBatcher\">\n+\t\t<constructor-arg value=\"3\" />\n+\t\t<property name=\"batchSubmitter\" ref=\"batchSubmitter\" />\n+\t</bean>\n+\n+\t<bean id=\"batchSubmitter\" class=\"com.usergrid.count.CassandraSubmitter\">\n+\t\t<constructor-arg ref=\"cassandraCounterStore\" />\n+\t</bean>\n+\n+\t<bean id=\"cassandraCounterStore\" class=\"com.usergrid.count.CassandraCounterStore\">\n+\t\t<constructor-arg>\n+\t\t\t<bean id=\"keyspace\" factory-bean=\"cassandraService\"\n+\t\t\t\tfactory-method=\"getUsergridApplicationKeyspace\" />\n+\t\t</constructor-arg>\n+\t</bean>\n+\n+\t<bean id=\"counterUtils\" class=\"org.usergrid.persistence.cassandra.CounterUtils\">\n+\t\t<property name=\"batcher\" ref=\"simpleBatcher\" />\n+\t\t<property name=\"counterType\" value=\"n\" /> <!-- use new couter architecture. p: parallel, o: old -->\n+\t</bean>\n \n \t<bean id=\"serviceManagerFactory\" class=\"org.usergrid.services.ServiceManagerFactory\">\n \t\t<constructor-arg>",
                "additions": 31,
                "raw_url": "https://github.com/apache/usergrid/raw/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/standalone/src/main/resources/standaloneApplicationContext.xml",
                "status": "modified",
                "changes": 64,
                "deletions": 33,
                "sha": "5e79bdeb213daf58b0a4509143b8219a58dc1e41",
                "blob_url": "https://github.com/apache/usergrid/blob/04530d9109e2195b42838fc6fe5f0cf3c7107a4d/stack/standalone/src/main/resources/standaloneApplicationContext.xml",
                "filename": "stack/standalone/src/main/resources/standaloneApplicationContext.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/standalone/src/main/resources/standaloneApplicationContext.xml?ref=04530d9109e2195b42838fc6fe5f0cf3c7107a4d"
            }
        ],
        "bug_id": "usergrid_16",
        "parent": "https://github.com/apache/usergrid/commit/9a152ae1c13205edad25b6c0abe57cd0debd0dd4",
        "message": "Merge pull request #44 from apigee/missing-entity-npe\n\nfix for missing entity npe plus other stuff",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/6306e2b99f4d02bcd4283f9d0e391c461048f705",
        "file": [
            {
                "patch": "@@ -2231,16 +2231,21 @@ public Entity get( UUID uuid ) throws Exception {\n \n         final Entity entity;\n \n-      //this is the fall back, why isn't this writt\n+        //this is the fall back, why isn't this writt\n         if ( entityType == null ) {\n \n+            //TODO, not sure we want this here any longer.  With 404's we'll hit elastic search every time\n             Query q = Query.fromQL(\n                 \"select * where \" + PROPERTY_UUID + \" = '\" + uuid.toString() + \"'\");\n             q.setResultsLevel( Level.ALL_PROPERTIES );\n             Results r = getRelationManager( getApplication() ).searchConnectedEntities( q );\n             entity = r.getEntity();\n \n-            mm.putString(uuid.toString(), entity.getType() );\n+\n+            //no gaurentee it even exists, ignore this\n+            if(entity != null) {\n+                mm.putString( uuid.toString(), entity.getType() );\n+            }\n         \n         } else { \n             entity = get(new SimpleEntityRef( entityType, uuid ));",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/6306e2b99f4d02bcd4283f9d0e391c461048f705/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "status": "modified",
                "changes": 9,
                "deletions": 2,
                "sha": "87536704227b6cb80e85ab0d3d616b437d66f49e",
                "blob_url": "https://github.com/apache/usergrid/blob/6306e2b99f4d02bcd4283f9d0e391c461048f705/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java?ref=6306e2b99f4d02bcd4283f9d0e391c461048f705"
            }
        ],
        "bug_id": "usergrid_17",
        "parent": "https://github.com/apache/usergrid/commit/43fec66623fcf515ee3221dc45f282ad9c333bc3",
        "message": "Fixes type lookup NPE bug",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/6a790a8ef44a0d64eb4833b1cecb10b68032f8b4",
        "file": [
            {
                "patch": "@@ -799,12 +799,7 @@ public boolean isExternalSSOProviderEnabled() {\n     }\n \n     private String getExternalSSOProvider(){\n-        try {\n             return properties.getProperty(USERGRID_EXTERNAL_PROVIDER);\n-        }\n-        catch(NullPointerException e ){\n-            throw new IllegalArgumentException(\"External SSO provider is enabled but the provider name is empty\");\n-        }\n     }\n \n     /**",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/6a790a8ef44a0d64eb4833b1cecb10b68032f8b4/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "status": "modified",
                "changes": 5,
                "deletions": 5,
                "sha": "62d454ab8ebe52563c566ac484dda9fa4a3452f1",
                "blob_url": "https://github.com/apache/usergrid/blob/6a790a8ef44a0d64eb4833b1cecb10b68032f8b4/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java?ref=6a790a8ef44a0d64eb4833b1cecb10b68032f8b4"
            }
        ],
        "bug_id": "usergrid_18",
        "parent": "https://github.com/apache/usergrid/commit/897d373e1e7916802177f09993712dab65f91bcc",
        "message": "removed unnecessary NPE check.. adding it in the methods call it.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/3f762ece4bcd0eaa8acbb0f8fb2114becbfbf332",
        "file": [
            {
                "patch": "@@ -290,7 +290,7 @@ public void setEncryptionService( EncryptionService encryptionService ) {\n     @Override\n     public void setup() throws Exception {\n \n-        if ( parseBoolean( properties.getProperty( PROPERTIES_SETUP_TEST_ACCOUNT ) ) ) {\n+        if ( getBooleanProperty( PROPERTIES_SETUP_TEST_ACCOUNT ) ) {\n             String test_app_name = properties.getProperty( PROPERTIES_TEST_ACCOUNT_APP );\n             String test_organization_name = properties.getProperty( PROPERTIES_TEST_ACCOUNT_ORGANIZATION );\n             String test_admin_username = properties.getProperty( PROPERTIES_TEST_ACCOUNT_ADMIN_USER_USERNAME );\n@@ -328,7 +328,7 @@ public void setup() throws Exception {\n \n \n     public boolean superuserEnabled() {\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n+        boolean superuser_enabled = getBooleanProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED );\n         String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n         String superuser_email = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL );\n         String superuser_password = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_PASSWORD );\n@@ -339,7 +339,7 @@ public boolean superuserEnabled() {\n \n     @Override\n     public void provisionSuperuser() throws Exception {\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n+        boolean superuser_enabled = getBooleanProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED );\n         String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n         String superuser_email = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL );\n         String superuser_password = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_PASSWORD );\n@@ -1247,13 +1247,11 @@ public UserInfo verifyAdminUserPasswordCredentials( String name, String password\n             userInfo = getUserInfo( MANAGEMENT_APPLICATION_ID, user );\n \n             boolean userIsSuperAdmin =\n-                    properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL ).equals( userInfo.getEmail() );\n-\n-            boolean testUserEnabled = parseBoolean( properties.getProperty( PROPERTIES_SETUP_TEST_ACCOUNT ) );\n+                    StringUtils.equals( getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL ), userInfo.getEmail() );\n+            boolean testUserEnabled = getBooleanProperty( PROPERTIES_SETUP_TEST_ACCOUNT );\n \n             boolean userIsTestUser = !testUserEnabled ? false :\n-                                     properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL )\n-                                               .equals( userInfo.getEmail() );\n+                    StringUtils.equals(getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL ), userInfo.getEmail());\n \n             if ( !userIsSuperAdmin && !userIsTestUser ) {\n \n@@ -1489,7 +1487,7 @@ public Long getLastAdminPasswordChange( UUID userId ) throws Exception {\n \n         Map<UUID, String> organizations;\n \n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n+        boolean superuser_enabled = getBooleanProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED );\n         String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n         if ( superuser_enabled && ( superuser_username != null ) && superuser_username.equals( user.getUsername() ) ) {\n             organizations = buildOrgBiMap( getOrganizations( null, 10 ) );\n@@ -2906,4 +2904,20 @@ public Object registerAppWithAPM( OrganizationInfo orgInfo, ApplicationInfo appI\n         // TODO Auto-generated method stub\n         return null;\n     }\n+\n+    private String getProperty(String key) {\n+        String obj = properties.getProperty(key);\n+        if(StringUtils.isEmpty(obj))\n+            return null;\n+        else\n+            return obj;\n+    }\n+\n+    private boolean getBooleanProperty(String key) {\n+        String obj = getProperty(key);\n+        if(StringUtils.isEmpty(obj))\n+            return false;\n+        else\n+            return Boolean.parseBoolean(obj);\n+    }\n }",
                "additions": 23,
                "raw_url": "https://github.com/apache/usergrid/raw/3f762ece4bcd0eaa8acbb0f8fb2114becbfbf332/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "status": "modified",
                "changes": 32,
                "deletions": 9,
                "sha": "82575147bd05bd36d90ef966906276b2f6c42777",
                "blob_url": "https://github.com/apache/usergrid/blob/3f762ece4bcd0eaa8acbb0f8fb2114becbfbf332/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java?ref=3f762ece4bcd0eaa8acbb0f8fb2114becbfbf332"
            }
        ],
        "bug_id": "usergrid_19",
        "parent": "https://github.com/apache/usergrid/commit/1140631c12c6b10e92b53f9d5d91b8db5a2fa5ff",
        "message": "Avoid NPE in ManagementServiceImpl",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/7ff36ddcb8352fa00d60e66167bbab71b75bdbec",
        "file": [
            {
                "patch": "@@ -313,8 +313,10 @@ public ServiceResults getApplicationCounterNames() throws Exception {\n \n \tpublic ServiceResults getApplicationCounters(Query query) throws Exception {\n \t\tResults counters = em.getAggregateCounters(query);\n-\t\tServiceResults results = simpleServiceResults(Type.COUNTERS)\n-\t\t\t\t.withCounters(counters.getCounters());\n+\t\tServiceResults results = simpleServiceResults(Type.COUNTERS);\n+\t\tif (counters != null) {\n+\t\t\tresults.withCounters(counters.getCounters());\n+\t\t}\n \t\treturn results;\n \t}\n ",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/7ff36ddcb8352fa00d60e66167bbab71b75bdbec/stack/services/src/main/java/org/usergrid/services/applications/ApplicationsService.java",
                "status": "modified",
                "changes": 6,
                "deletions": 2,
                "sha": "b9a1bdde85056c4983318e0d1c7d6c3ed4ef3084",
                "blob_url": "https://github.com/apache/usergrid/blob/7ff36ddcb8352fa00d60e66167bbab71b75bdbec/stack/services/src/main/java/org/usergrid/services/applications/ApplicationsService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/applications/ApplicationsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/applications/ApplicationsService.java?ref=7ff36ddcb8352fa00d60e66167bbab71b75bdbec"
            }
        ],
        "bug_id": "usergrid_20",
        "parent": "https://github.com/apache/usergrid/commit/c05f927f3b2ef033fa6a6c55c97fa988d9f65189",
        "message": "fix npe",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9",
        "file": [
            {
                "patch": "@@ -41,11 +41,12 @@ public void setSampleAppName(String sampleAppName) {\n     @Override\n     public ApplicationInfo createSampleFor(OrganizationInfo organizationInfo)\n             throws ApplicationCreationException {\n-        logger.info(\"create sample app {} in: {}\", sampleAppName, organizationInfo.getName());\n+\n         Preconditions.checkArgument(organizationInfo != null,\n                 \"OrganizationInfo was null\");\n         Preconditions.checkArgument(organizationInfo.getUuid() != null,\n                 \"OrganizationInfo had no UUID\");\n+\t\tlogger.info(\"create sample app {} in: {}\", sampleAppName, organizationInfo.getName());\n         UUID appId = null;\n         try {\n             appId = managementService.createApplication(",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9/stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java",
                "status": "modified",
                "changes": 3,
                "deletions": 1,
                "sha": "5ac34189dac688cf207d50b361a69665e51ea771",
                "blob_url": "https://github.com/apache/usergrid/blob/3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9/stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/ApplicationCreatorImpl.java?ref=3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9"
            },
            {
                "patch": "@@ -39,7 +39,7 @@\n \tprivate static final Logger logger = LoggerFactory\n \t\t\t.getLogger(DevicesService.class);\n \n-\tprivate static LRUMap deviceCache = new LRUMap(DEVICE_CACHE_COUNT);\n+\tprivate static final LRUMap deviceCache = new LRUMap(DEVICE_CACHE_COUNT);\n \n \tpublic DevicesService() {\n \t\tsuper();",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9/stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "8514dbe96f3bdbf9a5222a69e2cd352d6fb14e16",
                "blob_url": "https://github.com/apache/usergrid/blob/3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9/stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/devices/DevicesService.java?ref=3c0ba6ea17bf9d7809f1be9c1d7a90bc2d1401d9"
            }
        ],
        "bug_id": "usergrid_21",
        "parent": "https://github.com/apache/usergrid/commit/19a6c701e76153f0919d593ec2cb6e5114b6f898",
        "message": "May produce NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/19c63fc92d980094ac17aceef581ab78ce573f3d",
        "file": [
            {
                "patch": "@@ -65,6 +65,9 @@ public static String capitalizeDelimiter(String str, char... delims) {\n \t * @return\n \t */\n \tpublic static String capitalizeUnderscore(String str) {\n+\t\tif (str == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\treturn capitalizeDelimiter(str, '_');\n \t}\n \n@@ -80,6 +83,9 @@ public static Object lower(Object obj) {\n \t}\n \n \tpublic static String stringOrSubstringAfterLast(String str, char c) {\n+\t\tif (str == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\tint i = str.lastIndexOf(c);\n \t\tif (i != -1) {\n \t\t\treturn str.substring(i + 1);\n@@ -88,6 +94,9 @@ public static String stringOrSubstringAfterLast(String str, char c) {\n \t}\n \n \tpublic static String stringOrSubstringBeforeLast(String str, char c) {\n+\t\tif (str == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\tint i = str.lastIndexOf(c);\n \t\tif (i != -1) {\n \t\t\treturn str.substring(0, i);\n@@ -96,6 +105,9 @@ public static String stringOrSubstringBeforeLast(String str, char c) {\n \t}\n \n \tpublic static String stringOrSubstringBeforeFirst(String str, char c) {\n+\t\tif (str == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\tint i = str.indexOf(c);\n \t\tif (i != -1) {\n \t\t\treturn str.substring(0, i);\n@@ -104,6 +116,9 @@ public static String stringOrSubstringBeforeFirst(String str, char c) {\n \t}\n \n \tpublic static String stringOrSubstringAfterFirst(String str, char c) {\n+\t\tif (str == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\tint i = str.indexOf(c);\n \t\tif (i != -1) {\n \t\t\treturn str.substring(i + 1);\n@@ -112,6 +127,9 @@ public static String stringOrSubstringAfterFirst(String str, char c) {\n \t}\n \n \tpublic static String compactWhitespace(String str) {\n+\t\tif (str == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\tboolean prev_ws = false;\n \t\tStringBuilder builder = new StringBuilder();\n \t\tfor (int i = 0; i < str.length(); i++) {\n@@ -136,6 +154,9 @@ public static String compactWhitespace(String str) {\n \t * @return new string with replace applied\n \t */\n \tpublic static String replaceAll(String source, String find, String replace) {\n+\t\tif (source == null) {\n+\t\t\treturn null;\n+\t\t}\n \t\twhile (true) {\n \t\t\tString old = source;\n \t\t\tsource = source.replaceAll(find, replace);",
                "additions": 21,
                "raw_url": "https://github.com/apache/usergrid/raw/19c63fc92d980094ac17aceef581ab78ce573f3d/stack/core/src/main/java/org/usergrid/utils/StringUtils.java",
                "status": "modified",
                "changes": 21,
                "deletions": 0,
                "sha": "0f4028f0b60c4438a529d5df0e7215a3fca500f4",
                "blob_url": "https://github.com/apache/usergrid/blob/19c63fc92d980094ac17aceef581ab78ce573f3d/stack/core/src/main/java/org/usergrid/utils/StringUtils.java",
                "filename": "stack/core/src/main/java/org/usergrid/utils/StringUtils.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/utils/StringUtils.java?ref=19c63fc92d980094ac17aceef581ab78ce573f3d"
            }
        ],
        "bug_id": "usergrid_22",
        "parent": "https://github.com/apache/usergrid/commit/90c6692259f8b4f520b05821801d5efddc685e07",
        "message": "fix NPE in stringutils",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/326e414acc7d382f73e952b5d59fc8ce18e94c54",
        "file": [
            {
                "patch": "@@ -364,7 +364,7 @@ public ServiceResults postItemById(ServiceContext context, UUID id)\n \n \t\tEntity entity = em.get(id);\n \t\tif (entity == null) {\n-\t\t\treturn null;\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tentity = importEntity(context, entity);\n \n@@ -402,6 +402,9 @@ public ServiceResults deleteItemById(ServiceContext context, UUID id)\n \t\t}\n \n \t\tEntity item = em.get(id);\n+\t\tif (item == null) {\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n+\t\t}\n \t\titem = importEntity(context, item);\n \n \t\tem.removeFromCollection(context.getOwner(),\n@@ -425,6 +428,9 @@ public ServiceResults deleteItemByName(ServiceContext context, String name)\n \t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tEntity entity = em.get(ref);\n+\t\tif (entity == null) {\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n+\t\t}\n \t\tentity = importEntity(context, entity);\n \n \t\tcheckPermissionsForEntity(context, entity);",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/326e414acc7d382f73e952b5d59fc8ce18e94c54/stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java",
                "status": "modified",
                "changes": 8,
                "deletions": 1,
                "sha": "64701d7234cdf32073ca251444602fac17ea5441",
                "blob_url": "https://github.com/apache/usergrid/blob/326e414acc7d382f73e952b5d59fc8ce18e94c54/stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java?ref=326e414acc7d382f73e952b5d59fc8ce18e94c54"
            },
            {
                "patch": "@@ -295,7 +295,7 @@ public ServiceResults postItemById(ServiceContext context, UUID id)\n \n \t\tEntity entity = em.get(id);\n \t\tif (entity == null) {\n-\t\t\treturn null;\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tentity = importEntity(context, entity);\n \n@@ -331,11 +331,11 @@ public ServiceResults postItemsByQuery(ServiceContext context, Query query)\n \n \t\t\tEntityRef ref = em.getAlias(query.getEntityType(), name);\n \t\t\tif (ref == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tEntity entity = em.get(ref);\n \t\t\tif (entity == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tentity = importEntity(context, entity);\n \n@@ -362,7 +362,7 @@ public ServiceResults deleteItemById(ServiceContext context, UUID id)\n \n \t\tEntity entity = em.get(id);\n \t\tif (entity == null) {\n-\t\t\treturn null;\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tentity = importEntity(context, entity);\n \n@@ -392,11 +392,11 @@ public ServiceResults deleteItemsByQuery(ServiceContext context, Query query)\n \n \t\t\tEntityRef ref = em.getAlias(query.getEntityType(), name);\n \t\t\tif (ref == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tEntity entity = em.get(ref);\n \t\t\tif (entity == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tentity = importEntity(context, entity);\n ",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/326e414acc7d382f73e952b5d59fc8ce18e94c54/stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java",
                "status": "modified",
                "changes": 12,
                "deletions": 6,
                "sha": "2542fc22fe0be2c58bdfd7f369923dfba7a39b65",
                "blob_url": "https://github.com/apache/usergrid/blob/326e414acc7d382f73e952b5d59fc8ce18e94c54/stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java?ref=326e414acc7d382f73e952b5d59fc8ce18e94c54"
            },
            {
                "patch": "@@ -294,6 +294,10 @@ public Entity importEntity(ServiceContext context, Entity entity)\n \t@Override\n \tpublic Entity importEntity(ServiceRequest request, Entity entity)\n \t\t\tthrows Exception {\n+\t\tif (entity == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n \t\tif (!isRootService()) {\n \t\t\treturn sm.importEntity(request, entity);\n \t\t}",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/326e414acc7d382f73e952b5d59fc8ce18e94c54/stack/services/src/main/java/org/usergrid/services/AbstractService.java",
                "status": "modified",
                "changes": 4,
                "deletions": 0,
                "sha": "1879215e73885b45f41c1105adcabd99c34ec1ac",
                "blob_url": "https://github.com/apache/usergrid/blob/326e414acc7d382f73e952b5d59fc8ce18e94c54/stack/services/src/main/java/org/usergrid/services/AbstractService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/AbstractService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/AbstractService.java?ref=326e414acc7d382f73e952b5d59fc8ce18e94c54"
            }
        ],
        "bug_id": "usergrid_23",
        "parent": "https://github.com/apache/usergrid/commit/ce78e78f334dd0da507f06ba4f49c42081b4af69",
        "message": "Merge pull request #54 from apigee/fix-npe-on-entity-not-found\n\nfix npe when entity not found, throw service_resource_not_found instead",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/54735519943819e32df9aadcb81e9142f32e4cef",
        "file": [
            {
                "patch": "@@ -32,17 +32,11 @@\n     private final String prefix;\n     private final String base64Prefix;\n     private final boolean expires;\n-    private static Map<String, TokenCategory> prefixes;\n-    private static Map<String, TokenCategory> base64Prefixes;\n+    private static final Map<String, TokenCategory> prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+    private static final Map<String, TokenCategory> base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n \n \n     private synchronized static void register( TokenCategory type ) {\n-        if ( prefixes == null ) {\n-            prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-        }\n-        if ( base64Prefixes == null ) {\n-            base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-        }\n         prefixes.put( type.getPrefix(), type );\n         base64Prefixes.put( type.getBase64Prefix(), type );\n     }",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/54735519943819e32df9aadcb81e9142f32e4cef/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "status": "modified",
                "changes": 10,
                "deletions": 8,
                "sha": "4c05f5e6ca02f3138f7e4147c8733d87b3c84b44",
                "blob_url": "https://github.com/apache/usergrid/blob/54735519943819e32df9aadcb81e9142f32e4cef/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java?ref=54735519943819e32df9aadcb81e9142f32e4cef"
            },
            {
                "patch": "@@ -499,7 +499,13 @@ private ByteBuffer principalKey( AuthPrincipalInfo principalInfo ) {\n \n \n     private UUID getUUIDForToken( String token ) throws ExpiredTokenException, BadTokenException {\n+\n         TokenCategory tokenCategory = TokenCategory.getFromBase64String( token );\n+\n+        if( tokenCategory == null){\n+            return null;\n+        }\n+\n         byte[] bytes = decodeBase64( token.substring( TokenCategory.BASE64_PREFIX_LENGTH ) );\n         UUID uuid = uuid( bytes );\n         int i = 16;",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/54735519943819e32df9aadcb81e9142f32e4cef/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "status": "modified",
                "changes": 6,
                "deletions": 0,
                "sha": "b2a3d720f9dd0f83b404619f813464efd63d5f8c",
                "blob_url": "https://github.com/apache/usergrid/blob/54735519943819e32df9aadcb81e9142f32e4cef/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java?ref=54735519943819e32df9aadcb81e9142f32e4cef"
            }
        ],
        "bug_id": "usergrid_24",
        "parent": "https://github.com/apache/usergrid/commit/cbac9397be3cd1d2e4a18bd36e8b8f57035c6093",
        "message": "Missed null check may cause NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/5bb77985ba386b72d66a5584057a5d98b3f3e111",
        "file": [
            {
                "patch": "@@ -108,20 +108,13 @@ public AbstractElasticSearchFilter( final EntityIndexFactory entityIndexFactory,\n                         final CandidateResults candidateResults =\n                             applicationEntityIndex.search( searchEdge, searchTypes, query, limit, currentOffSet );\n \n-                        /**\n-                         * No candidates, we're done\n-                         */\n-                        if ( candidateResults.size() == 0 ) {\n-                            subscriber.onCompleted();\n-                            return;\n-                        }\n \n \n                         for( CandidateResult candidateResult: candidateResults){\n \n                             //our subscriber unsubscribed, break out\n                             if(subscriber.isUnsubscribed()){\n-                              return;\n+                                return;\n                             }\n \n                             final Candidate candidate = new Candidate( candidateResult, searchEdge );\n@@ -134,6 +127,13 @@ public AbstractElasticSearchFilter( final EntityIndexFactory entityIndexFactory,\n                             currentOffSet++;\n                         }\n \n+                        /**\n+                         * No candidates, we're done\n+                         */\n+                        if (candidateResults.size() < limit) {\n+                            subscriber.onCompleted();\n+                            return;\n+                        }\n \n                     }\n                     catch ( Throwable t ) {",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/5bb77985ba386b72d66a5584057a5d98b3f3e111/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java",
                "status": "modified",
                "changes": 16,
                "deletions": 8,
                "sha": "f403e21fc6beae59c349cb7a707de775b5d46637",
                "blob_url": "https://github.com/apache/usergrid/blob/5bb77985ba386b72d66a5584057a5d98b3f3e111/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java?ref=5bb77985ba386b72d66a5584057a5d98b3f3e111"
            },
            {
                "patch": "@@ -1293,7 +1293,7 @@ public void setQueryExecutor(final QueryExecutor queryExecutor){\n     /** uses cursor to get next batch of Results (returns null if no cursor) */\n     public Results getNextPageResults() throws Exception {\n         if ( queryExecutor == null || !queryExecutor.hasNext() ) {\n-            return null;\n+            return new Results();\n         }\n \n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/5bb77985ba386b72d66a5584057a5d98b3f3e111/stack/core/src/main/java/org/apache/usergrid/persistence/Results.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "fa221f5ed13645d6813696b03e75eb394566b970",
                "blob_url": "https://github.com/apache/usergrid/blob/5bb77985ba386b72d66a5584057a5d98b3f3e111/stack/core/src/main/java/org/apache/usergrid/persistence/Results.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/Results.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/Results.java?ref=5bb77985ba386b72d66a5584057a5d98b3f3e111"
            }
        ],
        "bug_id": "usergrid_25",
        "parent": "https://github.com/apache/usergrid/commit/a673c81bf7c51ce48f2b8d052fcba990931e1977",
        "message": "Updates observable short circuit and fixes NPE on empty results",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/0eda1b68315474f609421a3ad124b3423787754f",
        "file": [
            {
                "patch": "@@ -124,7 +124,13 @@ public void failed(Notifier notifier, Receipt receipt, UUID deviceUUID, Object c\n     * passed one w/ the UUID\n     */\n     private void saveReceipt(EntityRef notification, EntityRef device, Receipt receipt, boolean hasError) throws Exception {\n-        if (this.notification.getDebug() || hasError) {\n+\n+        boolean debug = false;\n+        if(this.notification != null){\n+            debug = this.notification.getDebug();\n+        }\n+\n+        if ( debug || hasError) {\n             if (receipt.getUuid() == null) {\n                 Receipt savedReceipt = em.create(receipt);\n                 receipt.setUuid(savedReceipt.getUuid());",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/0eda1b68315474f609421a3ad124b3423787754f/stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java",
                "status": "modified",
                "changes": 8,
                "deletions": 1,
                "sha": "3e78210d64026f0afc2c64f7eb85cc781ac82cce",
                "blob_url": "https://github.com/apache/usergrid/blob/0eda1b68315474f609421a3ad124b3423787754f/stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java?ref=0eda1b68315474f609421a3ad124b3423787754f"
            },
            {
                "patch": "@@ -270,7 +270,7 @@ public Observable sendBatchToProviders(final List<QueueMessage> messages, final\n                 Notification notification = notificationMap.get(message.getNotificationId());\n                 if (notification == null) {\n                     notification = em.get(message.getNotificationId(), Notification.class);\n-                    notificationMap.put(message.getNotificationId(), notification);\n+                    notificationMap.putIfAbsent(message.getNotificationId(), notification);\n                 }\n                 TaskManager taskManager = taskMap.get(message.getNotificationId());\n                 if (taskManager == null) {",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/0eda1b68315474f609421a3ad124b3423787754f/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "12a47b69eb0c42d8414eaadef03f42d5c3c92564",
                "blob_url": "https://github.com/apache/usergrid/blob/0eda1b68315474f609421a3ad124b3423787754f/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java?ref=0eda1b68315474f609421a3ad124b3423787754f"
            }
        ],
        "bug_id": "usergrid_26",
        "parent": "https://github.com/apache/usergrid/commit/f69e4f6ff16527b9fea4f03f934417d0a6b6a3a7",
        "message": "Add some delay in node.js tests and fix some NPEs around notifications.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/5d75a2992475ab907b15e4a2f86ab50ae89a1e40",
        "file": [
            {
                "patch": "@@ -58,7 +58,14 @@ public UnionIterator( int pageSize, int id, ByteBuffer minUuid ) {\n         super( pageSize );\n \n         this.id = id;\n-        list = new SortedColumnList( pageSize, UUID_SERIALIZER.fromByteBuffer( minUuid ) );\n+\n+        UUID parseMinUuid = null;\n+\n+        if(minUuid != null)      {\n+            parseMinUuid = UUID_SERIALIZER.fromByteBuffer( minUuid );\n+        }\n+\n+        list = new SortedColumnList( pageSize, parseMinUuid );\n     }\n \n ",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/5d75a2992475ab907b15e4a2f86ab50ae89a1e40/stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java",
                "status": "modified",
                "changes": 9,
                "deletions": 1,
                "sha": "00e90b881a8b11eb13b2fb2cfe062676c170f49b",
                "blob_url": "https://github.com/apache/usergrid/blob/5d75a2992475ab907b15e4a2f86ab50ae89a1e40/stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java?ref=5d75a2992475ab907b15e4a2f86ab50ae89a1e40"
            },
            {
                "patch": "@@ -16,13 +16,16 @@\n package org.usergrid.persistence.query.ir.result;\n \n \n+import java.nio.ByteBuffer;\n import java.util.HashSet;\n import java.util.Set;\n import java.util.UUID;\n \n import org.junit.Test;\n import org.usergrid.utils.UUIDUtils;\n \n+import me.prettyprint.cassandra.serializers.UUIDSerializer;\n+\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNull;\n@@ -295,6 +298,73 @@ public void iterationCompleted() {\n     }\n \n \n+    @Test\n+    public void nullCursorBytes() {\n+\n+        UUID id1 = UUIDUtils.minTimeUUID( 1 );\n+        UUID id2 = UUIDUtils.minTimeUUID( 2 );\n+        UUID id3 = UUIDUtils.minTimeUUID( 3 );\n+        UUID id4 = UUIDUtils.minTimeUUID( 4 );\n+        UUID id5 = UUIDUtils.minTimeUUID( 5 );\n+\n+\n+        InOrderIterator second = new InOrderIterator( 100 );\n+        second.add( id1 );\n+        second.add( id2 );\n+        second.add( id3 );\n+        second.add( id4 );\n+        second.add( id5 );\n+\n+        UnionIterator union = new UnionIterator( 100, 1, null );\n+\n+        union.addIterator( second );\n+\n+        Set<ScanColumn> ids = union.next();\n+\n+        // now make sure it's right, only 1, 3 and 8 intersect\n+        assertTrue( ids.contains( uuidColumn( id1 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id2 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id3 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id4 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id5 ) ) );\n+    }\n+\n+\n+    @Test\n+    public void validCursorBytes() {\n+\n+\n+        ByteBuffer cursor = UUIDSerializer.get().toByteBuffer( UUIDUtils.minTimeUUID( 4 ) );\n+\n+        UUID id1 = UUIDUtils.minTimeUUID( 1 );\n+        UUID id2 = UUIDUtils.minTimeUUID( 2 );\n+        UUID id3 = UUIDUtils.minTimeUUID( 3 );\n+        UUID id4 = UUIDUtils.minTimeUUID( 4 );\n+        UUID id5 = UUIDUtils.minTimeUUID( 5 );\n+\n+\n+        InOrderIterator second = new InOrderIterator( 100 );\n+        second.add( id1 );\n+        second.add( id2 );\n+        second.add( id3 );\n+        second.add( id4 );\n+        second.add( id5 );\n+\n+        UnionIterator union = new UnionIterator( 100, 1, cursor );\n+\n+        union.addIterator( second );\n+\n+        Set<ScanColumn> ids = union.next();\n+\n+        // now make sure it's right, only 1, 3 and 8 intersect\n+        assertFalse( ids.contains( uuidColumn( id1 ) ) );\n+        assertFalse( ids.contains( uuidColumn( id2 ) ) );\n+        assertFalse( ids.contains( uuidColumn( id3 ) ) );\n+        assertFalse( ids.contains( uuidColumn( id4 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id5 ) ) );\n+    }\n+\n+\n     private void reverse( UUID[] array ) {\n \n         UUID temp = null;",
                "additions": 70,
                "raw_url": "https://github.com/apache/usergrid/raw/5d75a2992475ab907b15e4a2f86ab50ae89a1e40/stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java",
                "status": "modified",
                "changes": 70,
                "deletions": 0,
                "sha": "8fd9ea80099eb580bf87af0cd8fcbfa73eb41572",
                "blob_url": "https://github.com/apache/usergrid/blob/5d75a2992475ab907b15e4a2f86ab50ae89a1e40/stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java",
                "filename": "stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java?ref=5d75a2992475ab907b15e4a2f86ab50ae89a1e40"
            }
        ],
        "bug_id": "usergrid_27",
        "parent": "https://github.com/apache/usergrid/commit/9dd14f1863b714e224531aa45595b0ed03731163",
        "message": "Fixes NPE issue in the union iterator",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/682041d7dbf135a8d57881691a11cbc560f6152c",
        "file": [
            {
                "patch": "@@ -220,7 +220,8 @@ public JSONWithPadding executePost(@Context UriInfo ui,\n \t\tif ((response.getEntities() != null)\n \t\t\t\t&& (response.getEntities().size() == 1)) {\n \n-\t\t\tEntity user = response.getEntities().get(0);\n+\t\t\tEntity entity = response.getEntities().get(0);\n+\t\t\tUser user = (User)entity.toTypedEntity();\n \n \t\t\tif (isNotBlank(password)) {\n \t\t\t\tmanagement.setAppUserPassword(getApplicationId(),\n@@ -234,7 +235,7 @@ public JSONWithPadding executePost(@Context UriInfo ui,\n \n \t\t\tif (!activated) {\n \t\t\t\tmanagement.startAppUserActivationFlow(getApplicationId(),\n-\t\t\t\t\t\tgetUser());\n+\t\t\t\t\t\tuser);\n \t\t\t}\n \t\t}\n \t\treturn new JSONWithPadding(response, callback);",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/682041d7dbf135a8d57881691a11cbc560f6152c/stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java",
                "status": "modified",
                "changes": 5,
                "deletions": 2,
                "sha": "92dbf07426d99d76c90a7f99de8a4f2f0669cbcb",
                "blob_url": "https://github.com/apache/usergrid/blob/682041d7dbf135a8d57881691a11cbc560f6152c/stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java",
                "filename": "stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java?ref=682041d7dbf135a8d57881691a11cbc560f6152c"
            }
        ],
        "bug_id": "usergrid_28",
        "parent": "https://github.com/apache/usergrid/commit/195cdbd46b27f6613ce412dedc43856165bfee41",
        "message": "fix NPE registration_requires_email_confirmation flow",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/1bf64fc9e07b57be874d3b232af9dcb3317d7d35",
        "file": [
            {
                "patch": "@@ -349,7 +349,7 @@ public Viewable handlePasswordResetForm(@Context UriInfo ui,\n \n             if (!useReCaptcha()) {\n                 management.startAppUserPasswordResetFlow(getApplicationId(),\n-                        user);\n+                \t\tgetUser());\n                 return handleViewable(\"resetpw_email_success\", this);\n             }\n \n@@ -362,7 +362,7 @@ public Viewable handlePasswordResetForm(@Context UriInfo ui,\n \n             if (reCaptchaResponse.isValid()) {\n                 management.startAppUserPasswordResetFlow(getApplicationId(),\n-                        user);\n+                        getUser());\n                 return handleViewable(\"resetpw_email_success\", this);\n             } else {\n                 errorMsg = \"Incorrect Captcha\";",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/1bf64fc9e07b57be874d3b232af9dcb3317d7d35/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "53c2578df9a27706f9d1f6e2e3951498567f93a8",
                "blob_url": "https://github.com/apache/usergrid/blob/1bf64fc9e07b57be874d3b232af9dcb3317d7d35/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "filename": "stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java?ref=1bf64fc9e07b57be874d3b232af9dcb3317d7d35"
            }
        ],
        "bug_id": "usergrid_29",
        "parent": "https://github.com/apache/usergrid/commit/a72d805d279decd5024daf6e57bacedcd1544f99",
        "message": "fixed application user password reset flow NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/16ce667c1558817b15019b3f6c42bb592908a57b",
        "file": [
            {
                "patch": "@@ -42,6 +42,7 @@\n import static org.usergrid.utils.ConversionUtils.string;\n \n import java.util.Map;\n+import java.util.UUID;\n \n import javax.ws.rs.Consumes;\n import javax.ws.rs.DefaultValue;\n@@ -105,18 +106,23 @@ public JSONWithPadding setUserPassword(@Context UriInfo ui,\n \t\t\treturn null;\n \t\t}\n \n-\t\tString oldPassword = string(json.get(\"oldpassword\"));\n-\t\tString newPassword = string(json.get(\"newpassword\"));\n-\t\tif (isApplicationAdmin(Identifier.fromUUID(getApplicationId()))) {\n-\t\t\tmanagement.setAdminUserPassword(getApplicationId(), newPassword);\n-\t\t} else {\n-\t\t\tmanagement.setAppUserPassword(getApplicationId(), getUser()\n-\t\t\t\t\t.getUuid(), oldPassword, newPassword);\n-\t\t}\n-\n \t\tApiResponse response = new ApiResponse(ui);\n \t\tresponse.setAction(\"set user password\");\n \n+\t\tif (getUser() != null) {\n+\t\t\tString oldPassword = string(json.get(\"oldpassword\"));\n+\t\t\tString newPassword = string(json.get(\"newpassword\"));\n+\t\t\tif (isApplicationAdmin(Identifier.fromUUID(getApplicationId()))) {\n+\t\t\t\tmanagement\n+\t\t\t\t\t\t.setAdminUserPassword(getApplicationId(), newPassword);\n+\t\t\t} else {\n+\t\t\t\tmanagement.setAppUserPassword(getApplicationId(), getUser()\n+\t\t\t\t\t\t.getUuid(), oldPassword, newPassword);\n+\t\t\t}\n+\t\t} else {\n+\t\t\tresponse.setError(\"User not found\");\n+\t\t}\n+\n \t\treturn new JSONWithPadding(response, callback);\n \t}\n \n@@ -128,11 +134,15 @@ public JSONWithPadding sendPin(@Context UriInfo ui,\n \n \t\tlogger.info(\"UserResource.sendPin\");\n \n-\t\tmanagement.sendAppUserPin(getApplicationId(), getUser().getUuid());\n-\n \t\tApiResponse response = new ApiResponse(ui);\n \t\tresponse.setAction(\"retrieve user pin\");\n \n+\t\tif (getUser() != null) {\n+\t\t\tmanagement.sendAppUserPin(getApplicationId(), getUserUuid());\n+\t\t} else {\n+\t\t\tresponse.setError(\"User not found\");\n+\t\t}\n+\n \t\treturn new JSONWithPadding(response, callback);\n \t}\n \n@@ -154,11 +164,15 @@ public JSONWithPadding setPin(@Context UriInfo ui,\n \n \t\tlogger.info(\"UserResource.setPin\");\n \n-\t\tmanagement.setAppUserPin(getApplicationId(), getUser().getUuid(), pin);\n-\n \t\tApiResponse response = new ApiResponse(ui);\n \t\tresponse.setAction(\"set user pin\");\n \n+\t\tif (getUser() != null) {\n+\t\t\tmanagement.setAppUserPin(getApplicationId(), getUserUuid(), pin);\n+\t\t} else {\n+\t\t\tresponse.setError(\"User not found\");\n+\t\t}\n+\n \t\treturn new JSONWithPadding(response, callback);\n \t}\n \n@@ -173,11 +187,15 @@ public JSONWithPadding postPin(@Context UriInfo ui,\n \n \t\tlogger.info(\"UserResource.postPin\");\n \n-\t\tmanagement.setAppUserPin(getApplicationId(), getUser().getUuid(), pin);\n-\n \t\tApiResponse response = new ApiResponse(ui);\n \t\tresponse.setAction(\"set user pin\");\n \n+\t\tif (getUser() != null) {\n+\t\t\tmanagement.setAppUserPin(getApplicationId(), getUserUuid(), pin);\n+\t\t} else {\n+\t\t\tresponse.setError(\"User not found\");\n+\t\t}\n+\n \t\treturn new JSONWithPadding(response, callback);\n \t}\n \n@@ -189,13 +207,17 @@ public JSONWithPadding jsonPin(@Context UriInfo ui, JsonNode json,\n \t\t\t@QueryParam(\"callback\") @DefaultValue(\"callback\") String callback)\n \t\t\tthrows Exception {\n \n-\t\tString pin = json.path(\"pin\").getTextValue();\n-\t\tmanagement.setAppUserPin(getApplicationId(), getUser().getUuid(), pin);\n-\n \t\tlogger.info(\"UserResource.jsonPin\");\n \t\tApiResponse response = new ApiResponse(ui);\n \t\tresponse.setAction(\"set user pin\");\n \n+\t\tif (getUser() != null) {\n+\t\t\tString pin = json.path(\"pin\").getTextValue();\n+\t\t\tmanagement.setAppUserPin(getApplicationId(), getUserUuid(), pin);\n+\t\t} else {\n+\t\t\tresponse.setError(\"User not found\");\n+\t\t}\n+\n \t\treturn new JSONWithPadding(response, callback);\n \t}\n \n@@ -209,7 +231,7 @@ public Viewable showPasswordResetForm(@Context UriInfo ui,\n \t\tthis.token = token;\n \n \t\tif (management.checkPasswordResetTokenForAppUser(getApplicationId(),\n-\t\t\t\tgetUser().getUuid(), token)) {\n+\t\t\t\tgetUserUuid(), token)) {\n \t\t\treturn new Viewable(\"resetpw_set_form\", this);\n \t\t} else {\n \t\t\treturn new Viewable(\"resetpw_email_form\", this);\n@@ -233,7 +255,7 @@ public Viewable handlePasswordResetForm(@Context UriInfo ui,\n \n \t\tif ((password1 != null) || (password2 != null)) {\n \t\t\tif (management.checkPasswordResetTokenForAppUser(\n-\t\t\t\t\tgetApplicationId(), getUser().getUuid(), token)) {\n+\t\t\t\t\tgetApplicationId(), getUserUuid(), token)) {\n \t\t\t\tif ((password1 != null) && password1.equals(password2)) {\n \t\t\t\t\tmanagement.setAppUserPassword(getApplicationId(), getUser()\n \t\t\t\t\t\t\t.getUuid(), password1);\n@@ -294,15 +316,23 @@ public User getUser() {\n \t\treturn user;\n \t}\n \n+\tpublic UUID getUserUuid() {\n+\t\tuser = getUser();\n+\t\tif (user == null) {\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn user.getUuid();\n+\t}\n+\n \t@GET\n \t@Path(\"activate\")\n \tpublic Viewable activate(@Context UriInfo ui,\n \t\t\t@QueryParam(\"token\") String token,\n \t\t\t@QueryParam(\"confirm\") boolean confirm) throws Exception {\n \n \t\tif (management.checkActivationTokenForAppUser(getApplicationId(),\n-\t\t\t\tgetUser().getUuid(), token)) {\n-\t\t\tmanagement.activateAppUser(getApplicationId(), getUser().getUuid());\n+\t\t\t\tgetUserUuid(), token)) {\n+\t\t\tmanagement.activateAppUser(getApplicationId(), getUserUuid());\n \t\t\tif (confirm) {\n \t\t\t\tmanagement.sendAppUserActivatedEmail(getApplicationId(), user);\n \t\t\t}\n@@ -317,7 +347,7 @@ public JSONWithPadding reactivate(@Context UriInfo ui,\n \t\t\t@QueryParam(\"callback\") @DefaultValue(\"callback\") String callback)\n \t\t\tthrows Exception {\n \n-\t\tlogger.info(\"Send activation email for user: \" + getUser().getUuid());\n+\t\tlogger.info(\"Send activation email for user: \" + getUserUuid());\n \n \t\tApiResponse response = new ApiResponse(ui);\n ",
                "additions": 53,
                "raw_url": "https://github.com/apache/usergrid/raw/16ce667c1558817b15019b3f6c42bb592908a57b/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "status": "modified",
                "changes": 76,
                "deletions": 23,
                "sha": "a42514ff0ddb18da12796224147c3a3ed61a336e",
                "blob_url": "https://github.com/apache/usergrid/blob/16ce667c1558817b15019b3f6c42bb592908a57b/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "filename": "stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java?ref=16ce667c1558817b15019b3f6c42bb592908a57b"
            }
        ],
        "bug_id": "usergrid_30",
        "parent": "https://github.com/apache/usergrid/commit/f07320adf2e8d3e0ebb8889553447bb9fa10cd70",
        "message": "fix NPE when user not found",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4",
        "file": [
            {
                "patch": "@@ -57,6 +57,7 @@\n import org.apache.usergrid.persistence.cassandra.index.IndexScanner;\n import org.apache.usergrid.persistence.cassandra.index.NoOpIndexScanner;\n import org.apache.usergrid.persistence.entities.Group;\n+import org.apache.usergrid.persistence.exceptions.EntityNotFoundException;\n import org.apache.usergrid.persistence.geo.CollectionGeoSearch;\n import org.apache.usergrid.persistence.geo.ConnectionGeoSearch;\n import org.apache.usergrid.persistence.geo.EntityLocationRef;\n@@ -89,10 +90,8 @@\n import me.prettyprint.hector.api.beans.DynamicComposite;\n import me.prettyprint.hector.api.beans.HColumn;\n import me.prettyprint.hector.api.mutation.Mutator;\n-\n import static java.lang.String.CASE_INSENSITIVE_ORDER;\n import static java.util.Arrays.asList;\n-\n import static me.prettyprint.hector.api.factory.HFactory.createMutator;\n import static org.apache.usergrid.persistence.Schema.COLLECTION_ROLES;\n import static org.apache.usergrid.persistence.Schema.DICTIONARY_COLLECTIONS;\n@@ -1799,6 +1798,10 @@ public ConnectionRef createConnection( String connectionType, EntityRef connecte\n         headEntity = em.validate( headEntity );\n         connectedEntityRef = em.validate( connectedEntityRef );\n \n+        if ( connectedEntityRef == null) {\n+          throw new EntityNotFoundException(\"The UUID of the connected entity was not found\");\n+        }\n+\n         ConnectionRefImpl connection = new ConnectionRefImpl( headEntity, connectionType, connectedEntityRef );\n \n         updateEntityConnection( false, connection );",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4/stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/RelationManagerImpl.java",
                "status": "modified",
                "changes": 7,
                "deletions": 2,
                "sha": "bc5f8a599edeecc77453d495ca81ce88ae551106",
                "blob_url": "https://github.com/apache/usergrid/blob/71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4/stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/RelationManagerImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/RelationManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/RelationManagerImpl.java?ref=71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4"
            },
            {
                "patch": "@@ -19,9 +19,11 @@\n \n import java.util.Map;\n \n+import org.junit.Assert;\n import org.junit.Test;\n import org.apache.usergrid.cassandra.Concurrent;\n import org.apache.usergrid.persistence.Entity;\n+import org.apache.usergrid.persistence.exceptions.EntityNotFoundException;\n \n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n@@ -80,4 +82,29 @@ public void testUserConnections() throws Exception {\n         app.put( \"email\", \"conn-user3@apigee.com\" );\n         app.testRequest( ServiceAction.POST, 1, \"users\", \"conn-user1\", \"manages\", \"user\" );\n     }\n+\n+    @Test\n+    public void testNonExistentEntity() throws Exception {\n+\n+      app.put( \"name\", \"foo\" );\n+      Entity foo = app.testRequest( ServiceAction.POST, 1, \"foos\" ).getEntity();\n+      assertNotNull( foo );\n+\n+      app.clear();\n+\n+      app.put( \"name\", \"bar\" );\n+      Entity bar = app.testRequest( ServiceAction.POST, 1, \"bars\" ).getEntity();\n+      assertNotNull( bar );\n+\n+      //POST users/conn-user1/user2/UUID\n+      app.testRequest( ServiceAction.POST, 1, \"foos\", \"foo\", \"bars\", bar.getUuid() ); // should succeed\n+\n+      try {\n+        //POST users/conn-user1/user2/bar\n+        app.testRequest( ServiceAction.POST, 1, \"foos\", \"foo\", \"bars\", \"bar\" );\n+        Assert.fail();\n+      } catch (EntityNotFoundException e) {\n+        // ok\n+      }\n+  }\n }",
                "additions": 27,
                "raw_url": "https://github.com/apache/usergrid/raw/71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4/stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java",
                "status": "modified",
                "changes": 27,
                "deletions": 0,
                "sha": "301a3bdff604ad62fa1b50b65b398c20e0fd9219",
                "blob_url": "https://github.com/apache/usergrid/blob/71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4/stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java",
                "filename": "stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/test/java/org/apache/usergrid/services/ConnectionsServiceIT.java?ref=71cfdf5a5d50d2b483c3db9b581e3ae44f7b74e4"
            }
        ],
        "bug_id": "usergrid_31",
        "parent": "https://github.com/apache/usergrid/commit/e450a287a8bd6116168f29443045647f8590ce1e",
        "message": "Fix NPE when connected entity doesn't exist",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/1da5e955b5c4208a7af903128157a2395eb79673",
        "file": [
            {
                "patch": "@@ -431,7 +431,11 @@ public synchronized void stopServer() {\n             httpServer = null;\n         }\n \n-        stopCassandra();\n+        if(embeddedCassandra != null) {\n+            stopCassandra();\n+            embeddedCassandra = null;\n+        }\n+\n         if (ctx instanceof XmlWebApplicationContext) {\n             ((XmlWebApplicationContext) ctx).close();\n         }",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/1da5e955b5c4208a7af903128157a2395eb79673/stack/standalone/src/main/java/org/usergrid/standalone/Server.java",
                "status": "modified",
                "changes": 6,
                "deletions": 1,
                "sha": "e01dc0868a7eb3976c8be6893446a5f560c9e14c",
                "blob_url": "https://github.com/apache/usergrid/blob/1da5e955b5c4208a7af903128157a2395eb79673/stack/standalone/src/main/java/org/usergrid/standalone/Server.java",
                "filename": "stack/standalone/src/main/java/org/usergrid/standalone/Server.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/standalone/src/main/java/org/usergrid/standalone/Server.java?ref=1da5e955b5c4208a7af903128157a2395eb79673"
            }
        ],
        "bug_id": "usergrid_32",
        "parent": "https://github.com/apache/usergrid/commit/bffa6f1159174cab64fbd738e385cf5b7271ec4c",
        "message": "should avoid NPE, when standalone server is stopping.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/8d749ca6ef6df30438d8d5541370b6c3aca8d0b0",
        "file": [
            {
                "patch": "@@ -606,7 +606,6 @@ public Response validateExternalToken(\n                         OrganizationOwnerInfo ownerOrgInfo = management.createOwnerAndOrganization(\n                                 orgName, username, name, email, dummyPassword, true, false );\n \n-                        management.activateOrganization( ownerOrgInfo.getOrganization() ); // redundant?\n                         applicationCreator.createSampleFor( ownerOrgInfo.getOrganization() );\n \n                         userId = ownerOrgInfo.getOwner().getUuid();\n@@ -623,8 +622,6 @@ public Response validateExternalToken(\n                         // already created user, so just create an org\n                         final OrganizationInfo organization = management.createOrganization( orgName, userInfo, true );\n \n-\n-                        management.activateOrganization( organization ); // redundant?\n                         applicationCreator.createSampleFor( organization );\n \n                         logger.info( \"Created user {}'s other org {}\", username, orgName );\n@@ -710,6 +707,10 @@ private JsonNode getMeFromUgCentral( String extAccessToken )  throws EntityNotFo\n      */\n     private void ensureAuthenticationAllowed( String username, String grant_type ) {\n \n+        if ( username == null || grant_type == null || !grant_type.equalsIgnoreCase( \"password\" )) {\n+            return; // we only care about username/password auth\n+        }\n+\n         final boolean externalTokensEnabled =\n                 !StringUtils.isEmpty( properties.getProperty( USERGRID_CENTRAL_URL ) );\n ",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/8d749ca6ef6df30438d8d5541370b6c3aca8d0b0/stack/rest/src/main/java/org/apache/usergrid/rest/management/ManagementResource.java",
                "status": "modified",
                "changes": 7,
                "deletions": 3,
                "sha": "6a0f4f2ff6bc9a61a53b2587e23d186460673584",
                "blob_url": "https://github.com/apache/usergrid/blob/8d749ca6ef6df30438d8d5541370b6c3aca8d0b0/stack/rest/src/main/java/org/apache/usergrid/rest/management/ManagementResource.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/management/ManagementResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/management/ManagementResource.java?ref=8d749ca6ef6df30438d8d5541370b6c3aca8d0b0"
            }
        ],
        "bug_id": "usergrid_33",
        "parent": "https://github.com/apache/usergrid/commit/277514902f18caf36c2a65b3803c8ecc60118e58",
        "message": "SSO central related: remove redundant calls to activate organization, and avoid NPEs in ensureAuthenticationAllowed().",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/cffc1cb7c276508741a35276ae6233c3319c16a8",
        "file": [
            {
                "patch": "@@ -50,6 +50,10 @@ public ServiceResults postCollection(ServiceContext context)\n \t\t\tthrows Exception {\n \n     String path = (String)context.getProperty(\"path\");\n+    \n+    if(path == null){\n+        throw new IllegalArgumentException(\"You must provide a 'path' property when creating a group\");\n+    }\n \n     logger.info(\"Creating group with path {}\", path);\n ",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/cffc1cb7c276508741a35276ae6233c3319c16a8/stack/services/src/main/java/org/usergrid/services/groups/GroupsService.java",
                "status": "modified",
                "changes": 4,
                "deletions": 0,
                "sha": "77722b52472393dda402e6dc05b14da12e54c2c9",
                "blob_url": "https://github.com/apache/usergrid/blob/cffc1cb7c276508741a35276ae6233c3319c16a8/stack/services/src/main/java/org/usergrid/services/groups/GroupsService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/groups/GroupsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/groups/GroupsService.java?ref=cffc1cb7c276508741a35276ae6233c3319c16a8"
            },
            {
                "patch": "@@ -73,8 +73,9 @@ public ServiceResults getEntityDictionary(ServiceContext context, List<EntityRef\n \n             String roleName = (String) em.getProperty(ref, \"name\");\n             \n+            //Should never happen\n             if (isBlank(roleName)) {\n-                return null;\n+                throw new IllegalArgumentException(\"You must provide a role name\");\n             }\n \n             return getApplicationRolePermissions(roleName);",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/cffc1cb7c276508741a35276ae6233c3319c16a8/stack/services/src/main/java/org/usergrid/services/roles/RolesService.java",
                "status": "modified",
                "changes": 3,
                "deletions": 1,
                "sha": "43e8077f81635dccc651f02504708f2ebfbbbe2d",
                "blob_url": "https://github.com/apache/usergrid/blob/cffc1cb7c276508741a35276ae6233c3319c16a8/stack/services/src/main/java/org/usergrid/services/roles/RolesService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/roles/RolesService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/roles/RolesService.java?ref=cffc1cb7c276508741a35276ae6233c3319c16a8"
            }
        ],
        "bug_id": "usergrid_34",
        "parent": "https://github.com/apache/usergrid/commit/d97dd804b9eb1570fb2cd6b02e550670589c9e39",
        "message": "Fixed invalid input errors for services that can cause NPEs",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/f973f585d8e81fef40e519cef423db10d7018e60",
        "file": [
            {
                "patch": "@@ -1241,10 +1241,20 @@ public DynamicEntity loadPartialEntity(UUID entityId,\n \t\t\t\tMap<String, Object> properties = deserializeEntityProperties(results\n \t\t\t\t\t\t.getByKey(key));\n \n+\t\t\t\tif (properties == null) {\n+\t\t\t\t\tlogger.error(\"Error deserializing entity with key \"\n+\t\t\t\t\t\t\t+ key\n+\t\t\t\t\t\t\t+ \", entity probaby doesn't exist, where did this key come from?\");\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\n \t\t\t\tUUID id = uuid(properties.get(PROPERTY_UUID));\n \t\t\t\tString type = string(properties.get(PROPERTY_TYPE));\n \n \t\t\t\tif ((id == null) || (type == null)) {\n+\t\t\t\t\tlogger.error(\"Error retrieving entity with key \"\n+\t\t\t\t\t\t\t+ key\n+\t\t\t\t\t\t\t+ \", no type or id deseriazable, where did this key come from?\");\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n \t\t\t\tA entity = EntityFactory.newEntity(id, type, entityClass);\n@@ -1255,7 +1265,9 @@ public DynamicEntity loadPartialEntity(UUID entityId,\n \n \t\t\tfor (UUID entityId : entityIds) {\n \t\t\t\tA entity = resultSet.get(entityId);\n-\t\t\t\tentities.add(entity);\n+\t\t\t\tif (entity != null) {\n+\t\t\t\t\tentities.add(entity);\n+\t\t\t\t}\n \t\t\t}\n \n \t\t}",
                "additions": 13,
                "raw_url": "https://github.com/apache/usergrid/raw/f973f585d8e81fef40e519cef423db10d7018e60/stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "status": "modified",
                "changes": 14,
                "deletions": 1,
                "sha": "58aae5a360edfcf5fa4d9cfd14a4e9bd5ead3902",
                "blob_url": "https://github.com/apache/usergrid/blob/f973f585d8e81fef40e519cef423db10d7018e60/stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/cassandra/EntityManagerImpl.java?ref=f973f585d8e81fef40e519cef423db10d7018e60"
            },
            {
                "patch": "@@ -45,7 +45,7 @@\n \t@EntityProperty(indexed = false, mutable = false)\n \tprotected String destination;\n \n-\t@EntityProperty(indexed = false, mutable = false)\n+\t@EntityProperty(name = \"reply_to\", indexed = false, mutable = false)\n \tprotected String replyTo;\n \n \t@EntityProperty(fulltextIndexed = false, required = true, mutable = false)",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/f973f585d8e81fef40e519cef423db10d7018e60/stack/core/src/main/java/org/usergrid/persistence/entities/Message.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "1f59328e83b9fa0829d2531397b65619d0ed1c29",
                "blob_url": "https://github.com/apache/usergrid/blob/f973f585d8e81fef40e519cef423db10d7018e60/stack/core/src/main/java/org/usergrid/persistence/entities/Message.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/entities/Message.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/entities/Message.java?ref=f973f585d8e81fef40e519cef423db10d7018e60"
            },
            {
                "patch": "@@ -16,7 +16,35 @@\n     <packaging>jar</packaging>\n     <name>${bundle.symbolicName} [${bundle.namespace}]</name>\n     <description>Counter batching service for Usergrid distributed counter architechture</description>\n-\n+\t<build>\n+\t\t<plugins>\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-surefire-plugin</artifactId>\n+\t\t\t\t<version>2.6</version>\n+\t\t\t\t<configuration>\n+\t\t\t\t\t<!-- <groups>fast,${groups}</groups> -->\n+\t\t\t\t\t<systemPropertyVariables>\n+\t\t\t\t\t\t<storage-config>${basedir}/src/test/conf</storage-config>\n+\t\t\t\t\t</systemPropertyVariables>\n+\t\t\t\t\t<forkMode>always</forkMode>\n+\t\t\t\t</configuration>\n+\t\t\t</plugin>\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-compiler-plugin</artifactId>\n+\t\t\t\t<version>2.3.2</version>\n+\t\t\t\t<configuration>\n+\t\t\t\t\t<source>1.6</source>\n+\t\t\t\t\t<target>1.6</target>\n+\t\t\t\t\t<optimize>true</optimize>\n+\t\t\t\t\t<debug>true</debug>\n+\t\t\t\t\t<showDeprecation>true</showDeprecation>\n+\t\t\t\t\t<showWarnings>true</showWarnings>\n+\t\t\t\t</configuration>\n+\t\t\t</plugin>\n+\t\t</plugins>\n+\t</build>\n     <dependencies>\n         <dependency>\n             <groupId>junit</groupId>",
                "additions": 29,
                "raw_url": "https://github.com/apache/usergrid/raw/f973f585d8e81fef40e519cef423db10d7018e60/stack/count-batcher/pom.xml",
                "status": "modified",
                "changes": 30,
                "deletions": 1,
                "sha": "c420bce6bf9fd2e15469da13f0c0ed44d185a607",
                "blob_url": "https://github.com/apache/usergrid/blob/f973f585d8e81fef40e519cef423db10d7018e60/stack/count-batcher/pom.xml",
                "filename": "stack/count-batcher/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/count-batcher/pom.xml?ref=f973f585d8e81fef40e519cef423db10d7018e60"
            },
            {
                "patch": "@@ -190,6 +190,21 @@\n \t\t\t<artifactId>usergrid-config</artifactId>\n \t\t\t<version>${project.version}</version>\n \t\t</dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-common</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-inserter</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-batcher</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n \t\t<dependency>\n \t\t\t<groupId>org.usergrid</groupId>\n \t\t\t<artifactId>usergrid-core</artifactId>",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/f973f585d8e81fef40e519cef423db10d7018e60/stack/rest/pom.xml",
                "status": "modified",
                "changes": 15,
                "deletions": 0,
                "sha": "ed6fc59ce54b5da24a3ac9eca2bae7443e092957",
                "blob_url": "https://github.com/apache/usergrid/blob/f973f585d8e81fef40e519cef423db10d7018e60/stack/rest/pom.xml",
                "filename": "stack/rest/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/pom.xml?ref=f973f585d8e81fef40e519cef423db10d7018e60"
            },
            {
                "patch": "@@ -148,6 +148,21 @@\n \t\t\t<artifactId>usergrid-config</artifactId>\n \t\t\t<version>${project.version}</version>\n \t\t</dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-common</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-inserter</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.usergrid</groupId>\n+            <artifactId>usergrid-count-batcher</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n \t\t<dependency>\n \t\t\t<groupId>org.usergrid</groupId>\n \t\t\t<artifactId>usergrid-core</artifactId>",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/f973f585d8e81fef40e519cef423db10d7018e60/stack/standalone/pom.xml",
                "status": "modified",
                "changes": 15,
                "deletions": 0,
                "sha": "126d0a13ad1c5d6fa516f6df1e0255cd0b9f24f9",
                "blob_url": "https://github.com/apache/usergrid/blob/f973f585d8e81fef40e519cef423db10d7018e60/stack/standalone/pom.xml",
                "filename": "stack/standalone/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/standalone/pom.xml?ref=f973f585d8e81fef40e519cef423db10d7018e60"
            },
            {
                "patch": "@@ -102,39 +102,37 @@\n \t\t<constructor-arg ref=\"cassandraHostConfigurator\" />\n \t\t<constructor-arg ref=\"lockManager\" />\n \t</bean>\n-    <bean id=\"entityManagerFactory\"\n-    \t\tclass=\"org.usergrid.persistence.cassandra.EntityManagerFactoryImpl\">\n-    \t\t<constructor-arg ref=\"cassandraService\" />\n-            <constructor-arg ref=\"counterUtils\"/>\n-    \t</bean>\n-\n-    \t<bean id=\"queueManagerFactory\"\n-    \t\tclass=\"org.usergrid.mq.cassandra.QueueManagerFactoryImpl\">\n-    \t\t<constructor-arg ref=\"cassandraService\" />\n-            <constructor-arg ref=\"counterUtils\"/>\n-    \t</bean>\n-\n-        <bean id=\"simpleBatcher\" class=\"com.usergrid.count.SimpleBatcher\">\n-            <constructor-arg value=\"3\"/>\n-            <property name=\"batchSubmitter\" ref=\"batchSubmitter\"/>\n-        </bean>\n-\n-        <bean id=\"batchSubmitter\" class=\"com.usergrid.count.CassandraSubmitter\">\n-            <constructor-arg ref=\"cassandraCounterStore\"/>\n-        </bean>\n-\n-        <bean id=\"cassandraCounterStore\" class=\"com.usergrid.count.CassandraCounterStore\">\n-            <constructor-arg>\n-                <bean id=\"keyspace\"\n-                      factory-bean=\"cassandraService\"\n-                      factory-method=\"getUsergridApplicationKeyspace\"/>\n-            </constructor-arg>\n-        </bean>\n-\n-        <bean id=\"counterUtils\" class=\"org.usergrid.persistence.cassandra.CounterUtils\">\n-            <property name=\"batcher\" ref=\"simpleBatcher\"/>\n-            <property name=\"counterType\" value=\"n\"/> <!-- use new couter architecture. p: parallel, o: old -->\n-        </bean>\n+\t<bean id=\"entityManagerFactory\"\n+\t\tclass=\"org.usergrid.persistence.cassandra.EntityManagerFactoryImpl\">\n+\t\t<constructor-arg ref=\"cassandraService\" />\n+\t\t<constructor-arg ref=\"counterUtils\" />\n+\t</bean>\n+\n+\t<bean id=\"queueManagerFactory\" class=\"org.usergrid.mq.cassandra.QueueManagerFactoryImpl\">\n+\t\t<constructor-arg ref=\"cassandraService\" />\n+\t\t<constructor-arg ref=\"counterUtils\" />\n+\t</bean>\n+\n+\t<bean id=\"simpleBatcher\" class=\"com.usergrid.count.SimpleBatcher\">\n+\t\t<constructor-arg value=\"3\" />\n+\t\t<property name=\"batchSubmitter\" ref=\"batchSubmitter\" />\n+\t</bean>\n+\n+\t<bean id=\"batchSubmitter\" class=\"com.usergrid.count.CassandraSubmitter\">\n+\t\t<constructor-arg ref=\"cassandraCounterStore\" />\n+\t</bean>\n+\n+\t<bean id=\"cassandraCounterStore\" class=\"com.usergrid.count.CassandraCounterStore\">\n+\t\t<constructor-arg>\n+\t\t\t<bean id=\"keyspace\" factory-bean=\"cassandraService\"\n+\t\t\t\tfactory-method=\"getUsergridApplicationKeyspace\" />\n+\t\t</constructor-arg>\n+\t</bean>\n+\n+\t<bean id=\"counterUtils\" class=\"org.usergrid.persistence.cassandra.CounterUtils\">\n+\t\t<property name=\"batcher\" ref=\"simpleBatcher\" />\n+\t\t<property name=\"counterType\" value=\"n\" /> <!-- use new couter architecture. p: parallel, o: old -->\n+\t</bean>\n \n \t<bean id=\"serviceManagerFactory\" class=\"org.usergrid.services.ServiceManagerFactory\">\n \t\t<constructor-arg>",
                "additions": 31,
                "raw_url": "https://github.com/apache/usergrid/raw/f973f585d8e81fef40e519cef423db10d7018e60/stack/standalone/src/main/resources/standaloneApplicationContext.xml",
                "status": "modified",
                "changes": 64,
                "deletions": 33,
                "sha": "5e79bdeb213daf58b0a4509143b8219a58dc1e41",
                "blob_url": "https://github.com/apache/usergrid/blob/f973f585d8e81fef40e519cef423db10d7018e60/stack/standalone/src/main/resources/standaloneApplicationContext.xml",
                "filename": "stack/standalone/src/main/resources/standaloneApplicationContext.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/standalone/src/main/resources/standaloneApplicationContext.xml?ref=f973f585d8e81fef40e519cef423db10d7018e60"
            }
        ],
        "bug_id": "usergrid_35",
        "parent": "https://github.com/apache/usergrid/commit/9a152ae1c13205edad25b6c0abe57cd0debd0dd4",
        "message": "fix for missing entity npe plus other stuff",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/12606e7de13a3404d3913425714f962c7ca18830",
        "file": [
            {
                "patch": "@@ -32,11 +32,17 @@\n     private final String prefix;\n     private final String base64Prefix;\n     private final boolean expires;\n-    private static final Map<String, TokenCategory> prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-    private static final Map<String, TokenCategory> base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+    private static Map<String, TokenCategory> prefixes;\n+    private static Map<String, TokenCategory> base64Prefixes;\n \n \n     private synchronized static void register( TokenCategory type ) {\n+        if ( prefixes == null ) {\n+            prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+        }\n+        if ( base64Prefixes == null ) {\n+            base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+        }\n         prefixes.put( type.getPrefix(), type );\n         base64Prefixes.put( type.getBase64Prefix(), type );\n     }",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/12606e7de13a3404d3913425714f962c7ca18830/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "status": "modified",
                "changes": 10,
                "deletions": 2,
                "sha": "121901d248b1e4d2dfe7857c7d0458b09898263c",
                "blob_url": "https://github.com/apache/usergrid/blob/12606e7de13a3404d3913425714f962c7ca18830/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java?ref=12606e7de13a3404d3913425714f962c7ca18830"
            },
            {
                "patch": "@@ -499,13 +499,7 @@ private ByteBuffer principalKey( AuthPrincipalInfo principalInfo ) {\n \n \n     private UUID getUUIDForToken( String token ) throws ExpiredTokenException, BadTokenException {\n-\n         TokenCategory tokenCategory = TokenCategory.getFromBase64String( token );\n-\n-        if( tokenCategory == null){\n-            return null;\n-        }\n-\n         byte[] bytes = decodeBase64( token.substring( TokenCategory.BASE64_PREFIX_LENGTH ) );\n         UUID uuid = uuid( bytes );\n         int i = 16;",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/12606e7de13a3404d3913425714f962c7ca18830/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "status": "modified",
                "changes": 6,
                "deletions": 6,
                "sha": "50156b5ac4b69be8fbfa1a829ca7eeaf04e668de",
                "blob_url": "https://github.com/apache/usergrid/blob/12606e7de13a3404d3913425714f962c7ca18830/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java?ref=12606e7de13a3404d3913425714f962c7ca18830"
            }
        ],
        "bug_id": "usergrid_36",
        "parent": "https://github.com/apache/usergrid/commit/9a673a7a9fa77ff385083cc64056f8055f1b8033",
        "message": "Merge pull request #174 from GERey/master\n\nRevert \"Missed null check may cause NPE\"",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/4116025f85b97a88b22d9520dac72104cc17c957",
        "file": [
            {
                "patch": "@@ -32,11 +32,17 @@\n     private final String prefix;\n     private final String base64Prefix;\n     private final boolean expires;\n-    private static final Map<String, TokenCategory> prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-    private static final Map<String, TokenCategory> base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+    private static Map<String, TokenCategory> prefixes;\n+    private static Map<String, TokenCategory> base64Prefixes;\n \n \n     private synchronized static void register( TokenCategory type ) {\n+        if ( prefixes == null ) {\n+            prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+        }\n+        if ( base64Prefixes == null ) {\n+            base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+        }\n         prefixes.put( type.getPrefix(), type );\n         base64Prefixes.put( type.getBase64Prefix(), type );\n     }",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/4116025f85b97a88b22d9520dac72104cc17c957/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "status": "modified",
                "changes": 10,
                "deletions": 2,
                "sha": "121901d248b1e4d2dfe7857c7d0458b09898263c",
                "blob_url": "https://github.com/apache/usergrid/blob/4116025f85b97a88b22d9520dac72104cc17c957/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java?ref=4116025f85b97a88b22d9520dac72104cc17c957"
            },
            {
                "patch": "@@ -499,13 +499,7 @@ private ByteBuffer principalKey( AuthPrincipalInfo principalInfo ) {\n \n \n     private UUID getUUIDForToken( String token ) throws ExpiredTokenException, BadTokenException {\n-\n         TokenCategory tokenCategory = TokenCategory.getFromBase64String( token );\n-\n-        if( tokenCategory == null){\n-            return null;\n-        }\n-\n         byte[] bytes = decodeBase64( token.substring( TokenCategory.BASE64_PREFIX_LENGTH ) );\n         UUID uuid = uuid( bytes );\n         int i = 16;",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/4116025f85b97a88b22d9520dac72104cc17c957/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "status": "modified",
                "changes": 6,
                "deletions": 6,
                "sha": "50156b5ac4b69be8fbfa1a829ca7eeaf04e668de",
                "blob_url": "https://github.com/apache/usergrid/blob/4116025f85b97a88b22d9520dac72104cc17c957/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java?ref=4116025f85b97a88b22d9520dac72104cc17c957"
            }
        ],
        "bug_id": "usergrid_37",
        "parent": "https://github.com/apache/usergrid/commit/cb7a7b3a3f59a6e5967c14a650895fe3dc1433c3",
        "message": "Revert \"Missed null check may cause NPE\"\n\nThis reverts commit 54735519943819e32df9aadcb81e9142f32e4cef.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/43dd08dcfa31c7d0c4d084ce5ebd8bd210eea4a3",
        "file": [
            {
                "patch": "@@ -34,7 +34,9 @@\n import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.UriInfo;\n \n+import org.apache.usergrid.management.exceptions.ManagementException;\n import org.apache.usergrid.rest.RootResource;\n+import org.apache.usergrid.services.exceptions.ServiceResourceNotFoundException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n@@ -76,8 +78,7 @@ public UsersResource() {\n     @Path(RootResource.USER_ID_PATH)\n     public UserResource getUserById( @Context UriInfo ui, @PathParam( \"userId\" ) String userIdStr ) throws Exception {\n \n-        return getSubResource( UserResource.class )\n-                .init( management.getAdminUserByUuid( UUID.fromString( userIdStr ) ) );\n+        return getUserResource(management.getAdminUserByUuid(UUID.fromString(userIdStr)), \"user id\", userIdStr);\n     }\n \n \n@@ -93,14 +94,21 @@ public UserResource getUserByUsername( @Context UriInfo ui, @PathParam( \"usernam\n             throw mappableSecurityException( \"unauthorized\", \"No admin identity for access credentials provided\" );\n         }\n \n-        return getSubResource( UserResource.class ).init( management.getAdminUserByUsername( username ) );\n+        return getUserResource(management.getAdminUserByUsername(username), \"username\", username);\n+    }\n+\n+    private UserResource getUserResource(UserInfo user, String type, String value) throws ManagementException {\n+        if (user == null) {\n+            throw new ManagementException(\"Could not find organization for \" + type + \" : \" + value);\n+        }\n+        return getSubResource(UserResource.class).init(user);\n     }\n \n \n     @Path(RootResource.EMAIL_PATH)\n     public UserResource getUserByEmail( @Context UriInfo ui, @PathParam( \"email\" ) String email ) throws Exception {\n \n-        return getSubResource( UserResource.class ).init( management.getAdminUserByEmail( email ) );\n+        return getUserResource(management.getAdminUserByEmail(email), \"email\", email);\n     }\n \n ",
                "additions": 12,
                "raw_url": "https://github.com/apache/usergrid/raw/43dd08dcfa31c7d0c4d084ce5ebd8bd210eea4a3/stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java",
                "status": "modified",
                "changes": 16,
                "deletions": 4,
                "sha": "89d54689114d3f1c2a45199c663853c81a8df695",
                "blob_url": "https://github.com/apache/usergrid/blob/43dd08dcfa31c7d0c4d084ce5ebd8bd210eea4a3/stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java?ref=43dd08dcfa31c7d0c4d084ce5ebd8bd210eea4a3"
            }
        ],
        "bug_id": "usergrid_38",
        "parent": "https://github.com/apache/usergrid/commit/4169a7f999ed3bdd1e11a78898257288c44a87fd",
        "message": "NPE may be thrown if the org admin identifier doesn't exist",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/4d1a5adc828dcccbe1f9a44b6644b0a6576b912f",
        "file": [
            {
                "patch": "@@ -136,13 +136,17 @@ public JSONWithPadding newUserForOrganizationFromForm( @Context UriInfo ui, @For\n \n         if ( user == null ) {\n             user = management.createAdminUser( username, name, email, password, false, false );\n+\n+            // A null may be returned if the user fails validation check\n+            if ( user != null ) {\n+                management.startAdminUserPasswordResetFlow( user );\n+            }\n         }\n \n         if ( user == null ) {\n             return null;\n         }\n \n-        management.startAdminUserPasswordResetFlow( user );\n         management.addAdminUserToOrganization( user, organization, true );\n \n         Map<String, Object> result = new LinkedHashMap<String, Object>();",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/4d1a5adc828dcccbe1f9a44b6644b0a6576b912f/stack/rest/src/main/java/org/apache/usergrid/rest/management/organizations/users/UsersResource.java",
                "status": "modified",
                "changes": 6,
                "deletions": 1,
                "sha": "716679fea0ef03b2274eff70ce665c73c4017f5b",
                "blob_url": "https://github.com/apache/usergrid/blob/4d1a5adc828dcccbe1f9a44b6644b0a6576b912f/stack/rest/src/main/java/org/apache/usergrid/rest/management/organizations/users/UsersResource.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/management/organizations/users/UsersResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/management/organizations/users/UsersResource.java?ref=4d1a5adc828dcccbe1f9a44b6644b0a6576b912f"
            }
        ],
        "bug_id": "usergrid_39",
        "parent": "https://github.com/apache/usergrid/commit/c47cc4d7a3018baec8303177e6c4087087f39b17",
        "message": "Null check to fix NPE when user validation fails due to missing email",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/4829c7abe19e60cc212a8c96b9b799cf8a3ad958",
        "file": [
            {
                "patch": "@@ -116,4 +116,11 @@\n     public void setProperty( String name, String value );\n \n     public Properties getMailProperties();\n+    public SuperUser getSuperUser();\n+    public static interface SuperUser{\n+       boolean isEnabled();\n+        String getUsername();\n+        String getEmail();\n+        String getPassword();\n+    }\n }",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/4829c7abe19e60cc212a8c96b9b799cf8a3ad958/stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java",
                "status": "modified",
                "changes": 7,
                "deletions": 0,
                "sha": "6ed892b8ddbe14221bf4302e31c08b27c5497a5a",
                "blob_url": "https://github.com/apache/usergrid/blob/4829c7abe19e60cc212a8c96b9b799cf8a3ad958/stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java?ref=4829c7abe19e60cc212a8c96b9b799cf8a3ad958"
            },
            {
                "patch": "@@ -26,16 +26,18 @@\n import static java.lang.Boolean.parseBoolean;\n \n import static org.apache.commons.lang.StringUtils.isBlank;\n+import static org.usergrid.utils.ListUtils.anyNull;\n \n \n public class AccountCreationPropsImpl implements AccountCreationProps {\n     private static final Logger logger = LoggerFactory.getLogger( AccountCreationPropsImpl.class );\n \n-    protected Properties properties;\n-\n+    protected final Properties properties;\n+    private final SuperUser superUser;\n \n     public AccountCreationPropsImpl( Properties properties ) {\n         this.properties = properties;\n+        this.superUser = new SuperUserImpl(properties);\n     }\n \n \n@@ -109,4 +111,48 @@ public Properties getMailProperties() {\n         }\n         return p;\n     }\n+\n+    @Override\n+    public SuperUser getSuperUser() {\n+        return superUser;\n+    }\n+\n+    protected static class SuperUserImpl implements SuperUser {\n+        private final boolean enabled;\n+        private final String username;\n+        private final String email;\n+        private final String password;\n+\n+        public SuperUserImpl(Properties properties) {\n+            enabled = parseBoolean(properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_ALLOWED));\n+            username = properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_NAME);\n+            email = properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_EMAIL);\n+            password = properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_PASSWORD);\n+        }\n+\n+        @Override\n+        public boolean isEnabled() {\n+            return superuserEnabled();\n+        }\n+\n+        @Override\n+        public String getUsername() {\n+            return username;\n+        }\n+\n+        @Override\n+        public String getEmail() {\n+            return email;\n+        }\n+\n+        @Override\n+        public String getPassword() {\n+            return password;\n+        }\n+\n+        private boolean superuserEnabled() {\n+            return enabled && !anyNull(username, email, password);\n+        }\n+    }\n+\n }",
                "additions": 48,
                "raw_url": "https://github.com/apache/usergrid/raw/4829c7abe19e60cc212a8c96b9b799cf8a3ad958/stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java",
                "status": "modified",
                "changes": 50,
                "deletions": 2,
                "sha": "06c809a2215e6a8639dbd7e2aa75f2ca19be8a09",
                "blob_url": "https://github.com/apache/usergrid/blob/4829c7abe19e60cc212a8c96b9b799cf8a3ad958/stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java?ref=4829c7abe19e60cc212a8c96b9b799cf8a3ad958"
            },
            {
                "patch": "@@ -129,10 +129,7 @@\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_ORGANIZATION_ACTIVATION_URL;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_SETUP_TEST_ACCOUNT;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_EMAIL;\n-import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_ALLOWED;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_EMAIL;\n-import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_NAME;\n-import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_PASSWORD;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_TEST_ACCOUNT_ADMIN_USER_EMAIL;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_TEST_ACCOUNT_ADMIN_USER_NAME;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_TEST_ACCOUNT_ADMIN_USER_PASSWORD;\n@@ -321,37 +318,25 @@ public void setup() throws Exception {\n             logger.warn( \"Test app creation disabled\" );\n         }\n \n-        if ( superuserEnabled() ) {\n+        if ( properties.getSuperUser().isEnabled() ) {\n             provisionSuperuser();\n         }\n     }\n \n \n-    public boolean superuserEnabled() {\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n-        String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n-        String superuser_email = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL );\n-        String superuser_password = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_PASSWORD );\n-\n-        return superuser_enabled && !anyNull( superuser_username, superuser_email, superuser_password );\n-    }\n \n \n     @Override\n     public void provisionSuperuser() throws Exception {\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n-        String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n-        String superuser_email = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL );\n-        String superuser_password = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_PASSWORD );\n-\n-        if ( !anyNull( superuser_username, superuser_email, superuser_password ) ) {\n-            UserInfo user = this.getAdminUserByUsername( superuser_username );\n+        final AccountCreationProps.SuperUser superUser = properties.getSuperUser();\n+        if ( superUser.isEnabled() ) {\n+            UserInfo user = this.getAdminUserByUsername( superUser.getUsername() );\n             if ( user == null ) {\n-                createAdminUser( superuser_username, \"Super User\", superuser_email, superuser_password,\n-                        superuser_enabled, !superuser_enabled );\n+                createAdminUser( superUser.getUsername(), \"Super User\", superUser.getEmail(), superUser.getPassword(),\n+                        superUser.isEnabled(), !superUser.isEnabled() );\n             }\n             else {\n-                this.setAdminUserPassword( user.getUuid(), superuser_password );\n+                this.setAdminUserPassword( user.getUuid(), superUser.getPassword() );\n             }\n         }\n         else {\n@@ -1246,13 +1231,12 @@ public UserInfo verifyAdminUserPasswordCredentials( String name, String password\n         if ( verify( MANAGEMENT_APPLICATION_ID, user.getUuid(), password ) ) {\n             userInfo = getUserInfo( MANAGEMENT_APPLICATION_ID, user );\n \n-            boolean userIsSuperAdmin =\n-                    properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL ).equals( userInfo.getEmail() );\n+            boolean userIsSuperAdmin = properties.getSuperUser().isEnabled() && properties.getSuperUser().getEmail().equals(userInfo.getEmail());\n \n             boolean testUserEnabled = parseBoolean( properties.getProperty( PROPERTIES_SETUP_TEST_ACCOUNT ) );\n \n             boolean userIsTestUser = !testUserEnabled ? false :\n-                                     properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL )\n+                                     properties.getProperty( PROPERTIES_TEST_ACCOUNT_ADMIN_USER_EMAIL )\n                                                .equals( userInfo.getEmail() );\n \n             if ( !userIsSuperAdmin && !userIsTestUser ) {\n@@ -1488,10 +1472,8 @@ public Long getLastAdminPasswordChange( UUID userId ) throws Exception {\n         json.put( \"organizations\", jsonOrganizations );\n \n         Map<UUID, String> organizations;\n-\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n-        String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n-        if ( superuser_enabled && ( superuser_username != null ) && superuser_username.equals( user.getUsername() ) ) {\n+        AccountCreationProps.SuperUser superUser = properties.getSuperUser();\n+        if ( superUser.isEnabled() && superUser.getUsername().equals( user.getUsername() ) ) {\n             organizations = buildOrgBiMap( getOrganizations( null, 10 ) );\n         }\n         else {",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/4829c7abe19e60cc212a8c96b9b799cf8a3ad958/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "status": "modified",
                "changes": 40,
                "deletions": 29,
                "sha": "429491b02c12988fc12cae07ac3fc0684bd060fe",
                "blob_url": "https://github.com/apache/usergrid/blob/4829c7abe19e60cc212a8c96b9b799cf8a3ad958/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java?ref=4829c7abe19e60cc212a8c96b9b799cf8a3ad958"
            }
        ],
        "bug_id": "usergrid_40",
        "parent": "https://github.com/apache/usergrid/commit/5faeb10bd634998968ea08fcac1af37b9fd79322",
        "message": "USERGRID-77 can't login for newly created user due to NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/832017bf7b1c2e8b809b8254f2fd70eebab58d0f",
        "file": [
            {
                "patch": "@@ -58,7 +58,14 @@ public UnionIterator( int pageSize, int id, ByteBuffer minUuid ) {\n         super( pageSize );\n \n         this.id = id;\n-        list = new SortedColumnList( pageSize, UUID_SERIALIZER.fromByteBuffer( minUuid ) );\n+\n+        UUID parseMinUuid = null;\n+\n+        if(minUuid != null)      {\n+            parseMinUuid = UUID_SERIALIZER.fromByteBuffer( minUuid );\n+        }\n+\n+        list = new SortedColumnList( pageSize, parseMinUuid );\n     }\n \n ",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/832017bf7b1c2e8b809b8254f2fd70eebab58d0f/stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java",
                "status": "modified",
                "changes": 9,
                "deletions": 1,
                "sha": "00e90b881a8b11eb13b2fb2cfe062676c170f49b",
                "blob_url": "https://github.com/apache/usergrid/blob/832017bf7b1c2e8b809b8254f2fd70eebab58d0f/stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java",
                "filename": "stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/usergrid/persistence/query/ir/result/UnionIterator.java?ref=832017bf7b1c2e8b809b8254f2fd70eebab58d0f"
            },
            {
                "patch": "@@ -16,13 +16,16 @@\n package org.usergrid.persistence.query.ir.result;\n \n \n+import java.nio.ByteBuffer;\n import java.util.HashSet;\n import java.util.Set;\n import java.util.UUID;\n \n import org.junit.Test;\n import org.usergrid.utils.UUIDUtils;\n \n+import me.prettyprint.cassandra.serializers.UUIDSerializer;\n+\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNull;\n@@ -295,6 +298,73 @@ public void iterationCompleted() {\n     }\n \n \n+    @Test\n+    public void nullCursorBytes() {\n+\n+        UUID id1 = UUIDUtils.minTimeUUID( 1 );\n+        UUID id2 = UUIDUtils.minTimeUUID( 2 );\n+        UUID id3 = UUIDUtils.minTimeUUID( 3 );\n+        UUID id4 = UUIDUtils.minTimeUUID( 4 );\n+        UUID id5 = UUIDUtils.minTimeUUID( 5 );\n+\n+\n+        InOrderIterator second = new InOrderIterator( 100 );\n+        second.add( id1 );\n+        second.add( id2 );\n+        second.add( id3 );\n+        second.add( id4 );\n+        second.add( id5 );\n+\n+        UnionIterator union = new UnionIterator( 100, 1, null );\n+\n+        union.addIterator( second );\n+\n+        Set<ScanColumn> ids = union.next();\n+\n+        // now make sure it's right, only 1, 3 and 8 intersect\n+        assertTrue( ids.contains( uuidColumn( id1 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id2 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id3 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id4 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id5 ) ) );\n+    }\n+\n+\n+    @Test\n+    public void validCursorBytes() {\n+\n+\n+        ByteBuffer cursor = UUIDSerializer.get().toByteBuffer( UUIDUtils.minTimeUUID( 4 ) );\n+\n+        UUID id1 = UUIDUtils.minTimeUUID( 1 );\n+        UUID id2 = UUIDUtils.minTimeUUID( 2 );\n+        UUID id3 = UUIDUtils.minTimeUUID( 3 );\n+        UUID id4 = UUIDUtils.minTimeUUID( 4 );\n+        UUID id5 = UUIDUtils.minTimeUUID( 5 );\n+\n+\n+        InOrderIterator second = new InOrderIterator( 100 );\n+        second.add( id1 );\n+        second.add( id2 );\n+        second.add( id3 );\n+        second.add( id4 );\n+        second.add( id5 );\n+\n+        UnionIterator union = new UnionIterator( 100, 1, cursor );\n+\n+        union.addIterator( second );\n+\n+        Set<ScanColumn> ids = union.next();\n+\n+        // now make sure it's right, only 1, 3 and 8 intersect\n+        assertFalse( ids.contains( uuidColumn( id1 ) ) );\n+        assertFalse( ids.contains( uuidColumn( id2 ) ) );\n+        assertFalse( ids.contains( uuidColumn( id3 ) ) );\n+        assertFalse( ids.contains( uuidColumn( id4 ) ) );\n+        assertTrue( ids.contains( uuidColumn( id5 ) ) );\n+    }\n+\n+\n     private void reverse( UUID[] array ) {\n \n         UUID temp = null;",
                "additions": 70,
                "raw_url": "https://github.com/apache/usergrid/raw/832017bf7b1c2e8b809b8254f2fd70eebab58d0f/stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java",
                "status": "modified",
                "changes": 70,
                "deletions": 0,
                "sha": "8fd9ea80099eb580bf87af0cd8fcbfa73eb41572",
                "blob_url": "https://github.com/apache/usergrid/blob/832017bf7b1c2e8b809b8254f2fd70eebab58d0f/stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java",
                "filename": "stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/usergrid/persistence/query/ir/result/UnionIteratorTest.java?ref=832017bf7b1c2e8b809b8254f2fd70eebab58d0f"
            }
        ],
        "bug_id": "usergrid_41",
        "parent": "https://github.com/apache/usergrid/commit/b22115aec275b24019556edda509a109650ae385",
        "message": "Merge pull request #32 from usergrid/USERGRID-2862-limitfix\n\nFixes NPE issue in the union iterator",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/07f203fbf0c4d62bd30925108dacf6d08461d45c",
        "file": [
            {
                "patch": "@@ -431,7 +431,11 @@ public synchronized void stopServer() {\n             httpServer = null;\n         }\n \n-        stopCassandra();\n+        if(embeddedCassandra != null) {\n+            stopCassandra();\n+            embeddedCassandra = null;\n+        }\n+\n         if (ctx instanceof XmlWebApplicationContext) {\n             ((XmlWebApplicationContext) ctx).close();\n         }",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/07f203fbf0c4d62bd30925108dacf6d08461d45c/stack/standalone/src/main/java/org/usergrid/standalone/Server.java",
                "status": "modified",
                "changes": 6,
                "deletions": 1,
                "sha": "e01dc0868a7eb3976c8be6893446a5f560c9e14c",
                "blob_url": "https://github.com/apache/usergrid/blob/07f203fbf0c4d62bd30925108dacf6d08461d45c/stack/standalone/src/main/java/org/usergrid/standalone/Server.java",
                "filename": "stack/standalone/src/main/java/org/usergrid/standalone/Server.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/standalone/src/main/java/org/usergrid/standalone/Server.java?ref=07f203fbf0c4d62bd30925108dacf6d08461d45c"
            }
        ],
        "bug_id": "usergrid_42",
        "parent": "https://github.com/apache/usergrid/commit/bffa6f1159174cab64fbd738e385cf5b7271ec4c",
        "message": "Merge pull request #88 from realbeast/feature/avoidnpe\n\nShould avoid NPE, when standalone server is stopping.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/7e8b34e56e883846ae1a2ca0274bcc36f030a144",
        "file": [
            {
                "patch": "@@ -220,7 +220,8 @@ public JSONWithPadding executePost(@Context UriInfo ui,\n \t\tif ((response.getEntities() != null)\n \t\t\t\t&& (response.getEntities().size() == 1)) {\n \n-\t\t\tEntity user = response.getEntities().get(0);\n+\t\t\tEntity entity = response.getEntities().get(0);\n+\t\t\tUser user = (User)entity.toTypedEntity();\n \n \t\t\tif (isNotBlank(password)) {\n \t\t\t\tmanagement.setAppUserPassword(getApplicationId(),\n@@ -234,7 +235,7 @@ public JSONWithPadding executePost(@Context UriInfo ui,\n \n \t\t\tif (!activated) {\n \t\t\t\tmanagement.startAppUserActivationFlow(getApplicationId(),\n-\t\t\t\t\t\tgetUser());\n+\t\t\t\t\t\tuser);\n \t\t\t}\n \t\t}\n \t\treturn new JSONWithPadding(response, callback);",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/7e8b34e56e883846ae1a2ca0274bcc36f030a144/stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java",
                "status": "modified",
                "changes": 5,
                "deletions": 2,
                "sha": "92dbf07426d99d76c90a7f99de8a4f2f0669cbcb",
                "blob_url": "https://github.com/apache/usergrid/blob/7e8b34e56e883846ae1a2ca0274bcc36f030a144/stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java",
                "filename": "stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/usergrid/rest/applications/users/UsersResource.java?ref=7e8b34e56e883846ae1a2ca0274bcc36f030a144"
            }
        ],
        "bug_id": "usergrid_43",
        "parent": "https://github.com/apache/usergrid/commit/195cdbd46b27f6613ce412dedc43856165bfee41",
        "message": "Merge pull request #44 from realbeast/feature/fixemailconfirmationflow\n\nfix NPE registration_requires_email_confirmation flow",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/c8af2e5fb445f1483327165e6ed93e6fb4d9b3fc",
        "file": [
            {
                "patch": "@@ -349,7 +349,7 @@ public Viewable handlePasswordResetForm(@Context UriInfo ui,\n \n             if (!useReCaptcha()) {\n                 management.startAppUserPasswordResetFlow(getApplicationId(),\n-                        user);\n+                \t\tgetUser());\n                 return handleViewable(\"resetpw_email_success\", this);\n             }\n \n@@ -362,7 +362,7 @@ public Viewable handlePasswordResetForm(@Context UriInfo ui,\n \n             if (reCaptchaResponse.isValid()) {\n                 management.startAppUserPasswordResetFlow(getApplicationId(),\n-                        user);\n+                        getUser());\n                 return handleViewable(\"resetpw_email_success\", this);\n             } else {\n                 errorMsg = \"Incorrect Captcha\";",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/c8af2e5fb445f1483327165e6ed93e6fb4d9b3fc/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "53c2578df9a27706f9d1f6e2e3951498567f93a8",
                "blob_url": "https://github.com/apache/usergrid/blob/c8af2e5fb445f1483327165e6ed93e6fb4d9b3fc/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "filename": "stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/usergrid/rest/applications/users/UserResource.java?ref=c8af2e5fb445f1483327165e6ed93e6fb4d9b3fc"
            }
        ],
        "bug_id": "usergrid_44",
        "parent": "https://github.com/apache/usergrid/commit/a72d805d279decd5024daf6e57bacedcd1544f99",
        "message": "Merge pull request #15 from realbeast/resetpw\n\nfixed application user password reset flow NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/8042fab526c637341715de3a063321b32060da80",
        "file": [
            {
                "patch": "@@ -364,7 +364,7 @@ public ServiceResults postItemById(ServiceContext context, UUID id)\n \n \t\tEntity entity = em.get(id);\n \t\tif (entity == null) {\n-\t\t\treturn null;\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tentity = importEntity(context, entity);\n \n@@ -402,6 +402,9 @@ public ServiceResults deleteItemById(ServiceContext context, UUID id)\n \t\t}\n \n \t\tEntity item = em.get(id);\n+\t\tif (item == null) {\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n+\t\t}\n \t\titem = importEntity(context, item);\n \n \t\tem.removeFromCollection(context.getOwner(),\n@@ -425,6 +428,9 @@ public ServiceResults deleteItemByName(ServiceContext context, String name)\n \t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tEntity entity = em.get(ref);\n+\t\tif (entity == null) {\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n+\t\t}\n \t\tentity = importEntity(context, entity);\n \n \t\tcheckPermissionsForEntity(context, entity);",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/8042fab526c637341715de3a063321b32060da80/stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java",
                "status": "modified",
                "changes": 8,
                "deletions": 1,
                "sha": "64701d7234cdf32073ca251444602fac17ea5441",
                "blob_url": "https://github.com/apache/usergrid/blob/8042fab526c637341715de3a063321b32060da80/stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/AbstractCollectionService.java?ref=8042fab526c637341715de3a063321b32060da80"
            },
            {
                "patch": "@@ -295,7 +295,7 @@ public ServiceResults postItemById(ServiceContext context, UUID id)\n \n \t\tEntity entity = em.get(id);\n \t\tif (entity == null) {\n-\t\t\treturn null;\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tentity = importEntity(context, entity);\n \n@@ -331,11 +331,11 @@ public ServiceResults postItemsByQuery(ServiceContext context, Query query)\n \n \t\t\tEntityRef ref = em.getAlias(query.getEntityType(), name);\n \t\t\tif (ref == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tEntity entity = em.get(ref);\n \t\t\tif (entity == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tentity = importEntity(context, entity);\n \n@@ -362,7 +362,7 @@ public ServiceResults deleteItemById(ServiceContext context, UUID id)\n \n \t\tEntity entity = em.get(id);\n \t\tif (entity == null) {\n-\t\t\treturn null;\n+\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t}\n \t\tentity = importEntity(context, entity);\n \n@@ -392,11 +392,11 @@ public ServiceResults deleteItemsByQuery(ServiceContext context, Query query)\n \n \t\t\tEntityRef ref = em.getAlias(query.getEntityType(), name);\n \t\t\tif (ref == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tEntity entity = em.get(ref);\n \t\t\tif (entity == null) {\n-\t\t\t\treturn null;\n+\t\t\t\tthrow new ServiceResourceNotFoundException(context);\n \t\t\t}\n \t\t\tentity = importEntity(context, entity);\n ",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/8042fab526c637341715de3a063321b32060da80/stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java",
                "status": "modified",
                "changes": 12,
                "deletions": 6,
                "sha": "2542fc22fe0be2c58bdfd7f369923dfba7a39b65",
                "blob_url": "https://github.com/apache/usergrid/blob/8042fab526c637341715de3a063321b32060da80/stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/AbstractConnectionsService.java?ref=8042fab526c637341715de3a063321b32060da80"
            },
            {
                "patch": "@@ -294,6 +294,10 @@ public Entity importEntity(ServiceContext context, Entity entity)\n \t@Override\n \tpublic Entity importEntity(ServiceRequest request, Entity entity)\n \t\t\tthrows Exception {\n+\t\tif (entity == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n \t\tif (!isRootService()) {\n \t\t\treturn sm.importEntity(request, entity);\n \t\t}",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/8042fab526c637341715de3a063321b32060da80/stack/services/src/main/java/org/usergrid/services/AbstractService.java",
                "status": "modified",
                "changes": 4,
                "deletions": 0,
                "sha": "1879215e73885b45f41c1105adcabd99c34ec1ac",
                "blob_url": "https://github.com/apache/usergrid/blob/8042fab526c637341715de3a063321b32060da80/stack/services/src/main/java/org/usergrid/services/AbstractService.java",
                "filename": "stack/services/src/main/java/org/usergrid/services/AbstractService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/services/AbstractService.java?ref=8042fab526c637341715de3a063321b32060da80"
            }
        ],
        "bug_id": "usergrid_45",
        "parent": "https://github.com/apache/usergrid/commit/ce78e78f334dd0da507f06ba4f49c42081b4af69",
        "message": "fix npe when entity not found, throw service_resource_not_found instead",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/09151ea0e9dd1f33dceddd6f33ada54389c42fd6",
        "file": [
            {
                "patch": "@@ -59,6 +59,13 @@ protected void configure() {\n         // bind our migration manager\n         bind( MigrationManager.class ).to( MigrationManagerImpl.class );\n \n+\n+\n+        //do multibindings for migrations\n+        Multibinder<Migration> migrationBinding = Multibinder.newSetBinder( binder(), Migration.class );\n+        migrationBinding.addBinding().to( Key.get( MigrationInfoSerialization.class ) );\n+\n+\n         bind( TimeService.class ).to( TimeServiceImpl.class );\n \n         bind( CassandraConfig.class ).to( CassandraConfigImpl.class );\n@@ -71,8 +78,11 @@ protected void configure() {\n \n         bind( DataMigrationManager.class ).to( DataMigrationManagerImpl.class );\n \n+\n+\n         //do multibindings for migrations\n-        Multibinder<Migration> migrationBinding = Multibinder.newSetBinder( binder(), Migration.class );\n-        migrationBinding.addBinding().to( Key.get( MigrationInfoSerialization.class ) );\n+        Multibinder<DataMigrationManager> dataMigrationManagerMultibinder = Multibinder.newSetBinder( binder(), DataMigrationManager.class );\n+//        migrationBinding.addBinding().to( Key.get( MigrationInfoSerialization.class ) );\n+\n     }\n }",
                "additions": 12,
                "raw_url": "https://github.com/apache/usergrid/raw/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java",
                "status": "modified",
                "changes": 14,
                "deletions": 2,
                "sha": "e37067fcfe126b08f02ef7e5f3258871fa7dd86d",
                "blob_url": "https://github.com/apache/usergrid/blob/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java?ref=09151ea0e9dd1f33dceddd6f33ada54389c42fd6"
            },
            {
                "patch": "@@ -41,6 +41,12 @@\n      */\n     public boolean isRunning();\n \n+    /**\n+     * Get the current version of the schema\n+     * @return\n+     */\n+    public int getCurrentVersion();\n+\n \n     /**\n      * Return that last status of the migration",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManager.java",
                "status": "modified",
                "changes": 6,
                "deletions": 0,
                "sha": "3357ed4b7e280f10e3d42110f47f95bad24bab4c",
                "blob_url": "https://github.com/apache/usergrid/blob/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManager.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManager.java?ref=09151ea0e9dd1f33dceddd6f33ada54389c42fd6"
            },
            {
                "patch": "@@ -27,12 +27,18 @@\n import java.util.NavigableMap;\n import java.util.Set;\n import java.util.TreeMap;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import org.apache.usergrid.persistence.core.migration.schema.MigrationException;\n \n+import com.google.common.base.Preconditions;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n import com.google.inject.Inject;\n import com.google.inject.Singleton;\n \n@@ -46,14 +52,33 @@\n \n     private final MigrationInfoSerialization migrationInfoSerialization;\n \n+    /**\n+     * Cache to cache versions temporarily\n+     */\n+    private final LoadingCache<String, Integer> versionCache = CacheBuilder.newBuilder()\n+            //cache the local value for 1 minute\n+            .expireAfterWrite( 1, TimeUnit.MINUTES ).build( new CacheLoader<String, Integer>() {\n+                @Override\n+                public Integer load( final String key ) throws Exception {\n+                    return migrationInfoSerialization.getVersion();\n+                }\n+            } );\n+\n \n     @Inject\n     public DataMigrationManagerImpl( final MigrationInfoSerialization migrationInfoSerialization,\n                                      final Set<DataMigration> migrations ) {\n+        Preconditions.checkNotNull( migrationInfoSerialization, \"migrationInfoSerialization must not be null\" );\n+        Preconditions.checkNotNull( migrations, \"migrations must not be null\" );\n+\n         this.migrationInfoSerialization = migrationInfoSerialization;\n \n+\n+\n         for ( DataMigration migration : migrations ) {\n \n+            Preconditions.checkNotNull( migration, \"A migration instance in the set of migrations was null.  This is not allowed\" );\n+\n             final int version = migration.getVersion();\n \n             final DataMigration existing = migrationTreeMap.get( version );\n@@ -103,7 +128,7 @@ public void migrate() throws MigrationException {\n \n             LOG.info( \"Running migration version {}\", migrationVersion );\n \n-            observer.update( migrationVersion,  \"Starting migration\" );\n+            observer.update( migrationVersion, \"Starting migration\" );\n \n \n             //perform this migration, if it fails, short circuit\n@@ -119,7 +144,7 @@ public void migrate() throws MigrationException {\n             }\n \n             //we had an unhandled exception or the migration failed, short circuit\n-            if(observer.failed){\n+            if ( observer.failed ) {\n                 return;\n             }\n \n@@ -128,13 +153,9 @@ public void migrate() throws MigrationException {\n \n             //update the observer for progress so other nodes can see it\n             observer.update( migrationVersion, \"Completed successfully\" );\n-\n-\n         }\n \n         migrationInfoSerialization.setStatusCode( StatusCode.COMPLETE.status );\n-\n-\n     }\n \n \n@@ -144,6 +165,17 @@ public boolean isRunning() {\n     }\n \n \n+    @Override\n+    public int getCurrentVersion() {\n+        try {\n+            return versionCache.get( \"currentVersion\" );\n+        }\n+        catch ( ExecutionException e ) {\n+            throw new DataMigrationException( \"Unable to get current version\", e );\n+        }\n+    }\n+\n+\n     @Override\n     public String getLastStatus() {\n         return migrationInfoSerialization.getStatusMessage();\n@@ -153,10 +185,10 @@ public String getLastStatus() {\n     /**\n      * Different status enums\n      */\n-    public enum StatusCode{\n-        COMPLETE(1),\n-        RUNNING(2),\n-        ERROR(3);\n+    public enum StatusCode {\n+        COMPLETE( 1 ),\n+        RUNNING( 2 ),\n+        ERROR( 3 );\n \n         public final int status;\n \n@@ -170,14 +202,13 @@ public String getLastStatus() {\n         private boolean failed = false;\n \n \n-\n         @Override\n         public void failed( final int migrationVersion, final String reason ) {\n \n-            final String storedMessage = String.format( \"Failed to migrate, reason is appended.  Error '%s'\", reason);\n+            final String storedMessage = String.format( \"Failed to migrate, reason is appended.  Error '%s'\", reason );\n \n \n-            update(migrationVersion,  storedMessage );\n+            update( migrationVersion, storedMessage );\n \n             LOG.error( storedMessage );\n \n@@ -193,9 +224,10 @@ public void failed( final int migrationVersion, final String reason, final Throw\n             throwable.printStackTrace( new PrintWriter( stackTrace ) );\n \n \n-            final String storedMessage = String.format( \"Failed to migrate, reason is appended.  Error '%s' %s\", reason, stackTrace.toString() );\n+            final String storedMessage = String.format( \"Failed to migrate, reason is appended.  Error '%s' %s\", reason,\n+                    stackTrace.toString() );\n \n-            update(migrationVersion,  storedMessage );\n+            update( migrationVersion, storedMessage );\n \n \n             LOG.error( \"Unable to migrate version {} due to reason {}.\", migrationVersion, reason, throwable );\n@@ -208,15 +240,14 @@ public void failed( final int migrationVersion, final String reason, final Throw\n \n         @Override\n         public void update( final int migrationVersion, final String message ) {\n-            final String error = String.format( \"Migration version %d.  %s\", migrationVersion, message);\n+            final String error = String.format( \"Migration version %d.  %s\", migrationVersion, message );\n \n             migrationInfoSerialization.setStatusMessage( error );\n         }\n \n \n         /**\n          * Return true if we failed\n-         * @return\n          */\n         public boolean isFailed() {\n             return failed;",
                "additions": 48,
                "raw_url": "https://github.com/apache/usergrid/raw/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManagerImpl.java",
                "status": "modified",
                "changes": 65,
                "deletions": 17,
                "sha": "4cc98df583fb68dc2caed929ef15c07f8aac90e2",
                "blob_url": "https://github.com/apache/usergrid/blob/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManagerImpl.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/migration/data/DataMigrationManagerImpl.java?ref=09151ea0e9dd1f33dceddd6f33ada54389c42fd6"
            },
            {
                "patch": "@@ -27,6 +27,7 @@\n import org.apache.usergrid.persistence.core.guice.CurrentImpl;\n import org.apache.usergrid.persistence.core.guice.PreviousImpl;\n import org.apache.usergrid.persistence.core.guice.ProxyImpl;\n+import org.apache.usergrid.persistence.core.migration.data.DataMigrationManager;\n import org.apache.usergrid.persistence.core.migration.schema.Migration;\n import org.apache.usergrid.persistence.core.task.NamedTaskExecutorImpl;\n import org.apache.usergrid.persistence.core.task.TaskExecutor;\n@@ -157,6 +158,15 @@ protected void configure() {\n         //Get the old version and the new one\n         migrationBinding.addBinding().to( Key.get( EdgeMetadataSerialization.class, PreviousImpl.class) );\n         migrationBinding.addBinding().to( Key.get( EdgeMetadataSerialization.class, CurrentImpl.class  ) );\n+\n+\n+        /**\n+         * Migrations of our edge meta serialization\n+         */\n+\n+        bind(EdgeMetadataSerialization.class).annotatedWith( PreviousImpl.class ).to( EdgeMetadataSerializationV1Impl.class  );\n+        bind(EdgeMetadataSerialization.class).annotatedWith( CurrentImpl.class ).to( EdgeMetadataSerializationV2Impl.class  );\n+        bind(EdgeMetadataSerialization.class).annotatedWith( ProxyImpl.class ).to( EdgeMetadataSerializationProxyImpl.class  );\n     }\n \n \n@@ -170,36 +180,6 @@ public TaskExecutor graphTaskExecutor( final GraphFig graphFig ) {\n     }\n \n \n-    @Inject\n-    @Singleton\n-    @Provides\n-    @PreviousImpl\n-    public EdgeMetadataSerialization getPreviousEdgeMetaSerialization( final Keyspace keyspace,\n-                                                                       final CassandraConfig cassandraConfig,\n-                                                                       final GraphFig graphFig ) {\n-        return new EdgeMetadataSerializationV1Impl( keyspace, cassandraConfig, graphFig );\n-    }\n-\n-\n-    @Inject\n-    @Singleton\n-    @Provides\n-    @CurrentImpl\n-    public EdgeMetadataSerialization getCurrentEdgeMetaSerialization( final Keyspace keyspace,\n-                                                                      final CassandraConfig cassandraConfig,\n-                                                                      final GraphFig graphFig ) {\n-        return new EdgeMetadataSerializationV2Impl( keyspace, cassandraConfig, graphFig );\n-    }\n-\n-\n-    @Inject\n-    @Singleton\n-    @Provides\n-    @ProxyImpl\n-    public EdgeMetadataSerialization getCurrentEdgeMetaSerialization( @PreviousImpl final EdgeMetadataSerialization previous,\n-                                                   @CurrentImpl final EdgeMetadataSerialization current ) {\n-       return new EdgeMetadataSerializationProxyImpl( previous, current );\n-    }\n }\n \n ",
                "additions": 10,
                "raw_url": "https://github.com/apache/usergrid/raw/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/guice/GraphModule.java",
                "status": "modified",
                "changes": 40,
                "deletions": 30,
                "sha": "dee53d458bd9b7263aad86461968d6fdcbb55ec6",
                "blob_url": "https://github.com/apache/usergrid/blob/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/guice/GraphModule.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/guice/GraphModule.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/guice/GraphModule.java?ref=09151ea0e9dd1f33dceddd6f33ada54389c42fd6"
            },
            {
                "patch": "@@ -92,9 +92,11 @@\n     @Inject\n     public GraphManagerImpl( @ProxyImpl final EdgeMetadataSerialization edgeMetadataSerialization,\n                              final EdgeSerialization storageEdgeSerialization,\n-                             final NodeSerialization nodeSerialization, final GraphFig graphFig,\n-                             @Assisted final ApplicationScope scope, final EdgeDeleteListener edgeDeleteListener,\n-                             final NodeDeleteListener nodeDeleteListener ) {\n+                             final NodeSerialization nodeSerialization,\n+                             final GraphFig graphFig,\n+                             final EdgeDeleteListener edgeDeleteListener,\n+                             final NodeDeleteListener nodeDeleteListener,\n+                             @Assisted final ApplicationScope scope) {\n \n \n         ValidationUtils.validateApplicationScope( scope );\n@@ -103,6 +105,7 @@ public GraphManagerImpl( @ProxyImpl final EdgeMetadataSerialization edgeMetadata\n         Preconditions.checkNotNull( nodeSerialization, \"nodeSerialization must not be null\" );\n         Preconditions.checkNotNull( graphFig, \"consistencyFig must not be null\" );\n         Preconditions.checkNotNull( scope, \"scope must not be null\" );\n+        Preconditions.checkNotNull( nodeDeleteListener, \"nodeDeleteListener must not be null\" );\n \n         this.scope = scope;\n         this.edgeMetadataSerialization = edgeMetadataSerialization;",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java",
                "status": "modified",
                "changes": 9,
                "deletions": 3,
                "sha": "df10816df2781107daa9924a28edf72980de1e19",
                "blob_url": "https://github.com/apache/usergrid/blob/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java?ref=09151ea0e9dd1f33dceddd6f33ada54389c42fd6"
            },
            {
                "patch": "@@ -23,11 +23,13 @@\n \n \n import java.util.Collection;\n+import java.util.Collections;\n import java.util.Iterator;\n \n import org.apache.usergrid.persistence.core.astyanax.MultiTennantColumnFamilyDefinition;\n import org.apache.usergrid.persistence.core.guice.CurrentImpl;\n import org.apache.usergrid.persistence.core.guice.PreviousImpl;\n+import org.apache.usergrid.persistence.core.migration.data.DataMigrationManager;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.SearchEdgeType;\n@@ -37,111 +39,238 @@\n \n import com.google.inject.Inject;\n import com.google.inject.Singleton;\n+import com.netflix.astyanax.Keyspace;\n import com.netflix.astyanax.MutationBatch;\n \n \n @Singleton\n public class EdgeMetadataSerializationProxyImpl implements EdgeMetadataSerialization {\n \n-    private EdgeMetadataSerialization previous;\n-    private EdgeMetadataSerialization current;\n+    private static final int MIGRATION_VERSION = 1;\n+\n+    private final DataMigrationManager dataMigrationManager;\n+    private final Keyspace keyspace;\n+    private final EdgeMetadataSerialization previous;\n+    private final EdgeMetadataSerialization current;\n \n \n     /**\n-     * TODO fin\n+     * Handles routing data to the right implementation, based on the current system migration version\n      */\n     @Inject\n-    public EdgeMetadataSerializationProxyImpl( @PreviousImpl final EdgeMetadataSerialization previous,\n+    public EdgeMetadataSerializationProxyImpl( final DataMigrationManager dataMigrationManager, final Keyspace keyspace,\n+                                               @PreviousImpl final EdgeMetadataSerialization previous,\n                                                @CurrentImpl final EdgeMetadataSerialization current ) {\n+        this.dataMigrationManager = dataMigrationManager;\n+        this.keyspace = keyspace;\n         this.previous = previous;\n         this.current = current;\n     }\n \n \n     @Override\n     public MutationBatch writeEdge( final ApplicationScope scope, final Edge edge ) {\n-        return null;\n+\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.writeEdge( scope, edge ) );\n+            aggregateBatch.mergeShallow( current.writeEdge( scope, edge ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.writeEdge( scope, edge );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeFromSource( final ApplicationScope scope, final Edge edge ) {\n-        return null;\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeEdgeTypeFromSource( scope, edge ) );\n+            aggregateBatch.mergeShallow( current.removeEdgeTypeFromSource( scope, edge ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeEdgeTypeFromSource( scope, edge );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeFromSource( final ApplicationScope scope, final Id sourceNode, final String type,\n                                                    final long timestamp ) {\n-        return null;\n+\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeEdgeTypeFromSource( scope, sourceNode, type, timestamp ) );\n+            aggregateBatch.mergeShallow( current.removeEdgeTypeFromSource( scope, sourceNode, type, timestamp ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeEdgeTypeFromSource( scope, sourceNode, type, timestamp );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeFromSource( final ApplicationScope scope, final Edge edge ) {\n-        return null;\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeIdTypeFromSource( scope, edge ) );\n+            aggregateBatch.mergeShallow( current.removeIdTypeFromSource( scope, edge ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeIdTypeFromSource( scope, edge );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeFromSource( final ApplicationScope scope, final Id sourceNode, final String type,\n                                                  final String idType, final long timestamp ) {\n-        return null;\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch\n+                    .mergeShallow( previous.removeIdTypeFromSource( scope, sourceNode, type, idType, timestamp ) );\n+            aggregateBatch.mergeShallow( current.removeIdTypeFromSource( scope, sourceNode, type, idType, timestamp ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeIdTypeFromSource( scope, sourceNode, type, idType, timestamp );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeToTarget( final ApplicationScope scope, final Edge edge ) {\n-        return null;\n+\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeEdgeTypeToTarget( scope, edge ) );\n+            aggregateBatch.mergeShallow( current.removeEdgeTypeToTarget( scope, edge ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeEdgeTypeToTarget( scope, edge );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeToTarget( final ApplicationScope scope, final Id targetNode, final String type,\n                                                  final long timestamp ) {\n-        return null;\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeEdgeTypeToTarget( scope, targetNode, type, timestamp ) );\n+            aggregateBatch.mergeShallow( current.removeEdgeTypeToTarget( scope, targetNode, type, timestamp ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeEdgeTypeToTarget( scope, targetNode, type, timestamp );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeToTarget( final ApplicationScope scope, final Edge edge ) {\n-        return null;\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeIdTypeFromSource( scope, edge ) );\n+            aggregateBatch.mergeShallow( current.removeIdTypeFromSource( scope, edge ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeIdTypeFromSource( scope, edge );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeToTarget( final ApplicationScope scope, final Id targetNode, final String type,\n                                                final String idType, final long timestamp ) {\n-        return null;\n+\n+\n+        if ( isOldVersion() ) {\n+            final MutationBatch aggregateBatch = keyspace.prepareMutationBatch();\n+\n+            aggregateBatch.mergeShallow( previous.removeIdTypeToTarget( scope, targetNode, type, idType, timestamp ) );\n+            aggregateBatch.mergeShallow( current.removeIdTypeToTarget( scope, targetNode, type, idType, timestamp ) );\n+\n+            return aggregateBatch;\n+        }\n+\n+        return current.removeIdTypeToTarget( scope, targetNode, type, idType, timestamp );\n     }\n \n \n     @Override\n     public Iterator<String> getEdgeTypesFromSource( final ApplicationScope scope, final SearchEdgeType search ) {\n-        return null;\n+        if ( isOldVersion() ) {\n+            return previous.getEdgeTypesFromSource( scope, search );\n+        }\n+\n+        return current.getEdgeTypesFromSource( scope, search );\n     }\n \n \n     @Override\n     public Iterator<String> getIdTypesFromSource( final ApplicationScope scope, final SearchIdType search ) {\n-        return null;\n+        if ( isOldVersion() ) {\n+            return previous.getIdTypesFromSource( scope, search );\n+        }\n+\n+        return current.getIdTypesFromSource( scope, search );\n     }\n \n \n     @Override\n     public Iterator<String> getEdgeTypesToTarget( final ApplicationScope scope, final SearchEdgeType search ) {\n-        return null;\n+        if ( isOldVersion() ) {\n+            return previous.getEdgeTypesToTarget( scope, search );\n+        }\n+\n+        return current.getEdgeTypesToTarget( scope, search );\n     }\n \n \n     @Override\n     public Iterator<String> getIdTypesToTarget( final ApplicationScope scope, final SearchIdType search ) {\n-        return null;\n+        if ( isOldVersion() ) {\n+            return previous.getIdTypesToTarget( scope, search );\n+        }\n+\n+        return current.getIdTypesToTarget( scope, search );\n     }\n \n \n     @Override\n     public Collection<MultiTennantColumnFamilyDefinition> getColumnFamilies() {\n-        return null;\n+        return Collections.EMPTY_LIST;\n+    }\n+\n+\n+    /**\n+     * Return true if we're on an old version\n+     */\n+    private boolean isOldVersion() {\n+        return dataMigrationManager.getCurrentVersion() < MIGRATION_VERSION;\n     }\n }",
                "additions": 147,
                "raw_url": "https://github.com/apache/usergrid/raw/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationProxyImpl.java",
                "status": "modified",
                "changes": 165,
                "deletions": 18,
                "sha": "cc5134937469f80048f4993da99c6b3de9bfa647",
                "blob_url": "https://github.com/apache/usergrid/blob/09151ea0e9dd1f33dceddd6f33ada54389c42fd6/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationProxyImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationProxyImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationProxyImpl.java?ref=09151ea0e9dd1f33dceddd6f33ada54389c42fd6"
            }
        ],
        "bug_id": "usergrid_46",
        "parent": "https://github.com/apache/usergrid/commit/dfed6a025a7fcb4c49decb4b3cf8bee37abeb1e7",
        "message": "Cleaned up some code.  Need to remove Jukito or disable auto proxying.  Incorrect proxy wiring is causing NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/f564f0d94f574f6e943346ed82502b080ceb0268",
        "file": [
            {
                "patch": "@@ -116,4 +116,11 @@\n     public void setProperty( String name, String value );\n \n     public Properties getMailProperties();\n+    public SuperUser getSuperUser();\n+    public static interface SuperUser{\n+       boolean isEnabled();\n+        String getUsername();\n+        String getEmail();\n+        String getPassword();\n+    }\n }",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/f564f0d94f574f6e943346ed82502b080ceb0268/stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java",
                "status": "modified",
                "changes": 7,
                "deletions": 0,
                "sha": "6ed892b8ddbe14221bf4302e31c08b27c5497a5a",
                "blob_url": "https://github.com/apache/usergrid/blob/f564f0d94f574f6e943346ed82502b080ceb0268/stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/AccountCreationProps.java?ref=f564f0d94f574f6e943346ed82502b080ceb0268"
            },
            {
                "patch": "@@ -26,16 +26,18 @@\n import static java.lang.Boolean.parseBoolean;\n \n import static org.apache.commons.lang.StringUtils.isBlank;\n+import static org.usergrid.utils.ListUtils.anyNull;\n \n \n public class AccountCreationPropsImpl implements AccountCreationProps {\n     private static final Logger logger = LoggerFactory.getLogger( AccountCreationPropsImpl.class );\n \n-    protected Properties properties;\n-\n+    protected final Properties properties;\n+    private final SuperUser superUser;\n \n     public AccountCreationPropsImpl( Properties properties ) {\n         this.properties = properties;\n+        this.superUser = new SuperUserImpl(properties);\n     }\n \n \n@@ -109,4 +111,48 @@ public Properties getMailProperties() {\n         }\n         return p;\n     }\n+\n+    @Override\n+    public SuperUser getSuperUser() {\n+        return superUser;\n+    }\n+\n+    protected static class SuperUserImpl implements SuperUser {\n+        private final boolean enabled;\n+        private final String username;\n+        private final String email;\n+        private final String password;\n+\n+        public SuperUserImpl(Properties properties) {\n+            enabled = parseBoolean(properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_ALLOWED));\n+            username = properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_NAME);\n+            email = properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_EMAIL);\n+            password = properties.getProperty(PROPERTIES_SYSADMIN_LOGIN_PASSWORD);\n+        }\n+\n+        @Override\n+        public boolean isEnabled() {\n+            return superuserEnabled();\n+        }\n+\n+        @Override\n+        public String getUsername() {\n+            return username;\n+        }\n+\n+        @Override\n+        public String getEmail() {\n+            return email;\n+        }\n+\n+        @Override\n+        public String getPassword() {\n+            return password;\n+        }\n+\n+        private boolean superuserEnabled() {\n+            return enabled && !anyNull(username, email, password);\n+        }\n+    }\n+\n }",
                "additions": 48,
                "raw_url": "https://github.com/apache/usergrid/raw/f564f0d94f574f6e943346ed82502b080ceb0268/stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java",
                "status": "modified",
                "changes": 50,
                "deletions": 2,
                "sha": "06c809a2215e6a8639dbd7e2aa75f2ca19be8a09",
                "blob_url": "https://github.com/apache/usergrid/blob/f564f0d94f574f6e943346ed82502b080ceb0268/stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/AccountCreationPropsImpl.java?ref=f564f0d94f574f6e943346ed82502b080ceb0268"
            },
            {
                "patch": "@@ -129,10 +129,7 @@\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_ORGANIZATION_ACTIVATION_URL;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_SETUP_TEST_ACCOUNT;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_EMAIL;\n-import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_ALLOWED;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_EMAIL;\n-import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_NAME;\n-import static org.usergrid.management.AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_PASSWORD;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_TEST_ACCOUNT_ADMIN_USER_EMAIL;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_TEST_ACCOUNT_ADMIN_USER_NAME;\n import static org.usergrid.management.AccountCreationProps.PROPERTIES_TEST_ACCOUNT_ADMIN_USER_PASSWORD;\n@@ -321,37 +318,25 @@ public void setup() throws Exception {\n             logger.warn( \"Test app creation disabled\" );\n         }\n \n-        if ( superuserEnabled() ) {\n+        if ( properties.getSuperUser().isEnabled() ) {\n             provisionSuperuser();\n         }\n     }\n \n \n-    public boolean superuserEnabled() {\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n-        String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n-        String superuser_email = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL );\n-        String superuser_password = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_PASSWORD );\n-\n-        return superuser_enabled && !anyNull( superuser_username, superuser_email, superuser_password );\n-    }\n \n \n     @Override\n     public void provisionSuperuser() throws Exception {\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n-        String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n-        String superuser_email = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL );\n-        String superuser_password = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_PASSWORD );\n-\n-        if ( !anyNull( superuser_username, superuser_email, superuser_password ) ) {\n-            UserInfo user = this.getAdminUserByUsername( superuser_username );\n+        final AccountCreationProps.SuperUser superUser = properties.getSuperUser();\n+        if ( superUser.isEnabled() ) {\n+            UserInfo user = this.getAdminUserByUsername( superUser.getUsername() );\n             if ( user == null ) {\n-                createAdminUser( superuser_username, \"Super User\", superuser_email, superuser_password,\n-                        superuser_enabled, !superuser_enabled );\n+                createAdminUser( superUser.getUsername(), \"Super User\", superUser.getEmail(), superUser.getPassword(),\n+                        superUser.isEnabled(), !superUser.isEnabled() );\n             }\n             else {\n-                this.setAdminUserPassword( user.getUuid(), superuser_password );\n+                this.setAdminUserPassword( user.getUuid(), superUser.getPassword() );\n             }\n         }\n         else {\n@@ -1246,13 +1231,12 @@ public UserInfo verifyAdminUserPasswordCredentials( String name, String password\n         if ( verify( MANAGEMENT_APPLICATION_ID, user.getUuid(), password ) ) {\n             userInfo = getUserInfo( MANAGEMENT_APPLICATION_ID, user );\n \n-            boolean userIsSuperAdmin =\n-                    properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL ).equals( userInfo.getEmail() );\n+            boolean userIsSuperAdmin = properties.getSuperUser().isEnabled() && properties.getSuperUser().getEmail().equals(userInfo.getEmail());\n \n             boolean testUserEnabled = parseBoolean( properties.getProperty( PROPERTIES_SETUP_TEST_ACCOUNT ) );\n \n             boolean userIsTestUser = !testUserEnabled ? false :\n-                                     properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_EMAIL )\n+                                     properties.getProperty( PROPERTIES_TEST_ACCOUNT_ADMIN_USER_EMAIL )\n                                                .equals( userInfo.getEmail() );\n \n             if ( !userIsSuperAdmin && !userIsTestUser ) {\n@@ -1488,10 +1472,8 @@ public Long getLastAdminPasswordChange( UUID userId ) throws Exception {\n         json.put( \"organizations\", jsonOrganizations );\n \n         Map<UUID, String> organizations;\n-\n-        boolean superuser_enabled = parseBoolean( properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_ALLOWED ) );\n-        String superuser_username = properties.getProperty( PROPERTIES_SYSADMIN_LOGIN_NAME );\n-        if ( superuser_enabled && ( superuser_username != null ) && superuser_username.equals( user.getUsername() ) ) {\n+        AccountCreationProps.SuperUser superUser = properties.getSuperUser();\n+        if ( superUser.isEnabled() && superUser.getUsername().equals( user.getUsername() ) ) {\n             organizations = buildOrgBiMap( getOrganizations( null, 10 ) );\n         }\n         else {",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/f564f0d94f574f6e943346ed82502b080ceb0268/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "status": "modified",
                "changes": 40,
                "deletions": 29,
                "sha": "429491b02c12988fc12cae07ac3fc0684bd060fe",
                "blob_url": "https://github.com/apache/usergrid/blob/f564f0d94f574f6e943346ed82502b080ceb0268/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "filename": "stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/usergrid/management/cassandra/ManagementServiceImpl.java?ref=f564f0d94f574f6e943346ed82502b080ceb0268"
            }
        ],
        "bug_id": "usergrid_47",
        "parent": "https://github.com/apache/usergrid/commit/2929f6008f84cb215bd22fb8bd6b1547c7b294f6",
        "message": "Merge pull request #48 from stliu/USERGRID-77\n\nUSERGRID-77 can't login for newly created user due to NPE",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/722c43b731a80c810916a09af8e50c19ac7c6891",
        "file": [
            {
                "patch": "@@ -16,6 +16,7 @@\n package org.apache.usergrid.corepersistence;\n \n \n+import com.google.common.base.Preconditions;\n import com.netflix.hystrix.exception.HystrixRuntimeException;\n import com.yammer.metrics.annotation.Metered;\n import static java.lang.String.CASE_INSENSITIVE_ORDER;\n@@ -191,6 +192,9 @@ public CpEntityManager() {}\n     @Override\n     public void init( EntityManagerFactory emf, UUID applicationId ) {\n \n+        Preconditions.checkNotNull(emf, \"emf must not be null\");\n+        Preconditions.checkNotNull( applicationId, \"applicationId must not be null\"  );\n+\n         this.emf = ( CpEntityManagerFactory ) emf;\n         this.managerCache = this.emf.getManagerCache();\n         this.applicationId = applicationId;\n@@ -202,9 +206,6 @@ public void init( EntityManagerFactory emf, UUID applicationId ) {\n \n         // set to false for now\n         this.skipAggregateCounters = false;\n-\n-\n-        applicationScope = this.emf.getApplicationScope( applicationId );\n     }\n \n \n@@ -643,11 +644,11 @@ public Results searchCollection( EntityRef entityRef, String collectionName, Que\n         return getRelationManager( entityRef ).searchCollection( collectionName, query );\n     }\n \n-\n-    @Override\n-    public void setApplicationId( UUID applicationId ) {\n-        this.applicationId = applicationId;\n-    }\n+//\n+//    @Override\n+//    public void setApplicationId( UUID applicationId ) {\n+//        this.applicationId = applicationId;\n+//    }\n \n \n     @Override\n@@ -2884,7 +2885,8 @@ public void visitCollectionEntry(\n                 }\n                 catch(WriteOptimisticVerifyException wo ){\n                     //swallow this, it just means this was already updated, which accomplishes our task.  Just ignore.\n-                    logger.warn( \"Someone beat us to updating entity {} in collection {}.  Ignoring.\", entity.getName(), collName );\n+                    logger.warn( \"Someone beat us to updating entity {} in collection {}.  Ignoring.\", entity.getName(),\n+                            collName );\n                 }\n                 catch (Exception ex) {\n                     logger.error(\"Error repersisting entity\", ex);",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/722c43b731a80c810916a09af8e50c19ac7c6891/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "status": "modified",
                "changes": 20,
                "deletions": 9,
                "sha": "751b9e27dd6d4cf1e0b1761ba5aeeb7ce748e3db",
                "blob_url": "https://github.com/apache/usergrid/blob/722c43b731a80c810916a09af8e50c19ac7c6891/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java?ref=722c43b731a80c810916a09af8e50c19ac7c6891"
            },
            {
                "patch": "@@ -41,7 +41,7 @@\n  */\n public interface EntityManager {\n \n-    public void setApplicationId( UUID applicationId );\n+//    public void setApplicationId( UUID applicationId );\n \n     public GeoIndexManager getGeoIndexManager();\n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/722c43b731a80c810916a09af8e50c19ac7c6891/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "cd927299733b4d981b54bb96b3abf6f884beb2c2",
                "blob_url": "https://github.com/apache/usergrid/blob/722c43b731a80c810916a09af8e50c19ac7c6891/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java?ref=722c43b731a80c810916a09af8e50c19ac7c6891"
            },
            {
                "patch": "@@ -26,7 +26,6 @@\n \n import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n import org.elasticsearch.action.admin.indices.delete.DeleteIndexResponse;\n-import org.elasticsearch.action.admin.indices.refresh.RefreshResponse;\n import org.elasticsearch.action.admin.indices.template.put.PutIndexTemplateResponse;\n import org.elasticsearch.action.search.SearchRequestBuilder;\n import org.elasticsearch.action.search.SearchResponse;\n@@ -36,7 +35,9 @@\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.XContentFactory;\n import org.elasticsearch.index.query.FilterBuilder;\n+import org.elasticsearch.index.query.MatchAllQueryBuilder;\n import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n import org.elasticsearch.indices.IndexAlreadyExistsException;\n import org.elasticsearch.indices.IndexMissingException;\n import org.elasticsearch.search.SearchHit;\n@@ -58,7 +59,9 @@\n import org.apache.usergrid.persistence.index.query.Query;\n import org.apache.usergrid.persistence.model.entity.Id;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n+import org.apache.usergrid.persistence.model.util.UUIDGenerator;\n \n+import com.google.common.collect.ImmutableMap;\n import com.google.inject.Inject;\n import com.google.inject.assistedinject.Assisted;\n \n@@ -88,11 +91,18 @@\n \n     private final IndexFig config;\n \n-    //number of times to wait for the index to refresh propertly. Is an N+1, so 9 = 10\n-    private static final int MAX_WAITS = 9;\n+    //number of times to wait for the index to refresh properly.\n+    private static final int MAX_WAITS = 10;\n     //number of milliseconds to try again before sleeping\n     private static final int WAIT_TIME = 250;\n \n+    private static final String VERIFY_TYPE = \"verification\";\n+\n+    private static final ImmutableMap<String, Object> DEFAULT_PAYLOAD =\n+            ImmutableMap.<String, Object>of( \"field\", \"test\" );\n+\n+    private static final MatchAllQueryBuilder MATCH_ALL_QUERY_BUILDER = QueryBuilders.matchAllQuery();\n+\n \n     @Inject\n     public EsEntityIndexImpl( @Assisted final ApplicationScope appScope, final IndexFig config,\n@@ -120,21 +130,16 @@ public void initializeIndex() {\n             CreateIndexResponse cir = admin.indices().prepareCreate( indexName ).execute().actionGet();\n             log.info( \"Created new Index Name [{}] ACK=[{}]\", indexName, cir.isAcknowledged() );\n \n-            RefreshResponse response;\n-\n-            do {\n-                response = admin.indices().prepareRefresh( indexName ).execute().actionGet();\n-            }\n-            while ( response.getFailedShards() != 0 );\n \n+            //create the document, this ensures the index is ready\n             /**\n-             * Immediately refresh to ensure the entire cluster is ready to receive this write.  Occasionally we see\n+             * Immediately create a document and remove it to ensure the entire cluster is ready to receive documents\n+             * .  Occasionally we see\n              * errors.  See this post.\n-             * http://elasticsearch-users.115913.n3.nabble\n-             * .com/IndexMissingException-on-create-index-followed-by-refresh-td1832793.html\n+             * http://elasticsearch-users.115913.n3.nabble.com/IndexMissingException-on-create-index-followed-by-refresh-td1832793.html\n              *\n              */\n-            refresh();\n+            testNewIndex();\n         }\n         catch ( IndexAlreadyExistsException expected ) {\n             // this is expected to happen if index already exists, it's a no-op and swallow\n@@ -145,6 +150,44 @@ public void initializeIndex() {\n     }\n \n \n+    /**\n+     * Tests writing a document to a new index to ensure it's working correctly.  Comes from email\n+     *\n+     * http://elasticsearch-users.115913.n3.nabble\n+     * .com/IndexMissingException-on-create-index-followed-by-refresh-td1832793.html\n+     */\n+\n+    private void testNewIndex() {\n+\n+\n+        log.info( \"Refreshing Created new Index Name [{}]\", indexName );\n+\n+        final RetryOperation retryOperation = new RetryOperation() {\n+            @Override\n+            public boolean doOp() {\n+                final String tempId = UUIDGenerator.newTimeUUID().toString();\n+\n+\n+                client.prepareIndex( indexName, VERIFY_TYPE, tempId ).setSource( DEFAULT_PAYLOAD ).get();\n+\n+                log.info( \"Successfully created new document with docId {} in index {} and type {}\", tempId, indexName,\n+                        VERIFY_TYPE );\n+\n+                //delete all types, this way if we miss one it will get cleaned up\n+\n+                client.prepareDeleteByQuery( indexName ).setTypes( VERIFY_TYPE ).setQuery( MATCH_ALL_QUERY_BUILDER )\n+                      .get();\n+\n+                log.info( \"Successfully deleted all documents in index {} and type {}\", indexName, VERIFY_TYPE );\n+\n+                return true;\n+            }\n+        };\n+\n+        doInRetry( retryOperation );\n+    }\n+\n+\n     /**\n      * Setup ElasticSearch type mappings as a template that applies to all new indexes. Applies to all indexes that\n      * start with our prefix.\n@@ -277,30 +320,22 @@ public void refresh() {\n \n         log.info( \"Refreshing Created new Index Name [{}]\", indexName );\n \n-        //now try to refresh, to ensure that it's recognized by everyone.  Occasionally we can get a success\n-        //before we can write.\n-        for ( int i = 0; i < MAX_WAITS; i++ ) {\n-            try {\n-                client.admin().indices().prepareRefresh( indexName ).execute().actionGet();\n-                log.debug( \"Refreshed index: \" + indexName );\n-                return;\n-            }\n-            catch ( IndexMissingException e ) {\n-                log.error( \"Unable to refresh index after create. Waiting before sleeping.\", e );\n-            }\n-\n-            try {\n-                Thread.sleep( WAIT_TIME );\n-            }\n-            catch ( InterruptedException e ) {\n-                //swallow it\n+        final RetryOperation retryOperation = new RetryOperation() {\n+            @Override\n+            public boolean doOp() {\n+                try {\n+                    client.admin().indices().prepareRefresh( indexName ).execute().actionGet();\n+                    log.debug( \"Refreshed index: \" + indexName );\n+                    return true;\n+                }\n+                catch ( IndexMissingException e ) {\n+                    log.error( \"Unable to refresh index after create. Waiting before sleeping.\", e );\n+                    throw e;\n+                }\n             }\n-        }\n+        };\n \n-        /**\n-         * Try the refresh one last time if we get here\n-         */\n-        client.admin().indices().prepareRefresh( indexName ).execute().actionGet();\n+        doInRetry( retryOperation );\n \n         log.debug( \"Refreshed index: \" + indexName );\n     }\n@@ -328,4 +363,43 @@ public void deleteIndex() {\n             log.info( \"Failed to delete index \" + indexName );\n         }\n     }\n+\n+\n+    /**\n+     * Do the retry operation\n+     * @param operation\n+     */\n+    private void doInRetry( final RetryOperation operation ) {\n+        for ( int i = 0; i < MAX_WAITS; i++ ) {\n+\n+            try {\n+                if(operation.doOp()){\n+                    return;\n+                }\n+            }\n+            catch ( Exception e ) {\n+                log.error( \"Unable to execute operation, retrying\", e );\n+            }\n+\n+\n+            try {\n+                Thread.sleep( WAIT_TIME );\n+            }\n+            catch ( InterruptedException e ) {\n+                //swallow it\n+            }\n+        }\n+    }\n+\n+\n+    /**\n+     * Interface for operations\n+     */\n+    private static interface RetryOperation {\n+\n+        /**\n+         * Return true if done, false if there should be a retry\n+         */\n+        public boolean doOp();\n+    }\n }",
                "additions": 109,
                "raw_url": "https://github.com/apache/usergrid/raw/722c43b731a80c810916a09af8e50c19ac7c6891/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "status": "modified",
                "changes": 144,
                "deletions": 35,
                "sha": "7584386ec84b2f9d1d5f3769f5c518741a0a88b8",
                "blob_url": "https://github.com/apache/usergrid/blob/722c43b731a80c810916a09af8e50c19ac7c6891/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java?ref=722c43b731a80c810916a09af8e50c19ac7c6891"
            }
        ],
        "bug_id": "usergrid_48",
        "parent": "https://github.com/apache/usergrid/commit/83200bf52f276c89f4351cf6fc8988414646507a",
        "message": "Added verification to init to catch NPE issues\n\nUpdated index creation to write a document and delete to verify correct functionality",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/7fdba4a2cfa6d18047b5b893382806a342a78eff",
        "file": [
            {
                "patch": "@@ -35,6 +35,7 @@\n     OAUTH2_UNSUPPORTED_GRANT_TYPE( \"unsupported_grant_type\", \"Unable to authenticate (OAuth)\" ), //\n     OAUTH2_INVALID_SCOPE( \"invalid_scope\", \"Unable to authenticate (OAuth\" ), //\n     INVALID_AUTH_ERROR( \"auth_invalid\", \"Unable to authenticate\" ), //\n+    INVALID_CLIENT_CREDENTIALS_ERROR( \"auth_invalid_credentials\", \"Unable to authenticate due to invalid client credentials\" ),\n     MISSING_CREDENTIALS_ERROR( \"auth_missing_credentials\", \"Unable to authenticate due to missing credentials\" ), //\n     BAD_CREDENTIALS_SYNTAX_ERROR( \"auth_bad_credentials_syntax\",\n             \"Unable to authenticate due to improperly constructed credentials\" ), //",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/AuthErrorInfo.java",
                "status": "modified",
                "changes": 1,
                "deletions": 0,
                "sha": "4d1d1383f3d3331abb0945739845c7a27d9d9440",
                "blob_url": "https://github.com/apache/usergrid/blob/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/AuthErrorInfo.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/AuthErrorInfo.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/AuthErrorInfo.java?ref=7fdba4a2cfa6d18047b5b893382806a342a78eff"
            },
            {
                "patch": "@@ -18,6 +18,9 @@\n \n \n import org.apache.shiro.codec.Base64;\n+import org.apache.shiro.subject.Subject;\n+import org.apache.usergrid.security.shiro.PrincipalCredentialsToken;\n+import org.apache.usergrid.security.shiro.utils.SubjectUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -28,6 +31,8 @@\n import java.security.Principal;\n import java.util.Map;\n \n+import static org.apache.usergrid.rest.exceptions.AuthErrorInfo.INVALID_CLIENT_CREDENTIALS_ERROR;\n+import static org.apache.usergrid.rest.exceptions.SecurityException.mappableSecurityException;\n import static org.apache.usergrid.security.shiro.Realm.ROLE_SERVICE_ADMIN;\n \n \n@@ -61,19 +66,32 @@ public void filter( ContainerRequestContext request ) {\n         if ( values.length < 2 ) {\n             return;\n         }\n-        String name = values[0].toLowerCase();\n+        String name = values[0];\n         String password = values[1];\n \n         String sysadmin_login_name = properties.getProperty( \"usergrid.sysadmin.login.name\" );\n         String sysadmin_login_password = properties.getProperty( \"usergrid.sysadmin.login.password\" );\n         boolean sysadmin_login_allowed =\n                 Boolean.parseBoolean( properties.getProperty( \"usergrid.sysadmin.login.allowed\" ) );\n-        if ( name.equals( sysadmin_login_name ) && password.equals( sysadmin_login_password )\n+        if ( name.equalsIgnoreCase( sysadmin_login_name ) && password.equals( sysadmin_login_password )\n                 && sysadmin_login_allowed ) {\n             request.setSecurityContext( new SysAdminRoleAuthenticator() );\n             if (logger.isTraceEnabled()) {\n                 logger.trace(\"System administrator access allowed\");\n             }\n+        }else{\n+\n+            try {\n+                PrincipalCredentialsToken token =\n+                    management.getPrincipalCredentialsTokenForClientCredentials( name, password );\n+                Subject subject = SubjectUtils.getSubject();\n+                subject.login( token );\n+            }\n+            catch ( Exception e ) {\n+                throw mappableSecurityException( INVALID_CLIENT_CREDENTIALS_ERROR );\n+            }\n+\n+\n         }\n     }\n ",
                "additions": 20,
                "raw_url": "https://github.com/apache/usergrid/raw/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/rest/src/main/java/org/apache/usergrid/rest/security/shiro/filters/BasicAuthSecurityFilter.java",
                "status": "modified",
                "changes": 22,
                "deletions": 2,
                "sha": "d4d2e60223fb647f976aea829901cfd38c202364",
                "blob_url": "https://github.com/apache/usergrid/blob/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/rest/src/main/java/org/apache/usergrid/rest/security/shiro/filters/BasicAuthSecurityFilter.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/security/shiro/filters/BasicAuthSecurityFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/security/shiro/filters/BasicAuthSecurityFilter.java?ref=7fdba4a2cfa6d18047b5b893382806a342a78eff"
            },
            {
                "patch": "@@ -54,6 +54,14 @@\n     String PROPERTIES_EMAIL_USER_PIN_REQUEST = \"usergrid.management.email.user-pin\";\n     String PROPERTIES_EMAIL_FOOTER = \"usergrid.management.email.footer\";\n \n+    String PROPERTIES_USER_ACTIVATION_URL = \"usergrid.user.activation.url\";\n+    String PROPERTIES_USER_CONFIRMATION_URL = \"usergrid.user.confirmation.url\";\n+    String PROPERTIES_USER_RESETPW_URL = \"usergrid.user.resetpw.url\";\n+    String PROPERTIES_ADMIN_ACTIVATION_URL = \"usergrid.admin.activation.url\";\n+    String PROPERTIES_ADMIN_CONFIRMATION_URL = \"usergrid.admin.confirmation.url\";\n+    String PROPERTIES_ORGANIZATION_ACTIVATION_URL = \"usergrid.organization.activation.url\";\n+    String PROPERTIES_ADMIN_RESETPW_URL = \"usergrid.admin.resetpw.url\";\n+\n     String PROPERTIES_USERGRID_SYSADMIN_LOGIN_FETCH_ORGS = \"usergrid.sysadmin.login.fetch_orgs\";\n \n     String PROPERTIES_ADMIN_USERS_REQUIRE_CONFIRMATION =",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/services/src/main/java/org/apache/usergrid/management/AccountCreationProps.java",
                "status": "modified",
                "changes": 8,
                "deletions": 0,
                "sha": "b1c114818ebbec2f162a7c52b35e6d9671a00642",
                "blob_url": "https://github.com/apache/usergrid/blob/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/services/src/main/java/org/apache/usergrid/management/AccountCreationProps.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/management/AccountCreationProps.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/management/AccountCreationProps.java?ref=7fdba4a2cfa6d18047b5b893382806a342a78eff"
            },
            {
                "patch": "@@ -17,6 +17,7 @@\n package org.apache.usergrid.management.cassandra;\n \n \n+import org.apache.usergrid.management.AccountCreationProps;\n import org.apache.usergrid.management.OrganizationConfigProps;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -206,10 +207,45 @@ public void setProperty(String name, String value) {\n         orgProperties.put(name,value);\n     }\n \n+    protected String getWorkflowUrlOverrideProperty(WorkflowUrl urlType) {\n+        String propertyName = null;\n+        switch (urlType) {\n+            case ORGANIZATION_ACTIVATION_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_ORGANIZATION_ACTIVATION_URL;\n+                break;\n+            case ADMIN_ACTIVATION_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_ADMIN_ACTIVATION_URL;\n+                break;\n+            case ADMIN_CONFIRMATION_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_ADMIN_CONFIRMATION_URL;\n+                break;\n+            case ADMIN_RESETPW_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_ADMIN_RESETPW_URL;\n+                break;\n+            case USER_ACTIVATION_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_USER_ACTIVATION_URL;\n+                break;\n+            case USER_CONFIRMATION_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_USER_CONFIRMATION_URL;\n+                break;\n+            case USER_RESETPW_URL:\n+                propertyName = AccountCreationProps.PROPERTIES_USER_RESETPW_URL;\n+                break;\n+            default:\n+                return null;\n+        }\n+\n+        return getProperty(propertyName);\n+    }\n+\n     @Override\n     public String getFullUrlTemplate(WorkflowUrl urlType) {\n         String urlTemplate = null;\n-        if (urlPaths.containsKey(urlType)) {\n+        String propertyValue = getWorkflowUrlOverrideProperty(urlType);\n+        if (propertyValue != null) {\n+            urlTemplate = propertyValue;\n+        }\n+        else if (urlPaths.containsKey(urlType)) {\n             urlTemplate = getProperty(ORGPROPERTIES_API_URL_BASE) + urlPaths.get(urlType);\n         }\n         return urlTemplate;",
                "additions": 37,
                "raw_url": "https://github.com/apache/usergrid/raw/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/services/src/main/java/org/apache/usergrid/management/cassandra/OrganizationConfigPropsImpl.java",
                "status": "modified",
                "changes": 38,
                "deletions": 1,
                "sha": "adfadf208f915a33adad4e90489d54831876ca56",
                "blob_url": "https://github.com/apache/usergrid/blob/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/services/src/main/java/org/apache/usergrid/management/cassandra/OrganizationConfigPropsImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/management/cassandra/OrganizationConfigPropsImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/management/cassandra/OrganizationConfigPropsImpl.java?ref=7fdba4a2cfa6d18047b5b893382806a342a78eff"
            },
            {
                "patch": "@@ -79,16 +79,12 @@ public UsersService() {\n \n     @Override\n     public ServiceResults getItemByName( ServiceContext context, String name ) throws Exception {\n-        String nameProperty = Schema.getDefaultSchema().aliasProperty( getEntityType() );\n-\n-        if ( nameProperty == null ) {\n-            nameProperty = \"name\";\n-        }\n-\n+        \n         EntityRef entity = null;\n         Identifier id = Identifier.from( name );\n \n         if ( id != null ) {\n+            // get the entityRef from the unique value index\n             entity = em.getUserByIdentifier( id );\n         }\n \n@@ -97,7 +93,14 @@ public ServiceResults getItemByName( ServiceContext context, String name ) throw\n         }\n \n         if ( !context.moreParameters() ) {\n+\n+            // full load the entity from the database based on the UUID from the unique value index\n             entity = em.get( entity );\n+\n+            if ( entity == null ) {\n+                throw new ServiceResourceNotFoundException( context );\n+            }\n+\n             entity = importEntity( context, ( Entity ) entity );\n         }\n ",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java",
                "status": "modified",
                "changes": 15,
                "deletions": 6,
                "sha": "734174328113125cf4201dcc44f910e6999711ac",
                "blob_url": "https://github.com/apache/usergrid/blob/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/users/UsersService.java?ref=7fdba4a2cfa6d18047b5b893382806a342a78eff"
            },
            {
                "patch": "@@ -27,10 +27,13 @@\n import com.datastax.driver.core.ConsistencyLevel;\n import com.datastax.driver.core.Session;\n import org.apache.usergrid.persistence.EntityManager;\n+import org.apache.usergrid.persistence.collection.MvccEntity;\n import org.apache.usergrid.persistence.collection.serialization.MvccEntitySerializationStrategy;\n+import org.apache.usergrid.persistence.collection.serialization.UniqueValue;\n import org.apache.usergrid.persistence.collection.serialization.UniqueValueSerializationStrategy;\n import org.apache.usergrid.persistence.collection.serialization.UniqueValueSet;\n import org.apache.usergrid.persistence.collection.serialization.impl.*;\n+import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.core.scope.ApplicationScopeImpl;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n import org.apache.usergrid.persistence.model.field.StringField;\n@@ -57,6 +60,10 @@\n \n     private static final String CONFIRM_DELETE_ARG = \"confirmDelete\";\n \n+    private static final String CONFIRM_UPDATE_ARG = \"confirmUpdate\";\n+\n+    private static final String SERIALIZATION_REPAIR_ARG = \"useSerializationRepair\";\n+\n     private static final String FILEPATH_ARG = \"file\";\n \n \n@@ -98,6 +105,18 @@ public Options createOptions() {\n \n         options.addOption( confirmDeleteOption );\n \n+        Option confirmUpdateOption =\n+            OptionBuilder.withArgName(CONFIRM_UPDATE_ARG).isRequired( false ).withDescription( \"confirm update\" )\n+                .create(CONFIRM_UPDATE_ARG);\n+\n+        options.addOption( confirmUpdateOption );\n+\n+        Option useSerializationRepair =\n+            OptionBuilder.withArgName(SERIALIZATION_REPAIR_ARG).isRequired( false ).withDescription( \"use unique value serialization repair to keep oldest index\" )\n+                .create(SERIALIZATION_REPAIR_ARG);\n+\n+        options.addOption( useSerializationRepair );\n+\n         Option filepathOption =\n             OptionBuilder.withArgName(FILEPATH_ARG).hasArg().isRequired( true )\n                 .withDescription( \"path to file containing UV info\" ).create(FILEPATH_ARG);\n@@ -124,8 +143,11 @@ public void runTool( CommandLine line ) throws Exception {\n \n         String operation = line.getOptionValue(OPERATION_ARG) != null ? line.getOptionValue(OPERATION_ARG) : \"get\";\n         boolean deleteOp = operation.toLowerCase().equals(\"delete\");\n+        boolean updateOp = operation.toLowerCase().equals(\"update\");\n         if (deleteOp && !line.hasOption(CONFIRM_DELETE_ARG)) {\n             throw new RuntimeException(\"Must add confirmDelete option to use delete.\");\n+        }else if( updateOp && !line.hasOption(CONFIRM_UPDATE_ARG) ){\n+            throw new RuntimeException(\"Must add confirmUpdate option to use update.\");\n         }\n         String filepath = line.getOptionValue(FILEPATH_ARG);\n         if (filepath == null || filepath.isEmpty()) {\n@@ -142,25 +164,64 @@ public void runTool( CommandLine line ) throws Exception {\n \n         File listFile = new File(filepath);\n \n+        boolean useSerializationRepair = false;\n+        if(line.hasOption(SERIALIZATION_REPAIR_ARG)){\n+            useSerializationRepair = true;\n+        }\n+\n         try (BufferedReader br = new BufferedReader(new FileReader(listFile))) {\n             String fileLine;\n             while ((fileLine = br.readLine()) != null) {\n                 String[] valuesArray = fileLine.trim().split(\"\\\\|\");\n-                if (valuesArray.length != 4) {\n+                if (valuesArray.length != 4 && valuesArray.length != 5) {\n                     logger.info(\"Line: >\"+fileLine+\"<\");\n                     throw new RuntimeException(\"Invalid file -- should contain one row per entity formatted like \" +\n-                            \"'{uuid}|{entityType}|{fieldType}|{fieldValue}'.  \" +\n-                            \"Example: 'b9398e88-ef7f-11e5-9e41-0a2cb9e6caa9|user|email|whatever@usergrid.com'\");\n+                            \"'{uuid}|{entityType}|{fieldType}|{fieldValue}|{newEntityUUID}'.  \" +\n+                            \"Example: 'b9398e88-ef7f-11e5-9e41-0a2cb9e6caa9|user|email|whatever@usergrid.com|newEntityUUID'.  \" +\n+                            \"Param {newEntityUUID} is optional.\");\n                 }\n                 UUID appUuid = UUID.fromString(valuesArray[0]);\n                 String entityType = valuesArray[1];\n                 String fieldType = valuesArray[2];\n                 String fieldValue = valuesArray[3];\n \n                 UniqueValueSet uniqueValueSet = uniqueValueSerializationStrategy.load(\n-                        new ApplicationScopeImpl(new SimpleId(appUuid, \"application\")),\n-                        ConsistencyLevel.valueOf(System.getProperty(\"usergrid.read.cl\", \"LOCAL_QUORUM\")), entityType,\n-                        Collections.singletonList(new StringField(fieldType, fieldValue)), false);\n+                    new ApplicationScopeImpl(new SimpleId(appUuid, \"application\")),\n+                    ConsistencyLevel.valueOf(System.getProperty(\"usergrid.read.cl\", \"CL_LOCAL_QUORUM\")), entityType,\n+                    Collections.singletonList(new StringField(fieldType, fieldValue)), useSerializationRepair);\n+\n+                if( updateOp) {\n+\n+                    if(valuesArray.length!=5){\n+                        throw new RuntimeException(\"Missing param {newEntityUUID}\");\n+                    }\n+                    String updateUUID = valuesArray[4];\n+\n+                    ApplicationScope applicationScope = new ApplicationScopeImpl(new SimpleId(appUuid, \"application\"));\n+                    com.google.common.base.Optional<MvccEntity> entity =\n+                        mvccEntitySerializationStrategy.load(applicationScope, new SimpleId(UUID.fromString(updateUUID), entityType));\n+\n+                    if( !entity.isPresent()\n+                        || !entity.get().getEntity().isPresent() ){\n+                        throw new RuntimeException(\"Unable to update unique value index because supplied UUID \"+updateUUID+\" does not exist\");\n+                    }\n+\n+                    logger.info(\"Delete unique value: {}\",  uniqueValueSet.getValue(fieldType));\n+                    session.execute(uniqueValueSerializationStrategy.deleteCQL(applicationScope, uniqueValueSet.getValue(fieldType)));\n+\n+                    UniqueValue newUniqueValue =\n+                        new UniqueValueImpl(new StringField(fieldType, fieldValue), entity.get().getId(), entity.get().getVersion());\n+                    logger.info(\"Writing new unique value: {}\", newUniqueValue);\n+                    session.execute(uniqueValueSerializationStrategy.writeCQL(applicationScope, newUniqueValue, -1));\n+\n+                    logger.info(\"Re-loading unique value set for field\");\n+\n+                }\n+\n+                uniqueValueSet = uniqueValueSerializationStrategy.load(\n+                    new ApplicationScopeImpl(new SimpleId(appUuid, \"application\")),\n+                    ConsistencyLevel.valueOf(System.getProperty(\"usergrid.read.cl\", \"CL_LOCAL_QUORUM\")), entityType,\n+                    Collections.singletonList(new StringField(fieldType, fieldValue)), useSerializationRepair);\n \n                 StringBuilder stringBuilder = new StringBuilder();\n \n@@ -199,114 +260,4 @@ public void runTool( CommandLine line ) throws Exception {\n             }\n         }\n     }\n-\n-        /*\n-        } else {\n-\n-            logger.info(\"Running entity unique scanner only\");\n-\n-\n-            // scan through all unique values and log some info\n-\n-            Iterator<com.netflix.astyanax.model.Row<ScopedRowKey<TypeField>, EntityVersion>> rows = null;\n-            try {\n-\n-                rows = keyspace.prepareQuery(CF_UNIQUE_VALUES)\n-                    .setConsistencyLevel(ConsistencyLevel.valueOf(System.getProperty(\"usergrid.read.cl\", \"CL_LOCAL_QUORUM\")))\n-                    .getAllRows()\n-                    .withColumnRange(new RangeBuilder().setLimit(1000).build())\n-                    .execute().getResult().iterator();\n-\n-            } catch (ConnectionException e) {\n-\n-                logger.error(\"Error connecting to cassandra\", e);\n-            }\n-\n-\n-            UUID finalAppToFilter = appToFilter;\n-\n-            if( rows != null) {\n-                rows.forEachRemaining(row -> {\n-\n-                    count.incrementAndGet();\n-\n-                    if(count.get() % 1000 == 0 ){\n-                        logger.info(\"Scanned {} rows in {}\", count.get(), CF_UNIQUE_VALUES.getName());\n-                    }\n-\n-                    final String fieldName = row.getKey().getKey().getField().getName();\n-                    final String fieldValue = row.getKey().getKey().getField().getValue().toString();\n-                    final String scopeType = row.getKey().getScope().getType();\n-                    final UUID scopeUUID = row.getKey().getScope().getUuid();\n-\n-\n-                    if (!fieldName.equalsIgnoreCase(fieldType) ||\n-                        (finalAppToFilter != null && !finalAppToFilter.equals(scopeUUID))\n-                        ) {\n-                        // do nothing\n-\n-                    } else {\n-\n-\n-                        // if we have more than 1 column, let's check for a duplicate\n-                        if (row.getColumns() != null && row.getColumns().size() > 1) {\n-\n-                            final List<EntityVersion> values = new ArrayList<>(row.getColumns().size());\n-\n-                            Iterator<Column<EntityVersion>> columns = row.getColumns().iterator();\n-                            columns.forEachRemaining(column -> {\n-\n-\n-                                final EntityVersion entityVersion = column.getName();\n-\n-\n-                                logger.trace(\n-                                    scopeType + \": \" + scopeUUID + \", \" +\n-                                        fieldName + \": \" + fieldValue + \", \" +\n-                                        \"entity type: \" + entityVersion.getEntityId().getType() + \", \" +\n-                                        \"entity uuid: \" + entityVersion.getEntityId().getUuid()\n-                                );\n-\n-\n-                                if (entityType != null &&\n-                                    entityVersion.getEntityId().getType().equalsIgnoreCase(entityType)\n-                                    ) {\n-\n-                                    // add the first value into the list\n-                                    if (values.size() == 0) {\n-\n-                                        values.add(entityVersion);\n-\n-\n-                                    } else {\n-\n-                                        if (!values.get(0).getEntityId().getUuid().equals(entityVersion.getEntityId().getUuid())) {\n-\n-                                            values.add(entityVersion);\n-\n-                                            logger.error(\"Duplicate found for field [{}={}].  Entry 1: [{}], Entry 2: [{}]\",\n-                                                fieldName, fieldValue, values.get(0).getEntityId(), entityVersion.getEntityId());\n-\n-                                        }\n-\n-                                    }\n-\n-\n-                                }\n-\n-                            });\n-                        }\n-                    }\n-\n-\n-                });\n-            }else{\n-\n-                logger.warn(\"No rows returned from table: {}\", CF_UNIQUE_VALUES.getName());\n-\n-            }\n-\n-        }\n-    }\n-    */\n }",
                "additions": 67,
                "raw_url": "https://github.com/apache/usergrid/raw/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/tools/src/main/java/org/apache/usergrid/tools/UniqueValueManager.java",
                "status": "modified",
                "changes": 183,
                "deletions": 116,
                "sha": "755ad3f092f36bae72526817b66b324520356360",
                "blob_url": "https://github.com/apache/usergrid/blob/7fdba4a2cfa6d18047b5b893382806a342a78eff/stack/tools/src/main/java/org/apache/usergrid/tools/UniqueValueManager.java",
                "filename": "stack/tools/src/main/java/org/apache/usergrid/tools/UniqueValueManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/tools/src/main/java/org/apache/usergrid/tools/UniqueValueManager.java?ref=7fdba4a2cfa6d18047b5b893382806a342a78eff"
            }
        ],
        "bug_id": "usergrid_49",
        "parent": "https://github.com/apache/usergrid/commit/9016fd290e80b88ba3199c0020fca7722b82d780",
        "message": "Merge branch 'master' of https://git-wip-us.apache.org/repos/asf/usergrid\n\n* 'master' of https://git-wip-us.apache.org/repos/asf/usergrid:\n  Add unique value index update option to UniqueValueManager tool.\n  Add support for application and organization client credentials to be passed in Authorization header.\n  Fix NPE when user doesn't exist after lookup from the unique value index.\n  Use URLs (like admin reset password URL) from properties if they are provided.",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38",
        "file": [
            {
                "patch": "@@ -27,6 +27,11 @@ Icon\n /portal/test/coverage/instrument/js/usergrid-coverage.min.js\n /portal/test/coverage/instrument/js/usergrid.min.js\n /stack/corepersistence/priamcluster/aws.properties\n+# Eclipse IDE files\n+.project\n+.classpath\n+.settings/\n+.metadata/\n #Webstorm artifacts\n .idea/\n stack/corepersistence/collection/nbactions.xml",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/.gitignore",
                "status": "modified",
                "changes": 5,
                "deletions": 0,
                "sha": "587301512f9e6a5c730008a729bb2879b6f42146",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/.gitignore",
                "filename": ".gitignore",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/.gitignore?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -169,6 +169,9 @@ module.exports = function (grunt) {\n       }\n     },\n     watch: {\n+      options: {\n+        livereload: true\n+      },\n       files: [\n         'index-template.html',\n         'css/**/*.css',\n@@ -188,7 +191,9 @@ module.exports = function (grunt) {\n       server: {\n         options: {\n           target: 'http://localhost:3000/index-debug.html', // target url to open\n-       //   open: 'http://localhost:3000/index-debug.html',\n+          open: 'http://localhost:3000/index-debug.html',\n+          hostname:'*',\n+          livereload:true,\n           port: 3000,\n           base: ''\n         }",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/Gruntfile.js",
                "status": "modified",
                "changes": 7,
                "deletions": 1,
                "sha": "7a6d3b9971974655f275507626352b24df63a734",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/Gruntfile.js",
                "filename": "portal/Gruntfile.js",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/Gruntfile.js?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -1,6 +1,6 @@\n {\n   \"name\": \"usergrid-portal\",\n-  \"version\": \"2.0.13\",\n+  \"version\": \"2.0.14\",\n   \"ignore\": [\n     \".jshintrc\",\n     \"**/*.txt\",",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/bower.json",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "71fe6a445fcb3bf5c8fb35c8f95b79dfc009fb57",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/bower.json",
                "filename": "portal/bower.json",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/bower.json?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -44,7 +44,7 @@ Usergrid.options = {\n \n Usergrid.regex = {\n   appNameRegex: new RegExp(\"^[0-9a-zA-Z.-]{3,25}$\"),\n-  usernameRegex: new RegExp(\"^[0-9a-zA-Z\\.\\_-]{4,25}$\"),\n+  usernameRegex: new RegExp(\"^[0-9a-zA-Z@\\.\\_-]{4,25}$\"),\n   nameRegex: new RegExp(\"^([0-9a-zA-Z@#$%^&!?;:.,'\\\"~*-:+_\\[\\\\](){}/\\\\ |]{3,60})+$\"),\n   roleNameRegex: new RegExp(\"^([0-9a-zA-Z./-]{3,25})+$\"),\n   emailRegex: new RegExp(\"^(([0-9a-zA-Z]+[_\\+.-]?)+@[0-9a-zA-Z]+[0-9,a-z,A-Z,.,-]*(.){1}[a-zA-Z]{2,4})+$\"),",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/config.js",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "936cd7522b50d736b5adfb5ef695b528c152ea07",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/config.js",
                "filename": "portal/config.js",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/config.js?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -114,6 +114,12 @@ AppServices.Controllers.controller('DataCtrl', ['ug', '$scope', '$rootScope', '$\n \n     });\n \n+    $scope.$on('query-error', function(event) {\n+      $scope.loading = false;\n+      $scope.applyScope();\n+      $scope.queryBoxesSelected = false;\n+    });\n+\n     $scope.$on('indexes-received', function(event, indexes) {\n       //todo - do something with the indexes\n       var fred = indexes;",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/js/data/data-controller.js",
                "status": "modified",
                "changes": 6,
                "deletions": 0,
                "sha": "486373ef7edb6d591d320146dec4558ec6b7eebc",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/js/data/data-controller.js",
                "filename": "portal/js/data/data-controller.js",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/js/data/data-controller.js?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -381,6 +381,7 @@ AppServices.Services.factory('ug', function (configuration, $rootScope,utility,\n       this.client().createCollection(options, function (err, collection, data) {\n         if (err) {\n           $rootScope.$broadcast('alert', 'error', 'error getting ' + collection._type + ': ' + data.error_description);\n+          $rootScope.$broadcast(type + '-error', collection);\n         } else {\n           $rootScope.$broadcast(type + '-received', collection);\n         }\n@@ -821,7 +822,7 @@ AppServices.Services.factory('ug', function (configuration, $rootScope,utility,\n     },\n \n     updateUser: function (user) {\n-      var body = $rootScope.currentUser;\n+      var body = {};\n       body.username = user.username;\n       body.name = user.name;\n       body.email = user.email;",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/js/global/ug-service.js",
                "status": "modified",
                "changes": 3,
                "deletions": 1,
                "sha": "345e9b627a4eafa2e8f9b992f8c660c5a78f1745",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/js/global/ug-service.js",
                "filename": "portal/js/global/ug-service.js",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/js/global/ug-service.js?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -2,7 +2,7 @@\n     <li class=\"option {{item.active ? 'active' : ''}}\" ng-cloak=\"\" ng-repeat=\"item in menuItems\"><a data-ng-href=\"{{item.path}}\"><i class=\"pictogram\" ng-bind-html=\"item.pic\"></i>{{item.title}}</a>\n         <ul class=\"nav nav-list\" ng-if=\"item.items\">\n             <li ng-repeat=\"subItem in item.items\"><a data-ng-href=\"{{subItem.path}}\"><i class=\"pictogram sub\" ng-bind-html=\"subItem.pic\"></i>{{subItem.title}}</a>\n-            </li>\n+            </li> \n         </ul>\n     </li>\n </ul>\n\\ No newline at end of file",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/js/menu.html",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "1a8d9a8ec59a6a993b2dad908db132dbc03cb2f6",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/js/menu.html",
                "filename": "portal/js/menu.html",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/js/menu.html?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -1,6 +1,6 @@\n {\n   \"name\": \"usergrid\",\n-  \"version\": \"2.0.13\",\n+  \"version\": \"2.0.14\", \n   \"packageName\": \"appsvc-ui\",\n   \"description\": \"full usergrid portal\",\n   \"main\": \"./scripts/web-server.js\",",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/package.json",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "9c85b4f384f7e2d2db9f7b3854a164a702e71236",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/portal/package.json",
                "filename": "portal/package.json",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/portal/package.json?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -0,0 +1,45 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Keep nothing but defaults here\n+\n+# The properties are not the actual configuration properties but\n+# safe dynamic property defaults for our testing via IDE or Maven\n+\n+cassandra.embedded=true\n+cassandra.hosts=127.0.0.1\n+cassandra.port=9160\n+cassandra.version=1.2\n+cassandra.cluster_name=Usergrid\n+cassandra.timeout=2000\n+\n+# Should be set to a larger value than Hystrix thread pool size\n+cassandra.connections=800\n+\n+collections.keyspace=Usergrid_Applications\n+collections.keyspace.strategy.options=replication_factor:1\n+collections.keyspace.strategy.class=org.apache.cassandra.locator.SimpleStrategy\n+\n+collection.stage.transient.timeout=60\n+\n+elasticsearch.embedded=true\n+elasticsearch.cluster_name=usergrid\n+elasticsearch.index_prefix=usergrid\n+elasticsearch.hosts=127.0.0.1\n+elasticsearch.port=9300\n+\n+index.query.limit.default=100\n+",
                "additions": 45,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/config/src/main/resources/corepersistence.properties",
                "status": "added",
                "changes": 45,
                "deletions": 0,
                "sha": "b749482659f49dbeac2de6ca388224a22616e448",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/config/src/main/resources/corepersistence.properties",
                "filename": "stack/config/src/main/resources/corepersistence.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/config/src/main/resources/corepersistence.properties?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -414,7 +414,7 @@ public QueueManager getQm() {\n \n     public EntityManager getEm() {\n         if ( em == null  ) {\n-            this.em = emf.getEntityManager( emf.getManagementAppId());\n+            this.em = emf.getEntityManager( emf.getManagementAppId() );\n         }\n         return em;\n     }",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/batch/service/SchedulerServiceImpl.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "37e8084ae44e06e90756c76e8b95f59097969c0f",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/batch/service/SchedulerServiceImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/batch/service/SchedulerServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/batch/service/SchedulerServiceImpl.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -15,6 +15,7 @@\n  */\n package org.apache.usergrid.corepersistence;\n \n+import com.netflix.hystrix.exception.HystrixRuntimeException;\n import java.nio.ByteBuffer;\n import java.util.ArrayList;\n import java.util.Collection;\n@@ -150,6 +151,8 @@\n public class CpEntityManager implements EntityManager {\n     private static final Logger logger = LoggerFactory.getLogger( CpEntityManager.class );\n \n+    private static final String COLL_SUFFIX = \"zzzcollzzz\"; \n+\n     private UUID applicationId;\n     private Application application;\n    \n@@ -206,13 +209,8 @@ public EntityManager init(CpEntityManagerFactory emf, UUID applicationId ,\n \n         indexBucketLocator = ( IndexBucketLocator ) emf.getApplicationContext().getBean( \"indexBucketLocator\" );\n \n+        appScope = this.emf.getApplicationScope(applicationId);\n \n-        try {\n-                    application = getApplication();\n-                }\n-                catch ( Exception ex ) {\n-                    logger.error(\"Getting application\", ex);\n-                }\n         return this;\n     }\n \n@@ -222,6 +220,18 @@ public CpManagerCache getManagerCache() {\n     }\n \n \n+    static String getCollectionScopeNameFromEntityType( String type) {\n+        String csn = Schema.defaultCollectionName( type ) + COLL_SUFFIX;\n+        return csn;\n+    }\n+\n+\n+   static String getCollectionScopeNameFromCollectionName( String name ) {\n+       String csn = name + COLL_SUFFIX;\n+       return csn;\n+   }\n+\n+\n     @Override\n     public Entity create(String entityType, Map<String, Object> properties) throws Exception {\n         return create( entityType, null, properties );\n@@ -297,22 +307,32 @@ public Entity create(\n     public Entity get( EntityRef entityRef ) throws Exception {\n \n         Id id = new SimpleId(  entityRef.getUuid(), entityRef.getType() );\n-        String collectionName = Schema.defaultCollectionName( entityRef.getType() );\n+        String collectionName = getCollectionScopeNameFromEntityType( entityRef.getType() );\n \n         CollectionScope collectionScope = new CollectionScopeImpl( \n             appScope.getApplication(), appScope.getApplication(), collectionName );\n \n         EntityCollectionManager ecm = managerCache.getEntityCollectionManager(collectionScope);\n \n-        // logger.debug(\"Loading entity {} type {} to {}\", \n-        //      new String[] { entityId.toString(), type, collectionName });\n-\n+        if ( logger.isDebugEnabled() ) {\n+            logger.debug(\"Loading entity {}:{} from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    id.getType(), \n+                    id.getUuid(), \n+                    collectionScope.getApplication(), \n+                    collectionScope.getOwner(), \n+                    collectionScope.getName() \n+            });\n+        }\n+       \n         org.apache.usergrid.persistence.model.entity.Entity cpEntity = \n             ecm.load( id ).toBlockingObservable().last();\n \n         if ( cpEntity == null ) {\n+            logger.debug(\"   entity null\");\n             return null;\n         }\n+        logger.debug(\"   entity found\");\n \n         Class clazz = Schema.getDefaultSchema().getEntityClass(entityRef.getType());\n \n@@ -351,22 +371,32 @@ public Entity get( EntityRef entityRef ) throws Exception {\n         String type = getDefaultSchema().getEntityType( entityClass );\n \n         Id id = new SimpleId( entityId, type );\n-        String collectionName = Schema.defaultCollectionName( type );\n+        String collectionName = getCollectionScopeNameFromEntityType( type );\n \n         CollectionScope collectionScope = new CollectionScopeImpl( \n             appScope.getApplication(), appScope.getApplication(), collectionName );\n \n         EntityCollectionManager ecm = managerCache.getEntityCollectionManager(collectionScope);\n \n-//        logger.debug(\"Loading entity {} type {} to {}\", \n-//            new String[] { entityId.toString(), type, collectionName });\n+        if ( logger.isDebugEnabled() ) {\n+            logger.debug(\"Loading entity {}:{} from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    id.getType(), \n+                    id.getUuid(), \n+                    collectionScope.getApplication(), \n+                    collectionScope.getOwner(), \n+                    collectionScope.getName() \n+            });\n+        }\n \n         org.apache.usergrid.persistence.model.entity.Entity cpEntity = \n             ecm.load( id ).toBlockingObservable().last();\n \n         if ( cpEntity == null ) {\n+            logger.debug(\"   entity null\");\n             return null;\n         }\n+        logger.debug(\"   entity found\");\n \n         A entity = EntityFactory.newEntity( entityId, type, entityClass );\n         entity.setProperties( CpEntityMapUtils.toMap( cpEntity ) );\n@@ -407,10 +437,10 @@ public Results get(Collection<UUID> entityIds, String entityType,\n     public void update( Entity entity ) throws Exception {\n \n         // first, update entity index in its own collection scope\n-        String collectionName = Schema.defaultCollectionName( entity.getType() );\n-\n         CollectionScope collectionScope = new CollectionScopeImpl( \n-            appScope.getApplication(), appScope.getApplication(), collectionName );\n+            appScope.getApplication(), \n+            appScope.getApplication(), \n+            getCollectionScopeNameFromEntityType( entity.getType() ) );\n \n         IndexScope indexScope = new IndexScopeImpl( \n             appScope.getApplication(), appScope.getApplication(), entity.getType());\n@@ -426,7 +456,21 @@ public void update( Entity entity ) throws Exception {\n         cpEntity = CpEntityMapUtils.fromMap( \n                 cpEntity, entity.getProperties(), entity.getType(), true );\n \n-        cpEntity = ecm.write( cpEntity ).toBlockingObservable().last();\n+        try {\n+            cpEntity = ecm.write( cpEntity ).toBlockingObservable().last();\n+\n+        } catch ( WriteUniqueVerifyException wuve ) {\n+                handleWriteUniqueVerifyException( entity, wuve );\n+\n+        } catch ( HystrixRuntimeException hre ) {\n+\n+            if ( hre.getCause() instanceof WriteUniqueVerifyException ) {\n+                WriteUniqueVerifyException wuve = (WriteUniqueVerifyException)hre.getCause();\n+                handleWriteUniqueVerifyException( entity, wuve );\n+            }\n+\n+        }\n+\n         ei.index( cpEntity );\n \n         // next, update entity in every collection and connection scope in which it is indexed \n@@ -458,7 +502,7 @@ private void updateEntityIndexes( Entity entity,\n                     IndexScope indexScope = new IndexScopeImpl( \n                         appScope.getApplication(), \n                         new SimpleId(uuid, ownerType), \n-                        coll + CpRelationManager.COLLECTION_SUFFIX);\n+                        getCollectionScopeNameFromCollectionName( coll ));\n \n                     EntityIndex ei = managerCache.getEntityIndex( indexScope );\n \n@@ -472,10 +516,10 @@ private void updateEntityIndexes( Entity entity,\n     @Override\n     public void delete( EntityRef entityRef ) throws Exception {\n \n-        String collectionName = Schema.defaultCollectionName( entityRef.getType() );\n-\n         CollectionScope collectionScope = new CollectionScopeImpl( \n-            appScope.getApplication(), appScope.getApplication(), collectionName );\n+            appScope.getApplication(), \n+            appScope.getApplication(), \n+            getCollectionScopeNameFromEntityType( entityRef.getType() ) );\n \n         EntityCollectionManager ecm = managerCache.getEntityCollectionManager(collectionScope);\n \n@@ -498,13 +542,13 @@ public void delete( EntityRef entityRef ) throws Exception {\n                 Map<UUID, Set<String>> collectionsByUuid = owners.get( ownerType );\n \n                 for ( UUID uuid : collectionsByUuid.keySet() ) {\n-                    Set<String> collections = collectionsByUuid.get( uuid );\n-                    for ( String coll : collections ) {\n+                    Set<String> collectionNames = collectionsByUuid.get( uuid );\n+                    for ( String coll : collectionNames ) {\n \n                         IndexScope indexScope = new IndexScopeImpl( \n                             appScope.getApplication(), \n                             new SimpleId(uuid, ownerType), \n-                            coll + CpRelationManager.COLLECTION_SUFFIX);\n+                            coll );\n \n                         EntityIndex ei = managerCache.getEntityIndex( indexScope );\n \n@@ -515,8 +559,9 @@ public void delete( EntityRef entityRef ) throws Exception {\n            \n             // deindex from default index scope\n             IndexScope defaultIndexScope = new IndexScopeImpl(\n-                appScope.getApplication(), appScope.getApplication(), \n-                collectionName + CpRelationManager.COLLECTION_SUFFIX);\n+                appScope.getApplication(), \n+                appScope.getApplication(), \n+                getCollectionScopeNameFromEntityType( entityRef.getType() ) );\n             EntityIndex entityIndex = managerCache.getEntityIndex(defaultIndexScope);\n \n             entityIndex.deindex( entity );\n@@ -777,7 +822,7 @@ public void updateProperties(\n     @Override\n     public void deleteProperty(EntityRef entityRef, String propertyName) throws Exception {\n \n-        String collectionName = Schema.defaultCollectionName( entityRef.getType() );\n+        String collectionName = getCollectionScopeNameFromEntityType( entityRef.getType() );\n \n         CollectionScope collectionScope = new CollectionScopeImpl( \n             appScope.getApplication(), appScope.getApplication(), collectionName );\n@@ -1781,6 +1826,8 @@ else if ( ( v instanceof String ) && isBlank( ( String ) v ) ) {\n         Object collection_key = key( applicationId,\n             Schema.DICTIONARY_COLLECTIONS, collectionName, bucketId );\n \n+\n+\n         CollectionInfo collection = null;\n \n         if ( !is_application ) {\n@@ -1854,7 +1901,20 @@ else if ( ( v instanceof String ) && isBlank( ( String ) v ) ) {\n \n         // prepare to write and index Core Persistence Entity into default scope\n         CollectionScope collectionScope = new CollectionScopeImpl( \n-            appScope.getApplication(), appScope.getApplication(), collectionName );\n+            appScope.getApplication(), \n+            appScope.getApplication(), \n+            getCollectionScopeNameFromEntityType( eType ));\n+\n+        if ( logger.isDebugEnabled() ) {\n+            logger.debug(\"Writing entity {}:{} into scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] {\n+                    entity.getType(), \n+                    entity.getUuid(), \n+                    collectionScope.getApplication(), \n+                    collectionScope.getOwner(), \n+                    collectionScope.getName() \n+            });\n+        }\n \n         IndexScope defaultIndexScope = new IndexScopeImpl(\n             appScope.getApplication(), appScope.getApplication(), entity.getType());\n@@ -1865,29 +1925,47 @@ else if ( ( v instanceof String ) && isBlank( ( String ) v ) ) {\n         try {\n             cpEntity = ecm.write( cpEntity ).toBlockingObservable().last();\n \n-        } catch (WriteUniqueVerifyException wuve) {\n+        } catch ( WriteUniqueVerifyException wuve ) {\n+                handleWriteUniqueVerifyException( entity, wuve );\n+\n+        } catch ( HystrixRuntimeException hre ) {\n \n-            // we may have multiple conflicts, but caller expects only one \n-            Map<String, Field> violiations = wuve.getVioliations();\n-            Field conflict = violiations.get( violiations.keySet().iterator().next() );\n+            if ( hre.getCause() instanceof WriteUniqueVerifyException ) {\n+                WriteUniqueVerifyException wuve = (WriteUniqueVerifyException)hre.getCause();\n+                handleWriteUniqueVerifyException( entity, wuve );\n+            }\n \n-            throw new DuplicateUniquePropertyExistsException( \n-                entity.getType(), conflict.getName(), conflict.getValue());\n         }\n+\n         ei.index( cpEntity );\n \n         // reflect changes in the legacy Entity\n         entity.setUuid( cpEntity.getId().getUuid() );\n         Map<String, Object> entityMap = CpEntityMapUtils.toMap( cpEntity );\n         entity.addProperties( entityMap );\n \n+        // add to and index in collection of the application\n         if ( !is_application ) {\n-            getRelationManager( getApplication() ).addToCollection( collectionName, entity );\n+            String collectionName2 = Schema.defaultCollectionName( eType );\n+            getRelationManager( getApplication() ).addToCollection( collectionName2, entity );\n         }\n \n         return entity;\n     }\n \n+\n+    private void handleWriteUniqueVerifyException( Entity entity, WriteUniqueVerifyException wuve) \n+            throws DuplicateUniquePropertyExistsException {\n+\n+        // we may have multiple conflicts, but caller expects only one \n+        Map<String, Field> violiations = wuve.getVioliations();\n+        Field conflict = violiations.get( violiations.keySet().iterator().next() );\n+\n+        throw new DuplicateUniquePropertyExistsException( \n+            entity.getType(), conflict.getName(), conflict.getValue()); \n+    }\n+    \n+\n     @Override\n     public void batchCreateRole(\n             Mutator<ByteBuffer> batch, UUID groupId, String roleName, String roleTitle, \n@@ -1925,16 +2003,19 @@ public void batchCreateRole(\n             elementCoValue = ByteBuffer.allocate( 0 );\n         }\n \n-        boolean entityHasDictionary = getDefaultSchema().hasDictionary( entity.getType(), dictionaryName );\n+        boolean entityHasDictionary = \n+            getDefaultSchema().hasDictionary( entity.getType(), dictionaryName );\n \n         // Don't index dynamic dictionaries not defined by the schema\n         if ( entityHasDictionary ) {\n             getRelationManager( entity )\n-                    .batchUpdateSetIndexes( batch, dictionaryName, elementValue, removeFromDictionary, timestampUuid );\n+                .batchUpdateSetIndexes( \n+                    batch, dictionaryName, elementValue, removeFromDictionary, timestampUuid );\n \n         }\n \n-        ApplicationCF dictionary_cf = entityHasDictionary ? ENTITY_DICTIONARIES : ENTITY_COMPOSITE_DICTIONARIES;\n+        ApplicationCF dictionary_cf = entityHasDictionary ? \n+            ENTITY_DICTIONARIES : ENTITY_COMPOSITE_DICTIONARIES;\n \n         if ( elementValue != null ) {\n             if ( !removeFromDictionary ) {\n@@ -1943,11 +2024,12 @@ public void batchCreateRole(\n                 elementCoValue = toStorableBinaryValue( elementCoValue, !entityHasDictionary );\n \n                 addInsertToMutator( batch, dictionary_cf, key( entity.getUuid(), dictionaryName ),\n-                        entityHasDictionary ? elementValue : asList( elementValue ), elementCoValue, timestamp );\n+                    entityHasDictionary ? \n+                        elementValue : asList( elementValue ), elementCoValue, timestamp );\n \n                 if ( !entityHasDictionary ) {\n-                    addInsertToMutator( batch, ENTITY_DICTIONARIES, key( entity.getUuid(), DICTIONARY_SETS ),\n-                            dictionaryName, null, timestamp );\n+                    addInsertToMutator( batch, ENTITY_DICTIONARIES, key( entity.getUuid(), \n+                        DICTIONARY_SETS ), dictionaryName, null, timestamp );\n                 }\n             }\n             else {\n@@ -1964,8 +2046,8 @@ public void batchCreateRole(\n             Mutator<ByteBuffer> batch, EntityRef entity, String dictionaryName, Object elementValue, \n             boolean removeFromDictionary, UUID timestampUuid) throws Exception {\n \n-        return batchUpdateDictionary( batch, entity, dictionaryName, elementValue, null, removeFromDictionary,\n-                timestampUuid );\n+        return batchUpdateDictionary( batch, entity, dictionaryName, elementValue, null, \n+                removeFromDictionary, timestampUuid );\n     }\n \n     @Override\n@@ -1979,10 +2061,13 @@ public void batchCreateRole(\n     //TODO: ask what the difference is.\n     @Override\n     public Set<String> getDictionaryNames(EntityRef entity) throws Exception {\n+\n         Set<String> dictionaryNames = new TreeSet<String>( CASE_INSENSITIVE_ORDER );\n+\n         List<HColumn<String, ByteBuffer>> results =\n-                cass.getAllColumns( cass.getApplicationKeyspace( applicationId ), ENTITY_DICTIONARIES,\n-                        key( entity.getUuid(), DICTIONARY_SETS ) );\n+            cass.getAllColumns( cass.getApplicationKeyspace( applicationId ), ENTITY_DICTIONARIES,\n+                key( entity.getUuid(), DICTIONARY_SETS ) );\n+\n         for ( HColumn<String, ByteBuffer> result : results ) {\n             String str = string( result.getName() );\n             if ( str != null ) {\n@@ -2028,13 +2113,11 @@ public void refreshIndex() {\n         // refresh system indexes \n         emf.refreshIndex();\n \n-        // refresh application entity index\n-        IndexScope indexScope = new IndexScopeImpl(\n-            appScope.getApplication(), new SimpleId(\"dummy\"), \"dummy\");\n+        // refresh this Entity Manager's application's index\n+        IndexScope indexScope = new IndexScopeImpl( \n+            appScope.getApplication(), appScope.getApplication(), \"dummy\" );\n         EntityIndex ei = managerCache.getEntityIndex( indexScope );\n         ei.refresh();\n-\n-        logger.debug(\"Refreshed index for system and application: \" + applicationId);\n     }\n \n \n@@ -2052,9 +2135,6 @@ public void refreshIndex() {\n \n         return cpEntity;\n     }\n-\n-\n-\n }\n \n ",
                "additions": 133,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "status": "modified",
                "changes": 186,
                "deletions": 53,
                "sha": "efb10b24005dd3beaaee75bb2c51de4115f81905",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -40,6 +40,8 @@\n import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n import org.apache.usergrid.persistence.collection.impl.CollectionScopeImpl;\n+import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n+import org.apache.usergrid.persistence.core.scope.ApplicationScopeImpl;\n import org.apache.usergrid.persistence.exceptions.ApplicationAlreadyExistsException;\n import org.apache.usergrid.persistence.graph.GraphManagerFactory;\n import org.apache.usergrid.persistence.index.EntityIndex;\n@@ -286,7 +288,7 @@ public UUID initializeApplication( String organizationName, UUID applicationId,\n     }\n \n \n-    public CollectionScope getApplicationScope( UUID applicationId ) {\n+    public ApplicationScope getApplicationScope( UUID applicationId ) {\n \n         Query q = Query.fromQL( PROPERTY_UUID + \" = '\" + applicationId.toString() + \"'\");\n \n@@ -302,11 +304,8 @@ public CollectionScope getApplicationScope( UUID applicationId ) {\n \n         Entity appEntity = em.load( candidateResult.getId() ).toBlockingObservable().last();\n \n-        return new CollectionScopeImpl(\n-            new SimpleId( ((UUID)(appEntity.getField(\"organizationUuid\")).getValue()), \"organization\"),\n-            new SimpleId( appEntity.getId().getUuid(), \"application\"),\n-            appEntity.getField(PROPERTY_NAME).getValue().toString()\n-        );\n+        return new ApplicationScopeImpl(\n+            new SimpleId( appEntity.getId().getUuid(), \"application\"));\n     }\n     \n ",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java",
                "status": "modified",
                "changes": 11,
                "deletions": 6,
                "sha": "6387383de495d69e847db830f71115146eb69f9f",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -113,7 +113,6 @@\n import static org.apache.usergrid.persistence.Schema.PROPERTY_CREATED;\n import static org.apache.usergrid.persistence.Schema.TYPE_APPLICATION;\n import static org.apache.usergrid.persistence.Schema.TYPE_ENTITY;\n-import static org.apache.usergrid.persistence.Schema.defaultCollectionName;\n import static org.apache.usergrid.persistence.Schema.getDefaultSchema;\n import static org.apache.usergrid.persistence.cassandra.ApplicationCF.ENTITY_DICTIONARIES;\n import static org.apache.usergrid.persistence.cassandra.ApplicationCF.ENTITY_INDEX;\n@@ -142,9 +141,9 @@\n \n     private static final Logger logger = LoggerFactory.getLogger( CpRelationManager.class );\n \n-    public static String COLLECTION_SUFFIX = \"\"; // TODO: do we need a suffix at all?\n+    private static final String ALL_TYPES = \"zzzalltypesnzzz\";\n \n-    public static String ALL_TYPES = \"zzzalltypesnzzz\";\n+    private static final String EDGE_COLL_SUFFIX = \"zzzcollzzz\";\n \n     private CpEntityManagerFactory emf;\n     \n@@ -171,45 +170,63 @@ public CpRelationManager() {}\n \n \n     public CpRelationManager init( \n-        EntityManager em, CpEntityManagerFactory emf, UUID applicationId,\n-        EntityRef headEntity, IndexBucketLocator indexBucketLocator ) {\n+        EntityManager em, \n+        CpEntityManagerFactory emf, \n+        UUID applicationId,\n+        EntityRef headEntity, \n+        IndexBucketLocator indexBucketLocator ) {\n \n         Assert.notNull( em, \"Entity manager cannot be null\" );\n+        Assert.notNull( emf, \"Entity manager factory cannot be null\" );\n         Assert.notNull( applicationId, \"Application Id cannot be null\" );\n         Assert.notNull( headEntity, \"Head entity cannot be null\" );\n         Assert.notNull( headEntity.getUuid(), \"Head entity uuid cannot be null\" );\n+       \n+        // TODO: this assert should not be failing\n+        //Assert.notNull( indexBucketLocator, \"indexBucketLocator cannot be null\" );\n \n         this.em = em;\n-        this.emf =emf;\n+        this.emf = emf;\n         this.applicationId = applicationId;\n         this.headEntity = headEntity;\n         this.managerCache = emf.getManagerCache();\n+        this.applicationScope = emf.getApplicationScope(applicationId);\n \n+        this.cass = em.getCass(); // TODO: eliminate need for this via Core Persistence\n+        this.indexBucketLocator = indexBucketLocator; // TODO: this also\n \n-        this.indexBucketLocator = indexBucketLocator;\n-\n-        String collectionName = Schema.defaultCollectionName( headEntity.getType() ); \n-\n-        this.applicationScope = emf.getApplicationScope(applicationId);\n \n+        // load the Core Persistence version of the head entity as well\n         this.headEntityScope = new CollectionScopeImpl( \n             this.applicationScope.getApplication(), \n             this.applicationScope.getApplication(), \n-            collectionName + COLLECTION_SUFFIX );\n+            CpEntityManager.getCollectionScopeNameFromEntityType( headEntity.getType()));\n \n         EntityCollectionManager ecm = managerCache.getEntityCollectionManager(headEntityScope);\n-        \n         this.cpHeadEntity = ecm.load( new SimpleId( \n             headEntity.getUuid(), headEntity.getType() )).toBlockingObservable().last();\n-\n         Assert.notNull( cpHeadEntity, \"cpHeadEntity cannot be null\" );\n \n-        this.cass = em.getCass();\n-\n         return this;\n     }\n \n     \n+    static String getEdgeTypeFromCollectionName( String name ) {\n+        String csn = name + EDGE_COLL_SUFFIX;\n+        return csn;\n+    }\n+\n+\n+    static boolean isConnectionEdgeType( String type )  {\n+        return type.endsWith( EDGE_COLL_SUFFIX );\n+    }\n+\n+    \n+    public String getConnectionName( String edgeType ) {\n+        return edgeType.substring( 0, edgeType.indexOf(EDGE_COLL_SUFFIX));\n+    }\n+\n+\n     @Override\n     public Set<String> getCollectionIndexes(String collectionName) throws Exception {\n         final Set<String> indexes = new HashSet<String>();\n@@ -270,18 +287,18 @@ public CpRelationManager init(\n             while ( iter.hasNext() ) {\n                 Edge edge = iter.next();\n \n-                if ( !edge.getType().endsWith(COLLECTION_SUFFIX) ) {\n+                if ( !isConnectionEdgeType( edge.getType()) ) {\n                     continue;\n                 }\n \n                 EntityRef eref = new SimpleEntityRef( \n                     edge.getSourceNode().getType(), edge.getSourceNode().getUuid() );\n \n-                String cEdgeType = edge.getType();\n-                if ( cEdgeType.endsWith( COLLECTION_SUFFIX )) {\n-                    cEdgeType = cEdgeType.substring( 0, cEdgeType.indexOf(COLLECTION_SUFFIX));\n+                String connectionName = null;\n+                if ( isConnectionEdgeType( edge.getType() )) {\n+                    connectionName = getConnectionName( edge.getType() );\n                 }\n-                addMapSet( results, eref, cEdgeType );\n+                addMapSet( results, eref, connectionName );\n             }\n \n             if ( limit > 0 && results.keySet().size() >= limit ) {\n@@ -291,7 +308,8 @@ public CpRelationManager init(\n \n         EntityRef applicationRef = new SimpleEntityRef( TYPE_APPLICATION, applicationId );\n         if ( !results.containsKey( applicationRef ) ) {\n-            addMapSet( results, applicationRef, defaultCollectionName( headEntity.getType() ) );\n+            addMapSet( results, applicationRef, \n+                    CpEntityManager.getCollectionScopeNameFromEntityType( headEntity.getType() ) );\n         }\n         return results;\n     }\n@@ -302,23 +320,23 @@ public CpRelationManager init(\n     @Override\n     public boolean isCollectionMember(String collName, EntityRef entity) throws Exception {\n \n-        // TODO: review & determine if this implementation is correct\n-\n         Id entityId = new SimpleId( entity.getUuid(), entity.getType() );\n \n         GraphManager gm = managerCache.getGraphManager(applicationScope);\n-        Observable<Edge> edges = gm.loadEdgeVersions(\n-                new SimpleSearchByEdge(new SimpleId(headEntity.getUuid(), headEntity.getType()), collName, entityId, UUIDGenerator.newTimeUUID(), null)\n-        );\n+        Observable<Edge> edges = gm.loadEdgeVersions( \n+                new SimpleSearchByEdge(\n+                    new SimpleId(headEntity.getUuid(), headEntity.getType()), \n+                    collName,  \n+                    entityId, \n+                    UUIDGenerator.newTimeUUID(), \n+                    null));\n \n         return edges.toBlockingObservable().firstOrDefault(null) != null;\n     }\n \n     @Override\n     public boolean isConnectionMember(String connectionName, EntityRef entity) throws Exception {\n \n-        // TODO: review / determine if this implementation is correct, it does not look right\n-\n         return isCollectionMember(connectionName, entity);\n     }\n \n@@ -362,9 +380,20 @@ public Entity addToCollection(String collName, EntityRef memberRef) throws Excep\n         CollectionScope memberScope = new CollectionScopeImpl( \n             applicationScope.getApplication(), \n             applicationScope.getApplication(), \n-            Schema.defaultCollectionName( memberRef.getType()) + COLLECTION_SUFFIX);\n+            CpEntityManager.getCollectionScopeNameFromEntityType( memberRef.getType()));\n         EntityCollectionManager memberMgr = managerCache.getEntityCollectionManager(memberScope);\n \n+        if ( logger.isDebugEnabled() ) {\n+            logger.debug(\"Loading member entity {}:{} from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    memberRef.getType(), \n+                    memberRef.getUuid(), \n+                    memberScope.getApplication(), \n+                    memberScope.getOwner(), \n+                    memberScope.getName() \n+            });\n+        }\n+\n         org.apache.usergrid.persistence.model.entity.Entity memberEntity = memberMgr.load(\n             new SimpleId( memberRef.getUuid(), memberRef.getType() )).toBlockingObservable().last();\n \n@@ -374,8 +403,9 @@ public Entity addToCollection(String collName, EntityRef memberRef) throws Excep\n         }\n \n         // create graph edge connection from head entity to member entity\n-        Edge edge = new SimpleMarkedEdge( cpHeadEntity.getId(), collName + COLLECTION_SUFFIX, \n-            memberEntity.getId(), UUIDGenerator.newTimeUUID(), false );\n+        Edge edge = new SimpleMarkedEdge( \n+            cpHeadEntity.getId(), getEdgeTypeFromCollectionName( collName ), memberEntity.getId(), \n+            UUIDGenerator.newTimeUUID(), false );\n \n         GraphManager gm = managerCache.getGraphManager(applicationScope);\n         gm.writeEdge(edge).toBlockingObservable().last();\n@@ -384,7 +414,7 @@ public Entity addToCollection(String collName, EntityRef memberRef) throws Excep\n         IndexScope collectionIndexScope = new IndexScopeImpl(\n             applicationScope.getApplication(), \n             cpHeadEntity.getId(), \n-            collName + COLLECTION_SUFFIX);\n+            CpEntityManager.getCollectionScopeNameFromCollectionName( collName ));\n         EntityIndex collectionIndex = managerCache.getEntityIndex(collectionIndexScope);\n         collectionIndex.index( memberEntity );\n \n@@ -477,36 +507,45 @@ public Entity createItemInCollection(\n     @Override\n     public void removeFromCollection(String collName, EntityRef memberRef) throws Exception {\n \n-//        if ( !collectionEntityExists(collName) ) {\n-//            return;\n-//        }\n-//\n-//        // look up collection entity in system collections scope \n-//        org.apache.usergrid.persistence.model.entity.Entity collectionEntity = \n-//            getCollectionEntity(collName);\n-\n-        // load the entity to be added to the collection\n+        // load the entity to be removed to the collection\n         CollectionScope memberScope = new CollectionScopeImpl( \n             this.applicationScope.getApplication(), \n             this.applicationScope.getApplication(), \n-            Schema.defaultCollectionName( memberRef.getType() ) + COLLECTION_SUFFIX );\n+            CpEntityManager.getCollectionScopeNameFromEntityType( memberRef.getType() ));\n         EntityCollectionManager memberMgr = managerCache.getEntityCollectionManager(memberScope);\n \n+        if ( logger.isDebugEnabled() ) {\n+            logger.debug(\"Loading entity to remove from collection \"\n+                    + \"{}:{} from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    memberRef.getType(), \n+                    memberRef.getUuid(), \n+                    memberScope.getApplication(), \n+                    memberScope.getOwner(), \n+                    memberScope.getName() \n+            });\n+        }\n+\n         org.apache.usergrid.persistence.model.entity.Entity memberEntity = memberMgr.load(\n             new SimpleId( memberRef.getUuid(), memberRef.getType() )).toBlockingObservable().last();\n \n         IndexScope indexScope = new IndexScopeImpl(\n             applicationScope.getApplication(), \n             cpHeadEntity.getId(), \n-            collName + COLLECTION_SUFFIX);\n+            CpEntityManager.getCollectionScopeNameFromCollectionName( collName ));\n \n+        // remove from collection index\n         EntityIndex ei = managerCache.getEntityIndex(indexScope);\n         ei.deindex( memberEntity );\n \n-        Edge edge = new SimpleMarkedEdge( cpHeadEntity.getId(), collName + COLLECTION_SUFFIX, \n-            memberEntity.getId(), UUIDGenerator.newTimeUUID(), false );\n+        // remove collection edge\n+        Edge edge = new SimpleMarkedEdge( cpHeadEntity.getId(), \n+            getEdgeTypeFromCollectionName( collName ), memberEntity.getId(), \n+            UUIDGenerator.newTimeUUID(), false );\n         GraphManager gm = managerCache.getGraphManager(applicationScope);\n         gm.deleteEdge(edge).toBlockingObservable().last();\n+\n+        // does not actually remove the entity itself\n     }\n \n \n@@ -532,7 +571,7 @@ public Results searchCollection(String collName, Query query) throws Exception {\n         IndexScope indexScope = new IndexScopeImpl(\n             applicationScope.getApplication(), \n             cpHeadEntity.getId(), \n-            collName + COLLECTION_SUFFIX);\n+            CpEntityManager.getCollectionScopeNameFromCollectionName( collName ));\n         EntityIndex ei = managerCache.getEntityIndex(indexScope);\n       \n         logger.debug(\"Searching collection {}\", collName);\n@@ -572,9 +611,21 @@ public ConnectionRef createConnection(\n         CollectionScope targetScope = new CollectionScopeImpl( \n             applicationScope.getApplication(), \n             applicationScope.getApplication(), \n-            Schema.defaultCollectionName( connectedEntityRef.getType() ) + COLLECTION_SUFFIX);\n+            CpEntityManager.getCollectionScopeNameFromEntityType( connectedEntityRef.getType() ));\n \n         EntityCollectionManager targetEcm = managerCache.getEntityCollectionManager(targetScope);\n+\n+        if ( logger.isDebugEnabled() ) {\n+            logger.debug(\"Loading connection target entity {}:{} from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    connectedEntityRef.getType(), \n+                    connectedEntityRef.getUuid(), \n+                    targetScope.getApplication(), \n+                    targetScope.getOwner(), \n+                    targetScope.getName() \n+            });\n+        }\n+\n         org.apache.usergrid.persistence.model.entity.Entity targetEntity = targetEcm.load(\n             new SimpleId( connectedEntityRef.getUuid(), connectedEntityRef.getType() ))\n                 .toBlockingObservable().last();\n@@ -590,7 +641,7 @@ public ConnectionRef createConnection(\n         IndexScope indexScope = new IndexScopeImpl(\n             applicationScope.getApplication(), \n             cpHeadEntity.getId(), \n-            connectionType + COLLECTION_SUFFIX);\n+            CpEntityManager.getCollectionScopeNameFromEntityType( connectionType ) );\n         EntityIndex ei = managerCache.getEntityIndex(indexScope);\n         ei.index( targetEntity );\n \n@@ -853,10 +904,18 @@ private Results buildResults(Query query, CandidateResults crs, String collName\n             CollectionScope collScope = new CollectionScopeImpl( \n                 applicationScope.getApplication(), \n                 applicationScope.getApplication(), \n-                Schema.defaultCollectionName( query.getEntityType() ) + COLLECTION_SUFFIX);\n-\n+                CpEntityManager.getCollectionScopeNameFromEntityType( query.getEntityType() ));\n             EntityCollectionManager ecm = managerCache.getEntityCollectionManager(collScope);\n \n+            if ( logger.isDebugEnabled() ) {\n+                logger.debug(\"Loading entities from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    collScope.getApplication(), \n+                    collScope.getOwner(), \n+                    collScope.getName() \n+                });\n+            }\n+\n             // first, build map of latest versions of entities\n             Map<Id, org.apache.usergrid.persistence.model.entity.Entity> latestVersions = \n                 new LinkedHashMap<Id, org.apache.usergrid.persistence.model.entity.Entity>();\n@@ -869,7 +928,7 @@ private Results buildResults(Query query, CandidateResults crs, String collName\n                 org.apache.usergrid.persistence.model.entity.Entity e =\n                     ecm.load( cr.getId() ).toBlockingObservable().last();\n \n-                if ( cr.getVersion().compareTo(e.getVersion()) < 0 )  {\n+                if ( cr.getVersion().compareTo( e.getVersion()) < 0 )  {\n                     logger.debug(\"Stale version uuid:{} type:{} v:{}\", \n                         new Object[] {cr.getId().getUuid(), cr.getId().getType(), cr.getVersion()});\n                     continue;\n@@ -1048,26 +1107,27 @@ public IndexUpdate batchUpdateCollectionIndex( IndexUpdate indexUpdate, EntityRe\n     }\n \n \n-    public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity entity, String entryName,\n-                                              Object entryValue, UUID timestampUuid, boolean schemaHasProperty,\n-                                              boolean isMultiValue, boolean removeListEntry, boolean fulltextIndexed )\n+    public IndexUpdate batchStartIndexUpdate( \n+            Mutator<ByteBuffer> batch, Entity entity, String entryName,\n+            Object entryValue, UUID timestampUuid, boolean schemaHasProperty,\n+             boolean isMultiValue, boolean removeListEntry, boolean fulltextIndexed )\n             throws Exception {\n-        return batchStartIndexUpdate( batch, entity, entryName, entryValue, timestampUuid, schemaHasProperty,\n-                isMultiValue, removeListEntry, fulltextIndexed, false );\n+        return batchStartIndexUpdate( batch, entity, entryName, entryValue, timestampUuid, \n+                schemaHasProperty, isMultiValue, removeListEntry, fulltextIndexed, false );\n     }\n \n \n     @Metered(group = \"core\", name = \"RelationManager_batchStartIndexUpdate\")\n-    public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity entity, String entryName,\n-                                              Object entryValue, UUID timestampUuid, boolean schemaHasProperty,\n-                                              boolean isMultiValue, boolean removeListEntry, boolean fulltextIndexed,\n-                                              boolean skipRead ) throws Exception {\n+    public IndexUpdate batchStartIndexUpdate( \n+        Mutator<ByteBuffer> batch, Entity entity, String entryName,\n+        Object entryValue, UUID timestampUuid, boolean schemaHasProperty,\n+        boolean isMultiValue, boolean removeListEntry, boolean fulltextIndexed,\n+        boolean skipRead ) throws Exception {\n \n         long timestamp = getTimestampInMicros( timestampUuid );\n \n-        IndexUpdate indexUpdate =\n-                new IndexUpdate( batch, entity, entryName, entryValue, schemaHasProperty, isMultiValue, removeListEntry,\n-                        timestampUuid );\n+        IndexUpdate indexUpdate = new IndexUpdate( batch, entity, entryName, entryValue, \n+                schemaHasProperty, isMultiValue, removeListEntry, timestampUuid );\n \n         // entryName = entryName.toLowerCase();\n \n@@ -1078,17 +1138,21 @@ public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity enti\n             List<HColumn<ByteBuffer, ByteBuffer>> entries = null;\n \n             if ( isMultiValue && validIndexableValue( entryValue ) ) {\n-                entries = cass.getColumns( cass.getApplicationKeyspace( applicationId ), ENTITY_INDEX_ENTRIES,\n-                        entity.getUuid(),\n-                        new DynamicComposite( entryName, indexValueCode( entryValue ), toIndexableValue( entryValue ) ),\n-                        setGreaterThanEqualityFlag( new DynamicComposite( entryName, indexValueCode( entryValue ),\n-                                toIndexableValue( entryValue ) ) ), INDEX_ENTRY_LIST_COUNT, false );\n+                entries = cass.getColumns( \n+                    cass.getApplicationKeyspace( applicationId ), ENTITY_INDEX_ENTRIES,\n+                        entity.getUuid(), new DynamicComposite( \n+                            entryName, indexValueCode( entryValue), toIndexableValue( entryValue )),\n+                        setGreaterThanEqualityFlag( \n+                            new DynamicComposite( entryName, indexValueCode( entryValue ),\n+                        toIndexableValue( entryValue ) ) ), INDEX_ENTRY_LIST_COUNT, false );\n             }\n             else {\n-                entries = cass.getColumns( cass.getApplicationKeyspace( applicationId ), ENTITY_INDEX_ENTRIES,\n-                        entity.getUuid(), new DynamicComposite( entryName ),\n-                        setGreaterThanEqualityFlag( new DynamicComposite( entryName ) ), INDEX_ENTRY_LIST_COUNT,\n-                        false );\n+                entries = cass.getColumns( \n+                    cass.getApplicationKeyspace( applicationId ), ENTITY_INDEX_ENTRIES,\n+                        entity.getUuid(), \n+                        new DynamicComposite( entryName ),\n+                        setGreaterThanEqualityFlag( \n+                            new DynamicComposite( entryName ) ), INDEX_ENTRY_LIST_COUNT, false );\n             }\n \n             if ( logger.isDebugEnabled() ) {\n@@ -1106,7 +1170,8 @@ public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity enti\n                 // new format:\n                 // composite(entryName,\n                 // value_code,prev_value,prev_timestamp,prev_obj_path) = null\n-                DynamicComposite composite = DynamicComposite.fromByteBuffer( entry.getName().duplicate() );\n+                DynamicComposite composite = \n+                        DynamicComposite.fromByteBuffer( entry.getName().duplicate() );\n                 prev_value = composite.get( 2 );\n                 prev_timestamp = ( UUID ) composite.get( 3 );\n                 if ( composite.size() > 4 ) {\n@@ -1120,7 +1185,8 @@ public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity enti\n                         entryPath = entryName + \".\" + prev_obj_path;\n                     }\n \n-                    indexUpdate.addPrevEntry( entryPath, prev_value, prev_timestamp, entry.getName().duplicate() );\n+                    indexUpdate.addPrevEntry( \n+                            entryPath, prev_value, prev_timestamp, entry.getName().duplicate() );\n \n                     // composite(property_value,connected_entity_id,entry_timestamp)\n                     // addDeleteToMutator(batch, ENTITY_INDEX_ENTRIES,\n@@ -1135,7 +1201,8 @@ public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity enti\n \n         if ( !isMultiValue || ( isMultiValue && !removeListEntry ) ) {\n \n-            List<Map.Entry<String, Object>> list = IndexUtils.getKeyValueList( entryName, entryValue, fulltextIndexed );\n+            List<Map.Entry<String, Object>> list = IndexUtils.getKeyValueList( \n+                    entryName, entryValue, fulltextIndexed );\n \n             if ( entryName.equalsIgnoreCase( \"location\" ) && ( entryValue instanceof Map ) ) {\n                 @SuppressWarnings(\"rawtypes\") double latitude =\n@@ -1149,14 +1216,18 @@ public IndexUpdate batchStartIndexUpdate( Mutator<ByteBuffer> batch, Entity enti\n             for ( Map.Entry<String, Object> indexEntry : list ) {\n \n                 if ( validIndexableValue( indexEntry.getValue() ) ) {\n-                    indexUpdate.addNewEntry( indexEntry.getKey(), toIndexableValue( indexEntry.getValue() ) );\n+                    indexUpdate.addNewEntry( \n+                            indexEntry.getKey(), toIndexableValue( indexEntry.getValue() ) );\n                 }\n             }\n \n             if ( isMultiValue ) {\n                 addInsertToMutator( batch, ENTITY_INDEX_ENTRIES, entity.getUuid(),\n-                        asList( entryName, indexValueCode( entryValue ), toIndexableValue( entryValue ),\n-                                indexUpdate.getTimestampUuid() ), null, timestamp );\n+                        asList( entryName, \n+                            indexValueCode( entryValue ), \n+                            toIndexableValue( entryValue ),\n+                            indexUpdate.getTimestampUuid() ),\n+                        null, timestamp );\n             }\n             else {\n                 // int i = 0;\n@@ -1174,7 +1245,8 @@ else if ( name.startsWith( entryName ) ) {\n                     byte code = indexValueCode( indexEntry.getValue() );\n                     Object val = toIndexableValue( indexEntry.getValue() );\n                     addInsertToMutator( batch, ENTITY_INDEX_ENTRIES, entity.getUuid(),\n-                            asList( entryName, code, val, indexUpdate.getTimestampUuid(), name ), null, timestamp );\n+                            asList( entryName, code, val, indexUpdate.getTimestampUuid(), name ), \n+                            null, timestamp );\n \n                     indexUpdate.addIndex( indexEntry.getKey() );\n                 }\n@@ -1196,12 +1268,14 @@ else if ( name.startsWith( entryName ) ) {\n      * @throws Exception the exception\n      */\n     @Metered(group = \"core\", name = \"RelationManager_batchUpdateBackwardConnectionsDictionaryIndexes\")\n-    public IndexUpdate batchUpdateBackwardConnectionsDictionaryIndexes( IndexUpdate indexUpdate ) throws Exception {\n+    public IndexUpdate batchUpdateBackwardConnectionsDictionaryIndexes( \n+            IndexUpdate indexUpdate ) throws Exception {\n \n         logger.debug( \"batchUpdateBackwardConnectionsListIndexes\" );\n \n         boolean entityHasDictionary = getDefaultSchema()\n-                .isDictionaryIndexedInConnections( indexUpdate.getEntity().getType(), indexUpdate.getEntryName() );\n+                .isDictionaryIndexedInConnections( \n+                        indexUpdate.getEntity().getType(), indexUpdate.getEntryName() );\n \n         if ( !entityHasDictionary ) {\n             return indexUpdate;\n@@ -1212,8 +1286,8 @@ public IndexUpdate batchUpdateBackwardConnectionsDictionaryIndexes( IndexUpdate\n     }\n \n     /**\n-     * Search each reverse connection type in the graph for connections.  If one is found, update the index\n-     * appropriately\n+     * Search each reverse connection type in the graph for connections.  \n+     * If one is found, update the index appropriately\n      *\n      * @param indexUpdate The index update to use\n      *\n@@ -1223,20 +1297,21 @@ private IndexUpdate doBackwardConnectionsUpdate( IndexUpdate indexUpdate ) throw\n         final Entity targetEntity = indexUpdate.getEntity();\n \n         final ConnectionTypesIterator connectionTypes =\n-                new ConnectionTypesIterator( cass, applicationId, targetEntity.getUuid(), false, 100 );\n+            new ConnectionTypesIterator( cass, applicationId, targetEntity.getUuid(), false, 100 );\n \n         for ( String connectionType : connectionTypes ) {\n \n-            PagingResultsIterator itr = getReversedConnectionsIterator( targetEntity, connectionType );\n+            PagingResultsIterator itr = \n+                    getReversedConnectionsIterator( targetEntity, connectionType );\n \n             for ( Object connection : itr ) {\n \n                 final ConnectedEntityRef sourceEntity = ( ConnectedEntityRef ) connection;\n \n-                //we need to create a connection ref from the source entity (found via reverse edge) to the entity\n-                // we're about to update.  This is the index that needs updated\n+                //we need to create a connection ref from the source entity (found via reverse edge) \n+                // to the entity we're about to update.  This is the index that needs updated\n                 final ConnectionRefImpl connectionRef =\n-                        new ConnectionRefImpl( sourceEntity, connectionType, indexUpdate.getEntity() );\n+                    new ConnectionRefImpl( sourceEntity, connectionType, indexUpdate.getEntity() );\n \n                 batchUpdateConnectionIndex( indexUpdate, connectionRef );\n             }\n@@ -1256,8 +1331,8 @@ private IndexUpdate doBackwardConnectionsUpdate( IndexUpdate indexUpdate ) throw\n      * @throws Exception the exception\n      */\n     @Metered(group = \"core\", name = \"RelationManager_batchUpdateConnectionIndex\")\n-    public IndexUpdate batchUpdateConnectionIndex( IndexUpdate indexUpdate, ConnectionRefImpl connection )\n-            throws Exception {\n+    public IndexUpdate batchUpdateConnectionIndex( \n+            IndexUpdate indexUpdate, ConnectionRefImpl connection ) throws Exception {\n \n         // UUID connection_id = connection.getUuid();\n \n@@ -1271,18 +1346,21 @@ public IndexUpdate batchUpdateConnectionIndex( IndexUpdate indexUpdate, Connecti\n                 batchDeleteConnectionIndexEntries( indexUpdate, entry, connection, index_keys );\n \n                 if ( \"location.coordinates\".equals( entry.getPath() ) ) {\n-                    EntityLocationRef loc = new EntityLocationRef( indexUpdate.getEntity(), entry.getTimestampUuid(),\n-                            entry.getValue().toString() );\n-                    batchDeleteLocationInConnectionsIndex( indexUpdate.getBatch(), indexBucketLocator, applicationId,\n-                            index_keys, entry.getPath(), loc );\n+                    EntityLocationRef loc = \n+                        new EntityLocationRef( indexUpdate.getEntity(), entry.getTimestampUuid(),\n+                        entry.getValue().toString() );\n+                    batchDeleteLocationInConnectionsIndex( \n+                        indexUpdate.getBatch(), indexBucketLocator, applicationId,\n+                        index_keys, entry.getPath(), loc );\n                 }\n             }\n             else {\n                 logger.error( \"Unexpected condition - deserialized property value is null\" );\n             }\n         }\n \n-        if ( ( indexUpdate.getNewEntries().size() > 0 ) && ( !indexUpdate.isMultiValue() || ( indexUpdate.isMultiValue()\n+        if ( ( indexUpdate.getNewEntries().size() > 0 ) \n+                && ( !indexUpdate.isMultiValue() || ( indexUpdate.isMultiValue()\n                 && !indexUpdate.isRemoveListEntry() ) ) ) {\n \n             for ( IndexUpdate.IndexEntry indexEntry : indexUpdate.getNewEntries() ) {\n@@ -1291,9 +1369,12 @@ public IndexUpdate batchUpdateConnectionIndex( IndexUpdate indexUpdate, Connecti\n \n                 if ( \"location.coordinates\".equals( indexEntry.getPath() ) ) {\n                     EntityLocationRef loc =\n-                            new EntityLocationRef( indexUpdate.getEntity(), indexEntry.getTimestampUuid(),\n+                            new EntityLocationRef( \n+                                    indexUpdate.getEntity(), \n+                                    indexEntry.getTimestampUuid(),\n                                     indexEntry.getValue().toString() );\n-                    batchStoreLocationInConnectionsIndex( indexUpdate.getBatch(), indexBucketLocator, applicationId,\n+                    batchStoreLocationInConnectionsIndex( \n+                            indexUpdate.getBatch(), indexBucketLocator, applicationId,\n                             index_keys, indexEntry.getPath(), loc );\n                 }\n             }\n@@ -1309,7 +1390,7 @@ public IndexUpdate batchUpdateConnectionIndex( IndexUpdate indexUpdate, Connecti\n \n         for ( String index : indexUpdate.getIndexesSet() ) {\n             addInsertToMutator( indexUpdate.getBatch(), ENTITY_DICTIONARIES,\n-                    key( connection.getConnectingIndexId(), Schema.DICTIONARY_INDEXES ), index, null,\n+                    key( connection.getConnectingIndexId(), Schema.DICTIONARY_INDEXES), index, null,\n                     indexUpdate.getTimestamp() );\n         }\n \n@@ -1323,9 +1404,11 @@ public IndexUpdate batchUpdateConnectionIndex( IndexUpdate indexUpdate, Connecti\n      *\n      * @return connectionType The name of the edges to search\n      */\n-    private PagingResultsIterator getReversedConnectionsIterator( EntityRef targetEntity, String connectionType )\n-            throws Exception {\n-        return new PagingResultsIterator( getConnectingEntities( targetEntity, connectionType, null, Level.REFS ) );\n+    private PagingResultsIterator getReversedConnectionsIterator( \n+            EntityRef targetEntity, String connectionType ) throws Exception {\n+\n+        return new PagingResultsIterator( \n+                getConnectingEntities( targetEntity, connectionType, null, Level.REFS ) );\n     }\n \n     /**\n@@ -1336,9 +1419,12 @@ private PagingResultsIterator getReversedConnectionsIterator( EntityRef targetEn\n      * @param connectedEntityType The connected entity type, if not specified all types are returned\n      * @param resultsLevel The results level to return\n      */\n-    private Results getConnectingEntities( EntityRef targetEntity, String connectionType, String connectedEntityType,\n-                                           Level resultsLevel ) throws Exception {\n-        return getConnectingEntities(targetEntity, connectionType, connectedEntityType, resultsLevel, 0);\n+    private Results getConnectingEntities( \n+            EntityRef targetEntity, String connectionType, String connectedEntityType,\n+            Level resultsLevel ) throws Exception {\n+\n+        return getConnectingEntities(\n+                targetEntity, connectionType, connectedEntityType, resultsLevel, 0);\n     }\n \n     /**\n@@ -1349,8 +1435,9 @@ private Results getConnectingEntities( EntityRef targetEntity, String connection\n      * @param connectedEntityType The connected entity type, if not specified all types are returned\n      * @param count result limit\n      */\n-    private Results getConnectingEntities(EntityRef targetEntity,\n-                                          String connectionType, String connectedEntityType, Level level, int count) throws Exception {\n+    private Results getConnectingEntities( EntityRef targetEntity, String connectionType, \n+            String connectedEntityType, Level level, int count) throws Exception {\n+\n         Query query = new Query();\n         query.setResultsLevel( level );\n         query.setLimit(count);",
                "additions": 194,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "status": "modified",
                "changes": 301,
                "deletions": 107,
                "sha": "56fb1152701c43eda5580908fa5f94d5733fba96",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -681,6 +681,7 @@ void batchCreateRole(Mutator<ByteBuffer> batch, UUID groupId, String roleName,\n \n     // things added for Core Persistence\n \n+    // testing only\n     void refreshIndex();\n \n     public void init( EntityManagerFactory emf, UUID applicationId);",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "status": "modified",
                "changes": 1,
                "deletions": 0,
                "sha": "902913f874423e538a36d5a0900ec2445d0828db",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -2853,11 +2853,6 @@ public void revokeGroupPermission( UUID groupId, String permission ) throws Exce\n         removeFromDictionary( groupRef( groupId ), DICTIONARY_PERMISSIONS, permission );\n     }\n \n-    @Override\n-    public void refreshIndex() {\n-        // no action necessary\n-    }\n-\n     @Override\n     public Results getEntities(List<UUID> ids, String type) {\n \n@@ -2880,4 +2875,9 @@ public Results getEntities(List<UUID> ids, String type) {\n         return Results.fromEntities( entities );\n     }\n \n+    @Override\n+    public void refreshIndex() {\n+        // no action necessary\n+    }\n+\n }",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "status": "modified",
                "changes": 10,
                "deletions": 5,
                "sha": "b328ecc76d89b637b9c018195cfa1e4343074780",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/EntityManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/cassandra/EntityManagerImpl.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -1796,7 +1796,6 @@ public void duplicateNameTest() throws Exception {\n         Entity createdRestaurant = em.create( \"restaurant\", restaurant.getProperties() );\n         assertNotNull( createdRestaurant );\n \n-\n         //we create 2 entities, otherwise this test will pass when it shouldn't\n         DynamicEntity restaurant2 = new DynamicEntity();\n         restaurant2.setName( \"4peaks\" );",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/java/org/apache/usergrid/persistence/CollectionIT.java",
                "status": "modified",
                "changes": 1,
                "deletions": 1,
                "sha": "a91a5d2ec3b32ec2289ab8dfb93aa24de8fa3374",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/java/org/apache/usergrid/persistence/CollectionIT.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/CollectionIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/CollectionIT.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -46,7 +46,7 @@\n public abstract class AbstractIteratingQueryIT {\n     private static final Logger LOG = LoggerFactory.getLogger( AbstractIteratingQueryIT.class );\n \n-    public static final long WRITE_DELAY = 50; // milliseconds to delay between writes in loop\n+    public static final long WRITE_DELAY = 200; // milliseconds to delay between writes in loop\n \n     @ClassRule\n     public static CoreITSetup setup = new CoreITSetupImpl( ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/java/org/apache/usergrid/persistence/query/AbstractIteratingQueryIT.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "874399f04868c6cd28a5954d2cf320c2f48e0eaf",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/java/org/apache/usergrid/persistence/query/AbstractIteratingQueryIT.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/query/AbstractIteratingQueryIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/query/AbstractIteratingQueryIT.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -0,0 +1,44 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+\n+# Hystrix Configuration\n+\n+# See also https://github.com/Netflix/Hystrix/wiki/Configuration\n+\n+# This can be set to THREAD or SEMAPHORE. In most cases it is recommended to \n+# stick with the default which is to run commands using thread isolation.\n+# Commands executed in threads have an extra layer of protection against \n+# latencies beyond what network timeouts can offer.\n+#hystrix.command.default.execution.isolation.strategy=THREAD\n+#hystrix.command.user.execution.isolation.strategy=THREAD\n+#hystrix.command.async.execution.isolation.strategy=THREAD\n+\n+# have to use these weird class names; may indicate a bug in Hystrix\n+hystrix.command.HystrixObservable$1.execution.isolation.strategy=THREAD\n+hystrix.command.HystrixObservable$2.execution.isolation.strategy=THREAD\n+\n+# Max number of concurrent HystrixCommands that can be executed\n+# This ONLY applies when isolation strategy is THREAD\n+hystrix.threadpool.default.coreSize=400\n+#hystrix.threadpool.user.coreSize=912\n+#hystrix.threadpool.async.coreSize=913\n+\n+# Max number of requests allowed to a method\n+# This ONLY applies when isolation strategy is SEMAPHORE\n+hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests=800\n+#hystrix.command.user.execution.isolation.semaphore.maxConcurrentRequests=315\n+#hystrix.command.async.execution.isolation.semaphore.maxConcurrentRequests=316",
                "additions": 44,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/resources/config.properties",
                "status": "added",
                "changes": 44,
                "deletions": 0,
                "sha": "ea438371166bebc85cb2ed6f377820440b4b95c9",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/resources/config.properties",
                "filename": "stack/core/src/test/resources/config.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/resources/config.properties?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -1,46 +1,17 @@\n-# Keep nothing but overriding test defaults in here\n-\n-cassandra.embedded=true\n-cassandra.hosts=127.0.0.1\n-cassandra.port=9160\n-cassandra.version=1.2\n-cassandra.cluster_name=Usergrid\n-cassandra.timeout=2000\n-\n-# Should be set to same value as Hystrix max requests or thread pool size?\n-cassandra.connections=500\n-\n-collections.keyspace=Usergrid_Applications\n-collections.keyspace.strategy.options=replication_factor:1\n-collections.keyspace.strategy.class=org.apache.cassandra.locator.SimpleStrategy\n-\n-collection.stage.transient.timeout=60\n-\n-elasticsearch.embedded=true\n-elasticsearch.cluster_name=usergrid\n-elasticsearch.index_prefix=usergrid\n-elasticsearch.hosts=127.0.0.1\n-elasticsearch.port=9300\n-\n-index.query.limit.default=100\n-\n-# Hystrix Configuration\n-# See also https://github.com/Netflix/Hystrix/wiki/Configuration\n-\n-# This can be set to THREAD or SEMAPHORE. In most cases it is recommended to \n-# stick with the default which is to run commands using thread isolation.\n-# Commands executed in threads have an extra layer of protection against \n-# latencies beyond what network timeouts can offer.\n-hystrix.command.default.execution.isolation.strategy=THREAD\n-hystrix.command.user.execution.isolation.strategy=THREAD\n-hystrix.command.async.execution.isolation.strategy=THREAD\n-\n-# Max number of concurrent HystrixCommands that can be executed\n-# This ONLY applies when isolation strategy is THREAD\n-hystrix.threadpool.user.coreSize=500\n-hystrix.threadpool.default.coreSize=500\n-hystrix.threadpool.async.coreSize=500\n-\n-# Max number of requests allowed to a method\n-# This ONLY applies when isolation strategy is SEMAPHORE\n-execution.isolation.semaphore.maxConcurrentRequests=50\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Overrides",
                "additions": 17,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/resources/corepersistence-UNIT.properties",
                "status": "modified",
                "changes": 63,
                "deletions": 46,
                "sha": "a09c0fb5fc8ceb6fd65920bb1dbe394c6e3314dc",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/resources/corepersistence-UNIT.properties",
                "filename": "stack/core/src/test/resources/corepersistence-UNIT.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/resources/corepersistence-UNIT.properties?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -1,23 +0,0 @@\n-# The properties are not the actual configuration properties but\n-# safe dynamic property defaults for our testing via IDE or Maven\n-\n-collections.keyspace=Usergrid_Applications\n-collections.keyspace.strategy.options=replication_factor:1\n-collections.keyspace.strategy.class=SimpleStrategy\n-collection.stage.transient.timeout=60\n-\n-cassandra.connections=10\n-cassandra.port=9160\n-cassandra.version=1.2\n-cassandra.hosts=localhost\n-cassandra.cluster_name=Usergrid\n-cassandra.timeout=5000\n-\n-index.query.limit.default=10\n-\n-elasticsearch.indexname=Usergrid\n-elasticsearch.embedded=true\n-elasticsearch.force-refresh=false\n-\n-\n-",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/194383cd3dcbd9586cd141debf08d27cee437931/stack/core/src/test/resources/corepersistence.properties",
                "status": "removed",
                "changes": 23,
                "deletions": 23,
                "sha": "b6e2d94afc355d8570977e0f92ec66c174878bfc",
                "blob_url": "https://github.com/apache/usergrid/blob/194383cd3dcbd9586cd141debf08d27cee437931/stack/core/src/test/resources/corepersistence.properties",
                "filename": "stack/core/src/test/resources/corepersistence.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/resources/corepersistence.properties?ref=194383cd3dcbd9586cd141debf08d27cee437931"
            },
            {
                "patch": "@@ -37,8 +37,10 @@ log4j.appender.stdout.layout.ConversionPattern=%d %p (%t) %c{1} - %m%n\n #log4j.logger.me.prettyprint.hector.api.beans.AbstractComposite=ERROR, stdout\n #log4j.logger.org.apache.usergrid.locking.singlenode.SingleNodeLockManagerImpl=DEBUG, stdout\n \n-log4j.logger.org.apache.usergrid=INFO\n-log4j.logger.org.antlr=DEBUG\n+log4j.logger.org.apache.usergrid.persistence=INFO\n+#log4j.logger.org.apache.usergrid.corepersistence=DEBUG\n+#log4j.logger.com.netflix.hystrix=DEBUG\n+#log4j.logger.org.antlr=DEBUG\n \n #log4j.logger.org.apache.usergrid.persistence.CollectionIT=DEBUG\n #log4j.logger.org.apache.usergrid.persistence.index=DEBUG",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/resources/log4j.properties",
                "status": "modified",
                "changes": 6,
                "deletions": 2,
                "sha": "75dc4d808d6f579a51d921e6f618ad654a518811",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/core/src/test/resources/log4j.properties",
                "filename": "stack/core/src/test/resources/log4j.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/resources/log4j.properties?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -269,9 +269,16 @@ private static String createCollectionScopeTypeName( IndexScope scope ) {\n     @Override\n     public void index( Entity entity ) {\n \n-        log.debug(\"Indexing entity:  \" + entity.getId().toString());\n-                log.debug(\"    Index Name:   \" + this.indexName);\n-                log.debug(\"    ES Type:      \" + this.indexType);\n+        if ( log.isDebugEnabled() ) {\n+            log.debug(\"Indexing entity {}:{} in scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    entity.getId().getType(), \n+                    entity.getId().getUuid(), \n+                    indexScope.getApplication(), \n+                    indexScope.getOwner(), \n+                    indexScope.getName() \n+            });\n+        }\n \n         ValidationUtils.verifyEntityWrite(entity);\n \n@@ -320,13 +327,21 @@ public void index( Entity entity ) {\n     @Override\n     public void deindex( final Id id, final UUID version) {\n \n+        if ( log.isDebugEnabled() ) {\n+            log.debug(\"De-indexing entity {}:{} in scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                new Object[] { \n+                    id.getType(), \n+                    id.getUuid(), \n+                    indexScope.getApplication(), \n+                    indexScope.getOwner(), \n+                    indexScope.getName() \n+            });\n+        }\n \n-        String indexId = createIndexDocId( id, version );\n-\n-        client\n-                .prepareDelete( indexName, indexType, indexId )\n-                .setRefresh( refresh )\n-                .execute().actionGet();\n+        String indexId = createIndexDocId( id, version ); \n+        client.prepareDelete( indexName, indexType, indexId )\n+            .setRefresh( refresh )\n+            .execute().actionGet();\n \n         log.debug(\"Deindexed Entity with index id \" + indexId);\n     }\n@@ -348,12 +363,15 @@ public void deindex( CandidateResult entity ) {\n     public CandidateResults search(Query query) {\n \n         QueryBuilder qb = query.createQueryBuilder();\n-        \n-        log.debug(\"Search\");\n-        log.debug(\"    Index Name: \" + this.indexName);\n-        log.debug(\"    ES Type:    \" + this.indexType);\n-        log.debug(\"    Query:      \" + qb.toString().replace(\"\\n\", \" \") );\n-        \n+\n+        if ( log.isDebugEnabled() ) {\n+            log.debug(\"Searching index {}\\n   type {}\\n   query {}\", \n+                new Object[] { \n+                    this.indexName,\n+                    this.indexType,\n+                    qb.toString().replace(\"\\n\", \" \") \n+            });\n+        }\n             \n         SearchResponse searchResponse;\n         if (query.getCursor() == null) {",
                "additions": 33,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "status": "modified",
                "changes": 48,
                "deletions": 15,
                "sha": "88123a3f530e625cab888510873abc1e75310ac5",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsEntityIndexImpl.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -19,16 +19,13 @@\n package org.apache.usergrid.persistence.index.utils;\n \n \n-import org.apache.usergrid.persistence.collection.mvcc.entity.MvccEntity;\n import org.apache.usergrid.persistence.index.IndexScope;\n \n import com.google.common.base.Preconditions;\n \n import static org.apache.usergrid.persistence.core.util.ValidationUtils.validateApplicationScope;\n-import static org.apache.usergrid.persistence.core.util.ValidationUtils.verifyEntityWrite;\n import static org.apache.usergrid.persistence.core.util.ValidationUtils.verifyIdentity;\n import static org.apache.usergrid.persistence.core.util.ValidationUtils.verifyString;\n-import static org.apache.usergrid.persistence.core.util.ValidationUtils.verifyTimeUuid;\n \n \n /**",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/utils/IndexValidationUtils.java",
                "status": "modified",
                "changes": 3,
                "deletions": 3,
                "sha": "899e7b0f7636356e0752f2e5028667a46eac4693",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/utils/IndexValidationUtils.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/utils/IndexValidationUtils.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/utils/IndexValidationUtils.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -34,7 +34,9 @@\n import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.UriInfo;\n \n+import org.apache.usergrid.management.exceptions.ManagementException;\n import org.apache.usergrid.rest.RootResource;\n+import org.apache.usergrid.services.exceptions.ServiceResourceNotFoundException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n@@ -76,8 +78,7 @@ public UsersResource() {\n     @Path(RootResource.USER_ID_PATH)\n     public UserResource getUserById( @Context UriInfo ui, @PathParam( \"userId\" ) String userIdStr ) throws Exception {\n \n-        return getSubResource( UserResource.class )\n-                .init( management.getAdminUserByUuid( UUID.fromString( userIdStr ) ) );\n+        return getUserResource(management.getAdminUserByUuid(UUID.fromString(userIdStr)), \"user id\", userIdStr);\n     }\n \n \n@@ -93,14 +94,21 @@ public UserResource getUserByUsername( @Context UriInfo ui, @PathParam( \"usernam\n             throw mappableSecurityException( \"unauthorized\", \"No admin identity for access credentials provided\" );\n         }\n \n-        return getSubResource( UserResource.class ).init( management.getAdminUserByUsername( username ) );\n+        return getUserResource(management.getAdminUserByUsername(username), \"username\", username);\n+    }\n+\n+    private UserResource getUserResource(UserInfo user, String type, String value) throws ManagementException {\n+        if (user == null) {\n+            throw new ManagementException(\"Could not find organization for \" + type + \" : \" + value);\n+        }\n+        return getSubResource(UserResource.class).init(user);\n     }\n \n \n     @Path(RootResource.EMAIL_PATH)\n     public UserResource getUserByEmail( @Context UriInfo ui, @PathParam( \"email\" ) String email ) throws Exception {\n \n-        return getSubResource( UserResource.class ).init( management.getAdminUserByEmail( email ) );\n+        return getUserResource(management.getAdminUserByEmail(email), \"email\", email);\n     }\n \n ",
                "additions": 12,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java",
                "status": "modified",
                "changes": 16,
                "deletions": 4,
                "sha": "89d54689114d3f1c2a45199c663853c81a8df695",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/management/users/UsersResource.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -27,16 +27,18 @@\n import javax.ws.rs.core.MediaType;\n \n import org.codehaus.jackson.JsonNode;\n+import org.junit.Ignore;\n import org.junit.Test;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.apache.usergrid.cassandra.Concurrent;\n import org.usergrid.java.client.Client.Query;\n import org.usergrid.java.client.entities.Activity;\n import org.usergrid.java.client.entities.Activity.ActivityObject;\n import org.usergrid.java.client.entities.Entity;\n import org.usergrid.java.client.entities.User;\n import org.usergrid.java.client.response.ApiResponse;\n+\n+import org.apache.usergrid.cassandra.Concurrent;\n import org.apache.usergrid.management.ApplicationInfo;\n import org.apache.usergrid.management.OrganizationInfo;\n import org.apache.usergrid.rest.AbstractRestIT;\n@@ -46,14 +48,14 @@\n import com.sun.jersey.api.client.ClientResponse.Status;\n import com.sun.jersey.api.client.UniformInterfaceException;\n \n+import static org.apache.usergrid.rest.applications.utils.TestUtils.getIdFromSearchResults;\n+import static org.apache.usergrid.utils.MapUtils.hashMap;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertNull;\n import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n-import static org.apache.usergrid.rest.applications.utils.TestUtils.getIdFromSearchResults;\n-import static org.apache.usergrid.utils.MapUtils.hashMap;\n \n \n /**\n@@ -74,8 +76,8 @@ public void usernameQuery() {\n         String ql = \"username = 'user*'\";\n \n         JsonNode node = resource().path( \"/test-organization/test-app/users\" ).queryParam( \"ql\", ql )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user1\" ), getIdFromSearchResults( node, 0 ) );\n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user2\" ), getIdFromSearchResults( node, 1 ) );\n@@ -91,8 +93,8 @@ public void nameQuery() {\n         String ql = \"name = 'John*'\";\n \n         JsonNode node = resource().path( \"/test-organization/test-app/users\" ).queryParam( \"ql\", ql )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user2\" ), getIdFromSearchResults( node, 0 ) );\n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user3\" ), getIdFromSearchResults( node, 1 ) );\n@@ -109,8 +111,8 @@ public void nameQueryByUUIDs() throws Exception {\n         OrganizationInfo orgInfo = setup.getMgmtSvc().getOrganizationByName( \"test-organization\" );\n \n         resource().path( \"/\" + orgInfo.getUuid() + \"/\" + appInfo.getId() + \"/users\" ).queryParam( \"ql\", ql )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n     }\n \n \n@@ -122,16 +124,18 @@ public void nameFullTextQuery() {\n         String ql = \"name contains 'Smith' order by name \";\n \n         JsonNode node = resource().path( \"/test-organization/test-app/users\" ).queryParam( \"ql\", ql )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user1\" ), getIdFromSearchResults( node, 0 ) );\n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user2\" ), getIdFromSearchResults( node, 1 ) );\n         assertEquals( UserRepo.INSTANCE.getByUserName( \"user3\" ), getIdFromSearchResults( node, 2 ) );\n     }\n \n \n-    /** Tests that when a full text index is run on a field that isn't full text indexed an error is thrown */\n+    /**\n+     * Tests that when a full text index is run on a field that isn't full text indexed an error is thrown\n+     */\n     @Test(expected = UniformInterfaceException.class)\n     public void fullTextQueryNotFullTextIndexed() {\n \n@@ -140,12 +144,15 @@ public void fullTextQueryNotFullTextIndexed() {\n         String ql = \"username contains 'user' \";\n \n         resource().path( \"/test-organization/test-app/users\" ).queryParam( \"ql\", ql )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n     }\n \n \n-    /** Tests that when a full text index is run on a field that isn't full text indexed an error is thrown */\n+    /**\n+     * Tests that when a full text index is run on a field that isn't full text indexed an error is thrown\n+     */\n+    @Ignore(\"This test is being ignored as users \")\n     @Test(expected = UniformInterfaceException.class)\n     public void fullQueryNotIndexed() {\n \n@@ -154,12 +161,14 @@ public void fullQueryNotIndexed() {\n         String ql = \"picture = 'foo' \";\n \n         resource().path( \"/test-organization/test-app/users\" ).queryParam( \"ql\", ql )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n     }\n \n \n-    /** Test that when activity is pushed with not actor, it's set to the user who created it */\n+    /**\n+     * Test that when activity is pushed with not actor, it's set to the user who created it\n+     */\n     @Test\n     public void emtpyActorActivity() {\n         UserRepo.INSTANCE.load( resource(), access_token );\n@@ -190,7 +199,9 @@ public void emtpyActorActivity() {\n     }\n \n \n-    /** Insert the uuid and email if they're empty in the request */\n+    /**\n+     * Insert the uuid and email if they're empty in the request\n+     */\n     @Test\n     public void noUUIDorEmail() {\n \n@@ -229,7 +240,9 @@ public void noUUIDorEmail() {\n     }\n \n \n-    /** Don't touch the UUID when it's already set in the JSON */\n+    /**\n+     * Don't touch the UUID when it's already set in the JSON\n+     */\n     @Test\n     public void ignoreUUIDandEmail() {\n         UserRepo.INSTANCE.load( resource(), access_token );\n@@ -273,7 +286,9 @@ public void ignoreUUIDandEmail() {\n     }\n \n \n-    /** Test that when activity is pushed with not actor, it's set to the user who created it */\n+    /**\n+     * Test that when activity is pushed with not actor, it's set to the user who created it\n+     */\n     @Test\n     public void userActivitiesDefaultOrder() {\n         UserRepo.INSTANCE.load( resource(), access_token );\n@@ -333,25 +348,27 @@ public void getUserWIthEmailUsername() {\n \n         // get the user with username property that has an email value\n         JsonNode node = resource().path( \"/test-organization/test-app/users/\" + username )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( username, node.get( \"entities\" ).get( 0 ).get( \"username\" ).asText() );\n         assertEquals( name, node.get( \"entities\" ).get( 0 ).get( \"name\" ).asText() );\n         assertEquals( email, node.get( \"entities\" ).get( 0 ).get( \"email\" ).asText() );\n \n         // get the user with email property value\n         node = resource().path( \"/test-organization/test-app/users/\" + email )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( username, node.get( \"entities\" ).get( 0 ).get( \"username\" ).asText() );\n         assertEquals( name, node.get( \"entities\" ).get( 0 ).get( \"name\" ).asText() );\n         assertEquals( email, node.get( \"entities\" ).get( 0 ).get( \"email\" ).asText() );\n     }\n \n \n-    /** Tests that when querying all users, we get the same result size when using \"order by\" */\n+    /**\n+     * Tests that when querying all users, we get the same result size when using \"order by\"\n+     */\n     @Test\n     public void resultSizeSame() {\n         UserRepo.INSTANCE.load( resource(), access_token );\n@@ -436,8 +453,8 @@ public void deleteUser() {\n         UUID createdId = response.getEntities().get( 0 ).getUuid();\n \n         JsonNode node = resource().path( \"/test-organization/test-app/users/\" + createdId )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).delete( JsonNode.class );\n+                                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).delete( JsonNode.class );\n \n         assertNull( node.get( \"errors\" ) );\n \n@@ -487,43 +504,43 @@ public void singularCollectionName() {\n \n         JsonNode node =\n                 resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                        .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                          .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         // singular collection name\n         path = String.format( \"/test-organization/test-app/user/%s/conn2/%s\", firstCreatedId, secondCreatedId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         path = String.format( \"/test-organization/test-app/users/%s/conn1\", firstCreatedId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         path = String.format( \"/test-organization/test-app/user/%s/conn1\", firstCreatedId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         path = String.format( \"/test-organization/test-app/users/%s/conn2\", firstCreatedId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         path = String.format( \"/test-organization/test-app/user/%s/conn2\", firstCreatedId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n     }\n@@ -561,21 +578,23 @@ public void connectionByNameAndType() {\n \n         JsonNode node =\n                 resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                        .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                          .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         // named entity in collection name\n         path = String.format( \"/test-organization/test-app/users/%s/conn2/users/%s\", username1, username2 );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n     }\n \n \n-    /** Usergrid-1222 test */\n+    /**\n+     * Usergrid-1222 test\n+     */\n     @Test\n     public void connectionQuerybyEmail() {\n         UUID id = UUIDUtils.newTimeUUID();\n@@ -607,7 +626,7 @@ public void connectionQuerybyEmail() {\n \n         JsonNode node =\n                 resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                        .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, perms );\n+                          .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, perms );\n \n \n         //Create the second role\n@@ -628,14 +647,14 @@ public void connectionQuerybyEmail() {\n         path = String.format( \"/test-organization/test-app/roles/%s/permissions\", roleId2 );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, perms );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, perms );\n \n \n         //connect the entities where role is the root\n         path = String.format( \"/test-organization/test-app/roles/%s/users/%s\", roleId1, userId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         // now create a connection of \"likes\" between the first user and the\n         // second using pluralized form\n@@ -647,7 +666,7 @@ public void connectionQuerybyEmail() {\n         path = String.format( \"/test-organization/test-app/roles/%s/users/%s\", roleId2, userId );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n \n         assertEquals( userId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n@@ -656,8 +675,9 @@ public void connectionQuerybyEmail() {\n         path = String.format( \"/test-organization/test-app/roles/%s/users\", roleId2 );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token )\n-                .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .get( JsonNode.class );\n \n         assertEquals( userId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n@@ -666,8 +686,9 @@ public void connectionQuerybyEmail() {\n         path = String.format( \"/test-organization/test-app/roles/%s/users\", roleId1 );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token )\n-                .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .get( JsonNode.class );\n \n         assertEquals( userId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n@@ -676,15 +697,16 @@ public void connectionQuerybyEmail() {\n         path = String.format( \"/test-organization/test-app/roles/%s\", roleId1 );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).delete( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).delete( JsonNode.class );\n \n         //query the first role, it should 404\n         path = String.format( \"/test-organization/test-app/roles/%s/users\", roleId1 );\n \n         try {\n             node = resource().path( path ).queryParam( \"access_token\", access_token )\n-                    .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n-                    .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .get( JsonNode.class );\n         }\n         catch ( UniformInterfaceException e ) {\n             assertEquals( Status.NOT_FOUND, e.getResponse().getClientResponseStatus() );\n@@ -694,8 +716,9 @@ public void connectionQuerybyEmail() {\n         path = String.format( \"/test-organization/test-app/roles/%s/users\", roleId2 );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token )\n-                .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"ql\", \"select%20*%20where%20username%20=%20'\" + email + \"'\" )\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .get( JsonNode.class );\n \n         assertEquals( userId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n     }\n@@ -736,15 +759,15 @@ public void connectionByNameAndDynamicType() {\n \n         JsonNode node =\n                 resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                        .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                          .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n \n         // named entity in collection name\n         path = String.format( \"/test-organization/test-app/users/%s/conn2/pizzas/%s\", username1, name );\n \n         node = resource().path( path ).queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         assertEquals( secondCreatedId.toString(), getEntity( node, 0 ).get( \"uuid\" ).asText() );\n     }\n@@ -766,8 +789,9 @@ public void nameUpdate() {\n \n         // attempt to log in\n         JsonNode node = resource().path( \"/test-organization/test-app/token\" ).queryParam( \"username\", username )\n-                .queryParam( \"password\", \"password\" ).queryParam( \"grant_type\", \"password\" )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                                  .queryParam( \"password\", \"password\" ).queryParam( \"grant_type\", \"password\" )\n+                                  .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                                  .get( JsonNode.class );\n \n         assertEquals( username, node.get( \"user\" ).get( \"username\" ).asText() );\n         assertEquals( name, node.get( \"user\" ).get( \"name\" ).asText() );\n@@ -783,13 +807,14 @@ public void nameUpdate() {\n         userEntity.setProperty( \"pin\", \"newp1n\" );\n \n         node = resource().path( String.format( \"/test-organization/test-app/users/%s\", username ) )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).put( JsonNode.class, userEntity.getProperties() );\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).put( JsonNode.class, userEntity.getProperties() );\n \n         // now see if we've updated\n         node = resource().path( \"/test-organization/test-app/token\" ).queryParam( \"username\", username )\n-                .queryParam( \"password\", \"password\" ).queryParam( \"grant_type\", \"password\" )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"password\", \"password\" ).queryParam( \"grant_type\", \"password\" )\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .get( JsonNode.class );\n \n         assertEquals( username, node.get( \"user\" ).get( \"username\" ).asText() );\n         assertEquals( newName, node.get( \"user\" ).get( \"name\" ).asText() );\n@@ -831,8 +856,8 @@ public void test_POST_batch() {\n         batch.add( properties );\n \n         node = resource().path( \"/test-organization/test-app/users/\" ).queryParam( \"access_token\", access_token )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                .post( JsonNode.class, batch );\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .post( JsonNode.class, batch );\n \n         assertNotNull( node );\n         logNode( node );\n@@ -848,24 +873,26 @@ public void deactivateUser() {\n \n         Map<String, String> payload =\n                 hashMap( \"email\", String.format( \"%s@anuff.com\", newUserUuid ) ).map( \"username\", userName )\n-                        .map( \"name\", \"Ed Anuff\" ).map( \"password\", \"sesame\" ).map( \"pin\", \"1234\" );\n+                                                                                .map( \"name\", \"Ed Anuff\" )\n+                                                                                .map( \"password\", \"sesame\" )\n+                                                                                .map( \"pin\", \"1234\" );\n \n         resource().path( \"/test-organization/test-app/users\" ).queryParam( \"access_token\", access_token )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                .post( JsonNode.class, payload );\n+                  .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                  .post( JsonNode.class, payload );\n \n         JsonNode response =\n                 resource().path( \"/test-organization/test-app/users\" ).queryParam( \"access_token\", access_token )\n-                        .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                        .get( JsonNode.class );\n+                          .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                          .get( JsonNode.class );\n \n         // disable the user\n \n         Map<String, String> data = new HashMap<String, String>();\n \n         response = resource().path( String.format( \"/test-organization/test-app/users/%s/deactivate\", userName ) )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, data );\n+                             .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                             .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, data );\n \n         JsonNode entity = getEntity( response, 0 );\n \n@@ -895,13 +922,14 @@ public void test_GET_user_ok() throws InterruptedException {\n         // TODO figure out what is being overridden? why 400?\n         JsonNode node =\n                 resource().path( \"/test-organization/test-app/users\" ).queryParam( \"access_token\", access_token )\n-                        .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                        .get( JsonNode.class );\n+                          .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                          .get( JsonNode.class );\n \n         String uuid = node.get( \"entities\" ).get( 0 ).get( \"uuid\" ).getTextValue();\n \n         node = resource().path( \"/test-organization/test-app/users/\" + uuid ).queryParam( \"access_token\", access_token )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .get( JsonNode.class );\n         logNode( node );\n         assertEquals( \"ed@anuff.com\", node.get( \"entities\" ).get( 0 ).get( \"email\" ).getTextValue() );\n     }\n@@ -936,8 +964,8 @@ public void setUserPasswordAsAdmin() {\n \n         // change the password as admin. The old password isn't required\n         JsonNode node = resource().path( \"/test-organization/test-app/users/edanuff/password\" )\n-                .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, data );\n+                                  .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, data );\n \n         assertNull( getError( node ) );\n \n@@ -963,7 +991,7 @@ public void passwordMismatchErrorUser() {\n         Status responseStatus = null;\n         try {\n             resource().path( \"/test-organization/test-app/users/edanuff/password\" ).accept( MediaType.APPLICATION_JSON )\n-                    .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, data );\n+                      .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class, data );\n         }\n         catch ( UniformInterfaceException uie ) {\n             responseStatus = uie.getResponse().getClientResponseStatus();\n@@ -996,8 +1024,8 @@ public void addRemoveRole() {\n         String json = \"{\\\"title\\\":\\\"\" + roleName + \"\\\",\\\"name\\\":\\\"\" + roleName + \"\\\"}\";\n         JsonNode node =\n                 resource().path( \"/test-organization/test-app/roles\" ).queryParam( \"access_token\", access_token )\n-                        .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                        .post( JsonNode.class, json );\n+                          .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                          .post( JsonNode.class, json );\n \n         // check it\n         assertNull( node.get( \"errors\" ) );\n@@ -1006,32 +1034,32 @@ public void addRemoveRole() {\n         // add Role\n \n         node = resource().path( \"/test-organization/test-app/users/\" + createdId + \"/roles/\" + roleName )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         // check it\n         assertNull( node.get( \"errors\" ) );\n         assertEquals( node.get( \"entities\" ).get( 0 ).get( \"name\" ).asText(), roleName );\n \n         node = resource().path( \"/test-organization/test-app/users/\" + createdId + \"/roles\" )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n         assertNull( node.get( \"errors\" ) );\n         assertEquals( node.get( \"entities\" ).get( 0 ).get( \"name\" ).asText(), roleName );\n \n \n         // remove Role\n \n         node = resource().path( \"/test-organization/test-app/users/\" + createdId + \"/roles/\" + roleName )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).delete( JsonNode.class );\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).delete( JsonNode.class );\n \n         // check it\n         assertNull( node.get( \"errors\" ) );\n \n         node = resource().path( \"/test-organization/test-app/users/\" + createdId + \"/roles\" )\n-                .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n         assertNull( node.get( \"errors\" ) );\n         assertTrue( node.get( \"entities\" ).size() == 0 );\n     }\n@@ -1045,20 +1073,21 @@ public void revokeToken() throws Exception {\n \n         JsonNode response =\n                 resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token1 )\n-                        .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                        .get( JsonNode.class );\n+                          .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                          .get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n \n         response = resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token2 )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n \n         // now revoke the tokens\n         response = resource().path( \"/test-organization/test-app/users/edanuff/revoketokens\" )\n-                .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                             .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n+                             .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n \n         // the tokens shouldn't work\n \n@@ -1067,8 +1096,8 @@ public void revokeToken() throws Exception {\n         try {\n             response =\n                     resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token1 )\n-                            .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                            .get( JsonNode.class );\n+                              .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                              .get( JsonNode.class );\n         }\n         catch ( UniformInterfaceException uie ) {\n             status = uie.getResponse().getClientResponseStatus();\n@@ -1081,8 +1110,8 @@ public void revokeToken() throws Exception {\n         try {\n             response =\n                     resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token2 )\n-                            .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                            .get( JsonNode.class );\n+                              .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                              .get( JsonNode.class );\n         }\n         catch ( UniformInterfaceException uie ) {\n             status = uie.getResponse().getClientResponseStatus();\n@@ -1094,19 +1123,22 @@ public void revokeToken() throws Exception {\n         String token4 = super.userToken( \"edanuff\", \"sesame\" );\n \n         response = resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token3 )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n \n         response = resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token4 )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n \n         // now revoke the token3\n         response = resource().path( \"/test-organization/test-app/users/edanuff/revoketoken\" )\n-                .queryParam( \"access_token\", token3 ).queryParam( \"token\", token3 ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).post( JsonNode.class );\n+                             .queryParam( \"access_token\", token3 ).queryParam( \"token\", token3 )\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .post( JsonNode.class );\n \n         // the token3 shouldn't work\n \n@@ -1115,8 +1147,8 @@ public void revokeToken() throws Exception {\n         try {\n             response =\n                     resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token3 )\n-                            .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                            .get( JsonNode.class );\n+                              .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                              .get( JsonNode.class );\n         }\n         catch ( UniformInterfaceException uie ) {\n             status = uie.getResponse().getClientResponseStatus();\n@@ -1129,8 +1161,8 @@ public void revokeToken() throws Exception {\n         try {\n             response =\n                     resource().path( \"/test-organization/test-app/users/edanuff\" ).queryParam( \"access_token\", token4 )\n-                            .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                            .get( JsonNode.class );\n+                              .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                              .get( JsonNode.class );\n \n             status = Status.OK;\n         }\n@@ -1156,8 +1188,8 @@ public void getToken() throws Exception {\n \n         JsonNode node =\n                 resource().path( \"/test-organization/test-app/users/test_1/token\" ).queryParam( \"client_id\", clientId )\n-                        .queryParam( \"client_secret\", clientSecret ).accept( MediaType.APPLICATION_JSON )\n-                        .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                          .queryParam( \"client_secret\", clientSecret ).accept( MediaType.APPLICATION_JSON )\n+                          .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         String user_token_from_client_credentials = node.get( \"access_token\" ).asText();\n \n@@ -1173,7 +1205,8 @@ public void getToken() throws Exception {\n         // bad access token\n         try {\n             resource().path( \"/test-organization/test-app/users/test_1/token\" ).queryParam( \"access_token\", \"blah\" )\n-                    .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                      .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                      .get( JsonNode.class );\n         }\n         catch ( UniformInterfaceException uie ) {\n             status = uie.getResponse().getClientResponseStatus();\n@@ -1184,8 +1217,9 @@ public void getToken() throws Exception {\n \n         try {\n             resource().path( \"/test-organization/test-app/users/test_2/token\" )\n-                    .queryParam( \"access_token\", user_token_from_client_credentials )\n-                    .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                      .queryParam( \"access_token\", user_token_from_client_credentials )\n+                      .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                      .get( JsonNode.class );\n         }\n         catch ( UniformInterfaceException uie ) {\n             status = uie.getResponse().getClientResponseStatus();\n@@ -1197,22 +1231,24 @@ public void getToken() throws Exception {\n \n         JsonNode response = null;\n         response = resource().path( \"/test-organization/test-app/users/test_1\" )\n-                .queryParam( \"access_token\", user_token_from_client_credentials ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .queryParam( \"access_token\", user_token_from_client_credentials )\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n \n         response = resource().path( \"/test-organization/test-app/users/test_1\" )\n-                .queryParam( \"access_token\", user_token_from_java ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .queryParam( \"access_token\", user_token_from_java ).accept( MediaType.APPLICATION_JSON )\n+                             .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n \n         setup.getMgmtSvc().deactivateUser( appInfo.getId(), userId );\n         try {\n             resource().path( \"/test-organization/test-app/token\" ).queryParam( \"grant_type\", \"password\" )\n-                    .queryParam( \"username\", \"test_1\" ).queryParam( \"password\", \"test123\" )\n-                    .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                      .queryParam( \"username\", \"test_1\" ).queryParam( \"password\", \"test123\" )\n+                      .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                      .get( JsonNode.class );\n             fail( \"request for deactivated user should fail\" );\n         }\n         catch ( UniformInterfaceException uie ) {\n@@ -1230,8 +1266,9 @@ public void delegatePutOnNotFound() throws Exception {\n \n         // should update a field\n         JsonNode response = resource().path( \"/test-organization/test-app/users/\" + randomName )\n-                .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                                      .queryParam( \"access_token\", adminAccessToken )\n+                                      .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                                      .get( JsonNode.class );\n         logNode( response );\n         assertNotNull( getEntity( response, 0 ) );\n         // PUT on user\n@@ -1240,16 +1277,16 @@ public void delegatePutOnNotFound() throws Exception {\n         randomName = \"user2_\" + UUIDUtils.newTimeUUID().toString();\n         Map<String, String> payload =\n                 hashMap( \"email\", randomName + \"@apigee.com\" ).map( \"username\", randomName ).map( \"name\", randomName )\n-                        .map( \"password\", \"password\" ).map( \"pin\", \"1234\" );\n+                                                              .map( \"password\", \"password\" ).map( \"pin\", \"1234\" );\n \n         response = resource().path( \"/test-organization/test-app/users\" ).queryParam( \"access_token\", adminAccessToken )\n-                .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n-                .put( JsonNode.class, payload );\n+                             .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                             .put( JsonNode.class, payload );\n \n         logNode( response );\n         response = resource().path( \"/test-organization/test-app/users/\" + randomName )\n-                .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n-                .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+                             .queryParam( \"access_token\", adminAccessToken ).accept( MediaType.APPLICATION_JSON )\n+                             .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n \n         assertNotNull( getEntity( response, 0 ) );\n         logNode( response );\n@@ -1264,8 +1301,8 @@ public void delegatePutOnNotFound() throws Exception {\n     public void queryForUuids() throws Exception {\n \n         {\n-            final JsonNode response = resource().path( \"/test-organization/test-app/users/\" )\n-                    .queryParam( \"ql\", \"select *\" )               // query for entities\n+            final JsonNode response = resource().path( \"/test-organization/test-app/users/\" ).queryParam( \"ql\",\n+                    \"select *\" )               // query for entities\n                     .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n                     .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n             assertNotNull( \"Entities must exist\", response.get( \"entities\" ) );\n@@ -1275,13 +1312,47 @@ public void queryForUuids() throws Exception {\n         }\n \n         {\n-            final JsonNode response = resource().path( \"/test-organization/test-app/users/\" )\n-                    .queryParam( \"ql\", \"select uuid\" )            // query for uuid properties\n+            final JsonNode response = resource().path( \"/test-organization/test-app/users/\" ).queryParam( \"ql\",\n+                    \"select uuid\" )            // query for uuid properties\n                     .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n                     .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n             assertNotNull( \"List must exist\", response.get( \"list\" ) );\n             assertTrue( \"Must be some list items\", response.get( \"list\" ).size() > 0 );\n             assertNull( \"Entities must not exist\", response.get( \"entries\" ) );\n         }\n     }\n+\n+\n+    @Test\n+    public void queryForUserUuids() throws Exception {\n+\n+        UserRepo.INSTANCE.load( resource(), access_token );\n+        Status status = null;\n+\n+\n+        String ql = \"uuid = \" + UserRepo.INSTANCE.getByUserName( \"user1\" );\n+\n+        JsonNode node = resource().path( \"/test-organization/test-app/users\" ).queryParam( \"ql\", ql )\n+                                  .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                                  .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+\n+\n+        Map<String, String> payload = hashMap( \"name\", \"Austin\" ).map( \"state\", \"TX\" );\n+\n+        node = resource().path( \"/test-organization/test-app/curts\" ).queryParam( \"access_token\", access_token )\n+                         .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )\n+                         .post( JsonNode.class, payload );\n+\n+        UUID userId = UUID.fromString( node.get( \"entities\" ).get( 0 ).get( \"uuid\" ).asText() );\n+\n+        assertNotNull( userId );\n+\n+        ql = \"uuid = \" + userId;\n+\n+        node = resource().path( \"/test-organization/test-app/curts\" ).queryParam( \"ql\", ql )\n+                         .queryParam( \"access_token\", access_token ).accept( MediaType.APPLICATION_JSON )\n+                         .type( MediaType.APPLICATION_JSON_TYPE ).get( JsonNode.class );\n+\n+        assertNotNull( node.get( \"entities\" ).get( 0 ).get( \"uuid\" ) );\n+    }\n }",
                "additions": 193,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/java/org/apache/usergrid/rest/applications/users/UserResourceIT.java",
                "status": "modified",
                "changes": 315,
                "deletions": 122,
                "sha": "dfeddc1240b567eb95553e0785f85f47f20a75ad",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/java/org/apache/usergrid/rest/applications/users/UserResourceIT.java",
                "filename": "stack/rest/src/test/java/org/apache/usergrid/rest/applications/users/UserResourceIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/java/org/apache/usergrid/rest/applications/users/UserResourceIT.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -0,0 +1,17 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Overrides",
                "additions": 17,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/resources/corepersistence-UNIT.properties",
                "status": "added",
                "changes": 17,
                "deletions": 0,
                "sha": "a09c0fb5fc8ceb6fd65920bb1dbe394c6e3314dc",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/resources/corepersistence-UNIT.properties",
                "filename": "stack/rest/src/test/resources/corepersistence-UNIT.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/resources/corepersistence-UNIT.properties?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -18,25 +18,36 @@\n # and the pattern to %c instead of %l.  (%l is slower.)\n \n # output messages into a rolling log file as well as stdout\n-log4j.rootLogger=WARN,stdout\n+log4j.rootLogger=ERROR,stdout\n \n # stdout\n log4j.appender.stdout=org.apache.log4j.ConsoleAppender\n #log4j.appender.stdout.layout=org.apache.log4j.SimpleLayout\n log4j.appender.stdout.layout=org.apache.log4j.PatternLayout\n-log4j.appender.stdout.layout.ConversionPattern=%d %p (%t) [%c] - %m%n\n+log4j.appender.stdout.layout.ConversionPattern=%d %p (%t) %c{1} - %m%n\n \n-log4j.category.org.apache=ERROR, stdout\n+#log4j.logger.org.apache.usergrid.persistence.cassandra.DB=WARN, stdout\n+#log4j.logger.org.apache.usergrid.persistence.cassandra.BATCH=WARN, stdout\n+#log4j.logger.org.apache.usergrid.persistence.cassandra.EntityManagerFactoryImpl=WARN, stdout\n+#log4j.logger.org.apache.usergrid.persistence.cassandra.DaoUtils=WARN, stdout\n+#log4j.logger.org.apache.usergrid.persistence.cassandra.EntityManagerImpl=WARN, stdout\n+#log4j.logger.org.apache.usergrid.persistence.cassandra.ConnectionRefImpl=WARN, stdout\n+#log4j.logger.me.prettyprint.cassandra.hector.TimingLogger=WARN, stdout\n+#log4j.logger.org.apache.usergrid.rest.security.AllowAjaxFilter=WARN, stdout\n+#log4j.logger.me.prettyprint.hector.api.beans.AbstractComposite=ERROR, stdout\n+#log4j.logger.org.apache.usergrid.locking.singlenode.SingleNodeLockManagerImpl=DEBUG, stdout\n \n-log4j.logger.org.apache.usergrid.persistence.cassandra.DB=WARN, stdout\n-log4j.logger.org.apache.usergrid.persistence.cassandra.BATCH=WARN, stdout\n-log4j.logger.org.apache.usergrid.persistence.cassandra.EntityManagerFactoryImpl=WARN, stdout\n-log4j.logger.org.apache.usergrid.persistence.cassandra.DaoUtils=WARN, stdout\n-log4j.logger.org.apache.usergrid.persistence.cassandra.EntityManagerImpl=WARN, stdout\n-log4j.logger.org.apache.usergrid.persistence.cassandra.ConnectionRefImpl=WARN, stdout\n-log4j.logger.me.prettyprint.cassandra.hector.TimingLogger=WARN, stdout\n-log4j.logger.org.apache.usergrid.rest.security.AllowAjaxFilter=WARN, stdout\n-log4j.logger.me.prettyprint.hector.api.beans.AbstractComposite=ERROR, stdout\n+log4j.logger.org.apache.usergrid=WARN\n+log4j.logger.org.apache.usergrid.corepersistence=DEBUG\n+log4j.logger.com.netflix.hystrix=DEBUG\n+#log4j.logger.org.antlr=DEBUG\n \n+#log4j.logger.org.apache.usergrid.persistence.CollectionIT=DEBUG\n+#log4j.logger.org.apache.usergrid.persistence.index=DEBUG\n+#log4j.logger.org.apache.usergrid.persistence.query=DEBUG\n+#log4j.logger.org.apache.usergrid.persistence.collection=DEBUG\n+#log4j.logger.org.elasticsearch=DEBUG\n+\n+#log4j.logger.org.apache.cassandra.service.StorageProxy=DEBUG, stdout\n \n log4j.logger.org.usergrid.rest.management=DEBUG",
                "additions": 23,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/resources/log4j.properties",
                "status": "modified",
                "changes": 35,
                "deletions": 12,
                "sha": "666bf10bd28153c91433c3d6a7718224b71edd9e",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/resources/log4j.properties",
                "filename": "stack/rest/src/test/resources/log4j.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/resources/log4j.properties?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -1,27 +1,27 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n <beans xmlns=\"http://www.springframework.org/schema/beans\"\r\n-\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:util=\"http://www.springframework.org/schema/util\"\r\n-\txmlns:context=\"http://www.springframework.org/schema/context\" xmlns:p=\"http://www.springframework.org/schema/p\"\r\n-\txsi:schemaLocation=\"\r\n+       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:util=\"http://www.springframework.org/schema/util\"\r\n+       xmlns:context=\"http://www.springframework.org/schema/context\" xmlns:p=\"http://www.springframework.org/schema/p\"\r\n+       xsi:schemaLocation=\"\r\n \thttp://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd\r\n \thttp://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd\r\n \thttp://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd\">\r\n \r\n-\t<bean id=\"properties\"\r\n-\t\tclass=\"org.springframework.beans.factory.config.PropertiesFactoryBean\">\r\n-\t\t<property name=\"singleton\" value=\"true\" />\r\n-\t\t<property name=\"ignoreResourceNotFound\" value=\"true\" />\r\n-\t\t<property name=\"locations\">\r\n-\t\t\t<list>\r\n-\t\t\t\t<value>classpath:/usergrid-default.properties</value>\r\n-\t\t\t\t<value>classpath:/usergrid-test.properties</value>\r\n-\t\t\t\t<value>${usergrid-custom-spring-test-properties}</value>\r\n-\t\t\t</list>\r\n-\t\t</property>\r\n-\t</bean>\r\n+    <bean id=\"properties\"\r\n+          class=\"org.springframework.beans.factory.config.PropertiesFactoryBean\">\r\n+        <property name=\"singleton\" value=\"true\" />\r\n+        <property name=\"ignoreResourceNotFound\" value=\"true\" />\r\n+        <property name=\"locations\">\r\n+            <list>\r\n+                <value>classpath:/usergrid-default.properties</value>\r\n+                <value>classpath:/usergrid-test.properties</value>\r\n+                <value>${usergrid-custom-spring-test-properties}</value>\r\n+            </list>\r\n+        </property>\r\n+    </bean>\r\n \t\r\n \r\n-\t<import resource=\"usergrid-rest-context.xml\"/>\r\n+    <import resource=\"usergrid-rest-context.xml\"/>\r\n \r\n     <bean id=\"traceTagManager\" class=\"org.apache.usergrid.persistence.cassandra.util.TraceTagManager\">\r\n         <property name=\"reportUnattached\" value=\"false\"/>\r\n@@ -32,15 +32,22 @@\n     <bean id=\"binaryStore\" class=\"org.apache.usergrid.services.assets.data.LocalFileBinaryStore\"/>\r\n \r\n     <!--<bean id=\"binaryStore\" class=\"org.apache.usergrid.services.assets.data.S3BinaryStore\">-->\r\n-        <!--<constructor-arg name=\"accessId\" value=\"xx\" />-->\r\n-        <!--<constructor-arg name=\"secretKey\" value=\"xx\" />-->\r\n-        <!--<constructor-arg name=\"bucketName\" value=\"xx\" />-->\r\n+    <!--<constructor-arg name=\"accessId\" value=\"xx\" />-->\r\n+    <!--<constructor-arg name=\"secretKey\" value=\"xx\" />-->\r\n+    <!--<constructor-arg name=\"bucketName\" value=\"xx\" />-->\r\n     <!--</bean>-->\r\n \r\n-    <bean id=\"setup\" class=\"org.apache.usergrid.persistence.cassandra.Setup\">\r\n+    <bean id=\"setup\" class=\"org.apache.usergrid.corepersistence.CpSetup\">\r\n         <constructor-arg ref=\"entityManagerFactory\"/>\r\n         <constructor-arg ref=\"cassandraService\"/>\r\n     </bean>\r\n+\r\n+\r\n+    <!--    <bean id=\"setup\" class=\"org.apache.usergrid.persistence.cassandra.Setup\">\r\n+        <constructor-arg ref=\"entityManagerFactory\"/>\r\n+        <constructor-arg ref=\"cassandraService\"/>\r\n+    </bean>-->\r\n+\r\n     <!-- The default schema manager -->\r\n     <!--\r\n     <bean class=\"org.apache.usergrid.persistence.CoreSchemaManager\">\r",
                "additions": 27,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/resources/usergrid-test-context.xml",
                "status": "modified",
                "changes": 47,
                "deletions": 20,
                "sha": "8141f503d0695e54d60942b655f390142d88d61f",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/rest/src/test/resources/usergrid-test-context.xml",
                "filename": "stack/rest/src/test/resources/usergrid-test-context.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/resources/usergrid-test-context.xml?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -32,17 +32,11 @@\n     private final String prefix;\n     private final String base64Prefix;\n     private final boolean expires;\n-    private static Map<String, TokenCategory> prefixes;\n-    private static Map<String, TokenCategory> base64Prefixes;\n+    private static final Map<String, TokenCategory> prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+    private static final Map<String, TokenCategory> base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n \n \n     private synchronized static void register( TokenCategory type ) {\n-        if ( prefixes == null ) {\n-            prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-        }\n-        if ( base64Prefixes == null ) {\n-            base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-        }\n         prefixes.put( type.getPrefix(), type );\n         base64Prefixes.put( type.getBase64Prefix(), type );\n     }",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "status": "modified",
                "changes": 10,
                "deletions": 8,
                "sha": "4c05f5e6ca02f3138f7e4147c8733d87b3c84b44",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            },
            {
                "patch": "@@ -499,7 +499,13 @@ private ByteBuffer principalKey( AuthPrincipalInfo principalInfo ) {\n \n \n     private UUID getUUIDForToken( String token ) throws ExpiredTokenException, BadTokenException {\n+\n         TokenCategory tokenCategory = TokenCategory.getFromBase64String( token );\n+\n+        if( tokenCategory == null){\n+            return null;\n+        }\n+\n         byte[] bytes = decodeBase64( token.substring( TokenCategory.BASE64_PREFIX_LENGTH ) );\n         UUID uuid = uuid( bytes );\n         int i = 16;",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "status": "modified",
                "changes": 6,
                "deletions": 0,
                "sha": "b2a3d720f9dd0f83b404619f813464efd63d5f8c",
                "blob_url": "https://github.com/apache/usergrid/blob/e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java?ref=e1b275f0a7c5e5aa4ba807fb483d01fe9e828f38"
            }
        ],
        "bug_id": "usergrid_50",
        "parent": "https://github.com/apache/usergrid/commit/194383cd3dcbd9586cd141debf08d27cee437931",
        "message": "Merge branch 'two-dot-o' of https://github.com/usergrid/usergrid into DPS-1042_import-counters\n\n# By Shawn Feldman (5) and others\n# Via Dave Johnson (4) and others\n* 'two-dot-o' of https://github.com/usergrid/usergrid:\n  Ensure consistent usage of edge connection type, fix duplicate property value tests.\n  Ignored test the highlights users not being fullQueryIndexed\n  Move property roles to correct locations, adding Hystrix property file config.properties, better ensure consistent usage of COLLECTION_SUFFIX.\n  add reload and * to connect task\n  add reload and * to connect task\n  fix profile call\n  Missed null check may cause NPE\n  add @ symbol\n  building release; adding new error event\n  NPE may be thrown if the org admin identifier doesn't exist\n  Reformatted the UserResourceIT  and added a test to prove issue. Removed the index checking from uuid checking\n  Added common Eclipse IDE files to .gitignore\n\nConflicts:\n\tstack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/7b215250afce3303af6a26ecf4ec8918840e37e0",
        "file": [
            {
                "patch": "@@ -32,7 +32,6 @@\n \n import org.apache.usergrid.corepersistence.asyncevents.AsyncEventService;\n import org.apache.usergrid.corepersistence.pipeline.PipelineBuilderFactory;\n-import org.apache.usergrid.corepersistence.pipeline.PipelineResult;\n import org.apache.usergrid.corepersistence.pipeline.read.ReadPipelineBuilder;\n import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n import org.apache.usergrid.corepersistence.results.ObservableQueryExecutor;\n@@ -648,7 +647,7 @@ public Results searchCollection( String collName, Query query ) throws Exception\n         }\n \n \n-        final Observable<PipelineResult<ResultsPage>> resultsObservable = readPipelineBuilder.execute();\n+        final Observable<ResultsPage> resultsObservable = readPipelineBuilder.execute();\n \n         return new ObservableQueryExecutor( resultsObservable ).next();\n     }\n@@ -917,7 +916,7 @@ public Results searchConnectedEntities( Query query ) throws Exception {\n         }\n \n \n-        final Observable<PipelineResult<ResultsPage>> resultsObservable = readPipelineBuilder.execute();\n+        final Observable<ResultsPage> resultsObservable = readPipelineBuilder.execute();\n \n         return new ObservableQueryExecutor( resultsObservable ).next();\n     }",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "status": "modified",
                "changes": 5,
                "deletions": 3,
                "sha": "6adeefcd589bdf5eaf32b39922699c390922c484",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -25,7 +25,7 @@\n import org.apache.usergrid.corepersistence.pipeline.cursor.RequestCursor;\n import org.apache.usergrid.corepersistence.pipeline.cursor.ResponseCursor;\n import org.apache.usergrid.corepersistence.pipeline.read.Collector;\n-import org.apache.usergrid.corepersistence.pipeline.read.PipelineOperation;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n \n import com.google.common.base.Optional;\n@@ -47,7 +47,6 @@\n     private final List<PipelineOperation> idPipelineOperationList;\n     private final Collector<?, R> collector;\n     private final RequestCursor requestCursor;\n-    private final ResponseCursor responseCursor;\n \n     private final int limit;\n \n@@ -69,18 +68,17 @@ public Pipeline( final ApplicationScope applicationScope, final List<PipelineOpe\n         this.limit = limit;\n \n         this.requestCursor = new RequestCursor( cursor );\n-        this.responseCursor = new ResponseCursor();\n     }\n \n \n     /**\n      * Execute the pipline construction, returning an observable of results\n      * @return\n      */\n-    public Observable<PipelineResult<R>> execute(){\n+    public Observable<R> execute(){\n \n \n-        Observable traverseObservable = Observable.just( applicationScope.getApplication() );\n+        Observable traverseObservable = Observable.just( new FilterResult<>( applicationScope.getApplication(), Optional.absent() ));\n \n         //build our traversal commands\n         for ( PipelineOperation pipelineOperation : idPipelineOperationList ) {\n@@ -99,7 +97,7 @@ public Pipeline( final ApplicationScope applicationScope, final List<PipelineOpe\n \n \n         //append the optional cursor into the response for the caller to use\n-        return response.map( result -> new PipelineResult<>( result, responseCursor ) );\n+        return response;\n     }\n \n \n@@ -111,7 +109,7 @@ public Pipeline( final ApplicationScope applicationScope, final List<PipelineOpe\n     private void setState( final PipelineOperation pipelineOperation ) {\n \n \n-        final PipelineContext context = new PipelineContext( applicationScope, requestCursor, responseCursor,\n+        final PipelineContext context = new PipelineContext( applicationScope, requestCursor,\n             limit, idCount );\n \n         pipelineOperation.setContext( context );",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/Pipeline.java",
                "status": "modified",
                "changes": 12,
                "deletions": 7,
                "sha": "26cf3468aa7d4e86bfe5e41c12ad9a144ddd8f75",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/Pipeline.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/Pipeline.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/Pipeline.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -38,16 +38,13 @@\n     private final int id;\n     private final ApplicationScope applicationScope;\n     private final RequestCursor requestCursor;\n-    private final ResponseCursor responseCursor;\n     private final int limit;\n \n \n-    public PipelineContext( final ApplicationScope applicationScope, final RequestCursor requestCursor,\n-                            final ResponseCursor responseCursor, final int limit, final int id ) {\n+    public PipelineContext( final ApplicationScope applicationScope, final RequestCursor requestCursor, final int limit, final int id ) {\n \n         this.applicationScope = applicationScope;\n         this.requestCursor = requestCursor;\n-        this.responseCursor = responseCursor;\n         this.limit = limit;\n         this.id = id;\n     }\n@@ -64,7 +61,7 @@ public int getId() {\n \n \n     /**\n-     * Get our cursor value if present\n+     * Get our cursor value if present from our pipline\n      * @param serializer\n      */\n     public <T extends Serializable> Optional<T> getCursor( final CursorSerializer<T> serializer ) {\n@@ -73,15 +70,6 @@ public int getId() {\n         return Optional.fromNullable( value );\n     }\n \n-\n-    /**\n-     * Set the cursor value into our resposne\n-     */\n-    public <T extends Serializable> void setCursorValue( final T value, final CursorSerializer<T> serializer ) {\n-        responseCursor.setCursor( id, value, serializer );\n-    }\n-\n-\n     /**\n      * Get the limit for this execution\n      * @return",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineContext.java",
                "status": "modified",
                "changes": 16,
                "deletions": 14,
                "sha": "018abb74e51d0c297f5f2bf36b41f686941db84e",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineContext.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineContext.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineContext.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -17,10 +17,11 @@\n  * under the License.\n  */\n \n-package org.apache.usergrid.corepersistence.pipeline.read;\n+package org.apache.usergrid.corepersistence.pipeline;\n \n \n import org.apache.usergrid.corepersistence.pipeline.PipelineContext;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n \n import rx.Observable;\n \n@@ -29,10 +30,10 @@\n  * Interface for filtering commands.  All filters must take an observable of Id's as an input.  Output is then determined by subclasses.\n   * This takes an input of Id, performs some operation, and emits values for further processing in the Observable\n   * pipeline\n- * @param <T> The input type\n- * @param <R>\n+ * @param <T> The input type of the filter value\n+ * @param <R> The output type of the filter value\n  */\n-public interface PipelineOperation< T, R> extends Observable.Transformer<T, R> {\n+public interface PipelineOperation<T, R> extends Observable.Transformer<FilterResult<T>, R> {\n \n     void setContext(final PipelineContext pipelineContext);\n }",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineOperation.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/PipelineOperation.java",
                "status": "renamed",
                "changes": 9,
                "deletions": 4,
                "sha": "d2fa16c9f9d0238e4bd19408578464f98ca09f5f",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineOperation.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineOperation.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineOperation.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -20,12 +20,10 @@\n package org.apache.usergrid.corepersistence.pipeline.cursor;\n \n \n-import java.io.Serializable;\n import java.util.Base64;\n-import java.util.HashMap;\n-import java.util.Map;\n \n-import com.fasterxml.jackson.core.Base64Variant;\n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n+\n import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.JsonNode;\n import com.fasterxml.jackson.databind.ObjectMapper;\n@@ -41,71 +39,72 @@\n \n     private static final ObjectMapper MAPPER = CursorSerializerUtil.getMapper();\n \n+\n     /**\n-     * We use a map b/c some indexes might be skipped\n+     * The pointer to the first edge path.  Evaluation is lazily performed in the case the caller does not care about\n+     * the cursor.\n      */\n-    private Map<Integer, CursorEntry<?>> cursors = new HashMap<>();\n+    private final Optional<EdgePath> edgePath;\n \n+    private Optional<String> encodedValue = null;\n \n-    /**\n-     * Set the possible cursor value into the index. DOES NOT parse the cursor.  This is intentional for performance\n-     */\n-    public <T extends Serializable> void setCursor( final int id, final T cursor,\n-                                                    final CursorSerializer<T> serializer ) {\n \n-        final CursorEntry<T> newEntry = new CursorEntry<>( cursor, serializer );\n-        cursors.put( id, newEntry );\n-    }\n+    public ResponseCursor( final Optional<EdgePath> edgePath ) {this.edgePath = edgePath;}\n \n \n     /**\n-     * now we're done, encode as a string\n+     * Lazyily encoded deliberately.  If the user doesn't care about a cursor and is using streams, we dont' want to take the\n+     * time to calculate it\n      */\n     public Optional<String> encodeAsString() {\n-        try {\n \n-            if(cursors.isEmpty()){\n-                return Optional.absent();\n-            }\n+        //always return cached if we are called 2x\n+        if ( encodedValue != null ) {\n+            return encodedValue;\n+        }\n+\n+        if ( !edgePath.isPresent() ) {\n+            encodedValue = Optional.absent();\n+            return encodedValue;\n+        }\n+\n+\n+        try {\n \n+            //no edge path, short circuit\n \n             final ObjectNode map = MAPPER.createObjectNode();\n \n-            for ( Map.Entry<Integer, CursorEntry<?>> entry : cursors.entrySet() ) {\n \n-                final CursorEntry cursorEntry = entry.getValue();\n+            Optional<EdgePath> current = edgePath;\n \n-                final JsonNode serialized = cursorEntry.serializer.toNode( MAPPER, cursorEntry.cursor );\n \n-                map.put( entry.getKey().toString(), serialized );\n-            }\n+            //traverse each edge and add them to our json\n+            do {\n+\n+                final EdgePath edgePath = current.get();\n+                final Object cursorValue = edgePath.getCursorValue();\n+                final CursorSerializer serializer = edgePath.getSerializer();\n+                final int filterId = edgePath.getFilterId();\n+\n+                final JsonNode serialized = serializer.toNode( MAPPER, cursorValue );\n+                map.put( String.valueOf( filterId ), serialized );\n \n+                current = current.get().getPrevious();\n+            }\n+            while ( current.isPresent() );\n \n-            final byte[] output = MAPPER.writeValueAsBytes(map);\n+            final byte[] output = MAPPER.writeValueAsBytes( map );\n \n             //generate a base64 url save string\n             final String value = Base64.getUrlEncoder().encodeToString( output );\n \n-            return Optional.of( value );\n-\n+            encodedValue =  Optional.of( value );\n         }\n         catch ( JsonProcessingException e ) {\n             throw new CursorParseException( \"Unable to serialize cursor\", e );\n         }\n-    }\n \n-\n-    /**\n-     * Interal pointer to the cursor and it's serialzed value\n-     */\n-    private static final class CursorEntry<T> {\n-        private final T cursor;\n-        private final CursorSerializer<T> serializer;\n-\n-\n-        private CursorEntry( final T cursor, final CursorSerializer<T> serializer ) {\n-            this.cursor = cursor;\n-            this.serializer = serializer;\n-        }\n+        return encodedValue;\n     }\n }",
                "additions": 40,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/cursor/ResponseCursor.java",
                "status": "modified",
                "changes": 81,
                "deletions": 41,
                "sha": "dbd8b88a2833496bcfe608e082d4a83a60b034e6",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/cursor/ResponseCursor.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/cursor/ResponseCursor.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/cursor/ResponseCursor.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -21,14 +21,15 @@\n \n \n import org.apache.usergrid.corepersistence.pipeline.PipelineContext;\n+import org.apache.usergrid.corepersistence.pipeline.PipelineOperation;\n \n \n /**\n  * Basic functionality for our commands to handle cursor IO\n  * @param <T> the input type\n  * @param <R> The output Type\n  */\n-public abstract class AbstractPipelineOperation<T, R> implements PipelineOperation<T, R> {\n+public abstract class AbstractFilter<T, R> implements Filter<T, R> {\n \n \n     protected PipelineContext pipelineContext;",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractFilter.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractPipelineOperation.java",
                "status": "renamed",
                "changes": 3,
                "deletions": 1,
                "sha": "e4d5d447b264287381a2dd0d0fa1a8845379a71c",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -33,7 +33,7 @@\n  * @param <R> The response type\n  * @param <C> The cursor type\n  */\n-public abstract class AbstractSeekingFilter<T, R, C extends Serializable> extends AbstractPipelineOperation<T, R> implements Filter<T, R> {\n+public abstract class AbstractPathFilter<T, R, C extends Serializable> extends AbstractFilter<T, R> implements Filter<T, R> {\n \n \n \n@@ -58,10 +58,17 @@\n \n     /**\n      * Sets the cursor into our pipeline context\n-     * @param newValue\n      */\n-    protected void setCursor(final C newValue){\n-        pipelineContext.setCursorValue( newValue, getCursorSerializer() );\n+    protected FilterResult<R> createFilterResult( final R emit, final C cursorValue, final Optional<EdgePath> parent ){\n+\n+\n+        //create a current path, and append our parent path to it\n+        final EdgePath<C> newEdgePath =\n+            new EdgePath<>( pipelineContext.getId(), cursorValue, getCursorSerializer(), parent );\n+\n+        //emit our value with the parent path\n+        return new FilterResult<>( emit, Optional.of( newEdgePath ) );\n+\n     }\n \n ",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractPathFilter.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractSeekingFilter.java",
                "status": "renamed",
                "changes": 15,
                "deletions": 4,
                "sha": "c68dc4a8f22b6bf930186eb101f279ee137da8ac",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractPathFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractPathFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/AbstractPathFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -20,11 +20,18 @@\n package org.apache.usergrid.corepersistence.pipeline.read;\n \n \n+import org.apache.usergrid.corepersistence.pipeline.PipelineOperation;\n+\n+\n /**\n- * A command that is used to reduce our stream of results into a final output\n- * @param <T>\n+ * A command that is used to reduce our stream of results into a stream of final batch outputs.  When used\n+ * no further transformation or encoding should occur.  Otherwise EdgePath data will be lost, and serialization cannot occur\n+ * across requests\n+ *\n+ * @param <T>  The input type\n+ * @param <R> The output type\n  */\n-public interface Collector<T, R> extends PipelineOperation<T, R> {\n+public interface Collector<T, R> extends PipelineOperation<T,R> {\n \n \n ",
                "additions": 10,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Collector.java",
                "status": "modified",
                "changes": 13,
                "deletions": 3,
                "sha": "e28ce4411ba00e1ce639fccc832dbb52ce4ab7a7",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Collector.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Collector.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Collector.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -20,25 +20,19 @@\n package org.apache.usergrid.corepersistence.pipeline.read;\n \n \n-import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.CandidateResultsEntityResultsCollector;\n-import org.apache.usergrid.corepersistence.pipeline.read.entity.EntityLoadCollector;\n+import org.apache.usergrid.corepersistence.pipeline.read.collect.ResultsPageCollector;\n \n \n /**\n  * A factory for generating collectors\n  */\n public interface CollectorFactory {\n \n-    /**\n-     * Generate a new instance of the command with the specified parameters\n-     */\n-    EntityLoadCollector entityLoadCollector();\n \n     /**\n-     * Get the collector for collection candidate results to entities\n+     * Get the results page collector\n      * @return\n      */\n-    CandidateResultsEntityResultsCollector candidateResultsEntityResultsCollector();\n-\n+   ResultsPageCollector getResultsPageCollector();\n \n }",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/CollectorFactory.java",
                "status": "modified",
                "changes": 12,
                "deletions": 9,
                "sha": "dd200b5b68b0114adf06e7e97e41a2bbb754482c",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/CollectorFactory.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/CollectorFactory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/CollectorFactory.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read;\n+\n+\n+import org.apache.usergrid.corepersistence.pipeline.cursor.CursorSerializer;\n+\n+import com.google.common.base.Optional;\n+\n+\n+/**\n+ * A path from our input element to our emitted element.  A list of EdgePaths comprise a path through the graph.  The chains of edge paths will result\n+ * in a cursor when aggregated.  If a graph traversal is the following\n+ *\n+ * applicationId(1) - \"users\" -> userId(2) - \"devices\" -> deviceId(3).  There would be 2 EdgePath\n+ *\n+ *  EdgePath(\"users\"->userId(2)) <- parent - EdgePath(\"devices\" -> deviceId(3))\n+ */\n+public class EdgePath<C> {\n+\n+\n+    private final int filterId;\n+    private final C cursorValue;\n+    private final CursorSerializer<C> serializer;\n+    private final Optional<EdgePath> previous;\n+\n+\n+    /**\n+     *\n+     * @param filterId The id of the filter that generated this path\n+     * @param cursorValue The value to resume seeking on the path\n+     * @param serializer The serializer to serialize the value\n+     * @param parent The parent graph path edge to reach this path\n+     */\n+    public EdgePath( final int filterId, final C cursorValue, final CursorSerializer<C> serializer,\n+                     final Optional<EdgePath> parent ) {\n+        this.filterId = filterId;\n+        this.cursorValue = cursorValue;\n+        this.serializer = serializer;\n+        this.previous = parent;\n+    }\n+\n+\n+    public C getCursorValue() {\n+        return cursorValue;\n+    }\n+\n+\n+    public int getFilterId() {\n+        return filterId;\n+    }\n+\n+\n+    public Optional<EdgePath> getPrevious() {\n+        return previous;\n+    }\n+\n+\n+    public CursorSerializer<C> getSerializer() {\n+        return serializer;\n+    }\n+}",
                "additions": 79,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/EdgePath.java",
                "status": "added",
                "changes": 79,
                "deletions": 0,
                "sha": "c560fad9d3542948f7d1bb52ac35be33735d8a3d",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/EdgePath.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/EdgePath.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/EdgePath.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -20,11 +20,12 @@\n package org.apache.usergrid.corepersistence.pipeline.read;\n \n \n-import org.apache.usergrid.persistence.model.entity.Id;\n+import org.apache.usergrid.corepersistence.pipeline.PipelineOperation;\n \n \n /**\n- * Traverses edges in the graph.  Either by query or graph traversal.  Take an observable of ids, and emits\n- * an observable of ids\n+ * Traverses edges in the graph.  Either by query or graph traversal.  Take an observable of FilterResult, and emits\n+ * an observable of FilterResults.  Filters should never emit groups or objects that represent collections.  Items should\n+ * always be emitted 1 at a time.  It is the responsibility of the collector to aggregate results.\n  */\n-public interface Filter<T, R> extends PipelineOperation<T, R> {}\n+public interface Filter<T, R> extends PipelineOperation<T, FilterResult<R>> {}",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Filter.java",
                "status": "modified",
                "changes": 9,
                "deletions": 4,
                "sha": "054a85a11de3ac71db0b04e9c339b4f62ce21738",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Filter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Filter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/Filter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -20,10 +20,14 @@\n package org.apache.usergrid.corepersistence.pipeline.read;\n \n \n-import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.CandidateResultsIdVerifyFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.collect.EntityFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.collect.IdCursorSerializer;\n+import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.CandidateEntityFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.CandidateIdFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.ElasticSearchCollectionFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.ElasticSearchConnectionFilter;\n-import org.apache.usergrid.corepersistence.pipeline.read.entity.EntityIdFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.graph.EntityIdFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.graph.EntityLoadFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.graph.ReadGraphCollectionByIdFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.graph.ReadGraphCollectionFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.graph.ReadGraphConnectionByIdFilter;\n@@ -43,6 +47,7 @@\n \n     /**\n      * Generate a new instance of the command with the specified parameters\n+     *\n      * @param collectionName The collection name to use when reading the graph\n      */\n     ReadGraphCollectionFilter readGraphCollectionFilter( final String collectionName );\n@@ -57,12 +62,14 @@\n \n     /**\n      * Generate a new instance of the command with the specified parameters\n+     *\n      * @param connectionName The connection name to use when traversing the graph\n      */\n     ReadGraphConnectionFilter readGraphConnectionFilter( final String connectionName );\n \n     /**\n      * Generate a new instance of the command with the specified parameters\n+     *\n      * @param connectionName The connection name to use when traversing the graph\n      * @param entityType The entity type to use when traversing the graph\n      */\n@@ -72,13 +79,15 @@ ReadGraphConnectionByTypeFilter readGraphConnectionByTypeFilter(\n \n     /**\n      * Read a connection directly between two identifiers\n+     *\n      * @param connectionName The connection name to use when traversing the graph\n-     * @param targetId  The target Id to use when traversing the graph\n+     * @param targetId The target Id to use when traversing the graph\n      */\n     ReadGraphConnectionByIdFilter readGraphConnectionByIdFilter( final String connectionName, final Id targetId );\n \n     /**\n      * Generate a new instance of the command with the specified parameters\n+     *\n      * @param query The query to use when querying the entities in the collection\n      * @param collectionName The collection name to use when querying\n      */\n@@ -90,6 +99,7 @@ ElasticSearchCollectionFilter elasticSearchCollectionFilter( @Assisted( \"query\"\n \n     /**\n      * Generate a new instance of the command with the specified parameters\n+     *\n      * @param query The query to use when querying the entities in the connection\n      * @param connectionName The type of connection to query\n      * @param connectedEntityType The type of entity in the connection.  Leave absent to query all entity types\n@@ -102,14 +112,32 @@ ElasticSearchConnectionFilter elasticSearchConnectionFilter( @Assisted( \"query\"\n \n \n     /**\n-     * Get a candidate ids verifier for collection results.  Should be inserted into pipelines where a query filter is an intermediate step,\n-     * not a final filter before collectors\n+     * Generate a new instance of the command with the specified parameters\n+     */\n+    EntityLoadFilter entityLoadFilter();\n+\n+    /**\n+     * Get the collector for collection candidate results to entities\n+     */\n+    CandidateEntityFilter candidateEntityFilter();\n+\n+    /**\n+     * Get a candidate ids verifier for collection results.  Should be inserted into pipelines where a query filter is\n+     * an intermediate step, not a final filter before collectors\n      */\n-    CandidateResultsIdVerifyFilter candidateResultsIdVerifyFilter();\n+    CandidateIdFilter candidateResultsIdVerifyFilter();\n \n     /**\n      * Get an entity id filter.  Used as a 1.0->2.0 bridge since we're not doing full traversals\n+     *\n      * @param entityId The entity id to emit\n      */\n     EntityIdFilter getEntityIdFilter( final Id entityId );\n+\n+\n+    /**\n+     * Create a new instance of our entity filter\n+     * @return\n+     */\n+    EntityFilter entityFilter();\n }",
                "additions": 34,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java",
                "status": "modified",
                "changes": 40,
                "deletions": 6,
                "sha": "a2f160568c483d0312f0c53b1c30153f273c7aeb",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterFactory.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -17,41 +17,40 @@\n  * under the License.\n  */\n \n-package org.apache.usergrid.corepersistence.pipeline;\n+package org.apache.usergrid.corepersistence.pipeline.read;\n \n \n-import org.apache.usergrid.corepersistence.pipeline.cursor.ResponseCursor;\n-\n import com.google.common.base.Optional;\n \n \n /**\n- * Intermediate observable that will return results, as well as an optional cursor\n- * @param <R>\n+ * A bean that is passed between filters with immutable cursor state\n+ * @param <T>\n  */\n-public class PipelineResult<R> {\n-\n+public class FilterResult<T> {\n+    private final T value;\n+    private final Optional<EdgePath> path;\n \n-    private final R result;\n \n-    private final ResponseCursor responseCursor;\n+    /**\n+     * Create a new immutable filtervalue\n+     * @param value The value the filter emits\n+     * @param path The path to this value, if created\n+     */\n+    public FilterResult( final T value, final Optional<EdgePath> path ) {\n+        this.value = value;\n+        this.path = path;\n+    }\n \n \n-    public PipelineResult( final R result, final ResponseCursor responseCursor ) {\n-        this.result = result;\n-        this.responseCursor = responseCursor;\n+    public T getValue() {\n+        return value;\n     }\n \n \n-    /**\n-     * If the user requests our cursor, return the cursor\n-     * @return\n-     */\n-    public Optional<String> getCursor(){\n-        return this.responseCursor.encodeAsString();\n+    public Optional<EdgePath> getPath() {\n+        return path;\n     }\n \n-    public R getResult(){\n-        return result;\n-    }\n+\n }",
                "additions": 20,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterResult.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/PipelineResult.java",
                "status": "renamed",
                "changes": 41,
                "deletions": 21,
                "sha": "3c41a2bd60fe44b56515d84dcc23ca62b0b215ae",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterResult.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterResult.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/FilterResult.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -20,9 +20,6 @@\n package org.apache.usergrid.corepersistence.pipeline.read;\n \n \n-import org.apache.usergrid.corepersistence.pipeline.PipelineResult;\n-import org.apache.usergrid.persistence.Entity;\n-import org.apache.usergrid.persistence.Results;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.common.base.Optional;\n@@ -103,5 +100,5 @@ ReadPipelineBuilder getConnectionWithQuery( final String connectionName, final O\n      * Load our entity results when our previous filter calls graph\n      * @return\n      */\n-    Observable<PipelineResult<ResultsPage>> execute();\n+    Observable<ResultsPage> execute();\n }",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilder.java",
                "status": "modified",
                "changes": 5,
                "deletions": 4,
                "sha": "d0e87b3ea6ecd66a09005daaa113a3505056f704",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilder.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilder.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilder.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -24,11 +24,11 @@\n import java.util.List;\n \n import org.apache.usergrid.corepersistence.pipeline.Pipeline;\n-import org.apache.usergrid.corepersistence.pipeline.PipelineResult;\n-import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.CandidateResultsEntityResultsCollector;\n-import org.apache.usergrid.corepersistence.pipeline.read.entity.EntityLoadCollector;\n+import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.CandidateEntityFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.graph.EntityLoadFilter;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.core.util.ValidationUtils;\n+import org.apache.usergrid.persistence.model.entity.Entity;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.common.base.Optional;\n@@ -52,6 +52,8 @@\n \n     private final ApplicationScope applicationScope;\n \n+    private final CollectorFactory collectorFactory;\n+\n \n     /**\n      * Our pointer to our collect filter. Set or cleared with each operation that's performed so the correct results are\n@@ -70,6 +72,7 @@ public ReadPipelineBuilderImpl( final FilterFactory filterFactory, final Collect\n         this.filterFactory = filterFactory;\n \n         this.applicationScope = applicationScope;\n+        this.collectorFactory = collectorFactory;\n \n         //init our cursor to empty\n         this.cursor = Optional.absent();\n@@ -78,7 +81,7 @@ public ReadPipelineBuilderImpl( final FilterFactory filterFactory, final Collect\n         this.limit = DEFAULT_LIMIT;\n \n \n-        this.collectorState = new CollectorState( collectorFactory );\n+        this.collectorState = new CollectorState( );\n \n         this.filters = new ArrayList<>();\n     }\n@@ -120,7 +123,7 @@ public ReadPipelineBuilder getEntityViaCollection( final String collectionName,\n \n         filters.add( filterFactory.readGraphCollectionByIdFilter( collectionName, entityId ) );\n \n-        this.collectorState.setEntityLoaderCollector();\n+        this.collectorState.setIdEntityLoaderFilter();\n \n         return this;\n     }\n@@ -132,7 +135,7 @@ public ReadPipelineBuilder getCollection( final String collectionName ) {\n \n         filters.add( filterFactory.readGraphCollectionFilter( collectionName ) );\n \n-        this.collectorState.setEntityLoaderCollector();\n+        this.collectorState.setIdEntityLoaderFilter();\n \n         return this;\n     }\n@@ -147,7 +150,7 @@ public ReadPipelineBuilder getCollectionWithQuery( final String collectionName,\n \n         filters.add( filterFactory.elasticSearchCollectionFilter( query, collectionName, entityType ) );\n \n-        this.collectorState.setCandidateResultsEntityResultsCollector();\n+        this.collectorState.setCandidateEntityFilter();\n \n         return this;\n     }\n@@ -159,7 +162,7 @@ public ReadPipelineBuilder getEntityViaConnection( final String connectionName,\n         ValidationUtils.verifyIdentity( entityId );\n \n         filters.add( filterFactory.readGraphConnectionByIdFilter( connectionName, entityId ) );\n-        collectorState.setEntityLoaderCollector();\n+        collectorState.setIdEntityLoaderFilter();\n \n         return this;\n     }\n@@ -169,7 +172,7 @@ public ReadPipelineBuilder getEntityViaConnection( final String connectionName,\n     public ReadPipelineBuilder getConnection( final String connectionName ) {\n         Preconditions.checkNotNull( connectionName, \"connectionName must not be null\" );\n         filters.add( filterFactory.readGraphConnectionFilter( connectionName ) );\n-        collectorState.setEntityLoaderCollector();\n+        collectorState.setIdEntityLoaderFilter();\n \n         return this;\n     }\n@@ -182,7 +185,7 @@ public ReadPipelineBuilder getConnection( final String connectionName, final Str\n \n         filters.add( filterFactory.readGraphConnectionByTypeFilter( connectionName, entityType ) );\n \n-        collectorState.setEntityLoaderCollector();\n+        collectorState.setIdEntityLoaderFilter();\n         return this;\n     }\n \n@@ -196,17 +199,30 @@ public ReadPipelineBuilder getConnectionWithQuery( final String connectionName,\n         Preconditions.checkNotNull( query, \"query must not be null\" );\n \n         filters.add( filterFactory.elasticSearchConnectionFilter( query, connectionName, entityType ) );\n-        collectorState.setCandidateResultsEntityResultsCollector();\n+        collectorState.setCandidateEntityFilter();\n         return this;\n     }\n \n \n     @Override\n-    public Observable<PipelineResult<ResultsPage>> execute() {\n+    public Observable<ResultsPage> execute() {\n \n         ValidationUtils.validateApplicationScope( applicationScope );\n \n-        final Collector<?, ResultsPage> collector = collectorState.getCollector();\n+\n+        //add our last filter that will generate entities\n+        final Filter<?, Entity> entityLoadFilter = collectorState.getFinalFilter();\n+\n+        filters.add( entityLoadFilter );\n+\n+        //add the filter that skips the first result on resume\n+        final Filter<Entity, Entity>  cursorEntityFilter = filterFactory.entityFilter();\n+\n+        filters.add( cursorEntityFilter );\n+\n+\n+        //execute our collector\n+        final Collector<?, ResultsPage> collector = collectorFactory.getResultsPageCollector();\n \n         Preconditions.checkNotNull( collector,\n             \"You have not specified an operation that creates a collection filter.  This is required for loading \"\n@@ -229,46 +245,52 @@ public ReadPipelineBuilder getConnectionWithQuery( final String connectionName,\n      * A mutable state for our collectors.  Rather than create a new instance each time, we create a singleton\n      * collector\n      */\n-    private static final class CollectorState {\n-        private final CollectorFactory collectorFactory;\n+    private final class CollectorState {\n+\n \n-        private EntityLoadCollector entityLoadCollector;\n+        private EntityLoadFilter entityLoadCollector;\n \n-        private CandidateResultsEntityResultsCollector candidateResultsEntityResultsCollector;\n+        private CandidateEntityFilter candidateEntityFilter;\n \n+        private Filter entityLoadFilter;\n \n-        private Collector<?, ResultsPage> collector = null;\n \n \n-        private CollectorState( final CollectorFactory collectorFactory ) {this.collectorFactory = collectorFactory;}\n+        private CollectorState( ){}\n \n \n-        public void setEntityLoaderCollector() {\n+        /**\n+         * Set our final filter to be a load entity by Id filter\n+         */\n+        public void setIdEntityLoaderFilter() {\n             if ( entityLoadCollector == null ) {\n-                entityLoadCollector = collectorFactory.entityLoadCollector();\n+                entityLoadCollector = filterFactory.entityLoadFilter();\n             }\n \n \n-            collector = entityLoadCollector;\n+            entityLoadFilter = entityLoadCollector;\n         }\n \n \n-        public void setCandidateResultsEntityResultsCollector() {\n-            if ( candidateResultsEntityResultsCollector == null ) {\n-                candidateResultsEntityResultsCollector = collectorFactory.candidateResultsEntityResultsCollector();\n+        /**\n+         * Set our final filter to be a load entity by candidate filter\n+         */\n+        public void setCandidateEntityFilter() {\n+            if ( candidateEntityFilter == null ) {\n+                candidateEntityFilter = filterFactory.candidateEntityFilter();\n             }\n \n-            collector = candidateResultsEntityResultsCollector;\n+            entityLoadFilter = candidateEntityFilter;\n         }\n \n \n         public void clear() {\n-            collector = null;\n+            entityLoadFilter = null;\n         }\n \n \n-        public Collector<?, ResultsPage> getCollector() {\n-            return collector;\n+        public Filter<?, Entity> getFinalFilter() {\n+            return entityLoadFilter;\n         }\n     }\n }",
                "additions": 51,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilderImpl.java",
                "status": "modified",
                "changes": 80,
                "deletions": 29,
                "sha": "28446ad4295ecb5c414ac9b77dc8815a3961c991",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilderImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilderImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ReadPipelineBuilderImpl.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -22,18 +22,28 @@\n \n import java.util.List;\n \n+import org.apache.usergrid.corepersistence.pipeline.cursor.ResponseCursor;\n import org.apache.usergrid.persistence.model.entity.Entity;\n \n \n /**\n- * An encapsulation of entities as a group of responses.  Ordered by the requesting filters.  Each set should be considered a \"page\" of results.\n+ * An encapsulation of entities as a group of responses.  Ordered by the requesting filters.  Each set should be\n+ * considered a \"page\" of results.  A hold over from 1.0.  We shouldn't need this when we fully move away from the EM/RM\n  */\n public class ResultsPage {\n \n     private final List<Entity> entityList;\n \n+    private final int limit;\n \n-    public ResultsPage( final List<Entity> entityList ) {this.entityList = entityList;}\n+    private final ResponseCursor responseCursor;\n+\n+\n+    public ResultsPage( final List<Entity> entityList, final ResponseCursor responseCursor, final int limit ) {\n+        this.entityList = entityList;\n+        this.responseCursor = responseCursor;\n+        this.limit = limit;\n+    }\n \n \n     public List<Entity> getEntityList() {\n@@ -43,9 +53,15 @@\n \n     /**\n      * Return true if the results page is empty\n-     * @return\n      */\n-    public boolean isEmpty(){\n-        return entityList == null || entityList.isEmpty();\n+    public boolean hasMoreResults() {\n+        return entityList != null && entityList.size() == limit;\n+    }\n+\n+\n+\n+\n+    public ResponseCursor getResponseCursor() {\n+        return responseCursor;\n     }\n }",
                "additions": 21,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ResultsPage.java",
                "status": "modified",
                "changes": 26,
                "deletions": 5,
                "sha": "1810d65410984b819a37ef3ed369b0e1cf834a64",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ResultsPage.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ResultsPage.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/ResultsPage.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read.collect;\n+\n+\n+import org.apache.usergrid.corepersistence.pipeline.PipelineContext;\n+import org.apache.usergrid.corepersistence.pipeline.read.Collector;\n+import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+\n+\n+/**\n+ * Basic functionality for our commands to handle cursor IO\n+ * @param <T> the input type\n+ * @param <R> The output Type\n+ */\n+public abstract class AbstractCollector<T, R> implements Collector<T, R> {\n+\n+\n+    protected PipelineContext pipelineContext;\n+\n+\n+    @Override\n+    public void setContext( final PipelineContext pipelineContext ) {\n+        this.pipelineContext = pipelineContext;\n+    }\n+\n+\n+\n+}",
                "additions": 46,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/AbstractCollector.java",
                "status": "added",
                "changes": 46,
                "deletions": 0,
                "sha": "1c5175da04bdc45a277cff6d1fa1e60cf4a67866",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/AbstractCollector.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/AbstractCollector.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/AbstractCollector.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read.collect;\n+\n+\n+import org.apache.usergrid.corepersistence.pipeline.cursor.CursorSerializer;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractPathFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n+import org.apache.usergrid.persistence.model.entity.Entity;\n+import org.apache.usergrid.persistence.model.entity.Id;\n+\n+import com.google.common.base.Optional;\n+\n+import rx.Observable;\n+\n+\n+/**\n+ * A filter that is used when we can potentially serialize pages via cursor.  This will filter the first result, only if\n+ * it matches the Id that was set\n+ */\n+public class EntityFilter extends AbstractPathFilter<Entity, Entity, Id> implements Filter<Entity, Entity> {\n+\n+\n+    @Override\n+    public Observable<FilterResult<Entity>> call( final Observable<FilterResult<Entity>> filterResultObservable ) {\n+\n+        //filter only the first id, then map into our path for our next pass\n+\n+\n+        return filterResultObservable.skipWhile( filterResult -> {\n+\n+            final Optional<Id> startFromCursor = getSeekValue();\n+\n+            return startFromCursor.isPresent() && startFromCursor.get().equals( filterResult.getValue().getId() );\n+        } ).map( filterResult -> {\n+\n+\n+            final Entity entity = filterResult.getValue();\n+            final Id entityId = entity.getId();\n+\n+            return createFilterResult( entity, entityId, filterResult.getPath() );\n+        } );\n+    }\n+\n+\n+    @Override\n+    protected CursorSerializer<Id> getCursorSerializer() {\n+        return IdCursorSerializer.INSTANCE;\n+    }\n+}",
                "additions": 68,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/EntityFilter.java",
                "status": "added",
                "changes": 68,
                "deletions": 0,
                "sha": "daf2e7fe0401c6ad62677803d27cf18a6f0d913d",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/EntityFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/EntityFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/EntityFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -17,15 +17,25 @@\n  * under the License.\n  */\n \n-package org.apache.usergrid.corepersistence.pipeline.read;\n+package org.apache.usergrid.corepersistence.pipeline.read.collect;\n \n \n-import org.apache.usergrid.persistence.index.CandidateResults;\n+import org.apache.usergrid.corepersistence.pipeline.cursor.AbstractCursorSerializer;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n \n /**\n- * Traverses edges in the graph.  Either by query or graph traversal.  Take an observable of ids, and emits\n- * an observable of ids\n+ * cursor serializer for Ids\n  */\n-public interface CandidateResultsFilter extends PipelineOperation<Id, CandidateResults> {}\n+public class IdCursorSerializer extends AbstractCursorSerializer<Id> {\n+\n+\n+    public static final IdCursorSerializer INSTANCE = new IdCursorSerializer();\n+\n+    @Override\n+    protected Class<Id> getType() {\n+        return Id.class;\n+    }\n+\n+\n+}",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/IdCursorSerializer.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/CandidateResultsFilter.java",
                "status": "renamed",
                "changes": 20,
                "deletions": 5,
                "sha": "d96b9f2f01a23f5158b27d25cb70d715e8560905",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/IdCursorSerializer.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/IdCursorSerializer.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/IdCursorSerializer.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read.collect;\n+\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.usergrid.corepersistence.pipeline.cursor.ResponseCursor;\n+import org.apache.usergrid.corepersistence.pipeline.read.Collector;\n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n+import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n+import org.apache.usergrid.persistence.model.entity.Entity;\n+\n+import com.google.common.base.Optional;\n+\n+import rx.Observable;\n+\n+\n+/**\n+ * Takes entities and collects them into results.  This mostly exists for 1.0 compatibility.  Eventually this will\n+ * become the only collector in our pipline and be used when rendering results, both on GET, PUT and POST.\n+ */\n+public class ResultsPageCollector extends AbstractCollector<Entity, ResultsPage>\n+    implements Collector<Entity, ResultsPage> {\n+\n+\n+    @Override\n+    public Observable<ResultsPage> call( final Observable<FilterResult<Entity>> filterResultObservable ) {\n+\n+        final int limit = pipelineContext.getLimit();\n+\n+        return filterResultObservable.buffer( limit ).flatMap( buffer -> Observable.from( buffer ).collect(\n+            () -> new ResultsPageWithCursorCollector( limit ), ( collector, entity ) -> {\n+                collector.add( entity );\n+            } ) ).map( resultsPageCollector -> new ResultsPage( resultsPageCollector.results,\n+            new ResponseCursor( resultsPageCollector.lastPath ), pipelineContext.getLimit() ) );\n+    }\n+\n+\n+    /**\n+     * A collector that will aggregate our results together\n+     */\n+    private static class ResultsPageWithCursorCollector {\n+\n+\n+        private final List<Entity> results;\n+\n+        private Optional<EdgePath> lastPath;\n+\n+\n+        private ResultsPageWithCursorCollector( final int limit ) {\n+            this.results = new ArrayList<>( limit );\n+        }\n+\n+\n+        public void add( final FilterResult<Entity> result ) {\n+            this.results.add( result.getValue() );\n+            this.lastPath = result.getPath();\n+        }\n+    }\n+}",
                "additions": 80,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/ResultsPageCollector.java",
                "status": "added",
                "changes": 80,
                "deletions": 0,
                "sha": "84654aa67530f57811b2eb89fa1edc3a5bdb16c6",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/ResultsPageCollector.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/ResultsPageCollector.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/collect/ResultsPageCollector.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -24,11 +24,13 @@\n import org.slf4j.LoggerFactory;\n \n import org.apache.usergrid.corepersistence.pipeline.cursor.CursorSerializer;\n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractSeekingFilter;\n-import org.apache.usergrid.corepersistence.pipeline.read.CandidateResultsFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractPathFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.core.metrics.MetricsFactory;\n import org.apache.usergrid.persistence.core.metrics.ObservableTimer;\n import org.apache.usergrid.persistence.index.ApplicationEntityIndex;\n+import org.apache.usergrid.persistence.index.CandidateResult;\n import org.apache.usergrid.persistence.index.CandidateResults;\n import org.apache.usergrid.persistence.index.EntityIndexFactory;\n import org.apache.usergrid.persistence.index.SearchEdge;\n@@ -44,8 +46,8 @@\n /**\n  * Command for reading graph edges\n  */\n-public abstract class AbstractElasticSearchFilter extends AbstractSeekingFilter<Id, CandidateResults, Integer>\n-    implements CandidateResultsFilter {\n+public abstract class AbstractElasticSearchFilter extends AbstractPathFilter<Id, Candidate, Integer>\n+    implements Filter<Id, Candidate> {\n \n     private static final Logger log = LoggerFactory.getLogger( AbstractElasticSearchFilter.class );\n \n@@ -66,7 +68,7 @@ public AbstractElasticSearchFilter( final EntityIndexFactory entityIndexFactory,\n \n \n     @Override\n-    public Observable<CandidateResults> call( final Observable<Id> observable ) {\n+    public Observable<FilterResult<Candidate>> call( final Observable<FilterResult<Id>> observable ) {\n \n         //get the graph manager\n         final ApplicationEntityIndex applicationEntityIndex =\n@@ -80,12 +82,12 @@ public AbstractElasticSearchFilter( final EntityIndexFactory entityIndexFactory,\n \n \n         //return all ids that are emitted from this edge\n-        return observable.flatMap( id -> {\n+        return observable.flatMap( idFilterResult -> {\n \n-            final SearchEdge searchEdge = getSearchEdge( id );\n+            final SearchEdge searchEdge = getSearchEdge( idFilterResult.getValue() );\n \n \n-            final Observable<CandidateResults> candidates = Observable.create( subscriber -> {\n+            final Observable<FilterResult<Candidate>> candidates = Observable.create( subscriber -> {\n \n                 //our offset to our start value.  This will be set the first time we emit\n                 //after we receive new ids, we want to reset this to 0\n@@ -98,28 +100,41 @@ public AbstractElasticSearchFilter( final EntityIndexFactory entityIndexFactory,\n \n                 subscriber.onStart();\n \n-                //emit while we have values from ES\n-                while ( true ) {\n+                //emit while we have values from ES and someone is subscribed\n+                while ( !subscriber.isUnsubscribed() ) {\n \n \n                     try {\n                         final CandidateResults candidateResults =\n                             applicationEntityIndex.search( searchEdge, searchTypes, query, limit, currentOffSet );\n \n-                        currentOffSet += candidateResults.size();\n \n-                        //set the cursor for the next value\n-                        setCursor( currentOffSet );\n+\n+                        for( CandidateResult candidateResult: candidateResults){\n+\n+                            //our subscriber unsubscribed, break out\n+                            if(subscriber.isUnsubscribed()){\n+                                return;\n+                            }\n+\n+                            final Candidate candidate = new Candidate( candidateResult, searchEdge );\n+\n+                            final FilterResult<Candidate>\n+                                result = createFilterResult( candidate, currentOffSet, idFilterResult.getPath() );\n+\n+                            subscriber.onNext( result );\n+\n+                            currentOffSet++;\n+                        }\n \n                         /**\n                          * No candidates, we're done\n                          */\n-                        if ( candidateResults.size() == 0 ) {\n+                        if (candidateResults.size() < limit) {\n                             subscriber.onCompleted();\n                             return;\n                         }\n \n-                        subscriber.onNext( candidateResults );\n                     }\n                     catch ( Throwable t ) {\n ",
                "additions": 30,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java",
                "status": "modified",
                "changes": 45,
                "deletions": 15,
                "sha": "f403e21fc6beae59c349cb7a707de775b5d46637",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/AbstractElasticSearchFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -7,7 +7,7 @@\n  * \"License\"); you may not use this file except in compliance\n  * with the License.  You may obtain a copy of the License at\n  *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n  *\n  * Unless required by applicable law or agreed to in writing,\n  * software distributed under the License is distributed on an\n@@ -17,25 +17,39 @@\n  * under the License.\n  */\n \n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n+package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch;\n \n \n-import org.apache.usergrid.persistence.Query;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n+import org.apache.usergrid.persistence.index.CandidateResult;\n import org.apache.usergrid.persistence.index.SearchEdge;\n \n \n /**\n- * Factory for creating results\n+ * Create a candidate. This holds the original candidate, as well as the search scope it was found it\n  */\n-public interface ResultsLoaderFactory {\n+public class Candidate {\n+\n+    private final CandidateResult candidateResult;\n+    private final SearchEdge searchEdge;\n+\n \n     /**\n-     * Get the loader for results\n-     * @param applicationScope The application scope used to load results\n-     * @param indexScope The index scope used in the search\n-     * @param\n+     * Create a new Candidate for further processing\n+     * @param candidateResult  The candidate result\n+     * @param searchEdge The search edge this was searched on\n      */\n-    ResultsLoader getLoader( final ApplicationScope applicationScope, final SearchEdge indexScope,\n-                             final Query.Level resultsLevel );\n+    public Candidate( final CandidateResult candidateResult, final SearchEdge searchEdge ) {\n+        this.candidateResult = candidateResult;\n+        this.searchEdge = searchEdge;\n+    }\n+\n+\n+    public CandidateResult getCandidateResult() {\n+        return candidateResult;\n+    }\n+\n+\n+    public SearchEdge getSearchEdge() {\n+        return searchEdge;\n+    }\n }",
                "additions": 26,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/Candidate.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsLoaderFactory.java",
                "status": "renamed",
                "changes": 38,
                "deletions": 12,
                "sha": "ab9d5d9485aa679dcf2ce9aa277bf4ab9a8677a7",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/Candidate.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/Candidate.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/Candidate.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -27,49 +27,53 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractPipelineOperation;\n-import org.apache.usergrid.corepersistence.pipeline.read.Collector;\n-import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n+import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n import org.apache.usergrid.persistence.collection.EntitySet;\n import org.apache.usergrid.persistence.collection.MvccEntity;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.index.ApplicationEntityIndex;\n import org.apache.usergrid.persistence.index.CandidateResult;\n-import org.apache.usergrid.persistence.index.CandidateResults;\n import org.apache.usergrid.persistence.index.EntityIndexBatch;\n import org.apache.usergrid.persistence.index.EntityIndexFactory;\n import org.apache.usergrid.persistence.index.SearchEdge;\n import org.apache.usergrid.persistence.model.entity.Entity;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.fasterxml.uuid.UUIDComparator;\n+import com.google.common.base.Optional;\n import com.google.inject.Inject;\n \n import rx.Observable;\n \n \n /**\n- * Loads entities from an incoming CandidateResults object and return them as results\n+ * Loads entities from an incoming CandidateResult emissions into entities, then streams them on\n+ * performs internal buffering for efficiency.  Note that all entities may not be emitted if our load crosses page boundaries.  It is up to the\n+ * collector to determine when to stop streaming entities.\n  */\n-public class CandidateResultsEntityResultsCollector extends AbstractPipelineOperation<CandidateResults, ResultsPage>\n-    implements Collector<CandidateResults, ResultsPage> {\n+public class CandidateEntityFilter extends AbstractFilter<Candidate, Entity>\n+    implements Filter<Candidate, Entity> {\n \n     private final EntityCollectionManagerFactory entityCollectionManagerFactory;\n     private final EntityIndexFactory entityIndexFactory;\n \n \n     @Inject\n-    public CandidateResultsEntityResultsCollector( final EntityCollectionManagerFactory entityCollectionManagerFactory,\n-                                                   final EntityIndexFactory entityIndexFactory ) {\n+    public CandidateEntityFilter( final EntityCollectionManagerFactory entityCollectionManagerFactory,\n+                                  final EntityIndexFactory entityIndexFactory ) {\n         this.entityCollectionManagerFactory = entityCollectionManagerFactory;\n         this.entityIndexFactory = entityIndexFactory;\n     }\n \n \n     @Override\n-    public Observable<ResultsPage> call( final Observable<CandidateResults> candidateResultsObservable ) {\n+       public Observable<FilterResult<Entity>> call(\n+           final Observable<FilterResult<Candidate>> candidateResultsObservable ) {\n \n \n         /**\n@@ -86,43 +90,50 @@ public CandidateResultsEntityResultsCollector( final EntityCollectionManagerFact\n         final ApplicationEntityIndex applicationIndex =\n             entityIndexFactory.createApplicationEntityIndex( applicationScope );\n \n-        final Observable<ResultsPage> searchIdSetObservable = candidateResultsObservable.flatMap( candidateResults -> {\n-            //flatten toa list of ids to load\n-            final Observable<List<Id>> candidateIds =\n-                Observable.from( candidateResults ).map( candidate -> candidate.getId() ).toList();\n+        //buffer them to get a page size we can make 1 network hop\n+        final Observable<FilterResult<Entity>> searchIdSetObservable = candidateResultsObservable.buffer( pipelineContext.getLimit() )\n \n-            //load the ids\n-            final Observable<EntitySet> entitySetObservable =\n-                candidateIds.flatMap( ids -> entityCollectionManager.load( ids ) );\n+            //load them\n+            .flatMap( candidateResults -> {\n+                    //flatten toa list of ids to load\n+                    final Observable<List<Id>> candidateIds =\n+                        Observable.from( candidateResults ).map( filterResultCandidate -> filterResultCandidate.getValue().getCandidateResult().getId() ).toList();\n \n-            //now we have a collection, validate our canidate set is correct.\n+                    //load the ids\n+                    final Observable<EntitySet> entitySetObservable =\n+                        candidateIds.flatMap( ids -> entityCollectionManager.load( ids ) );\n \n-            return entitySetObservable\n-                .map( entitySet -> new EntityCollector( applicationIndex.createBatch(), entitySet, candidateResults ) )\n-                .doOnNext( entityCollector -> entityCollector.merge() )\n-                .map( entityCollector -> entityCollector.getResults() );\n-        } );\n+                    //now we have a collection, validate our canidate set is correct.\n+\n+                    return entitySetObservable.map(\n+                        entitySet -> new EntityVerifier( applicationIndex.createBatch(), entitySet,\n+                            candidateResults ) ).doOnNext( entityCollector -> entityCollector.merge() )\n+                                              .flatMap(\n+                                                  entityCollector -> Observable.from( entityCollector.getResults() ) );\n+                } );\n \n         //if we filter all our results, we want to continue to try the next page\n         return searchIdSetObservable;\n     }\n \n \n+\n+\n     /**\n      * Our collector to collect entities.  Not quite a true collector, but works within our operational flow as this state is mutable and difficult to represent functionally\n      */\n-    private static final class EntityCollector {\n+    private static final class EntityVerifier {\n \n-        private static final Logger logger = LoggerFactory.getLogger( EntityCollector.class );\n-        private List<Entity> results = new ArrayList<>();\n+        private static final Logger logger = LoggerFactory.getLogger( EntityVerifier.class );\n+        private List<FilterResult<Entity>> results = new ArrayList<>();\n \n         private final EntityIndexBatch batch;\n-        private final CandidateResults candidateResults;\n+        private final List<FilterResult<Candidate>> candidateResults;\n         private final EntitySet entitySet;\n \n \n-        public EntityCollector( final EntityIndexBatch batch, final EntitySet entitySet,\n-                                final CandidateResults candidateResults ) {\n+        public EntityVerifier( final EntityIndexBatch batch, final EntitySet entitySet,\n+                               final List<FilterResult<Candidate>> candidateResults ) {\n             this.batch = batch;\n             this.entitySet = entitySet;\n             this.candidateResults = candidateResults;\n@@ -135,16 +146,16 @@ public EntityCollector( final EntityIndexBatch batch, final EntitySet entitySet,\n          */\n         public void merge() {\n \n-            for ( final CandidateResult candidateResult : candidateResults ) {\n+            for ( final FilterResult<Candidate> candidateResult : candidateResults ) {\n                 validate( candidateResult );\n             }\n \n             batch.execute();\n         }\n \n \n-        public ResultsPage getResults() {\n-            return new ResultsPage( results );\n+        public List<FilterResult<Entity>> getResults() {\n+            return results;\n         }\n \n \n@@ -153,8 +164,11 @@ public EntityIndexBatch getBatch() {\n         }\n \n \n-        private void validate( final CandidateResult candidateResult ) {\n+        private void validate( final FilterResult<Candidate> filterResult ) {\n \n+            final Candidate candidate = filterResult.getValue();\n+            final CandidateResult candidateResult = candidate.getCandidateResult();\n+            final SearchEdge searchEdge = candidate.getSearchEdge();\n             final Id candidateId = candidateResult.getId();\n             final UUID candidateVersion = candidateResult.getVersion();\n \n@@ -178,13 +192,14 @@ private void validate( final CandidateResult candidateResult ) {\n \n \n             final UUID entityVersion = entity.getVersion();\n+            final Id entityId = entity.getId();\n+\n \n \n-            //entity is newer than ES version, could be an update or the entity is marked as deleted\n-            if ( UUIDComparator.staticCompare( entityVersion, candidateVersion ) > 0) {\n \n-                final Id entityId = entity.getId();\n-                final SearchEdge searchEdge = candidateResults.getSearchEdge();\n+\n+            //entity is newer than ES version, could be an update or the entity is marked as deleted\n+            if ( UUIDComparator.staticCompare( entityVersion, candidateVersion ) > 0 || !entity.getEntity().isPresent()) {\n \n                 logger.warn( \"Deindexing stale entity on edge {} for entityId {} and version {}\",\n                     new Object[] { searchEdge, entityId, entityVersion } );\n@@ -196,9 +211,6 @@ private void validate( final CandidateResult candidateResult ) {\n             //remove the ES record, since the read in cass should cause a read repair, just ignore\n             if ( UUIDComparator.staticCompare( candidateVersion, entityVersion ) > 0 ) {\n \n-                final Id entityId = entity.getId();\n-                final SearchEdge searchEdge = candidateResults.getSearchEdge();\n-\n                 logger.warn(\n                     \"Found a newer version in ES over cassandra for edge {} for entityId {} and version {}.  Repair \"\n                         + \"should be run\", new Object[] { searchEdge, entityId, entityVersion } );\n@@ -210,8 +222,13 @@ private void validate( final CandidateResult candidateResult ) {\n \n             //they're the same add it\n \n+            final Entity returnEntity = entity.getEntity().get();\n+\n+            final Optional<EdgePath> parent = filterResult.getPath();\n+\n+            final FilterResult<Entity> toReturn = new FilterResult<>( returnEntity, parent );\n \n-            results.add( entity.getEntity().get() );\n+            results.add( toReturn );\n         }\n     }\n }",
                "additions": 58,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateEntityFilter.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateResultsEntityResultsCollector.java",
                "status": "renamed",
                "changes": 99,
                "deletions": 41,
                "sha": "d30917c971a7fadb725f72ba72c1ff30bcc277c4",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateEntityFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateEntityFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateEntityFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -27,16 +27,17 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractPipelineOperation;\n-import org.apache.usergrid.corepersistence.pipeline.read.PipelineOperation;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractFilter;\n+import org.apache.usergrid.corepersistence.pipeline.PipelineOperation;\n+import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n import org.apache.usergrid.persistence.collection.MvccLogEntry;\n import org.apache.usergrid.persistence.collection.VersionSet;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.index.ApplicationEntityIndex;\n import org.apache.usergrid.persistence.index.CandidateResult;\n-import org.apache.usergrid.persistence.index.CandidateResults;\n import org.apache.usergrid.persistence.index.EntityIndexBatch;\n import org.apache.usergrid.persistence.index.EntityIndexFactory;\n import org.apache.usergrid.persistence.index.SearchEdge;\n@@ -52,24 +53,24 @@\n  * Responsible for verifying candidate result versions, then emitting the Ids of these versions\n  * Input is a batch of candidate results, output is a stream of validated Ids\n  */\n-public class CandidateResultsIdVerifyFilter extends AbstractPipelineOperation<CandidateResults, Id>\n-    implements PipelineOperation<CandidateResults, Id> {\n+public class CandidateIdFilter extends AbstractFilter<Candidate, Id>\n+    implements Filter<Candidate, Id> {\n \n     private final EntityCollectionManagerFactory entityCollectionManagerFactory;\n     private final EntityIndexFactory entityIndexFactory;\n \n \n     @Inject\n-    public CandidateResultsIdVerifyFilter( final EntityCollectionManagerFactory entityCollectionManagerFactory,\n-                                           final EntityIndexFactory entityIndexFactory ) {\n+    public CandidateIdFilter( final EntityCollectionManagerFactory entityCollectionManagerFactory,\n+                              final EntityIndexFactory entityIndexFactory ) {\n         this.entityCollectionManagerFactory = entityCollectionManagerFactory;\n         this.entityIndexFactory = entityIndexFactory;\n     }\n \n \n \n     @Override\n-    public Observable<Id> call( final Observable<CandidateResults> observable ) {\n+      public Observable<FilterResult<Id>> call( final Observable<FilterResult<Candidate>> filterResultObservable ) {\n \n \n         /**\n@@ -86,42 +87,47 @@ public CandidateResultsIdVerifyFilter( final EntityCollectionManagerFactory enti\n         final ApplicationEntityIndex applicationIndex =\n             entityIndexFactory.createApplicationEntityIndex( applicationScope );\n \n-        final Observable<Id> searchIdSetObservable = observable.flatMap( candidateResults -> {\n-            //flatten toa list of ids to load\n-            final Observable<List<Id>> candidateIds =\n-                Observable.from( candidateResults ).map( candidate -> candidate.getId() ).toList();\n+        final Observable<FilterResult<Id>> searchIdSetObservable = filterResultObservable.buffer( pipelineContext.getLimit() ).flatMap(\n+            candidateResults -> {\n+                //flatten toa list of ids to load\n+                final Observable<List<Id>> candidateIds =\n+                    Observable.from( candidateResults ).map( candidate -> candidate.getValue().getCandidateResult().getId() )\n+                              .toList();\n \n-            //load the ids\n-            final Observable<VersionSet> versionSetObservable =\n-                candidateIds.flatMap( ids -> entityCollectionManager.getLatestVersion( ids ) );\n+                //load the ids\n+                final Observable<VersionSet> versionSetObservable =\n+                    candidateIds.flatMap( ids -> entityCollectionManager.getLatestVersion( ids ) );\n \n-            //now we have a collection, validate our canidate set is correct.\n+                //now we have a collection, validate our canidate set is correct.\n \n-            return versionSetObservable\n-                .map( entitySet -> new EntityCollector( applicationIndex.createBatch(), entitySet, candidateResults ) )\n-                .doOnNext( entityCollector -> entityCollector.merge() )\n-                .flatMap( entityCollector -> Observable.from(  entityCollector.collectResults() ) );\n+                return versionSetObservable.map(\n+                    entitySet -> new EntityCollector( applicationIndex.createBatch(), entitySet, candidateResults ) )\n+                                           .doOnNext( entityCollector -> entityCollector.merge() ).flatMap(\n+                        entityCollector -> Observable.from( entityCollector.collectResults() ) );\n         } );\n \n         return searchIdSetObservable;\n     }\n \n \n+\n+\n+\n     /**\n      * Map a new cp entity to an old entity.  May be null if not present\n      */\n     private static final class EntityCollector {\n \n         private static final Logger logger = LoggerFactory.getLogger( EntityCollector.class );\n-        private List<Id> results = new ArrayList<>();\n+        private List<FilterResult<Id>> results = new ArrayList<>();\n \n         private final EntityIndexBatch batch;\n-        private final CandidateResults candidateResults;\n+        private final List<FilterResult<Candidate>> candidateResults;\n         private final VersionSet versionSet;\n \n \n         public EntityCollector( final EntityIndexBatch batch, final VersionSet versionSet,\n-                                final CandidateResults candidateResults ) {\n+                                final List<FilterResult<Candidate>> candidateResults ) {\n             this.batch = batch;\n             this.versionSet = versionSet;\n             this.candidateResults = candidateResults;\n@@ -134,24 +140,28 @@ public EntityCollector( final EntityIndexBatch batch, final VersionSet versionSe\n          */\n         public void merge() {\n \n-            for ( final CandidateResult candidateResult : candidateResults ) {\n+            for ( final FilterResult<Candidate> candidateResult : candidateResults ) {\n                 validate( candidateResult );\n             }\n \n             batch.execute();\n         }\n \n \n-        public List<Id> collectResults() {\n+        public List<FilterResult<Id>> collectResults() {\n             return results;\n         }\n \n \n         /**\n          * Validate each candidate results vs the data loaded from cass\n-         * @param candidateResult\n+         * @param filterCandidate\n          */\n-        private void validate( final CandidateResult candidateResult ) {\n+        private void validate( final FilterResult<Candidate> filterCandidate ) {\n+\n+            final CandidateResult candidateResult = filterCandidate.getValue().getCandidateResult();\n+\n+            final SearchEdge searchEdge = filterCandidate.getValue().getSearchEdge();\n \n             final MvccLogEntry logEntry = versionSet.getMaxVersion( candidateResult.getId() );\n \n@@ -164,8 +174,6 @@ private void validate( final CandidateResult candidateResult ) {\n             //entity is newer than ES version\n             if ( UUIDComparator.staticCompare( entityVersion, candidateVersion ) > 0 ) {\n \n-                final SearchEdge searchEdge = candidateResults.getSearchEdge();\n-\n                 logger.warn( \"Deindexing stale entity on edge {} for entityId {} and version {}\",\n                     new Object[] { searchEdge, entityId, entityVersion } );\n                 batch.deindex( searchEdge, entityId, entityVersion );\n@@ -176,16 +184,16 @@ private void validate( final CandidateResult candidateResult ) {\n             //remove the ES record, since the read in cass should cause a read repair, just ignore\n             if ( UUIDComparator.staticCompare( candidateVersion, entityVersion ) > 0 ) {\n \n-                final SearchEdge searchEdge = candidateResults.getSearchEdge();\n-\n                 logger.warn(\n                     \"Found a newer version in ES over cassandra for edge {} for entityId {} and version {}.  Repair \"\n                         + \"should be run\", new Object[] { searchEdge, entityId, entityVersion } );\n             }\n \n             //they're the same add it\n \n-            results.add( entityId );\n+            final FilterResult<Id> result = new FilterResult<>( entityId, filterCandidate.getPath()  );\n+\n+            results.add( result );\n         }\n     }\n ",
                "additions": 40,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateIdFilter.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateResultsIdVerifyFilter.java",
                "status": "renamed",
                "changes": 72,
                "deletions": 32,
                "sha": "56e1c1cef0358a2ed9b0ffd2ecb0bd094c3163af",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateIdFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateIdFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/CandidateIdFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -1,44 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-\n-import org.apache.usergrid.persistence.EntityRef;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.SimpleEntityRef;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-\n-public class CollectionRefsVerifier extends VersionVerifier {\n-\n-\n-\n-    @Override\n-    public Results getResults( final Collection<Id> ids ) {\n-        List<EntityRef> refs = new ArrayList<EntityRef>(ids.size());\n-        for ( Id id : ids ) {\n-            refs.add( new SimpleEntityRef( id.getType(), id.getUuid() ) );\n-        }\n-        return Results.fromRefList( refs );\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionRefsVerifier.java",
                "status": "removed",
                "changes": 44,
                "deletions": 44,
                "sha": "cc966333c16e14fde566cf4160acabc14b75dd24",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionRefsVerifier.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionRefsVerifier.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionRefsVerifier.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,65 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import org.apache.usergrid.persistence.Query;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n-import org.apache.usergrid.persistence.index.ApplicationEntityIndex;\n-import org.apache.usergrid.persistence.index.SearchEdge;\n-\n-\n-/**\n- * Factory for creating results\n- */\n-public class CollectionResultsLoaderFactoryImpl implements ResultsLoaderFactory {\n-\n-    private final EntityCollectionManager entityCollectionManager;\n-    private final ApplicationEntityIndex applicationEntityIndex;\n-\n-\n-    public CollectionResultsLoaderFactoryImpl( final EntityCollectionManager entityCollectionManager,\n-        final ApplicationEntityIndex applicationEntityIndex ) {\n-        this.entityCollectionManager = entityCollectionManager;\n-        this.applicationEntityIndex = applicationEntityIndex;\n-    }\n-\n-\n-    @Override\n-    public ResultsLoader getLoader( final ApplicationScope applicationScope, final SearchEdge scope,\n-                                    final Query.Level resultsLevel ) {\n-\n-        ResultsVerifier verifier;\n-\n-        if ( resultsLevel == Query.Level.REFS ) {\n-            verifier = new CollectionRefsVerifier();\n-        }\n-        else if ( resultsLevel == Query.Level.IDS ) {\n-            verifier = new IdsVerifier();\n-        }\n-        else {\n-            verifier = new EntityVerifier( Query.MAX_LIMIT );\n-        }\n-\n-        return new FilteringLoader( entityCollectionManager, applicationEntityIndex, verifier, applicationScope,\n-            scope );\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionResultsLoaderFactoryImpl.java",
                "status": "removed",
                "changes": 65,
                "deletions": 65,
                "sha": "94c91d9750be5d4e1d147b92b3c03eb5786fb1d5",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionResultsLoaderFactoryImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionResultsLoaderFactoryImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/CollectionResultsLoaderFactoryImpl.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,59 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-\n-import org.apache.usergrid.persistence.ConnectionRef;\n-import org.apache.usergrid.persistence.EntityRef;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.cassandra.ConnectionRefImpl;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-import static org.apache.usergrid.persistence.SimpleEntityRef.ref;\n-\n-\n-/**\n- * Verifier for creating connections\n- */\n-public class ConnectionRefsVerifier extends VersionVerifier {\n-\n-\n-    private final EntityRef ownerId;\n-    private final String connectionType;\n-\n-\n-    public ConnectionRefsVerifier( final EntityRef ownerId, final String connectionType ) {\n-        this.ownerId = ownerId;\n-        this.connectionType = connectionType;\n-    }\n-\n-    @Override\n-    public Results getResults( final Collection<Id> ids ) {\n-        List<ConnectionRef> refs = new ArrayList<>();\n-        for ( Id id : ids ) {\n-            refs.add( new ConnectionRefImpl( ownerId, connectionType, ref(id.getType(), id.getUuid())  ));\n-        }\n-\n-        return Results.fromConnections( refs );\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionRefsVerifier.java",
                "status": "removed",
                "changes": 59,
                "deletions": 59,
                "sha": "6b7bddeb048dcb9b39cf3c62bab5d3546d458726",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionRefsVerifier.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionRefsVerifier.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionRefsVerifier.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,73 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import org.apache.usergrid.persistence.EntityRef;\n-import org.apache.usergrid.persistence.Query;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n-import org.apache.usergrid.persistence.index.ApplicationEntityIndex;\n-import org.apache.usergrid.persistence.index.EntityIndexFactory;\n-import org.apache.usergrid.persistence.index.SearchEdge;\n-\n-\n-/**\n- * Factory for creating results\n- */\n-public class ConnectionResultsLoaderFactoryImpl implements ResultsLoaderFactory {\n-\n-    private final EntityCollectionManager entityCollectionManager;\n-    private final ApplicationEntityIndex applicationEntityIndex;\n-    private final EntityRef ownerId;\n-    private final String connectionType;\n-\n-\n-    public ConnectionResultsLoaderFactoryImpl( final EntityCollectionManager entityCollectionManager,\n-                                               final ApplicationEntityIndex applicationEntityIndex, final EntityRef ownerId,\n-                                               final String connectionType ) {\n-        this.entityCollectionManager = entityCollectionManager;\n-        this.applicationEntityIndex = applicationEntityIndex;\n-        this.ownerId = ownerId;\n-        this.connectionType = connectionType;\n-    }\n-\n-\n-    @Override\n-    public ResultsLoader getLoader( final ApplicationScope applicationScope, final SearchEdge scope,\n-                                    final Query.Level resultsLevel ) {\n-\n-        ResultsVerifier verifier;\n-\n-        if ( resultsLevel == Query.Level.REFS ) {\n-            verifier = new ConnectionRefsVerifier( ownerId, connectionType );\n-        }\n-        else if ( resultsLevel == Query.Level.IDS ) {\n-            verifier = new ConnectionRefsVerifier( ownerId, connectionType );\n-            ;\n-        }\n-        else {\n-            verifier = new EntityVerifier( Query.MAX_LIMIT );\n-        }\n-\n-        return new FilteringLoader( entityCollectionManager, applicationEntityIndex, verifier, applicationScope, scope );\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionResultsLoaderFactoryImpl.java",
                "status": "removed",
                "changes": 73,
                "deletions": 73,
                "sha": "55b95a93efd565fadf0ad517b59d3bbf5f9f64c4",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionResultsLoaderFactoryImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionResultsLoaderFactoryImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ConnectionResultsLoaderFactoryImpl.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,224 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.Iterator;\n-import java.util.NoSuchElementException;\n-\n-import org.apache.usergrid.persistence.index.*;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import org.apache.usergrid.persistence.Query;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n-\n-import com.google.common.base.Optional;\n-\n-\n-public class ElasticSearchQueryExecutor implements Iterable<Results>, Iterator<Results> {\n-\n-    private static final Logger logger = LoggerFactory.getLogger( ElasticSearchQueryExecutor.class );\n-\n-    private final ResultsLoaderFactory resultsLoaderFactory;\n-\n-    private final ApplicationScope applicationScope;\n-\n-    private final ApplicationEntityIndex entityIndex;\n-\n-    private final SearchEdge indexScope;\n-\n-    private final SearchTypes types;\n-\n-    private final String query;\n-\n-    private final Optional<Integer> setOffsetFromCursor;\n-\n-    private final int limit;\n-\n-    private int offset;\n-\n-\n-    private Results currentResults;\n-\n-    private boolean moreToLoad = true;\n-\n-\n-\n-\n-    public ElasticSearchQueryExecutor( final ResultsLoaderFactory resultsLoaderFactory, final ApplicationEntityIndex entityIndex,\n-                                       final ApplicationScope applicationScope, final SearchEdge indexScope,\n-                                       final SearchTypes types, final String query, final Optional<Integer> setOffsetFromCursor, final int limit ) {\n-        this.resultsLoaderFactory = resultsLoaderFactory;\n-        this.applicationScope = applicationScope;\n-        this.entityIndex = entityIndex;\n-        this.indexScope = indexScope;\n-        this.types = types;\n-        this.setOffsetFromCursor = setOffsetFromCursor;\n-\n-        //we must deep copy the query passed.  Otherwise we will modify it's state with cursors.  Won't fix, not relevant\n-        //once we start subscribing to streams.\n-        this.query = query;\n-        this.limit = limit;\n-    }\n-\n-\n-    @Override\n-    public Iterator<Results> iterator() {\n-        return this;\n-    }\n-\n-\n-    private void loadNextPage() {\n-        // Because of possible stale entities, which are filtered out by buildResults(),\n-        // we loop until the we've got enough results to satisfy the query limit.\n-\n-        final int maxQueries = 10; // max re-queries to satisfy query limit\n-\n-\n-        Results results = null;\n-        int queryCount = 0;\n-\n-\n-        CandidateResults crs = null;\n-\n-        int newLimit = limit;\n-\n-        while ( queryCount++ < maxQueries ) {\n-\n-            crs = entityIndex.search( indexScope, types, query, newLimit , offset);\n-\n-\n-            logger.debug( \"Calling build results with crs {}\", crs );\n-            results = buildResults( indexScope, crs );\n-\n-            /**\n-             * In an edge case where we delete stale entities, we could potentially get less results than expected.\n-             * This will only occur once during the repair phase.\n-             * We need to ensure that we short circuit before we overflow the requested limit during a repair.\n-             */\n-            if ( crs.isEmpty() || !crs.hasOffset() || results.size() > 0 ) { // no results, no cursor, can't get more\n-                break;\n-            }\n-\n-\n-            //we didn't load anything, but there was a cursor, this means a read repair occured.  We have to short\n-            //circuit to avoid over returning the result set\n-\n-\n-            // need to query for more\n-            // ask for just what we need to satisfy, don't want to exceed limit\n-            newLimit =  newLimit - results.size();\n-\n-            logger.warn( \"Satisfy query limit {}, new limit {} query count {}\", new Object[] {\n-                limit, newLimit, queryCount\n-            } );\n-        }\n-\n-        //now set our cursor if we have one for the next iteration\n-        if ( results.hasCursor() ) {\n-            moreToLoad = true;\n-        }\n-\n-        else {\n-            moreToLoad = false;\n-        }\n-\n-//\n-//        //set our select subjects into our query if provided\n-//        if(crs != null){\n-//            query.setSelectSubjects( crs.getGetFieldMappings() );\n-//        }\n-//\n-\n-        //set our current results and the flag\n-        this.currentResults = results;\n-    }\n-\n-\n-\n-    /**\n-     * Build results from a set of candidates, and discard those that represent stale indexes.\n-     *\n-     * @param indexScope The index scope to execute the search on\n-     * @param crs Candidates to be considered for results\n-     */\n-    private Results buildResults( final SearchEdge indexScope, final CandidateResults crs ) {\n-\n-        logger.debug( \"buildResults()  from {} candidates\", crs.size() );\n-\n-        //get an instance of our results loader\n-        final ResultsLoader resultsLoader =\n-            this.resultsLoaderFactory.getLoader( applicationScope, indexScope, Query.Level.ALL_PROPERTIES );\n-\n-        //load the results\n-        final Results results = resultsLoader.loadResults(crs);\n-\n-        //signal for post processing\n-        resultsLoader.postProcess();\n-\n-        //set offset into query\n-\n-        logger.debug( \"Returning results size {}\", results.size() );\n-\n-        return results;\n-    }\n-\n-\n-    @Override\n-    public boolean hasNext() {\n-\n-        //we've tried to load and it's empty and we have more to load, load the next page\n-        if ( currentResults == null ) {\n-            //there's nothing left to load, nothing to do\n-            if ( !moreToLoad ) {\n-                return false;\n-            }\n-\n-            //load the page\n-\n-            loadNextPage();\n-        }\n-\n-\n-        //see if our current results are not null\n-        return currentResults != null;\n-    }\n-\n-\n-    @Override\n-    public Results next() {\n-        if ( !hasNext() ) {\n-            throw new NoSuchElementException( \"No more results present\" );\n-        }\n-\n-        final Results toReturn = currentResults;\n-\n-        currentResults = null;\n-\n-        return toReturn;\n-    }\n-\n-    @Override\n-    public void remove() {\n-        throw new RuntimeException(\"Remove not implemented!!\");\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ElasticSearchQueryExecutor.java",
                "status": "removed",
                "changes": 224,
                "deletions": 224,
                "sha": "6e170f88c07b3c8d8a55883edc138319d57820ec",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ElasticSearchQueryExecutor.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ElasticSearchQueryExecutor.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ElasticSearchQueryExecutor.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,127 +0,0 @@\n-/*\n- *\n- *  * Licensed to the Apache Software Foundation (ASF) under one or more\n- *  *  contributor license agreements.  The ASF licenses this file to You\n- *  * under the Apache License, Version 2.0 (the \"License\"); you may not\n- *  * use this file except in compliance with the License.\n- *  * You may obtain a copy of the License at\n- *  *\n- *  *     http://www.apache.org/licenses/LICENSE-2.0\n- *  *\n- *  * Unless required by applicable law or agreed to in writing, software\n- *  * distributed under the License is distributed on an \"AS IS\" BASIS,\n- *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- *  * See the License for the specific language governing permissions and\n- *  * limitations under the License.  For additional information regarding\n- *  * copyright in this work, please see the NOTICE file in the top level\n- *  * directory of this distribution.\n- *\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.UUID;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import org.apache.usergrid.corepersistence.util.CpEntityMapUtils;\n-import org.apache.usergrid.persistence.Entity;\n-import org.apache.usergrid.persistence.EntityFactory;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.EntitySet;\n-import org.apache.usergrid.persistence.collection.MvccEntity;\n-import org.apache.usergrid.persistence.index.CandidateResult;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-import com.fasterxml.uuid.UUIDComparator;\n-import com.google.common.base.Optional;\n-\n-\n-/**\n- * A loader that verifies versions are correct in cassandra and match elasticsearch\n- */\n-public class EntityVerifier implements ResultsVerifier {\n-\n-    private static final Logger logger = LoggerFactory.getLogger( EntityVerifier.class );\n-\n-    private EntitySet ids;\n-\n-    private Map<Id, org.apache.usergrid.persistence.model.entity.Entity> entityMapping;\n-\n-\n-    public EntityVerifier( final int maxSize ) {\n-        this.entityMapping = new HashMap<>( maxSize );\n-    }\n-\n-\n-    @Override\n-    public void loadResults( final Collection<Id> idsToLoad, final EntityCollectionManager ecm ) {\n-        ids = ecm.load( idsToLoad ).toBlocking().last();\n-        logger.debug(\"loadResults() asked for {} ids and got {}\", idsToLoad.size(), ids.size());\n-    }\n-\n-\n-    @Override\n-    public boolean isValid( final CandidateResult candidateResult ) {\n-        final Id entityId = candidateResult.getId();\n-\n-        final MvccEntity savedEntity = ids.getEntity( entityId );\n-\n-        //version wasn't found deindex\n-        if ( savedEntity == null ) {\n-            logger.warn( \"Version for Entity {}:{} not found\", entityId.getType(), entityId.getUuid() );\n-            return false;\n-        }\n-\n-        final UUID candidateVersion = candidateResult.getVersion();\n-        final UUID savedVersion = savedEntity.getVersion();\n-\n-        if ( UUIDComparator.staticCompare( savedVersion, candidateVersion ) > 0 ) {\n-            logger.warn( \"Stale version of Entity uuid:{} type:{}, stale v:{}, latest v:{}\", new Object[] {\n-                    entityId.getUuid(), entityId.getType(), candidateVersion, savedEntity\n-            } );\n-\n-            return false;\n-        }\n-\n-\n-        final Optional<org.apache.usergrid.persistence.model.entity.Entity> entity = savedEntity.getEntity();\n-\n-        if ( !entity.isPresent() ) {\n-            logger.warn( \"Entity uuid:{} version v:{} is deleted but indexed, this is a bug \",\n-                    entityId.getUuid(), savedEntity.getEntity() );\n-            return false;\n-        }\n-\n-        entityMapping.put( entityId, entity.get() );\n-\n-        return true;\n-    }\n-\n-\n-    @Override\n-    public Results getResults( final Collection<Id> ids ) {\n-\n-        final List<Entity> ugEntities = new ArrayList<>( ids.size() );\n-\n-        for ( final Id id : ids ) {\n-            final org.apache.usergrid.persistence.model.entity.Entity cpEntity = entityMapping.get( id );\n-\n-            Entity entity = EntityFactory.newEntity( id.getUuid(), id.getType() );\n-\n-            Map<String, Object> entityMap = CpEntityMapUtils.toMap( cpEntity );\n-            entity.addProperties( entityMap );\n-            ugEntities.add( entity );\n-        }\n-\n-        return Results.fromEntities( ugEntities );\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/EntityVerifier.java",
                "status": "removed",
                "changes": 127,
                "deletions": 127,
                "sha": "d73c73169e4d2abbd998eb213b5af0b00b82f30f",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/EntityVerifier.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/EntityVerifier.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/EntityVerifier.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,219 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.Collection;\n-import java.util.HashMap;\n-import java.util.Iterator;\n-import java.util.Map;\n-import java.util.TreeMap;\n-import java.util.UUID;\n-\n-import javax.annotation.Nullable;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import org.apache.usergrid.corepersistence.ManagerCache;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n-import org.apache.usergrid.persistence.index.ApplicationEntityIndex;\n-import org.apache.usergrid.persistence.index.EntityIndexBatch;\n-import org.apache.usergrid.persistence.index.EntityIndexFactory;\n-import org.apache.usergrid.persistence.index.SearchEdge;\n-import org.apache.usergrid.persistence.index.CandidateResult;\n-import org.apache.usergrid.persistence.index.CandidateResults;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-import com.fasterxml.uuid.UUIDComparator;\n-import com.google.common.base.Function;\n-import com.google.common.collect.Collections2;\n-\n-\n-public class FilteringLoader implements ResultsLoader {\n-\n-    private static final Logger logger = LoggerFactory.getLogger( FilteringLoader.class );\n-\n-    private final EntityCollectionManager entityCollectionManager;\n-    private final ResultsVerifier resultsVerifier;\n-    private final ApplicationScope applicationScope;\n-    private final SearchEdge indexScope;\n-    private final EntityIndexBatch indexBatch;\n-\n-\n-    /**\n-     * Create an instance of a filter loader\n-     *\n-     * @param entityCollectionManager The entityCollectionManagerFactory\n-     * @param resultsVerifier The verifier to verify the candidate results\n-     * @param applicationScope The application scope to perform the load\n-     * @param indexScope The index scope used in the search\n-     */\n-    protected FilteringLoader( final  EntityCollectionManager entityCollectionManager, final ApplicationEntityIndex applicationEntityIndex,  final ResultsVerifier resultsVerifier,\n-                               final ApplicationScope applicationScope, final SearchEdge indexScope ) {\n-\n-        this.entityCollectionManager = entityCollectionManager;\n-        this.resultsVerifier = resultsVerifier;\n-        this.applicationScope = applicationScope;\n-        this.indexScope = indexScope;\n-\n-        indexBatch = applicationEntityIndex.createBatch();\n-    }\n-\n-\n-    @Override\n-    public Results loadResults( final CandidateResults crs ) {\n-\n-\n-        if ( crs.size() == 0 ) {\n-            return new Results();\n-        }\n-\n-\n-        // For each entity, holds the index it appears in our candidates for keeping ordering correct\n-        final Map<Id, Integer> orderIndex = new HashMap<>( crs.size() );\n-\n-        // Maps the entity ids to our candidates\n-        final Map<Id, CandidateResult> maxCandidateMapping = new HashMap<>( crs.size() );\n-\n-\n-        final Iterator<CandidateResult> iter = crs.iterator();\n-\n-\n-        // TODO, in this case we're \"optimizing\" due to the limitations of collection scope.\n-        // Perhaps  we should change the API to just be an application, then an \"owner\" scope?\n-\n-        // Go through the candidates and group them by scope for more efficient retrieval.\n-        // Also remove duplicates before we even make a network call\n-        for ( int i = 0; iter.hasNext(); i++ ) {\n-\n-            final CandidateResult currentCandidate = iter.next();\n-\n-            final Id entityId = currentCandidate.getId();\n-\n-            //check if we've seen this candidate by id\n-            final CandidateResult previousMax = maxCandidateMapping.get( entityId );\n-\n-            //its not been seen, save it\n-            if ( previousMax == null ) {\n-                maxCandidateMapping.put( entityId, currentCandidate );\n-                orderIndex.put( entityId, i );\n-                continue;\n-            }\n-\n-            //we have seen it, compare them\n-\n-            final UUID previousMaxVersion = previousMax.getVersion();\n-\n-            final UUID currentVersion = currentCandidate.getVersion();\n-\n-\n-            final CandidateResult toRemove;\n-            final CandidateResult toKeep;\n-\n-            //current is newer than previous.  Remove previous and keep current\n-            if ( UUIDComparator.staticCompare( currentVersion, previousMaxVersion ) > 0 ) {\n-                toRemove = previousMax;\n-                toKeep = currentCandidate;\n-            }\n-            //previously seen value is newer than current.  Remove the current and keep the previously seen value\n-            else {\n-                toRemove = currentCandidate;\n-                toKeep = previousMax;\n-            }\n-\n-            //this is a newer version, we know we already have a stale entity, add it to be cleaned up\n-\n-\n-            //de-index it\n-            logger.warn( \"Stale version of Entity uuid:{} type:{}, stale v:{}, latest v:{}\", new Object[] {\n-                    entityId.getUuid(), entityId.getType(), toRemove.getVersion(), toKeep.getVersion()\n-                } );\n-\n-            //deindex this document, and remove the previous maxVersion\n-            //we have to deindex this from our ownerId, since this is what gave us the reference\n-            indexBatch.deindex( indexScope, toRemove );\n-\n-\n-            //TODO, fire the entity repair cleanup task here instead of de-indexing\n-\n-            //replace the value with a more current version\n-            maxCandidateMapping.put( entityId, toKeep );\n-            orderIndex.put( entityId, i );\n-        }\n-\n-\n-        //now everything is ordered, and older versions are removed.  Batch fetch versions to verify\n-        // existence and correct versions\n-\n-        final TreeMap<Integer, Id> sortedResults = new TreeMap<>();\n-\n-\n-        final Collection<Id> idsToLoad =\n-            Collections2.transform( maxCandidateMapping.values(), new Function<CandidateResult, Id>() {\n-                @Nullable\n-                @Override\n-                public Id apply( @Nullable final CandidateResult input ) {\n-                    //NOTE this is never null, we won't need to check\n-                    return input.getId();\n-                }\n-            } );\n-\n-\n-        //now using the scope, load the collection\n-\n-\n-\n-        //load the results into the loader for this scope for validation\n-        resultsVerifier.loadResults( idsToLoad, entityCollectionManager );\n-\n-        //now let the loader validate each candidate.  For instance, the \"max\" in this candidate\n-        //could still be a stale result, so it needs validated\n-        for ( final Id requestedId : idsToLoad ) {\n-\n-            final CandidateResult cr = maxCandidateMapping.get( requestedId );\n-\n-            //ask the loader if this is valid, if not discard it and de-index it\n-            if ( !resultsVerifier.isValid( cr ) ) {\n-                indexBatch.deindex( indexScope, cr );\n-                continue;\n-            }\n-\n-            //if we get here we're good, we need to add this to our results\n-            final int candidateIndex = orderIndex.get( requestedId );\n-\n-            sortedResults.put( candidateIndex, requestedId );\n-        }\n-\n-\n-        // NOTE DO NOT execute the batch here.\n-        // It changes the results and we need consistent paging until we aggregate all results\n-        return resultsVerifier.getResults( sortedResults.values() );\n-    }\n-\n-\n-    @Override\n-    public void postProcess() {\n-        this.indexBatch.execute();\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/FilteringLoader.java",
                "status": "removed",
                "changes": 219,
                "deletions": 219,
                "sha": "ade64a24327841010609dcd9070ff42dc06d323a",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/FilteringLoader.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/FilteringLoader.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/FilteringLoader.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,46 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-import java.util.UUID;\n-\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-\n-public class IdsVerifier extends VersionVerifier {\n-\n-    @Override\n-    public Results getResults( final Collection<Id> ids ) {\n-\n-        final List<UUID> returnIds = new ArrayList<>( ids.size() );\n-\n-        for ( final Id id : ids ) {\n-            returnIds.add( id.getUuid() );\n-        }\n-\n-\n-        return Results.fromIdList( returnIds );\n-    }\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/IdsVerifier.java",
                "status": "removed",
                "changes": 46,
                "deletions": 46,
                "sha": "4a3bfcd8c6dcbf9cad7af09b863c0ffa6c95804a",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/IdsVerifier.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/IdsVerifier.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/IdsVerifier.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,43 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.index.CandidateResults;\n-\n-\n-/**\n- * Interface for loading results\n- */\n-public interface ResultsLoader {\n-\n-    /**\n-     * Using the candidate results, load our results.  Should filter stale results\n-     * @param  crs The candidate result set\n-     * @return Results.  Null safe, but may be empty\n-     */\n-    public Results loadResults( final CandidateResults crs);\n-\n-    /**\n-     * Post process the load operation\n-     */\n-    public void postProcess();\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsLoader.java",
                "status": "removed",
                "changes": 43,
                "deletions": 43,
                "sha": "c2a3e9a5b4d3c2dda0dbcc965fcee36e275d81a8",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsLoader.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsLoader.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsLoader.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,52 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.Collection;\n-import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.index.CandidateResult;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-\n-public interface ResultsVerifier {\n-\n-    /**\n-     * Load all the candidate ides for verification\n-     * @param ids The Id's to load\n-     * @param ecm The entity collection manager\n-     */\n-    public void loadResults(Collection<Id> ids, EntityCollectionManager ecm);\n-\n-    /**\n-     * Return true if the candidate result is a valid result that should be retained. If it should\n-     * not it should also be removed from the list of possible return values in this loader\n-     * @param candidateResult\n-     */\n-    public boolean isValid(CandidateResult candidateResult);\n-\n-\n-    /**\n-     * Load the result set with the given ids\n-     * @return\n-     */\n-    public Results getResults(Collection<Id> ids);\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsVerifier.java",
                "status": "removed",
                "changes": 52,
                "deletions": 52,
                "sha": "fe72ca2e7db74eada85e1712d04b0097699a9682",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsVerifier.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsVerifier.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/ResultsVerifier.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,85 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.impl;\n-\n-\n-import java.util.Collection;\n-import java.util.UUID;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.MvccLogEntry;\n-import org.apache.usergrid.persistence.collection.VersionSet;\n-import org.apache.usergrid.persistence.index.CandidateResult;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-import com.fasterxml.uuid.UUIDComparator;\n-\n-\n-/**\n- * A loader that verifies versions are correct in Cassandra and match ElasticSearch\n- */\n-public abstract class VersionVerifier implements ResultsVerifier {\n-\n-    private static final Logger logger = LoggerFactory.getLogger( VersionVerifier.class );\n-\n-    private VersionSet ids;\n-\n-\n-    @Override\n-    public void loadResults( final Collection<Id> idsToLoad, final EntityCollectionManager ecm ) {\n-        ids = ecm.getLatestVersion( idsToLoad ).toBlocking().last();\n-    }\n-\n-\n-    @Override\n-    public boolean isValid( final CandidateResult candidateResult ) {\n-        final Id entityId = candidateResult.getId();\n-\n-        final MvccLogEntry version = ids.getMaxVersion( entityId );\n-\n-        //version wasn't found ,deindex\n-        if ( version == null ) {\n-            logger.warn( \"Version for Entity {}:{} not found\",\n-                    entityId.getUuid(), entityId.getUuid() );\n-\n-            return false;\n-        }\n-\n-        final UUID savedVersion = version.getVersion();\n-\n-        if ( UUIDComparator.staticCompare( savedVersion, candidateResult.getVersion() ) > 0 ) {\n-            logger.debug( \"Stale version of Entity uuid:{} type:{}, stale v:{}, latest v:{}\",\n-                new Object[] {\n-                    entityId.getUuid(),\n-                    entityId.getType(),\n-                    candidateResult.getVersion(),\n-                    savedVersion\n-            } );\n-\n-            return false;\n-        }\n-\n-        return true;\n-    }\n-\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/VersionVerifier.java",
                "status": "removed",
                "changes": 85,
                "deletions": 85,
                "sha": "c49fb28cb0b720fa71a45cd50bbb77c4b363e9ec",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/VersionVerifier.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/VersionVerifier.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/elasticsearch/impl/VersionVerifier.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -1,94 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.apache.usergrid.corepersistence.pipeline.read.entity;\n-\n-\n-import java.util.List;\n-\n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractPipelineOperation;\n-import org.apache.usergrid.corepersistence.pipeline.read.Collector;\n-import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n-import org.apache.usergrid.persistence.collection.EntitySet;\n-import org.apache.usergrid.persistence.collection.MvccEntity;\n-import org.apache.usergrid.persistence.model.entity.Entity;\n-import org.apache.usergrid.persistence.model.entity.Id;\n-\n-import com.google.inject.Inject;\n-\n-import rx.Observable;\n-\n-\n-/**\n- * Loads entities from a set of Ids.\n- *\n- * TODO refactor this into a common command that both ES search and graphSearch can use for repair and verification\n- */\n-public class EntityLoadCollector extends AbstractPipelineOperation<Id, ResultsPage>\n-    implements Collector<Id, ResultsPage> {\n-\n-    private final EntityCollectionManagerFactory entityCollectionManagerFactory;\n-\n-\n-    @Inject\n-    public EntityLoadCollector( final EntityCollectionManagerFactory entityCollectionManagerFactory ) {\n-        this.entityCollectionManagerFactory = entityCollectionManagerFactory;\n-    }\n-\n-\n-    @Override\n-    public Observable<ResultsPage> call( final Observable<Id> observable ) {\n-\n-\n-        final EntityCollectionManager entityCollectionManager =\n-            entityCollectionManagerFactory.createCollectionManager( pipelineContext.getApplicationScope() );\n-\n-        final Observable<EntitySet> entitySetObservable = observable.buffer( pipelineContext.getLimit() ).flatMap(\n-            bufferedIds -> Observable.just( bufferedIds ).flatMap( ids -> entityCollectionManager.load( ids ) ) );\n-\n-\n-        final Observable<ResultsPage> resultsObservable = entitySetObservable\n-\n-            .flatMap( entitySet -> {\n-\n-                //get our entites and filter missing ones, then collect them into a results object\n-                final Observable<MvccEntity> mvccEntityObservable = Observable.from( entitySet.getEntities() );\n-\n-\n-                //convert them to our old entity model, then filter abscent, meaning they weren't found\n-                final Observable<List<Entity>> entitiesPageObservable =\n-                    mvccEntityObservable.filter( mvccEntity -> mvccEntity.getEntity().isPresent() )\n-                                        .map( mvccEntity -> mvccEntity.getEntity().get() ).toList();\n-\n-                //convert them to a list, then map them into results\n-                return entitiesPageObservable.map( entities -> new ResultsPage( entities ) );\n-            } );\n-\n-\n-        return resultsObservable;\n-    }\n-\n-    /**\n-     * Map a new cp entity to an old entity.  May be null if not present\n-     */\n-\n-\n-}",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/entity/EntityLoadCollector.java",
                "status": "removed",
                "changes": 94,
                "deletions": 94,
                "sha": "dd6b9b87046bb0a303b67f0c5f4afdbba3588ddf",
                "blob_url": "https://github.com/apache/usergrid/blob/c6bbfba989b806b106fe6b2e4f1744123c30c760/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/entity/EntityLoadCollector.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/entity/EntityLoadCollector.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/entity/EntityLoadCollector.java?ref=c6bbfba989b806b106fe6b2e4f1744123c30c760"
            },
            {
                "patch": "@@ -20,8 +20,9 @@\n package org.apache.usergrid.corepersistence.pipeline.read.graph;\n \n \n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractPipelineOperation;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.graph.GraphManager;\n import org.apache.usergrid.persistence.graph.GraphManagerFactory;\n import org.apache.usergrid.persistence.graph.SearchByEdge;\n@@ -39,7 +40,7 @@\n /**\n  * Filter should take and Id and a graph edge, and ensure the connection between the two exists\n  */\n-public abstract class AbstractReadGraphEdgeByIdFilter extends AbstractPipelineOperation<Id, Id> implements\n+public abstract class AbstractReadGraphEdgeByIdFilter extends AbstractFilter<Id, Id> implements\n     Filter<Id, Id> {\n \n     private final GraphManagerFactory graphManagerFactory;\n@@ -55,20 +56,21 @@ public AbstractReadGraphEdgeByIdFilter( final GraphManagerFactory graphManagerFa\n \n \n     @Override\n-    public Observable<Id> call( final Observable<Id> idObservable ) {\n+    public Observable<FilterResult<Id>> call( final Observable<FilterResult<Id>> filterValueObservable ) {\n \n         final GraphManager gm = graphManagerFactory.createEdgeManager( pipelineContext.getApplicationScope() );\n \n-        return idObservable.flatMap( id -> {\n+        return filterValueObservable.flatMap( filterValue -> {\n             final String edgeTypeName = getEdgeName();\n+            final Id id = filterValue.getValue();\n \n             //create our search\n             final SearchByEdge searchByEdge =\n                 new SimpleSearchByEdge( id, edgeTypeName, targetId, Long.MAX_VALUE, SearchByEdgeType.Order.DESCENDING,\n                     Optional.absent() );\n \n             //load the versions of the edge, take the first since that's all we need to validate existence, then emit the target node\n-            return gm.loadEdgeVersions( searchByEdge ).take( 1 ).map( edge -> edge.getTargetNode() );\n+            return gm.loadEdgeVersions( searchByEdge ).take( 1 ).map( edge -> edge.getTargetNode() ).map( targetId -> new FilterResult<>(targetId, filterValue.getPath()));\n         } );\n     }\n ",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphEdgeByIdFilter.java",
                "status": "modified",
                "changes": 12,
                "deletions": 5,
                "sha": "42b352b9185664b4e6bae4140be56c7d33106ea1",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphEdgeByIdFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphEdgeByIdFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphEdgeByIdFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -21,8 +21,10 @@\n \n \n import org.apache.usergrid.corepersistence.pipeline.cursor.CursorSerializer;\n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractSeekingFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractPathFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.GraphManager;\n import org.apache.usergrid.persistence.graph.GraphManagerFactory;\n@@ -38,7 +40,7 @@\n /**\n  * Command for reading graph edges\n  */\n-public abstract class AbstractReadGraphFilter extends AbstractSeekingFilter<Id, Id, Edge> implements Filter<Id, Id> {\n+public abstract class AbstractReadGraphFilter extends AbstractPathFilter<Id, Id, Edge> implements Filter<Id, Id> {\n \n     private final GraphManagerFactory graphManagerFactory;\n \n@@ -52,21 +54,24 @@ public AbstractReadGraphFilter( final GraphManagerFactory graphManagerFactory )\n \n \n     @Override\n-    public Observable<Id> call( final Observable<Id> observable ) {\n+    public Observable<FilterResult<Id>> call( final Observable<FilterResult<Id>> previousIds ) {\n+\n \n         //get the graph manager\n         final GraphManager graphManager =\n             graphManagerFactory.createEdgeManager( pipelineContext.getApplicationScope() );\n \n \n         final String edgeName = getEdgeTypeName();\n+        final EdgeState edgeCursorState = new EdgeState();\n \n \n         //return all ids that are emitted from this edge\n-        return observable.flatMap( id -> {\n+        return previousIds.flatMap( previousFilterValue -> {\n \n             //set our our constant state\n             final Optional<Edge> startFromCursor = getSeekValue();\n+            final Id id = previousFilterValue.getValue();\n \n \n             final SimpleSearchByEdgeType search =\n@@ -77,14 +82,29 @@ public AbstractReadGraphFilter( final GraphManagerFactory graphManagerFactory )\n              * TODO, pass a message with pointers to our cursor values to be generated later\n              */\n             return graphManager.loadEdgesFromSource( search )\n-                //set our cursor every edge we traverse\n-                .doOnNext( edge -> setCursor( edge ) )\n-                    //map our id from the target edge\n-                .map( edge -> edge.getTargetNode() );\n+                //set the edge state for cursors\n+                .doOnNext( edge -> edgeCursorState.update( edge ) )\n+\n+                    //map our id from the target edge  and set our cursor every edge we traverse\n+                .map( edge -> createFilterResult( edge.getTargetNode(), edgeCursorState.getCursorEdge(),\n+                    previousFilterValue.getPath() ) );\n         } );\n     }\n \n \n+    @Override\n+    protected FilterResult<Id> createFilterResult( final Id emit, final Edge cursorValue,\n+                                                   final Optional<EdgePath> parent ) {\n+\n+        //if it's our first pass, there's no cursor to generate\n+        if(cursorValue == null){\n+            return new FilterResult<>( emit, parent );\n+        }\n+\n+        return super.createFilterResult( emit, cursorValue, parent );\n+    }\n+\n+\n     @Override\n     protected CursorSerializer<Edge> getCursorSerializer() {\n         return EdgeCursorSerializer.INSTANCE;\n@@ -95,4 +115,33 @@ public AbstractReadGraphFilter( final GraphManagerFactory graphManagerFactory )\n      * Get the edge type name we should use when traversing\n      */\n     protected abstract String getEdgeTypeName();\n+\n+\n+    /**\n+     * Wrapper class. Because edges seek > the last returned, we need to keep our n-1 value. This will be our cursor We\n+     * always try to seek to the same position as we ended.  Since we don't deal with a persistent read result, if we\n+     * seek to a value = to our last, we may skip data.\n+     */\n+    private final class EdgeState {\n+\n+        private Edge cursorEdge = null;\n+        private Edge currentEdge = null;\n+\n+\n+        /**\n+         * Update the pointers\n+         */\n+        private void update( final Edge newEdge ) {\n+            cursorEdge = currentEdge;\n+            currentEdge = newEdge;\n+        }\n+\n+\n+        /**\n+         * Get the edge to use in cursors for resume\n+         */\n+        private Edge getCursorEdge() {\n+            return cursorEdge;\n+        }\n+    }\n }",
                "additions": 57,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphFilter.java",
                "status": "modified",
                "changes": 65,
                "deletions": 8,
                "sha": "303bc5bad2474dd046deeabe141d72f6844f5723",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/AbstractReadGraphFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -17,11 +17,12 @@\n  * under the License.\n  */\n \n-package org.apache.usergrid.corepersistence.pipeline.read.entity;\n+package org.apache.usergrid.corepersistence.pipeline.read.graph;\n \n \n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractPipelineOperation;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.inject.Inject;\n@@ -34,7 +35,7 @@\n  * This command is a stopgap to make migrating 1.0 code easier.  Once full traversal has been implemented, this should\n  * be removed\n  */\n-public class EntityIdFilter extends AbstractPipelineOperation<Id, Id> implements Filter<Id, Id> {\n+public class EntityIdFilter extends AbstractFilter<Id, Id> implements Filter<Id, Id> {\n \n     private final Id entityId;\n \n@@ -44,10 +45,10 @@\n \n \n \n-\n     @Override\n-    public Observable<Id> call( final Observable<Id> idObservable ) {\n-        return Observable.just( entityId );\n-    }\n+    public Observable<FilterResult<Id>> call( final Observable<FilterResult<Id>> filterValueObservable ) {\n+        //ignore what our input was, and simply emit the id specified\n+       return filterValueObservable.map( idFilterResult ->  new FilterResult( entityId, idFilterResult.getPath() ));\n \n+    }\n }",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityIdFilter.java",
                "previous_filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/entity/EntityIdFilter.java",
                "status": "renamed",
                "changes": 15,
                "deletions": 7,
                "sha": "5a0e0264f5641e8fa2cd5111fa086136d92fbc4c",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityIdFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityIdFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityIdFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -0,0 +1,155 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.usergrid.corepersistence.pipeline.read.graph;\n+\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n+import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n+import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n+import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n+import org.apache.usergrid.persistence.collection.EntitySet;\n+import org.apache.usergrid.persistence.collection.MvccEntity;\n+import org.apache.usergrid.persistence.model.entity.Entity;\n+import org.apache.usergrid.persistence.model.entity.Id;\n+\n+import com.google.common.base.Optional;\n+import com.google.inject.Inject;\n+\n+import rx.Observable;\n+\n+\n+/**\n+ * Loads entities from a set of Ids.\n+ *\n+ * TODO refactor this into a common command that both ES search and graphSearch can use for repair and verification\n+ */\n+public class EntityLoadFilter extends AbstractFilter<Id, Entity> implements Filter<Id, Entity> {\n+\n+    private final EntityCollectionManagerFactory entityCollectionManagerFactory;\n+\n+\n+    @Inject\n+    public EntityLoadFilter( final EntityCollectionManagerFactory entityCollectionManagerFactory ) {\n+        this.entityCollectionManagerFactory = entityCollectionManagerFactory;\n+    }\n+\n+\n+    @Override\n+    public Observable<FilterResult<Entity>> call( final Observable<FilterResult<Id>> filterResultObservable ) {\n+\n+\n+        final EntityCollectionManager entityCollectionManager =\n+            entityCollectionManagerFactory.createCollectionManager( pipelineContext.getApplicationScope() );\n+\n+        //it's more efficient to make 1 network hop to get everything, then drop our results if required\n+        final Observable<FilterResult<Entity>> entityObservable =\n+            filterResultObservable.buffer( pipelineContext.getLimit() ).flatMap( bufferedIds -> {\n+\n+                    final Observable<EntitySet> entitySetObservable =\n+                        Observable.from( bufferedIds ).map( filterResultId -> filterResultId.getValue() ).toList()\n+                                  .flatMap( ids -> entityCollectionManager.load( ids ) );\n+\n+\n+                    //now we have a collection, validate our canidate set is correct.\n+\n+                    return entitySetObservable.map( entitySet -> new EntityVerifier( entitySet, bufferedIds ) )\n+                                              .doOnNext( entityCollector -> entityCollector.merge() ).flatMap(\n+                            entityCollector -> Observable.from( entityCollector.getResults() ) );\n+                } );\n+\n+        return entityObservable;\n+    }\n+\n+\n+    /**\n+     * Our collector to collect entities.  Not quite a true collector, but works within our operational flow as this\n+     * state is mutable and difficult to represent functionally\n+     */\n+    private static final class EntityVerifier {\n+\n+        private static final Logger logger = LoggerFactory.getLogger( EntityVerifier.class );\n+        private List<FilterResult<Entity>> results = new ArrayList<>();\n+\n+        private final List<FilterResult<Id>> candidateResults;\n+        private final EntitySet entitySet;\n+\n+\n+        public EntityVerifier( final EntitySet entitySet, final List<FilterResult<Id>> candidateResults ) {\n+            this.entitySet = entitySet;\n+            this.candidateResults = candidateResults;\n+            this.results = new ArrayList<>( entitySet.size() );\n+        }\n+\n+\n+        /**\n+         * Merge our candidates and our entity set into results\n+         */\n+        public void merge() {\n+\n+            for ( final FilterResult<Id> candidateResult : candidateResults ) {\n+                validate( candidateResult );\n+            }\n+        }\n+\n+\n+        public List<FilterResult<Entity>> getResults() {\n+            return results;\n+        }\n+\n+\n+        private void validate( final FilterResult<Id> filterResult ) {\n+\n+            final Id candidateId = filterResult.getValue();\n+\n+\n+            final MvccEntity entity = entitySet.getEntity( candidateId );\n+\n+\n+            //doesn't exist warn and drop\n+            if ( entity == null || !entity.getEntity().isPresent() ) {\n+                logger.warn( \"Read graph edge and received candidate with entityId {}, yet was not found in cassandra.\"\n+                        + \"  Ignoring since this could be a region sync issue\", candidateId );\n+\n+\n+                //TODO trigger an audit after a fail count where we explicitly try to repair from other regions\n+\n+                return;\n+            }\n+\n+            //it exists, add it\n+\n+            final Entity returnEntity = entity.getEntity().get();\n+\n+            final Optional<EdgePath> parent = filterResult.getPath();\n+\n+            final FilterResult<Entity> toReturn = new FilterResult<>( returnEntity, parent );\n+\n+            results.add( toReturn );\n+        }\n+    }\n+}",
                "additions": 155,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityLoadFilter.java",
                "status": "added",
                "changes": 155,
                "deletions": 0,
                "sha": "d598a2e25b48464c3b3f4a69a1ef72e9aeb61552",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityLoadFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityLoadFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/EntityLoadFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -21,8 +21,9 @@\n \n \n import org.apache.usergrid.corepersistence.pipeline.cursor.CursorSerializer;\n-import org.apache.usergrid.corepersistence.pipeline.read.AbstractSeekingFilter;\n+import org.apache.usergrid.corepersistence.pipeline.read.AbstractPathFilter;\n import org.apache.usergrid.corepersistence.pipeline.read.Filter;\n+import org.apache.usergrid.corepersistence.pipeline.read.FilterResult;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.GraphManager;\n import org.apache.usergrid.persistence.graph.GraphManagerFactory;\n@@ -42,7 +43,7 @@\n /**\n  * Command for reading graph edges on a connection\n  */\n-public class ReadGraphConnectionByTypeFilter extends AbstractSeekingFilter<Id, Id, Edge> implements Filter<Id, Id> {\n+public class ReadGraphConnectionByTypeFilter extends AbstractPathFilter<Id, Id, Edge> implements Filter<Id, Id> {\n \n     private final GraphManagerFactory graphManagerFactory;\n     private final String connectionName;\n@@ -61,8 +62,9 @@ public ReadGraphConnectionByTypeFilter( final GraphManagerFactory graphManagerFa\n     }\n \n \n+\n     @Override\n-    public Observable<Id> call( final Observable<Id> observable ) {\n+    public Observable<FilterResult<Id>> call( final Observable<FilterResult<Id>> filterResultObservable ) {\n \n         //get the graph manager\n         final GraphManager graphManager = graphManagerFactory.createEdgeManager( pipelineContext.getApplicationScope() );\n@@ -73,20 +75,18 @@ public ReadGraphConnectionByTypeFilter( final GraphManagerFactory graphManagerFa\n \n \n         //return all ids that are emitted from this edge\n-        return observable.flatMap( id -> {\n+        return filterResultObservable.flatMap( idFilterResult -> {\n \n               //set our our constant state\n             final Optional<Edge> startFromCursor = getSeekValue();\n+            final Id id = idFilterResult.getValue();\n \n             final SimpleSearchByIdType search =\n                 new SimpleSearchByIdType( id, edgeName, Long.MAX_VALUE, SearchByEdgeType.Order.DESCENDING,\n                     entityType, startFromCursor );\n \n-            /**\n-             * TODO, pass a message with pointers to our cursor values to be generated later\n-             */\n-            return graphManager.loadEdgesFromSourceByType( search ).doOnNext( edge -> setCursor( edge ) ).map(\n-                edge -> edge.getTargetNode() );\n+            return graphManager.loadEdgesFromSourceByType( search ).map(\n+                edge -> createFilterResult( edge.getTargetNode(), edge, idFilterResult.getPath() ));\n         } );\n     }\n \n@@ -95,4 +95,6 @@ public ReadGraphConnectionByTypeFilter( final GraphManagerFactory graphManagerFa\n     protected CursorSerializer<Edge> getCursorSerializer() {\n         return EdgeCursorSerializer.INSTANCE;\n     }\n+\n+\n }",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/ReadGraphConnectionByTypeFilter.java",
                "status": "modified",
                "changes": 20,
                "deletions": 9,
                "sha": "737157932236062e5284b492412b910f5e45755d",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/ReadGraphConnectionByTypeFilter.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/ReadGraphConnectionByTypeFilter.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/pipeline/read/graph/ReadGraphConnectionByTypeFilter.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -26,12 +26,10 @@\n import java.util.Map;\n import java.util.NoSuchElementException;\n \n-import org.apache.usergrid.corepersistence.pipeline.PipelineResult;\n import org.apache.usergrid.corepersistence.pipeline.read.ResultsPage;\n import org.apache.usergrid.corepersistence.util.CpEntityMapUtils;\n import org.apache.usergrid.persistence.EntityFactory;\n import org.apache.usergrid.persistence.Results;\n-import org.apache.usergrid.persistence.collection.MvccEntity;\n import org.apache.usergrid.persistence.model.entity.Entity;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n@@ -51,13 +49,17 @@\n     public Iterator<Results> iterator;\n \n \n-    public ObservableQueryExecutor( final Observable<PipelineResult<ResultsPage>> resultsObservable ) {\n+    public ObservableQueryExecutor( final Observable<ResultsPage> resultsObservable) {\n        //map to our old results objects, return a default empty if required\n         this.resultsObservable = resultsObservable.map( resultsPage -> createResults( resultsPage ) ).defaultIfEmpty( new Results() );\n     }\n \n \n-\n+    /**\n+     *\n+     * @param cpEntity\n+     * @return\n+     */\n     private org.apache.usergrid.persistence.Entity mapEntity( final Entity cpEntity ) {\n \n \n@@ -72,9 +74,8 @@ public ObservableQueryExecutor( final Observable<PipelineResult<ResultsPage>> re\n         return entity;\n     }\n \n-    private Results createResults( final PipelineResult<ResultsPage> pipelineResults ){\n+    private Results createResults( final ResultsPage resultsPage ){\n \n-        final ResultsPage resultsPage = pipelineResults.getResult();\n         final List<Entity> entityList = resultsPage.getEntityList();\n         final List<org.apache.usergrid.persistence.Entity> resultsEntities = new ArrayList<>( entityList.size() );\n \n@@ -85,10 +86,15 @@ private Results createResults( final PipelineResult<ResultsPage> pipelineResults\n \n         final Results results = Results.fromEntities( resultsEntities );\n \n-        if(pipelineResults.getCursor().isPresent()) {\n-            results.setCursor( pipelineResults.getCursor().get() );\n-        }\n \n+        //add the cursor if our limit is the same\n+        if(resultsPage.hasMoreResults()) {\n+            final Optional<String> cursor = resultsPage.getResponseCursor().encodeAsString();\n+\n+            if ( cursor.isPresent() ) {\n+                results.setCursor( cursor.get() );\n+            }\n+        }\n         return results;\n \n ",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/results/ObservableQueryExecutor.java",
                "status": "modified",
                "changes": 24,
                "deletions": 9,
                "sha": "0260d1d44f2e8449fc13b87c6f7f0b3c3084f60c",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/corepersistence/results/ObservableQueryExecutor.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/results/ObservableQueryExecutor.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/results/ObservableQueryExecutor.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -1293,7 +1293,7 @@ public void setQueryExecutor(final QueryExecutor queryExecutor){\n     /** uses cursor to get next batch of Results (returns null if no cursor) */\n     public Results getNextPageResults() throws Exception {\n         if ( queryExecutor == null || !queryExecutor.hasNext() ) {\n-            return null;\n+            return new Results();\n         }\n \n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/persistence/Results.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "fa221f5ed13645d6813696b03e75eb394566b970",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/main/java/org/apache/usergrid/persistence/Results.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/Results.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/Results.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -24,11 +24,11 @@\n \n import org.junit.Test;\n \n+import org.apache.usergrid.corepersistence.pipeline.read.EdgePath;\n import org.apache.usergrid.corepersistence.pipeline.read.elasticsearch.ElasticsearchCursorSerializer;\n import org.apache.usergrid.corepersistence.pipeline.read.graph.EdgeCursorSerializer;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.impl.SimpleEdge;\n-import org.apache.usergrid.persistence.graph.impl.SimpleMarkedEdge;\n \n import com.google.common.base.Optional;\n \n@@ -41,7 +41,10 @@\n     @Test\n     public void testCursors(){\n \n-        ResponseCursor responseCursor = new ResponseCursor();\n+\n+\n+\n+\n \n \n         //test encoding edge\n@@ -58,13 +61,18 @@ public void testCursors(){\n         final Integer query2 = 20;\n \n \n-        responseCursor.setCursor( 0, edge1, EdgeCursorSerializer.INSTANCE );\n \n-        responseCursor.setCursor( 1, query1, ElasticsearchCursorSerializer.INSTANCE );\n+        final EdgePath<Integer> filter3Path = new EdgePath<>( 3, query2, ElasticsearchCursorSerializer.INSTANCE, Optional.absent() );\n+\n+        final EdgePath<Edge> filter2Path = new EdgePath<Edge>(2, edge2, EdgeCursorSerializer.INSTANCE, Optional.of( filter3Path ));\n+\n+        final EdgePath<Integer> filter1Path = new EdgePath<>( 1, query1, ElasticsearchCursorSerializer.INSTANCE, Optional.of(filter2Path) );\n+\n+        final EdgePath<Edge> filter0Path = new EdgePath<>( 0, edge1, EdgeCursorSerializer.INSTANCE, Optional.of( filter1Path ) );\n+\n \n-        responseCursor.setCursor(2, edge2, EdgeCursorSerializer.INSTANCE);\n \n-        responseCursor.setCursor(3, query2, ElasticsearchCursorSerializer.INSTANCE);\n+        ResponseCursor responseCursor = new ResponseCursor( Optional.of(filter0Path) );\n \n         final Optional<String> cursor = responseCursor.encodeAsString();\n ",
                "additions": 14,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/test/java/org/apache/usergrid/corepersistence/pipeline/cursor/CursorTest.java",
                "status": "modified",
                "changes": 20,
                "deletions": 6,
                "sha": "fd65ebfc82f7f88900761c55448f88485cc2fdc3",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/core/src/test/java/org/apache/usergrid/corepersistence/pipeline/cursor/CursorTest.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/corepersistence/pipeline/cursor/CursorTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/corepersistence/pipeline/cursor/CursorTest.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -42,14 +42,10 @@\n \n     private final List<CandidateResult> candidates;\n     private final Collection<SelectFieldMapping> getFieldMappings;\n-    private final SearchEdge searchEdge;\n \n-\n-    public CandidateResults( List<CandidateResult> candidates, final Collection<SelectFieldMapping> getFieldMappings,\n-                             final SearchEdge searchEdge ) {\n+    public CandidateResults( List<CandidateResult> candidates, final Collection<SelectFieldMapping> getFieldMappings) {\n         this.candidates = candidates;\n         this.getFieldMappings = getFieldMappings;\n-        this.searchEdge = searchEdge;\n         offset = Optional.absent();\n     }\n \n@@ -91,11 +87,6 @@ public boolean isEmpty() {\n     }\n \n \n-    public SearchEdge getSearchEdge() {\n-        return searchEdge;\n-    }\n-\n-\n     /**\n      * Get the candidates\n      * @return",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/CandidateResults.java",
                "status": "modified",
                "changes": 11,
                "deletions": 10,
                "sha": "a157e473c6c1f684bdf7bdf98fe31cf96ce79ea3",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/CandidateResults.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/CandidateResults.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/CandidateResults.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -169,7 +169,7 @@ public CandidateResults search( final SearchEdge searchEdge, final SearchTypes s\n         }\n         failureMonitor.success();\n \n-        return parseResults(searchResponse, parsedQuery, searchEdge, limit, offset);\n+        return parseResults(searchResponse, parsedQuery, limit, offset);\n     }\n \n \n@@ -227,7 +227,7 @@ private void checkDeleteByQueryResponse( final QueryBuilder query, final DeleteB\n     /**\n      * Parse the results and return the canddiate results\n      */\n-    private CandidateResults parseResults( final SearchResponse searchResponse, final ParsedQuery query, final SearchEdge searchEdge,\n+    private CandidateResults parseResults( final SearchResponse searchResponse, final ParsedQuery query,\n                                            final int limit, final int from ) {\n \n         final SearchHits searchHits = searchResponse.getHits();\n@@ -244,8 +244,7 @@ private CandidateResults parseResults( final SearchResponse searchResponse, fina\n             candidates.add( candidateResult );\n         }\n \n-        final CandidateResults candidateResults = new CandidateResults( candidates, query.getSelectFieldMappings(),\n-            searchEdge );\n+        final CandidateResults candidateResults = new CandidateResults( candidates, query.getSelectFieldMappings());\n \n         // >= seems odd.  However if we get an overflow, we need to account for it.\n         if (  hits.length >= limit ) {",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsApplicationEntityIndexImpl.java",
                "status": "modified",
                "changes": 7,
                "deletions": 4,
                "sha": "5b670602a3440dad83af350465adce0d739469c7",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsApplicationEntityIndexImpl.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsApplicationEntityIndexImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsApplicationEntityIndexImpl.java?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            },
            {
                "patch": "@@ -73,6 +73,9 @@\n                     },\n                     \"string\": {\n                         \"type\": \"string\",\n+                        \"norms\": {\n+                            \"enabled\": false\n+                        },\n                         \"fields\": {\n                             \"exact\": {\n                                 \"type\": \"string\",",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/corepersistence/queryindex/src/main/resources/org/apache/usergrid/persistence/index/usergrid-mappings.json",
                "status": "modified",
                "changes": 3,
                "deletions": 0,
                "sha": "c22a4ecd92a0ffbe9d7828eb28f9d7b979e4983f",
                "blob_url": "https://github.com/apache/usergrid/blob/7b215250afce3303af6a26ecf4ec8918840e37e0/stack/corepersistence/queryindex/src/main/resources/org/apache/usergrid/persistence/index/usergrid-mappings.json",
                "filename": "stack/corepersistence/queryindex/src/main/resources/org/apache/usergrid/persistence/index/usergrid-mappings.json",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/resources/org/apache/usergrid/persistence/index/usergrid-mappings.json?ref=7b215250afce3303af6a26ecf4ec8918840e37e0"
            }
        ],
        "bug_id": "usergrid_51",
        "parent": "https://github.com/apache/usergrid/commit/c6bbfba989b806b106fe6b2e4f1744123c30c760",
        "message": "Merge branch 'two-dot-o-dev' of https://git-wip-us.apache.org/repos/asf/incubator-usergrid into USERGRID-609\n\n# By Todd Nine\n# Via Todd Nine\n* 'two-dot-o-dev' of https://git-wip-us.apache.org/repos/asf/incubator-usergrid:\n  Updates observable short circuit and fixes NPE on empty results\n  Fixes graph cursor resume state.\n  Fixes resume logic by loading then filtering first id\n  Massive refactor.  Paths for cursor generation are now part of our I/O results. This allows the collector to take until satisfied, then generate a serializable path.\n  Updated mapping to fix missing doc_values and disable norms  since we use external sorting",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/e4beaead1026f280ea65b363c40f48e22be65a2b",
        "file": [
            {
                "patch": "@@ -455,12 +455,20 @@ usergrid.scheduler.job.queueName=/jobs\n \n # Set the number of queue consumers to read from the in-region push notification queue.\n #\n-usergrid.push.worker_count=8\n+usergrid.push.worker_count=2\n \n # Set the sleep time between queue polling ( in milliseconds)\n #\n usergrid.push.sleep=100\n \n+# This setting determines the inmemory cache TTL (in minutes) for push notifications queue managers.\n+#\n+usergrid.push.queuemanager.cache.time-to-live=10\n+\n+# This setting determines the inmemory cache size (# elements) for push notifications queue managers.\n+#\n+usergrid.push.queuemanager.cache.size=200\n+\n \n \n ###############################  Usergrid Central SSO  #############################",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/config/src/main/resources/usergrid-default.properties",
                "status": "modified",
                "changes": 10,
                "deletions": 1,
                "sha": "4f57cdd49666c751b72037d5268fd7279a820e92",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/config/src/main/resources/usergrid-default.properties",
                "filename": "stack/config/src/main/resources/usergrid-default.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/config/src/main/resources/usergrid-default.properties?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -27,6 +27,7 @@\n import org.apache.usergrid.persistence.Schema;\n import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n import org.apache.usergrid.persistence.core.scope.ApplicationScopeImpl;\n+import org.apache.usergrid.persistence.exceptions.PersistenceException;\n import org.apache.usergrid.persistence.model.entity.Id;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n import org.apache.usergrid.persistence.model.field.StringField;\n@@ -65,7 +66,11 @@ public ApplicationIdCacheImpl(\n             .build(new CacheLoader<String, UUID>() {\n                 @Override\n                 public UUID load(final String key) throws Exception {\n-                    return fetchApplicationId(key);\n+                    UUID appId = fetchApplicationId(key);\n+                    if ( appId == null ) {\n+                        throw new PersistenceException(\"Error getting applicationId\");\n+                    }\n+                    return appId;\n                 }\n             });\n     }\n@@ -76,7 +81,7 @@ public UUID getApplicationId( final String applicationName ) {\n             return appCache.get( applicationName.toLowerCase() );\n         } catch (Exception e) {\n             if (logger.isDebugEnabled()) {\n-                logger.debug(\"Returning for key {} value null\", applicationName);\n+                logger.debug(\"Returning for key {} value null due to exception: {}\", applicationName, e);\n             }\n             return null;\n         }",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/ApplicationIdCacheImpl.java",
                "status": "modified",
                "changes": 9,
                "deletions": 2,
                "sha": "d327607a3f421846fe1338bc31bb722735c1e7db",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/ApplicationIdCacheImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/ApplicationIdCacheImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/ApplicationIdCacheImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -651,15 +651,15 @@ private boolean skipIndexingForType( String type ) {\n      */\n     @Override\n     public void delete( EntityRef entityRef ) throws Exception {\n-        //TODO: since we want the user to mark it and we sweep it later. It should be marked by the graph manager here.\n         //Step 1 & 2 Currently to block so we ensure that marking is done immediately\n         //If this returns null then nothing was marked null so the entity doesn't exist\n         markEntity( entityRef ).toBlocking().lastOrDefault( null );\n \n-        //TODO: figure out how to return async call to service tier? Do I not need to?\n         //Step 3\n         deleteAsync( entityRef );\n \n+        decrementEntityCollection( Schema.defaultCollectionName( entityRef.getType() ));\n+\n     }\n \n ",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "68f5d71a6c7b2b25c1370e3e60224bcbf6754972",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -33,7 +33,7 @@\n     int getCacheSize();\n \n     @Key( \"usergrid.index_schema_cache_timeout_ms\" )\n-    @Default( \"60000\" )\n+    @Default( \"15000\" )\n     int getCacheTimeout();\n \n }",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheFig.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "a99b48e0aacce10485adfad427acb33835e5f844",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheFig.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheFig.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheFig.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -19,6 +19,7 @@\n \n \n import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -49,7 +50,7 @@ public IndexSchemaCacheImpl(MapManager mapManager,IndexSchemaCacheFig indexSchem\n         this.mapManager = mapManager;\n         indexSchemaCache = CacheBuilder.newBuilder()\n             .maximumSize( indexSchemaCacheFig.getCacheSize() )\n-            //.expireAfterWrite( indexSchemaCacheFig.getCacheTimeout(), TimeUnit.MILLISECONDS ) <-- I don't think we want this to expire that quickly.\n+            .expireAfterWrite( indexSchemaCacheFig.getCacheTimeout(), TimeUnit.MILLISECONDS )\n             .build( new CacheLoader<String, Optional<Map>>() {\n                 @Override\n                 public Optional<Map> load( final String collectionName ) throws Exception {",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheImpl.java",
                "status": "modified",
                "changes": 3,
                "deletions": 1,
                "sha": "d4bade4551e319e218258aeb01df5a7a0a266b03",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexSchemaCacheImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -226,6 +226,7 @@ public IndexServiceImpl( final GraphManagerFactory graphManagerFactory, final En\n                 return Optional.absent();\n             }\n \n+            // never add \"none\" because it has special meaning, \"none\" disables indexing for a type\n             fieldsToKeep.remove(\"none\");\n \n             defaultProperties.addAll( fieldsToKeep );",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexServiceImpl.java",
                "status": "modified",
                "changes": 1,
                "deletions": 0,
                "sha": "950962623f7d8297b23855a4a6d5a1b33d8991f8",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexServiceImpl.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/index/IndexServiceImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -17,6 +17,7 @@\n package org.apache.usergrid.utils;\n \n \n+import java.text.DecimalFormat;\n import java.util.Arrays;\n \n import org.apache.commons.io.IOUtils;\n@@ -169,4 +170,11 @@ public static String readClasspathFileAsString( String filePath ) {\n         }\n         return null;\n     }\n+\n+    public static String readableByteSize(long size) {\n+        if(size <= 0) return \"0\";\n+        final String[] units = new String[] { \"B\", \"kB\", \"MB\", \"GB\", \"TB\" };\n+        int digitGroups = (int) (Math.log10(size)/Math.log10(1024));\n+        return new DecimalFormat(\"#,##0.#\").format(size/Math.pow(1024, digitGroups)) + \" \" + units[digitGroups];\n+    }\n }",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/utils/StringUtils.java",
                "status": "modified",
                "changes": 8,
                "deletions": 0,
                "sha": "6bb44d8969fcf8cbdb7860e0826c57ecf31aa72e",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/java/org/apache/usergrid/utils/StringUtils.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/utils/StringUtils.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/utils/StringUtils.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -60,9 +60,15 @@\n         <property name=\"loadBalancingPolicy\" ref=\"loadBalancingPolicy\"/>\n \t</bean>\n \n+    <util:map id=\"cassandraCredentials\" map-class=\"java.util.HashMap\">\n+        <entry key=\"username\" value=\"${cassandra.username}\" />\n+        <entry key=\"password\" value=\"${cassandra.password}\" />\n+    </util:map>\n+\n \t<bean id=\"cassandraCluster\" class=\"me.prettyprint.cassandra.service.ThriftCluster\">\n \t\t<constructor-arg value=\"${cassandra.cluster}\" />\n \t\t<constructor-arg ref=\"cassandraHostConfigurator\" />\n+        <constructor-arg ref=\"cassandraCredentials\" />\n \t</bean>\n \n     <bean id=\"loadBalancingPolicy\" class=\"me.prettyprint.cassandra.connection.DynamicLoadBalancingPolicy\"/>",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/resources/usergrid-core-context.xml",
                "status": "modified",
                "changes": 6,
                "deletions": 0,
                "sha": "ea1cdf6aa4973194670d5b51b22300a040132f0d",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/core/src/main/resources/usergrid-core-context.xml",
                "filename": "stack/core/src/main/resources/usergrid-core-context.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/resources/usergrid-core-context.xml?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -94,7 +94,6 @@ public NodeShardAllocationImpl( final EdgeShardSerialization edgeShardSerializat\n \n         else {\n             existingShards = edgeShardSerialization.getShardMetaData( scope, maxShardId, directedEdgeMeta );\n-            //logger.info(\"existing shards has something: {}\", existingShards.hasNext());\n \n             /**\n              * We didn't get anything out of cassandra, so we need to create the minimum shard\n@@ -113,8 +112,6 @@ public NodeShardAllocationImpl( final EdgeShardSerialization edgeShardSerializat\n             }\n         }\n \n-        //logger.info(\"getShards existing shards: {}\", existingShards);\n-\n         return new ShardEntryGroupIterator( existingShards, graphFig.getShardMinDelta(), shardGroupCompaction, scope,\n             directedEdgeMeta );\n     }\n@@ -240,7 +237,9 @@ public boolean auditShard( final ApplicationScope scope, final ShardEntryGroup s\n \n         final Shard newShard = new Shard( marked.getTimestamp(), createTimestamp, false );\n \n-        logger.info( \"Allocating new shard {} for edge meta {}\", newShard, directedEdgeMeta );\n+        if(logger.isTraceEnabled()) {\n+            logger.trace(\"Allocating new shard {} for edge meta {}\", newShard, directedEdgeMeta);\n+        }\n \n         final MutationBatch batch = this.edgeShardSerialization.writeShardMeta( scope, newShard, directedEdgeMeta );\n ",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardAllocationImpl.java",
                "status": "modified",
                "changes": 7,
                "deletions": 4,
                "sha": "47b630f6cf40e3ef8efc57c6d8976c6ddd8cc186",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardAllocationImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardAllocationImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardAllocationImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -303,9 +303,6 @@ public CompactionResult compact( final ApplicationScope scope, final DirectedEdg\n             logger.trace(\"Finished compacting {} shards and moved {} edges\", sourceShards, totalEdgeCount);\n         }\n \n-        logger.info(\"Finished compacting {} shards and moved {} edges\", sourceShards, totalEdgeCount);\n-\n-\n         resultBuilder.withCopiedEdges( totalEdgeCount ).withSourceShards( sourceShards ).withTargetShard( targetShard );\n \n         /**\n@@ -351,8 +348,9 @@ public CompactionResult compact( final ApplicationScope scope, final DirectedEdg\n             Shard compactedShard = new Shard( targetShard.getShardIndex(), timeService.getCurrentTime(), true );\n             compactedShard.setShardEnd(targetShard.getShardEnd());\n \n-            logger.info( \"Shard has been fully compacted.  Marking shard {} as compacted in Cassandra\", compactedShard );\n-\n+            if(logger.isTraceEnabled()) {\n+                logger.trace(\"Shard has been fully compacted.  Marking shard {} as compacted in Cassandra\", compactedShard);\n+            }\n \n             final MutationBatch updateMark = edgeShardSerialization.writeShardMeta( scope, compactedShard, edgeMeta );\n             try {\n@@ -402,7 +400,7 @@ public CompactionResult compact( final ApplicationScope scope, final DirectedEdg\n         }\n         catch ( RejectedExecutionException ree ) {\n \n-            //ignore, if this happens we don't care, we're saturated, we can check later\n+            // ignore, if this happens we don't care, we're saturated, we can check later\n             logger.info( \"Rejected audit for shard of scope {} edge, meta {} and group {}\", scope, edgeMeta, group );\n \n             return Futures.immediateFuture( AuditResult.NOT_CHECKED );\n@@ -503,8 +501,10 @@ public AuditResult call() throws Exception {\n                  */\n                 try {\n                     CompactionResult result = compact( scope, edgeMeta, group );\n-                    logger.info( \"Compaction result for compaction of scope {} with edge meta data of {} and shard group {} is {}\",\n-                            scope, edgeMeta, group, result );\n+                    if(logger.isTraceEnabled()) {\n+                        logger.trace(\"Compaction result for compaction of scope {} with edge meta data of {} and shard group {} is {}\",\n+                            scope, edgeMeta, group, result);\n+                    }\n                 }\n                 finally {\n                     shardCompactionTaskTracker.complete( scope, edgeMeta, group );\n@@ -535,8 +535,6 @@ public boolean canStartTask( final ApplicationScope scope, final DirectedEdgeMet\n                                      ShardEntryGroup group ) {\n             final Long hash = doHash( scope, edgeMeta, group ).hash().asLong();\n             final Boolean returned = runningTasks.putIfAbsent( hash, TRUE );\n-            //logger.info(\"hash components are app: {}, edgeMeta: {}, group: {}\", scope.getApplication(), edgeMeta, group);\n-            //logger.info(\"checking hash value of: {}, already started: {}\", hash, returned );\n \n             /**\n              * Someone already put the value",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/ShardGroupCompactionImpl.java",
                "status": "modified",
                "changes": 18,
                "deletions": 10,
                "sha": "0853adb43d8544ea8f0406faf53f85e632385911",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/ShardGroupCompactionImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/ShardGroupCompactionImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/ShardGroupCompactionImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -88,11 +88,11 @@\n     int getLocalQuorumTimeout();\n \n     @Key( \"usergrid.queue.client.connection.timeout\")\n-    @Default( \"1000\" ) // 1 second\n+    @Default( \"5000\" ) // 5 seconds\n     int getQueueClientConnectionTimeout();\n \n     @Key( \"usergrid.queue.client.socket.timeout\")\n-    @Default( \"10000\" ) // 10 seconds\n+    @Default( \"20000\" ) // 20 seconds\n     int getQueueClientSocketTimeout();\n \n     @Key( \"usergrid.queue.poll.timeshift\")",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/QueueFig.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "6265a33100d55beab83cdb9d7c6ce656d87830f5",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/QueueFig.java",
                "filename": "stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/QueueFig.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/QueueFig.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -1,21 +1,18 @@\n /*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n  *\n- *  * Licensed to the Apache Software Foundation (ASF) under one or more\n- *  *  contributor license agreements.  The ASF licenses this file to You\n- *  * under the Apache License, Version 2.0 (the \"License\"); you may not\n- *  * use this file except in compliance with the License.\n- *  * You may obtain a copy of the License at\n- *  *\n- *  *     http://www.apache.org/licenses/LICENSE-2.0\n- *  *\n- *  * Unless required by applicable law or agreed to in writing, software\n- *  * distributed under the License is distributed on an \"AS IS\" BASIS,\n- *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- *  * See the License for the specific language governing permissions and\n- *  * limitations under the License.  For additional information regarding\n- *  * copyright in this work, please see the NOTICE file in the top level\n- *  * directory of this distribution.\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n  *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n  */\n package org.apache.usergrid.persistence.queue.impl;\n ",
                "additions": 12,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/QueueManagerFactoryImpl.java",
                "status": "modified",
                "changes": 27,
                "deletions": 15,
                "sha": "93b2fb22e6da13542ef1c67a15077bf0b9229576",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/QueueManagerFactoryImpl.java",
                "filename": "stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/QueueManagerFactoryImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queue/src/main/java/org/apache/usergrid/persistence/queue/impl/QueueManagerFactoryImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -248,6 +248,31 @@ public ApiResponse getQueueDepth(){\n \n     }\n \n+    @GET\n+    @Path(\"/status/heap\")\n+    @JSONP\n+    @Produces({MediaType.APPLICATION_JSON, \"application/javascript\"})\n+    public ApiResponse getHeapStats(){\n+\n+        ApiResponse response = createApiResponse();\n+\n+        ObjectNode node = JsonNodeFactory.instance.objectNode();\n+\n+        long heapAllocatedSize = Runtime.getRuntime().totalMemory();\n+        long heapMaxSize = Runtime.getRuntime().maxMemory();\n+        long heapFreeSize = Runtime.getRuntime().freeMemory();\n+        long heapUsedSize = heapAllocatedSize - heapFreeSize;\n+\n+        node.put( \"used\", org.apache.usergrid.utils.StringUtils.readableByteSize(heapUsedSize) );\n+        node.put( \"free\", org.apache.usergrid.utils.StringUtils.readableByteSize(heapFreeSize) );\n+        node.put( \"allocated\", org.apache.usergrid.utils.StringUtils.readableByteSize(heapAllocatedSize) );\n+        node.put( \"max\", org.apache.usergrid.utils.StringUtils.readableByteSize(heapMaxSize) );\n+\n+        response.setProperty( \"status\", node );\n+        return response;\n+\n+    }\n+\n \n \n     private void dumpMetrics( ObjectNode node ) {",
                "additions": 25,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/main/java/org/apache/usergrid/rest/RootResource.java",
                "status": "modified",
                "changes": 25,
                "deletions": 0,
                "sha": "b8abe54e3f757cca8d30b3f3aa3cf3b44c020a75",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/main/java/org/apache/usergrid/rest/RootResource.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/RootResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/RootResource.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -91,7 +91,7 @@ public CollectionResource() {\n      * @throws Exception\n      */\n     @POST\n-    @Path( \"{itemName}/_indexes\" )\n+    @Path( \"{itemName}/_index\" )\n     @Produces({ MediaType.APPLICATION_JSON,\"application/javascript\"})\n     @RequireApplicationAccess\n     @JSONP\n@@ -153,7 +153,7 @@ private void addItemToServiceContext( final @Context UriInfo ui,\n     }\n \n     @DELETE\n-    @Path( \"{itemName}/_indexes\" )\n+    @Path( \"{itemName}/_index\" )\n     @Produces({ MediaType.APPLICATION_JSON,\"application/javascript\"})\n     @RequireApplicationAccess\n     @JSONP\n@@ -222,10 +222,6 @@ public ApiResponse executePostForReindexing( @Context UriInfo ui, String body,\n \n         addItemToServiceContext( ui, itemName );\n \n-//        final ReIndexRequestBuilder request =\n-//            createRequest().withApplicationId( services.getApplicationId() ).withCollection(\n-//                String.valueOf( getServiceParameters().get( 0 ) ) ).withDelay( 50, TimeUnit.MILLISECONDS );\n-//\n         IndexResource indexResource = new IndexResource(injector);\n         return indexResource.rebuildIndexesPost( services.getApplicationId().toString(),itemName.getPath(),false,callback );\n     }",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/main/java/org/apache/usergrid/rest/applications/CollectionResource.java",
                "status": "modified",
                "changes": 8,
                "deletions": 6,
                "sha": "1e9483251c5f298baab21eef46789ef6048ef092",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/main/java/org/apache/usergrid/rest/applications/CollectionResource.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/applications/CollectionResource.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/applications/CollectionResource.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -78,6 +78,17 @@ public void printReport() {\n \n     @Test\n     public void testPaging() throws Exception {\n+\n+        // this test should work even with indexing turned off for notificaitons collection\n+        ArrayList<String> indexingArray = new ArrayList<>(  );\n+        indexingArray.add( \"none\" );\n+        Entity payload = new Entity();\n+        payload.put( \"fields\", indexingArray);\n+\n+        String unIndexedCollectionName = \"notifications\";\n+        app().collection( unIndexedCollectionName ).collection( \"_indexes\" ).post( payload );\n+        refreshIndex();\n+\n         // create notifier\n         Entity notifier = new Entity().chainPut(\"name\", \"mynotifier\").chainPut(\"provider\", \"noop\");\n ",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/test/java/org/apache/usergrid/rest/NotificationsIT.java",
                "status": "modified",
                "changes": 11,
                "deletions": 0,
                "sha": "1655846e624e47f76a7e49d214826f6490851e4b",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/test/java/org/apache/usergrid/rest/NotificationsIT.java",
                "filename": "stack/rest/src/test/java/org/apache/usergrid/rest/NotificationsIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/java/org/apache/usergrid/rest/NotificationsIT.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -136,7 +136,7 @@ public void postToCollectionSchemaUsingOrgAppCreds(){\n \n         try {\n \n-            this.pathResource( getOrgAppPath( \"testcollections/_indexes\" ) ).post( false, payload,\n+            this.pathResource( getOrgAppPath( \"testcollections/_index\" ) ).post( false, payload,\n                 new QueryParameters().addParam( \"grant_type\", \"client_credentials\" ).addParam( \"client_id\",\n                     String.valueOf( ( ( Map ) appCredentials.get( \"credentials\" ) ).get( \"client_id\" ) ) )\n                                      .addParam( \"client_secret\", String.valueOf(\n@@ -167,7 +167,7 @@ public void deleteCollectionSchema() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        Entity thing = this.app().collection( \"testCollections\" ).collection( \"_indexes\" ).post( payload );\n+        Entity thing = this.app().collection( \"testCollections\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n \n@@ -206,10 +206,11 @@ public void deleteCollectionSchema() throws Exception {\n         //to prove that the entity exists\n \n         //next part is to delete the schema then reindex it and it should work.\n-        this.app().collection( \"testCollections\" ).collection( \"_indexes\" ).delete();\n+        this.app().collection( \"testCollections\" ).collection( \"_index\" ).delete();\n         refreshIndex();\n \n-        this.app().collection( \"testCollections\" ).collection( \"_reindex\" ).post(true,clientSetup.getSuperuserToken(),ApiResponse.class,null,null,false);\n+        this.app().collection( \"testCollections\" ).collection( \"_reindex\" )\n+            .post(true,clientSetup.getSuperuserToken(),ApiResponse.class,null,null,false);\n         refreshIndex();\n \n \n@@ -244,7 +245,7 @@ public void verifyThatFieldsIsRequiredForCollectionSchema() throws Exception {\n \n         //Post index to the collection metadata\n         try {\n-            this.app().collection( \"testCollections\" ).collection( \"_indexes\" ).post( payload );\n+            this.app().collection( \"testCollections\" ).collection( \"_index\" ).post( payload );\n             fail();\n         }catch(BadRequestException bre){\n             //this is expected.\n@@ -258,7 +259,7 @@ public void verifyThatFieldsIsRequiredForCollectionSchema() throws Exception {\n         payload.put( \"fields\", indexingMap);\n \n         try {\n-            this.app().collection( \"testCollections\" ).collection( \"_indexes\" ).post( payload );\n+            this.app().collection( \"testCollections\" ).collection( \"_index\" ).post( payload );\n             fail();\n         }catch(BadRequestException bre){\n             //this is expected.\n@@ -268,7 +269,7 @@ public void verifyThatFieldsIsRequiredForCollectionSchema() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         try {\n-            this.app().collection( \"testCollections\" ).collection( \"_indexes\" ).post( payload );\n+            this.app().collection( \"testCollections\" ).collection( \"_index\" ).post( payload );\n         }catch(BadRequestException bre){\n             fail( \"This shouldn't fail\" );\n         }\n@@ -291,7 +292,7 @@ public void postCollectionSchemaWithWildcardIndexAll() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        Entity thing = this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        Entity thing = this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n \n@@ -365,12 +366,13 @@ public void postToCollectionSchemaUpdateExistingCollection() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        Entity thing = this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        Entity thing = this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n \n         //Reindex and verify that the entity only has field one index.\n-        this.app().collection( \"testCollection\" ).collection( \"_reindex\" ).post(true,clientSetup.getSuperuserToken(),ApiResponse.class,null,null,false);\n+        this.app().collection( \"testCollection\" ).collection( \"_reindex\" )\n+            .post(true,clientSetup.getSuperuserToken(),ApiResponse.class,null,null,false);\n \n         for(int i = 0; i < 10; i++) {\n             String query = \"one ='value\"+ i + \"'\";\n@@ -415,7 +417,7 @@ public void postToCollectionSchemaAndVerifyFieldsAreUpdated() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        Entity thing = this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        Entity thing = this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         Collection collection = this.app().collection( \"testCollection\" ).collection( \"_index\" ).get();\n@@ -430,7 +432,8 @@ public void postToCollectionSchemaAndVerifyFieldsAreUpdated() throws Exception {\n \n \n         //Reindex and verify that the entity only has field one index.\n-        this.app().collection( \"testCollection\" ).collection( \"_reindex\" ).post(true,clientSetup.getSuperuserToken(),ApiResponse.class,null,null,false);\n+        this.app().collection( \"testCollection\" ).collection( \"_reindex\" )\n+            .post(true,clientSetup.getSuperuserToken(),ApiResponse.class,null,null,false);\n \n \n         indexingArray.add( \"one\" );\n@@ -442,7 +445,7 @@ public void postToCollectionSchemaAndVerifyFieldsAreUpdated() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n \n         collection = this.app().collection( \"testCollection\" ).collection( \"_index\" ).get();\n \n@@ -494,7 +497,7 @@ public void postToCollectionSchemaWithSchemaFirst() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         //Create test collection with a test entity that is partially indexed.\n@@ -536,7 +539,7 @@ public void postToCollectionArraySchemaWithSchemaFirst() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         Map<String,Object> arrayFieldsForTesting = new HashMap<>();\n@@ -586,7 +589,7 @@ public void postToCollectionSchemaArrayWithTopLevelIndexing() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         Map<String,Object> arrayFieldsForTesting = new HashMap<>();\n@@ -629,7 +632,7 @@ public void postToCollectionSchemaArrayWithSelectiveTopLevelIndexing() throws Ex\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         Map<String,Object> arrayFieldsForTestingSelectiveIndexing = new HashMap<>();\n@@ -684,7 +687,7 @@ public void postToCollectionSchemaArrayWithSelectiveTopLevelIndexingAddingDefaul\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         Map<String,Object> arrayFieldsForTestingSelectiveIndexing = new HashMap<>();\n@@ -735,7 +738,7 @@ public void putToCollectionSchema() throws Exception {\n         payload.put( \"fields\", indexingArray);\n \n         //Post index to the collection metadata\n-        this.app().collection( \"testCollection\" ).collection( \"_indexes\" ).post( payload );\n+        this.app().collection( \"testCollection\" ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         //Create test collection with a test entity that is partially indexed.\n@@ -958,7 +961,7 @@ public void postCollectionSchemaWithWildcardIndexNone() throws Exception {\n \n         String randomizer = RandomStringUtils.randomAlphanumeric(10);\n         String collectionName = \"col_\" + randomizer;\n-        app().collection( collectionName ).collection( \"_indexes\" ).post( payload );\n+        app().collection( collectionName ).collection( \"_index\" ).post( payload );\n         refreshIndex();\n \n         // was the no-index wildcard saved and others ignored?\n@@ -989,4 +992,108 @@ public void postCollectionSchemaWithWildcardIndexNone() throws Exception {\n             .get( new QueryParameters().setQuery( \"select * where color='magenta'\" ) ).iterator();\n         assertFalse( getByQuery.hasNext() );\n     }\n+\n+\n+    /**\n+     * Test that indexed entities can be connected to un-indexed Entities and connections still work.\n+     */\n+    @Test\n+    public void testIndexedEntityToUnindexedEntityConnections() {\n+\n+        // create entities in an un-indexed collection\n+\n+        ArrayList<String> indexingArray = new ArrayList<>(  );\n+        indexingArray.add( \"!\" );\n+        Entity payload = new Entity();\n+        payload.put( \"fields\", indexingArray);\n+\n+        String randomizer = RandomStringUtils.randomAlphanumeric(10);\n+        String unIndexedCollectionName = \"col_\" + randomizer;\n+        app().collection( unIndexedCollectionName ).collection( \"_index\" ).post( payload );\n+        refreshIndex();\n+\n+        String entityName1 = \"unindexed1\";\n+        Entity unindexed1 = this.app().collection( unIndexedCollectionName )\n+            .post( new Entity().withProp(\"name\", entityName1).withProp( \"color\", \"violet\" ) );\n+\n+        String entityName2 = \"unindexed2\";\n+        Entity unindexed2 = this.app().collection( unIndexedCollectionName )\n+            .post( new Entity().withProp(\"name\", entityName2).withProp( \"color\", \"violet\" ) );\n+\n+        // create an indexed entity\n+\n+        String indexedCollection = \"col_\" + randomizer;\n+        String indexedEntityName = \"indexedEntity\";\n+        Entity indexedEntity = this.app().collection( indexedCollection )\n+            .post( new Entity().withProp(\"name\", indexedEntityName).withProp( \"color\", \"orange\" ) );\n+\n+        // create connections from indexed entity to un-indexed entities\n+\n+        app().collection(indexedCollection).entity(indexedEntity).connection(\"likes\").entity(unindexed1).post();\n+        app().collection(indexedCollection).entity(indexedEntity).connection(\"likes\").entity(unindexed2).post();\n+\n+        Collection connectionsByGraph = app().collection( indexedCollection )\n+            .entity(indexedEntity).connection( \"likes\" ).get();\n+        assertEquals( 2, connectionsByGraph.getNumOfEntities() );\n+\n+        Collection connectionsByQuery = app().collection( indexedCollection )\n+            .entity(indexedEntity).connection( \"likes\" )\n+            .get( new QueryParameters().setQuery( \"select * where color='violet'\" ));\n+        assertEquals( 0, connectionsByQuery.getNumOfEntities() );\n+\n+    }\n+\n+\n+    /**\n+     * Test that index entities can be connected to un-indexed Entities and connections still work.\n+     */\n+    @Test\n+    public void testUnindexedEntityToIndexedEntityConnections() {\n+\n+        // create two entities in an indexed collection\n+\n+        String randomizer = RandomStringUtils.randomAlphanumeric(10);\n+        String indexedCollection = \"col_\" + randomizer;\n+        String indexedEntityName = \"indexedEntity\";\n+\n+        Entity indexedEntity1 = this.app().collection( indexedCollection )\n+            .post( new Entity().withProp(\"name\", indexedEntityName + \"_1\").withProp( \"color\", \"orange\" ) );\n+\n+        Entity indexedEntity2 = this.app().collection( indexedCollection )\n+            .post( new Entity().withProp(\"name\", indexedEntityName + \"_2\").withProp( \"color\", \"orange\" ) );\n+\n+        // create an un-indexed entity\n+\n+        ArrayList<String> indexingArray = new ArrayList<>(  );\n+        indexingArray.add( \"!\" );\n+        Entity payload = new Entity();\n+        payload.put( \"fields\", indexingArray);\n+\n+        String unIndexedCollectionName = \"col_\" + randomizer;\n+        app().collection( unIndexedCollectionName ).collection( \"_index\" ).post( payload );\n+        refreshIndex();\n+\n+        String entityName1 = \"unindexed1\";\n+        Entity unindexed1 = this.app().collection( unIndexedCollectionName )\n+            .post( new Entity().withProp(\"name\", entityName1).withProp( \"color\", \"violet\" ) );\n+\n+        // create connections from un-indexed entity to indexed entities\n+\n+        app().collection(unIndexedCollectionName).entity(unindexed1).connection(\"likes\").entity(indexedEntity1).post();\n+        app().collection(unIndexedCollectionName).entity(unindexed1).connection(\"likes\").entity(indexedEntity2).post();\n+\n+        // should be able to get connections via graph from un-indexed to index\n+\n+        Collection connectionsByGraph = app().collection( indexedCollection )\n+            .entity(unindexed1).connection( \"likes\" ).get();\n+        assertEquals( 2, connectionsByGraph.getNumOfEntities() );\n+\n+        // should not be able to get connections via query from unindexed to indexed\n+\n+        Collection connectionsByQuery = app().collection( indexedCollection )\n+            .entity(unindexed1).connection( \"likes\" )\n+            .get( new QueryParameters().setQuery( \"select * where color='orange'\" ));\n+        assertEquals( 0, connectionsByQuery.getNumOfEntities() );\n+    }\n+\n }",
                "additions": 127,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/test/java/org/apache/usergrid/rest/applications/collection/CollectionsResourceIT.java",
                "status": "modified",
                "changes": 147,
                "deletions": 20,
                "sha": "db07c3fdc0493ed119000d794e90fadc8e9017d3",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/test/java/org/apache/usergrid/rest/applications/collection/CollectionsResourceIT.java",
                "filename": "stack/rest/src/test/java/org/apache/usergrid/rest/applications/collection/CollectionsResourceIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/java/org/apache/usergrid/rest/applications/collection/CollectionsResourceIT.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -27,6 +27,7 @@\n import org.apache.usergrid.rest.test.resource.AbstractRestIT;\n import org.apache.usergrid.rest.test.resource.model.ApiResponse;\n import org.apache.usergrid.rest.test.resource.model.Collection;\n+import org.apache.usergrid.rest.test.resource.model.Entity;\n import org.apache.usergrid.rest.test.resource.model.QueryParameters;\n \n import static org.junit.Assert.assertEquals;\n@@ -62,4 +63,51 @@ public void applicationrequestInternalCounters() throws Exception {\n         assertEquals( 2, ( ( LinkedHashMap ) ( ( ArrayList)counters.get( \"values\" )).get( 0 )).get( \"value\" ));\n \n     }\n+\n+    @Test\n+    public void testDecrementingEntityCounters() throws Exception {\n+\n+        //Create test collection with test entity that is full text indexed.\n+        int numberOfEntitiesToCreate = 10;\n+\n+        Entity[] entities = new Entity[numberOfEntitiesToCreate];\n+        Entity testEntity = new Entity();\n+        for(int i = 0; i < numberOfEntitiesToCreate; i++){\n+            testEntity.put( \"one\",\"value\"+i );\n+            testEntity.put( \"two\",\"valuetwo\"+i );\n+            entities[i]= this.app().collection( \"testCollection\" ).post( testEntity );\n+        }\n+\n+        //get default application\n+       // ApiResponse defaultApp = org().app( clientSetup.getAppName() ).get();\n+\n+        QueryParameters queryParameters = new QueryParameters();\n+        queryParameters.addParam( \"resolution\", \"all\" ).addParam( \"counter\", \"application.collection.testcollections\" );\n+        Collection countersResponse = org().app( clientSetup.getAppName() ).collection( \"counters\" ).get( queryParameters ,true );\n+\n+        assertNotNull( countersResponse );\n+        ArrayList counterValues = ( ArrayList ) countersResponse.getResponse().getProperties().get( \"counters\" );\n+        LinkedHashMap counters = ( LinkedHashMap ) counterValues.get( 0 );\n+        assertEquals( \"application.collection.testcollections\", counters.get( \"name\" ) );\n+\n+        //Since it was accessed twice above.\n+        assertEquals( 10, ( ( LinkedHashMap ) ( ( ArrayList)counters.get( \"values\" )).get( 0 )).get( \"value\" ));\n+\n+        for(int i = 0; i < numberOfEntitiesToCreate; i++){\n+            this.app().collection( \"testCollection\" ).entity( entities[i] ).delete( );\n+        }\n+        \n+        queryParameters.addParam( \"resolution\", \"all\" ).addParam( \"counter\", \"application.collection.testcollections\" );\n+        countersResponse = org().app( clientSetup.getAppName() ).collection( \"counters\" ).get( queryParameters ,true );\n+\n+        assertNotNull( countersResponse );\n+        counterValues = ( ArrayList ) countersResponse.getResponse().getProperties().get( \"counters\" );\n+        counters = ( LinkedHashMap ) counterValues.get( 0 );\n+        assertEquals( \"application.collection.testcollections\", counters.get( \"name\" ) );\n+\n+        //Since it was accessed twice above.\n+        assertEquals( 0, ( ( LinkedHashMap ) ( ( ArrayList)counters.get( \"values\" )).get( 0 )).get( \"value\" ));\n+\n+\n+    }\n }",
                "additions": 48,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/test/java/org/apache/usergrid/rest/applications/events/ApplicationRequestCounterIT.java",
                "status": "modified",
                "changes": 48,
                "deletions": 0,
                "sha": "cf07dffbffb906df2dfa4e8a9f4ae4f8b65ebfc5",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/rest/src/test/java/org/apache/usergrid/rest/applications/events/ApplicationRequestCounterIT.java",
                "filename": "stack/rest/src/test/java/org/apache/usergrid/rest/applications/events/ApplicationRequestCounterIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/test/java/org/apache/usergrid/rest/applications/events/ApplicationRequestCounterIT.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -17,7 +17,6 @@\n package org.apache.usergrid.management.cassandra;\n \n \n-import com.google.common.base.Optional;\n import com.google.common.base.Preconditions;\n import com.google.common.cache.CacheBuilder;\n import com.google.common.cache.CacheLoader;\n@@ -88,6 +87,8 @@\n import static org.apache.commons.lang.StringUtils.isBlank;\n import static org.apache.usergrid.locking.LockHelper.getUniqueUpdateLock;\n import static org.apache.usergrid.management.AccountCreationProps.*;\n+import static org.apache.usergrid.management.OrganizationConfigProps.ORGPROPERTIES_ADMIN_SYSADMIN_EMAIL;\n+import static org.apache.usergrid.management.OrganizationConfigProps.WorkflowUrl;\n import static org.apache.usergrid.persistence.CredentialsInfo.getCredentialsSecret;\n import static org.apache.usergrid.persistence.Schema.*;\n import static org.apache.usergrid.persistence.Schema.PROPERTY_UUID;\n@@ -107,7 +108,6 @@\n import static org.apache.usergrid.utils.ListUtils.anyNull;\n import static org.apache.usergrid.utils.MapUtils.hashMap;\n import static org.apache.usergrid.utils.PasswordUtils.mongoPassword;\n-import static org.apache.usergrid.management.OrganizationConfigProps.*;\n \n \n public class ManagementServiceImpl implements ManagementService {\n@@ -173,6 +173,37 @@\n     protected LocalShiroCache localShiroCache;\n \n \n+    private LoadingCache<UUID, OrganizationConfig> orgConfigByAppCache = CacheBuilder.newBuilder().maximumSize( 1000 )\n+        .expireAfterWrite( Long.valueOf( System.getProperty(ORG_CONFIG_CACHE_PROP, \"30000\") ) , TimeUnit.MILLISECONDS)\n+        .build( new CacheLoader<UUID, OrganizationConfig>() {\n+            public OrganizationConfig load( UUID applicationInfoId ) {\n+\n+                try {\n+\n+                    if (applicationInfoId != null && applicationInfoId != CpNamingUtils.MANAGEMENT_APPLICATION_ID) {\n+\n+                        final EntityManager em = emf.getEntityManager(smf.getManagementAppId());\n+\n+                        Results r = em.getSourceEntities(\n+                            new SimpleEntityRef(CpNamingUtils.APPLICATION_INFO, applicationInfoId),\n+                            ORG_APP_RELATIONSHIP, Group.ENTITY_TYPE, Level.ALL_PROPERTIES);\n+\n+                        Group org = (Group) r.getEntity();\n+                        if (org != null) {\n+                            Map<Object, Object> entityProperties = em.getDictionaryAsMap(org, ORGANIZATION_CONFIG_DICTIONARY);\n+                            return new OrganizationConfig(orgConfigProperties, org.getUuid(), org.getPath(), entityProperties, false);\n+                        }\n+                    }\n+\n+                    return new OrganizationConfig(orgConfigProperties);\n+\n+                } catch (Exception e) {\n+                    return new OrganizationConfig(orgConfigProperties);\n+                }\n+            }}\n+        );\n+\n+\n \n     /** Must be constructed with a CassandraClientPool. */\n     public ManagementServiceImpl(Injector injector) {\n@@ -1678,6 +1709,8 @@ public void addAdminUserToOrganization( UserInfo user, OrganizationInfo organiza\n         em.addToCollection(new SimpleEntityRef(Group.ENTITY_TYPE, organization.getUuid()), \"users\",\n             new SimpleEntityRef(User.ENTITY_TYPE, user.getUuid()));\n \n+        invalidateManagementAppAuthCache();\n+\n         if ( email ) {\n             sendAdminUserInvitedEmail( user, organization );\n         }\n@@ -1713,6 +1746,8 @@ public void removeAdminUserFromOrganization( UUID userId, UUID organizationId, b\n \n         em.removeFromCollection(new SimpleEntityRef(Group.ENTITY_TYPE, organizationId), \"users\",\n             new SimpleEntityRef(User.ENTITY_TYPE, userId));\n+\n+        invalidateManagementAppAuthCache();\n     }\n \n \n@@ -1773,15 +1808,13 @@ public ApplicationInfo createApplication(UUID organizationId, String application\n                     + \")</a> created a new application named \" + applicationName, null );\n         }\n \n-        ScopedCache scopedCache = cacheFactory.getScopedCache(\n-            new CacheScope( new SimpleId( CpNamingUtils.MANAGEMENT_APPLICATION_ID, \"application\" )));\n-        scopedCache.invalidate();\n-        localShiroCache.invalidateAll();\n+        invalidateManagementAppAuthCache();\n \n         return new ApplicationInfo( applicationId, appInfo.getName() );\n     }\n \n \n+\n     @Override\n     public void deleteApplication(UUID applicationId) throws Exception {\n         emf.deleteApplication( applicationId );\n@@ -1835,10 +1868,7 @@ public ApplicationInfo restoreApplication(UUID applicationId) throws Exception {\n                     + \")</a> restored an application named \" + appInfo.getName(), null );\n         }\n \n-        ScopedCache scopedCache = cacheFactory.getScopedCache(\n-            new CacheScope( new SimpleId( CpNamingUtils.MANAGEMENT_APPLICATION_ID, \"application\" )));\n-        scopedCache.invalidate();\n-        localShiroCache.invalidateAll();\n+        invalidateManagementAppAuthCache();\n \n         return new ApplicationInfo( applicationId, appInfo.getName() );\n     }\n@@ -2274,6 +2304,8 @@ public String getConfirmationTokenForAdminUser( UUID userId, long ttl, UUID orga\n     public void activateAdminUser( UUID userId ) throws Exception {\n         EntityManager em = emf.getEntityManager( smf.getManagementAppId() );\n         em.setProperty( new SimpleEntityRef( User.ENTITY_TYPE, userId ), \"activated\", true );\n+\n+        invalidateManagementAppAuthCache();\n     }\n \n \n@@ -3424,39 +3456,10 @@ public void updateOrganizationConfig( OrganizationConfig organizationConfig ) th\n     }\n \n \n-    private LoadingCache<UUID, OrganizationConfig> orgConfigByAppCache =\n-        CacheBuilder.newBuilder().maximumSize( 1000 )\n-            .expireAfterWrite( Long.valueOf( System.getProperty(ORG_CONFIG_CACHE_PROP, \"30000\") ) , TimeUnit.MILLISECONDS)\n-            .build( new CacheLoader<UUID, OrganizationConfig>() {\n-                public OrganizationConfig load( UUID applicationInfoId ) {\n-\n-                    try {\n-\n-                        if (applicationInfoId != null && applicationInfoId != CpNamingUtils.MANAGEMENT_APPLICATION_ID) {\n-\n-                            final EntityManager em = emf.getEntityManager(smf.getManagementAppId());\n-\n-                            Results r = em.getSourceEntities(\n-                                new SimpleEntityRef(CpNamingUtils.APPLICATION_INFO, applicationInfoId),\n-                                ORG_APP_RELATIONSHIP, Group.ENTITY_TYPE, Level.ALL_PROPERTIES);\n-\n-                            Group org = (Group) r.getEntity();\n-\n-                            if (org != null) {\n-                                Map<Object, Object> entityProperties = em.getDictionaryAsMap(org, ORGANIZATION_CONFIG_DICTIONARY);\n-                                return new OrganizationConfig(orgConfigProperties, org.getUuid(), org.getPath(), entityProperties, false);\n-                            }\n-\n-                        }\n-\n-                        return new OrganizationConfig(orgConfigProperties);\n-\n-                    }catch (Exception e){\n-\n-                        return new OrganizationConfig(orgConfigProperties);\n-\n-                    }\n-                }}\n-            );\n-\n+    private void invalidateManagementAppAuthCache() {\n+        ScopedCache scopedCache = cacheFactory.getScopedCache(\n+            new CacheScope( new SimpleId( CpNamingUtils.MANAGEMENT_APPLICATION_ID, \"application\" )));\n+        scopedCache.invalidate();\n+        localShiroCache.invalidateAll();\n+    }\n }",
                "additions": 48,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/management/cassandra/ManagementServiceImpl.java",
                "status": "modified",
                "changes": 93,
                "deletions": 45,
                "sha": "73a56c8a03a9e333a83d7dbf3428c601eccf45e5",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/management/cassandra/ManagementServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/management/cassandra/ManagementServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/management/cassandra/ManagementServiceImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.usergrid.services.notifications;\n+\n+import com.google.common.cache.*;\n+import com.google.inject.Singleton;\n+import org.apache.usergrid.persistence.EntityManager;\n+import org.apache.usergrid.persistence.core.metrics.MetricsFactory;\n+import org.apache.usergrid.persistence.queue.QueueManager;\n+import org.apache.usergrid.services.notifications.impl.ApplicationQueueManagerImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Properties;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+@Singleton\n+public class ApplicationQueueManagerCache{\n+\n+    private static final Logger logger = LoggerFactory.getLogger( ApplicationQueueManagerCache.class );\n+\n+\n+    private final Cache<UUID, ApplicationQueueManager> cache;\n+\n+    private static final String CACHE_TTL_PROP = \"usergrid.push.queuemanager.cache.time-to-live\";\n+    private static final String CACHE_MAX_SIZE_PROP = \"usergrid.push.queuemanager.cache.size\";\n+\n+    public ApplicationQueueManagerCache(){\n+\n+        // set a smaller ttl\n+        long ttl = 10;\n+        int configuredMaxSize;\n+\n+        try{\n+            ttl = Integer.parseInt(System.getProperty(CACHE_TTL_PROP));\n+        } catch (NumberFormatException e){\n+            // already defaulted to 1 above\n+        }\n+\n+        try{\n+            configuredMaxSize = Integer.parseInt(System.getProperty(CACHE_MAX_SIZE_PROP));\n+        } catch (NumberFormatException e){\n+            configuredMaxSize = 200;\n+        }\n+\n+        this.cache = CacheBuilder.newBuilder()\n+            .maximumSize(Math.max(1000,configuredMaxSize))\n+            .expireAfterWrite(ttl, TimeUnit.MINUTES)\n+            .removalListener(new RemovalListener<UUID, ApplicationQueueManager>() {\n+                @Override\n+                public void onRemoval(\n+                    RemovalNotification<UUID, ApplicationQueueManager> queueManagerNotifiication) {\n+                    try {\n+                        if ( queueManagerNotifiication.getValue() != null) {\n+                            queueManagerNotifiication.getValue().stop();\n+                        }\n+                    } catch (Exception ie) {\n+                        logger.error(\"Failed to shutdown push queue manager from cache\", ie.getMessage());\n+                    }\n+                }\n+            }).build();\n+\n+    }\n+\n+    public void put(UUID key, ApplicationQueueManager value){\n+\n+        cache.put(key, value);\n+    }\n+\n+    public ConcurrentMap<UUID, ApplicationQueueManager> asMap(){\n+\n+        return cache.asMap();\n+    }\n+\n+    public ApplicationQueueManager get(UUID key){\n+        return cache.getIfPresent(key);\n+    }\n+\n+    public void invalidate(UUID key){\n+        cache.invalidate(key);\n+    }\n+\n+    public void invalidateAll(){\n+        cache.invalidateAll();\n+    }\n+\n+\n+    public ApplicationQueueManager getApplicationQueueManager( final EntityManager entityManager,\n+                                                               final QueueManager queueManager,\n+                                                               final JobScheduler jobScheduler,\n+                                                               final MetricsFactory metricsService,\n+                                                               final Properties properties ) {\n+\n+\n+        ApplicationQueueManager manager = cache.getIfPresent(entityManager.getApplicationId());\n+\n+        if(manager != null){\n+            if(logger.isTraceEnabled()){\n+                logger.trace(\"Returning push queue manager from cache for application: {}\", entityManager.getApplicationId());\n+            }\n+            return manager;\n+\n+        }else {\n+            if(logger.isTraceEnabled()) {\n+                logger.trace(\"Push queue manager not found in cache, loading for application: {}\", entityManager.getApplicationId());\n+            }\n+            manager = new ApplicationQueueManagerImpl(\n+                jobScheduler,\n+                entityManager,\n+                queueManager,\n+                metricsService,\n+                properties\n+            );\n+\n+            cache.put(entityManager.getApplicationId(), manager);\n+\n+            return manager;\n+\n+\n+        }\n+\n+\n+    }\n+\n+\n+}",
                "additions": 143,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/ApplicationQueueManagerCache.java",
                "status": "added",
                "changes": 143,
                "deletions": 0,
                "sha": "555e495715ccb69b23446b2d6fa6aa45be496324",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/ApplicationQueueManagerCache.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/ApplicationQueueManagerCache.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/ApplicationQueueManagerCache.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -77,6 +77,7 @@\n     private ServiceManagerFactory smf;\n     private EntityManagerFactory emf;\n     private QueueManagerFactory queueManagerFactory;\n+    private ApplicationQueueManagerCache applicationQueueManagerCache;\n \n     public NotificationsService() {\n         if (logger.isTraceEnabled()) {\n@@ -99,7 +100,10 @@ public void init( ServiceInfo info ) {\n         QueueScope queueScope = new QueueScopeImpl( name, QueueScope.RegionImplementation.LOCAL);\n         queueManagerFactory = getApplicationContext().getBean( Injector.class ).getInstance(QueueManagerFactory.class);\n         QueueManager queueManager = queueManagerFactory.getQueueManager(queueScope);\n-        notificationQueueManager = new ApplicationQueueManagerImpl(jobScheduler,em,queueManager,metricsService,props);\n+        applicationQueueManagerCache = getApplicationContext().getBean(Injector.class).getInstance(ApplicationQueueManagerCache.class);\n+        notificationQueueManager = applicationQueueManagerCache\n+            .getApplicationQueueManager(em,queueManager, jobScheduler, metricsService ,props);\n+\n         gracePeriod = JobScheduler.SCHEDULER_GRACE_PERIOD;\n     }\n \n@@ -136,7 +140,10 @@ public ServiceResults postCollection(ServiceContext context) throws Exception {\n             // perform some input validates on useGraph payload property vs. ql= path query\n             final List<ServiceParameter> parameters = context.getRequest().getOriginalParameters();\n             for (ServiceParameter parameter : parameters){\n-                if( parameter instanceof ServiceParameter.QueryParameter && context.getProperties().get(\"useGraph\").equals(true)){\n+                if( parameter instanceof ServiceParameter.QueryParameter\n+                    && context.getProperties().get(\"useGraph\") != null\n+                      && context.getProperties().get(\"useGraph\").equals(true)){\n+\n                     throw new IllegalArgumentException(\"Query ql parameter cannot be used with useGraph:true property value\");\n                 }\n             }",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java",
                "status": "modified",
                "changes": 11,
                "deletions": 2,
                "sha": "907638eede9cd1faccd10b2e1624e9ea77d1f968",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/NotificationsService.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -57,6 +57,7 @@\n     private ServiceManagerFactory smf;\n \n     private EntityManagerFactory emf;\n+    private ApplicationQueueManagerCache applicationQueueManagerCache;\n \n \n     private Properties properties;\n@@ -79,15 +80,15 @@ public QueueListener(ServiceManagerFactory smf, EntityManagerFactory emf, Proper\n         this.emf = emf;\n         this.metricsService = smf.getApplicationContext().getBean( Injector.class ).getInstance(MetricsFactory.class);\n         this.properties = props;\n+        this.applicationQueueManagerCache = smf.getApplicationContext().getBean(Injector.class).getInstance(ApplicationQueueManagerCache.class);\n+\n     }\n \n     /**\n      * Start the service and begin consuming messages\n      */\n     public void start(){\n         //TODO refactor this into a central component that will start/stop services\n-//        boolean shouldRun = new Boolean(properties.getProperty(\"usergrid.notifications.listener.run\", \"false\"));\n-\n \n             if (logger.isDebugEnabled()) {\n                 logger.debug(\"QueueListener: starting.\");\n@@ -166,9 +167,6 @@ private void execute(int threadNumber){\n         // run until there are no more active jobs\n         final AtomicLong runCount = new AtomicLong(0);\n \n-        //cache to retrieve push manager, cached per notifier, so many notifications will get same push manager\n-        LoadingCache<UUID, ApplicationQueueManager> queueManagerMap = getQueueManagerCache(queueManager);\n-\n         while ( true ) {\n \n                 Timer.Context timerContext = timer.time();\n@@ -207,7 +205,16 @@ private void execute(int threadNumber){\n                                 //send each set of app ids together\n                                 for (Map.Entry<UUID, List<QueueMessage>> entry : messageMap.entrySet()) {\n                                     UUID applicationId = entry.getKey();\n-                                    ApplicationQueueManager manager = queueManagerMap.get(applicationId);\n+\n+                                    ApplicationQueueManager manager = applicationQueueManagerCache\n+                                        .getApplicationQueueManager(\n+                                            emf.getEntityManager(applicationId),\n+                                            queueManager,\n+                                            new JobScheduler(smf.getServiceManager(applicationId), emf.getEntityManager(applicationId)),\n+                                            metricsService,\n+                                            properties\n+                                        );\n+\n                                     if (logger.isTraceEnabled()) {\n                                         logger.trace(\"send batch for app {} of {} messages\", entry.getKey(), entry.getValue().size());\n                                     }\n@@ -238,7 +245,7 @@ private void execute(int threadNumber){\n                                 }\n \n                                 if(runCount.incrementAndGet() % consecutiveCallsToRemoveDevices == 0){\n-                                    for(ApplicationQueueManager applicationQueueManager : queueManagerMap.asMap().values()){\n+                                    for(ApplicationQueueManager applicationQueueManager : applicationQueueManagerCache.asMap().values()){\n                                         try {\n                                             applicationQueueManager.asyncCheckForInactiveDevices();\n                                         }catch (Exception inactiveDeviceException){\n@@ -280,43 +287,6 @@ private void execute(int threadNumber){\n         }\n     }\n \n-    private LoadingCache<UUID, ApplicationQueueManager> getQueueManagerCache(final QueueManager queueManager) {\n-        return CacheBuilder\n-                    .newBuilder()\n-                    .expireAfterAccess(10, TimeUnit.MINUTES)\n-                    .removalListener(new RemovalListener<UUID, ApplicationQueueManager>() {\n-                        @Override\n-                        public void onRemoval(\n-                                RemovalNotification<UUID, ApplicationQueueManager> queueManagerNotifiication) {\n-                            try {\n-                                queueManagerNotifiication.getValue().stop();\n-                            } catch (Exception ie) {\n-                                logger.error(\"Failed to shutdown from cache\", ie);\n-                            }\n-                        }\n-                    }).build(new CacheLoader<UUID, ApplicationQueueManager>() {\n-                         @Override\n-                         public ApplicationQueueManager load(final UUID applicationId) {\n-                             try {\n-                                 EntityManager entityManager = emf.getEntityManager(applicationId);\n-                                 ServiceManager serviceManager = smf.getServiceManager(applicationId);\n-\n-                                 ApplicationQueueManagerImpl manager = new ApplicationQueueManagerImpl(\n-                                         new JobScheduler(serviceManager, entityManager),\n-                                         entityManager,\n-                                         queueManager,\n-                                         metricsService,\n-                                         properties\n-                                 );\n-                                 return manager;\n-                             } catch (Exception e) {\n-                                 logger.error(\"Could not instantiate queue manager\", e);\n-                                 return null;\n-                             }\n-                         }\n-                     });\n-    }\n-\n     public void stop(){\n         if (logger.isDebugEnabled()) {\n             logger.debug(\"stop processes\");",
                "additions": 14,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/QueueListener.java",
                "status": "modified",
                "changes": 58,
                "deletions": 44,
                "sha": "478d5edc9f6c19b5c55087fd719c1c9ba218b416",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/QueueListener.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/QueueListener.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/QueueListener.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -26,6 +26,8 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.time.Instant;\n+import java.time.LocalDateTime;\n import java.util.*;\n import java.util.concurrent.atomic.AtomicLong;\n \n@@ -37,12 +39,10 @@\n     private AtomicLong successes = new AtomicLong();\n     private AtomicLong failures = new AtomicLong();\n     private EntityManager em;\n-    private boolean hasFinished;\n \n     public TaskManager(EntityManager em, Notification notification) {\n         this.em = em;\n         this.notification = notification;\n-        hasFinished = false;\n     }\n \n     public long getSuccesses(){return successes.get();}\n@@ -53,77 +53,78 @@ public void completed(Notifier notifier, UUID deviceUUID) throws Exception {\n         completed(notifier,null,deviceUUID,null);\n     }\n     public void completed(Notifier notifier, Receipt receipt, UUID deviceUUID, String newProviderId) throws Exception {\n-        if (logger.isTraceEnabled()) {\n-            logger.trace(\"REMOVED {}\", deviceUUID);\n-        }\n+\n+        successes.incrementAndGet();\n+\n+\n         try {\n-            if (logger.isTraceEnabled()) {\n-                logger.trace(\"notification {} removing device {} from remaining\", notification.getUuid(), deviceUUID);\n-            }\n+            //.{year}.{month}.{day}.{HH24} possibly minute.\n+            //random date and time for format\n+\n+\n+            //incrementNotificationCounter( \"completed\" );\n \n             EntityRef deviceRef = new SimpleEntityRef(Device.ENTITY_TYPE, deviceUUID);\n+\n             if (receipt != null) {\n-                if (logger.isTraceEnabled()) {\n-                    logger.trace(\"notification {} sent to device {}. saving receipt.\", notification.getUuid(), deviceUUID);\n-                }\n+\n                 receipt.setSent(System.currentTimeMillis());\n                 this.saveReceipt(notification, deviceRef, receipt,false);\n                 if (logger.isTraceEnabled()) {\n-                    logger.trace(\"notification {} receipt saved for device {}\", notification.getUuid(), deviceUUID);\n+                    logger.trace(\"Notification {} receipt saved for device {}\", notification.getUuid(), deviceUUID);\n                 }\n-                successes.incrementAndGet();\n+\n             }\n \n             if (newProviderId != null) {\n                 if (logger.isTraceEnabled()) {\n-                    logger.trace(\"notification {} replacing device {} notifierId\", notification.getUuid(), deviceUUID);\n+                    logger.trace(\"Notification {} replacing notifier id for device {} \", notification.getUuid(), deviceUUID);\n                 }\n                 replaceProviderId(deviceRef, notifier, newProviderId);\n             }\n \n             if (logger.isTraceEnabled()) {\n-                logger.trace(\"notification {} completed device {}\", notification.getUuid(), deviceUUID);\n+                logger.trace(\"Notification {} sending completed for device {}\", notification.getUuid(), deviceUUID);\n             }\n \n-        } finally {\n-            if (logger.isTraceEnabled()) {\n-                logger.trace(\"COUNT is: {}\", successes.get());\n-            }\n-//            if (hasFinished) { //process has finished but notifications are still coming in\n-//                finishedBatch();\n-//\n-//            }\n+        } catch(Exception e) {\n+\n+            logger.error(\"Unable to mark notification {} as completed due to: {}\", notification.getUuid(), e);\n+\n         }\n     }\n \n     public void failed(Notifier notifier, Receipt receipt, UUID deviceUUID, Object code, String message) throws Exception {\n \n+        failures.incrementAndGet();\n+\n         try {\n+\n+            //incrementNotificationCounter( \"failed\" );\n+\n             if (logger.isDebugEnabled()) {\n-                logger.debug(\"notification {} for device {} got error {}\", notification.getUuid(), deviceUUID, code);\n+                logger.debug(\"Notification {} for device {} got error {}\", notification.getUuid(), deviceUUID, code);\n             }\n \n-            failures.incrementAndGet();\n-            if(receipt!=null) {\n-                if ( receipt.getUuid() != null ) {\n-                    successes.decrementAndGet();\n-                }\n+            if(receipt != null) {\n                 receipt.setErrorCode( code );\n                 receipt.setErrorMessage( message );\n                 this.saveReceipt( notification, new SimpleEntityRef( Device.ENTITY_TYPE, deviceUUID ), receipt, true );\n-                if ( logger.isDebugEnabled() ) {\n-                    logger.debug( \"notification {} receipt saved for device {}\", notification.getUuid(), deviceUUID );\n-                }\n             }\n-        } finally {\n+\n             completed(notifier, deviceUUID);\n             finishedBatch();\n+\n+        } catch (Exception e){\n+\n+            logger.error(\"Unable to finish marking notification {} as failed due to error: \", notification.getUuid(), e);\n+\n         }\n     }\n \n-    /*\n-    * called from TaskManager - creates a persistent receipt and updates the\n-    * passed one w/ the UUID\n+    /**\n+    * Called from TaskManager - Creates a persistent receipt\n+    *\n     */\n     private void saveReceipt(EntityRef notification, EntityRef device, Receipt receipt, boolean hasError) throws Exception {\n \n@@ -142,11 +143,16 @@ private void saveReceipt(EntityRef notification, EntityRef device, Receipt recei\n             } else {\n                 em.addToCollections(entities, Notification.RECEIPTS_COLLECTION, receipt);\n             }\n+\n+            if ( logger.isDebugEnabled() ) {\n+                logger.debug( \"Notification {} receipt saved for device {}\", notification.getUuid(), device.getUuid() );\n+            }\n+\n         }\n \n     }\n \n-    protected void replaceProviderId(EntityRef device, Notifier notifier,\n+    private void replaceProviderId(EntityRef device, Notifier notifier,\n                                      String newProviderId) throws Exception {\n         Object value = em.getProperty(device, notifier.getName()\n                 + ApplicationQueueManager.NOTIFIER_ID_POSTFIX);\n@@ -161,33 +167,38 @@ protected void replaceProviderId(EntityRef device, Notifier notifier,\n         }\n     }\n \n-    public void finishedBatch() throws Exception {\n-        finishedBatch(true);\n+    public void incrementNotificationCounter(String status){\n+        em.incrementAggregateCounters( null,null,null,\"counters.notifications.\"+notification.getUuid()+\".\"+status,1 );\n+\n+        LocalDateTime localDateTime = LocalDateTime.now();\n+        StringBuilder currentDate = new StringBuilder(  );\n+        currentDate.append( \"counters.notifications.aggregate.\"+status+\".\" );\n+        currentDate.append( localDateTime.getYear()+\".\" );\n+        currentDate.append( localDateTime.getMonth()+\".\" );\n+        currentDate.append( localDateTime.getDayOfMonth()+\".\" );\n+        currentDate.append( localDateTime.getMinute() );\n+        em.incrementAggregateCounters( null,null,null,currentDate.toString(),1 );\n+\n     }\n \n-    public void finishedBatch(boolean refreshNotification) throws Exception {\n \n-        long successes = this.successes.get(); //reset counters\n-        long failures = this.failures.get(); //reset counters\n+    public void finishedBatch() throws Exception {\n \n-        for (int i = 0; i < successes; i++) {\n-            this.successes.decrementAndGet();\n-        }\n-        for (int i = 0; i < failures; i++) {\n-            this.failures.decrementAndGet();\n-        }\n+        long successes = this.successes.get();\n+        long failures = this.failures.get();\n \n-        this.hasFinished = true;\n+        // reset the counters\n+        this.successes.set(0);\n+        this.failures.set(0);\n \n-        // force refresh notification by fetching it\n-        if (refreshNotification) {\n-            notification = em.get(this.notification.getUuid(), Notification.class);\n-        }\n+        // get the latest notification info\n+        notification = em.get(this.notification.getUuid(), Notification.class);\n \n         notification.updateStatistics(successes, failures);\n         notification.setModified(System.currentTimeMillis());\n         notification.setFinished(notification.getModified());\n \n         em.update(notification);\n+\n     }\n }",
                "additions": 64,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java",
                "status": "modified",
                "changes": 117,
                "deletions": 53,
                "sha": "870cae990672298e33733a34f4d3db1201d719b3",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/TaskManager.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -19,15 +19,18 @@\n import com.codahale.metrics.Meter;\n import org.apache.usergrid.batch.JobExecution;\n import org.apache.usergrid.persistence.*;\n+import org.apache.usergrid.persistence.core.executor.TaskExecutorFactory;\n import org.apache.usergrid.persistence.core.metrics.MetricsFactory;\n import org.apache.usergrid.persistence.entities.*;\n import org.apache.usergrid.persistence.Query;\n+import org.apache.usergrid.persistence.index.utils.UUIDUtils;\n import org.apache.usergrid.persistence.queue.QueueManager;\n import org.apache.usergrid.persistence.queue.QueueMessage;\n import org.apache.usergrid.services.notifications.*;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import rx.Observable;\n+import rx.Scheduler;\n import rx.Subscriber;\n import rx.functions.Func1;\n import rx.schedulers.Schedulers;\n@@ -42,21 +45,28 @@\n \n     private static final Logger logger = LoggerFactory.getLogger(ApplicationQueueManagerImpl.class);\n \n-    //this is for tests, will not mark initial post complete, set to false for tests\n-\n     private final EntityManager em;\n     private final QueueManager qm;\n     private final JobScheduler jobScheduler;\n     private final MetricsFactory metricsFactory;\n     private final String queueName;\n     private final Meter queueMeter;\n     private final Meter sendMeter;\n+    private int concurrencyFactor;\n \n+    private final static String PUSH_PROCESSING_MAXTHREADS_PROP = \"usergrid.push.async.processing.threads\";\n+    private final static String PUSH_PROCESSING_QUEUESIZE_PROP = \"usergrid.push.async.processing.queue.size\";\n     private final static String PUSH_PROCESSING_CONCURRENCY_PROP = \"usergrid.push.async.processing.concurrency\";\n \n     HashMap<Object, ProviderAdapter> notifierHashMap; // only retrieve notifiers once\n \n \n+\n+    //private final Scheduler scheduler;\n+\n+\n+\n+\n     public ApplicationQueueManagerImpl( JobScheduler jobScheduler, EntityManager entityManager,\n                                         QueueManager queueManager, MetricsFactory metricsFactory,\n                                         Properties properties) {\n@@ -65,8 +75,35 @@ public ApplicationQueueManagerImpl( JobScheduler jobScheduler, EntityManager ent\n         this.jobScheduler = jobScheduler;\n         this.metricsFactory = metricsFactory;\n         this.queueName = getQueueNames(properties);\n-        queueMeter = metricsFactory.getMeter(ApplicationQueueManagerImpl.class, \"notification.queue\");\n-        sendMeter = metricsFactory.getMeter(NotificationsService.class, \"queue.send\");\n+        this.queueMeter = metricsFactory.getMeter(ApplicationQueueManagerImpl.class, \"notification.queue\");\n+        this.sendMeter = metricsFactory.getMeter(NotificationsService.class, \"queue.send\");\n+        this.concurrencyFactor = Integer.valueOf(System.getProperty(PUSH_PROCESSING_CONCURRENCY_PROP, \"50\"));\n+\n+\n+        /**\n+        int maxAsyncThreads;\n+        int workerQueueSize;\n+\n+        try {\n+\n+            maxAsyncThreads = Integer.valueOf(System.getProperty(PUSH_PROCESSING_MAXTHREADS_PROP, \"200\"));\n+            workerQueueSize = Integer.valueOf(System.getProperty(PUSH_PROCESSING_QUEUESIZE_PROP, \"2000\"));\n+\n+        } catch (Exception e){\n+\n+            // if junk is passed into the property, just default the values\n+            maxAsyncThreads = 200;\n+            workerQueueSize = 2000;\n+            this.concurrencyFactor = 50;\n+\n+        }\n+\n+\n+        // create our own executor which has a bounded queue w/ caller runs policy for rejected tasks\n+        this.scheduler = Schedulers.from(TaskExecutorFactory\n+            .createTaskExecutor( \"push-device-io\", maxAsyncThreads, workerQueueSize,\n+                TaskExecutorFactory.RejectionAction.CALLERRUNS ));\n+         **/\n \n     }\n \n@@ -104,7 +141,9 @@ public void queueNotification(final Notification notification, final JobExecutio\n                 logger.trace(\"notification {} start query\", notification.getUuid());\n             }\n \n-            logger.info(\"Notification {} started processing\", notification.getUuid());\n+            if(logger.isTraceEnabled()) {\n+                logger.trace(\"Notification {} started processing\", notification.getUuid());\n+            }\n \n \n \n@@ -206,6 +245,7 @@ public void queueNotification(final Notification notification, final JobExecutio\n                                 Query devicesQuery = new Query();\n                                 devicesQuery.setCollection(\"devices\");\n                                 devicesQuery.setResultsLevel(Query.Level.CORE_PROPERTIES);\n+                                devicesQuery.setLimit(50); // for now, assume a user has no more than 50 devices\n \n                                 try {\n \n@@ -234,7 +274,6 @@ public void queueNotification(final Notification notification, final JobExecutio\n                         return Observable.from(entities);\n \n                         })\n-                        .distinct( deviceRef -> deviceRef.getUuid())\n                         .filter( device -> {\n \n                             if(logger.isTraceEnabled()) {\n@@ -271,37 +310,47 @@ public void queueNotification(final Notification notification, final JobExecutio\n \n                         })\n                         .map(sendMessageFunction)\n-                        .doOnNext( message -> {\n-                            try {\n+                        .subscribeOn(Schedulers.io());\n \n-                                if(message.isPresent()){\n+                }, concurrencyFactor)\n+                .distinct( queueMessage -> {\n \n-                                    if(logger.isTraceEnabled()) {\n-                                        logger.trace(\"Queueing notification message for device: {}\", message.get().getDeviceId());\n-                                    }\n-                                    qm.sendMessage( message.get() );\n-                                    queueMeter.mark();\n-                                }\n+                    if(queueMessage.isPresent()) {\n+                        return queueMessage.get().getDeviceId();\n+                    }\n \n-                            } catch (IOException e) {\n+                    return UUIDUtils.newTimeUUID(); // this should be distinct, default handling for the Optional.empty() case\n \n-                                if(message.isPresent()){\n-                                    logger.error(\"Unable to queue notification for notification UUID {} and device UUID {} \",\n-                                        message.get().getNotificationId(), message.get().getDeviceId());\n-                                }\n-                                else{\n-                                    logger.error(\"Unable to queue notification as it's not present when trying to send to queue\");\n-                                }\n+                } )\n+                .doOnNext( message -> {\n+                    try {\n \n+                        if(message.isPresent()){\n+\n+                            if(logger.isTraceEnabled()) {\n+                                logger.trace(\"Queueing notification message for device: {}\", message.get().getDeviceId());\n                             }\n+                            qm.sendMessage( message.get() );\n+                            queueMeter.mark();\n+                        }\n \n+                    } catch (IOException e) {\n \n-                        }).subscribeOn(Schedulers.io());\n+                        if(message.isPresent()){\n+                            logger.error(\"Unable to queue notification for notification UUID {} and device UUID {} \",\n+                                message.get().getNotificationId(), message.get().getDeviceId());\n+                        }\n+                        else{\n+                            logger.error(\"Unable to queue notification as it's not present when trying to send to queue\");\n+                        }\n+\n+                    }\n \n-                }, Integer.valueOf(System.getProperty(PUSH_PROCESSING_CONCURRENCY_PROP, \"50\")))\n+\n+                })\n                 .doOnError(throwable -> {\n \n-                    logger.error(\"Error while processing devices for notification : {}\", notification.getUuid());\n+                    logger.error(\"Error while processing devices for notification : {}, error: {}\", notification.getUuid(), throwable.getMessage());\n                     notification.setProcessingFinished(-1L);\n                     notification.setDeviceProcessedCount(deviceCount.get());\n                     logger.warn(\"Partial notification. Only {} devices processed for notification {}\",\n@@ -319,7 +368,9 @@ public void queueNotification(final Notification notification, final JobExecutio\n                         notification.setProcessingFinished(System.currentTimeMillis());\n                         notification.setDeviceProcessedCount(deviceCount.get());\n                         em.update(notification);\n-                        logger.info(\"Notification {} finished processing {} device(s)\", notification.getUuid(), deviceCount.get());\n+                        if(logger.isTraceEnabled()) {\n+                            logger.trace(\"Notification {} finished processing {} device(s)\", notification.getUuid(), deviceCount.get());\n+                        }\n \n                     } catch (Exception e) {\n                         logger.error(\"Unable to set processing finished timestamp for notification\");\n@@ -348,7 +399,7 @@ public void queueNotification(final Notification notification, final JobExecutio\n         // if no devices, go ahead and mark the batch finished\n         if (deviceCount.get() <= 0 ) {\n             TaskManager taskManager = new TaskManager(em, notification);\n-            taskManager.finishedBatch(true);\n+            taskManager.finishedBatch();\n         }\n \n \n@@ -540,32 +591,43 @@ public void stop() {\n \n \n     /**\n-     * Validates that a notifier and adapter exists to send notifications to;\n-     * {\"winphone\":\"mymessage\",\"apple\":\"mymessage\"}\n-     * TODO: document this method better\n+     *  Validates that a notifier and adapter exists to send notifications to. For the example payload\n+     *\n+     *  { \"payloads\" : {\"winphone\":\"mymessage\",\"apple\":\"mymessage\"} }\n+     *\n+     *  Notifiers with name \"winphone\" and \"apple\" must exist.\n      */\n-    private Map<String, Object> translatePayloads(Map<String, Object> payloads, Map<Object, ProviderAdapter>\n-        notifierMap) throws Exception {\n-        Map<String, Object> translatedPayloads = new HashMap<String, Object>(payloads.size());\n+    private Map<String, Object> translatePayloads(Map<String, Object> payloads,\n+                                                  Map<Object, ProviderAdapter> notifierMap) throws Exception {\n+\n+        final Map<String, Object> translatedPayloads = new HashMap<String, Object>(payloads.size());\n+\n         for (Map.Entry<String, Object> entry : payloads.entrySet()) {\n+\n             String payloadKey = entry.getKey().toLowerCase();\n             Object payloadValue = entry.getValue();\n+\n             //look for adapter from payload map\n             ProviderAdapter providerAdapter = notifierMap.get(payloadKey);\n             if (providerAdapter != null) {\n+\n                 //translate payload to usable information\n                 Object translatedPayload = payloadValue != null ? providerAdapter.translatePayload(payloadValue) : null;\n                 if (translatedPayload != null) {\n                     translatedPayloads.put(payloadKey, translatedPayload);\n                 }\n+\n             }\n         }\n         return translatedPayloads;\n     }\n \n     public static String getQueueNames(Properties properties) {\n-        String name = properties.getProperty(ApplicationQueueManagerImpl.DEFAULT_QUEUE_PROPERTY, ApplicationQueueManagerImpl.DEFAULT_QUEUE_NAME);\n+\n+        String name = properties.getProperty(ApplicationQueueManagerImpl.DEFAULT_QUEUE_PROPERTY,\n+            ApplicationQueueManagerImpl.DEFAULT_QUEUE_NAME);\n         return name;\n+\n     }\n \n     private static final class IteratorObservable<T> implements rx.Observable.OnSubscribe<T> {\n@@ -585,15 +647,15 @@ public void call(final Subscriber<? super T> subscriber) {\n \n             try {\n                 while (!subscriber.isUnsubscribed() && input.hasNext()) {\n+\n                     //send our input to the next\n-                    //logger.debug(\"calling next on iterator: {}\", input.getClass().getSimpleName());\n                     subscriber.onNext((T) input.next());\n+\n                 }\n \n                 //tell the subscriber we don't have any more data\n-                //logger.debug(\"finished iterator: {}\", input.getClass().getSimpleName());\n-\n                 subscriber.onCompleted();\n+\n             } catch (Throwable t) {\n                 logger.error(\"failed on subscriber\", t);\n                 subscriber.onError(t);\n@@ -617,10 +679,9 @@ public void asyncCheckForInactiveDevices() throws Exception {\n                     }\n                 }\n             } catch (Exception e) {\n-                logger.error(\"checkForInactiveDevices\", e); // not\n-                // essential so\n-                // don't fail,\n-                // but log\n+                // not essential so don't fail, but log\n+                logger.error(\"checkForInactiveDevices\", e);\n+\n             }\n         }\n     }\n@@ -630,14 +691,14 @@ private boolean isOkToSend(Notification notification) {\n \n         if (notification.getCanceled() == Boolean.TRUE) {\n             if (logger.isDebugEnabled()) {\n-                logger.debug(\"notification {} canceled. not sending.\",\n+                logger.debug(\"Notification {} canceled. Not sending.\",\n                     notification.getUuid());\n             }\n             return false;\n         }\n         if (notification.isExpired()) {\n             if (logger.isDebugEnabled()) {\n-                logger.debug(\"notification {} expired. not sending.\",\n+                logger.debug(\"Notification {} expired. Not sending.\",\n                     notification.getUuid());\n             }\n             return false;\n@@ -654,7 +715,7 @@ private String getProviderId(EntityRef device, Notifier notifier) throws Excepti\n             }\n             return value != null ? value.toString() : null;\n         } catch (Exception e) {\n-            logger.error(\"Error getting provider ID, proceeding with rest of batch\", e);\n+            logger.error(\"Error getting notifier for device {}, proceeding with rest of batch\", device, e);\n             return null;\n         }\n     }",
                "additions": 106,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "status": "modified",
                "changes": 151,
                "deletions": 45,
                "sha": "eb5d794061e7d1fa967b3afd81618bfea2cdad48",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifications/impl/ApplicationQueueManagerImpl.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -16,7 +16,9 @@\n  */\n package org.apache.usergrid.services.notifiers;\n \n+import com.google.inject.Injector;\n import org.apache.usergrid.persistence.entities.Notifier;\n+import org.apache.usergrid.services.notifications.ApplicationQueueManagerCache;\n import org.apache.usergrid.services.notifications.ProviderAdapterFactory;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -54,6 +56,10 @@ public ServiceResults postCollection(ServiceContext context)\n                 providerAdapter.validateCreateNotifier(payload);\n                 NotificationsService ns = (NotificationsService) sm.getService(\"notifications\");\n                 ns.testConnection(notifier);\n+\n+                // clear the app's push manager cache when notifiers are added\n+                ns.getApplicationContext().getBean(Injector.class)\n+                    .getInstance(ApplicationQueueManagerCache.class).invalidate(em.getApplicationId());\n             } catch (Exception e) {\n                 logger.info(\"notifier testConnection() failed\", e);\n                 em.delete(notifier);",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifiers/NotifiersService.java",
                "status": "modified",
                "changes": 6,
                "deletions": 0,
                "sha": "cd5ca205e4dd7f2827333a161906701142b38174",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/main/java/org/apache/usergrid/services/notifiers/NotifiersService.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/services/notifiers/NotifiersService.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/services/notifiers/NotifiersService.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            },
            {
                "patch": "@@ -19,14 +19,19 @@\n import com.google.android.gcm.server.Constants;\n import com.google.android.gcm.server.InvalidRequestException;\n import net.jcip.annotations.NotThreadSafe;\n+\n+import org.apache.usergrid.ServiceApplication;\n import org.apache.usergrid.persistence.*;\n import org.apache.usergrid.persistence.entities.*;\n+import org.apache.usergrid.persistence.index.query.CounterResolution;\n+import org.apache.usergrid.services.ServiceResults;\n import org.apache.usergrid.services.notifications.*;\n import org.junit.*;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import java.lang.reflect.Field;\n+import java.time.LocalDateTime;\n import java.util.*;\n \n import org.apache.usergrid.services.ServiceAction;\n@@ -304,6 +309,78 @@ public void singlePushNotificationWithMapPayload() throws Exception {\n         checkReceipts(notification, 1);\n     }\n \n+    @Ignore(\"turn this on and run individually when you want to verify. there is an issue with the aggregate counter, because of all the other tests\"\n+        + \"AND, there is an issue with the batcher where we have to turn it up/down to see the results in time. \")\n+    @Test\n+    public void singlePushNotificationWithCounters() throws Exception {\n+\n+        long ts = System.currentTimeMillis() - ( 24 * 60 * 60 * 1000 );\n+        app.clear();\n+        String payload = \"Hello, World!\";\n+        Map<String, String> payloads = new HashMap<String, String>(1);\n+        payloads.put(notifier.getUuid().toString(), payload);\n+        app.put(\"payloads\", payloads);\n+        app.put(\"queued\", System.currentTimeMillis());\n+        app.put(\"debug\", false);\n+        app.put(\"expire\", System.currentTimeMillis() + 300000); // add 5 minutes to current time\n+\n+        Entity e = app.testRequest(ServiceAction.POST, 1, \"devices\", device1.getUuid(), \"notifications\").getEntity();\n+        app.testRequest(ServiceAction.GET, 1, \"notifications\", e.getUuid());\n+\n+        Notification notification = app.getEntityManager().get(e.getUuid(), Notification.class);\n+        assertEquals(\n+            notification.getPayloads().get(notifier.getUuid().toString()),\n+            payload);\n+\n+        // perform push //\n+        notification = notificationWaitForComplete(notification);\n+        //        checkReceipts(notification, 1);\n+\n+\n+        verifyNotificationCounter( notification,\"completed\",ts,1 );\n+        verifyNotificationCounter( notification,\"failed\",ts, 0 );\n+\n+\n+\n+\n+    }\n+\n+    public void verifyNotificationCounter(Notification notification,String status,Long timestamp, int expected){\n+\n+        Results countersResults = app.getEntityManager().getAggregateCounters( null,null,null,\"counters.notifications.\"+notification.getUuid()+\".\"+status,\n+            CounterResolution.ALL,timestamp,System.currentTimeMillis(),false ) ;\n+\n+        assertEquals( 1, countersResults.getCounters().size() );\n+        if(expected > 0) {\n+            assertEquals( expected, countersResults.getCounters().get( 0 ).getValues().get( 0 ).getValue() );\n+        }else if (expected == 0){\n+            assertEquals( 0,countersResults.getCounters().get( 0 ).getValues().size());\n+        }\n+\n+        LocalDateTime localDateTime = LocalDateTime.now();\n+        StringBuilder currentDate = new StringBuilder(  );\n+        currentDate.append( \"counters.notifications.aggregate.\"+status+\".\" );\n+        currentDate.append( localDateTime.getYear()+\".\" );\n+        currentDate.append( localDateTime.getMonth()+\".\" );\n+        currentDate.append( localDateTime.getDayOfMonth()); //+\".\" );\n+\n+        countersResults = app.getEntityManager().getAggregateCounters( null,null,null,currentDate.toString(),\n+            CounterResolution.ALL,timestamp,System.currentTimeMillis(),false ) ;\n+\n+        //checks to see that it exists\n+        assertEquals( 1, countersResults.getCounters().size() );\n+        if(expected > 0) {\n+            assertEquals( expected, countersResults.getCounters().get( 0 ).getValues().get( 0 ).getValue() );\n+\n+        }\n+        else if (expected == 0){\n+            assertEquals( 0,countersResults.getCounters().get( 0 ).getValues().size());\n+        }\n+\n+    }\n+\n+\n+\n     @Test\n     public void singlePushNotificationMultipleDevices() throws Exception {\n ",
                "additions": 77,
                "raw_url": "https://github.com/apache/usergrid/raw/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/test/java/org/apache/usergrid/services/notifications/gcm/NotificationsServiceIT.java",
                "status": "modified",
                "changes": 77,
                "deletions": 0,
                "sha": "1a9f4f7b30f7d439f4d06492e261e81819232718",
                "blob_url": "https://github.com/apache/usergrid/blob/e4beaead1026f280ea65b363c40f48e22be65a2b/stack/services/src/test/java/org/apache/usergrid/services/notifications/gcm/NotificationsServiceIT.java",
                "filename": "stack/services/src/test/java/org/apache/usergrid/services/notifications/gcm/NotificationsServiceIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/test/java/org/apache/usergrid/services/notifications/gcm/NotificationsServiceIT.java?ref=e4beaead1026f280ea65b363c40f48e22be65a2b"
            }
        ],
        "bug_id": "usergrid_52",
        "parent": "https://github.com/apache/usergrid/commit/279c020d3f97c74d78bb973b291cb9dca8805ed0",
        "message": "Merge branch 'release-2.1.1'\n\n* release-2.1.1: (23 commits)\n  Add more info to the log statement when we can't load an application.\n  Update logging statements to be trace level.\n  Clear an app's push manager queue cache when notifiers are added ( current notifiers are stored as a hash map within the class instance).\n  Re-work caching of push notification queue managers such that producing and consuming leverage the same cache.\n  Ensure the hector cluster is created with credentials from the properties file.\n  Added fixes around caching and changed the endpoint to selective indexing to be /_index instead of /_indexes\n  Tweak heap status to return used heap, and changed endpoint to status/heap.\n  Add status/memory endpoint to get heap usage, max heap, and free heap.\n  Increase limit of device fetching per user to 50.\n  Increase AWS client timeouts.\n  Back to Schedulers.io()\n  Update distinct to properly use device ID.\n  Update distinct code.\n  Fix scheduler.\n  Temporarily disable notification counters and back to Schedulers.io()\n  Fix NPE.\n  Added a test for counters that isn't correctly configured to work with other tests yet, and added the counters to the backend of notifications for further examination.\n  Add a separate executor pool for async processing instead of unbounded Schedulers.io()\n  Invalidate ShiroCache when admin user added to org.\n  Ensure that applicationId cache does not cache nulls.\n  ...",
        "repo": "usergrid"
    },
    {
        "commit": "https://github.com/apache/usergrid/commit/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f",
        "file": [
            {
                "patch": "@@ -36,7 +36,7 @@ collections.keyspace.strategy.class=org.apache.cassandra.locator.SimpleStrategy\n collection.stage.transient.timeout=60\n \n elasticsearch.embedded=true\n-elasticsearch.cluster_name=usergrid\n+elasticsearch.cluster_name=usergrid_test\n elasticsearch.index_prefix=usergrid\n elasticsearch.hosts=127.0.0.1\n elasticsearch.port=9300",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/config/src/main/resources/corepersistence.properties",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "566e259afc61c31661c97dac40e0b36f39656fed",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/config/src/main/resources/corepersistence.properties",
                "filename": "stack/config/src/main/resources/corepersistence.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/config/src/main/resources/corepersistence.properties?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -506,12 +506,12 @@\n \t    <type>jar</type>\n     </dependency>\n \n-    <dependency>\n-      <artifactId>lucene-core</artifactId>\n-      <groupId>org.apache.lucene</groupId>\n-      <type>jar</type>\n-      <version>4.7.2</version>\n-    </dependency>\n+    <!--<dependency>-->\n+      <!--<artifactId>lucene-core</artifactId>-->\n+      <!--<groupId>org.apache.lucene</groupId>-->\n+      <!--<type>jar</type>-->\n+      <!--<version>4.7.2</version>-->\n+    <!--</dependency>-->\n \n     <dependency>\n         <groupId>org.jukito</groupId>",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/pom.xml",
                "status": "modified",
                "changes": 12,
                "deletions": 6,
                "sha": "12e282a706da192ebec83c5877a981f411b52788",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/pom.xml",
                "filename": "stack/core/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/pom.xml?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -30,6 +30,19 @@\n import java.util.TreeSet;\n import java.util.UUID;\n \n+import java.util.*;\n+\n+import javax.annotation.Resource;\n+\n+import org.apache.usergrid.persistence.*;\n+import org.apache.usergrid.persistence.EntityRef;\n+import org.apache.usergrid.persistence.Results;\n+import org.apache.usergrid.persistence.SimpleEntityRef;\n+import org.apache.usergrid.persistence.cassandra.*;\n+import org.apache.usergrid.persistence.entities.*;\n+import org.apache.usergrid.persistence.index.query.*;\n+import org.apache.usergrid.persistence.model.util.UUIDGenerator;\n+import org.apache.usergrid.utils.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.util.Assert;\n@@ -56,15 +69,13 @@\n import org.apache.usergrid.persistence.cassandra.ConnectionRefImpl;\n import org.apache.usergrid.persistence.cassandra.CounterUtils;\n import org.apache.usergrid.persistence.cassandra.GeoIndexManager;\n+\n import org.apache.usergrid.persistence.cassandra.util.TraceParticipant;\n import org.apache.usergrid.persistence.collection.CollectionScope;\n import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n import org.apache.usergrid.persistence.collection.exception.WriteUniqueVerifyException;\n import org.apache.usergrid.persistence.collection.impl.CollectionScopeImpl;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n-import org.apache.usergrid.persistence.entities.Application;\n-import org.apache.usergrid.persistence.entities.Event;\n-import org.apache.usergrid.persistence.entities.Role;\n import org.apache.usergrid.persistence.exceptions.DuplicateUniquePropertyExistsException;\n import org.apache.usergrid.persistence.exceptions.RequiredPropertyNotFoundException;\n import org.apache.usergrid.persistence.index.EntityIndex;\n@@ -73,6 +84,7 @@\n import org.apache.usergrid.persistence.index.query.CounterResolution;\n import org.apache.usergrid.persistence.index.query.Identifier;\n import org.apache.usergrid.persistence.index.query.Query;\n+\n import org.apache.usergrid.persistence.index.query.Query.Level;\n import org.apache.usergrid.persistence.model.entity.Id;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n@@ -98,9 +110,11 @@\n import me.prettyprint.hector.api.query.MultigetSliceCounterQuery;\n import me.prettyprint.hector.api.query.QueryResult;\n import me.prettyprint.hector.api.query.SliceCounterQuery;\n+import rx.Observable;\n \n import static java.lang.String.CASE_INSENSITIVE_ORDER;\n import static java.util.Arrays.asList;\n+import java.util.HashSet;\n \n import static me.prettyprint.hector.api.factory.HFactory.createCounterSliceQuery;\n import static me.prettyprint.hector.api.factory.HFactory.createMutator;\n@@ -117,6 +131,10 @@\n import static org.apache.usergrid.persistence.SimpleEntityRef.getUuid;\n import static org.apache.usergrid.persistence.SimpleEntityRef.ref;\n import static org.apache.usergrid.persistence.cassandra.ApplicationCF.APPLICATION_AGGREGATE_COUNTERS;\n+import static org.apache.usergrid.persistence.Schema.*;\n+import static org.apache.usergrid.persistence.SimpleEntityRef.ref;\n+import static org.apache.usergrid.persistence.SimpleRoleRef.getIdForGroupIdAndRoleName;\n+import static org.apache.usergrid.persistence.SimpleRoleRef.getIdForRoleName;\n import static org.apache.usergrid.persistence.cassandra.ApplicationCF.ENTITY_COMPOSITE_DICTIONARIES;\n import static org.apache.usergrid.persistence.cassandra.ApplicationCF.ENTITY_COUNTERS;\n import static org.apache.usergrid.persistence.cassandra.ApplicationCF.ENTITY_DICTIONARIES;\n@@ -148,10 +166,11 @@\n public class CpEntityManager implements EntityManager {\n     private static final Logger logger = LoggerFactory.getLogger( CpEntityManager.class );\n \n-    private static final String COLL_SUFFIX = \"zzzcollzzz\";\n     public static final String APPLICATION_COLLECTION = \"application.collection.\";\n     public static final String APPLICATION_ENTITIES = \"application.entities\";\n     public static final long ONE_COUNT = 1L;\n+    private static final String COLL_SUFFIX = \"zzzcollzzz\";\n+    private static final String CONN_SUFFIX = \"zzzconnzzz\"; \n \n     private UUID applicationId;\n     private Application application;\n@@ -226,10 +245,16 @@ static String getCollectionScopeNameFromEntityType( String type) {\n     }\n \n \n-   static String getCollectionScopeNameFromCollectionName( String name ) {\n-       String csn = name + COLL_SUFFIX;\n-       return csn;\n-   }\n+    static String getCollectionScopeNameFromCollectionName( String name ) {\n+        String csn = name + COLL_SUFFIX;\n+        return csn;\n+    }\n+\n+\n+    static String getConnectionScopeName( String connectionType ) {\n+        String csn = connectionType + CONN_SUFFIX;\n+        return csn;\n+    }\n \n \n     @Override\n@@ -515,6 +540,10 @@ private void updateEntityIndexes( Entity entity,\n \n     @Override\n     public void delete( EntityRef entityRef ) throws Exception {\n+        deleteAsync( entityRef ).toBlockingObservable().last();\n+    }\n+\n+    private Observable deleteAsync( EntityRef entityRef ) throws Exception {\n \n         CollectionScope collectionScope = new CollectionScopeImpl( \n             appScope.getApplication(), \n@@ -571,7 +600,9 @@ public void delete( EntityRef entityRef ) throws Exception {\n \n \n             // and finally...\n-            ecm.delete( entityId ).toBlockingObservable().last();\n+            return ecm.delete( entityId );\n+        }else{\n+            return Observable.empty();\n         }\n     }\n \n@@ -1315,127 +1346,295 @@ public Results searchConnectedEntities(\n \n     @Override\n     public Map<String, String> getRoles() throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        return cast( getDictionaryAsMap( getApplicationRef(), DICTIONARY_ROLENAMES ) );\n     }\n \n     @Override\n     public void resetRoles() throws Exception {\n-        // TODO\n+        try {\n+            createRole( \"admin\", \"Administrator\", 0 );\n+        }\n+        catch ( Exception e ) {\n+            logger.error( \"Could not create admin role, may already exist\", e );\n+        }\n+\n+        try {\n+            createRole( \"default\", \"Default\", 0 );\n+        }\n+        catch ( Exception e ) {\n+            logger.error( \"Could not create default role, may already exist\", e );\n+        }\n+\n+        try {\n+            createRole( \"guest\", \"Guest\", 0 );\n+        }\n+        catch ( Exception e ) {\n+            logger.error( \"Could not create guest role, may already exist\", e );\n+        }\n+\n+        try {\n+            grantRolePermissions( \"default\", Arrays.asList(\"get,put,post,delete:/**\") );\n+        }\n+        catch ( Exception e ) {\n+            logger.error( \"Could not populate default role\", e );\n+        }\n+\n+        try {\n+            grantRolePermissions( \"guest\", Arrays.asList( \"post:/users\", \"post:/devices\", \"put:/devices/*\" ) );\n+        }\n+        catch ( Exception e ) {\n+            logger.error( \"Could not populate guest role\", e );\n+        }\n     }\n \n     @Override\n     public Entity createRole(String roleName, String roleTitle, long inactivity) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+\n+        String propertyName = roleName;\n+        UUID ownerId = applicationId;\n+        String batchRoleName = StringUtils.stringOrSubstringAfterLast(roleName.toLowerCase(), ':');\n+        return batchCreateRole(batchRoleName, roleTitle, inactivity, propertyName, ownerId,null);\n     }\n \n+    private Entity batchCreateRole(String roleName, String roleTitle, long inactivity, String propertyName, UUID ownerId,Map<String, Object> additionalProperties ) throws Exception {\n+        UUID timestampUuid = newTimeUUID();\n+        long timestamp = getTimestampInMicros(timestampUuid);\n+\n+        Map<String, Object> properties = new TreeMap<>( CASE_INSENSITIVE_ORDER );\n+        properties.put( PROPERTY_TYPE, Role.ENTITY_TYPE );\n+        properties.put( PROPERTY_NAME, propertyName );\n+        properties.put( \"roleName\", roleName );\n+        properties.put( \"title\", roleTitle );\n+        properties.put( PROPERTY_INACTIVITY, inactivity );\n+        if(additionalProperties!=null) {\n+            for (String key : additionalProperties.keySet()) {\n+                properties.put(key, additionalProperties.get(key));\n+            }\n+        }\n+\n+        UUID id = UUIDGenerator.newTimeUUID();\n+        batchCreate( null, Role.ENTITY_TYPE, null, properties,  id, timestampUuid );\n+\n+        Mutator<ByteBuffer> batch = createMutator( cass.getApplicationKeyspace( applicationId ), be );\n+        addInsertToMutator( batch, ENTITY_DICTIONARIES, key( ownerId, Schema.DICTIONARY_ROLENAMES ),\n+                roleName, roleTitle, timestamp );\n+        addInsertToMutator( batch, ENTITY_DICTIONARIES, key( ownerId, Schema.DICTIONARY_ROLETIMES ),\n+                roleName, inactivity, timestamp );\n+        addInsertToMutator( batch, ENTITY_DICTIONARIES, key(  ownerId, DICTIONARY_SETS ),\n+                Schema.DICTIONARY_ROLENAMES, null, timestamp );\n+\n+        batchExecute( batch, CassandraService.RETRY_COUNT );\n+\n+        return get( id ,Role.class );\n+    }\n+\n+\n     @Override\n     public void grantRolePermission(String roleName, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        permission = permission.toLowerCase();\n+        long timestamp = cass.createTimestamp();\n+        Mutator<ByteBuffer> batch = createMutator( cass.getApplicationKeyspace( applicationId ), be );\n+        addInsertToMutator( batch, ApplicationCF.ENTITY_DICTIONARIES, getRolePermissionsKey( roleName ), permission,\n+                ByteBuffer.allocate( 0 ), timestamp );\n+        batchExecute( batch, CassandraService.RETRY_COUNT );\n     }\n \n     @Override\n     public void grantRolePermissions(\n             String roleName, Collection<String> permissions) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        long timestamp = cass.createTimestamp();\n+        Mutator<ByteBuffer> batch = createMutator( cass.getApplicationKeyspace( applicationId ), be );\n+        for ( String permission : permissions ) {\n+            permission = permission.toLowerCase();\n+            addInsertToMutator( batch, ApplicationCF.ENTITY_DICTIONARIES, getRolePermissionsKey( roleName ), permission,\n+                    ByteBuffer.allocate( 0 ), timestamp );\n+        }\n+        batchExecute( batch, CassandraService.RETRY_COUNT );\n+    }\n+\n+    private Object getRolePermissionsKey( String roleName ) {\n+        return key( getIdForRoleName( roleName ), DICTIONARY_PERMISSIONS );\n+    }\n+\n+    private Object getRolePermissionsKey( UUID groupId, String roleName ) {\n+        return key( getIdForGroupIdAndRoleName( groupId, roleName ), DICTIONARY_PERMISSIONS );\n     }\n \n     @Override\n     public void revokeRolePermission(String roleName, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        permission = permission.toLowerCase();\n+        long timestamp = cass.createTimestamp();\n+        Mutator<ByteBuffer> batch = createMutator( cass.getApplicationKeyspace( applicationId ), be );\n+        CassandraPersistenceUtils\n+                .addDeleteToMutator(batch, ApplicationCF.ENTITY_DICTIONARIES, getRolePermissionsKey(roleName),\n+                        permission, timestamp);\n+        batchExecute( batch, CassandraService.RETRY_COUNT );\n     }\n \n     @Override\n     public Set<String> getRolePermissions(String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        return cass.getAllColumnNames( cass.getApplicationKeyspace( applicationId ), ApplicationCF.ENTITY_DICTIONARIES,\n+                getRolePermissionsKey( roleName ) );\n     }\n \n     @Override\n     public void deleteRole(String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        removeFromDictionary( getApplicationRef(), DICTIONARY_ROLENAMES, roleName );\n+        removeFromDictionary( getApplicationRef(), DICTIONARY_ROLETIMES, roleName );\n+        EntityRef entity = getRoleRef(roleName);\n+        if(entity != null) {\n+            delete(entity);\n+        }\n     }\n \n     @Override\n     public Map<String, String> getGroupRoles(UUID groupId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        return cast(getDictionaryAsMap(new SimpleEntityRef(Group.ENTITY_TYPE, groupId), DICTIONARY_ROLENAMES));\n     }\n \n     @Override\n     public Entity createGroupRole(UUID groupId, String roleName, long inactivity) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        String batchRoleName = StringUtils.stringOrSubstringAfterLast(roleName.toLowerCase(), ':');\n+        String roleTitle = batchRoleName;\n+        String propertyName = groupId + \":\" + batchRoleName;\n+        Map<String, Object> properties = new TreeMap<String, Object>( CASE_INSENSITIVE_ORDER );\n+        properties.put( \"group\", groupId );\n+\n+        Entity entity =  batchCreateRole(roleName,roleTitle,inactivity,propertyName,groupId,properties);\n+        getRelationManager(  new SimpleEntityRef(Group.ENTITY_TYPE,groupId) ).addToCollection(COLLECTION_ROLES, entity);\n+\n+        return entity;\n     }\n \n     @Override\n-    public void grantGroupRolePermission(\n-            UUID groupId, String roleName, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void grantGroupRolePermission( UUID groupId, String roleName, String permission ) throws Exception {\n+        roleName = roleName.toLowerCase();\n+        permission = permission.toLowerCase();\n+        long timestamp = cass.createTimestamp();\n+        Mutator<ByteBuffer> batch = createMutator( cass.getApplicationKeyspace( applicationId ), be );\n+        addInsertToMutator( batch, ApplicationCF.ENTITY_DICTIONARIES, getRolePermissionsKey( groupId, roleName ),\n+                permission, ByteBuffer.allocate( 0 ), timestamp );\n+        batchExecute( batch, CassandraService.RETRY_COUNT );\n     }\n \n+\n     @Override\n-    public void revokeGroupRolePermission(\n-            UUID groupId, String roleName, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void revokeGroupRolePermission( UUID groupId, String roleName, String permission ) throws Exception {\n+        roleName = roleName.toLowerCase();\n+        permission = permission.toLowerCase();\n+        long timestamp = cass.createTimestamp();\n+        Mutator<ByteBuffer> batch = createMutator( cass.getApplicationKeyspace( applicationId ), be );\n+        CassandraPersistenceUtils.addDeleteToMutator( batch, ApplicationCF.ENTITY_DICTIONARIES,\n+                getRolePermissionsKey( groupId, roleName ), permission, timestamp );\n+        batchExecute( batch, CassandraService.RETRY_COUNT );\n     }\n \n     @Override\n     public Set<String> getGroupRolePermissions(UUID groupId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        return cass.getAllColumnNames( cass.getApplicationKeyspace( applicationId ), ApplicationCF.ENTITY_DICTIONARIES,\n+                getRolePermissionsKey( groupId, roleName ) );\n     }\n \n     @Override\n     public void deleteGroupRole(UUID groupId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        removeFromDictionary( new SimpleEntityRef(Group.ENTITY_TYPE ,groupId ), DICTIONARY_ROLENAMES, roleName );\n+        cass.deleteRow( cass.getApplicationKeyspace( applicationId ), ApplicationCF.ENTITY_DICTIONARIES,\n+                getIdForGroupIdAndRoleName( groupId, roleName ) );\n     }\n \n     @Override\n-    public Set<String> getUserRoles(UUID userId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public Set<String> getUserRoles( UUID userId ) throws Exception {\n+        return cast( getDictionaryAsSet( userRef( userId ), DICTIONARY_ROLENAMES ) );\n     }\n \n     @Override\n     public void addUserToRole(UUID userId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        addToDictionary( userRef(userId), DICTIONARY_ROLENAMES, roleName, roleName );\n+        addToCollection( userRef( userId ), COLLECTION_ROLES, getRoleRef(roleName) );\n     }\n \n+    private EntityRef userRef(UUID userId){\n+        return new SimpleEntityRef(User.ENTITY_TYPE,userId);\n+    }\n     @Override\n     public void removeUserFromRole(UUID userId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        removeFromDictionary( userRef(userId), DICTIONARY_ROLENAMES, roleName );\n+        removeFromCollection( userRef(userId), COLLECTION_ROLES, getRoleRef(roleName) );\n     }\n \n     @Override\n     public Set<String> getUserPermissions(UUID userId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        return cast( getDictionaryAsSet( new SimpleEntityRef( User.ENTITY_TYPE,userId ), Schema.DICTIONARY_PERMISSIONS ) );\n     }\n \n     @Override\n     public void grantUserPermission(UUID userId, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        permission = permission.toLowerCase();\n+        addToDictionary( userRef(userId), DICTIONARY_PERMISSIONS, permission );\n     }\n \n     @Override\n-    public void revokeUserPermission(UUID userId, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void revokeUserPermission( UUID userId, String permission ) throws Exception {\n+        permission = permission.toLowerCase();\n+        removeFromDictionary( userRef(userId), DICTIONARY_PERMISSIONS, permission );\n     }\n \n+\n     @Override\n-    public Map<String, String> getUserGroupRoles(UUID userId, UUID groupId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public Map<String, String> getUserGroupRoles( UUID userId, UUID groupId ) throws Exception {\n+        // TODO this never returns anything - write path not invoked\n+        EntityRef userRef =  userRef(userId);\n+        return cast( getDictionaryAsMap( userRef, DICTIONARY_ROLENAMES ) );\n     }\n \n+\n     @Override\n     public void addUserToGroupRole(UUID userId, UUID groupId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        EntityRef userRef =  userRef(userId);\n+        EntityRef roleRef = getRoleRef(roleName);\n+        addToDictionary( userRef, DICTIONARY_ROLENAMES, roleName, roleName );\n+        addToCollection( userRef, COLLECTION_ROLES, roleRef );\n+        addToCollection( roleRef, COLLECTION_USERS, userRef );\n     }\n \n     @Override\n     public void removeUserFromGroupRole(UUID userId, UUID groupId, String roleName) \n             throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        roleName = roleName.toLowerCase();\n+        EntityRef memberRef = userRef(userId);\n+        EntityRef roleRef = getRoleRef(roleName);\n+        removeFromDictionary( memberRef, DICTIONARY_ROLENAMES, roleName );\n+        removeFromCollection( memberRef, COLLECTION_ROLES, roleRef );\n+        removeFromCollection( roleRef, COLLECTION_USERS, userRef( userId ) );\n     }\n \n     @Override\n     public Results getUsersInGroupRole(\n             UUID groupId, String roleName, Level level) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        return this.getCollection( getRoleRef(roleName), COLLECTION_USERS, null, 10000, level, false );\n+    }\n+    private EntityRef getRoleRef(String roleName) throws Exception{\n+        Results results = this.searchCollection(\n+                new SimpleEntityRef(\"application\", applicationId),\n+                Schema.defaultCollectionName(Role.ENTITY_TYPE),\n+                Query.findForProperty(\"roleName\", roleName)\n+        );\n+        Iterator<Entity> iterator = results.iterator();\n+        EntityRef roleRef = null;\n+        while(iterator.hasNext()) {\n+            roleRef = iterator.next();\n+        }\n+        return roleRef;\n     }\n \n     @Override\n@@ -1457,6 +1656,7 @@ private void incrementAggregateCounters( UUID userId, UUID groupId, String categ\n \n             batchExecute( m, CassandraService.RETRY_COUNT );\n         }\n+\n     }\n \n     @Override\n@@ -1465,6 +1665,7 @@ public Results getAggregateCounters(\n             CounterResolution resolution, long start, long finish, boolean pad) {\n         return this.getAggregateCounters(\n                 userId, groupId, null, category, counterName, resolution, start, finish, pad );\n+\n     }\n \n     @Override\n@@ -1502,6 +1703,7 @@ public Results getAggregateCounters(\n             }\n         }\n         return Results.fromCounters( new AggregateCounterSet( counterName, userId, groupId, category, counters ) );\n+\n     }\n \n     @Override\n@@ -1587,8 +1789,9 @@ public int compare( AggregateCounterSet o1, AggregateCounterSet o2 ) {\n         return Results.fromCounters( countSets );\n     }\n \n+\n     @Override\n-    public EntityRef getUserByIdentifier(Identifier identifier) throws Exception {\n+    public EntityRef getUserByIdentifier( Identifier identifier ) throws Exception {\n         if ( identifier == null ) {\n             return null;\n         }\n@@ -1622,8 +1825,9 @@ public EntityRef getUserByIdentifier(Identifier identifier) throws Exception {\n         return null;\n     }\n \n+\n     @Override\n-    public EntityRef getGroupByIdentifier(Identifier identifier) throws Exception {\n+    public EntityRef getGroupByIdentifier( Identifier identifier ) throws Exception {\n         if ( identifier == null ) {\n             return null;\n         }\n@@ -1644,6 +1848,7 @@ public EntityRef getGroupByIdentifier(Identifier identifier) throws Exception {\n         Set<String> nameSet = cast( getDictionaryAsSet( getApplicationRef(), Schema.DICTIONARY_COUNTERS ) );\n         names.addAll( nameSet );\n         return names;\n+\n     }\n \n     @Override\n@@ -1658,23 +1863,27 @@ public EntityRef getGroupByIdentifier(Identifier identifier) throws Exception {\n             counters.put( column.getName(), column.getValue() );\n         }\n         return counters;\n+\n     }\n \n     @Override\n     public Map<String, Long> getApplicationCounters() throws Exception {\n         return getEntityCounters( applicationId );\n+\n     }\n \n     @Override\n     public void incrementAggregateCounters(\n             UUID userId, UUID groupId, String category, Map<String, Long> counters) {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+\n+        // TODO: add an implementation here...\n     }\n \n     @Override\n     public boolean isPropertyValueUniqueForEntity(\n             String entityType, String propertyName, Object propertyValue) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+\n+        return true; // TODO: is it OK to rely on Core Persistence write-time check for this?\n     }\n \n     @Override\n@@ -1719,47 +1928,101 @@ public Results getEntities(List<UUID> ids, String type) {\n \n     @Override\n     public Map<String, Role> getRolesWithTitles(Set<String> roleNames) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        Map<String, Role> rolesWithTitles = new HashMap<String, Role>();\n+\n+        Map<String, Object> nameResults = null;\n+\n+        if ( roleNames != null ) {\n+            nameResults = getDictionaryElementValues( getApplicationRef(), DICTIONARY_ROLENAMES,\n+                    roleNames.toArray(new String[roleNames.size()]));\n+        }\n+        else {\n+            nameResults = cast( getDictionaryAsMap( getApplicationRef(), DICTIONARY_ROLENAMES ) );\n+            roleNames = nameResults.keySet();\n+        }\n+        Map<String, Object> timeResults = getDictionaryElementValues( getApplicationRef(), DICTIONARY_ROLETIMES,\n+                roleNames.toArray(new String[roleNames.size()]));\n+\n+        for ( String roleName : roleNames ) {\n+\n+            String savedTitle = string( nameResults.get( roleName ) );\n+\n+            // no title, skip the role\n+            if ( savedTitle == null ) {\n+                continue;\n+            }\n+\n+            Role newRole = new Role();\n+            newRole.setName( roleName );\n+            newRole.setTitle( savedTitle );\n+            newRole.setInactivity( getLong( timeResults.get( roleName ) ) );\n+\n+            rolesWithTitles.put( roleName, newRole );\n+        }\n+\n+        return rolesWithTitles;\n     }\n \n     @Override\n     public String getRoleTitle(String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+        String title = string( getDictionaryElementValue( getApplicationRef(), DICTIONARY_ROLENAMES, roleName ) );\n+        if ( title == null ) {\n+            title = roleName;\n+        }\n+        return title;\n     }\n \n+    @SuppressWarnings( \"unchecked\" )\n     @Override\n-    public Map<String, Role> getUserRolesWithTitles(UUID userId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public Map<String, Role> getUserRolesWithTitles( UUID userId ) throws Exception {\n+        return getRolesWithTitles(\n+                ( Set<String> ) cast( getDictionaryAsSet( userRef( userId ), DICTIONARY_ROLENAMES ) ) );\n     }\n \n+    @SuppressWarnings( \"unchecked\" )\n     @Override\n-    public Map<String, Role> getGroupRolesWithTitles(UUID userId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public Map<String, Role> getGroupRolesWithTitles( UUID groupId ) throws Exception {\n+        return getRolesWithTitles(\n+                ( Set<String> ) cast( getDictionaryAsSet( groupRef( groupId ), DICTIONARY_ROLENAMES ) ) );\n     }\n \n     @Override\n-    public void addGroupToRole(UUID userId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void addGroupToRole( UUID groupId, String roleName ) throws Exception {\n+        roleName = roleName.toLowerCase();\n+        addToDictionary( groupRef( groupId ), DICTIONARY_ROLENAMES, roleName, roleName );\n+        addToCollection( groupRef( groupId ), COLLECTION_ROLES, getRoleRef( roleName ) );\n     }\n \n+\n     @Override\n-    public void removeGroupFromRole(UUID userId, String roleName) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void removeGroupFromRole( UUID groupId, String roleName ) throws Exception {\n+        roleName = roleName.toLowerCase();\n+        removeFromDictionary( groupRef( groupId ), DICTIONARY_ROLENAMES, roleName );\n+        removeFromCollection( groupRef( groupId ), COLLECTION_ROLES, getRoleRef( roleName ) );\n     }\n \n+\n     @Override\n-    public Set<String> getGroupPermissions(UUID groupId) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public Set<String> getGroupPermissions( UUID groupId ) throws Exception {\n+        return cast( getDictionaryAsSet( groupRef( groupId ), Schema.DICTIONARY_PERMISSIONS ) );\n     }\n \n+\n     @Override\n-    public void grantGroupPermission(UUID groupId, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void grantGroupPermission( UUID groupId, String permission ) throws Exception {\n+        permission = permission.toLowerCase();\n+        addToDictionary( groupRef( groupId ), DICTIONARY_PERMISSIONS, permission );\n     }\n \n+\n     @Override\n-    public void revokeGroupPermission(UUID groupId, String permission) throws Exception {\n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n+    public void revokeGroupPermission( UUID groupId, String permission ) throws Exception {\n+        permission = permission.toLowerCase();\n+        removeFromDictionary( groupRef( groupId ), DICTIONARY_PERMISSIONS, permission );\n+    }\n+\n+    private EntityRef groupRef(UUID groupId){\n+        return new SimpleEntityRef( Group.ENTITY_TYPE, groupId );\n     }\n \n     @Override\n@@ -2001,6 +2264,7 @@ private void incrementEntityCollection( String collection_name, long cassandraTi\n         }\n     }\n \n+\n     private void handleWriteUniqueVerifyException( Entity entity, WriteUniqueVerifyException wuve) \n             throws DuplicateUniquePropertyExistsException {\n \n@@ -2012,15 +2276,6 @@ private void handleWriteUniqueVerifyException( Entity entity, WriteUniqueVerifyE\n             entity.getType(), conflict.getName(), conflict.getValue()); \n     }\n     \n-\n-    @Override\n-    public void batchCreateRole(\n-            Mutator<ByteBuffer> batch, UUID groupId, String roleName, String roleTitle, \n-            long inactivity, RoleRef roleRef, UUID timestampUuid) throws Exception {\n-        \n-        throw new UnsupportedOperationException(\"Not supported yet.\"); \n-    }\n-\n     @Override\n     public Mutator<ByteBuffer> batchSetProperty(\n             Mutator<ByteBuffer> batch, EntityRef entity, String propertyName, Object propertyValue, ",
                "additions": 324,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "status": "modified",
                "changes": 393,
                "deletions": 69,
                "sha": "c600554a1b70ba021b0f963b55c49aa44949eec0",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -233,8 +233,7 @@ public UUID initializeApplication( String organizationName, UUID applicationId,\n         if ( orgUuid == null ) {\n           \n             // organization does not exist, create it.\n-            Entity orgInfoEntity = new Entity(\n-                new SimpleId(UUIDGenerator.newTimeUUID(), \"organization\" ));\n+            Entity orgInfoEntity = new Entity(generateOrgId( UUIDGenerator.newTimeUUID() ));\n \n             orgUuid = orgInfoEntity.getId().getUuid();\n \n@@ -258,8 +257,7 @@ public UUID initializeApplication( String organizationName, UUID applicationId,\n         }\n         properties.put( PROPERTY_NAME, appName );\n \n-        Entity appInfoEntity = new Entity(\n-            new SimpleId(UUIDGenerator.newTimeUUID(), \"application\" ));\n+        Entity appInfoEntity = new Entity(generateApplicationId( UUIDGenerator.newTimeUUID() ));\n \n         long timestamp = System.currentTimeMillis();\n         appInfoEntity.setField( new LongField( PROPERTY_CREATED, (long)(timestamp / 1000)));\n@@ -290,22 +288,11 @@ public UUID initializeApplication( String organizationName, UUID applicationId,\n \n     public ApplicationScope getApplicationScope( UUID applicationId ) {\n \n-        Query q = Query.fromQL( PROPERTY_UUID + \" = '\" + applicationId.toString() + \"'\");\n+        //We can always generate a scope, it doesn't matter if  the application exists yet or not.\n \n-        EntityCollectionManager em= getManagerCache().getEntityCollectionManager(SYSTEM_APP_SCOPE);\n-        EntityIndex ei = getManagerCache().getEntityIndex( SYSTEM_APPS_INDEX_SCOPE );\n-        CandidateResults results = ei.search( q );\n-\n-        if ( results.isEmpty() ) {\n-            return null;\n-        }\n-\n-        CandidateResult candidateResult = results.iterator().next(); \n-\n-        Entity appEntity = em.load( candidateResult.getId() ).toBlockingObservable().last();\n+        final ApplicationScopeImpl scope = new ApplicationScopeImpl( generateApplicationId( applicationId ) );\n \n-        return new ApplicationScopeImpl(\n-            new SimpleId( appEntity.getId().getUuid(), \"application\"));\n+        return scope;\n     }\n     \n \n@@ -379,7 +366,7 @@ public UUID lookupApplication( String name) throws Exception {\n     \n     @Override\n     public void setup() throws Exception {\n-        // no op?\n+        getSetup().init();\n     }\n \n     \n@@ -489,6 +476,11 @@ public ApplicationContext getApplicationContext() {\n     @Override\n     public void setApplicationContext( ApplicationContext applicationContext ) throws BeansException {\n         this.applicationContext = applicationContext;\n+        try {\n+            setup();\n+        } catch (Exception ex) {\n+            logger.error(\"Error setting up EMF\", ex);\n+        }\n     }\n \n     /**\n@@ -511,6 +503,14 @@ public UUID getDefaultAppId() {\n         return DEFAULT_APPLICATION_ID; \n     }\n \n+    private Id generateOrgId(UUID id){\n+        return new SimpleId( id, \"organization\" );\n+    }\n+\n+\n+    private Id generateApplicationId(UUID id){\n+        return new SimpleId( id, \"application\" );\n+    }\n     \n     /**\n      * Gets the setup.",
                "additions": 19,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java",
                "status": "modified",
                "changes": 38,
                "deletions": 19,
                "sha": "c2ab923c0ff397b4aca8684827d1d8e45907a8a3",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManagerFactory.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -64,7 +64,7 @@\n import org.apache.usergrid.persistence.geo.model.Point;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.GraphManager;\n-import org.apache.usergrid.persistence.graph.impl.SimpleMarkedEdge;\n+import org.apache.usergrid.persistence.graph.impl.SimpleEdge;\n import org.apache.usergrid.persistence.graph.impl.SimpleSearchByEdge;\n import org.apache.usergrid.persistence.graph.impl.SimpleSearchByEdgeType;\n import org.apache.usergrid.persistence.graph.impl.SimpleSearchEdgeType;\n@@ -78,7 +78,6 @@\n import org.apache.usergrid.persistence.index.query.Query.Level;\n import org.apache.usergrid.persistence.model.entity.Id;\n import org.apache.usergrid.persistence.model.entity.SimpleId;\n-import org.apache.usergrid.persistence.model.util.UUIDGenerator;\n \n import org.apache.usergrid.persistence.query.ir.AllNode;\n import org.apache.usergrid.persistence.query.ir.NameIdentifierNode;\n@@ -281,7 +280,7 @@ public String getConnectionName( String edgeType ) {\n             String edgeType = edgeTypes.next();\n \n             Observable<Edge> edges = gm.loadEdgesToTarget( new SimpleSearchByEdgeType( \n-                cpHeadEntity.getId(), edgeType, cpHeadEntity.getVersion(), null ));\n+                cpHeadEntity.getId(), edgeType, Long.MAX_VALUE, null ));\n \n             Iterator<Edge> iter = edges.toBlockingObservable().getIterator();\n             while ( iter.hasNext() ) {\n@@ -328,7 +327,7 @@ public boolean isCollectionMember(String collName, EntityRef entity) throws Exce\n                     new SimpleId(headEntity.getUuid(), headEntity.getType()), \n                     collName,  \n                     entityId, \n-                    UUIDGenerator.newTimeUUID(), \n+                    Long.MAX_VALUE,\n                     null));\n \n         return edges.toBlockingObservable().firstOrDefault(null) != null;\n@@ -403,9 +402,9 @@ public Entity addToCollection(String collName, EntityRef memberRef) throws Excep\n         }\n \n         // create graph edge connection from head entity to member entity\n-        Edge edge = new SimpleMarkedEdge( \n+        Edge edge = new SimpleEdge(\n             cpHeadEntity.getId(), getEdgeTypeFromCollectionName( collName ), memberEntity.getId(), \n-            UUIDGenerator.newTimeUUID(), false );\n+           memberEntity.getId().getUuid().timestamp() );\n \n         GraphManager gm = managerCache.getGraphManager(applicationScope);\n         gm.writeEdge(edge).toBlockingObservable().last();\n@@ -539,9 +538,9 @@ public void removeFromCollection(String collName, EntityRef memberRef) throws Ex\n         ei.deindex( memberEntity );\n \n         // remove collection edge\n-        Edge edge = new SimpleMarkedEdge( cpHeadEntity.getId(), \n+        Edge edge = new SimpleEdge( cpHeadEntity.getId(),\n             getEdgeTypeFromCollectionName( collName ), memberEntity.getId(), \n-            UUIDGenerator.newTimeUUID(), false );\n+           memberEntity.getId().getUuid().timestamp() );\n         GraphManager gm = managerCache.getGraphManager(applicationScope);\n         gm.deleteEdge(edge).toBlockingObservable().last();\n \n@@ -631,8 +630,8 @@ public ConnectionRef createConnection(\n                 .toBlockingObservable().last();\n \n         // create graph edge connection from head entity to member entity\n-        Edge edge = new SimpleMarkedEdge( cpHeadEntity.getId(), connectionType, \n-            targetEntity.getId(), UUIDGenerator.newTimeUUID(), false );\n+        Edge edge = new SimpleEdge( cpHeadEntity.getId(), connectionType,\n+            targetEntity.getId(), System.currentTimeMillis() );\n \n         GraphManager gm = managerCache.getGraphManager(applicationScope);\n         gm.writeEdge(edge).toBlockingObservable().last();\n@@ -641,7 +640,7 @@ public ConnectionRef createConnection(\n         IndexScope indexScope = new IndexScopeImpl(\n             applicationScope.getApplication(), \n             cpHeadEntity.getId(), \n-            CpEntityManager.getCollectionScopeNameFromEntityType( connectionType ) );\n+            CpEntityManager.getConnectionScopeName( connectionType ));\n         EntityIndex ei = managerCache.getEntityIndex(indexScope);\n         ei.index( targetEntity );\n \n@@ -719,23 +718,59 @@ public void deleteConnection(ConnectionRef connectionRef) throws Exception {\n         throw new UnsupportedOperationException(\"Not supported yet.\"); \n     }\n \n+\n     @Override\n-    public Results getConnectedEntities(String connectionType, String connectedEntityType, \n-            Level resultsLevel) throws Exception {\n+    public Results getConnectedEntities(\n+        String connectionType, String connectedEntityType, Level resultsLevel) throws Exception {\n+\n+        Results raw = null;\n \n         Query query = new Query();\n         query.setConnectionType(connectionType);\n         query.setEntityType(connectedEntityType);\n-        return searchConnectedEntities( query );\n+\n+        if ( connectionType == null ) {\n+            raw = searchConnectedEntities( query );\n+\n+        } else {\n+\n+            headEntity = em.validate( headEntity );\n+\n+            IndexScope indexScope = new IndexScopeImpl(\n+                applicationScope.getApplication(), \n+                cpHeadEntity.getId(), \n+                CpEntityManager.getConnectionScopeName( connectionType ));\n+            EntityIndex ei = managerCache.getEntityIndex(indexScope);\n+        \n+            logger.debug(\"Searching connections from all-types scope {}:{}:{}\", new String[] { \n+                indexScope.getApplication().toString(), \n+                indexScope.getOwner().toString(),\n+                indexScope.getName()}); \n+\n+            query = adjustQuery( query );\n+            CandidateResults crs = ei.search( query );\n+\n+            raw = buildResults( query , crs, query.getConnectionType() );\n+        }\n+\n+        List<ConnectionRef> crefs = new ArrayList<ConnectionRef>();\n+        for ( Entity e : raw.getEntities() ) {\n+            ConnectionRef cref = new ConnectionRefImpl( headEntity, connectionType, e );\n+            crefs.add( cref );\n+        }\n+\n+        return Results.fromConnections( crefs );\n     }\n \n+\n     @Override\n     public Results getConnectingEntities(String connectionType, String connectedEntityType, \n             Level resultsLevel) throws Exception {\n \n         return getConnectingEntities( connectionType, connectedEntityType, resultsLevel, -1 );\n     }\n \n+\n     @Override\n     public Results getConnectingEntities(String connectionType, String entityType, \n             Level level, int count) throws Exception {\n@@ -901,21 +936,6 @@ private Results buildResults(Query query, CandidateResults crs, String collName\n \n         } else {\n \n-            CollectionScope collScope = new CollectionScopeImpl( \n-                applicationScope.getApplication(), \n-                applicationScope.getApplication(), \n-                CpEntityManager.getCollectionScopeNameFromEntityType( query.getEntityType() ));\n-            EntityCollectionManager ecm = managerCache.getEntityCollectionManager(collScope);\n-\n-            if ( logger.isDebugEnabled() ) {\n-                logger.debug(\"Loading entities from scope\\n   app {}\\n   owner {}\\n   name {}\", \n-                new Object[] { \n-                    collScope.getApplication(), \n-                    collScope.getOwner(), \n-                    collScope.getName() \n-                });\n-            }\n-\n             // first, build map of latest versions of entities\n             Map<Id, org.apache.usergrid.persistence.model.entity.Entity> latestVersions = \n                 new LinkedHashMap<Id, org.apache.usergrid.persistence.model.entity.Entity>();\n@@ -925,18 +945,33 @@ private Results buildResults(Query query, CandidateResults crs, String collName\n \n                 CandidateResult cr = iter.next();\n \n+                CollectionScope collScope = new CollectionScopeImpl( \n+                    applicationScope.getApplication(), \n+                    applicationScope.getApplication(), \n+                    CpEntityManager.getCollectionScopeNameFromEntityType( cr.getId().getType() ));\n+                EntityCollectionManager ecm = managerCache.getEntityCollectionManager(collScope);\n+\n+                if ( logger.isDebugEnabled() ) {\n+                    logger.debug(\"Loading entity {} from scope\\n   app {}\\n   owner {}\\n   name {}\", \n+                    new Object[] { \n+                        cr.getId(),\n+                        collScope.getApplication(), \n+                        collScope.getOwner(), \n+                        collScope.getName() \n+                    });\n+                }\n+\n                 org.apache.usergrid.persistence.model.entity.Entity e =\n                     ecm.load( cr.getId() ).toBlockingObservable().last();\n \n                 if ( cr.getVersion().compareTo( e.getVersion()) < 0 )  {\n-                    logger.debug(\"Stale version uuid:{} type:{} v:{}\", \n+                    logger.debug(\"Stale version uuid:{} type:{} version:{}\", \n                         new Object[] {cr.getId().getUuid(), cr.getId().getType(), cr.getVersion()});\n                     continue;\n                 }\n \n                 org.apache.usergrid.persistence.model.entity.Entity alreadySeen = \n-                    latestVersions.get( e.getId() );\n-\n+                    latestVersions.get( e.getId() ); \n                 if ( alreadySeen == null ) { // never seen it, so add to map\n                     latestVersions.put( e.getId(), e);\n \n@@ -980,9 +1015,8 @@ public void batchUpdateSetIndexes( Mutator<ByteBuffer> batch, String setName, Ob\n \n         elementValue = getDefaultSchema().validateEntitySetValue( entity.getType(), setName, elementValue );\n \n-        IndexUpdate indexUpdate =\n-                batchStartIndexUpdate( batch, entity, setName, elementValue, timestampUuid, true, true, removeFromSet,\n-                        false );\n+        IndexUpdate indexUpdate = batchStartIndexUpdate( batch, entity, setName, elementValue, \n+                timestampUuid, true, true, removeFromSet, false );\n \n         // Update collections\n         Map<String, Set<CollectionInfo>> containers =\n@@ -1027,16 +1061,17 @@ public void batchUpdateSetIndexes( Mutator<ByteBuffer> batch, String setName, Ob\n      * @throws Exception the exception\n      */\n     @Metered(group = \"core\", name = \"RelationManager_batchUpdateCollectionIndex\")\n-    public IndexUpdate batchUpdateCollectionIndex( IndexUpdate indexUpdate, EntityRef owner, String collectionName )\n+    public IndexUpdate batchUpdateCollectionIndex( \n+            IndexUpdate indexUpdate, EntityRef owner, String collectionName )\n             throws Exception {\n \n         logger.debug( \"batchUpdateCollectionIndex\" );\n \n         Entity indexedEntity = indexUpdate.getEntity();\n \n-        String bucketId = indexBucketLocator\n-                .getBucket( applicationId, IndexBucketLocator.IndexType.COLLECTION, indexedEntity.getUuid(), indexedEntity.getType(),\n-                        indexUpdate.getEntryName() );\n+        String bucketId = indexBucketLocator .getBucket( applicationId, \n+                IndexBucketLocator.IndexType.COLLECTION, indexedEntity.getUuid(), \n+                indexedEntity.getType(), indexUpdate.getEntryName() );\n \n         // the root name without the bucket\n         // entity_id,collection_name,prop_name,\n@@ -1054,22 +1089,23 @@ public IndexUpdate batchUpdateCollectionIndex( IndexUpdate indexUpdate, EntityRe\n \n                 index_key = key( index_name, bucketId );\n \n-                addDeleteToMutator( indexUpdate.getBatch(), ENTITY_INDEX, index_key, entry.getIndexComposite(),\n-                        indexUpdate.getTimestamp() );\n+                addDeleteToMutator( indexUpdate.getBatch(), ENTITY_INDEX, index_key, \n+                        entry.getIndexComposite(), indexUpdate.getTimestamp() );\n \n                 if ( \"location.coordinates\".equals( entry.getPath() ) ) {\n-                    EntityLocationRef loc = new EntityLocationRef( indexUpdate.getEntity(), entry.getTimestampUuid(),\n-                            entry.getValue().toString() );\n-                    batchRemoveLocationFromCollectionIndex( indexUpdate.getBatch(), indexBucketLocator, applicationId,\n-                            index_name, loc );\n+                    EntityLocationRef loc = new EntityLocationRef( indexUpdate.getEntity(), \n+                            entry.getTimestampUuid(), entry.getValue().toString() );\n+                    batchRemoveLocationFromCollectionIndex( indexUpdate.getBatch(), \n+                            indexBucketLocator, applicationId, index_name, loc );\n                 }\n             }\n             else {\n                 logger.error( \"Unexpected condition - deserialized property value is null\" );\n             }\n         }\n \n-        if ( ( indexUpdate.getNewEntries().size() > 0 ) && ( !indexUpdate.isMultiValue() || ( indexUpdate.isMultiValue()\n+        if ( ( indexUpdate.getNewEntries().size() > 0 ) \n+                && ( !indexUpdate.isMultiValue() || ( indexUpdate.isMultiValue()\n                 && !indexUpdate.isRemoveListEntry() ) ) ) {\n \n             for ( IndexUpdate.IndexEntry indexEntry : indexUpdate.getNewEntries() ) {\n@@ -1082,14 +1118,15 @@ public IndexUpdate batchUpdateCollectionIndex( IndexUpdate indexUpdate, EntityRe\n \n                 // int i = 0;\n \n-                addInsertToMutator( indexUpdate.getBatch(), ENTITY_INDEX, index_key, indexEntry.getIndexComposite(),\n-                        null, indexUpdate.getTimestamp() );\n+                addInsertToMutator( indexUpdate.getBatch(), ENTITY_INDEX, index_key, \n+                        indexEntry.getIndexComposite(), null, indexUpdate.getTimestamp() );\n \n                 if ( \"location.coordinates\".equals( indexEntry.getPath() ) ) {\n-                    EntityLocationRef loc =\n-                            new EntityLocationRef( indexUpdate.getEntity(), indexEntry.getTimestampUuid(),\n-                                    indexEntry.getValue().toString() );\n-                    batchStoreLocationInCollectionIndex( indexUpdate.getBatch(), indexBucketLocator, applicationId,\n+                    EntityLocationRef loc = new EntityLocationRef( \n+                            indexUpdate.getEntity(), indexEntry.getTimestampUuid(),\n+                            indexEntry.getValue().toString() );\n+                    batchStoreLocationInCollectionIndex( indexUpdate.getBatch(), \n+                            indexBucketLocator, applicationId,\n                             index_name, indexedEntity.getUuid(), loc );\n                 }\n ",
                "additions": 89,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "status": "modified",
                "changes": 141,
                "deletions": 52,
                "sha": "0b5dc0d6671be3a42b6689519771b03eab1f1cf8",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpRelationManager.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -34,8 +34,11 @@\n import static org.apache.usergrid.persistence.cassandra.CassandraService.DEFAULT_APPLICATION;\n import static org.apache.usergrid.persistence.cassandra.CassandraService.DEFAULT_ORGANIZATION;\n import static org.apache.usergrid.persistence.cassandra.CassandraService.MANAGEMENT_APPLICATION;\n+import static org.apache.usergrid.persistence.cassandra.CassandraService.PRINCIPAL_TOKEN_CF;\n+import static org.apache.usergrid.persistence.cassandra.CassandraService.PROPERTIES_CF;\n import static org.apache.usergrid.persistence.cassandra.CassandraService.STATIC_APPLICATION_KEYSPACE;\n import static org.apache.usergrid.persistence.cassandra.CassandraService.SYSTEM_KEYSPACE;\n+import static org.apache.usergrid.persistence.cassandra.CassandraService.TOKENS_CF;\n import static org.apache.usergrid.persistence.cassandra.CassandraService.USE_VIRTUAL_KEYSPACES;\n import static org.apache.usergrid.persistence.cassandra.CassandraService.keyspaceForApplication;\n import org.apache.usergrid.persistence.cassandra.Setup;\n@@ -139,7 +142,22 @@ public static Application getDefaultApp() {\n \n     @Override\n     public void setupSystemKeyspace() throws Exception {\n-        // no-op\n+\n+        logger.info( \"Initialize system keyspace\" );\n+\n+        cass.createColumnFamily( SYSTEM_KEYSPACE, createColumnFamilyDefinition( \n+                SYSTEM_KEYSPACE, APPLICATIONS_CF, ComparatorType.BYTESTYPE ) );\n+\n+        cass.createColumnFamily( SYSTEM_KEYSPACE, createColumnFamilyDefinition( \n+                SYSTEM_KEYSPACE, PROPERTIES_CF, ComparatorType.BYTESTYPE ) );\n+\n+        cass.createColumnFamily( SYSTEM_KEYSPACE, createColumnFamilyDefinition( \n+                SYSTEM_KEYSPACE, TOKENS_CF, ComparatorType.BYTESTYPE ) );\n+\n+        cass.createColumnFamily( SYSTEM_KEYSPACE, createColumnFamilyDefinition( \n+                SYSTEM_KEYSPACE, PRINCIPAL_TOKEN_CF, ComparatorType.UUIDTYPE ) );\n+\n+        logger.info( \"System keyspace initialized\" );\n     }\n \n     ",
                "additions": 19,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpSetup.java",
                "status": "modified",
                "changes": 20,
                "deletions": 1,
                "sha": "1b63ce78db132433a17b89c15e4214e127f56aaf",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpSetup.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/corepersistence/CpSetup.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/corepersistence/CpSetup.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -604,10 +604,6 @@ public boolean isPropertyValueUniqueForEntity(\n     <A extends Entity> A batchCreate(Mutator<ByteBuffer> m, String entityType, \n             Class<A> entityClass, Map<String, Object> properties, \n             UUID importId, UUID timestampUuid) throws Exception;\n-\n-    void batchCreateRole(Mutator<ByteBuffer> batch, UUID groupId, String roleName, \n-            String roleTitle, long inactivity, RoleRef roleRef, UUID timestampUuid) throws Exception;\n-\n     /**\n      * Batch dictionary property.\n      *",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "status": "modified",
                "changes": 4,
                "deletions": 4,
                "sha": "750efc011fd973f2025af957b3932cdf0c1cd9a1",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "filename": "stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/main/java/org/apache/usergrid/persistence/EntityManager.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -73,6 +73,8 @@ public void testEntityConnectionsSimple() throws Exception {\n \n         em.createConnection( firstUserEntity, \"likes\", secondUserEntity );\n \n+        em.refreshIndex();\n+\n         Results r = em.getConnectedEntities( firstUserEntity, \"likes\", null, Level.IDS );\n \n         List<ConnectionRef> connections = r.getConnections();\n@@ -139,6 +141,8 @@ public void testEntityConnections() throws Exception {\n         LOG.info( \"\\n\\nConnecting \" + awardA.getUuid() + \" \\\"awarded\\\" \" + catB.getUuid() + \"\\n\" );\n         em.createConnection( awardA, \"awarded\", catB );\n \n+        em.refreshIndex();\n+\n         // List forward connections for cat A\n \n         // Thread.sleep(5000);\n@@ -158,6 +162,8 @@ public void testEntityConnections() throws Exception {\n         LOG.info( \"\\n\\nConnecting \" + awardA.getUuid() + \" \\\"awarded\\\" \" + catA.getUuid() + \"\\n\" );\n         em.createConnection( awardA, \"awarded\", catA );\n \n+        em.refreshIndex();\n+\n         // List forward connections for cat A\n \n         testEntityConnections( applicationId, catA.getUuid(), \"cat\", 1 );\n@@ -266,6 +272,7 @@ public void testEntityConnectionsMembership() throws Exception {\n \n         em.createConnection( secondUserEntity, \"likes\", arrogantbutcher );\n \n+        em.refreshIndex();\n \n         Results r = em.getConnectedEntities( firstUserEntity, \"likes\", \"restaurant\", Level.IDS );\n ",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "status": "modified",
                "changes": 7,
                "deletions": 0,
                "sha": "f442cd5b19654fb10c30fc477dc04e17fbce1ecb",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/EntityConnectionsIT.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -147,8 +147,10 @@ public void testPermissions() throws Exception {\n         assertEquals( \"proper number of group roles not set\", 1, roles.size() );\n         dump( \"group roles\", roles );\n \n+        em.refreshIndex();\n         em.addUserToGroupRole( user.getUuid(), group.getUuid(), \"admin\" );\n \n+        em.refreshIndex();\n         Results r = em.getUsersInGroupRole( group.getUuid(), \"admin\", Level.ALL_PROPERTIES );\n         assertEquals( \"proper number of users in group role not set\", 1, r.size() );\n         dump( \"entities\", r.getEntities() );",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/test/java/org/apache/usergrid/persistence/PermissionsIT.java",
                "status": "modified",
                "changes": 2,
                "deletions": 0,
                "sha": "87aca6453170256128fa1b95f38aafbffda28bcc",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/test/java/org/apache/usergrid/persistence/PermissionsIT.java",
                "filename": "stack/core/src/test/java/org/apache/usergrid/persistence/PermissionsIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/java/org/apache/usergrid/persistence/PermissionsIT.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -38,13 +38,13 @@ log4j.appender.stdout.layout.ConversionPattern=%d %p (%t) %c{1} - %m%n\n #log4j.logger.org.apache.usergrid.locking.singlenode.SingleNodeLockManagerImpl=DEBUG, stdout\n \n log4j.logger.org.apache.usergrid.persistence=INFO\n-#log4j.logger.org.apache.usergrid.corepersistence=DEBUG\n+log4j.logger.org.apache.usergrid.corepersistence=DEBUG\n #log4j.logger.com.netflix.hystrix=DEBUG\n #log4j.logger.org.antlr=DEBUG\n \n #log4j.logger.org.apache.usergrid.persistence.CollectionIT=DEBUG\n-#log4j.logger.org.apache.usergrid.persistence.index=DEBUG\n-#log4j.logger.org.apache.usergrid.persistence.query=DEBUG\n+log4j.logger.org.apache.usergrid.persistence.index=DEBUG\n+log4j.logger.org.apache.usergrid.persistence.query=DEBUG\n #log4j.logger.org.apache.usergrid.persistence.collection=DEBUG\n #log4j.logger.org.elasticsearch=DEBUG\n ",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/test/resources/log4j.properties",
                "status": "modified",
                "changes": 6,
                "deletions": 3,
                "sha": "b42a590558909d42272445ca484b8fbfbfda6464",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/core/src/test/resources/log4j.properties",
                "filename": "stack/core/src/test/resources/log4j.properties",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/core/src/test/resources/log4j.properties?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -1,7 +1,6 @@\n package org.apache.usergrid.persistence.core.astyanax;\n \n \n-import org.apache.cassandra.db.marshal.BooleanType;\n import org.apache.cassandra.db.marshal.DynamicCompositeType;\n \n \n@@ -11,22 +10,27 @@\n  */\n public class ColumnTypes {\n \n+\n     /**\n-     * UUID from max by the row key to min at the end of the row\n+     * Long time with max by the row key and min at the end of the row\n      */\n+    public static final String LONG_TYPE_REVERSED = \"LongType(reversed=true)\";\n+\n+\n     public static final String UUID_TYPE_REVERSED = \"UUIDType(reversed=true)\";\n+\n+\n+\n     /**\n      * Constant for the dynamic composite comparator type we'll need\n      */\n     public static final String DYNAMIC_COMPOSITE_TYPE = DynamicCompositeType.class.getSimpleName() + \"(a=>AsciiType,b=>BytesType,i=>IntegerType,x=>LexicalUUIDType,l=>LongType,\" +\n                         \"t=>TimeUUIDType,s=>UTF8Type,u=>UUIDType,A=>AsciiType(reversed=true),B=>BytesType(reversed=true),\" +\n-                        \"I=>IntegerType(reversed=true),X=>LexicalUUIDType(reversed=true),L=>LongType(reversed=true),\" +\n-                        \"T=>TimeUUIDType(reversed=true),S=>UTF8Type(reversed=true),U=>\"+UUID_TYPE_REVERSED+ \")\";\n+                        \"I=>IntegerType(reversed=true),X=>LexicalUUIDType(reversed=true),L=>\"+LONG_TYPE_REVERSED+\",\" +\n+                        \"T=>TimeUUIDType(reversed=true),S=>UTF8Type(reversed=true),U=>\"+UUID_TYPE_REVERSED+\")\";\n+\n+\n \n-    /**\n-     * Long time with max by the row key and min at the end of the row\n-     */\n-    public static final String LONG_TYPE_REVERSED = \"LongType(reversed=true)\";\n \n \n }",
                "additions": 12,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/astyanax/ColumnTypes.java",
                "status": "modified",
                "changes": 20,
                "deletions": 8,
                "sha": "b5e41ff02ad0974476d10fccbfb756f7c8276fff",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/astyanax/ColumnTypes.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/astyanax/ColumnTypes.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/astyanax/ColumnTypes.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -27,6 +27,15 @@\n  */\n public interface AsyncProcessor<T> {\n \n+    /**\n+     * Start the consumption of the timeout events\n+     */\n+    public void start();\n+\n+    /**\n+     * Stop consumption\n+     */\n+    public void stop();\n \n     /**\n      * The processor implementation is responsible for guaranteeing the events fire in the runtime environment. This",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessor.java",
                "status": "modified",
                "changes": 9,
                "deletions": 0,
                "sha": "48a41cf7046dc8be1d27a95db2a8aa079e7c50a8",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessor.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessor.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessor.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -20,14 +20,12 @@\n \n \n import java.io.Serializable;\n-import java.util.concurrent.ExecutionException;\n+import java.util.HashMap;\n+import java.util.Map;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.cache.CacheBuilder;\n-import com.google.common.cache.CacheLoader;\n-import com.google.common.cache.LoadingCache;\n import com.google.inject.Inject;\n import com.google.inject.Singleton;\n \n@@ -43,19 +41,8 @@\n     private final TimeoutQueueFactory queueFactory;\n     private final ConsistencyFig consistencyFig;\n \n-    private final LoadingCache<Class<? extends Serializable>, AsyncProcessor<? extends Serializable>> loadedProcessors = CacheBuilder.newBuilder()\n-           .maximumSize( 1000 )\n-           .build( new CacheLoader<Class<? extends Serializable>, AsyncProcessor<? extends Serializable>>() {\n-\n-               @Override\n-               public AsyncProcessor<? extends Serializable> load( final Class<? extends Serializable> key ) throws Exception {\n-                   LOG.info( \"Creating queue from factory for event key {}\", key );\n-\n-                   final TimeoutQueue queue = queueFactory.getQueue( key );\n-\n-                   return  new AsyncProcessorImpl( queue, consistencyFig );\n-               }\n-           } );\n+    private final Map<Class<? extends Serializable>, AsyncProcessor<? extends Serializable>> instances =\n+            new HashMap( 100 );\n \n \n     @Inject\n@@ -67,11 +54,31 @@ public AsyncProcessorFactoryImpl( final TimeoutQueueFactory queueFactory, final\n \n     @Override\n     public <T extends Serializable> AsyncProcessor<T> getProcessor( final Class<T> eventClass ) {\n-        try {\n-            return ( AsyncProcessor<T> ) loadedProcessors.get( eventClass );\n+\n+        AsyncProcessor<T> processor = ( AsyncProcessor<T> ) instances.get( eventClass );\n+\n+\n+        if ( processor != null ) {\n+            return processor;\n         }\n-        catch ( ExecutionException e ) {\n-            throw new RuntimeException( \"Unable to load from cache\", e );\n+\n+\n+        synchronized ( this ) {\n+            processor = ( AsyncProcessor<T> ) instances.get( eventClass );\n+\n+\n+            if ( processor != null ) {\n+                return processor;\n+            }\n+\n+            TimeoutQueue queue = queueFactory.getQueue( eventClass );\n+            AsyncProcessorImpl newProcessor = new AsyncProcessorImpl( queue, consistencyFig );\n+\n+            instances.put( eventClass, newProcessor );\n+\n+            newProcessor.start();\n+\n+            return newProcessor;\n         }\n     }\n }",
                "additions": 28,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorFactoryImpl.java",
                "status": "modified",
                "changes": 49,
                "deletions": 21,
                "sha": "ad798049406c8dcf51786649f13dc5535d5b8c38",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorFactoryImpl.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorFactoryImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorFactoryImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -34,6 +34,7 @@\n import com.google.inject.Singleton;\n \n import rx.Observable;\n+import rx.Scheduler;\n import rx.Subscriber;\n import rx.functions.FuncN;\n import rx.schedulers.Schedulers;\n@@ -53,23 +54,49 @@\n     private static final Logger LOG = LoggerFactory.getLogger( AsyncProcessor.class );\n \n     protected final TimeoutQueue<T> queue;\n-//    protected final ConsistencyFig consistencyFig;\n+    protected final ConsistencyFig consistencyFig;\n     protected final List<MessageListener<T, ?>> listeners = new ArrayList<>();\n \n \n     protected List<ErrorListener<T>> errorListeners = new ArrayList<ErrorListener<T>>();\n     protected List<CompleteListener<T>> completeListeners = new ArrayList<CompleteListener<T>>();\n \n+    private Scheduler.Worker worker;\n+\n \n     @Inject\n     public AsyncProcessorImpl( final TimeoutQueue<T> queue, final ConsistencyFig consistencyFig ) {\n         this.queue = queue;\n-//        this.consistencyFig = consistencyFig;\n+        this.consistencyFig = consistencyFig;\n+    }\n+\n+\n+    @Override\n+    public void start() {\n+        synchronized ( this ) {\n+            if ( worker != null ) {\n+                return;\n+            }\n \n-        //we purposefully use a new thread.  We don't want to use one of the I/O threads to run this task\n-        //in the event the scheduler is full, we'll end up rejecting the reschedule of this task\n-        Schedulers.newThread().createWorker().schedulePeriodically( new TimeoutTask<T>( this, consistencyFig ), consistencyFig.getTaskLoopTime(),\n-                consistencyFig.getTaskLoopTime(), TimeUnit.MILLISECONDS );\n+\n+            worker = Schedulers.newThread().createWorker();\n+\n+\n+            worker.schedulePeriodically( new TimeoutTask<T>( this, consistencyFig ), consistencyFig.getTaskLoopTime(),\n+                    consistencyFig.getTaskLoopTime(), TimeUnit.MILLISECONDS );\n+        }\n+    }\n+\n+\n+    @Override\n+    public void stop() {\n+        synchronized ( this ) {\n+            if ( worker == null ) {\n+                return;\n+            }\n+\n+            worker.unsubscribe();\n+        }\n     }\n \n \n@@ -81,12 +108,19 @@ public AsyncProcessorImpl( final TimeoutQueue<T> queue, final ConsistencyFig con\n \n     @Override\n     public void start( final AsynchronousMessage<T> event ) {\n+\n+//        This is helpful for detecting wiring issues.  Uncomment this to find the issue at queue time\n+        if ( listeners.size() == 0 ) {\n+            LOG.warn( \"Nothing is listening for event of class {}.  You're talking to /dev/null!\", event.getEvent().getClass() );\n+        }\n+\n         final T data = event.getEvent();\n         /**\n          * Execute all listeners in parallel\n          */\n         List<Observable<?>> observables = new ArrayList<Observable<?>>( listeners.size() );\n \n+\n         for ( MessageListener<T, ?> listener : listeners ) {\n             observables.add( HystrixObservable.async( listener.receive( data ) ).subscribeOn( Schedulers.io() ) );\n         }\n@@ -136,8 +170,6 @@ public void onNext( final AsynchronousMessage<T> tAsynchronousMessage ) {\n     }\n \n \n-\n-\n     @Override\n     public <R> void addListener( final MessageListener<T, R> listener ) {\n         this.listeners.add( listener );",
                "additions": 40,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorImpl.java",
                "status": "modified",
                "changes": 48,
                "deletions": 8,
                "sha": "ad0f40b3ebd1c30f37a37711c6394967d69319c4",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorImpl.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/consistency/AsyncProcessorImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -69,7 +69,7 @@ protected void configure() {\n \n         bind( CassandraConfig.class ).to( CassandraConfigImpl.class );\n \n-        bind(AsyncProcessorFactory.class).to( AsyncProcessorFactoryImpl.class );\n+        bind(AsyncProcessorFactory.class).to( AsyncProcessorFactoryImpl.class ).asEagerSingleton();\n \n         bindTimeoutQueueFactory();\n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "6d663fa12001ab795afc521111c1270d0be1bd20",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/guice/CommonModule.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -20,11 +20,8 @@\n package org.apache.usergrid.persistence.core.hystrix;\n \n \n-import com.netflix.config.ConfigurationManager;\n import com.netflix.hystrix.HystrixCommandGroupKey;\n-import com.netflix.hystrix.HystrixCommandProperties;\n import com.netflix.hystrix.HystrixObservableCommand;\n-import com.netflix.hystrix.HystrixThreadPoolProperties.Setter;\n \n import rx.Observable;\n ",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/hystrix/HystrixObservable.java",
                "status": "modified",
                "changes": 3,
                "deletions": 3,
                "sha": "c38c4b84f8db1c7016d34f7a697b047f90ddd743",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/hystrix/HystrixObservable.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/hystrix/HystrixObservable.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/hystrix/HystrixObservable.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -29,16 +29,16 @@\n  */\n public class ApplicationScopeImpl implements ApplicationScope {\n \n-    protected final Id organization;\n+    protected final Id application;\n \n \n-    public ApplicationScopeImpl( final Id organization ) {\n-        this.organization = organization;}\n+    public ApplicationScopeImpl( final Id application ) {\n+        this.application = application;}\n \n \n     @Override\n     public Id getApplication() {\n-        return this.organization;\n+        return this.application;\n     }\n \n \n@@ -53,7 +53,7 @@ public boolean equals( final Object o ) {\n \n         final ApplicationScopeImpl that = ( ApplicationScopeImpl ) o;\n \n-        if ( !organization.equals( that.organization ) ) {\n+        if ( !application.equals( that.application ) ) {\n             return false;\n         }\n \n@@ -63,14 +63,14 @@ public boolean equals( final Object o ) {\n \n     @Override\n     public int hashCode() {\n-        return organization.hashCode();\n+        return application.hashCode();\n     }\n \n \n     @Override\n     public String toString() {\n         return \"ApplicationScopeImpl{\" +\n-                \"organization=\" + organization +\n+                \"application=\" + application +\n                 '}';\n     }\n }",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/scope/ApplicationScopeImpl.java",
                "status": "modified",
                "changes": 14,
                "deletions": 7,
                "sha": "692ba49291251e22425e326dae4bc014fc662957",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/scope/ApplicationScopeImpl.java",
                "filename": "stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/scope/ApplicationScopeImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/common/src/main/java/org/apache/usergrid/persistence/core/scope/ApplicationScopeImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -53,5 +53,5 @@\n     /**\n      * Get the version (as a type 1 time uuid) of this edge\n      */\n-    UUID getVersion();\n+    long getTimestamp();\n }",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/Edge.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "21f804a62f05dd143479834514d01d0a10c73acc",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/Edge.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/Edge.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/Edge.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -74,10 +74,12 @@\n      *\n      * Remove the node from the graph.\n      *\n-     * @param node\n+     * @param node The node to remove\n+     * @param timestamp The timestamp to apply the delete operation.  Any edges connected to this node with a timestmap\n+     * <= the specified time will be removed from the graph\n      * @return\n      */\n-    Observable<Id> deleteNode(Id node);\n+    Observable<Id> deleteNode(Id node, long timestamp);\n \n     /**\n      * Get all versions of this edge where versions <= max version",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/GraphManager.java",
                "status": "modified",
                "changes": 6,
                "deletions": 2,
                "sha": "aa1a4a8712b3dc5c6f531b899ef65507bc2b8bb1",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/GraphManager.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/GraphManager.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/GraphManager.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -54,11 +54,11 @@\n     String getType();\n \n     /**\n-     * Get the Maximum Version of an edge we can return.\n-     * This should always be a type 1 time uuid.\n-     * @return\n+     * Get the Maximum timestamp of an edge we can return.\n+\n+     * @return The max timestamp as a long\n      */\n-    UUID getMaxVersion();\n+    long getMaxTimestamp();\n \n     /**\n      * The optional start parameter.  All edges emitted with be > the specified start edge.",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdge.java",
                "status": "modified",
                "changes": 8,
                "deletions": 4,
                "sha": "8deeb69e30f6b5e84ff6f1aa666c39c2667e638f",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdge.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdge.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdge.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -52,7 +52,7 @@\n      * This should always be a type 1 time uuid.\n      * @return\n      */\n-    UUID getMaxVersion();\n+    long getMaxTimestamp();\n \n     /**\n      * The optional start parameter.  All edges emitted with be > the specified start edge.",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdgeType.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "97c01c04403d16371eb05a3014d481af21455e1e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdgeType.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdgeType.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/SearchByEdgeType.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -63,7 +63,7 @@ public EdgeDeleteListener( final AsyncProcessorFactory asyncProcessorFactory,\n \n         final MarkedEdge edge = delete.getData();\n         final ApplicationScope scope = delete.getApplicationScope();\n-        final UUID maxVersion = edge.getVersion();\n+        final long maxTimestamp = edge.getTimestamp();\n \n \n         return edgeDeleteRepair.repair( scope, edge, delete.getTimestamp() )\n@@ -73,11 +73,11 @@ public EdgeDeleteListener( final AsyncProcessorFactory asyncProcessorFactory,\n \n                                        Observable<Integer> sourceDelete = edgeMetaRepair\n                                                .repairSources( scope, edge.getSourceNode(), edge.getType(),\n-                                                       maxVersion );\n+                                                       maxTimestamp );\n \n                                        Observable<Integer> targetDelete = edgeMetaRepair\n                                                .repairTargets( scope, edge.getTargetNode(), edge.getType(),\n-                                                       maxVersion );\n+                                                       maxTimestamp );\n \n                                        return Observable.zip( sourceDelete, targetDelete,\n                                                new Func2<Integer, Integer, Integer>() {",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListener.java",
                "status": "modified",
                "changes": 6,
                "deletions": 3,
                "sha": "278abb4dfbde11adf406c6f10b9a6f2843ffc161",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListener.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListener.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListener.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -32,6 +32,7 @@\n import org.apache.usergrid.persistence.core.consistency.AsyncProcessorFactory;\n import org.apache.usergrid.persistence.core.consistency.AsynchronousMessage;\n import org.apache.usergrid.persistence.core.consistency.ConsistencyFig;\n+import org.apache.usergrid.persistence.core.consistency.TimeService;\n import org.apache.usergrid.persistence.core.hystrix.HystrixObservable;\n import org.apache.usergrid.persistence.core.rx.ObservableIterator;\n import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n@@ -90,15 +91,15 @@\n     private final GraphFig graphFig;\n     private final ConsistencyFig consistencyFig;\n \n-\n     @Inject\n     public GraphManagerImpl( final EdgeMetadataSerialization edgeMetadataSerialization,\n                              @CommitLogEdgeSerialization final EdgeSerialization commitLogSerialization,\n                              final NodeSerialization nodeSerialization, final GraphFig graphFig,\n-                             final AsyncProcessorFactory asyncProcessorFactory,\n-                             final MergedEdgeReader mergedEdgeReader,\n+                             final AsyncProcessorFactory asyncProcessorFactory, final MergedEdgeReader mergedEdgeReader,\n                              final ConsistencyFig consistencyFig,\n-                             @Assisted final ApplicationScope scope) {\n+                             @Assisted final ApplicationScope scope\n+                             ) {\n+\n \n \n         ValidationUtils.validateApplicationScope( scope );\n@@ -119,6 +120,7 @@ public GraphManagerImpl( final EdgeMetadataSerialization edgeMetadataSerializati\n         this.graphFig = graphFig;\n         this.consistencyFig = consistencyFig;\n \n+\n         this.edgeDeleteAsyncProcessor = asyncProcessorFactory.getProcessor( EdgeDeleteEvent.class );\n \n         this.nodeDeleteAsyncProcessor = asyncProcessorFactory.getProcessor( NodeDeleteEvent.class );\n@@ -208,19 +210,19 @@ public Edge call( final MarkedEdge edge ) {\n \n \n     @Override\n-    public Observable<Id> deleteNode( final Id node ) {\n+    public Observable<Id> deleteNode( final Id node, final long timestamp ) {\n         return HystrixObservable\n                 .user( Observable.from( node ).subscribeOn( Schedulers.io() ).map( new Func1<Id, Id>() {\n                     @Override\n                     public Id call( final Id id ) {\n \n                         //mark the node as deleted\n-                        final UUID deleteTime = UUIDGenerator.newTimeUUID();\n \n-                        final MutationBatch nodeMutation = nodeSerialization.mark( scope, id, deleteTime );\n+\n+                        final MutationBatch nodeMutation = nodeSerialization.mark( scope, id, timestamp );\n \n                         final AsynchronousMessage<NodeDeleteEvent> event = nodeDeleteAsyncProcessor\n-                                .setVerification( new NodeDeleteEvent( scope, deleteTime, node ), getTimeout() );\n+                                .setVerification( new NodeDeleteEvent( scope, UUIDGenerator.newTimeUUID(), timestamp, node ), getTimeout() );\n \n \n                         try {\n@@ -243,7 +245,7 @@ public Id call( final Id id ) {\n     public Observable<Edge> loadEdgeVersions( final SearchByEdge searchByEdge ) {\n         return HystrixObservable\n                 .user( mergedEdgeReader.getEdgeVersions( scope, searchByEdge ).buffer( graphFig.getScanPageSize() )\n-                                       .flatMap( new EdgeBufferFilter( searchByEdge.getMaxVersion() ) )\n+                                       .flatMap( new EdgeBufferFilter( searchByEdge.getMaxTimestamp() ) )\n                                        .cast( Edge.class ) );\n     }\n \n@@ -252,23 +254,23 @@ public Id call( final Id id ) {\n     public Observable<Edge> loadEdgesFromSource( final SearchByEdgeType search ) {\n         return HystrixObservable\n                 .user( mergedEdgeReader.getEdgesFromSource( scope, search ).buffer( graphFig.getScanPageSize() )\n-                                       .flatMap( new EdgeBufferFilter( search.getMaxVersion() ) ).cast( Edge.class ) );\n+                                       .flatMap( new EdgeBufferFilter( search.getMaxTimestamp() ) ).cast( Edge.class ) );\n     }\n \n \n     @Override\n     public Observable<Edge> loadEdgesToTarget( final SearchByEdgeType search ) {\n         return HystrixObservable\n                 .user( mergedEdgeReader.getEdgesToTarget( scope, search ).buffer( graphFig.getScanPageSize() )\n-                                       .flatMap( new EdgeBufferFilter( search.getMaxVersion() ) ).cast( Edge.class ) );\n+                                       .flatMap( new EdgeBufferFilter( search.getMaxTimestamp() ) ).cast( Edge.class ) );\n     }\n \n \n     @Override\n     public Observable<Edge> loadEdgesFromSourceByType( final SearchByIdType search ) {\n         return HystrixObservable.user( mergedEdgeReader.getEdgesFromSourceByTargetType( scope, search )\n                                                        .buffer( graphFig.getScanPageSize() )\n-                                                       .flatMap( new EdgeBufferFilter( search.getMaxVersion() ) )\n+                                                       .flatMap( new EdgeBufferFilter( search.getMaxTimestamp() ) )\n \n                                                        .cast( Edge.class ) );\n     }\n@@ -278,7 +280,7 @@ public Id call( final Id id ) {\n     public Observable<Edge> loadEdgesToTargetByType( final SearchByIdType search ) {\n         return HystrixObservable.user( mergedEdgeReader.getEdgesToTargetBySourceType( scope, search )\n                                                        .buffer( graphFig.getScanPageSize() )\n-                                                       .flatMap( new EdgeBufferFilter( search.getMaxVersion() ) )\n+                                                       .flatMap( new EdgeBufferFilter( search.getMaxTimestamp() ) )\n                                                        .cast( Edge.class ) );\n     }\n \n@@ -345,10 +347,10 @@ private long getTimeout() {\n      */\n     private class EdgeBufferFilter implements Func1<List<MarkedEdge>, Observable<MarkedEdge>> {\n \n-        private final UUID maxVersion;\n+        private final long maxVersion;\n \n \n-        private EdgeBufferFilter( final UUID maxVersion ) {\n+        private EdgeBufferFilter( final long maxVersion ) {\n             this.maxVersion = maxVersion;\n         }\n \n@@ -363,7 +365,7 @@ private EdgeBufferFilter( final UUID maxVersion ) {\n         @Override\n         public Observable<MarkedEdge> call( final List<MarkedEdge> markedEdges ) {\n \n-            final Map<Id, UUID> markedVersions = nodeSerialization.getMaxVersions( scope, markedEdges );\n+            final Map<Id, Long> markedVersions = nodeSerialization.getMaxVersions( scope, markedEdges );\n             return Observable.from( markedEdges ).filter( new EdgeFilter( this.maxVersion, markedVersions ) );\n         }\n     }\n@@ -374,13 +376,13 @@ private EdgeBufferFilter( final UUID maxVersion ) {\n      */\n     private static class EdgeFilter implements Func1<MarkedEdge, Boolean> {\n \n-        private final UUID maxVersion;\n+        private final long maxTimestamp;\n \n-        private final Map<Id, UUID> markCache;\n+        private final Map<Id, Long> markCache;\n \n \n-        private EdgeFilter( final UUID maxVersion, Map<Id, UUID> markCache ) {\n-            this.maxVersion = maxVersion;\n+        private EdgeFilter( final long maxTimestamp, Map<Id, Long> markCache ) {\n+            this.maxTimestamp = maxTimestamp;\n             this.markCache = markCache;\n         }\n \n@@ -389,27 +391,27 @@ private EdgeFilter( final UUID maxVersion, Map<Id, UUID> markCache ) {\n         public Boolean call( final MarkedEdge edge ) {\n \n \n-            final UUID edgeVersion = edge.getVersion();\n+            final long edgeTimestamp = edge.getTimestamp();\n \n             //our edge needs to not be deleted and have a version that's > max Version\n-            if ( edge.isDeleted() || UUIDComparator.staticCompare( edgeVersion, maxVersion ) > 0 ) {\n+            if ( edge.isDeleted() || Long.compare( edgeTimestamp, maxTimestamp )> 0 ) {\n                 return false;\n             }\n \n \n-            final UUID sourceVersion = markCache.get( edge.getSourceNode() );\n+            final Long sourceTimestamp = markCache.get( edge.getSourceNode() );\n \n             //the source Id has been marked for deletion.  It's version is <= to the marked version for deletion,\n             // so we need to discard it\n-            if ( sourceVersion != null && UUIDComparator.staticCompare( edgeVersion, sourceVersion ) < 1 ) {\n+            if ( sourceTimestamp != null && Long.compare( edgeTimestamp, sourceTimestamp ) < 1 ) {\n                 return false;\n             }\n \n-            final UUID targetVersion = markCache.get( edge.getTargetNode() );\n+            final Long targetTimestamp = markCache.get( edge.getTargetNode() );\n \n             //the target Id has been marked for deletion.  It's version is <= to the marked version for deletion,\n             // so we need to discard it\n-            if ( targetVersion != null && UUIDComparator.staticCompare( edgeVersion, targetVersion ) < 1 ) {\n+            if ( targetTimestamp != null &&  Long.compare( edgeTimestamp, targetTimestamp ) < 1 ) {\n                 return false;\n             }\n ",
                "additions": 28,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java",
                "status": "modified",
                "changes": 54,
                "deletions": 26,
                "sha": "9708fd3fd33bdbb9b39ba9f1283c416cd8dc39f6",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/GraphManagerImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -30,7 +30,11 @@\n  * Event for when a node is deleted\n  */\n public class NodeDeleteEvent extends EdgeEvent<Id> {\n-    public NodeDeleteEvent( final ApplicationScope applicationScope, final UUID version, final Id id ) {\n-        super( applicationScope, version, id );\n+\n+    private final long timestamp;\n+\n+    public NodeDeleteEvent( final ApplicationScope applicationScope, final UUID eventTime, final long timestamp, final Id id ) {\n+        super( applicationScope, eventTime, id );\n+        this.timestamp = timestamp;\n     }\n }",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteEvent.java",
                "status": "modified",
                "changes": 8,
                "deletions": 2,
                "sha": "236950267e2d9e922a9516a4f583ed662167dde2",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteEvent.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteEvent.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteEvent.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -104,16 +104,16 @@ public NodeDeleteListener( final NodeSerialization nodeSerialization,\n     /**\n      * Removes this node from the graph.\n      *\n-     * @param edgeEvent The edge event that was fired.\n+     * @param nodeDeleteEvent The edge event that was fired.\n      *\n      * @return An observable that emits the total number of edges that have been removed with this node both as the\n      *         target and source\n      */\n     @Override\n-    public Observable<Integer> receive( final NodeDeleteEvent edgeEvent ) {\n+    public Observable<Integer> receive( final NodeDeleteEvent nodeDeleteEvent ) {\n \n-        final Id node = edgeEvent.getData();\n-        final ApplicationScope scope = edgeEvent.getApplicationScope();\n+        final Id node = nodeDeleteEvent.getData();\n+        final ApplicationScope scope = nodeDeleteEvent.getApplicationScope();\n \n \n         return Observable.from( node )\n@@ -123,7 +123,7 @@ public NodeDeleteListener( final NodeSerialization nodeSerialization,\n                     @Override\n                     public Observable<Integer> call( final Id node ) {\n \n-                        final Optional<UUID> maxVersion = nodeSerialization.getMaxVersion( scope, node );\n+                        final Optional<Long> maxVersion = nodeSerialization.getMaxVersion( scope, node );\n \n                         LOG.debug( \"Node with id {} has max version of {}\", node, maxVersion.orNull() );\n \n@@ -132,26 +132,26 @@ public NodeDeleteListener( final NodeSerialization nodeSerialization,\n                             return Observable.empty();\n                         }\n \n-                        maxVersion.get();\n+\n \n                         //do all the delete, then when done, delete the node\n-                        return doDeletes( node, scope, maxVersion.get() ).count()\n+                        return doDeletes( node, scope, maxVersion.get(), nodeDeleteEvent.getTimestamp() ).count()\n                                 //if nothing is ever emitted, emit 0 so that we know no operations took place.\n                                 // Finally remove\n                                 // the\n                                 // target node in the mark\n                                .doOnCompleted( new Action0() {\n-                                    @Override\n-                                    public void call() {\n-                                        try {\n-                                            nodeSerialization.delete( scope, node, maxVersion.get() ).execute();\n-                                        }\n-                                        catch ( ConnectionException e ) {\n-                                            throw new RuntimeException( \"Unable to delete marked graph node \" + node,\n-                                                    e );\n-                                        }\n-                                    }\n-                                } );\n+                                   @Override\n+                                   public void call() {\n+                                       try {\n+                                           nodeSerialization.delete( scope, node, maxVersion.get() ).execute();\n+                                       }\n+                                       catch ( ConnectionException e ) {\n+                                           throw new RuntimeException( \"Unable to delete marked graph node \" + node,\n+                                                   e );\n+                                       }\n+                                   }\n+                               } );\n                     }\n                 } ).defaultIfEmpty( 0 );\n     }\n@@ -160,7 +160,7 @@ public void call() {\n     /**\n      * Do the deletes\n      */\n-    private Observable<MarkedEdge> doDeletes( final Id node, final ApplicationScope scope, final UUID version ) {\n+    private Observable<MarkedEdge> doDeletes( final Id node, final ApplicationScope scope, final long maxVersion, final UUID eventTimestamp ) {\n         /**\n          * Note that while we're processing, returned edges could be moved from the commit log to storage.  As a result,\n          * we need to issue a delete with the same version as the node delete on both commit log and storage for\n@@ -176,7 +176,7 @@ public void call() {\n                             @Override\n                             public Observable<MarkedEdge> call( final String edgeType ) {\n                                 return mergedEdgeReader.getEdgesToTarget( scope,\n-                                        new SimpleSearchByEdgeType( node, edgeType, version, null ) );\n+                                        new SimpleSearchByEdgeType( node, edgeType, maxVersion, null ) );\n                             }\n                         } );\n \n@@ -188,7 +188,7 @@ public void call() {\n                             @Override\n                             public Observable<MarkedEdge> call( final String edgeType ) {\n                                 return mergedEdgeReader.getEdgesFromSource( scope,\n-                                        new SimpleSearchByEdgeType( node, edgeType, version, null ) );\n+                                        new SimpleSearchByEdgeType( node, edgeType, maxVersion, null ) );\n                             }\n                         } );\n \n@@ -213,8 +213,8 @@ public void call() {\n \n                             //we use the version specified on the delete purposefully.  If these edges are re-written\n                             //at a greater time we want them to exit\n-                            batch.mergeShallow( commitLogSerialization.deleteEdge( scope, edge, version ) );\n-                            batch.mergeShallow( storageSerialization.deleteEdge( scope, edge, version ) );\n+                            batch.mergeShallow( commitLogSerialization.deleteEdge( scope, edge, eventTimestamp ) );\n+                            batch.mergeShallow( storageSerialization.deleteEdge( scope, edge, eventTimestamp ) );\n \n                             sourceNodes.add( new TargetPair( edge.getSourceNode(), edge.getType() ) );\n                             targetNodes.add( new TargetPair( edge.getTargetNode(), edge.getType() ) );\n@@ -243,7 +243,7 @@ public void call() {\n                                     @Override\n                                     public Observable<Integer> call( final TargetPair targetPair ) {\n                                         return edgeMetaRepair\n-                                                .repairSources( scope, targetPair.id, targetPair.edgeType, version );\n+                                                .repairSources( scope, targetPair.id, targetPair.edgeType, maxVersion );\n                                     }\n                                 } ).last();\n \n@@ -255,7 +255,7 @@ public void call() {\n                                     @Override\n                                     public Observable<Integer> call( final TargetPair targetPair ) {\n                                         return edgeMetaRepair\n-                                                .repairTargets( scope, targetPair.id, targetPair.edgeType, version );\n+                                                .repairTargets( scope, targetPair.id, targetPair.edgeType, maxVersion );\n                                     }\n                                 } ).last();\n ",
                "additions": 25,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListener.java",
                "status": "modified",
                "changes": 50,
                "deletions": 25,
                "sha": "7c67f0466e13067827959a7c7f81383ea0c9c404",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListener.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListener.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListener.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -20,11 +20,11 @@\n package org.apache.usergrid.persistence.graph.impl;\n \n \n-import java.io.Serializable;\n import java.util.UUID;\n \n import org.apache.usergrid.persistence.core.util.ValidationUtils;\n import org.apache.usergrid.persistence.graph.Edge;\n+import org.apache.usergrid.persistence.graph.serialization.util.EdgeUtils;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n \n@@ -37,19 +37,16 @@\n     protected final Id sourceNode;\n     protected final String type;\n     protected final Id targetNode;\n-    protected final UUID version;\n+    protected final long timestamp;\n \n \n-    public SimpleEdge( final Id sourceNode, final String type, final Id targetNode, final UUID version ) {\n-\n-        ValidationUtils.verifyIdentity( sourceNode );\n-        ValidationUtils.verifyString( type, \"type\" );\n-        ValidationUtils.verifyIdentity( targetNode );\n-        ValidationUtils.verifyTimeUuid( version, \"version\" );\n+    public SimpleEdge( final Id sourceNode, final String type, final Id targetNode, final long timestamp ) {\n         this.sourceNode = sourceNode;\n         this.type = type;\n         this.targetNode = targetNode;\n-        this.version = version;\n+        this.timestamp = timestamp;\n+\n+        EdgeUtils.validateEdge( this );\n     }\n \n \n@@ -71,18 +68,11 @@ public Id getTargetNode() {\n     }\n \n \n-    public UUID getVersion() {\n-        return version;\n+    public long getTimestamp() {\n+        return timestamp;\n     }\n \n \n-\n-    /**\n-     * Test if the 2 edges are equal to one another.  Note that this is an edge comparison, not a marked edge comparison\n-     * @param o\n-     * @return\n-     */\n-\n     @Override\n     public boolean equals( final Object o ) {\n         if ( this == o ) {\n@@ -92,19 +82,18 @@ public boolean equals( final Object o ) {\n             return false;\n         }\n \n-        final Edge that = ( Edge ) o;\n-\n+        final SimpleEdge that = ( SimpleEdge ) o;\n \n-        if ( !sourceNode.equals( that.getSourceNode() ) ) {\n+        if ( timestamp != that.timestamp ) {\n             return false;\n         }\n-        if ( !targetNode.equals( that.getTargetNode() ) ) {\n+        if ( !sourceNode.equals( that.sourceNode ) ) {\n             return false;\n         }\n-        if ( !type.equals( that.getType() ) ) {\n+        if ( !targetNode.equals( that.targetNode ) ) {\n             return false;\n         }\n-        if ( !version.equals( that.getVersion() ) ) {\n+        if ( !type.equals( that.type ) ) {\n             return false;\n         }\n \n@@ -117,18 +106,18 @@ public int hashCode() {\n         int result = sourceNode.hashCode();\n         result = 31 * result + type.hashCode();\n         result = 31 * result + targetNode.hashCode();\n-        result = 31 * result + version.hashCode();\n+        result = 31 * result + ( int ) ( timestamp ^ ( timestamp >>> 32 ) );\n         return result;\n     }\n \n \n     @Override\n     public String toString() {\n-        return \"SimpleMarkedEdge{\" +\n+        return \"SimpleEdge{\" +\n                 \"sourceNode=\" + sourceNode +\n                 \", type='\" + type + '\\'' +\n                 \", targetNode=\" + targetNode +\n-                \", version=\" + version +\n+                \", timestamp=\" + timestamp +\n                 '}';\n     }\n }",
                "additions": 16,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleEdge.java",
                "status": "modified",
                "changes": 43,
                "deletions": 27,
                "sha": "576d9dd203d21a4027e3d27396f5b61d57c8e3e0",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleEdge.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleEdge.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleEdge.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -36,15 +36,15 @@\n     private final boolean deleted;\n \n \n-    public SimpleMarkedEdge( final Id sourceNode, final String type, final Id targetNode, final UUID version, final boolean deleted) {\n+    public SimpleMarkedEdge( final Id sourceNode, final String type, final Id targetNode, final long timestamp, final boolean deleted) {\n \n-        super(sourceNode, type, targetNode, version);\n+        super(sourceNode, type, targetNode, timestamp);\n         this.deleted = deleted;\n     }\n \n \n     public SimpleMarkedEdge(final Edge edge, final boolean deleted){\n-        this(edge.getSourceNode(), edge.getType(), edge.getTargetNode(), edge.getVersion(), deleted);\n+        this(edge.getSourceNode(), edge.getType(), edge.getTargetNode(), edge.getTimestamp(), deleted);\n     }\n \n \n@@ -88,11 +88,7 @@ public int hashCode() {\n     @Override\n     public String toString() {\n         return \"SimpleMarkedEdge{\" +\n-                \"sourceNode=\" + sourceNode +\n-                \", type='\" + type + '\\'' +\n-                \", targetNode=\" + targetNode +\n-                \", version=\" + version +\n-                \", deleted=\" + deleted +\n-                '}';\n+                \"deleted=\" + deleted +\n+                \"} \" + super.toString();\n     }\n }",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleMarkedEdge.java",
                "status": "modified",
                "changes": 14,
                "deletions": 9,
                "sha": "a5b4f2e5ef9b181dd20bba3d5491da3aacae4278",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleMarkedEdge.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleMarkedEdge.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleMarkedEdge.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -25,6 +25,7 @@\n import org.apache.usergrid.persistence.core.util.ValidationUtils;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.SearchByEdge;\n+import org.apache.usergrid.persistence.graph.serialization.util.EdgeUtils;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.common.base.Optional;\n@@ -39,7 +40,7 @@\n     private final Id sourceNode;\n     private final Id targetNode;\n     private final String type;\n-    private final UUID maxVersion;\n+    private final long maxTimestamp;\n     private final Optional<Edge> last;\n \n \n@@ -48,20 +49,20 @@\n      * @param sourceNode The source node of the edge\n      * @param targetNode The target node of the edge\n      * @param type The edge type\n-     * @param maxVersion The maximum version to return\n+     * @param maxTimestamp The maximum timestamp to seek from\n      * @param last The value to start seeking from.  Must be >= this value\n      */\n-    public SimpleSearchByEdge( final Id sourceNode, final String type, final Id targetNode, final UUID maxVersion, final Edge last ) {\n+    public SimpleSearchByEdge( final Id sourceNode, final String type, final Id targetNode, final long maxTimestamp, final Edge last ) {\n         ValidationUtils.verifyIdentity(sourceNode);\n         ValidationUtils.verifyIdentity(targetNode);\n         ValidationUtils.verifyString( type, \"type\" );\n-        ValidationUtils.verifyTimeUuid( maxVersion, \"maxVersion\" );\n+        EdgeUtils.validateTimestamp(  maxTimestamp, \"maxTimestamp\" );\n \n \n         this.sourceNode = sourceNode;\n         this.targetNode = targetNode;\n         this.type = type;\n-        this.maxVersion = maxVersion;\n+        this.maxTimestamp = maxTimestamp;\n         this.last = Optional.fromNullable(last);\n     }\n \n@@ -85,8 +86,8 @@ public String getType() {\n \n \n     @Override\n-    public UUID getMaxVersion() {\n-        return maxVersion;\n+    public long getMaxTimestamp() {\n+        return maxTimestamp;\n     }\n \n ",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdge.java",
                "status": "modified",
                "changes": 15,
                "deletions": 7,
                "sha": "e0dbc296323cc3678cc3287f0cb79884d45f0901",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdge.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdge.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdge.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -25,6 +25,7 @@\n import org.apache.usergrid.persistence.core.util.ValidationUtils;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.SearchByEdgeType;\n+import org.apache.usergrid.persistence.graph.serialization.util.EdgeUtils;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.common.base.Optional;\n@@ -38,26 +39,26 @@\n \n     private final Id node;\n     private final String type;\n-    private final UUID maxVersion;\n+    private final long maxTimestamp;\n     private final Optional<Edge> last;\n \n \n     /**\n      * Create the search modules\n      * @param node The node to search from\n      * @param type The edge type\n-     * @param maxVersion The maximum version to return\n+     * @param maxTimestamp The maximum timestamp to return\n      * @param last The value to start seeking from.  Must be >= this value\n      */\n-    public SimpleSearchByEdgeType( final Id node, final String type, final UUID maxVersion, final Edge last ) {\n+    public SimpleSearchByEdgeType( final Id node, final String type, final long maxTimestamp, final Edge last ) {\n         ValidationUtils.verifyIdentity(node);\n         ValidationUtils.verifyString( type, \"type\" );\n-        ValidationUtils.verifyTimeUuid( maxVersion, \"maxVersion\" );\n+        EdgeUtils.validateTimestamp(maxTimestamp, \"maxTimestamp\");\n \n \n         this.node = node;\n         this.type = type;\n-        this.maxVersion = maxVersion;\n+        this.maxTimestamp = maxTimestamp;\n         this.last = Optional.fromNullable(last);\n     }\n \n@@ -75,8 +76,8 @@ public String getType() {\n \n \n     @Override\n-    public UUID getMaxVersion() {\n-        return maxVersion;\n+    public long getMaxTimestamp() {\n+        return maxTimestamp;\n     }\n \n \n@@ -91,16 +92,16 @@ public boolean equals( final Object o ) {\n         if ( this == o ) {\n             return true;\n         }\n-        if ( o == null || getClass() != o.getClass() ) {\n+        if ( !( o instanceof SimpleSearchByEdgeType ) ) {\n             return false;\n         }\n \n         final SimpleSearchByEdgeType that = ( SimpleSearchByEdgeType ) o;\n \n-        if ( !last.equals( that.last ) ) {\n+        if ( maxTimestamp != that.maxTimestamp ) {\n             return false;\n         }\n-        if ( !maxVersion.equals( that.maxVersion ) ) {\n+        if ( !last.equals( that.last ) ) {\n             return false;\n         }\n         if ( !node.equals( that.node ) ) {\n@@ -118,7 +119,7 @@ public boolean equals( final Object o ) {\n     public int hashCode() {\n         int result = node.hashCode();\n         result = 31 * result + type.hashCode();\n-        result = 31 * result + maxVersion.hashCode();\n+        result = 31 * result + ( int ) ( maxTimestamp ^ ( maxTimestamp >>> 32 ) );\n         result = 31 * result + last.hashCode();\n         return result;\n     }",
                "additions": 12,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdgeType.java",
                "status": "modified",
                "changes": 23,
                "deletions": 11,
                "sha": "75e921788ffa8c8a255684c2bf93915df4d11508",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdgeType.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdgeType.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByEdgeType.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -41,13 +41,13 @@\n      *\n      * @param node The node to search from\n      * @param type The edge type\n-     * @param maxVersion The maximum version to return\n+     * @param maxTimestamp The maximum version to search\n      * @param idType The id type on the edge\n      * @param last The value to start seeking from.  Must be >= this value\n \n      */\n-    public SimpleSearchByIdType( final Id node, final String type, final UUID maxVersion, final String idType, final Edge last  ) {\n-        super( node, type, maxVersion, last );\n+    public SimpleSearchByIdType( final Id node, final String type, final long maxTimestamp, final String idType, final Edge last  ) {\n+        super( node, type, maxTimestamp, last );\n \n         ValidationUtils.verifyString( idType, \"idType\" );\n         this.idType = idType;",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByIdType.java",
                "status": "modified",
                "changes": 6,
                "deletions": 3,
                "sha": "6d5fb9f8f46bf6798fd8a225a876eaeed7a3267c",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByIdType.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByIdType.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/SimpleSearchByIdType.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -138,7 +138,7 @@ public void call( final MarkedEdge markedEdge ) {\n \n                 final SimpleSearchByEdge search =\n                         new SimpleSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getTargetNode(),\n-                                edge.getVersion(), null );\n+                                edge.getTimestamp(), null );\n \n                 return serialization.getEdgeVersions( scope, search );\n             }",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairImpl.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "554a3ba703de8aa86cace53e2fa1cbe4252a037f",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -39,12 +39,12 @@\n      * @param scope The scope to use\n      * @param sourceId The source Id to use\n      * @param edgeType The edge type\n-     * @param version The max version to clean\n+     * @param maxTimestamp The max timestamp to clean\n      *\n      * @return An observable that emits the total number of sub types still in use.  0 implies the type and subtypes\n      *         have been removed.  Anything > 0 implies the edgeType and subTypes are still in use\n      */\n-    public Observable<Integer> repairSources( ApplicationScope scope, Id sourceId, String edgeType, UUID version );\n+    public Observable<Integer> repairSources( ApplicationScope scope, Id sourceId, String edgeType, long maxTimestamp );\n \n \n     /**\n@@ -53,10 +53,10 @@\n      * @param scope The scope to use\n      * @param targetId The target Id to use\n      * @param edgeType The edge type\n-     * @param version The max version to clean\n+     * @param maxTimestamp The max version to clean\n      *\n      * @return An observable that emits the total number of sub types still in use.  0 implies the type and subtypes\n      *         have been removed.  Anything > 0 implies the edgeType and subTypes are still in use\n      */\n-    public Observable<Integer> repairTargets( ApplicationScope scope, Id targetId, String edgeType, UUID version );\n+    public Observable<Integer> repairTargets( ApplicationScope scope, Id targetId, String edgeType, long maxTimestamp );\n }",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepair.java",
                "status": "modified",
                "changes": 8,
                "deletions": 4,
                "sha": "f98b0fa1d4fdfe699e71a556d5a06810e2e76850",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepair.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepair.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepair.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -38,6 +38,7 @@\n import org.apache.usergrid.persistence.graph.serialization.EdgeMetadataSerialization;\n import org.apache.usergrid.persistence.graph.serialization.impl.MergedEdgeReader;\n import org.apache.usergrid.persistence.core.rx.ObservableIterator;\n+import org.apache.usergrid.persistence.graph.serialization.util.EdgeUtils;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.common.base.Preconditions;\n@@ -90,31 +91,31 @@ public EdgeMetaRepairImpl( final EdgeMetadataSerialization edgeMetadataSerializa\n \n     @Override\n     public Observable<Integer> repairSources( final ApplicationScope scope, final Id sourceId, final String edgeType,\n-                                              final UUID version ) {\n+                                              final long maxTimestamp ) {\n \n \n-        return clearTypes( scope, sourceId, edgeType, version, source );\n+        return clearTypes( scope, sourceId, edgeType, maxTimestamp, source );\n     }\n \n \n     @Override\n     public Observable<Integer> repairTargets( final ApplicationScope scope, final Id targetId, final String edgeType,\n-                                              final UUID version ) {\n-        return clearTypes( scope, targetId, edgeType, version, target );\n+                                              final long maxTimestamp) {\n+        return clearTypes( scope, targetId, edgeType, maxTimestamp, target );\n     }\n \n \n     private Observable<Integer> clearTypes( final ApplicationScope scope, final Id node, final String edgeType,\n-                                            final UUID version, final CleanSerialization serialization ) {\n+                                            final long maxTimestamp, final CleanSerialization serialization ) {\n \n         ValidationUtils.validateApplicationScope( scope );\n         ValidationUtils.verifyIdentity( node );\n         Preconditions.checkNotNull( edgeType, \"edge type is required\" );\n-        Preconditions.checkNotNull( version, \"version is required\" );\n+        EdgeUtils.validateTimestamp( maxTimestamp, \"maxTimestamp\" );\n         Preconditions.checkNotNull( serialization, \"serialization is required\" );\n \n \n-        Observable<Integer> deleteCounts = serialization.loadEdgeSubTypes( scope, node, edgeType, version )\n+        Observable<Integer> deleteCounts = serialization.loadEdgeSubTypes( scope, node, edgeType, maxTimestamp )\n                 .buffer( graphFig.getRepairConcurrentSize() )\n                         //buffer them into concurrent groups based on the concurrent repair size\n                 .flatMap( new Func1<List<String>, Observable<Integer>>() {\n@@ -135,7 +136,7 @@ public EdgeMetaRepairImpl( final EdgeMetadataSerialization edgeMetadataSerializa\n \n                             Observable<Integer> search =\n                                     //load each edge in it's own thread\n-                                    serialization.loadEdges( scope, node, edgeType, subType, version ).doOnNext( RX_LOG ).take( 1 ).count()\n+                                    serialization.loadEdges( scope, node, edgeType, subType, maxTimestamp ).doOnNext( RX_LOG ).take( 1 ).count()\n                                                  .doOnNext( new Action1<Integer>() {\n \n                                                      @Override\n@@ -163,7 +164,7 @@ public void call( final Integer count ) {\n                                                                  subType );\n                                                          batch.mergeShallow( serialization\n                                                                  .removeEdgeSubType( scope, node, edgeType, subType,\n-                                                                         version ) );\n+                                                                         maxTimestamp ) );\n                                                      }\n                                                  } );\n \n@@ -210,15 +211,15 @@ public void call( final Integer subTypeUsedCount ) {\n                  * We can only execute deleting this type if no sub types were deleted\n                  */\n                 if ( subTypeUsedCount != 0 ) {\n-                    LOG.debug( \"Type {} has {} subtypes in use as of version {}.  Not deleting type.\", edgeType,\n-                            subTypeUsedCount, version );\n+                    LOG.debug( \"Type {} has {} subtypes in use as of maxTimestamp {}.  Not deleting type.\", edgeType,\n+                            subTypeUsedCount, maxTimestamp );\n                     return;\n                 }\n \n                 try {\n \n-                    LOG.debug( \"Type {} has no subtypes in use as of version {}.  Deleting type.\", edgeType, version );\n-                    serialization.removeEdgeType( scope, node, edgeType, version ).execute();\n+                    LOG.debug( \"Type {} has no subtypes in use as of maxTimestamp {}.  Deleting type.\", edgeType, maxTimestamp );\n+                    serialization.removeEdgeType( scope, node, edgeType, maxTimestamp ).execute();\n                 }\n                 catch ( ConnectionException e ) {\n                     throw new RuntimeException( \"Unable to execute mutation\" );\n@@ -234,29 +235,29 @@ public void call( final Integer subTypeUsedCount ) {\n     private static interface CleanSerialization {\n \n         /**\n-         * Load all subtypes for the edge with a version <= the provided version\n+         * Load all subtypes for the edge with a maxTimestamp <= the provided maxTimestamp\n          */\n         Observable<String> loadEdgeSubTypes( final ApplicationScope scope, final Id nodeId, final String type,\n-                                             final UUID version );\n+                                             final long maxTimestamp );\n \n \n         /**\n          * Load an observable with edges from the details provided\n          */\n         Observable<MarkedEdge> loadEdges( final ApplicationScope scope, final Id nodeId, final String edgeType,\n-                                          final String subType, final UUID version );\n+                                          final String subType, final long maxTimestamp );\n \n         /**\n          * Remove the sub type specified\n          */\n         MutationBatch removeEdgeSubType( final ApplicationScope scope, final Id nodeId, final String edgeType,\n-                                         final String subType, final UUID version );\n+                                         final String subType, final long maxTimestamp );\n \n         /**\n          * Remove the edge type\n          */\n         MutationBatch removeEdgeType( final ApplicationScope scope, final Id nodeId, final String type,\n-                                      final UUID version );\n+                                      final long maxTimestamp );\n     }\n \n \n@@ -268,7 +269,7 @@ MutationBatch removeEdgeType( final ApplicationScope scope, final Id nodeId, fin\n \n         @Override\n         public Observable<String> loadEdgeSubTypes( final ApplicationScope scope, final Id nodeId,\n-                                                    final String edgeType, final UUID version ) {\n+                                                    final String edgeType, final long maxTimestamp ) {\n \n \n             return Observable.create( new ObservableIterator<String>( \"edgeTargetIdTypes\" ) {\n@@ -283,23 +284,23 @@ MutationBatch removeEdgeType( final ApplicationScope scope, final Id nodeId, fin\n \n         @Override\n         public Observable<MarkedEdge> loadEdges( final ApplicationScope scope, final Id nodeId, final String edgeType,\n-                                                 final String subType, final UUID version ) {\n+                                                 final String subType, final long maxTimestamp ) {\n             return mergedEdgeReader.getEdgesToTargetBySourceType( scope,\n-                    new SimpleSearchByIdType( nodeId, edgeType, version, subType, null ) );\n+                    new SimpleSearchByIdType( nodeId, edgeType, maxTimestamp, subType, null ) );\n         }\n \n \n         @Override\n         public MutationBatch removeEdgeSubType( final ApplicationScope scope, final Id nodeId, final String type,\n-                                                final String subType, final UUID version ) {\n-            return edgeMetadataSerialization.removeIdTypeToTarget( scope, nodeId, type, subType, version );\n+                                                final String subType, final long maxTimestamp ) {\n+            return edgeMetadataSerialization.removeIdTypeToTarget( scope, nodeId, type, subType, maxTimestamp );\n         }\n \n \n         @Override\n         public MutationBatch removeEdgeType( final ApplicationScope scope, final Id nodeId, final String type,\n-                                             final UUID version ) {\n-            return edgeMetadataSerialization.removeEdgeTypeToTarget( scope, nodeId, type, version );\n+                                             final long maxTimestamp ) {\n+            return edgeMetadataSerialization.removeEdgeTypeToTarget( scope, nodeId, type, maxTimestamp );\n         }\n     };\n \n@@ -310,7 +311,7 @@ public MutationBatch removeEdgeType( final ApplicationScope scope, final Id node\n \n         @Override\n         public Observable<String> loadEdgeSubTypes( final ApplicationScope scope, final Id nodeId,\n-                                                    final String edgeType, final UUID version ) {\n+                                                    final String edgeType, final long maxTimestamp ) {\n             return Observable.create( new ObservableIterator<String>( \"edgeSourceIdTypes\" ) {\n                 @Override\n                 protected Iterator<String> getIterator() {\n@@ -323,24 +324,24 @@ public MutationBatch removeEdgeType( final ApplicationScope scope, final Id node\n \n         @Override\n         public Observable<MarkedEdge> loadEdges( final ApplicationScope scope, final Id nodeId, final String edgeType,\n-                                                 final String subType, final UUID version ) {\n+                                                 final String subType, final long maxTimestamp ) {\n \n             return mergedEdgeReader.getEdgesFromSourceByTargetType( scope,\n-                    new SimpleSearchByIdType( nodeId, edgeType, version, subType, null ) );\n+                    new SimpleSearchByIdType( nodeId, edgeType, maxTimestamp, subType, null ) );\n         }\n \n \n         @Override\n         public MutationBatch removeEdgeSubType( final ApplicationScope scope, final Id nodeId, final String type,\n-                                                final String subType, final UUID version ) {\n-            return edgeMetadataSerialization.removeIdTypeFromSource( scope, nodeId, type, subType, version );\n+                                                final String subType, final long maxTimestamp ) {\n+            return edgeMetadataSerialization.removeIdTypeFromSource( scope, nodeId, type, subType, maxTimestamp );\n         }\n \n \n         @Override\n         public MutationBatch removeEdgeType( final ApplicationScope scope, final Id nodeId, final String type,\n-                                             final UUID version ) {\n-            return edgeMetadataSerialization.removeEdgeTypeFromSource( scope, nodeId, type, version );\n+                                             final long maxTimestamp ) {\n+            return edgeMetadataSerialization.removeEdgeTypeFromSource( scope, nodeId, type, maxTimestamp );\n         }\n     };\n ",
                "additions": 33,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairImpl.java",
                "status": "modified",
                "changes": 65,
                "deletions": 32,
                "sha": "01ad9c435914bffd10e6565089763c20ed70571b",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -78,18 +78,18 @@ public EdgeWriteCompactImpl( @CommitLogEdgeSerialization final EdgeSerialization\n        }\n \n     @Override\n-    public Observable<Integer> compact( final ApplicationScope scope, final MarkedEdge edge, final UUID timestamp ) {\n+    public Observable<Integer> compact( final ApplicationScope scope, final MarkedEdge edge, final UUID operationTimestamp ) {\n         final Edge writtenEdge = edge;\n \n-              final UUID writeVersion = edge.getVersion();\n+              final long timestamp = edge.getTimestamp();\n \n               return Observable.create( new ObservableIterator<MarkedEdge>( \"getEdgeVersions\" ) {\n                   @Override\n                   protected Iterator<MarkedEdge> getIterator() {\n                       //get our edge as it exists in the commit log\n                       return commitLog.getEdgeVersions( scope,\n                               new SimpleSearchByEdge( writtenEdge.getSourceNode(), writtenEdge.getType(),\n-                                      writtenEdge.getTargetNode(), writeVersion, null ) );\n+                                      writtenEdge.getTargetNode(), timestamp, null ) );\n                   }\n               } )\n                               //buffer them, then execute mutations in batch\n@@ -106,10 +106,10 @@ public EdgeWriteCompactImpl( @CommitLogEdgeSerialization final EdgeSerialization\n                                   LOG.debug( \"Buffering edge {} to permanent storage and removing from commitlog\", edge );\n \n                                   //batch the write\n-                                  storageWriteBatch.mergeShallow( permanentStorage.writeEdge( scope, edge, timestamp ) );\n+                                  storageWriteBatch.mergeShallow( permanentStorage.writeEdge( scope, edge, operationTimestamp ) );\n \n                                   //batch the cleanup\n-                                  commitlogCleanBatch.mergeShallow( commitLog.deleteEdge( scope, edge, timestamp ) );\n+                                  commitlogCleanBatch.mergeShallow( commitLog.deleteEdge( scope, edge, operationTimestamp ) );\n                               }\n \n ",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeWriteCompactImpl.java",
                "status": "modified",
                "changes": 10,
                "deletions": 5,
                "sha": "3a89c7806a8412016c6e90292644ac7a751cef4d",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeWriteCompactImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeWriteCompactImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeWriteCompactImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -62,11 +62,11 @@\n      * @param scope Organization scope\n      * @param sourceNode Source node\n      * @param type The edge type\n-     * @param version The version to use on the delete\n+     * @param timestamp The version to use on the delete\n      *\n      * @return A mutation batch to use on issuing the delelete\n      */\n-    MutationBatch removeEdgeTypeFromSource( ApplicationScope scope, Id sourceNode, String type, UUID version );\n+    MutationBatch removeEdgeTypeFromSource( ApplicationScope scope, Id sourceNode, String type, long timestamp );\n \n     /**\n      * Remove all meta data from the source to the target type.  The caller must ensure that this is the last edge with\n@@ -88,12 +88,12 @@\n      * @param sourceNode Source node\n      * @param type The edge type\n      * @param idType The idType to use\n-     * @param version The version to use on the delete\n+     * @param timestamp The version to use on the delete\n      *\n      * @return a mutation batch with the delete operations\n      */\n     MutationBatch removeIdTypeFromSource( ApplicationScope scope, Id sourceNode, String type, String idType,\n-                                          UUID version );\n+                                          long timestamp );\n \n     /**\n      * Remove all meta data from the target to the source type.  The caller must ensure that this is the last edge with\n@@ -114,11 +114,11 @@ MutationBatch removeIdTypeFromSource( ApplicationScope scope, Id sourceNode, Str\n      * @param scope Organization scope\n      * @param targetNode Source node\n      * @param type The edge type\n-     * @param version The version to use on the delete\n+     * @param timestamp The version to use on the delete\n      *\n      * @return A mutation batch to use on issuing the delelete\n      */\n-    MutationBatch removeEdgeTypeToTarget( ApplicationScope scope, Id targetNode, String type, UUID version );\n+    MutationBatch removeEdgeTypeToTarget( ApplicationScope scope, Id targetNode, String type, long timestamp );\n \n \n     /**\n@@ -141,12 +141,12 @@ MutationBatch removeIdTypeFromSource( ApplicationScope scope, Id sourceNode, Str\n      * @param targetNode Source node\n      * @param type The edge type\n      * @param idType The idType to use\n-     * @param version The version to use on the delete\n+     * @param timestamp The version to use on the delete\n      *\n      * @return a mutation batch with the delete operations\n      */\n     MutationBatch removeIdTypeToTarget( ApplicationScope scope, Id targetNode, String type, String idType,\n-                                        UUID version );\n+                                        long timestamp );\n \n     /**\n      * Get all edge types from the given source node",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerialization.java",
                "status": "modified",
                "changes": 16,
                "deletions": 8,
                "sha": "cc62a42589cbcee939cee241d392974ac020317c",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerialization.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerialization.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerialization.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -44,9 +44,9 @@\n      *\n      * @param scope The org scope of the graph\n      * @param node The node to mark\n-     * @param version The version to mark for deletion\n+     * @param timestamp The timestamp to mark for deletion.  Anything <= this time is considered deleted from the graph\n      */\n-    MutationBatch mark( ApplicationScope scope, Id node, UUID version );\n+    MutationBatch mark( ApplicationScope scope, Id node, long timestamp );\n \n \n     /**\n@@ -55,16 +55,16 @@\n      * @param node\n      * @return\n      */\n-    MutationBatch delete( ApplicationScope scope, Id node, UUID version );\n+    MutationBatch delete( ApplicationScope scope, Id node, long timestamp );\n \n     /**\n-     * Get the maximum version of a node marked for deletion.  If the node has no mark\n+     * Get the maximum timestamp of a node marked for deletion.  If the node has no mark\n      * the optional will return empty\n      * @param scope The scope to search in\n      * @param nodeId The node id\n-     * @return The optional uuid.  If none is present, the node is not currently marked\n+     * @return The optional timestamp.  If none is present, the node is not currently marked\n      */\n-    Optional<UUID> getMaxVersion(ApplicationScope scope, Id nodeId);\n+    Optional<Long> getMaxVersion(ApplicationScope scope, Id nodeId);\n \n     /**\n      * Return a map with all max versions from the specified nodeIds.  If no max version is present\n@@ -74,5 +74,5 @@\n      * @param edges The collection of edges we need to check against.  Both the source and target Id's will be added\n      * @return A map of all marked Id's, with the mark version as the value\n      */\n-    Map<Id, UUID> getMaxVersions(ApplicationScope scope, Collection<? extends Edge> edges);\n+    Map<Id, Long> getMaxVersions(ApplicationScope scope, Collection<? extends Edge> edges);\n }",
                "additions": 7,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/NodeSerialization.java",
                "status": "modified",
                "changes": 14,
                "deletions": 7,
                "sha": "96f869dcc0b1861eb257cb3420efbdccd9661539",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/NodeSerialization.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/NodeSerialization.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/NodeSerialization.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -141,7 +141,7 @@ public MutationBatch writeEdge( final ApplicationScope scope, final Edge edge )\n         final Id source = edge.getSourceNode();\n         final Id target = edge.getTargetNode();\n         final String edgeType = edge.getType();\n-        final long timestamp = CassUtils.getTimestamp( edge.getVersion() );\n+        final long timestamp = edge.getTimestamp();\n \n         final MutationBatch batch = keyspace.prepareMutationBatch().withConsistencyLevel( cassandraConfig.getWriteCL() ).withTimestamp( timestamp );\n \n@@ -184,54 +184,54 @@ public MutationBatch writeEdge( final ApplicationScope scope, final Edge edge )\n \n     @Override\n     public MutationBatch removeEdgeTypeFromSource( final ApplicationScope scope, final Edge edge ) {\n-        return removeEdgeTypeFromSource( scope, edge.getSourceNode(), edge.getType(), edge.getVersion() );\n+        return removeEdgeTypeFromSource( scope, edge.getSourceNode(), edge.getType(), edge.getTimestamp() );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeFromSource( final ApplicationScope scope, final Id sourceNode,\n-                                                   final String type, final UUID version ) {\n+                                                   final String type, final long version ) {\n         return removeEdgeType( scope, sourceNode, type, version, CF_SOURCE_EDGE_TYPES );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeFromSource( final ApplicationScope scope, final Edge edge ) {\n         return removeIdTypeFromSource( scope, edge.getSourceNode(), edge.getType(), edge.getTargetNode().getType(),\n-                edge.getVersion() );\n+                edge.getTimestamp() );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeFromSource( final ApplicationScope scope, final Id sourceNode, final String type,\n-                                                 final String idType, final UUID version ) {\n+                                                 final String idType, final long version ) {\n         return removeIdType( scope, sourceNode, idType, type, version, CF_SOURCE_EDGE_ID_TYPES );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeToTarget( final ApplicationScope scope, final Edge edge ) {\n-        return removeEdgeTypeToTarget( scope, edge.getTargetNode(), edge.getType(), edge.getVersion() );\n+        return removeEdgeTypeToTarget( scope, edge.getTargetNode(), edge.getType(), edge.getTimestamp() );\n     }\n \n \n     @Override\n     public MutationBatch removeEdgeTypeToTarget( final ApplicationScope scope, final Id targetNode, final String type,\n-                                                 final UUID version ) {\n+                                                 final long version ) {\n         return removeEdgeType( scope, targetNode, type, version, CF_TARGET_EDGE_TYPES );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeToTarget( final ApplicationScope scope, final Edge edge ) {\n         return removeIdTypeToTarget( scope, edge.getTargetNode(), edge.getType(), edge.getSourceNode().getType(),\n-                edge.getVersion() );\n+                edge.getTimestamp() );\n     }\n \n \n     @Override\n     public MutationBatch removeIdTypeToTarget( final ApplicationScope scope, final Id targetNode, final String type,\n-                                               final String idType, final UUID version ) {\n+                                               final String idType, final long version ) {\n         return removeIdType( scope, targetNode, idType, type, version, CF_TARGET_EDGE_ID_TYPES );\n     }\n \n@@ -246,17 +246,16 @@ public MutationBatch removeIdTypeToTarget( final ApplicationScope scope, final I\n      * @param cf The column family\n      */\n     private MutationBatch removeEdgeType( final ApplicationScope scope, final Id rowKeyId, final String edgeType,\n-                                          final UUID version,\n+                                          final long version,\n                                           final MultiTennantColumnFamily<ApplicationScope, Id, String> cf ) {\n \n-        final long timestamp = CassUtils.getTimestamp( version );\n+\n \n \n         //write target<--source edge type meta data\n         final ScopedRowKey<ApplicationScope, Id> rowKey = new ScopedRowKey<ApplicationScope, Id>( scope, rowKeyId );\n \n-\n-        final MutationBatch batch = keyspace.prepareMutationBatch().withTimestamp( timestamp );\n+        final MutationBatch batch = keyspace.prepareMutationBatch().withTimestamp( version );\n \n         batch.withRow( cf, rowKey ).deleteColumn( edgeType );\n \n@@ -277,14 +276,11 @@ private MutationBatch removeEdgeType( final ApplicationScope scope, final Id row\n      * @return A populated mutation with the remove operations\n      */\n     private MutationBatch removeIdType( final ApplicationScope scope, final Id rowId, final String idType,\n-                                        final String edgeType, final UUID version,\n+                                        final String edgeType, final long version,\n                                         final MultiTennantColumnFamily<ApplicationScope, EdgeIdTypeKey, String> cf ) {\n \n \n-\n-        final long timestamp = CassUtils.getTimestamp( version );\n-\n-        final   MutationBatch batch = keyspace.prepareMutationBatch().withTimestamp( timestamp );\n+          final   MutationBatch batch = keyspace.prepareMutationBatch().withTimestamp( version );\n \n \n ",
                "additions": 14,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationImpl.java",
                "status": "modified",
                "changes": 32,
                "deletions": 18,
                "sha": "dba8356198c9e7081a8174294961b17e1b025d5e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeMetadataSerializationImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -30,20 +30,21 @@\n import javax.inject.Inject;\n \n import org.apache.cassandra.db.marshal.BytesType;\n+import org.apache.cassandra.db.marshal.DynamicCompositeType;\n \n import org.apache.usergrid.persistence.core.astyanax.CassandraConfig;\n-import org.apache.usergrid.persistence.core.astyanax.ColumnTypes;\n-import org.apache.usergrid.persistence.core.astyanax.OrganizationScopedRowKeySerializer;\n-import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.core.astyanax.ColumnNameIterator;\n import org.apache.usergrid.persistence.core.astyanax.ColumnParser;\n+import org.apache.usergrid.persistence.core.astyanax.ColumnTypes;\n import org.apache.usergrid.persistence.core.astyanax.CompositeFieldSerializer;\n import org.apache.usergrid.persistence.core.astyanax.IdColDynamicCompositeSerializer;\n import org.apache.usergrid.persistence.core.astyanax.IdRowCompositeSerializer;\n import org.apache.usergrid.persistence.core.astyanax.MultiTennantColumnFamily;\n import org.apache.usergrid.persistence.core.astyanax.MultiTennantColumnFamilyDefinition;\n+import org.apache.usergrid.persistence.core.astyanax.OrganizationScopedRowKeySerializer;\n import org.apache.usergrid.persistence.core.astyanax.ScopedRowKey;\n import org.apache.usergrid.persistence.core.migration.Migration;\n+import org.apache.usergrid.persistence.core.scope.ApplicationScope;\n import org.apache.usergrid.persistence.core.util.ValidationUtils;\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.graph.GraphFig;\n@@ -71,15 +72,18 @@\n import com.netflix.astyanax.model.DynamicComposite;\n import com.netflix.astyanax.query.RowQuery;\n import com.netflix.astyanax.serializers.AbstractSerializer;\n+import com.netflix.astyanax.serializers.LongSerializer;\n+import com.netflix.astyanax.serializers.StringSerializer;\n import com.netflix.astyanax.serializers.UUIDSerializer;\n import com.netflix.astyanax.util.RangeBuilder;\n \n import static com.google.common.base.Preconditions.checkNotNull;\n+import static org.apache.usergrid.persistence.core.astyanax.ColumnTypes.LONG_TYPE_REVERSED;\n+import static org.apache.usergrid.persistence.core.astyanax.ColumnTypes.UUID_TYPE_REVERSED;\n \n \n /**\n- *  Serialization for edges.  Delegates partitioning to the sharding strategy.\n- *\n+ * Serialization for edges.  Delegates partitioning to the sharding strategy.\n  */\n @Singleton\n public class EdgeSerializationImpl implements EdgeSerialization, Migration {\n@@ -96,13 +100,23 @@\n     //Edge serializers\n     private static final EdgeSerializer EDGE_SERIALIZER = new EdgeSerializer();\n \n-    private static final UUIDSerializer UUID_SERIALIZER = UUIDSerializer.get();\n+    private static final LongSerializer LONG_SERIALIZER = LongSerializer.get();\n+\n+\n+    /**\n+     * Constant for the dynamic composite comparator type we'll need\n+     */\n+    public static final String EDGE_DYNAMIC_COMPOSITE_TYPE =\n+            //we purposefully associate lower case \"l\" and \"u\" with reversed types.  This way we can use\n+            //the default serialization in Astayanax, but get reverse order in cassandra\n+            DynamicCompositeType.class.getSimpleName() + \"(s=>UTF8Type,l=>\" + LONG_TYPE_REVERSED + \",u=>\"\n+                    + UUID_TYPE_REVERSED + \")\";\n \n \n     /**\n      * Get all graph edge versions\n      */\n-    private final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, UUID> graphEdgeVersionsCf;\n+    private final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, Long> graphEdgeVersionsCf;\n \n \n     // column families\n@@ -153,31 +167,26 @@ public EdgeSerializationImpl( final Keyspace keyspace, final CassandraConfig cas\n         this.edgeShardStrategy = edgeShardStrategy;\n \n         //initialize the CF's from our implementation\n-        sourceNodeEdgesCf = new MultiTennantColumnFamily<ApplicationScope, RowKey, DirectedEdge>(\n-                edgeShardStrategy.getSourceNodeCfName(),\n-                new OrganizationScopedRowKeySerializer<RowKey>( ROW_SERIALIZER ), EDGE_SERIALIZER );\n+        sourceNodeEdgesCf = new MultiTennantColumnFamily<>( edgeShardStrategy.getSourceNodeCfName(),\n+                new OrganizationScopedRowKeySerializer<>( ROW_SERIALIZER ), EDGE_SERIALIZER );\n \n \n-        targetNodeEdgesCf = new MultiTennantColumnFamily<ApplicationScope, RowKey, DirectedEdge>(\n-                edgeShardStrategy.getTargetNodeCfName(),\n-                new OrganizationScopedRowKeySerializer<RowKey>( ROW_SERIALIZER ), EDGE_SERIALIZER );\n+        targetNodeEdgesCf = new MultiTennantColumnFamily<>( edgeShardStrategy.getTargetNodeCfName(),\n+                new OrganizationScopedRowKeySerializer<>( ROW_SERIALIZER ), EDGE_SERIALIZER );\n \n \n-        sourceNodeTargetTypeCf = new MultiTennantColumnFamily<ApplicationScope, RowKeyType, DirectedEdge>(\n-                edgeShardStrategy.getSourceNodeTargetTypeCfName(),\n-                new OrganizationScopedRowKeySerializer<RowKeyType>( ROW_TYPE_SERIALIZER ), EDGE_SERIALIZER );\n+        sourceNodeTargetTypeCf = new MultiTennantColumnFamily<>( edgeShardStrategy.getSourceNodeTargetTypeCfName(),\n+                new OrganizationScopedRowKeySerializer<>( ROW_TYPE_SERIALIZER ), EDGE_SERIALIZER );\n \n \n         /**\n          * The edges that are to the target node with the source type.  The target node is the row key\n          */\n-        targetNodeSourceTypeCf = new MultiTennantColumnFamily<ApplicationScope, RowKeyType, DirectedEdge>(\n-                edgeShardStrategy.getTargetNodeSourceTypeCfName(),\n-                new OrganizationScopedRowKeySerializer<RowKeyType>( ROW_TYPE_SERIALIZER ), EDGE_SERIALIZER );\n+        targetNodeSourceTypeCf = new MultiTennantColumnFamily<>( edgeShardStrategy.getTargetNodeSourceTypeCfName(),\n+                new OrganizationScopedRowKeySerializer<>( ROW_TYPE_SERIALIZER ), EDGE_SERIALIZER );\n \n-        graphEdgeVersionsCf = new MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, UUID>(\n-                edgeShardStrategy.getGraphEdgeVersions(),\n-                new OrganizationScopedRowKeySerializer<EdgeRowKey>( EDGE_ROW_KEY_SERIALIZER ), UUID_SERIALIZER );\n+        graphEdgeVersionsCf = new MultiTennantColumnFamily<>( edgeShardStrategy.getGraphEdgeVersions(),\n+                new OrganizationScopedRowKeySerializer<>( EDGE_ROW_KEY_SERIALIZER ), LONG_SERIALIZER );\n     }\n \n \n@@ -188,8 +197,8 @@ public MutationBatch writeEdge( final ApplicationScope scope, final MarkedEdge m\n         ValidationUtils.verifyTimeUuid( timestamp, \"timestamp\" );\n \n \n-        final MutationBatch batch =\n-                keyspace.prepareMutationBatch().withConsistencyLevel( cassandraConfig.getWriteCL() ).withTimestamp( timestamp.timestamp() );\n+        final MutationBatch batch = keyspace.prepareMutationBatch().withConsistencyLevel( cassandraConfig.getWriteCL() )\n+                                            .withTimestamp( timestamp.timestamp() );\n \n         final boolean isDeleted = markedEdge.isDeleted();\n \n@@ -209,9 +218,9 @@ public void countEdge( final Id rowId, final long shardId, final String... types\n \n \n             @Override\n-            public void writeVersion( final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, UUID> columnFamily,\n-                                      final EdgeRowKey rowKey, final UUID version ) {\n-                batch.withRow( columnFamily, ScopedRowKey.fromKey( scope, rowKey ) ).putColumn( version, isDeleted );\n+            public void writeVersion( final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, Long> columnFamily,\n+                                      final EdgeRowKey rowKey, final long timestamp ) {\n+                batch.withRow( columnFamily, ScopedRowKey.fromKey( scope, rowKey ) ).putColumn( timestamp, isDeleted );\n             }\n         } );\n \n@@ -227,8 +236,8 @@ public MutationBatch deleteEdge( final ApplicationScope scope, final MarkedEdge\n         ValidationUtils.verifyTimeUuid( timestamp, \"timestamp\" );\n \n \n-        final MutationBatch batch =\n-                keyspace.prepareMutationBatch().withConsistencyLevel( cassandraConfig.getWriteCL() ).withTimestamp( timestamp.timestamp() );\n+        final MutationBatch batch = keyspace.prepareMutationBatch().withConsistencyLevel( cassandraConfig.getWriteCL() )\n+                                            .withTimestamp( timestamp.timestamp() );\n \n \n         doWrite( scope, markedEdge, new RowOp<RowKey>() {\n@@ -246,9 +255,9 @@ public void countEdge( final Id rowId, final long shardId, final String... types\n \n \n             @Override\n-            public void writeVersion( final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, UUID> columnFamily,\n-                                      final EdgeRowKey rowKey, final UUID version ) {\n-                batch.withRow( columnFamily, ScopedRowKey.fromKey( scope, rowKey ) ).deleteColumn( version );\n+            public void writeVersion( final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, Long> columnFamily,\n+                                      final EdgeRowKey rowKey, final long timestamp ) {\n+                batch.withRow( columnFamily, ScopedRowKey.fromKey( scope, rowKey ) ).deleteColumn( timestamp );\n             }\n         } );\n \n@@ -270,34 +279,34 @@ private void doWrite( final ApplicationScope scope, final MarkedEdge edge, final\n \n         final Id sourceNodeId = edge.getSourceNode();\n         final Id targetNodeId = edge.getTargetNode();\n-        final UUID version = edge.getVersion();\n+        final long timestamp = edge.getTimestamp();\n         final String type = edge.getType();\n \n \n         /**\n          * Key in the serializers based on the edge\n          */\n \n-        final RowKey sourceRowKey =\n-                new RowKey( sourceNodeId, type, edgeShardStrategy.getWriteShard( scope, sourceNodeId, version, type ) );\n+        final RowKey sourceRowKey = new RowKey( sourceNodeId, type,\n+                edgeShardStrategy.getWriteShard( scope, sourceNodeId, timestamp, type ) );\n \n         final RowKeyType sourceRowKeyType = new RowKeyType( sourceNodeId, type, targetNodeId,\n-                edgeShardStrategy.getWriteShard( scope, sourceNodeId, version, type, targetNodeId.getType() ) );\n+                edgeShardStrategy.getWriteShard( scope, sourceNodeId, timestamp, type, targetNodeId.getType() ) );\n \n-        final DirectedEdge sourceEdge = new DirectedEdge( targetNodeId, version );\n+        final DirectedEdge sourceEdge = new DirectedEdge( targetNodeId, timestamp );\n \n \n-        final RowKey targetRowKey =\n-                new RowKey( targetNodeId, type, edgeShardStrategy.getWriteShard( scope, targetNodeId, version, type ) );\n+        final RowKey targetRowKey = new RowKey( targetNodeId, type,\n+                edgeShardStrategy.getWriteShard( scope, targetNodeId, timestamp, type ) );\n \n         final RowKeyType targetRowKeyType = new RowKeyType( targetNodeId, type, sourceNodeId,\n-                edgeShardStrategy.getWriteShard( scope, targetNodeId, version, type, sourceNodeId.getType() ) );\n+                edgeShardStrategy.getWriteShard( scope, targetNodeId, timestamp, type, sourceNodeId.getType() ) );\n \n-        final DirectedEdge targetEdge = new DirectedEdge( sourceNodeId, version );\n+        final DirectedEdge targetEdge = new DirectedEdge( sourceNodeId, timestamp );\n \n \n         final EdgeRowKey edgeRowKey = new EdgeRowKey( sourceNodeId, type, targetNodeId, edgeShardStrategy\n-                .getWriteShard( scope, sourceNodeId, version, type, targetNodeId.getUuid().toString(),\n+                .getWriteShard( scope, sourceNodeId, timestamp, type, targetNodeId.getUuid().toString(),\n                         targetNodeId.getType() ) );\n \n \n@@ -319,9 +328,9 @@ private void doWrite( final ApplicationScope scope, final MarkedEdge edge, final\n \n \n         /**\n-         * Write this in the version log for this edge of source->target\n+         * Write this in the timestamp log for this edge of source->target\n          */\n-        op.writeVersion( graphEdgeVersionsCf, edgeRowKey, version );\n+        op.writeVersion( graphEdgeVersionsCf, edgeRowKey, timestamp );\n     }\n \n \n@@ -333,15 +342,15 @@ private void doWrite( final ApplicationScope scope, final MarkedEdge edge, final\n         final Id targetId = search.targetNode();\n         final Id sourceId = search.sourceNode();\n         final String type = search.getType();\n-        final UUID maxVersion = search.getMaxVersion();\n+        final long maxTimestamp = search.getMaxTimestamp();\n \n-        final EdgeSearcher<EdgeRowKey, UUID, MarkedEdge> searcher =\n-                new EdgeSearcher<EdgeRowKey, UUID, MarkedEdge>( scope, maxVersion, search.last(),\n-                        edgeShardStrategy.getReadShards( scope, sourceId, maxVersion, type ) ) {\n+        final EdgeSearcher<EdgeRowKey, Long, MarkedEdge> searcher =\n+                new EdgeSearcher<EdgeRowKey, Long, MarkedEdge>( scope, maxTimestamp, search.last(),\n+                        edgeShardStrategy.getReadShards( scope, sourceId, maxTimestamp, type ) ) {\n \n                     @Override\n-                    protected Serializer<UUID> getSerializer() {\n-                        return UUID_SERIALIZER;\n+                    protected Serializer<Long> getSerializer() {\n+                        return LONG_SERIALIZER;\n                     }\n \n \n@@ -355,7 +364,7 @@ public void setRange( final RangeBuilder builder ) {\n                         }\n \n                         //start seeking at a value < our max version\n-                        builder.setStart( maxVersion, UUID_SERIALIZER );\n+                        builder.setStart( maxTimestamp );\n                     }\n \n \n@@ -366,14 +375,14 @@ protected EdgeRowKey generateRowKey( long shard ) {\n \n \n                     @Override\n-                    protected UUID getStartColumn( final Edge last ) {\n-                        return last.getVersion();\n+                    protected Long getStartColumn( final Edge last ) {\n+                        return last.getTimestamp();\n                     }\n \n \n                     @Override\n-                    protected MarkedEdge createEdge( final UUID version, final boolean marked ) {\n-                        return new SimpleMarkedEdge( sourceId, type, targetId, version, marked );\n+                    protected MarkedEdge createEdge( final Long column, final boolean marked ) {\n+                        return new SimpleMarkedEdge( sourceId, type, targetId, column.longValue(), marked );\n                     }\n                 };\n \n@@ -389,11 +398,11 @@ protected MarkedEdge createEdge( final UUID version, final boolean marked ) {\n \n         final Id sourceId = edgeType.getNode();\n         final String type = edgeType.getType();\n-        final UUID maxVersion = edgeType.getMaxVersion();\n+        final long maxTimestamp = edgeType.getMaxTimestamp();\n \n         final EdgeSearcher<RowKey, DirectedEdge, MarkedEdge> searcher =\n-                new EdgeSearcher<RowKey, DirectedEdge, MarkedEdge>( scope, maxVersion, edgeType.last(),\n-                        edgeShardStrategy.getReadShards( scope, sourceId, maxVersion, type ) ) {\n+                new EdgeSearcher<RowKey, DirectedEdge, MarkedEdge>( scope, maxTimestamp, edgeType.last(),\n+                        edgeShardStrategy.getReadShards( scope, sourceId, maxTimestamp, type ) ) {\n \n \n                     @Override\n@@ -410,13 +419,13 @@ protected RowKey generateRowKey( long shard ) {\n \n                     @Override\n                     protected DirectedEdge getStartColumn( final Edge last ) {\n-                        return new DirectedEdge( last.getTargetNode(), last.getVersion() );\n+                        return new DirectedEdge( last.getTargetNode(), last.getTimestamp() );\n                     }\n \n \n                     @Override\n                     protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked ) {\n-                        return new SimpleMarkedEdge( sourceId, type, edge.id, edge.version, marked );\n+                        return new SimpleMarkedEdge( sourceId, type, edge.id, edge.timestamp, marked );\n                     }\n                 };\n \n@@ -434,11 +443,11 @@ protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked )\n         final Id targetId = edgeType.getNode();\n         final String type = edgeType.getType();\n         final String targetType = edgeType.getIdType();\n-        final UUID maxVersion = edgeType.getMaxVersion();\n+        final long maxTimestamp = edgeType.getMaxTimestamp();\n \n         final EdgeSearcher<RowKeyType, DirectedEdge, MarkedEdge> searcher =\n-                new EdgeSearcher<RowKeyType, DirectedEdge, MarkedEdge>( scope, maxVersion, edgeType.last(),\n-                        edgeShardStrategy.getReadShards( scope, targetId, maxVersion, type, targetType ) ) {\n+                new EdgeSearcher<RowKeyType, DirectedEdge, MarkedEdge>( scope, maxTimestamp, edgeType.last(),\n+                        edgeShardStrategy.getReadShards( scope, targetId, maxTimestamp, type, targetType ) ) {\n \n                     @Override\n                     protected Serializer<DirectedEdge> getSerializer() {\n@@ -454,13 +463,13 @@ protected RowKeyType generateRowKey( long shard ) {\n \n                     @Override\n                     protected DirectedEdge getStartColumn( final Edge last ) {\n-                        return new DirectedEdge( last.getTargetNode(), last.getVersion() );\n+                        return new DirectedEdge( last.getTargetNode(), last.getTimestamp() );\n                     }\n \n \n                     @Override\n                     protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked ) {\n-                        return new SimpleMarkedEdge( targetId, type, edge.id, edge.version, marked );\n+                        return new SimpleMarkedEdge( targetId, type, edge.id, edge.timestamp, marked );\n                     }\n                 };\n \n@@ -476,11 +485,11 @@ protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked )\n \n         final Id targetId = edgeType.getNode();\n         final String type = edgeType.getType();\n-        final UUID maxVersion = edgeType.getMaxVersion();\n+        final long maxTimestamp = edgeType.getMaxTimestamp();\n \n         final EdgeSearcher<RowKey, DirectedEdge, MarkedEdge> searcher =\n-                new EdgeSearcher<RowKey, DirectedEdge, MarkedEdge>( scope, maxVersion, edgeType.last(),\n-                        edgeShardStrategy.getReadShards( scope, targetId, maxVersion, type ) ) {\n+                new EdgeSearcher<RowKey, DirectedEdge, MarkedEdge>( scope, maxTimestamp, edgeType.last(),\n+                        edgeShardStrategy.getReadShards( scope, targetId, maxTimestamp, type ) ) {\n \n                     @Override\n                     protected Serializer<DirectedEdge> getSerializer() {\n@@ -496,13 +505,13 @@ protected RowKey generateRowKey( long shard ) {\n \n                     @Override\n                     protected DirectedEdge getStartColumn( final Edge last ) {\n-                        return new DirectedEdge( last.getSourceNode(), last.getVersion() );\n+                        return new DirectedEdge( last.getSourceNode(), last.getTimestamp() );\n                     }\n \n \n                     @Override\n                     protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked ) {\n-                        return new SimpleMarkedEdge( edge.id, type, targetId, edge.version, marked );\n+                        return new SimpleMarkedEdge( edge.id, type, targetId, edge.timestamp, marked );\n                     }\n                 };\n \n@@ -521,12 +530,12 @@ protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked )\n         final Id targetId = edgeType.getNode();\n         final String sourceType = edgeType.getIdType();\n         final String type = edgeType.getType();\n-        final UUID maxVersion = edgeType.getMaxVersion();\n+        final long maxTimestamp = edgeType.getMaxTimestamp();\n \n \n         final EdgeSearcher<RowKeyType, DirectedEdge, MarkedEdge> searcher =\n-                new EdgeSearcher<RowKeyType, DirectedEdge, MarkedEdge>( scope, maxVersion, edgeType.last(),\n-                        edgeShardStrategy.getReadShards( scope, targetId, maxVersion, type, sourceType ) ) {\n+                new EdgeSearcher<RowKeyType, DirectedEdge, MarkedEdge>( scope, maxTimestamp, edgeType.last(),\n+                        edgeShardStrategy.getReadShards( scope, targetId, maxTimestamp, type, sourceType ) ) {\n                     @Override\n                     protected Serializer<DirectedEdge> getSerializer() {\n                         return EDGE_SERIALIZER;\n@@ -541,13 +550,13 @@ protected RowKeyType generateRowKey( final long shard ) {\n \n                     @Override\n                     protected DirectedEdge getStartColumn( final Edge last ) {\n-                        return new DirectedEdge( last.getTargetNode(), last.getVersion() );\n+                        return new DirectedEdge( last.getTargetNode(), last.getTimestamp() );\n                     }\n \n \n                     @Override\n                     protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked ) {\n-                        return new SimpleMarkedEdge( edge.id, type, targetId, edge.version, marked );\n+                        return new SimpleMarkedEdge( edge.id, type, targetId, edge.timestamp, marked );\n                     }\n                 };\n \n@@ -557,21 +566,21 @@ protected MarkedEdge createEdge( final DirectedEdge edge, final boolean marked )\n \n     @Override\n     public Collection<MultiTennantColumnFamilyDefinition> getColumnFamilies() {\n-        return Arrays.asList( graphCf( sourceNodeEdgesCf ), graphCf( targetNodeEdgesCf ),\n-                graphCf( sourceNodeTargetTypeCf ), graphCf( targetNodeSourceTypeCf ),\n-                new MultiTennantColumnFamilyDefinition( graphEdgeVersionsCf, BytesType.class.getSimpleName(),\n-                        ColumnTypes.UUID_TYPE_REVERSED, BytesType.class.getSimpleName(),\n-                        MultiTennantColumnFamilyDefinition.CacheOption.KEYS ) );\n+        return Arrays\n+                .asList( graphCf( sourceNodeEdgesCf ), graphCf( targetNodeEdgesCf ), graphCf( sourceNodeTargetTypeCf ),\n+                        graphCf( targetNodeSourceTypeCf ),\n+                        new MultiTennantColumnFamilyDefinition( graphEdgeVersionsCf, BytesType.class.getSimpleName(),\n+                                ColumnTypes.LONG_TYPE_REVERSED, BytesType.class.getSimpleName(),\n+                                MultiTennantColumnFamilyDefinition.CacheOption.KEYS ) );\n     }\n \n \n     /**\n      * Helper to generate an edge definition by the type\n      */\n     private MultiTennantColumnFamilyDefinition graphCf( MultiTennantColumnFamily cf ) {\n-        return new MultiTennantColumnFamilyDefinition( cf, BytesType.class.getSimpleName(),\n-                ColumnTypes.DYNAMIC_COMPOSITE_TYPE, BytesType.class.getSimpleName(),\n-                MultiTennantColumnFamilyDefinition.CacheOption.KEYS );\n+        return new MultiTennantColumnFamilyDefinition( cf, BytesType.class.getSimpleName(), EDGE_DYNAMIC_COMPOSITE_TYPE,\n+                BytesType.class.getSimpleName(), MultiTennantColumnFamilyDefinition.CacheOption.KEYS );\n     }\n \n \n@@ -580,12 +589,12 @@ private MultiTennantColumnFamilyDefinition graphCf( MultiTennantColumnFamily cf\n      */\n     private static class DirectedEdge {\n \n-        public final UUID version;\n+        public final long timestamp;\n         public final Id id;\n \n \n-        private DirectedEdge( final Id id, final UUID version ) {\n-            this.version = version;\n+        private DirectedEdge( final Id id, final long timestamp ) {\n+            this.timestamp = timestamp;\n             this.id = id;\n         }\n     }\n@@ -597,16 +606,33 @@ private DirectedEdge( final Id id, final UUID version ) {\n      */\n     private static class EdgeSerializer extends AbstractSerializer<DirectedEdge> {\n \n-        private static final IdColDynamicCompositeSerializer ID_COL_SERIALIZER = IdColDynamicCompositeSerializer.get();\n-\n-        private static final UUIDSerializer UUID_SERIALIZER = UUIDSerializer.get();\n+                private static final IdColDynamicCompositeSerializer ID_COL_SERIALIZER =  IdColDynamicCompositeSerializer.get();\n+//        private static final UUIDSerializer UUID_SERIALIZER = UUIDSerializer.get();\n+//        private static final StringSerializer STRING_SERIALIZER = StringSerializer.get().getString(;\n+//        )\n \n \n         @Override\n         public ByteBuffer toByteBuffer( final DirectedEdge edge ) {\n-            final DynamicComposite colValue = createComposite( edge, AbstractComposite.ComponentEquality.EQUAL );\n \n-            return colValue.serialize();\n+            DynamicComposite composite = new DynamicComposite();\n+\n+//            //add our edge\n+//            composite.addComponent( edge.timestamp, LONG_SERIALIZER, LONG_TYPE_REVERSED,\n+//                    AbstractComposite.ComponentEquality.EQUAL );\n+\n+//            //we do this explicity instead of re-using the id composite serializer b/c we want high order\n+//            //time uuids first, not second. In this column family, there is no sort\n+//            composite.addComponent( edge.id.getUuid(), UUID_SERIALIZER, UUID_TYPE_REVERSED,\n+//                    AbstractComposite.ComponentEquality.EQUAL );\n+//\n+//            composite.addComponent( edge.id.getType(), STRING_SERIALIZER );\n+\n+            composite.addComponent( edge.timestamp, LONG_SERIALIZER );\n+\n+            ID_COL_SERIALIZER.toComposite( composite, edge.id);\n+\n+            return composite.serialize();\n         }\n \n \n@@ -618,31 +644,14 @@ public DirectedEdge fromByteBuffer( final ByteBuffer byteBuffer ) {\n \n \n             //return the version\n-            final UUID version = composite.get( 0, UUID_SERIALIZER );\n+            final long timestamp = composite.get( 0, LONG_SERIALIZER );\n \n \n             //parse our id\n             final Id id = ID_COL_SERIALIZER.fromComposite( composite, 1 );\n \n \n-            return new DirectedEdge( id, version );\n-        }\n-\n-\n-        /**\n-         * Create the dynamic composite for this directed edge\n-         */\n-        private DynamicComposite createComposite( DirectedEdge edge, AbstractComposite.ComponentEquality equality ) {\n-            DynamicComposite composite = new DynamicComposite();\n-\n-            //add our edge\n-            composite.addComponent( edge.version, UUID_SERIALIZER, ColumnTypes.UUID_TYPE_REVERSED, equality );\n-\n-\n-            ID_COL_SERIALIZER.toComposite( composite, edge.id );\n-\n-\n-            return composite;\n+            return new DirectedEdge( id, timestamp );\n         }\n     }\n \n@@ -740,15 +749,15 @@ private EdgeRowKey( final Id sourceId, final String edgeType, final Id targetId,\n             implements ColumnParser<C, T>, Iterator<ScopedRowKey<ApplicationScope, R>> {\n \n         protected final Optional<Edge> last;\n-        protected final UUID maxVersion;\n+        protected final long maxTimestamp;\n         protected final ApplicationScope scope;\n         protected final Iterator<Long> shards;\n \n \n-        protected EdgeSearcher( final ApplicationScope scope, final UUID maxVersion, final Optional<Edge> last,\n+        protected EdgeSearcher( final ApplicationScope scope, final long maxTimestamp, final Optional<Edge> last,\n                                 final Iterator<Long> shards ) {\n             this.scope = scope;\n-            this.maxVersion = maxVersion;\n+            this.maxTimestamp = maxTimestamp;\n             this.last = last;\n             this.shards = shards;\n         }\n@@ -952,8 +961,8 @@ void writeEdge( final MultiTennantColumnFamily<ApplicationScope, R, DirectedEdge\n         /**\n          * Write the edge into the version cf\n          */\n-        void writeVersion( final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, UUID> columnFamily,\n-                           EdgeRowKey rowKey, UUID version );\n+        void writeVersion( final MultiTennantColumnFamily<ApplicationScope, EdgeRowKey, Long> columnFamily,\n+                           EdgeRowKey rowKey, long timestamp );\n     }\n \n \n@@ -1039,8 +1048,7 @@ private void advanceRow() {\n                             .autoPaginate( true ).withColumnRange( rangeBuilder.build() );\n \n \n-            currentColumnIterator =\n-                    new ColumnNameIterator<C, T>( query, searcher, searcher.hasPage() );\n+            currentColumnIterator = new ColumnNameIterator<C, T>( query, searcher, searcher.hasPage() );\n         }\n     }\n }",
                "additions": 125,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeSerializationImpl.java",
                "status": "modified",
                "changes": 242,
                "deletions": 117,
                "sha": "b61616e85eec1ccae57f91f8eba4474e5f784d19",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeSerializationImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeSerializationImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/EdgeSerializationImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -381,7 +381,7 @@ public int compare( final SourceAwareMarkedEdge o1, final SourceAwareMarkedEdge\n      * want descending ordering\n      */\n     public static int compareVersions( final MarkedEdge o1, final MarkedEdge o2 ) {\n-        return UUIDComparator.staticCompare( o1.getVersion(), o2.getVersion() );\n+        return Long.compare( o1.getTimestamp(), o2.getTimestamp() );\n     }\n \n \n@@ -437,7 +437,7 @@ public String toString() {\n         @Override\n         public EdgeKey call( final MarkedEdge markedEdge ) {\n             return new EdgeKey( markedEdge.getSourceNode(), markedEdge.getType(), markedEdge.getTargetNode(),\n-                    markedEdge.getVersion() );\n+                    markedEdge.getTimestamp() );\n         }\n     }\n \n@@ -449,14 +449,14 @@ public EdgeKey call( final MarkedEdge markedEdge ) {\n         private final Id sourceNode;\n         private final String type;\n         private final Id targetNode;\n-        private final UUID version;\n+        private final long timestamp;\n \n \n-        private EdgeKey( final Id sourceNode, final String type, final Id targetNode, final UUID version ) {\n+        private EdgeKey( final Id sourceNode, final String type, final Id targetNode, final long timestamp ) {\n             this.sourceNode = sourceNode;\n             this.type = type;\n             this.targetNode = targetNode;\n-            this.version = version;\n+            this.timestamp = timestamp;\n         }\n \n \n@@ -465,12 +465,15 @@ public boolean equals( final Object o ) {\n             if ( this == o ) {\n                 return true;\n             }\n-            if ( !( o instanceof EdgeKey ) ) {\n+            if ( o == null || getClass() != o.getClass() ) {\n                 return false;\n             }\n \n             final EdgeKey edgeKey = ( EdgeKey ) o;\n \n+            if ( timestamp != edgeKey.timestamp ) {\n+                return false;\n+            }\n             if ( !sourceNode.equals( edgeKey.sourceNode ) ) {\n                 return false;\n             }\n@@ -480,9 +483,6 @@ public boolean equals( final Object o ) {\n             if ( !type.equals( edgeKey.type ) ) {\n                 return false;\n             }\n-            if ( !version.equals( edgeKey.version ) ) {\n-                return false;\n-            }\n \n             return true;\n         }\n@@ -493,8 +493,9 @@ public int hashCode() {\n             int result = sourceNode.hashCode();\n             result = 31 * result + type.hashCode();\n             result = 31 * result + targetNode.hashCode();\n-            result = 31 * result + version.hashCode();\n+            result = 31 * result + ( int ) ( timestamp ^ ( timestamp >>> 32 ) );\n             return result;\n         }\n     }\n+\n }",
                "additions": 11,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImpl.java",
                "status": "modified",
                "changes": 21,
                "deletions": 10,
                "sha": "e578b083fef4cbc1a12b35ea3d77eab704698aa9",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -26,7 +26,6 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n-import java.util.UUID;\n \n import javax.inject.Inject;\n \n@@ -44,6 +43,7 @@\n import org.apache.usergrid.persistence.graph.Edge;\n import org.apache.usergrid.persistence.core.astyanax.CassandraConfig;\n import org.apache.usergrid.persistence.graph.serialization.NodeSerialization;\n+import org.apache.usergrid.persistence.graph.serialization.util.EdgeUtils;\n import org.apache.usergrid.persistence.model.entity.Id;\n \n import com.google.common.base.Optional;\n@@ -112,37 +112,37 @@ public NodeSerializationImpl( final Keyspace keyspace, final CassandraConfig fig\n \n \n     @Override\n-    public MutationBatch mark( final ApplicationScope scope, final Id node, final UUID version ) {\n+    public MutationBatch mark( final ApplicationScope scope, final Id node, final long timestamp ) {\n         ValidationUtils.validateApplicationScope( scope );\n         ValidationUtils.verifyIdentity( node );\n-        ValidationUtils.verifyTimeUuid( version, \"version\" );\n+        EdgeUtils.validateTimestamp(timestamp, \"timestamp\");\n \n         MutationBatch batch = keyspace.prepareMutationBatch().withConsistencyLevel( fig.getWriteCL() );\n \n-        batch.withRow( GRAPH_DELETE, ScopedRowKey.fromKey( scope, node ) ).setTimestamp( version.timestamp() )\n-             .putColumn( COLUMN_NAME, version );\n+        batch.withRow( GRAPH_DELETE, ScopedRowKey.fromKey( scope, node ) ).setTimestamp(timestamp )\n+             .putColumn( COLUMN_NAME, timestamp );\n \n         return batch;\n     }\n \n \n     @Override\n-    public MutationBatch delete( final ApplicationScope scope, final Id node, final UUID version ) {\n+    public MutationBatch delete( final ApplicationScope scope, final Id node, final long timestamp ) {\n         ValidationUtils.validateApplicationScope( scope );\n         ValidationUtils.verifyIdentity( node );\n-        ValidationUtils.verifyTimeUuid( version, \"version\" );\n+        EdgeUtils.validateTimestamp( timestamp, \"timestamp\" );\n \n         MutationBatch batch = keyspace.prepareMutationBatch().withConsistencyLevel( fig.getWriteCL() );\n \n-        batch.withRow( GRAPH_DELETE, ScopedRowKey.fromKey( scope, node ) ).setTimestamp( version.timestamp() )\n+        batch.withRow( GRAPH_DELETE, ScopedRowKey.fromKey( scope, node ) ).setTimestamp( timestamp )\n              .deleteColumn( COLUMN_NAME );\n \n         return batch;\n     }\n \n \n     @Override\n-    public Optional<UUID> getMaxVersion( final ApplicationScope scope, final Id node ) {\n+    public Optional<Long> getMaxVersion( final ApplicationScope scope, final Id node ) {\n         ValidationUtils.validateApplicationScope( scope );\n         ValidationUtils.verifyIdentity( node );\n \n@@ -154,7 +154,7 @@ public MutationBatch delete( final ApplicationScope scope, final Id node, final\n             Column<Boolean> result =\n                     query.getKey( ScopedRowKey.fromKey( scope, node ) ).getColumn( COLUMN_NAME ).execute().getResult();\n \n-            return Optional.of( result.getUUIDValue() );\n+            return Optional.of( result.getLongValue() );\n         }\n         catch ( NotFoundException e ) {\n             //swallow, there's just no column\n@@ -167,7 +167,7 @@ public MutationBatch delete( final ApplicationScope scope, final Id node, final\n \n \n     @Override\n-    public Map<Id, UUID> getMaxVersions( final ApplicationScope scope, final Collection<? extends Edge> nodeIds ) {\n+    public Map<Id, Long> getMaxVersions( final ApplicationScope scope, final Collection<? extends Edge> nodeIds ) {\n         ValidationUtils.validateApplicationScope( scope );\n         Preconditions.checkNotNull( nodeIds, \"nodeIds cannot be null\" );\n \n@@ -178,7 +178,7 @@ public MutationBatch delete( final ApplicationScope scope, final Id node, final\n         final List<ScopedRowKey<ApplicationScope, Id>> keys = new ArrayList<ScopedRowKey<ApplicationScope, Id>>(nodeIds.size());\n \n         //worst case all are marked\n-        final Map<Id, UUID> versions = new HashMap<Id, UUID>(nodeIds.size());\n+        final Map<Id, Long> versions = new HashMap<>(nodeIds.size());\n \n         for(final Edge edge: nodeIds){\n             keys.add( ScopedRowKey.fromKey( scope, edge.getSourceNode() ) );\n@@ -193,7 +193,7 @@ public MutationBatch delete( final ApplicationScope scope, final Id node, final\n                 Column<Boolean> column = row.getColumns().getColumnByName( COLUMN_NAME );\n \n                 if(column != null){\n-                    versions.put( row.getKey().getKey(), column.getUUIDValue() );\n+                    versions.put( row.getKey().getKey(), column.getLongValue() );\n                 }\n \n ",
                "additions": 13,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/NodeSerializationImpl.java",
                "status": "modified",
                "changes": 26,
                "deletions": 13,
                "sha": "2acc5a834e710440cb765545d7219b5deea7fc4e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/NodeSerializationImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/NodeSerializationImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/NodeSerializationImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -31,23 +31,32 @@\n \n     /**\n      * Get the shard key used for writing this shard.  CUD operations should use this\n+     *\n+     * @param scope The application's scope\n+     * @param rowKeyId The id being used in the row key\n+     * @param timestamp The timestamp on the edge\n+     * @param types The types in the edge\n      */\n-    public long getWriteShard(final ApplicationScope scope, final Id rowKeyId, final  UUID version, final String... types );\n+    public long getWriteShard(final ApplicationScope scope, final Id rowKeyId, final  long timestamp, final String... types );\n \n \n     /**\n      * Get the iterator of all shards for this entity\n+     *\n+     * @param scope The application scope\n+     * @param rowKeyId The id used in the row key\n+     * @param maxTimestamp The max timestamp to use\n+     * @param types the types in the edge\n      */\n-    public Iterator<Long> getReadShards(final ApplicationScope scope,final  Id rowKeyId, final UUID maxVersion,final  String... types );\n+    public Iterator<Long> getReadShards(final ApplicationScope scope,final  Id rowKeyId, final long maxTimestamp,final  String... types );\n \n     /**\n      * Increment our count meta data by the passed value.  Can be a positive or a negative number.\n-     * @param batch The batch to add the count to\n-     * @param scope\n-     * @param rowKeyId\n+     * @param scope The scope in the application\n+     * @param rowKeyId The row key id\n      * @param shardId The shard id to use\n      * @param count The amount to increment or decrement\n-     * @param types\n+     * @param types The types\n      * @return\n      */\n     public void increment(final ApplicationScope scope,final  Id rowKeyId, long shardId, long count ,final  String... types );",
                "additions": 15,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/EdgeShardStrategy.java",
                "status": "modified",
                "changes": 21,
                "deletions": 6,
                "sha": "09436acc363a62e110574bec909d3fdb6045b9f1",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/EdgeShardStrategy.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/EdgeShardStrategy.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/EdgeShardStrategy.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -37,20 +37,20 @@\n     /**\n      * Get the time meta data for the given node\n      * @param nodeId\n-     * @param version The time to select the slice for.\n+     * @param timestamp The time to select the slice for.\n      * @param edgeType\n      */\n-    public long getSlice(final ApplicationScope scope, final Id nodeId, final UUID version, final String... edgeType);\n+    public long getSlice(final ApplicationScope scope, final Id nodeId, final long timestamp, final String... edgeType);\n \n     /**\n      * Get an iterator of all versions <= the version\n      * @param scope\n      * @param nodeId\n-     * @param maxVersion\n+     * @param maxTimestamp The highest timestamp\n      * @param edgeType\n      * @return\n      */\n-    public Iterator<Long> getVersions(final ApplicationScope scope, final Id nodeId, final UUID maxVersion, final String... edgeType);\n+    public Iterator<Long> getVersions(final ApplicationScope scope, final Id nodeId, final long  maxTimestamp, final String... edgeType);\n \n \n     /**",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCache.java",
                "status": "modified",
                "changes": 8,
                "deletions": 4,
                "sha": "7845ab08c0584047e3099d2757dd01a0892ee87a",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCache.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCache.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCache.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -37,38 +37,20 @@\n \n \n /**\n- * Implementation for doing approximation.  Uses hy perlog log.\n+ * Implementation for doing edge approximation based on counters.  Uses a guava loading cache to load values from\n+ * cassandra, and flush them on cache eviction.\n  *\n- *\n- * http://blog.aggregateknowledge.com/2012/10/25/sketch-of-the-day-hyperloglog-cornerstone-of-a-big-data-infrastructure/\n- *\n- * See also\n- *\n- * http://blog.aggregateknowledge.com/2012/10/25/sketch-of-the-day-hyperloglog-cornerstone-of-a-big-data-infrastructure/\n- *\n- * See also\n- *\n- * https://github.com/addthis/stream-lib/blob/master/src/main/java/com/clearspring/analytics/stream/cardinality\n- * /HyperLogLog.java\n  */\n-\n-\n public class NodeShardApproximationImpl implements NodeShardApproximation {\n \n-    private final GraphFig graphFig;\n-\n-    //TODO, replace with with our counters. This is just a POC for now.  HyperLogLog appears to use too much ram, waiting\n-    //to hear back on http://dsiutils.di.unimi.it/#install\n-    //for our use case\n-    private final LoadingCache<ShardKey, AtomicLong> graphLogs;\n+       private final LoadingCache<ShardKey, AtomicLong> graphLogs;\n \n \n     /**\n      * Create a time shard approximation with the correct configuration.\n      */\n     @Inject\n     public NodeShardApproximationImpl( final GraphFig graphFig) {\n-        this.graphFig = graphFig;\n \n         graphLogs = CacheBuilder.newBuilder()\n                .maximumSize( graphFig.getShardCacheSize() )",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardApproximationImpl.java",
                "status": "modified",
                "changes": 24,
                "deletions": 21,
                "sha": "54d8c3c80bf20190e6debef7275db6c5d87d4d3b",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardApproximationImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardApproximationImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardApproximationImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -96,7 +96,7 @@ public void propertyChange( final PropertyChangeEvent evt ) {\n \n \n     @Override\n-    public long getSlice( final ApplicationScope scope, final Id nodeId, final UUID time, final String... edgeType ) {\n+    public long getSlice( final ApplicationScope scope, final Id nodeId, final long timestamp, final String... edgeType ) {\n \n \n         final CacheKey key = new CacheKey( scope, nodeId, edgeType );\n@@ -109,7 +109,7 @@ public long getSlice( final ApplicationScope scope, final Id nodeId, final UUID\n             throw new RuntimeException( \"Unable to load shard key for graph\", e );\n         }\n \n-        final Long shardId = entry.getShardId( time.timestamp() );\n+        final Long shardId = entry.getShardId( timestamp );\n \n         if ( shardId != null ) {\n             return shardId;\n@@ -121,7 +121,7 @@ public long getSlice( final ApplicationScope scope, final Id nodeId, final UUID\n \n \n     @Override\n-    public Iterator<Long> getVersions( final ApplicationScope scope, final Id nodeId, final UUID maxVersion,\n+    public Iterator<Long> getVersions( final ApplicationScope scope, final Id nodeId, final long maxTimestamp,\n                                        final String... edgeType ) {\n         final CacheKey key = new CacheKey( scope, nodeId, edgeType );\n               CacheEntry entry;\n@@ -133,7 +133,7 @@ public long getSlice( final ApplicationScope scope, final Id nodeId, final UUID\n                   throw new RuntimeException( \"Unable to load shard key for graph\", e );\n               }\n \n-        Iterator<Long> iterator = entry.getShards( maxVersion.timestamp() );\n+        Iterator<Long> iterator = entry.getShards( maxTimestamp );\n \n         if(iterator == null){\n             return Collections.<Long>emptyList().iterator();",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardCacheImpl.java",
                "status": "modified",
                "changes": 8,
                "deletions": 4,
                "sha": "c11da7b85f09649ba03a94d9e38cd761d1850397",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardCacheImpl.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardCacheImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/NodeShardCacheImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -48,16 +48,16 @@\n \n \n     @Override\n-    public long getWriteShard( final ApplicationScope scope, final Id rowKeyId, final UUID version,\n+    public long getWriteShard( final ApplicationScope scope, final Id rowKeyId, final long timestamp,\n                                final String... types ) {\n-        return shardCache.getSlice( scope, rowKeyId, version, types );\n+        return shardCache.getSlice( scope, rowKeyId, timestamp, types );\n     }\n \n \n     @Override\n-    public Iterator<Long> getReadShards( final ApplicationScope scope, final Id rowKeyId, final UUID maxVersion,\n+    public Iterator<Long> getReadShards( final ApplicationScope scope, final Id rowKeyId, final long maxTimestamp,\n                                          final String... types ) {\n-        return shardCache.getVersions( scope, rowKeyId, maxVersion, types );\n+        return shardCache.getVersions( scope, rowKeyId, maxTimestamp, types );\n     }\n \n ",
                "additions": 4,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/SizebasedEdgeShardStrategy.java",
                "status": "modified",
                "changes": 8,
                "deletions": 4,
                "sha": "c1dd2dcfa7812e54e623fa930bfbfdb89fe69327",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/SizebasedEdgeShardStrategy.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/SizebasedEdgeShardStrategy.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/SizebasedEdgeShardStrategy.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -44,14 +44,14 @@\n \n \n     @Override\n-    public long getWriteShard( final ApplicationScope scope, final Id rowKeyId, final UUID version,\n+    public long getWriteShard( final ApplicationScope scope, final Id rowKeyId, final long timestamp,\n                                final String... types ) {\n         return 0;  //To change body of implemented methods use File | Settings | File Templates.\n     }\n \n \n     @Override\n-    public Iterator<Long> getReadShards( final ApplicationScope scope, final Id rowKeyId, final UUID maxVersion,\n+    public Iterator<Long> getReadShards( final ApplicationScope scope, final Id rowKeyId, final long maxTimestamp,\n                                          final String... types ) {\n         return Collections.singleton(0l).iterator();\n     }",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/TimebasedEdgeShardStrategy.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "396410eec9446b5f98ccb72ab51de7c40072da3e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/TimebasedEdgeShardStrategy.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/TimebasedEdgeShardStrategy.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/impl/TimebasedEdgeShardStrategy.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -47,10 +47,20 @@ public static void validateEdge( Edge e ) {\n         ValidationUtils.verifyIdentity( e.getSourceNode() );\n         ValidationUtils.verifyIdentity( e.getTargetNode() );\n         ValidationUtils.verifyString( e.getType(), \"type\" );\n-        ValidationUtils.verifyTimeUuid( e.getVersion(), \"version\" );\n+        validateTimestamp( e.getTimestamp(), \"timestamp\" );\n+\n     }\n \n \n+    /**\n+     * Validate the timestamp is set\n+     * @param value\n+     * @param fieldName\n+     */\n+    public static void validateTimestamp(final long value, final String fieldName){\n+        Preconditions.checkArgument( value > -1, fieldName );\n+    }\n+\n     /**\n      * Validate the search edge\n      */\n@@ -80,7 +90,7 @@ public static void validateSearchByEdgeType( final SearchByEdgeType search ) {\n \n         ValidationUtils.verifyIdentity( search.getNode() );\n         ValidationUtils.verifyString( search.getType(), \"type\" );\n-        ValidationUtils.verifyTimeUuid( search.getMaxVersion(), \"maxVersion\" );\n+        validateTimestamp( search.getMaxTimestamp(), \"maxTimestamp\" );\n \n         //only validate if the value is present\n         if(search.last().isPresent()){\n@@ -98,7 +108,7 @@ public static void validateSearchByEdge( final SearchByEdge search ) {\n            ValidationUtils.verifyIdentity( search.sourceNode() );\n            ValidationUtils.verifyIdentity( search.targetNode() );\n            ValidationUtils.verifyString( search.getType(), \"type\" );\n-           ValidationUtils.verifyTimeUuid( search.getMaxVersion(), \"maxVersion\" );\n+           validateTimestamp( search.getMaxTimestamp(), \"maxTimestamp\" );\n \n            //only validate if the value is present\n            if(search.last().isPresent()){",
                "additions": 13,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/util/EdgeUtils.java",
                "status": "modified",
                "changes": 16,
                "deletions": 3,
                "sha": "b1919572c969fbc0f1f8a992d0ce0e3edad25f3f",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/util/EdgeUtils.java",
                "filename": "stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/util/EdgeUtils.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/main/java/org/apache/usergrid/persistence/graph/serialization/util/EdgeUtils.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -75,8 +75,8 @@ public ComittedGraphTestHelper( final GraphManager graphManager ) {\n \n \n         @Override\n-        public Observable<Id> deleteNode( final Id node ) {\n-            return graphManager.deleteNode( node );\n+        public Observable<Id> deleteNode( final Id node, final long timestamp) {\n+            return graphManager.deleteNode( node, timestamp );\n         }\n \n ",
                "additions": 2,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/ComittedGraphManagerIT.java",
                "status": "modified",
                "changes": 4,
                "deletions": 2,
                "sha": "596480d2805620c8a9a872d782d56f9ae9f4591d",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/ComittedGraphManagerIT.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/ComittedGraphManagerIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/ComittedGraphManagerIT.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -104,7 +104,7 @@ public void testWriteReadEdgeTypeSource() throws TimeoutException, InterruptedEx\n \n         //now test retrieving it\n \n-        SearchByEdgeType search = createSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getVersion(), null );\n+        SearchByEdgeType search = createSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesFromSource( search );\n \n@@ -114,7 +114,7 @@ public void testWriteReadEdgeTypeSource() throws TimeoutException, InterruptedEx\n         assertEquals( \"Correct edge returned\", edge, returned );\n \n         //change edge type to be invalid, shouldn't get a result\n-        search = createSearchByEdge( edge.getSourceNode(), edge.getType() + \"invalid\", edge.getVersion(), null );\n+        search = createSearchByEdge( edge.getSourceNode(), edge.getType() + \"invalid\", edge.getTimestamp(), null );\n \n         edges = gm.loadEdgesFromSource( search );\n \n@@ -136,7 +136,7 @@ public void testWriteReadEdgeTypeTarget() throws TimeoutException, InterruptedEx\n \n         //now test retrieving it\n \n-        SearchByEdgeType search = createSearchByEdge( edge.getTargetNode(), edge.getType(), edge.getVersion(), null );\n+        SearchByEdgeType search = createSearchByEdge( edge.getTargetNode(), edge.getType(), edge.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesToTarget( search );\n \n@@ -146,7 +146,7 @@ public void testWriteReadEdgeTypeTarget() throws TimeoutException, InterruptedEx\n         assertEquals( \"Correct edge returned\", edge, returned );\n \n         //change edge type to be invalid, shouldn't get a result\n-        search = createSearchByEdge( edge.getTargetNode(), edge.getType() + \"invalid\", edge.getVersion(), null );\n+        search = createSearchByEdge( edge.getTargetNode(), edge.getType() + \"invalid\", edge.getTimestamp(), null );\n \n         edges = gm.loadEdgesToTarget( search );\n \n@@ -162,15 +162,15 @@ public void testWriteReadEdgeTypeVersionSource() throws TimeoutException, Interr\n \n         GraphManager gm = getHelper( emf.createEdgeManager( scope ) );\n \n-        final UUID earlyVersion = UUIDGenerator.newTimeUUID();\n+        final long earlyVersion = 1000l;\n \n-        Edge edge = createEdge( \"source\", \"test\", \"target\" );\n+        Edge edge = createEdge( \"source\", \"test\", \"target\", earlyVersion);\n \n         gm.writeEdge( edge ).toBlockingObservable().last();\n \n         //now test retrieving it\n \n-        SearchByEdgeType search = createSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getVersion(), null );\n+        SearchByEdgeType search = createSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesFromSource( search );\n \n@@ -180,7 +180,7 @@ public void testWriteReadEdgeTypeVersionSource() throws TimeoutException, Interr\n         assertEquals( \"Correct edge returned\", edge, returned );\n \n         //now test with an earlier version, we shouldn't get the edge back\n-        search = createSearchByEdge( edge.getSourceNode(), edge.getType(), earlyVersion, null );\n+        search = createSearchByEdge( edge.getSourceNode(), edge.getType(), earlyVersion-1, null );\n \n         edges = gm.loadEdgesFromSource( search );\n \n@@ -196,16 +196,16 @@ public void testWriteReadEdgeTypeVersionTarget() throws TimeoutException, Interr\n \n         GraphManager gm = getHelper( emf.createEdgeManager( scope ) );\n \n-        final UUID earlyVersion = UUIDGenerator.newTimeUUID();\n+        final long earlyVersion = 10000l;\n \n \n-        Edge edge = createEdge( \"source\", \"test\", \"target\" );\n+        Edge edge = createEdge( \"source\", \"test\", \"target\", earlyVersion);\n \n         gm.writeEdge( edge ).toBlockingObservable().last();\n \n         //now test retrieving it\n \n-        SearchByEdgeType search = createSearchByEdge( edge.getTargetNode(), edge.getType(), edge.getVersion(), null );\n+        SearchByEdgeType search = createSearchByEdge( edge.getTargetNode(), edge.getType(), edge.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesToTarget( search );\n \n@@ -215,7 +215,7 @@ public void testWriteReadEdgeTypeVersionTarget() throws TimeoutException, Interr\n         assertEquals( \"Correct edge returned\", edge, returned );\n \n         //change edge type to be invalid, shouldn't get a result\n-        search = createSearchByEdge( edge.getTargetNode(), edge.getType(), earlyVersion, null );\n+        search = createSearchByEdge( edge.getTargetNode(), edge.getType(), earlyVersion-1, null );\n \n         edges = gm.loadEdgesToTarget( search );\n \n@@ -234,30 +234,30 @@ public void testWriteReadEdgeTypeVersionSourceDistinct() throws TimeoutException\n \n         GraphManager gm = getHelper( emf.createEdgeManager( scope ) );\n \n-        final UUID earlyVersion = UUIDGenerator.newTimeUUID();\n+        final long earlyVersion = 10000l;\n \n \n-        Edge edge1 = createEdge( \"source\", \"test\", \"target\" );\n+        Edge edge1 = createEdge( \"source\", \"test\", \"target\", earlyVersion + 1 );\n \n         final Id sourceId = edge1.getSourceNode();\n         final Id targetId = edge1.getTargetNode();\n \n \n         gm.writeEdge( edge1 ).toBlockingObservable().last();\n \n-        Edge edge2 = createEdge( sourceId, edge1.getType(), targetId );\n+        Edge edge2 = createEdge( sourceId, edge1.getType(), targetId, earlyVersion + 2 );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().last();\n \n-        Edge edge3 = createEdge( sourceId, edge1.getType(), targetId );\n+        Edge edge3 = createEdge( sourceId, edge1.getType(), targetId, earlyVersion + 3 );\n \n         gm.writeEdge( edge3 ).toBlockingObservable().last();\n \n \n         //now test retrieving it, we should only get edge3, since it's the latest\n \n         SearchByEdgeType search =\n-                createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge3.getVersion(), null );\n+                createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge3.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesFromSource( search );\n \n@@ -270,7 +270,7 @@ public void testWriteReadEdgeTypeVersionSourceDistinct() throws TimeoutException\n         assertFalse( \"No more edges\", returned.hasNext() );\n \n         //now test with an earlier version, we shouldn't get the edge back\n-        search = createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge2.getVersion(), null );\n+        search = createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge2.getTimestamp(), null );\n \n         edges = gm.loadEdgesFromSource( search );\n \n@@ -280,7 +280,7 @@ public void testWriteReadEdgeTypeVersionSourceDistinct() throws TimeoutException\n         assertEquals( \"Correct edge returned\", edge1, returned.next() );\n         assertFalse( \"No more edges\", returned.hasNext() );\n \n-        search = createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge1.getVersion(), null );\n+        search = createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge1.getTimestamp(), null );\n \n         edges = gm.loadEdgesFromSource( search );\n \n@@ -305,33 +305,33 @@ public void testWriteReadEdgeTypeVersionTargetDistinct() throws TimeoutException\n \n \n         GraphManager gm = getHelper( emf.createEdgeManager( scope ) );\n-        ;\n \n \n-        final UUID earlyVersion = UUIDGenerator.newTimeUUID();\n+\n+        final long earlyVersion = 10000l;\n \n \n-        Edge edge1 = createEdge( \"source\", \"test\", \"target\" );\n+        Edge edge1 = createEdge( \"source\", \"test\", \"target\", earlyVersion+1 );\n \n         final Id sourceId = edge1.getSourceNode();\n         final Id targetId = edge1.getTargetNode();\n \n \n         gm.writeEdge( edge1 ).toBlockingObservable().last();\n \n-        Edge edge2 = createEdge( sourceId, edge1.getType(), targetId );\n+        Edge edge2 = createEdge( sourceId, edge1.getType(), targetId, earlyVersion+2 );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().last();\n \n-        Edge edge3 = createEdge( sourceId, edge1.getType(), targetId );\n+        Edge edge3 = createEdge( sourceId, edge1.getType(), targetId, earlyVersion +3 );\n \n         gm.writeEdge( edge3 ).toBlockingObservable().last();\n \n \n         //now test retrieving it, we should only get edge3, since it's the latest\n \n         SearchByEdgeType search =\n-                createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge3.getVersion(), null );\n+                createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge3.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesToTarget( search );\n \n@@ -344,7 +344,7 @@ public void testWriteReadEdgeTypeVersionTargetDistinct() throws TimeoutException\n         assertFalse( \"No more edges\", returned.hasNext() );\n \n         //now test with an earlier version, we shouldn't get the edge back\n-        search = createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge2.getVersion(), null );\n+        search = createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge2.getTimestamp(), null );\n \n         edges = gm.loadEdgesToTarget( search );\n \n@@ -354,7 +354,7 @@ public void testWriteReadEdgeTypeVersionTargetDistinct() throws TimeoutException\n         assertEquals( \"Correct edge returned\", edge1, returned.next() );\n         assertFalse( \"No more edges\", returned.hasNext() );\n \n-        search = createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge1.getVersion(), null );\n+        search = createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge1.getTimestamp(), null );\n \n         edges = gm.loadEdgesToTarget( search );\n \n@@ -397,7 +397,7 @@ public void testWriteReadEdgeTypePagingSource() throws TimeoutException, Interru\n         //now test retrieving it\n \n         SearchByEdgeType search =\n-                createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge3.getVersion(), null );\n+                createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge3.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesFromSource( search );\n \n@@ -415,7 +415,7 @@ public void testWriteReadEdgeTypePagingSource() throws TimeoutException, Interru\n         assertFalse( \"No more edges\", returned.hasNext() );\n \n         //still edge 3 is our max version, but we start with edge 2 as our last read\n-        search = createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge3.getVersion(), edge2 );\n+        search = createSearchByEdge( edge1.getSourceNode(), edge1.getType(), edge3.getTimestamp(), edge2 );\n \n         edges = gm.loadEdgesFromSource( search );\n \n@@ -453,7 +453,7 @@ public void testWriteReadEdgeTypePagingTarget() {\n         //now test retrieving it\n \n         SearchByEdgeType search =\n-                createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge3.getVersion(), null );\n+                createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge3.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesToTarget( search );\n \n@@ -471,7 +471,7 @@ public void testWriteReadEdgeTypePagingTarget() {\n \n         assertFalse( \"No more edges\", returned.hasNext() );\n \n-        search = createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge3.getVersion(), edge2 );\n+        search = createSearchByEdge( edge1.getTargetNode(), edge1.getType(), edge3.getTimestamp(), edge2 );\n \n         edges = gm.loadEdgesToTarget( search );\n \n@@ -496,7 +496,7 @@ public void testWriteReadEdgeTypeTargetTypeSource() {\n \n         //now test retrieving it\n \n-        SearchByIdType search = createSearchByEdgeAndId( edge.getSourceNode(), edge.getType(), edge.getVersion(),\n+        SearchByIdType search = createSearchByEdgeAndId( edge.getSourceNode(), edge.getType(), edge.getTimestamp(),\n                 edge.getTargetNode().getType(), null );\n \n         Observable<Edge> edges = gm.loadEdgesFromSourceByType( search );\n@@ -508,7 +508,7 @@ public void testWriteReadEdgeTypeTargetTypeSource() {\n \n \n         //change edge type to be invalid, shouldn't get a result\n-        search = createSearchByEdgeAndId( edge.getSourceNode(), edge.getType(), edge.getVersion(),\n+        search = createSearchByEdgeAndId( edge.getSourceNode(), edge.getType(), edge.getTimestamp(),\n                 edge.getTargetNode().getType() + \"invalid\", null );\n \n         edges = gm.loadEdgesFromSourceByType( search );\n@@ -533,7 +533,7 @@ public void testWriteReadEdgeTypeTargetTypeTarget() {\n \n         //now test retrieving it\n \n-        SearchByIdType search = createSearchByEdgeAndId( edge.getTargetNode(), edge.getType(), edge.getVersion(),\n+        SearchByIdType search = createSearchByEdgeAndId( edge.getTargetNode(), edge.getType(), edge.getTimestamp(),\n                 edge.getSourceNode().getType(), null );\n \n         Observable<Edge> edges = gm.loadEdgesToTargetByType( search );\n@@ -545,7 +545,7 @@ public void testWriteReadEdgeTypeTargetTypeTarget() {\n \n \n         //change edge type to be invalid, shouldn't get a result\n-        search = createSearchByEdgeAndId( edge.getTargetNode(), edge.getType(), edge.getVersion(),\n+        search = createSearchByEdgeAndId( edge.getTargetNode(), edge.getType(), edge.getTimestamp(),\n                 edge.getSourceNode().getType() + \"invalid\", null );\n \n         edges = gm.loadEdgesToTargetByType( search );\n@@ -570,7 +570,7 @@ public void testWriteReadEdgeDeleteSource() {\n         //now test retrieving it\n \n \n-        SearchByEdgeType search = createSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getVersion(), null );\n+        SearchByEdgeType search = createSearchByEdge( edge.getSourceNode(), edge.getType(), edge.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesFromSource( search );\n \n@@ -579,7 +579,7 @@ public void testWriteReadEdgeDeleteSource() {\n \n         assertEquals( \"Correct edge returned\", edge, returned );\n \n-        SearchByIdType searchById = createSearchByEdgeAndId( edge.getSourceNode(), edge.getType(), edge.getVersion(),\n+        SearchByIdType searchById = createSearchByEdgeAndId( edge.getSourceNode(), edge.getType(), edge.getTimestamp(),\n                 edge.getTargetNode().getType(), null );\n \n         edges = gm.loadEdgesFromSourceByType( searchById );\n@@ -590,7 +590,7 @@ public void testWriteReadEdgeDeleteSource() {\n         assertEquals( \"Correct edge returned\", edge, returned );\n \n         final SearchByEdge searchByEdge =\n-                createGetByEdge( edge.getSourceNode(), edge.getType(), edge.getTargetNode(), edge.getVersion(), null );\n+                createGetByEdge( edge.getSourceNode(), edge.getType(), edge.getTargetNode(), edge.getTimestamp(), null );\n \n         returned = gm.loadEdgeVersions( searchByEdge ).toBlockingObservable().single();\n \n@@ -640,7 +640,7 @@ public void testWriteReadEdgeDeleteTarget() {\n         //now test retrieving it\n \n \n-        SearchByEdgeType search = createSearchByEdge( edge.getTargetNode(), edge.getType(), edge.getVersion(), null );\n+        SearchByEdgeType search = createSearchByEdge( edge.getTargetNode(), edge.getType(), edge.getTimestamp(), null );\n \n         Observable<Edge> edges = gm.loadEdgesToTarget( search );\n \n@@ -649,7 +649,7 @@ public void testWriteReadEdgeDeleteTarget() {\n \n         assertEquals( \"Correct edge returned\", edge, returned );\n \n-        SearchByIdType searchById = createSearchByEdgeAndId( edge.getTargetNode(), edge.getType(), edge.getVersion(),\n+        SearchByIdType searchById = createSearchByEdgeAndId( edge.getTargetNode(), edge.getType(), edge.getTimestamp(),\n                 edge.getSourceNode().getType(), null );\n \n         edges = gm.loadEdgesToTargetByType( searchById );\n@@ -692,16 +692,16 @@ public void testWriteReadEdgeTypesSourceTypes() {\n         Id targetId1 = new SimpleId( \"target\" );\n         Id targetId2 = new SimpleId( \"target2\" );\n \n-        Edge testTargetEdge = createEdge( sourceId, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge testTargetEdge = createEdge( sourceId, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( testTargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge testTarget2Edge = createEdge( sourceId, \"test\", targetId2, UUIDGenerator.newTimeUUID() );\n+        Edge testTarget2Edge = createEdge( sourceId, \"test\", targetId2, System.currentTimeMillis() );\n \n         gm.writeEdge( testTarget2Edge ).toBlockingObservable().singleOrDefault( null );\n \n \n-        Edge test2TargetEdge = createEdge( sourceId, \"test2\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge test2TargetEdge = createEdge( sourceId, \"test2\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( test2TargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n@@ -755,16 +755,16 @@ public void testWriteReadEdgeTypesTargetTypes() {\n         Id targetId1 = new SimpleId( \"target\" );\n \n \n-        Edge testTargetEdge = createEdge( sourceId1, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge testTargetEdge = createEdge( sourceId1, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( testTargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge testTarget2Edge = createEdge( sourceId2, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge testTarget2Edge = createEdge( sourceId2, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( testTarget2Edge ).toBlockingObservable().singleOrDefault( null );\n \n \n-        Edge test2TargetEdge = createEdge( sourceId1, \"test2\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge test2TargetEdge = createEdge( sourceId1, \"test2\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( test2TargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n@@ -820,17 +820,17 @@ public void testWriteReadEdgeTypesSourceTypesPaging() {\n         Id targetId2 = new SimpleId( \"target2\" );\n \n \n-        Edge testTargetEdge = createEdge( sourceId1, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge testTargetEdge = createEdge( sourceId1, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( testTargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n \n-        Edge testTargetEdge2 = createEdge( sourceId1, \"test\", targetId2, UUIDGenerator.newTimeUUID() );\n+        Edge testTargetEdge2 = createEdge( sourceId1, \"test\", targetId2, System.currentTimeMillis() );\n \n         gm.writeEdge( testTargetEdge2 ).toBlockingObservable().singleOrDefault( null );\n \n \n-        Edge test2TargetEdge = createEdge( sourceId1, \"test2\", targetId2, UUIDGenerator.newTimeUUID() );\n+        Edge test2TargetEdge = createEdge( sourceId1, \"test2\", targetId2, System.currentTimeMillis() );\n \n         gm.writeEdge( test2TargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n@@ -898,16 +898,16 @@ public void testWriteReadEdgeTypesTargetTypesPaging() {\n         Id targetId = new SimpleId( \"target\" );\n \n \n-        Edge testTargetEdge = createEdge( sourceId1, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge testTargetEdge = createEdge( sourceId1, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( testTargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n \n-        Edge testTargetEdge2 = createEdge( sourceId2, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge testTargetEdge2 = createEdge( sourceId2, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( testTargetEdge2 ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge test2TargetEdge = createEdge( sourceId2, \"test2\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge test2TargetEdge = createEdge( sourceId2, \"test2\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( test2TargetEdge ).toBlockingObservable().singleOrDefault( null );\n \n@@ -978,31 +978,25 @@ public void testMarkSourceEdges() throws InterruptedException {\n         Id targetId1 = new SimpleId( \"target\" );\n         Id targetId2 = new SimpleId( \"target2\" );\n \n-        Edge edge1 = createEdge( sourceId, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+\n+        Edge edge1 = createEdge( sourceId, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( edge1 ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge edge2 = createEdge( sourceId, \"test\", targetId2, UUIDGenerator.newTimeUUID() );\n+        Edge edge2 = createEdge( sourceId, \"test\", targetId2, System.currentTimeMillis() );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().singleOrDefault( null );\n \n \n-        final UUID maxVersion = UUIDGenerator.newTimeUUID();\n-\n+        final long maxVersion = System.currentTimeMillis();\n \n \n-        assertTrue( UUIDComparator.staticCompare( maxVersion, edge2.getVersion() ) > 0);\n-        assertTrue( UUIDComparator.staticCompare( maxVersion, edge1.getVersion() ) > 0);\n \n-        ByteBuffer edge1Buff = UUIDSerializer.get().toByteBuffer( edge1.getVersion() );\n-        ByteBuffer edge2Buff = UUIDSerializer.get().toByteBuffer( edge2.getVersion() );\n-        ByteBuffer maxBuff = UUIDSerializer.get().toByteBuffer( maxVersion );\n+        assertTrue( Long.compare( maxVersion, edge2.getTimestamp() ) > 0);\n+        assertTrue( Long.compare( maxVersion, edge1.getTimestamp() ) > 0);\n \n \n \n-        assertTrue( UUIDType.instance.compare( maxBuff.duplicate(), edge1Buff.duplicate() ) > 0);\n-        assertTrue( UUIDType.instance.compare( maxBuff.duplicate(), edge2Buff.duplicate() ) > 0);\n-\n \n         //get our 2 edges\n         Observable<Edge> edges = gm.loadEdgesFromSource(\n@@ -1071,16 +1065,16 @@ public void testMarkTargetEdges() {\n         Id sourceId2 = new SimpleId( \"source2\" );\n         Id targetId = new SimpleId( \"target\" );\n \n-        Edge edge1 = createEdge( sourceId1, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge edge1 = createEdge( sourceId1, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( edge1 ).toBlockingObservable().last();\n \n-        Edge edge2 = createEdge( sourceId2, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge edge2 = createEdge( sourceId2, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().last();\n \n \n-        final UUID maxVersion = UUIDGenerator.newTimeUUID();\n+        final long maxVersion = System.currentTimeMillis();\n \n \n         //get our 2 edges\n@@ -1139,16 +1133,16 @@ public void testMarkSourceEdgesType() {\n         Id targetId1 = new SimpleId( \"target\" );\n         Id targetId2 = new SimpleId( \"target2\" );\n \n-        Edge edge1 = createEdge( sourceId, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge edge1 = createEdge( sourceId, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( edge1 ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge edge2 = createEdge( sourceId, \"test\", targetId2, UUIDGenerator.newTimeUUID() );\n+        Edge edge2 = createEdge( sourceId, \"test\", targetId2, System.currentTimeMillis() );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().singleOrDefault( null );\n \n \n-        final UUID maxVersion = UUIDGenerator.newTimeUUID();\n+        final long maxVersion = System.currentTimeMillis();\n \n \n         //get our 2 edges\n@@ -1217,16 +1211,16 @@ public void testMarkTargetEdgesType() {\n         Id sourceId2 = new SimpleId( \"source2\" );\n         Id targetId = new SimpleId( \"target\" );\n \n-        Edge edge1 = createEdge( sourceId1, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge edge1 = createEdge( sourceId1, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( edge1 ).toBlockingObservable().last();\n \n-        Edge edge2 = createEdge( sourceId2, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge edge2 = createEdge( sourceId2, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().last();\n \n \n-        final UUID maxVersion = UUIDGenerator.newTimeUUID();\n+        final long maxVersion = System.currentTimeMillis();\n \n         //get our 2 edges\n         Observable<Edge> edges = gm.loadEdgesToTargetByType(\n@@ -1295,16 +1289,16 @@ public void markSourceNode() {\n         Id targetId1 = new SimpleId( \"target\" );\n         Id targetId2 = new SimpleId( \"target2\" );\n \n-        Edge edge1 = createEdge( sourceId, \"test\", targetId1, UUIDGenerator.newTimeUUID() );\n+        Edge edge1 = createEdge( sourceId, \"test\", targetId1, System.currentTimeMillis() );\n \n         gm.writeEdge( edge1 ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge edge2 = createEdge( sourceId, \"test\", targetId2, UUIDGenerator.newTimeUUID() );\n+        Edge edge2 = createEdge( sourceId, \"test\", targetId2, System.currentTimeMillis() );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().singleOrDefault( null );\n \n \n-        final UUID maxVersion = UUIDGenerator.newTimeUUID();\n+        final long maxVersion = System.currentTimeMillis();\n \n         Iterator<Edge> results =\n                 gm.loadEdgesFromSource( createSearchByEdge( sourceId, edge1.getType(), maxVersion, null ) )\n@@ -1339,7 +1333,7 @@ public void markSourceNode() {\n         assertFalse( \"No more edges\", results.hasNext() );\n \n         //mark the source node\n-        gm.deleteNode( sourceId ).toBlockingObservable().last();\n+        gm.deleteNode( sourceId, edge2.getTimestamp() ).toBlockingObservable().last();\n \n \n         //now re-read, nothing should be there since they're marked\n@@ -1377,16 +1371,16 @@ public void markTargetNode() {\n         Id sourceId2 = new SimpleId( \"source2\" );\n         Id targetId = new SimpleId( \"target\" );\n \n-        Edge edge1 = createEdge( sourceId1, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge edge1 = createEdge( sourceId1, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( edge1 ).toBlockingObservable().singleOrDefault( null );\n \n-        Edge edge2 = createEdge( sourceId2, \"test\", targetId, UUIDGenerator.newTimeUUID() );\n+        Edge edge2 = createEdge( sourceId2, \"test\", targetId, System.currentTimeMillis() );\n \n         gm.writeEdge( edge2 ).toBlockingObservable().singleOrDefault( null );\n \n \n-        final UUID maxVersion = UUIDGenerator.newTimeUUID();\n+        final long maxVersion = System.currentTimeMillis();\n \n         Iterator<Edge> results =\n                 gm.loadEdgesToTarget( createSearchByEdge( targetId, edge1.getType(), maxVersion, null ) )\n@@ -1421,7 +1415,7 @@ public void markTargetNode() {\n         assertFalse( \"No more edges\", results.hasNext() );\n \n         //mark the source node\n-        gm.deleteNode( targetId ).toBlockingObservable().last();\n+        gm.deleteNode( targetId, edge2.getTimestamp() ).toBlockingObservable().last();\n \n \n         //now re-read, nothing should be there since they're marked\n@@ -1464,54 +1458,6 @@ public void invalidEdgeTypesDelete( @All Edge edge ) {\n \n         em.deleteEdge( edge );\n     }\n-\n-    //\n-    //    public static class InvalidInput extends JukitoModule {\n-    //\n-    //        @Override\n-    //        protected void configureTest() {\n-    //create all edge types of junk input\n-    //\n-    //            final UUID version = UUIDGenerator.newTimeUUID();\n-    //\n-    //            Id nullUuid = mock( Id.class );\n-    //            when( nullUuid.getUuid() ).thenReturn( null );\n-    //\n-    //\n-    //            Id nullType = mock( Id.class );\n-    //            when( nullType.getType() ).thenReturn( \"type\" );\n-    //\n-    //            Edge[] edges = new Edge[] {\n-    //                    mockEdge( nullUuid, \"test\", createId( \"target\" ), version ),\n-    //\n-    //                    mockEdge( nullType, \"test\", createId( \"target\" ), version ),\n-    //\n-    //                    mockEdge( createId( \"source\" ), null, createId( \"target\" ), version ),\n-    //\n-    //                    mockEdge( createId( \"source\" ), \"test\", nullUuid, version ),\n-    //\n-    //                    mockEdge( createId( \"source\" ), \"test\", nullType, version ),\n-    //\n-    //                    mockEdge( createId( \"source\" ), \"test\", createId( \"target\" ), null )\n-    //            };\n-    //\n-    //\n-    //            bindManyInstances( Edge.class, edges );\n-    //\n-    //        }\n-    //\n-    //\n-    //        private Edge mockEdge( final Id sourceId, final String type, final Id targetId, final UUID version ) {\n-    //            Edge edge = mock( Edge.class );\n-    //\n-    //            when( edge.getSourceNode() ).thenReturn( sourceId );\n-    //            when( edge.getType() ).thenReturn( type );\n-    //            when( edge.getTargetNode() ).thenReturn( targetId );\n-    //            when( edge.getTimestamp() ).thenReturn( version );\n-    //\n-    //            return edge;\n-    //        }\n-    //    }\n }\n \n ",
                "additions": 75,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerIT.java",
                "status": "modified",
                "changes": 204,
                "deletions": 129,
                "sha": "0c8ccdd2216a2a2faa1f835910fc940cd39a0cf1",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerIT.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerIT.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -113,9 +113,7 @@ public Edge newEdge() {\n \n             @Override\n             public Observable<Edge> doSearch( final GraphManager manager ) {\n-                UUID uuid = UUIDGenerator.newTimeUUID();\n-\n-                return manager.loadEdgesFromSource( new SimpleSearchByEdgeType( sourceId, \"test\", uuid, null ) );\n+                 return manager.loadEdgesFromSource( new SimpleSearchByEdgeType( sourceId, \"test\", System.currentTimeMillis(), null ) );\n             }\n         };\n \n@@ -142,9 +140,7 @@ public Edge newEdge() {\n \n             @Override\n             public Observable<Edge> doSearch( final GraphManager manager ) {\n-                UUID uuid = UUIDGenerator.newTimeUUID();\n-\n-                return manager.loadEdgesToTarget( new SimpleSearchByEdgeType( targetId, \"test\", uuid, null ) );\n+                return manager.loadEdgesToTarget( new SimpleSearchByEdgeType( targetId, \"test\", System.currentTimeMillis(), null ) );\n             }\n         };\n \n@@ -205,7 +201,7 @@ public Boolean call() throws Exception {\n                 Edge returned = manager.writeEdge( edge ).toBlockingObservable().last();\n \n \n-                assertNotNull( \"Returned has a version\", returned.getVersion() );\n+                assertNotNull( \"Returned has a version\", returned.getTimestamp() );\n \n \n                 if ( i % 1000 == 0 ) {",
                "additions": 3,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerLoadTest.java",
                "status": "modified",
                "changes": 10,
                "deletions": 7,
                "sha": "9302d544dc14613e359a592eb7a8cff1ea0e2d87",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerLoadTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerLoadTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerLoadTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -108,7 +108,7 @@ public Edge newEdge() {\n             public Observable<Edge> doSearch( final GraphManager manager ) {\n \n \n-                final UUID uuid = UUIDGenerator.newTimeUUID();\n+                final long timestamp = System.currentTimeMillis();\n \n \n                 return Observable.create( new Observable.OnSubscribe<Edge>() {\n@@ -119,7 +119,7 @@ public void call( final Subscriber<? super Edge> subscriber ) {\n                             for ( Id sourceId : sourceIds ) {\n \n                                 final Iterable<Edge> edges = manager.loadEdgesFromSource(\n-                                        new SimpleSearchByEdgeType( sourceId, \"test\", uuid, null ) )\n+                                        new SimpleSearchByEdgeType( sourceId, \"test\", timestamp, null ) )\n                                                                     .toBlockingObservable().toIterable();\n \n                                 for ( Edge edge : edges ) {\n@@ -193,9 +193,7 @@ public Edge newEdge() {\n \n             @Override\n             public Observable<Edge> doSearch( final GraphManager manager ) {\n-                UUID uuid = UUIDGenerator.newTimeUUID();\n-\n-                return manager.loadEdgesFromSource( new SimpleSearchByEdgeType( sourceId, \"test\", uuid, null ) );\n+                return manager.loadEdgesFromSource( new SimpleSearchByEdgeType( sourceId, \"test\", System.currentTimeMillis(), null ) );\n             }\n         };\n \n@@ -222,9 +220,8 @@ public Edge newEdge() {\n \n             @Override\n             public Observable<Edge> doSearch( final GraphManager manager ) {\n-                UUID uuid = UUIDGenerator.newTimeUUID();\n \n-                return manager.loadEdgesToTarget( new SimpleSearchByEdgeType( targetId, \"test\", uuid, null ) );\n+                return manager.loadEdgesToTarget( new SimpleSearchByEdgeType( targetId, \"test\", System.currentTimeMillis(), null ) );\n             }\n         };\n \n@@ -251,7 +248,7 @@ private void doTest( EdgeGenerator generator ) throws InterruptedException {\n             Edge returned = manager.writeEdge( edge ).toBlockingObservable().last();\n \n \n-            assertNotNull( \"Returned has a version\", returned.getVersion() );\n+            assertNotNull( \"Returned has a version\", returned.getTimestamp() );\n \n             ids.add( returned );\n ",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerStressTest.java",
                "status": "modified",
                "changes": 13,
                "deletions": 8,
                "sha": "4b3bba45ec3c7073208c115d02cda6f6fed2e7c4",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerStressTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerStressTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/GraphManagerStressTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -27,6 +27,8 @@\n import org.jukito.UseModules;\n import org.junit.Before;\n import org.junit.runner.RunWith;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import org.apache.usergrid.persistence.core.cassandra.ITRunner;\n import org.apache.usergrid.persistence.core.consistency.AsyncProcessor;\n@@ -54,6 +56,7 @@\n @UseModules( { TestGraphModule.class } )\n public class StorageGraphManagerIT extends GraphManagerIT {\n \n+    private static final Logger LOG = LoggerFactory.getLogger( StorageGraphManagerIT.class );\n \n     @Inject\n     protected AsyncProcessor<EdgeDeleteEvent> edgeDelete;\n@@ -150,22 +153,22 @@ public ComittedGraphTestHelper( final GraphManager graphManager ) {\n \n         @Override\n         public Observable<Edge> writeEdge( final Edge edge ) {\n-            completeInvocations.decrementAndGet();\n+            completeInvocations.incrementAndGet();\n             return graphManager.writeEdge( edge );\n         }\n \n \n         @Override\n         public Observable<Edge> deleteEdge( final Edge edge ) {\n-            completeInvocations.decrementAndGet();\n+            completeInvocations.incrementAndGet();\n             return graphManager.deleteEdge( edge );\n         }\n \n \n         @Override\n-        public Observable<Id> deleteNode( final Id node ) {\n-            completeInvocations.decrementAndGet();\n-            return graphManager.deleteNode( node );\n+        public Observable<Id> deleteNode( final Id node, final long timestamp ) {\n+            completeInvocations.incrementAndGet();\n+            return graphManager.deleteNode( node, timestamp );\n         }\n \n \n@@ -233,13 +236,13 @@ public ComittedGraphTestHelper( final GraphManager graphManager ) {\n \n \n         public void complete() {\n-            completeInvocations.incrementAndGet();\n+            completeInvocations.decrementAndGet();\n             tryWake();\n         }\n \n \n         public void error() {\n-            errorInvocations.incrementAndGet();\n+            errorInvocations.decrementAndGet();\n             tryWake();\n         }\n \n@@ -255,12 +258,13 @@ public void tryWake() {\n          * Away for our invocations to be 0\n          */\n         public void await() {\n-            while (  completeInvocations.get() != 0 ) {\n+            while (  completeInvocations.get() > 0 ) {\n+\n+                LOG.info( \"Waiting for more invocations, count is {} \", completeInvocations.get() );\n \n                 synchronized ( mutex ) {\n                     try {\n-\n-                        mutex.wait();\n+                        mutex.wait(1000 );\n                     }\n                     catch ( InterruptedException e ) {\n                         //no op",
                "additions": 14,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/StorageGraphManagerIT.java",
                "status": "modified",
                "changes": 24,
                "deletions": 10,
                "sha": "8c7692496cb914b2dce60c401a3b93645d123f9d",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/StorageGraphManagerIT.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/StorageGraphManagerIT.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/StorageGraphManagerIT.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -137,20 +137,20 @@ public void testDeleteIT() throws ConnectionException {\n         final Id targetId = createId( \"target\" );\n \n \n-        MarkedEdge edgeV1 = createMarkedEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV2 = createMarkedEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV3 = createMarkedEdge( sourceId, edgeType, targetId );\n+        final long edgeTimestamp = 1000l;\n \n+        MarkedEdge edgeV1 = createMarkedEdge( sourceId, edgeType, targetId, edgeTimestamp );\n+        MarkedEdge edgeV2 = createMarkedEdge( sourceId, edgeType, targetId, edgeTimestamp + 1 );\n+        MarkedEdge edgeV3 = createMarkedEdge( sourceId, edgeType, targetId, edgeTimestamp + 2 );\n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n \n-        commitLogEdgeSerialization.writeEdge( scope, edgeV1, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV2, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV3, timestamp ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV1, UUIDGenerator.newTimeUUID() ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV2, UUIDGenerator.newTimeUUID() ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV3, UUIDGenerator.newTimeUUID() ).execute();\n \n-        storageEdgeSerialization.writeEdge( scope, edgeV1, timestamp ).execute();\n-        storageEdgeSerialization.writeEdge( scope, edgeV2, timestamp ).execute();\n-        storageEdgeSerialization.writeEdge( scope, edgeV3, timestamp ).execute();\n+        storageEdgeSerialization.writeEdge( scope, edgeV1, UUIDGenerator.newTimeUUID() ).execute();\n+        storageEdgeSerialization.writeEdge( scope, edgeV2, UUIDGenerator.newTimeUUID() ).execute();\n+        storageEdgeSerialization.writeEdge( scope, edgeV3, UUIDGenerator.newTimeUUID() ).execute();\n \n \n \n@@ -163,7 +163,7 @@ public void testDeleteIT() throws ConnectionException {\n         assertEquals( edgeV3, returned.getData() );\n \n         //now validate there's nothing in the commit log.\n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         /******\n          * Ensure everything is removed from the commit log\n@@ -278,20 +278,22 @@ public void testDeleteAllIT() throws ConnectionException {\n         final Id targetId = createId( \"target\" );\n \n \n-        MarkedEdge edgeV1 = createMarkedEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV2 = createMarkedEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV3 = createMarkedEdge( sourceId, edgeType, targetId );\n+        final long timestamp = 1000l;\n+\n+        MarkedEdge edgeV1 = createMarkedEdge( sourceId, edgeType, targetId, timestamp );\n+        MarkedEdge edgeV2 = createMarkedEdge( sourceId, edgeType, targetId, timestamp + 1 );\n+        MarkedEdge edgeV3 = createMarkedEdge( sourceId, edgeType, targetId, timestamp + 2);\n \n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n+        final UUID foobar = UUIDGenerator.newTimeUUID();\n \n-        commitLogEdgeSerialization.writeEdge( scope, edgeV1, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV2, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV3, timestamp ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV1, foobar ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV2, foobar ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV3, foobar ).execute();\n \n-        storageEdgeSerialization.writeEdge( scope, edgeV1, timestamp ).execute();\n-        storageEdgeSerialization.writeEdge( scope, edgeV2, timestamp ).execute();\n-        storageEdgeSerialization.writeEdge( scope, edgeV3, timestamp ).execute();\n+        storageEdgeSerialization.writeEdge( scope, edgeV1, foobar ).execute();\n+        storageEdgeSerialization.writeEdge( scope, edgeV2, foobar ).execute();\n+        storageEdgeSerialization.writeEdge( scope, edgeV3, foobar ).execute();\n \n         edgeMetadataSerialization.writeEdge( scope, edgeV1 ).execute();\n         edgeMetadataSerialization.writeEdge( scope, edgeV2 ).execute();\n@@ -317,7 +319,7 @@ public void testDeleteAllIT() throws ConnectionException {\n \n \n         //now validate there's nothing in the commit log.\n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         /******\n          * Ensure everything is removed from the commit log\n@@ -472,7 +474,7 @@ public void writeFailsCommitLogUnwritten() throws ConnectionException {\n         when(edgeProcessor.getProcessor( EdgeWriteEvent.class )).thenReturn( processor );\n \n \n-        EdgeWriteEvent edgeWriteEvent = new EdgeWriteEvent( scope, edgeV1.getVersion(), edgeV1 );\n+        EdgeWriteEvent edgeWriteEvent = new EdgeWriteEvent( scope,  UUIDGenerator.newTimeUUID(), edgeV1 );\n \n         Keyspace keyspace = mock( Keyspace.class );\n \n@@ -489,7 +491,7 @@ public void writeFailsCommitLogUnwritten() throws ConnectionException {\n          */\n         when( commitLog.getEdgeVersions( same( scope ), any( SearchByEdge.class ) ) ).thenReturn( Collections\n                 .singletonList( createEdge( edgeV1.getSourceNode(), edgeV1.getType(), edgeV1.getTargetNode(),\n-                        edgeV1.getVersion() ) ).iterator() );\n+                        edgeV1.getTimestamp() ) ).iterator() );\n \n \n         /**",
                "additions": 26,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListenerTest.java",
                "status": "modified",
                "changes": 50,
                "deletions": 24,
                "sha": "d54c0c93aefb6882596c1aa9772b3b4a28c296b1",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListenerTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListenerTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeDeleteListenerTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -68,6 +68,7 @@\n import static org.mockito.Mockito.doThrow;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.times;\n import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n \n@@ -130,16 +131,16 @@ public void testWriteIT() throws ConnectionException {\n         final Id targetId = createId( \"target\" );\n \n \n-        MarkedEdge edgeV1 = createEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV2 = createEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV3 = createEdge( sourceId, edgeType, targetId );\n+        final long timestamp = 1000l;\n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n+        MarkedEdge edgeV1 = createEdge( sourceId, edgeType, targetId, timestamp);\n+        MarkedEdge edgeV2 = createEdge( sourceId, edgeType, targetId, timestamp + 1 );\n+        MarkedEdge edgeV3 = createEdge( sourceId, edgeType, targetId, timestamp + 2 );\n \n \n-        commitLogEdgeSerialization.writeEdge( scope, edgeV1, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV2, timestamp).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV3, timestamp ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV1,  UUIDGenerator.newTimeUUID() ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV2,  UUIDGenerator.newTimeUUID()).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV3,  UUIDGenerator.newTimeUUID() ).execute();\n \n         EdgeWriteEvent edgeWriteEvent = new EdgeWriteEvent( scope, UUIDGenerator.newTimeUUID(), edgeV3 );\n \n@@ -149,7 +150,7 @@ public void testWriteIT() throws ConnectionException {\n         assertEquals( 3, returned.intValue() );\n \n         //now validate there's nothing in the commit log.\n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         /******\n          * Ensure everything is removed from the commit log\n@@ -260,16 +261,17 @@ public void testWritePreviousVersionIT() throws ConnectionException {\n         final String edgeType = \"test\";\n         final Id targetId = createId( \"target\" );\n \n+        final long timestamp = 10000;\n \n-        MarkedEdge edgeV1 = createEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV2 = createEdge( sourceId, edgeType, targetId );\n-        MarkedEdge edgeV3 = createEdge( sourceId, edgeType, targetId );\n+\n+        MarkedEdge edgeV1 = createEdge( sourceId, edgeType, targetId, timestamp );\n+        MarkedEdge edgeV2 = createEdge( sourceId, edgeType, targetId, timestamp+1 );\n+        MarkedEdge edgeV3 = createEdge( sourceId, edgeType, targetId, timestamp+2 );\n \n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV1, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV2, timestamp ).execute();\n-        commitLogEdgeSerialization.writeEdge( scope, edgeV3, timestamp ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV1,  UUIDGenerator.newTimeUUID() ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV2,  UUIDGenerator.newTimeUUID() ).execute();\n+        commitLogEdgeSerialization.writeEdge( scope, edgeV3,  UUIDGenerator.newTimeUUID() ).execute();\n \n         EdgeWriteEvent edgeWriteEvent = new EdgeWriteEvent( scope, UUIDGenerator.newTimeUUID(), edgeV2 );\n \n@@ -279,7 +281,7 @@ public void testWritePreviousVersionIT() throws ConnectionException {\n         assertEquals( 2, returned.intValue() );\n \n         //now validate there's nothing in the commit log.\n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         /******\n          * Ensure everything is removed from the commit log\n@@ -412,7 +414,7 @@ public void writeFailsCommitLogUnwritten() throws ConnectionException {\n         when(edgeProcessor.getProcessor( EdgeWriteEvent.class )).thenReturn( processor );\n \n \n-        EdgeWriteEvent edgeWriteEvent = new EdgeWriteEvent( scope, edgeV1.getVersion(), edgeV1 );\n+        EdgeWriteEvent edgeWriteEvent = new EdgeWriteEvent( scope, UUIDGenerator.newTimeUUID(), edgeV1 );\n \n         Keyspace keyspace = mock( Keyspace.class );\n \n@@ -430,7 +432,7 @@ public void writeFailsCommitLogUnwritten() throws ConnectionException {\n          */\n         when( commitLog.getEdgeVersions( same(scope), any( SearchByEdge.class ) ) ).thenReturn( Collections\n                 .singletonList( createEdge( edgeV1.getSourceNode(), edgeV1.getType(), edgeV1.getTargetNode(),\n-                        edgeV1.getVersion() ) ).iterator() );\n+                        edgeV1.getTimestamp() ) ).iterator() );\n \n \n         /**",
                "additions": 20,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeWriteListenerTest.java",
                "status": "modified",
                "changes": 38,
                "deletions": 18,
                "sha": "a6ea2b07dee11001fb24de3b9f03802310a4253b",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeWriteListenerTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeWriteListenerTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/EdgeWriteListenerTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -134,21 +134,17 @@ public void testNoDeletionMarked() {\n \n         Id targetNode = edge.getTargetNode();\n \n-        UUID version = UUIDGenerator.newTimeUUID();\n+        UUID eventTime = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n \n-        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, version, sourceNode );\n+        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, eventTime, now, sourceNode );\n \n         int count = deleteListener.receive( deleteEvent ).toBlockingObservable().last();\n \n         assertEquals( \"Mark was not set, no delete should be executed\", 0, count );\n \n \n-        deleteEvent = new NodeDeleteEvent( scope, version, targetNode );\n-\n-        count = deleteListener.receive( deleteEvent ).toBlockingObservable().last();\n-\n-        assertEquals( \"Mark was not set, no delete should be executed\", 0, count );\n     }\n \n \n@@ -175,11 +171,12 @@ public void testRemoveSourceNode() throws ConnectionException {\n \n \n         //mark the node so\n-        UUID deleteVersion = UUIDGenerator.newTimeUUID();\n+        UUID deleteEventTimestamp = UUIDGenerator.newTimeUUID();\n+        long timestamp = System.currentTimeMillis();\n \n-        nodeSerialization.mark( scope, sourceNode, deleteVersion ).execute();\n+        nodeSerialization.mark( scope, sourceNode, timestamp ).execute();\n \n-        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, deleteVersion, sourceNode );\n+        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, deleteEventTimestamp, timestamp, sourceNode );\n \n \n         int count = deleteListener.receive( deleteEvent ).toBlockingObservable().last();\n@@ -188,7 +185,7 @@ public void testRemoveSourceNode() throws ConnectionException {\n \n         //now verify we can't get any of the info back\n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n \n         Iterator<MarkedEdge> returned = edgeSerialization\n@@ -263,11 +260,12 @@ public void testRemoveTargetNode() throws ConnectionException {\n \n \n         //mark the node so\n-        UUID deleteVersion = UUIDGenerator.newTimeUUID();\n+        UUID deleteEventTimestamp = UUIDGenerator.newTimeUUID();\n+        long deleteTimestamp = System.currentTimeMillis();\n \n-        nodeSerialization.mark( scope, targetNode, deleteVersion ).execute();\n+        nodeSerialization.mark( scope, targetNode, deleteTimestamp ).execute();\n \n-        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, deleteVersion, targetNode );\n+        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, deleteEventTimestamp, deleteTimestamp, targetNode );\n \n \n         int count = deleteListener.receive( deleteEvent ).toBlockingObservable().last();\n@@ -276,7 +274,7 @@ public void testRemoveTargetNode() throws ConnectionException {\n \n         //now verify we can't get any of the info back\n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n \n         Iterator<MarkedEdge> returned = edgeSerialization\n@@ -376,11 +374,11 @@ public void testMultiDelete() throws ConnectionException, InterruptedException {\n         log.info( \"Saved {} source edges\", sourceCount );\n         log.info( \"Saved {} target edges\", targetCount );\n \n-        UUID deleteVersion = UUID.fromString( \"ffffffff-ffff-1fff-bfff-ffffffffffff\" );\n+        long deleteVersion = Long.MAX_VALUE;\n \n         nodeSerialization.mark( scope, toDelete, deleteVersion ).execute();\n \n-        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, deleteVersion, toDelete );\n+        NodeDeleteEvent deleteEvent = new NodeDeleteEvent( scope, UUIDGenerator.newTimeUUID(), deleteVersion, toDelete );\n \n \n         int count = deleteListener.receive( deleteEvent ).toBlockingObservable().last();\n@@ -390,7 +388,7 @@ public void testMultiDelete() throws ConnectionException, InterruptedException {\n \n         //now verify we can't get any of the info back\n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n \n            //validate it's not returned by the",
                "additions": 16,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListenerTest.java",
                "status": "modified",
                "changes": 34,
                "deletions": 18,
                "sha": "f65d7a4746e583595deeb824d01104cc18926630",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListenerTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListenerTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/NodeDeleteListenerTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -129,7 +129,7 @@ public void commitLogTest() throws ConnectionException {\n \n         //write it as non deleted to storage\n         final MarkedEdge edge1NotDeleted =\n-                createEdge( edge1.getSourceNode(), edgeType, edge1.getTargetNode(), edge1.getVersion(), false );\n+                createEdge( edge1.getSourceNode(), edgeType, edge1.getTargetNode(), edge1.getTimestamp(), false );\n \n         storageEdgeSerialization.writeEdge( scope, edge1NotDeleted,  UUIDGenerator.newTimeUUID() ).execute();\n \n@@ -141,14 +141,14 @@ public void commitLogTest() throws ConnectionException {\n         //now repair delete the first edge\n \n         Iterator<MarkedEdge> itr = commitLogEdgeSerialization.getEdgeVersions( scope,\n-                new SimpleSearchByEdge( sourceId, edgeType, targetId, UUIDGenerator.newTimeUUID(), null ) );\n+                new SimpleSearchByEdge( sourceId, edgeType, targetId, System.currentTimeMillis(), null ) );\n \n         assertEquals( edge2, itr.next() );\n         assertEquals( edge1, itr.next() );\n         assertFalse( itr.hasNext() );\n \n         itr =  storageEdgeSerialization.getEdgeVersions( scope,\n-                new SimpleSearchByEdge( sourceId, edgeType, targetId, UUIDGenerator.newTimeUUID(), null ) );\n+                new SimpleSearchByEdge( sourceId, edgeType, targetId, System.currentTimeMillis(), null ) );\n \n         assertEquals( edge2, itr.next() );\n         assertEquals( edge1NotDeleted, itr.next() );\n@@ -159,13 +159,13 @@ public void commitLogTest() throws ConnectionException {\n         assertEquals( edge1, deleted );\n \n         itr = commitLogEdgeSerialization.getEdgeVersions( scope,\n-                new SimpleSearchByEdge( sourceId, edgeType, targetId, UUIDGenerator.newTimeUUID(), null ) );\n+                new SimpleSearchByEdge( sourceId, edgeType, targetId,System.currentTimeMillis(), null ) );\n \n         assertEquals( edge2, itr.next() );\n         assertFalse( itr.hasNext() );\n \n         itr = storageEdgeSerialization.getEdgeVersions( scope,\n-                new SimpleSearchByEdge( sourceId, edgeType, targetId, UUIDGenerator.newTimeUUID(), null ) );\n+                new SimpleSearchByEdge( sourceId, edgeType, targetId, System.currentTimeMillis(), null ) );\n \n         assertEquals( edge2, itr.next() );\n         assertFalse( itr.hasNext() );",
                "additions": 5,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairTest.java",
                "status": "modified",
                "changes": 10,
                "deletions": 5,
                "sha": "f71a8ea8176d81207d2c87dd6e1e1a2288fdb46e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeDeleteRepairTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -110,7 +110,7 @@ public void cleanTargetNoEdgesNoMeta() {\n \n         final Id targetId = createId( \"target\" );\n         final String test = \"test\";\n-        final UUID version = UUIDGenerator.newTimeUUID();\n+        final long version = System.currentTimeMillis();\n \n         int value = edgeMetaRepair.repairTargets( scope, targetId, test, version ).toBlockingObservable().single();\n \n@@ -126,7 +126,7 @@ public void cleanTargetSingleEdge() throws ConnectionException {\n \n         edgeMetadataSerialization.writeEdge( scope, edge ).execute();\n \n-        int value = edgeMetaRepair.repairTargets( scope, edge.getTargetNode(), edge.getType(), edge.getVersion() )\n+        int value = edgeMetaRepair.repairTargets( scope, edge.getTargetNode(), edge.getType(), edge.getTimestamp() )\n                                   .toBlockingObservable().single();\n \n         assertEquals( \"No subtypes removed, edge exists\", 1, value );\n@@ -135,7 +135,7 @@ public void cleanTargetSingleEdge() throws ConnectionException {\n \n         storageEdgeSerialization.deleteEdge( scope, edge, UUIDGenerator.newTimeUUID() ).execute();\n \n-        value = edgeMetaRepair.repairTargets( scope, edge.getTargetNode(), edge.getType(), edge.getVersion() )\n+        value = edgeMetaRepair.repairTargets( scope, edge.getTargetNode(), edge.getType(), edge.getTimestamp() )\n                               .toBlockingObservable().single();\n \n         assertEquals( \"Single subtype should be removed\", 0, value );\n@@ -180,7 +180,7 @@ public void cleanTargetMultipleEdge() throws ConnectionException {\n         edgeMetadataSerialization.writeEdge( scope, edge3 ).execute();\n \n \n-        UUID cleanupVersion = UUIDGenerator.newTimeUUID();\n+        long cleanupVersion = System.currentTimeMillis();\n \n         int value = edgeMetaRepair.repairTargets( scope, edge1.getTargetNode(), edge1.getType(), cleanupVersion )\n                                   .toBlockingObservable().single();\n@@ -248,7 +248,7 @@ public void cleanTargetMultipleEdgeBuffer() throws ConnectionException {\n         }\n \n \n-        UUID cleanupVersion = UUIDGenerator.newTimeUUID();\n+        long cleanupVersion = System.currentTimeMillis();\n \n         int value = edgeMetaRepair.repairTargets( scope, targetId, edgeType, cleanupVersion ).toBlockingObservable()\n                                   .single();\n@@ -289,7 +289,7 @@ public void cleanSourceSingleEdge() throws ConnectionException {\n \n         edgeMetadataSerialization.writeEdge( scope, edge ).execute();\n \n-        int value = edgeMetaRepair.repairSources( scope, edge.getSourceNode(), edge.getType(), edge.getVersion() )\n+        int value = edgeMetaRepair.repairSources( scope, edge.getSourceNode(), edge.getType(), edge.getTimestamp() )\n                                   .toBlockingObservable().single();\n \n         assertEquals( \"No subtypes removed, edge exists\", 1, value );\n@@ -298,7 +298,7 @@ public void cleanSourceSingleEdge() throws ConnectionException {\n \n         storageEdgeSerialization.deleteEdge( scope, edge, UUIDGenerator.newTimeUUID() ).execute();\n \n-        value = edgeMetaRepair.repairSources( scope, edge.getSourceNode(), edge.getType(), edge.getVersion() )\n+        value = edgeMetaRepair.repairSources( scope, edge.getSourceNode(), edge.getType(), edge.getTimestamp() )\n                               .toBlockingObservable().single();\n \n         assertEquals( \"Single subtype should be removed\", 0, value );\n@@ -343,7 +343,7 @@ public void cleanSourceMultipleEdge() throws ConnectionException {\n         edgeMetadataSerialization.writeEdge( scope, edge3 ).execute();\n \n \n-        UUID cleanupVersion = UUIDGenerator.newTimeUUID();\n+        long cleanupVersion = System.currentTimeMillis();\n \n         int value = edgeMetaRepair.repairSources( scope, edge1.getSourceNode(), edge1.getType(), cleanupVersion )\n                                   .toBlockingObservable().single();\n@@ -412,7 +412,7 @@ public void cleanSourceMultipleEdgeBuffer() throws ConnectionException {\n         }\n \n \n-        UUID cleanupVersion = UUIDGenerator.newTimeUUID();\n+        long cleanupVersion = System.currentTimeMillis();\n \n         int value = edgeMetaRepair.repairSources( scope, sourceId, edgeType, cleanupVersion ).toBlockingObservable()\n                                   .single();",
                "additions": 9,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairTest.java",
                "status": "modified",
                "changes": 18,
                "deletions": 9,
                "sha": "dc7c148ee0ad1c004c96b81c598e9db536b661ff",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/impl/stage/EdgeMetaRepairTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -259,13 +259,14 @@ public void readSourceEdgeIdTypes() throws ConnectionException {\n      */\n     @Test\n     public void deleteTargetEdgeTypes() throws ConnectionException {\n-        final Edge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+        final long timestamp = 1000l;\n+        final Edge edge1 = createEdge( \"source\", \"edge\", \"target\", timestamp );\n \n         final Id sourceId = edge1.getSourceNode();\n \n-        final Edge edge2 = createEdge( sourceId, \"edge\", createId( \"target2\" ) );\n+        final Edge edge2 = createEdge( sourceId, \"edge\", createId( \"target2\" ), timestamp + 1 );\n \n-        final Edge edge3 = createEdge( sourceId, \"edge2\", createId( \"target3\" ) );\n+        final Edge edge3 = createEdge( sourceId, \"edge2\", createId( \"target3\" ), timestamp + 2 );\n \n         //set writing the edge\n         serialization.writeEdge( scope, edge1 ).execute();\n@@ -365,13 +366,16 @@ public void deleteSourceEdgeTypes() throws ConnectionException {\n      */\n     @Test\n     public void deleteTargetIdTypes() throws ConnectionException {\n-        final Edge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+\n+        final long timestamp = 1000l;\n+\n+        final Edge edge1 = createEdge( \"source\", \"edge\", \"target\", timestamp );\n \n         final Id sourceId = edge1.getSourceNode();\n \n-        final Edge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ) );\n+        final Edge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ), timestamp + 1 );\n \n-        final Edge edge3 = createEdge( sourceId, \"edge\", createId( \"target2\" ) );\n+        final Edge edge3 = createEdge( sourceId, \"edge\", createId( \"target2\" ), timestamp + 2 );\n \n         //set writing the edge\n         serialization.writeEdge( scope, edge1 ).execute();\n@@ -419,13 +423,16 @@ public void deleteTargetIdTypes() throws ConnectionException {\n      */\n     @Test\n     public void deleteSourceIdTypes() throws ConnectionException {\n-        final Edge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+\n+        final long timestamp = 1000l;\n+\n+        final Edge edge1 = createEdge( \"source\", \"edge\", \"target\", timestamp );\n \n         final Id targetId = edge1.getTargetNode();\n \n-        final Edge edge2 = createEdge( createId( \"source\" ), \"edge\", targetId );\n+        final Edge edge2 = createEdge( createId( \"source\" ), \"edge\", targetId, timestamp+1 );\n \n-        final Edge edge3 = createEdge( createId( \"source2\" ), \"edge\", targetId );\n+        final Edge edge3 = createEdge( createId( \"source2\" ), \"edge\", targetId, timestamp+2 );\n \n         //set writing the edge\n         serialization.writeEdge( scope, edge1 ).execute();",
                "additions": 16,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerializationTest.java",
                "status": "modified",
                "changes": 25,
                "deletions": 9,
                "sha": "530da50b1de3b06d6e4f50a7d718bc790d62f08e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerializationTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerializationTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeMetadataSerializationTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -110,7 +110,7 @@ public void mixedEdgeTypes() throws ConnectionException {\n         serialization.writeEdge( scope, edge, UUIDGenerator.newTimeUUID() ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationChopTest.java",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "e45ea8e65e7868c8009834590f8bd53931e70c6a",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationChopTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationChopTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationChopTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -136,7 +136,7 @@ public void mixedEdgeTypes() throws ConnectionException {\n         serialization.writeEdge( scope, edge2, timestamp ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n \n@@ -170,25 +170,29 @@ public void mixedEdgeTypes() throws ConnectionException {\n      */\n     @Test\n     public void testPaging() throws ConnectionException {\n-        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+\n+        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\", 0);\n \n         final Id sourceId = edge1.getSourceNode();\n         final Id targetId = edge1.getTargetNode();\n \n \n-        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", targetId );\n+        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", targetId, 1 );\n \n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n-\n-        serialization.writeEdge( scope, edge1, timestamp ).execute();\n-        serialization.writeEdge( scope, edge2, timestamp ).execute();\n+        serialization.writeEdge( scope, edge1, UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, edge2, UUIDGenerator.newTimeUUID() ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n \n+\n+\n+\n+\n+\n         Iterator<MarkedEdge> results =\n                 serialization.getEdgesFromSource( scope, createSearchByEdge( sourceId, \"edge\", now, edge2 ) );\n \n@@ -219,33 +223,33 @@ public void testPaging() throws ConnectionException {\n      */\n     @Test\n     public void directEdgeGets() throws ConnectionException {\n-        final MarkedEdge edgev1 = createEdge( \"source\", \"edge1\", \"target\" );\n+\n+        long timestamp = 1000;\n+        final MarkedEdge edgev1 = createEdge( \"source\", \"edge1\", \"target\", timestamp );\n \n         final Id sourceId = edgev1.getSourceNode();\n         final Id targetId = edgev1.getTargetNode();\n \n \n-        final MarkedEdge edgev2 = createEdge( sourceId, \"edge1\", targetId );\n+        final MarkedEdge edgev2 = createEdge( sourceId, \"edge1\", targetId, timestamp+1 );\n \n         //we shouldn't get this one back\n         final MarkedEdge diffTarget = createEdge( sourceId, \"edge1\", createId( \"newTarget\" ) );\n \n         assertTrue( \"Edge version 1 has lower time uuid\",\n-                UUIDComparator.staticCompare( edgev1.getVersion(), edgev2.getVersion() ) < 0 );\n+                Long.compare( edgev1.getTimestamp(), edgev2.getTimestamp() ) < 0 );\n \n         //create edge type 2 to ensure we don't get it in results\n         final MarkedEdge edgeType2V1 = createEdge( sourceId, \"edge2\", targetId );\n \n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n-\n \n-        serialization.writeEdge( scope, edgev1, timestamp ).execute();\n-        serialization.writeEdge( scope, edgev2, timestamp ).execute();\n-        serialization.writeEdge( scope, edgeType2V1, timestamp ).execute();\n-        serialization.writeEdge( scope, diffTarget, timestamp ).execute();\n+        serialization.writeEdge( scope, edgev1, UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, edgev2, UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, edgeType2V1, UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, diffTarget, UUIDGenerator.newTimeUUID() ).execute();\n \n-        final UUID now = UUIDGenerator.newTimeUUID();\n+        final long now = System.currentTimeMillis();\n \n \n         SearchByEdge search = createGetByEdge( sourceId, \"edge1\", targetId, now, null );\n@@ -259,7 +263,7 @@ public void directEdgeGets() throws ConnectionException {\n         //max version test\n \n         //test max version\n-        search = createGetByEdge( sourceId, \"edge1\", targetId, edgev1.getVersion(), null );\n+        search = createGetByEdge( sourceId, \"edge1\", targetId, edgev1.getTimestamp(), null );\n \n         results = serialization.getEdgeVersions( scope, search );\n \n@@ -290,7 +294,7 @@ public void mixedIdTypes() throws ConnectionException {\n         serialization.writeEdge( scope, edge2, timestamp ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n \n@@ -327,23 +331,23 @@ public void mixedIdTypes() throws ConnectionException {\n      */\n     @Test\n     public void idTypesPaging() throws ConnectionException {\n-        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+        final long timestamp = 1000;\n+        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\", timestamp );\n \n         final Id sourceId = edge1.getSourceNode();\n         final Id targetId1 = edge1.getTargetNode();\n \n \n-        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ) );\n+        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ), timestamp+1 );\n \n         final Id targetId2 = edge2.getTargetNode();\n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n \n-        serialization.writeEdge( scope, edge1, timestamp ).execute();\n-        serialization.writeEdge( scope, edge2, timestamp ).execute();\n+        serialization.writeEdge( scope, edge1, UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, edge2, UUIDGenerator.newTimeUUID() ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n \n@@ -385,23 +389,23 @@ public void idTypesPaging() throws ConnectionException {\n      */\n     @Test\n     public void delete() throws ConnectionException {\n-        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+        //we purposefully use the same timestamp\n+        final long timestamp = 1000l;\n+        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\", timestamp );\n \n         final Id sourceId = edge1.getSourceNode();\n         final Id targetId1 = edge1.getTargetNode();\n \n \n-        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ) );\n+        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ), timestamp );\n \n         final Id targetId2 = edge2.getTargetNode();\n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n-\n-        serialization.writeEdge( scope, edge1, timestamp ).execute();\n-        serialization.writeEdge( scope, edge2, timestamp ).execute();\n+        serialization.writeEdge( scope, edge1,  UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, edge2,  UUIDGenerator.newTimeUUID() ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n         Iterator<MarkedEdge> results = serialization.getEdgesFromSourceByTargetType( scope,\n@@ -494,23 +498,23 @@ public void delete() throws ConnectionException {\n      */\n     @Test\n     public void mark() throws ConnectionException {\n-        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\" );\n+        final long timestamp = 1000l;\n+        final MarkedEdge edge1 = createEdge( \"source\", \"edge\", \"target\", timestamp );\n \n         final Id sourceId = edge1.getSourceNode();\n         final Id targetId1 = edge1.getTargetNode();\n \n \n-        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ) );\n+        final MarkedEdge edge2 = createEdge( sourceId, \"edge\", createId( \"target\" ), timestamp+1 );\n \n         final Id targetId2 = edge2.getTargetNode();\n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n \n-        serialization.writeEdge( scope, edge1, timestamp ).execute();\n-        serialization.writeEdge( scope, edge2, timestamp ).execute();\n+        serialization.writeEdge( scope, edge1,  UUIDGenerator.newTimeUUID() ).execute();\n+        serialization.writeEdge( scope, edge2,  UUIDGenerator.newTimeUUID() ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n         Iterator<MarkedEdge> results = serialization.getEdgesFromSourceByTargetType( scope,\n@@ -557,10 +561,10 @@ public void mark() throws ConnectionException {\n         //now we've validated everything exists, lets blitz the data and ensure it's removed\n \n         final MarkedEdge mark1 =\n-                createEdge( edge1.getSourceNode(), edge1.getType(), edge1.getTargetNode(), edge1.getVersion(), true );\n+                createEdge( edge1.getSourceNode(), edge1.getType(), edge1.getTargetNode(), edge1.getTimestamp(), true );\n \n         final MarkedEdge mark2 =\n-                createEdge( edge2.getSourceNode(), edge2.getType(), edge2.getTargetNode(), edge2.getVersion(), true );\n+                createEdge( edge2.getSourceNode(), edge2.getType(), edge2.getTargetNode(), edge2.getTimestamp(), true );\n \n \n         final UUID timestamp2 = UUIDGenerator.newTimeUUID();\n@@ -662,23 +666,23 @@ public void pageIteration() throws ConnectionException {\n         Set<Edge> edges = new HashSet<Edge>( size );\n \n \n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n+       long timestamp = 0;\n \n         for ( int i = 0; i < size; i++ ) {\n-            final MarkedEdge edge = createEdge( sourceId, type, createId( \"target\" ) );\n+            final MarkedEdge edge = createEdge( sourceId, type, createId( \"target\" ), timestamp );\n \n-            serialization.writeEdge( scope, edge, timestamp ).execute();\n+            serialization.writeEdge( scope, edge, UUIDGenerator.newTimeUUID() ).execute();\n             edges.add( edge );\n-        }\n \n+            timestamp++;\n+        }\n \n-        UUID now = UUIDGenerator.newTimeUUID();\n \n         //get our edges out by name\n         Iterator<MarkedEdge> results =\n-                serialization.getEdgesFromSource( scope, createSearchByEdge( sourceId, type, now, null ) );\n+                serialization.getEdgesFromSource( scope, createSearchByEdge( sourceId, type, timestamp, null ) );\n \n-        for ( MarkedEdge edge : new IterableWrapper<MarkedEdge>( results ) ) {\n+        for ( MarkedEdge edge : new IterableWrapper<>( results ) ) {\n             assertTrue( \"Removed edge from write set\", edges.remove( edge ) );\n         }\n \n@@ -704,48 +708,47 @@ public void testIteratorPaging() throws ConnectionException {\n \n         final MutationBatch batch = keyspace.prepareMutationBatch();\n \n-        UUID lastMax = null;\n-\n-        final UUID timestamp = UUIDGenerator.newTimeUUID();\n+        long timestamp = 10000l;\n \n         for ( int i = 0; i < writeCount; i++ ) {\n \n-            final MarkedEdge edge = createEdge( sourceId, edgeType, targetId );\n+            final MarkedEdge edge = createEdge( sourceId, edgeType, targetId, timestamp );\n \n-            lastMax = edge.getVersion();\n+            batch.mergeShallow( serialization.writeEdge( scope, edge, UUIDGenerator.newTimeUUID() ) );\n \n-            batch.mergeShallow( serialization.writeEdge( scope, edge, timestamp ) );\n+            //increment timestamp (not done inline on purpose) If we do System.currentMillis we get the same edge on fast systems\n+            timestamp++;\n         }\n \n         log.info( \"Flushing edges\" );\n         batch.execute();\n \n \n         Iterator<MarkedEdge> results =\n-                serialization.getEdgeVersions( scope, createGetByEdge( sourceId, edgeType, targetId, lastMax, null ) );\n+                serialization.getEdgeVersions( scope, createGetByEdge( sourceId, edgeType, targetId, timestamp, null ) );\n \n         verify( results, writeCount );\n \n \n         //get them all from source\n-        results = serialization.getEdgesFromSource( scope, createSearchByEdge( sourceId, edgeType, lastMax, null ) );\n+        results = serialization.getEdgesFromSource( scope, createSearchByEdge( sourceId, edgeType, timestamp, null ) );\n \n         verify( results, writeCount );\n \n \n         results = serialization.getEdgesFromSourceByTargetType( scope,\n-                createSearchByEdgeAndId( sourceId, edgeType, lastMax, targetId.getType(), null ) );\n+                createSearchByEdgeAndId( sourceId, edgeType, timestamp, targetId.getType(), null ) );\n \n         verify( results, writeCount );\n \n \n-        results = serialization.getEdgesToTarget( scope, createSearchByEdge( targetId, edgeType, lastMax, null ) );\n+        results = serialization.getEdgesToTarget( scope, createSearchByEdge( targetId, edgeType, timestamp, null ) );\n \n         verify( results, writeCount );\n \n \n         results = serialization.getEdgesToTargetBySourceType( scope,\n-                createSearchByEdgeAndId( targetId, edgeType, lastMax, sourceId.getType(), null ) );\n+                createSearchByEdgeAndId( targetId, edgeType, timestamp, sourceId.getType(), null ) );\n \n         verify( results, writeCount );\n     }\n@@ -771,7 +774,7 @@ public void successiveWriteReturnSource() throws ConnectionException {\n         serialization.writeEdge( scope, edge1, timestamp2 ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n \n@@ -862,7 +865,7 @@ public void successiveWriteReturnTarget() throws ConnectionException {\n         serialization.writeEdge( scope, edge1, timestamp2 ).execute();\n \n \n-        UUID now = UUIDGenerator.newTimeUUID();\n+        long now = System.currentTimeMillis();\n \n         //get our edges out by name\n ",
                "additions": 64,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationTest.java",
                "status": "modified",
                "changes": 125,
                "deletions": 61,
                "sha": "9c29d56b6eb66e67444971754aa2de7364493e93",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/EdgeSerializationTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -87,13 +87,13 @@ public void setup() {\n     public void writeReadDelete() throws ConnectionException {\n \n         final Id nodeId = createId( \"test\" );\n-        final UUID version = UUIDGenerator.newTimeUUID();\n+        final long version = System.currentTimeMillis();\n \n         serialization.mark( scope, nodeId, version ).execute();\n \n-        Optional<UUID> returned = serialization.getMaxVersion( scope, nodeId );\n+        Optional<Long> returned = serialization.getMaxVersion( scope, nodeId );\n \n-        assertEquals( version, returned.get() );\n+        assertEquals( version, returned.get().longValue() );\n \n         serialization.delete( scope, nodeId, returned.get() ).execute();\n \n@@ -114,7 +114,7 @@ public void noDeleteVersion() {\n \n         final Id nodeId = createId( \"test\" );\n \n-        Optional<UUID> returned = serialization.getMaxVersion( scope, nodeId );\n+        Optional<Long>returned = serialization.getMaxVersion( scope, nodeId );\n \n         /**\n          * Verifies we didnt' get anything back when nothing has been marked\n@@ -130,14 +130,14 @@ public void noDeleteVersion() {\n     public void oldVersionDiscarded() throws ConnectionException {\n \n         final Id nodeId = createId( \"test\" );\n-        final UUID version1 = UUIDGenerator.newTimeUUID();\n-        final UUID version2 = UUIDGenerator.newTimeUUID();\n+        final long version1 = System.currentTimeMillis();\n+        final long version2 = version1+1;\n \n         serialization.mark( scope, nodeId, version2 ).execute();\n \n-        Optional<UUID> returned = serialization.getMaxVersion( scope, nodeId );\n+        Optional<Long>returned = serialization.getMaxVersion( scope, nodeId );\n \n-        assertEquals( version2, returned.get() );\n+        assertEquals( version2, returned.get().longValue() );\n \n         //now write version1, it should be discarded\n \n@@ -148,14 +148,14 @@ public void oldVersionDiscarded() throws ConnectionException {\n         /**\n          * Verifies that it is deleted\n          */\n-        assertEquals( version2, returned.get() );\n+        assertEquals( version2, returned.get().longValue() );\n \n         //perform a delete with v1, we shouldn't lose the column\n         serialization.delete( scope, nodeId, version1 ).execute();\n \n         returned = serialization.getMaxVersion( scope, nodeId );\n \n-        assertEquals( version2, returned.get() );\n+        assertEquals( version2, returned.get().longValue() );\n \n         //now delete v2\n         serialization.delete( scope, nodeId, version2 ).execute();\n@@ -177,17 +177,17 @@ public void multiGet() throws ConnectionException {\n         final Id nodeId3 = createId( \"test\" );\n \n \n-        final UUID version = UUIDGenerator.newTimeUUID();\n+        final long version = System.currentTimeMillis();\n \n         serialization.mark( scope, nodeId1, version ).execute();\n         serialization.mark( scope, nodeId2, version ).execute();\n \n-        Map<Id, UUID> marks = serialization.getMaxVersions( scope,\n+        Map<Id, Long> marks = serialization.getMaxVersions( scope,\n                 Arrays.asList( createEdge( nodeId1, \"test\", nodeId2 ), createEdge( nodeId2, \"test\", nodeId3 ) ) );\n \n \n-        assertEquals( version, marks.get( nodeId1 ) );\n-        assertEquals( version, marks.get( nodeId2 ) );\n+        assertEquals( version, marks.get( nodeId1 ).longValue() );\n+        assertEquals( version, marks.get( nodeId2 ).longValue() );\n         assertFalse( marks.containsKey( nodeId3 ) );\n     }\n }",
                "additions": 14,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/NodeSerializationTest.java",
                "status": "modified",
                "changes": 28,
                "deletions": 14,
                "sha": "a731bab61751cd255abaab37ddd81eefc9855850",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/NodeSerializationTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/NodeSerializationTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/NodeSerializationTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -67,7 +67,7 @@ public void testDifferentTargetSourceEdges() {\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), createId( \"target\" ),\n-                        first.edge.getVersion() ), edgeSerialization );\n+                        first.edge.getTimestamp() ), edgeSerialization );\n \n \n         int compare = new MergedEdgeReaderImpl.SourceEdgeComparator( edgeSerialization ).compare( first, second );\n@@ -78,14 +78,17 @@ public void testDifferentTargetSourceEdges() {\n \n     @Test\n     public void testDifferentVersionSourceEdges() {\n+        final long firstTime = 1000l;\n+               final long secondTime = firstTime +1;\n+\n \n         MergedEdgeReaderImpl.SourceAwareMarkedEdge first =\n-                new MergedEdgeReaderImpl.SourceAwareMarkedEdge( createEdge( \"source\", \"edge\", \"target\" ),\n+                new MergedEdgeReaderImpl.SourceAwareMarkedEdge( createEdge( \"source\", \"edge\", \"target\", firstTime ),\n                         edgeSerialization );\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), first.edge.getTargetNode(),\n-                        UUIDGenerator.newTimeUUID() ), edgeSerialization );\n+                       secondTime), edgeSerialization );\n \n \n         int compare = new MergedEdgeReaderImpl.SourceEdgeComparator( edgeSerialization ).compare( first, second );\n@@ -105,7 +108,7 @@ public void testDifferentSourceIteratorsSourceEdges() {\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), first.edge.getTargetNode(),\n-                        first.edge.getVersion() ), other );\n+                        first.edge.getTimestamp() ), other );\n \n         MergedEdgeReaderImpl.SourceEdgeComparator comparator =\n                 new MergedEdgeReaderImpl.SourceEdgeComparator( edgeSerialization );\n@@ -146,7 +149,7 @@ public void testDifferentTargetTargetEdges() {\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( createId( \"source\" ), first.edge.getType(), first.edge.getTargetNode(),\n-                        first.edge.getVersion() ), edgeSerialization );\n+                        first.edge.getTimestamp() ), edgeSerialization );\n         ;\n \n \n@@ -159,13 +162,17 @@ public void testDifferentTargetTargetEdges() {\n     @Test\n     public void testDifferentVersionTargetEdges() {\n \n+        final long firstTime = 1000l;\n+                      final long secondTime = firstTime +1;\n+\n+\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge first =\n-                new MergedEdgeReaderImpl.SourceAwareMarkedEdge( createEdge( \"source\", \"edge\", \"target\" ),\n+                new MergedEdgeReaderImpl.SourceAwareMarkedEdge( createEdge( \"source\", \"edge\", \"target\", firstTime),\n                         edgeSerialization );\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), first.edge.getTargetNode(),\n-                        UUIDGenerator.newTimeUUID() ), edgeSerialization );\n+                        secondTime ), edgeSerialization );\n \n \n         int compare = new MergedEdgeReaderImpl.TargetEdgeComparator( edgeSerialization ).compare( first, second );\n@@ -185,7 +192,7 @@ public void testDifferentDeleteTargetEdges() {\n \n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), first.edge.getTargetNode(),\n-                        first.edge.getVersion() ), other );\n+                        first.edge.getTimestamp() ), other );\n \n         MergedEdgeReaderImpl.TargetEdgeComparator comparator =\n                 new MergedEdgeReaderImpl.TargetEdgeComparator( edgeSerialization );\n@@ -203,13 +210,16 @@ public void testDifferentDeleteTargetEdges() {\n     @Test\n     public void testDifferentVersion() {\n \n+        final long firstTime = 1000l;\n+        final long secondTime = firstTime +1;\n+\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge first =\n-                new MergedEdgeReaderImpl.SourceAwareMarkedEdge( createEdge( \"source\", \"edge\", \"target\" ),\n+                new MergedEdgeReaderImpl.SourceAwareMarkedEdge( createEdge( \"source\", \"edge\", \"target\", firstTime),\n                         edgeSerialization );\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), first.edge.getTargetNode(),\n-                        UUIDGenerator.newTimeUUID() ), edgeSerialization );\n+                       secondTime ), edgeSerialization );\n \n         int compare = new MergedEdgeReaderImpl.EdgeVersionComparator( edgeSerialization ).compare( first, second );\n \n@@ -228,7 +238,7 @@ public void testDifferentMark() {\n         //same as first, just with large target node\n         MergedEdgeReaderImpl.SourceAwareMarkedEdge second = new MergedEdgeReaderImpl.SourceAwareMarkedEdge(\n                 createEdge( first.edge.getSourceNode(), first.edge.getType(), first.edge.getTargetNode(),\n-                        first.edge.getVersion() ), otherSerialization );\n+                        first.edge.getTimestamp() ), otherSerialization );\n \n         MergedEdgeReaderImpl.EdgeVersionComparator comparator =\n                 new MergedEdgeReaderImpl.EdgeVersionComparator( edgeSerialization );",
                "additions": 21,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImplComparatorTest.java",
                "status": "modified",
                "changes": 32,
                "deletions": 11,
                "sha": "3e467c124a01a855625ac1afe19777e38afb7fa7",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImplComparatorTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImplComparatorTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderImplComparatorTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -34,8 +34,6 @@\n import org.apache.usergrid.persistence.model.entity.Id;\n import org.apache.usergrid.persistence.model.util.UUIDGenerator;\n \n-import com.fasterxml.uuid.UUIDComparator;\n-\n import static org.apache.usergrid.persistence.graph.test.util.EdgeTestUtils.createEdge;\n import static org.apache.usergrid.persistence.graph.test.util.EdgeTestUtils.createId;\n import static org.apache.usergrid.persistence.graph.test.util.EdgeTestUtils.createSearchByEdge;\n@@ -83,24 +81,29 @@ public void testOrderedMergeSource() {\n         final Id sourceId = createId( \"source\" );\n         final String type = \"test\";\n \n+        final long timestamp1 = 1000l;\n+        final long timestamp2 = timestamp1 + 100l;\n+        final long timestamp3 = timestamp2 + 100l;\n+        final long timestamp4 = timestamp3 + 100l;\n+\n \n-        MarkedEdge commitLogEdge1 = createEdge( sourceId, type, createId( \"target1\" ) );\n-        MarkedEdge storageEdge1 = createEdge( sourceId, type, createId( \"target2\" ) );\n-        MarkedEdge commitLogEdge2 = createEdge( sourceId, type, createId( \"target3\" ) );\n-        MarkedEdge storageEdge2 = createEdge( sourceId, type, createId( \"target4\" ) );\n+        MarkedEdge commitLogEdge1 = createEdge( sourceId, type, createId( \"target1\" ), timestamp1 );\n+        MarkedEdge storageEdge1 = createEdge( sourceId, type, createId( \"target2\" ), timestamp2 );\n+        MarkedEdge commitLogEdge2 = createEdge( sourceId, type, createId( \"target3\" ), timestamp3 );\n+        MarkedEdge storageEdge2 = createEdge( sourceId, type, createId( \"target4\" ), timestamp4 );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( storageEdge1.getVersion(), commitLogEdge2.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( storageEdge1.getTimestamp(), commitLogEdge2.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) < 0 );\n \n-        SearchByEdgeType searchByEdgeType = createSearchByEdge( sourceId, type, UUIDGenerator.newTimeUUID(), null );\n+        SearchByEdgeType searchByEdgeType = createSearchByEdge( sourceId, type, System.currentTimeMillis(), null );\n \n         /**\n          * Mock up the commit log\n          */\n         when( commitLog.getEdgesFromSource( scope, searchByEdgeType ) )\n-                .thenReturn( Arrays.asList( commitLogEdge2, commitLogEdge1).iterator() );\n+                .thenReturn( Arrays.asList( commitLogEdge2, commitLogEdge1 ).iterator() );\n \n         /**\n          * Mock up the storage\n@@ -136,16 +139,20 @@ public void testOrderedMergeSourceDeleted() {\n         final String type = \"test\";\n \n \n-        MarkedEdge commitLogEdge1 = createEdge( sourceId, type, createId( \"target\" ), UUIDGenerator.newTimeUUID(), true );\n-        MarkedEdge storageEdge1 =   createEdge( sourceId, type, commitLogEdge1.getTargetNode(), commitLogEdge1.getVersion(), false );\n-        MarkedEdge commitLogEdge2 =  createEdge( sourceId, type, createId( \"target\" ), UUIDGenerator.newTimeUUID(), true );\n-        MarkedEdge storageEdge2 =  createEdge( sourceId, type, commitLogEdge2.getTargetNode(), commitLogEdge2.getVersion(), false );\n+        MarkedEdge commitLogEdge1 =\n+                createEdge( sourceId, type, createId( \"target\" ), System.currentTimeMillis(), true );\n+        MarkedEdge storageEdge1 =\n+                createEdge( sourceId, type, commitLogEdge1.getTargetNode(), commitLogEdge1.getTimestamp(), false );\n+        MarkedEdge commitLogEdge2 =\n+                createEdge( sourceId, type, createId( \"target\" ), System.currentTimeMillis(), true );\n+        MarkedEdge storageEdge2 =\n+                createEdge( sourceId, type, commitLogEdge2.getTargetNode(), commitLogEdge2.getTimestamp(), false );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) ==  0 );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) == 0 );\n \n-        SearchByEdgeType searchByEdgeType = createSearchByEdge( sourceId, type, UUIDGenerator.newTimeUUID(), null );\n+        SearchByEdgeType searchByEdgeType = createSearchByEdge( sourceId, type, System.currentTimeMillis(), null );\n \n         /**\n          * Mock up the commit log\n@@ -182,18 +189,23 @@ public void testOrderedMergeSourceTargetType() {\n         final String type = \"test\";\n         final String targetIdType = \"target\";\n \n-        MarkedEdge commitLogEdge1 = createEdge( sourceId, type, createId( targetIdType ) );\n-        MarkedEdge storageEdge1 = createEdge( sourceId, type, createId( targetIdType ) );\n-        MarkedEdge commitLogEdge2 = createEdge( sourceId, type, createId( targetIdType ) );\n-        MarkedEdge storageEdge2 = createEdge( sourceId, type, createId( targetIdType ) );\n+        final long timestamp1 = 1000l;\n+        final long timestamp2 = timestamp1 + 100l;\n+        final long timestamp3 = timestamp2 + 100l;\n+        final long timestamp4 = timestamp3 + 100l;\n+\n+        MarkedEdge commitLogEdge1 = createEdge( sourceId, type, createId( targetIdType ), timestamp1 );\n+        MarkedEdge storageEdge1 = createEdge( sourceId, type, createId( targetIdType ), timestamp2 );\n+        MarkedEdge commitLogEdge2 = createEdge( sourceId, type, createId( targetIdType ), timestamp3 );\n+        MarkedEdge storageEdge2 = createEdge( sourceId, type, createId( targetIdType ), timestamp4 );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( storageEdge1.getVersion(), commitLogEdge2.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( storageEdge1.getTimestamp(), commitLogEdge2.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) < 0 );\n \n         SearchByIdType searchByEdgeType =\n-                createSearchByEdgeAndId( sourceId, type, UUIDGenerator.newTimeUUID(), targetIdType, null );\n+                createSearchByEdgeAndId( sourceId, type, System.currentTimeMillis(), targetIdType, null );\n \n         /**\n          * Mock up the commit log\n@@ -221,6 +233,7 @@ public void testOrderedMergeSourceTargetType() {\n         assertFalse( marked.hasNext() );\n     }\n \n+\n     @Test\n     public void testOrderedMergeSourceTargetTypeDeleted() {\n \n@@ -232,17 +245,21 @@ public void testOrderedMergeSourceTargetTypeDeleted() {\n         final String type = \"test\";\n         final String targetIdType = \"target\";\n \n-        MarkedEdge commitLogEdge1 = createEdge( sourceId, type, createId( targetIdType ), UUIDGenerator.newTimeUUID(), true );\n-        MarkedEdge storageEdge1 = createEdge( sourceId, type, commitLogEdge1.getTargetNode(), commitLogEdge1.getVersion(), false );\n-        MarkedEdge commitLogEdge2 = createEdge( sourceId, type, createId( targetIdType ) , UUIDGenerator.newTimeUUID(), true);\n-        MarkedEdge storageEdge2 = createEdge( sourceId, type, commitLogEdge2.getTargetNode(), commitLogEdge2.getVersion(), false );\n+        MarkedEdge commitLogEdge1 =\n+                createEdge( sourceId, type, createId( targetIdType ), System.currentTimeMillis(), true );\n+        MarkedEdge storageEdge1 =\n+                createEdge( sourceId, type, commitLogEdge1.getTargetNode(), commitLogEdge1.getTimestamp(), false );\n+        MarkedEdge commitLogEdge2 =\n+                createEdge( sourceId, type, createId( targetIdType ), System.currentTimeMillis(), true );\n+        MarkedEdge storageEdge2 =\n+                createEdge( sourceId, type, commitLogEdge2.getTargetNode(), commitLogEdge2.getTimestamp(), false );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) == 0  );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) == 0 );\n \n         SearchByIdType searchByEdgeType =\n-                createSearchByEdgeAndId( sourceId, type, UUIDGenerator.newTimeUUID(), targetIdType, null );\n+                createSearchByEdgeAndId( sourceId, type, System.currentTimeMillis(), targetIdType, null );\n \n         /**\n          * Mock up the commit log\n@@ -268,9 +285,6 @@ public void testOrderedMergeSourceTargetTypeDeleted() {\n     }\n \n \n-\n-\n-\n     @Test\n     public void testOrderedMergeTarget() {\n \n@@ -281,18 +295,22 @@ public void testOrderedMergeTarget() {\n         final Id targetId = createId( \"target\" );\n         final String type = \"test\";\n \n+        final long timestamp1 = 1000l;\n+        final long timestamp2 = timestamp1 + 100l;\n+        final long timestamp3 = timestamp2 + 100l;\n+        final long timestamp4 = timestamp3 + 100l;\n \n-        MarkedEdge commitLogEdge1 = createEdge( createId( \"source\" ), type, targetId );\n-        MarkedEdge storageEdge1 = createEdge( createId( \"source\" ), type, targetId );\n-        MarkedEdge commitLogEdge2 = createEdge( createId( \"source\" ), type, targetId );\n-        MarkedEdge storageEdge2 = createEdge( createId( \"source\" ), type, targetId );\n+        MarkedEdge commitLogEdge1 = createEdge( createId( \"source\" ), type, targetId, timestamp1 );\n+        MarkedEdge storageEdge1 = createEdge( createId( \"source\" ), type, targetId, timestamp2 );\n+        MarkedEdge commitLogEdge2 = createEdge( createId( \"source\" ), type, targetId, timestamp3 );\n+        MarkedEdge storageEdge2 = createEdge( createId( \"source\" ), type, targetId, timestamp4 );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( storageEdge1.getVersion(), commitLogEdge2.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( storageEdge1.getTimestamp(), commitLogEdge2.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) < 0 );\n \n-        SearchByEdgeType searchByEdgeType = createSearchByEdge( targetId, type, UUIDGenerator.newTimeUUID(), null );\n+        SearchByEdgeType searchByEdgeType = createSearchByEdge( targetId, type, System.currentTimeMillis(), null );\n \n         /**\n          * Mock up the commit log\n@@ -333,19 +351,24 @@ public void testOrderedMergeTargetDeleted() {\n         final Id targetId = createId( \"target\" );\n         final String type = \"test\";\n \n+        final long timestamp1 = 1000l;\n+              final long timestamp2 = timestamp1 + 100l;\n+\n \n         MarkedEdge commitLogEdge1 =\n-                createEdge( createId( \"source\" ), type, targetId, UUIDGenerator.newTimeUUID(), true );\n-        MarkedEdge storageEdge1 = createEdge( commitLogEdge1.getSourceNode(), type, commitLogEdge1.getTargetNode(), commitLogEdge1.getVersion(), false );\n+                createEdge( createId( \"source\" ), type, targetId, timestamp1, true );\n+        MarkedEdge storageEdge1 = createEdge( commitLogEdge1.getSourceNode(), type, commitLogEdge1.getTargetNode(),\n+                commitLogEdge1.getTimestamp(), false );\n         MarkedEdge commitLogEdge2 =\n-                createEdge( createId( \"source\" ), type, targetId, UUIDGenerator.newTimeUUID(), true );\n-        MarkedEdge storageEdge2 = createEdge( commitLogEdge2.getSourceNode(), type, commitLogEdge2.getTargetNode(), commitLogEdge2.getVersion(), false );\n+                createEdge( createId( \"source\" ), type, targetId, timestamp2, true );\n+        MarkedEdge storageEdge2 = createEdge( commitLogEdge2.getSourceNode(), type, commitLogEdge2.getTargetNode(),\n+                commitLogEdge2.getTimestamp(), false );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) ==  0 );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) == 0 );\n \n-        SearchByEdgeType searchByEdgeType = createSearchByEdge( targetId, type, UUIDGenerator.newTimeUUID(), null );\n+        SearchByEdgeType searchByEdgeType = createSearchByEdge( targetId, type, System.currentTimeMillis(), null );\n \n         /**\n          * Mock up the commit log\n@@ -383,18 +406,24 @@ public void testOrderedMergeTargetSourceType() {\n         final String type = \"test\";\n         final String sourceIdType = \"source\";\n \n-        MarkedEdge commitLogEdge1 = createEdge( createId( sourceIdType), type, targetId );\n-        MarkedEdge storageEdge1 = createEdge( createId( sourceIdType ), type, targetId );\n-        MarkedEdge commitLogEdge2 = createEdge( createId( sourceIdType), type, targetId );\n-        MarkedEdge storageEdge2 = createEdge( createId( sourceIdType ), type, targetId );\n+        final long timestamp1 = 1000l;\n+        final long timestamp2 = timestamp1 + 100l;\n+        final long timestamp3 = timestamp2 + 100l;\n+        final long timestamp4 = timestamp3 + 100l;\n+\n+\n+        MarkedEdge commitLogEdge1 = createEdge( createId( sourceIdType ), type, targetId, timestamp1 );\n+        MarkedEdge storageEdge1 = createEdge( createId( sourceIdType ), type, targetId, timestamp2 );\n+        MarkedEdge commitLogEdge2 = createEdge( createId( sourceIdType ), type, targetId, timestamp3 );\n+        MarkedEdge storageEdge2 = createEdge( createId( sourceIdType ), type, targetId, timestamp4 );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( storageEdge1.getVersion(), commitLogEdge2.getVersion() ) < 0 );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( storageEdge1.getTimestamp(), commitLogEdge2.getTimestamp() ) < 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) < 0 );\n \n         SearchByIdType searchByEdgeType =\n-                createSearchByEdgeAndId( targetId, type, UUIDGenerator.newTimeUUID(), sourceIdType, null );\n+                createSearchByEdgeAndId( targetId, type, System.currentTimeMillis(), sourceIdType, null );\n \n         /**\n          * Mock up the commit log\n@@ -415,8 +444,6 @@ public void testOrderedMergeTargetSourceType() {\n                 read.getEdgesToTargetBySourceType( scope, searchByEdgeType ).toBlockingObservable().getIterator();\n \n \n-\n-\n         assertEquals( storageEdge2, marked.next() );\n         assertEquals( commitLogEdge2, marked.next() );\n         assertEquals( storageEdge1, marked.next() );\n@@ -425,6 +452,7 @@ public void testOrderedMergeTargetSourceType() {\n         assertFalse( marked.hasNext() );\n     }\n \n+\n     @Test\n     public void testOrderedMergeTargetSourceTypeDeleted() {\n \n@@ -436,17 +464,22 @@ public void testOrderedMergeTargetSourceTypeDeleted() {\n         final String type = \"test\";\n         final String sourceIdType = \"target\";\n \n-        MarkedEdge commitLogEdge1 = createEdge( createId( sourceIdType), type, targetId, UUIDGenerator.newTimeUUID(), true );\n-        MarkedEdge storageEdge1 = createEdge( commitLogEdge1.getSourceNode(), type, commitLogEdge1.getTargetNode(), commitLogEdge1.getVersion(), false );\n-        MarkedEdge commitLogEdge2 = createEdge( createId( sourceIdType), type, targetId , UUIDGenerator.newTimeUUID(), true);\n-        MarkedEdge storageEdge2 = createEdge( commitLogEdge2.getSourceNode(), type, commitLogEdge2.getTargetNode(), commitLogEdge2.getVersion(), false );\n+        final long timestamp1 = 10000l;\n+        final long timestamp2 = timestamp1 + 100;\n+\n+        MarkedEdge commitLogEdge1 = createEdge( createId( sourceIdType ), type, targetId, timestamp1, true );\n+        MarkedEdge storageEdge1 = createEdge( commitLogEdge1.getSourceNode(), type, commitLogEdge1.getTargetNode(),\n+                commitLogEdge1.getTimestamp(), false );\n+        MarkedEdge commitLogEdge2 = createEdge( createId( sourceIdType ), type, targetId, timestamp2, true );\n+        MarkedEdge storageEdge2 = createEdge( commitLogEdge2.getSourceNode(), type, commitLogEdge2.getTargetNode(),\n+                commitLogEdge2.getTimestamp(), false );\n \n         //verify our versions are as expected\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge1.getVersion(), storageEdge1.getVersion() ) == 0  );\n-        assertTrue( UUIDComparator.staticCompare( commitLogEdge2.getVersion(), storageEdge2.getVersion() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge1.getTimestamp(), storageEdge1.getTimestamp() ) == 0 );\n+        assertTrue( Long.compare( commitLogEdge2.getTimestamp(), storageEdge2.getTimestamp() ) == 0 );\n \n         SearchByIdType searchByEdgeType =\n-                createSearchByEdgeAndId( targetId, type, UUIDGenerator.newTimeUUID(), sourceIdType, null );\n+                createSearchByEdgeAndId( targetId, type, System.currentTimeMillis(), sourceIdType, null );\n \n         /**\n          * Mock up the commit log\n@@ -471,5 +504,4 @@ public void testOrderedMergeTargetSourceTypeDeleted() {\n \n         assertFalse( marked.hasNext() );\n     }\n-\n }",
                "additions": 101,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderTest.java",
                "status": "modified",
                "changes": 170,
                "deletions": 69,
                "sha": "d54349a5ab67b134bfd6a2aea1d7013577bb051b",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/MergedEdgeReaderTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -83,7 +83,7 @@ public void testNoShards() throws ConnectionException {\n         final String otherIdType = \"type\";\n \n \n-        UUID newTime = UUIDGenerator.newTimeUUID();\n+        final long newTime = 10000l;\n \n \n         NodeShardCache cache = new NodeShardCacheImpl( allocation, graphFig );\n@@ -128,7 +128,7 @@ public void testSingleExistingShard() {\n         final String otherIdType = \"type\";\n \n \n-        UUID newTime = UUIDGenerator.newTimeUUID();\n+        final long newTime = 10000l;\n \n         final long min = 0;\n \n@@ -196,54 +196,54 @@ public void testRangeShard() {\n \n         //check getting equal to our min, mid and max\n \n-        long slice = cache.getSlice( scope, id, EdgeTestUtils.setTimestamp(min), edgeType, otherIdType );\n+        long slice = cache.getSlice( scope, id, min, edgeType, otherIdType );\n \n \n         //we return the min UUID possible, all edges should start by writing to this edge\n         assertEquals( min, slice );\n \n-        slice = cache.getSlice( scope, id, EdgeTestUtils.setTimestamp(mid),\n+        slice = cache.getSlice( scope, id, mid,\n                 edgeType, otherIdType );\n \n \n         //we return the mid UUID possible, all edges should start by writing to this edge\n         assertEquals( mid, slice );\n \n-        slice = cache.getSlice( scope, id, EdgeTestUtils.setTimestamp(max) ,\n+        slice = cache.getSlice( scope, id, max ,\n                 edgeType, otherIdType );\n \n \n         //we return the mid UUID possible, all edges should start by writing to this edge\n         assertEquals( max, slice );\n \n         //now test in between\n-        slice = cache.getSlice( scope, id, EdgeTestUtils.setTimestamp( min+1 ), edgeType, otherIdType );\n+        slice = cache.getSlice( scope, id, min+1, edgeType, otherIdType );\n \n \n         //we return the min UUID possible, all edges should start by writing to this edge\n         assertEquals( min, slice );\n \n-        slice = cache.getSlice( scope, id,  EdgeTestUtils.setTimestamp(  mid-1 ), edgeType, otherIdType );\n+        slice = cache.getSlice( scope, id,   mid-1, edgeType, otherIdType );\n \n \n         //we return the min UUID possible, all edges should start by writing to this edge\n         assertEquals( min, slice );\n \n \n-        slice = cache.getSlice( scope, id,  EdgeTestUtils.setTimestamp(  mid+1 ), edgeType, otherIdType );\n+        slice = cache.getSlice( scope, id,   mid+1, edgeType, otherIdType );\n \n \n         //we return the mid UUID possible, all edges should start by writing to this edge\n         assertEquals( mid, slice );\n \n-        slice = cache.getSlice( scope, id,  EdgeTestUtils.setTimestamp( max-1), edgeType, otherIdType );\n+        slice = cache.getSlice( scope, id,  max-1, edgeType, otherIdType );\n \n \n         //we return the mid UUID possible, all edges should start by writing to this edge\n         assertEquals( mid, slice );\n \n \n-        slice = cache.getSlice( scope, id,  EdgeTestUtils.setTimestamp(  max ), edgeType, otherIdType );\n+        slice = cache.getSlice( scope, id,   max, edgeType, otherIdType );\n \n \n         //we return the mid UUID possible, all edges should start by writing to this edge\n@@ -295,22 +295,22 @@ public void testRangeShardIterator() {\n         //check getting equal to our min, mid and max\n \n         Iterator<Long> slice =\n-                cache.getVersions( scope, id,  EdgeTestUtils.setTimestamp(  max ), edgeType, otherIdType );\n+                cache.getVersions( scope, id,   max, edgeType, otherIdType );\n \n \n         assertEquals( max, slice.next().longValue() );\n         assertEquals( mid, slice.next().longValue() );\n         assertEquals( min, slice.next().longValue() );\n \n \n-        slice = cache.getVersions( scope, id,  EdgeTestUtils.setTimestamp(  mid ),\n+        slice = cache.getVersions( scope, id,   mid,\n                 edgeType, otherIdType );\n \n         assertEquals( mid, slice.next().longValue() );\n         assertEquals( min, slice.next().longValue() );\n \n \n-        slice = cache.getVersions( scope, id,  EdgeTestUtils.setTimestamp(  min ),\n+        slice = cache.getVersions( scope, id,   min,\n                 edgeType, otherIdType );\n \n         assertEquals( min, slice.next().longValue() );",
                "additions": 13,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCacheTest.java",
                "status": "modified",
                "changes": 26,
                "deletions": 13,
                "sha": "6c46c324c5d1423a56f499f7053716b580054bc8",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCacheTest.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCacheTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/serialization/impl/shard/NodeShardCacheTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -67,10 +67,26 @@\n      * @return an Edge for testing\n      */\n     public static MarkedEdge createEdge( final String sourceType, final String edgeType, final String targetType ) {\n-        return createEdge( createId( sourceType ), edgeType, createId( targetType ), UUIDGenerator.newTimeUUID() );\n+        return createEdge( createId( sourceType ), edgeType, createId( targetType ), System.currentTimeMillis() );\n     }\n \n \n+    /**\n+     * Create an edge for testing\n+     *\n+     * @param sourceType The source type to use in the id\n+     * @param edgeType The edge type to use\n+     * @param targetType The target type to use\n+     * @param timestamp the edge's timestamp\n+     *\n+     * @return an Edge for testing\n+     */\n+    public static MarkedEdge createEdge( final String sourceType, final String edgeType, final String targetType, final long timestamp ) {\n+        return createEdge( createId( sourceType ), edgeType, createId( targetType ), timestamp );\n+    }\n+\n+\n+\n     /**\n      * Create an edge for testing\n      *\n@@ -82,7 +98,7 @@ public static MarkedEdge createEdge( final String sourceType, final String edgeT\n      */\n     public static MarkedEdge createMarkedEdge( final String sourceType, final String edgeType,\n                                                final String targetType ) {\n-        return createEdge( createId( sourceType ), edgeType, createId( targetType ), UUIDGenerator.newTimeUUID(),\n+        return createEdge( createId( sourceType ), edgeType, createId( targetType ), System.currentTimeMillis(),\n                 true );\n     }\n \n@@ -91,41 +107,49 @@ public static MarkedEdge createMarkedEdge( final String sourceType, final String\n      * Create an edge for testing\n      */\n     public static MarkedEdge createEdge( final Id sourceId, final String edgeType, final Id targetId ) {\n-        return createEdge( sourceId, edgeType, targetId, UUIDGenerator.newTimeUUID() );\n+        return createEdge( sourceId, edgeType, targetId, System.currentTimeMillis() );\n     }\n \n \n     /**\n      * Create an edge that is marked\n      */\n     public static MarkedEdge createMarkedEdge( final Id sourceId, final String edgeType, final Id targetId ) {\n-        return createEdge( sourceId, edgeType, targetId, UUIDGenerator.newTimeUUID(), true );\n+        return createEdge( sourceId, edgeType, targetId, System.currentTimeMillis(), true );\n     }\n \n \n+    /**\n+        * Create an edge that is marked\n+        */\n+       public static MarkedEdge createMarkedEdge( final Id sourceId, final String edgeType, final Id targetId, final long timestamp) {\n+           return createEdge( sourceId, edgeType, targetId, timestamp, true );\n+       }\n+\n+\n     /**\n      * Create an edge with the specified params\n      */\n     public static MarkedEdge createEdge( final Id sourceId, final String edgeType, final Id targetId,\n-                                         final UUID version ) {\n-        return createEdge( sourceId, edgeType, targetId, version, false );\n+                                         final long timestamp ) {\n+        return createEdge( sourceId, edgeType, targetId, timestamp, false );\n     }\n \n \n     /**\n      * Create an edge with the specified params\n      */\n     public static MarkedEdge createEdge( final Id sourceId, final String edgeType, final Id targetId,\n-                                         final UUID version, final boolean deleted ) {\n-        return new SimpleMarkedEdge( sourceId, edgeType, targetId, version, deleted );\n+                                         final long timestamp, final boolean deleted ) {\n+        return new SimpleMarkedEdge( sourceId, edgeType, targetId, timestamp, deleted );\n     }\n \n \n     /**\n      * Create the id\n      */\n     public static Id createId( String type ) {\n-        return createId( UUIDGenerator.newTimeUUID(), type );\n+        return createId(UUIDGenerator.newTimeUUID(), type );\n     }\n \n \n@@ -148,7 +172,7 @@ public static Id createId( UUID id, String type ) {\n      * @param last\n      * @return\n      */\n-    public static SearchByEdgeType createSearchByEdge( final Id sourceId, final String type, final UUID maxVersion,\n+    public static SearchByEdgeType createSearchByEdge( final Id sourceId, final String type, final long maxVersion,\n                                                        final Edge last ) {\n         return new SimpleSearchByEdgeType( sourceId, type, maxVersion, last );\n     }\n@@ -163,7 +187,7 @@ public static SearchByEdgeType createSearchByEdge( final Id sourceId, final Stri\n      * @param last\n      * @return\n      */\n-    public static SearchByIdType createSearchByEdgeAndId( final Id sourceId, final String type, final UUID maxVersion,\n+    public static SearchByIdType createSearchByEdgeAndId( final Id sourceId, final String type, final long maxVersion,\n                                                           final String idType, final Edge last ) {\n         return new SimpleSearchByIdType( sourceId, type, maxVersion, idType, last );\n     }\n@@ -192,98 +216,98 @@ public static SimpleSearchIdType createSearchIdType( final Id sourceId, final St\n      * Get the edge by type\n      */\n     public static SearchByEdge createGetByEdge( final Id sourceId, final String type, final Id targetId,\n-                                                final UUID maxVersion, final Edge last ) {\n+                                                final long maxVersion, final Edge last ) {\n         return new SimpleSearchByEdge( sourceId, type, targetId, maxVersion, last );\n     }\n \n-\n-    /**\n-     * NEVER USE THIS IN A REAL ENV.  Setting timestamps in anything but the present can result in collections Copied\n-     * from fasterxml uuid utils\n-     */\n-    public static UUID setTimestamp( long timestamp ) {\n-\n-        byte[] uuidBytes = new byte[16];\n-        EthernetAddress _ethernetAddress = EthernetAddress.constructMulticastAddress();\n-        _ethernetAddress.toByteArray( uuidBytes, 10 );\n-        // and add clock sequence\n-        int clockSeq = timer.getClockSequence();\n-        uuidBytes[UUIDUtil.BYTE_OFFSET_CLOCK_SEQUENCE] = ( byte ) ( clockSeq >> 8 );\n-        uuidBytes[UUIDUtil.BYTE_OFFSET_CLOCK_SEQUENCE + 1] = ( byte ) clockSeq;\n-        long l2 = gatherLong( uuidBytes, 8 );\n-        long _uuidL2 = UUIDUtil.initUUIDSecondLong( l2 );\n-\n-\n-        final long rawTimestamp = timestamp;\n-        // Time field components are kind of shuffled, need to slice:\n-        int clockHi = ( int ) ( rawTimestamp >>> 32 );\n-        int clockLo = ( int ) rawTimestamp;\n-        // and dice\n-        int midhi = ( clockHi << 16 ) | ( clockHi >>> 16 );\n-        // need to squeeze in type (4 MSBs in byte 6, clock hi)\n-        midhi &= ~0xF000; // remove high nibble of 6th byte\n-        midhi |= 0x1000; // type 1\n-        long midhiL = ( long ) midhi;\n-        midhiL = ( ( midhiL << 32 ) >>> 32 ); // to get rid of sign extension\n-        // and reconstruct\n-        long l1 = ( ( ( long ) clockLo ) << 32 ) | midhiL;\n-        // last detail: must force 2 MSB to be '10'\n-        return new UUID( l1, _uuidL2 );\n-    }\n-\n-    /*\n-    /********************************************************************************\n-    /* Internal helper methods\n-    /********************************************************************************\n-     */\n-\n-\n-    protected final static long gatherLong( byte[] buffer, int offset ) {\n-        long hi = ( ( long ) _gatherInt( buffer, offset ) ) << 32;\n-        //long lo = ((long) _gatherInt(buffer, offset+4)) & MASK_LOW_INT;\n-        long lo = ( ( ( long ) _gatherInt( buffer, offset + 4 ) ) << 32 ) >>> 32;\n-        return hi | lo;\n-    }\n-\n-\n-    private final static int _gatherInt( byte[] buffer, int offset ) {\n-        return ( buffer[offset] << 24 ) | ( ( buffer[offset + 1] & 0xFF ) << 16 ) | ( ( buffer[offset + 2] & 0xFF )\n-                << 8 ) | ( buffer[offset + 3] & 0xFF );\n-    }\n-\n-\n-    private static final Random random = new Random();\n-    private static final UUIDTimer timer;\n-\n-\n-    /**\n-     * Lame, but required\n-     */\n-    static {\n-        try {\n-            timer = new UUIDTimer( random, new TimestampSynchronizer() {\n-                @Override\n-                protected long initialize() throws IOException {\n-                    return System.currentTimeMillis();\n-                }\n-\n-\n-                @Override\n-                protected void deactivate() throws IOException {\n-\n-                }\n-\n-\n-                @Override\n-                protected long update( final long now ) throws IOException {\n-                    return now;\n-                }\n-            } );\n-        }\n-        catch ( IOException e ) {\n-            throw new RuntimeException( \"Couldn't intialize timer\", e );\n-        }\n-    }\n+//\n+//    /**\n+//     * NEVER USE THIS IN A REAL ENV.  Setting timestamps in anything but the present can result in collections Copied\n+//     * from fasterxml uuid utils\n+//     */\n+//    public static UUID setTimestamp( long timestamp ) {\n+//\n+//        byte[] uuidBytes = new byte[16];\n+//        EthernetAddress _ethernetAddress = EthernetAddress.constructMulticastAddress();\n+//        _ethernetAddress.toByteArray( uuidBytes, 10 );\n+//        // and add clock sequence\n+//        int clockSeq = timer.getClockSequence();\n+//        uuidBytes[UUIDUtil.BYTE_OFFSET_CLOCK_SEQUENCE] = ( byte ) ( clockSeq >> 8 );\n+//        uuidBytes[UUIDUtil.BYTE_OFFSET_CLOCK_SEQUENCE + 1] = ( byte ) clockSeq;\n+//        long l2 = gatherLong( uuidBytes, 8 );\n+//        long _uuidL2 = UUIDUtil.initUUIDSecondLong( l2 );\n+//\n+//\n+//        final long rawTimestamp = timestamp;\n+//        // Time field components are kind of shuffled, need to slice:\n+//        int clockHi = ( int ) ( rawTimestamp >>> 32 );\n+//        int clockLo = ( int ) rawTimestamp;\n+//        // and dice\n+//        int midhi = ( clockHi << 16 ) | ( clockHi >>> 16 );\n+//        // need to squeeze in type (4 MSBs in byte 6, clock hi)\n+//        midhi &= ~0xF000; // remove high nibble of 6th byte\n+//        midhi |= 0x1000; // type 1\n+//        long midhiL = ( long ) midhi;\n+//        midhiL = ( ( midhiL << 32 ) >>> 32 ); // to get rid of sign extension\n+//        // and reconstruct\n+//        long l1 = ( ( ( long ) clockLo ) << 32 ) | midhiL;\n+//        // last detail: must force 2 MSB to be '10'\n+//        return new UUID( l1, _uuidL2 );\n+//    }\n+//\n+//    /*\n+//    /********************************************************************************\n+//    /* Internal helper methods\n+//    /********************************************************************************\n+//     */\n+//\n+//\n+//    protected final static long gatherLong( byte[] buffer, int offset ) {\n+//        long hi = ( ( long ) _gatherInt( buffer, offset ) ) << 32;\n+//        //long lo = ((long) _gatherInt(buffer, offset+4)) & MASK_LOW_INT;\n+//        long lo = ( ( ( long ) _gatherInt( buffer, offset + 4 ) ) << 32 ) >>> 32;\n+//        return hi | lo;\n+//    }\n+//\n+//\n+//    private final static int _gatherInt( byte[] buffer, int offset ) {\n+//        return ( buffer[offset] << 24 ) | ( ( buffer[offset + 1] & 0xFF ) << 16 ) | ( ( buffer[offset + 2] & 0xFF )\n+//                << 8 ) | ( buffer[offset + 3] & 0xFF );\n+//    }\n+//\n+//\n+//    private static final Random random = new Random();\n+//    private static final UUIDTimer timer;\n+//\n+//\n+//    /**\n+//     * Lame, but required\n+//     */\n+//    static {\n+//        try {\n+//            timer = new UUIDTimer( random, new TimestampSynchronizer() {\n+//                @Override\n+//                protected long initialize() throws IOException {\n+//                    return System.currentTimeMillis();\n+//                }\n+//\n+//\n+//                @Override\n+//                protected void deactivate() throws IOException {\n+//\n+//                }\n+//\n+//\n+//                @Override\n+//                protected long update( final long now ) throws IOException {\n+//                    return now;\n+//                }\n+//            } );\n+//        }\n+//        catch ( IOException e ) {\n+//            throw new RuntimeException( \"Couldn't intialize timer\", e );\n+//        }\n+//    }\n }\n \n ",
                "additions": 124,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/test/util/EdgeTestUtils.java",
                "status": "modified",
                "changes": 224,
                "deletions": 100,
                "sha": "dd577ab51f7793af15931e02888ea51813e51d73",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/test/util/EdgeTestUtils.java",
                "filename": "stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/test/util/EdgeTestUtils.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/graph/src/test/java/org/apache/usergrid/persistence/graph/test/util/EdgeTestUtils.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -26,7 +26,7 @@\n         <commons.collections.version>3.2.1</commons.collections.version>\n         <commons.io.version>2.4</commons.io.version>\n         <commons.lang.version>3.1</commons.lang.version>\n-        <elasticsearch.version>1.1.1</elasticsearch.version>\n+        <elasticsearch.version>1.2.0</elasticsearch.version>\n         <fasterxml-uuid.version>3.1.3</fasterxml-uuid.version>\n         <guava.version>15.0</guava.version>\n         <guice.version>3.0</guice.version>",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/pom.xml",
                "status": "modified",
                "changes": 2,
                "deletions": 1,
                "sha": "be8c445ab16d79becdd1883cf7c6dc6ecb643115",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/pom.xml",
                "filename": "stack/corepersistence/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/pom.xml?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -18,89 +18,88 @@\n  */\n package org.apache.usergrid.persistence.index.impl;\n \n-import com.google.inject.Inject;\n-import com.google.inject.Singleton;\n-import org.apache.usergrid.persistence.core.util.AvailablePortFinder;\n-import org.apache.usergrid.persistence.index.IndexFig;\n+\n import org.elasticsearch.client.Client;\n-import org.elasticsearch.client.transport.TransportClient;\n import org.elasticsearch.common.settings.ImmutableSettings;\n import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.transport.InetSocketTransportAddress;\n import org.elasticsearch.node.Node;\n import org.elasticsearch.node.NodeBuilder;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import org.apache.usergrid.persistence.core.util.AvailablePortFinder;\n+import org.apache.usergrid.persistence.index.IndexFig;\n+\n+import com.google.inject.Inject;\n+import com.google.inject.Singleton;\n+\n+\n /**\n  * Provides access to ElasticSearch client.\n  */\n @Singleton\n public class EsProvider {\n \n-    private static final Logger log = LoggerFactory.getLogger(EsProvider.class);\n+    private static final Logger log = LoggerFactory.getLogger( EsProvider.class );\n \n     private final IndexFig indexFig;\n     private static Client client;\n \n+\n     @Inject\n-    public EsProvider(IndexFig fig) {\n+    public EsProvider( IndexFig fig ) {\n         this.indexFig = fig;\n     }\n \n+\n     public synchronized Client getClient() {\n-        if (client == null) {\n-            client = getClient(indexFig);\n+        if ( client == null ) {\n+            client = getClient( indexFig );\n         }\n         return client;\n     }\n \n-    public static synchronized Client getClient(IndexFig fig) {\n \n-        if (client == null) {\n+    public static synchronized Client getClient( IndexFig fig ) {\n+\n+        if ( client == null ) {\n \n             Client newClient = null;\n \n-            if (fig.isEmbedded()) {\n+            if ( fig.isEmbedded() ) {\n \n                 int port = AvailablePortFinder.getNextAvailable( 2000 );\n \n-                Settings settings = ImmutableSettings.settingsBuilder()\n-                        .put(\"node.http.enabled\", true)\n-                        .put(\"transport.tcp.port\", port)\n-                        .put(\"path.logs\", \"target/elasticsearch/logs_\" + port)\n-                        .put(\"path.data\", \"target/elasticsearch/data_\" + port)\n-                        .put(\"gateway.type\", \"none\")\n-                        .put(\"index.store.type\", \"memory\")\n-                        .put(\"index.number_of_shards\", 1)\n-                        .put(\"index.number_of_replicas\", 1)\n-                        .build();\n+                Settings settings = ImmutableSettings.settingsBuilder().put( \"node.http.enabled\", true )\n+                                                     .put( \"transport.tcp.port\", port )\n+                                                     .put( \"path.logs\", \"target/elasticsearch/logs_\" + port )\n+                                                     .put( \"path.data\", \"target/elasticsearch/data_\" + port )\n+                                                     .put( \"gateway.type\", \"none\" ).put( \"index.store.type\", \"memory\" )\n+                                                     .put( \"index.number_of_shards\", 1 )\n+                                                     .put( \"index.number_of_replicas\", 1 ).build();\n \n-                log.info(\"Starting ElasticSearch embedded with settings: \" +  settings.getAsMap());\n+                log.info( \"Starting ElasticSearch embedded with settings: \" + settings.getAsMap() );\n \n-                Node node = NodeBuilder.nodeBuilder().local(true).settings(settings).node();\n+                Node node = NodeBuilder.nodeBuilder().local( true ).settings( settings ).node();\n                 newClient = node.client();\n+            }\n+            else { // build client that connects to all hosts\n+                final String hosts = fig.getHosts();\n \n-            } else { // build client that connects to all hosts\n+                Settings settings =\n+                        ImmutableSettings.settingsBuilder().put( \"client.transport.ping_timeout\", 2000 ) // milliseconds\n+                                .put( \"client.transport.nodes_sampler_interval\", 100 ).put( \"http.enabled\", false )\n \n-                Settings settings = ImmutableSettings.settingsBuilder()\n-                        .put(\"cluster.name\", fig.getClusterName() )\n-                        // TODO: consider making these configurable\n-                        .put(\"client.transport.ignore_cluster_name\", true )\n-                        .put(\"client.transport.ping_timeout\", 2000) // milliseconds\n-                        .put(\"client.transport.nodes_sampler_interval\", 100 )\n-                        .build();\n+                                //this assumes that we're using zen for host discovery.  Putting an explicit set of\n+                                // bootstrap hosts ensures we connect to a valid cluster.\n+                                .put( \"discovery.zen.ping.unicast.hosts\", hosts ).build();\n \n-                log.info(\"Creating ElasticSearch client with settings: \" +  settings.getAsMap());\n+                Node node = NodeBuilder.nodeBuilder().settings( settings ).clusterName( fig.getClusterName() )\n+                                       .client( true ).node();\n+\n+                newClient = node.client();\n \n-                TransportClient transportClient = new TransportClient(settings);\n \n-                for (String host : fig.getHosts().split(\",\")) {\n-                    transportClient.addTransportAddress(\n-                            new InetSocketTransportAddress(host.trim(), fig.getPort()));\n-                    log.info(\"   Added transport for ElasticSearch host {}:{}\", host.trim(), fig.getPort() ) ;\n-                }\n-                newClient = transportClient;\n             }\n             client = newClient;\n         }",
                "additions": 40,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsProvider.java",
                "status": "modified",
                "changes": 81,
                "deletions": 41,
                "sha": "b448c61150f67c8de45d761e004819a2d1f0a19a",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsProvider.java",
                "filename": "stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsProvider.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/main/java/org/apache/usergrid/persistence/index/impl/EsProvider.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -91,12 +91,12 @@ public void testSimpleCrud() {\n             getResponse.getSource().get( \"message\" ) );\n \n         // update via script\n-        client.prepareUpdate( indexName, collectionName, id)\n-            .setScript( \"ctx._source.message = \\\"coming out of a keen city in the sky\\\"\" )\n-            .execute().actionGet();\n-        getResponse = client.prepareGet( indexName, collectionName, id).get();\n-        assertEquals(\"coming out of a keen city in the sky\", \n-            getResponse.getSource().get( \"message\" ) );\n+//        client.prepareUpdate( indexName, collectionName, id)\n+//            .setScript( \"ctx._source.message = \\\"coming out of a keen city in the sky\\\"\" )\n+//            .execute().actionGet();\n+//        getResponse = client.prepareGet( indexName, collectionName, id).get();\n+//        assertEquals(\"coming out of a keen city in the sky\", \n+//            getResponse.getSource().get( \"message\" ) );\n \n         // delete\n         client.prepareDelete(indexName, collectionName, id).execute().actionGet();",
                "additions": 6,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/ElasticSearchTest.java",
                "status": "modified",
                "changes": 12,
                "deletions": 6,
                "sha": "29106a26fa168eb9d8d89a8a4bb8f60e6763acb5",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/ElasticSearchTest.java",
                "filename": "stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/ElasticSearchTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/ElasticSearchTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -30,8 +30,6 @@\n import org.slf4j.LoggerFactory;\n \n import org.apache.usergrid.persistence.collection.CollectionScope;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n import org.apache.usergrid.persistence.collection.guice.MigrationManagerRule;\n import org.apache.usergrid.persistence.collection.impl.CollectionScopeImpl;\n import org.apache.usergrid.persistence.collection.util.EntityUtils;\n@@ -42,7 +40,6 @@\n import org.apache.usergrid.persistence.index.IndexScope;\n import org.apache.usergrid.persistence.index.guice.TestIndexModule;\n import org.apache.usergrid.persistence.index.query.CandidateResults;\n-import org.apache.usergrid.persistence.index.query.EntityResults;\n import org.apache.usergrid.persistence.index.query.Query;\n import org.apache.usergrid.persistence.model.entity.Entity;\n import org.apache.usergrid.persistence.model.entity.Id;",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityConnectionIndexImplTest.java",
                "status": "modified",
                "changes": 3,
                "deletions": 3,
                "sha": "75d5e09dea62b99b3824e7e2073a1645a509e7dd",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityConnectionIndexImplTest.java",
                "filename": "stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityConnectionIndexImplTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityConnectionIndexImplTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -21,14 +21,11 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.util.HashMap;\n-import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.List;\n import java.util.Map;\n-import java.util.concurrent.TimeUnit;\n \n import org.jukito.UseModules;\n-import org.junit.Before;\n import org.junit.ClassRule;\n import org.junit.Rule;\n import org.junit.Test;\n@@ -39,23 +36,16 @@\n import org.apache.commons.lang3.time.StopWatch;\n \n import org.apache.usergrid.persistence.collection.CollectionScope;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManager;\n-import org.apache.usergrid.persistence.collection.EntityCollectionManagerFactory;\n import org.apache.usergrid.persistence.collection.guice.MigrationManagerRule;\n import org.apache.usergrid.persistence.collection.impl.CollectionScopeImpl;\n-import org.apache.usergrid.persistence.collection.mvcc.entity.impl.MvccEntityDeleteEvent;\n import org.apache.usergrid.persistence.collection.util.EntityUtils;\n import org.apache.usergrid.persistence.core.cassandra.CassandraRule;\n import org.apache.usergrid.persistence.core.cassandra.ITRunner;\n-import org.apache.usergrid.persistence.core.consistency.AsyncProcessor;\n-import org.apache.usergrid.persistence.core.consistency.AsyncProcessorFactory;\n-import org.apache.usergrid.persistence.core.consistency.QueueListenerHelper;\n import org.apache.usergrid.persistence.index.EntityIndex;\n import org.apache.usergrid.persistence.index.EntityIndexFactory;\n import org.apache.usergrid.persistence.index.IndexScope;\n import org.apache.usergrid.persistence.index.guice.TestIndexModule;\n import org.apache.usergrid.persistence.index.query.CandidateResults;\n-import org.apache.usergrid.persistence.index.query.EntityResults;\n import org.apache.usergrid.persistence.index.query.Query;\n import org.apache.usergrid.persistence.index.utils.UUIDUtils;\n import org.apache.usergrid.persistence.model.entity.Entity;\n@@ -72,7 +62,6 @@\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n-import static org.junit.Assert.assertTrue;\n \n \n @RunWith(ITRunner.class)",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityIndexTest.java",
                "status": "modified",
                "changes": 11,
                "deletions": 11,
                "sha": "4b1b8526ec52c1f57c7b8107ba5900b14e609608",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityIndexTest.java",
                "filename": "stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityIndexTest.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/corepersistence/queryindex/src/test/java/org/apache/usergrid/persistence/index/impl/EntityIndexTest.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -1837,6 +1837,7 @@\n                     <exclude>**/src/main/dist/webapps/**</exclude>\n \n                     <!-- TODO: need to add headers to many files in corepersistence -->\n+                    <exclude>**/launcher-vagrant/**</exclude>\n                     <exclude>**/corepersistence/**</exclude>\n                     <exclude>**/awscluster/**</exclude>\n ",
                "additions": 1,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/pom.xml",
                "status": "modified",
                "changes": 1,
                "deletions": 0,
                "sha": "b672e1c708c3b66df29e2b1da843eb046d9dd8ce",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/pom.xml",
                "filename": "stack/pom.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/pom.xml?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -20,10 +20,8 @@\n import javax.ws.rs.core.Response;\n import javax.ws.rs.ext.Provider;\n \n-import org.apache.usergrid.persistence.exceptions.QueryParseException;\n import org.apache.usergrid.persistence.exceptions.QueryTokenException;\n \n-import antlr.NoViableAltException;\n \n import static javax.ws.rs.core.Response.Status.BAD_REQUEST;\n ",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/QueryTokenExceptionMapper.java",
                "status": "modified",
                "changes": 2,
                "deletions": 2,
                "sha": "906811cd77518f5b7884026386d2eb1f7a6e946e",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/QueryTokenExceptionMapper.java",
                "filename": "stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/QueryTokenExceptionMapper.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/rest/src/main/java/org/apache/usergrid/rest/exceptions/QueryTokenExceptionMapper.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -32,11 +32,17 @@\n     private final String prefix;\n     private final String base64Prefix;\n     private final boolean expires;\n-    private static final Map<String, TokenCategory> prefixes = new ConcurrentHashMap<String, TokenCategory>();\n-    private static final Map<String, TokenCategory> base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+    private static Map<String, TokenCategory> prefixes;\n+    private static Map<String, TokenCategory> base64Prefixes;\n \n \n     private synchronized static void register( TokenCategory type ) {\n+        if ( prefixes == null ) {\n+            prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+        }\n+        if ( base64Prefixes == null ) {\n+            base64Prefixes = new ConcurrentHashMap<String, TokenCategory>();\n+        }\n         prefixes.put( type.getPrefix(), type );\n         base64Prefixes.put( type.getBase64Prefix(), type );\n     }",
                "additions": 8,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "status": "modified",
                "changes": 10,
                "deletions": 2,
                "sha": "121901d248b1e4d2dfe7857c7d0458b09898263c",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/TokenCategory.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -499,13 +499,7 @@ private ByteBuffer principalKey( AuthPrincipalInfo principalInfo ) {\n \n \n     private UUID getUUIDForToken( String token ) throws ExpiredTokenException, BadTokenException {\n-\n         TokenCategory tokenCategory = TokenCategory.getFromBase64String( token );\n-\n-        if( tokenCategory == null){\n-            return null;\n-        }\n-\n         byte[] bytes = decodeBase64( token.substring( TokenCategory.BASE64_PREFIX_LENGTH ) );\n         UUID uuid = uuid( bytes );\n         int i = 16;",
                "additions": 0,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "status": "modified",
                "changes": 6,
                "deletions": 6,
                "sha": "50156b5ac4b69be8fbfa1a829ca7eeaf04e668de",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "filename": "stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/main/java/org/apache/usergrid/security/tokens/cassandra/TokenServiceImpl.java?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            },
            {
                "patch": "@@ -16,32 +16,38 @@\n     limitations under the License.\r\n -->\r\n <beans xmlns=\"http://www.springframework.org/schema/beans\"\r\n-\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:util=\"http://www.springframework.org/schema/util\"\r\n-\txmlns:context=\"http://www.springframework.org/schema/context\" xmlns:p=\"http://www.springframework.org/schema/p\"\r\n-\txsi:schemaLocation=\"\r\n+       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:util=\"http://www.springframework.org/schema/util\"\r\n+       xmlns:context=\"http://www.springframework.org/schema/context\" xmlns:p=\"http://www.springframework.org/schema/p\"\r\n+       xsi:schemaLocation=\"\r\n \thttp://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd\r\n \thttp://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd\r\n \thttp://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd\">\r\n \r\n-\t<bean id=\"properties\"\r\n-\t\tclass=\"org.springframework.beans.factory.config.PropertiesFactoryBean\">\r\n-\t\t<property name=\"singleton\" value=\"true\" />\r\n-\t\t<property name=\"ignoreResourceNotFound\" value=\"true\" />\r\n-\t\t<property name=\"locations\">\r\n-\t\t\t<list>\r\n-\t\t\t\t<value>classpath:/usergrid-default.properties</value>\r\n-\t\t\t\t<value>classpath:/usergrid-test.properties</value>\r\n-\t\t\t\t<value>${usergrid-custom-spring-test-properties}</value>\r\n-\t\t\t</list>\r\n-\t\t</property>\r\n-\t</bean>\r\n-\r\n-\t<import resource=\"classpath:/usergrid-services-context.xml\" />\r\n-\r\n-    <bean id=\"setup\" class=\"org.apache.usergrid.persistence.cassandra.Setup\">\r\n+    <bean id=\"properties\"\r\n+          class=\"org.springframework.beans.factory.config.PropertiesFactoryBean\">\r\n+        <property name=\"singleton\" value=\"true\" />\r\n+        <property name=\"ignoreResourceNotFound\" value=\"true\" />\r\n+        <property name=\"locations\">\r\n+            <list>\r\n+                <value>classpath:/usergrid-default.properties</value>\r\n+                <value>classpath:/usergrid-test.properties</value>\r\n+                <value>${usergrid-custom-spring-test-properties}</value>\r\n+            </list>\r\n+        </property>\r\n+    </bean>\r\n+\r\n+    <import resource=\"classpath:/usergrid-services-context.xml\" />\r\n+\r\n+    <bean id=\"setup\" class=\"org.apache.usergrid.corepersistence.CpSetup\">\r\n         <constructor-arg ref=\"entityManagerFactory\"/>\r\n         <constructor-arg ref=\"cassandraService\"/>\r\n     </bean>\r\n+\r\n+    <!--  <bean id=\"setup\" class=\"org.apache.usergrid.persistence.cassandra.Setup\">\r\n+      <constructor-arg ref=\"entityManagerFactory\"/>\r\n+      <constructor-arg ref=\"cassandraService\"/>\r\n+    </bean>-->\r\n+\r\n     <!-- The default schema manager -->\r\n     <!-- refer to a named schemaManager from the DataControl annotation thusly -->\r\n     <bean id=\"coreManager\" class=\"org.apache.usergrid.persistence.CoreSchemaManager\">\r\n@@ -54,9 +60,9 @@\n     </bean>\r\n \r\n     <!--<bean id=\"binaryStore\" class=\"org.apache.usergrid.services.assets.data.S3BinaryStore\">-->\r\n-        <!--<constructor-arg name=\"accessId\" value=\"xx\" />-->\r\n-        <!--<constructor-arg name=\"secretKey\" value=\"xx\" />-->\r\n-        <!--<constructor-arg name=\"bucketName\" value=\"xx\" />-->\r\n+    <!--<constructor-arg name=\"accessId\" value=\"xx\" />-->\r\n+    <!--<constructor-arg name=\"secretKey\" value=\"xx\" />-->\r\n+    <!--<constructor-arg name=\"bucketName\" value=\"xx\" />-->\r\n     <!--</bean>-->\r\n \r\n </beans>\r",
                "additions": 28,
                "raw_url": "https://github.com/apache/usergrid/raw/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/services/src/test/resources/usergrid-test-context.xml",
                "status": "modified",
                "changes": 50,
                "deletions": 22,
                "sha": "af11880886ebbb171526270f43db3186d142783f",
                "blob_url": "https://github.com/apache/usergrid/blob/183e0eaaae2af9e3d83a5920fd012d7e8d12e06f/stack/services/src/test/resources/usergrid-test-context.xml",
                "filename": "stack/services/src/test/resources/usergrid-test-context.xml",
                "contents_url": "https://api.github.com/repos/apache/usergrid/contents/stack/services/src/test/resources/usergrid-test-context.xml?ref=183e0eaaae2af9e3d83a5920fd012d7e8d12e06f"
            }
        ],
        "bug_id": "usergrid_53",
        "parent": "https://github.com/apache/usergrid/commit/6664dc28ffce57a43e10a228a5a7776389e5706a",
        "message": "Merge branch 'two-dot-o' of https://github.com/usergrid/usergrid into DPS-1042_import-counters\n\n# By Shawn Feldman (6) and others\n# Via Dave Johnson (6) and others\n* 'two-dot-o' of https://github.com/usergrid/usergrid:\n  All EntityConnectionsIT tests now passing.\n  RAT ignore for Vagrant temp files\n  remove logging, refresh index\n  remove comment\n  adding rest of groups and roles f(x)\n  adding majority of methods back to cpentitymanager\n  Changed error to warning\n  Fix test failures, clean up imports.\n  Merged remote fixes\n  Upgraded to ES 1.2.0.\n  Longs for versions instead of time UUIDs.\n  Work to get services module tests working.\n  All tests pass with new long timestamp\n  removing simpleroleref\n  Revert \"Missed null check may cause NPE\"\n  check for nulls\n  Changed edge interface to have timestamps on the edge.\n  Changed edge interface to have timestamps on the edge.\n\nConflicts:\n\tstack/core/src/main/java/org/apache/usergrid/corepersistence/CpEntityManager.java",
        "repo": "usergrid"
    }
]