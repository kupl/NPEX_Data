{
    "jackrabbit_0e650aa": {
        "bug_id": "jackrabbit_0e650aa",
        "commit": "https://github.com/apache/jackrabbit/commit/0e650aa902229e39b003c722f5674d4c6a89d8d0",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java",
                "changes": 282,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java?ref=44a1d182d1be2dbdd1f6920ed1676dba0327a71c",
                "deletions": 282,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java",
                "patch": "@@ -1,282 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.core.cache;\n-\n-import java.util.concurrent.ConcurrentHashMap;\n-\n-import org.apache.commons.collections.map.LinkedMap;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-/**\n- * An <code>ItemStateCache</code> implementation that internally uses a\n- * {@link LinkedMap} to maintain a cache of <code>ItemState</code> objects. The\n- * cache uses a rough estimate of the memory consumption of the cached item\n- * states for calculating the maximum number of entries. The oldest entries\n- * are flushed once the cache size has exceeded a certain limit.\n- * <p/>\n- * TODO rename class to something more appropriate, e.g. FIFOItemSateCache since\n- * it doesn't use a LRU eviction policy anymore.\n- */\n-public class LRUCache<Key, Value> implements Cache {\n-\n-    /** Logger instance */\n-    private static Logger log = LoggerFactory.getLogger(LRUCache.class);\n-\n-    /**\n-     * Map of cache entries.\n-     */\n-    private final ConcurrentHashMap<Key, Entry<Key, Value>> entries =\n-        new ConcurrentHashMap<Key, Entry<Key, Value>>();\n-\n-    /**\n-     * Most recently used entry, or <code>null</code> if the cache is empty.\n-     */\n-    private Entry<Key, Value> first = null;\n-\n-    /**\n-     * Least recently used entry, or <code>null</code> if the cache is empty.\n-     */\n-    private Entry<Key, Value> last = null;\n-\n-    /**\n-     * Current size of the cache; sum of the sizes of all the cached entries.\n-     */\n-    private long currentSize = 0;\n-\n-    /**\n-     * Maximum size of the cache\n-     */\n-    private long maximumSize;\n-\n-    /**\n-     * Cache access listener\n-     */\n-    private CacheAccessListener listener = null;\n-\n-    /**\n-     * Access count used to fire {@link CacheAccessListener#cacheAccessed()}\n-     * calls once every {@link CacheAccessListener#ACCESS_INTERVAL} hits.\n-     */\n-    private int accessCount;\n-\n-    /**\n-     * Constructs a new, empty <code>ItemStateCache</code> with the specified\n-     * maximum memory.\n-     *\n-     * @param maximumSize maximum size of the cache\n-     */\n-    public LRUCache(long maximumSize) {\n-        this.maximumSize = maximumSize;\n-    }\n-\n-    public boolean containsKey(Key key) {\n-        return entries.containsKey(key);\n-    }\n-\n-    public Value get(Key key) {\n-        Entry<Key, Value> entry = entries.get(key);\n-        if (entry != null) {\n-            boolean notifyAccessListener;\n-            synchronized (this) {\n-                // Check if we should notify the access listener\n-                notifyAccessListener =\n-                    (++accessCount % CacheAccessListener.ACCESS_INTERVAL) == 0;\n-\n-                // Move this entry to the beginning of the LRU linked list\n-                if (entry.prev != null) {\n-                    entry.prev.next = entry.next;\n-                    if (entry.next != null) {\n-                        entry.next.prev = entry.prev;\n-                    } else if (entry.prev != null) {\n-                        last = entry.prev;\n-                        entry.prev = null;\n-                    }\n-                    first.prev = entry;\n-                    entry.next = first;\n-                    first = entry;\n-                }\n-            }\n-\n-            // Notify the access listener outside the synchronized block\n-            if (notifyAccessListener && listener != null) {\n-                listener.cacheAccessed();\n-            }\n-\n-            return entry.value;\n-        } else {\n-            return null;\n-        }\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    public synchronized Value[] values() {\n-        Object[] values = new Object[entries.size()];\n-        Entry<Key, Value> entry = first;\n-        for (int i = 0; i < values.length && entry != null; i++) {\n-            values[i] = entry.value;\n-            entry = entry.next;\n-        }\n-        return (Value[]) values;\n-    }\n-\n-    public synchronized void put(Key key, Value value, long size) {\n-        Entry<Key, Value> entry = new Entry<Key, Value>(key, value, size);\n-        if (first != null) {\n-            first.prev = entry;\n-        }\n-        entry.next = first;\n-        first = entry;\n-        if (last == null) {\n-            last = entry;\n-        }\n-\n-        currentSize += size;\n-\n-        Entry<Key, Value> previous = entries.put(key, entry);\n-        if (previous != null) {\n-            log.warn(\"Overwriting cached entry {}\", key);\n-            currentSize -= previous.size;\n-        }\n-\n-        shrinkIfNeeded();\n-    }\n-\n-    public synchronized Value remove(Key key) {\n-        Entry<Key, Value> entry = entries.remove(key);\n-        if (entry != null) {\n-            if (entry.prev != null) {\n-                entry.prev.next = entry.next;\n-            } else {\n-                first = entry.next;\n-            }\n-            if (entry.next != null) {\n-                entry.next.prev = entry.prev;\n-            } else {\n-                last = entry.prev;\n-            }\n-\n-            currentSize -= entry.size;\n-\n-            return entry.value;\n-        } else {\n-            return null;\n-        }\n-    }\n-\n-    public synchronized void clear() {\n-        entries.clear();\n-        first = null;\n-        last = null;\n-        currentSize = 0;\n-    }\n-\n-    public boolean isEmpty() {\n-        return entries.isEmpty();\n-    }\n-\n-    public synchronized long getAccessCount() {\n-        return accessCount;\n-    }\n-\n-    public synchronized void resetAccessCount() {\n-        accessCount = 0;\n-    }\n-\n-    public synchronized long getMemoryUsed() {\n-        return currentSize;\n-    }\n-\n-    public synchronized long getMaxMemorySize() {\n-        return maximumSize;\n-    }\n-\n-    public synchronized void setMaxMemorySize(long size) {\n-        this.maximumSize = size;\n-        shrinkIfNeeded();\n-    }\n-\n-    private void shrinkIfNeeded() {\n-        while (currentSize > maximumSize && last != null) {\n-            entries.remove(last.key);\n-            currentSize -= last.size;\n-            if (last.prev != null) {\n-                last.prev.next = null;\n-                last = last.prev;\n-            } else {\n-                first = null;\n-                last = null;\n-            }\n-        }\n-    }\n-\n-    /**\n-     * Set the cache access listener. Only one listener per cache is supported.\n-     *\n-     * @param listener the new listener\n-     */\n-    public synchronized void setAccessListener(CacheAccessListener listener) {\n-        this.listener = listener;\n-    }\n-\n-    /**\n-     * {@inheritDoc}\n-     */\n-    public synchronized void dispose() {\n-        if (listener != null) {\n-            listener.disposeCache(this);\n-        }\n-    }\n-\n-    public String toString() {\n-        StringBuilder builder = new StringBuilder();\n-        builder.append(\"{ \");\n-        Entry<Key, Value> entry = first;\n-        while (entry != null) {\n-            builder.append(entry.key);\n-            builder.append(\" => \");\n-            builder.append(entry.value);\n-            builder.append(\" \");\n-        }\n-        builder.append(\"}\");\n-        return builder.toString();\n-    }\n-\n-    /**\n-     * Internal cache entry.\n-     */\n-    private static class Entry<Key, Value> {\n-\n-        final Key key;\n-\n-        final Value value;\n-\n-        final long size;\n-\n-        Entry<Key, Value> prev = null;\n-\n-        Entry<Key, Value> next = null;\n-\n-        public Entry(Key key, Value value, long size) {\n-            this.key = key;\n-            this.value = value;\n-            this.size = size;\n-        }\n-\n-    }\n-\n-}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cache/LRUCache.java",
                "sha": "a02fe447f705cecbb7ecbb6e382df0a433894a46",
                "status": "removed"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 8,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java",
                "patch": "@@ -18,7 +18,6 @@\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.apache.jackrabbit.core.cache.LRUCache;\n import org.apache.jackrabbit.core.fs.FileSystemResource;\n import org.apache.jackrabbit.core.fs.FileSystem;\n import org.apache.jackrabbit.core.state.ItemState;\n@@ -38,6 +37,7 @@\n import org.apache.jackrabbit.core.persistence.PersistenceManager;\n import org.apache.jackrabbit.core.util.StringIndex;\n import org.apache.jackrabbit.core.persistence.util.BLOBStore;\n+import org.apache.jackrabbit.core.persistence.util.BundleCache;\n import org.apache.jackrabbit.core.persistence.util.FileBasedIndex;\n import org.apache.jackrabbit.core.persistence.util.LRUNodeIdCache;\n import org.apache.jackrabbit.core.persistence.util.NodePropBundle;\n@@ -68,7 +68,7 @@\n  * included in the bundle but generated when required.\n  * <p/>\n  * In order to increase performance, there are 2 caches maintained. One is the\n- * bundle cache that caches already loaded bundles. The other is the\n+ * {@link BundleCache} that caches already loaded bundles. The other is the\n  * {@link LRUNodeIdCache} that caches non-existent bundles. This is useful\n  * because a lot of {@link #exists(NodeId)} calls are issued that would result\n  * in a useless SQL execution if the desired bundle does not exist.\n@@ -103,7 +103,7 @@\n     private StringIndex nameIndex;\n \n     /** the cache of loaded bundles */\n-    private LRUCache<NodeId, NodePropBundle> bundles;\n+    private BundleCache bundles;\n \n     /** the cache of non-existent bundles */\n     private LRUNodeIdCache missing;\n@@ -387,7 +387,7 @@ protected abstract void store(NodeReferences refs)\n     public void init(PMContext context) throws Exception {\n         this.context = context;\n         // init bundle cache\n-        bundles = new LRUCache<NodeId, NodePropBundle>(bundleCacheSize);\n+        bundles = new BundleCache(bundleCacheSize);\n         missing = new LRUNodeIdCache();\n     }\n     \n@@ -656,7 +656,7 @@ private NodePropBundle getBundle(NodeId id) throws ItemStateException {\n                 bundle = loadBundle(id);\n                 if (bundle != null) {\n                     bundle.markOld();\n-                    bundles.put(id, bundle, bundle.getSize());\n+                    bundles.put(bundle);\n                 } else {\n                     missing.put(id);\n                 }\n@@ -692,9 +692,8 @@ private void putBundle(NodePropBundle bundle) throws ItemStateException {\n         missing.remove(bundle.getId());\n         // only put to cache if already exists. this is to ensure proper overwrite\n         // and not creating big contention during bulk loads\n-        if (bundles.containsKey(bundle.getId())) {\n-            bundles.remove(bundle.getId());\n-            bundles.put(bundle.getId(), bundle, bundle.getSize());\n+        if (bundles.contains(bundle.getId())) {\n+            bundles.put(bundle);\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/AbstractBundlePersistenceManager.java",
                "sha": "48ca35c3c84107e95dd25b1da8b552a3560b1d33",
                "status": "modified"
            },
            {
                "additions": 7,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 8,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java",
                "patch": "@@ -24,7 +24,6 @@\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.apache.jackrabbit.core.cache.LRUCache;\n import org.apache.jackrabbit.core.fs.FileSystemResource;\n import org.apache.jackrabbit.core.fs.FileSystem;\n import org.apache.jackrabbit.core.id.ItemId;\n@@ -35,6 +34,7 @@\n import org.apache.jackrabbit.core.persistence.PMContext;\n import org.apache.jackrabbit.core.persistence.PersistenceManager;\n import org.apache.jackrabbit.core.persistence.util.BLOBStore;\n+import org.apache.jackrabbit.core.persistence.util.BundleCache;\n import org.apache.jackrabbit.core.persistence.util.FileBasedIndex;\n import org.apache.jackrabbit.core.persistence.util.LRUNodeIdCache;\n import org.apache.jackrabbit.core.persistence.util.NodePropBundle;\n@@ -68,7 +68,7 @@\n  * included in the bundle but generated when required.\n  * <p/>\n  * In order to increase performance, there are 2 caches maintained. One is the\n- * bundle cache that caches already loaded bundles. The other is the\n+ * {@link BundleCache} that caches already loaded bundles. The other is the\n  * {@link LRUNodeIdCache} that caches non-existent bundles. This is useful\n  * because a lot of {@link #exists(NodeId)} calls are issued that would result\n  * in a useless SQL execution if the desired bundle does not exist.\n@@ -103,7 +103,7 @@\n     private StringIndex nameIndex;\n \n     /** the cache of loaded bundles */\n-    private LRUCache<NodeId, NodePropBundle> bundles;\n+    private BundleCache bundles;\n \n     /** the cache of non-existent bundles */\n     private LRUNodeIdCache missing;\n@@ -387,7 +387,7 @@ protected abstract void store(NodeReferences refs)\n     public void init(PMContext context) throws Exception {\n         this.context = context;\n         // init bundle cache\n-        bundles = new LRUCache<NodeId, NodePropBundle>(bundleCacheSize);\n+        bundles = new BundleCache(bundleCacheSize);\n         missing = new LRUNodeIdCache();\n     }\n \n@@ -654,7 +654,7 @@ private NodePropBundle getBundle(NodeId id) throws ItemStateException {\n                 bundle = loadBundle(id);\n                 if (bundle != null) {\n                     bundle.markOld();\n-                    bundles.put(id, bundle, bundle.getSize());\n+                    bundles.put(bundle);\n                 } else {\n                     missing.put(id);\n                 }\n@@ -690,9 +690,8 @@ private void putBundle(NodePropBundle bundle) throws ItemStateException {\n         missing.remove(bundle.getId());\n         // only put to cache if already exists. this is to ensure proper overwrite\n         // and not creating big contention during bulk loads\n-        if (bundles.containsKey(bundle.getId())) {\n-            bundles.remove(bundle.getId());\n-            bundles.put(bundle.getId(), bundle, bundle.getSize());\n+        if (bundles.contains(bundle.getId())) {\n+            bundles.put(bundle);\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/pool/AbstractBundlePersistenceManager.java",
                "sha": "8c224f4ff47cb4bad10797ee08da42956c75b273",
                "status": "modified"
            },
            {
                "additions": 196,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java",
                "changes": 196,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java",
                "patch": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.persistence.util;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.jackrabbit.core.id.NodeId;\n+import org.slf4j.LoggerFactory;\n+import org.slf4j.Logger;\n+\n+/**\n+ * This Class implements a simple cache for nodeprop bundles\n+ */\n+public class BundleCache {\n+\n+    /**\n+     * the default logger\n+     */\n+    private static Logger log = LoggerFactory.getLogger(BundleCache.class);\n+\n+    /**\n+     * the current memory usage of this cache\n+     */\n+    private long curSize;\n+\n+    /**\n+     * the maximum chache size\n+     */\n+    private long maxSize;\n+\n+    /**\n+     * the number of cache hits\n+     */\n+    private long hits;\n+\n+    /**\n+     * the number of cache misses\n+     */\n+    private long misses;\n+\n+    /**\n+     * a map of the cache entries\n+     */\n+    private final LinkedHashMap<NodeId, NodePropBundle> bundles;\n+\n+    /**\n+     * Creates a new BundleCache\n+     *\n+     * @param maxSize the maximum size of this cache in bytes.\n+     */\n+    @SuppressWarnings(\"serial\")\n+    public BundleCache(long maxSize) {\n+        this.maxSize = maxSize;\n+        this.bundles = new LinkedHashMap<NodeId, NodePropBundle>(\n+                (int) maxSize / 1024, 0.75f, true /* access-ordered */) {\n+            @Override\n+            protected boolean removeEldestEntry(\n+                    Map.Entry<NodeId, NodePropBundle> e) {\n+                long maxSize = BundleCache.this.maxSize;\n+                if (curSize <= maxSize) {\n+                    return false;\n+                } else if (curSize - e.getValue().getSize() <= maxSize) {\n+                    curSize -= e.getValue().getSize();\n+                    return true;\n+                } else {\n+                    shrink();\n+                    return false;\n+                }\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Returns the maximum cache size in bytes.\n+     *\n+     * @return the maximum cache size in bytes.\n+     */\n+    public long getMaxSize() {\n+        return maxSize;\n+    }\n+\n+    /**\n+     * Sets the maximum cache size in bytes.\n+     *\n+     * @param maxSize the maximum cache size in bytes.\n+     */\n+    public void setMaxSize(long maxSize) {\n+        this.maxSize = maxSize;\n+\n+        if (curSize > maxSize) {\n+            shrink();\n+        }\n+    }\n+\n+    private void shrink() {\n+        List<NodePropBundle> list =\n+            new ArrayList<NodePropBundle>(bundles.values());\n+        for (int i = list.size() - 1; curSize > maxSize && i >= 0; i--) {\n+            NodePropBundle bundle = list.get(i);\n+            curSize -= bundle.getSize();\n+            bundles.remove(bundle.getId());\n+        }\n+    }\n+\n+    /**\n+     * Returns the bundle with the given <code>id</code> or <code>null</code>\n+     * if the bundle is not cached.\n+     *\n+     * @param id the id of the bundle\n+     * @return the cached bundle or <code>null</code>\n+     */\n+    public synchronized NodePropBundle get(NodeId id) {\n+        NodePropBundle bundle = bundles.get(id);\n+        if (bundle != null) {\n+            hits++;\n+        } else {\n+            misses++;\n+        }\n+        if (log.isInfoEnabled() && (hits + misses) % 10000 == 0) {\n+            long c = curSize / 1024;\n+            long m = maxSize / 1024;\n+            long a = bundles.size() > 0 ? curSize / bundles.size() : 0;\n+            log.info(\"num=\" + bundles.size() + \" mem=\" + c + \"k max=\" + m + \"k avg=\" + a\n+                    + \" hits=\" + hits + \" miss=\" + misses);\n+        }\n+        return bundle;\n+    }\n+\n+    /**\n+     * Puts a bundle to the cache.\n+     *\n+     * @param bundle the bunlde to put to the cache\n+     */\n+    public synchronized void put(NodePropBundle bundle) {\n+        NodePropBundle previous = bundles.get(bundle.getId());\n+        if (previous != null) {\n+            curSize -= previous.getSize();\n+        }\n+        bundles.put(bundle.getId(), bundle);\n+        curSize += bundle.getSize();\n+    }\n+\n+    /**\n+     * Checks if the bundle with the given id is cached.\n+     *\n+     * @param id the id of the bundle\n+     * @return <code>true</code> if the bundle is cached;\n+     *         <code>false</code> otherwise.\n+     */\n+    public synchronized boolean contains(NodeId id) {\n+        return bundles.containsKey(id);\n+    }\n+\n+    /**\n+     * Removes a bundle from this cache.\n+     *\n+     * @param id the id of the bunlde to remove.\n+     * @return the previously cached bunlde or <code>null</code> of the bundle\n+     *         was not cached.\n+     */\n+    public synchronized NodePropBundle remove(NodeId id) {\n+        NodePropBundle bundle = bundles.remove(id);\n+        if (bundle != null) {\n+            curSize -= bundle.getSize();\n+        }\n+        return bundle;\n+    }\n+\n+    /**\n+     * Clears this cache and removes all bundles.\n+     */\n+    public synchronized void clear() {\n+        bundles.clear();\n+        curSize = 0;\n+        hits = 0;\n+        misses = 0;\n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/util/BundleCache.java",
                "sha": "eef26ab885356573c608013cd928954773738f24",
                "status": "added"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java",
                "patch": "@@ -82,6 +82,14 @@\n      */\n     boolean isEmpty();\n \n+    /**\n+     * Informs the cache that the item was modified and the cache might need to\n+     * recalculate the items caching weight.\n+     *\n+     * @param id the id of the item that was modified.\n+     */\n+    void update(ItemId id);\n+\n     /**\n      * Informs the cache that it is no longer in use.\n      */",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateCache.java",
                "sha": "6e2ad3f993d6131b4ad55931f638272071661e1c",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java",
                "patch": "@@ -159,6 +159,14 @@ public synchronized void evictAll() {\n         refs.clear();\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    public synchronized void update(ItemId id) {\n+        // delegate\n+        cache.update(id);\n+    }\n+\n     /**\n      * {@inheritDoc}\n      */",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ItemStateReferenceCache.java",
                "sha": "f7e23f70701618e016af839d928f0f60ba88187e",
                "status": "modified"
            },
            {
                "additions": 217,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java",
                "changes": 241,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 24,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java",
                "patch": "@@ -16,9 +16,14 @@\n  */\n package org.apache.jackrabbit.core.state;\n \n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n import org.apache.commons.collections.map.LinkedMap;\n-import org.apache.jackrabbit.core.cache.CacheManager;\n-import org.apache.jackrabbit.core.cache.LRUCache;\n+import org.apache.jackrabbit.core.cache.Cache;\n+import org.apache.jackrabbit.core.cache.CacheAccessListener;\n import org.apache.jackrabbit.core.id.ItemId;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -33,87 +38,275 @@\n  * TODO rename class to something more appropriate, e.g. FIFOItemSateCache since\n  * it doesn't use a LRU eviction policy anymore.\n  */\n-public class MLRUItemStateCache implements ItemStateCache {\n-\n+public class MLRUItemStateCache implements ItemStateCache, Cache {\n     /** Logger instance */\n     private static Logger log = LoggerFactory.getLogger(MLRUItemStateCache.class);\n \n     /** default maximum memory to use */\n     public static final int DEFAULT_MAX_MEM = 4 * 1024 * 1024;\n \n+    /** the amount of memory the entries use */\n+    private volatile long totalMem;\n+\n+    /** the maximum of memory the cache may use */\n+    private volatile long maxMem;\n+\n     /** the number of writes */\n-    private volatile long numWrites = 0;\n+    private volatile long numWrites;\n+\n+    /** the access count */\n+    private volatile long accessCount;\n \n-    private final LRUCache<ItemId, ItemState> cache =\n-        new LRUCache<ItemId, ItemState>(DEFAULT_MAX_MEM);\n+    /** the cache access listeners */\n+    private CacheAccessListener accessListener;\n \n-    public MLRUItemStateCache(CacheManager cacheMgr) {\n-        cacheMgr.add(cache);\n-        cache.setAccessListener(cacheMgr);\n+    /**\n+     * A cache for <code>ItemState</code> instances\n+     */\n+    private final Map<ItemId, Entry> cache;\n+\n+    /**\n+     * Constructs a new, empty <code>ItemStateCache</code> with a maximum amount\n+     * of memory of {@link #DEFAULT_MAX_MEM}.\n+     */\n+    public MLRUItemStateCache() {\n+        this(DEFAULT_MAX_MEM);\n     }\n \n-    //-------------------------------------------------------< ItemStateCache >\n+    /**\n+     * Constructs a new, empty <code>ItemStateCache</code> with the specified\n+     * maximum memory.\n+     *\n+     * @param maxMem the maximum amount of memory this cache may use.\n+     */\n+    @SuppressWarnings(\"serial\")\n+    private MLRUItemStateCache(int maxMem) {\n+        this.maxMem = maxMem;\n+        this.cache = new LinkedHashMap<ItemId, MLRUItemStateCache.Entry>(\n+                maxMem / 1024, 0.75f, true /* access-ordered */) {\n+            @Override\n+            protected boolean removeEldestEntry(Map.Entry<ItemId, Entry> e) {\n+                long maxMem = MLRUItemStateCache.this.maxMem;\n+                if (totalMem <= maxMem) {\n+                    return false;\n+                } else if (totalMem - e.getValue().size <= maxMem) {\n+                    totalMem -= e.getValue().size;\n+                    return true;\n+                } else {\n+                    shrink();\n+                    return false;\n+                }\n+            }\n+        };\n+    }\n \n+    //-------------------------------------------------------< ItemStateCache >\n     /**\n      * {@inheritDoc}\n      */\n     public boolean isCached(ItemId id) {\n-        return cache.containsKey(id);\n+        synchronized (cache) {\n+            return cache.containsKey(id);\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public ItemState retrieve(ItemId id) {\n-        return cache.get(id);\n+        touch();\n+        synchronized (cache) {\n+            Entry entry = cache.get(id);\n+            if (entry != null) {\n+                return entry.state;\n+            } else {\n+                return null;\n+            }\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public ItemState[] retrieveAll() {\n-        return cache.values();\n+        synchronized (cache) {\n+            ItemState[] states = new ItemState[cache.size()];\n+            int i = 0;\n+            for (Entry entry : cache.values()) {\n+                states[i++] = entry.state;\n+            }\n+            return states;\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n-    public synchronized void cache(ItemState state) {\n-        cache.put(state.getId(), state, state.calculateMemoryFootprint());\n+    public void update(ItemId id) {\n+        touch();\n+        synchronized (cache) {\n+            Entry entry = cache.get(id);\n+            if (entry != null) {\n+                totalMem -= entry.size;\n+                entry.recalc();\n+                totalMem += entry.size;\n+            }\n+        }\n+    }\n \n-        if (numWrites++ % 10000 == 0 && log.isDebugEnabled()) {\n-            log.debug(\"Item state cache size: {}% of {} bytes\",\n-                    cache.getMemoryUsed() * 100 / cache.getMaxMemorySize(),\n-                    cache.getMaxMemorySize());\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void cache(ItemState state) {\n+        touch();\n+        synchronized (cache) {\n+            ItemId id = state.getId();\n+            if (cache.containsKey(id)) {\n+                log.warn(\"overwriting cached entry \" + id);\n+                evict(id);\n+            }\n+            Entry entry = new Entry(state);\n+            totalMem += entry.size;\n+            cache.put(id, entry);\n+            if (numWrites++ % 10000 == 0 && log.isDebugEnabled()) {\n+                log.debug(this + \" size=\" + cache.size() + \", \" + totalMem + \"/\" + maxMem);\n+            }\n         }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public void evict(ItemId id) {\n-        cache.remove(id);\n+        touch();\n+        synchronized (cache) {\n+            Entry entry = cache.remove(id);\n+            if (entry != null) {\n+                totalMem -= entry.size;\n+            }\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public void evictAll() {\n-        cache.clear();\n+        synchronized (cache) {\n+            cache.clear();\n+            totalMem = 0;\n+        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public boolean isEmpty() {\n-        return cache.isEmpty();\n+        synchronized (cache) {\n+            return cache.isEmpty();\n+        }\n+    }\n+\n+    private void touch() {\n+        accessCount++;\n+        if ((accessCount % CacheAccessListener.ACCESS_INTERVAL) == 0) {\n+            if (accessListener != null) {\n+                accessListener.cacheAccessed();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public long getAccessCount() {\n+        return accessCount;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public long getMaxMemorySize() {\n+        return maxMem;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public long getMemoryUsed() {\n+        return totalMem;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void resetAccessCount() {\n+        synchronized (cache) {\n+            accessCount = 0;\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    public void setMaxMemorySize(long size) {\n+        synchronized (cache) {\n+            this.maxMem = size;\n+\n+            // remove items, if too many\n+            if (totalMem > maxMem) {\n+                shrink();\n+            }\n+        }\n+    }\n+\n+    private void shrink() {\n+        List<Map.Entry<ItemId, Entry>> list =\n+            new ArrayList<Map.Entry<ItemId, Entry>>(cache.entrySet());\n+        for (int i = list.size() - 1; totalMem > maxMem && i >= 0; i--) {\n+            Map.Entry<ItemId, Entry> last = list.get(i);\n+            totalMem -= last.getValue().size;\n+            cache.remove(last.getKey());\n+        }\n+    }\n+\n+    /**\n+     * Set the cache access listener. Only one listener per cache is supported.\n+     *\n+     * @param listener the new listener\n+     */\n+    public void setAccessListener(CacheAccessListener listener) {\n+        this.accessListener = listener;\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     public void dispose() {\n-        cache.dispose();\n+        synchronized (cache) {\n+            if (accessListener != null) {\n+                accessListener.disposeCache(this);\n+            }\n+        }\n+    }\n+\n+\n+    /**\n+     * Internal cache entry.\n+     */\n+    private static class Entry {\n+\n+        private final ItemState state;\n+\n+        private long size;\n+\n+        public Entry(ItemState state) {\n+            this.state = state;\n+            this.size = 64 + state.calculateMemoryFootprint();\n+        }\n+\n+        public void recalc() {\n+            size = 64 + state.calculateMemoryFootprint();\n+        }\n     }\n \n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/MLRUItemStateCache.java",
                "sha": "5fdccd585b0a8bae95dc29782678b7ca5acb576c",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java?ref=0e650aa902229e39b003c722f5674d4c6a89d8d0",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java",
                "patch": "@@ -41,7 +41,10 @@ public ManagedMLRUItemStateCacheFactory(CacheManager cacheMgr) {\n      * Create a new cache instance and link it to the cache manager.\n      */\n     public ItemStateCache newItemStateCache() {\n-        return new MLRUItemStateCache(cacheMgr);\n+        MLRUItemStateCache cache = new MLRUItemStateCache();\n+        cacheMgr.add(cache);\n+        cache.setAccessListener(cacheMgr);\n+        return cache;\n     }\n \n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/0e650aa902229e39b003c722f5674d4c6a89d8d0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/ManagedMLRUItemStateCacheFactory.java",
                "sha": "c9a843c4ecdc6b02ecf7e1d64cc114109233598f",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java",
                "changes": 76,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java?ref=44a1d182d1be2dbdd1f6920ed1676dba0327a71c",
                "deletions": 76,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java",
                "patch": "@@ -1,76 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.core.cache;\n-\n-import junit.framework.TestCase;\n-\n-/**\n- * Test cases for the {@link LRUCache} class.\n- */\n-public class LRUCacheTest extends TestCase {\n-\n-    public void testLRUCache() {\n-        LRUCache<String, String> cache = new LRUCache<String, String>(3);\n-\n-        cache.put(\"foo\", \"1\", 1);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertEquals(1, cache.getMemoryUsed());\n-\n-        cache.put(\"bar\", \"12\", 2);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-\n-        cache.put(\"baz\", \"123\", 3);\n-        assertFalse(cache.containsKey(\"foo\"));\n-        assertFalse(cache.containsKey(\"bar\"));\n-        assertTrue(cache.containsKey(\"baz\"));\n-        assertEquals(\"123\", cache.get(\"baz\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-\n-        cache.put(\"foo\", \"1\", 1);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertFalse(cache.containsKey(\"bar\"));\n-        assertFalse(cache.containsKey(\"baz\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertEquals(1, cache.getMemoryUsed());\n-\n-        cache.put(\"bar\", \"12\", 2);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-\n-        cache.remove(\"foo\");\n-        assertFalse(cache.containsKey(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(2, cache.getMemoryUsed());\n-\n-        cache.put(\"foo\", \"1\", 1);\n-        assertTrue(cache.containsKey(\"foo\"));\n-        assertEquals(\"1\", cache.get(\"foo\"));\n-        assertTrue(cache.containsKey(\"bar\"));\n-        assertEquals(\"12\", cache.get(\"bar\"));\n-        assertEquals(3, cache.getMemoryUsed());\n-    }\n-\n-}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/LRUCacheTest.java",
                "sha": "180cb9fdd5b22d100390b666e9b77b86f54fa89d",
                "status": "removed"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java?ref=44a1d182d1be2dbdd1f6920ed1676dba0327a71c",
                "deletions": 33,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java",
                "patch": "@@ -1,33 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.jackrabbit.core.cache;\n-\n-import junit.framework.TestCase;\n-import junit.framework.Test;\n-import junit.framework.TestSuite;\n-\n-public class TestAll extends TestCase {\n-\n-    public static Test suite() {\n-        TestSuite suite = new TestSuite();\n-\n-        suite.addTestSuite(LRUCacheTest.class);\n-\n-        return suite;\n-    }\n-\n-}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/44a1d182d1be2dbdd1f6920ed1676dba0327a71c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cache/TestAll.java",
                "sha": "f4126ea88b635834181498950d1ad297890534c2",
                "status": "removed"
            }
        ],
        "message": "JCR-2699: Improve read/write concurrency\n\nRevert revision 1003542 until I have time to solve the NPE issue.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1003773 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/44a1d182d1be2dbdd1f6920ed1676dba0327a71c",
        "patched_files": [
            "LRUCache.java",
            "ItemStateReferenceCache.java",
            "ManagedMLRUItemStateCacheFactory.java",
            "AbstractBundlePersistenceManager.java",
            "BundleCache.java",
            "ItemStateCache.java",
            "MLRUItemStateCache.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TestAll.java",
            "LRUCacheTest.java"
        ]
    },
    "jackrabbit_1d2a0a6": {
        "bug_id": "jackrabbit_1d2a0a6",
        "commit": "https://github.com/apache/jackrabbit/commit/1d2a0a63f781368aefdc003197d95f4bebf8f353",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d2a0a63f781368aefdc003197d95f4bebf8f353/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/ConcurrentVersioningWithTransactionsTest.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/ConcurrentVersioningWithTransactionsTest.java?ref=1d2a0a63f781368aefdc003197d95f4bebf8f353",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/ConcurrentVersioningWithTransactionsTest.java",
                "patch": "@@ -23,6 +23,7 @@\n import javax.jcr.Node;\n import javax.jcr.RepositoryException;\n import javax.jcr.Session;\n+import javax.jcr.InvalidItemStateException;\n import javax.jcr.version.Version;\n import javax.transaction.UserTransaction;\n \n@@ -66,6 +67,8 @@ public void execute(Session session, Node test)\n                         n.addMixin(mixVersionable);\n                         session.save();\n                         utx.commit();\n+                    } catch (InvalidItemStateException e) {\n+                        // ignore\n                     } catch (Exception e) {\n                         final Throwable deepCause = getLevel2Cause(e);\n                         if (deepCause != null && deepCause instanceof StaleItemStateException) {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d2a0a63f781368aefdc003197d95f4bebf8f353/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/ConcurrentVersioningWithTransactionsTest.java",
                "sha": "ab73e9a51f1fa070abfc6e384145965dbee9473f",
                "status": "modified"
            }
        ],
        "message": "JCR-1275: NullPointerException in AbstractVersionManager.createVersionHistory()\n- fix test case\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@633834 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/f0cdc4af34f1515f96e98bfa297b15dfc2b14d58",
        "patched_files": [],
        "repo": "jackrabbit",
        "unit_tests": [
            "ConcurrentVersioningWithTransactionsTest.java"
        ]
    },
    "jackrabbit_1d8d310": {
        "bug_id": "jackrabbit_1d8d310",
        "commit": "https://github.com/apache/jackrabbit/commit/1d8d3102dcf52a2cdfa56f6da52547984631d123",
        "file": [
            {
                "additions": 48,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/AbstractVersionManager.java",
                "changes": 48,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/AbstractVersionManager.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/AbstractVersionManager.java",
                "patch": "@@ -21,6 +21,7 @@\n import org.apache.jackrabbit.core.NodeId;\n import org.apache.jackrabbit.core.NodeImpl;\n import org.apache.jackrabbit.core.SessionImpl;\n+import org.apache.jackrabbit.core.nodetype.NodeTypeRegistry;\n import org.apache.jackrabbit.core.state.ItemStateException;\n import org.apache.jackrabbit.core.state.LocalItemStateManager;\n import org.apache.jackrabbit.core.state.NodeState;\n@@ -58,6 +59,11 @@\n      */\n     protected LocalItemStateManager stateMgr;\n \n+    /**\n+     * Node type registry.\n+     */\n+    protected final NodeTypeRegistry ntReg;\n+\n     /**\n      * Persistent root node of the version histories.\n      */\n@@ -78,6 +84,10 @@ protected boolean allowReader() {\n                 }\n             };\n \n+    public AbstractVersionManager(NodeTypeRegistry ntReg) {\n+        this.ntReg = ntReg;\n+    }\n+\n     //-------------------------------------------------------< VersionManager >\n \n     /**\n@@ -529,4 +539,42 @@ protected void versionDestroyed(InternalVersion version) {\n      */\n     protected void itemDiscarded(InternalVersionItem item) {\n     }\n+\n+    /**\n+     * Creates an {@link InternalVersionItem} based on the {@link NodeState}\n+     * identified by <code>id</code>.\n+     *\n+     * @param id    the node id of the version item.\n+     * @return the version item or <code>null</code> if there is no node state\n+     *         with the given <code>id</code>.\n+     * @throws RepositoryException if an error occurs while reading from the\n+     *                             version storage.\n+     */\n+    protected InternalVersionItem createInternalVersionItem(NodeId id)\n+            throws RepositoryException {\n+        try {\n+            if (stateMgr.hasItemState(id)) {\n+                NodeState state = (NodeState) stateMgr.getItemState(id);\n+                NodeStateEx pNode = new NodeStateEx(stateMgr, ntReg, state, null);\n+                NodeId parentId = pNode.getParentId();\n+                InternalVersionItem parent = getItem(parentId);\n+                Name ntName = state.getNodeTypeName();\n+                if (ntName.equals(NameConstants.NT_FROZENNODE)) {\n+                    return new InternalFrozenNodeImpl(this, pNode, parent);\n+                } else if (ntName.equals(NameConstants.NT_VERSIONEDCHILD)) {\n+                    return new InternalFrozenVHImpl(this, pNode, parent);\n+                } else if (ntName.equals(NameConstants.NT_VERSION)) {\n+                    return ((InternalVersionHistory) parent).getVersion(id);\n+                } else if (ntName.equals(NameConstants.NT_VERSIONHISTORY)) {\n+                    return new InternalVersionHistoryImpl(this, pNode);\n+                } else {\n+                    return null;\n+                }\n+            } else {\n+                return null;\n+            }\n+        } catch (ItemStateException e) {\n+            throw new RepositoryException(e);\n+        }\n+    }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/AbstractVersionManager.java",
                "sha": "1905cf3d0c01b66a3213b354940eb9ece6f4a42d",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java",
                "patch": "@@ -17,6 +17,7 @@\n package org.apache.jackrabbit.core.version;\n \n import org.apache.jackrabbit.spi.Name;\n+import org.apache.jackrabbit.core.NodeId;\n \n import java.util.Calendar;\n \n@@ -40,6 +41,13 @@\n      */\n     InternalFrozenNode getFrozenNode();\n \n+    /**\n+     * Returns the node id of the frozen node.\n+     *\n+     * @return the node id of the frozen node;\n+     */\n+    NodeId getFrozenNodeId();\n+\n     /**\n      * Equivalent to {@link Version#getCreated()}\n      *",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java",
                "sha": "a6b96f9275ebe85d03c3c6aff7ea324d0a1e1ff2",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 5,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java",
                "patch": "@@ -108,16 +108,23 @@ public Name getName() {\n     public InternalFrozenNode getFrozenNode() {\n         // get frozen node\n         try {\n-            NodeState.ChildNodeEntry entry = node.getState().getChildNodeEntry(NameConstants.JCR_FROZENNODE, 1);\n-            if (entry == null) {\n-                throw new InternalError(\"version has no frozen node: \" + getId());\n-            }\n-            return (InternalFrozenNode) vMgr.getItem(entry.getId());\n+            return (InternalFrozenNode) vMgr.getItem(getFrozenNodeId());\n         } catch (RepositoryException e) {\n             throw new IllegalStateException(\"unable to retrieve frozen node: \" + e);\n         }\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    public NodeId getFrozenNodeId() {\n+        NodeState.ChildNodeEntry entry = node.getState().getChildNodeEntry(NameConstants.JCR_FROZENNODE, 1);\n+        if (entry == null) {\n+            throw new InternalError(\"version has no frozen node: \" + getId());\n+        }\n+        return entry.getId();\n+    }\n+\n     /**\n      * {@inheritDoc}\n      */",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java",
                "sha": "384d86ceecda64c3a18cd6fda8c26a0af76447e4",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImpl.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImpl.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 27,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImpl.java",
                "patch": "@@ -111,11 +111,6 @@\n      */\n     private final VersionItemStateProvider versProvider;\n \n-    /**\n-     * the node type manager\n-     */\n-    private NodeTypeRegistry ntReg;\n-\n     /**\n      * the dynamic event state collection factory\n      */\n@@ -136,10 +131,10 @@ public VersionManagerImpl(PersistenceManager pMgr, FileSystem fs,\n                               NodeId rootParentId,\n                               ItemStateCacheFactory cacheFactory,\n                               ISMLocking ismLocking) throws RepositoryException {\n+        super(ntReg);\n         try {\n             this.pMgr = pMgr;\n             this.fs = fs;\n-            this.ntReg = ntReg;\n             this.escFactory = new DynamicESCFactory(obsMgr);\n \n             // need to store the version storage root directly into the persistence manager\n@@ -257,37 +252,20 @@ protected InternalVersionItem getItem(NodeId id)\n             synchronized (versionItems) {\n                 InternalVersionItem item = (InternalVersionItem) versionItems.get(id);\n                 if (item == null) {\n-                    if (stateMgr.hasItemState(id)) {\n-                        NodeState state = (NodeState) stateMgr.getItemState(id);\n-                        NodeStateEx pNode = new NodeStateEx(stateMgr, ntReg, state, null);\n-                        NodeId parentId = pNode.getParentId();\n-                        InternalVersionItem parent = getItem(parentId);\n-                        Name ntName = state.getNodeTypeName();\n-                        if (ntName.equals(NameConstants.NT_FROZENNODE)) {\n-                            item = new InternalFrozenNodeImpl(this, pNode, parent);\n-                        } else if (ntName.equals(NameConstants.NT_VERSIONEDCHILD)) {\n-                            item = new InternalFrozenVHImpl(this, pNode, parent);\n-                        } else if (ntName.equals(NameConstants.NT_VERSION)) {\n-                            item = ((InternalVersionHistory) parent).getVersion(id);\n-                        } else if (ntName.equals(NameConstants.NT_VERSIONHISTORY)) {\n-                            item = new InternalVersionHistoryImpl(this, pNode);\n-                        } else {\n-                            return null;\n-                        }\n+                    item = createInternalVersionItem(id);\n+                    if (item != null) {\n+                        versionItems.put(id, item);\n                     } else {\n                         return null;\n                     }\n-                    versionItems.put(id, item);\n                 }\n                 return item;\n             }\n-        } catch (ItemStateException e) {\n-            throw new RepositoryException(e);\n         } finally {\n             releaseReadLock();\n         }\n     }\n-\n+    \n     /**\n      * {@inheritDoc}\n      * <p/>",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImpl.java",
                "sha": "5e77b296bda118f4f07f23e87646dcaf4ad0ace4",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/XAVersionManager.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/XAVersionManager.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 8,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/XAVersionManager.java",
                "patch": "@@ -74,11 +74,6 @@\n      */\n     private final VersionManagerImpl vMgr;\n \n-    /**\n-     * Node type registry.\n-     */\n-    private NodeTypeRegistry ntReg;\n-\n     /**\n      * The session that uses this version manager.\n      */\n@@ -100,9 +95,8 @@\n     public XAVersionManager(VersionManagerImpl vMgr, NodeTypeRegistry ntReg,\n                             SessionImpl session, ItemStateCacheFactory cacheFactory)\n             throws RepositoryException {\n-\n+        super(ntReg);\n         this.vMgr = vMgr;\n-        this.ntReg = ntReg;\n         this.session = session;\n         this.stateMgr = new XAItemStateManager(vMgr.getSharedStateMgr(),\n                 this, CHANGE_LOG_ATTRIBUTE_NAME, cacheFactory);\n@@ -366,7 +360,13 @@ protected InternalVersion checkin(InternalVersionHistoryImpl history,\n             history = makeLocalCopy(history);\n             xaItems.put(history.getId(), history);\n         }\n-        return super.checkin(history, node);\n+        InternalVersion version = super.checkin(history, node);\n+        NodeId frozenNodeId = version.getFrozenNodeId();\n+        InternalVersionItem frozenNode = createInternalVersionItem(frozenNodeId);\n+        if (frozenNode != null) {\n+            xaItems.put(frozenNodeId, frozenNode);\n+        }\n+        return version;\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/XAVersionManager.java",
                "sha": "2c9ad33959bd508caab6036988025da300f6fea0",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java",
                "patch": "@@ -34,7 +34,9 @@ public void testRestoreWithXA() throws Exception {\n         UserTransactionImpl tx = new UserTransactionImpl(superuser);\n         tx.begin();\n         Version v10 = n.checkin();\n+        String versionName = v10.getName();\n         n.restore(v10, true);\n+        assertEquals(\"Wrong version restored\", versionName, n.getBaseVersion().getName());\n         tx.commit();\n     }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java",
                "sha": "8679ab2a9a567bc1ccbf3bf18955e2d6e70288a4",
                "status": "modified"
            },
            {
                "additions": 42,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/TestAll.java",
                "changes": 42,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/TestAll.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/TestAll.java",
                "patch": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.version;\n+\n+import junit.framework.Test;\n+import junit.framework.TestCase;\n+import junit.framework.TestSuite;\n+\n+/**\n+ * Test suite that includes all jackrabbit core version tests.\n+ */\n+public class TestAll extends TestCase {\n+\n+    /**\n+     * Returns a test suite that executes all tests inside this package.\n+     *\n+     * @return a test suite that executes all tests inside this package\n+     */\n+    public static Test suite() {\n+        TestSuite suite = new TestSuite(\"Version tests\");\n+        // disabled because JCR-1481 is not yet fixed\n+        //suite.addTestSuite(CheckinRemoveVersionTest.class);\n+        suite.addTestSuite(RemoveVersionLabelTest.class);\n+        suite.addTestSuite(RestoreTest.class);\n+        suite.addTestSuite(VersionIteratorImplTest.class);\n+        return suite;\n+    }\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/TestAll.java",
                "sha": "d5df74b8f81297fc1361c0dbdbff3f77447a75c8",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java?ref=1d8d3102dcf52a2cdfa56f6da52547984631d123",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java",
                "patch": "@@ -48,6 +48,7 @@ public NodeId getId() {\n \n         public Calendar getCreated() {return null;}\n         public InternalFrozenNode getFrozenNode() {return null;}\n+        public NodeId getFrozenNodeId() {return null;}\n         public Name[] getLabels() {return null;}\n         public Name getName() {return null;}\n         public InternalVersion[] getPredecessors() {return null;}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/1d8d3102dcf52a2cdfa56f6da52547984631d123/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java",
                "sha": "0550a3e4d777cc37e7bd4a120f03a11f74d80215",
                "status": "modified"
            }
        ],
        "message": "JCR-1476: Restore to base version throws NullPointerException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@638303 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/92c5b554a53eee3b03def467cbf54540fea094c5",
        "patched_files": [
            "InternalVersionImpl.java",
            "VersionIteratorImpl.java",
            "InternalVersion.java",
            "VersionManagerImpl.java",
            "AbstractVersionManager.java",
            "Restore.java",
            "XAVersionManager.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "VersionIteratorImplTest.java",
            "TestAll.java",
            "RestoreTest.java"
        ]
    },
    "jackrabbit_260862c": {
        "bug_id": "jackrabbit_260862c",
        "commit": "https://github.com/apache/jackrabbit/commit/260862ca17080f2d5f6eb924f54b2a4b93c49638",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/260862ca17080f2d5f6eb924f54b2a4b93c49638/jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java?ref=260862ca17080f2d5f6eb924f54b2a4b93c49638",
                "deletions": 1,
                "filename": "jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java",
                "patch": "@@ -1508,7 +1508,7 @@ public synchronized NodeImpl addNode(QName nodeName, QName nodeTypeName,\n         if (nodeTypeName != null) {\n             nt = session.getNodeTypeManager().getNodeType(nodeTypeName);\n         }\n-        return internalAddChildNode(nodeName, nt, new NodeId(uuid));\n+        return internalAddChildNode(nodeName, nt, uuid == null ? null : new NodeId(uuid));\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/jackrabbit/raw/260862ca17080f2d5f6eb924f54b2a4b93c49638/jackrabbit/src/main/java/org/apache/jackrabbit/core/NodeImpl.java",
                "sha": "26f6d11222ac503bae732514d8c536408db92e54",
                "status": "modified"
            }
        ],
        "message": "- fixing eventual NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@378253 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/93ff88412eca3b31693cbaa37acdb7d1b093e237",
        "patched_files": [
            "NodeImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "NodeImplTest.java"
        ]
    },
    "jackrabbit_26e4a64": {
        "bug_id": "jackrabbit_26e4a64",
        "commit": "https://github.com/apache/jackrabbit/commit/26e4a64576af30014947f125005319fd1e050ece",
        "file": [
            {
                "additions": 13,
                "blob_url": "https://github.com/apache/jackrabbit/blob/26e4a64576af30014947f125005319fd1e050ece/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java?ref=26e4a64576af30014947f125005319fd1e050ece",
                "deletions": 13,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "patch": "@@ -27,9 +27,15 @@\n \n import org.apache.jackrabbit.core.state.NoSuchItemStateException;\n import org.apache.jackrabbit.test.AbstractJCRTest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class NPEandCMETest extends AbstractJCRTest {\n \n+    /** Logger instance */\n+    private static final Logger log =\n+            LoggerFactory.getLogger(NPEandCMETest.class);\n+\n     private final static int NUM_THREADS = 10;\n     private final static boolean SHOW_STACKTRACE = true;\n     \n@@ -71,8 +77,8 @@ public void testDo() throws Exception {\n             npes += tasks[i].npes;\n             cmes += tasks[i].cmes;\n         }\n-        System.err.println(\"Total NPEs: \" + npes);\n-        System.err.println(\"Total CMEs: \" + cmes);\n+        assertEquals(\"Total NPEs > 0\", 0, npes);\n+        assertEquals(\"Total CMEs > 0\", 0, cmes);\n     }\n     \n     private static class TestTask implements Runnable {\n@@ -121,24 +127,18 @@ public void run() {\n                 // ignorable\n             }\n             catch (RepositoryException e) {\n-                if (e.getCause() == null || !(e.getCause() instanceof NoSuchItemStateException)) {\n-                    System.err.println(\"thread\" + id + \":\" + e);\n-                    e.printStackTrace();\n+                Throwable cause = e.getCause();\n+                if (!(cause instanceof NoSuchItemStateException)) {\n+                    log.warn(\"Unexpected RepositoryException caught\", e);\n                 }\n                 // else ignorable\n             }\n             catch (NullPointerException e) {\n-                System.err.println(\"====> \" + e);\n-                if (SHOW_STACKTRACE) {\n-                    e.printStackTrace();\n-                }\n+                log.error(\"NPE caught\", e);\n                 npes++;\n             }\n             catch (ConcurrentModificationException e) {\n-                System.err.println(\"====> \" + e);\n-                if (SHOW_STACKTRACE) {\n-                    e.printStackTrace();\n-                }\n+                log.error(\"CME caught\", e);\n                 cmes++;\n             }\n         }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/26e4a64576af30014947f125005319fd1e050ece/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "sha": "db55de6ce9374538c349e0958d3194f04c083893",
                "status": "modified"
            }
        ],
        "message": "JCR-3063 NullPointerException in ItemManager\n\nClean up output from the test case\n\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1175988 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/e7094b41c645a957a2dc2057584d7f11b6243b70",
        "patched_files": [],
        "repo": "jackrabbit",
        "unit_tests": [
            "NPEandCMETest.java"
        ]
    },
    "jackrabbit_3f55d09": {
        "bug_id": "jackrabbit_3f55d09",
        "commit": "https://github.com/apache/jackrabbit/commit/3f55d09a77b3e332efcc1507dbc319d4712c7fdb",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java?ref=3f55d09a77b3e332efcc1507dbc319d4712c7fdb",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java",
                "patch": "@@ -806,7 +806,10 @@ public boolean itemExists(String absPath) throws RepositoryException {\n      * {@inheritDoc}\n      */\n     public void save() throws RepositoryException {\n-        perform(new SessionSaveOperation());\n+        // JCR-3131: no need to perform save op when there's nothing to save...\n+        if (context.getItemStateManager().hasAnyTransientItemStates()) {\n+            perform(new SessionSaveOperation());\n+        }\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/jackrabbit/raw/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java",
                "sha": "c689c25b9bd0acc3d52c4dbe8f2ee8ef52bd378c",
                "status": "modified"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/jackrabbit/blob/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java?ref=3f55d09a77b3e332efcc1507dbc319d4712c7fdb",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java",
                "patch": "@@ -504,4 +504,30 @@ public void testRemoveNodeWithInvisibleNonRemovableChild() throws Exception {\n             // success\n         }\n     }\n+    \n+    // https://issues.apache.org/jira/browse/JCR-3131\n+    public void testEmptySaveNoRootAccess() throws RepositoryException, NotExecutableException {\n+\n+        Session s = getTestSession();\n+        s.save();\n+\n+        Privilege[] read = privilegesFromName(Privilege.JCR_READ);\n+\n+        try {\n+            JackrabbitAccessControlList tmpl = getPolicy(acMgr, \"/\", testUser.getPrincipal());\n+            tmpl.addEntry(testUser.getPrincipal(), read, false, getRestrictions(superuser, path));\n+            acMgr.setPolicy(tmpl.getPath(), tmpl);\n+            superuser.save();\n+\n+            // empty save operation\n+            s.save();\n+        }\n+        finally {\n+            // undo revocation of read privilege\n+            JackrabbitAccessControlList tmpl = getPolicy(acMgr, \"/\", testUser.getPrincipal());\n+            tmpl.addEntry(testUser.getPrincipal(), read, true, getRestrictions(superuser, path));\n+            acMgr.setPolicy(tmpl.getPath(), tmpl);\n+            superuser.save();\n+        }\n+    }\n }\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/jackrabbit/raw/3f55d09a77b3e332efcc1507dbc319d4712c7fdb/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/acl/WriteTest.java",
                "sha": "a6ae45e73c94a63b47777b987a5c8da7d1cfa0fb",
                "status": "modified"
            }
        ],
        "message": "JCR-3131: NPE in ItemManager when calling Session.save() with nothing to save\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1196062 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/4fa3d5f41bd428876ad4fe5a44d340c94973b942",
        "patched_files": [
            "SessionImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "SessionImplTest.java",
            "WriteTest.java"
        ]
    },
    "jackrabbit_46fc0c5": {
        "bug_id": "jackrabbit_46fc0c5",
        "commit": "https://github.com/apache/jackrabbit/commit/46fc0c5d78527b840955c2a432278979198d2342",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/46fc0c5d78527b840955c2a432278979198d2342/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java?ref=46fc0c5d78527b840955c2a432278979198d2342",
                "deletions": 4,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java",
                "patch": "@@ -771,14 +771,13 @@ public void end() throws ItemStateException {\n \n             ISMLocking.ReadLock readLock = null;\n             try {\n+                // Let the shared item listeners know about the change\n+                shared.persisted();\n+\n                 // downgrade to read lock\n                 readLock = writeLock.downgrade();\n                 writeLock = null;\n \n-                // Let the shared item listeners know about the change\n-                // JCR-2171: This must happen after downgrading the lock!\n-                shared.persisted();\n-\n                 /* notify virtual providers about node references */\n                 for (int i = 0; i < virtualNodeReferences.length; i++) {\n                     ChangeLog virtualRefs = virtualNodeReferences[i];",
                "raw_url": "https://github.com/apache/jackrabbit/raw/46fc0c5d78527b840955c2a432278979198d2342/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/state/SharedItemStateManager.java",
                "sha": "5d966ebd19a23fde1dbd8e955a3dd6cc980e7dbe",
                "status": "modified"
            },
            {
                "additions": 131,
                "blob_url": "https://github.com/apache/jackrabbit/blob/46fc0c5d78527b840955c2a432278979198d2342/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "changes": 131,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java?ref=46fc0c5d78527b840955c2a432278979198d2342",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "patch": "@@ -0,0 +1,131 @@\n+package org.apache.jackrabbit.core;\n+\n+import java.util.ConcurrentModificationException;\n+\n+import javax.jcr.InvalidItemStateException;\n+import javax.jcr.ItemNotFoundException;\n+import javax.jcr.Node;\n+import javax.jcr.NodeIterator;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Session;\n+\n+import org.apache.jackrabbit.core.state.NoSuchItemStateException;\n+import org.apache.jackrabbit.test.AbstractJCRTest;\n+\n+public class NPEandCMETest extends AbstractJCRTest {\n+\n+    private final static int NUM_THREADS = 10;\n+    private final static boolean SHOW_STACKTRACE = true;\n+    \n+    protected void setUp() throws Exception {\n+        super.setUp();\n+        Session session = getHelper().getSuperuserSession();\n+        session.getRootNode().addNode(\"test\");\n+        session.save();\n+    }\n+    \n+    protected void tearDown() throws Exception {\n+        try {\n+            Session session = getHelper().getSuperuserSession();\n+            if (session.getRootNode().hasNode(\"test\")) {\n+                session.getRootNode().getNode(\"test\").remove();\n+                session.save();\n+            }\n+        } finally {\n+            super.tearDown();\n+        }\n+    }\n+    \n+    public void testDo() throws Exception {\n+        Thread[] threads = new Thread[NUM_THREADS];\n+        TestTask[] tasks = new TestTask[NUM_THREADS];\n+        for (int i = 0; i < NUM_THREADS; i++) {\n+            Session session = getHelper().getSuperuserSession();\n+            tasks[i] = new TestTask(i, session);\n+        }\n+        for (int i = 0; i < NUM_THREADS; i++) {\n+            threads[i] = new Thread(tasks[i]);\n+            threads[i].start();\n+        }\n+        for (int i = 0; i < NUM_THREADS; i++) {\n+            threads[i].join();\n+        }\n+        int npes = 0, cmes = 0;\n+        for(int i = 0; i < NUM_THREADS; i++) {\n+            npes += tasks[i].npes;\n+            cmes += tasks[i].cmes;\n+        }\n+        System.err.println(\"Total NPEs: \" + npes);\n+        System.err.println(\"Total CMEs: \" + cmes);\n+    }\n+    \n+    private static class TestTask implements Runnable {\n+\n+        private final Session session;\n+        private final int id;\n+        private final Node test;\n+        \n+        private int npes = 0;\n+        private int cmes = 0;\n+        \n+        private TestTask(int id, Session session) throws RepositoryException {\n+            this.id = id;\n+            this.session = session;\n+            test = this.session.getRootNode().getNode(\"test\");\n+        }\n+        \n+        public void run() {\n+            try {\n+                for (int i = 0; i < 500; i++) {\n+                    NodeIterator nodes = test.getNodes();\n+                    if (nodes.getSize() > 100) {\n+                        long count = nodes.getSize() - 100;\n+                        while (nodes.hasNext() && count-- > 0) {\n+                            Node node = nodes.nextNode();\n+                            if (node != null) {\n+                                try {\n+                                    node.remove();\n+                                }\n+                                catch (ItemNotFoundException e) {\n+                                    // item was already removed\n+                                }\n+                                catch (InvalidItemStateException e) {\n+                                    // ignorable\n+                                }\n+                            }\n+                        }\n+                        session.save();\n+                    }\n+                    test.addNode(\"test-\" + id + \"-\" + i);\n+                    session.save();\n+                }\n+                \n+            }\n+            catch (InvalidItemStateException e) {\n+                // ignorable\n+            }\n+            catch (RepositoryException e) {\n+                if (e.getCause() == null || !(e.getCause() instanceof NoSuchItemStateException)) {\n+                    System.err.println(\"thread\" + id + \":\" + e);\n+                    e.printStackTrace();\n+                }\n+                // else ignorable\n+            }\n+            catch (NullPointerException e) {\n+                System.err.println(\"====> \" + e);\n+                if (SHOW_STACKTRACE) {\n+                    e.printStackTrace();\n+                }\n+                npes++;\n+            }\n+            catch (ConcurrentModificationException e) {\n+                System.err.println(\"====> \" + e);\n+                if (SHOW_STACKTRACE) {\n+                    e.printStackTrace();\n+                }\n+                cmes++;\n+            }\n+        }\n+        \n+    }\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/46fc0c5d78527b840955c2a432278979198d2342/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "sha": "b97fdc26f576329b413a32de6bacb18789f1de0b",
                "status": "added"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/46fc0c5d78527b840955c2a432278979198d2342/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/TestAll.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/TestAll.java?ref=46fc0c5d78527b840955c2a432278979198d2342",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/TestAll.java",
                "patch": "@@ -80,6 +80,8 @@ public static Test suite() {\n \n         suite.addTestSuite(OverlappingNodeAddTest.class);\n \n+        suite.addTestSuite(NPEandCMETest.class);\n+\n         return suite;\n     }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/46fc0c5d78527b840955c2a432278979198d2342/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/TestAll.java",
                "sha": "94e6e3205e124f4f3ce3891d57f763ee31f04677",
                "status": "modified"
            }
        ],
        "message": "JCR-3063 NullPointerException in ItemManager\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1174822 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/522cafdb29f9c848042c9d27202eff1c9682adf4",
        "patched_files": [
            "SharedItemStateManager.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TestAll.java",
            "NPEandCMETest.java"
        ]
    },
    "jackrabbit_5234d5a": {
        "bug_id": "jackrabbit_5234d5a",
        "commit": "https://github.com/apache/jackrabbit/commit/5234d5accc5cf52e594682593d40168afaa1aaee",
        "file": [
            {
                "additions": 11,
                "blob_url": "https://github.com/apache/jackrabbit/blob/5234d5accc5cf52e594682593d40168afaa1aaee/jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java",
                "changes": 22,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java?ref=5234d5accc5cf52e594682593d40168afaa1aaee",
                "deletions": 11,
                "filename": "jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java",
                "patch": "@@ -18,32 +18,32 @@\n  */\n package org.apache.jackrabbit.rmi.xml;\n \n-import java.io.UnsupportedEncodingException;\n-\n import javax.jcr.RepositoryException;\n \n import junit.framework.TestCase;\n \n import org.apache.jackrabbit.rmi.xml.ImportContentHandler;\n-import org.xml.sax.SAXException;\n+import org.xml.sax.helpers.AttributesImpl;\n \n public class ImportContentHandlerTest extends TestCase {\n \n-    public void testImportContentHandler() throws RepositoryException, SAXException {\n+    public void testImportContentHandler() throws Exception {\n         // fail test if handler cannot be set up\n         DummyImportContentHandler ch = new DummyImportContentHandler();\n \n         // these may throw SAXException\n         ch.startDocument();\n-        ch.startElement(null, \"sample\", \"sample\", null);\n-        ch.endElement(null, \"sample\", \"sample\");\n+        ch.startPrefixMapping(\"foo\", \"http://example.com/ns/foo\");\n+        ch.startElement(\n+                \"http://example.com/ns/foo\", \"sample\", \"foo:sample\",\n+                new AttributesImpl());\n+        ch.endElement(\"http://example.com/ns/foo\", \"sample\", \"foo:sample\");\n+        ch.endPrefixMapping(\"foo\");\n         ch.endDocument();\n \n-        byte[] xml = ch.getXML();\n-        assertNotNull(\"Serialized XML is null\", xml);\n-        assertTrue(\"Serialized XML is empty\", xml.length > 0);\n-\n-        // for the moment we don't actually care for the concrete contents\n+        String xml = new String(ch.getXML(), \"UTF-8\");\n+        assertTrue(xml.contains(\n+                \"<foo:sample xmlns:foo=\\\"http://example.com/ns/foo\\\"/>\"));\n     }\n \n     private static class DummyImportContentHandler extends ImportContentHandler {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/5234d5accc5cf52e594682593d40168afaa1aaee/jackrabbit-jcr-rmi/src/test/java/org/apache/jackrabbit/rmi/xml/ImportContentHandlerTest.java",
                "sha": "f74e41ad51f293ae109710cb7c36a8dd6c269eec",
                "status": "modified"
            }
        ],
        "message": "JCR-1343: Replace use of Xerces by JAXP to implement SAX DocumentHandler\r\n    - Improved test case, previous one was throwing an NPE\r\n      because of the null attributes argument to startElement()\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@615950 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/a5e73c05166943ad412973bbd1c4fae9f073ea98",
        "patched_files": [],
        "repo": "jackrabbit",
        "unit_tests": [
            "ImportContentHandlerTest.java"
        ]
    },
    "jackrabbit_524deb7": {
        "bug_id": "jackrabbit_524deb7",
        "commit": "https://github.com/apache/jackrabbit/commit/524deb74243abba98b246845296ee422baf4c556",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java",
                "patch": "@@ -21,6 +21,7 @@\n import javax.jcr.version.Version;\n \n import java.util.Calendar;\n+import java.util.List;\n \n /**\n  * This interface defines the internal version.\n@@ -63,7 +64,7 @@\n      * @see javax.jcr.version.Version#getSuccessors()\n      * @return the successors as internal versions\n      */\n-    InternalVersion[] getSuccessors();\n+    List<InternalVersion> getSuccessors();\n \n     /**\n      * Equivalent to {@link Version#getLinearSuccessor()}.",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersion.java",
                "sha": "a612163bb2da395dbf05a11fd20e9470fc2e575a",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "patch": "@@ -162,7 +162,7 @@ private synchronized void init() throws RepositoryException {\n         }\n \n         // fix legacy\n-        if (rootVersion.getSuccessors().length == 0) {\n+        if (rootVersion.getSuccessors().isEmpty()) {\n             for (Name versionName : nameCache.keySet()) {\n                 InternalVersionImpl v = createVersionInstance(versionName);\n                 v.legacyResolveSuccessors();",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "sha": "9929305c5226f744bb109a677579e0c1cdab183a",
                "status": "modified"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java",
                "changes": 37,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 11,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java",
                "patch": "@@ -22,11 +22,14 @@\n import org.apache.jackrabbit.core.id.NodeId;\n import org.apache.jackrabbit.spi.Name;\n import org.apache.jackrabbit.spi.commons.name.NameConstants;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import javax.jcr.PropertyType;\n import javax.jcr.RepositoryException;\n import java.util.Arrays;\n import java.util.Calendar;\n+import java.util.Collections;\n import java.util.HashSet;\n import java.util.List;\n import java.util.ArrayList;\n@@ -37,6 +40,10 @@\n class InternalVersionImpl extends InternalVersionItemImpl\n         implements InternalVersion {\n \n+    /** Logger instance */\n+    private static final Logger log =\n+        LoggerFactory.getLogger(InternalVersionImpl.class);\n+\n     /**\n      * the date when this version was created\n      */\n@@ -138,18 +145,27 @@ public Calendar getCreated() {\n     /**\n      * {@inheritDoc}\n      */\n-    public InternalVersion[] getSuccessors() {\n+    public List<InternalVersion> getSuccessors() {\n         ReadLock lock = vMgr.acquireReadLock();\n         try {\n-            InternalValue[] values = node.getPropertyValues(NameConstants.JCR_SUCCESSORS);\n+            InternalValue[] values =\n+                node.getPropertyValues(NameConstants.JCR_SUCCESSORS);\n             if (values != null) {\n-                InternalVersion[] versions = new InternalVersion[values.length];\n-                for (int i = 0; i < values.length; i++) {\n-                    versions[i] = versionHistory.getVersion(values[i].getNodeId());\n+                List<InternalVersion> versions =\n+                    new ArrayList<InternalVersion>(values.length);\n+                for (InternalValue value : values) {\n+                    InternalVersion version =\n+                        versionHistory.getVersion(value.getNodeId());\n+                    if (version != null) {\n+                        versions.add(version);\n+                    } else {\n+                        // Can happen with a corrupted repository (JCR-2655)\n+                        log.warn(\"Missing successor {}\", value.getNodeId());\n+                    }\n                 }\n                 return versions;\n             } else {\n-                return new InternalVersion[0];\n+                return Collections.emptyList();\n             }\n         } finally {\n             lock.release();\n@@ -275,8 +291,7 @@ private void storeXCessors(List<InternalVersion> cessors, Name propname, boolean\n      */\n     void internalDetach() throws RepositoryException {\n         // detach this from all successors\n-        InternalVersion[] succ = getSuccessors();\n-        for (InternalVersion aSucc : succ) {\n+        for (InternalVersion aSucc :  getSuccessors()) {\n             ((InternalVersionImpl) aSucc).internalDetachPredecessor(this, true);\n         }\n \n@@ -312,7 +327,7 @@ void internalAttach() throws RepositoryException {\n      */\n     private void internalAddSuccessor(InternalVersionImpl succ, boolean store)\n             throws RepositoryException {\n-        List<InternalVersion> l = new ArrayList<InternalVersion>(Arrays.asList(getSuccessors()));\n+        List<InternalVersion> l = new ArrayList<InternalVersion>(getSuccessors());\n         if (!l.contains(succ)) {\n             l.add(succ);\n             storeXCessors(l, NameConstants.JCR_SUCCESSORS, store);\n@@ -353,11 +368,11 @@ private void internalDetachPredecessor(InternalVersionImpl v, boolean store)\n     private void internalDetachSuccessor(InternalVersionImpl v, boolean store)\n             throws RepositoryException {\n         // remove 'v' from successors list\n-        List<InternalVersion> l = new ArrayList<InternalVersion>(Arrays.asList(getSuccessors()));\n+        List<InternalVersion> l = new ArrayList<InternalVersion>(getSuccessors());\n         l.remove(v);\n \n         // attach V's successors\n-        l.addAll(Arrays.asList(v.getSuccessors()));\n+        l.addAll(v.getSuccessors());\n         storeXCessors(l, NameConstants.JCR_SUCCESSORS, store);\n     }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionImpl.java",
                "sha": "85309383189b4b9f6afd4d4bfe9cf0b8a293011d",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java",
                "patch": "@@ -664,7 +664,7 @@ protected String calculateCheckinVersionName(InternalVersionHistoryImpl history,\n             return newVersionName;\n         } else {\n             // best is root version\n-            return String.valueOf(best.getSuccessors().length + 1) + \".0\";\n+            return String.valueOf(best.getSuccessors().size() + 1) + \".0\";\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionManagerBase.java",
                "sha": "0c12cb5eb2734f04f9d550c8bd9a8daa814a0949",
                "status": "modified"
            },
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 4,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java",
                "patch": "@@ -512,12 +512,10 @@ protected void internalRemoveVersion(InternalVersionHistoryImpl history, Name na\n             xaItems.put(history.getId(), history);\n             // also put 'successor' and 'predecessor' version items to xaItem sets\n             InternalVersion v = history.getVersion(name);\n-            InternalVersion[] vs = v.getSuccessors();\n-            for (InternalVersion v1 : vs) {\n+            for (InternalVersion v1 : v.getSuccessors()) {\n                 xaItems.put(v1.getId(), v1);\n             }\n-            vs = v.getPredecessors();\n-            for (InternalVersion v1 : vs) {\n+            for (InternalVersion v1 : v.getPredecessors()) {\n                 xaItems.put(v1.getId(), v1);\n             }\n         }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalXAVersionManager.java",
                "sha": "819b40e2020ae624e26be9e0ee89c08df3f53808",
                "status": "modified"
            },
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 4,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java",
                "patch": "@@ -34,6 +34,7 @@\n import javax.jcr.Node;\n import javax.jcr.nodetype.ConstraintViolationException;\n import java.util.Calendar;\n+import java.util.List;\n \n /**\n  * Base implementation of the {@link javax.jcr.version.Version} interface.\n@@ -84,10 +85,11 @@ public Calendar getCreated() throws RepositoryException {\n      */\n     public javax.jcr.version.Version[] getSuccessors() throws RepositoryException {\n         // need to wrap it around proper node\n-        InternalVersion[] suc = getInternalVersion().getSuccessors();\n-        Version[] ret = new Version[suc.length];\n-        for (int i = 0; i < suc.length; i++) {\n-            ret[i] = (Version) sessionContext.getSessionImpl().getNodeById(suc[i].getId());\n+        List<InternalVersion> suc = getInternalVersion().getSuccessors();\n+        Version[] ret = new Version[suc.size()];\n+        for (int i = 0; i < ret.length; i++) {\n+            ret[i] = (Version) sessionContext.getSessionImpl().getNodeById(\n+                    suc.get(i).getId());\n         }\n         return ret;\n     }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java",
                "sha": "42df5e3c39cd592e2374d105b0563af4af11956a",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 3,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java",
                "patch": "@@ -26,7 +26,6 @@\n import java.util.ConcurrentModificationException;\n import java.util.LinkedList;\n import java.util.NoSuchElementException;\n-import java.util.Arrays;\n \n /**\n  * This Class implements a VersionIterator that iterates over a version\n@@ -170,8 +169,7 @@ private synchronized void collectAllVersions(InternalVersion root) {\n             NodeId id = currentVersion.getId();\n             if (!versions.contains(id)) {\n                 versions.add(id);\n-                InternalVersion[] successors = currentVersion.getSuccessors();\n-                workQueue.addAll(Arrays.asList(successors));\n+                workQueue.addAll(currentVersion.getSuccessors());\n             }\n         }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java",
                "sha": "99a485c51cfe190acda1ff4037c050be18e10034",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 3,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java",
                "patch": "@@ -19,6 +19,7 @@\n import java.util.ArrayList;\n import java.util.HashSet;\n import java.util.LinkedList;\n+import java.util.List;\n import java.util.Set;\n \n import javax.jcr.ItemExistsException;\n@@ -577,14 +578,14 @@ protected void internalRestoreFrozen(NodeStateEx state,\n                     if (v == null) {\n                         // if version selector was unable to select version,\n                         // choose the initial one\n-                        InternalVersion[] vs = vh.getRootVersion().getSuccessors();\n-                        if (vs.length == 0) {\n+                        List<InternalVersion> vs = vh.getRootVersion().getSuccessors();\n+                        if (vs.isEmpty()) {\n                             String msg = \"Unable to select appropariate version for \"\n                                     + child.getName() + \" using \" + vsel;\n                             log.error(msg);\n                             throw new VersionException(msg);\n                         }\n-                        v = vs[0];\n+                        v = vs.get(0);\n                     }\n                     InternalFrozenNode f = v.getFrozenNode();\n                     restoredChild = state.addNode(fh.getName(), f.getFrozenPrimaryType(), f.getFrozenId());",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionManagerImplRestore.java",
                "sha": "72a76bae530495bdcebb85bd89cf18e86bb893da",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java?ref=524deb74243abba98b246845296ee422baf4c556",
                "deletions": 2,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java",
                "patch": "@@ -16,7 +16,9 @@\n  */\n package org.apache.jackrabbit.core.version;\n \n+import java.util.Arrays;\n import java.util.Calendar;\n+import java.util.List;\n \n import junit.framework.TestCase;\n \n@@ -37,8 +39,8 @@ public DummyInternalVersion(InternalVersion[] successors, NodeId id) {\n             this.id = id;\n         }\n \n-        public InternalVersion[] getSuccessors() {\n-            return successors;\n+        public List<InternalVersion> getSuccessors() {\n+            return Arrays.asList(successors);\n         }\n \n         public NodeId getId() {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/524deb74243abba98b246845296ee422baf4c556/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/VersionIteratorImplTest.java",
                "sha": "c14f66bb6211a4ff7430a807018dbe1a311fd01b",
                "status": "modified"
            }
        ],
        "message": "JCR-2655: initVersions crashes with NPE\n\nSkip missing successors to avoid the NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1000912 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/97bb7f89fc3d1487dc2155f44a2c2d9db7c74169",
        "patched_files": [
            "InternalVersionManagerBase.java",
            "VersionIteratorImpl.java",
            "VersionManagerImplRestore.java",
            "InternalXAVersionManager.java",
            "InternalVersionImpl.java",
            "InternalVersionHistoryImpl.java",
            "InternalVersion.java",
            "VersionImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "VersionIteratorImplTest.java",
            "InternalVersionHistoryImplTest.java"
        ]
    },
    "jackrabbit_54ac4bc": {
        "bug_id": "jackrabbit_54ac4bc",
        "commit": "https://github.com/apache/jackrabbit/commit/54ac4bcd680a041703893c78f0cb48a6bde79e7a",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/54ac4bcd680a041703893c78f0cb48a6bde79e7a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java?ref=54ac4bcd680a041703893c78f0cb48a6bde79e7a",
                "deletions": 4,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java",
                "patch": "@@ -38,7 +38,6 @@\n import org.apache.jackrabbit.api.jsr283.security.AccessControlManager;\n import org.apache.jackrabbit.api.jsr283.retention.RetentionManager;\n import org.apache.jackrabbit.core.security.authentication.AuthContext;\n-import org.apache.jackrabbit.core.state.ItemStateException;\n import org.apache.jackrabbit.core.state.LocalItemStateManager;\n import org.apache.jackrabbit.core.state.NodeState;\n import org.apache.jackrabbit.core.state.SessionItemStateManager;\n@@ -419,7 +418,7 @@ public Session createSession(String workspaceName)\n         if (workspaceName == null) {\n             workspaceName = rep.getConfig().getDefaultWorkspaceName();\n         }\n-        if (loginContext!=null) {\n+        if (loginContext != null) {\n             return rep.createSession(loginContext, workspaceName);\n         } else {\n             return rep.createSession(getSubject(), workspaceName);\n@@ -667,10 +666,9 @@ public void removeListener(SessionListener listener) {\n     /**\n      * Create a data store garbage collector for this repository.\n      *\n-     * @throws ItemStateException\n      * @throws RepositoryException\n      */\n-    public GarbageCollector createDataStoreGarbageCollector() throws RepositoryException, ItemStateException {\n+    public GarbageCollector createDataStoreGarbageCollector() throws RepositoryException {\n         ArrayList pmList = new ArrayList();\n         VersionManagerImpl vm = (VersionManagerImpl) rep.getVersionManager();\n         PersistenceManager pm = vm.getPersistenceManager();",
                "raw_url": "https://github.com/apache/jackrabbit/raw/54ac4bcd680a041703893c78f0cb48a6bde79e7a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/SessionImpl.java",
                "sha": "5eaf4475f57d7353306bf9bd88e0bd29e8153122",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/54ac4bcd680a041703893c78f0cb48a6bde79e7a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/GarbageCollector.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/GarbageCollector.java?ref=54ac4bcd680a041703893c78f0cb48a6bde79e7a",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/GarbageCollector.java",
                "patch": "@@ -147,6 +147,9 @@ public void setScanEventListener(ScanEventListener callback) {\n      */\n     public void scan() throws RepositoryException,\n             IllegalStateException, IOException, ItemStateException {\n+        if (store == null) {\n+            throw new RepositoryException(\"No DataStore configured.\");\n+        }\n         long now = System.currentTimeMillis();\n         if (startScanTimestamp == 0) {\n             startScanTimestamp = now;",
                "raw_url": "https://github.com/apache/jackrabbit/raw/54ac4bcd680a041703893c78f0cb48a6bde79e7a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/GarbageCollector.java",
                "sha": "2f3bc06598068976af0bed46c20a7f33cfa8970c",
                "status": "modified"
            }
        ],
        "message": "JCR-1985 NullPointerException in GarbageCollector.scan() if no DataStore configured\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@745534 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/1bf25a0bc093f028a87e49ec0a023970815bc299",
        "patched_files": [
            "SessionImpl.java",
            "GarbageCollector.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "SessionImplTest.java",
            "GarbageCollectorTest.java"
        ]
    },
    "jackrabbit_5570035": {
        "bug_id": "jackrabbit_5570035",
        "commit": "https://github.com/apache/jackrabbit/commit/55700358113308bb81a09c0b3cea28df83a59ba9",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/PropertyImpl.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/PropertyImpl.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/PropertyImpl.java",
                "patch": "@@ -17,6 +17,7 @@\n package org.apache.jackrabbit.core;\n \n import java.io.InputStream;\n+import java.io.IOException;\n import java.math.BigDecimal;\n import java.util.ArrayList;\n import java.util.Calendar;\n@@ -49,6 +50,7 @@\n import org.apache.jackrabbit.spi.commons.name.NameConstants;\n import org.apache.jackrabbit.spi.commons.value.ValueFormat;\n import org.apache.jackrabbit.value.ValueHelper;\n+import org.apache.commons.io.input.AutoCloseInputStream;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -474,7 +476,14 @@ public String getString() throws RepositoryException {\n     }\n \n     public InputStream getStream() throws RepositoryException {\n-        return getValue().getBinary().getStream();\n+        final Binary bin = getValue().getBinary();\n+        // make sure binary is disposed after stream had been consumed\n+        return new AutoCloseInputStream(bin.getStream()) {\n+            public void close() throws IOException {\n+                super.close();\n+                bin.dispose();\n+            }\n+        };\n     }\n \n     public long getLong() throws RepositoryException {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/PropertyImpl.java",
                "sha": "706b2ec9437de4c2ffedeaf9890b143dd30678af",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBFileValue.java",
                "changes": 66,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBFileValue.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 56,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBFileValue.java",
                "patch": "@@ -18,8 +18,6 @@\n \n import java.io.IOException;\n import java.io.InputStream;\n-import java.io.ByteArrayOutputStream;\n-import java.io.UnsupportedEncodingException;\n \n import javax.jcr.RepositoryException;\n import javax.jcr.Binary;\n@@ -38,48 +36,6 @@\n  */\n abstract class BLOBFileValue implements Binary {\n \n-    /**\n-     * Returns a String representation of this value.\n-     *\n-     * @return String representation of this value.\n-     * @throws RepositoryException\n-     */\n-    String getString() throws RepositoryException {\n-        // TODO: review again. currently the getString method of the JCR Value is delegated to the QValue.\n-        InputStream stream = getStream();\n-        try {\n-            ByteArrayOutputStream out = new ByteArrayOutputStream();\n-            byte[] buffer = new byte[8192];\n-            int read;\n-            while ((read = stream.read(buffer)) > 0) {\n-                out.write(buffer, 0, read);\n-            }\n-            byte[] data = out.toByteArray();\n-            return new String(data, \"UTF-8\");\n-        } catch (UnsupportedEncodingException e) {\n-            throw new RepositoryException(\"UTF-8 not supported on this platform\", e);\n-        } catch (IOException e) {\n-            throw new RepositoryException(\"conversion from stream to string failed\", e);\n-        } finally {\n-            try {\n-                if (stream != null) {\n-                    stream.close();\n-                }\n-            } catch (IOException e) {\n-                // ignore\n-            }\n-        }\n-    }\n-\n-    /**\n-     * Frees temporarily allocated resources such as temporary file, buffer, etc.\n-     * If this <code>BLOBFileValue</code> is backed by a persistent resource\n-     * calling this method will have no effect.\n-     *\n-     * @see #delete(boolean)\n-     */\n-    abstract void discard();\n-\n     /**\n      * Deletes the persistent resource backing this <code>BLOBFileValue</code>.\n      *\n@@ -89,12 +45,18 @@ String getString() throws RepositoryException {\n     abstract void delete(boolean pruneEmptyParentDirs);\n \n     /**\n-     * Checks if this object is immutable.\n-     * Immutable objects can not change and can safely copied.\n+     * Returns a copy of this BLOB file value. The returned copy may also be\n+     * this object. However an implementation must guarantee that the returned\n+     * value has state that is independent from this value. Immutable values\n+     * can savely return the same value (this object).\n+     * <p/>\n+     * Specifically, {@link #dispose()} on the returned value must not have an\n+     * effect on this value!\n      *\n-     * @return true if the object is immutable\n+     * @return a value that can be used independently from this value.\n+     * @throws RepositoryException if an error occur while copying this value.\n      */\n-    abstract boolean isImmutable();\n+    abstract BLOBFileValue copy() throws RepositoryException;\n \n     public abstract boolean equals(Object obj);\n \n@@ -112,9 +74,6 @@ DataIdentifier getDataIdentifier() {\n     }\n \n     //-----------------------------------------------------< javax.jcr.Binary >\n-    public abstract long getSize();\n-\n-    public abstract InputStream getStream() throws RepositoryException;\n \n     public int read(byte[] b, long position) throws IOException, RepositoryException {\n         InputStream in = getStream();\n@@ -125,9 +84,4 @@ public int read(byte[] b, long position) throws IOException, RepositoryException\n             in.close();\n         }\n     }\n-\n-    public void dispose() {\n-        discard();\n-    }\n-\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBFileValue.java",
                "sha": "b4e6e28123b943b72e2eec6e92fae850ea074ab9",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInDataStore.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInDataStore.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 3,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInDataStore.java",
                "patch": "@@ -57,16 +57,16 @@ void delete(boolean pruneEmptyParentDirs) {\n         // do nothing\n     }\n \n-    void discard() {\n+    public void dispose() {\n         // do nothing\n     }\n \n     DataIdentifier getDataIdentifier() {\n         return identifier;\n     }\n \n-    boolean isImmutable() {\n-        return true;\n+    BLOBFileValue copy() throws RepositoryException {\n+        return this;\n     }\n \n     public boolean equals(Object obj) {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInDataStore.java",
                "sha": "afa1123703ba30e8267f9e9572e242691f4e08d9",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInMemory.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInMemory.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 12,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInMemory.java",
                "patch": "@@ -22,7 +22,6 @@\n import javax.jcr.RepositoryException;\n import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n-import java.io.UnsupportedEncodingException;\n import java.util.Arrays;\n \n /**\n@@ -122,14 +121,14 @@ void delete(boolean pruneEmptyParentDirs) {\n         // the data will be garbage collected\n     }\n \n-    void discard() {\n+    public void dispose() {\n         // do nothing\n         // this object could still be referenced\n         // the data will be garbage collected\n     }\n \n-    boolean isImmutable() {\n-        return true;\n+    BLOBFileValue copy() throws RepositoryException {\n+        return this;\n     }\n \n     public long getSize() {\n@@ -140,14 +139,6 @@ public InputStream getStream() {\n         return new ByteArrayInputStream(data);\n     }\n \n-    String getString() throws RepositoryException {\n-        try {\n-            return new String(data, \"UTF-8\");\n-        } catch (UnsupportedEncodingException e) {\n-            throw new RepositoryException(\"UTF-8 not supported on this platform\", e);\n-        }\n-    }\n-\n     public String toString() {\n         StringBuilder buff = new StringBuilder(PREFIX.length() + 2 * data.length);\n         buff.append(PREFIX);",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInMemory.java",
                "sha": "77afa162bf61cfae97b5e31429faf0a323045e18",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInResource.java",
                "changes": 7,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInResource.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 4,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInResource.java",
                "patch": "@@ -92,13 +92,12 @@ void delete(boolean pruneEmptyParentDirs) {\n \n     }\n \n-    void discard() {\n+    public void dispose() {\n         // this instance is not backed by temporarily allocated resource/buffer\n     }\n \n-    boolean isImmutable() {\n-        // delete will modify the state.\n-        return false;\n+    BLOBFileValue copy() throws RepositoryException {\n+        return BLOBInTempFile.getInstance(getStream(), true);\n     }\n \n     public long getSize() {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInResource.java",
                "sha": "bdd167cd0e6462e4b248199c8ba0ca037d39e8ca",
                "status": "modified"
            },
            {
                "additions": 14,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInTempFile.java",
                "changes": 21,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInTempFile.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 7,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInTempFile.java",
                "patch": "@@ -92,16 +92,20 @@ private BLOBInTempFile(File file, boolean temp) {\n      * @param in the stream\n      * @param temp\n      */\n-    static BLOBInTempFile getInstance(InputStream in, boolean temp) throws RepositoryException {\n-        return new BLOBInTempFile(in, temp);\n+    static BLOBFileValue getInstance(InputStream in, boolean temp) throws RepositoryException {\n+        if (temp) {\n+            return new RefCountingBLOBFileValue(new BLOBInTempFile(in, temp));\n+        } else {\n+            return new BLOBInTempFile(in, temp);\n+        }\n     }\n \n     /**\n      * Creates a new instance from a file.\n      *\n      * @param file the file\n      */\n-    static BLOBInTempFile getInstance(File file, boolean temp) throws IOException {\n+    static BLOBInTempFile getInstance(File file, boolean temp) {\n         return new BLOBInTempFile(file, temp);\n     }\n \n@@ -111,15 +115,18 @@ void delete(boolean pruneEmptyParentDirs) {\n         file = null;\n     }\n \n-    void discard() {\n+    public void dispose() {\n         if (temp) {\n             delete(true);\n         }\n     }\n \n-    boolean isImmutable() {\n-        // discard and delete can modify the state.\n-        return false;\n+    BLOBFileValue copy() throws RepositoryException {\n+        if (temp) {\n+            return BLOBInTempFile.getInstance(getStream(), temp);\n+        } else {\n+            return BLOBInTempFile.getInstance(file, temp);\n+        }\n     }\n \n     public long getSize() {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/BLOBInTempFile.java",
                "sha": "6ebf2293546f9584a2f593fe6bcf1ffaaffd55bc",
                "status": "modified"
            },
            {
                "additions": 35,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValue.java",
                "changes": 60,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValue.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 25,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValue.java",
                "patch": "@@ -49,6 +49,7 @@\n import org.apache.jackrabbit.spi.commons.value.AbstractQValueFactory;\n import org.apache.jackrabbit.spi.commons.value.QValueValue;\n import org.apache.jackrabbit.util.ISO8601;\n+import org.apache.commons.io.IOUtils;\n \n /**\n  * <code>InternalValue</code> represents the internal format of a property value.\n@@ -115,7 +116,6 @@ public static InternalValue create(Value value, NamePathResolver resolver, DataS\n             throws ValueFormatException, RepositoryException {\n         switch (value.getType()) {\n             case PropertyType.BINARY:\n-                InternalValue result;\n                 BLOBFileValue blob = null;\n                 if (value instanceof BinaryValueImpl) {\n                     BinaryValueImpl bin = (BinaryValueImpl) value;\n@@ -131,10 +131,24 @@ public static InternalValue create(Value value, NamePathResolver resolver, DataS\n                     }\n                 }\n                 if (blob == null) {\n-                    blob = getBLOBFileValue(store, value.getBinary().getStream(), true);\n+                    Binary b = value.getBinary();\n+                    boolean dispose = false;\n+                    try {\n+                        if (b instanceof BLOBFileValue) {\n+                            // use as is\n+                            blob = (BLOBFileValue) b;\n+                        } else {\n+                            // create a copy from the stream\n+                            dispose = true;\n+                            blob = getBLOBFileValue(store, b.getStream(), true);\n+                        }\n+                    } finally {\n+                        if (dispose) {\n+                            b.dispose();\n+                        }\n+                    }\n                 }\n-                result = new InternalValue(blob);\n-                return result;\n+                return new InternalValue(blob);\n             case PropertyType.BOOLEAN:\n                 return create(value.getBoolean());\n             case PropertyType.DATE:\n@@ -334,7 +348,7 @@ public static InternalValue create(InputStream value, DataStore store) throws Re\n      * @throws RepositoryException\n      */\n     public static InternalValue create(InputStream value) throws RepositoryException {\n-        return new InternalValue(getBLOBFileValue(null, value, false));\n+        return create(value, null);\n     }\n \n     /**\n@@ -432,21 +446,8 @@ public InternalValue createCopy() throws RepositoryException {\n             // wrapped value is immutable (and therefore this instance as well)\n             return this;\n         }\n-        BLOBFileValue v = (BLOBFileValue) val;\n-        if (v.isImmutable()) {\n-            return this;\n-        }\n-        // return a copy since the wrapped BLOBFileValue instance is mutable\n-        InputStream stream = v.getStream();\n-        try {\n-            return createTemporary(stream);\n-        } finally {\n-            try {\n-                stream.close();\n-            } catch (IOException e) {\n-                // ignore\n-            }\n-        }\n+        // return a copy of the wrapped BLOBFileValue\n+        return new InternalValue(((BLOBFileValue) val).copy());\n     }\n \n     /**\n@@ -639,7 +640,7 @@ public void store(DataStore dataStore) throws RepositoryException {\n      */\n     public long getLength() throws RepositoryException {\n         if (PropertyType.BINARY == type) {\n-            return ((BLOBFileValue) val).getSize();\n+            return ((Binary) val).getSize();\n         } else {\n             return super.getLength();\n         }\n@@ -650,7 +651,14 @@ public long getLength() throws RepositoryException {\n      */\n     public String getString() throws RepositoryException {\n         if (type == PropertyType.BINARY) {\n-            return ((BLOBFileValue) val).getString();\n+            InputStream stream = getStream();\n+            try {\n+                return IOUtils.toString(stream, \"UTF-8\");\n+            } catch (IOException e) {\n+                throw new RepositoryException(\"conversion from stream to string failed\", e);\n+            } finally {\n+                IOUtils.closeQuietly(stream);\n+            }\n         } else if (type == PropertyType.DATE) {\n             return ISO8601.format(((Calendar) val));\n         } else {\n@@ -663,7 +671,7 @@ public String getString() throws RepositoryException {\n      */\n     public InputStream getStream() throws RepositoryException {\n         if (type == PropertyType.BINARY) {\n-            return ((BLOBFileValue) val).getStream();\n+            return ((Binary) val).getStream();\n         } else {\n             try {\n                 // convert via string\n@@ -679,7 +687,9 @@ public InputStream getStream() throws RepositoryException {\n      */\n     public Binary getBinary() throws RepositoryException {\n         if (type == PropertyType.BINARY) {\n-            return (BLOBFileValue) val;\n+            // return an independent copy that can be disposed without\n+            // affecting this value\n+            return ((BLOBFileValue) val).copy();\n         } else {\n             try {\n                 // convert via string\n@@ -697,7 +707,7 @@ public Binary getBinary() throws RepositoryException {\n     public void discard() {\n         if (type == PropertyType.BINARY) {\n             BLOBFileValue bfv = (BLOBFileValue) val;\n-            bfv.discard();\n+            bfv.dispose();\n         } else {\n             super.discard();\n         }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValue.java",
                "sha": "9f3b59c334fadaa35918089397c083d1bcaf5764",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValueFactory.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValueFactory.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValueFactory.java",
                "patch": "@@ -150,7 +150,11 @@ public QValue create(byte[] value) throws RepositoryException {\n     }\n \n     public QValue create(InputStream value) throws RepositoryException, IOException {\n-        return InternalValue.create(value, store);\n+        if (store == null) {\n+            return InternalValue.createTemporary(value);\n+        } else {\n+            return InternalValue.create(value, store);\n+        }\n     }\n \n     public QValue create(File value) throws RepositoryException, IOException {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/InternalValueFactory.java",
                "sha": "8d8fc4ab775b668e291974476cf313c80f83dac8",
                "status": "modified"
            },
            {
                "additions": 210,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/RefCountingBLOBFileValue.java",
                "changes": 210,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/RefCountingBLOBFileValue.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/RefCountingBLOBFileValue.java",
                "patch": "@@ -0,0 +1,210 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.value;\n+\n+import java.io.InputStream;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.jcr.RepositoryException;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * <code>RefCountingBLOBFileValue</code> implements a reference counting BLOB\n+ * file value on top of an existing {@link BLOBFileValue}. Whenever a\n+ * {@link #copy()} is created from this BLOB file value, a new light weight\n+ * {@link RefCountBinary} is created and the reference count {@link #refCount}\n+ * is incremented. The underlying value is discarded once this\n+ * {@link RefCountingBLOBFileValue} and all its light weight\n+ * {@link RefCountBinary} intances have been discarded.\n+ */\n+public class RefCountingBLOBFileValue extends BLOBFileValue {\n+\n+    /**\n+     * The logger instance for this class.\n+     */\n+    private static final Logger log = LoggerFactory.getLogger(RefCountingBLOBFileValue.class);\n+\n+    /**\n+     * The actual value.\n+     */\n+    private final BLOBFileValue value;\n+\n+    /**\n+     * The current ref count. Initially set to one.\n+     */\n+    private final AtomicInteger refCount = new AtomicInteger(1);\n+\n+    /**\n+     * Whether this instance has been discarded and cannot be used anymore.\n+     */\n+    private boolean disposed = false;\n+\n+    /**\n+     * Creates a new reference counting blob file value based on the given\n+     * <code>value</code>.\n+     *\n+     * @param value the underlying value.\n+     */\n+    public RefCountingBLOBFileValue(BLOBFileValue value) {\n+        this.value = value;\n+    }\n+\n+    //----------------------------< BLOBFileValue >-----------------------------\n+\n+    /**\n+     * Discards the underyling value if the reference count drops to zero.\n+     */\n+    public void dispose() {\n+        if (refCount.get() > 0) {\n+            if (refCount.decrementAndGet() == 0) {\n+                log.debug(\"{}@refCount={}, discarding value...\",\n+                        System.identityHashCode(this), refCount);\n+                value.dispose();\n+                disposed = true;\n+            } else {\n+                log.debug(\"{}@refCount={}\",\n+                        System.identityHashCode(this), refCount);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Forwards the call to the underlying value.\n+     *\n+     * @param pruneEmptyParentDirs if <code>true</code>, empty parent\n+     *                             directories will automatically be deleted\n+     */\n+    void delete(boolean pruneEmptyParentDirs) {\n+        value.delete(pruneEmptyParentDirs);\n+    }\n+\n+    /**\n+     * Returns a light weight copy of this BLOB file value.\n+     *\n+     * @return a copy of this value.\n+     * @throws RepositoryException if an error occurs while creating the copy or\n+     *                             if this value has been disposed already.\n+     */\n+    BLOBFileValue copy() throws RepositoryException {\n+        if (refCount.get() <= 0) {\n+            throw new RepositoryException(\"this BLOBFileValue has been disposed\");\n+        }\n+        BLOBFileValue bin = new RefCountBinary();\n+        refCount.incrementAndGet();\n+        log.debug(\"{}@refCount={}\", System.identityHashCode(this), refCount);\n+        return bin;\n+    }\n+\n+    public boolean equals(Object obj) {\n+        if (obj instanceof RefCountingBLOBFileValue) {\n+            RefCountingBLOBFileValue val = (RefCountingBLOBFileValue) obj;\n+            return value.equals(val.value);\n+        }\n+        return false;\n+    }\n+\n+    public String toString() {\n+        return value.toString();\n+    }\n+\n+    public int hashCode() {\n+        return 0;\n+    }\n+\n+    //-----------------------------------------------------< javax.jcr.Binary >\n+\n+    public long getSize() throws RepositoryException {\n+        return value.getSize();\n+    }\n+\n+    public InputStream getStream() throws RepositoryException {\n+        return value.getStream();\n+    }\n+\n+    protected void finalize() throws Throwable {\n+        if (!disposed) {\n+            dispose();\n+        }\n+        super.finalize();\n+    }\n+\n+    //------------------------< RefCountBinary >--------------------------------\n+\n+    private final class RefCountBinary extends BLOBFileValue {\n+\n+        private boolean disposed;\n+\n+        public InputStream getStream() throws RepositoryException {\n+            checkDisposed();\n+            return getInternalValue().getStream();\n+        }\n+\n+        public long getSize() throws RepositoryException {\n+            checkDisposed();\n+            return getInternalValue().getSize();\n+        }\n+\n+        public void dispose() {\n+            if (!disposed) {\n+                disposed = true;\n+                getInternalValue().dispose();\n+            }\n+        }\n+\n+        void delete(boolean pruneEmptyParentDirs) {\n+            getInternalValue().delete(pruneEmptyParentDirs);\n+        }\n+\n+        BLOBFileValue copy() throws RepositoryException {\n+            checkDisposed();\n+            return getInternalValue().copy();\n+        }\n+\n+        public boolean equals(Object obj) {\n+            if (obj instanceof RefCountBinary) {\n+                RefCountBinary other = (RefCountBinary) obj;\n+                return getInternalValue().equals(other.getInternalValue());\n+            }\n+            return false;\n+        }\n+\n+        public String toString() {\n+            return getInternalValue().toString();\n+        }\n+\n+        public int hashCode() {\n+            return 0;\n+        }\n+\n+        protected void finalize() throws Throwable {\n+            dispose();\n+            super.finalize();\n+        }\n+\n+        private BLOBFileValue getInternalValue() {\n+            return RefCountingBLOBFileValue.this;\n+        }\n+\n+        private void checkDisposed() throws RepositoryException {\n+            if (disposed) {\n+                throw new RepositoryException(\"this BLOBFileValue is disposed\");\n+            }\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/RefCountingBLOBFileValue.java",
                "sha": "5256ca542a7b3b1f4b6cb6e3651ecbd461dca738",
                "status": "added"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/ValueFactoryImpl.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/ValueFactoryImpl.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/ValueFactoryImpl.java",
                "patch": "@@ -21,6 +21,7 @@\n import org.apache.jackrabbit.spi.commons.conversion.NamePathResolver;\n import org.apache.jackrabbit.spi.commons.value.ValueFactoryQImpl;\n import org.apache.jackrabbit.spi.QValue;\n+import org.apache.jackrabbit.value.BinaryImpl;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -59,7 +60,7 @@ public ValueFactoryImpl(NamePathResolver resolver, DataStore store) {\n     public Value createValue(QValue qvalue) {\n         if (qvalue instanceof InternalValue && PropertyType.BINARY == qvalue.getType()) {\n             try {\n-                return new BinaryValueImpl(((InternalValue) qvalue).getBLOBFileValue());\n+                return new BinaryValueImpl(((InternalValue) qvalue).getBLOBFileValue().copy());\n             } catch (RepositoryException e) {\n                 // should not get here\n                 log.error(e.getMessage(), e);\n@@ -68,6 +69,19 @@ public Value createValue(QValue qvalue) {\n         return super.createValue(qvalue);\n     }\n \n+    public Binary createBinary(InputStream stream) throws RepositoryException {\n+        try {\n+            QValue value = getQValueFactory().create(stream);\n+            if (value instanceof InternalValue) {\n+                return ((InternalValue) value).getBLOBFileValue();\n+            } else {\n+                return new BinaryImpl(stream);\n+            }\n+        } catch (IOException e) {\n+            throw new RepositoryException(e);\n+        }\n+    }\n+\n     public Value createValue(Binary binary) {\n         try {\n             if (binary instanceof BLOBInDataStore) {\n@@ -77,6 +91,8 @@ public Value createValue(Binary binary) {\n                     // if the value is already in this data store\n                     return new BinaryValueImpl(value.getBLOBFileValue());\n                 }\n+            } else if (binary instanceof BLOBFileValue) {\n+                return new BinaryValueImpl(((BLOBFileValue) binary).copy());\n             }\n             return createValue(binary.getStream());\n         } catch (RepositoryException e) {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/value/ValueFactoryImpl.java",
                "sha": "917b25c987412a2821abdc720376f2e3bb51a571",
                "status": "modified"
            },
            {
                "additions": 91,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/BinaryValueTest.java",
                "changes": 91,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/BinaryValueTest.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/BinaryValueTest.java",
                "patch": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.value;\n+\n+import java.io.ByteArrayInputStream;\n+import java.util.Random;\n+\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Property;\n+import javax.jcr.Binary;\n+import javax.jcr.Node;\n+\n+import org.apache.jackrabbit.test.AbstractJCRTest;\n+\n+/**\n+ * <code>BinaryValueTest</code> check if multiple executions of:\n+ * <ul>\n+ * <li>get Binary from property</li>\n+ * <li>read from Binary</li>\n+ * <li>dispose Binary</li>\n+ * </ul>\n+ * do not throw an exception.\n+ * <p/>\n+ * See also JCR-2238.\n+ */\n+public class BinaryValueTest extends AbstractJCRTest {\n+\n+    public void testDispose10() throws Exception {\n+        checkDispose(10, false);\n+    }\n+\n+    public void testDispose10k() throws Exception {\n+        checkDispose(10 * 1024, false);\n+    }\n+\n+    public void testDispose10Save() throws Exception {\n+        checkDispose(10, true);\n+    }\n+\n+    public void testDispose10kSave() throws Exception {\n+        checkDispose(10 * 1024, true);\n+    }\n+\n+    protected void checkDispose(int length, boolean save) throws Exception {\n+        Property prop = setProperty(testRootNode.addNode(nodeName1), length);\n+        if (save) {\n+            superuser.save();\n+        }\n+        checkProperty(prop);\n+    }\n+\n+    protected Property setProperty(Node node, int length) throws RepositoryException {\n+        Random rand = new Random();\n+        byte[] data = new byte[length];\n+        rand.nextBytes(data);\n+\n+        Binary b = vf.createBinary(new ByteArrayInputStream(data));\n+        //System.out.println(b.getClass() + \": \" + System.identityHashCode(b));\n+        try {\n+            return node.setProperty(propertyName1, b);\n+        } finally {\n+            b.dispose();\n+        }\n+    }\n+\n+    protected void checkProperty(Property prop) throws Exception {\n+        for (int i = 0; i < 3; i++) {\n+            Binary b = prop.getBinary();\n+            try {\n+                //System.out.println(b.getClass() + \": \" + System.identityHashCode(b));\n+                b.read(new byte[1], 0);\n+            } finally {\n+                b.dispose();\n+            }\n+        }\n+    }\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/BinaryValueTest.java",
                "sha": "9e0edd0f0cf445845b133ca4ec531800712ffcfb",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/TestAll.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/TestAll.java?ref=55700358113308bb81a09c0b3cea28df83a59ba9",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/TestAll.java",
                "patch": "@@ -32,6 +32,7 @@\n     public static Test suite() {\n         TestSuite suite = new TestSuite(\"org.apache.jackrabbit.core.value tests\");\n \n+        suite.addTestSuite(BinaryValueTest.class);\n         suite.addTestSuite(InternalValueFactoryTest.class);\n         suite.addTestSuite(InternalValueTest.class);\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/55700358113308bb81a09c0b3cea28df83a59ba9/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/value/TestAll.java",
                "sha": "9908963eb984b225eeb9b4e1983a87e60ae7c517",
                "status": "modified"
            }
        ],
        "message": "JCR-2238: Binary throws NullPointerException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@802676 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/bb679e0b074203f67d645ae81bf39ce3b8493d12",
        "patched_files": [
            "ValueFactoryImpl.java",
            "InternalValueFactory.java",
            "RefCountingBLOBFileValue.java",
            "BLOBFileValue.java",
            "BLOBInResource.java",
            "BLOBInTempFile.java",
            "BinaryValue.java",
            "InternalValue.java",
            "BLOBInMemory.java",
            "BLOBInDataStore.java",
            "PropertyImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "InternalValueTest.java",
            "TestAll.java",
            "InternalValueFactoryTest.java",
            "BinaryValueTest.java"
        ]
    },
    "jackrabbit_6251ae0": {
        "bug_id": "jackrabbit_6251ae0",
        "commit": "https://github.com/apache/jackrabbit/commit/6251ae013f83502b63a5ca7b88e50af8104c4a79",
        "file": [
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/6251ae013f83502b63a5ca7b88e50af8104c4a79/src/java/org/apache/jackrabbit/core/NodeImpl.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/NodeImpl.java?ref=6251ae013f83502b63a5ca7b88e50af8104c4a79",
                "deletions": 1,
                "filename": "src/java/org/apache/jackrabbit/core/NodeImpl.java",
                "patch": "@@ -1617,12 +1617,14 @@ public boolean isNode() {\n      * {@inheritDoc}\n      */\n     public String getName() throws RepositoryException {\n+        // check state of this instance\n+        sanityCheck();\n+\n         if (state.getParentUUID() == null) {\n             // this is the root node\n             return \"\";\n         }\n \n-        //QName name = getPrimaryPath().getNameElement().getName();\n         QName name = session.getHierarchyManager().getName(id);\n         try {\n             return name.toJCRName(session.getNamespaceResolver());",
                "raw_url": "https://github.com/apache/jackrabbit/raw/6251ae013f83502b63a5ca7b88e50af8104c4a79/src/java/org/apache/jackrabbit/core/NodeImpl.java",
                "sha": "5f4fb7aa9d03f5bb38a208be0b6a554849c8a1e3",
                "status": "modified"
            }
        ],
        "message": "calling Node.getName() on disposed instance could throw NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@160858 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/105b3b1d3496786cd85305e462d208edf66d1ca9",
        "patched_files": [
            "NodeImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "NodeImplTest.java"
        ]
    },
    "jackrabbit_661cb4d": {
        "bug_id": "jackrabbit_661cb4d",
        "commit": "https://github.com/apache/jackrabbit/commit/661cb4d47fb3926439ddc253c32426c058ba6102",
        "file": [
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/jackrabbit/blob/661cb4d47fb3926439ddc253c32426c058ba6102/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/FileDataStore.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/FileDataStore.java?ref=661cb4d47fb3926439ddc253c32426c058ba6102",
                "deletions": 4,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/FileDataStore.java",
                "patch": "@@ -324,15 +324,21 @@ private int deleteOlderRecursive(File file, long min) {\n                 }\n             }\n         } else if (file.isDirectory()) {\n-            for (File f: file.listFiles()) {\n-                count += deleteOlderRecursive(f, min);\n+            File[] list = file.listFiles();\n+            if (list != null) {\n+                for (File f: list) {\n+                    count += deleteOlderRecursive(f, min);\n+                }\n             }\n \n             // JCR-1396: FileDataStore Garbage Collector and empty directories\n             // Automatic removal of empty directories (but not the root!)\n             synchronized (this) {\n-                if (file != directory && file.list().length == 0) {\n-                    file.delete();\n+                if (file != directory) {\n+                    list = file.listFiles();\n+                    if (list != null && list.length == 0) {\n+                        file.delete();\n+                    }\n                 }\n             }\n         }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/661cb4d47fb3926439ddc253c32426c058ba6102/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/FileDataStore.java",
                "sha": "c878ecc655b9cc5066067909ca208a0e4b5f261b",
                "status": "modified"
            }
        ],
        "message": "JCR-2969 FileDataStore garbage collection can throw a NullPointerException if there is I/O problem\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1102601 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/c12b0efa8eefe59856e5f42ba9c431b573f7eac5",
        "patched_files": [
            "FileDataStore.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TestFileDataStore.java"
        ]
    },
    "jackrabbit_69e80ad": {
        "bug_id": "jackrabbit_69e80ad",
        "commit": "https://github.com/apache/jackrabbit/commit/69e80ad8fa1f9466c666933892e0810596058afe",
        "file": [
            {
                "additions": 15,
                "blob_url": "https://github.com/apache/jackrabbit/blob/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/pom.xml",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/pom.xml?ref=69e80ad8fa1f9466c666933892e0810596058afe",
                "deletions": 0,
                "filename": "jackrabbit-jcr-server/pom.xml",
                "patch": "@@ -45,6 +45,21 @@\n     <url>http://svn.apache.org/viewvc/jackrabbit/trunk/jackrabbit-jcr-server</url>\n   </scm>\n \n+  <build>\n+    <plugins>\n+      <plugin>\n+        <artifactId>maven-surefire-plugin</artifactId>\n+        <configuration>\n+          <includes>\n+            <include>**/*Test.java</include>\n+          </includes>\n+          <forkMode>once</forkMode>\n+          <argLine>-Xmx128m -enableassertions</argLine>\n+        </configuration>\n+      </plugin>\n+    </plugins>\n+  </build>\n+\n   <dependencies>\n     <dependency>\n       <groupId>javax.jcr</groupId>",
                "raw_url": "https://github.com/apache/jackrabbit/raw/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/pom.xml",
                "sha": "5f3053c21c6e2b8e70e657ff12249e2312c1c9a3",
                "status": "modified"
            },
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/jackrabbit/blob/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/JcrDavException.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/JcrDavException.java?ref=69e80ad8fa1f9466c666933892e0810596058afe",
                "deletions": 6,
                "filename": "jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/JcrDavException.java",
                "patch": "@@ -44,7 +44,10 @@\n import javax.jcr.nodetype.NoSuchNodeTypeException;\n import javax.jcr.query.InvalidQueryException;\n import javax.jcr.version.VersionException;\n-import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.LinkedHashMap;\n+\n \n /**\n  * <code>JcrDavException</code> extends the {@link DavException} in order to\n@@ -54,8 +57,8 @@\n \n     private static Logger log = LoggerFactory.getLogger(JcrDavException.class);\n \n-    // mapping of Jcr exceptions to error codes.\n-    private static HashMap codeMap = new HashMap();\n+    // ordered mapping of Jcr exceptions to error codes.\n+    private static Map codeMap = new LinkedHashMap(20);\n     static {\n         codeMap.put(AccessDeniedException.class, new Integer(DavServletResponse.SC_FORBIDDEN));\n         codeMap.put(ConstraintViolationException.class, new Integer(DavServletResponse.SC_CONFLICT));\n@@ -71,13 +74,30 @@\n         codeMap.put(NoSuchWorkspaceException.class, new Integer(DavServletResponse.SC_CONFLICT));\n         codeMap.put(PathNotFoundException.class, new Integer(DavServletResponse.SC_CONFLICT));\n         codeMap.put(ReferentialIntegrityException.class, new Integer(DavServletResponse.SC_CONFLICT));\n-        codeMap.put(RepositoryException.class, new Integer(DavServletResponse.SC_FORBIDDEN));\n         codeMap.put(LoginException.class, new Integer(DavServletResponse.SC_UNAUTHORIZED));\n         codeMap.put(UnsupportedRepositoryOperationException.class, new Integer(DavServletResponse.SC_NOT_IMPLEMENTED));\n         codeMap.put(ValueFormatException.class, new Integer(DavServletResponse.SC_CONFLICT));\n         codeMap.put(VersionException.class, new Integer(DavServletResponse.SC_CONFLICT));\n+        codeMap.put(RepositoryException.class, new Integer(DavServletResponse.SC_FORBIDDEN));\n     }\n \n+    private static int lookupErrorCode(Class exceptionClass) {\n+        Integer code = (Integer) codeMap.get(exceptionClass);\n+        if (code == null) {\n+            for (Iterator it = codeMap.keySet().iterator(); it.hasNext();) {\n+                Class jcrExceptionClass = (Class) it.next();\n+                if (jcrExceptionClass.isAssignableFrom(exceptionClass)) {\n+                    code = (Integer) codeMap.get(jcrExceptionClass);\n+                    break;\n+                }\n+            }\n+            if (code == null) {\n+                code = new Integer(DavServletResponse.SC_FORBIDDEN); // fallback\n+            }\n+        }\n+        return code.intValue();\n+    }\n+    \n     private Class exceptionClass;\n \n     /**\n@@ -108,7 +128,7 @@ public JcrDavException(Throwable cause, int errorCode) {\n      * @see JcrDavException#JcrDavException(Throwable, int)\n      */\n     public JcrDavException(RepositoryException cause) {\n-        this(cause, ((Integer)codeMap.get(cause.getClass())).intValue());\n+        this(cause, lookupErrorCode(cause.getClass()));\n     }\n \n     /**\n@@ -136,4 +156,4 @@ public Element toXml(Document document) {\n         error.appendChild(excep);\n         return error;\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/webdav/jcr/JcrDavException.java",
                "sha": "ab67e696c835ed16c5e03bb4f9e02ba1506ed968",
                "status": "modified"
            },
            {
                "additions": 54,
                "blob_url": "https://github.com/apache/jackrabbit/blob/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/webdav/jcr/JcrDavExceptionTest.java",
                "changes": 54,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/webdav/jcr/JcrDavExceptionTest.java?ref=69e80ad8fa1f9466c666933892e0810596058afe",
                "deletions": 0,
                "filename": "jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/webdav/jcr/JcrDavExceptionTest.java",
                "patch": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.webdav.jcr;\n+\n+import junit.framework.TestCase;\n+\n+import javax.jcr.lock.LockException;\n+import javax.jcr.RepositoryException;\n+\n+/** <code>JcrDavExceptionTest</code>... */\n+public class JcrDavExceptionTest extends TestCase {\n+\n+    public void testDerivedException() {\n+        RepositoryException re = new DerievedRepositoryException();\n+\n+        // creating JcrDavException from the derived exception must not throw\n+        // NPE (see issue https://issues.apache.org/jira/browse/JCR-1678)\n+        JcrDavException jde = new JcrDavException(re);\n+\n+        // error code must be the same as for LockException\n+        assertEquals(new JcrDavException(new LockException()).getErrorCode(),\n+                     jde.getErrorCode());\n+    }\n+\n+    public void testNullException() {\n+        try {\n+            new JcrDavException(null);\n+            fail(\"Should throw NPE\");\n+        } catch (NullPointerException e) {\n+            // as documented in the javadoc\n+        }\n+    }\n+\n+    /**\n+     * Derived exception that does not extend from RepositoryException, which\n+     * returns the 'default' error code.\n+     */\n+    private static final class DerievedRepositoryException extends LockException {\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/jackrabbit/raw/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/webdav/jcr/JcrDavExceptionTest.java",
                "sha": "fcf13989892aacb5945aa0ea0db373968a50f2b4",
                "status": "added"
            },
            {
                "additions": 34,
                "blob_url": "https://github.com/apache/jackrabbit/blob/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/src/test/resources/log4j.properties",
                "changes": 34,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/test/resources/log4j.properties?ref=69e80ad8fa1f9466c666933892e0810596058afe",
                "deletions": 0,
                "filename": "jackrabbit-jcr-server/src/test/resources/log4j.properties",
                "patch": "@@ -0,0 +1,34 @@\n+#  Licensed to the Apache Software Foundation (ASF) under one or more\n+#  contributor license agreements.  See the NOTICE file distributed with\n+#  this work for additional information regarding copyright ownership.\n+#  The ASF licenses this file to You under the Apache License, Version 2.0\n+#  (the \"License\"); you may not use this file except in compliance with\n+#  the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#  Unless required by applicable law or agreed to in writing, software\n+#  distributed under the License is distributed on an \"AS IS\" BASIS,\n+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#  See the License for the specific language governing permissions and\n+#  limitations under the License.\n+\n+# Set root logger level to INFO and its only appender to file.\n+log4j.rootLogger=INFO, file\n+#log4j.rootLogger=DEBUG, stdout, file\n+#log4j.rootLogger=ERROR, stdout, file\n+\n+# 'stdout' is set to be a ConsoleAppender.\n+log4j.appender.stdout=org.apache.log4j.ConsoleAppender\n+\n+# 'stdout' uses PatternLayout\n+log4j.appender.stdout.layout=org.apache.log4j.PatternLayout\n+log4j.appender.stdout.layout.ConversionPattern=%d{dd.MM.yyyy HH:mm:ss} *%-5p* [%t] %c{1}: %m (%F, line %L)\\n\n+\n+# 'file' is set to be a FileAppender.\n+log4j.appender.file=org.apache.log4j.FileAppender\n+log4j.appender.file.File=target/jcr.log\n+\n+# 'file' uses PatternLayout.\n+log4j.appender.file.layout=org.apache.log4j.PatternLayout\n+log4j.appender.file.layout.ConversionPattern=%d{dd.MM.yyyy HH:mm:ss} *%-5p* [%t] %c{1}: %m (%F, line %L)\\n",
                "raw_url": "https://github.com/apache/jackrabbit/raw/69e80ad8fa1f9466c666933892e0810596058afe/jackrabbit-jcr-server/src/test/resources/log4j.properties",
                "sha": "70eb1148e6dd7cc5604edf46135ea8b5aca9f3a4",
                "status": "added"
            }
        ],
        "message": "JCR-1678: NullPointerException in constructor of JcrDavException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@677893 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/afc54fccfbc74d9cd656dc0f41c48f1b1b18dc9a",
        "patched_files": [
            "log4j.java",
            "JcrDavException.java",
            "pom.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "JcrDavExceptionTest.java"
        ]
    },
    "jackrabbit_6f86c84": {
        "bug_id": "jackrabbit_6f86c84",
        "commit": "https://github.com/apache/jackrabbit/commit/6f86c84fc59da1cb9c54ff659a6bbbfc25c64498",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/6f86c84fc59da1cb9c54ff659a6bbbfc25c64498/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java?ref=6f86c84fc59da1cb9c54ff659a6bbbfc25c64498",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java",
                "patch": "@@ -43,7 +43,7 @@\n     /**\n      * the id's of the versions to return\n      */\n-    private LinkedList<NodeId> versions = new LinkedList<NodeId>();\n+    private final LinkedList<NodeId> versions = new LinkedList<NodeId>();\n \n     /**\n      * the current position",
                "raw_url": "https://github.com/apache/jackrabbit/raw/6f86c84fc59da1cb9c54ff659a6bbbfc25c64498/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionIteratorImpl.java",
                "sha": "7d2df985c5d0f05dfb89633dfc04a0125fc91b2f",
                "status": "modified"
            }
        ],
        "message": "JCR-2655: initVersions crashes with NPE\n\nMake an unmodified variable final.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1032621 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/828e730f556c83e9dbc46384383d6f3081b316f1",
        "patched_files": [
            "VersionIteratorImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "VersionIteratorImplTest.java"
        ]
    },
    "jackrabbit_7134e3f": {
        "bug_id": "jackrabbit_7134e3f",
        "commit": "https://github.com/apache/jackrabbit/commit/7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea",
        "file": [
            {
                "additions": 34,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingQueue.java",
                "changes": 35,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingQueue.java?ref=7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingQueue.java",
                "patch": "@@ -52,13 +52,30 @@\n      */\n     private final Map pendingDocuments = new HashMap();\n \n+    /**\n+     * Flag that indicates whether this indexing queue had been\n+     * {@link #initialize(MultiIndex) initialized}.\n+     */\n+    private volatile boolean initialized = false;\n+\n     /**\n      * Creates an indexing queue.\n      *\n      * @param queueStore the store where to read the pending extraction jobs.\n      */\n-    IndexingQueue(IndexingQueueStore queueStore, MultiIndex index) {\n+    IndexingQueue(IndexingQueueStore queueStore) {\n         this.queueStore = queueStore;\n+    }\n+\n+    /**\n+     * Initializes the indexing queue.\n+     *\n+     * @param index the multi index this indexing queue belongs to.\n+     */\n+    void initialize(MultiIndex index) {\n+        if (initialized) {\n+            throw new IllegalStateException(\"already initialized\");\n+        }\n         String[] uuids = queueStore.getPending();\n         for (int i = 0; i < uuids.length; i++) {\n             try {\n@@ -78,6 +95,7 @@\n                 }\n             }\n         }\n+        initialized = true;\n     }\n \n     /**\n@@ -86,6 +104,7 @@\n      * @return the {@link Document}s that are finished.\n      */\n     public Document[] getFinishedDocuments() {\n+        checkInitialized();\n         List finished = new ArrayList();\n         synchronized (this) {\n             finished.addAll(pendingDocuments.values());\n@@ -113,6 +132,7 @@\n      *                     queue.\n      */\n     public synchronized Document removeDocument(String uuid) throws IOException {\n+        checkInitialized();\n         Document doc = (Document) pendingDocuments.remove(uuid);\n         if (doc != null) {\n             queueStore.removeUUID(uuid);\n@@ -133,6 +153,7 @@ public synchronized Document removeDocument(String uuid) throws IOException {\n      *                     queue.\n      */\n     public synchronized Document addDocument(Document doc) throws IOException {\n+        checkInitialized();\n         String uuid = doc.get(FieldNames.UUID);\n         Document existing = (Document) pendingDocuments.put(uuid, doc);\n         log.debug(\"added node {}. New size of indexing queue: {}\",\n@@ -151,6 +172,7 @@ public synchronized Document addDocument(Document doc) throws IOException {\n      * @throws IOException if an error occurs while closing this queue.\n      */\n     public synchronized void close() throws IOException {\n+        checkInitialized();\n         // go through pending documents and close readers\n         Iterator it = pendingDocuments.values().iterator();\n         while (it.hasNext()) {\n@@ -168,6 +190,17 @@ public synchronized void close() throws IOException {\n      *                     disk.\n      */\n     public synchronized void commit() throws IOException {\n+        checkInitialized();\n         queueStore.commit();\n     }\n+\n+    /**\n+     * Checks if this indexing queue is initialized and otherwise throws a\n+     * {@link IllegalStateException}.\n+     */\n+    private void checkInitialized() {\n+        if (!initialized) {\n+            throw new IllegalStateException(\"not initialized\");\n+        }\n+    }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingQueue.java",
                "sha": "c20c3d9cce97a373639259c4b92088eb330c35dc",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/MultiIndex.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/MultiIndex.java?ref=7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/MultiIndex.java",
                "patch": "@@ -261,7 +261,7 @@\n         }\n \n         // initialize indexing queue\n-        this.indexingQueue = new IndexingQueue(store, this);\n+        this.indexingQueue = new IndexingQueue(store);\n \n         // open persistent indexes\n         for (int i = 0; i < indexNames.size(); i++) {\n@@ -298,6 +298,8 @@\n             reader.close();\n         }\n \n+        indexingQueue.initialize(this);\n+\n         redoLogApplied = redoLog.hasEntries();\n \n         // run recovery",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7134e3f76dfd3008c0e36fd8bf6ce2eb774ebeea/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/MultiIndex.java",
                "sha": "d0ecec3b7b8f2ec79c28eb381bbc2ae24b1a223c",
                "status": "modified"
            }
        ],
        "message": "JCR-1459: NullPointerException on startup if IndexingQueue has pending nodes\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@634632 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/87ebddcf0ecdec7b8c7864c9bd1d4427f827b04c",
        "patched_files": [
            "IndexingQueue.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "IndexingQueueTest.java"
        ]
    },
    "jackrabbit_7280250": {
        "bug_id": "jackrabbit_7280250",
        "commit": "https://github.com/apache/jackrabbit/commit/7280250cac441584c513a16937724b2adbbbfd87",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7280250cac441584c513a16937724b2adbbbfd87/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java?ref=7280250cac441584c513a16937724b2adbbbfd87",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java",
                "patch": "@@ -328,7 +328,7 @@ private NodeImpl getTokenParent(User user) throws RepositoryException {\n                     }\n                 }\n             } else {\n-                log.debug(\"Cannot create login token: No corresponding node for User {}.\", user.getID());\n+                log.debug(\"Cannot create login token: No user specified. (null)\");\n             }\n         } catch (RepositoryException e) {\n             // conflict while creating token store for this user -> refresh and",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7280250cac441584c513a16937724b2adbbbfd87/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authentication/token/TokenProvider.java",
                "sha": "50666a2c1043303017427b5a102a819f9ef0cfe9",
                "status": "modified"
            }
        ],
        "message": "fix NPE on error path when user is null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1577995 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/3d86c4ec5bb5a274ffc24362d28f0bcb23adacc9",
        "patched_files": [
            "TokenProvider.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TokenProviderTest.java"
        ]
    },
    "jackrabbit_75e67c5": {
        "bug_id": "jackrabbit_75e67c5",
        "commit": "https://github.com/apache/jackrabbit/commit/75e67c5a35528f59729af55345b8428e7999951a",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java?ref=75e67c5a35528f59729af55345b8428e7999951a",
                "deletions": 1,
                "filename": "jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java",
                "patch": "@@ -634,7 +634,10 @@ private QValue buildQValue(TextValue tv, int targetType, NamePathResolver resolv\n     private void checkIncludesMixReferenceable(Importer.NodeInfo nodeInfo) throws RepositoryException {\n         List l = new ArrayList();\n         l.add(nodeInfo.getNodeTypeName());\n-        l.addAll(Arrays.asList(nodeInfo.getMixinNames()));\n+        Name[] mixinNames = nodeInfo.getMixinNames();\n+        if (mixinNames != null && mixinNames.length > 0) {\n+            l.addAll(Arrays.asList(nodeInfo.getMixinNames()));\n+        }\n         if (l.contains(NameConstants.MIX_REFERENCEABLE)) {\n             // shortcut\n             return;",
                "raw_url": "https://github.com/apache/jackrabbit/raw/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/xml/SessionImporter.java",
                "sha": "c8a2d55c61e2d061670dfa6a2dc93bd5b0f14a7e",
                "status": "modified"
            },
            {
                "additions": 79,
                "blob_url": "https://github.com/apache/jackrabbit/blob/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java",
                "changes": 86,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java?ref=75e67c5a35528f59729af55345b8428e7999951a",
                "deletions": 7,
                "filename": "jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java",
                "patch": "@@ -16,21 +16,26 @@\n  */\n package org.apache.jackrabbit.jcr2spi.xml;\n \n-import org.apache.jackrabbit.test.AbstractJCRTest;\n-import org.apache.jackrabbit.spi.Name;\n import org.apache.jackrabbit.JcrConstants;\n+import org.apache.jackrabbit.spi.Name;\n+import org.apache.jackrabbit.test.AbstractJCRTest;\n+import org.apache.jackrabbit.uuid.UUID;\n import org.xml.sax.ContentHandler;\n import org.xml.sax.SAXException;\n import org.xml.sax.helpers.AttributesImpl;\n \n-import javax.jcr.RepositoryException;\n import javax.jcr.ImportUUIDBehavior;\n-import javax.jcr.PropertyType;\n-import javax.jcr.Session;\n import javax.jcr.Item;\n import javax.jcr.Property;\n-import java.util.List;\n+import javax.jcr.PropertyType;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Session;\n+import javax.jcr.nodetype.ConstraintViolationException;\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n import java.util.Arrays;\n+import java.util.List;\n \n /**\n  * <code>SessionImportTest</code>...\n@@ -108,6 +113,73 @@ public void testImportNameValueWithUnregisteredNamespace() throws RepositoryExce\n         superuser.save();\n     }\n \n+    /**\n+     * Test case for issue <a href=\"https://issues.apache.org/jira/browse/JCR-1857\">JCR-1857</href>\n+     *\n+     * @throws IOException\n+     * @throws RepositoryException\n+     */\n+    public void testEmptyMixins() throws IOException, RepositoryException {\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\" +\n+                \"<sv:node xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\"\\n\" +\n+                \"         xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\"\\n\" +\n+                \"         xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\"\\n\" +\n+                \"         xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\"\\n\" +\n+                \"         sv:name=\\\"testnode1\\\">\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\">\\n\" +\n+                \"        <sv:value>nt:unstructured</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:title\\\" sv:type=\\\"String\\\">\\n\" +\n+                \"        <sv:value>Test Node</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:uuid\\\" sv:type=\\\"String\\\">\\n\" +\n+                \"        <sv:value>1234</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"</sv:node>\";\n+\n+        InputStream in = new ByteArrayInputStream(xml.getBytes());\n+        try {\n+            superuser.importXML(testRootNode.getPath(), in, ImportUUIDBehavior.IMPORT_UUID_COLLISION_THROW);\n+            fail(\"jcr:uuid cannot be created if mix:referenceable is not part of the effective nodetype.\");\n+        } catch (ConstraintViolationException e) {\n+            // ok.\n+        }\n+    }\n+\n+    /**\n+     * Test case for issue <a href=\"https://issues.apache.org/jira/browse/JCR-1857\">JCR-1857</href>\n+     *\n+     * @throws IOException\n+     * @throws RepositoryException\n+     */\n+    public void testEmptyMixins2() throws IOException, RepositoryException {\n+        /*\n+        JSR 170: nt:resource includes mix:referenceable\n+        TODO: tests needs to be adjusted for JSR 283 (-> define test-property)\n+        */\n+        String referenceableNt = \"nt:resource\";\n+        /*\n+        TODO: retrieve valid jcr:uuid value from test-properties.\n+        */\n+        String uuid = UUID.randomUUID().toString();\n+        String xml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\" +\n+                \"<sv:node xmlns:nt=\\\"http://www.jcp.org/jcr/nt/1.0\\\"\\n\" +\n+                \"         xmlns:sv=\\\"http://www.jcp.org/jcr/sv/1.0\\\"\\n\" +\n+                \"         xmlns:mix=\\\"http://www.jcp.org/jcr/mix/1.0\\\"\\n\" +\n+                \"         xmlns:jcr=\\\"http://www.jcp.org/jcr/1.0\\\"\\n\" +\n+                \"         sv:name=\\\"testnode1\\\">\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:primaryType\\\" sv:type=\\\"Name\\\">\\n\" +\n+                \"        <sv:value>\" + referenceableNt + \"</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"    <sv:property sv:name=\\\"jcr:uuid\\\" sv:type=\\\"String\\\">\\n\" +\n+                \"        <sv:value>\" + uuid + \"</sv:value>\\n\" +\n+                \"    </sv:property>\\n\" +\n+                \"</sv:node>\";\n+\n+        InputStream in = new ByteArrayInputStream(xml.getBytes());\n+        superuser.importXML(testRootNode.getPath(), in, ImportUUIDBehavior.IMPORT_UUID_COLLISION_THROW);\n+    }\n+\n     private static String getUnknownURI(Session session, String uriHint) throws RepositoryException {\n         String uri = uriHint;\n         int index = 0;\n@@ -122,7 +194,7 @@ private static String getUnknownURI(Session session, String uriHint) throws Repo\n     /**\n      * Returns a prefix that is unique among the already registered prefixes.\n      *\n-     * @param uriHint namespace uri that serves as hint for the prefix generation\n+     * @param session\n      * @return a unique prefix\n      */\n     public static String getUniquePrefix(Session session) throws RepositoryException {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/75e67c5a35528f59729af55345b8428e7999951a/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/xml/SessionImportTest.java",
                "sha": "a8bb3430b7a8dfbf8b4b5055bbd56558a2b0f98b",
                "status": "modified"
            }
        ],
        "message": "JCR-1857: NPE with SessionImporter#checkIncludesMixReferenceable if NodeInfo doesn't contain mixin names\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@714034 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/b88ddc6c2057a1b66c56304b78d487c999cd7767",
        "patched_files": [
            "SessionImporter.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "SessionImportTest.java"
        ]
    },
    "jackrabbit_787e2fc": {
        "bug_id": "jackrabbit_787e2fc",
        "commit": "https://github.com/apache/jackrabbit/commit/787e2fca5b8e1176299dfa3e95d6d437fa8e7433",
        "file": [
            {
                "additions": 79,
                "blob_url": "https://github.com/apache/jackrabbit/blob/787e2fca5b8e1176299dfa3e95d6d437fa8e7433/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/LazyFileInputStream.java",
                "changes": 120,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/LazyFileInputStream.java?ref=787e2fca5b8e1176299dfa3e95d6d437fa8e7433",
                "deletions": 41,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/LazyFileInputStream.java",
                "patch": "@@ -17,13 +17,12 @@\n package org.apache.jackrabbit.core.data;\n \n import java.io.File;\n+import java.io.FileDescriptor;\n import java.io.FileInputStream;\n import java.io.FileNotFoundException;\n import java.io.IOException;\n \n import org.apache.commons.io.input.AutoCloseInputStream;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n \n /**\n  * This input stream delays opening the file until the first byte is read, and\n@@ -32,7 +31,10 @@\n  */\n public class LazyFileInputStream extends AutoCloseInputStream {\n \n-    private static Logger log = LoggerFactory.getLogger(LazyFileInputStream.class);\n+    /**\n+     * The file descriptor to use.\n+     */\n+    protected final FileDescriptor fd;\n \n     /**\n      * The file to read from.\n@@ -47,83 +49,119 @@\n     protected boolean opened;\n \n     /**\n-     * Create a lazy input stream for the given file.\n+     * Creates a new <code>LazyFileInputStream</code> for the given file. If the\n+     * file is unreadable, a FileNotFoundException is thrown.\n      * The file is not opened until the first byte is read from the stream.\n-     * \n+     *\n      * @param file the file\n+     * @throws java.io.FileNotFoundException\n      */\n-    public LazyFileInputStream(File file) throws FileNotFoundException {\n+    public LazyFileInputStream(File file)\n+            throws FileNotFoundException {\n         super(null);\n         if (!file.canRead()) {\n             throw new FileNotFoundException(file.getPath());\n-        }        \n+        }\n         this.file = file;\n+        this.fd = null;\n+    }\n+\n+    /**\n+     * Creates a new <code>LazyFileInputStream</code> for the given file\n+     * descriptor.\n+     * The file is not opened until the first byte is read from the stream.\n+     *\n+     * @param fdObj\n+     */\n+    public LazyFileInputStream(FileDescriptor fd) {\n+        super(null);\n+        this.file = null;\n+        this.fd = fd;\n+    }\n+\n+    /**\n+     * Creates a new <code>LazyFileInputStream</code> for the given file. If the\n+     * file is unreadable, a FileNotFoundException is thrown.\n+     *\n+     * @param name\n+     * @throws java.io.FileNotFoundException\n+     */\n+    public LazyFileInputStream(String name) throws FileNotFoundException {\n+        this(new File(name));\n     }\n \n     /**\n      * Open the stream if required.\n-     * \n-     * @throws IOException\n+     *\n+     * @throws java.io.IOException\n      */\n-    protected void openStream() throws IOException {\n+    protected void open() throws IOException {\n         if (!opened) {\n             opened = true;\n-            in = new FileInputStream(file);\n+            if (fd != null) {\n+                in = new FileInputStream(fd);\n+            } else {\n+                in = new FileInputStream(file);\n+            }\n         }\n     }\n-    \n+\n     public int read() throws IOException {\n-        openStream();\n+        open();\n         return super.read();\n     }\n \n-    public int read(byte[] b) throws IOException {\n-        return read(b, 0, b.length);\n-    }\n-\n-    public int read(byte[] b, int off, int len) throws IOException {\n-        openStream();\n-        return super.read(b, off, len);\n+    public int available() throws IOException {\n+        open();\n+        return super.available();\n     }\n \n     public void close() throws IOException {\n         // make sure the file is not opened afterwards\n         opened = true;\n-        super.close();\n+        \n+        // only close the file if it was in fact opened\n+        if (in != null) {\n+            super.close();\n+        }\n     }\n \n-    public long skip(long n) throws IOException {\n-        openStream();\n-        return super.skip(n);\n+    public synchronized void reset() throws IOException {\n+        open();\n+        super.reset();\n     }\n \n-    public int available() throws IOException {\n-        openStream();\n-        return super.available();\n+    public boolean markSupported() {\n+        try {\n+            open();\n+        } catch (IOException e) {\n+            throw new IllegalStateException(e.toString());\n+        }\n+        return super.markSupported();\n     }\n \n-    public void mark(int readlimit) {\n+    public synchronized void mark(int readlimit) {\n         try {\n-            openStream();\n+            open();\n         } catch (IOException e) {\n-            log.info(\"Error getting underlying stream: \", e);\n+            throw new IllegalStateException(e.toString());\n         }\n         super.mark(readlimit);\n     }\n \n-    public void reset() throws IOException {\n-        openStream();\n-        super.reset();\n+    public long skip(long n) throws IOException {\n+        open();\n+        return super.skip(n);\n     }\n \n-    public boolean markSupported() {\n-        try {\n-            openStream();\n-        } catch (IOException e) {\n-            log.info(\"Error getting underlying stream: \", e);\n-            return false;\n-        }\n-        return super.markSupported();\n+    public int read(byte[] b) throws IOException {\n+        open();\n+        return super.read(b, 0, b.length);\n+    }\n+\n+    public int read(byte[] b, int off, int len) throws IOException {\n+        open();\n+        return super.read(b, off, len);\n     }\n \n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/787e2fca5b8e1176299dfa3e95d6d437fa8e7433/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/data/LazyFileInputStream.java",
                "sha": "2741966a89b59d6416ea4477f84a359dd3e150d5",
                "status": "modified"
            },
            {
                "additions": 143,
                "blob_url": "https://github.com/apache/jackrabbit/blob/787e2fca5b8e1176299dfa3e95d6d437fa8e7433/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/LazyFileInputStreamTest.java",
                "changes": 143,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/LazyFileInputStreamTest.java?ref=787e2fca5b8e1176299dfa3e95d6d437fa8e7433",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/LazyFileInputStreamTest.java",
                "patch": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.data;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.RandomAccessFile;\n+\n+import org.apache.jackrabbit.test.JUnitTest;\n+\n+/**\n+ * Tests the LazyFileInputStream class.\n+ */\n+public class LazyFileInputStreamTest extends JUnitTest {\n+    \n+    private static final String TEST_FILE = \"target/test.txt\";\n+    \n+    private File file = new File(TEST_FILE);\n+\n+    public void setUp() {\n+        // Create the test directory\n+        new File(TEST_FILE).getParentFile().mkdirs();\n+    }\n+    \n+    public void tearDown() {\n+        new File(TEST_FILE).delete();\n+    }\n+    \n+    private void createFile() throws IOException {\n+        FileOutputStream out = new FileOutputStream(file);\n+        out.write(new byte[1]);\n+        out.close();\n+    }    \n+    \n+    public void test() throws IOException {\n+        \n+        createFile();\n+        \n+        // test exception if file doesn't exist\n+        try {\n+            LazyFileInputStream in = new LazyFileInputStream(file.getAbsolutePath() + \"XX\");\n+            in.close();\n+            fail();\n+        } catch (IOException e) {\n+            // expected\n+        }\n+        \n+        // test open / close (without reading)\n+        LazyFileInputStream in = new LazyFileInputStream(file);\n+        in.close();\n+        \n+        // test reading too much and closing too much\n+        in = new LazyFileInputStream(file);\n+        assertEquals(0, in.read());\n+        assertEquals(-1, in.read());\n+        assertEquals(-1, in.read());\n+        assertEquals(-1, in.read());\n+        in.close();\n+        in.close();\n+        in.close();\n+        assertEquals(-1, in.read());\n+        \n+        // test with file name\n+        in = new LazyFileInputStream(file.getAbsolutePath());\n+        assertEquals(1, in.available());\n+        assertEquals(0, in.read());\n+        assertEquals(0, in.available());\n+        assertEquals(-1, in.read());\n+        assertEquals(0, in.available());\n+        in.close();\n+        \n+        // test markSupported, mark, and reset\n+        in = new LazyFileInputStream(file);\n+        assertFalse(in.markSupported());\n+        in.mark(1);\n+        assertEquals(0, in.read());\n+        try {\n+            in.reset();\n+            fail();\n+        } catch (IOException e) {\n+            // expected\n+        }\n+        assertEquals(-1, in.read());\n+        in.close();\n+        \n+        // test read(byte[])\n+        in = new LazyFileInputStream(file);\n+        byte[] test = new byte[2];\n+        assertEquals(1, in.read(test));\n+        in.close();        \n+        \n+        // test read(byte[],int,int)\n+        in = new LazyFileInputStream(file);\n+        assertEquals(1, in.read(test, 0, 2));\n+        in.close();        \n+\n+        // test skip\n+        in = new LazyFileInputStream(file);\n+        assertEquals(2, in.skip(2));\n+        assertEquals(-1, in.read(test));\n+        assertEquals(0, in.skip(2));\n+        in.close();        \n+\n+        // test with the file descriptor\n+        RandomAccessFile ra = new RandomAccessFile(file, \"r\");\n+        in = new LazyFileInputStream(ra.getFD());\n+        assertEquals(0, in.read());\n+        assertEquals(-1, in.read());\n+        in.close();\n+        ra.close();\n+        \n+        // test that the file is not opened before reading\n+        in = new LazyFileInputStream(file);\n+        // this should fail in Windows if the file was opened\n+        file.delete();\n+        \n+        createFile();\n+        \n+        // test that the file is closed after reading the last byte\n+        in = new LazyFileInputStream(file);\n+        assertEquals(0, in.read());\n+        assertEquals(-1, in.read());\n+        // this should fail in Windows if the file was opened\n+        file.delete();\n+        \n+    }\n+\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/787e2fca5b8e1176299dfa3e95d6d437fa8e7433/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/LazyFileInputStreamTest.java",
                "sha": "2406570a9d344fa5bc006f053be6adbfb9f773f3",
                "status": "added"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/787e2fca5b8e1176299dfa3e95d6d437fa8e7433/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/TestAll.java",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/TestAll.java?ref=787e2fca5b8e1176299dfa3e95d6d437fa8e7433",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/TestAll.java",
                "patch": "@@ -32,6 +32,7 @@\n      */\n     public static Test suite() {\n         TestSuite suite = new TestSuite(\"Data tests\");\n+        suite.addTestSuite(LazyFileInputStreamTest.class);\n         suite.addTestSuite(OpenFilesTest.class);\n         suite.addTestSuite(DataStoreTest.class);\n         suite.addTestSuite(NodeTypeTest.class);",
                "raw_url": "https://github.com/apache/jackrabbit/raw/787e2fca5b8e1176299dfa3e95d6d437fa8e7433/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/data/TestAll.java",
                "sha": "c5f3f397766a7b70d64da2e0a81dd7fd0115a69a",
                "status": "modified"
            }
        ],
        "message": "JCR-2067 FileDataStore: only open a stream when really necessary - close() can throw a NullPointerException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@779081 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/fd2f40b7d6d5a7d4f9aaca099cce1c7913271f59",
        "patched_files": [
            "LazyFileInputStream.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TestAll.java",
            "LazyFileInputStreamTest.java"
        ]
    },
    "jackrabbit_790743e": {
        "bug_id": "jackrabbit_790743e",
        "commit": "https://github.com/apache/jackrabbit/commit/790743e39e6c863c8799ec18b8cad1a70e0047fb",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/790743e39e6c863c8799ec18b8cad1a70e0047fb/jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/util/Timer.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/util/Timer.java?ref=790743e39e6c863c8799ec18b8cad1a70e0047fb",
                "deletions": 2,
                "filename": "jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/util/Timer.java",
                "patch": "@@ -188,8 +188,10 @@ public void run() {\n             synchronized (Timer.this) {\n                 if (numScheduledTasks == 0 &&\n                         System.currentTimeMillis() > lastTaskScheduled + IDLE_TIME) {\n-                    delegatee.cancel();\n-                    delegatee = null;\n+                    if (delegatee != null) {\n+                        delegatee.cancel();\n+                        delegatee = null;\n+                    }\n                 }\n             }\n         }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/790743e39e6c863c8799ec18b8cad1a70e0047fb/jackrabbit-jcr-commons/src/main/java/org/apache/jackrabbit/util/Timer.java",
                "sha": "f35eca1bec675883705e40b6914af77f76660d03",
                "status": "modified"
            }
        ],
        "message": "JCR-1486: Introduce Timer idle time\n- NullPointerException may happen when idle checker task runs while Timer.cancel() is called.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@638867 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/94f74654e2bb435e0de8599d156b689302deab32",
        "patched_files": [
            "Timer.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TimerTest.java"
        ]
    },
    "jackrabbit_79c89fe": {
        "bug_id": "jackrabbit_79c89fe",
        "commit": "https://github.com/apache/jackrabbit/commit/79c89fe5025b873a5bb8297795f9d89301b0b708",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/79c89fe5025b873a5bb8297795f9d89301b0b708/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/integration/random/operation/Restore.java",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/integration/random/operation/Restore.java?ref=79c89fe5025b873a5bb8297795f9d89301b0b708",
                "deletions": 2,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/integration/random/operation/Restore.java",
                "patch": "@@ -38,8 +38,7 @@ public Restore(Session s, String path) {\n     public NodeIterator execute() throws Exception {\n         Node n = getNode();\n         Version v = getRandomVersion(false);\n-        // TODO: for now only call restore on non-base versions. See: JCR-1476\n-        if (v != null && !n.getBaseVersion().isSame(v)) {\n+        if (v != null) {\n             log.info(n.getPath() + \":\" + v.getName());\n             n.restore(v, true);\n         }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/79c89fe5025b873a5bb8297795f9d89301b0b708/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/integration/random/operation/Restore.java",
                "sha": "98f3953c4452377ebea771fcd44a160ef5f1dff4",
                "status": "modified"
            }
        ],
        "message": "JCR-1476: Restore to base version throws NullPointerException\n- remove workaround in test case\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@638821 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/73e1867b08af94ed615ee3746fd07793504b3ba1",
        "patched_files": [
            "Restore.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "RestoreTest.java"
        ]
    },
    "jackrabbit_7ad3571": {
        "bug_id": "jackrabbit_7ad3571",
        "commit": "https://github.com/apache/jackrabbit/commit/7ad35718087e1d235f06a6d36a8870517dac6b9a",
        "file": [
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7ad35718087e1d235f06a6d36a8870517dac6b9a/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java",
                "changes": 10,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java?ref=7ad35718087e1d235f06a6d36a8870517dac6b9a",
                "deletions": 5,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java",
                "patch": "@@ -112,10 +112,10 @@ public void testGetPath()\n     /**\n      * Tests if getName() returns same as last name returned by getPath()\n      */\n-    public void testGetName() throws RepositoryException {\n-        assertEquals(\"getName() of root must be an empty string\",\n-                \"\",\n-                session.getRootNode().getName());\n+    public void testGetName() throws RepositoryException, NotExecutableException {\n+        if (childNode == null) {\n+            throw new NotExecutableException(\"Workspace does not have sufficient content to run this test.\");\n+        }\n \n         // build name from path\n         String path = childNode.getPath();\n@@ -1017,4 +1017,4 @@ private Node locateNodeWithSameNameSiblings(Node node)\n         }\n         return null;\n     }\n-}\n\\ No newline at end of file\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7ad35718087e1d235f06a6d36a8870517dac6b9a/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/NodeReadMethodsTest.java",
                "sha": "e8e15352921671cc43569fa4988d7fdac8d1b3fe",
                "status": "modified"
            }
        ],
        "message": "JCR-583: TCK: NodeReadMethodsTest.testGetName fails with NPE if 'testroot' has no child node\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@480975 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/5bb3f49b42789fd9d5ddcf849f162a8f007bc9ce",
        "patched_files": [],
        "repo": "jackrabbit",
        "unit_tests": [
            "NodeReadMethodsTest.java"
        ]
    },
    "jackrabbit_7be5cdd": {
        "bug_id": "jackrabbit_7be5cdd",
        "commit": "https://github.com/apache/jackrabbit/commit/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df",
                "deletions": 1,
                "filename": "jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java",
                "patch": "@@ -60,7 +60,7 @@\n      * @return locator of the resource specified with the Destination header.\n      * @see DavConstants#HEADER_DESTINATION\n      */\n-    public DavResourceLocator getDestinationLocator();\n+    public DavResourceLocator getDestinationLocator() throws DavException;\n \n     /**\n      * Returns true if the {@link DavConstants#HEADER_OVERWRITE Overwrite header}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/DavServletRequest.java",
                "sha": "2c336754166be31b819b043f07d6d1a2d7f8fa86",
                "status": "modified"
            },
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java",
                "changes": 28,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df",
                "deletions": 24,
                "filename": "jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java",
                "patch": "@@ -163,32 +163,12 @@ public DavResourceLocator getRequestLocator() {\n      * resource.\n      *\n      * @return path of the destination resource.\n+     * @throws DavException \n      * @see #HEADER_DESTINATION\n      * @see DavServletRequest#getDestinationLocator\n      */\n-    public DavResourceLocator getDestinationLocator() {\n-        String destination = httpRequest.getHeader(HEADER_DESTINATION);\n-        if (destination != null) {\n-            try {\n-                URI uri = new URI(destination);\n-                if (uri.getAuthority().equals(httpRequest.getHeader(\"Host\"))) {\n-                    destination = uri.getRawPath();\n-                }\n-            } catch (URISyntaxException e) {\n-                log.debug(\"Destination is path is not a valid URI (\" + e.getMessage() + \".\");\n-                int pos = destination.lastIndexOf(\":\");\n-                if (pos > 0) {\n-                    destination = destination.substring(destination.indexOf(\"/\", pos));\n-                    log.debug(\"Tried to retrieve resource destination path from invalid URI: \" + destination);\n-                }\n-            }\n-            // cut off the context path\n-            String contextPath = httpRequest.getContextPath();\n-            if (destination.startsWith(contextPath)) {\n-                destination = destination.substring(contextPath.length());\n-            }\n-        }\n-        return factory.createResourceLocator(hrefPrefix, destination);\n+    public DavResourceLocator getDestinationLocator() throws DavException {\n+        return getHrefLocator(httpRequest.getHeader(HEADER_DESTINATION));\n     }\n \n     /**\n@@ -201,7 +181,7 @@ public DavResourceLocator getHrefLocator(String href) throws DavException {\n         String ref = href;\n         if (ref != null) {\n             //href should be a Simple-ref production as defined in RFC4918, so it is either an absolute URI\n-            //or an absoltute path\n+            //or an absolute path\n             try {\n                 URI uri = new URI(ref);\n                 String auth = uri.getAuthority();",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/main/java/org/apache/jackrabbit/webdav/WebdavRequestImpl.java",
                "sha": "334d76b27b33b48c5cb5c97f70109d14e23c8cc1",
                "status": "modified"
            },
            {
                "additions": 117,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java",
                "changes": 117,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df",
                "deletions": 0,
                "filename": "jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java",
                "patch": "@@ -0,0 +1,117 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\r\n+ * contributor license agreements.  See the NOTICE file distributed with\r\n+ * this work for additional information regarding copyright ownership.\r\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\r\n+ * (the \"License\"); you may not use this file except in compliance with\r\n+ * the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *      http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+package org.apache.jackrabbit.webdav.server;\r\n+\r\n+import java.io.IOException;\r\n+import java.net.URI;\r\n+import java.net.URISyntaxException;\r\n+\r\n+import junit.framework.TestCase;\r\n+\r\n+import org.apache.commons.httpclient.HttpClient;\r\n+import org.apache.commons.httpclient.HttpException;\r\n+import org.apache.commons.httpclient.UsernamePasswordCredentials;\r\n+import org.apache.commons.httpclient.auth.AuthScope;\r\n+import org.apache.commons.httpclient.methods.HeadMethod;\r\n+import org.apache.commons.httpclient.methods.PutMethod;\r\n+import org.apache.jackrabbit.webdav.DavException;\r\n+import org.apache.jackrabbit.webdav.client.methods.DeleteMethod;\r\n+import org.apache.jackrabbit.webdav.client.methods.MoveMethod;\r\n+\r\n+/**\r\n+ * Test cases for WebDAV BIND functionality (see <a href=\"http://greenbytes.de/tech/webdav/draft-ietf-webdav-bind-20.html\">draft-ietf-webdav-bind-20</a>\r\n+ * <p>\r\n+ * Required system properties:\r\n+ * <ul>\r\n+ *   <li>webdav.test.url</li>\r\n+ *   <li>webdav.test.username</li>\r\n+ *   <li>webdav.test.password</li>\r\n+ * </ul>\r\n+ */\r\n+\r\n+public class RFC4918DestinationHeaderTest extends TestCase {\r\n+\r\n+    private String root;\r\n+    private URI uri;\r\n+    private String username, password;\r\n+    private HttpClient client;\r\n+    \r\n+    protected void setUp() throws Exception {\r\n+        this.uri = URI.create(System.getProperty(\"webdav.test.url\"));\r\n+        this.root = this.uri.toASCIIString();\r\n+        if (!this.root.endsWith(\"/\")) {\r\n+            this.root += \"/\";\r\n+        }\r\n+        this.username = System.getProperty((\"webdav.test.username\"), \"\");\r\n+        this.password = System.getProperty((\"webdav.test.password\"), \"\");\r\n+        this.client = new HttpClient();\r\n+        this.client.getState().setCredentials(\r\n+                new AuthScope(this.uri.getHost(), this.uri.getPort()),\r\n+                new UsernamePasswordCredentials(this.username, this.password));\r\n+        super.setUp();\r\n+    }\r\n+\r\n+    protected void tearDown() throws Exception {\r\n+        super.tearDown();\r\n+    }\r\n+    \r\n+    public void testMove() throws HttpException, IOException, DavException, URISyntaxException {\r\n+\r\n+        String testuri = this.root + \"movetest\";\r\n+        String destinationuri = testuri + \"2\";\r\n+        String destinationpath = new URI(destinationuri).getRawPath();\r\n+        // make sure the scheme is removed\r\n+        assertTrue(destinationpath.indexOf(\":\") < 0);\r\n+        \r\n+        int status;\r\n+        try {\r\n+            PutMethod put = new PutMethod(testuri);\r\n+            status = this.client.executeMethod(put);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 201 || status == 204);\r\n+\r\n+            // try to move outside the servlet's name space\r\n+            MoveMethod move = new MoveMethod(testuri, \"/foobar\", true);\r\n+            status = this.client.executeMethod(move);\r\n+            assertTrue(\"status: \" + status, status == 403);\r\n+\r\n+            // try a relative path\r\n+            move = new MoveMethod(testuri, \"foobar\", true);\r\n+            status = this.client.executeMethod(move);\r\n+            assertTrue(\"status: \" + status, status == 400);\r\n+\r\n+            move = new MoveMethod(testuri, destinationpath, true);\r\n+            status = this.client.executeMethod(move);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 201 || status == 204);\r\n+            \r\n+            HeadMethod head = new HeadMethod(destinationuri);\r\n+            status = this.client.executeMethod(head);\r\n+            assertTrue(\"status: \" + status, status == 200);\r\n+\r\n+            head = new HeadMethod(testuri);\r\n+            status = this.client.executeMethod(head);\r\n+            assertTrue(\"status: \" + status, status == 404);\r\n+\r\n+        } finally {\r\n+            DeleteMethod delete = new DeleteMethod(testuri);\r\n+            status = this.client.executeMethod(delete);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 204 || status == 404);\r\n+            delete = new DeleteMethod(destinationuri);\r\n+            status = this.client.executeMethod(delete);\r\n+            assertTrue(\"status: \" + status, status == 200 || status == 204 || status == 404);\r\n+        }\r\n+    }\r\n+}\r",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/RFC4918DestinationHeaderTest.java",
                "sha": "409367508cbeb9eed1dace5107dc5591a1260f9b",
                "status": "added"
            },
            {
                "additions": 33,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java",
                "changes": 33,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java?ref=7be5cdd48db966403fe6ad44b18a38e8a1f8d3df",
                "deletions": 0,
                "filename": "jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java",
                "patch": "@@ -0,0 +1,33 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\r\n+ * contributor license agreements.  See the NOTICE file distributed with\r\n+ * this work for additional information regarding copyright ownership.\r\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\r\n+ * (the \"License\"); you may not use this file except in compliance with\r\n+ * the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *      http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+package org.apache.jackrabbit.webdav.server;\r\n+\r\n+import junit.framework.Test;\r\n+import junit.framework.TestCase;\r\n+import junit.framework.TestSuite;\r\n+\r\n+public class WebdavServerTests extends TestCase {\r\n+\r\n+    public static Test suite() {\r\n+        TestSuite suite = new TestSuite(\"WebDAV Server Tests\");\r\n+\r\n+        suite.addTestSuite(BindTest.class);\r\n+        suite.addTestSuite(RFC4918DestinationHeaderTest.class);\r\n+\r\n+        return suite;\r\n+    }\r\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7be5cdd48db966403fe6ad44b18a38e8a1f8d3df/jackrabbit-webdav/src/test/java/org/apache/jackrabbit/webdav/server/WebdavServerTests.java",
                "sha": "0e3bc4cadb38c0770ac0eb53bef06a3483f40576",
                "status": "added"
            }
        ],
        "message": "JCR-1782: fix potential NPE in parsing Destination header, add RFC 4918 compliant parsing, add test cases\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@701129 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/bc05cc9a6912c94e7af980f3f2aac451446ec9f4",
        "patched_files": [
            "WebdavRequestImpl.java",
            "WebdavServerTests.java",
            "DavServletRequest.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "RFC4918DestinationHeaderTest.java"
        ]
    },
    "jackrabbit_7d653b1": {
        "bug_id": "jackrabbit_7d653b1",
        "commit": "https://github.com/apache/jackrabbit/commit/7d653b12127c3da2f5c1804551bd76c6797fd21d",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d",
                "deletions": 1,
                "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
                "patch": "@@ -348,7 +348,7 @@ public Object visit(RelationQueryNode node, Object data) throws RepositoryExcept\n             PathQueryNode relPath = node.getRelativePath();\n             if (relPath == null) {\n                 propPath.append(\".\");\n-            } else if (relPath.getNumOperands() > 0 && relPath.getPathSteps()[0].getNameTest().equals(XPathQueryBuilder.FN_POSITION_FULL)) {\n+            } else if (relPath.getNumOperands() > 0 && XPathQueryBuilder.FN_POSITION_FULL.equals(relPath.getPathSteps()[0].getNameTest())) {\n                 propPath.append(resolver.getJCRName(XPathQueryBuilder.FN_POSITION_FULL));\n             } else {\n                 LocationStepQueryNode[] steps = relPath.getPathSteps();",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormat.java",
                "sha": "d345adcaaaeb7c9dde3ff7b12e145c4c540a5b98",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
                "changes": 11,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d",
                "deletions": 3,
                "filename": "jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
                "patch": "@@ -425,8 +425,13 @@ public Object visit(SimpleNode node, Object data) {\n                         }\n                         PathQueryNode relPath = tmp.getRelativePath();\n                         LocationStepQueryNode[] steps = relPath.getPathSteps();\n-                        \n-                        tmpRelPath.addLast(steps[steps.length-1].getNameTest());\n+\n+                        Name nameTest = steps[steps.length-1].getNameTest();\n+                        if (nameTest==null) {\n+                        \t// see LocationStepQueryNode javadoc on when getNameTest()==null: when it was a star (asterisk)\n+                        \tnameTest = RelationQueryNode.STAR_NAME_TEST;\n+                        }\n+\t\t\t\t\t\ttmpRelPath.addLast(nameTest);\n                     }\n                 }\n                 break;\n@@ -956,7 +961,7 @@ private QueryNode createFunction(SimpleNode node, QueryNode queryNode) {\n                     }\n                     if (queryNode.getType() == QueryNode.TYPE_PATH) {\n                         PathQueryNode pathNode = (PathQueryNode) queryNode;\n-                        \n+\n                         pathNode.addPathStep(createDerefQueryNode(node, descendant, pathNode));\n                     } else if (queryNode.getType() == QueryNode.TYPE_RELATION) {\n                         RelationQueryNode relNode = (RelationQueryNode) queryNode;",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/main/java/org/apache/jackrabbit/spi/commons/query/xpath/XPathQueryBuilder.java",
                "sha": "2fa556437e041137d664dcbd958f04983d390450",
                "status": "modified"
            },
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java?ref=7d653b12127c3da2f5c1804551bd76c6797fd21d",
                "deletions": 0,
                "filename": "jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
                "patch": "@@ -67,6 +67,14 @@ public void testStarNameTest() throws Exception {\n         checkStatement(\"//element(*, foo)[foo/*/@bar = 'bla']\");\n     }\n \n+    public void testStarNameAtBeginningOfPredicate() throws Exception {\n+        checkStatement(\"//element(*, foo)[*/*/@bar = 'bla']\");\n+    }\n+\n+    public void testChildStarName() throws Exception {\n+        checkStatement(\"//programs//*[*/@sunday]\");\n+    }\n+\n     public void testRepSimilar() throws Exception {\n         checkStatement(\"//element(*, foo)[rep:similar(foo, '/some/path')]\");\n     }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/7d653b12127c3da2f5c1804551bd76c6797fd21d/jackrabbit-spi-commons/src/test/java/org/apache/jackrabbit/spi/commons/query/xpath/QueryFormatTest.java",
                "sha": "a07e8e255ab27c025c1e011d651663d55d8ab3a1",
                "status": "modified"
            }
        ],
        "message": "JCR-3435: Fix NPE for xpath query with child axis and star name\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1393342 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/c403b6eca2b7722a9dc8db2fb237e2fb050f79ac",
        "patched_files": [
            "QueryFormat.java",
            "XPathQueryBuilder.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "QueryFormatTest.java"
        ]
    },
    "jackrabbit_936453a": {
        "bug_id": "jackrabbit_936453a",
        "commit": "https://github.com/apache/jackrabbit/commit/936453a1287000626f6074db6ad0537ece561d9c",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java?ref=936453a1287000626f6074db6ad0537ece561d9c",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "patch": "@@ -185,6 +185,10 @@ public int nextDoc() throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n+            if (contextScorer == null) {\n+                docNo = NO_MORE_DOCS;\n+                return docNo;\n+            }\n \n             if (docNo == -1) {\n                 // get first doc of context scorer\n@@ -225,6 +229,10 @@ public int advance(int target) throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n+            if (contextScorer == null) {\n+                docNo = NO_MORE_DOCS;\n+                return docNo;\n+            }\n \n             // optimize in the case of an advance to finish.\n             // see https://issues.apache.org/jira/browse/JCR-3091",
                "raw_url": "https://github.com/apache/jackrabbit/raw/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "sha": "610c3b9494b14cbf68b467e862eb03476255db49",
                "status": "modified"
            },
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/jackrabbit/blob/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java?ref=936453a1287000626f6074db6ad0537ece561d9c",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "patch": "@@ -243,4 +243,16 @@ public void testSimpleQuery() throws Exception {\n         executeSQLQuery(sql, new Node[] {foo});\n     }\n \n+    /**\n+     * JCR-3337\n+     */\n+    public void testNotIsDescendantNodeQuery() throws Exception {\n+        Node foo = testRootNode.addNode(\"foo\");\n+        testRootNode.getSession().save();\n+        String sql = \"SELECT a.* FROM [nt:base] as a WHERE isdescendantnode(a,'\"\n+                + testRootNode.getPath()\n+                + \"') and not isdescendantnode(a,'\"\n+                + foo.getPath() + \"')\";\n+        executeSQL2Query(sql, new Node[] {});\n+    }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/936453a1287000626f6074db6ad0537ece561d9c/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "sha": "31b1d560beaca24b8a6249255f91ceada7a33726",
                "status": "modified"
            }
        ],
        "message": "JCR-3337 Negated descendant node query with no results throws NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1352053 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/ac674fe9a3f293f97ecc194a5ec280b389290382",
        "patched_files": [
            "ChildAxisQuery.java",
            "NotQuery.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "ChildAxisQueryTest.java"
        ]
    },
    "jackrabbit_9b9beb7": {
        "bug_id": "jackrabbit_9b9beb7",
        "commit": "https://github.com/apache/jackrabbit/commit/9b9beb7f3a6970f234a637d127f820055b828053",
        "file": [
            {
                "additions": 26,
                "blob_url": "https://github.com/apache/jackrabbit/blob/9b9beb7f3a6970f234a637d127f820055b828053/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "changes": 26,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java?ref=9b9beb7f3a6970f234a637d127f820055b828053",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "patch": "@@ -290,6 +290,32 @@ public boolean hasVersion(Name versionName) {\n      * {@inheritDoc}\n      */\n     public InternalVersion getVersion(NodeId id) {\n+        InternalVersion v = getCachedVersion(id);\n+\n+        // If the version was not found, our cache may not have been\n+        // synchronized with updates from another cluster node.  Reload the history\n+        // to be sure we have the latest updates and try again.\n+        if (v == null) {\n+            try {\n+                reload();\n+            } catch (RepositoryException e) {\n+\n+                // We should add the checked exception to this method definition\n+                // so we don't need to wrap it.\n+                // Avoiding it for now to limit impact of this fix.\n+                throw new RuntimeException(e);\n+            }\n+            v = getCachedVersion(id);\n+        }\n+\n+        return v;\n+    }\n+\n+    /**\n+     * Returns the version from cache, or <code>null</code> if it is not\n+     * present.\n+     */\n+    private InternalVersion getCachedVersion(NodeId id) {\n         InternalVersion v = versionCache.get(id);\n         if (v == null) {\n             for (Name versionName : nameCache.keySet()) {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/9b9beb7f3a6970f234a637d127f820055b828053/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "sha": "3e9f5a266cbd589af12e30ff3054a1403752a13d",
                "status": "modified"
            }
        ],
        "message": "JCR-1440: NPE Thrown when two Cluster Nodes are hitting the same underlying database\n\nPatch by Ryan Brush\n\nThis needs more work (the solution reminds me of the double checked-locking antipattern), but at least it solves the most pressing issue and does not seem to cause any notable risk to other use cases.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@911856 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/c41e81997a91f21839c63ba4a8faf8d068054dfb",
        "patched_files": [
            "InternalVersionHistoryImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "InternalVersionHistoryImplTest.java"
        ]
    },
    "jackrabbit_9dbf8ce": {
        "bug_id": "jackrabbit_9dbf8ce",
        "commit": "https://github.com/apache/jackrabbit/commit/9dbf8ce74b6a9bbfc50868b1482193d78a34476f",
        "file": [
            {
                "additions": 24,
                "blob_url": "https://github.com/apache/jackrabbit/blob/9dbf8ce74b6a9bbfc50868b1482193d78a34476f/jackrabbit-spi/src/test/java/org/apache/jackrabbit/spi/QValueFactoryTest.java",
                "changes": 32,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi/src/test/java/org/apache/jackrabbit/spi/QValueFactoryTest.java?ref=9dbf8ce74b6a9bbfc50868b1482193d78a34476f",
                "deletions": 8,
                "filename": "jackrabbit-spi/src/test/java/org/apache/jackrabbit/spi/QValueFactoryTest.java",
                "patch": "@@ -182,13 +182,17 @@ public void testNullDateValue() throws IOException, RepositoryException {\n             factory.create((Calendar) null);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n         try {\n             factory.create(null, PropertyType.DATE);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n     }\n \n@@ -215,7 +219,9 @@ public void testNullReferenceValue() throws IOException, RepositoryException {\n             factory.create(null, PropertyType.REFERENCE);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n     }\n \n@@ -256,7 +262,9 @@ public void testNullNameValue() throws IOException, RepositoryException {\n             factory.create((Name) null);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n     }\n \n@@ -308,7 +316,9 @@ public void testNullPathValue() throws IOException, RepositoryException {\n             factory.create((Path) null);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n     }\n \n@@ -361,19 +371,25 @@ public void testNullBinaryValue() throws IOException, RepositoryException {\n             factory.create((byte[]) null);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n         try {\n             factory.create((InputStream) null);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n         try {\n             factory.create((File) null);\n             fail();\n         } catch (IllegalArgumentException e) {\n-            // ok\n+          // ok\n+        } catch (NullPointerException e) {\n+          // ok\n         }\n     }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/9dbf8ce74b6a9bbfc50868b1482193d78a34476f/jackrabbit-spi/src/test/java/org/apache/jackrabbit/spi/QValueFactoryTest.java",
                "sha": "f9c830f98e1dc14b3d18561066cc5868b8192b36",
                "status": "modified"
            }
        ],
        "message": "In the tests for creating QValue instances with null values, also consider a NullPointerException as legal (in addition to IllegalArgumentException)\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@706660 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/c316aa357cffac2c1a00e6185eeaaccdeaedefa5",
        "patched_files": [
            "QValueFactory.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "QValueFactoryTest.java"
        ]
    },
    "jackrabbit_a0b4637": {
        "bug_id": "jackrabbit_a0b4637",
        "commit": "https://github.com/apache/jackrabbit/commit/a0b46378111db40c38862ae45eea1e5387b91fbd",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/jackrabbit/blob/a0b46378111db40c38862ae45eea1e5387b91fbd/jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java?ref=a0b46378111db40c38862ae45eea1e5387b91fbd",
                "deletions": 2,
                "filename": "jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "patch": "@@ -152,8 +152,12 @@ private void init() throws RepositoryException {\n                     QName name = pState.getName();\n                     UUID ref = (UUID) pState.getValues()[0].internalValue();\n                     InternalVersionImpl v = (InternalVersionImpl) getVersion(new NodeId(ref));\n-                    labelCache.put(name, v);\n-                    v.internalAddLabel(name);\n+                    if (v != null) {\n+                        labelCache.put(name, v);\n+                        v.internalAddLabel(name);\n+                    } else {\n+                        log.warn(\"Error while resolving label reference. Version missing: \" + ref);\n+                    }\n                 }\n             }\n         } catch (ItemStateException e) {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/a0b46378111db40c38862ae45eea1e5387b91fbd/jackrabbit/src/main/java/org/apache/jackrabbit/core/version/InternalVersionHistoryImpl.java",
                "sha": "b09ccddc9eed9e6ffa507674aff034661defd861",
                "status": "modified"
            }
        ],
        "message": "adding simple protection of eventual NPE. need to investigate further.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@405567 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/0ce449c65fc93dd402fd1d88ba3baa8e89be69df",
        "patched_files": [
            "InternalVersionHistoryImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "InternalVersionHistoryImplTest.java"
        ]
    },
    "jackrabbit_a0ec94d": {
        "bug_id": "jackrabbit_a0ec94d",
        "commit": "https://github.com/apache/jackrabbit/commit/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/jackrabbit/blob/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java?ref=a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java",
                "patch": "@@ -164,6 +164,12 @@ protected Document createDoc() throws RepositoryException {\n                 doc.add(new Field(FieldNames.PARENT, node.getParentId().toString(), Field.Store.YES, Field.Index.UN_TOKENIZED, Field.TermVector.NO));\n                 NodeState parent = (NodeState) stateProvider.getItemState(node.getParentId());\n                 NodeState.ChildNodeEntry child = parent.getChildNodeEntry(node.getNodeId());\n+                if (child == null) {\n+                    // this can only happen when jackrabbit\n+                    // is running in a cluster.\n+                    throw new RepositoryException(\"Missing child node entry \" +\n+                            \"for node with id: \" + node.getNodeId());\n+                }\n                 String name = NameFormat.format(child.getName(), mappings);\n                 doc.add(new Field(FieldNames.LABEL, name, Field.Store.NO, Field.Index.UN_TOKENIZED, Field.TermVector.NO));\n             }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NodeIndexer.java",
                "sha": "cb8bb08f50679e2e330f352d09213e763b5b0985",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java?ref=a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b",
                "deletions": 3,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java",
                "patch": "@@ -422,11 +422,11 @@ public Object next() {\n                 Document doc = null;\n                 try {\n                     doc = createDocument(state, getNamespaceMappings());\n+                    retrieveAggregateRoot(state, aggregateRoots);\n                 } catch (RepositoryException e) {\n-                    log.error(\"Exception while creating document for node: \"\n+                    log.warn(\"Exception while creating document for node: \"\n                             + state.getNodeId() + \": \" + e.toString());\n                 }\n-                retrieveAggregateRoot(state, aggregateRoots);\n                 return doc;\n             }\n         });\n@@ -451,7 +451,7 @@ public Object next() {\n                     try {\n                         return createDocument(state, getNamespaceMappings());\n                     } catch (RepositoryException e) {\n-                        log.error(\"Exception while creating document for node: \"\n+                        log.warn(\"Exception while creating document for node: \"\n                                 + state.getNodeId() + \": \" + e.toString());\n                     }\n                     return null;",
                "raw_url": "https://github.com/apache/jackrabbit/raw/a0ec94d1a547749bfb692cf5ada2dd30e11e5a3b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/SearchIndex.java",
                "sha": "af975ed5c9ad7e04a74563266cc45897a2fea944",
                "status": "modified"
            }
        ],
        "message": "JCR-931: cluster synchronization NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@540492 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/c0bca944465ca480ffd9d5f7112a6aa8f2093cb7",
        "patched_files": [
            "SearchIndex.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "SearchIndexTest.java"
        ]
    },
    "jackrabbit_a94e7a2": {
        "bug_id": "jackrabbit_a94e7a2",
        "commit": "https://github.com/apache/jackrabbit/commit/a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java?ref=a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15",
                "deletions": 0,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java",
                "patch": "@@ -309,6 +309,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                             log.error(message);\n                             missingChildren.add(entry);\n                         }\n+                    } else {\n+                        return;\n                     }\n                 } else {\n                     NodeId cp = childBundle.getParentId();\n@@ -333,6 +335,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                                     log.error(message);\n                                 }\n                             }\n+                        } else {\n+                            return;\n                         }\n                     }\n                 }\n@@ -376,6 +380,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                                 modifications.add(bundle);\n                             }\n                         }\n+                    } else {\n+                        return;\n                     }\n                 } else {\n                     boolean found = false;\n@@ -410,6 +416,8 @@ private void checkBundleConsistency(NodeId id, NodePropBundle bundle,\n                                         + \"'\");\n                                 modifications.add(parentBundle);\n                             }\n+                        } else {\n+                            return;\n                         }\n                     }\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/a94e7a22c29e32ec348eace5e2f05b1bc8bc8d15/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/persistence/bundle/ConsistencyCheckerImpl.java",
                "sha": "2afaffbb56e62ab5c3829df006b941569b903330",
                "status": "modified"
            }
        ],
        "message": "JCR-3265 guard against possible npe's due to double checking: if the bundle is no longer there we don't need to continue to check it\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1350207 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/e3651d9a88b13b48cfb84f5830d985d3cac4dae0",
        "patched_files": [
            "ConsistencyCheckerImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "ConsistencyCheckerImplTest.java"
        ]
    },
    "jackrabbit_a9501ef": {
        "bug_id": "jackrabbit_a9501ef",
        "commit": "https://github.com/apache/jackrabbit/commit/a9501efa46f9833e96e1c7cb0f83f467649ac4b7",
        "file": [
            {
                "additions": 6,
                "blob_url": "https://github.com/apache/jackrabbit/blob/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "changes": 14,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java?ref=a9501efa46f9833e96e1c7cb0f83f467649ac4b7",
                "deletions": 8,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "patch": "@@ -139,6 +139,12 @@ public void normalize(float norm) {\n         public Scorer scorer(IndexReader reader, boolean scoreDocsInOrder,\n                 boolean topScorer) throws IOException {\n             contextScorer = context.weight(searcher).scorer(reader, scoreDocsInOrder, topScorer);\n+            if (contextScorer == null) {\n+                // context query does not match any node\n+                // the inverse is to match all nodes\n+                return new MatchAllDocsQuery().createWeight(searcher).scorer(\n+                        reader, scoreDocsInOrder, topScorer);\n+            }\n             return new NotQueryScorer(reader);\n         }\n \n@@ -185,10 +191,6 @@ public int nextDoc() throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n-            if (contextScorer == null) {\n-                docNo = NO_MORE_DOCS;\n-                return docNo;\n-            }\n \n             if (docNo == -1) {\n                 // get first doc of context scorer\n@@ -229,10 +231,6 @@ public int advance(int target) throws IOException {\n             if (docNo == NO_MORE_DOCS) {\n                 return docNo;\n             }\n-            if (contextScorer == null) {\n-                docNo = NO_MORE_DOCS;\n-                return docNo;\n-            }\n \n             // optimize in the case of an advance to finish.\n             // see https://issues.apache.org/jira/browse/JCR-3091",
                "raw_url": "https://github.com/apache/jackrabbit/raw/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/NotQuery.java",
                "sha": "c91fd3a651af7e09c517ed12595d3f89bea978cd",
                "status": "modified"
            },
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java?ref=a9501efa46f9833e96e1c7cb0f83f467649ac4b7",
                "deletions": 1,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "patch": "@@ -253,6 +253,6 @@ public void testNotIsDescendantNodeQuery() throws Exception {\n                 + testRootNode.getPath()\n                 + \"') and not isdescendantnode(a,'\"\n                 + foo.getPath() + \"')\";\n-        executeSQL2Query(sql, new Node[] {});\n+        executeSQL2Query(sql, new Node[] {foo});\n     }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/a9501efa46f9833e96e1c7cb0f83f467649ac4b7/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/query/ChildAxisQueryTest.java",
                "sha": "4ab3af55e4cbf43c063468a521bfd863adbb096b",
                "status": "modified"
            }
        ],
        "message": "JCR-3337 Negated descendant node query with no results throws NPE\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1357591 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/e60384f3420a4edecdd76472664527ccd61d07c2",
        "patched_files": [
            "ChildAxisQuery.java",
            "NotQuery.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "ChildAxisQueryTest.java"
        ]
    },
    "jackrabbit_ac1354c": {
        "bug_id": "jackrabbit_ac1354c",
        "commit": "https://github.com/apache/jackrabbit/commit/ac1354cd57d9aa8492555381a7c30715132909e6",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java?ref=ac1354cd57d9aa8492555381a7c30715132909e6",
                "deletions": 2,
                "filename": "jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java",
                "patch": "@@ -94,8 +94,8 @@ public Credentials getCredentials(HttpServletRequest request)\n                     return null;\n                 } else {\n                     int pos = defaultHeaderValue.indexOf(':');\n-                    if (pos<0) {\n-                        return new SimpleCredentials(defaultHeaderValue, null);\n+                    if (pos < 0) {\n+                        return new SimpleCredentials(defaultHeaderValue, new char[0]);\n                     } else {\n                         return new SimpleCredentials(\n                                 defaultHeaderValue.substring(0, pos),",
                "raw_url": "https://github.com/apache/jackrabbit/raw/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/main/java/org/apache/jackrabbit/server/BasicCredentialsProvider.java",
                "sha": "e80e812694e6022c0f44113f15327545a0e830bd",
                "status": "modified"
            },
            {
                "additions": 287,
                "blob_url": "https://github.com/apache/jackrabbit/blob/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java",
                "changes": 287,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java?ref=ac1354cd57d9aa8492555381a7c30715132909e6",
                "deletions": 0,
                "filename": "jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java",
                "patch": "@@ -0,0 +1,287 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.server;\n+\n+import junit.framework.TestCase;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.Cookie;\n+import javax.servlet.http.HttpSession;\n+import javax.servlet.ServletInputStream;\n+import javax.servlet.RequestDispatcher;\n+import javax.servlet.ServletException;\n+import javax.jcr.LoginException;\n+import javax.jcr.Credentials;\n+import javax.jcr.SimpleCredentials;\n+import java.util.Enumeration;\n+import java.util.Map;\n+import java.util.Locale;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.security.Principal;\n+import java.io.UnsupportedEncodingException;\n+import java.io.IOException;\n+import java.io.BufferedReader;\n+\n+/**\n+ * <code>BasicCredentialsProviderTest</code>...\n+ */\n+public class BasicCredentialsProviderTest extends TestCase {\n+\n+    public void testMissingDefaultHeader() throws ServletException {\n+        CredentialsProvider cb = new BasicCredentialsProvider(null);\n+        try {\n+            Credentials creds = cb.getCredentials(new RequestImpl(null));\n+            fail(\"LoginException expected\");\n+        } catch (LoginException e) {\n+            // ok\n+        }\n+    }\n+\n+    public void testDefaultPassword() throws ServletException, LoginException {\n+        Map m = new HashMap();\n+        m.put(\"userId\", new char[0]);\n+        m.put(\"userId:\", new char[0]);\n+        m.put(\"userId:pw\", \"pw\".toCharArray());\n+\n+        for (Iterator it = m.keySet().iterator(); it.hasNext();) {\n+            String defaultHeaderValue = it.next().toString();\n+            char[] pw = (char[]) m.get(defaultHeaderValue);\n+\n+            CredentialsProvider cb = new BasicCredentialsProvider(defaultHeaderValue);\n+            Credentials creds = cb.getCredentials(new RequestImpl(null));\n+\n+            assertNotNull(creds);\n+            assertTrue(creds instanceof SimpleCredentials);\n+            assertEquals(\"userId\",((SimpleCredentials) creds).getUserID());\n+            if (pw.length == 0) {\n+                assertEquals(0, ((SimpleCredentials) creds).getPassword().length);\n+            } else {\n+                assertEquals(new String(pw), new String(((SimpleCredentials) creds).getPassword()));\n+            }\n+        }\n+    }\n+\n+\n+\n+\n+    private class RequestImpl implements HttpServletRequest {\n+\n+        private final String authHeader;\n+\n+        private RequestImpl(String authHeader) {\n+            this.authHeader = authHeader;\n+        }\n+\n+        public String getAuthType() {\n+            return null;\n+        }\n+\n+        public Cookie[] getCookies() {\n+            return new Cookie[0];\n+        }\n+\n+        public long getDateHeader(String name) {\n+            return 0;\n+        }\n+\n+        public String getHeader(String name) {\n+            return authHeader;\n+        }\n+\n+        public Enumeration getHeaders(String name) {\n+            return null;\n+        }\n+\n+        public Enumeration getHeaderNames() {\n+            return null;\n+        }\n+\n+        public int getIntHeader(String name) {\n+            return 0;\n+        }\n+\n+        public String getMethod() {\n+            return null;\n+        }\n+\n+        public String getPathInfo() {\n+            return null;\n+        }\n+\n+        public String getPathTranslated() {\n+            return null;\n+        }\n+\n+        public String getContextPath() {\n+            return null;\n+        }\n+\n+        public String getQueryString() {\n+            return null;\n+        }\n+\n+        public String getRemoteUser() {\n+            return null;\n+        }\n+\n+        public boolean isUserInRole(String role) {\n+            return false;\n+        }\n+\n+        public Principal getUserPrincipal() {\n+            return null;\n+        }\n+\n+        public String getRequestedSessionId() {\n+            return null;\n+        }\n+\n+        public String getRequestURI() {\n+            return null;\n+        }\n+\n+        public StringBuffer getRequestURL() {\n+            return null;\n+        }\n+\n+        public String getServletPath() {\n+            return null;\n+        }\n+\n+        public HttpSession getSession(boolean create) {\n+            return null;\n+        }\n+\n+        public HttpSession getSession() {\n+            return null;\n+        }\n+\n+        public boolean isRequestedSessionIdValid() {\n+            return false;\n+        }\n+\n+        public boolean isRequestedSessionIdFromCookie() {\n+            return false;\n+        }\n+\n+        public boolean isRequestedSessionIdFromURL() {\n+            return false;\n+        }\n+\n+        public boolean isRequestedSessionIdFromUrl() {\n+            return false;\n+        }\n+\n+        public Object getAttribute(String name) {\n+            return null;\n+        }\n+\n+        public Enumeration getAttributeNames() {\n+            return null;\n+        }\n+\n+        public String getCharacterEncoding() {\n+            return null;\n+        }\n+\n+        public void setCharacterEncoding(String s) throws UnsupportedEncodingException {\n+        }\n+\n+        public int getContentLength() {\n+            return 0;\n+        }\n+\n+        public String getContentType() {\n+            return null;\n+        }\n+\n+        public ServletInputStream getInputStream() throws IOException {\n+            return null;\n+        }\n+\n+        public String getParameter(String name) {\n+            return null;\n+        }\n+\n+        public Enumeration getParameterNames() {\n+            return null;\n+        }\n+\n+        public String[] getParameterValues(String name) {\n+            return new String[0];\n+        }\n+\n+        public Map getParameterMap() {\n+            return null;\n+        }\n+\n+        public String getProtocol() {\n+            return null;\n+        }\n+\n+        public String getScheme() {\n+            return null;\n+        }\n+\n+        public String getServerName() {\n+            return null;\n+        }\n+\n+        public int getServerPort() {\n+            return 0;\n+        }\n+\n+        public BufferedReader getReader() throws IOException {\n+            return null;\n+        }\n+\n+        public String getRemoteAddr() {\n+            return null;\n+        }\n+\n+        public String getRemoteHost() {\n+            return null;\n+        }\n+\n+        public void setAttribute(String name, Object o) {\n+        }\n+\n+        public void removeAttribute(String name) {\n+        }\n+\n+        public Locale getLocale() {\n+            return null;\n+        }\n+\n+        public Enumeration getLocales() {\n+            return null;\n+        }\n+\n+        public boolean isSecure() {\n+            return false;\n+        }\n+\n+        public RequestDispatcher getRequestDispatcher(String path) {\n+            return null;\n+        }\n+\n+        public String getRealPath(String path) {\n+            return null;\n+        }\n+    }\n+}\n\\ No newline at end of file",
                "raw_url": "https://github.com/apache/jackrabbit/raw/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/BasicCredentialsProviderTest.java",
                "sha": "f9b703db6b7f9b649b50f60a818112f72c983410",
                "status": "added"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/jackrabbit/blob/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java",
                "changes": 39,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java?ref=ac1354cd57d9aa8492555381a7c30715132909e6",
                "deletions": 0,
                "filename": "jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java",
                "patch": "@@ -0,0 +1,39 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.server;\n+\n+import junit.framework.Test;\n+import junit.framework.TestCase;\n+import junit.framework.TestSuite;\n+\n+/**\n+ * Test suite that includes all testcases for package org.apache.jackrabbit.server.\n+ */\n+public class TestAll extends TestCase {\n+\n+    /**\n+     * Returns a <code>Test</code> suite that executes all tests inside this\n+     * package.\n+     */\n+    public static Test suite() {\n+        TestSuite suite = new TestSuite(\"org.apache.jackrabbit.server tests\");\n+\n+        suite.addTestSuite(BasicCredentialsProviderTest.class);\n+\n+        return suite;\n+    }\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/ac1354cd57d9aa8492555381a7c30715132909e6/jackrabbit-jcr-server/src/test/java/org/apache/jackrabbit/server/TestAll.java",
                "sha": "26efafb9d1b19aea6a1aa373f31f3d660ada6091",
                "status": "added"
            }
        ],
        "message": "JCR-2032 : BasicCredentialsProviderTest throws NPE if defaultAuthHeader init param misses the password\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@755512 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/cb0c0b1fe5e1137726ff14f5dbdc14bdae97dd63",
        "patched_files": [
            "BasicCredentialsProvider.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TestAll.java",
            "BasicCredentialsProviderTest.java"
        ]
    },
    "jackrabbit_b25503c": {
        "bug_id": "jackrabbit_b25503c",
        "commit": "https://github.com/apache/jackrabbit/commit/b25503c7e069a88cd8ffa0499538e44b41f95783",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 9,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java",
                "patch": "@@ -364,15 +364,6 @@ private static String getPropertyDefSpec(PropertyDefinition property)\n         }\n         String type = PropertyType.nameFromValue(property.getRequiredType());\n         writer.println(\"  RequiredType \" + type.toUpperCase());\n-        writer.print(\"  ValueConstraints [\");\n-        String[] constraints = property.getValueConstraints();\n-        for (int i = 0; i < constraints.length; i++) {\n-            if (i > 0) {\n-                writer.print(',');\n-            }\n-            writer.print(constraints[i]);\n-        }\n-        writer.println(\"]\");\n         Value[] values = property.getDefaultValues();\n         if (values != null && values.length > 0) {\n             writer.print(\"  DefaultValues [\");",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/PredefinedNodeTypeTest.java",
                "sha": "2c00e83fba7dfd1de460d0bb52de84a1b2aa30f1",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 2,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:lockIsDeep\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:lockOwner\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-lockable.txt",
                "sha": "f0e0b774c6be5d5e0d617378e773cf729aefd7ad",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 1,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:uuid\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-referenceable.txt",
                "sha": "634c9854a4c5a3dd39839b67408eae7e146d58e0",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 5,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:baseVersion\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:isCheckedOut\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues [true]\n   AutoCreated true\n   Mandatory true\n@@ -31,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mergeFailed\n   RequiredType REFERENCE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -41,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:predecessors\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -51,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:versionHistory\n   RequiredType REFERENCE\n-  ValueConstraints [nt:versionHistory]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/mix-versionable.txt",
                "sha": "8aff88e48089378642017d566ed8dc223e37ef85",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 2,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:mixinTypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:primaryType\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-base.txt",
                "sha": "24eec467ce63b220c6959ed0465ccec3d97d5fd3",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt",
                "changes": 8,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 8,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:autoCreated\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:defaultPrimaryType\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -31,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mandatory\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -41,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:name\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -51,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:onParentVersion\n   RequiredType STRING\n-  ValueConstraints [COPY,VERSION,INITIALIZE,COMPUTE,IGNORE,ABORT]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -61,7 +56,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:protected\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -71,7 +65,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:requiredPrimaryTypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues [nt:base]\n   AutoCreated false\n   Mandatory true\n@@ -81,7 +74,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:sameNameSiblings\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-childNodeDefinition.txt",
                "sha": "1a5954e38d534d1e9f8d045755890f8a534cae07",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 5,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt",
                "patch": "@@ -21,7 +21,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:frozenMixinTypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -31,7 +30,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:frozenPrimaryType\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true\n@@ -41,7 +39,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:frozenUuid\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true\n@@ -51,7 +48,6 @@ PropertyDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -61,7 +57,6 @@ PropertyDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-frozenNode.txt",
                "sha": "76ff255f5bc5b616512d7945bde192402a0b9fd5",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 1,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:created\n   RequiredType DATE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-hierarchyNode.txt",
                "sha": "70819a663ebfda918b87cb7729a1fd325dfbb6c2",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 1,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:content\n   RequiredType REFERENCE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-linkedFile.txt",
                "sha": "372dae8004cc99851486db6586ef83c6f73d43ea",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 5,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt",
                "patch": "@@ -29,7 +29,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:hasOrderableChildNodes\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -39,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:isMixin\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -49,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:nodeTypeName\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -59,7 +56,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:primaryItemName\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -69,7 +65,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:supertypes\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-nodeType.txt",
                "sha": "f9302563dbdcb22b76f552e0e756713bd504eb67",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt",
                "changes": 9,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 9,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:autoCreated\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:defaultValues\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -31,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mandatory\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -41,7 +38,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:multiple\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -51,7 +47,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:name\n   RequiredType NAME\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -61,7 +56,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:onParentVersion\n   RequiredType STRING\n-  ValueConstraints [COPY,VERSION,INITIALIZE,COMPUTE,IGNORE,ABORT]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -71,7 +65,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:protected\n   RequiredType BOOLEAN\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -81,7 +74,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:requiredType\n   RequiredType STRING\n-  ValueConstraints [STRING,BINARY,LONG,DOUBLE,BOOLEAN,DATE,NAME,PATH,REFERENCE,UNDEFINED]\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -91,7 +83,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:valueConstraints\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-propertyDefinition.txt",
                "sha": "96300ed1606c4b167338277e253de6186c98b13e",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 2,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:language\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -21,7 +20,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:statement\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-query.txt",
                "sha": "b4dba314ab058ddc60bc22fcdb12f45ea5824ae9",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 4,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt",
                "patch": "@@ -12,7 +12,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:data\n   RequiredType BINARY\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -22,7 +21,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:encoding\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -32,7 +30,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:lastModified\n   RequiredType DATE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true\n@@ -42,7 +39,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:mimeType\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-resource.txt",
                "sha": "0ac93bf4f0450b9d06127e7fc61bf5b6eb9dd516",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 2,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt",
                "patch": "@@ -20,7 +20,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -30,7 +29,6 @@ PropertyDefinition\n PropertyDefinition\n   Name \"*\"\n   RequiredType UNDEFINED\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-unstructured.txt",
                "sha": "20030495c86e4bea63bd7daf5811d41c2734eb96",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt",
                "changes": 3,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 3,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt",
                "patch": "@@ -21,7 +21,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:created\n   RequiredType DATE\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true\n@@ -31,7 +30,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:predecessors\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory false\n@@ -41,7 +39,6 @@ PropertyDefinition\n PropertyDefinition\n   Name jcr:successors\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-version.txt",
                "sha": "cac88227083978d22fce4951964ef9a1134688c0",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 1,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt",
                "patch": "@@ -39,7 +39,6 @@ ChildNodeDefinition\n PropertyDefinition\n   Name jcr:versionableUuid\n   RequiredType STRING\n-  ValueConstraints []\n   DefaultValues null\n   AutoCreated true\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionHistory.txt",
                "sha": "cad4c8f779c529cf5576a8972f2c239479083e22",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 1,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name \"*\"\n   RequiredType REFERENCE\n-  ValueConstraints [nt:version]\n   DefaultValues null\n   AutoCreated false\n   Mandatory false",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionLabels.txt",
                "sha": "71054269ddc32930ca6b1e752dc0248551c9a11d",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt",
                "changes": 1,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt?ref=b25503c7e069a88cd8ffa0499538e44b41f95783",
                "deletions": 1,
                "filename": "jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt",
                "patch": "@@ -11,7 +11,6 @@ PrimaryItemName\n PropertyDefinition\n   Name jcr:childVersionHistory\n   RequiredType REFERENCE\n-  ValueConstraints [nt:versionHistory]\n   DefaultValues null\n   AutoCreated true\n   Mandatory true",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b25503c7e069a88cd8ffa0499538e44b41f95783/jackrabbit/src/test/java/org/apache/jackrabbit/test/api/nodetype/spec/nt-versionedChild.txt",
                "sha": "8b101a09fdc648a2e2b7c2af5a5dc1c4f478864d",
                "status": "modified"
            }
        ],
        "message": "JCR-541: NPE in PredefinedNodeTypeTest.getPropertyDefSpec\n- PropertyDefinition.getValueConstratins() may return null\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@430715 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/e2272fe4ed0172d584f1094083f2aaa94d889468",
        "patched_files": [
            "nt-linkedFile.java",
            "nt-base.java",
            "nt-childNodeDefinition.java",
            "nt-nodeType.java",
            "mix-versionable.java",
            "nt-unstructured.java",
            "nt-version.java",
            "nt-query.java",
            "mix-referenceable.java",
            "nt-versionedChild.java",
            "nt-resource.java",
            "nt-propertyDefinition.java",
            "nt-versionLabels.java",
            "nt-hierarchyNode.java",
            "nt-frozenNode.java",
            "nt-versionHistory.java",
            "mix-lockable.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "PredefinedNodeTypeTest.java"
        ]
    },
    "jackrabbit_b352ea3": {
        "bug_id": "jackrabbit_b352ea3",
        "commit": "https://github.com/apache/jackrabbit/commit/b352ea311e1c5082521fdcae7116fb5dabb1f2a0",
        "file": [
            {
                "additions": 2,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ChangeLogRecord.java",
                "changes": 4,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ChangeLogRecord.java?ref=b352ea311e1c5082521fdcae7116fb5dabb1f2a0",
                "deletions": 2,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ChangeLogRecord.java",
                "patch": "@@ -114,7 +114,7 @@\n     /**\n      * Last used session for event sources.\n      */\n-    private Session lastSession;\n+    private ClusterSession lastSession;\n \n     /**\n      * Create a new instance of this class. Used when serializing.\n@@ -358,7 +358,7 @@ private EventState createEventState(int type, NodeId parentId, Path parentPath,\n      * @return session\n      */\n     private Session getOrCreateSession(String userId) {\n-        if (lastSession == null || !lastSession.getUserID().equals(userId)) {\n+        if (lastSession == null || !lastSession.isUserId(userId)) {\n             lastSession = new ClusterSession(userId);\n         }\n         return lastSession;",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ChangeLogRecord.java",
                "sha": "2a8e8b48225e03007c5f0e8619955bf2a57bdc2e",
                "status": "modified"
            },
            {
                "additions": 17,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterSession.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterSession.java?ref=b352ea311e1c5082521fdcae7116fb5dabb1f2a0",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterSession.java",
                "patch": "@@ -55,6 +55,22 @@ public ClusterSession(String userId) {\n         this.userId = userId;\n     }\n \n+    /**\n+     * Returns <code>true</code> if the given <code>userId</code> is the same as\n+     * the {@link #userId} of this session.\n+     *\n+     * @param userId the user id or <code>null</code>.\n+     * @return <code>true</code> if they are the same; <code>false</code>\n+     *         otherwise.\n+     */\n+    boolean isUserId(String userId) {\n+        if (userId == null) {\n+            return this.userId == null;\n+        } else {\n+            return userId.equals(this.userId);\n+        }\n+    }\n+\n     /**\n      * {@inheritDoc}\n      */\n@@ -284,7 +300,7 @@ public void removeLockToken(String s) {\n     public boolean equals(Object obj) {\n         if (obj instanceof ClusterSession) {\n             ClusterSession other = (ClusterSession) obj;\n-            return userId.equals(other.userId);\n+            return isUserId(other.userId);\n         }\n         return false;\n     }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/cluster/ClusterSession.java",
                "sha": "071e0f035dd9c972eba08a29bf6af14434684f87",
                "status": "modified"
            },
            {
                "additions": 19,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/ClusterRecordTest.java",
                "changes": 19,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/ClusterRecordTest.java?ref=b352ea311e1c5082521fdcae7116fb5dabb1f2a0",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/ClusterRecordTest.java",
                "patch": "@@ -116,6 +116,25 @@ public void testUpdateOperation() throws Exception {\n         assertEquals(listener.getClusterEvents().get(0), update);\n     }\n \n+    /**\n+     * Test producing and consuming an update with a null userId\n+     */\n+    public void testUpdateOperationWithNullUserId() throws Exception {\n+        UpdateEvent update = factory.createUpdateOperationWithNullUserId();\n+\n+        UpdateEventChannel channel = master.createUpdateChannel(DEFAULT_WORKSPACE);\n+        channel.updateCreated(update);\n+        channel.updatePrepared(update);\n+        channel.updateCommitted(update, null);\n+\n+        SimpleEventListener listener = new SimpleEventListener();\n+        slave.createUpdateChannel(DEFAULT_WORKSPACE).setListener(listener);\n+        slave.sync();\n+\n+        assertEquals(1, listener.getClusterEvents().size());\n+        assertEquals(listener.getClusterEvents().get(0), update);\n+    }\n+\n     /**\n      * Test producing and consuming a lock operation.\n      * @throws Exception",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/ClusterRecordTest.java",
                "sha": "0ca7f5efc521734700743233808dbda96acd3319",
                "status": "modified"
            },
            {
                "additions": 39,
                "blob_url": "https://github.com/apache/jackrabbit/blob/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/UpdateEventFactory.java",
                "changes": 45,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/UpdateEventFactory.java?ref=b352ea311e1c5082521fdcae7116fb5dabb1f2a0",
                "deletions": 6,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/UpdateEventFactory.java",
                "patch": "@@ -110,10 +110,39 @@ public UpdateEvent createUpdateOperation() {\n         changes.deleted(n3);\n \n         List events = new ArrayList();\n-        events.add(createEventState(n1, Event.NODE_ADDED, \"{}n1\"));\n-        events.add(createEventState(p1, n1, Event.PROPERTY_ADDED));\n-        events.add(createEventState(p2, n2, Event.PROPERTY_REMOVED));\n-        events.add(createEventState(n3, Event.NODE_REMOVED, \"{}n3\"));\n+        events.add(createEventState(n1, Event.NODE_ADDED, \"{}n1\", session));\n+        events.add(createEventState(p1, n1, Event.PROPERTY_ADDED, session));\n+        events.add(createEventState(p2, n2, Event.PROPERTY_REMOVED, session));\n+        events.add(createEventState(n3, Event.NODE_REMOVED, \"{}n3\", session));\n+\n+        return new UpdateEvent(changes, events, System.currentTimeMillis(), \"user-data\");\n+    }\n+\n+    /**\n+     * Create an update operation.\n+     *\n+     * @return update operation\n+     */\n+    public UpdateEvent createUpdateOperationWithNullUserId() {\n+        NodeState n1 = createNodeState();\n+        NodeState n2 = createNodeState();\n+        NodeState n3 = createNodeState();\n+        PropertyState p1 = createPropertyState(n1.getNodeId(), \"{}a\");\n+        PropertyState p2 = createPropertyState(n2.getNodeId(), \"{}b\");\n+\n+        ChangeLog changes = new ChangeLog();\n+        changes.added(n1);\n+        changes.added(p1);\n+        changes.deleted(p2);\n+        changes.modified(n2);\n+        changes.deleted(n3);\n+\n+        Session s = new ClusterSession(null);\n+        List events = new ArrayList();\n+        events.add(createEventState(n1, Event.NODE_ADDED, \"{}n1\", s));\n+        events.add(createEventState(p1, n1, Event.PROPERTY_ADDED, s));\n+        events.add(createEventState(p2, n2, Event.PROPERTY_REMOVED, s));\n+        events.add(createEventState(n3, Event.NODE_REMOVED, \"{}n3\", s));\n \n         return new UpdateEvent(changes, events, System.currentTimeMillis(), \"user-data\");\n     }\n@@ -153,9 +182,11 @@ protected PropertyState createPropertyState(NodeId parentId, String name) {\n      * @param n node state\n      * @param type <code>Event.NODE_ADDED</code> or <code>Event.NODE_REMOVED</code>\n      * @param name node name\n+     * @param session the session that produced the event.\n      * @return event state\n      */\n-    protected EventState createEventState(NodeState n, int type, String name) {\n+    protected EventState createEventState(NodeState n, int type, String name,\n+                                          Session session) {\n         Path.Element relPath = pathFactory.createElement(nameFactory.create(name));\n \n         switch (type) {\n@@ -179,9 +210,11 @@ protected EventState createEventState(NodeState n, int type, String name) {\n      * @param p property state\n      * @param parent parent node state\n      * @param type <code>Event.NODE_ADDED</code> or <code>Event.NODE_REMOVED</code>\n+     * @param session the session that produces the event.\n      * @return event state\n      */\n-    protected EventState createEventState(PropertyState p, NodeState parent, int type) {\n+    protected EventState createEventState(PropertyState p, NodeState parent, int type,\n+                                          Session session) {\n         Path.Element relPath = pathFactory.createElement(p.getName());\n \n         switch (type) {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/b352ea311e1c5082521fdcae7116fb5dabb1f2a0/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/cluster/UpdateEventFactory.java",
                "sha": "29d76261a46c56d749a8961f48d33f1356e9a675",
                "status": "modified"
            }
        ],
        "message": "JCR-2213: ChangeLogRecord throws NullPointerException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@794253 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/6fb52bbcffe1efeeaf0f8c84c39649ff2c9f530e",
        "patched_files": [
            "ClusterSession.java",
            "UpdateEventFactory.java",
            "ClusterRecord.java",
            "ChangeLogRecord.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "ClusterRecordTest.java"
        ]
    },
    "jackrabbit_c4e3a76": {
        "bug_id": "jackrabbit_c4e3a76",
        "commit": "https://github.com/apache/jackrabbit/commit/c4e3a766830fd2849881db89011c1144f0eb21d4",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/c4e3a766830fd2849881db89011c1144f0eb21d4/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authorization/GlobPattern.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authorization/GlobPattern.java?ref=c4e3a766830fd2849881db89011c1144f0eb21d4",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authorization/GlobPattern.java",
                "patch": "@@ -158,7 +158,7 @@ public boolean equals(Object obj) {\n         if (obj instanceof GlobPattern) {\n             GlobPattern other = (GlobPattern) obj;\n             return nodePath.equals(other.nodePath) &&\n-                    (restriction == null) ? other.restriction == null : restriction.equals(other.restriction);\n+                    ((restriction == null) ? other.restriction == null : restriction.equals(other.restriction));\n         }\n         return false;\n     }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/c4e3a766830fd2849881db89011c1144f0eb21d4/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/authorization/GlobPattern.java",
                "sha": "b9eab6769292b68206e2e5a6a84b79c05ba3c84b",
                "status": "modified"
            },
            {
                "additions": 18,
                "blob_url": "https://github.com/apache/jackrabbit/blob/c4e3a766830fd2849881db89011c1144f0eb21d4/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/GlobPatternTest.java",
                "changes": 18,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/GlobPatternTest.java?ref=c4e3a766830fd2849881db89011c1144f0eb21d4",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/GlobPatternTest.java",
                "patch": "@@ -351,4 +351,22 @@ public void testEmptyRestriction() {\n     public void testMatchesItem() {\n        // TODO\n     }\n+\n+     public void testEquals() {\n+         GlobPattern gp1 = GlobPattern.create(\"/a/b/c\");\n+         GlobPattern gp2 = GlobPattern.create(\"/a/b/c\");\n+         assertEquals(gp1, gp2);\n+\n+         gp1 = GlobPattern.create(\"/a/b/c\");\n+         gp2 = GlobPattern.create(\"/a/b/c/d\");\n+         assertFalse(gp1.equals(gp2));\n+\n+         gp1 = GlobPattern.create(\"/a/b/c\", null);\n+         gp2 = GlobPattern.create(\"/a/b/c\", \"\");\n+         assertFalse(gp1.equals(gp2));\n+\n+         gp1 = GlobPattern.create(\"/a/b/c\", \"\");\n+         gp2 = GlobPattern.create(\"/a/b/c\", \"\");\n+         assertEquals(gp1, gp2);\n+     }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/c4e3a766830fd2849881db89011c1144f0eb21d4/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/authorization/GlobPatternTest.java",
                "sha": "d392f74abd2bf68312a35218e822cea2b200edcd",
                "status": "modified"
            }
        ],
        "message": "JCR-3882: GlobalPattern's equals() implementation throws NullPointerException\n\nApply Woonsan Ko's pull request. Thanks Pedro Teixeira for reporting the issue.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1759440 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/d0538556898985b9eb77e48f445304dd721e81c5",
        "patched_files": [
            "GlobPattern.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "GlobPatternTest.java"
        ]
    },
    "jackrabbit_d64e336": {
        "bug_id": "jackrabbit_d64e336",
        "commit": "https://github.com/apache/jackrabbit/commit/d64e3367c4bbb01e893b172bd735c1459d4c5f08",
        "file": [
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08",
                "deletions": 5,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java",
                "patch": "@@ -43,7 +43,6 @@\n import org.apache.jackrabbit.core.retention.RetentionRegistry;\n import org.apache.jackrabbit.core.security.AccessManager;\n import org.apache.jackrabbit.core.security.authorization.Permission;\n-import org.apache.jackrabbit.core.security.user.UserManagerImpl;\n import org.apache.jackrabbit.core.session.SessionContext;\n import org.apache.jackrabbit.core.state.ChildNodeEntry;\n import org.apache.jackrabbit.core.state.ItemState;\n@@ -934,10 +933,6 @@ public void checkRemoveNode(NodeState targetState, NodeId parentId,\n                 throw new RepositoryException(\"Unable to perform removal. Node is affected by a retention.\");\n             }\n         }\n-\n-        if (UserManagerImpl.includesAdmin(context.getSessionImpl().getItemManager().getNode(targetPath))) {\n-            throw new RepositoryException(\"Attempt to remove/move the admin user.\");\n-        }\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/BatchedItemOperations.java",
                "sha": "ff32888e91aa4922f35fc8c25a07d453b1a1d4ef",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08",
                "deletions": 5,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java",
                "patch": "@@ -33,7 +33,6 @@\n import org.apache.jackrabbit.core.nodetype.NodeTypeConflictException;\n import org.apache.jackrabbit.core.nodetype.NodeTypeRegistry;\n import org.apache.jackrabbit.core.security.authorization.Permission;\n-import org.apache.jackrabbit.core.security.user.UserManagerImpl;\n import org.apache.jackrabbit.core.session.SessionContext;\n import org.apache.jackrabbit.core.session.SessionOperation;\n import org.apache.jackrabbit.core.state.NodeState;\n@@ -303,10 +302,6 @@ private void checkCondition(ItemImpl item, int options, int permissions, boolean\n                 throw new RepositoryException(\"Unable to perform operation. Node is affected by a retention.\");\n             }\n         }\n-\n-        if (isRemoval && item.isNode() && UserManagerImpl.includesAdmin((NodeImpl) item)) {\n-            throw new RepositoryException(\"Attempt to remove/move the admin user.\");\n-        }\n     }\n \n     public synchronized boolean canModify(",
                "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/ItemValidator.java",
                "sha": "eb08c56812c9680ae9aab060fcb9095297c3797f",
                "status": "modified"
            },
            {
                "additions": 0,
                "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java",
                "changes": 15,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08",
                "deletions": 15,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java",
                "patch": "@@ -16,7 +16,6 @@\n  */\n package org.apache.jackrabbit.core.security.user;\n \n-import org.apache.jackrabbit.api.JackrabbitRepository;\n import org.apache.jackrabbit.api.security.principal.ItemBasedPrincipal;\n import org.apache.jackrabbit.api.security.user.Authorizable;\n import org.apache.jackrabbit.api.security.user.AuthorizableExistsException;\n@@ -1154,20 +1153,6 @@ public void loggedOut(SessionImpl session) {\n         }\n     }\n \n-    //--------------------------------------------------------------------------\n-    public static boolean includesAdmin(NodeImpl node) throws RepositoryException {\n-        SessionImpl s = (SessionImpl) node.getSession();\n-        if (s.getRepository().getDescriptorValue(JackrabbitRepository.OPTION_USER_MANAGEMENT_SUPPORTED).getBoolean()) {\n-            UserManager uMgr = s.getUserManager();\n-            if (uMgr instanceof UserManagerImpl) {\n-                UserManagerImpl uMgrImpl = (UserManagerImpl) uMgr;\n-                AuthorizableImpl admin = (AuthorizableImpl) uMgrImpl.getAuthorizable(uMgrImpl.adminId);\n-                return Text.isDescendantOrEqual(node.getPath(), admin.getNode().getPath());\n-            }\n-        }\n-        return false;\n-    }\n-\n     //------------------------------------------------------< inner classes >---\n     /**\n      * Inner class",
                "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/security/user/UserManagerImpl.java",
                "sha": "dcdc91d5b9d1142c657dfa463d9e6355a472312d",
                "status": "modified"
            },
            {
                "additions": 149,
                "blob_url": "https://github.com/apache/jackrabbit/blob/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java",
                "changes": 213,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java?ref=d64e3367c4bbb01e893b172bd735c1459d4c5f08",
                "deletions": 64,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java",
                "patch": "@@ -16,13 +16,20 @@\n  */\n package org.apache.jackrabbit.core.security.user;\n \n+import java.util.Properties;\n+import javax.jcr.Node;\n import javax.jcr.RepositoryException;\n import javax.jcr.Session;\n \n import org.apache.jackrabbit.api.security.user.AbstractUserTest;\n import org.apache.jackrabbit.api.security.user.Authorizable;\n+import org.apache.jackrabbit.api.security.user.User;\n+import org.apache.jackrabbit.api.security.user.UserManager;\n import org.apache.jackrabbit.core.NodeImpl;\n+import org.apache.jackrabbit.core.SessionImpl;\n+import org.apache.jackrabbit.core.id.NodeId;\n import org.apache.jackrabbit.core.security.principal.AdminPrincipal;\n+import org.apache.jackrabbit.spi.commons.conversion.NameResolver;\n import org.apache.jackrabbit.test.NotExecutableException;\n \n /**\n@@ -65,119 +72,197 @@ public void testRemoveSelf() throws RepositoryException, NotExecutableException\n         }\n     }\n \n+    /**\n+     * Test if the administrator is recreated upon login if the corresponding\n+     * node gets removed.\n+     *\n+     * @throws RepositoryException\n+     * @throws NotExecutableException\n+     */\n     public void testRemoveAdminNode() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n-        Session s = null;\n+        // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        // after removing the node the admin user doesn't exist any more\n+        assertNull(userMgr.getAuthorizable(adminId));\n+\n+        // login must succeed as system user mgr recreates the admin user\n+        Session s2 = getHelper().getSuperuserSession();\n         try {\n-            NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n-            s = adminNode.getSession();\n-            adminNode.remove();\n-            // use session obtained from the node as usermgr may point to a dedicated\n-            // system workspace different from the superusers workspace.\n-            s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            assertNotNull(getUserManager(s2).getAuthorizable(adminId));\n         } finally {\n-            if (s != null) {\n-                s.refresh(false);\n-            }\n+            s2.logout();\n         }\n     }\n \n-    public void testSessionRemoveItem()  throws RepositoryException, NotExecutableException {\n+    /**\n+     * Test for collisions that would prevent from recreate the admin user.\n+     * - an intermediate rep:AuthorizableFolder node with the same name\n+     */\n+    public void testAdminNodeCollidingWithAuthorizableFolder() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n-        Session s = null;\n+        // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+        String adminPath = adminNode.getPath();\n+        String adminNodeName = adminNode.getName();\n+        Node parentNode = adminNode.getParent();\n+\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        Session s2 = null;\n+        String collidingPath = null;\n         try {\n-            NodeImpl parent = (NodeImpl) ((AuthorizableImpl) admin).getNode().getParent();\n-            s = parent.getSession();\n-            s.removeItem(parent.getPath());\n+            // now create a colliding node:\n+            Node n = parentNode.addNode(adminNodeName, \"rep:AuthorizableFolder\");\n+            collidingPath = n.getPath();\n             s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n+\n+            // force recreation of admin user.\n+            s2 = getHelper().getSuperuserSession();\n+\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            assertEquals(adminNodeName, ((AuthorizableImpl) admin).getNode().getName());\n+            assertFalse(adminPath.equals(((AuthorizableImpl) admin).getNode().getPath()));\n+\n         } finally {\n-            if (s != null) {\n-                s.refresh(false);\n+            if (s2 != null) {\n+                s2.logout();\n+            }\n+            // remove the extra folder and the admin user (created underneath) again.\n+            if (collidingPath != null) {\n+                s.getNode(collidingPath).remove();\n+                s.save();\n             }\n         }\n     }\n \n-    public void testSessionMoveAdminNode()  throws RepositoryException, NotExecutableException {\n+    /**\n+     * Test for collisions that would prevent from recreate the admin user.\n+     * - a colliding node somewhere else with the same jcr:uuid.\n+     *\n+     * Test if creation of the administrator user forces the removal of some\n+     * other node in the repository that by change happens to have the same\n+     * jcr:uuid and thus inhibits the creation of the admininstrator user.\n+     */\n+    public void testAdminNodeCollidingWithRandomNode() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n-        Session s = null;\n+        // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+        NodeId nid = adminNode.getNodeId();\n+\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        Session s2 = null;\n+        String collidingPath = null;\n         try {\n-            NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n-            s = adminNode.getSession();\n-            s.move(adminNode.getPath(), \"/somewhereelse\");\n-            // use session obtained from the node as usermgr may point to a dedicated\n-            // system workspace different from the superusers workspace.\n+            // create a colliding node outside of the user tree\n+            NameResolver nr = (SessionImpl) s;\n+            // NOTE: testRootNode will not be present if users are stored in a distinct wsp.\n+            //       therefore use root node as start...\n+            NodeImpl tr = (NodeImpl) s.getRootNode();\n+            Node n = tr.addNode(nr.getQName(\"tmpNode\"), nr.getQName(testNodeType), nid);\n+            collidingPath = n.getPath();\n             s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n-        }  finally {\n-            if (s != null) {\n-                s.refresh(false);\n-            }\n-        }\n-    }\n \n-    public void testSessionMoveParentNode()  throws RepositoryException, NotExecutableException {\n-        Authorizable admin = userMgr.getAuthorizable(adminId);\n+            // force recreation of admin user.\n+            s2 = getHelper().getSuperuserSession();\n \n-        if (admin == null || !(admin instanceof AuthorizableImpl)) {\n-            throw new NotExecutableException();\n-        }\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            // the colliding node must have been removed.\n+            assertFalse(s2.nodeExists(collidingPath));\n \n-        Session s = null;\n-        try {\n-            NodeImpl parent = (NodeImpl) ((AuthorizableImpl) admin).getNode().getParent();\n-            s = parent.getSession();\n-            s.move(parent.getPath(), \"/somewhereelse\");\n-            // use session obtained from the node as usermgr may point to a dedicated\n-            // system workspace different from the superusers workspace.\n-            s.save();\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n         } finally {\n-            if (s != null) {\n-                s.refresh(false);\n+            if (s2 != null) {\n+                s2.logout();\n+            }\n+            if (collidingPath != null && s.nodeExists(collidingPath)) {\n+                s.getNode(collidingPath).remove();\n+                s.save();\n             }\n         }\n     }\n \n-    public void testWorkspaceMoveAdminNode()  throws RepositoryException, NotExecutableException {\n+    /**\n+     * Reconfiguration of the user-root-path will result in node collision\n+     * upon initialization of the built-in repository users. Test if the\n+     * UserManagerImpl in this case removes the colliding admin-user node.\n+     */\n+    public void testChangeUserRootPath() throws RepositoryException, NotExecutableException {\n         Authorizable admin = userMgr.getAuthorizable(adminId);\n \n         if (admin == null || !(admin instanceof AuthorizableImpl)) {\n             throw new NotExecutableException();\n         }\n \n         // access the node corresponding to the admin user and remove it\n+        NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n+\n+        Session s = adminNode.getSession();\n+        adminNode.remove();\n+        // use session obtained from the node as usermgr may point to a dedicated\n+        // system workspace different from the superusers workspace.\n+        s.save();\n+\n+        Session s2 = null;\n+        String collidingPath = null;\n         try {\n-            NodeImpl adminNode = ((AuthorizableImpl) admin).getNode();\n-            Session s = adminNode.getSession();\n-            s.getWorkspace().move(adminNode.getPath(), \"/somewhereelse\");\n-            fail();\n-        } catch (RepositoryException e) {\n-            // success\n+            // create a colliding user node outside of the user tree\n+            Properties props = new Properties();\n+            props.setProperty(\"usersPath\", \"/testPath\");\n+            UserManager um = new UserManagerImpl((SessionImpl) s, adminId, props);\n+            User collidingUser = um.createUser(adminId, adminId);\n+            collidingPath = ((AuthorizableImpl) collidingUser).getNode().getPath();\n+            s.save();\n+\n+            // force recreation of admin user.\n+            s2 = getHelper().getSuperuserSession();\n+\n+            admin = userMgr.getAuthorizable(adminId);\n+            assertNotNull(admin);\n+            // the colliding node must have been removed.\n+            assertFalse(s2.nodeExists(collidingPath));\n+\n+        } finally {\n+            if (s2 != null) {\n+                s2.logout();\n+            }\n+            if (collidingPath != null && s.nodeExists(collidingPath)) {\n+                s.getNode(collidingPath).remove();\n+                s.save();\n+            }\n         }\n     }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/d64e3367c4bbb01e893b172bd735c1459d4c5f08/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/security/user/AdministratorTest.java",
                "sha": "b26ac51731a8c899504728007d49b76051e5ec0f",
                "status": "modified"
            }
        ],
        "message": "JCR-3702 : NPE if user w/o read permission on admin user node removes any node\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1546953 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/e134f4233aba42748cd6b35f56eadcf9cc6c4eb5",
        "patched_files": [
            "ItemValidator.java",
            "UserManagerImpl.java",
            "BatchedItemOperations.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "UserManagerImplTest.java",
            "AdministratorTest.java"
        ]
    },
    "jackrabbit_d82b624": {
        "bug_id": "jackrabbit_d82b624",
        "commit": "https://github.com/apache/jackrabbit/commit/d82b62405dc1db67b53d6e86d2d73e3353675b63",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/jackrabbit/blob/d82b62405dc1db67b53d6e86d2d73e3353675b63/jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java?ref=d82b62405dc1db67b53d6e86d2d73e3353675b63",
                "deletions": 0,
                "filename": "jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java",
                "patch": "@@ -76,6 +76,10 @@ protected void tearDown() throws IOException {\n      * Test to validate store retrieve in cache.\n      */\n     public void testStoreRetrieve() {\n+        // FIXME: JCR-3806\n+        if (true) {\n+            return;\n+        }\n         try {\n             AsyncUploadCache pendingFiles = new AsyncUploadCache();\n             pendingFiles.init(TARGET_DIR, CACHE_DIR, 100);\n@@ -116,6 +120,10 @@ public void testStoreRetrieve() {\n      * cachePurgeTrigFactor * size.\n      */\n     public void testAutoPurge() {\n+        // FIXME: JCR-3806\n+        if (true) {\n+            return;\n+        }\n         try {\n             AsyncUploadCache pendingFiles = new AsyncUploadCache();\n             pendingFiles.init(TARGET_DIR, CACHE_DIR, 100);\n@@ -179,6 +187,10 @@ public void testAutoPurge() {\n      * cachePurgeTrigFactor * size.\n      */\n     public void testAutoPurgeWithPendingUpload() {\n+        // FIXME: JCR-3806\n+        if (true) {\n+            return;\n+        }\n         try {\n             AsyncUploadCache pendingFiles = new AsyncUploadCache();\n             pendingFiles.init(TARGET_DIR, CACHE_DIR, 100);",
                "raw_url": "https://github.com/apache/jackrabbit/raw/d82b62405dc1db67b53d6e86d2d73e3353675b63/jackrabbit-data/src/test/java/org/apache/jackrabbit/core/data/TestLocalCache.java",
                "sha": "705cc9fbe45d25dc1fefb45303c1499ee44db43d",
                "status": "modified"
            }
        ],
        "message": "JCR-3806: TestLocalCache fails occasionally with NPE\n\nIgnore tests for now\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1619422 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/054c5906503c0a0893ce2f70ae80185045a51ef1",
        "patched_files": [
            "LocalCache.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "TestLocalCache.java"
        ]
    },
    "jackrabbit_df3bb8b": {
        "bug_id": "jackrabbit_df3bb8b",
        "commit": "https://github.com/apache/jackrabbit/commit/df3bb8b94b3b34b0cd21d1c4873cb326226c8918",
        "file": [
            {
                "additions": 12,
                "blob_url": "https://github.com/apache/jackrabbit/blob/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java",
                "changes": 12,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java?ref=df3bb8b94b3b34b0cd21d1c4873cb326226c8918",
                "deletions": 0,
                "filename": "jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java",
                "patch": "@@ -271,4 +271,16 @@ public void testGetPropertyOfRemovedAncestor() throws RepositoryException {\n             rw.logout();\n         }\n     }\n+\n+    public void testGetDeepEmptyStringProperty() throws RepositoryException, NotExecutableException {\n+        Node n = testRootNode.getNode(nodeName1);\n+        Node n2 = n.addNode(nodeName2);\n+        Node n3 = n2.addNode(nodeName3);\n+        Node n4 = n3.addNode(nodeName4);\n+        Property emptyProp = n4.setProperty(propertyName1, \"\");\n+        testRootNode.save();\n+\n+        Property p = readOnly.getProperty(emptyProp.getPath());\n+        assertEquals(\"\", p.getString());\n+    }\n }",
                "raw_url": "https://github.com/apache/jackrabbit/raw/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-jcr2spi/src/test/java/org/apache/jackrabbit/jcr2spi/GetPropertyTest.java",
                "sha": "af0e96341d1fb009dee8b82b250a28e406e355b5",
                "status": "modified"
            },
            {
                "additions": 3,
                "blob_url": "https://github.com/apache/jackrabbit/blob/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java?ref=df3bb8b94b3b34b0cd21d1c4873cb326226c8918",
                "deletions": 2,
                "filename": "jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java",
                "patch": "@@ -413,9 +413,10 @@ public PropertyInfo getPropertyInfo(SessionInfo sessionInfo, PropertyId property\n                     QValue qValue = getQValueFactory(sessionInfo).create(length, uri, QValueFactoryImpl.NO_INDEX) ;\n                     return new PropertyInfoImpl(propertyId, p, propertyType, qValue);\n                 }\n-            } else if (props.contains(JCR_GET_STRING) && props.get(JCR_GET_STRING).getValue() != null) {\n+            } else if (props.contains(JCR_GET_STRING)) {\n                 // single valued non-binary property\n-                String str = props.get(JCR_GET_STRING).getValue().toString();\n+                Object v = props.get(JCR_GET_STRING).getValue();\n+                String str = (v == null) ? \"\" : v.toString();\n                 QValue qValue = ValueFormat.getQValue(str, propertyType, getNamePathResolver(sessionInfo), getQValueFactory(sessionInfo));\n                 return new PropertyInfoImpl(propertyId, p, propertyType, qValue);\n             } else {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/df3bb8b94b3b34b0cd21d1c4873cb326226c8918/jackrabbit-spi2dav/src/main/java/org/apache/jackrabbit/spi2davex/RepositoryServiceImpl.java",
                "sha": "762dfa0dd4b5e0c2445423e2d3ac43040d08a4cd",
                "status": "modified"
            }
        ],
        "message": "JCR-3163 NPE in RepositoryServiceImpl.getPropertyInfo()\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1209033 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/9ccd17ce5df1888a815ca03f22aad6d2a82c3aa7",
        "patched_files": [
            "RepositoryServiceImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "GetPropertyTest.java"
        ]
    },
    "jackrabbit_e33c5bb": {
        "bug_id": "jackrabbit_e33c5bb",
        "commit": "https://github.com/apache/jackrabbit/commit/e33c5bbe93b3858802cf8b16c28ddd2cc73405bd",
        "file": [
            {
                "additions": 40,
                "blob_url": "https://github.com/apache/jackrabbit/blob/e33c5bbe93b3858802cf8b16c28ddd2cc73405bd/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java",
                "changes": 40,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java?ref=e33c5bbe93b3858802cf8b16c28ddd2cc73405bd",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java",
                "patch": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.jackrabbit.core.version;\n+\n+import org.apache.jackrabbit.test.AbstractJCRTest;\n+import org.apache.jackrabbit.core.UserTransactionImpl;\n+\n+import javax.jcr.Node;\n+import javax.jcr.version.Version;\n+\n+/**\n+ * Test case for JCR-1476.\n+ */\n+public class RestoreTest extends AbstractJCRTest {\n+\n+    public void testRestoreWithXA() throws Exception {\n+        Node n = testRootNode.addNode(nodeName1);\n+        n.addMixin(mixVersionable);\n+        testRootNode.save();\n+        UserTransactionImpl tx = new UserTransactionImpl(superuser);\n+        tx.begin();\n+        Version v10 = n.checkin();\n+        n.restore(v10, true);\n+        tx.commit();\n+    }\n+}",
                "raw_url": "https://github.com/apache/jackrabbit/raw/e33c5bbe93b3858802cf8b16c28ddd2cc73405bd/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/version/RestoreTest.java",
                "sha": "ce5af6f644f4281335b4ca1c4d8c2f674d636fb9",
                "status": "added"
            }
        ],
        "message": "JCR-1476: Restore to base version throws NullPointerException\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@637108 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/7974dc328bb4a64753967ea9f6b0eeb71b6d48ef",
        "patched_files": [
            "Restore.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "RestoreTest.java"
        ]
    },
    "jackrabbit_e6560c8": {
        "bug_id": "jackrabbit_e6560c8",
        "commit": "https://github.com/apache/jackrabbit/commit/e6560c8336190d62dd64b0b0798fd1f256261fc6",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/e6560c8336190d62dd64b0b0798fd1f256261fc6/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingConfigurationImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingConfigurationImpl.java?ref=e6560c8336190d62dd64b0b0798fd1f256261fc6",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingConfigurationImpl.java",
                "patch": "@@ -950,7 +950,7 @@ public Object next() {\n                 try {\n                     nodeStates = new Iterator() {\n \n-                        private NodeState next =\n+                        private NodeState next = context.getParentId() == null ? null :\n                                 (NodeState) ism.getItemState(context.getParentId());\n \n                         public void remove() {",
                "raw_url": "https://github.com/apache/jackrabbit/raw/e6560c8336190d62dd64b0b0798fd1f256261fc6/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/query/lucene/IndexingConfigurationImpl.java",
                "sha": "281bdd722f7014d50877ed36a40dac85d981c773",
                "status": "modified"
            },
            {
                "additions": 5,
                "blob_url": "https://github.com/apache/jackrabbit/blob/e6560c8336190d62dd64b0b0798fd1f256261fc6/jackrabbit-core/src/test/repository/workspaces/indexing-test/indexing-configuration.xml",
                "changes": 5,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/repository/workspaces/indexing-test/indexing-configuration.xml?ref=e6560c8336190d62dd64b0b0798fd1f256261fc6",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/repository/workspaces/indexing-test/indexing-configuration.xml",
                "patch": "@@ -37,6 +37,11 @@\n         <property>text</property>\n     </index-rule>\n \n+    <index-rule nodeType=\"nt:unstructured\"\n+                condition=\"ancestor::*/@rule = 'ancestor-axis'\">\n+      <property>Text</property>\n+    </index-rule>\n+\n     <index-rule nodeType=\"nt:hierarchyNode\">\n         <!-- do not index any properties -->\n     </index-rule>",
                "raw_url": "https://github.com/apache/jackrabbit/raw/e6560c8336190d62dd64b0b0798fd1f256261fc6/jackrabbit-core/src/test/repository/workspaces/indexing-test/indexing-configuration.xml",
                "sha": "dc0bf1d67c887108b4608df333cd390153f14b07",
                "status": "modified"
            }
        ],
        "message": "JCR-2580: NullPointerException when using ancestor axis in indexing configuration\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@926354 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/668d8073ec9ebe8fb472c82980aadb18dfce93f6",
        "patched_files": [
            "IndexingConfigurationImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "IndexingConfigurationImplTest.java"
        ]
    },
    "jackrabbit_e7094b4": {
        "bug_id": "jackrabbit_e7094b4",
        "commit": "https://github.com/apache/jackrabbit/commit/e7094b41c645a957a2dc2057584d7f11b6243b70",
        "file": [
            {
                "additions": 16,
                "blob_url": "https://github.com/apache/jackrabbit/blob/e7094b41c645a957a2dc2057584d7f11b6243b70/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "changes": 16,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java?ref=e7094b41c645a957a2dc2057584d7f11b6243b70",
                "deletions": 0,
                "filename": "jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "patch": "@@ -1,3 +1,19 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n package org.apache.jackrabbit.core;\n \n import java.util.ConcurrentModificationException;",
                "raw_url": "https://github.com/apache/jackrabbit/raw/e7094b41c645a957a2dc2057584d7f11b6243b70/jackrabbit-core/src/test/java/org/apache/jackrabbit/core/NPEandCMETest.java",
                "sha": "2a404ab4a6a86078e07c7e8811e4cc5bb3b20178",
                "status": "modified"
            }
        ],
        "message": "JCR-3063: NullPointerException in ItemManager\n\nAdd missing license header\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1174887 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/46fc0c5d78527b840955c2a432278979198d2342",
        "patched_files": [],
        "repo": "jackrabbit",
        "unit_tests": [
            "NPEandCMETest.java"
        ]
    },
    "jackrabbit_f64c554": {
        "bug_id": "jackrabbit_f64c554",
        "commit": "https://github.com/apache/jackrabbit/commit/f64c5543baead3bad17977b6ef29e4f5bf2c955c",
        "file": [
            {
                "additions": 8,
                "blob_url": "https://github.com/apache/jackrabbit/blob/f64c5543baead3bad17977b6ef29e4f5bf2c955c/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java",
                "changes": 13,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java?ref=f64c5543baead3bad17977b6ef29e4f5bf2c955c",
                "deletions": 5,
                "filename": "contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java",
                "patch": "@@ -68,16 +68,19 @@ public void accept(OperationVisitor visitor) throws PathNotFoundException, ItemE\n      */\n     public void persisted(CacheBehaviour cacheBehaviour) {\n         if (cacheBehaviour == CacheBehaviour.INVALIDATE) {\n+            NodeEntry entry;\n             if (nodeState == null || removeExisting) {\n                 // invalidate the complete tree\n-                NodeEntry root = nodeState.getNodeEntry();\n-                while (root.getParent() != null) {\n-                    root = root.getParent();\n+                // -> start searching root-entry from any version-entry or\n+                //    from the given nodestate\n+                entry = (nodeState == null) ? versionStates[0].getNodeEntry() : nodeState.getNodeEntry();\n+                while (entry.getParent() != null) {\n+                    entry = entry.getParent();\n                 }\n-                root.invalidate(true);\n             } else {\n-                nodeState.getHierarchyEntry().invalidate(true);\n+                entry = nodeState.getNodeEntry();\n             }\n+            entry.invalidate(true);\n         }\n     }\n     //----------------------------------------< Access Operation Parameters >---",
                "raw_url": "https://github.com/apache/jackrabbit/raw/f64c5543baead3bad17977b6ef29e4f5bf2c955c/contrib/spi/jcr2spi/src/main/java/org/apache/jackrabbit/jcr2spi/operation/Restore.java",
                "sha": "5e2c62d02d9cc7be0e52a6c0e6045885f94bbbc9",
                "status": "modified"
            }
        ],
        "message": "#0000 - avoid NPE upon Restore.persisted in case of a \n        Workspace.restore.\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@508431 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/7a058b665b0568b0f903cfeaac47024b3f967a68",
        "patched_files": [
            "Restore.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "RestoreTest.java"
        ]
    },
    "jackrabbit_f8957a7": {
        "bug_id": "jackrabbit_f8957a7",
        "commit": "https://github.com/apache/jackrabbit/commit/f8957a704cd301c5707292108df2b1920568efde",
        "file": [
            {
                "additions": 4,
                "blob_url": "https://github.com/apache/jackrabbit/blob/f8957a704cd301c5707292108df2b1920568efde/src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java",
                "changes": 6,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java?ref=f8957a704cd301c5707292108df2b1920568efde",
                "deletions": 2,
                "filename": "src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java",
                "patch": "@@ -50,7 +50,7 @@\n     private PersistenceManagerConfig pmc;\n \n     /**\n-     * Workspace search index configuration.\n+     * Workspace search index configuration. Can be <code>null</code>.\n      */\n     private SearchConfig sc;\n \n@@ -79,7 +79,9 @@\n      */\n     public void init() throws ConfigurationException {\n         fsc.init();\n-        sc.init();\n+        if (sc != null) {\n+            sc.init();\n+        }\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/jackrabbit/raw/f8957a704cd301c5707292108df2b1920568efde/src/java/org/apache/jackrabbit/core/config/WorkspaceConfig.java",
                "sha": "e216a1d1fd2143f72a65810ea80f09961a116cbb",
                "status": "modified"
            }
        ],
        "message": "Fixed NPE in WorkspaceConfig.init() when SearchConfig is not available. (JCR-71)\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/jackrabbit/trunk@157916 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/0647faf8d8dc2d52ba182c5436575337f8c28eb8",
        "patched_files": [
            "WorkspaceConfig.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "WorkspaceConfigTest.java"
        ]
    },
    "jackrabbit_f95af78": {
        "bug_id": "jackrabbit_f95af78",
        "commit": "https://github.com/apache/jackrabbit/commit/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f",
        "file": [
            {
                "additions": 1,
                "blob_url": "https://github.com/apache/jackrabbit/blob/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java",
                "changes": 2,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java?ref=f95af78c5a567f14c3acfea0c6b7710ce0e25d9f",
                "deletions": 1,
                "filename": "jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java",
                "patch": "@@ -127,7 +127,7 @@ public Version getLinearSuccessor() throws RepositoryException {\n      */\n     public javax.jcr.version.Version getLinearPredecessor() throws RepositoryException {\n         InternalVersion pred = getInternalVersion().getLinearPredecessor();\n-        return (Version) sessionContext.getSessionImpl().getNodeById(pred.getId());\n+        return pred == null ? null : (Version) sessionContext.getSessionImpl().getNodeById(pred.getId());\n     }\n \n     /**",
                "raw_url": "https://github.com/apache/jackrabbit/raw/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/version/VersionImpl.java",
                "sha": "2070a6a74c67be28b81376210c11c4a9f1dc8c12",
                "status": "modified"
            },
            {
                "additions": 10,
                "blob_url": "https://github.com/apache/jackrabbit/blob/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java",
                "changes": 17,
                "contents_url": "https://api.github.com/repos/apache/jackrabbit/contents/jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java?ref=f95af78c5a567f14c3acfea0c6b7710ce0e25d9f",
                "deletions": 7,
                "filename": "jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java",
                "patch": "@@ -41,31 +41,34 @@ public void testGetPredecessors() throws RepositoryException {\n \n         assertTrue(\"Version should have at minimum one predecessor version.\", version.getPredecessors().length > 0);\n     }\n-    \n+\n     /**\n-     * Checks ontaining the linear predecessor.\n+     * Checks obtaining the linear predecessor.\n      * @since JCR 2.0\n      */\n     public void testGetLinearPredecessorSuccessor() throws RepositoryException {\n \n         String path = versionableNode.getPath();\n-        \n+\n         VersionManager vm = versionableNode.getSession().getWorkspace().getVersionManager();\n-        \n+\n         // get the previous version\n         Version pred = vm.getBaseVersion(path);\n \n+        // shouldn't have a predecessor\n+        assertNull(pred.getLinearPredecessor());\n+\n         // shouldn't have a successor yet\n         assertNull(pred.getLinearSuccessor());\n-        \n+\n         // check root version\n         Version root = vm.getVersionHistory(path).getRootVersion();\n         assertNull(root.getLinearSuccessor());\n-        \n+\n         // create a new version\n         vm.checkout(path);\n         Version version = vm.checkin(path);\n-        \n+\n         // refresh the predecessor\n         pred = (Version)versionableNode.getSession().getNode(pred.getPath());\n ",
                "raw_url": "https://github.com/apache/jackrabbit/raw/f95af78c5a567f14c3acfea0c6b7710ce0e25d9f/jackrabbit-jcr-tests/src/main/java/org/apache/jackrabbit/test/api/version/GetPredecessorsTest.java",
                "sha": "00ab2a5575240cd5228cc3720ebced5ba274569d",
                "status": "modified"
            }
        ],
        "message": "JCR-4324: NPE on Version.getLinearPredecessor() implementation\n\ngit-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1834424 13f79535-47bb-0310-9956-ffa450edef68",
        "parent": "https://github.com/apache/jackrabbit/commit/4e6739f9fc0759ab7ef1cc7a988e604f755c1d28",
        "patched_files": [
            "VersionImpl.java"
        ],
        "repo": "jackrabbit",
        "unit_tests": [
            "GetPredecessorsTest.java"
        ]
    }
}