<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Schema.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-broker</a> &gt; <a href="../index.html" class="el_bundle">pinot-common</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.common.data</a> &gt; <span class="el_source">Schema.java</span></div><h1>Schema.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.common.data;

import com.google.common.base.Preconditions;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.linkedin.pinot.common.data.FieldSpec.DataType;
import com.linkedin.pinot.common.data.FieldSpec.FieldType;
import com.linkedin.pinot.common.utils.EqualityUtils;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import javax.annotation.Nonnull;
import org.codehaus.jackson.annotate.JsonIgnore;
import org.codehaus.jackson.annotate.JsonIgnoreProperties;
import org.codehaus.jackson.map.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


/**
 * The &lt;code&gt;Schema&lt;/code&gt; class is defined for each table to describe the details of the table's fields (columns).
 * &lt;p&gt;Four field types are supported: DIMENSION, METRIC, TIME, DATE_TIME.
 * ({@link com.linkedin.pinot.common.data.DimensionFieldSpec}, {@link com.linkedin.pinot.common.data.MetricFieldSpec},
 * {@link com.linkedin.pinot.common.data.TimeFieldSpec}, {@link com.linkedin.pinot.common.data.DateTimeFieldSpec})
 * &lt;p&gt;For each field, a {@link com.linkedin.pinot.common.data.FieldSpec} is defined to provide the details of the field.
 * &lt;p&gt;There could be multiple DIMENSION or METRIC or DATE_TIME fields, but at most 1 TIME field.
 * &lt;p&gt;In pinot, we store data using 5 &lt;code&gt;DataType&lt;/code&gt;s: INT, LONG, FLOAT, DOUBLE, STRING. All other
 * &lt;code&gt;DataType&lt;/code&gt;s will be converted to one of them.
 */
@SuppressWarnings(&quot;unused&quot;)
@JsonIgnoreProperties(ignoreUnknown = true)
<span class="fc" id="L55">public final class Schema {</span>
<span class="fc" id="L56">  private static final Logger LOGGER = LoggerFactory.getLogger(Schema.class);</span>
<span class="fc" id="L57">  private static final ObjectMapper MAPPER = new ObjectMapper();</span>

  private String _schemaName;
<span class="fc" id="L60">  private final List&lt;DimensionFieldSpec&gt; _dimensionFieldSpecs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L61">  private final List&lt;MetricFieldSpec&gt; _metricFieldSpecs = new ArrayList&lt;&gt;();</span>
  private TimeFieldSpec _timeFieldSpec;
<span class="fc" id="L63">  private final List&lt;DateTimeFieldSpec&gt; _dateTimeFieldSpecs = new ArrayList&lt;&gt;();</span>

  // Json ignored fields
<span class="fc" id="L66">  private transient final Map&lt;String, FieldSpec&gt; _fieldSpecMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L67">  private transient final List&lt;String&gt; _dimensionNames = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L68">  private transient final List&lt;String&gt; _metricNames = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L69">  private transient final List&lt;String&gt; _dateTimeNames = new ArrayList&lt;&gt;();</span>

  @Nonnull
  public static Schema fromFile(@Nonnull File schemaFile) throws IOException {
<span class="fc" id="L73">    return MAPPER.readValue(schemaFile, Schema.class);</span>
  }

  @Nonnull
  public static Schema fromString(@Nonnull String schemaString) throws IOException {
<span class="fc" id="L78">    return MAPPER.readValue(schemaString, Schema.class);</span>
  }

  @Nonnull
  public static Schema fromInputSteam(@Nonnull InputStream schemaInputStream) throws IOException {
<span class="fc" id="L83">    return MAPPER.readValue(schemaInputStream, Schema.class);</span>
  }

  /**
   * NOTE: schema name could be null in tests
   */
  public String getSchemaName() {
<span class="fc" id="L90">    return _schemaName;</span>
  }

  public void setSchemaName(@Nonnull String schemaName) {
<span class="fc" id="L94">    _schemaName = schemaName;</span>
<span class="fc" id="L95">  }</span>

  @Nonnull
  public List&lt;DimensionFieldSpec&gt; getDimensionFieldSpecs() {
<span class="fc" id="L99">    return _dimensionFieldSpecs;</span>
  }

  /**
   * Required by JSON deserializer. DO NOT USE. DO NOT REMOVE.
   * Adding @Deprecated to prevent usage
   * @param dimensionFieldSpecs
   */
  @Deprecated
  public void setDimensionFieldSpecs(@Nonnull List&lt;DimensionFieldSpec&gt; dimensionFieldSpecs) {
<span class="fc" id="L109">    Preconditions.checkState(_dimensionFieldSpecs.isEmpty());</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">    for (DimensionFieldSpec dimensionFieldSpec : dimensionFieldSpecs) {</span>
<span class="fc" id="L112">      addField(dimensionFieldSpec);</span>
<span class="fc" id="L113">    }</span>
<span class="fc" id="L114">  }</span>

  @Nonnull
  public List&lt;MetricFieldSpec&gt; getMetricFieldSpecs() {
<span class="fc" id="L118">    return _metricFieldSpecs;</span>
  }

  /**
   * Required by JSON deserializer. DO NOT USE. DO NOT REMOVE.
   * Adding @Deprecated to prevent usage
   * @param metricFieldSpecs
   */
  @Deprecated
  public void setMetricFieldSpecs(@Nonnull List&lt;MetricFieldSpec&gt; metricFieldSpecs) {
<span class="fc" id="L128">    Preconditions.checkState(_metricFieldSpecs.isEmpty());</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">    for (MetricFieldSpec metricFieldSpec : metricFieldSpecs) {</span>
<span class="fc" id="L131">      addField(metricFieldSpec);</span>
<span class="fc" id="L132">    }</span>
<span class="fc" id="L133">  }</span>

  @Nonnull
  public List&lt;DateTimeFieldSpec&gt; getDateTimeFieldSpecs() {
<span class="nc" id="L137">    return _dateTimeFieldSpecs;</span>
  }

  /**
   * Required by JSON deserializer. DO NOT USE. DO NOT REMOVE.
   * Adding @Deprecated to prevent usage
   * @param dateTimeFieldSpecs
   */
  @Deprecated
  public void setDateTimeFieldSpecs(@Nonnull List&lt;DateTimeFieldSpec&gt; dateTimeFieldSpecs) {
<span class="fc" id="L147">    Preconditions.checkState(_dateTimeFieldSpecs.isEmpty());</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">    for (DateTimeFieldSpec dateTimeFieldSpec : dateTimeFieldSpecs) {</span>
<span class="fc" id="L150">      addField(dateTimeFieldSpec);</span>
<span class="fc" id="L151">    }</span>
<span class="fc" id="L152">  }</span>

  public TimeFieldSpec getTimeFieldSpec() {
<span class="fc" id="L155">    return _timeFieldSpec;</span>
  }

  /**
   * Required by JSON deserializer. DO NOT USE. DO NOT REMOVE.
   * Adding @Deprecated to prevent usage
   * @param timeFieldSpec
   */
  @Deprecated
  public void setTimeFieldSpec(TimeFieldSpec timeFieldSpec) {
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    if (timeFieldSpec != null) {</span>
<span class="fc" id="L166">      addField(timeFieldSpec);</span>
    }
<span class="fc" id="L168">  }</span>

  public void addField(@Nonnull FieldSpec fieldSpec) {
<span class="fc" id="L171">    Preconditions.checkNotNull(fieldSpec);</span>
<span class="fc" id="L172">    String columnName = fieldSpec.getName();</span>
<span class="fc" id="L173">    Preconditions.checkNotNull(columnName);</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">    Preconditions.checkState(!_fieldSpecMap.containsKey(columnName),</span>
        &quot;Field spec already exists for column: &quot; + columnName);

<span class="fc" id="L177">    FieldType fieldType = fieldSpec.getFieldType();</span>
<span class="pc bpc" id="L178" title="1 of 5 branches missed.">    switch (fieldType) {</span>
      case DIMENSION:
<span class="fc" id="L180">        _dimensionNames.add(columnName);</span>
<span class="fc" id="L181">        _dimensionFieldSpecs.add((DimensionFieldSpec) fieldSpec);</span>
<span class="fc" id="L182">        break;</span>
      case METRIC:
<span class="fc" id="L184">        _metricNames.add(columnName);</span>
<span class="fc" id="L185">        _metricFieldSpecs.add((MetricFieldSpec) fieldSpec);</span>
<span class="fc" id="L186">        break;</span>
      case TIME:
<span class="fc" id="L188">        _timeFieldSpec = (TimeFieldSpec) fieldSpec;</span>
<span class="fc" id="L189">        break;</span>
      case DATE_TIME:
<span class="fc" id="L191">        _dateTimeNames.add(columnName);</span>
<span class="fc" id="L192">        _dateTimeFieldSpecs.add((DateTimeFieldSpec) fieldSpec);</span>
<span class="fc" id="L193">        break;</span>
      default:
<span class="nc" id="L195">        throw new UnsupportedOperationException(&quot;Unsupported field type: &quot; + fieldType);</span>
    }

<span class="fc" id="L198">    _fieldSpecMap.put(columnName, fieldSpec);</span>
<span class="fc" id="L199">  }</span>

  @Deprecated
  // For third-eye backward compatible.
  public void addField(@Nonnull String columnName, @Nonnull FieldSpec fieldSpec) {
<span class="nc" id="L204">    addField(fieldSpec);</span>
<span class="nc" id="L205">  }</span>

  public boolean removeField(String columnName) {
<span class="fc" id="L208">    FieldSpec existingFieldSpec = _fieldSpecMap.remove(columnName);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">    if (existingFieldSpec != null) {</span>
<span class="fc" id="L210">      FieldType fieldType = existingFieldSpec.getFieldType();</span>
<span class="pc bpc" id="L211" title="4 of 5 branches missed.">      switch (fieldType) {</span>
        case DIMENSION:
<span class="nc" id="L213">          int index = _dimensionNames.indexOf(columnName);</span>
<span class="nc" id="L214">          _dimensionNames.remove(index);</span>
<span class="nc" id="L215">          _dimensionFieldSpecs.remove(index);</span>
<span class="nc" id="L216">          break;</span>
        case METRIC:
<span class="nc" id="L218">          index = _metricNames.indexOf(columnName);</span>
<span class="nc" id="L219">          _metricNames.remove(index);</span>
<span class="nc" id="L220">          _metricFieldSpecs.remove(index);</span>
<span class="nc" id="L221">          break;</span>
        case TIME:
<span class="nc" id="L223">          _timeFieldSpec = null;</span>
<span class="nc" id="L224">          break;</span>
        case DATE_TIME:
<span class="fc" id="L226">          index = _dateTimeNames.indexOf(columnName);</span>
<span class="fc" id="L227">          _dateTimeNames.remove(index);</span>
<span class="fc" id="L228">          _dateTimeFieldSpecs.remove(index);</span>
<span class="fc" id="L229">          break;</span>
        default:
<span class="nc" id="L231">          throw new UnsupportedOperationException(&quot;Unsupported field type: &quot; + fieldType);</span>
      }
<span class="fc" id="L233">      return true;</span>
    } else {
<span class="fc" id="L235">      return false;</span>
    }
  }

  public boolean hasColumn(@Nonnull String columnName) {
<span class="fc" id="L240">    return _fieldSpecMap.containsKey(columnName);</span>
  }

  @JsonIgnore
  @Nonnull
  public Map&lt;String, FieldSpec&gt; getFieldSpecMap() {
<span class="fc" id="L246">    return _fieldSpecMap;</span>
  }

  @JsonIgnore
  @Nonnull
  public Set&lt;String&gt; getColumnNames() {
<span class="fc" id="L252">    return _fieldSpecMap.keySet();</span>
  }

  @JsonIgnore
  @Nonnull
  public Collection&lt;FieldSpec&gt; getAllFieldSpecs() {
<span class="fc" id="L258">    return _fieldSpecMap.values();</span>
  }

  public int size() {
<span class="nc" id="L262">    return _fieldSpecMap.size();</span>
  }

  @JsonIgnore
  public FieldSpec getFieldSpecFor(@Nonnull String columnName) {
<span class="fc" id="L267">    return _fieldSpecMap.get(columnName);</span>
  }

  @JsonIgnore
  public MetricFieldSpec getMetricSpec(@Nonnull String metricName) {
<span class="fc" id="L272">    FieldSpec fieldSpec = _fieldSpecMap.get(metricName);</span>
<span class="pc bpc" id="L273" title="2 of 4 branches missed.">    if (fieldSpec != null &amp;&amp; fieldSpec.getFieldType() == FieldType.METRIC) {</span>
<span class="fc" id="L274">      return (MetricFieldSpec) fieldSpec;</span>
    }
<span class="nc" id="L276">    return null;</span>
  }

  @JsonIgnore
  public DimensionFieldSpec getDimensionSpec(@Nonnull String dimensionName) {
<span class="fc" id="L281">    FieldSpec fieldSpec = _fieldSpecMap.get(dimensionName);</span>
<span class="pc bpc" id="L282" title="2 of 4 branches missed.">    if (fieldSpec != null &amp;&amp; fieldSpec.getFieldType() == FieldType.DIMENSION) {</span>
<span class="fc" id="L283">      return (DimensionFieldSpec) fieldSpec;</span>
    }
<span class="nc" id="L285">    return null;</span>
  }

  @JsonIgnore
  public DateTimeFieldSpec getDateTimeSpec(@Nonnull String dateTimeName) {
<span class="fc" id="L290">    FieldSpec fieldSpec = _fieldSpecMap.get(dateTimeName);</span>
<span class="pc bpc" id="L291" title="2 of 4 branches missed.">    if (fieldSpec != null &amp;&amp; fieldSpec.getFieldType() == FieldType.DATE_TIME) {</span>
<span class="fc" id="L292">      return (DateTimeFieldSpec) fieldSpec;</span>
    }
<span class="nc" id="L294">    return null;</span>
  }

  @JsonIgnore
  @Nonnull
  public List&lt;String&gt; getDimensionNames() {
<span class="fc" id="L300">    return _dimensionNames;</span>
  }

  @JsonIgnore
  @Nonnull
  public List&lt;String&gt; getMetricNames() {
<span class="fc" id="L306">    return _metricNames;</span>
  }

  @JsonIgnore
  @Nonnull
  public List&lt;String&gt; getDateTimeNames() {
<span class="fc" id="L312">    return _dateTimeNames;</span>
  }

  @JsonIgnore
  public String getTimeColumnName() {
<span class="fc bfc" id="L317" title="All 2 branches covered.">    return (_timeFieldSpec != null) ? _timeFieldSpec.getName() : null;</span>
  }

  @JsonIgnore
  public TimeUnit getIncomingTimeUnit() {
<span class="nc bnc" id="L322" title="All 2 branches missed.">    return (_timeFieldSpec != null) ? _timeFieldSpec.getIncomingGranularitySpec().getTimeType() : null;</span>
  }

  @JsonIgnore
  public TimeUnit getOutgoingTimeUnit() {
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">    return (_timeFieldSpec != null) ? _timeFieldSpec.getOutgoingGranularitySpec().getTimeType() : null;</span>
  }

  @JsonIgnore
  @Nonnull
  public String getJSONSchema() {
<span class="fc" id="L333">    JsonObject jsonSchema = new JsonObject();</span>
<span class="fc" id="L334">    jsonSchema.addProperty(&quot;schemaName&quot;, _schemaName);</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">    if (!_dimensionFieldSpecs.isEmpty()) {</span>
<span class="fc" id="L336">      JsonArray jsonArray = new JsonArray();</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">      for (DimensionFieldSpec dimensionFieldSpec : _dimensionFieldSpecs) {</span>
<span class="fc" id="L338">        jsonArray.add(dimensionFieldSpec.toJsonObject());</span>
<span class="fc" id="L339">      }</span>
<span class="fc" id="L340">      jsonSchema.add(&quot;dimensionFieldSpecs&quot;, jsonArray);</span>
    }
<span class="fc bfc" id="L342" title="All 2 branches covered.">    if (!_metricFieldSpecs.isEmpty()) {</span>
<span class="fc" id="L343">      JsonArray jsonArray = new JsonArray();</span>
<span class="fc bfc" id="L344" title="All 2 branches covered.">      for (MetricFieldSpec metricFieldSpec : _metricFieldSpecs) {</span>
<span class="fc" id="L345">        jsonArray.add(metricFieldSpec.toJsonObject());</span>
<span class="fc" id="L346">      }</span>
<span class="fc" id="L347">      jsonSchema.add(&quot;metricFieldSpecs&quot;, jsonArray);</span>
    }
<span class="fc bfc" id="L349" title="All 2 branches covered.">    if (_timeFieldSpec != null) {</span>
<span class="fc" id="L350">      jsonSchema.add(&quot;timeFieldSpec&quot;, _timeFieldSpec.toJsonObject());</span>
    }
<span class="fc bfc" id="L352" title="All 2 branches covered.">    if (!_dateTimeFieldSpecs.isEmpty()) {</span>
<span class="fc" id="L353">      JsonArray jsonArray = new JsonArray();</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">      for (DateTimeFieldSpec dateTimeFieldSpec : _dateTimeFieldSpecs) {</span>
<span class="fc" id="L355">        jsonArray.add(dateTimeFieldSpec.toJsonObject());</span>
<span class="fc" id="L356">      }</span>
<span class="fc" id="L357">      jsonSchema.add(&quot;dateTimeFieldSpecs&quot;, jsonArray);</span>
    }
<span class="fc" id="L359">    return new GsonBuilder().setPrettyPrinting().create().toJson(jsonSchema);</span>
  }

  /**
   * Validates a pinot schema.
   * &lt;p&gt;The following validations are performed:
   * &lt;ul&gt;
   *   &lt;li&gt;For dimension, time, date time fields, support {@link DataType}: INT, LONG, FLOAT, DOUBLE, STRING&lt;/li&gt;
   *   &lt;li&gt;For non-derived metric fields, support {@link DataType}: INT, LONG, FLOAT, DOUBLE&lt;/li&gt;
   * &lt;/ul&gt;
   *
   * @param ctxLogger Logger used to log the message (if null, the current class logger is used)
   * @return Whether schema is valid
   */
  public boolean validate(Logger ctxLogger) {
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">    if (ctxLogger == null) {</span>
<span class="nc" id="L375">      ctxLogger = LOGGER;</span>
    }

    // Log ALL the schema errors that may be present.
<span class="fc bfc" id="L379" title="All 2 branches covered.">    for (FieldSpec fieldSpec : _fieldSpecMap.values()) {</span>
<span class="fc" id="L380">      FieldType fieldType = fieldSpec.getFieldType();</span>
<span class="fc" id="L381">      DataType dataType = fieldSpec.getDataType();</span>
<span class="fc" id="L382">      String fieldName = fieldSpec.getName();</span>
<span class="pc bpc" id="L383" title="1 of 3 branches missed.">      switch (fieldType) {</span>
        case DIMENSION:
        case TIME:
        case DATE_TIME:
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">          switch (dataType) {</span>
            case INT:
            case LONG:
            case FLOAT:
            case DOUBLE:
            case STRING:
<span class="fc" id="L393">              break;</span>
            default:
<span class="nc" id="L395">              ctxLogger.info(&quot;Unsupported data type: {} in DIMENSION/TIME field: {}&quot;, dataType, fieldName);</span>
<span class="nc" id="L396">              return false;</span>
          }
          break;
        case METRIC:
<span class="pc bpc" id="L400" title="1 of 3 branches missed.">          switch (dataType) {</span>
            case INT:
            case LONG:
            case FLOAT:
            case DOUBLE:
<span class="fc" id="L405">              break;</span>
            case STRING:
<span class="fc" id="L407">              MetricFieldSpec metricFieldSpec = (MetricFieldSpec) fieldSpec;</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">              if (!metricFieldSpec.isDerivedMetric()) {</span>
<span class="fc" id="L409">                ctxLogger.info(&quot;Unsupported data type: STRING in non-derived METRIC field: {}&quot;, fieldName);</span>
<span class="fc" id="L410">                return false;</span>
              }
              break;
            default:
<span class="nc" id="L414">              ctxLogger.info(&quot;Unsupported data type: {} in METRIC field: {}&quot;, dataType, fieldName);</span>
<span class="nc" id="L415">              return false;</span>
          }
          break;
        default:
<span class="nc" id="L419">          ctxLogger.info(&quot;Unsupported field type: {} for field: {}&quot;, dataType, fieldName);</span>
<span class="nc" id="L420">          return false;</span>
      }
<span class="fc" id="L422">    }</span>

<span class="fc" id="L424">    return true;</span>
  }

<span class="fc" id="L427">  public static class SchemaBuilder {</span>
    private Schema _schema;

<span class="fc" id="L430">    public SchemaBuilder() {</span>
<span class="fc" id="L431">      _schema = new Schema();</span>
<span class="fc" id="L432">    }</span>

    public SchemaBuilder setSchemaName(@Nonnull String schemaName) {
<span class="fc" id="L435">      _schema.setSchemaName(schemaName);</span>
<span class="fc" id="L436">      return this;</span>
    }

    public SchemaBuilder addSingleValueDimension(@Nonnull String dimensionName, @Nonnull DataType dataType) {
<span class="fc" id="L440">      _schema.addField(new DimensionFieldSpec(dimensionName, dataType, true));</span>
<span class="fc" id="L441">      return this;</span>
    }

    public SchemaBuilder addSingleValueDimension(@Nonnull String dimensionName, @Nonnull DataType dataType,
        @Nonnull Object defaultNullValue) {
<span class="fc" id="L446">      _schema.addField(new DimensionFieldSpec(dimensionName, dataType, true, defaultNullValue));</span>
<span class="fc" id="L447">      return this;</span>
    }

    public SchemaBuilder addMultiValueDimension(@Nonnull String dimensionName, @Nonnull DataType dataType) {
<span class="fc" id="L451">      _schema.addField(new DimensionFieldSpec(dimensionName, dataType, false));</span>
<span class="fc" id="L452">      return this;</span>
    }

    public SchemaBuilder addMultiValueDimension(@Nonnull String dimensionName, @Nonnull DataType dataType,
        @Nonnull Object defaultNullValue) {
<span class="fc" id="L457">      _schema.addField(new DimensionFieldSpec(dimensionName, dataType, false, defaultNullValue));</span>
<span class="fc" id="L458">      return this;</span>
    }

    public SchemaBuilder addMetric(@Nonnull String metricName, @Nonnull DataType dataType) {
<span class="fc" id="L462">      _schema.addField(new MetricFieldSpec(metricName, dataType));</span>
<span class="fc" id="L463">      return this;</span>
    }

    public SchemaBuilder addMetric(@Nonnull String metricName, @Nonnull DataType dataType,
        @Nonnull Object defaultNullValue) {
<span class="fc" id="L468">      _schema.addField(new MetricFieldSpec(metricName, dataType, defaultNullValue));</span>
<span class="fc" id="L469">      return this;</span>
    }

    public SchemaBuilder addMetric(@Nonnull String name, @Nonnull DataType dataType, int fieldSize,
        @Nonnull MetricFieldSpec.DerivedMetricType derivedMetricType) {
<span class="fc" id="L474">      _schema.addField(new MetricFieldSpec(name, dataType, fieldSize, derivedMetricType));</span>
<span class="fc" id="L475">      return this;</span>
    }

    public SchemaBuilder addMetric(@Nonnull String name, @Nonnull DataType dataType, int fieldSize,
        @Nonnull MetricFieldSpec.DerivedMetricType derivedMetricType, @Nonnull Object defaultNullValue) {
<span class="fc" id="L480">      _schema.addField(new MetricFieldSpec(name, dataType, fieldSize, derivedMetricType, defaultNullValue));</span>
<span class="fc" id="L481">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, @Nonnull TimeUnit incomingTimeUnit,
        @Nonnull DataType incomingDataType) {
<span class="fc" id="L486">      _schema.addField(new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnit));</span>
<span class="fc" id="L487">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, @Nonnull TimeUnit incomingTimeUnit,
        @Nonnull DataType incomingDataType, @Nonnull Object defaultNullValue) {
<span class="fc" id="L492">      _schema.addField(new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnit, defaultNullValue));</span>
<span class="fc" id="L493">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, @Nonnull TimeUnit incomingTimeUnit,
        @Nonnull DataType incomingDataType, @Nonnull String outgoingName, @Nonnull TimeUnit outgoingTimeUnit,
        @Nonnull DataType outgoingDataType) {
<span class="fc" id="L499">      _schema.addField(</span>
          new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnit, outgoingName, outgoingDataType,
              outgoingTimeUnit));
<span class="fc" id="L502">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, @Nonnull TimeUnit incomingTimeUnit,
        @Nonnull DataType incomingDataType, @Nonnull String outgoingName, @Nonnull TimeUnit outgoingTimeUnit,
        @Nonnull DataType outgoingDataType, @Nonnull Object defaultNullValue) {
<span class="fc" id="L508">      _schema.addField(</span>
          new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnit, outgoingName, outgoingDataType,
              outgoingTimeUnit, defaultNullValue));
<span class="fc" id="L511">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, int incomingTimeUnitSize,
        @Nonnull TimeUnit incomingTimeUnit, @Nonnull DataType incomingDataType) {
<span class="fc" id="L516">      _schema.addField(new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnitSize, incomingTimeUnit));</span>
<span class="fc" id="L517">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, int incomingTimeUnitSize,
        @Nonnull TimeUnit incomingTimeUnit, @Nonnull DataType incomingDataType, @Nonnull Object defaultNullValue) {
<span class="fc" id="L522">      _schema.addField(</span>
          new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnitSize, incomingTimeUnit, defaultNullValue));
<span class="fc" id="L524">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, int incomingTimeUnitSize,
        @Nonnull TimeUnit incomingTimeUnit, @Nonnull DataType incomingDataType, @Nonnull String outgoingName,
        int outgoingTimeUnitSize, @Nonnull TimeUnit outgoingTimeUnit, @Nonnull DataType outgoingDataType) {
<span class="fc" id="L530">      _schema.addField(</span>
          new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnitSize, incomingTimeUnit, outgoingName,
              outgoingDataType, outgoingTimeUnitSize, outgoingTimeUnit));
<span class="fc" id="L533">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull String incomingName, int incomingTimeUnitSize,
        @Nonnull TimeUnit incomingTimeUnit, @Nonnull DataType incomingDataType, @Nonnull String outgoingName,
        int outgoingTimeUnitSize, @Nonnull TimeUnit outgoingTimeUnit, @Nonnull DataType outgoingDataType,
        @Nonnull Object defaultNullValue) {
<span class="fc" id="L540">      _schema.addField(</span>
          new TimeFieldSpec(incomingName, incomingDataType, incomingTimeUnitSize, incomingTimeUnit, outgoingName,
              outgoingDataType, outgoingTimeUnitSize, outgoingTimeUnit, defaultNullValue));
<span class="fc" id="L543">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull TimeGranularitySpec incomingTimeGranularitySpec) {
<span class="fc" id="L547">      _schema.addField(new TimeFieldSpec(incomingTimeGranularitySpec));</span>
<span class="fc" id="L548">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull TimeGranularitySpec incomingTimeGranularitySpec,
        @Nonnull Object defaultNullValue) {
<span class="fc" id="L553">      _schema.addField(new TimeFieldSpec(incomingTimeGranularitySpec, defaultNullValue));</span>
<span class="fc" id="L554">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull TimeGranularitySpec incomingTimeGranularitySpec,
        @Nonnull TimeGranularitySpec outgoingTimeGranularitySpec) {
<span class="fc" id="L559">      _schema.addField(new TimeFieldSpec(incomingTimeGranularitySpec, outgoingTimeGranularitySpec));</span>
<span class="fc" id="L560">      return this;</span>
    }

    public SchemaBuilder addTime(@Nonnull TimeGranularitySpec incomingTimeGranularitySpec,
        @Nonnull TimeGranularitySpec outgoingTimeGranularitySpec, @Nonnull Object defaultNullValue) {
<span class="fc" id="L565">      _schema.addField(new TimeFieldSpec(incomingTimeGranularitySpec, outgoingTimeGranularitySpec, defaultNullValue));</span>
<span class="fc" id="L566">      return this;</span>
    }

    public SchemaBuilder addDateTime(@Nonnull String name, @Nonnull DataType dataType, @Nonnull String format,
        @Nonnull String granularity) {
<span class="fc" id="L571">      _schema.addField(new DateTimeFieldSpec(name, dataType, format, granularity));</span>
<span class="fc" id="L572">      return this;</span>
    }

    public Schema build() {
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">      if (!_schema.validate(LOGGER)) {</span>
<span class="nc" id="L577">        throw new RuntimeException(&quot;Invalid schema&quot;);</span>
      }
<span class="fc" id="L579">      return _schema;</span>
    }
  }

  @Override
  public String toString() {
<span class="fc" id="L585">    return getJSONSchema();</span>
  }

  @SuppressWarnings(&quot;EqualsWhichDoesntCheckParameterClass&quot;)
  @Override
  public boolean equals(Object o) {
<span class="fc bfc" id="L591" title="All 2 branches covered.">    if (EqualityUtils.isSameReference(this, o)) {</span>
<span class="fc" id="L592">      return true;</span>
    }

<span class="fc bfc" id="L595" title="All 2 branches covered.">    if (EqualityUtils.isNullOrNotSameClass(this, o)) {</span>
<span class="fc" id="L596">      return false;</span>
    }

<span class="fc" id="L599">    Schema that = (Schema) o;</span>
<span class="fc bfc" id="L600" title="All 10 branches covered.">    return EqualityUtils.isEqual(_schemaName, that._schemaName) &amp;&amp; EqualityUtils.isEqual(_dimensionFieldSpecs,</span>
        that._dimensionFieldSpecs) &amp;&amp; EqualityUtils.isEqual(_metricFieldSpecs, that._metricFieldSpecs)
        &amp;&amp; EqualityUtils.isEqual(_timeFieldSpec, that._timeFieldSpec) &amp;&amp; EqualityUtils.isEqual(_dateTimeFieldSpecs,
        that._dateTimeFieldSpecs);
  }

  @Override
  public int hashCode() {
<span class="fc" id="L608">    int result = EqualityUtils.hashCodeOf(_schemaName);</span>
<span class="fc" id="L609">    result = EqualityUtils.hashCodeOf(result, _dimensionFieldSpecs);</span>
<span class="fc" id="L610">    result = EqualityUtils.hashCodeOf(result, _metricFieldSpecs);</span>
<span class="fc" id="L611">    result = EqualityUtils.hashCodeOf(result, _timeFieldSpec);</span>
<span class="fc" id="L612">    result = EqualityUtils.hashCodeOf(result, _dateTimeFieldSpecs);</span>
<span class="fc" id="L613">    return result;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>