<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>KafkaHighLevelConsumerStreamProvider.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-perf</a> &gt; <a href="../index.html" class="el_bundle">pinot-core</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.core.realtime.impl.kafka</a> &gt; <span class="el_source">KafkaHighLevelConsumerStreamProvider.java</span></div><h1>KafkaHighLevelConsumerStreamProvider.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.core.realtime.impl.kafka;

import com.linkedin.pinot.common.metrics.ServerMeter;
import com.linkedin.pinot.common.metrics.ServerMetrics;
import com.yammer.metrics.core.Meter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.linkedin.pinot.core.data.GenericRow;
import com.linkedin.pinot.core.realtime.StreamProvider;
import com.linkedin.pinot.core.realtime.StreamProviderConfig;
import kafka.consumer.ConsumerIterator;
import kafka.javaapi.consumer.ConsumerConnector;


/**
 *
 */
<span class="fc" id="L33">public class KafkaHighLevelConsumerStreamProvider implements StreamProvider {</span>
<span class="fc" id="L34">  private static final Logger STATIC_LOGGER = LoggerFactory.getLogger(KafkaHighLevelConsumerStreamProvider.class);</span>

  private KafkaHighLevelStreamProviderConfig streamProviderConfig;
  private KafkaMessageDecoder decoder;

  private ConsumerConnector consumer;
  private ConsumerIterator&lt;byte[], byte[]&gt; kafkaIterator;
<span class="fc" id="L41">  private long lastLogTime = 0;</span>
<span class="fc" id="L42">  private long lastCount = 0;</span>
  private ConsumerAndIterator consumerAndIterator;

<span class="fc" id="L45">  private Logger INSTANCE_LOGGER = STATIC_LOGGER;</span>

  private ServerMetrics serverMetrics;
  private String tableAndStreamName;
<span class="fc" id="L49">  private long currentCount = 0L;</span>

<span class="fc" id="L51">  private Meter tableAndStreamRowsConsumed = null;</span>
<span class="fc" id="L52">  private Meter tableRowsConsumed = null;</span>

  @Override
  public void init(StreamProviderConfig streamProviderConfig, String tableName, ServerMetrics serverMetrics)
      throws Exception {
<span class="fc" id="L57">    this.streamProviderConfig = (KafkaHighLevelStreamProviderConfig) streamProviderConfig;</span>
<span class="fc" id="L58">    this.decoder = this.streamProviderConfig.getDecoder();</span>
<span class="fc" id="L59">    tableAndStreamName = tableName + &quot;-&quot; + streamProviderConfig.getStreamName();</span>
<span class="fc" id="L60">    INSTANCE_LOGGER = LoggerFactory.getLogger(</span>
        KafkaHighLevelConsumerStreamProvider.class.getName() + &quot;_&quot; + tableName + &quot;_&quot; + streamProviderConfig
            .getStreamName());
<span class="fc" id="L63">    this.serverMetrics = serverMetrics;</span>
<span class="fc" id="L64">  }</span>

  @Override
  public void start() throws Exception {
<span class="fc" id="L68">    consumerAndIterator = KafkaConsumerManager.acquireConsumerAndIteratorForConfig(streamProviderConfig);</span>
<span class="fc" id="L69">    kafkaIterator = consumerAndIterator.getIterator();</span>
<span class="fc" id="L70">    consumer = consumerAndIterator.getConsumer();</span>
<span class="fc" id="L71">  }</span>

  @Override
  public void setOffset(long offset) {
<span class="nc" id="L75">    throw new UnsupportedOperationException();</span>
  }

  @Override
  public GenericRow next(GenericRow destination) {
<span class="fc bfc" id="L80" title="All 2 branches covered.">    if (kafkaIterator.hasNext()) {</span>
      try {
<span class="fc" id="L82">        destination = decoder.decode(kafkaIterator.next().message(), destination);</span>
<span class="fc" id="L83">        tableAndStreamRowsConsumed = serverMetrics.addMeteredTableValue(tableAndStreamName, ServerMeter.REALTIME_ROWS_CONSUMED, 1L, tableAndStreamRowsConsumed);</span>
<span class="fc" id="L84">        tableRowsConsumed = serverMetrics.addMeteredGlobalValue(ServerMeter.REALTIME_ROWS_CONSUMED, 1L, tableRowsConsumed);</span>
<span class="fc" id="L85">        ++currentCount;</span>

<span class="fc" id="L87">        final long now = System.currentTimeMillis();</span>
        // Log every minute or 100k events
<span class="pc bpc" id="L89" title="1 of 4 branches missed.">        if (now - lastLogTime &gt; 60000 || currentCount - lastCount &gt;= 100000) {</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">          if (lastCount == 0) {</span>
<span class="fc" id="L91">            INSTANCE_LOGGER.info(&quot;Consumed {} events from kafka stream {}&quot;, currentCount,</span>
                this.streamProviderConfig.getStreamName());
          } else {
<span class="nc" id="L94">            INSTANCE_LOGGER.info(&quot;Consumed {} events from kafka stream {} (rate:{}/s)&quot;, currentCount - lastCount,</span>
                this.streamProviderConfig.getStreamName(),
                (float) (currentCount - lastCount) * 1000 / (now - lastLogTime));
          }
<span class="fc" id="L98">          lastCount = currentCount;</span>
<span class="fc" id="L99">          lastLogTime = now;</span>
        }
<span class="fc" id="L101">        return destination;</span>
<span class="nc" id="L102">      } catch (Exception e) {</span>
<span class="nc" id="L103">        INSTANCE_LOGGER.warn(&quot;Caught exception while consuming events&quot;, e);</span>
<span class="nc" id="L104">        serverMetrics.addMeteredTableValue(tableAndStreamName, ServerMeter.REALTIME_CONSUMPTION_EXCEPTIONS, 1L);</span>
<span class="nc" id="L105">        serverMetrics.addMeteredGlobalValue(ServerMeter.REALTIME_CONSUMPTION_EXCEPTIONS, 1L);</span>
<span class="nc" id="L106">        throw e;</span>
      }
    }
<span class="fc" id="L109">    return null;</span>
  }

  @Override
  public GenericRow next(long offset) {
<span class="nc" id="L114">    throw new UnsupportedOperationException();</span>
  }

  @Override
  public long currentOffset() {
<span class="nc" id="L119">    throw new UnsupportedOperationException();</span>
  }

  @Override
  public void commit() {
<span class="fc" id="L124">    consumer.commitOffsets();</span>
<span class="fc" id="L125">    serverMetrics.addMeteredTableValue(tableAndStreamName, ServerMeter.REALTIME_OFFSET_COMMITS, 1L);</span>
<span class="fc" id="L126">    serverMetrics.addMeteredGlobalValue(ServerMeter.REALTIME_OFFSET_COMMITS, 1L);</span>
<span class="fc" id="L127">  }</span>

  @Override
  public void commit(long offset) {
<span class="nc" id="L131">    throw new UnsupportedOperationException();</span>
  }

  @Override
  public void shutdown() throws Exception {
<span class="fc bfc" id="L136" title="All 2 branches covered.">    if (consumerAndIterator != null) {</span>
<span class="fc" id="L137">      kafkaIterator = null;</span>
<span class="fc" id="L138">      consumer = null;</span>

<span class="fc" id="L140">      KafkaConsumerManager.releaseConsumerAndIterator(consumerAndIterator);</span>
<span class="fc" id="L141">      consumerAndIterator = null;</span>
    }
<span class="fc" id="L143">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>