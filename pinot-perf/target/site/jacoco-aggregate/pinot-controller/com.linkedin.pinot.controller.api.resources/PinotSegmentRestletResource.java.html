<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PinotSegmentRestletResource.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-perf</a> &gt; <a href="../index.html" class="el_bundle">pinot-controller</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.controller.api.resources</a> &gt; <span class="el_source">PinotSegmentRestletResource.java</span></div><h1>PinotSegmentRestletResource.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.linkedin.pinot.controller.api.resources;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.linkedin.pinot.common.config.TableNameBuilder;
import com.linkedin.pinot.common.metadata.ZKMetadataProvider;
import com.linkedin.pinot.common.metadata.segment.OfflineSegmentZKMetadata;
import com.linkedin.pinot.common.metadata.segment.RealtimeSegmentZKMetadata;
import com.linkedin.pinot.common.utils.CommonConstants;
import com.linkedin.pinot.controller.helix.core.PinotHelixResourceManager;
import com.linkedin.pinot.controller.helix.core.PinotResourceManagerResponse;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import javax.inject.Inject;
import javax.ws.rs.Encoded;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import org.apache.helix.ZNRecord;
import org.apache.helix.store.zk.ZkHelixPropertyStore;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import static com.linkedin.pinot.controller.api.resources.Constants.TABLE_NAME;
import static com.linkedin.pinot.controller.api.resources.FileUploadPathProvider.*;


/**
 * Current URI Mappings:
 * &lt;ul&gt;
 *   &lt;li&gt;
 *     &quot;/tables/{tableName}/segments/{segmentName}&quot;:
 *     &quot;/tables/{tableName}/segments/{segmentName}/metadata&quot;:
 *     Get segment metadata for a given segment
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &quot;/tables/{tableName}/segments&quot;:
 *     &quot;/tables/{tableName}/segments/metadata&quot;:
 *     List segment metadata for a given table
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *      &quot;/tables/{tableName}/segments/crc&quot;:
 *      Get crc information for a given table
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &quot;/tables/{tableName}/segments/{segmentName}?state={state}&quot;:
 *     Change the state of the segment to specified {state} (enable|disable|drop)
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &quot;/tables/{tableName}/segments?state={state}&quot;:
 *     Change the state of all segments of the table to specified {state} (enable|disable|drop)
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &quot;/tables/{tableName}/segments/{segmentName}/reload&quot;:
 *     Reload the segment
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &quot;/tables/{tableName}/segments/reload&quot;:
 *     Reload all segments of the table
 *   &lt;/li&gt;
 * &lt;/ul&gt;
 *
 * {@inheritDoc}
 */

@Api(tags = Constants.TABLE_TAG)
@Path(&quot;/&quot;)
<span class="fc" id="L101">public class PinotSegmentRestletResource {</span>
<span class="fc" id="L102">  public static Logger LOGGER = LoggerFactory.getLogger(PinotSegmentRestletResource.class);</span>
<span class="fc" id="L103">  public static final Response.Status BAD_REQUEST = Response.Status.BAD_REQUEST;</span>
<span class="fc" id="L104">  public static final Response.Status INTERNAL_ERROR = Response.Status.INTERNAL_SERVER_ERROR;</span>

  private static final long _offlineToOnlineTimeoutInseconds = 5L;

  @Inject
  PinotHelixResourceManager _pinotHelixResourceManager;

  @GET
  @Path(&quot;tables/{tableName}/segments&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Lists metadata or toggles segment states&quot;, notes = &quot;Toggles segment states if 'state' is specified in query param, otherwise lists metadata&quot;)
  public String toggleStateOrListMetadataForAllSegments(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam(value = &quot;enable|disable|drop&quot;, required = false) @QueryParam(&quot;state&quot;) String stateStr,
      @ApiParam(value = &quot;realtime|offline&quot;, required = false) @QueryParam(&quot;type&quot;) String tableTypeStr) {
<span class="fc" id="L119">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="fc" id="L120">    StateType state = Constants.validateState(stateStr);</span>

<span class="pc bpc" id="L122" title="1 of 2 branches missed.">    if (stateStr == null) {</span>
<span class="nc" id="L123">      JSONArray result = getAllSegmentsMetadataForTable(tableName, tableType);</span>
<span class="nc" id="L124">      return result.toString();</span>
    }
<span class="fc" id="L126">    return toggleStateInternal(tableName, state, tableType, null, _pinotHelixResourceManager).toString();</span>
  }

  @GET
  @Path(&quot;tables/{tableName}/segments/{segmentName}&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Lists metadata or toggles state of a segment&quot;, notes = &quot;Toggles segment state if 'state' is specified in query param, otherwise lists segment metadata&quot;)
  public String toggleStateOrListMetadataForOneSegment(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam (value = &quot;Name of segment&quot;, required = true) @PathParam(&quot;segmentName&quot;) @Encoded String segmentName,
      @ApiParam(value = &quot;online|offline|drop&quot;, required = false) @QueryParam(&quot;state&quot;) String stateStr,
      @ApiParam(value = &quot;realtime|offline&quot;, required = false) @QueryParam(&quot;type&quot;) String tableTypeStr
  ) throws JSONException {
<span class="fc" id="L139">    segmentName = checkGetEncodedParam(segmentName);</span>
    // segmentName will never be null,otherwise we would reach the method toggleStateOrListMetadataForAllSegments()
<span class="fc" id="L141">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="fc" id="L142">    StateType stateType = Constants.validateState(stateStr);</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">    if (stateStr == null) {</span>
      // This is a list metadata operation
<span class="nc" id="L145">      return listSegmentMetadataInternal(tableName, segmentName, tableType);</span>
    } else {
      // We need to toggle state
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">      if (tableType == null) {</span>
<span class="nc" id="L149">        List&lt;String&gt; realtimeSegments = _pinotHelixResourceManager.getSegmentsFor(TableNameBuilder.REALTIME.tableNameWithType(tableName));</span>
<span class="nc" id="L150">        List&lt;String&gt; offlineSegments = _pinotHelixResourceManager.getSegmentsFor(TableNameBuilder.OFFLINE.tableNameWithType(tableName));</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (realtimeSegments.contains(segmentName)) {</span>
<span class="nc" id="L152">          tableType = CommonConstants.Helix.TableType.REALTIME;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        } else if (offlineSegments.contains(segmentName)) {</span>
<span class="nc" id="L154">          tableType = CommonConstants.Helix.TableType.OFFLINE;</span>
        }
      }
<span class="fc" id="L157">      return toggleStateInternal(tableName, stateType, tableType, segmentName, _pinotHelixResourceManager).toString();</span>
    }
  }

  private String checkGetEncodedParam(String encoded) {
    try {
<span class="fc" id="L163">      return URLDecoder.decode(encoded, &quot;UTF-8&quot;);</span>
<span class="nc" id="L164">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L165">      String errStr = &quot;Could not decode parameter '&quot; + encoded + &quot;'&quot;;</span>
<span class="nc" id="L166">      throw new ControllerApplicationException(LOGGER, errStr, Response.Status.BAD_REQUEST);</span>
    }
  }

  @GET
  @Path(&quot;tables/{tableName}/segments/metadata&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Lists metadata all segments of table&quot;, notes = &quot;Lists segment metadata&quot;)
  public String listMetadataForAllSegments(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam(value = &quot;enable|disable|drop&quot;, required = false) @QueryParam(&quot;state&quot;) String stateStr,
      @ApiParam(value = &quot;realtime|offline&quot;, required = false) @QueryParam(&quot;type&quot;) String tableTypeStr) {
<span class="nc" id="L178">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="nc" id="L179">    JSONArray result = getAllSegmentsMetadataForTable(tableName, tableType);</span>
<span class="nc" id="L180">    return result.toString();</span>
  }

  @GET
  @Path(&quot;tables/{tableName}/segments/{segmentName}/metadata&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Lists metadata one segments of table&quot;, notes = &quot;Lists segment metadata&quot;)
  public String listMetadataForOneSegment(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam (value = &quot;Name of segment&quot;, required = true) @PathParam(&quot;segmentName&quot;) @Encoded String segmentName,
      @ApiParam(value = &quot;realtime|offline&quot;, required = false) @QueryParam(&quot;type&quot;) String tableTypeStr
  ) throws JSONException {
<span class="nc" id="L192">    segmentName = checkGetEncodedParam(segmentName);</span>
<span class="nc" id="L193">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="nc" id="L194">    return listSegmentMetadataInternal(tableName, segmentName, tableType);</span>
  }

  private String listSegmentMetadataInternal(@Nonnull  String tableName, @Nonnull String segmentName,
      @Nullable CommonConstants.Helix.TableType tableType) throws JSONException {
    // The code in restlet.resources seems to return an array of arrays, so we will do the same
    // to maintain backward compatibility
<span class="nc" id="L201">    JSONArray result = new JSONArray();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">    if (tableType != null) {</span>
<span class="nc" id="L203">      String tableNameWithType = TableNameBuilder.forType(tableType).tableNameWithType(tableName);</span>
<span class="nc" id="L204">      JSONArray metadata = getSegmentMetaData(tableNameWithType, segmentName, tableType);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">      if (metadata == null) {</span>
<span class="nc" id="L206">        throw new ControllerApplicationException(LOGGER, &quot;Segment &quot; + segmentName + &quot; not found in table &quot; +</span>
            tableNameWithType, Response.Status.NOT_FOUND);
      }
<span class="nc" id="L209">      result.put(metadata);</span>
<span class="nc" id="L210">      return result.toString();</span>
    }
    // Again,keeping backward compatibility, returning metadata from both table types.
    // The segment should appear only in one
    JSONArray metadata;

<span class="nc bnc" id="L216" title="All 2 branches missed.">    if (_pinotHelixResourceManager.hasOfflineTable(tableName)) {</span>
<span class="nc" id="L217">      metadata = getSegmentMetaData(TableNameBuilder.OFFLINE.tableNameWithType(tableName), segmentName, CommonConstants.Helix.TableType.OFFLINE);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (metadata != null) {</span>
<span class="nc" id="L219">        result.put(metadata);</span>
<span class="nc" id="L220">        return result.toString();</span>
      }
    }

<span class="nc bnc" id="L224" title="All 2 branches missed.">    if (_pinotHelixResourceManager.hasRealtimeTable(tableName)) {</span>
<span class="nc" id="L225">      metadata = getSegmentMetaData(tableName, segmentName, CommonConstants.Helix.TableType.REALTIME);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">      if (metadata != null) {</span>
<span class="nc" id="L227">        result.put(metadata);</span>
<span class="nc" id="L228">        return result.toString();</span>
      }
    }
<span class="nc" id="L231">    throw new ControllerApplicationException(LOGGER, &quot;Segment &quot; + segmentName + &quot; not found in table &quot; +</span>
        tableName, Response.Status.NOT_FOUND);
  }

  @POST
  @Path(&quot;tables/{tableName}/segments/{segmentName}/reload&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Reloads one segment&quot;, notes = &quot;Reloads one segment&quot;)
  public SuccessResponse reloadOneSegment(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam(value = &quot;Name of segment&quot;, required = true) @PathParam(&quot;segmentName&quot;) @Encoded String segmentName,
      @ApiParam(value = &quot;realtime|offline&quot;) @QueryParam(&quot;type&quot;) String tableTypeStr) {
<span class="nc" id="L243">    segmentName = checkGetEncodedParam(segmentName);</span>
<span class="nc" id="L244">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="nc" id="L245">    return new SuccessResponse(reloadSegmentForTable(tableName, segmentName, tableType));</span>
  }

  @POST
  @Path(&quot;tables/{tableName}/segments/reload&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Reloads all segments of a table&quot;, notes = &quot;Reloads all segments&quot;)
  public SuccessResponse reloadAllSegments(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam(value = &quot;realtime|offline&quot;) @QueryParam(&quot;type&quot;) String tableTypeStr) {
<span class="fc" id="L255">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="fc" id="L256">    return new SuccessResponse((reloadAllSegmentsForTable(tableName, tableType)));</span>
  }

  @Deprecated
  @GET
  @Path(&quot;tables/{tableName}/segments/{segmentName}/reload&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Reloads one segment&quot;, notes = &quot;Reloads one segment&quot;)
  public SuccessResponse reloadOneSegmentDeprecated(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam(value = &quot;Name of segment&quot;, required = true) @PathParam(&quot;segmentName&quot;) @Encoded String segmentName,
      @ApiParam(value = &quot;realtime|offline&quot;) @QueryParam(&quot;type&quot;) String tableTypeStr) {
<span class="nc" id="L268">    segmentName = checkGetEncodedParam(segmentName);</span>
<span class="nc" id="L269">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="nc" id="L270">    return new SuccessResponse(reloadSegmentForTable(tableName, segmentName, tableType));</span>
  }

  @Deprecated
  @GET
  @Path(&quot;tables/{tableName}/segments/reload&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Reloads all segments of a table&quot;, notes = &quot;Reloads all segments&quot;)
  public SuccessResponse reloadAllSegmentsDeprecated(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName,
      @ApiParam(value = &quot;realtime|offline&quot;) @QueryParam(&quot;type&quot;) String tableTypeStr) {
<span class="nc" id="L281">    CommonConstants.Helix.TableType tableType = Constants.validateTableType(tableTypeStr);</span>
<span class="nc" id="L282">    return new SuccessResponse((reloadAllSegmentsForTable(tableName, tableType)));</span>
  }

  @GET
  @Path(&quot;tables/{tableName}/segments/crc&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Gets crc of all segments of a table&quot;, notes = &quot;Gets crc of all segments&quot;)
  public String getCrcForAllSegments(
      @ApiParam(value = &quot;Name of the table&quot;, required = true) @PathParam(&quot;tableName&quot;) String tableName) {
<span class="fc" id="L291">    return getAllCrcMetadataForTable(tableName);</span>
  }

  //////////////////////////////////////////////////////////////////////////////////////

  private String reloadSegmentForTable(String tableName, String segmentName,
      CommonConstants.Helix.TableType tableType) {
<span class="nc" id="L298">    int numReloadMessagesSent = 0;</span>

<span class="nc bnc" id="L300" title="All 4 branches missed.">    if ((tableType == null) || CommonConstants.Helix.TableType.OFFLINE == tableType) {</span>
<span class="nc" id="L301">      String offlineTableName = TableNameBuilder.OFFLINE.tableNameWithType(tableName);</span>
<span class="nc" id="L302">      numReloadMessagesSent += _pinotHelixResourceManager.reloadSegment(offlineTableName, segmentName);</span>
    }

<span class="nc bnc" id="L305" title="All 4 branches missed.">    if ((tableType == null) || CommonConstants.Helix.TableType.REALTIME == tableType) {</span>
<span class="nc" id="L306">      String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(tableName);</span>
<span class="nc" id="L307">      numReloadMessagesSent += _pinotHelixResourceManager.reloadSegment(realtimeTableName, segmentName);</span>
    }

<span class="nc" id="L310">    return &quot;Sent &quot; + numReloadMessagesSent + &quot; reload messages&quot;;</span>
  }

  private String reloadAllSegmentsForTable(String tableName, @Nullable CommonConstants.Helix.TableType tableType) {
<span class="fc" id="L314">    int numReloadMessagesSent = 0;</span>

<span class="pc bpc" id="L316" title="2 of 4 branches missed.">    if ((tableType == null) || CommonConstants.Helix.TableType.OFFLINE == tableType) {</span>
<span class="fc" id="L317">      String offlineTableName = TableNameBuilder.OFFLINE.tableNameWithType(tableName);</span>
<span class="fc" id="L318">      numReloadMessagesSent += _pinotHelixResourceManager.reloadAllSegments(offlineTableName);</span>
    }

<span class="pc bpc" id="L321" title="2 of 4 branches missed.">    if ((tableType == null) || CommonConstants.Helix.TableType.REALTIME == tableType) {</span>
<span class="nc" id="L322">      String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(tableName);</span>
<span class="nc" id="L323">      numReloadMessagesSent += _pinotHelixResourceManager.reloadAllSegments(realtimeTableName);</span>
    }

<span class="fc" id="L326">    return &quot;Sent &quot; + numReloadMessagesSent + &quot; reload messages&quot;;</span>
  }

  public static JSONArray toggleStateInternal(String tableName, StateType state,
      CommonConstants.Helix.TableType tableType, String segmentName, PinotHelixResourceManager helixResourceManager) {
<span class="fc" id="L331">    JSONArray ret = new JSONArray();</span>
<span class="fc" id="L332">    List&lt;String&gt; segmentsToToggle = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L333">    String offlineTableName = TableNameBuilder.OFFLINE.tableNameWithType(tableName);</span>
<span class="fc" id="L334">    String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(tableName);</span>
<span class="fc" id="L335">    String tableNameWithType = &quot;&quot;;</span>
<span class="fc" id="L336">    List&lt;String&gt; realtimeSegments = helixResourceManager.getSegmentsFor(realtimeTableName);</span>
<span class="fc" id="L337">    List&lt;String&gt; offlineSegments = helixResourceManager.getSegmentsFor(offlineTableName);</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">    if (tableType == null) {</span>
<span class="nc" id="L339">      PinotResourceManagerResponse responseRealtime =</span>
          toggleSegmentsForTable(realtimeSegments, realtimeTableName, segmentName, state, helixResourceManager);
<span class="nc" id="L341">      PinotResourceManagerResponse responseOffline =</span>
          toggleSegmentsForTable(offlineSegments, offlineTableName, segmentName, state, helixResourceManager);
<span class="nc bnc" id="L343" title="All 4 branches missed.">      if (!responseOffline.isSuccessful() || !responseRealtime.isSuccessful()) {</span>
<span class="nc" id="L344">        throw new ControllerApplicationException(LOGGER, &quot;OFFLINE response : &quot; + responseOffline.getMessage() + &quot;, REALTIME response&quot;</span>
            + responseRealtime.getMessage(), INTERNAL_ERROR);
      }
<span class="nc" id="L347">      List&lt;PinotResourceManagerResponse&gt; responses = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L348">      responses.add(responseRealtime);</span>
<span class="nc" id="L349">      responses.add(responseOffline);</span>
<span class="nc" id="L350">      ret.put(responses);</span>
<span class="nc" id="L351">      return ret;</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">    } else if (CommonConstants.Helix.TableType.REALTIME == tableType) {</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">      if (helixResourceManager.hasRealtimeTable(tableName)) {</span>
<span class="fc" id="L354">        tableNameWithType = realtimeTableName;</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">        if (segmentName != null) {</span>
<span class="fc" id="L356">          segmentsToToggle = Collections.singletonList(segmentName);</span>
        } else {
<span class="nc" id="L358">          segmentsToToggle.addAll(realtimeSegments);</span>
        }
      } else {
<span class="nc" id="L361">        throw new ControllerApplicationException(LOGGER, &quot;There is no realtime table for &quot; + tableName, BAD_REQUEST);</span>
      }
    } else {
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">      if (helixResourceManager.hasOfflineTable(tableName)) {</span>
<span class="fc" id="L365">        tableNameWithType = offlineTableName;</span>
<span class="fc bfc" id="L366" title="All 2 branches covered.">        if (segmentName != null) {</span>
<span class="fc" id="L367">          segmentsToToggle = Collections.singletonList(segmentName);</span>
        } else {
<span class="fc" id="L369">          segmentsToToggle.addAll(offlineSegments);</span>
        }
      } else {
<span class="nc" id="L372">        throw new ControllerApplicationException(LOGGER, &quot;There is no offline table for: &quot; + tableName, BAD_REQUEST);</span>
      }
    }
<span class="fc" id="L375">    PinotResourceManagerResponse resourceManagerResponse =</span>
        toggleSegmentsForTable(segmentsToToggle, tableNameWithType, segmentName, state, helixResourceManager);
<span class="fc" id="L377">    ret.put(resourceManagerResponse);</span>
<span class="fc" id="L378">    return ret;</span>
  }

  /**
   * Helper method to toggle state of segment for a given table. The tableName expected is the internally
   * stored name (with offline/realtime annotation).
   *
   * @param segmentsToToggle: segments that we want to perform operations on
   * @param tableName: Internal name (created by TableNameBuilder) for the table
   * @param segmentName: Segment to set the state for.
   * @param state: Value of state to set.
   * @return
   * @throws JSONException
   */
  private static PinotResourceManagerResponse toggleSegmentsForTable(@Nonnull List&lt;String&gt; segmentsToToggle,
      @Nonnull String tableName, String segmentName, @Nonnull StateType state,
      PinotHelixResourceManager helixResourceManager) {
<span class="fc" id="L395">    long timeOutInSeconds = 10L;</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">    if (segmentName == null) {</span>
      // For enable, allow 5 seconds per segment for an instance as timeout.
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">      if (state == StateType.ENABLE) {</span>
<span class="nc" id="L399">        int instanceCount = helixResourceManager.getAllInstances().size();</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (instanceCount != 0) {</span>
<span class="nc" id="L401">          timeOutInSeconds = (long) ((_offlineToOnlineTimeoutInseconds * segmentsToToggle.size()) / instanceCount);</span>
        } else {
<span class="nc" id="L403">          return new PinotResourceManagerResponse(&quot;Error: could not find any instances in table &quot; + tableName, false);</span>
        }
      }
    }
<span class="pc bpc" id="L407" title="2 of 4 branches missed.">    if (segmentsToToggle == null || segmentsToToggle.isEmpty()) {</span>
      // Nothing to do. Not sure if 404 is a response here, but since they are asking us to toggle states of all
      // segments, and there are none to do, 200 is an equally valid response, in that we succeeded in changing the
      // state of 0 segments.
      //
      // If a table has only one type of segment (e.g. only realtime), the restlet API returned a 500, since helixi
      // throws a NPE. It tried the realtime segments first, and if there were none, then the operation would fail.
      // If only realtime segments existed, then we would still return 500 even though the realtime segments were
      // changed state correctly.
      //
      // In jersey, API, if there are no segments in realtime (or in offline), we succeed the operation AND return 200
      // if we succeeded.
<span class="nc" id="L419">      return new PinotResourceManagerResponse(&quot;No segments to toggle&quot;, true);</span>
    }

<span class="pc bpc" id="L422" title="3 of 4 branches missed.">    switch (state) {</span>
      case ENABLE:
<span class="nc" id="L424">        return helixResourceManager.toggleSegmentState(tableName, segmentsToToggle, true, timeOutInSeconds);</span>
      case DISABLE:
<span class="nc" id="L426">        return helixResourceManager.toggleSegmentState(tableName, segmentsToToggle, false, timeOutInSeconds);</span>
      case DROP:
<span class="fc" id="L428">        return helixResourceManager.deleteSegments(tableName, segmentsToToggle);</span>
      default:
<span class="pc" id="L430">        throw new ControllerApplicationException(LOGGER, &quot;Invalid state&quot;, BAD_REQUEST);</span>
    }
  }

  private JSONArray getAllSegmentsMetadataForTable(String tableName, CommonConstants.Helix.TableType tableType) {
<span class="nc" id="L435">    boolean foundRealtimeTable = false;</span>
<span class="nc" id="L436">    boolean foundOfflineTable = false;</span>
<span class="nc" id="L437">    JSONArray ret = new JSONArray();</span>
    try {
<span class="nc bnc" id="L439" title="All 6 branches missed.">      if ((tableType == null || tableType == CommonConstants.Helix.TableType.REALTIME)</span>
          &amp;&amp; _pinotHelixResourceManager.hasRealtimeTable(tableName)) {
<span class="nc" id="L441">        String realtimeTableName = TableNameBuilder.REALTIME.tableNameWithType(tableName);</span>
<span class="nc" id="L442">        JSONObject realtime = new JSONObject();</span>
<span class="nc" id="L443">        realtime.put(FileUploadPathProvider.TABLE_NAME, realtimeTableName);</span>
<span class="nc" id="L444">        realtime.put(&quot;segments&quot;, new ObjectMapper().writeValueAsString(</span>
            _pinotHelixResourceManager.getInstanceToSegmentsInATableMap(realtimeTableName)));
<span class="nc" id="L446">        ret.put(realtime);</span>
<span class="nc" id="L447">        foundRealtimeTable = true;</span>
      }

<span class="nc bnc" id="L450" title="All 6 branches missed.">      if ((tableType == null</span>
          || tableType == CommonConstants.Helix.TableType.OFFLINE &amp;&amp; _pinotHelixResourceManager.hasOfflineTable(
          tableName))) {
<span class="nc" id="L453">        String offlineTableName = TableNameBuilder.OFFLINE.tableNameWithType(tableName);</span>
<span class="nc" id="L454">        JSONObject offline = new JSONObject();</span>
<span class="nc" id="L455">        offline.put(FileUploadPathProvider.TABLE_NAME, offlineTableName);</span>
<span class="nc" id="L456">        offline.put(&quot;segments&quot;, new ObjectMapper().writeValueAsString(</span>
            _pinotHelixResourceManager.getInstanceToSegmentsInATableMap(offlineTableName)));
<span class="nc" id="L458">        ret.put(offline);</span>
<span class="nc" id="L459">        foundOfflineTable = true;</span>
      }
<span class="nc" id="L461">    } catch (JSONException | JsonProcessingException e) {</span>
<span class="nc" id="L462">      throw new ControllerApplicationException(LOGGER,</span>
          String.format(&quot;Failed to convert segment metadata to json, table: %s&quot;, tableName),
          Response.Status.INTERNAL_SERVER_ERROR);
<span class="nc" id="L465">    }</span>

<span class="nc bnc" id="L467" title="All 4 branches missed.">    if (foundOfflineTable || foundRealtimeTable) {</span>
<span class="nc" id="L468">      return ret;</span>
    } else {
<span class="nc" id="L470">      throw new ControllerApplicationException(LOGGER, &quot;Table &quot; + tableName + &quot; not found.&quot;, Response.Status.NOT_FOUND);</span>
    }
  }

  /**
   * Get meta-data for segment of table. Table name is the suffixed (offline/realtime)
   * name.
   * @param tableNameWithType: Suffixed (realtime/offline) table Name
   * @param segmentName: Segment for which to get the meta-data.
   * @return A json array that is to be returned to the client.
   * @throws JSONException
   * XXX
   * @note: Previous restlet API retuned a toString from this method, so if compat is desired, then change this method to return a String type
   */
  private @Nullable JSONArray getSegmentMetaData(String tableNameWithType, String segmentName, @Nonnull  CommonConstants.Helix.TableType tableType)
      throws JSONException {
<span class="nc bnc" id="L486" title="All 2 branches missed.">    if (!ZKMetadataProvider.isSegmentExisted(_pinotHelixResourceManager.getPropertyStore(), tableNameWithType, segmentName)) {</span>
<span class="nc" id="L487">      return null;</span>
    }

<span class="nc" id="L490">    JSONArray ret = new JSONArray();</span>
<span class="nc" id="L491">    JSONObject jsonObj = new JSONObject();</span>
<span class="nc" id="L492">    jsonObj.put(TABLE_NAME, tableNameWithType);</span>

<span class="nc" id="L494">    ZkHelixPropertyStore&lt;ZNRecord&gt; propertyStore = _pinotHelixResourceManager.getPropertyStore();</span>

<span class="nc bnc" id="L496" title="All 2 branches missed.">    if (tableType == tableType.OFFLINE) {</span>
<span class="nc" id="L497">      OfflineSegmentZKMetadata offlineSegmentZKMetadata =</span>
          ZKMetadataProvider.getOfflineSegmentZKMetadata(propertyStore, tableNameWithType, segmentName);
<span class="nc" id="L499">      jsonObj.put(STATE, offlineSegmentZKMetadata.toMap());</span>

    }

<span class="nc bnc" id="L503" title="All 2 branches missed.">    if (tableType == CommonConstants.Helix.TableType.REALTIME) {</span>
<span class="nc" id="L504">      RealtimeSegmentZKMetadata realtimeSegmentZKMetadata =</span>
          ZKMetadataProvider.getRealtimeSegmentZKMetadata(propertyStore, tableNameWithType, segmentName);
<span class="nc" id="L506">      jsonObj.put(STATE, realtimeSegmentZKMetadata.toMap());</span>
    }

<span class="nc" id="L509">    ret.put(jsonObj);</span>
<span class="nc" id="L510">    return ret;</span>
  }

  private String getAllCrcMetadataForTable(String tableName) {
    PinotResourceManagerResponse response;

    // TODO
    // In the restlet.resource version, we see this code block below
    // seems to be wrong comparing the table name to have the table type, but we copy it here anyway.
    // Realtime table is not supported.
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">    if (TableNameBuilder.getTableTypeFromTableName(tableName) == CommonConstants.Helix.TableType.REALTIME) {</span>
<span class="nc" id="L521">      throw new ControllerApplicationException(LOGGER, &quot;Realtime table is not supported&quot;, Response.Status.FORBIDDEN);</span>
    }

    // Check that the offline table exists.
<span class="fc" id="L525">    String offlineTableName = TableNameBuilder.OFFLINE.tableNameWithType(tableName);</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">    if (!_pinotHelixResourceManager.getAllTables().contains(offlineTableName)) {</span>
<span class="nc" id="L527">      throw new ControllerApplicationException(LOGGER, &quot;Offline table &quot; + tableName + &quot; does not exist.&quot;, BAD_REQUEST);</span>
    }

<span class="fc" id="L530">    Map&lt;String, String&gt; segmentCrcForTable = _pinotHelixResourceManager.getSegmentsCrcForTable(offlineTableName);</span>
<span class="fc" id="L531">    ObjectMapper mapper = new ObjectMapper();</span>
<span class="fc" id="L532">    String result = null;</span>
    try {
<span class="fc" id="L534">      result = mapper.writerWithDefaultPrettyPrinter().writeValueAsString(segmentCrcForTable);</span>
<span class="nc" id="L535">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L536">      throw new ControllerApplicationException(LOGGER,</span>
          String.format(&quot;Failed to write segment crc values for table: %s&quot;, tableName),
          Response.Status.INTERNAL_SERVER_ERROR);
<span class="fc" id="L539">    }</span>
<span class="fc" id="L540">    return result;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>