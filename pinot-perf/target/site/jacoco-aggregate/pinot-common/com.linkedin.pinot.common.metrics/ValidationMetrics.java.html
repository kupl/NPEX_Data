<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ValidationMetrics.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-perf</a> &gt; <a href="../index.html" class="el_bundle">pinot-common</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.common.metrics</a> &gt; <span class="el_source">ValidationMetrics.java</span></div><h1>ValidationMetrics.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.common.metrics;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import com.yammer.metrics.core.Gauge;
import com.yammer.metrics.core.MetricName;
import com.yammer.metrics.core.MetricsRegistry;


/**
 * Validation metrics utility class, which contains the glue code to publish metrics.
 */
public class ValidationMetrics {
  private final MetricsRegistry _metricsRegistry;

<span class="fc" id="L34">  private final Map&lt;String, Long&gt; _gaugeValues = new HashMap&lt;&gt;();</span>
<span class="fc" id="L35">  private final Set&lt;MetricName&gt; _metricNames = new HashSet&lt;&gt;();</span>

  /**
   * A simple gauge that returns whatever last value was stored in the _gaugeValues hash map.
   */
  private class StoredValueGauge extends Gauge&lt;Long&gt; {
    private final String key;

<span class="fc" id="L43">    public StoredValueGauge(String key) {</span>
<span class="fc" id="L44">      this.key = key;</span>
<span class="fc" id="L45">    }</span>

    @Override
    public Long value() {
<span class="nc" id="L49">      return _gaugeValues.get(key);</span>
    }
  }

  /**
   * A simple gauge that returns the difference between the current system time in millis and the value stored in the
   * _gaugeValues hash map.
   */
  private class CurrentTimeMillisDeltaGauge extends Gauge&lt;Long&gt; {
    private final String key;

<span class="fc" id="L60">    public CurrentTimeMillisDeltaGauge(String key) {</span>
<span class="fc" id="L61">      this.key = key;</span>
<span class="fc" id="L62">    }</span>

    @Override
    public Long value() {
<span class="nc" id="L66">      Long gaugeValue = _gaugeValues.get(key);</span>

<span class="nc bnc" id="L68" title="All 4 branches missed.">      if (gaugeValue != null &amp;&amp; gaugeValue != Long.MIN_VALUE)</span>
<span class="nc" id="L69">        return System.currentTimeMillis() - gaugeValue;</span>
      else
<span class="nc" id="L71">        return Long.MIN_VALUE;</span>
    }
  }

  /**
   * A simple gauge that returns the difference in hours between the current system time and the value stored in the
   * _gaugeValues hash map.
   */
  private class CurrentTimeMillisDeltaGaugeHours extends Gauge&lt;Double&gt; {
    private final String key;

<span class="fc" id="L82">    private final double MILLIS_PER_HOUR = TimeUnit.MILLISECONDS.convert(1, TimeUnit.HOURS);</span>

<span class="fc" id="L84">    public CurrentTimeMillisDeltaGaugeHours(String key) {</span>
<span class="fc" id="L85">      this.key = key;</span>
<span class="fc" id="L86">    }</span>

    @Override
    public Double value() {
<span class="nc" id="L90">      Long gaugeValue = _gaugeValues.get(key);</span>

<span class="nc bnc" id="L92" title="All 4 branches missed.">      if (gaugeValue != null &amp;&amp; gaugeValue != Long.MIN_VALUE)</span>
<span class="nc" id="L93">        return (System.currentTimeMillis() - gaugeValue) / MILLIS_PER_HOUR;</span>
      else
<span class="nc" id="L95">        return Double.MIN_VALUE;</span>
    }
  }

  private interface GaugeFactory&lt;T&gt; {
    Gauge&lt;T&gt; buildGauge(final String key);
  }

<span class="fc" id="L103">  private class StoredValueGaugeFactory implements GaugeFactory&lt;Long&gt; {</span>
    @Override
    public Gauge&lt;Long&gt; buildGauge(final String key) {
<span class="fc" id="L106">      return new StoredValueGauge(key);</span>
    }
  }

<span class="fc" id="L110">  private class CurrentTimeMillisDeltaGaugeFactory implements GaugeFactory&lt;Long&gt; {</span>
    @Override
    public Gauge&lt;Long&gt; buildGauge(final String key) {
<span class="fc" id="L113">      return new CurrentTimeMillisDeltaGauge(key);</span>
    }
  }

<span class="fc" id="L117">  private class CurrentTimeMillisDeltaGaugeHoursFactory implements GaugeFactory&lt;Double&gt; {</span>
    @Override
    public Gauge&lt;Double&gt; buildGauge(final String key) {
<span class="fc" id="L120">      return new CurrentTimeMillisDeltaGaugeHours(key);</span>
    }
  }

<span class="fc" id="L124">  private final StoredValueGaugeFactory _storedValueGaugeFactory = new StoredValueGaugeFactory();</span>
<span class="fc" id="L125">  private final CurrentTimeMillisDeltaGaugeFactory _currentTimeMillisDeltaGaugeFactory = new CurrentTimeMillisDeltaGaugeFactory();</span>
<span class="fc" id="L126">  private final CurrentTimeMillisDeltaGaugeHoursFactory _currentTimeMillisDeltaGaugeHoursFactory = new CurrentTimeMillisDeltaGaugeHoursFactory();</span>

  /**
   * Builds the validation metrics.
   *
   * @param metricsRegistry The metrics registry used to store all the gauges.
   */
<span class="fc" id="L133">  public ValidationMetrics(MetricsRegistry metricsRegistry) {</span>
<span class="fc" id="L134">    _metricsRegistry = metricsRegistry;</span>
<span class="fc" id="L135">  }</span>

  /**
   * Updates the missing segment count gauge.
   *
   * @param resource The resource for which the gauge is updated
   * @param missingSegmentCount The number of missing segments
   */
  public void updateMissingSegmentCountGauge(final String resource, final int missingSegmentCount) {
<span class="fc" id="L144">    final String fullGaugeName = makeGaugeName(resource, &quot;missingSegmentCount&quot;);</span>
<span class="fc" id="L145">    makeGauge(fullGaugeName, makeMetricName(fullGaugeName), _storedValueGaugeFactory, missingSegmentCount);</span>
<span class="fc" id="L146">  }</span>

  /**
   * Updates the offline segment delay gauge.
   *
   * @param resource The resource for which the gauge is updated
   * @param lastOfflineSegmentTime The last offline segment end time, in milliseconds since the epoch, or Long.MIN_VALUE
   *                               if there is no such time.
   */
  public void updateOfflineSegmentDelayGauge(final String resource, final long lastOfflineSegmentTime) {
<span class="fc" id="L156">    final String fullGaugeName = makeGaugeName(resource, &quot;offlineSegmentDelayMillis&quot;);</span>
<span class="fc" id="L157">    makeGauge(fullGaugeName, makeMetricName(fullGaugeName), _currentTimeMillisDeltaGaugeFactory, lastOfflineSegmentTime);</span>
<span class="fc" id="L158">    final String fullGaugeNameHours = makeGaugeName(resource, &quot;offlineSegmentDelayHours&quot;);</span>
<span class="fc" id="L159">    makeGauge(fullGaugeNameHours, makeMetricName(fullGaugeNameHours), _currentTimeMillisDeltaGaugeHoursFactory, lastOfflineSegmentTime);</span>
<span class="fc" id="L160">  }</span>

  /**
   * Updates the last push time gauge.
   *
   * @param resource The resource for which the gauge is updated
   * @param lastPushTimeMillis The last push time, in milliseconds since the epoch, or Long.MIN_VALUE if there is no
   *                           such time.
   */
  public void updateLastPushTimeGauge(final String resource, final long lastPushTimeMillis) {
<span class="fc" id="L170">    final String fullGaugeName = makeGaugeName(resource, &quot;lastPushTimeDelayMillis&quot;);</span>
<span class="fc" id="L171">    makeGauge(fullGaugeName, makeMetricName(fullGaugeName), _currentTimeMillisDeltaGaugeFactory, lastPushTimeMillis);</span>
<span class="fc" id="L172">    final String fullGaugeNameHours = makeGaugeName(resource, &quot;lastPushTimeDelayHours&quot;);</span>
<span class="fc" id="L173">    makeGauge(fullGaugeNameHours, makeMetricName(fullGaugeNameHours), _currentTimeMillisDeltaGaugeHoursFactory, lastPushTimeMillis);</span>
<span class="fc" id="L174">  }</span>

  /**
   * Updates the total document count gauge.
   *
   * @param resource The resource for which the gauge is updated
   * @param documentCount Total document count for the given resource name or table name
   */
  public void updateTotalDocumentCountGauge(final String resource, final long documentCount)
  {
<span class="fc" id="L184">    final String fullGaugeName = makeGaugeName(resource, &quot;TotalDocumentCount&quot;);</span>
<span class="fc" id="L185">    makeGauge(fullGaugeName, makeMetricName(fullGaugeName), _storedValueGaugeFactory, documentCount);</span>
<span class="fc" id="L186">  }</span>

  /**
   * Updates the non consuming partition count metric.
   *
   * @param resource The resource for which the gauge is updated
   * @param partitionCount Number of Kafka partitions that do not have any segment in CONSUMING state.
   */
  public void updateNonConsumingPartitionCountMetric(final String resource, final int partitionCount) {
<span class="nc" id="L195">    final String fullGaugeName = makeGaugeName(resource, &quot;NonConsumingPartitionCount&quot;);</span>
<span class="nc" id="L196">    makeGauge(fullGaugeName, makeMetricName(fullGaugeName), _storedValueGaugeFactory, partitionCount);</span>
<span class="nc" id="L197">  }</span>

  /**
   * Updates the segment count gauge.
   *
   * @param resource The resource for which the gauge is updated
   * @param segmentCount Total segment count for the given resource name or table name
   */
  public void updateSegmentCountGauge(final String resource, final long segmentCount)
  {
<span class="fc" id="L207">    final String fullGaugeName = makeGaugeName(resource, &quot;SegmentCount&quot;);</span>
<span class="fc" id="L208">    makeGauge(fullGaugeName, makeMetricName(fullGaugeName), _storedValueGaugeFactory, segmentCount);</span>
<span class="fc" id="L209">  }</span>

  private String makeGaugeName(final String resource, final String gaugeName) {
<span class="fc" id="L212">    return &quot;pinot.controller.&quot; + resource + &quot;.&quot; + gaugeName;</span>
  }

  private MetricName makeMetricName(final String gaugeName) {
<span class="fc" id="L216">    return new MetricName(ValidationMetrics.class, gaugeName);</span>
  }

  private void makeGauge(final String gaugeName, final MetricName metricName, final GaugeFactory&lt;?&gt; gaugeFactory, final long value) {
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    if (!_gaugeValues.containsKey(gaugeName)) {</span>
<span class="fc" id="L221">      _gaugeValues.put(gaugeName, value);</span>
<span class="fc" id="L222">      MetricsHelper.newGauge(_metricsRegistry, metricName, gaugeFactory.buildGauge(gaugeName));</span>
<span class="fc" id="L223">      _metricNames.add(metricName);</span>
    } else {
<span class="nc" id="L225">      _gaugeValues.put(gaugeName, value);</span>
    }
<span class="fc" id="L227">  }</span>

  /**
   * Unregisters all validation metrics.
   */
  public void unregisterAllMetrics() {
<span class="nc bnc" id="L233" title="All 2 branches missed.">    for (MetricName metricName : _metricNames) {</span>
<span class="nc" id="L234">      MetricsHelper.removeMetric(_metricsRegistry, metricName);</span>
<span class="nc" id="L235">    }</span>

<span class="nc" id="L237">    _metricNames.clear();</span>
<span class="nc" id="L238">    _gaugeValues.clear();</span>
<span class="nc" id="L239">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>