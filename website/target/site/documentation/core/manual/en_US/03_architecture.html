<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Architecture</title>
<link rel="stylesheet" href="css/blazebit.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="prettify/prettify.min.css">
<script src="prettify/prettify.min.js"></script>
<script src="prettify/lang-ext.js"></script>
<script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
<link rel="shortcut icon" href="images/favicon.png">
</head>
<body class="book toc2 toc-left">

<div class="brand">
    <a class="vendor" href="https://blazebit.com">
        <strong>Blazebit.com</strong>
    </a>
    <a class="logo" href="https://persistence.blazebit.com">
        <strong>blaze-persistence</strong>
    </a>
</div>
<br/>

<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#architecture">Architecture</a>
<ul class="sectlevel2">
<li><a href="#architecture-interfaces">Interfaces</a></li>
<li><a href="#architecture-query-building">Query building</a></li>
<li><a href="#architecture-jpa-provider-integration">JPA Provider Integration</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is just a high level view for those that are interested about how {projectname} works.</p>
</div>
<div class="sect2">
<h3 id="architecture-interfaces"><a class="anchor" href="#architecture-interfaces"></a>Interfaces</h3>
<div class="paragraph">
<p>A quick overview that presents the interfaces that are essential for users and how they are related.</p>
</div>
<div class="sect3">
<h4 id="architecture-interfaces-basic"><a class="anchor" href="#architecture-interfaces-basic"></a>Basic functionality</h4>
<div class="paragraph">
<p>{projectname} has a builder API for building JPQL queries in a comfortable fashion.</p>
</div>
<div class="paragraph">
<p>The most important interfaces that a user should be concerned with are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="{core_jdoc}/persistence/CriteriaBuilder.html"><code>com.blazebit.persistence.CriteriaBuilder</code></a></p>
</li>
<li>
<p><a href="{core_jdoc}/persistence/PaginatedCriteriaBuilder.html"><code>com.blazebit.persistence.PaginatedCriteriaBuilder</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The functionalities of the query builders are separated into base interfaces to avoid duplication where possible.
All functionality for the <code>WHERE</code>-clause for example can be found in <a href="{core_jdoc}/persistence/BaseWhereBuilder.html"><code>com.blazebit.persistence.BaseWhereBuilder</code></a>.
Analogous to that, there also exist interfaces for other clauses.</p>
</div>
<div class="paragraph">
<p>Unless some advanced features(e.g. CTEs) are used, the query string returned by every query builder is JPQL compliant and thus can also be directly compiled via <code>EntityManager#createQuery(String)</code>.
In case of advanced features the query string that is returned might contain syntax elements which are not supported by JPQL. Some features like CTEs simply can not be modeled with JPQL,
therefore a syntax similar to SQL was used to visualize the query model. The query objects returned for such queries are custom implementations,
so beware that you can&#8217;t simply cast them to provider specific subtypes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: can't modify frozen #&lt;Class:#&lt;Asciidoctor::Diagram::PlantUmlBlockProcessor:0x8b1ebed&gt;&gt;
interface BaseQueryBuilder
interface QueryBuilder
interface BaseCriteriaBuilder
interface FullCriteriaBuilder
interface PaginatedCriteriaBuilder
interface CriteriaBuilder
interface SetOperationBuilder

BaseQueryBuilder &lt;|-- QueryBuilder
BaseQueryBuilder &lt;|-- BaseCriteriaBuilder

QueryBuilder &lt;|-- FullCriteriaBuilder
FullCriteriaBuilder &lt;|-- PaginatedCriteriaBuilder
FullCriteriaBuilder &lt;|-- CriteriaBuilder
BaseCriteriaBuilder &lt;|-- CriteriaBuilder
SetOperationBuilder &lt;|-- CriteriaBuilder

hide members</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architecture-interfaces-dml"><a class="anchor" href="#architecture-interfaces-dml"></a>DML support</h4>
<div class="paragraph">
<p>If a user uses {projectname} for data manipulation too, then the following interfaces are unavoidable to know</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="{core_jdoc}/persistence/InsertCriteriaBuilder.html"><code>com.blazebit.persistence.InsertCriteriaBuilder</code></a></p>
</li>
<li>
<p><a href="{core_jdoc}/persistence/UpdateCriteriaBuilder.html"><code>com.blazebit.persistence.UpdateCriteriaBuilder</code></a></p>
</li>
<li>
<p><a href="{core_jdoc}/persistence/DeleteCriteriaBuilder.html"><code>com.blazebit.persistence.DeleteCriteriaBuilder</code></a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: can't modify frozen #&lt;Class:#&lt;Asciidoctor::Diagram::PlantUmlBlockProcessor:0x8b1ebed&gt;&gt;
interface BaseModificationCriteriaBuilder
interface BaseInsertCriteriaBuilder
interface BaseDeleteCriteriaBuilder
interface BaseUpdateCriteriaBuilder

interface ModificationCriteriaBuilder
interface InsertCriteriaBuilder
interface DeleteCriteriaBuilder
interface UpdateCriteriaBuilder

BaseModificationCriteriaBuilder &lt;|-- BaseInsertCriteriaBuilder
BaseModificationCriteriaBuilder &lt;|-- BaseDeleteCriteriaBuilder
BaseModificationCriteriaBuilder &lt;|-- BaseUpdateCriteriaBuilder
BaseModificationCriteriaBuilder &lt;|-- ModificationCriteriaBuilder

ModificationCriteriaBuilder &lt;|-- InsertCriteriaBuilder
BaseInsertCriteriaBuilder &lt;|-- InsertCriteriaBuilder

ModificationCriteriaBuilder &lt;|-- DeleteCriteriaBuilder
BaseDeleteCriteriaBuilder &lt;|-- DeleteCriteriaBuilder

ModificationCriteriaBuilder &lt;|-- UpdateCriteriaBuilder
BaseUpdateCriteriaBuilder &lt;|-- UpdateCriteriaBuilder

hide members</pre>
</div>
</div>
<div class="paragraph">
<p>Every interface has a dual partner interface prefixed with <code>Returning</code> that is relevant for data manipulation queries that return results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>Returning</code> interfaces are only relevant when using <a href="#updatable-ctes">CTEs (Common Table Expressions)</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: can't modify frozen #&lt;Class:#&lt;Asciidoctor::Diagram::PlantUmlBlockProcessor:0x8b1ebed&gt;&gt;
interface ReturningBuilder
interface BaseModificationCriteriaBuilder
interface BaseInsertCriteriaBuilder
interface BaseDeleteCriteriaBuilder
interface BaseUpdateCriteriaBuilder

interface ReturningModificationCriteriaBuilder
interface InsertCriteriaBuilder
interface DeleteCriteriaBuilder
interface UpdateCriteriaBuilder
interface ReturningInsertCriteriaBuilder
interface ReturningDeleteCriteriaBuilder
interface ReturningUpdateCriteriaBuilder

BaseModificationCriteriaBuilder &lt;|-- BaseInsertCriteriaBuilder
BaseModificationCriteriaBuilder &lt;|-- BaseDeleteCriteriaBuilder
BaseModificationCriteriaBuilder &lt;|-- BaseUpdateCriteriaBuilder
BaseModificationCriteriaBuilder &lt;|-- ReturningModificationCriteriaBuilder
ReturningBuilder &lt;|-- ReturningModificationCriteriaBuilder

ReturningModificationCriteriaBuilder &lt;|-- InsertCriteriaBuilder
BaseInsertCriteriaBuilder &lt;|-- ReturningInsertCriteriaBuilder

ReturningModificationCriteriaBuilder &lt;|-- DeleteCriteriaBuilder
BaseDeleteCriteriaBuilder &lt;|-- ReturningDeleteCriteriaBuilder

ReturningModificationCriteriaBuilder &lt;|-- UpdateCriteriaBuilder
BaseUpdateCriteriaBuilder &lt;|-- ReturningUpdateCriteriaBuilder

hide members</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architecture-interfaces-cte"><a class="anchor" href="#architecture-interfaces-cte"></a>CTE support</h4>
<div class="paragraph">
<p>CTE builders are split into two families of interface groups. One group is concerned with CTEs that do select queries, the other with DML queries.</p>
</div>
<div class="paragraph">
<p>Select CTE queries can either be recursive or non-recursive. Recursive CTEs always have a base part and a recursive part which is explicitly modeled in the API.
One starts with a <a href="{core_jdoc}/persistence/SelectRecursiveCTECriteriaBuilder.html"><code>com.blazebit.persistence.SelectRecursiveCTECriteriaBuilder</code></a> for defining the base part
and then unions the recursive part of the query in a <a href="{core_jdoc}/persistence/SelectCTECriteriaBuilder.html"><code>com.blazebit.persistence.SelectCTECriteriaBuilder</code></a>.
The non-recursive builder is very similar but does not have an explicit notion of a base or recursive part. Although it supports set operations,
we do not recommend building recursive queries with the non-recursive builder especially because it&#8217;s not portable and less readable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: can't modify frozen #&lt;Class:#&lt;Asciidoctor::Diagram::PlantUmlBlockProcessor:0x8b1ebed&gt;&gt;
interface BaseCTECriteriaBuilder
interface SelectBaseCTECriteriaBuilder
interface FullSelectCTECriteriaBuilder
interface SelectCTECriteriaBuilder
interface SelectRecursiveCTECriteriaBuilder
interface SetOperationBuilder

BaseCTECriteriaBuilder &lt;|-- SelectBaseCTECriteriaBuilder

SelectBaseCTECriteriaBuilder &lt;|-- SelectRecursiveCTECriteriaBuilder
SelectBaseCTECriteriaBuilder &lt;|-- SelectCTECriteriaBuilder
SelectBaseCTECriteriaBuilder &lt;|-- FullSelectCTECriteriaBuilder
SetOperationBuilder &lt;|-- FullSelectCTECriteriaBuilder

hide members</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architecture-interfaces-set"><a class="anchor" href="#architecture-interfaces-set"></a>Set operations support</h4>
<div class="paragraph">
<p>Every query builder has support for set operations as defined by the interface <a href="{core_jdoc}/persistence/SetOperationBuilder.html"><code>com.blazebit.persistence.SetOperationBuilder</code></a>.
One can start a nested group of query builders concatenated with set operations. This group has to be ended and concatenated with another query build or another nested group.
When an empty set operation group is encountered during the query building, it is removed internally.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: can't modify frozen #&lt;Class:#&lt;Asciidoctor::Diagram::PlantUmlBlockProcessor:0x8b1ebed&gt;&gt;
interface BaseOngoingSetOperationBuilder

interface StartOngoingSetOperationBuilder
interface OngoingSetOperationBuilder

interface BaseXXXBuilder
interface LeafOngoingFinalSetOperationXXXBuilder
interface MiddleOngoingSetOperationXXXBuilder
interface StartOngoingSetOperationXXXBuilder
interface OngoingSetOperationXXXBuilder
interface LeafOngoingSetOperationXXXBuilder

interface BaseFinalSetOperationBuilder

interface BaseOngoingFinalSetOperationBuilder
interface OngoingFinalSetOperationXXXBuilder
interface FinalSetOperationXXXBuilder

BaseOngoingSetOperationBuilder &lt;|-- StartOngoingSetOperationBuilder
BaseOngoingSetOperationBuilder &lt;|-- OngoingSetOperationBuilder
BaseOngoingSetOperationBuilder &lt;|-- LeafOngoingFinalSetOperationXXXBuilder
BaseOngoingSetOperationBuilder &lt;|-- LeafOngoingSetOperationXXXBuilder

OngoingSetOperationBuilder &lt;|-- MiddleOngoingSetOperationXXXBuilder
StartOngoingSetOperationBuilder &lt;|-- StartOngoingSetOperationXXXBuilder

MiddleOngoingSetOperationXXXBuilder &lt;|-- StartOngoingSetOperationXXXBuilder
BaseXXXBuilder &lt;|-- StartOngoingSetOperationXXXBuilder
MiddleOngoingSetOperationXXXBuilder &lt;|-- OngoingSetOperationXXXBuilder
BaseXXXBuilder &lt;|-- OngoingSetOperationXXXBuilder
BaseXXXBuilder &lt;|-- LeafOngoingSetOperationXXXBuilder

BaseFinalSetOperationBuilder &lt;|-- BaseOngoingFinalSetOperationBuilder
BaseFinalSetOperationBuilder &lt;|-- FinalSetOperationXXXBuilder
FinalSetOperationXXXBuilder &lt;|-- OngoingFinalSetOperationXXXBuilder

hide members</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder
    .startSet(Cat.class) <i class="conum" data-value="1"></i><b>(1)</b>
        .startUnionAll() <i class="conum" data-value="2"></i><b>(2)</b>
        .endSetWith() <i class="conum" data-value="3"></i><b>(3)</b>
        .endSet() <i class="conum" data-value="4"></i><b>(4)</b>
        .unionAll() <i class="conum" data-value="5"></i><b>(5)</b>
    .endSet() <i class="conum" data-value="6"></i><b>(6)</b>
    .unionAll() <i class="conum" data-value="7"></i><b>(7)</b>
    .endSet() <i class="conum" data-value="8"></i><b>(8)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting a builder with a nested set operation group returns <code>StartOngoingSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Starting any nested set operation group returns <code>StartOngoingSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ending nested set operation group with <code>endSetWith()</code> to specify ordering and limiting returns <code>OngoingFinalSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ending a nested set operation group with <code>endSet()</code> results in <code>MiddleOngoingSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Connecting a nested set operation group with a set operation results in <code>OngoingSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Ending a top level set operation nested group results in <code>LeafOngoingFinalSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Connecting a top level set operation group with a set operation results in <code>LeafOngoingSetOperationXXXBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Ending the top level set operation results in <code>FinalSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="architecture-interfaces-set-toplevel"><a class="anchor" href="#architecture-interfaces-set-toplevel"></a>Top-level query builder set operations</h5>
<div class="paragraph">
<p>Invoking a set operation on a top level query builder results in a <code>LeafOngoingSetOperationXXXBuilder</code> type.
<code>LeafOngoingSetOperationXXXBuilder</code> types are the possible <em>exit types</em> for a top level set operation group.</p>
</div>
<div class="paragraph">
<p>Further connecting the builder via a set operation will produce a builder of the same type <code>LeafOngoingSetOperationXXXBuilder</code>.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .unionAll() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The set operation on a top level query builder produces <code>LeafOngoingSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When ending such a builder via <code>endSet()</code>, a <code>FinalSetOperationXXXBuilder</code> is produced.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .unionAll()
    .endSet() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The ending of a top level set operation builder produces <code>FinalSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>FinalSetOperationXXXBuilder</code> types are the result of a top level set operation and once constructed only support specifying ordering or limiting.</p>
</div>
</div>
<div class="sect4">
<h5 id="architecture-interfaces-set-nested"><a class="anchor" href="#architecture-interfaces-set-nested"></a>Nested query builder set operations</h5>
<div class="paragraph">
<p>Invoking a nested set operation on a query builder results in a <code>StartOngoingSetOperationXXXBuilder</code> type.
<code>StartOngoingSetOperationXXXBuilder</code> types represent a builder for a group of set operations within parenthesis.
With such a builder the normal query builder methods are available and additionally, it can end the group.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The nested set operation on a query builder produces <code>StartOngoingSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When connecting the builder with another set operation a <code>OngoingSetOperationXXXBuilder</code> is produced which essentially has the same functionality.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll()
    .unionAll() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A set operation on a <code>StartOngoingSetOperationXXXBuilder</code> produces <code>OngoingSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When ending such a top level nested builder via <code>endSet()</code>, a <code>LeafOngoingFinalSetOperationXXXBuilder</code> is produced.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll()
    .endSet() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Results in <code>LeafOngoingFinalSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Or when in a nested context, a <code>MiddleOngoingSetOperationXXXBuilder</code> is produced.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll()
    .startUnionAll()
    .endSet() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Results in <code>MiddleOngoingSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ending of the builder is equivalent to doing a <em>closing parenthesis</em>.</p>
</div>
<div class="paragraph">
<p>Since a nested group only makes sense when connecting the group with something else, the <code>LeafOngoingFinalSetOperationXXXBuilder</code> and <code>MiddleOngoingSetOperationXXXBuilder</code> only allow connecting
a new builder with a set operation or ending the whole query builder.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll()
    .endSet()
    .unionAll() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Results in <code>LeafOngoingSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Or when in a nested context, a <code>OngoingSetOperationXXXBuilder</code> is produced.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll()
    .startUnionAll()
    .endSet()
    .unionAll() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Results in <code>OngoingSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ending a nested group with <code>endSetWith()</code> allows to specify ordering and limiting for the group and returns a <code>OngoingFinalSetOperationXXXBuilder</code>.</p>
</div>
<div class="listingblock">
<div class="content">
    <pre class="prettyprint javaext lang-javaext">criteriaBuilder.from(Cat.class)
    .startUnionAll()
    .endSetWith() <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Results in <code>OngoingFinalSetOperationXXXBuilder</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="architecture-query-building"><a class="anchor" href="#architecture-query-building"></a>Query building</h3>
<div class="paragraph">
<p>Every query builder has several clause specific <em>managers</em> that it delegates to. These <em>managers</em> contain the state for a clause and might interact with other clauses.
Depending on which query builder features are used, the query object that is produced by a query builder through <code>getTypeQuery()</code> or <code>getQuery()</code> is either the JPA provider&#8217;s native query or a custom query.</p>
</div>
<div class="paragraph">
<p>If no advanced features are used, nothing special happens. The query string is built and passed to <code>EntityManager.createQuery()</code> which is then returned.
When advanced features are used, an <em>example query</em> is built which most of the time is very similar to the original query except for advanced features.
This <em>example query</em> serves as a basis for execution of advanced SQL. It almost contains all the necessary parts, there is just some SQL that needs to be replaced.</p>
</div>
<div class="paragraph">
<p>If CTEs are involved, one query per CTE is built via the same mechanism and added to the <em>participating queries</em> list. This list is ordered and contains all query parts that are involved in an advanced query.
The ordering is important because in the end, parameters are positionally set in SQL and the order within the list represents the order of the query parts in the SQL.
All these query objects are then passed to a <em>QuerySpecification</em> which is capable of producing the SQL for the whole query from it&#8217;s query parts.
It serves as component that can be composed into a bigger query but also provides a method for creating a <em>SelectQueryPlan</em> or <em>ModificationQueryPlan</em>.
Such query plans represent the executable form of query specifications that are fixed. The reason for the separation between the two is that <em>list parameters</em> or calls to <code>setFirstResult()</code> and <code>setMaxResults()</code> could change the SQL.</p>
</div>
<div class="paragraph">
<p>The query specification is wrapped in an implementation of the JPA query interfaces <code>javax.persistence.Query</code> or <code>javax.persistence.TypedQuery</code> and a query plan is only created on demand just before executing.
Parameters, lock modes and flush modes are propagated to all necessary <em>participating queries</em>.</p>
</div>
<div class="paragraph">
<p>Set operations on top level queries essentially are special query specifications that contain multiple other query specifications.</p>
</div>
<div class="paragraph">
<p>To really execute such advanced queries, query plans use the <code>ExtendedQuerySupport</code>. It offers methods to run an JPA query with an SQL replacement and a list of <em>participating queries</em>.
The <code>ExtendedQuerySupport</code> is JPA provider specific and is responsible for proper query caching and giving access to SQL specifics of JPA query objects.</p>
</div>
<div class="paragraph">
<p>The integration of <code>ObjectBuilder</code> is done by introducing a query wrapper that takes results, passes them through the object builder and then returns the results.</p>
</div>
</div>
<div class="sect2">
<h3 id="architecture-jpa-provider-integration"><a class="anchor" href="#architecture-jpa-provider-integration"></a>JPA Provider Integration</h3>
<div class="paragraph">
<p>The essential integration points with the JPA provider are encapsulated in <code>EntityManagerFactoryIntegrator</code> and <code>ExtendedQuerySupport</code>.</p>
</div>
<div class="paragraph">
<p>The <code>EntityManagerFactoryIntegrator</code> offers support for DBMS detection, function registration and
the construction of a <code>JpaProvider</code> through a <code>JpaProviderFactory</code>. The <code>JpaProvider</code> is a contract that can be used to query JPA provider specifics.
Some of those specifics are whether a feature like entity joins is supported but also metamodel specifics like whether an attribute has a join table.</p>
</div>
<div class="paragraph">
<p>The <code>ExtendedQuerySupport</code> is necessary for advanced SQL related functionality and might not be available for a JPA provider.
It provides access to SQL related information like the column names of an entity attribute or simply the SQL query for a JPA query.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-08-05 16:46:14 KST
</div>
</div>
</body>
</html>