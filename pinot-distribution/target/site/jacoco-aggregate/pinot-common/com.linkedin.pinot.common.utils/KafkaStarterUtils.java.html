<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>KafkaStarterUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-distribution</a> &gt; <a href="../index.html" class="el_bundle">pinot-common</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.common.utils</a> &gt; <span class="el_source">KafkaStarterUtils.java</span></div><h1>KafkaStarterUtils.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.common.utils;

import java.io.File;
import java.security.Permission;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import org.I0Itec.zkclient.ZkClient;
import org.apache.commons.io.FileUtils;
import kafka.admin.TopicCommand;
import kafka.server.KafkaConfig;
import kafka.server.KafkaServerStartable;


/**
 * Utilities to start Kafka during unit tests.
 *
 */
<span class="nc" id="L34">public class KafkaStarterUtils {</span>
  public static final int DEFAULT_KAFKA_PORT = 19092;
  public static final int DEFAULT_BROKER_ID = 0;
  public static final String DEFAULT_ZK_STR = ZkStarter.DEFAULT_ZK_STR + &quot;/kafka&quot;;
  public static final String DEFAULT_KAFKA_BROKER = &quot;localhost:&quot; + DEFAULT_KAFKA_PORT;

  public static Properties getDefaultKafkaConfiguration() {
<span class="nc" id="L41">    final Properties configuration = new Properties();</span>

    // Enable topic deletion by default for integration tests
<span class="nc" id="L44">    configureTopicDeletion(configuration, true);</span>

    // Set host name
<span class="nc" id="L47">    configureHostName(configuration, &quot;localhost&quot;);</span>

<span class="nc" id="L49">    return configuration;</span>
  }

  public static List&lt;KafkaServerStartable&gt; startServers(final int brokerCount, final int port, final String zkStr,
      final Properties configuration) {
<span class="nc" id="L54">    List&lt;KafkaServerStartable&gt; startables = new ArrayList&lt;&gt;(brokerCount);</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">    for (int i = 0; i &lt; brokerCount; i++) {</span>
<span class="nc" id="L57">      startables.add(startServer(port + i, i, zkStr, &quot;/tmp/kafka-&quot; + Double.toHexString(Math.random()), configuration));</span>
    }

<span class="nc" id="L60">    return startables;</span>
  }

  public static KafkaServerStartable startServer(final int port, final int brokerId, final String zkStr,
      final Properties configuration) {
<span class="nc" id="L65">    return startServer(port, brokerId, zkStr, &quot;/tmp/kafka-&quot; + Double.toHexString(Math.random()), configuration);</span>
  }

  public static KafkaServerStartable startServer(final int port, final int brokerId, final String zkStr,
      final String logDirPath, final Properties configuration) {
    // Create the ZK nodes for Kafka, if needed
<span class="nc" id="L71">    int indexOfFirstSlash = zkStr.indexOf('/');</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">    if (indexOfFirstSlash != -1) {</span>
<span class="nc" id="L73">      String bareZkUrl = zkStr.substring(0, indexOfFirstSlash);</span>
<span class="nc" id="L74">      String zkNodePath = zkStr.substring(indexOfFirstSlash);</span>
<span class="nc" id="L75">      ZkClient client = new ZkClient(bareZkUrl);</span>
<span class="nc" id="L76">      client.createPersistent(zkNodePath, true);</span>
<span class="nc" id="L77">      client.close();</span>
    }

<span class="nc" id="L80">    File logDir = new File(logDirPath);</span>
<span class="nc" id="L81">    logDir.mkdirs();</span>

<span class="nc" id="L83">    configureKafkaPort(configuration, port);</span>
<span class="nc" id="L84">    configureZkConnectionString(configuration, zkStr);</span>
<span class="nc" id="L85">    configureBrokerId(configuration, brokerId);</span>
<span class="nc" id="L86">    configureKafkaLogDirectory(configuration, logDir);</span>
<span class="nc" id="L87">    configuration.put(&quot;zookeeper.session.timeout.ms&quot;, &quot;60000&quot;);</span>
<span class="nc" id="L88">    KafkaConfig config = new KafkaConfig(configuration);</span>

<span class="nc" id="L90">    KafkaServerStartable serverStartable = new KafkaServerStartable(config);</span>
<span class="nc" id="L91">    serverStartable.startup();</span>

<span class="nc" id="L93">    return serverStartable;</span>
  }

  public static void configureSegmentSizeBytes(Properties properties, int segmentSize) {
<span class="nc" id="L97">    properties.put(&quot;log.segment.bytes&quot;, Integer.toString(segmentSize));</span>
<span class="nc" id="L98">  }</span>

  public static void configureLogRetentionSizeBytes(Properties properties, int logRetentionSizeBytes) {
<span class="nc" id="L101">    properties.put(&quot;log.retention.bytes&quot;, Integer.toString(logRetentionSizeBytes));</span>
<span class="nc" id="L102">  }</span>

  public static void configureKafkaLogDirectory(Properties configuration, File logDir) {
<span class="nc" id="L105">    configuration.put(&quot;log.dirs&quot;, logDir.getAbsolutePath());</span>
<span class="nc" id="L106">  }</span>

  public static void configureBrokerId(Properties configuration, int brokerId) {
<span class="nc" id="L109">    configuration.put(&quot;broker.id&quot;, Integer.toString(brokerId));</span>
<span class="nc" id="L110">  }</span>

  public static void configureZkConnectionString(Properties configuration, String zkStr) {
<span class="nc" id="L113">    configuration.put(&quot;zookeeper.connect&quot;, zkStr);</span>
<span class="nc" id="L114">  }</span>

  public static void configureKafkaPort(Properties configuration, int port) {
<span class="nc" id="L117">    configuration.put(&quot;port&quot;, Integer.toString(port));</span>
<span class="nc" id="L118">  }</span>

  public static void configureTopicDeletion(Properties configuration, boolean topicDeletionEnabled) {
<span class="nc" id="L121">    configuration.put(&quot;delete.topic.enable&quot;, Boolean.toString(topicDeletionEnabled));</span>
<span class="nc" id="L122">  }</span>

  public static void configureHostName(Properties configuration, String hostName) {
<span class="nc" id="L125">    configuration.put(&quot;host.name&quot;, hostName);</span>
<span class="nc" id="L126">  }</span>

  public static void stopServer(KafkaServerStartable serverStartable) {
<span class="nc" id="L129">    serverStartable.shutdown();</span>
<span class="nc" id="L130">    FileUtils.deleteQuietly(new File(serverStartable.serverConfig().logDirs().apply(0)));</span>
<span class="nc" id="L131">  }</span>

  public static void createTopic(String kafkaTopic, String zkStr, int partitionCount) {
<span class="nc" id="L134">    invokeTopicCommand(</span>
        new String[]{&quot;--create&quot;, &quot;--zookeeper&quot;, zkStr, &quot;--replication-factor&quot;, &quot;1&quot;, &quot;--partitions&quot;, Integer.toString(
            partitionCount), &quot;--topic&quot;,
            kafkaTopic});
<span class="nc" id="L138">  }</span>

  private static void invokeTopicCommand(String[] args) {
    // jfim: Use Java security to trap System.exit in Kafka 0.9's TopicCommand
<span class="nc" id="L142">    System.setSecurityManager(new SecurityManager() {</span>
      @Override
      public void checkPermission(Permission perm) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (perm.getName().startsWith(&quot;exitVM&quot;)) {</span>
<span class="nc" id="L146">          throw new SecurityException(&quot;System.exit is disabled&quot;);</span>
        }
<span class="nc" id="L148">      }</span>

      @Override
      public void checkPermission(Permission perm, Object context) {
<span class="nc" id="L152">        checkPermission(perm);</span>
<span class="nc" id="L153">      }</span>
    });

    try {
<span class="nc" id="L157">      TopicCommand.main(args);</span>
<span class="nc" id="L158">    } catch (SecurityException ex) {</span>
      // Do nothing, this is caused by our security manager that disables System.exit
<span class="nc" id="L160">    }</span>

<span class="nc" id="L162">    System.setSecurityManager(null);</span>
<span class="nc" id="L163">  }</span>

  public static void deleteTopic(String kafkaTopic, String zkStr) {
<span class="nc" id="L166">    invokeTopicCommand(new String[]{&quot;--delete&quot;, &quot;--zookeeper&quot;, zkStr, &quot;--topic&quot;, kafkaTopic});</span>
<span class="nc" id="L167">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>