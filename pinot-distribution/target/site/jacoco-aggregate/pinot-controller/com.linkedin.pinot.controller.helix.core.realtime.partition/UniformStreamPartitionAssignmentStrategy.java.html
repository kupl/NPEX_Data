<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UniformStreamPartitionAssignmentStrategy.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-distribution</a> &gt; <a href="../index.html" class="el_bundle">pinot-controller</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.controller.helix.core.realtime.partition</a> &gt; <span class="el_source">UniformStreamPartitionAssignmentStrategy.java</span></div><h1>UniformStreamPartitionAssignmentStrategy.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.controller.helix.core.realtime.partition;

import com.linkedin.pinot.common.config.TableConfig;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;


/**
 * Generates a uniform partition assignment for the table
 * The partition assignment is done by uniformly spraying the partitions across available instances
 * A random point is picked as the start for the spreading out over instances
 *
 * This strategy does not care about what are the other tables on the tenant,
 * and only assigns partitions for the one table that is being added/updated
 *
 * NOTE: We do not support/expect partition aware tables with multi tenant setup, hence this strategy should suffice
 *
 * An example znode for 8 kafka partitions and and 6 realtime servers (Server_s1 to Server_s6)
 * for a table config with UniformStreamPartitionAssignmentStrategy looks as below in zookeeper.
 * This example assumes that the random point picked was at the first server i.e. Server_s1.company.com
 *
 {
   &quot;id&quot;:&quot;KafkaTopicName&quot;
   ,&quot;simpleFields&quot;:{
   }
   ,&quot;listFields&quot;:{
     &quot;0&quot;:[&quot;Server_s1.company.com_8001&quot;,&quot;Server_s2.company.com_8001&quot;,&quot;Server_s3.company.com_8001&quot;]
     ,&quot;1&quot;:[&quot;Server_s4.company.com_8001&quot;,&quot;Server_s5.company.com_8001&quot;,&quot;Server_s6.company.com_8001&quot;]
     ,&quot;2&quot;:[&quot;Server_s1.company.com_8001&quot;,&quot;Server_s2.company.com_8001&quot;,&quot;Server_s3.company.com_8001&quot;]
     ,&quot;3&quot;:[&quot;Server_s4.company.com_8001&quot;,&quot;Server_s5.company.com_8001&quot;,&quot;Server_s6.company.com_8001&quot;]
     ,&quot;4&quot;:[&quot;Server_s1.company.com_8001&quot;,&quot;Server_s2.company.com_8001&quot;,&quot;Server_s3.company.com_8001&quot;]
     ,&quot;5&quot;:[&quot;Server_s4.company.com_8001&quot;,&quot;Server_s5.company.com_8001&quot;,&quot;Server_s6.company.com_8001&quot;]
     ,&quot;6&quot;:[&quot;Server_s1.company.com_8001&quot;,&quot;Server_s2.company.com_8001&quot;,&quot;Server_s3.company.com_8001&quot;]
     ,&quot;7&quot;:[&quot;Server_s4.company.com_8001&quot;,&quot;Server_s5.company.com_8001&quot;,&quot;Server_s6.company.com_8001&quot;]
   }
   ,&quot;mapFields&quot;:{
   }
 }
 *
 */
<span class="fc" id="L59">public class UniformStreamPartitionAssignmentStrategy implements StreamPartitionAssignmentStrategy {</span>

  private List&lt;String&gt; _instanceNames;

<span class="fc" id="L63">  private final Random rand = new Random();</span>

  @Override
  public void init(List&lt;TableConfig&gt; allTablesInTenant, List&lt;String&gt; instanceNames,
      Map&lt;String, List&lt;RealtimePartition&gt;&gt; tableNameToPartitionsList) {
<span class="fc" id="L68">    _instanceNames = instanceNames;</span>
    // TODO: this strategy does not read other tables in the tenant and their partition assignments for now
    // This is because we want to avoid the race conditions we might encounter,
    // when multiple controllers try to read/write the partitions at the same time
<span class="fc" id="L72">  }</span>

  @Override
  public Map&lt;String, List&lt;RealtimePartition&gt;&gt; generatePartitionAssignment(TableConfig tableConfig, int numPartitions) {

<span class="fc" id="L77">    Map&lt;String, List&lt;RealtimePartition&gt;&gt; newPartitionAssignment = new HashMap&lt;&gt;(1);</span>

<span class="fc" id="L79">    int numReplicas = tableConfig.getValidationConfig().getReplicasPerPartitionNumber();</span>

<span class="fc" id="L81">    List&lt;RealtimePartition&gt; realtimePartitions = new ArrayList&lt;&gt;(numPartitions);</span>
<span class="fc" id="L82">    int serverId = rand.nextInt(_instanceNames.size());</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">    for (int p = 0; p &lt; numPartitions; p++) {</span>
<span class="fc" id="L84">      List&lt;String&gt; instances = new ArrayList&lt;&gt;(numReplicas);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">      for (int r = 0; r &lt; numReplicas; r++) {</span>
<span class="fc" id="L86">        instances.add(_instanceNames.get(serverId++));</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (serverId == _instanceNames.size()) {</span>
<span class="fc" id="L88">          serverId = 0;</span>
        }
      }
<span class="fc" id="L91">      realtimePartitions.add(new RealtimePartition(String.valueOf(p), instances));</span>
    }

<span class="fc" id="L94">    newPartitionAssignment.put(tableConfig.getTableName(), realtimePartitions);</span>
<span class="fc" id="L95">    return newPartitionAssignment;</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>