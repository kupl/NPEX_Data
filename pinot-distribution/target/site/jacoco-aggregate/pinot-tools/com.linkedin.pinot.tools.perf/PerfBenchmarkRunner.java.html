<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PerfBenchmarkRunner.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-distribution</a> &gt; <a href="../index.html" class="el_bundle">pinot-tools</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.tools.perf</a> &gt; <span class="el_source">PerfBenchmarkRunner.java</span></div><h1>PerfBenchmarkRunner.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.tools.perf;

import com.google.common.base.Preconditions;
import com.linkedin.pinot.core.segment.index.SegmentMetadataImpl;
import com.linkedin.pinot.tools.AbstractBaseCommand;
import com.linkedin.pinot.tools.Command;
import java.io.File;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;
import org.kohsuke.args4j.CmdLineParser;
import org.kohsuke.args4j.Option;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


@SuppressWarnings(&quot;FieldCanBeLocal&quot;)
<span class="nc" id="L35">public class PerfBenchmarkRunner extends AbstractBaseCommand implements Command {</span>
<span class="nc" id="L36">  private static final Logger LOGGER = LoggerFactory.getLogger(PerfBenchmarkRunner.class);</span>

  @Option(name = &quot;-mode&quot;, required = true, metaVar = &quot;&lt;String&gt;&quot;,
      usage = &quot;Mode of the PerfBenchmarkRunner (startAll|startAllButServer|startServerWithPreLoadedSegments).&quot;)
  private String _mode;

  @Option(name = &quot;-dataDir&quot;, required = false, metaVar = &quot;&lt;String&gt;&quot;, usage = &quot;Path to data directory.&quot;)
  private String _dataDir;

<span class="nc" id="L45">  @Option(name = &quot;-tempDir&quot;, required = false, metaVar = &quot;&lt;String&gt;&quot;,</span>
      usage = &quot;Path to temporary directory to start the cluster&quot;)
  private String _tempDir = &quot;/tmp/&quot;;

<span class="nc" id="L49">  @Option(name = &quot;-loadMode&quot;, required = false, metaVar = &quot;&lt;String&gt;&quot;, usage = &quot;Load mode of the segments (HEAP|MMAP).&quot;)</span>
  private String _loadMode = &quot;HEAP&quot;;

  @Option(name = &quot;-segmentFormatVersion&quot;, required = false, metaVar = &quot;&lt;String&gt;&quot;,
      usage = &quot;Segment format version to be loaded (v1|v3).&quot;)
  private String _segmentFormatVersion;

  @Option(name = &quot;-batchLoad&quot;, required = false, metaVar = &quot;&lt;boolean&gt;&quot;, usage = &quot;Batch load multiple tables.&quot;)
  private boolean _isBatchLoad;

<span class="nc" id="L59">  @Option(name = &quot;-numThreads&quot;, required = false, metaVar = &quot;&lt;int&gt;&quot;,</span>
      usage = &quot;Number of threads for batch load (default 10).&quot;)
  private int _numThreads = 10;

<span class="nc" id="L63">  @Option(name = &quot;-timeoutInSeconds&quot;, required = false, metaVar = &quot;&lt;int&gt;&quot;,</span>
      usage = &quot;Timeout in seconds for batch load (default 60).&quot;)
  private int _timeoutInSeconds = 60;

  @Option(name = &quot;-tableNames&quot;, required = false, metaVar = &quot;&lt;String&gt;&quot;,
      usage = &quot;Comma separated table names to be loaded (non-batch load).&quot;)
  private String _tableNames;

  @Option(name = &quot;-invertedIndexColumns&quot;, required = false, metaVar = &quot;&lt;String&gt;&quot;,
      usage = &quot;Comma separated inverted index columns to be created (non-batch load).&quot;)
  private String _invertedIndexColumns;

<span class="nc" id="L75">  @Option(name = &quot;-help&quot;, required = false, help = true, aliases = {&quot;-h&quot;, &quot;--h&quot;, &quot;--help&quot;},</span>
      usage = &quot;Print this message.&quot;)
  private boolean _help = false;

  @Override
  public boolean getHelp() {
<span class="nc" id="L81">    return _help;</span>
  }

  @Override
  public String getName() {
<span class="nc" id="L86">    return getClass().getSimpleName();</span>
  }

  @Override
  public String description() {
<span class="nc" id="L91">    return &quot;Start Pinot cluster with optional preloaded segments.&quot;;</span>
  }

  @Override
  public boolean execute()
      throws Exception {
<span class="nc bnc" id="L97" title="All 4 branches missed.">    if (_mode.equalsIgnoreCase(&quot;startAll&quot;) || _mode.equalsIgnoreCase(&quot;startAllButServer&quot;)) {</span>
<span class="nc" id="L98">      startAllButServer();</span>
    }
<span class="nc bnc" id="L100" title="All 4 branches missed.">    if (_mode.equalsIgnoreCase(&quot;startAll&quot;) || _mode.equalsIgnoreCase(&quot;startServerWithPreLoadedSegments&quot;)) {</span>
<span class="nc" id="L101">      startServerWithPreLoadedSegments();</span>
    }
<span class="nc" id="L103">    return true;</span>
  }

  public void startAllButServer()
      throws Exception {
<span class="nc" id="L108">    PerfBenchmarkDriverConf perfBenchmarkDriverConf = new PerfBenchmarkDriverConf();</span>
<span class="nc" id="L109">    perfBenchmarkDriverConf.setStartServer(false);</span>
<span class="nc" id="L110">    PerfBenchmarkDriver driver =</span>
        new PerfBenchmarkDriver(perfBenchmarkDriverConf, _tempDir, _loadMode, _segmentFormatVersion, false);
<span class="nc" id="L112">    driver.run();</span>
<span class="nc" id="L113">  }</span>

  private void startServerWithPreLoadedSegments()
      throws Exception {
<span class="nc" id="L117">    PerfBenchmarkDriverConf perfBenchmarkDriverConf = new PerfBenchmarkDriverConf();</span>
<span class="nc" id="L118">    perfBenchmarkDriverConf.setStartZookeeper(false);</span>
<span class="nc" id="L119">    perfBenchmarkDriverConf.setStartController(false);</span>
<span class="nc" id="L120">    perfBenchmarkDriverConf.setStartBroker(false);</span>
<span class="nc" id="L121">    perfBenchmarkDriverConf.setServerInstanceDataDir(_dataDir);</span>
<span class="nc" id="L122">    final PerfBenchmarkDriver driver =</span>
        new PerfBenchmarkDriver(perfBenchmarkDriverConf, _tempDir, _loadMode, _segmentFormatVersion, false);
<span class="nc" id="L124">    driver.run();</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (_isBatchLoad) {</span>
<span class="nc" id="L127">      String[] tableNames = new File(_dataDir).list();</span>
<span class="nc" id="L128">      Preconditions.checkNotNull(tableNames);</span>
<span class="nc" id="L129">      ExecutorService executorService = Executors.newFixedThreadPool(_numThreads);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">      for (final String tableName : tableNames) {</span>
<span class="nc" id="L131">        executorService.submit(new Runnable() {</span>
          @Override
          public void run() {
            try {
<span class="nc" id="L135">              loadTable(driver, _dataDir, tableName, null);</span>
<span class="nc" id="L136">            } catch (Exception e) {</span>
<span class="nc" id="L137">              LOGGER.error(&quot;Caught exception while loading table: {}&quot;, tableName, e);</span>
<span class="nc" id="L138">            }</span>
<span class="nc" id="L139">          }</span>
        });
      }
<span class="nc" id="L142">      executorService.shutdown();</span>
<span class="nc" id="L143">      executorService.awaitTermination(_timeoutInSeconds, TimeUnit.SECONDS);</span>
<span class="nc" id="L144">    } else {</span>
<span class="nc" id="L145">      List&lt;String&gt; invertedIndexColumns = null;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">      if (_invertedIndexColumns != null) {</span>
<span class="nc" id="L147">        invertedIndexColumns = Arrays.asList(_invertedIndexColumns.split(&quot;,&quot;));</span>
      }
<span class="nc bnc" id="L149" title="All 2 branches missed.">      for (String tableName : _tableNames.split(&quot;,&quot;)) {</span>
<span class="nc" id="L150">        loadTable(driver, _dataDir, tableName, invertedIndexColumns);</span>
      }
    }
<span class="nc" id="L153">  }</span>

  public static void loadTable(PerfBenchmarkDriver driver, String dataDir, String tableName,
      List&lt;String&gt; invertedIndexColumns)
      throws Exception {
<span class="nc" id="L158">    boolean tableConfigured = false;</span>
<span class="nc" id="L159">    File[] segments = new File(dataDir, tableName).listFiles();</span>
<span class="nc" id="L160">    Preconditions.checkNotNull(segments);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">    for (File segment : segments) {</span>
<span class="nc" id="L162">      SegmentMetadataImpl segmentMetadata = new SegmentMetadataImpl(segment);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">      if (!tableConfigured) {</span>
<span class="nc" id="L164">        driver.configureTable(segmentMetadata.getTableName(), invertedIndexColumns);</span>
<span class="nc" id="L165">        tableConfigured = true;</span>
      }
<span class="nc" id="L167">      driver.addSegment(segmentMetadata);</span>
    }
<span class="nc" id="L169">  }</span>

  /**
   * Main method for the class.
   *
   * @param args arguments for the perf benchmark runner.
   * @throws Exception
   */
  public static void main(String[] args)
      throws Exception {
<span class="nc" id="L179">    PerfBenchmarkRunner perfBenchmarkRunner = new PerfBenchmarkRunner();</span>
<span class="nc" id="L180">    CmdLineParser parser = new CmdLineParser(perfBenchmarkRunner);</span>
<span class="nc" id="L181">    parser.parseArgument(args);</span>

<span class="nc bnc" id="L183" title="All 2 branches missed.">    if (perfBenchmarkRunner._help) {</span>
<span class="nc" id="L184">      perfBenchmarkRunner.printUsage();</span>
    } else {
<span class="nc" id="L186">      perfBenchmarkRunner.execute();</span>
    }
<span class="nc" id="L188">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>