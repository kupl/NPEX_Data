<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ColumnarToStarTreeConverter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-distribution</a> &gt; <a href="../index.html" class="el_bundle">pinot-tools</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.tools.segment.converter</a> &gt; <span class="el_source">ColumnarToStarTreeConverter.java</span></div><h1>ColumnarToStarTreeConverter.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.tools.segment.converter;

import com.linkedin.pinot.common.data.StarTreeIndexSpec;
import com.linkedin.pinot.common.segment.SegmentMetadata;
import com.linkedin.pinot.common.utils.TarGzCompressionUtils;
import com.linkedin.pinot.core.data.readers.FileFormat;
import com.linkedin.pinot.core.data.readers.PinotSegmentRecordReader;
import com.linkedin.pinot.core.indexsegment.generator.SegmentGeneratorConfig;
import com.linkedin.pinot.core.segment.DefaultSegmentNameGenerator;
import com.linkedin.pinot.core.segment.SegmentNameGenerator;
import com.linkedin.pinot.core.segment.creator.SegmentIndexCreationDriver;
import com.linkedin.pinot.core.segment.creator.impl.SegmentIndexCreationDriverImpl;
import com.linkedin.pinot.core.segment.index.SegmentMetadataImpl;
import java.io.File;
import java.lang.reflect.Field;
import org.apache.commons.io.FileUtils;
import org.codehaus.jackson.map.ObjectMapper;
import org.kohsuke.args4j.CmdLineParser;
import org.kohsuke.args4j.Option;


/**
 * Class to convert Pinot Columnar Segment to Pinot Star Tree Segment
 */
<span class="nc" id="L40">public class ColumnarToStarTreeConverter {</span>
  private static final String TMP_DIR_PREFIX = &quot;_tmp_&quot;;
<span class="nc" id="L42">  private static final ObjectMapper objectMapper = new ObjectMapper();</span>

<span class="nc" id="L44">  @Option(name = &quot;-inputDir&quot;, required = true, usage = &quot;Path to input directory containing Pinot segments&quot;)</span>
  private String _inputDirName = null;

<span class="nc" id="L47">  @Option(name = &quot;-outputDir&quot;, required = true, usage = &quot;Path to output directory&quot;)</span>
  private String _outputDirName = null;

<span class="nc" id="L50">  @Option(name = &quot;-starTreeConfigFile&quot;, required = false, usage = &quot;Path to Star Tree configuration file&quot;)</span>
  private String _starTreeConfigFileName = null;

<span class="nc" id="L53">  @SuppressWarnings(&quot;FieldCanBeLocal&quot;)</span>
  @Option(name = &quot;-overwrite&quot;, required = false, usage = &quot;Overwrite existing output directory.&quot;)
  private boolean _overwrite = false;

<span class="nc" id="L57">  @Option(name = &quot;-help&quot;, required = false, help = true, aliases = {&quot;-h&quot;}, usage = &quot;print this message&quot;)</span>
  private boolean _help = false;

  /**
   * Convert the specified set of columnar segments into star tree segments.
   * @throws Exception
   */
  public void convert()
      throws Exception {
<span class="nc" id="L66">    File inputDir = new File(_inputDirName);</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">    if (!inputDir.exists()) {</span>
<span class="nc" id="L69">      System.out.println(&quot;Error: Input directory &quot; + _inputDirName + &quot; does not exist.&quot;);</span>
<span class="nc" id="L70">      return;</span>
    }

<span class="nc" id="L73">    File outputDir = new File(_outputDirName);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">    if (!outputDir.exists()) {</span>
<span class="nc" id="L75">      System.out.println(&quot;Error: Output directory &quot; + _outputDirName + &quot; does not exist&quot;);</span>
<span class="nc" id="L76">      return;</span>
    }

<span class="nc" id="L79">    File[] files = inputDir.listFiles();</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">    if (files == null || files.length == 0) {</span>
<span class="nc" id="L81">      System.out.println(&quot;Error: Input directory &quot; + _inputDirName + &quot; is empty&quot;);</span>
<span class="nc" id="L82">      return;</span>
    }

<span class="nc bnc" id="L85" title="All 2 branches missed.">    for (File file : files) {</span>
<span class="nc" id="L86">      String fileName = file.getName();</span>

      File segment;
<span class="nc" id="L89">      boolean cleanupTempFile = false;</span>

<span class="nc bnc" id="L91" title="All 4 branches missed.">      if (fileName.endsWith(&quot;tar.gz&quot;) || fileName.endsWith(&quot;tgz&quot;)) {</span>
<span class="nc" id="L92">        File untarredSegment = new File(outputDir, TMP_DIR_PREFIX + System.currentTimeMillis());</span>
<span class="nc" id="L93">        segment = TarGzCompressionUtils.unTar(file, untarredSegment).get(0);</span>
<span class="nc" id="L94">        cleanupTempFile = true;</span>
<span class="nc" id="L95">      } else {</span>
<span class="nc" id="L96">        segment = file;</span>
      }

<span class="nc" id="L99">      convertSegment(segment);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">      if (cleanupTempFile) {</span>
<span class="nc" id="L101">        FileUtils.deleteQuietly(segment.getParentFile());</span>
      }
    }
<span class="nc" id="L104">  }</span>

  /**
   * Helper method to perform the conversion.
   * @param columnarSegment Columnar segment directory to convert
   * @throws Exception
   */
  private void convertSegment(File columnarSegment)
      throws Exception {
<span class="nc" id="L113">    PinotSegmentRecordReader pinotSegmentRecordReader = new PinotSegmentRecordReader(columnarSegment);</span>
<span class="nc" id="L114">    SegmentGeneratorConfig config = new SegmentGeneratorConfig(pinotSegmentRecordReader.getSchema());</span>

<span class="nc" id="L116">    config.setDataDir(_inputDirName);</span>
<span class="nc" id="L117">    config.setInputFilePath(columnarSegment.getAbsolutePath());</span>
<span class="nc" id="L118">    config.setFormat(FileFormat.PINOT);</span>
<span class="nc" id="L119">    config.setOutDir(_outputDirName);</span>
<span class="nc" id="L120">    config.setOverwrite(_overwrite);</span>

<span class="nc" id="L122">    StarTreeIndexSpec starTreeIndexSpec = null;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (_starTreeConfigFileName != null) {</span>
<span class="nc" id="L124">       starTreeIndexSpec = StarTreeIndexSpec.fromFile(new File(_starTreeConfigFileName));</span>
    }
<span class="nc" id="L126">    config.enableStarTreeIndex(starTreeIndexSpec);</span>

    // Read the segment and table name from the segment's metadata.
<span class="nc" id="L129">    SegmentMetadata metadata = new SegmentMetadataImpl(columnarSegment);</span>
<span class="nc" id="L130">    SegmentNameGenerator nameGenerator = new DefaultSegmentNameGenerator(metadata.getName());</span>
<span class="nc" id="L131">    config.setSegmentNameGenerator(nameGenerator);</span>
<span class="nc" id="L132">    config.setTableName(metadata.getTableName());</span>

<span class="nc" id="L134">    SegmentIndexCreationDriver indexCreator = new SegmentIndexCreationDriverImpl();</span>
<span class="nc" id="L135">    indexCreator.init(config);</span>
<span class="nc" id="L136">    indexCreator.build();</span>
<span class="nc" id="L137">  }</span>

  /**
   * Helper method to print usage at the command line interface.
   */
  private static void printUsage() {
<span class="nc" id="L143">    System.out.println(&quot;Usage: ColumnarToStarTreeConverter&quot;);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">    for (Field field : ColumnarToStarTreeConverter.class.getDeclaredFields()) {</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">      if (field.isAnnotationPresent(Option.class)) {</span>
<span class="nc" id="L147">        Option option = field.getAnnotation(Option.class);</span>

<span class="nc" id="L149">        System.out.println(</span>
            String.format(&quot;\t%-15s: %s (required=%s)&quot;, option.name(), option.usage(), option.required()));
      }
    }
<span class="nc" id="L153">  }</span>

  /**
   * Main driver for the converter class.
   *
   * @param args Command line arguments
   * @throws Exception
   */
  public static void main(String[] args)
      throws Exception {
<span class="nc" id="L163">    ColumnarToStarTreeConverter converter = new ColumnarToStarTreeConverter();</span>
<span class="nc" id="L164">    CmdLineParser parser = new CmdLineParser(converter);</span>
<span class="nc" id="L165">    parser.parseArgument(args);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">    if (converter._help) {</span>
<span class="nc" id="L168">      printUsage();</span>
<span class="nc" id="L169">      return;</span>
    }

<span class="nc" id="L172">    converter.convert();</span>
<span class="nc" id="L173">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>