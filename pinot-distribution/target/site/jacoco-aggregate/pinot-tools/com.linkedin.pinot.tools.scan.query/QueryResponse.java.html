<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>QueryResponse.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-distribution</a> &gt; <a href="../index.html" class="el_bundle">pinot-tools</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.tools.scan.query</a> &gt; <span class="el_source">QueryResponse.java</span></div><h1>QueryResponse.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.tools.scan.query;

import com.linkedin.pinot.core.query.utils.Pair;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import org.codehaus.jackson.annotate.JsonProperty;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.map.annotate.JsonSerialize;


public class QueryResponse {
<span class="nc" id="L28">  private int _numDocsScanned = 0;</span>
<span class="nc" id="L29">  private int _totalDocs = 0;</span>
<span class="nc" id="L30">  private long _timeUsedMs = 0;</span>

  SelectionResults _selectionResults;
  List&lt;AggregationResult&gt; _aggregationResults;

<span class="nc" id="L35">  QueryResponse(ResultTable resultTable) {</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">    if (resultTable == null) {</span>
<span class="nc" id="L37">      return;</span>
    }

<span class="nc" id="L40">    _numDocsScanned = resultTable.getNumDocsScanned();</span>
<span class="nc" id="L41">    _totalDocs = resultTable.getTotalDocs();</span>
<span class="nc" id="L42">    _timeUsedMs = resultTable.getProcessingTime();</span>

<span class="nc bnc" id="L44" title="All 4 branches missed.">    switch (resultTable.getResultType()) {</span>
      case Selection:
<span class="nc" id="L46">        buildSelectionResult(resultTable);</span>
<span class="nc" id="L47">        break;</span>

      case Aggregation:
<span class="nc" id="L50">        buildAggregationResult(resultTable);</span>
<span class="nc" id="L51">        break;</span>

      case AggregationGroupBy:
<span class="nc" id="L54">        buildAggregationGroupByResult(resultTable);</span>
<span class="nc" id="L55">        break;</span>

      default:
        // Nothing to do here.
    }
<span class="nc" id="L60">  }</span>

  private void buildSelectionResult(ResultTable resultTable) {
<span class="nc" id="L63">    List&lt;List&lt;String&gt;&gt; results = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L64">    List&lt;String&gt; columns = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L66" title="All 2 branches missed.">    for (Pair&lt;String, String&gt; pair : resultTable.getColumnList()) {</span>
<span class="nc" id="L67">      columns.add(pair.getFirst());</span>
<span class="nc" id="L68">    }</span>


<span class="nc bnc" id="L71" title="All 2 branches missed.">    for (ResultTable.Row row : resultTable) {</span>
<span class="nc" id="L72">      List&lt;String&gt; columnValues = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">      for (Object value : row) {</span>
<span class="nc" id="L74">        columnValues.add(value.toString());</span>
<span class="nc" id="L75">      }</span>
<span class="nc" id="L76">      results.add(columnValues);</span>
<span class="nc" id="L77">    }</span>

<span class="nc" id="L79">    _selectionResults = new SelectionResults(columns, results);</span>
<span class="nc" id="L80">  }</span>

  private void buildAggregationResult(ResultTable resultTable) {
<span class="nc" id="L83">    _aggregationResults = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">    for (ResultTable.Row row : resultTable) {</span>
<span class="nc" id="L85">      int columnId = 0;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">      for (Object value : row) {</span>
<span class="nc" id="L87">        AggregationResult aggregationResult =</span>
            new AggregationResult(resultTable.getFunction(columnId), value.toString());
<span class="nc" id="L89">        _aggregationResults.add(aggregationResult);</span>
<span class="nc" id="L90">        ++columnId;</span>
<span class="nc" id="L91">      }</span>
<span class="nc" id="L92">    }</span>
<span class="nc" id="L93">  }</span>


  private void buildAggregationGroupByResult(ResultTable resultTable) {
<span class="nc" id="L97">    List&lt;Pair&gt; columnList = resultTable.getColumnList();</span>
<span class="nc" id="L98">    List&lt;String&gt; groupByColumns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L99">    _aggregationResults = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">    for (Pair pair : columnList) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">      if (pair.getSecond() == null) {</span>
<span class="nc" id="L103">        groupByColumns.add(pair.getFirst().toString());</span>
      }
<span class="nc" id="L105">    }</span>

<span class="nc" id="L107">    int numGroupByColumns = groupByColumns.size();</span>
<span class="nc" id="L108">    List&lt;List&lt;String&gt;&gt; groupValueStrings = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">    for (ResultTable.Row row : resultTable) {</span>
<span class="nc" id="L111">      int colId = 0;</span>
<span class="nc" id="L112">      List&lt;String&gt; group = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">      for (Object value : row) {</span>
        // All group by columns come first.
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (columnList.get(colId).getSecond() != null) {</span>
<span class="nc" id="L117">          break;</span>
        }
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (value instanceof  Object []) {</span>
<span class="nc" id="L120">          Object[] array = (Object[]) value;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">          for (Object obj : array) {</span>
<span class="nc" id="L122">            group.add(obj.toString());</span>
          }
<span class="nc" id="L124">        } else {</span>
<span class="nc" id="L125">          group.add(value.toString());</span>
        }
<span class="nc" id="L127">        ++colId;</span>
<span class="nc" id="L128">      }</span>
<span class="nc" id="L129">      groupValueStrings.add(group);</span>
<span class="nc" id="L130">    }</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">    for (int colId = numGroupByColumns; colId &lt; columnList.size(); ++colId) {</span>
<span class="nc" id="L133">      String function = resultTable.getFunction(colId);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">      if (function.equalsIgnoreCase(&quot;count_*&quot;)) {</span>
<span class="nc" id="L135">        function = &quot;count_star&quot;;</span>
      }

<span class="nc" id="L138">      int rowId = 0;</span>
<span class="nc" id="L139">      List&lt;GroupValue&gt; groupValues = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">      for (ResultTable.Row row : resultTable) {</span>
<span class="nc" id="L141">        String value = row.get(colId).toString();</span>
<span class="nc" id="L142">        GroupValue groupValue = new GroupValue(value, groupValueStrings.get(rowId));</span>
<span class="nc" id="L143">        groupValues.add(groupValue);</span>
<span class="nc" id="L144">        ++rowId;</span>
<span class="nc" id="L145">      }</span>

<span class="nc" id="L147">      AggregationResult aggregationResult = new AggregationResult(groupValues, groupByColumns, function);</span>
<span class="nc" id="L148">      _aggregationResults.add(aggregationResult);</span>
    }
<span class="nc" id="L150">  }</span>

  public int getNumDocsScanned() {
<span class="nc" id="L153">    return _numDocsScanned;</span>
  }

  public int getTotalDocs() {
<span class="nc" id="L157">    return _totalDocs;</span>
  }

  public long getTimeUsedMs() {
<span class="nc" id="L161">    return _timeUsedMs;</span>
  }

  @JsonProperty(&quot;selectionResults&quot;)
  @JsonSerialize(include= JsonSerialize.Inclusion.NON_NULL)
  SelectionResults getSelectionResults() {
<span class="nc" id="L167">    return _selectionResults;</span>
  }

  @JsonProperty(&quot;aggregationResults&quot;)
  @JsonSerialize(include= JsonSerialize.Inclusion.NON_NULL)
  List&lt;AggregationResult&gt; getAggregationResults() {
<span class="nc" id="L173">    return _aggregationResults;</span>
  }

  class SelectionResults {
    private final List&lt;String&gt; _columnList;
    private final List&lt;List&lt;String&gt;&gt; _results;

<span class="nc" id="L180">    SelectionResults(List&lt;String&gt; columnList, List&lt;List&lt;String&gt;&gt; results) {</span>
<span class="nc" id="L181">      _columnList = columnList;</span>
<span class="nc" id="L182">      _results = results;</span>
<span class="nc" id="L183">    }</span>

    @JsonProperty(&quot;columns&quot;)
    public List&lt;String&gt; getColumnList() {
<span class="nc" id="L187">      return _columnList;</span>
    }

    @JsonProperty(&quot;results&quot;)
    public List&lt;List&lt;String&gt;&gt; getResults() {
<span class="nc" id="L192">      return _results;</span>
    }
  }

  class AggregationResult {
    private String _value;
    private String _function;
    List&lt;GroupValue&gt; _groupValues;
    List&lt;String&gt; _groupByColumns;

<span class="nc" id="L202">    AggregationResult(String function, String value) {</span>
<span class="nc" id="L203">      _function = function;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">      if (_function.equalsIgnoreCase(&quot;count_*&quot;)) {</span>
<span class="nc" id="L205">        _function = &quot;count_star&quot;;</span>
      }
<span class="nc" id="L207">      _value = value;</span>
<span class="nc" id="L208">      _groupValues = null;</span>
<span class="nc" id="L209">    }</span>

<span class="nc" id="L211">    public AggregationResult(List&lt;GroupValue&gt; group, List&lt;String&gt; groupByColumns, String function) {</span>
<span class="nc" id="L212">      _groupValues = group;</span>
<span class="nc" id="L213">      _groupByColumns = groupByColumns;</span>
<span class="nc" id="L214">      _function = function;</span>
<span class="nc" id="L215">      _value = null;</span>
<span class="nc" id="L216">    }</span>

    @JsonProperty(&quot;function&quot;)
    @JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)
    public String getFunction() {
<span class="nc" id="L221">      return _function;</span>
    }

    @JsonProperty(&quot;value&quot;)
    @JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)
    public String getValue() {
<span class="nc" id="L227">      return _value;</span>
    }

    @JsonProperty(&quot;groupByResult&quot;)
    @JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)
    public List&lt;GroupValue&gt; getGroupValues() {
<span class="nc" id="L233">      return _groupValues;</span>
    }

    @JsonProperty(&quot;groupByColumns&quot;)
    public List&lt;String&gt; getGroupByColumns() {
<span class="nc" id="L238">      return _groupByColumns;</span>
    }
  }

  class GroupValue {
    private final String _value;
    private final List&lt;String&gt; _group;

<span class="nc" id="L246">    GroupValue(String value, List&lt;String&gt; group) {</span>
<span class="nc" id="L247">      _value = value;</span>
<span class="nc" id="L248">      _group = group;</span>
<span class="nc" id="L249">    }</span>

    @JsonProperty(&quot;value&quot;)
    public String getValue() {
<span class="nc" id="L253">      return _value;</span>
    }

    @JsonProperty(&quot;group&quot;)
    public List&lt;String&gt; getGroup() {
<span class="nc" id="L258">      return _group;</span>
    }
  }

  @Override
  public String toString() {
    try {
<span class="nc" id="L265">      return new ObjectMapper().writeValueAsString(this);</span>
<span class="nc" id="L266">    } catch (IOException e) {</span>
<span class="nc" id="L267">      return null;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>