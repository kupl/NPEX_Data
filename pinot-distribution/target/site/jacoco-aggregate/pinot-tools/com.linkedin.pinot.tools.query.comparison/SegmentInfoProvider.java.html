<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SegmentInfoProvider.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-distribution</a> &gt; <a href="../index.html" class="el_bundle">pinot-tools</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.tools.query.comparison</a> &gt; <span class="el_source">SegmentInfoProvider.java</span></div><h1>SegmentInfoProvider.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.tools.query.comparison;

import com.linkedin.pinot.common.data.DimensionFieldSpec;
import com.linkedin.pinot.common.data.Schema;
import com.linkedin.pinot.common.segment.ReadMode;
import com.linkedin.pinot.common.utils.TarGzCompressionUtils;
import com.linkedin.pinot.core.indexsegment.IndexSegment;
import com.linkedin.pinot.core.segment.index.loader.Loaders;
import com.linkedin.pinot.core.segment.index.readers.Dictionary;
import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import org.apache.commons.io.FileUtils;


/**
 * Given a segments directory, pick all segments and read the dictionaries for all single-value dimension columns.
 * Here we will treat time column (if exists) as a single-value dimension column.
 */
public class SegmentInfoProvider {
<span class="nc" id="L40">  private static final String TMP_DIR = System.getProperty(&quot;java.io.tmpdir&quot;);</span>
  private static final String SEGMENT_INFO_PROVIDER = &quot;segmentInfoProvider&quot;;

  private final List&lt;String&gt; _singleValueDimensionColumns;
  private final List&lt;String&gt; _metricColumns;
  private final Map&lt;String, List&lt;Object&gt;&gt; _singleValueDimensionValuesMap;

  /**
   * Assume that segments directory has at least one segment.
   * - Gets all single-value dimension/metric columns from the directory.
   * - Reads dictionaries for all single-value dimension columns.
   *
   * @param segmentDirName Name of directory containing tarred/untarred segments.
   * @throws Exception
   */
  public SegmentInfoProvider(String segmentDirName)
<span class="nc" id="L56">      throws Exception {</span>
<span class="nc" id="L57">    Set&lt;String&gt; uniqueMetrics = new HashSet&lt;&gt;();</span>
<span class="nc" id="L58">    Set&lt;String&gt; uniqueSingleValueDimensions = new HashSet&lt;&gt;();</span>
<span class="nc" id="L59">    Map&lt;String, Set&lt;Object&gt;&gt; uniqueSingleValueDimensionValues = new HashMap&lt;&gt;();</span>

<span class="nc" id="L61">    File segmentsDir = new File(segmentDirName);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">    for (File segment : segmentsDir.listFiles()) {</span>
<span class="nc" id="L63">      readOneSegment(segment, uniqueMetrics, uniqueSingleValueDimensions, uniqueSingleValueDimensionValues);</span>
    }

<span class="nc" id="L66">    _singleValueDimensionColumns = new ArrayList&lt;&gt;(uniqueSingleValueDimensions);</span>
<span class="nc" id="L67">    _metricColumns = new ArrayList&lt;&gt;(uniqueMetrics);</span>
<span class="nc" id="L68">    _singleValueDimensionValuesMap = new HashMap&lt;&gt;(uniqueSingleValueDimensionValues.size());</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">    for (Map.Entry&lt;String, Set&lt;Object&gt;&gt; entry : uniqueSingleValueDimensionValues.entrySet()) {</span>
<span class="nc" id="L71">      _singleValueDimensionValuesMap.put(entry.getKey(), new ArrayList&lt;&gt;(entry.getValue()));</span>
<span class="nc" id="L72">    }</span>
<span class="nc" id="L73">  }</span>

  /**
   * Read the metadata of the given segmentFile and collect:
   * - Unique metric columns
   * - Unique single-value dimension columns
   * - Unique values for each single-value dimension columns
   *
   * @param segmentFile segment file.
   * @param uniqueMetrics unique metric columns buffer.
   * @param uniqueSingleValueDimensions unique single-value dimension columns buffer.
   * @param singleValueDimensionValuesMap single-value dimension columns to unique values map buffer.
   * @throws Exception
   */
  private void readOneSegment(File segmentFile, Set&lt;String&gt; uniqueMetrics, Set&lt;String&gt; uniqueSingleValueDimensions,
      Map&lt;String, Set&lt;Object&gt;&gt; singleValueDimensionValuesMap)
      throws Exception {
    // Get segment directory from segment file (decompress if necessary).
    File segmentDir;
<span class="nc" id="L92">    File tmpDir = null;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">    if (segmentFile.isFile()) {</span>
<span class="nc" id="L94">      tmpDir = File.createTempFile(SEGMENT_INFO_PROVIDER, null, new File(TMP_DIR));</span>
<span class="nc" id="L95">      FileUtils.deleteQuietly(tmpDir);</span>
<span class="nc" id="L96">      tmpDir.mkdir();</span>
<span class="nc" id="L97">      TarGzCompressionUtils.unTar(segmentFile, tmpDir);</span>
<span class="nc" id="L98">      segmentDir = tmpDir.listFiles()[0];</span>
    } else {
<span class="nc" id="L100">      segmentDir = segmentFile;</span>
    }

<span class="nc" id="L103">    IndexSegment indexSegment = Loaders.IndexSegment.load(segmentDir, ReadMode.heap);</span>
<span class="nc" id="L104">    Schema schema = indexSegment.getSegmentMetadata().getSchema();</span>

    // Add time column if exists.
<span class="nc" id="L107">    String timeColumn = schema.getTimeColumnName();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (timeColumn != null) {</span>
<span class="nc" id="L109">      uniqueSingleValueDimensions.add(timeColumn);</span>
<span class="nc" id="L110">      loadValuesForSingleValueDimension(indexSegment, singleValueDimensionValuesMap, timeColumn);</span>
    }

    // Add all metric columns.
<span class="nc" id="L114">    uniqueMetrics.addAll(schema.getMetricNames());</span>

    // Add all single-value dimension columns.
<span class="nc bnc" id="L117" title="All 2 branches missed.">    for (DimensionFieldSpec fieldSpec : schema.getDimensionFieldSpecs()) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">      if (!fieldSpec.isSingleValueField()) {</span>
<span class="nc" id="L119">        continue;</span>
      }
<span class="nc" id="L121">      String column = fieldSpec.getName();</span>
<span class="nc" id="L122">      uniqueSingleValueDimensions.add(column);</span>
<span class="nc" id="L123">      loadValuesForSingleValueDimension(indexSegment, singleValueDimensionValuesMap, column);</span>
<span class="nc" id="L124">    }</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (tmpDir != null) {</span>
<span class="nc" id="L127">      FileUtils.deleteQuietly(tmpDir);</span>
    }
<span class="nc" id="L129">  }</span>

  /**
   * Helper method to load values for a single-value dimension.
   *
   * @param indexSegment index segment.
   * @param singleValueDimensionValuesMap single-value dimension columns to unique values map buffer.
   * @param column single-value dimension name.
   */
  private void loadValuesForSingleValueDimension(IndexSegment indexSegment,
      Map&lt;String, Set&lt;Object&gt;&gt; singleValueDimensionValuesMap, String column) {
<span class="nc" id="L140">    Dictionary dictionary = indexSegment.getDataSource(column).getDictionary();</span>

<span class="nc" id="L142">    Set&lt;Object&gt; values = singleValueDimensionValuesMap.get(column);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">    if (values == null) {</span>
<span class="nc" id="L144">      values = new HashSet&lt;&gt;();</span>
<span class="nc" id="L145">      singleValueDimensionValuesMap.put(column, values);</span>
    }

<span class="nc" id="L148">    int length = dictionary.length();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">    for (int i = 0; i &lt; length; i++) {</span>
<span class="nc" id="L150">      values.add(dictionary.get(i));</span>
    }
<span class="nc" id="L152">  }</span>

  /**
   * Return the list of single-value dimension columns.
   *
   * @return single-value dimension columns.
   */
  public List&lt;String&gt; getSingleValueDimensionColumns() {
<span class="nc" id="L160">    return _singleValueDimensionColumns;</span>
  }

  /**
   * Return the list of metric columns
   *
   * @return metric columns.
   */
  public List&lt;String&gt; getMetricColumns() {
<span class="nc" id="L169">    return _metricColumns;</span>
  }

  /**
   * Return the map from single-value dimension names to values list for the column.
   *
   * @return map from single-value dimension names to values list for the column.
   */
  public Map&lt;String, List&lt;Object&gt;&gt; getSingleValueDimensionValuesMap() {
<span class="nc" id="L178">    return _singleValueDimensionValuesMap;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>