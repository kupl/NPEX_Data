<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SegmentZKMetadata.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-tools</a> &gt; <a href="../index.html" class="el_bundle">pinot-common</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.common.metadata.segment</a> &gt; <span class="el_source">SegmentZKMetadata.java</span></div><h1>SegmentZKMetadata.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.common.metadata.segment;

import com.linkedin.pinot.common.metadata.ZKMetadata;
import com.linkedin.pinot.common.utils.CommonConstants;
import com.linkedin.pinot.common.utils.CommonConstants.Segment.SegmentType;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import javax.annotation.Nonnull;
import org.apache.helix.ZNRecord;
import org.joda.time.Duration;
import org.joda.time.Interval;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import static com.linkedin.pinot.common.utils.EqualityUtils.*;


public abstract class SegmentZKMetadata implements ZKMetadata {
<span class="fc" id="L37">  private static final Logger LOGGER = LoggerFactory.getLogger(SegmentZKMetadata.class);</span>

  private static final String NULL = &quot;null&quot;;

  private String _segmentName;
  private String _tableName;
  private SegmentType _segmentType;
<span class="fc" id="L44">  private long _startTime = -1;</span>
<span class="fc" id="L45">  private long _endTime = -1;</span>
  private TimeUnit _timeUnit;
  private Duration _timeGranularity;
  private Interval _timeInterval;
  private String _indexVersion;
<span class="fc" id="L50">  private long _totalRawDocs = -1;</span>
<span class="fc" id="L51">  private long _crc = -1;</span>
<span class="fc" id="L52">  private long _creationTime = -1;</span>
  private SegmentPartitionMetadata _partitionMetadata;
<span class="fc" id="L54">  private long _segmentUploadStartTime = -1;</span>
  private Map&lt;String, String&gt; _customMap;

<span class="fc" id="L57">  public SegmentZKMetadata() {</span>
<span class="fc" id="L58">  }</span>

<span class="fc" id="L60">  public SegmentZKMetadata(ZNRecord znRecord) {</span>
<span class="fc" id="L61">    _segmentName = znRecord.getSimpleField(CommonConstants.Segment.SEGMENT_NAME);</span>
<span class="fc" id="L62">    _tableName = znRecord.getSimpleField(CommonConstants.Segment.TABLE_NAME);</span>
<span class="fc" id="L63">    _segmentType = znRecord.getEnumField(CommonConstants.Segment.SEGMENT_TYPE, SegmentType.class, SegmentType.OFFLINE);</span>
<span class="fc" id="L64">    _startTime = znRecord.getLongField(CommonConstants.Segment.START_TIME, -1);</span>
<span class="fc" id="L65">    _endTime = znRecord.getLongField(CommonConstants.Segment.END_TIME, -1);</span>
<span class="pc bpc" id="L66" title="1 of 4 branches missed.">    if (znRecord.getSimpleFields().containsKey(CommonConstants.Segment.TIME_UNIT) &amp;&amp; !znRecord.getSimpleField(</span>
        CommonConstants.Segment.TIME_UNIT).equals(NULL)) {
<span class="fc" id="L68">      setTimeUnit(znRecord.getEnumField(CommonConstants.Segment.TIME_UNIT, TimeUnit.class, TimeUnit.DAYS));</span>
    }
<span class="fc" id="L70">    _indexVersion = znRecord.getSimpleField(CommonConstants.Segment.INDEX_VERSION);</span>
<span class="fc" id="L71">    _totalRawDocs = znRecord.getLongField(CommonConstants.Segment.TOTAL_DOCS, -1);</span>
<span class="fc" id="L72">    _crc = znRecord.getLongField(CommonConstants.Segment.CRC, -1);</span>
<span class="fc" id="L73">    _creationTime = znRecord.getLongField(CommonConstants.Segment.CREATION_TIME, -1);</span>

    try {
<span class="fc" id="L76">      String partitionMetadataJson = znRecord.getSimpleField(CommonConstants.Segment.PARTITION_METADATA);</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">      if (partitionMetadataJson != null) {</span>
<span class="fc" id="L78">        _partitionMetadata = SegmentPartitionMetadata.fromJsonString(partitionMetadataJson);</span>
      }
<span class="nc" id="L80">    } catch (IOException e) {</span>
<span class="nc" id="L81">      LOGGER.error(</span>
          &quot;Exception caught while reading partition info from zk metadata for segment '{}', partition info dropped.&quot;,
          _segmentName, e);
<span class="fc" id="L84">    }</span>
<span class="fc" id="L85">    _segmentUploadStartTime = znRecord.getLongField(CommonConstants.Segment.SEGMENT_UPLOAD_START_TIME, -1);</span>
<span class="fc" id="L86">    _customMap = znRecord.getMapField(CommonConstants.Segment.CUSTOM_MAP);</span>
<span class="fc" id="L87">  }</span>

  public String getSegmentName() {
<span class="fc" id="L90">    return _segmentName;</span>
  }

  public void setSegmentName(String segmentName) {
<span class="fc" id="L94">    _segmentName = segmentName;</span>
<span class="fc" id="L95">  }</span>

  public String getTableName() {
<span class="fc" id="L98">    return _tableName;</span>
  }

  public void setTableName(String tableName) {
<span class="fc" id="L102">    _tableName = tableName;</span>
<span class="fc" id="L103">  }</span>

  public long getStartTime() {
<span class="fc" id="L106">    return _startTime;</span>
  }

  public void setStartTime(long startTime) {
<span class="fc" id="L110">    _startTime = startTime;</span>
<span class="fc" id="L111">  }</span>

  public long getEndTime() {
<span class="fc" id="L114">    return _endTime;</span>
  }

  public void setEndTime(long endTime) {
<span class="fc" id="L118">    _endTime = endTime;</span>
<span class="fc" id="L119">  }</span>

  public TimeUnit getTimeUnit() {
<span class="fc" id="L122">    return _timeUnit;</span>
  }

  /**
   * NOTE: should be called after setting start and end time.
   */
  public void setTimeUnit(@Nonnull TimeUnit timeUnit) {
<span class="fc" id="L129">    _timeUnit = timeUnit;</span>
<span class="fc" id="L130">    _timeGranularity = new Duration(_timeUnit.toMillis(1));</span>
    // For consuming segment, end time might not be set
<span class="fc bfc" id="L132" title="All 4 branches covered.">    if (_startTime &gt;= 0 &amp;&amp; _startTime &lt;= _endTime) {</span>
<span class="fc" id="L133">      _timeInterval = new Interval(_timeUnit.toMillis(_startTime), _timeUnit.toMillis(_endTime));</span>
    }
<span class="fc" id="L135">  }</span>

  public Duration getTimeGranularity() {
<span class="nc" id="L138">    return _timeGranularity;</span>
  }

  public Interval getTimeInterval() {
<span class="nc" id="L142">    return _timeInterval;</span>
  }

  public String getIndexVersion() {
<span class="fc" id="L146">    return _indexVersion;</span>
  }

  public void setIndexVersion(String indexVersion) {
<span class="fc" id="L150">    _indexVersion = indexVersion;</span>
<span class="fc" id="L151">  }</span>

  public SegmentType getSegmentType() {
<span class="nc" id="L154">    return _segmentType;</span>
  }

  public void setSegmentType(SegmentType segmentType) {
<span class="fc" id="L158">    _segmentType = segmentType;</span>
<span class="fc" id="L159">  }</span>

  public long getTotalRawDocs() {
<span class="fc" id="L162">    return _totalRawDocs;</span>
  }

  public void setTotalRawDocs(long totalRawDocs) {
<span class="fc" id="L166">    _totalRawDocs = totalRawDocs;</span>
<span class="fc" id="L167">  }</span>

  public long getCrc() {
<span class="fc" id="L170">    return _crc;</span>
  }

  public void setCrc(long crc) {
<span class="fc" id="L174">    _crc = crc;</span>
<span class="fc" id="L175">  }</span>

  public long getCreationTime() {
<span class="fc" id="L178">    return _creationTime;</span>
  }

  public void setCreationTime(long creationTime) {
<span class="fc" id="L182">    _creationTime = creationTime;</span>
<span class="fc" id="L183">  }</span>

  public void setPartitionMetadata(SegmentPartitionMetadata partitionMetadata) {
<span class="fc" id="L186">    _partitionMetadata = partitionMetadata;</span>
<span class="fc" id="L187">  }</span>

  public SegmentPartitionMetadata getPartitionMetadata() {
<span class="fc" id="L190">    return _partitionMetadata;</span>
  }

  public long getSegmentUploadStartTime() {
<span class="nc" id="L194">    return _segmentUploadStartTime;</span>
  }

  public void setSegmentUploadStartTime(long segmentUploadStartTime) {
<span class="nc" id="L198">    _segmentUploadStartTime = segmentUploadStartTime;</span>
<span class="nc" id="L199">  }</span>

  public Map&lt;String, String&gt; getCustomMap() {
<span class="nc" id="L202">    return _customMap;</span>
  }

  public void setCustomMap(Map&lt;String, String&gt; customMap) {
<span class="nc" id="L206">    _customMap = customMap;</span>
<span class="nc" id="L207">  }</span>

  @Override
  public boolean equals(Object segmentMetadata) {
<span class="fc bfc" id="L211" title="All 2 branches covered.">    if (isSameReference(this, segmentMetadata)) {</span>
<span class="fc" id="L212">      return true;</span>
    }

<span class="fc bfc" id="L215" title="All 2 branches covered.">    if (isNullOrNotSameClass(this, segmentMetadata)) {</span>
<span class="fc" id="L216">      return false;</span>
    }

<span class="fc" id="L219">    SegmentZKMetadata metadata = (SegmentZKMetadata) segmentMetadata;</span>
<span class="fc bfc" id="L220" title="All 26 branches covered.">    return isEqual(_segmentName, metadata._segmentName) &amp;&amp; isEqual(_tableName, metadata._tableName) &amp;&amp; isEqual(</span>
        _indexVersion, metadata._indexVersion) &amp;&amp; isEqual(_timeUnit, metadata._timeUnit) &amp;&amp; isEqual(_startTime,
        metadata._startTime) &amp;&amp; isEqual(_endTime, metadata._endTime) &amp;&amp; isEqual(_segmentType, metadata._segmentType)
        &amp;&amp; isEqual(_totalRawDocs, metadata._totalRawDocs) &amp;&amp; isEqual(_crc, metadata._crc) &amp;&amp; isEqual(_creationTime,
        metadata._creationTime) &amp;&amp; isEqual(_partitionMetadata, metadata._partitionMetadata) &amp;&amp; isEqual(
        _segmentUploadStartTime, metadata._segmentUploadStartTime) &amp;&amp; isEqual(_customMap, metadata._customMap);
  }

  @Override
  public int hashCode() {
<span class="fc" id="L230">    int result = hashCodeOf(_segmentName);</span>
<span class="fc" id="L231">    result = hashCodeOf(result, _tableName);</span>
<span class="fc" id="L232">    result = hashCodeOf(result, _segmentType);</span>
<span class="fc" id="L233">    result = hashCodeOf(result, _startTime);</span>
<span class="fc" id="L234">    result = hashCodeOf(result, _endTime);</span>
<span class="fc" id="L235">    result = hashCodeOf(result, _timeUnit);</span>
<span class="fc" id="L236">    result = hashCodeOf(result, _indexVersion);</span>
<span class="fc" id="L237">    result = hashCodeOf(result, _totalRawDocs);</span>
<span class="fc" id="L238">    result = hashCodeOf(result, _crc);</span>
<span class="fc" id="L239">    result = hashCodeOf(result, _creationTime);</span>
<span class="fc" id="L240">    result = hashCodeOf(result, _partitionMetadata);</span>
<span class="fc" id="L241">    result = hashCodeOf(result, _segmentUploadStartTime);</span>
<span class="fc" id="L242">    result = hashCodeOf(result, _customMap);</span>
<span class="fc" id="L243">    return result;</span>
  }

  @Override
  public ZNRecord toZNRecord() {
<span class="fc" id="L248">    ZNRecord znRecord = new ZNRecord(_segmentName);</span>
<span class="fc" id="L249">    znRecord.setSimpleField(CommonConstants.Segment.SEGMENT_NAME, _segmentName);</span>
<span class="fc" id="L250">    znRecord.setSimpleField(CommonConstants.Segment.TABLE_NAME, _tableName);</span>
<span class="fc" id="L251">    znRecord.setEnumField(CommonConstants.Segment.SEGMENT_TYPE, _segmentType);</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">    if (_timeUnit == null) {</span>
<span class="fc" id="L253">      znRecord.setSimpleField(CommonConstants.Segment.TIME_UNIT, NULL);</span>
    } else {
<span class="fc" id="L255">      znRecord.setEnumField(CommonConstants.Segment.TIME_UNIT, _timeUnit);</span>
    }
<span class="fc" id="L257">    znRecord.setLongField(CommonConstants.Segment.START_TIME, _startTime);</span>
<span class="fc" id="L258">    znRecord.setLongField(CommonConstants.Segment.END_TIME, _endTime);</span>

<span class="fc" id="L260">    znRecord.setSimpleField(CommonConstants.Segment.INDEX_VERSION, _indexVersion);</span>
<span class="fc" id="L261">    znRecord.setLongField(CommonConstants.Segment.TOTAL_DOCS, _totalRawDocs);</span>
<span class="fc" id="L262">    znRecord.setLongField(CommonConstants.Segment.CRC, _crc);</span>
<span class="fc" id="L263">    znRecord.setLongField(CommonConstants.Segment.CREATION_TIME, _creationTime);</span>

<span class="fc bfc" id="L265" title="All 2 branches covered.">    if (_partitionMetadata != null) {</span>
      try {
<span class="fc" id="L267">        String partitionMetadataJson = _partitionMetadata.toJsonString();</span>
<span class="fc" id="L268">        znRecord.setSimpleField(CommonConstants.Segment.PARTITION_METADATA, partitionMetadataJson);</span>
<span class="nc" id="L269">      } catch (IOException e) {</span>
<span class="nc" id="L270">        LOGGER.error(</span>
            &quot;Exception caught while writing partition metadata into ZNRecord for segment '{}', will be dropped&quot;,
            _segmentName, e);
<span class="fc" id="L273">      }</span>
    }
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">    if (_segmentUploadStartTime &gt; 0) {</span>
<span class="nc" id="L276">      znRecord.setLongField(CommonConstants.Segment.SEGMENT_UPLOAD_START_TIME, _segmentUploadStartTime);</span>
    }
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">    if (_customMap != null) {</span>
<span class="nc" id="L279">      znRecord.setMapField(CommonConstants.Segment.CUSTOM_MAP, _customMap);</span>
    }
<span class="fc" id="L281">    return znRecord;</span>
  }

  public Map&lt;String, String&gt; toMap() {
<span class="nc" id="L285">    Map&lt;String, String&gt; configMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L286">    configMap.put(CommonConstants.Segment.SEGMENT_NAME, _segmentName);</span>
<span class="nc" id="L287">    configMap.put(CommonConstants.Segment.TABLE_NAME, _tableName);</span>
<span class="nc" id="L288">    configMap.put(CommonConstants.Segment.SEGMENT_TYPE, _segmentType.toString());</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">    if (_timeUnit == null) {</span>
<span class="nc" id="L290">      configMap.put(CommonConstants.Segment.TIME_UNIT, null);</span>
    } else {
<span class="nc" id="L292">      configMap.put(CommonConstants.Segment.TIME_UNIT, _timeUnit.toString());</span>
    }
<span class="nc" id="L294">    configMap.put(CommonConstants.Segment.START_TIME, Long.toString(_startTime));</span>
<span class="nc" id="L295">    configMap.put(CommonConstants.Segment.END_TIME, Long.toString(_endTime));</span>

<span class="nc" id="L297">    configMap.put(CommonConstants.Segment.INDEX_VERSION, _indexVersion);</span>
<span class="nc" id="L298">    configMap.put(CommonConstants.Segment.TOTAL_DOCS, Long.toString(_totalRawDocs));</span>
<span class="nc" id="L299">    configMap.put(CommonConstants.Segment.CRC, Long.toString(_crc));</span>
<span class="nc" id="L300">    configMap.put(CommonConstants.Segment.CREATION_TIME, Long.toString(_creationTime));</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">    if (_partitionMetadata != null) {</span>
      try {
<span class="nc" id="L304">        String partitionMetadataJson = _partitionMetadata.toJsonString();</span>
<span class="nc" id="L305">        configMap.put(CommonConstants.Segment.PARTITION_METADATA, partitionMetadataJson);</span>
<span class="nc" id="L306">      } catch (IOException e) {</span>
<span class="nc" id="L307">        LOGGER.error(</span>
            &quot;Exception caught while converting partition metadata into JSON string for segment '{}', will be dropped&quot;,
            _segmentName, e);
<span class="nc" id="L310">      }</span>
    }

<span class="nc bnc" id="L313" title="All 2 branches missed.">    if (_segmentUploadStartTime &gt; 0) {</span>
<span class="nc" id="L314">      configMap.put(CommonConstants.Segment.SEGMENT_UPLOAD_START_TIME, Long.toString(_segmentUploadStartTime));</span>
    }

<span class="nc bnc" id="L317" title="All 2 branches missed.">    if (_customMap == null) {</span>
<span class="nc" id="L318">      configMap.put(CommonConstants.Segment.CUSTOM_MAP, null);</span>
    } else {
<span class="nc" id="L320">      JSONObject jsonObject = new JSONObject(_customMap);</span>
<span class="nc" id="L321">      configMap.put(CommonConstants.Segment.CUSTOM_MAP, jsonObject.toString());</span>
    }

<span class="nc" id="L324">    return configMap;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>