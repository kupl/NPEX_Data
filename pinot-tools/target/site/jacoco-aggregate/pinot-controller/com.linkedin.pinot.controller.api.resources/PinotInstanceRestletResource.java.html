<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PinotInstanceRestletResource.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-tools</a> &gt; <a href="../index.html" class="el_bundle">pinot-controller</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.controller.api.resources</a> &gt; <span class="el_source">PinotInstanceRestletResource.java</span></div><h1>PinotInstanceRestletResource.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.controller.api.resources;

import com.fasterxml.jackson.annotation.JsonProperty;
import com.linkedin.pinot.controller.api.pojos.Instance;
import com.linkedin.pinot.controller.helix.core.PinotHelixResourceManager;
import com.linkedin.pinot.controller.helix.core.PinotResourceManagerResponse;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;
import java.util.List;
import javax.inject.Inject;
import javax.ws.rs.Consumes;
import javax.ws.rs.DELETE;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import org.apache.helix.model.InstanceConfig;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


@Api(tags = Constants.INSTANCE_TAG)
@Path(&quot;/&quot;)
<span class="fc" id="L48">public class PinotInstanceRestletResource {</span>
<span class="fc" id="L49">  private static final Logger LOGGER = LoggerFactory.getLogger(</span>
      PinotInstanceRestletResource.class);
  @Inject
  PinotHelixResourceManager pinotHelixResourceManager;

<span class="fc" id="L54">  public static  class Instances</span>
  {
    List&lt;String&gt; instances;
<span class="fc" id="L57">    public Instances(@JsonProperty(&quot;instances&quot;) List&lt;String&gt; instances) {</span>
<span class="fc" id="L58">      this.instances = instances;</span>
<span class="fc" id="L59">    }</span>

    public List&lt;String&gt; getInstances() {
<span class="fc" id="L62">      return instances;</span>
    }

    public Instances setInstances(List&lt;String&gt; instances) {
<span class="nc" id="L66">      this.instances = instances;</span>
<span class="nc" id="L67">      return this;</span>
    }
  }

  @GET
  @Path(&quot;/instances&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;List all instances&quot;)
  @ApiResponses(value = {@ApiResponse(code=200, message = &quot;Success&quot;),
      @ApiResponse(code=500, message = &quot;Error reading instances&quot;)})
  public Instances getAllInstances(
  ) {
<span class="fc" id="L79">    return new Instances(pinotHelixResourceManager.getAllInstances());</span>
  }

  @GET
  @Path(&quot;/instances/{instanceName}&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Get instance information&quot;, produces = MediaType.APPLICATION_JSON)
  @ApiResponses(value = {@ApiResponse(code=200, message = &quot;Success&quot;),
      @ApiResponse(code = 404, message = &quot;Instance not found&quot;),
      @ApiResponse(code=500, message = &quot;Error reading instances&quot;)})
  public String getInstance(
      @ApiParam(value = &quot;Instance name&quot;, required = true,
          example = &quot;Server_a.b.com_20000 | Broker_my.broker.com_30000&quot;)
      @PathParam(&quot;instanceName&quot;) String instanceName)
  {

<span class="fc bfc" id="L95" title="All 2 branches covered.">    if (!pinotHelixResourceManager.instanceExists(instanceName)) {</span>
<span class="fc" id="L96">      throw new ControllerApplicationException(LOGGER, &quot;Instance &quot; + instanceName + &quot; does not exist&quot;,</span>
          javax.ws.rs.core.Response.Status.NOT_FOUND);
    }
<span class="fc" id="L99">    InstanceConfig instanceConfig = pinotHelixResourceManager.getHelixInstanceConfig(instanceName);</span>
<span class="fc" id="L100">    JSONObject response = new JSONObject();</span>
    try {
<span class="fc" id="L102">      response.put(&quot;instanceName&quot;, instanceConfig.getInstanceName());</span>
<span class="fc" id="L103">      response.put(&quot;hostName&quot;, instanceConfig.getHostName());</span>
<span class="fc" id="L104">      response.put(&quot;enabled&quot;, instanceConfig.getInstanceEnabled());</span>
<span class="fc" id="L105">      response.put(&quot;port&quot;, instanceConfig.getPort());</span>
<span class="fc" id="L106">      response.put(&quot;tags&quot;, new JSONArray(instanceConfig.getTags()));</span>
<span class="nc" id="L107">    } catch (JSONException e) {</span>
<span class="nc" id="L108">      throw new ControllerApplicationException(LOGGER, e.getMessage(), Response.Status.INTERNAL_SERVER_ERROR, e);</span>
<span class="fc" id="L109">    }</span>
<span class="fc" id="L110">    return response.toString();</span>
  }

  @POST
  @Path(&quot;/instances&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Create a new instance&quot;, consumes = MediaType.APPLICATION_JSON, notes = &quot;Creates a new instance with given instance config&quot;)
  @ApiResponses(value = {@ApiResponse(code = 200, message=&quot;Instance successfully created&quot;),
      @ApiResponse(code=409, message=&quot;Instance exists already&quot;),
      @ApiResponse(code = 500, message = &quot;Internal error&quot;)})
  public SuccessResponse addInstance(
      Instance instance
  ) {
<span class="fc" id="L124">    LOGGER.info(&quot;Instance creation request received for instance &quot; + instance.toInstanceId());</span>
<span class="fc" id="L125">    final PinotResourceManagerResponse resp = pinotHelixResourceManager.addInstance(instance);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (resp.status == PinotResourceManagerResponse.ResponseStatus.failure) {</span>
<span class="fc" id="L127">      throw new ControllerApplicationException(LOGGER, &quot;Instance already exists&quot;,</span>
          javax.ws.rs.core.Response.Status.CONFLICT);
    }
<span class="fc" id="L130">    return new SuccessResponse(&quot;Instance successfully created&quot;);</span>
  }

  // TODO: @consumes text/plain but swagger doc says json. Does that work. It's better this way if it works
  @POST
  @Path(&quot;/instances/{instanceName}/state&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @Consumes(MediaType.TEXT_PLAIN)
  @ApiOperation(value = &quot;Create a new instance&quot;, consumes = MediaType.APPLICATION_JSON, notes = &quot;Creates a new instance with given instance config&quot;)
  @ApiResponses(value = {@ApiResponse(code = 200, message=&quot;Instance successfully created&quot;),
      @ApiResponse(code=409, message=&quot;Instance exists already&quot;),
      @ApiResponse(code = 400, message=&quot;Bad Request&quot;),
      @ApiResponse(code = 500, message = &quot;Internal error&quot;)})
  public SuccessResponse addInstance(
      @ApiParam(value = &quot;Instance name&quot;, required = true,
          example = &quot;Server_a.b.com_20000 | Broker_my.broker.com_30000&quot;)
      @PathParam(&quot;instanceName&quot;) String instanceName,
      String state
  ) {
    // TODO: state should be moved to path or form parameter
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">    if (! pinotHelixResourceManager.instanceExists(instanceName)) {</span>
<span class="nc" id="L151">      throw new ControllerApplicationException(LOGGER, &quot;Instance &quot; + instanceName + &quot; does not exist&quot;,</span>
          Response.Status.NOT_FOUND);
    }
    PinotResourceManagerResponse response;
<span class="fc bfc" id="L155" title="All 2 branches covered.">    if (StateType.ENABLE.name().equalsIgnoreCase(state)) {</span>
<span class="fc" id="L156">      response = pinotHelixResourceManager.enableInstance(instanceName);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">    } else if (StateType.DISABLE.name().equalsIgnoreCase(state)) {</span>
<span class="fc" id="L158">      response = pinotHelixResourceManager.disableInstance(instanceName);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">    } else if (StateType.DROP.name().equalsIgnoreCase(state)) {</span>
<span class="nc" id="L160">      response = pinotHelixResourceManager.dropInstance(instanceName);</span>
    } else {
<span class="nc" id="L162">     throw new ControllerApplicationException(LOGGER, &quot;Unknown state &quot; + state + &quot; for instance request&quot;,</span>
         Response.Status.BAD_REQUEST);
    }
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    if (response.isSuccessful()) {</span>
<span class="fc" id="L166">      return new SuccessResponse(&quot;Request to &quot; + state + &quot; instance &quot; + instanceName  + &quot; is successful&quot;);</span>
    }
<span class="nc" id="L168">    throw new ControllerApplicationException(LOGGER, &quot;Failed to &quot; + state + &quot; instance &quot; + instanceName,</span>
        Response.Status.INTERNAL_SERVER_ERROR);
  }

  @DELETE
  @Path(&quot;/instances/{instanceName}&quot;)
  @Consumes(MediaType.TEXT_PLAIN)
  @Produces(MediaType.APPLICATION_JSON)
  @ApiOperation(value = &quot;Delete an instance&quot;, consumes = MediaType.APPLICATION_JSON,
      notes = &quot;Deletes an instance of given name&quot;)
  @ApiResponses(value = {@ApiResponse(code = 200, message=&quot;Instance successfully deleted&quot;),
      @ApiResponse(code = 404, message = &quot;Instance not found&quot;),
      @ApiResponse(code = 409, message = &quot;Forbidden operation typically because the instance is live or &quot;
          + &quot;idealstates still contain some information of this instance&quot;),
      @ApiResponse(code = 400, message = &quot;Bad Request&quot;),
      @ApiResponse(code = 500, message = &quot;Internal error&quot;)})
  public SuccessResponse deleteInstance(
      @ApiParam(value = &quot;Instance name&quot;, required = true,
          example = &quot;Server_a.b.com_20000 | Broker_my.broker.com_30000&quot;)
      @PathParam(&quot;instanceName&quot;) String instanceName
  ) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">    if (! pinotHelixResourceManager.instanceExists(instanceName)) {</span>
<span class="nc" id="L190">      throw new ControllerApplicationException(LOGGER, &quot;Instance &quot; + instanceName + &quot; does not exist&quot;,</span>
          Response.Status.NOT_FOUND);
    }
<span class="nc bnc" id="L193" title="All 2 branches missed.">    if (!pinotHelixResourceManager.isInstanceDroppable(instanceName)) {</span>
<span class="nc" id="L194">      throw new ControllerApplicationException(LOGGER, &quot;Instance &quot; + instanceName + &quot; is live or it still appears in the idealstate&quot;,</span>
          Response.Status.CONFLICT);
    }
<span class="nc" id="L197">    PinotResourceManagerResponse response = pinotHelixResourceManager.dropInstance(instanceName);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (!response.isSuccessful()) {</span>
<span class="nc" id="L199">      LOGGER.error(&quot;Failed to delete instance: {}, response: {}&quot;, instanceName, response.message);</span>
<span class="nc" id="L200">      throw new ControllerApplicationException(LOGGER, &quot;Failed to delete instance&quot;, Response.Status.INTERNAL_SERVER_ERROR);</span>
    }
<span class="nc" id="L202">    return new SuccessResponse(&quot;Successfully deleted instance&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>