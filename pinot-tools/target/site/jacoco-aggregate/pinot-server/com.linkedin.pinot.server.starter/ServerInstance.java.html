<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServerInstance.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-tools</a> &gt; <a href="../index.html" class="el_bundle">pinot-server</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.server.starter</a> &gt; <span class="el_source">ServerInstance.java</span></div><h1>ServerInstance.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.server.starter;

import com.linkedin.pinot.common.metrics.ServerMetrics;
import com.linkedin.pinot.common.query.QueryExecutor;
import com.linkedin.pinot.core.data.manager.offline.InstanceDataManager;
import com.linkedin.pinot.core.query.scheduler.QueryScheduler;
import com.linkedin.pinot.core.query.scheduler.QuerySchedulerFactory;
import com.linkedin.pinot.server.conf.ServerConf;
import com.linkedin.pinot.server.request.ScheduledRequestHandler;
import com.linkedin.pinot.transport.netty.NettyServer;
import com.linkedin.pinot.transport.netty.NettyServer.RequestHandlerFactory;
import javax.annotation.Nonnull;
import org.apache.commons.configuration.Configuration;
import org.apache.helix.ZNRecord;
import org.apache.helix.store.zk.ZkHelixPropertyStore;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


/**
 * A standalone server which will listen on a port and serve queries based on the given configuration. Cluster
 * management is maintained outside of this class.
 */
<span class="nc" id="L39">public class ServerInstance {</span>
<span class="fc" id="L40">  private static final Logger LOGGER = LoggerFactory.getLogger(ServerInstance.class);</span>

  private ServerConf _serverConf;
  private ServerMetrics _serverMetrics;
  private InstanceDataManager _instanceDataManager;
  private QueryExecutor _queryExecutor;
  private QueryScheduler _queryScheduler;
  private ScheduledRequestHandler _requestHandler;
  private NettyServer _nettyServer;

<span class="nc" id="L50">  private boolean _started = false;</span>

  public void init(@Nonnull ServerConf serverConf, @Nonnull ZkHelixPropertyStore&lt;ZNRecord&gt; propertyStore)
      throws Exception {
<span class="nc" id="L54">    LOGGER.info(&quot;Initializing server instance&quot;);</span>

<span class="nc" id="L56">    _serverConf = serverConf;</span>
<span class="nc" id="L57">    ServerBuilder serverBuilder = new ServerBuilder(_serverConf, propertyStore);</span>
<span class="nc" id="L58">    _serverMetrics = serverBuilder.getServerMetrics();</span>
<span class="nc" id="L59">    _instanceDataManager = serverBuilder.buildInstanceDataManager();</span>
<span class="nc" id="L60">    _queryExecutor = serverBuilder.buildQueryExecutor(_instanceDataManager);</span>
<span class="nc" id="L61">    _queryScheduler = serverBuilder.buildQueryScheduler(_queryExecutor);</span>
<span class="nc" id="L62">    _requestHandler = new ScheduledRequestHandler(_queryScheduler, _serverMetrics);</span>
<span class="nc" id="L63">    _nettyServer = serverBuilder.buildNettyServer(new RequestHandlerFactory() {</span>
      @Override
      public NettyServer.RequestHandler createNewRequestHandler() {
<span class="nc" id="L66">        return _requestHandler;</span>
      }
    });

<span class="nc" id="L70">    LOGGER.info(&quot;Finish initializing server instance&quot;);</span>
<span class="nc" id="L71">  }</span>

  public void start() {
<span class="nc" id="L74">    LOGGER.info(&quot;Starting server instance&quot;);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">    if (_started) {</span>
<span class="nc" id="L76">      LOGGER.info(&quot;Server instance is already started&quot;);</span>
<span class="nc" id="L77">      return;</span>
    }

<span class="nc" id="L80">    LOGGER.info(&quot;Starting instance data manager&quot;);</span>
<span class="nc" id="L81">    _instanceDataManager.start();</span>
<span class="nc" id="L82">    LOGGER.info(&quot;Starting query executor&quot;);</span>
<span class="nc" id="L83">    _queryExecutor.start();</span>
<span class="nc" id="L84">    LOGGER.info(&quot;Starting query scheduler&quot;);</span>
<span class="nc" id="L85">    _queryScheduler.start();</span>
<span class="nc" id="L86">    LOGGER.info(&quot;Starting netty server&quot;);</span>
<span class="nc" id="L87">    new Thread(_nettyServer).start();</span>

<span class="nc" id="L89">    _started = true;</span>
<span class="nc" id="L90">    LOGGER.info(&quot;Finish starting server instance&quot;);</span>
<span class="nc" id="L91">  }</span>

  public void shutDown() {
<span class="nc" id="L94">    LOGGER.info(&quot;Shutting down server instance&quot;);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">    if (!_started) {</span>
<span class="nc" id="L96">      LOGGER.info(&quot;Server instance is not running&quot;);</span>
<span class="nc" id="L97">      return;</span>
    }

<span class="nc" id="L100">    LOGGER.info(&quot;Shutting down netty server&quot;);</span>
<span class="nc" id="L101">    _nettyServer.shutdownGracefully();</span>
<span class="nc" id="L102">    LOGGER.info(&quot;Shutting down query scheduler&quot;);</span>
<span class="nc" id="L103">    _queryScheduler.stop();</span>
<span class="nc" id="L104">    LOGGER.info(&quot;Shutting down query executor&quot;);</span>
<span class="nc" id="L105">    _queryExecutor.shutDown();</span>
<span class="nc" id="L106">    LOGGER.info(&quot;Shutting down instance data manager&quot;);</span>
<span class="nc" id="L107">    _instanceDataManager.shutDown();</span>

<span class="nc" id="L109">    _started = false;</span>
<span class="nc" id="L110">    LOGGER.info(&quot;Finish shutting down server instance&quot;);</span>
<span class="nc" id="L111">  }</span>

  public ServerMetrics getServerMetrics() {
<span class="nc" id="L114">    return _serverMetrics;</span>
  }

  public InstanceDataManager getInstanceDataManager() {
<span class="nc" id="L118">    return _instanceDataManager;</span>
  }

  public void resetQueryScheduler(String schedulerName) {
<span class="nc" id="L122">    Configuration schedulerConfig = _serverConf.getSchedulerConfig();</span>
<span class="nc" id="L123">    schedulerConfig.setProperty(QuerySchedulerFactory.ALGORITHM_NAME_CONFIG_KEY, schedulerName);</span>
<span class="nc" id="L124">    _queryScheduler = QuerySchedulerFactory.create(schedulerConfig, _queryExecutor, _serverMetrics);</span>
<span class="nc" id="L125">    _queryScheduler.start();</span>
<span class="nc" id="L126">    _requestHandler.setScheduler(_queryScheduler);</span>
<span class="nc" id="L127">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>