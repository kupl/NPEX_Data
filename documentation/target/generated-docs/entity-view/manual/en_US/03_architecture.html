<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Architecture</title>
<link rel="stylesheet" href="css/blazebit.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="prettify/prettify.min.css">
<script src="prettify/prettify.min.js"></script>
<script src="prettify/lang-ext.js"></script>
<script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
<link rel="shortcut icon" href="images/favicon.png">
</head>
<body class="book toc2 toc-left">

<div class="brand">
    <a class="vendor" href="https://blazebit.com">
        <strong>Blazebit.com</strong>
    </a>
    <a class="logo" href="https://persistence.blazebit.com">
        <strong>blaze-persistence</strong>
    </a>
</div>
<br/>

<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#architecture">Architecture</a>
<ul class="sectlevel2">
<li><a href="#architecture-interfaces">Interfaces</a></li>
<li><a href="#architecture-core-integration">Core module integration</a></li>
<li><a href="#architecture-object-builder-pipeline">Object builder pipeline</a></li>
<li><a href="#architecture-updatable-entity-views">Updatable entity views</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is just a high level view for those that are interested about how {projectname} entity view works.</p>
</div>
<div class="sect2">
<h3 id="architecture-interfaces"><a class="anchor" href="#architecture-interfaces"></a>Interfaces</h3>
<div class="paragraph">
<p>A quick overview that presents the interfaces that are essential for users and how they are related.</p>
</div>
<div class="paragraph">
<p>Since entity views are mostly annotation driven and are about mapping attributes to entity attributes, there are not that many interfaces.
The two most important ones are the <code>EntityViewManager</code> and the <code>EntityViewSetting</code>.</p>
</div>
<div class="paragraph">
<p>A <code>EntityViewManager</code> is built once on startup during which it analyzes and validates the configured entity views.
It is responsible for building implementations for the interfaces and abstract classes from the metamodel and caching object builder instances for entity views.</p>
</div>
<div class="paragraph">
<p>The <code>EntityViewSetting</code> is a configuration that can be applied on a query builder through an <code>EntityViewManager</code> and contains information about</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The entity view</p>
</li>
<li>
<p>Pagination</p>
</li>
<li>
<p>Filters and sorters</p>
</li>
<li>
<p>Parameters and properties</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="architecture-core-integration"><a class="anchor" href="#architecture-core-integration"></a>Core module integration</h3>
<div class="paragraph">
<p>The entity view module builds on top of the <code>ObjectBuilder</code> integration point offered by query builders of the core module.
Every entity view is translated into a <code>ObjectBuilder</code> which is then applied on a query builder.</p>
</div>
</div>
<div class="sect2">
<h3 id="architecture-object-builder-pipeline"><a class="anchor" href="#architecture-object-builder-pipeline"></a>Object builder pipeline</h3>
<div class="paragraph">
<p>During startup the metamodel is built which is then used for building an object builder pipeline.
For every entity view interface/class a <code>ObjectBuilder</code> template called <code>ViewTypeObjectBuilderTemplate</code> is created which is cached.
From these templates a normal <code>ObjectBuilder</code> is built that can be applied on any query builder. Depending on the features a entity view uses,
the resulting object builder might actually be a object builder pipeline i.e. it invokes multiple object builders in an ordered manner on tuples.</p>
</div>
<div class="paragraph">
<p>In general, a object builder for an entity view just takes in the tuple and passes it to the constructor of the entity view implementation.
As soon as subviews or collections are involved, it becomes a pipeline. The pipeline has two different forms, the abstract form represented by <code>TupleTransformatorFactory</code> and the concrete form <code>TupleTransformator</code>.
When a object builder is created from a template, the concrete form is created from the abstract one which might involve building object builders for subviews.
Every collection introduces a new transformation level i.e. elements of a collection must be materialized before the collection can be materialized.</p>
</div>
<div class="paragraph">
<p>So the result is processed from the <em>leafs</em>(i.e. the elements) upwards(i.e. a collection) until objects of the target entity view type are materialized.</p>
</div>
</div>
<div class="sect2">
<h3 id="architecture-updatable-entity-views"><a class="anchor" href="#architecture-updatable-entity-views"></a>Updatable entity views</h3>
<div class="paragraph">
<p>Updatable entity views are still in flux and are not yet fully thought through, but here comes the essential idea.</p>
</div>
<div class="paragraph">
<p>Similar to the object builder pipeline, a <code>EntityViewUpdater</code> is composed of several possibly nested <em>attribute flushers</em>.
A <code>EntityViewUpdater</code> is built once and is responsible for <em>flushing</em> dirty attributes to the persistence context.
After flushing, attributes are considered to be non-dirty but they can become dirty again either through a change or a transaction rollback.</p>
</div>
<div class="paragraph">
<p>Dirty tracking is done either by remembering the initial state and comparing with changed state or not at all.
Collections are tracked by using custom collection implementations that do <em>action recording</em> which is then <em>replayed</em> onto a collection of an entity reference.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-08-04 13:32:35 KST
</div>
</div>
</body>
</html>