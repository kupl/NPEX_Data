<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AvroUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-controller</a> &gt; <a href="../index.html" class="el_bundle">pinot-core</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.core.util</a> &gt; <span class="el_source">AvroUtils.java</span></div><h1>AvroUtils.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.core.util;

import com.google.common.base.Preconditions;
import com.linkedin.pinot.common.data.DimensionFieldSpec;
import com.linkedin.pinot.common.data.FieldSpec;
import com.linkedin.pinot.common.data.MetricFieldSpec;
import com.linkedin.pinot.common.data.Schema;
import com.linkedin.pinot.common.data.TimeFieldSpec;
import com.linkedin.pinot.core.data.GenericRow;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.zip.GZIPInputStream;
import org.apache.avro.Schema.Field;
import org.apache.avro.file.DataFileStream;
import org.apache.avro.generic.GenericData;
import org.apache.avro.generic.GenericDatumReader;
import org.apache.avro.generic.GenericRecord;


public class AvroUtils {
<span class="nc" id="L42">  private AvroUtils() {</span>
<span class="nc" id="L43">  }</span>

  private static final String COUNT = &quot;count&quot;;
  private static final String METRIC = &quot;met&quot;;
  private static final String DAY = &quot;days&quot;;
  private static final String DAYS_SINCE_EPOCH = &quot;daysSinceEpoch&quot;;

  /**
   * gives back a basic pinot schema object with field type as unknown and not aware of whether SV or MV
   * this is just a util method for testing
   * @param avroFile
   * @return
   * @throws FileNotFoundException
   * @throws IOException
   */
  public static Schema extractSchemaFromAvro(File avroFile) throws IOException {
<span class="pc" id="L59">    try (DataFileStream&lt;GenericRecord&gt; dataStreamReader = getAvroReader(avroFile)) {</span>
<span class="fc" id="L60">      org.apache.avro.Schema avroSchema = dataStreamReader.getSchema();</span>
<span class="fc" id="L61">      return getPinotSchemaFromAvroSchema(avroSchema, getDefaultFieldTypes(avroSchema), TimeUnit.DAYS);</span>
<span class="pc bpc" id="L62" title="6 of 8 branches missed.">    }</span>
  }

  /**
   * This is just a refactor of the original code that had the hard-coded logic for deducing
   * if a column is dimension/metric/time. This is used only for testing purposes.
   *
   * @param avroSchema The input avro schema for which to deduce the dimension/metric/time columns.
   * @return Hash map containing column names as keys and field type (dim/metric/time) as value.
   */
  private static Map&lt;String, FieldSpec.FieldType&gt; getDefaultFieldTypes(org.apache.avro.Schema avroSchema) {
<span class="fc" id="L73">    Map&lt;String, FieldSpec.FieldType&gt; fieldTypes = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L75" title="All 2 branches covered.">    for (final Field field : avroSchema.getFields()) {</span>
      FieldSpec.FieldType fieldType;

<span class="pc bpc" id="L78" title="1 of 4 branches missed.">      if (field.name().contains(COUNT) || field.name().contains(METRIC)) {</span>
<span class="fc" id="L79">        fieldType = FieldSpec.FieldType.METRIC;</span>
<span class="pc bpc" id="L80" title="2 of 4 branches missed.">      } else if (field.name().contains(DAY) || field.name().equalsIgnoreCase(DAYS_SINCE_EPOCH)) {</span>
<span class="nc" id="L81">        fieldType = FieldSpec.FieldType.TIME;</span>
      } else {
<span class="fc" id="L83">        fieldType = FieldSpec.FieldType.DIMENSION;</span>
      }

<span class="fc" id="L86">      fieldTypes.put(field.name(), fieldType);</span>
<span class="fc" id="L87">    }</span>

<span class="fc" id="L89">    return fieldTypes;</span>
  }

  /**
   * Given an avro schema object along with column field types and time unit, return the equivalent
   * pinot schema object.
   *
   * @param avroSchema Avro schema for which to get the Pinot schema.
   * @param fieldTypes Map containing fieldTypes for each column.
   * @param timeUnit Time unit to be used for the time column.
   * @return Return the equivalent pinot schema for the given avro schema.
   */
  private static Schema getPinotSchemaFromAvroSchema(org.apache.avro.Schema avroSchema,
      Map&lt;String, FieldSpec.FieldType&gt; fieldTypes, TimeUnit timeUnit) {
<span class="fc" id="L103">    Schema pinotSchema = new Schema();</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">    for (Field field : avroSchema.getFields()) {</span>
<span class="fc" id="L106">      String fieldName = field.name();</span>
<span class="fc" id="L107">      FieldSpec.DataType dataType = extractFieldDataType(field);</span>
<span class="fc" id="L108">      boolean isSingleValueField = isSingleValueField(field);</span>

<span class="fc" id="L110">      FieldSpec.FieldType fieldType = fieldTypes.get(fieldName);</span>
<span class="pc bpc" id="L111" title="2 of 4 branches missed.">      switch (fieldType) {</span>
        case DIMENSION:
<span class="fc" id="L113">          pinotSchema.addField(new DimensionFieldSpec(fieldName, dataType, isSingleValueField));</span>
<span class="fc" id="L114">          break;</span>
        case METRIC:
<span class="fc" id="L116">          Preconditions.checkState(isSingleValueField, &quot;Unsupported multi-value for metric field.&quot;);</span>
<span class="fc" id="L117">          pinotSchema.addField(new MetricFieldSpec(fieldName, dataType));</span>
<span class="fc" id="L118">          break;</span>
        case TIME:
<span class="nc" id="L120">          Preconditions.checkState(isSingleValueField, &quot;Unsupported multi-value for time field.&quot;);</span>
<span class="nc" id="L121">          pinotSchema.addField(new TimeFieldSpec(field.name(), dataType, timeUnit));</span>
<span class="nc" id="L122">          break;</span>
        default:
<span class="nc" id="L124">          throw new UnsupportedOperationException(&quot;Unsupported field type: &quot; + fieldType + &quot; for field: &quot; + fieldName);</span>
      }
<span class="fc" id="L126">    }</span>

<span class="fc" id="L128">    return pinotSchema;</span>
  }

  /**
   * Given a avro schema file name, field types for columns and type unit, return the equivalent
   * pinot schema object.
   *
   * @param avroSchemaFileName Name of the text file containing avro schema.
   * @return PinotSchema equivalent of avro schema.
   */
  public static Schema getPinotSchemaFromAvroSchemaFile(String avroSchemaFileName,
      Map&lt;String, FieldSpec.FieldType&gt; fieldTypes, TimeUnit timeUnit) throws IOException {
<span class="nc" id="L140">    File avroSchemaFile = new File(avroSchemaFileName);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">    if (!avroSchemaFile.exists()) {</span>
<span class="nc" id="L142">      throw new FileNotFoundException();</span>
    }

<span class="nc" id="L145">    org.apache.avro.Schema avroSchema = new org.apache.avro.Schema.Parser().parse(avroSchemaFile);</span>
<span class="nc" id="L146">    return getPinotSchemaFromAvroSchema(avroSchema, fieldTypes, timeUnit);</span>
  }

  /**
   * Get the Avro file reader for the given file.
   */
  public static DataFileStream&lt;GenericRecord&gt; getAvroReader(File avroFile) throws IOException {
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">    if (avroFile.getName().endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L154">      return new DataFileStream&lt;&gt;(new GZIPInputStream(new FileInputStream(avroFile)),</span>
          new GenericDatumReader&lt;GenericRecord&gt;());
    } else {
<span class="fc" id="L157">      return new DataFileStream&lt;&gt;(new FileInputStream(avroFile), new GenericDatumReader&lt;GenericRecord&gt;());</span>
    }
  }

  /**
   * Return whether the Avro field is a single-value field.
   */
  public static boolean isSingleValueField(Field field) {
    try {
<span class="fc" id="L166">      org.apache.avro.Schema fieldSchema = extractSupportedSchema(field.schema());</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">      return fieldSchema.getType() != org.apache.avro.Schema.Type.ARRAY;</span>
<span class="nc" id="L168">    } catch (Exception e) {</span>
<span class="nc" id="L169">      throw new RuntimeException(&quot;Caught exception while extracting non-null schema from field: &quot; + field.name(), e);</span>
    }
  }

  /**
   * Extract the data type stored in Pinot for the given Avro field.
   */
  public static FieldSpec.DataType extractFieldDataType(Field field) {
    try {
<span class="fc" id="L178">      org.apache.avro.Schema fieldSchema = extractSupportedSchema(field.schema());</span>
<span class="fc" id="L179">      org.apache.avro.Schema.Type fieldType = fieldSchema.getType();</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">      if (fieldType == org.apache.avro.Schema.Type.ARRAY) {</span>
<span class="fc" id="L181">        return FieldSpec.DataType.valueOf(extractSupportedSchema(fieldSchema.getElementType()).getType());</span>
      } else {
<span class="fc" id="L183">        return FieldSpec.DataType.valueOf(fieldType);</span>
      }
<span class="nc" id="L185">    } catch (Exception e) {</span>
<span class="nc" id="L186">      throw new RuntimeException(&quot;Caught exception while extracting data type from field: &quot; + field.name(), e);</span>
    }
  }

  /**
   * Helper method to extract the supported Avro schema from the given Avro field schema.
   * &lt;p&gt;Currently we support INT/LONG/FLOAT/DOUBLE/BOOLEAN/STRING/ENUM
   */
  private static org.apache.avro.Schema extractSupportedSchema(org.apache.avro.Schema fieldSchema) {
<span class="fc" id="L195">    org.apache.avro.Schema.Type fieldType = fieldSchema.getType();</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">    if (fieldType == org.apache.avro.Schema.Type.UNION) {</span>
<span class="fc" id="L197">      org.apache.avro.Schema nonNullSchema = null;</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">      for (org.apache.avro.Schema childFieldSchema : fieldSchema.getTypes()) {</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (childFieldSchema.getType() != org.apache.avro.Schema.Type.NULL) {</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">          if (nonNullSchema == null) {</span>
<span class="fc" id="L201">            nonNullSchema = childFieldSchema;</span>
          } else {
<span class="nc" id="L203">            throw new IllegalStateException(&quot;More than one non-null schema in UNION schema&quot;);</span>
          }
        }
<span class="fc" id="L206">      }</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">      if (nonNullSchema != null) {</span>
<span class="fc" id="L208">        return extractSupportedSchema(nonNullSchema);</span>
      } else {
<span class="nc" id="L210">        throw new IllegalStateException(&quot;Cannot find non-null schema in UNION schema&quot;);</span>
      }
<span class="fc bfc" id="L212" title="All 2 branches covered.">    } else if (fieldType == org.apache.avro.Schema.Type.RECORD) {</span>
<span class="fc" id="L213">      List&lt;Field&gt; recordFields = fieldSchema.getFields();</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">      Preconditions.checkState(recordFields.size() == 1, &quot;Not one field in the RECORD schema&quot;);</span>
<span class="fc" id="L215">      return extractSupportedSchema(recordFields.get(0).schema());</span>
    } else {
<span class="fc" id="L217">      return fieldSchema;</span>
    }
  }

  /**
   * Fill the data in a {@link GenericRecord} to a {@link GenericRow}.
   */
  public static void fillGenericRow(GenericRecord from, GenericRow to, Schema schema) {
<span class="fc bfc" id="L225" title="All 2 branches covered.">    for (FieldSpec fieldSpec : schema.getAllFieldSpecs()) {</span>
<span class="fc" id="L226">      String fieldName = fieldSpec.getName();</span>
<span class="fc" id="L227">      Object avroValue = from.get(fieldName);</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">      if (fieldSpec.isSingleValueField()) {</span>
<span class="fc" id="L229">        to.putField(fieldName, transformAvroValueToObject(avroValue, fieldSpec));</span>
      } else {
<span class="fc" id="L231">        to.putField(fieldName, transformAvroArrayToObjectArray((GenericData.Array) avroValue, fieldSpec));</span>
      }
<span class="fc" id="L233">    }</span>
<span class="fc" id="L234">  }</span>

  /**
   * Transform a single-value Avro value into an object in Pinot format.
   */
  public static Object transformAvroValueToObject(Object avroValue, FieldSpec fieldSpec) {
<span class="fc bfc" id="L240" title="All 2 branches covered.">    if (avroValue == null) {</span>
<span class="fc" id="L241">      return fieldSpec.getDefaultNullValue();</span>
    }
<span class="fc bfc" id="L243" title="All 2 branches covered.">    if (avroValue instanceof GenericData.Record) {</span>
<span class="fc" id="L244">      return transformAvroValueToObject(((GenericData.Record) avroValue).get(0), fieldSpec);</span>
    }
<span class="fc bfc" id="L246" title="All 2 branches covered.">    if (fieldSpec.getDataType() == FieldSpec.DataType.STRING) {</span>
<span class="fc" id="L247">      return avroValue.toString();</span>
    }
<span class="fc" id="L249">    return avroValue;</span>
  }

  /**
   * Transform an Avro array into an object array in Pinot format.
   */
  public static Object[] transformAvroArrayToObjectArray(GenericData.Array avroArray, FieldSpec fieldSpec) {
<span class="pc bpc" id="L256" title="1 of 4 branches missed.">    if (avroArray == null || avroArray.size() == 0) {</span>
<span class="fc" id="L257">      return new Object[]{fieldSpec.getDefaultNullValue()};</span>
    }
<span class="fc" id="L259">    int numValues = avroArray.size();</span>
<span class="fc" id="L260">    Object[] objects = new Object[numValues];</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">    for (int i = 0; i &lt; numValues; i++) {</span>
<span class="fc" id="L262">      objects[i] = transformAvroValueToObject(avroArray.get(i), fieldSpec);</span>
    }
<span class="fc" id="L264">    return objects;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>