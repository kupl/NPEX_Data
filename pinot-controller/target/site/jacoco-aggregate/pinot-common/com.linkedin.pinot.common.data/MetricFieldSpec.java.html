<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MetricFieldSpec.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-controller</a> &gt; <a href="../index.html" class="el_bundle">pinot-common</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.common.data</a> &gt; <span class="el_source">MetricFieldSpec.java</span></div><h1>MetricFieldSpec.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.common.data;

import com.google.common.base.Preconditions;
import com.google.gson.JsonObject;
import com.linkedin.pinot.common.utils.EqualityUtils;
import javax.annotation.Nonnull;
import org.codehaus.jackson.annotate.JsonIgnore;
import org.codehaus.jackson.annotate.JsonIgnoreProperties;


/**
 * The &lt;code&gt;MetricFieldSpec&lt;/code&gt; class contains all specs related to any metric field (column) in {@link Schema}.
 * &lt;p&gt;Different with {@link DimensionFieldSpec}, inside &lt;code&gt;MetricFieldSpec&lt;/code&gt; we allow user defined
 * {@link DerivedMetricType} and &lt;code&gt;fieldSize&lt;/code&gt;.
 * &lt;p&gt;{@link DerivedMetricType} is used when the metric field is derived from some other fields (e.g. HLL).
 * &lt;p&gt;&lt;code&gt;fieldSize&lt;/code&gt; is used to mark the size of the value when the size is not constant (e.g. STRING).
 */
@SuppressWarnings(&quot;unused&quot;)
@JsonIgnoreProperties(ignoreUnknown = true)
public final class MetricFieldSpec extends FieldSpec {
  private static final int UNDEFINED_FIELD_SIZE = -1;

  // These two fields are for derived metric fields.
<span class="fc" id="L39">  private int _fieldSize = UNDEFINED_FIELD_SIZE;</span>
<span class="fc" id="L40">  private DerivedMetricType _derivedMetricType = null;</span>

  // Default constructor required by JSON de-serializer. DO NOT REMOVE.
  public MetricFieldSpec() {
<span class="fc" id="L44">    super();</span>
<span class="fc" id="L45">  }</span>

  public MetricFieldSpec(@Nonnull String name, @Nonnull DataType dataType) {
<span class="fc" id="L48">    super(name, dataType, true);</span>
<span class="fc" id="L49">    _fieldSize = _dataType.size();</span>
<span class="fc" id="L50">  }</span>

  public MetricFieldSpec(@Nonnull String name, @Nonnull DataType dataType, @Nonnull Object defaultNullValue) {
<span class="fc" id="L53">    super(name, dataType, true, defaultNullValue);</span>
<span class="fc" id="L54">    _fieldSize = _dataType.size();</span>
<span class="fc" id="L55">  }</span>

  // For derived metric fields.
  public MetricFieldSpec(@Nonnull String name, @Nonnull DataType dataType, int fieldSize,
      @Nonnull DerivedMetricType derivedMetricType) {
<span class="fc" id="L60">    super(name, dataType, true);</span>
<span class="fc" id="L61">    setFieldSize(fieldSize);</span>
<span class="fc" id="L62">    _derivedMetricType = derivedMetricType;</span>
<span class="fc" id="L63">  }</span>

  // For derived metric fields.
  public MetricFieldSpec(@Nonnull String name, @Nonnull DataType dataType, int fieldSize,
      @Nonnull DerivedMetricType derivedMetricType, @Nonnull Object defaultNullValue) {
<span class="fc" id="L68">    super(name, dataType, true, defaultNullValue);</span>
<span class="fc" id="L69">    setFieldSize(fieldSize);</span>
<span class="fc" id="L70">    _derivedMetricType = derivedMetricType;</span>
<span class="fc" id="L71">  }</span>

  public int getFieldSize() {
<span class="fc" id="L74">    return _fieldSize;</span>
  }

  // Required by JSON de-serializer. DO NOT REMOVE.
  public void setFieldSize(int fieldSize) {
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">    Preconditions.checkArgument(fieldSize &gt; 0, &quot;Field size: &quot; + fieldSize + &quot; is not a positive number.&quot;);</span>
<span class="pc bpc" id="L80" title="1 of 4 branches missed.">    if (_dataType != null &amp;&amp; _dataType != DataType.STRING) {</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">      Preconditions.checkArgument(fieldSize == _dataType.size(),</span>
          &quot;Field size: &quot; + fieldSize + &quot; does not match data type: &quot; + _dataType);
    }
<span class="fc" id="L84">    _fieldSize = fieldSize;</span>
<span class="fc" id="L85">  }</span>

  public DerivedMetricType getDerivedMetricType() {
<span class="fc" id="L88">    return _derivedMetricType;</span>
  }

  // Required by JSON de-serializer. DO NOT REMOVE.
  public void setDerivedMetricType(DerivedMetricType derivedMetricType) {
<span class="fc" id="L93">    _derivedMetricType = derivedMetricType;</span>
<span class="fc" id="L94">  }</span>

  @JsonIgnore
  @Nonnull
  @Override
  public FieldType getFieldType() {
<span class="fc" id="L100">    return FieldType.METRIC;</span>
  }

  // Required by JSON de-serializer. DO NOT REMOVE.
  @Override
  public void setDataType(@Nonnull DataType dataType) {
<span class="fc" id="L106">    super.setDataType(dataType);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">    if (_dataType != DataType.STRING) {</span>
<span class="fc" id="L108">      _fieldSize = _dataType.size();</span>
    }
<span class="fc" id="L110">  }</span>

  // Required by JSON de-serializer. DO NOT REMOVE.
  @Override
  public void setSingleValueField(boolean isSingleValueField) {
<span class="fc" id="L115">    Preconditions.checkArgument(isSingleValueField, &quot;Unsupported multi-value for metric field.&quot;);</span>
<span class="fc" id="L116">  }</span>

  @JsonIgnore
  public boolean isDerivedMetric() {
<span class="fc bfc" id="L120" title="All 2 branches covered.">    return _derivedMetricType != null;</span>
  }

  /**
   * The &lt;code&gt;DerivedMetricType&lt;/code&gt; enum is assigned for all metric fields to allow derived metric field, a
   * customized type which is not included in DataType.
   * &lt;p&gt;It is currently used for derived field recognition in star tree &lt;code&gt;MetricBuffer&lt;/code&gt;, may have other use
   * cases later.
   * &lt;p&gt;Generally, a customized type value should be converted to a standard
   * {@link com.linkedin.pinot.common.data.FieldSpec.DataType} for storage, and converted back when needed.
   */
<span class="fc" id="L131">  public enum DerivedMetricType {</span>
    // HLL derived metric type.
<span class="fc" id="L133">    HLL</span>
  }

  @Nonnull
  @Override
  public JsonObject toJsonObject() {
<span class="fc" id="L139">    JsonObject jsonObject = super.toJsonObject();</span>
<span class="pc bpc" id="L140" title="1 of 4 branches missed.">    if (_dataType == DataType.STRING &amp;&amp; _fieldSize != UNDEFINED_FIELD_SIZE) {</span>
<span class="fc" id="L141">      jsonObject.addProperty(&quot;fieldSize&quot;, _fieldSize);</span>
    }
<span class="fc bfc" id="L143" title="All 2 branches covered.">    if (_derivedMetricType != null) {</span>
<span class="fc" id="L144">      jsonObject.addProperty(&quot;derivedMetricType&quot;, _derivedMetricType.name());</span>
    }
<span class="fc" id="L146">    return jsonObject;</span>
  }

  @Override
  public String toString() {
<span class="fc" id="L151">    return &quot;&lt; field type: METRIC, field name: &quot; + _name + &quot;, data type: &quot; + _dataType + &quot;, default null value: &quot;</span>
        + _defaultNullValue + &quot;, field size: &quot; + _fieldSize + &quot;, derived metric type: &quot; + _derivedMetricType + &quot; &gt;&quot;;
  }

  @Override
  public boolean equals(Object o) {
<span class="fc bfc" id="L157" title="All 2 branches covered.">    if (!super.equals(o)) {</span>
<span class="fc" id="L158">      return false;</span>
    }

<span class="fc" id="L161">    MetricFieldSpec that = (MetricFieldSpec) o;</span>
<span class="fc bfc" id="L162" title="All 4 branches covered.">    return EqualityUtils.isEqual(_fieldSize, that._fieldSize) &amp;&amp; EqualityUtils.isEqual(_derivedMetricType,</span>
        that._derivedMetricType);
  }

  @Override
  public int hashCode() {
<span class="fc" id="L168">    int result = EqualityUtils.hashCodeOf(super.hashCode(), _fieldSize);</span>
<span class="fc" id="L169">    result = EqualityUtils.hashCodeOf(result, _derivedMetricType);</span>
<span class="fc" id="L170">    return result;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>