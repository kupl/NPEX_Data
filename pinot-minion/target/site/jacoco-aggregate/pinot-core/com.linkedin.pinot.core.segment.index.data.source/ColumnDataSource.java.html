<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ColumnDataSource.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-minion</a> &gt; <a href="../index.html" class="el_bundle">pinot-core</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.core.segment.index.data.source</a> &gt; <span class="el_source">ColumnDataSource.java</span></div><h1>ColumnDataSource.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.core.segment.index.data.source;

import com.google.common.base.Preconditions;
import com.linkedin.pinot.common.data.FieldSpec;
import com.linkedin.pinot.core.common.Block;
import com.linkedin.pinot.core.common.DataSource;
import com.linkedin.pinot.core.common.DataSourceMetadata;
import com.linkedin.pinot.core.io.reader.DataFileReader;
import com.linkedin.pinot.core.io.reader.ReaderContext;
import com.linkedin.pinot.core.io.reader.SingleColumnMultiValueReader;
import com.linkedin.pinot.core.io.reader.SingleColumnSingleValueReader;
import com.linkedin.pinot.core.io.reader.impl.v1.SortedIndexReader;
import com.linkedin.pinot.core.operator.blocks.MultiValueBlock;
import com.linkedin.pinot.core.operator.blocks.SingleValueBlock;
import com.linkedin.pinot.core.realtime.impl.dictionary.MutableDictionary;
import com.linkedin.pinot.core.segment.index.ColumnMetadata;
import com.linkedin.pinot.core.segment.index.column.ColumnIndexContainer;
import com.linkedin.pinot.core.segment.index.readers.Dictionary;
import com.linkedin.pinot.core.segment.index.readers.InvertedIndexReader;


public final class ColumnDataSource extends DataSource {
  private final String _operatorName;
  private final FieldSpec.DataType _dataType;
  private final boolean _isSingleValue;
  private final boolean _isSorted;
  private final int _numDocs;
  private final int _maxNumMultiValues;
  private final DataFileReader _forwardIndex;
  private final InvertedIndexReader _invertedIndex;
  private final Dictionary _dictionary;
  private final DataSourceMetadata _metadata;

  /**
   * For OFFLINE segment.
   */
  public ColumnDataSource(ColumnIndexContainer indexContainer, ColumnMetadata metadata) {
<span class="fc" id="L53">    this(metadata.getColumnName(), metadata.getDataType(), metadata.isSingleValue(), metadata.isSorted(),</span>
        metadata.getTotalDocs(), metadata.getMaxNumberOfMultiValues(), indexContainer.getForwardIndex(),
        indexContainer.getInvertedIndex(), indexContainer.getDictionary());
<span class="fc" id="L56">  }</span>

  /**
   * For REALTIME segment.
   */
  public ColumnDataSource(FieldSpec fieldSpec, int numDocs, int maxNumMultiValues, DataFileReader forwardIndex,
      InvertedIndexReader invertedIndex, MutableDictionary dictionary) {
<span class="fc" id="L63">    this(fieldSpec.getName(), fieldSpec.getDataType(), fieldSpec.isSingleValueField(), false, numDocs,</span>
        maxNumMultiValues, forwardIndex, invertedIndex, dictionary);
<span class="fc" id="L65">  }</span>

  private ColumnDataSource(String columnName, FieldSpec.DataType dataType, boolean isSingleValue, boolean isSorted,
      int numDocs, int maxNumMultiValues, DataFileReader forwardIndex, InvertedIndexReader invertedIndex,
<span class="fc" id="L69">      Dictionary dictionary) {</span>
    // Sanity check
<span class="fc bfc" id="L71" title="All 2 branches covered.">    if (isSingleValue) {</span>
<span class="fc" id="L72">      Preconditions.checkState(forwardIndex instanceof SingleColumnSingleValueReader);</span>
    } else {
<span class="fc" id="L74">      Preconditions.checkState(forwardIndex instanceof SingleColumnMultiValueReader);</span>
    }
<span class="fc bfc" id="L76" title="All 2 branches covered.">    if (dictionary != null) {</span>
      // Dictionary-based index
<span class="fc bfc" id="L78" title="All 2 branches covered.">      if (isSorted) {</span>
<span class="fc" id="L79">        Preconditions.checkState(invertedIndex instanceof SortedIndexReader);</span>
      }
    } else {
      // Raw index
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">      Preconditions.checkState(invertedIndex == null);</span>
    }

<span class="fc" id="L86">    _operatorName = &quot;ColumnDataSource [&quot; + columnName + &quot;]&quot;;</span>
<span class="fc" id="L87">    _dataType = dataType;</span>
<span class="fc" id="L88">    _isSingleValue = isSingleValue;</span>
<span class="fc" id="L89">    _isSorted = isSorted;</span>
<span class="fc" id="L90">    _numDocs = numDocs;</span>
<span class="fc" id="L91">    _maxNumMultiValues = maxNumMultiValues;</span>
<span class="fc" id="L92">    _forwardIndex = forwardIndex;</span>
<span class="fc" id="L93">    _invertedIndex = invertedIndex;</span>
<span class="fc" id="L94">    _dictionary = dictionary;</span>
<span class="fc" id="L95">    _metadata = new DataSourceMetadata() {</span>
      @Override
      public FieldSpec.DataType getDataType() {
<span class="fc" id="L98">        return _dataType;</span>
      }

      @Override
      public boolean isSingleValue() {
<span class="fc" id="L103">        return _isSingleValue;</span>
      }

      @Override
      public boolean isSorted() {
<span class="fc" id="L108">        return _isSorted;</span>
      }

      @Override
      public boolean hasInvertedIndex() {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        return _invertedIndex != null;</span>
      }

      @Override
      public boolean hasDictionary() {
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        return _dictionary != null;</span>
      }
    };
<span class="fc" id="L121">  }</span>

  @Override
  public DataSourceMetadata getDataSourceMetadata() {
<span class="fc" id="L125">    return _metadata;</span>
  }

  @Override
  public InvertedIndexReader getInvertedIndex() {
<span class="fc" id="L130">    return _invertedIndex;</span>
  }

  @Override
  public Dictionary getDictionary() {
<span class="fc" id="L135">    return _dictionary;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  @Override
  protected Block getNextBlock() {
<span class="fc bfc" id="L141" title="All 2 branches covered.">    if (_isSingleValue) {</span>
<span class="fc" id="L142">      return new SingleValueBlock((SingleColumnSingleValueReader&lt;? super ReaderContext&gt;) _forwardIndex, _numDocs,</span>
          _dataType, _dictionary);
    } else {
<span class="fc" id="L145">      return new MultiValueBlock((SingleColumnMultiValueReader&lt;? super ReaderContext&gt;) _forwardIndex, _numDocs,</span>
          _maxNumMultiValues, _dataType, _dictionary);
    }
  }

  @Override
  public String getOperatorName() {
<span class="fc" id="L152">    return _operatorName;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>