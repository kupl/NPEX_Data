<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AggregatedPoolStats.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">pinot-server</a> &gt; <a href="../index.html" class="el_bundle">pinot-transport</a> &gt; <a href="index.source.html" class="el_package">com.linkedin.pinot.transport.metrics</a> &gt; <span class="el_source">AggregatedPoolStats.java</span></div><h1>AggregatedPoolStats.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2014-2016 LinkedIn Corp. (pinot-core@linkedin.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.linkedin.pinot.transport.metrics;

import java.util.Collection;
import java.util.List;
import java.util.concurrent.CopyOnWriteArrayList;

import com.linkedin.pinot.common.metrics.AggregatedHistogram;
import com.linkedin.pinot.common.metrics.LatencyMetric;
import com.yammer.metrics.core.Sampling;
import com.yammer.metrics.core.Summarizable;


public class AggregatedPoolStats&lt;T extends Sampling &amp; Summarizable&gt; implements PoolStats&lt;T&gt;, PoolStatsProvider {

<span class="pc" id="L30">  private final long DEFAULT_REFRESH_MS = 60 * 1000; // 1 minute</span>

  // Refresh Delay config
  private final long _refreshMs;

  // Last Refreshed timestamp
  private volatile long _lastRefreshedTime;

  private volatile int _totalCreated;
  private volatile int _totalDestroyed;
  private volatile int _totalCreateErrors;
  private volatile int _totalDestroyErrors;
  private volatile int _totalBadDestroyed;
  private volatile int _totalTimedOut;

  private volatile int _checkedOut;
  private volatile int _maxPoolSize;
  private volatile int _minPoolSize;
  private volatile int _poolSize;

  private volatile int _sampleMaxCheckedOut;
  private volatile int _sampleMaxPoolSize;

  private volatile int _idleCount;
  private volatile LatencyMetric&lt;T&gt; _waitTime;
  private volatile LifecycleStats&lt;T&gt; _lifecycleStats;

<span class="pc" id="L57">  private final List&lt;PoolStatsProvider&gt; _poolStatsProvider = new CopyOnWriteArrayList&lt;PoolStatsProvider&gt;();</span>

<span class="nc" id="L59">  public AggregatedPoolStats(long refreshMs) {</span>
<span class="nc" id="L60">    _refreshMs = refreshMs;</span>
<span class="nc" id="L61">  }</span>

<span class="fc" id="L63">  public AggregatedPoolStats() {</span>
<span class="fc" id="L64">    _refreshMs = DEFAULT_REFRESH_MS;</span>
<span class="fc" id="L65">  }</span>

  public AggregatedPoolStats&lt;T&gt; addAll(Collection&lt;PoolStatsProvider&gt; poolStats) {
<span class="nc" id="L68">    _poolStatsProvider.addAll(poolStats);</span>
<span class="nc" id="L69">    return this;</span>
  }

  public AggregatedPoolStats&lt;T&gt; add(PoolStatsProvider poolStat) {
<span class="fc" id="L73">    _poolStatsProvider.add(poolStat);</span>
<span class="fc" id="L74">    return this;</span>
  }

  public void refreshIfElapsed() {
<span class="fc" id="L78">    long currentTime = System.currentTimeMillis();</span>
<span class="pc bpc" id="L79" title="1 of 4 branches missed.">    if (currentTime - _lastRefreshedTime &gt; _refreshMs &amp;&amp; !_poolStatsProvider.isEmpty()) {</span>
<span class="fc" id="L80">      refresh();</span>
<span class="fc" id="L81">      _lastRefreshedTime = currentTime;</span>
    }
<span class="fc" id="L83">  }</span>

  public void refresh() {
<span class="fc" id="L86">    int totalCreated = 0;</span>
<span class="fc" id="L87">    int totalDestroyed = 0;</span>
<span class="fc" id="L88">    int totalCreateErrors = 0;</span>
<span class="fc" id="L89">    int totalDestroyErrors = 0;</span>
<span class="fc" id="L90">    int totalBadDestroyed = 0;</span>
<span class="fc" id="L91">    int totalTimedOut = 0;</span>

<span class="fc" id="L93">    int checkedOut = 0;</span>
<span class="fc" id="L94">    int maxPoolSize = 0;</span>
<span class="fc" id="L95">    int minPoolSize = 0;</span>
<span class="fc" id="L96">    int poolSize = 0;</span>

<span class="fc" id="L98">    int sampleMaxCheckedOut = 0;</span>
<span class="fc" id="L99">    int sampleMaxPoolSize = 0;</span>

<span class="fc" id="L101">    int idleCount = 0;</span>
<span class="fc" id="L102">    AggregatedHistogram&lt;Sampling&gt; waitTimeHist = new AggregatedHistogram&lt;Sampling&gt;();</span>
<span class="fc" id="L103">    AggregatedHistogram&lt;Sampling&gt; createTimeHist = new AggregatedHistogram&lt;Sampling&gt;();</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">    for (PoolStatsProvider p : _poolStatsProvider) {</span>
<span class="fc" id="L106">      PoolStats&lt;T&gt; s = p.getStats();</span>
<span class="fc" id="L107">      totalCreated += s.getTotalCreated();</span>
<span class="fc" id="L108">      totalDestroyed += s.getTotalBadDestroyed();</span>
<span class="fc" id="L109">      totalCreateErrors += s.getTotalCreateErrors();</span>
<span class="fc" id="L110">      totalDestroyErrors += s.getTotalDestroyErrors();</span>
<span class="fc" id="L111">      totalBadDestroyed += s.getTotalBadDestroyed();</span>
<span class="fc" id="L112">      totalTimedOut += s.getTotalTimedOut();</span>
<span class="fc" id="L113">      checkedOut += s.getCheckedOut();</span>
<span class="fc" id="L114">      maxPoolSize += s.getMaxPoolSize();</span>
<span class="fc" id="L115">      minPoolSize += s.getMinPoolSize();</span>
<span class="fc" id="L116">      poolSize += s.getPoolSize();</span>
<span class="fc" id="L117">      sampleMaxCheckedOut += s.getSampleMaxCheckedOut();</span>
<span class="fc" id="L118">      sampleMaxPoolSize += s.getSampleMaxPoolSize();</span>
<span class="fc" id="L119">      idleCount += s.getIdleCount();</span>
<span class="fc" id="L120">      waitTimeHist.add(s.getWaitTime().getHistogram());</span>
<span class="fc" id="L121">      createTimeHist.add(s.getLifecycleStats().getCreateTime().getHistogram());</span>
<span class="fc" id="L122">    }</span>

<span class="fc" id="L124">    _totalCreated = totalCreated;</span>
<span class="fc" id="L125">    _totalDestroyed = totalDestroyed;</span>
<span class="fc" id="L126">    _totalBadDestroyed = totalBadDestroyed;</span>
<span class="fc" id="L127">    _totalCreateErrors = totalCreateErrors;</span>
<span class="fc" id="L128">    _totalDestroyErrors = totalDestroyErrors;</span>
<span class="fc" id="L129">    _totalTimedOut = totalTimedOut;</span>
<span class="fc" id="L130">    _checkedOut = checkedOut;</span>
<span class="fc" id="L131">    _maxPoolSize = maxPoolSize;</span>
<span class="fc" id="L132">    _minPoolSize = minPoolSize;</span>
<span class="fc" id="L133">    _poolSize = poolSize;</span>
<span class="fc" id="L134">    _sampleMaxCheckedOut = sampleMaxCheckedOut;</span>
<span class="fc" id="L135">    _sampleMaxPoolSize = sampleMaxPoolSize;</span>
<span class="fc" id="L136">    _idleCount = idleCount;</span>
<span class="fc" id="L137">    _waitTime = new LatencyMetric(waitTimeHist);</span>
<span class="fc" id="L138">    _lifecycleStats = new LifecycleStats(new LatencyMetric&lt;AggregatedHistogram&lt;Sampling&gt;&gt;(createTimeHist));</span>
<span class="fc" id="L139">  }</span>

  @Override
  public int getTotalCreated() {
<span class="fc" id="L143">    refreshIfElapsed();</span>
<span class="fc" id="L144">    return _totalCreated;</span>
  }

  @Override
  public int getTotalDestroyed() {
<span class="fc" id="L149">    refreshIfElapsed();</span>
<span class="fc" id="L150">    return _totalDestroyed;</span>
  }

  @Override
  public int getTotalCreateErrors() {
<span class="fc" id="L155">    refreshIfElapsed();</span>
<span class="fc" id="L156">    return _totalCreateErrors;</span>
  }

  @Override
  public int getTotalDestroyErrors() {
<span class="fc" id="L161">    refreshIfElapsed();</span>
<span class="fc" id="L162">    return _totalDestroyErrors;</span>
  }

  @Override
  public int getTotalBadDestroyed() {
<span class="nc" id="L167">    refreshIfElapsed();</span>
<span class="nc" id="L168">    return _totalBadDestroyed;</span>
  }

  @Override
  public int getTotalTimedOut() {
<span class="fc" id="L173">    refreshIfElapsed();</span>
<span class="fc" id="L174">    return _totalTimedOut;</span>
  }

  @Override
  public int getCheckedOut() {
<span class="fc" id="L179">    refreshIfElapsed();</span>
<span class="fc" id="L180">    return _checkedOut;</span>
  }

  @Override
  public int getMaxPoolSize() {
<span class="nc" id="L185">    refreshIfElapsed();</span>
<span class="nc" id="L186">    return _maxPoolSize;</span>
  }

  @Override
  public int getMinPoolSize() {
<span class="nc" id="L191">    refreshIfElapsed();</span>
<span class="nc" id="L192">    return _minPoolSize;</span>
  }

  @Override
  public int getPoolSize() {
<span class="fc" id="L197">    refreshIfElapsed();</span>
<span class="fc" id="L198">    return _poolSize;</span>
  }

  @Override
  public int getSampleMaxCheckedOut() {
<span class="nc" id="L203">    refreshIfElapsed();</span>
<span class="nc" id="L204">    return _sampleMaxCheckedOut;</span>
  }

  @Override
  public int getSampleMaxPoolSize() {
<span class="nc" id="L209">    refreshIfElapsed();</span>
<span class="nc" id="L210">    return _sampleMaxPoolSize;</span>
  }

  @Override
  public int getIdleCount() {
<span class="fc" id="L215">    refreshIfElapsed();</span>
<span class="fc" id="L216">    return _idleCount;</span>
  }

  @Override
  public LatencyMetric&lt;T&gt; getWaitTime() {
<span class="nc" id="L221">    refreshIfElapsed();</span>
<span class="nc" id="L222">    return _waitTime;</span>
  }

  @Override
  public LifecycleStats&lt;T&gt; getLifecycleStats() {
<span class="nc" id="L227">    refreshIfElapsed();</span>
<span class="nc" id="L228">    return _lifecycleStats;</span>
  }

  @Override
  public PoolStats&lt;T&gt; getStats() {
<span class="nc" id="L233">    return this;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L238">    return &quot;AggregatedPoolStats [_refreshMs=&quot; + _refreshMs + &quot;, _lastRefreshedTime=&quot; + _lastRefreshedTime</span>
        + &quot;, _totalCreated=&quot; + _totalCreated + &quot;, _totalDestroyed=&quot; + _totalDestroyed + &quot;, _totalCreateErrors=&quot;
        + _totalCreateErrors + &quot;, _totalDestroyErrors=&quot; + _totalDestroyErrors + &quot;, _totalBadDestroyed=&quot;
        + _totalBadDestroyed + &quot;, _totalTimedOut=&quot; + _totalTimedOut + &quot;, _checkedOut=&quot; + _checkedOut
        + &quot;, _maxPoolSize=&quot; + _maxPoolSize + &quot;, _minPoolSize=&quot; + _minPoolSize + &quot;, _poolSize=&quot; + _poolSize
        + &quot;, _sampleMaxCheckedOut=&quot; + _sampleMaxCheckedOut + &quot;, _sampleMaxPoolSize=&quot; + _sampleMaxPoolSize
        + &quot;, _idleCount=&quot; + _idleCount + &quot;, _waitTime=&quot; + _waitTime + &quot;, _lifecycleStats=&quot; + _lifecycleStats
        + &quot;, _poolStatsProvider=&quot; + _poolStatsProvider + &quot;]&quot;;
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>